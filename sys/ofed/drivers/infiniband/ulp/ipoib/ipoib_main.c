begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004 Topspin Communications.  All rights reserved.  * Copyright (c) 2005 Sun Microsystems, Inc. All rights reserved.  * Copyright (c) 2004 Voltaire, Inc. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|"ipoib.h"
end_include

begin_function_decl
specifier|static
name|int
name|ipoib_resolvemulti
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|struct
name|sockaddr
modifier|*
modifier|*
parameter_list|,
name|struct
name|sockaddr
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_include
include|#
directive|include
file|<linux/module.h>
end_include

begin_include
include|#
directive|include
file|<linux/init.h>
end_include

begin_include
include|#
directive|include
file|<linux/slab.h>
end_include

begin_include
include|#
directive|include
file|<linux/kernel.h>
end_include

begin_include
include|#
directive|include
file|<linux/vmalloc.h>
end_include

begin_include
include|#
directive|include
file|<linux/if_arp.h>
end_include

begin_comment
comment|/* For ARPHRD_xxx */
end_comment

begin_include
include|#
directive|include
file|<linux/if_vlan.h>
end_include

begin_include
include|#
directive|include
file|<net/ip.h>
end_include

begin_include
include|#
directive|include
file|<net/ipv6.h>
end_include

begin_expr_stmt
name|MODULE_AUTHOR
argument_list|(
literal|"Roland Dreier"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DESCRIPTION
argument_list|(
literal|"IP-over-InfiniBand net driver"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_LICENSE
argument_list|(
literal|"Dual BSD/GPL"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|ipoib_sendq_size
init|=
name|IPOIB_TX_RING_SIZE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ipoib_recvq_size
init|=
name|IPOIB_RX_RING_SIZE
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|module_param_named
argument_list|(
name|send_queue_size
argument_list|,
name|ipoib_sendq_size
argument_list|,
name|int
argument_list|,
literal|0444
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|send_queue_size
argument_list|,
literal|"Number of descriptors in send queue"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|module_param_named
argument_list|(
name|recv_queue_size
argument_list|,
name|ipoib_recvq_size
argument_list|,
name|int
argument_list|,
literal|0444
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|recv_queue_size
argument_list|,
literal|"Number of descriptors in receive queue"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_INFINIBAND_IPOIB_DEBUG
end_ifdef

begin_decl_stmt
name|int
name|ipoib_debug_level
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|module_param_named
argument_list|(
name|debug_level
argument_list|,
name|ipoib_debug_level
argument_list|,
name|int
argument_list|,
literal|0644
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|debug_level
argument_list|,
literal|"Enable debug tracing if> 0"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_struct
struct|struct
name|ipoib_path_iter
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
decl_stmt|;
name|struct
name|ipoib_path
name|path
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|u8
name|ipv4_bcast_addr
index|[]
init|=
block|{
literal|0x00
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0x12
block|,
literal|0x40
block|,
literal|0x1b
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|workqueue_struct
modifier|*
name|ipoib_workqueue
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|ib_sa_client
name|ipoib_sa_client
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|ipoib_add_one
parameter_list|(
name|struct
name|ib_device
modifier|*
name|device
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ipoib_remove_one
parameter_list|(
name|struct
name|ib_device
modifier|*
name|device
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ipoib_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ipoib_output
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|dst
parameter_list|,
name|struct
name|route
modifier|*
name|ro
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ipoib_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|command
parameter_list|,
name|caddr_t
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ipoib_input
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|IPOIB_MTAP
parameter_list|(
name|_ifp
parameter_list|,
name|_m
parameter_list|)
define|\
value|do {								\ 	if (bpf_peers_present((_ifp)->if_bpf)) {		\ 		M_ASSERTVALID(_m);				\ 		ipoib_mtap_mb((_ifp), (_m));			\ 	}							\ } while (0)
end_define

begin_comment
comment|/*  * This is for clients that have an ipoib_header in the mbuf.  */
end_comment

begin_function
specifier|static
name|void
name|ipoib_mtap_mb
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mb
parameter_list|)
block|{
name|struct
name|ipoib_header
modifier|*
name|ih
decl_stmt|;
name|struct
name|ether_header
name|eh
decl_stmt|;
name|ih
operator|=
name|mtod
argument_list|(
name|mb
argument_list|,
expr|struct
name|ipoib_header
operator|*
argument_list|)
expr_stmt|;
name|eh
operator|.
name|ether_type
operator|=
name|ih
operator|->
name|proto
expr_stmt|;
name|bcopy
argument_list|(
name|ih
operator|->
name|hwaddr
argument_list|,
operator|&
name|eh
operator|.
name|ether_dhost
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|eh
operator|.
name|ether_shost
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|mb
operator|->
name|m_data
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|ipoib_header
argument_list|)
expr_stmt|;
name|mb
operator|->
name|m_len
operator|-=
sizeof|sizeof
argument_list|(
expr|struct
name|ipoib_header
argument_list|)
expr_stmt|;
name|bpf_mtap2
argument_list|(
name|ifp
operator|->
name|if_bpf
argument_list|,
operator|&
name|eh
argument_list|,
sizeof|sizeof
argument_list|(
name|eh
argument_list|)
argument_list|,
name|mb
argument_list|)
expr_stmt|;
name|mb
operator|->
name|m_data
operator|-=
sizeof|sizeof
argument_list|(
expr|struct
name|ipoib_header
argument_list|)
expr_stmt|;
name|mb
operator|->
name|m_len
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|ipoib_header
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ipoib_mtap_proto
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mb
parameter_list|,
name|uint16_t
name|proto
parameter_list|)
block|{
name|struct
name|ether_header
name|eh
decl_stmt|;
name|eh
operator|.
name|ether_type
operator|=
name|proto
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|eh
operator|.
name|ether_shost
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|eh
operator|.
name|ether_dhost
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|bpf_mtap2
argument_list|(
name|ifp
operator|->
name|if_bpf
argument_list|,
operator|&
name|eh
argument_list|,
sizeof|sizeof
argument_list|(
name|eh
argument_list|)
argument_list|,
name|mb
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|ib_client
name|ipoib_client
init|=
block|{
operator|.
name|name
operator|=
literal|"ipoib"
block|,
operator|.
name|add
operator|=
name|ipoib_add_one
block|,
operator|.
name|remove
operator|=
name|ipoib_remove_one
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|ipoib_open
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|dev
init|=
name|priv
operator|->
name|dev
decl_stmt|;
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"bringing up interface\n"
argument_list|)
expr_stmt|;
name|set_bit
argument_list|(
name|IPOIB_FLAG_ADMIN_UP
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|ipoib_pkey_dev_delay_open
argument_list|(
name|priv
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|ipoib_ib_dev_open
argument_list|(
name|priv
argument_list|)
condition|)
goto|goto
name|err_disable
goto|;
if|if
condition|(
name|ipoib_ib_dev_up
argument_list|(
name|priv
argument_list|)
condition|)
goto|goto
name|err_stop
goto|;
if|if
condition|(
operator|!
name|test_bit
argument_list|(
name|IPOIB_FLAG_SUBINTERFACE
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
condition|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|cpriv
decl_stmt|;
comment|/* Bring up any child interfaces too */
name|mutex_lock
argument_list|(
operator|&
name|priv
operator|->
name|vlan_mutex
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|cpriv
argument_list|,
argument|&priv->child_intfs
argument_list|,
argument|list
argument_list|)
if|if
condition|(
operator|(
name|cpriv
operator|->
name|dev
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
name|ipoib_open
argument_list|(
name|cpriv
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|priv
operator|->
name|vlan_mutex
argument_list|)
expr_stmt|;
block|}
name|dev
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
name|dev
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
return|return
literal|0
return|;
name|err_stop
label|:
name|ipoib_ib_dev_stop
argument_list|(
name|priv
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|err_disable
label|:
name|clear_bit
argument_list|(
name|IPOIB_FLAG_ADMIN_UP
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_init
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|dev
decl_stmt|;
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
decl_stmt|;
name|priv
operator|=
name|arg
expr_stmt|;
name|dev
operator|=
name|priv
operator|->
name|dev
expr_stmt|;
if|if
condition|(
operator|(
name|dev
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
name|ipoib_open
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|queue_work
argument_list|(
name|ipoib_workqueue
argument_list|,
operator|&
name|priv
operator|->
name|flush_light
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ipoib_stop
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|dev
init|=
name|priv
operator|->
name|dev
decl_stmt|;
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"stopping interface\n"
argument_list|)
expr_stmt|;
name|clear_bit
argument_list|(
name|IPOIB_FLAG_ADMIN_UP
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
expr_stmt|;
name|dev
operator|->
name|if_drv_flags
operator|&=
operator|~
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
expr_stmt|;
name|ipoib_ib_dev_down
argument_list|(
name|priv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ipoib_ib_dev_stop
argument_list|(
name|priv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|test_bit
argument_list|(
name|IPOIB_FLAG_SUBINTERFACE
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
condition|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|cpriv
decl_stmt|;
comment|/* Bring down any child interfaces too */
name|mutex_lock
argument_list|(
operator|&
name|priv
operator|->
name|vlan_mutex
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|cpriv
argument_list|,
argument|&priv->child_intfs
argument_list|,
argument|list
argument_list|)
if|if
condition|(
operator|(
name|cpriv
operator|->
name|dev
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|!=
literal|0
condition|)
name|ipoib_stop
argument_list|(
name|cpriv
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|priv
operator|->
name|vlan_mutex
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ipoib_change_mtu
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|int
name|new_mtu
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|dev
init|=
name|priv
operator|->
name|dev
decl_stmt|;
comment|/* dev->if_mtu> 2K ==> connected mode */
if|if
condition|(
name|ipoib_cm_admin_enabled
argument_list|(
name|priv
argument_list|)
condition|)
block|{
if|if
condition|(
name|new_mtu
operator|>
name|IPOIB_CM_MTU
argument_list|(
name|ipoib_cm_max_mtu
argument_list|(
name|priv
argument_list|)
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|new_mtu
operator|>
name|priv
operator|->
name|mcast_mtu
condition|)
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"mtu> %d will cause multicast packet drops.\n"
argument_list|,
name|priv
operator|->
name|mcast_mtu
argument_list|)
expr_stmt|;
name|dev
operator|->
name|if_mtu
operator|=
name|new_mtu
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|new_mtu
operator|>
name|IPOIB_UD_MTU
argument_list|(
name|priv
operator|->
name|max_ib_mtu
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
name|priv
operator|->
name|admin_mtu
operator|=
name|new_mtu
expr_stmt|;
name|dev
operator|->
name|if_mtu
operator|=
name|min
argument_list|(
name|priv
operator|->
name|mcast_mtu
argument_list|,
name|priv
operator|->
name|admin_mtu
argument_list|)
expr_stmt|;
name|queue_work
argument_list|(
name|ipoib_workqueue
argument_list|,
operator|&
name|priv
operator|->
name|flush_light
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ipoib_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|command
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ifaddr
modifier|*
name|ifa
init|=
operator|(
expr|struct
name|ifaddr
operator|*
operator|)
name|data
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|command
condition|)
block|{
case|case
name|SIOCSIFFLAGS
case|:
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
name|error
operator|=
operator|-
name|ipoib_open
argument_list|(
name|priv
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|ipoib_stop
argument_list|(
name|priv
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCADDMULTI
case|:
case|case
name|SIOCDELMULTI
case|:
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|queue_work
argument_list|(
name|ipoib_workqueue
argument_list|,
operator|&
name|priv
operator|->
name|restart_task
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSIFADDR
case|:
name|ifp
operator|->
name|if_flags
operator||=
name|IFF_UP
expr_stmt|;
switch|switch
condition|(
name|ifa
operator|->
name|ifa_addr
operator|->
name|sa_family
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
name|ifp
operator|->
name|if_init
argument_list|(
name|ifp
operator|->
name|if_softc
argument_list|)
expr_stmt|;
comment|/* before arpwhohas */
name|arp_ifinit
argument_list|(
name|ifp
argument_list|,
name|ifa
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|ifp
operator|->
name|if_init
argument_list|(
name|ifp
operator|->
name|if_softc
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|SIOCGIFADDR
case|:
block|{
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|ifr
operator|->
name|ifr_data
expr_stmt|;
name|bcopy
argument_list|(
name|IF_LLADDR
argument_list|(
name|ifp
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
name|sa
operator|->
name|sa_data
argument_list|,
name|INFINIBAND_ALEN
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SIOCSIFMTU
case|:
comment|/* 		 * Set the interface MTU. 		 */
name|error
operator|=
operator|-
name|ipoib_change_mtu
argument_list|(
name|priv
argument_list|,
name|ifr
operator|->
name|ifr_mtu
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ipoib_path
modifier|*
name|__path_find
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|void
modifier|*
name|gid
parameter_list|)
block|{
name|struct
name|rb_node
modifier|*
name|n
init|=
name|priv
operator|->
name|path_tree
operator|.
name|rb_node
decl_stmt|;
name|struct
name|ipoib_path
modifier|*
name|path
decl_stmt|;
name|int
name|ret
decl_stmt|;
while|while
condition|(
name|n
condition|)
block|{
name|path
operator|=
name|rb_entry
argument_list|(
name|n
argument_list|,
expr|struct
name|ipoib_path
argument_list|,
name|rb_node
argument_list|)
expr_stmt|;
name|ret
operator|=
name|memcmp
argument_list|(
name|gid
argument_list|,
name|path
operator|->
name|pathrec
operator|.
name|dgid
operator|.
name|raw
argument_list|,
sizeof|sizeof
argument_list|(
expr|union
name|ib_gid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
name|n
operator|=
name|n
operator|->
name|rb_left
expr_stmt|;
elseif|else
if|if
condition|(
name|ret
operator|>
literal|0
condition|)
name|n
operator|=
name|n
operator|->
name|rb_right
expr_stmt|;
else|else
return|return
name|path
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|__path_add
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ipoib_path
modifier|*
name|path
parameter_list|)
block|{
name|struct
name|rb_node
modifier|*
modifier|*
name|n
init|=
operator|&
name|priv
operator|->
name|path_tree
operator|.
name|rb_node
decl_stmt|;
name|struct
name|rb_node
modifier|*
name|pn
init|=
name|NULL
decl_stmt|;
name|struct
name|ipoib_path
modifier|*
name|tpath
decl_stmt|;
name|int
name|ret
decl_stmt|;
while|while
condition|(
operator|*
name|n
condition|)
block|{
name|pn
operator|=
operator|*
name|n
expr_stmt|;
name|tpath
operator|=
name|rb_entry
argument_list|(
name|pn
argument_list|,
expr|struct
name|ipoib_path
argument_list|,
name|rb_node
argument_list|)
expr_stmt|;
name|ret
operator|=
name|memcmp
argument_list|(
name|path
operator|->
name|pathrec
operator|.
name|dgid
operator|.
name|raw
argument_list|,
name|tpath
operator|->
name|pathrec
operator|.
name|dgid
operator|.
name|raw
argument_list|,
sizeof|sizeof
argument_list|(
expr|union
name|ib_gid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
name|n
operator|=
operator|&
name|pn
operator|->
name|rb_left
expr_stmt|;
elseif|else
if|if
condition|(
name|ret
operator|>
literal|0
condition|)
name|n
operator|=
operator|&
name|pn
operator|->
name|rb_right
expr_stmt|;
else|else
return|return
operator|-
name|EEXIST
return|;
block|}
name|rb_link_node
argument_list|(
operator|&
name|path
operator|->
name|rb_node
argument_list|,
name|pn
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|rb_insert_color
argument_list|(
operator|&
name|path
operator|->
name|rb_node
argument_list|,
operator|&
name|priv
operator|->
name|path_tree
argument_list|)
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|path
operator|->
name|list
argument_list|,
operator|&
name|priv
operator|->
name|path_list
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|ipoib_path_free
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ipoib_path
modifier|*
name|path
parameter_list|)
block|{
name|_IF_DRAIN
argument_list|(
operator|&
name|path
operator|->
name|queue
argument_list|)
expr_stmt|;
if|if
condition|(
name|path
operator|->
name|ah
condition|)
name|ipoib_put_ah
argument_list|(
name|path
operator|->
name|ah
argument_list|)
expr_stmt|;
if|if
condition|(
name|ipoib_cm_get
argument_list|(
name|path
argument_list|)
condition|)
name|ipoib_cm_destroy_tx
argument_list|(
name|ipoib_cm_get
argument_list|(
name|path
argument_list|)
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|path
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_INFINIBAND_IPOIB_DEBUG
end_ifdef

begin_function
name|struct
name|ipoib_path_iter
modifier|*
name|ipoib_path_iter_init
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|ipoib_path_iter
modifier|*
name|iter
decl_stmt|;
name|iter
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
expr|*
name|iter
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|iter
condition|)
return|return
name|NULL
return|;
name|iter
operator|->
name|priv
operator|=
name|priv
expr_stmt|;
name|memset
argument_list|(
name|iter
operator|->
name|path
operator|.
name|pathrec
operator|.
name|dgid
operator|.
name|raw
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|ipoib_path_iter_next
argument_list|(
name|iter
argument_list|)
condition|)
block|{
name|kfree
argument_list|(
name|iter
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|iter
return|;
block|}
end_function

begin_function
name|int
name|ipoib_path_iter_next
parameter_list|(
name|struct
name|ipoib_path_iter
modifier|*
name|iter
parameter_list|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
init|=
name|iter
operator|->
name|priv
decl_stmt|;
name|struct
name|rb_node
modifier|*
name|n
decl_stmt|;
name|struct
name|ipoib_path
modifier|*
name|path
decl_stmt|;
name|int
name|ret
init|=
literal|1
decl_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|n
operator|=
name|rb_first
argument_list|(
operator|&
name|priv
operator|->
name|path_tree
argument_list|)
expr_stmt|;
while|while
condition|(
name|n
condition|)
block|{
name|path
operator|=
name|rb_entry
argument_list|(
name|n
argument_list|,
expr|struct
name|ipoib_path
argument_list|,
name|rb_node
argument_list|)
expr_stmt|;
if|if
condition|(
name|memcmp
argument_list|(
name|iter
operator|->
name|path
operator|.
name|pathrec
operator|.
name|dgid
operator|.
name|raw
argument_list|,
name|path
operator|->
name|pathrec
operator|.
name|dgid
operator|.
name|raw
argument_list|,
sizeof|sizeof
argument_list|(
expr|union
name|ib_gid
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|iter
operator|->
name|path
operator|=
operator|*
name|path
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|n
operator|=
name|rb_next
argument_list|(
name|n
argument_list|)
expr_stmt|;
block|}
name|spin_unlock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|ipoib_path_iter_read
parameter_list|(
name|struct
name|ipoib_path_iter
modifier|*
name|iter
parameter_list|,
name|struct
name|ipoib_path
modifier|*
name|path
parameter_list|)
block|{
operator|*
name|path
operator|=
name|iter
operator|->
name|path
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_INFINIBAND_IPOIB_DEBUG */
end_comment

begin_function
name|void
name|ipoib_mark_paths_invalid
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|ipoib_path
modifier|*
name|path
decl_stmt|,
modifier|*
name|tp
decl_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|list_for_each_entry_safe
argument_list|(
argument|path
argument_list|,
argument|tp
argument_list|,
argument|&priv->path_list
argument_list|,
argument|list
argument_list|)
block|{
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"mark path LID 0x%04x GID %16D invalid\n"
argument_list|,
name|be16_to_cpu
argument_list|(
name|path
operator|->
name|pathrec
operator|.
name|dlid
argument_list|)
argument_list|,
name|path
operator|->
name|pathrec
operator|.
name|dgid
operator|.
name|raw
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
name|path
operator|->
name|valid
operator|=
literal|0
expr_stmt|;
block|}
name|spin_unlock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ipoib_flush_paths
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|ipoib_path
modifier|*
name|path
decl_stmt|,
modifier|*
name|tp
decl_stmt|;
name|LIST_HEAD
argument_list|(
name|remove_list
argument_list|)
expr_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|list_splice_init
argument_list|(
operator|&
name|priv
operator|->
name|path_list
argument_list|,
operator|&
name|remove_list
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|path
argument_list|,
argument|&remove_list
argument_list|,
argument|list
argument_list|)
name|rb_erase
argument_list|(
operator|&
name|path
operator|->
name|rb_node
argument_list|,
operator|&
name|priv
operator|->
name|path_tree
argument_list|)
expr_stmt|;
name|list_for_each_entry_safe
argument_list|(
argument|path
argument_list|,
argument|tp
argument_list|,
argument|&remove_list
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|path
operator|->
name|query
condition|)
name|ib_sa_cancel_query
argument_list|(
name|path
operator|->
name|query_id
argument_list|,
name|path
operator|->
name|query
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|wait_for_completion
argument_list|(
operator|&
name|path
operator|->
name|done
argument_list|)
expr_stmt|;
name|ipoib_path_free
argument_list|(
name|priv
argument_list|,
name|path
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|path_rec_completion
parameter_list|(
name|int
name|status
parameter_list|,
name|struct
name|ib_sa_path_rec
modifier|*
name|pathrec
parameter_list|,
name|void
modifier|*
name|path_ptr
parameter_list|)
block|{
name|struct
name|ipoib_path
modifier|*
name|path
init|=
name|path_ptr
decl_stmt|;
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
init|=
name|path
operator|->
name|priv
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|dev
init|=
name|priv
operator|->
name|dev
decl_stmt|;
name|struct
name|ipoib_ah
modifier|*
name|ah
init|=
name|NULL
decl_stmt|;
name|struct
name|ipoib_ah
modifier|*
name|old_ah
init|=
name|NULL
decl_stmt|;
name|struct
name|ifqueue
name|mbqueue
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mb
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
if|if
condition|(
operator|!
name|status
condition|)
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"PathRec LID 0x%04x for GID %16D\n"
argument_list|,
name|be16_to_cpu
argument_list|(
name|pathrec
operator|->
name|dlid
argument_list|)
argument_list|,
name|pathrec
operator|->
name|dgid
operator|.
name|raw
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
else|else
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"PathRec status %d for GID %16D\n"
argument_list|,
name|status
argument_list|,
name|path
operator|->
name|pathrec
operator|.
name|dgid
operator|.
name|raw
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|mbqueue
argument_list|,
sizeof|sizeof
argument_list|(
name|mbqueue
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|status
condition|)
block|{
name|struct
name|ib_ah_attr
name|av
decl_stmt|;
if|if
condition|(
operator|!
name|ib_init_ah_from_path
argument_list|(
name|priv
operator|->
name|ca
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|pathrec
argument_list|,
operator|&
name|av
argument_list|)
condition|)
name|ah
operator|=
name|ipoib_create_ah
argument_list|(
name|priv
argument_list|,
name|priv
operator|->
name|pd
argument_list|,
operator|&
name|av
argument_list|)
expr_stmt|;
block|}
name|spin_lock_irqsave
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|ah
condition|)
block|{
name|path
operator|->
name|pathrec
operator|=
operator|*
name|pathrec
expr_stmt|;
name|old_ah
operator|=
name|path
operator|->
name|ah
expr_stmt|;
name|path
operator|->
name|ah
operator|=
name|ah
expr_stmt|;
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"created address handle %p for LID 0x%04x, SL %d\n"
argument_list|,
name|ah
argument_list|,
name|be16_to_cpu
argument_list|(
name|pathrec
operator|->
name|dlid
argument_list|)
argument_list|,
name|pathrec
operator|->
name|sl
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|_IF_DEQUEUE
argument_list|(
operator|&
name|path
operator|->
name|queue
argument_list|,
name|mb
argument_list|)
expr_stmt|;
if|if
condition|(
name|mb
operator|==
name|NULL
condition|)
break|break;
name|_IF_ENQUEUE
argument_list|(
operator|&
name|mbqueue
argument_list|,
name|mb
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_INFINIBAND_IPOIB_CM
if|if
condition|(
name|ipoib_cm_enabled
argument_list|(
name|priv
argument_list|,
name|path
operator|->
name|hwaddr
argument_list|)
operator|&&
operator|!
name|ipoib_cm_get
argument_list|(
name|path
argument_list|)
condition|)
name|ipoib_cm_set
argument_list|(
name|path
argument_list|,
name|ipoib_cm_create_tx
argument_list|(
name|priv
argument_list|,
name|path
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|path
operator|->
name|valid
operator|=
literal|1
expr_stmt|;
block|}
name|path
operator|->
name|query
operator|=
name|NULL
expr_stmt|;
name|complete
argument_list|(
operator|&
name|path
operator|->
name|done
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|old_ah
condition|)
name|ipoib_put_ah
argument_list|(
name|old_ah
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|_IF_DEQUEUE
argument_list|(
operator|&
name|mbqueue
argument_list|,
name|mb
argument_list|)
expr_stmt|;
if|if
condition|(
name|mb
operator|==
name|NULL
condition|)
break|break;
name|mb
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|dev
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|if_transmit
argument_list|(
name|dev
argument_list|,
name|mb
argument_list|)
condition|)
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"dev_queue_xmit failed "
literal|"to requeue packet\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|ipoib_path
modifier|*
name|path_rec_create
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|uint8_t
modifier|*
name|hwaddr
parameter_list|)
block|{
name|struct
name|ipoib_path
modifier|*
name|path
decl_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|broadcast
condition|)
return|return
name|NULL
return|;
name|path
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
expr|*
name|path
argument_list|,
name|GFP_ATOMIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|path
condition|)
return|return
name|NULL
return|;
name|path
operator|->
name|priv
operator|=
name|priv
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|path
operator|->
name|queue
argument_list|,
sizeof|sizeof
argument_list|(
name|path
operator|->
name|queue
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_INFINIBAND_IPOIB_CM
name|memcpy
argument_list|(
operator|&
name|path
operator|->
name|hwaddr
argument_list|,
name|hwaddr
argument_list|,
name|INFINIBAND_ALEN
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|memcpy
argument_list|(
name|path
operator|->
name|pathrec
operator|.
name|dgid
operator|.
name|raw
argument_list|,
operator|&
name|hwaddr
index|[
literal|4
index|]
argument_list|,
sizeof|sizeof
argument_list|(
expr|union
name|ib_gid
argument_list|)
argument_list|)
expr_stmt|;
name|path
operator|->
name|pathrec
operator|.
name|sgid
operator|=
name|priv
operator|->
name|local_gid
expr_stmt|;
name|path
operator|->
name|pathrec
operator|.
name|pkey
operator|=
name|cpu_to_be16
argument_list|(
name|priv
operator|->
name|pkey
argument_list|)
expr_stmt|;
name|path
operator|->
name|pathrec
operator|.
name|numb_path
operator|=
literal|1
expr_stmt|;
name|path
operator|->
name|pathrec
operator|.
name|traffic_class
operator|=
name|priv
operator|->
name|broadcast
operator|->
name|mcmember
operator|.
name|traffic_class
expr_stmt|;
return|return
name|path
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|path_rec_start
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ipoib_path
modifier|*
name|path
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|dev
init|=
name|priv
operator|->
name|dev
decl_stmt|;
name|ib_sa_comp_mask
name|comp_mask
init|=
name|IB_SA_PATH_REC_MTU_SELECTOR
operator||
name|IB_SA_PATH_REC_MTU
decl_stmt|;
name|struct
name|ib_sa_path_rec
name|p_rec
decl_stmt|;
name|p_rec
operator|=
name|path
operator|->
name|pathrec
expr_stmt|;
name|p_rec
operator|.
name|mtu_selector
operator|=
name|IB_SA_GT
expr_stmt|;
switch|switch
condition|(
name|roundup_pow_of_two
argument_list|(
name|dev
operator|->
name|if_mtu
operator|+
name|IPOIB_ENCAP_LEN
argument_list|)
condition|)
block|{
case|case
literal|512
case|:
name|p_rec
operator|.
name|mtu
operator|=
name|IB_MTU_256
expr_stmt|;
break|break;
case|case
literal|1024
case|:
name|p_rec
operator|.
name|mtu
operator|=
name|IB_MTU_512
expr_stmt|;
break|break;
case|case
literal|2048
case|:
name|p_rec
operator|.
name|mtu
operator|=
name|IB_MTU_1024
expr_stmt|;
break|break;
case|case
literal|4096
case|:
name|p_rec
operator|.
name|mtu
operator|=
name|IB_MTU_2048
expr_stmt|;
break|break;
default|default:
comment|/* Wildcard everything */
name|comp_mask
operator|=
literal|0
expr_stmt|;
name|p_rec
operator|.
name|mtu
operator|=
literal|0
expr_stmt|;
name|p_rec
operator|.
name|mtu_selector
operator|=
literal|0
expr_stmt|;
block|}
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"Start path record lookup for %16D MTU> %d\n"
argument_list|,
name|p_rec
operator|.
name|dgid
operator|.
name|raw
argument_list|,
literal|":"
argument_list|,
name|comp_mask
condition|?
name|ib_mtu_enum_to_int
argument_list|(
name|p_rec
operator|.
name|mtu
argument_list|)
else|:
literal|0
argument_list|)
expr_stmt|;
name|init_completion
argument_list|(
operator|&
name|path
operator|->
name|done
argument_list|)
expr_stmt|;
name|path
operator|->
name|query_id
operator|=
name|ib_sa_path_rec_get
argument_list|(
operator|&
name|ipoib_sa_client
argument_list|,
name|priv
operator|->
name|ca
argument_list|,
name|priv
operator|->
name|port
argument_list|,
operator|&
name|p_rec
argument_list|,
name|comp_mask
operator||
name|IB_SA_PATH_REC_DGID
operator||
name|IB_SA_PATH_REC_SGID
operator||
name|IB_SA_PATH_REC_NUMB_PATH
operator||
name|IB_SA_PATH_REC_TRAFFIC_CLASS
operator||
name|IB_SA_PATH_REC_PKEY
argument_list|,
literal|1000
argument_list|,
name|GFP_ATOMIC
argument_list|,
name|path_rec_completion
argument_list|,
name|path
argument_list|,
operator|&
name|path
operator|->
name|query
argument_list|)
expr_stmt|;
if|if
condition|(
name|path
operator|->
name|query_id
operator|<
literal|0
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"ib_sa_path_rec_get failed: %d\n"
argument_list|,
name|path
operator|->
name|query_id
argument_list|)
expr_stmt|;
name|path
operator|->
name|query
operator|=
name|NULL
expr_stmt|;
name|complete
argument_list|(
operator|&
name|path
operator|->
name|done
argument_list|)
expr_stmt|;
return|return
name|path
operator|->
name|query_id
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_unicast_send
parameter_list|(
name|struct
name|mbuf
modifier|*
name|mb
parameter_list|,
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ipoib_header
modifier|*
name|eh
parameter_list|)
block|{
name|struct
name|ipoib_path
modifier|*
name|path
decl_stmt|;
name|path
operator|=
name|__path_find
argument_list|(
name|priv
argument_list|,
name|eh
operator|->
name|hwaddr
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|path
operator|||
operator|!
name|path
operator|->
name|valid
condition|)
block|{
name|int
name|new_path
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|path
condition|)
block|{
name|path
operator|=
name|path_rec_create
argument_list|(
name|priv
argument_list|,
name|eh
operator|->
name|hwaddr
argument_list|)
expr_stmt|;
name|new_path
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|path
condition|)
block|{
name|_IF_ENQUEUE
argument_list|(
operator|&
name|path
operator|->
name|queue
argument_list|,
name|mb
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|path
operator|->
name|query
operator|&&
name|path_rec_start
argument_list|(
name|priv
argument_list|,
name|path
argument_list|)
condition|)
block|{
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_path
condition|)
name|ipoib_path_free
argument_list|(
name|priv
argument_list|,
name|path
argument_list|)
expr_stmt|;
return|return;
block|}
else|else
name|__path_add
argument_list|(
name|priv
argument_list|,
name|path
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|++
name|priv
operator|->
name|dev
operator|->
name|if_oerrors
expr_stmt|;
name|m_freem
argument_list|(
name|mb
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
if|if
condition|(
name|ipoib_cm_get
argument_list|(
name|path
argument_list|)
operator|&&
name|ipoib_cm_up
argument_list|(
name|path
argument_list|)
condition|)
block|{
name|ipoib_cm_send
argument_list|(
name|priv
argument_list|,
name|mb
argument_list|,
name|ipoib_cm_get
argument_list|(
name|path
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|path
operator|->
name|ah
condition|)
block|{
name|ipoib_send
argument_list|(
name|priv
argument_list|,
name|mb
argument_list|,
name|path
operator|->
name|ah
argument_list|,
name|IPOIB_QPN
argument_list|(
name|eh
operator|->
name|hwaddr
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|path
operator|->
name|query
operator|||
operator|!
name|path_rec_start
argument_list|(
name|priv
argument_list|,
name|path
argument_list|)
operator|)
operator|&&
name|path
operator|->
name|queue
operator|.
name|ifq_len
operator|<
name|IPOIB_MAX_PATH_REC_QUEUE
condition|)
block|{
name|_IF_ENQUEUE
argument_list|(
operator|&
name|path
operator|->
name|queue
argument_list|,
name|mb
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|++
name|priv
operator|->
name|dev
operator|->
name|if_oerrors
expr_stmt|;
name|m_freem
argument_list|(
name|mb
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ipoib_send_one
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mb
parameter_list|)
block|{
name|struct
name|ipoib_header
modifier|*
name|eh
decl_stmt|;
name|eh
operator|=
name|mtod
argument_list|(
name|mb
argument_list|,
expr|struct
name|ipoib_header
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|IPOIB_IS_MULTICAST
argument_list|(
name|eh
operator|->
name|hwaddr
argument_list|)
condition|)
block|{
comment|/* Add in the P_Key for multicast*/
name|eh
operator|->
name|hwaddr
index|[
literal|8
index|]
operator|=
operator|(
name|priv
operator|->
name|pkey
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|eh
operator|->
name|hwaddr
index|[
literal|9
index|]
operator|=
name|priv
operator|->
name|pkey
operator|&
literal|0xff
expr_stmt|;
name|ipoib_mcast_send
argument_list|(
name|priv
argument_list|,
name|eh
operator|->
name|hwaddr
operator|+
literal|4
argument_list|,
name|mb
argument_list|)
expr_stmt|;
block|}
else|else
name|ipoib_unicast_send
argument_list|(
name|mb
argument_list|,
name|priv
argument_list|,
name|eh
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|_ipoib_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|dev
parameter_list|,
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|mb
decl_stmt|;
if|if
condition|(
operator|(
name|dev
operator|->
name|if_drv_flags
operator|&
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
operator|)
operator|!=
name|IFF_DRV_RUNNING
condition|)
return|return;
name|spin_lock
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|IFQ_DRV_IS_EMPTY
argument_list|(
operator|&
name|dev
operator|->
name|if_snd
argument_list|)
operator|&&
operator|(
name|dev
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_OACTIVE
operator|)
operator|==
literal|0
condition|)
block|{
name|IFQ_DRV_DEQUEUE
argument_list|(
operator|&
name|dev
operator|->
name|if_snd
argument_list|,
name|mb
argument_list|)
expr_stmt|;
if|if
condition|(
name|mb
operator|==
name|NULL
condition|)
break|break;
name|IPOIB_MTAP
argument_list|(
name|dev
argument_list|,
name|mb
argument_list|)
expr_stmt|;
name|ipoib_send_one
argument_list|(
name|priv
argument_list|,
name|mb
argument_list|)
expr_stmt|;
block|}
name|spin_unlock
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|dev
parameter_list|)
block|{
name|_ipoib_start
argument_list|(
name|dev
argument_list|,
name|dev
operator|->
name|if_softc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_vlan_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mb
decl_stmt|;
name|priv
operator|=
name|VLAN_COOKIE
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|!=
name|NULL
condition|)
return|return
name|_ipoib_start
argument_list|(
name|dev
argument_list|,
name|priv
argument_list|)
return|;
while|while
condition|(
operator|!
name|IFQ_DRV_IS_EMPTY
argument_list|(
operator|&
name|dev
operator|->
name|if_snd
argument_list|)
condition|)
block|{
name|IFQ_DRV_DEQUEUE
argument_list|(
operator|&
name|dev
operator|->
name|if_snd
argument_list|,
name|mb
argument_list|)
expr_stmt|;
if|if
condition|(
name|mb
operator|==
name|NULL
condition|)
break|break;
name|m_freem
argument_list|(
name|mb
argument_list|)
expr_stmt|;
name|dev
operator|->
name|if_oerrors
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|ipoib_dev_init
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ib_device
modifier|*
name|ca
parameter_list|,
name|int
name|port
parameter_list|)
block|{
comment|/* Allocate RX/TX "rings" to hold queued mbs */
name|priv
operator|->
name|rx_ring
operator|=
name|kzalloc
argument_list|(
name|ipoib_recvq_size
operator|*
sizeof|sizeof
expr|*
name|priv
operator|->
name|rx_ring
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|rx_ring
condition|)
block|{
name|printk
argument_list|(
name|KERN_WARNING
literal|"%s: failed to allocate RX ring (%d entries)\n"
argument_list|,
name|ca
operator|->
name|name
argument_list|,
name|ipoib_recvq_size
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|priv
operator|->
name|tx_ring
operator|=
name|kzalloc
argument_list|(
name|ipoib_sendq_size
operator|*
sizeof|sizeof
expr|*
name|priv
operator|->
name|tx_ring
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|tx_ring
condition|)
block|{
name|printk
argument_list|(
name|KERN_WARNING
literal|"%s: failed to allocate TX ring (%d entries)\n"
argument_list|,
name|ca
operator|->
name|name
argument_list|,
name|ipoib_sendq_size
argument_list|)
expr_stmt|;
goto|goto
name|out_rx_ring_cleanup
goto|;
block|}
name|memset
argument_list|(
name|priv
operator|->
name|tx_ring
argument_list|,
literal|0
argument_list|,
name|ipoib_sendq_size
operator|*
sizeof|sizeof
expr|*
name|priv
operator|->
name|tx_ring
argument_list|)
expr_stmt|;
comment|/* priv->tx_head, tx_tail& tx_outstanding are already 0 */
if|if
condition|(
name|ipoib_ib_dev_init
argument_list|(
name|priv
argument_list|,
name|ca
argument_list|,
name|port
argument_list|)
condition|)
goto|goto
name|out_tx_ring_cleanup
goto|;
return|return
literal|0
return|;
name|out_tx_ring_cleanup
label|:
name|kfree
argument_list|(
name|priv
operator|->
name|tx_ring
argument_list|)
expr_stmt|;
name|out_rx_ring_cleanup
label|:
name|kfree
argument_list|(
name|priv
operator|->
name|rx_ring
argument_list|)
expr_stmt|;
name|out
label|:
return|return
operator|-
name|ENOMEM
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_detach
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|dev
decl_stmt|;
name|dev
operator|=
name|priv
operator|->
name|dev
expr_stmt|;
if|if
condition|(
operator|!
name|test_bit
argument_list|(
name|IPOIB_FLAG_SUBINTERFACE
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
condition|)
block|{
name|bpfdetach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|if_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|if_free
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
else|else
name|VLAN_SETCOOKIE
argument_list|(
name|priv
operator|->
name|dev
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|priv
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ipoib_dev_cleanup
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|cpriv
decl_stmt|,
modifier|*
name|tcpriv
decl_stmt|;
comment|/* Delete any child interfaces first */
name|list_for_each_entry_safe
argument_list|(
argument|cpriv
argument_list|,
argument|tcpriv
argument_list|,
argument|&priv->child_intfs
argument_list|,
argument|list
argument_list|)
block|{
name|ipoib_dev_cleanup
argument_list|(
name|cpriv
argument_list|)
expr_stmt|;
name|ipoib_detach
argument_list|(
name|cpriv
argument_list|)
expr_stmt|;
block|}
name|ipoib_ib_dev_cleanup
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|priv
operator|->
name|rx_ring
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|priv
operator|->
name|tx_ring
argument_list|)
expr_stmt|;
name|priv
operator|->
name|rx_ring
operator|=
name|NULL
expr_stmt|;
name|priv
operator|->
name|tx_ring
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|volatile
name|int
name|ipoib_unit
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|struct
name|ipoib_dev_priv
modifier|*
name|ipoib_priv_alloc
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
decl_stmt|;
name|priv
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ipoib_dev_priv
argument_list|)
argument_list|,
name|M_TEMP
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
expr_stmt|;
name|spin_lock_init
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|mutex_init
argument_list|(
operator|&
name|priv
operator|->
name|vlan_mutex
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|priv
operator|->
name|path_list
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|priv
operator|->
name|child_intfs
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|priv
operator|->
name|dead_ahs
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|priv
operator|->
name|multicast_list
argument_list|)
expr_stmt|;
name|INIT_DELAYED_WORK
argument_list|(
operator|&
name|priv
operator|->
name|pkey_poll_task
argument_list|,
name|ipoib_pkey_poll
argument_list|)
expr_stmt|;
name|INIT_DELAYED_WORK
argument_list|(
operator|&
name|priv
operator|->
name|mcast_task
argument_list|,
name|ipoib_mcast_join_task
argument_list|)
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|priv
operator|->
name|carrier_on_task
argument_list|,
name|ipoib_mcast_carrier_on_task
argument_list|)
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|priv
operator|->
name|flush_light
argument_list|,
name|ipoib_ib_dev_flush_light
argument_list|)
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|priv
operator|->
name|flush_normal
argument_list|,
name|ipoib_ib_dev_flush_normal
argument_list|)
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|priv
operator|->
name|flush_heavy
argument_list|,
name|ipoib_ib_dev_flush_heavy
argument_list|)
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|priv
operator|->
name|restart_task
argument_list|,
name|ipoib_mcast_restart_task
argument_list|)
expr_stmt|;
name|INIT_DELAYED_WORK
argument_list|(
operator|&
name|priv
operator|->
name|ah_reap_task
argument_list|,
name|ipoib_reap_ah
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|priv
operator|->
name|broadcastaddr
argument_list|,
name|ipv4_bcast_addr
argument_list|,
name|INFINIBAND_ALEN
argument_list|)
expr_stmt|;
return|return
operator|(
name|priv
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|ipoib_dev_priv
modifier|*
name|ipoib_intf_alloc
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
decl_stmt|;
name|struct
name|sockaddr_dl
modifier|*
name|sdl
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|dev
decl_stmt|;
name|priv
operator|=
name|ipoib_priv_alloc
argument_list|()
expr_stmt|;
name|dev
operator|=
name|priv
operator|->
name|dev
operator|=
name|if_alloc
argument_list|(
name|IFT_INFINIBAND
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev
condition|)
block|{
name|free
argument_list|(
name|priv
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|dev
operator|->
name|if_softc
operator|=
name|priv
expr_stmt|;
name|if_initname
argument_list|(
name|dev
argument_list|,
name|name
argument_list|,
name|atomic_fetchadd_int
argument_list|(
operator|&
name|ipoib_unit
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|dev
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_MULTICAST
expr_stmt|;
name|dev
operator|->
name|if_addrlen
operator|=
name|INFINIBAND_ALEN
expr_stmt|;
name|dev
operator|->
name|if_hdrlen
operator|=
name|IPOIB_HEADER_LEN
expr_stmt|;
name|if_attach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|dev
operator|->
name|if_init
operator|=
name|ipoib_init
expr_stmt|;
name|dev
operator|->
name|if_ioctl
operator|=
name|ipoib_ioctl
expr_stmt|;
name|dev
operator|->
name|if_start
operator|=
name|ipoib_start
expr_stmt|;
name|dev
operator|->
name|if_output
operator|=
name|ipoib_output
expr_stmt|;
name|dev
operator|->
name|if_input
operator|=
name|ipoib_input
expr_stmt|;
name|dev
operator|->
name|if_resolvemulti
operator|=
name|ipoib_resolvemulti
expr_stmt|;
name|if_initbaudrate
argument_list|(
name|dev
argument_list|,
name|IF_Gbps
argument_list|(
literal|10
argument_list|)
argument_list|)
expr_stmt|;
name|dev
operator|->
name|if_broadcastaddr
operator|=
name|priv
operator|->
name|broadcastaddr
expr_stmt|;
name|dev
operator|->
name|if_snd
operator|.
name|ifq_maxlen
operator|=
name|ipoib_sendq_size
operator|*
literal|2
expr_stmt|;
name|sdl
operator|=
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|dev
operator|->
name|if_addr
operator|->
name|ifa_addr
expr_stmt|;
name|sdl
operator|->
name|sdl_type
operator|=
name|IFT_INFINIBAND
expr_stmt|;
name|sdl
operator|->
name|sdl_alen
operator|=
name|dev
operator|->
name|if_addrlen
expr_stmt|;
name|priv
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|if_link_state_change
argument_list|(
name|dev
argument_list|,
name|LINK_STATE_DOWN
argument_list|)
expr_stmt|;
name|bpfattach
argument_list|(
name|dev
argument_list|,
name|DLT_EN10MB
argument_list|,
name|ETHER_HDR_LEN
argument_list|)
expr_stmt|;
return|return
name|dev
operator|->
name|if_softc
return|;
block|}
end_function

begin_function
name|int
name|ipoib_set_dev_features
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ib_device
modifier|*
name|hca
parameter_list|)
block|{
name|struct
name|ib_device_attr
modifier|*
name|device_attr
decl_stmt|;
name|int
name|result
init|=
operator|-
name|ENOMEM
decl_stmt|;
name|device_attr
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
expr|*
name|device_attr
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|device_attr
condition|)
block|{
name|printk
argument_list|(
name|KERN_WARNING
literal|"%s: allocation of %zu bytes failed\n"
argument_list|,
name|hca
operator|->
name|name
argument_list|,
sizeof|sizeof
expr|*
name|device_attr
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
name|result
operator|=
name|ib_query_device
argument_list|(
name|hca
argument_list|,
name|device_attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
condition|)
block|{
name|printk
argument_list|(
name|KERN_WARNING
literal|"%s: ib_query_device failed (ret = %d)\n"
argument_list|,
name|hca
operator|->
name|name
argument_list|,
name|result
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|device_attr
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
name|priv
operator|->
name|hca_caps
operator|=
name|device_attr
operator|->
name|device_cap_flags
expr_stmt|;
name|kfree
argument_list|(
name|device_attr
argument_list|)
expr_stmt|;
name|priv
operator|->
name|dev
operator|->
name|if_hwassist
operator|=
literal|0
expr_stmt|;
name|priv
operator|->
name|dev
operator|->
name|if_capabilities
operator|=
literal|0
expr_stmt|;
ifndef|#
directive|ifndef
name|CONFIG_INFINIBAND_IPOIB_CM
if|if
condition|(
name|priv
operator|->
name|hca_caps
operator|&
name|IB_DEVICE_UD_IP_CSUM
condition|)
block|{
name|set_bit
argument_list|(
name|IPOIB_FLAG_CSUM
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
expr_stmt|;
name|priv
operator|->
name|dev
operator|->
name|if_hwassist
operator|=
name|CSUM_IP
operator||
name|CSUM_TCP
operator||
name|CSUM_UDP
expr_stmt|;
name|priv
operator|->
name|dev
operator|->
name|if_capabilities
operator|=
name|IFCAP_HWCSUM
operator||
name|IFCAP_VLAN_HWCSUM
expr_stmt|;
block|}
if|#
directive|if
literal|0
block|if (priv->dev->features& NETIF_F_SG&& priv->hca_caps& IB_DEVICE_UD_TSO) { 		priv->dev->if_capabilities |= IFCAP_TSO4; 		priv->dev->if_hwassist |= CSUM_TSO; 	}
endif|#
directive|endif
endif|#
directive|endif
name|priv
operator|->
name|dev
operator|->
name|if_capabilities
operator||=
name|IFCAP_VLAN_HWTAGGING
operator||
name|IFCAP_VLAN_MTU
operator||
name|IFCAP_LINKSTATE
expr_stmt|;
name|priv
operator|->
name|dev
operator|->
name|if_capenable
operator|=
name|priv
operator|->
name|dev
operator|->
name|if_capabilities
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ifnet
modifier|*
name|ipoib_add_port
parameter_list|(
specifier|const
name|char
modifier|*
name|format
parameter_list|,
name|struct
name|ib_device
modifier|*
name|hca
parameter_list|,
name|u8
name|port
parameter_list|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
decl_stmt|;
name|struct
name|ib_port_attr
name|attr
decl_stmt|;
name|int
name|result
init|=
operator|-
name|ENOMEM
decl_stmt|;
name|priv
operator|=
name|ipoib_intf_alloc
argument_list|(
name|format
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|priv
condition|)
goto|goto
name|alloc_mem_failed
goto|;
if|if
condition|(
operator|!
name|ib_query_port
argument_list|(
name|hca
argument_list|,
name|port
argument_list|,
operator|&
name|attr
argument_list|)
condition|)
name|priv
operator|->
name|max_ib_mtu
operator|=
name|ib_mtu_enum_to_int
argument_list|(
name|attr
operator|.
name|max_mtu
argument_list|)
expr_stmt|;
else|else
block|{
name|printk
argument_list|(
name|KERN_WARNING
literal|"%s: ib_query_port %d failed\n"
argument_list|,
name|hca
operator|->
name|name
argument_list|,
name|port
argument_list|)
expr_stmt|;
goto|goto
name|device_init_failed
goto|;
block|}
comment|/* MTU will be reset when mcast join happens */
name|priv
operator|->
name|dev
operator|->
name|if_mtu
operator|=
name|IPOIB_UD_MTU
argument_list|(
name|priv
operator|->
name|max_ib_mtu
argument_list|)
expr_stmt|;
name|priv
operator|->
name|mcast_mtu
operator|=
name|priv
operator|->
name|admin_mtu
operator|=
name|priv
operator|->
name|dev
operator|->
name|if_mtu
expr_stmt|;
name|result
operator|=
name|ib_query_pkey
argument_list|(
name|hca
argument_list|,
name|port
argument_list|,
literal|0
argument_list|,
operator|&
name|priv
operator|->
name|pkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
condition|)
block|{
name|printk
argument_list|(
name|KERN_WARNING
literal|"%s: ib_query_pkey port %d failed (ret = %d)\n"
argument_list|,
name|hca
operator|->
name|name
argument_list|,
name|port
argument_list|,
name|result
argument_list|)
expr_stmt|;
goto|goto
name|device_init_failed
goto|;
block|}
if|if
condition|(
name|ipoib_set_dev_features
argument_list|(
name|priv
argument_list|,
name|hca
argument_list|)
condition|)
goto|goto
name|device_init_failed
goto|;
comment|/* 	 * Set the full membership bit, so that we join the right 	 * broadcast group, etc. 	 */
name|priv
operator|->
name|pkey
operator||=
literal|0x8000
expr_stmt|;
name|priv
operator|->
name|broadcastaddr
index|[
literal|8
index|]
operator|=
name|priv
operator|->
name|pkey
operator|>>
literal|8
expr_stmt|;
name|priv
operator|->
name|broadcastaddr
index|[
literal|9
index|]
operator|=
name|priv
operator|->
name|pkey
operator|&
literal|0xff
expr_stmt|;
name|result
operator|=
name|ib_query_gid
argument_list|(
name|hca
argument_list|,
name|port
argument_list|,
literal|0
argument_list|,
operator|&
name|priv
operator|->
name|local_gid
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
condition|)
block|{
name|printk
argument_list|(
name|KERN_WARNING
literal|"%s: ib_query_gid port %d failed (ret = %d)\n"
argument_list|,
name|hca
operator|->
name|name
argument_list|,
name|port
argument_list|,
name|result
argument_list|)
expr_stmt|;
goto|goto
name|device_init_failed
goto|;
block|}
name|memcpy
argument_list|(
name|IF_LLADDR
argument_list|(
name|priv
operator|->
name|dev
argument_list|)
operator|+
literal|4
argument_list|,
name|priv
operator|->
name|local_gid
operator|.
name|raw
argument_list|,
sizeof|sizeof
argument_list|(
expr|union
name|ib_gid
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|ipoib_dev_init
argument_list|(
name|priv
argument_list|,
name|hca
argument_list|,
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|<
literal|0
condition|)
block|{
name|printk
argument_list|(
name|KERN_WARNING
literal|"%s: failed to initialize port %d (ret = %d)\n"
argument_list|,
name|hca
operator|->
name|name
argument_list|,
name|port
argument_list|,
name|result
argument_list|)
expr_stmt|;
goto|goto
name|device_init_failed
goto|;
block|}
if|if
condition|(
name|ipoib_cm_admin_enabled
argument_list|(
name|priv
argument_list|)
condition|)
name|priv
operator|->
name|dev
operator|->
name|if_mtu
operator|=
name|IPOIB_CM_MTU
argument_list|(
name|ipoib_cm_max_mtu
argument_list|(
name|priv
argument_list|)
argument_list|)
expr_stmt|;
name|INIT_IB_EVENT_HANDLER
argument_list|(
operator|&
name|priv
operator|->
name|event_handler
argument_list|,
name|priv
operator|->
name|ca
argument_list|,
name|ipoib_event
argument_list|)
expr_stmt|;
name|result
operator|=
name|ib_register_event_handler
argument_list|(
operator|&
name|priv
operator|->
name|event_handler
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|<
literal|0
condition|)
block|{
name|printk
argument_list|(
name|KERN_WARNING
literal|"%s: ib_register_event_handler failed for "
literal|"port %d (ret = %d)\n"
argument_list|,
name|hca
operator|->
name|name
argument_list|,
name|port
argument_list|,
name|result
argument_list|)
expr_stmt|;
goto|goto
name|event_failed
goto|;
block|}
name|if_printf
argument_list|(
name|priv
operator|->
name|dev
argument_list|,
literal|"Attached to %s port %d\n"
argument_list|,
name|hca
operator|->
name|name
argument_list|,
name|port
argument_list|)
expr_stmt|;
return|return
name|priv
operator|->
name|dev
return|;
name|event_failed
label|:
name|ipoib_dev_cleanup
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|device_init_failed
label|:
name|ipoib_detach
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|alloc_mem_failed
label|:
return|return
name|ERR_PTR
argument_list|(
name|result
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_add_one
parameter_list|(
name|struct
name|ib_device
modifier|*
name|device
parameter_list|)
block|{
name|struct
name|list_head
modifier|*
name|dev_list
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|dev
decl_stmt|;
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
decl_stmt|;
name|int
name|s
decl_stmt|,
name|e
decl_stmt|,
name|p
decl_stmt|;
if|if
condition|(
name|rdma_node_get_transport
argument_list|(
name|device
operator|->
name|node_type
argument_list|)
operator|!=
name|RDMA_TRANSPORT_IB
condition|)
return|return;
name|dev_list
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
expr|*
name|dev_list
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dev_list
condition|)
return|return;
name|INIT_LIST_HEAD
argument_list|(
name|dev_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|device
operator|->
name|node_type
operator|==
name|RDMA_NODE_IB_SWITCH
condition|)
block|{
name|s
operator|=
literal|0
expr_stmt|;
name|e
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|s
operator|=
literal|1
expr_stmt|;
name|e
operator|=
name|device
operator|->
name|phys_port_cnt
expr_stmt|;
block|}
for|for
control|(
name|p
operator|=
name|s
init|;
name|p
operator|<=
name|e
condition|;
operator|++
name|p
control|)
block|{
if|if
condition|(
name|rdma_port_get_link_layer
argument_list|(
name|device
argument_list|,
name|p
argument_list|)
operator|!=
name|IB_LINK_LAYER_INFINIBAND
condition|)
continue|continue;
name|dev
operator|=
name|ipoib_add_port
argument_list|(
literal|"ib"
argument_list|,
name|device
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IS_ERR
argument_list|(
name|dev
argument_list|)
condition|)
block|{
name|priv
operator|=
name|dev
operator|->
name|if_softc
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|priv
operator|->
name|list
argument_list|,
name|dev_list
argument_list|)
expr_stmt|;
block|}
block|}
name|ib_set_client_data
argument_list|(
name|device
argument_list|,
operator|&
name|ipoib_client
argument_list|,
name|dev_list
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_remove_one
parameter_list|(
name|struct
name|ib_device
modifier|*
name|device
parameter_list|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|struct
name|list_head
modifier|*
name|dev_list
decl_stmt|;
if|if
condition|(
name|rdma_node_get_transport
argument_list|(
name|device
operator|->
name|node_type
argument_list|)
operator|!=
name|RDMA_TRANSPORT_IB
condition|)
return|return;
name|dev_list
operator|=
name|ib_get_client_data
argument_list|(
name|device
argument_list|,
operator|&
name|ipoib_client
argument_list|)
expr_stmt|;
name|list_for_each_entry_safe
argument_list|(
argument|priv
argument_list|,
argument|tmp
argument_list|,
argument|dev_list
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|rdma_port_get_link_layer
argument_list|(
name|device
argument_list|,
name|priv
operator|->
name|port
argument_list|)
operator|!=
name|IB_LINK_LAYER_INFINIBAND
condition|)
continue|continue;
name|ib_unregister_event_handler
argument_list|(
operator|&
name|priv
operator|->
name|event_handler
argument_list|)
expr_stmt|;
comment|/* dev_change_flags(priv->dev, priv->dev->flags& ~IFF_UP); */
name|flush_workqueue
argument_list|(
name|ipoib_workqueue
argument_list|)
expr_stmt|;
name|ipoib_dev_cleanup
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|ipoib_detach
argument_list|(
name|priv
argument_list|)
expr_stmt|;
block|}
name|kfree
argument_list|(
name|dev_list
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_config_vlan
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_int16_t
name|vtag
parameter_list|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|parent
decl_stmt|;
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|dev
decl_stmt|;
name|uint16_t
name|pkey
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_type
operator|!=
name|IFT_INFINIBAND
condition|)
return|return;
name|dev
operator|=
name|VLAN_DEVAT
argument_list|(
name|ifp
argument_list|,
name|vtag
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|==
name|NULL
condition|)
return|return;
name|priv
operator|=
name|NULL
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|parent
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
comment|/* We only support 15 bits of pkey. */
if|if
condition|(
name|vtag
operator|&
literal|0x8000
condition|)
return|return;
name|pkey
operator|=
name|vtag
operator||
literal|0x8000
expr_stmt|;
comment|/* Set full membership bit. */
if|if
condition|(
name|pkey
operator|==
name|parent
operator|->
name|pkey
condition|)
return|return;
comment|/* Check for dups */
name|mutex_lock
argument_list|(
operator|&
name|parent
operator|->
name|vlan_mutex
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|priv
argument_list|,
argument|&parent->child_intfs
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|priv
operator|->
name|pkey
operator|==
name|pkey
condition|)
block|{
name|priv
operator|=
name|NULL
expr_stmt|;
name|error
operator|=
name|EBUSY
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|priv
operator|=
name|ipoib_priv_alloc
argument_list|()
expr_stmt|;
name|priv
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|priv
operator|->
name|max_ib_mtu
operator|=
name|parent
operator|->
name|max_ib_mtu
expr_stmt|;
name|priv
operator|->
name|mcast_mtu
operator|=
name|priv
operator|->
name|admin_mtu
operator|=
name|parent
operator|->
name|dev
operator|->
name|if_mtu
expr_stmt|;
name|set_bit
argument_list|(
name|IPOIB_FLAG_SUBINTERFACE
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
expr_stmt|;
name|error
operator|=
name|ipoib_set_dev_features
argument_list|(
name|priv
argument_list|,
name|parent
operator|->
name|ca
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|out
goto|;
name|priv
operator|->
name|pkey
operator|=
name|pkey
expr_stmt|;
name|priv
operator|->
name|broadcastaddr
index|[
literal|8
index|]
operator|=
name|pkey
operator|>>
literal|8
expr_stmt|;
name|priv
operator|->
name|broadcastaddr
index|[
literal|9
index|]
operator|=
name|pkey
operator|&
literal|0xff
expr_stmt|;
name|dev
operator|->
name|if_broadcastaddr
operator|=
name|priv
operator|->
name|broadcastaddr
expr_stmt|;
name|error
operator|=
name|ipoib_dev_init
argument_list|(
name|priv
argument_list|,
name|parent
operator|->
name|ca
argument_list|,
name|parent
operator|->
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|out
goto|;
name|priv
operator|->
name|parent
operator|=
name|parent
operator|->
name|dev
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|priv
operator|->
name|list
argument_list|,
operator|&
name|parent
operator|->
name|child_intfs
argument_list|)
expr_stmt|;
name|VLAN_SETCOOKIE
argument_list|(
name|dev
argument_list|,
name|priv
argument_list|)
expr_stmt|;
name|dev
operator|->
name|if_start
operator|=
name|ipoib_vlan_start
expr_stmt|;
name|dev
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_RUNNING
expr_stmt|;
name|dev
operator|->
name|if_hdrlen
operator|=
name|IPOIB_HEADER_LEN
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|ipoib_open
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|parent
operator|->
name|vlan_mutex
argument_list|)
expr_stmt|;
return|return;
name|out
label|:
name|mutex_unlock
argument_list|(
operator|&
name|parent
operator|->
name|vlan_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
condition|)
name|free
argument_list|(
name|priv
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|ipoib_warn
argument_list|(
name|parent
argument_list|,
literal|"failed to initialize subinterface: device %s, port %d vtag 0x%X"
argument_list|,
name|parent
operator|->
name|ca
operator|->
name|name
argument_list|,
name|parent
operator|->
name|port
argument_list|,
name|vtag
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_unconfig_vlan
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_int16_t
name|vtag
parameter_list|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|parent
decl_stmt|;
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|dev
decl_stmt|;
name|uint16_t
name|pkey
decl_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_type
operator|!=
name|IFT_INFINIBAND
condition|)
return|return;
name|dev
operator|=
name|VLAN_DEVAT
argument_list|(
name|ifp
argument_list|,
name|vtag
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
condition|)
name|VLAN_SETCOOKIE
argument_list|(
name|dev
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|pkey
operator|=
name|vtag
operator||
literal|0x8000
expr_stmt|;
name|parent
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|parent
operator|->
name|vlan_mutex
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
argument|priv
argument_list|,
argument|&parent->child_intfs
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|priv
operator|->
name|pkey
operator|==
name|pkey
condition|)
block|{
name|ipoib_dev_cleanup
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|list_del
argument_list|(
operator|&
name|priv
operator|->
name|list
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|mutex_unlock
argument_list|(
operator|&
name|parent
operator|->
name|vlan_mutex
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|eventhandler_tag
name|ipoib_vlan_attach
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|eventhandler_tag
name|ipoib_vlan_detach
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|__init
name|ipoib_init_module
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ipoib_recvq_size
operator|=
name|roundup_pow_of_two
argument_list|(
name|ipoib_recvq_size
argument_list|)
expr_stmt|;
name|ipoib_recvq_size
operator|=
name|min
argument_list|(
name|ipoib_recvq_size
argument_list|,
name|IPOIB_MAX_QUEUE_SIZE
argument_list|)
expr_stmt|;
name|ipoib_recvq_size
operator|=
name|max
argument_list|(
name|ipoib_recvq_size
argument_list|,
name|IPOIB_MIN_QUEUE_SIZE
argument_list|)
expr_stmt|;
name|ipoib_sendq_size
operator|=
name|roundup_pow_of_two
argument_list|(
name|ipoib_sendq_size
argument_list|)
expr_stmt|;
name|ipoib_sendq_size
operator|=
name|min
argument_list|(
name|ipoib_sendq_size
argument_list|,
name|IPOIB_MAX_QUEUE_SIZE
argument_list|)
expr_stmt|;
name|ipoib_sendq_size
operator|=
name|max
argument_list|(
name|ipoib_sendq_size
argument_list|,
name|max
argument_list|(
literal|2
operator|*
name|MAX_SEND_CQE
argument_list|,
name|IPOIB_MIN_QUEUE_SIZE
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_INFINIBAND_IPOIB_CM
name|ipoib_max_conn_qp
operator|=
name|min
argument_list|(
name|ipoib_max_conn_qp
argument_list|,
name|IPOIB_CM_MAX_CONN_QP
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ipoib_vlan_attach
operator|=
name|EVENTHANDLER_REGISTER
argument_list|(
name|vlan_config
argument_list|,
name|ipoib_config_vlan
argument_list|,
name|NULL
argument_list|,
name|EVENTHANDLER_PRI_FIRST
argument_list|)
expr_stmt|;
name|ipoib_vlan_detach
operator|=
name|EVENTHANDLER_REGISTER
argument_list|(
name|vlan_unconfig
argument_list|,
name|ipoib_unconfig_vlan
argument_list|,
name|NULL
argument_list|,
name|EVENTHANDLER_PRI_FIRST
argument_list|)
expr_stmt|;
comment|/* 	 * We create our own workqueue mainly because we want to be 	 * able to flush it when devices are being removed.  We can't 	 * use schedule_work()/flush_scheduled_work() because both 	 * unregister_netdev() and linkwatch_event take the rtnl lock, 	 * so flush_scheduled_work() can deadlock during device 	 * removal. 	 */
name|ipoib_workqueue
operator|=
name|create_singlethread_workqueue
argument_list|(
literal|"ipoib"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ipoib_workqueue
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_fs
goto|;
block|}
name|ib_sa_register_client
argument_list|(
operator|&
name|ipoib_sa_client
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_register_client
argument_list|(
operator|&
name|ipoib_client
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_sa
goto|;
return|return
literal|0
return|;
name|err_sa
label|:
name|ib_sa_unregister_client
argument_list|(
operator|&
name|ipoib_sa_client
argument_list|)
expr_stmt|;
name|destroy_workqueue
argument_list|(
name|ipoib_workqueue
argument_list|)
expr_stmt|;
name|err_fs
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|__exit
name|ipoib_cleanup_module
parameter_list|(
name|void
parameter_list|)
block|{
name|EVENTHANDLER_DEREGISTER
argument_list|(
name|vlan_config
argument_list|,
name|ipoib_vlan_attach
argument_list|)
expr_stmt|;
name|EVENTHANDLER_DEREGISTER
argument_list|(
name|vlan_unconfig
argument_list|,
name|ipoib_vlan_detach
argument_list|)
expr_stmt|;
name|ib_unregister_client
argument_list|(
operator|&
name|ipoib_client
argument_list|)
expr_stmt|;
name|ib_sa_unregister_client
argument_list|(
operator|&
name|ipoib_sa_client
argument_list|)
expr_stmt|;
name|destroy_workqueue
argument_list|(
name|ipoib_workqueue
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Infiniband output routine.  */
end_comment

begin_function
specifier|static
name|int
name|ipoib_output
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|dst
parameter_list|,
name|struct
name|route
modifier|*
name|ro
parameter_list|)
block|{
name|u_char
name|edst
index|[
name|INFINIBAND_ALEN
index|]
decl_stmt|;
name|struct
name|llentry
modifier|*
name|lle
init|=
name|NULL
decl_stmt|;
name|struct
name|rtentry
modifier|*
name|rt0
init|=
name|NULL
decl_stmt|;
name|struct
name|ipoib_header
modifier|*
name|eh
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|short
name|type
decl_stmt|;
if|if
condition|(
name|ro
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|m
operator|->
name|m_flags
operator|&
operator|(
name|M_BCAST
operator||
name|M_MCAST
operator|)
operator|)
condition|)
name|lle
operator|=
name|ro
operator|->
name|ro_lle
expr_stmt|;
name|rt0
operator|=
name|ro
operator|->
name|ro_rt
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|MAC
name|error
operator|=
name|mac_ifnet_check_transmit
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|bad
goto|;
endif|#
directive|endif
name|M_PROFILE
argument_list|(
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_MONITOR
condition|)
block|{
name|error
operator|=
name|ENETDOWN
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
operator|!
operator|(
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
operator|)
operator|&&
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|)
condition|)
block|{
name|error
operator|=
name|ENETDOWN
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
switch|switch
condition|(
name|dst
operator|->
name|sa_family
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
if|if
condition|(
name|lle
operator|!=
name|NULL
operator|&&
operator|(
name|lle
operator|->
name|la_flags
operator|&
name|LLE_VALID
operator|)
condition|)
name|memcpy
argument_list|(
name|edst
argument_list|,
operator|&
name|lle
operator|->
name|ll_addr
operator|.
name|mac8
argument_list|,
sizeof|sizeof
argument_list|(
name|edst
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|m
operator|->
name|m_flags
operator|&
name|M_MCAST
condition|)
name|ip_ib_mc_map
argument_list|(
operator|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|dst
operator|)
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|,
name|ifp
operator|->
name|if_broadcastaddr
argument_list|,
name|edst
argument_list|)
expr_stmt|;
else|else
name|error
operator|=
name|arpresolve
argument_list|(
name|ifp
argument_list|,
name|rt0
argument_list|,
name|m
argument_list|,
name|dst
argument_list|,
name|edst
argument_list|,
operator|&
name|lle
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|==
name|EWOULDBLOCK
condition|?
literal|0
else|:
name|error
operator|)
return|;
name|type
operator|=
name|htons
argument_list|(
name|ETHERTYPE_IP
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_ARP
case|:
block|{
name|struct
name|arphdr
modifier|*
name|ah
decl_stmt|;
name|ah
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|arphdr
operator|*
argument_list|)
expr_stmt|;
name|ah
operator|->
name|ar_hrd
operator|=
name|htons
argument_list|(
name|ARPHRD_INFINIBAND
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ntohs
argument_list|(
name|ah
operator|->
name|ar_op
argument_list|)
condition|)
block|{
case|case
name|ARPOP_REVREQUEST
case|:
case|case
name|ARPOP_REVREPLY
case|:
name|type
operator|=
name|htons
argument_list|(
name|ETHERTYPE_REVARP
argument_list|)
expr_stmt|;
break|break;
case|case
name|ARPOP_REQUEST
case|:
case|case
name|ARPOP_REPLY
case|:
default|default:
name|type
operator|=
name|htons
argument_list|(
name|ETHERTYPE_ARP
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|m
operator|->
name|m_flags
operator|&
name|M_BCAST
condition|)
name|bcopy
argument_list|(
name|ifp
operator|->
name|if_broadcastaddr
argument_list|,
name|edst
argument_list|,
name|INFINIBAND_ALEN
argument_list|)
expr_stmt|;
else|else
name|bcopy
argument_list|(
name|ar_tha
argument_list|(
name|ah
argument_list|)
argument_list|,
name|edst
argument_list|,
name|INFINIBAND_ALEN
argument_list|)
expr_stmt|;
block|}
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
if|if
condition|(
name|lle
operator|!=
name|NULL
operator|&&
operator|(
name|lle
operator|->
name|la_flags
operator|&
name|LLE_VALID
operator|)
condition|)
name|memcpy
argument_list|(
name|edst
argument_list|,
operator|&
name|lle
operator|->
name|ll_addr
operator|.
name|mac8
argument_list|,
sizeof|sizeof
argument_list|(
name|edst
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|m
operator|->
name|m_flags
operator|&
name|M_MCAST
condition|)
name|ipv6_ib_mc_map
argument_list|(
operator|&
operator|(
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|dst
operator|)
operator|->
name|sin6_addr
argument_list|,
name|ifp
operator|->
name|if_broadcastaddr
argument_list|,
name|edst
argument_list|)
expr_stmt|;
else|else
name|error
operator|=
name|nd6_storelladdr
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|,
name|dst
argument_list|,
operator|(
name|u_char
operator|*
operator|)
name|edst
argument_list|,
operator|&
name|lle
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
name|type
operator|=
name|htons
argument_list|(
name|ETHERTYPE_IPV6
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"can't handle af%d\n"
argument_list|,
name|dst
operator|->
name|sa_family
argument_list|)
expr_stmt|;
name|error
operator|=
name|EAFNOSUPPORT
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
comment|/* 	 * Add local net header.  If no space in first mbuf, 	 * allocate another. 	 */
name|M_PREPEND
argument_list|(
name|m
argument_list|,
name|IPOIB_HEADER_LEN
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOBUFS
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|eh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ipoib_header
operator|*
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|memcpy
argument_list|(
operator|&
name|eh
operator|->
name|proto
argument_list|,
operator|&
name|type
argument_list|,
sizeof|sizeof
argument_list|(
name|eh
operator|->
name|proto
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|memcpy
argument_list|(
operator|&
name|eh
operator|->
name|hwaddr
argument_list|,
name|edst
argument_list|,
sizeof|sizeof
argument_list|(
name|edst
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Queue message on interface, update output statistics if 	 * successful, and start output if interface not yet active. 	 */
return|return
operator|(
call|(
name|ifp
operator|->
name|if_transmit
call|)
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|)
operator|)
return|;
name|bad
label|:
if|if
condition|(
name|m
operator|!=
name|NULL
condition|)
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Upper layer processing for a received Infiniband packet.  */
end_comment

begin_function
name|void
name|ipoib_demux
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|u_short
name|proto
parameter_list|)
block|{
name|int
name|isr
decl_stmt|;
ifdef|#
directive|ifdef
name|MAC
comment|/* 	 * Tag the mbuf with an appropriate MAC label before any other 	 * consumers can get to it. 	 */
name|mac_ifnet_create_mbuf
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Allow monitor mode to claim this frame, after stats are updated. */
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_MONITOR
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"discard frame at IFF_MONITOR\n"
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Dispatch frame to upper layer. 	 */
switch|switch
condition|(
name|proto
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|ETHERTYPE_IP
case|:
name|isr
operator|=
name|NETISR_IP
expr_stmt|;
break|break;
case|case
name|ETHERTYPE_ARP
case|:
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_NOARP
condition|)
block|{
comment|/* Discard packet if ARP is disabled on interface */
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
name|isr
operator|=
name|NETISR_ARP
expr_stmt|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INET6
case|case
name|ETHERTYPE_IPV6
case|:
name|isr
operator|=
name|NETISR_IPV6
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
goto|goto
name|discard
goto|;
block|}
name|netisr_dispatch
argument_list|(
name|isr
argument_list|,
name|m
argument_list|)
expr_stmt|;
return|return;
name|discard
label|:
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Process a received Infiniband packet.  */
end_comment

begin_function
specifier|static
name|void
name|ipoib_input
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|ipoib_header
modifier|*
name|eh
decl_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
operator|)
operator|==
literal|0
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
name|CURVNET_SET_QUIET
argument_list|(
name|ifp
operator|->
name|if_vnet
argument_list|)
expr_stmt|;
comment|/* Let BPF have it before we strip the header. */
name|IPOIB_MTAP
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|eh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ipoib_header
operator|*
argument_list|)
expr_stmt|;
comment|/* 	 * Reset layer specific mbuf flags to avoid confusing upper layers. 	 * Strip off Infiniband header. 	 */
name|m
operator|->
name|m_flags
operator|&=
operator|~
name|M_VLANTAG
expr_stmt|;
name|m
operator|->
name|m_flags
operator|&=
operator|~
operator|(
name|M_PROTOFLAGS
operator|)
expr_stmt|;
name|m_adj
argument_list|(
name|m
argument_list|,
name|IPOIB_HEADER_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|IPOIB_IS_MULTICAST
argument_list|(
name|eh
operator|->
name|hwaddr
argument_list|)
condition|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|eh
operator|->
name|hwaddr
argument_list|,
name|ifp
operator|->
name|if_broadcastaddr
argument_list|,
name|ifp
operator|->
name|if_addrlen
argument_list|)
operator|==
literal|0
condition|)
name|m
operator|->
name|m_flags
operator||=
name|M_BCAST
expr_stmt|;
else|else
name|m
operator|->
name|m_flags
operator||=
name|M_MCAST
expr_stmt|;
name|ifp
operator|->
name|if_imcasts
operator|++
expr_stmt|;
block|}
name|ipoib_demux
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|,
name|ntohs
argument_list|(
name|eh
operator|->
name|proto
argument_list|)
argument_list|)
expr_stmt|;
name|CURVNET_RESTORE
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ipoib_resolvemulti
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|sockaddr
modifier|*
modifier|*
name|llsa
parameter_list|,
name|struct
name|sockaddr
modifier|*
name|sa
parameter_list|)
block|{
name|struct
name|sockaddr_dl
modifier|*
name|sdl
decl_stmt|;
ifdef|#
directive|ifdef
name|INET
name|struct
name|sockaddr_in
modifier|*
name|sin
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INET6
name|struct
name|sockaddr_in6
modifier|*
name|sin6
decl_stmt|;
endif|#
directive|endif
name|u_char
modifier|*
name|e_addr
decl_stmt|;
switch|switch
condition|(
name|sa
operator|->
name|sa_family
condition|)
block|{
case|case
name|AF_LINK
case|:
comment|/* 		 * No mapping needed. Just check that it's a valid MC address. 		 */
name|sdl
operator|=
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|sa
expr_stmt|;
name|e_addr
operator|=
name|LLADDR
argument_list|(
name|sdl
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IPOIB_IS_MULTICAST
argument_list|(
name|e_addr
argument_list|)
condition|)
return|return
name|EADDRNOTAVAIL
return|;
operator|*
name|llsa
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
name|sin
operator|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|sa
expr_stmt|;
if|if
condition|(
operator|!
name|IN_MULTICAST
argument_list|(
name|ntohl
argument_list|(
name|sin
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|)
argument_list|)
condition|)
return|return
name|EADDRNOTAVAIL
return|;
name|sdl
operator|=
name|malloc
argument_list|(
sizeof|sizeof
expr|*
name|sdl
argument_list|,
name|M_IFMADDR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdl
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|sdl
operator|->
name|sdl_len
operator|=
sizeof|sizeof
expr|*
name|sdl
expr_stmt|;
name|sdl
operator|->
name|sdl_family
operator|=
name|AF_LINK
expr_stmt|;
name|sdl
operator|->
name|sdl_index
operator|=
name|ifp
operator|->
name|if_index
expr_stmt|;
name|sdl
operator|->
name|sdl_type
operator|=
name|IFT_INFINIBAND
expr_stmt|;
name|sdl
operator|->
name|sdl_alen
operator|=
name|INFINIBAND_ALEN
expr_stmt|;
name|e_addr
operator|=
name|LLADDR
argument_list|(
name|sdl
argument_list|)
expr_stmt|;
name|ip_ib_mc_map
argument_list|(
name|sin
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|,
name|ifp
operator|->
name|if_broadcastaddr
argument_list|,
name|e_addr
argument_list|)
expr_stmt|;
operator|*
name|llsa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|sdl
expr_stmt|;
return|return
literal|0
return|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
name|sin6
operator|=
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|sa
expr_stmt|;
comment|/* 		 * An IP6 address of 0 means listen to all 		 * of the multicast address used for IP6.   		 * This has no meaning in ipoib. 		 */
if|if
condition|(
name|IN6_IS_ADDR_UNSPECIFIED
argument_list|(
operator|&
name|sin6
operator|->
name|sin6_addr
argument_list|)
condition|)
return|return
name|EADDRNOTAVAIL
return|;
if|if
condition|(
operator|!
name|IN6_IS_ADDR_MULTICAST
argument_list|(
operator|&
name|sin6
operator|->
name|sin6_addr
argument_list|)
condition|)
return|return
name|EADDRNOTAVAIL
return|;
name|sdl
operator|=
name|malloc
argument_list|(
sizeof|sizeof
expr|*
name|sdl
argument_list|,
name|M_IFMADDR
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|sdl
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|sdl
operator|->
name|sdl_len
operator|=
sizeof|sizeof
expr|*
name|sdl
expr_stmt|;
name|sdl
operator|->
name|sdl_family
operator|=
name|AF_LINK
expr_stmt|;
name|sdl
operator|->
name|sdl_index
operator|=
name|ifp
operator|->
name|if_index
expr_stmt|;
name|sdl
operator|->
name|sdl_type
operator|=
name|IFT_INFINIBAND
expr_stmt|;
name|sdl
operator|->
name|sdl_alen
operator|=
name|INFINIBAND_ALEN
expr_stmt|;
name|e_addr
operator|=
name|LLADDR
argument_list|(
name|sdl
argument_list|)
expr_stmt|;
name|ipv6_ib_mc_map
argument_list|(
operator|&
name|sin6
operator|->
name|sin6_addr
argument_list|,
name|ifp
operator|->
name|if_broadcastaddr
argument_list|,
name|e_addr
argument_list|)
expr_stmt|;
operator|*
name|llsa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|sdl
expr_stmt|;
return|return
literal|0
return|;
endif|#
directive|endif
default|default:
return|return
name|EAFNOSUPPORT
return|;
block|}
block|}
end_function

begin_expr_stmt
name|module_init
argument_list|(
name|ipoib_init_module
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|module_exit
argument_list|(
name|ipoib_cleanup_module
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


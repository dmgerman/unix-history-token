begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2004, 2005 Topspin Communications.  All rights reserved.  * Copyright (c) 2005 Sun Microsystems, Inc. All rights reserved.  * Copyright (c) 2005 Mellanox Technologies. All rights reserved.  * Copyright (c) 2004, 2005 Voltaire, Inc. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|"ipoib.h"
end_include

begin_include
include|#
directive|include
file|<rdma/ib_cache.h>
end_include

begin_include
include|#
directive|include
file|<security/mac/mac_framework.h>
end_include

begin_include
include|#
directive|include
file|<linux/delay.h>
end_include

begin_include
include|#
directive|include
file|<linux/dma-mapping.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_INFINIBAND_IPOIB_DEBUG_DATA
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|data_debug_level
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|module_param
argument_list|(
name|data_debug_level
argument_list|,
name|int
argument_list|,
literal|0644
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|data_debug_level
argument_list|,
literal|"Enable data path debug tracing if> 0"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_expr_stmt
specifier|static
name|DEFINE_MUTEX
argument_list|(
name|pkey_mutex
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|struct
name|ipoib_ah
modifier|*
name|ipoib_create_ah
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ib_pd
modifier|*
name|pd
parameter_list|,
name|struct
name|ib_ah_attr
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|ipoib_ah
modifier|*
name|ah
decl_stmt|;
name|ah
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
expr|*
name|ah
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ah
condition|)
return|return
name|NULL
return|;
name|ah
operator|->
name|priv
operator|=
name|priv
expr_stmt|;
name|ah
operator|->
name|last_send
operator|=
literal|0
expr_stmt|;
name|kref_init
argument_list|(
operator|&
name|ah
operator|->
name|ref
argument_list|)
expr_stmt|;
name|ah
operator|->
name|ah
operator|=
name|ib_create_ah
argument_list|(
name|pd
argument_list|,
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|ah
operator|->
name|ah
argument_list|)
condition|)
block|{
name|kfree
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|ah
operator|=
name|NULL
expr_stmt|;
block|}
else|else
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"Created ah %p\n"
argument_list|,
name|ah
operator|->
name|ah
argument_list|)
expr_stmt|;
return|return
name|ah
return|;
block|}
end_function

begin_function
name|void
name|ipoib_free_ah
parameter_list|(
name|struct
name|kref
modifier|*
name|kref
parameter_list|)
block|{
name|struct
name|ipoib_ah
modifier|*
name|ah
init|=
name|container_of
argument_list|(
name|kref
argument_list|,
expr|struct
name|ipoib_ah
argument_list|,
name|ref
argument_list|)
decl_stmt|;
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
init|=
name|ah
operator|->
name|priv
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|ah
operator|->
name|list
argument_list|,
operator|&
name|priv
operator|->
name|dead_ahs
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ipoib_dma_unmap_rx
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ipoib_rx_buf
modifier|*
name|rx_req
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|m
operator|=
name|rx_req
operator|->
name|mb
init|;
name|m
operator|!=
name|NULL
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
operator|,
name|i
operator|++
control|)
name|ib_dma_unmap_single
argument_list|(
name|priv
operator|->
name|ca
argument_list|,
name|rx_req
operator|->
name|mapping
index|[
name|i
index|]
argument_list|,
name|m
operator|->
name|m_len
argument_list|,
name|DMA_FROM_DEVICE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ipoib_dma_mb
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mb
parameter_list|,
name|unsigned
name|int
name|length
parameter_list|)
block|{
name|m_adj
argument_list|(
name|mb
argument_list|,
operator|-
operator|(
name|mb
operator|->
name|m_pkthdr
operator|.
name|len
operator|-
name|length
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|struct
name|mbuf
modifier|*
name|ipoib_alloc_map_mb
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ipoib_rx_buf
modifier|*
name|rx_req
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|mb
decl_stmt|,
modifier|*
name|m
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|rx_req
operator|->
name|mb
operator|=
name|NULL
expr_stmt|;
name|mb
operator|=
name|m_getm2
argument_list|(
name|NULL
argument_list|,
name|size
argument_list|,
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|mb
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|m
operator|=
name|mb
init|;
name|m
operator|!=
name|NULL
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
operator|,
name|i
operator|++
control|)
block|{
name|m
operator|->
name|m_len
operator|=
name|M_SIZE
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|mb
operator|->
name|m_pkthdr
operator|.
name|len
operator|+=
name|m
operator|->
name|m_len
expr_stmt|;
name|rx_req
operator|->
name|mapping
index|[
name|i
index|]
operator|=
name|ib_dma_map_single
argument_list|(
name|priv
operator|->
name|ca
argument_list|,
name|mtod
argument_list|(
name|m
argument_list|,
name|void
operator|*
argument_list|)
argument_list|,
name|m
operator|->
name|m_len
argument_list|,
name|DMA_FROM_DEVICE
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|ib_dma_mapping_error
argument_list|(
name|priv
operator|->
name|ca
argument_list|,
name|rx_req
operator|->
name|mapping
index|[
name|i
index|]
argument_list|)
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
name|rx_req
operator|->
name|mb
operator|=
name|mb
expr_stmt|;
return|return
operator|(
name|mb
operator|)
return|;
name|error
label|:
for|for
control|(
name|j
operator|=
literal|0
operator|,
name|m
operator|=
name|mb
init|;
name|j
operator|<
name|i
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
operator|,
name|j
operator|++
control|)
name|ib_dma_unmap_single
argument_list|(
name|priv
operator|->
name|ca
argument_list|,
name|rx_req
operator|->
name|mapping
index|[
name|j
index|]
argument_list|,
name|m
operator|->
name|m_len
argument_list|,
name|DMA_FROM_DEVICE
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|mb
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ipoib_ib_post_receive
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|int
name|id
parameter_list|)
block|{
name|struct
name|ipoib_rx_buf
modifier|*
name|rx_req
decl_stmt|;
name|struct
name|ib_recv_wr
modifier|*
name|bad_wr
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|i
decl_stmt|;
name|rx_req
operator|=
operator|&
name|priv
operator|->
name|rx_ring
index|[
name|id
index|]
expr_stmt|;
for|for
control|(
name|m
operator|=
name|rx_req
operator|->
name|mb
operator|,
name|i
operator|=
literal|0
init|;
name|m
operator|!=
name|NULL
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
operator|,
name|i
operator|++
control|)
block|{
name|priv
operator|->
name|rx_sge
index|[
name|i
index|]
operator|.
name|addr
operator|=
name|rx_req
operator|->
name|mapping
index|[
name|i
index|]
expr_stmt|;
name|priv
operator|->
name|rx_sge
index|[
name|i
index|]
operator|.
name|length
operator|=
name|m
operator|->
name|m_len
expr_stmt|;
block|}
name|priv
operator|->
name|rx_wr
operator|.
name|num_sge
operator|=
name|i
expr_stmt|;
name|priv
operator|->
name|rx_wr
operator|.
name|wr_id
operator|=
name|id
operator||
name|IPOIB_OP_RECV
expr_stmt|;
name|ret
operator|=
name|ib_post_recv
argument_list|(
name|priv
operator|->
name|qp
argument_list|,
operator|&
name|priv
operator|->
name|rx_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"receive failed for buf %d (%d)\n"
argument_list|,
name|id
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|ipoib_dma_unmap_rx
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|rx_ring
index|[
name|id
index|]
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|priv
operator|->
name|rx_ring
index|[
name|id
index|]
operator|.
name|mb
argument_list|)
expr_stmt|;
name|priv
operator|->
name|rx_ring
index|[
name|id
index|]
operator|.
name|mb
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|mbuf
modifier|*
name|ipoib_alloc_rx_mb
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|int
name|id
parameter_list|)
block|{
return|return
name|ipoib_alloc_map_mb
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|rx_ring
index|[
name|id
index|]
argument_list|,
name|priv
operator|->
name|max_ib_mtu
operator|+
name|IB_GRH_BYTES
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ipoib_ib_post_receives
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ipoib_recvq_size
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
operator|!
name|ipoib_alloc_rx_mb
argument_list|(
name|priv
argument_list|,
name|i
argument_list|)
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"failed to allocate receive buffer %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
if|if
condition|(
name|ipoib_ib_post_receive
argument_list|(
name|priv
argument_list|,
name|i
argument_list|)
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"ipoib_ib_post_receive failed for buf %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
operator|-
name|EIO
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_ib_handle_rx_wc
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ib_wc
modifier|*
name|wc
parameter_list|)
block|{
name|struct
name|ipoib_rx_buf
name|saverx
decl_stmt|;
name|unsigned
name|int
name|wr_id
init|=
name|wc
operator|->
name|wr_id
operator|&
operator|~
name|IPOIB_OP_RECV
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|dev
init|=
name|priv
operator|->
name|dev
decl_stmt|;
name|struct
name|ipoib_header
modifier|*
name|eh
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mb
decl_stmt|;
name|ipoib_dbg_data
argument_list|(
name|priv
argument_list|,
literal|"recv completion: id %d, status: %d\n"
argument_list|,
name|wr_id
argument_list|,
name|wc
operator|->
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|wr_id
operator|>=
name|ipoib_recvq_size
argument_list|)
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"recv completion event with wrid %d (> %d)\n"
argument_list|,
name|wr_id
argument_list|,
name|ipoib_recvq_size
argument_list|)
expr_stmt|;
return|return;
block|}
name|mb
operator|=
name|priv
operator|->
name|rx_ring
index|[
name|wr_id
index|]
operator|.
name|mb
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|wc
operator|->
name|status
operator|!=
name|IB_WC_SUCCESS
argument_list|)
condition|)
block|{
if|if
condition|(
name|wc
operator|->
name|status
operator|!=
name|IB_WC_WR_FLUSH_ERR
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"failed recv event "
literal|"(status=%d, wrid=%d vend_err %x)\n"
argument_list|,
name|wc
operator|->
name|status
argument_list|,
name|wr_id
argument_list|,
name|wc
operator|->
name|vendor_err
argument_list|)
expr_stmt|;
goto|goto
name|repost
goto|;
block|}
if|if
condition|(
name|mb
condition|)
block|{
name|ipoib_dma_unmap_rx
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|rx_ring
index|[
name|wr_id
index|]
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|mb
argument_list|)
expr_stmt|;
name|priv
operator|->
name|rx_ring
index|[
name|wr_id
index|]
operator|.
name|mb
operator|=
name|NULL
expr_stmt|;
block|}
return|return;
block|}
comment|/* 	 * Drop packets that this interface sent, ie multicast packets 	 * that the HCA has replicated. 	 */
if|if
condition|(
name|wc
operator|->
name|slid
operator|==
name|priv
operator|->
name|local_lid
operator|&&
name|wc
operator|->
name|src_qp
operator|==
name|priv
operator|->
name|qp
operator|->
name|qp_num
condition|)
goto|goto
name|repost
goto|;
name|memcpy
argument_list|(
operator|&
name|saverx
argument_list|,
operator|&
name|priv
operator|->
name|rx_ring
index|[
name|wr_id
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|saverx
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * If we can't allocate a new RX buffer, dump 	 * this packet and reuse the old buffer. 	 */
if|if
condition|(
name|unlikely
argument_list|(
operator|!
name|ipoib_alloc_rx_mb
argument_list|(
name|priv
argument_list|,
name|wr_id
argument_list|)
argument_list|)
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|priv
operator|->
name|rx_ring
index|[
name|wr_id
index|]
argument_list|,
operator|&
name|saverx
argument_list|,
sizeof|sizeof
argument_list|(
name|saverx
argument_list|)
argument_list|)
expr_stmt|;
name|if_inc_counter
argument_list|(
name|dev
argument_list|,
name|IFCOUNTER_IQDROPS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|repost
goto|;
block|}
name|ipoib_dbg_data
argument_list|(
name|priv
argument_list|,
literal|"received %d bytes, SLID 0x%04x\n"
argument_list|,
name|wc
operator|->
name|byte_len
argument_list|,
name|wc
operator|->
name|slid
argument_list|)
expr_stmt|;
name|ipoib_dma_unmap_rx
argument_list|(
name|priv
argument_list|,
operator|&
name|saverx
argument_list|)
expr_stmt|;
name|ipoib_dma_mb
argument_list|(
name|priv
argument_list|,
name|mb
argument_list|,
name|wc
operator|->
name|byte_len
argument_list|)
expr_stmt|;
name|if_inc_counter
argument_list|(
name|dev
argument_list|,
name|IFCOUNTER_IPACKETS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|if_inc_counter
argument_list|(
name|dev
argument_list|,
name|IFCOUNTER_IBYTES
argument_list|,
name|mb
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|)
expr_stmt|;
name|mb
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|dev
expr_stmt|;
name|m_adj
argument_list|(
name|mb
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ib_grh
argument_list|)
operator|-
name|INFINIBAND_ALEN
argument_list|)
expr_stmt|;
name|eh
operator|=
name|mtod
argument_list|(
name|mb
argument_list|,
expr|struct
name|ipoib_header
operator|*
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|eh
operator|->
name|hwaddr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* Zero the queue pair, only dgid is in grh */
if|if
condition|(
name|test_bit
argument_list|(
name|IPOIB_FLAG_CSUM
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
operator|&&
name|likely
argument_list|(
name|wc
operator|->
name|wc_flags
operator|&
name|IB_WC_IP_CSUM_OK
argument_list|)
condition|)
name|mb
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|=
name|CSUM_IP_CHECKED
operator||
name|CSUM_IP_VALID
expr_stmt|;
name|dev
operator|->
name|if_input
argument_list|(
name|dev
argument_list|,
name|mb
argument_list|)
expr_stmt|;
name|repost
label|:
if|if
condition|(
name|unlikely
argument_list|(
name|ipoib_ib_post_receive
argument_list|(
name|priv
argument_list|,
name|wr_id
argument_list|)
argument_list|)
condition|)
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"ipoib_ib_post_receive failed "
literal|"for buf %d\n"
argument_list|,
name|wr_id
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ipoib_dma_map_tx
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ca
parameter_list|,
name|struct
name|ipoib_tx_buf
modifier|*
name|tx_req
parameter_list|,
name|int
name|max
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|mb
init|=
name|tx_req
operator|->
name|mb
decl_stmt|;
name|u64
modifier|*
name|mapping
init|=
name|tx_req
operator|->
name|mapping
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|m
operator|=
name|mb
operator|,
name|p
operator|=
name|NULL
operator|,
name|i
operator|=
literal|0
init|;
name|m
operator|!=
name|NULL
condition|;
name|p
operator|=
name|m
operator|,
name|m
operator|=
name|m
operator|->
name|m_next
operator|,
name|i
operator|++
control|)
block|{
if|if
condition|(
name|m
operator|->
name|m_len
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
name|panic
argument_list|(
literal|"ipoib_dma_map_tx: First mbuf empty\n"
argument_list|)
expr_stmt|;
name|p
operator|->
name|m_next
operator|=
name|m_free
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|m
operator|=
name|p
expr_stmt|;
name|i
operator|--
expr_stmt|;
block|}
name|i
operator|--
expr_stmt|;
if|if
condition|(
name|i
operator|>=
name|max
condition|)
block|{
name|tx_req
operator|->
name|mb
operator|=
name|mb
operator|=
name|m_defrag
argument_list|(
name|mb
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|mb
operator|==
name|NULL
condition|)
return|return
operator|-
name|EIO
return|;
for|for
control|(
name|m
operator|=
name|mb
operator|,
name|i
operator|=
literal|0
init|;
name|m
operator|!=
name|NULL
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
operator|,
name|i
operator|++
control|)
empty_stmt|;
if|if
condition|(
name|i
operator|>=
name|max
condition|)
return|return
operator|-
name|EIO
return|;
block|}
name|error
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|m
operator|=
name|mb
operator|,
name|i
operator|=
literal|0
init|;
name|m
operator|!=
name|NULL
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
operator|,
name|i
operator|++
control|)
block|{
name|mapping
index|[
name|i
index|]
operator|=
name|ib_dma_map_single
argument_list|(
name|ca
argument_list|,
name|mtod
argument_list|(
name|m
argument_list|,
name|void
operator|*
argument_list|)
argument_list|,
name|m
operator|->
name|m_len
argument_list|,
name|DMA_TO_DEVICE
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|ib_dma_mapping_error
argument_list|(
name|ca
argument_list|,
name|mapping
index|[
name|i
index|]
argument_list|)
argument_list|)
condition|)
block|{
name|error
operator|=
operator|-
name|EIO
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|error
condition|)
block|{
name|int
name|end
decl_stmt|;
name|end
operator|=
name|i
expr_stmt|;
for|for
control|(
name|m
operator|=
name|mb
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|end
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
operator|,
name|i
operator|++
control|)
name|ib_dma_unmap_single
argument_list|(
name|ca
argument_list|,
name|mapping
index|[
name|i
index|]
argument_list|,
name|m
operator|->
name|m_len
argument_list|,
name|DMA_TO_DEVICE
argument_list|)
expr_stmt|;
block|}
return|return
name|error
return|;
block|}
end_function

begin_function
name|void
name|ipoib_dma_unmap_tx
parameter_list|(
name|struct
name|ib_device
modifier|*
name|ca
parameter_list|,
name|struct
name|ipoib_tx_buf
modifier|*
name|tx_req
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|mb
init|=
name|tx_req
operator|->
name|mb
decl_stmt|;
name|u64
modifier|*
name|mapping
init|=
name|tx_req
operator|->
name|mapping
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|m
operator|=
name|mb
operator|,
name|i
operator|=
literal|0
init|;
name|m
operator|!=
name|NULL
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
operator|,
name|i
operator|++
control|)
name|ib_dma_unmap_single
argument_list|(
name|ca
argument_list|,
name|mapping
index|[
name|i
index|]
argument_list|,
name|m
operator|->
name|m_len
argument_list|,
name|DMA_TO_DEVICE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_ib_handle_tx_wc
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ib_wc
modifier|*
name|wc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|dev
init|=
name|priv
operator|->
name|dev
decl_stmt|;
name|unsigned
name|int
name|wr_id
init|=
name|wc
operator|->
name|wr_id
decl_stmt|;
name|struct
name|ipoib_tx_buf
modifier|*
name|tx_req
decl_stmt|;
name|ipoib_dbg_data
argument_list|(
name|priv
argument_list|,
literal|"send completion: id %d, status: %d\n"
argument_list|,
name|wr_id
argument_list|,
name|wc
operator|->
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|wr_id
operator|>=
name|ipoib_sendq_size
argument_list|)
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"send completion event with wrid %d (> %d)\n"
argument_list|,
name|wr_id
argument_list|,
name|ipoib_sendq_size
argument_list|)
expr_stmt|;
return|return;
block|}
name|tx_req
operator|=
operator|&
name|priv
operator|->
name|tx_ring
index|[
name|wr_id
index|]
expr_stmt|;
name|ipoib_dma_unmap_tx
argument_list|(
name|priv
operator|->
name|ca
argument_list|,
name|tx_req
argument_list|)
expr_stmt|;
name|if_inc_counter
argument_list|(
name|dev
argument_list|,
name|IFCOUNTER_OPACKETS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|tx_req
operator|->
name|mb
argument_list|)
expr_stmt|;
operator|++
name|priv
operator|->
name|tx_tail
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
operator|--
name|priv
operator|->
name|tx_outstanding
operator|==
name|ipoib_sendq_size
operator|>>
literal|1
argument_list|)
operator|&&
operator|(
name|dev
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_OACTIVE
operator|)
operator|&&
name|test_bit
argument_list|(
name|IPOIB_FLAG_ADMIN_UP
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
condition|)
name|dev
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
if|if
condition|(
name|wc
operator|->
name|status
operator|!=
name|IB_WC_SUCCESS
operator|&&
name|wc
operator|->
name|status
operator|!=
name|IB_WC_WR_FLUSH_ERR
condition|)
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"failed send event "
literal|"(status=%d, wrid=%d vend_err %x)\n"
argument_list|,
name|wc
operator|->
name|status
argument_list|,
name|wr_id
argument_list|,
name|wc
operator|->
name|vendor_err
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ipoib_poll_tx
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
name|int
name|n
decl_stmt|,
name|i
decl_stmt|;
name|n
operator|=
name|ib_poll_cq
argument_list|(
name|priv
operator|->
name|send_cq
argument_list|,
name|MAX_SEND_CQE
argument_list|,
name|priv
operator|->
name|send_wc
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
operator|++
name|i
control|)
block|{
name|struct
name|ib_wc
modifier|*
name|wc
init|=
name|priv
operator|->
name|send_wc
operator|+
name|i
decl_stmt|;
if|if
condition|(
name|wc
operator|->
name|wr_id
operator|&
name|IPOIB_OP_CM
condition|)
name|ipoib_cm_handle_tx_wc
argument_list|(
name|priv
argument_list|,
name|wc
argument_list|)
expr_stmt|;
else|else
name|ipoib_ib_handle_tx_wc
argument_list|(
name|priv
argument_list|,
name|wc
argument_list|)
expr_stmt|;
block|}
return|return
name|n
operator|==
name|MAX_SEND_CQE
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_poll
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
name|int
name|n
decl_stmt|,
name|i
decl_stmt|;
name|poll_more
label|:
name|spin_lock
argument_list|(
operator|&
name|priv
operator|->
name|drain_lock
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|n
operator|=
name|ib_poll_cq
argument_list|(
name|priv
operator|->
name|recv_cq
argument_list|,
name|IPOIB_NUM_WC
argument_list|,
name|priv
operator|->
name|ibwc
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|ib_wc
modifier|*
name|wc
init|=
name|priv
operator|->
name|ibwc
operator|+
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|wc
operator|->
name|wr_id
operator|&
name|IPOIB_OP_RECV
operator|)
operator|==
literal|0
condition|)
name|panic
argument_list|(
literal|"ipoib_poll: Bad wr_id 0x%jX\n"
argument_list|,
operator|(
name|intmax_t
operator|)
name|wc
operator|->
name|wr_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|wc
operator|->
name|wr_id
operator|&
name|IPOIB_OP_CM
condition|)
name|ipoib_cm_handle_rx_wc
argument_list|(
name|priv
argument_list|,
name|wc
argument_list|)
expr_stmt|;
else|else
name|ipoib_ib_handle_rx_wc
argument_list|(
name|priv
argument_list|,
name|wc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|n
operator|!=
name|IPOIB_NUM_WC
condition|)
break|break;
block|}
name|spin_unlock
argument_list|(
operator|&
name|priv
operator|->
name|drain_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ib_req_notify_cq
argument_list|(
name|priv
operator|->
name|recv_cq
argument_list|,
name|IB_CQ_NEXT_COMP
operator||
name|IB_CQ_REPORT_MISSED_EVENTS
argument_list|)
condition|)
goto|goto
name|poll_more
goto|;
block|}
end_function

begin_function
name|void
name|ipoib_ib_completion
parameter_list|(
name|struct
name|ib_cq
modifier|*
name|cq
parameter_list|,
name|void
modifier|*
name|dev_ptr
parameter_list|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
init|=
name|dev_ptr
decl_stmt|;
name|ipoib_poll
argument_list|(
name|priv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|drain_tx_cq
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|dev
init|=
name|priv
operator|->
name|dev
decl_stmt|;
name|spin_lock
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
while|while
condition|(
name|ipoib_poll_tx
argument_list|(
name|priv
argument_list|)
condition|)
empty_stmt|;
comment|/* nothing */
if|if
condition|(
name|dev
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_OACTIVE
condition|)
name|mod_timer
argument_list|(
operator|&
name|priv
operator|->
name|poll_timer
argument_list|,
name|jiffies
operator|+
literal|1
argument_list|)
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ipoib_send_comp_handler
parameter_list|(
name|struct
name|ib_cq
modifier|*
name|cq
parameter_list|,
name|void
modifier|*
name|dev_ptr
parameter_list|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
init|=
name|dev_ptr
decl_stmt|;
name|mod_timer
argument_list|(
operator|&
name|priv
operator|->
name|poll_timer
argument_list|,
name|jiffies
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|post_send
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|unsigned
name|int
name|wr_id
parameter_list|,
name|struct
name|ib_ah
modifier|*
name|address
parameter_list|,
name|u32
name|qpn
parameter_list|,
name|struct
name|ipoib_tx_buf
modifier|*
name|tx_req
parameter_list|,
name|void
modifier|*
name|head
parameter_list|,
name|int
name|hlen
parameter_list|)
block|{
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mb
init|=
name|tx_req
operator|->
name|mb
decl_stmt|;
name|u64
modifier|*
name|mapping
init|=
name|tx_req
operator|->
name|mapping
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|m
operator|=
name|mb
operator|,
name|i
operator|=
literal|0
init|;
name|m
operator|!=
name|NULL
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
operator|,
name|i
operator|++
control|)
block|{
name|priv
operator|->
name|tx_sge
index|[
name|i
index|]
operator|.
name|addr
operator|=
name|mapping
index|[
name|i
index|]
expr_stmt|;
name|priv
operator|->
name|tx_sge
index|[
name|i
index|]
operator|.
name|length
operator|=
name|m
operator|->
name|m_len
expr_stmt|;
block|}
name|priv
operator|->
name|tx_wr
operator|.
name|wr
operator|.
name|num_sge
operator|=
name|i
expr_stmt|;
name|priv
operator|->
name|tx_wr
operator|.
name|wr
operator|.
name|wr_id
operator|=
name|wr_id
expr_stmt|;
name|priv
operator|->
name|tx_wr
operator|.
name|remote_qpn
operator|=
name|qpn
expr_stmt|;
name|priv
operator|->
name|tx_wr
operator|.
name|ah
operator|=
name|address
expr_stmt|;
if|if
condition|(
name|head
condition|)
block|{
name|priv
operator|->
name|tx_wr
operator|.
name|mss
operator|=
literal|0
expr_stmt|;
comment|/* XXX mb_shinfo(mb)->gso_size; */
name|priv
operator|->
name|tx_wr
operator|.
name|header
operator|=
name|head
expr_stmt|;
name|priv
operator|->
name|tx_wr
operator|.
name|hlen
operator|=
name|hlen
expr_stmt|;
name|priv
operator|->
name|tx_wr
operator|.
name|wr
operator|.
name|opcode
operator|=
name|IB_WR_LSO
expr_stmt|;
block|}
else|else
name|priv
operator|->
name|tx_wr
operator|.
name|wr
operator|.
name|opcode
operator|=
name|IB_WR_SEND
expr_stmt|;
return|return
name|ib_post_send
argument_list|(
name|priv
operator|->
name|qp
argument_list|,
operator|&
name|priv
operator|->
name|tx_wr
operator|.
name|wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|ipoib_send
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mb
parameter_list|,
name|struct
name|ipoib_ah
modifier|*
name|address
parameter_list|,
name|u32
name|qpn
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|dev
init|=
name|priv
operator|->
name|dev
decl_stmt|;
name|struct
name|ipoib_tx_buf
modifier|*
name|tx_req
decl_stmt|;
name|int
name|hlen
decl_stmt|;
name|void
modifier|*
name|phead
decl_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|priv
operator|->
name|tx_outstanding
operator|>
name|MAX_SEND_CQE
argument_list|)
condition|)
while|while
condition|(
name|ipoib_poll_tx
argument_list|(
name|priv
argument_list|)
condition|)
empty_stmt|;
comment|/* nothing */
name|m_adj
argument_list|(
name|mb
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ipoib_pseudoheader
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
literal|0
comment|/* XXX segment offload mb_is_gso(mb) */
condition|)
block|{
comment|/* XXX hlen = mb_transport_offset(mb) + tcp_hdrlen(mb); */
name|phead
operator|=
name|mtod
argument_list|(
name|mb
argument_list|,
name|void
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|mb
operator|->
name|m_len
operator|<
name|hlen
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"linear data too small\n"
argument_list|)
expr_stmt|;
name|if_inc_counter
argument_list|(
name|dev
argument_list|,
name|IFCOUNTER_OERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|mb
argument_list|)
expr_stmt|;
return|return;
block|}
name|m_adj
argument_list|(
name|mb
argument_list|,
name|hlen
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|unlikely
argument_list|(
name|mb
operator|->
name|m_pkthdr
operator|.
name|len
operator|-
name|IPOIB_ENCAP_LEN
operator|>
name|priv
operator|->
name|mcast_mtu
argument_list|)
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"packet len %d (> %d) too long to send, dropping\n"
argument_list|,
name|mb
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|priv
operator|->
name|mcast_mtu
argument_list|)
expr_stmt|;
name|if_inc_counter
argument_list|(
name|dev
argument_list|,
name|IFCOUNTER_OERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ipoib_cm_mb_too_long
argument_list|(
name|priv
argument_list|,
name|mb
argument_list|,
name|priv
operator|->
name|mcast_mtu
argument_list|)
expr_stmt|;
return|return;
block|}
name|phead
operator|=
name|NULL
expr_stmt|;
name|hlen
operator|=
literal|0
expr_stmt|;
block|}
name|ipoib_dbg_data
argument_list|(
name|priv
argument_list|,
literal|"sending packet, length=%d address=%p qpn=0x%06x\n"
argument_list|,
name|mb
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|address
argument_list|,
name|qpn
argument_list|)
expr_stmt|;
comment|/* 	 * We put the mb into the tx_ring _before_ we call post_send() 	 * because it's entirely possible that the completion handler will 	 * run before we execute anything after the post_send().  That 	 * means we have to make sure everything is properly recorded and 	 * our state is consistent before we call post_send(). 	 */
name|tx_req
operator|=
operator|&
name|priv
operator|->
name|tx_ring
index|[
name|priv
operator|->
name|tx_head
operator|&
operator|(
name|ipoib_sendq_size
operator|-
literal|1
operator|)
index|]
expr_stmt|;
name|tx_req
operator|->
name|mb
operator|=
name|mb
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|ipoib_dma_map_tx
argument_list|(
name|priv
operator|->
name|ca
argument_list|,
name|tx_req
argument_list|,
name|IPOIB_UD_TX_SG
argument_list|)
argument_list|)
condition|)
block|{
name|if_inc_counter
argument_list|(
name|dev
argument_list|,
name|IFCOUNTER_OERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|tx_req
operator|->
name|mb
condition|)
name|m_freem
argument_list|(
name|tx_req
operator|->
name|mb
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|mb
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
operator|(
name|CSUM_IP
operator||
name|CSUM_TCP
operator||
name|CSUM_UDP
operator|)
condition|)
name|priv
operator|->
name|tx_wr
operator|.
name|wr
operator|.
name|send_flags
operator||=
name|IB_SEND_IP_CSUM
expr_stmt|;
else|else
name|priv
operator|->
name|tx_wr
operator|.
name|wr
operator|.
name|send_flags
operator|&=
operator|~
name|IB_SEND_IP_CSUM
expr_stmt|;
if|if
condition|(
operator|++
name|priv
operator|->
name|tx_outstanding
operator|==
name|ipoib_sendq_size
condition|)
block|{
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"TX ring full, stopping kernel net queue\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ib_req_notify_cq
argument_list|(
name|priv
operator|->
name|send_cq
argument_list|,
name|IB_CQ_NEXT_COMP
argument_list|)
condition|)
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"request notify on send CQ failed\n"
argument_list|)
expr_stmt|;
name|dev
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_OACTIVE
expr_stmt|;
block|}
if|if
condition|(
name|unlikely
argument_list|(
name|post_send
argument_list|(
name|priv
argument_list|,
name|priv
operator|->
name|tx_head
operator|&
operator|(
name|ipoib_sendq_size
operator|-
literal|1
operator|)
argument_list|,
name|address
operator|->
name|ah
argument_list|,
name|qpn
argument_list|,
name|tx_req
argument_list|,
name|phead
argument_list|,
name|hlen
argument_list|)
argument_list|)
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"post_send failed\n"
argument_list|)
expr_stmt|;
name|if_inc_counter
argument_list|(
name|dev
argument_list|,
name|IFCOUNTER_OERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|--
name|priv
operator|->
name|tx_outstanding
expr_stmt|;
name|ipoib_dma_unmap_tx
argument_list|(
name|priv
operator|->
name|ca
argument_list|,
name|tx_req
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|mb
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_OACTIVE
condition|)
name|dev
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
block|}
else|else
block|{
name|address
operator|->
name|last_send
operator|=
name|priv
operator|->
name|tx_head
expr_stmt|;
operator|++
name|priv
operator|->
name|tx_head
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|__ipoib_reap_ah
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|ipoib_ah
modifier|*
name|ah
decl_stmt|,
modifier|*
name|tah
decl_stmt|;
name|LIST_HEAD
argument_list|(
name|remove_list
argument_list|)
expr_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|list_for_each_entry_safe
argument_list|(
argument|ah
argument_list|,
argument|tah
argument_list|,
argument|&priv->dead_ahs
argument_list|,
argument|list
argument_list|)
if|if
condition|(
operator|(
name|int
operator|)
name|priv
operator|->
name|tx_tail
operator|-
operator|(
name|int
operator|)
name|ah
operator|->
name|last_send
operator|>=
literal|0
condition|)
block|{
name|list_del
argument_list|(
operator|&
name|ah
operator|->
name|list
argument_list|)
expr_stmt|;
name|ib_destroy_ah
argument_list|(
name|ah
operator|->
name|ah
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|ah
argument_list|)
expr_stmt|;
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ipoib_reap_ah
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|ipoib_dev_priv
argument_list|,
name|ah_reap_task
operator|.
name|work
argument_list|)
decl_stmt|;
name|__ipoib_reap_ah
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|test_bit
argument_list|(
name|IPOIB_STOP_REAPER
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
condition|)
name|queue_delayed_work
argument_list|(
name|ipoib_workqueue
argument_list|,
operator|&
name|priv
operator|->
name|ah_reap_task
argument_list|,
name|HZ
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_ah_dev_cleanup
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
name|unsigned
name|long
name|begin
decl_stmt|;
name|begin
operator|=
name|jiffies
expr_stmt|;
while|while
condition|(
operator|!
name|list_empty
argument_list|(
operator|&
name|priv
operator|->
name|dead_ahs
argument_list|)
condition|)
block|{
name|__ipoib_reap_ah
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|time_after
argument_list|(
name|jiffies
argument_list|,
name|begin
operator|+
name|HZ
argument_list|)
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"timing out; will leak address handles\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|msleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_ib_tx_timer_func
parameter_list|(
name|unsigned
name|long
name|ctx
parameter_list|)
block|{
name|drain_tx_cq
argument_list|(
operator|(
expr|struct
name|ipoib_dev_priv
operator|*
operator|)
name|ctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ipoib_ib_dev_open
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|ib_find_pkey
argument_list|(
name|priv
operator|->
name|ca
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|pkey
argument_list|,
operator|&
name|priv
operator|->
name|pkey_index
argument_list|)
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"P_Key 0x%04x not found\n"
argument_list|,
name|priv
operator|->
name|pkey
argument_list|)
expr_stmt|;
name|clear_bit
argument_list|(
name|IPOIB_PKEY_ASSIGNED
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|set_bit
argument_list|(
name|IPOIB_PKEY_ASSIGNED
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ipoib_init_qp
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"ipoib_init_qp returned %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|ipoib_ib_post_receives
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"ipoib_ib_post_receives returned %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|ipoib_ib_dev_stop
argument_list|(
name|priv
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|ipoib_cm_dev_open
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"ipoib_cm_dev_open returned %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|ipoib_ib_dev_stop
argument_list|(
name|priv
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|clear_bit
argument_list|(
name|IPOIB_STOP_REAPER
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
expr_stmt|;
name|queue_delayed_work
argument_list|(
name|ipoib_workqueue
argument_list|,
operator|&
name|priv
operator|->
name|ah_reap_task
argument_list|,
name|HZ
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_pkey_dev_check_presence
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
name|u16
name|pkey_index
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ib_find_pkey
argument_list|(
name|priv
operator|->
name|ca
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|pkey
argument_list|,
operator|&
name|pkey_index
argument_list|)
condition|)
name|clear_bit
argument_list|(
name|IPOIB_PKEY_ASSIGNED
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
expr_stmt|;
else|else
name|set_bit
argument_list|(
name|IPOIB_PKEY_ASSIGNED
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ipoib_ib_dev_up
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
name|ipoib_pkey_dev_check_presence
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|test_bit
argument_list|(
name|IPOIB_PKEY_ASSIGNED
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
condition|)
block|{
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"PKEY is not assigned.\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|set_bit
argument_list|(
name|IPOIB_FLAG_OPER_UP
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
expr_stmt|;
return|return
name|ipoib_mcast_start_thread
argument_list|(
name|priv
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|ipoib_ib_dev_down
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|int
name|flush
parameter_list|)
block|{
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"downing ib_dev\n"
argument_list|)
expr_stmt|;
name|clear_bit
argument_list|(
name|IPOIB_FLAG_OPER_UP
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
expr_stmt|;
name|if_link_state_change
argument_list|(
name|priv
operator|->
name|dev
argument_list|,
name|LINK_STATE_DOWN
argument_list|)
expr_stmt|;
comment|/* Shutdown the P_Key thread if still active */
if|if
condition|(
operator|!
name|test_bit
argument_list|(
name|IPOIB_PKEY_ASSIGNED
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
condition|)
block|{
name|mutex_lock
argument_list|(
operator|&
name|pkey_mutex
argument_list|)
expr_stmt|;
name|set_bit
argument_list|(
name|IPOIB_PKEY_STOP
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
expr_stmt|;
name|cancel_delayed_work
argument_list|(
operator|&
name|priv
operator|->
name|pkey_poll_task
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|pkey_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|flush
condition|)
name|flush_workqueue
argument_list|(
name|ipoib_workqueue
argument_list|)
expr_stmt|;
block|}
name|ipoib_mcast_stop_thread
argument_list|(
name|priv
argument_list|,
name|flush
argument_list|)
expr_stmt|;
name|ipoib_mcast_dev_flush
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|ipoib_flush_paths
argument_list|(
name|priv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|recvs_pending
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
name|int
name|pending
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ipoib_recvq_size
condition|;
operator|++
name|i
control|)
if|if
condition|(
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
operator|.
name|mb
condition|)
operator|++
name|pending
expr_stmt|;
return|return
name|pending
return|;
block|}
end_function

begin_function
name|void
name|ipoib_drain_cq
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|n
decl_stmt|;
name|spin_lock
argument_list|(
operator|&
name|priv
operator|->
name|drain_lock
argument_list|)
expr_stmt|;
do|do
block|{
name|n
operator|=
name|ib_poll_cq
argument_list|(
name|priv
operator|->
name|recv_cq
argument_list|,
name|IPOIB_NUM_WC
argument_list|,
name|priv
operator|->
name|ibwc
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
operator|++
name|i
control|)
block|{
comment|/* 			 * Convert any successful completions to flush 			 * errors to avoid passing packets up the 			 * stack after bringing the device down. 			 */
if|if
condition|(
name|priv
operator|->
name|ibwc
index|[
name|i
index|]
operator|.
name|status
operator|==
name|IB_WC_SUCCESS
condition|)
name|priv
operator|->
name|ibwc
index|[
name|i
index|]
operator|.
name|status
operator|=
name|IB_WC_WR_FLUSH_ERR
expr_stmt|;
if|if
condition|(
operator|(
name|priv
operator|->
name|ibwc
index|[
name|i
index|]
operator|.
name|wr_id
operator|&
name|IPOIB_OP_RECV
operator|)
operator|==
literal|0
condition|)
name|panic
argument_list|(
literal|"ipoib_drain_cq:  Bad wrid 0x%jX\n"
argument_list|,
operator|(
name|intmax_t
operator|)
name|priv
operator|->
name|ibwc
index|[
name|i
index|]
operator|.
name|wr_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|ibwc
index|[
name|i
index|]
operator|.
name|wr_id
operator|&
name|IPOIB_OP_CM
condition|)
name|ipoib_cm_handle_rx_wc
argument_list|(
name|priv
argument_list|,
name|priv
operator|->
name|ibwc
operator|+
name|i
argument_list|)
expr_stmt|;
else|else
name|ipoib_ib_handle_rx_wc
argument_list|(
name|priv
argument_list|,
name|priv
operator|->
name|ibwc
operator|+
name|i
argument_list|)
expr_stmt|;
block|}
block|}
do|while
condition|(
name|n
operator|==
name|IPOIB_NUM_WC
condition|)
do|;
name|spin_unlock
argument_list|(
operator|&
name|priv
operator|->
name|drain_lock
argument_list|)
expr_stmt|;
name|spin_lock
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
while|while
condition|(
name|ipoib_poll_tx
argument_list|(
name|priv
argument_list|)
condition|)
empty_stmt|;
comment|/* nothing */
name|spin_unlock
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ipoib_ib_dev_stop
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|int
name|flush
parameter_list|)
block|{
name|struct
name|ib_qp_attr
name|qp_attr
decl_stmt|;
name|unsigned
name|long
name|begin
decl_stmt|;
name|struct
name|ipoib_tx_buf
modifier|*
name|tx_req
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ipoib_cm_dev_stop
argument_list|(
name|priv
argument_list|)
expr_stmt|;
comment|/* 	 * Move our QP to the error state and then reinitialize in 	 * when all work requests have completed or have been flushed. 	 */
name|qp_attr
operator|.
name|qp_state
operator|=
name|IB_QPS_ERR
expr_stmt|;
if|if
condition|(
name|ib_modify_qp
argument_list|(
name|priv
operator|->
name|qp
argument_list|,
operator|&
name|qp_attr
argument_list|,
name|IB_QP_STATE
argument_list|)
condition|)
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"Failed to modify QP to ERROR state\n"
argument_list|)
expr_stmt|;
comment|/* Wait for all sends and receives to complete */
name|begin
operator|=
name|jiffies
expr_stmt|;
while|while
condition|(
name|priv
operator|->
name|tx_head
operator|!=
name|priv
operator|->
name|tx_tail
operator|||
name|recvs_pending
argument_list|(
name|priv
argument_list|)
condition|)
block|{
if|if
condition|(
name|time_after
argument_list|(
name|jiffies
argument_list|,
name|begin
operator|+
literal|5
operator|*
name|HZ
argument_list|)
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"timing out; %d sends %d receives not completed\n"
argument_list|,
name|priv
operator|->
name|tx_head
operator|-
name|priv
operator|->
name|tx_tail
argument_list|,
name|recvs_pending
argument_list|(
name|priv
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 			 * assume the HW is wedged and just free up 			 * all our pending work requests. 			 */
while|while
condition|(
operator|(
name|int
operator|)
name|priv
operator|->
name|tx_tail
operator|-
operator|(
name|int
operator|)
name|priv
operator|->
name|tx_head
operator|<
literal|0
condition|)
block|{
name|tx_req
operator|=
operator|&
name|priv
operator|->
name|tx_ring
index|[
name|priv
operator|->
name|tx_tail
operator|&
operator|(
name|ipoib_sendq_size
operator|-
literal|1
operator|)
index|]
expr_stmt|;
name|ipoib_dma_unmap_tx
argument_list|(
name|priv
operator|->
name|ca
argument_list|,
name|tx_req
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|tx_req
operator|->
name|mb
argument_list|)
expr_stmt|;
operator|++
name|priv
operator|->
name|tx_tail
expr_stmt|;
operator|--
name|priv
operator|->
name|tx_outstanding
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ipoib_recvq_size
condition|;
operator|++
name|i
control|)
block|{
name|struct
name|ipoib_rx_buf
modifier|*
name|rx_req
decl_stmt|;
name|rx_req
operator|=
operator|&
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|rx_req
operator|->
name|mb
condition|)
continue|continue;
name|ipoib_dma_unmap_rx
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|rx_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|rx_req
operator|->
name|mb
argument_list|)
expr_stmt|;
name|rx_req
operator|->
name|mb
operator|=
name|NULL
expr_stmt|;
block|}
goto|goto
name|timeout
goto|;
block|}
name|ipoib_drain_cq
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"All sends and receives done.\n"
argument_list|)
expr_stmt|;
name|timeout
label|:
name|del_timer_sync
argument_list|(
operator|&
name|priv
operator|->
name|poll_timer
argument_list|)
expr_stmt|;
name|qp_attr
operator|.
name|qp_state
operator|=
name|IB_QPS_RESET
expr_stmt|;
if|if
condition|(
name|ib_modify_qp
argument_list|(
name|priv
operator|->
name|qp
argument_list|,
operator|&
name|qp_attr
argument_list|,
name|IB_QP_STATE
argument_list|)
condition|)
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"Failed to modify QP to RESET state\n"
argument_list|)
expr_stmt|;
comment|/* Wait for all AHs to be reaped */
name|set_bit
argument_list|(
name|IPOIB_STOP_REAPER
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
expr_stmt|;
name|cancel_delayed_work
argument_list|(
operator|&
name|priv
operator|->
name|ah_reap_task
argument_list|)
expr_stmt|;
if|if
condition|(
name|flush
condition|)
name|flush_workqueue
argument_list|(
name|ipoib_workqueue
argument_list|)
expr_stmt|;
name|ipoib_ah_dev_cleanup
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|ib_req_notify_cq
argument_list|(
name|priv
operator|->
name|recv_cq
argument_list|,
name|IB_CQ_NEXT_COMP
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ipoib_ib_dev_init
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ib_device
modifier|*
name|ca
parameter_list|,
name|int
name|port
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|dev
init|=
name|priv
operator|->
name|dev
decl_stmt|;
name|priv
operator|->
name|ca
operator|=
name|ca
expr_stmt|;
name|priv
operator|->
name|port
operator|=
name|port
expr_stmt|;
name|priv
operator|->
name|qp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ipoib_transport_dev_init
argument_list|(
name|priv
argument_list|,
name|ca
argument_list|)
condition|)
block|{
name|printk
argument_list|(
name|KERN_WARNING
literal|"%s: ipoib_transport_dev_init failed\n"
argument_list|,
name|ca
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENODEV
return|;
block|}
name|setup_timer
argument_list|(
operator|&
name|priv
operator|->
name|poll_timer
argument_list|,
name|ipoib_ib_tx_timer_func
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
if|if
condition|(
name|ipoib_ib_dev_open
argument_list|(
name|priv
argument_list|)
condition|)
block|{
name|ipoib_transport_dev_cleanup
argument_list|(
name|priv
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENODEV
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|__ipoib_ib_dev_flush
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|enum
name|ipoib_flush_level
name|level
parameter_list|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|cpriv
decl_stmt|;
name|u16
name|new_index
decl_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|priv
operator|->
name|vlan_mutex
argument_list|)
expr_stmt|;
comment|/* 	 * Flush any child interfaces too -- they might be up even if 	 * the parent is down. 	 */
name|list_for_each_entry
argument_list|(
argument|cpriv
argument_list|,
argument|&priv->child_intfs
argument_list|,
argument|list
argument_list|)
name|__ipoib_ib_dev_flush
argument_list|(
name|cpriv
argument_list|,
name|level
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|priv
operator|->
name|vlan_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|test_bit
argument_list|(
name|IPOIB_FLAG_INITIALIZED
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
condition|)
block|{
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"Not flushing - IPOIB_FLAG_INITIALIZED not set.\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|test_bit
argument_list|(
name|IPOIB_FLAG_ADMIN_UP
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
condition|)
block|{
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"Not flushing - IPOIB_FLAG_ADMIN_UP not set.\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|level
operator|==
name|IPOIB_FLUSH_HEAVY
condition|)
block|{
if|if
condition|(
name|ib_find_pkey
argument_list|(
name|priv
operator|->
name|ca
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|pkey
argument_list|,
operator|&
name|new_index
argument_list|)
condition|)
block|{
name|clear_bit
argument_list|(
name|IPOIB_PKEY_ASSIGNED
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
expr_stmt|;
name|ipoib_ib_dev_down
argument_list|(
name|priv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ipoib_ib_dev_stop
argument_list|(
name|priv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ipoib_pkey_dev_delay_open
argument_list|(
name|priv
argument_list|)
condition|)
return|return;
block|}
comment|/* restart QP only if P_Key index is changed */
if|if
condition|(
name|test_and_set_bit
argument_list|(
name|IPOIB_PKEY_ASSIGNED
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
operator|&&
name|new_index
operator|==
name|priv
operator|->
name|pkey_index
condition|)
block|{
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"Not flushing - P_Key index not changed.\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|priv
operator|->
name|pkey_index
operator|=
name|new_index
expr_stmt|;
block|}
if|if
condition|(
name|level
operator|==
name|IPOIB_FLUSH_LIGHT
condition|)
block|{
name|ipoib_mark_paths_invalid
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|ipoib_mcast_dev_flush
argument_list|(
name|priv
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|level
operator|>=
name|IPOIB_FLUSH_NORMAL
condition|)
name|ipoib_ib_dev_down
argument_list|(
name|priv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|level
operator|==
name|IPOIB_FLUSH_HEAVY
condition|)
block|{
name|ipoib_ib_dev_stop
argument_list|(
name|priv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ipoib_ib_dev_open
argument_list|(
name|priv
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * The device could have been brought down between the start and when 	 * we get here, don't bring it back up if it's not configured up 	 */
if|if
condition|(
name|test_bit
argument_list|(
name|IPOIB_FLAG_ADMIN_UP
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
condition|)
block|{
if|if
condition|(
name|level
operator|>=
name|IPOIB_FLUSH_NORMAL
condition|)
name|ipoib_ib_dev_up
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|ipoib_mcast_restart_task
argument_list|(
operator|&
name|priv
operator|->
name|restart_task
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ipoib_ib_dev_flush_light
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|ipoib_dev_priv
argument_list|,
name|flush_light
argument_list|)
decl_stmt|;
name|__ipoib_ib_dev_flush
argument_list|(
name|priv
argument_list|,
name|IPOIB_FLUSH_LIGHT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ipoib_ib_dev_flush_normal
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|ipoib_dev_priv
argument_list|,
name|flush_normal
argument_list|)
decl_stmt|;
name|__ipoib_ib_dev_flush
argument_list|(
name|priv
argument_list|,
name|IPOIB_FLUSH_NORMAL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ipoib_ib_dev_flush_heavy
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|ipoib_dev_priv
argument_list|,
name|flush_heavy
argument_list|)
decl_stmt|;
name|__ipoib_ib_dev_flush
argument_list|(
name|priv
argument_list|,
name|IPOIB_FLUSH_HEAVY
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ipoib_ib_dev_cleanup
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"cleaning up ib_dev\n"
argument_list|)
expr_stmt|;
name|ipoib_mcast_stop_thread
argument_list|(
name|priv
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ipoib_mcast_dev_flush
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|ipoib_ah_dev_cleanup
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|ipoib_transport_dev_cleanup
argument_list|(
name|priv
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Delayed P_Key Assigment Interim Support  *  * The following is initial implementation of delayed P_Key assigment  * mechanism. It is using the same approach implemented for the multicast  * group join. The single goal of this implementation is to quickly address  * Bug #2507. This implementation will probably be removed when the P_Key  * change async notification is available.  */
end_comment

begin_function
name|void
name|ipoib_pkey_poll
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|ipoib_dev_priv
argument_list|,
name|pkey_poll_task
operator|.
name|work
argument_list|)
decl_stmt|;
name|ipoib_pkey_dev_check_presence
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|test_bit
argument_list|(
name|IPOIB_PKEY_ASSIGNED
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
condition|)
name|ipoib_open
argument_list|(
name|priv
argument_list|)
expr_stmt|;
else|else
block|{
name|mutex_lock
argument_list|(
operator|&
name|pkey_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|test_bit
argument_list|(
name|IPOIB_PKEY_STOP
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
condition|)
name|queue_delayed_work
argument_list|(
name|ipoib_workqueue
argument_list|,
operator|&
name|priv
operator|->
name|pkey_poll_task
argument_list|,
name|HZ
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|pkey_mutex
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|ipoib_pkey_dev_delay_open
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
comment|/* Look for the interface pkey value in the IB Port P_Key table and */
comment|/* set the interface pkey assigment flag                            */
name|ipoib_pkey_dev_check_presence
argument_list|(
name|priv
argument_list|)
expr_stmt|;
comment|/* P_Key value not assigned yet - start polling */
if|if
condition|(
operator|!
name|test_bit
argument_list|(
name|IPOIB_PKEY_ASSIGNED
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
condition|)
block|{
name|mutex_lock
argument_list|(
operator|&
name|pkey_mutex
argument_list|)
expr_stmt|;
name|clear_bit
argument_list|(
name|IPOIB_PKEY_STOP
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
expr_stmt|;
name|queue_delayed_work
argument_list|(
name|ipoib_workqueue
argument_list|,
operator|&
name|priv
operator|->
name|pkey_poll_task
argument_list|,
name|HZ
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|pkey_mutex
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


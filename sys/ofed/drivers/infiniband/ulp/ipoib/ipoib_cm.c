begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2006 Mellanox Technologies. All rights reserved  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|"ipoib.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_INFINIBAND_IPOIB_CM
end_ifdef

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip_icmp.h>
end_include

begin_include
include|#
directive|include
file|<netinet/icmp6.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_cm.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_cache.h>
end_include

begin_include
include|#
directive|include
file|<linux/delay.h>
end_include

begin_decl_stmt
name|int
name|ipoib_max_conn_qp
init|=
literal|128
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|module_param_named
argument_list|(
name|max_nonsrq_conn_qp
argument_list|,
name|ipoib_max_conn_qp
argument_list|,
name|int
argument_list|,
literal|0444
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|max_nonsrq_conn_qp
argument_list|,
literal|"Max number of connected-mode QPs per interface "
literal|"(applied only if shared receive queue is not available)"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_INFINIBAND_IPOIB_DEBUG_DATA
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|data_debug_level
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|module_param_named
argument_list|(
name|cm_data_debug_level
argument_list|,
name|data_debug_level
argument_list|,
name|int
argument_list|,
literal|0644
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_PARM_DESC
argument_list|(
name|cm_data_debug_level
argument_list|,
literal|"Enable data path debug tracing for connected mode if> 0"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|IPOIB_CM_IETF_ID
value|0x1000000000000000ULL
end_define

begin_define
define|#
directive|define
name|IPOIB_CM_RX_UPDATE_TIME
value|(256 * HZ)
end_define

begin_define
define|#
directive|define
name|IPOIB_CM_RX_TIMEOUT
value|(2 * 256 * HZ)
end_define

begin_define
define|#
directive|define
name|IPOIB_CM_RX_DELAY
value|(3 * 256 * HZ)
end_define

begin_define
define|#
directive|define
name|IPOIB_CM_RX_UPDATE_MASK
value|(0x3)
end_define

begin_decl_stmt
specifier|static
name|struct
name|ib_qp_attr
name|ipoib_cm_err_attr
init|=
block|{
operator|.
name|qp_state
operator|=
name|IB_QPS_ERR
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|IPOIB_CM_RX_DRAIN_WRID
value|0xffffffff
end_define

begin_decl_stmt
specifier|static
name|struct
name|ib_send_wr
name|ipoib_cm_rx_drain_wr
init|=
block|{
operator|.
name|wr_id
operator|=
name|IPOIB_CM_RX_DRAIN_WRID
block|,
operator|.
name|opcode
operator|=
name|IB_WR_SEND
block|, }
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|ipoib_cm_tx_handler
parameter_list|(
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|,
name|struct
name|ib_cm_event
modifier|*
name|event
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|ipoib_cm_dma_unmap_rx
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ipoib_cm_rx_buf
modifier|*
name|rx_req
parameter_list|)
block|{
name|ipoib_dma_unmap_rx
argument_list|(
name|priv
argument_list|,
operator|(
expr|struct
name|ipoib_rx_buf
operator|*
operator|)
name|rx_req
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ipoib_cm_post_receive_srq
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|int
name|id
parameter_list|)
block|{
name|struct
name|ib_recv_wr
modifier|*
name|bad_wr
decl_stmt|;
name|struct
name|ipoib_rx_buf
modifier|*
name|rx_req
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|i
decl_stmt|;
name|rx_req
operator|=
operator|(
expr|struct
name|ipoib_rx_buf
operator|*
operator|)
operator|&
name|priv
operator|->
name|cm
operator|.
name|srq_ring
index|[
name|id
index|]
expr_stmt|;
for|for
control|(
name|m
operator|=
name|rx_req
operator|->
name|mb
operator|,
name|i
operator|=
literal|0
init|;
name|m
operator|!=
name|NULL
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
operator|,
name|i
operator|++
control|)
block|{
name|priv
operator|->
name|cm
operator|.
name|rx_sge
index|[
name|i
index|]
operator|.
name|addr
operator|=
name|rx_req
operator|->
name|mapping
index|[
name|i
index|]
expr_stmt|;
name|priv
operator|->
name|cm
operator|.
name|rx_sge
index|[
name|i
index|]
operator|.
name|length
operator|=
name|m
operator|->
name|m_len
expr_stmt|;
block|}
name|priv
operator|->
name|cm
operator|.
name|rx_wr
operator|.
name|num_sge
operator|=
name|i
expr_stmt|;
name|priv
operator|->
name|cm
operator|.
name|rx_wr
operator|.
name|wr_id
operator|=
name|id
operator||
name|IPOIB_OP_CM
operator||
name|IPOIB_OP_RECV
expr_stmt|;
name|ret
operator|=
name|ib_post_srq_recv
argument_list|(
name|priv
operator|->
name|cm
operator|.
name|srq
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"post srq failed for buf %d (%d)\n"
argument_list|,
name|id
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|ipoib_dma_unmap_rx
argument_list|(
name|priv
argument_list|,
name|rx_req
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|priv
operator|->
name|cm
operator|.
name|srq_ring
index|[
name|id
index|]
operator|.
name|mb
argument_list|)
expr_stmt|;
name|priv
operator|->
name|cm
operator|.
name|srq_ring
index|[
name|id
index|]
operator|.
name|mb
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ipoib_cm_post_receive_nonsrq
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ipoib_cm_rx
modifier|*
name|rx
parameter_list|,
name|struct
name|ib_recv_wr
modifier|*
name|wr
parameter_list|,
name|struct
name|ib_sge
modifier|*
name|sge
parameter_list|,
name|int
name|id
parameter_list|)
block|{
name|struct
name|ipoib_rx_buf
modifier|*
name|rx_req
decl_stmt|;
name|struct
name|ib_recv_wr
modifier|*
name|bad_wr
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|i
decl_stmt|;
name|rx_req
operator|=
operator|(
expr|struct
name|ipoib_rx_buf
operator|*
operator|)
operator|&
name|rx
operator|->
name|rx_ring
index|[
name|id
index|]
expr_stmt|;
for|for
control|(
name|m
operator|=
name|rx_req
operator|->
name|mb
operator|,
name|i
operator|=
literal|0
init|;
name|m
operator|!=
name|NULL
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
operator|,
name|i
operator|++
control|)
block|{
name|sge
index|[
name|i
index|]
operator|.
name|addr
operator|=
name|rx_req
operator|->
name|mapping
index|[
name|i
index|]
expr_stmt|;
name|sge
index|[
name|i
index|]
operator|.
name|length
operator|=
name|m
operator|->
name|m_len
expr_stmt|;
block|}
name|wr
operator|->
name|num_sge
operator|=
name|i
expr_stmt|;
name|wr
operator|->
name|wr_id
operator|=
name|id
operator||
name|IPOIB_OP_CM
operator||
name|IPOIB_OP_RECV
expr_stmt|;
name|ret
operator|=
name|ib_post_recv
argument_list|(
name|rx
operator|->
name|qp
argument_list|,
name|wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"post recv failed for buf %d (%d)\n"
argument_list|,
name|id
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|ipoib_dma_unmap_rx
argument_list|(
name|priv
argument_list|,
name|rx_req
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|rx
operator|->
name|rx_ring
index|[
name|id
index|]
operator|.
name|mb
argument_list|)
expr_stmt|;
name|rx
operator|->
name|rx_ring
index|[
name|id
index|]
operator|.
name|mb
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|mbuf
modifier|*
name|ipoib_cm_alloc_rx_mb
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ipoib_cm_rx_buf
modifier|*
name|rx_req
parameter_list|)
block|{
return|return
name|ipoib_alloc_map_mb
argument_list|(
name|priv
argument_list|,
operator|(
expr|struct
name|ipoib_rx_buf
operator|*
operator|)
name|rx_req
argument_list|,
name|priv
operator|->
name|cm
operator|.
name|max_cm_mtu
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_cm_free_rx_ring
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ipoib_cm_rx_buf
modifier|*
name|rx_ring
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ipoib_recvq_size
condition|;
operator|++
name|i
control|)
if|if
condition|(
name|rx_ring
index|[
name|i
index|]
operator|.
name|mb
condition|)
block|{
name|ipoib_cm_dma_unmap_rx
argument_list|(
name|priv
argument_list|,
operator|&
name|rx_ring
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|rx_ring
index|[
name|i
index|]
operator|.
name|mb
argument_list|)
expr_stmt|;
block|}
name|kfree
argument_list|(
name|rx_ring
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_cm_start_rx_drain
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
name|struct
name|ipoib_cm_rx
modifier|*
name|p
decl_stmt|;
comment|/* We only reserved 1 extra slot in CQ for drain WRs, so 	 * make sure we have at most 1 outstanding WR. */
if|if
condition|(
name|list_empty
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_flush_list
argument_list|)
operator|||
operator|!
name|list_empty
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_drain_list
argument_list|)
condition|)
return|return;
comment|/* 	 * QPs on flush list are error state.  This way, a "flush 	 * error" WC will be immediately generated for each WR we post. 	 */
name|p
operator|=
name|list_entry
argument_list|(
name|priv
operator|->
name|cm
operator|.
name|rx_flush_list
operator|.
name|next
argument_list|,
name|typeof
argument_list|(
operator|*
name|p
argument_list|)
argument_list|,
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|ib_post_send
argument_list|(
name|p
operator|->
name|qp
argument_list|,
operator|&
name|ipoib_cm_rx_drain_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
condition|)
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"failed to post drain wr\n"
argument_list|)
expr_stmt|;
name|list_splice_init
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_flush_list
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_drain_list
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_cm_rx_event_handler
parameter_list|(
name|struct
name|ib_event
modifier|*
name|event
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|ipoib_cm_rx
modifier|*
name|p
init|=
name|ctx
decl_stmt|;
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
init|=
name|p
operator|->
name|priv
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
if|if
condition|(
name|event
operator|->
name|event
operator|!=
name|IB_EVENT_QP_LAST_WQE_REACHED
condition|)
return|return;
name|spin_lock_irqsave
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|list_move
argument_list|(
operator|&
name|p
operator|->
name|list
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_flush_list
argument_list|)
expr_stmt|;
name|p
operator|->
name|state
operator|=
name|IPOIB_CM_RX_FLUSH
expr_stmt|;
name|ipoib_cm_start_rx_drain
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ib_qp
modifier|*
name|ipoib_cm_create_rx_qp
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ipoib_cm_rx
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|ib_qp_init_attr
name|attr
init|=
block|{
operator|.
name|event_handler
operator|=
name|ipoib_cm_rx_event_handler
block|,
operator|.
name|send_cq
operator|=
name|priv
operator|->
name|recv_cq
block|,
comment|/* For drain WR */
operator|.
name|recv_cq
operator|=
name|priv
operator|->
name|recv_cq
block|,
operator|.
name|srq
operator|=
name|priv
operator|->
name|cm
operator|.
name|srq
block|,
operator|.
name|cap
operator|.
name|max_send_wr
operator|=
literal|1
block|,
comment|/* For drain WR */
operator|.
name|cap
operator|.
name|max_send_sge
operator|=
literal|1
block|,
operator|.
name|sq_sig_type
operator|=
name|IB_SIGNAL_ALL_WR
block|,
operator|.
name|qp_type
operator|=
name|IB_QPT_RC
block|,
operator|.
name|qp_context
operator|=
name|p
block|, 	}
decl_stmt|;
if|if
condition|(
operator|!
name|ipoib_cm_has_srq
argument_list|(
name|priv
argument_list|)
condition|)
block|{
name|attr
operator|.
name|cap
operator|.
name|max_recv_wr
operator|=
name|ipoib_recvq_size
expr_stmt|;
name|attr
operator|.
name|cap
operator|.
name|max_recv_sge
operator|=
name|priv
operator|->
name|cm
operator|.
name|num_frags
expr_stmt|;
block|}
return|return
name|ib_create_qp
argument_list|(
name|priv
operator|->
name|pd
argument_list|,
operator|&
name|attr
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ipoib_cm_modify_rx_qp
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|,
name|struct
name|ib_qp
modifier|*
name|qp
parameter_list|,
name|unsigned
name|psn
parameter_list|)
block|{
name|struct
name|ib_qp_attr
name|qp_attr
decl_stmt|;
name|int
name|qp_attr_mask
decl_stmt|,
name|ret
decl_stmt|;
name|qp_attr
operator|.
name|qp_state
operator|=
name|IB_QPS_INIT
expr_stmt|;
name|ret
operator|=
name|ib_cm_init_qp_attr
argument_list|(
name|cm_id
argument_list|,
operator|&
name|qp_attr
argument_list|,
operator|&
name|qp_attr_mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"failed to init QP attr for INIT: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|ib_modify_qp
argument_list|(
name|qp
argument_list|,
operator|&
name|qp_attr
argument_list|,
name|qp_attr_mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"failed to modify QP to INIT: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|qp_attr
operator|.
name|qp_state
operator|=
name|IB_QPS_RTR
expr_stmt|;
name|ret
operator|=
name|ib_cm_init_qp_attr
argument_list|(
name|cm_id
argument_list|,
operator|&
name|qp_attr
argument_list|,
operator|&
name|qp_attr_mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"failed to init QP attr for RTR: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|qp_attr
operator|.
name|rq_psn
operator|=
name|psn
expr_stmt|;
name|ret
operator|=
name|ib_modify_qp
argument_list|(
name|qp
argument_list|,
operator|&
name|qp_attr
argument_list|,
name|qp_attr_mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"failed to modify QP to RTR: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
comment|/* 	 * Current Mellanox HCA firmware won't generate completions 	 * with error for drain WRs unless the QP has been moved to 	 * RTS first. This work-around leaves a window where a QP has 	 * moved to error asynchronously, but this will eventually get 	 * fixed in firmware, so let's not error out if modify QP 	 * fails. 	 */
name|qp_attr
operator|.
name|qp_state
operator|=
name|IB_QPS_RTS
expr_stmt|;
name|ret
operator|=
name|ib_cm_init_qp_attr
argument_list|(
name|cm_id
argument_list|,
operator|&
name|qp_attr
argument_list|,
operator|&
name|qp_attr_mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"failed to init QP attr for RTS: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ret
operator|=
name|ib_modify_qp
argument_list|(
name|qp
argument_list|,
operator|&
name|qp_attr
argument_list|,
name|qp_attr_mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"failed to modify QP to RTS: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_cm_init_rx_wr
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ib_recv_wr
modifier|*
name|wr
parameter_list|,
name|struct
name|ib_sge
modifier|*
name|sge
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IPOIB_CM_RX_SG
condition|;
name|i
operator|++
control|)
name|sge
index|[
name|i
index|]
operator|.
name|lkey
operator|=
name|priv
operator|->
name|mr
operator|->
name|lkey
expr_stmt|;
name|wr
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|wr
operator|->
name|sg_list
operator|=
name|sge
expr_stmt|;
name|wr
operator|->
name|num_sge
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ipoib_cm_nonsrq_init_rx
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|,
name|struct
name|ipoib_cm_rx
modifier|*
name|rx
parameter_list|)
block|{
struct|struct
block|{
name|struct
name|ib_recv_wr
name|wr
decl_stmt|;
name|struct
name|ib_sge
name|sge
index|[
name|IPOIB_CM_RX_SG
index|]
decl_stmt|;
block|}
modifier|*
name|t
struct|;
name|int
name|ret
decl_stmt|;
name|int
name|i
decl_stmt|;
name|rx
operator|->
name|rx_ring
operator|=
name|kzalloc
argument_list|(
name|ipoib_recvq_size
operator|*
sizeof|sizeof
expr|*
name|rx
operator|->
name|rx_ring
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rx
operator|->
name|rx_ring
condition|)
block|{
name|printk
argument_list|(
name|KERN_WARNING
literal|"%s: failed to allocate CM non-SRQ ring (%d entries)\n"
argument_list|,
name|priv
operator|->
name|ca
operator|->
name|name
argument_list|,
name|ipoib_recvq_size
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
name|memset
argument_list|(
name|rx
operator|->
name|rx_ring
argument_list|,
literal|0
argument_list|,
name|ipoib_recvq_size
operator|*
sizeof|sizeof
expr|*
name|rx
operator|->
name|rx_ring
argument_list|)
expr_stmt|;
name|t
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
expr|*
name|t
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|t
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_free
goto|;
block|}
name|ipoib_cm_init_rx_wr
argument_list|(
name|priv
argument_list|,
operator|&
name|t
operator|->
name|wr
argument_list|,
name|t
operator|->
name|sge
argument_list|)
expr_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|cm
operator|.
name|nonsrq_conn_qp
operator|>=
name|ipoib_max_conn_qp
condition|)
block|{
name|spin_unlock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ib_send_cm_rej
argument_list|(
name|cm_id
argument_list|,
name|IB_CM_REJ_NO_QP
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|err_free
goto|;
block|}
else|else
operator|++
name|priv
operator|->
name|cm
operator|.
name|nonsrq_conn_qp
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ipoib_recvq_size
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
operator|!
name|ipoib_cm_alloc_rx_mb
argument_list|(
name|priv
argument_list|,
operator|&
name|rx
operator|->
name|rx_ring
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"failed to allocate receive buffer %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_count
goto|;
block|}
name|ret
operator|=
name|ipoib_cm_post_receive_nonsrq
argument_list|(
name|priv
argument_list|,
name|rx
argument_list|,
operator|&
name|t
operator|->
name|wr
argument_list|,
name|t
operator|->
name|sge
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"ipoib_cm_post_receive_nonsrq "
literal|"failed for buf %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EIO
expr_stmt|;
goto|goto
name|err_count
goto|;
block|}
block|}
name|rx
operator|->
name|recv_count
operator|=
name|ipoib_recvq_size
expr_stmt|;
name|kfree
argument_list|(
name|t
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|err_count
label|:
name|spin_lock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
operator|--
name|priv
operator|->
name|cm
operator|.
name|nonsrq_conn_qp
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|err_free
label|:
name|kfree
argument_list|(
name|t
argument_list|)
expr_stmt|;
name|ipoib_cm_free_rx_ring
argument_list|(
name|priv
argument_list|,
name|rx
operator|->
name|rx_ring
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ipoib_cm_send_rep
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|,
name|struct
name|ib_qp
modifier|*
name|qp
parameter_list|,
name|struct
name|ib_cm_req_event_param
modifier|*
name|req
parameter_list|,
name|unsigned
name|psn
parameter_list|)
block|{
name|struct
name|ipoib_cm_data
name|data
init|=
block|{}
decl_stmt|;
name|struct
name|ib_cm_rep_param
name|rep
init|=
block|{}
decl_stmt|;
name|data
operator|.
name|qpn
operator|=
name|cpu_to_be32
argument_list|(
name|priv
operator|->
name|qp
operator|->
name|qp_num
argument_list|)
expr_stmt|;
name|data
operator|.
name|mtu
operator|=
name|cpu_to_be32
argument_list|(
name|priv
operator|->
name|cm
operator|.
name|max_cm_mtu
argument_list|)
expr_stmt|;
name|rep
operator|.
name|private_data
operator|=
operator|&
name|data
expr_stmt|;
name|rep
operator|.
name|private_data_len
operator|=
sizeof|sizeof
name|data
expr_stmt|;
name|rep
operator|.
name|flow_control
operator|=
literal|0
expr_stmt|;
name|rep
operator|.
name|rnr_retry_count
operator|=
name|req
operator|->
name|rnr_retry_count
expr_stmt|;
name|rep
operator|.
name|srq
operator|=
name|ipoib_cm_has_srq
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|rep
operator|.
name|qp_num
operator|=
name|qp
operator|->
name|qp_num
expr_stmt|;
name|rep
operator|.
name|starting_psn
operator|=
name|psn
expr_stmt|;
return|return
name|ib_send_cm_rep
argument_list|(
name|cm_id
argument_list|,
operator|&
name|rep
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ipoib_cm_req_handler
parameter_list|(
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|,
name|struct
name|ib_cm_event
modifier|*
name|event
parameter_list|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
init|=
name|cm_id
operator|->
name|context
decl_stmt|;
name|struct
name|ipoib_cm_rx
modifier|*
name|p
decl_stmt|;
name|unsigned
name|psn
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"REQ arrived\n"
argument_list|)
expr_stmt|;
name|p
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
expr|*
name|p
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|p
operator|->
name|priv
operator|=
name|priv
expr_stmt|;
name|p
operator|->
name|id
operator|=
name|cm_id
expr_stmt|;
name|cm_id
operator|->
name|context
operator|=
name|p
expr_stmt|;
name|p
operator|->
name|state
operator|=
name|IPOIB_CM_RX_LIVE
expr_stmt|;
name|p
operator|->
name|jiffies
operator|=
name|jiffies
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|p
operator|->
name|list
argument_list|)
expr_stmt|;
name|p
operator|->
name|qp
operator|=
name|ipoib_cm_create_rx_qp
argument_list|(
name|priv
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|p
operator|->
name|qp
argument_list|)
condition|)
block|{
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|p
operator|->
name|qp
argument_list|)
expr_stmt|;
goto|goto
name|err_qp
goto|;
block|}
name|psn
operator|=
name|random
argument_list|()
operator|&
literal|0xffffff
expr_stmt|;
name|ret
operator|=
name|ipoib_cm_modify_rx_qp
argument_list|(
name|priv
argument_list|,
name|cm_id
argument_list|,
name|p
operator|->
name|qp
argument_list|,
name|psn
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_modify
goto|;
if|if
condition|(
operator|!
name|ipoib_cm_has_srq
argument_list|(
name|priv
argument_list|)
condition|)
block|{
name|ret
operator|=
name|ipoib_cm_nonsrq_init_rx
argument_list|(
name|priv
argument_list|,
name|cm_id
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
goto|goto
name|err_modify
goto|;
block|}
name|spin_lock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|queue_delayed_work
argument_list|(
name|ipoib_workqueue
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|stale_task
argument_list|,
name|IPOIB_CM_RX_DELAY
argument_list|)
expr_stmt|;
comment|/* Add this entry to passive ids list head, but do not re-add it 	 * if IB_EVENT_QP_LAST_WQE_REACHED has moved it to flush list. */
name|p
operator|->
name|jiffies
operator|=
name|jiffies
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|state
operator|==
name|IPOIB_CM_RX_LIVE
condition|)
name|list_move
argument_list|(
operator|&
name|p
operator|->
name|list
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|passive_ids
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ipoib_cm_send_rep
argument_list|(
name|priv
argument_list|,
name|cm_id
argument_list|,
name|p
operator|->
name|qp
argument_list|,
operator|&
name|event
operator|->
name|param
operator|.
name|req_rcvd
argument_list|,
name|psn
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"failed to send REP: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ib_modify_qp
argument_list|(
name|p
operator|->
name|qp
argument_list|,
operator|&
name|ipoib_cm_err_attr
argument_list|,
name|IB_QP_STATE
argument_list|)
condition|)
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"unable to move qp to error state\n"
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
name|err_modify
label|:
name|ib_destroy_qp
argument_list|(
name|p
operator|->
name|qp
argument_list|)
expr_stmt|;
name|err_qp
label|:
name|kfree
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ipoib_cm_rx_handler
parameter_list|(
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|,
name|struct
name|ib_cm_event
modifier|*
name|event
parameter_list|)
block|{
name|struct
name|ipoib_cm_rx
modifier|*
name|p
decl_stmt|;
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
decl_stmt|;
switch|switch
condition|(
name|event
operator|->
name|event
condition|)
block|{
case|case
name|IB_CM_REQ_RECEIVED
case|:
return|return
name|ipoib_cm_req_handler
argument_list|(
name|cm_id
argument_list|,
name|event
argument_list|)
return|;
case|case
name|IB_CM_DREQ_RECEIVED
case|:
name|p
operator|=
name|cm_id
operator|->
name|context
expr_stmt|;
name|ib_send_cm_drep
argument_list|(
name|cm_id
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Fall through */
case|case
name|IB_CM_REJ_RECEIVED
case|:
name|p
operator|=
name|cm_id
operator|->
name|context
expr_stmt|;
name|priv
operator|=
name|p
operator|->
name|priv
expr_stmt|;
if|if
condition|(
name|ib_modify_qp
argument_list|(
name|p
operator|->
name|qp
argument_list|,
operator|&
name|ipoib_cm_err_attr
argument_list|,
name|IB_QP_STATE
argument_list|)
condition|)
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"unable to move qp to error state\n"
argument_list|)
expr_stmt|;
comment|/* Fall through */
default|default:
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
name|void
name|ipoib_cm_handle_rx_wc
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ib_wc
modifier|*
name|wc
parameter_list|)
block|{
name|struct
name|ipoib_cm_rx_buf
name|saverx
decl_stmt|;
name|struct
name|ipoib_cm_rx_buf
modifier|*
name|rx_ring
decl_stmt|;
name|unsigned
name|int
name|wr_id
init|=
name|wc
operator|->
name|wr_id
operator|&
operator|~
operator|(
name|IPOIB_OP_CM
operator||
name|IPOIB_OP_RECV
operator|)
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|dev
init|=
name|priv
operator|->
name|dev
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mb
decl_stmt|,
modifier|*
name|newmb
decl_stmt|;
name|struct
name|ipoib_cm_rx
modifier|*
name|p
decl_stmt|;
name|int
name|has_srq
decl_stmt|;
name|u_short
name|proto
decl_stmt|;
name|ipoib_dbg_data
argument_list|(
name|priv
argument_list|,
literal|"cm recv completion: id %d, status: %d\n"
argument_list|,
name|wr_id
argument_list|,
name|wc
operator|->
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|wr_id
operator|>=
name|ipoib_recvq_size
argument_list|)
condition|)
block|{
if|if
condition|(
name|wr_id
operator|==
operator|(
name|IPOIB_CM_RX_DRAIN_WRID
operator|&
operator|~
operator|(
name|IPOIB_OP_CM
operator||
name|IPOIB_OP_RECV
operator|)
operator|)
condition|)
block|{
name|spin_lock
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|list_splice_init
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_drain_list
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_reap_list
argument_list|)
expr_stmt|;
name|ipoib_cm_start_rx_drain
argument_list|(
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|cm
operator|.
name|id
operator|!=
name|NULL
condition|)
name|queue_work
argument_list|(
name|ipoib_workqueue
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_reap_task
argument_list|)
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
else|else
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"cm recv completion event with wrid %d (> %d)\n"
argument_list|,
name|wr_id
argument_list|,
name|ipoib_recvq_size
argument_list|)
expr_stmt|;
return|return;
block|}
name|p
operator|=
name|wc
operator|->
name|qp
operator|->
name|qp_context
expr_stmt|;
name|has_srq
operator|=
name|ipoib_cm_has_srq
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|rx_ring
operator|=
name|has_srq
condition|?
name|priv
operator|->
name|cm
operator|.
name|srq_ring
else|:
name|p
operator|->
name|rx_ring
expr_stmt|;
name|mb
operator|=
name|rx_ring
index|[
name|wr_id
index|]
operator|.
name|mb
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|wc
operator|->
name|status
operator|!=
name|IB_WC_SUCCESS
argument_list|)
condition|)
block|{
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"cm recv error "
literal|"(status=%d, wrid=%d vend_err %x)\n"
argument_list|,
name|wc
operator|->
name|status
argument_list|,
name|wr_id
argument_list|,
name|wc
operator|->
name|vendor_err
argument_list|)
expr_stmt|;
operator|++
name|dev
operator|->
name|if_ierrors
expr_stmt|;
if|if
condition|(
name|has_srq
condition|)
goto|goto
name|repost
goto|;
else|else
block|{
if|if
condition|(
operator|!
operator|--
name|p
operator|->
name|recv_count
condition|)
block|{
name|spin_lock
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|list_move
argument_list|(
operator|&
name|p
operator|->
name|list
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_reap_list
argument_list|)
expr_stmt|;
name|queue_work
argument_list|(
name|ipoib_workqueue
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_reap_task
argument_list|)
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
block|}
if|if
condition|(
name|unlikely
argument_list|(
operator|!
operator|(
name|wr_id
operator|&
name|IPOIB_CM_RX_UPDATE_MASK
operator|)
argument_list|)
condition|)
block|{
if|if
condition|(
name|p
operator|&&
name|time_after_eq
argument_list|(
name|jiffies
argument_list|,
name|p
operator|->
name|jiffies
operator|+
name|IPOIB_CM_RX_UPDATE_TIME
argument_list|)
condition|)
block|{
name|p
operator|->
name|jiffies
operator|=
name|jiffies
expr_stmt|;
comment|/* Move this entry to list head, but do not re-add it 			 * if it has been moved out of list. */
if|if
condition|(
name|p
operator|->
name|state
operator|==
name|IPOIB_CM_RX_LIVE
condition|)
name|list_move
argument_list|(
operator|&
name|p
operator|->
name|list
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|passive_ids
argument_list|)
expr_stmt|;
block|}
block|}
name|memcpy
argument_list|(
operator|&
name|saverx
argument_list|,
operator|&
name|rx_ring
index|[
name|wr_id
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|saverx
argument_list|)
argument_list|)
expr_stmt|;
name|newmb
operator|=
name|ipoib_cm_alloc_rx_mb
argument_list|(
name|priv
argument_list|,
operator|&
name|rx_ring
index|[
name|wr_id
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
operator|!
name|newmb
argument_list|)
condition|)
block|{
comment|/* 		 * If we can't allocate a new RX buffer, dump 		 * this packet and reuse the old buffer. 		 */
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"failed to allocate receive buffer %d\n"
argument_list|,
name|wr_id
argument_list|)
expr_stmt|;
operator|++
name|dev
operator|->
name|if_ierrors
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|rx_ring
index|[
name|wr_id
index|]
argument_list|,
operator|&
name|saverx
argument_list|,
sizeof|sizeof
argument_list|(
name|saverx
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|repost
goto|;
block|}
name|ipoib_cm_dma_unmap_rx
argument_list|(
name|priv
argument_list|,
operator|&
name|saverx
argument_list|)
expr_stmt|;
name|ipoib_dbg_data
argument_list|(
name|priv
argument_list|,
literal|"received %d bytes, SLID 0x%04x\n"
argument_list|,
name|wc
operator|->
name|byte_len
argument_list|,
name|wc
operator|->
name|slid
argument_list|)
expr_stmt|;
name|ipoib_dma_mb
argument_list|(
name|priv
argument_list|,
name|mb
argument_list|,
name|wc
operator|->
name|byte_len
argument_list|)
expr_stmt|;
operator|++
name|dev
operator|->
name|if_opackets
expr_stmt|;
name|dev
operator|->
name|if_obytes
operator|+=
name|mb
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
name|mb
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|dev
expr_stmt|;
name|proto
operator|=
operator|*
name|mtod
argument_list|(
name|mb
argument_list|,
name|uint16_t
operator|*
argument_list|)
expr_stmt|;
name|m_adj
argument_list|(
name|mb
argument_list|,
name|IPOIB_ENCAP_LEN
argument_list|)
expr_stmt|;
name|IPOIB_MTAP_PROTO
argument_list|(
name|dev
argument_list|,
name|mb
argument_list|,
name|proto
argument_list|)
expr_stmt|;
name|ipoib_demux
argument_list|(
name|dev
argument_list|,
name|mb
argument_list|,
name|ntohs
argument_list|(
name|proto
argument_list|)
argument_list|)
expr_stmt|;
name|repost
label|:
if|if
condition|(
name|has_srq
condition|)
block|{
if|if
condition|(
name|unlikely
argument_list|(
name|ipoib_cm_post_receive_srq
argument_list|(
name|priv
argument_list|,
name|wr_id
argument_list|)
argument_list|)
condition|)
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"ipoib_cm_post_receive_srq failed "
literal|"for buf %d\n"
argument_list|,
name|wr_id
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|unlikely
argument_list|(
name|ipoib_cm_post_receive_nonsrq
argument_list|(
name|priv
argument_list|,
name|p
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_wr
argument_list|,
name|priv
operator|->
name|cm
operator|.
name|rx_sge
argument_list|,
name|wr_id
argument_list|)
argument_list|)
condition|)
block|{
operator|--
name|p
operator|->
name|recv_count
expr_stmt|;
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"ipoib_cm_post_receive_nonsrq failed "
literal|"for buf %d\n"
argument_list|,
name|wr_id
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|post_send
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ipoib_cm_tx
modifier|*
name|tx
parameter_list|,
name|struct
name|ipoib_cm_tx_buf
modifier|*
name|tx_req
parameter_list|,
name|unsigned
name|int
name|wr_id
parameter_list|)
block|{
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mb
init|=
name|tx_req
operator|->
name|mb
decl_stmt|;
name|u64
modifier|*
name|mapping
init|=
name|tx_req
operator|->
name|mapping
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|m
operator|=
name|mb
operator|,
name|i
operator|=
literal|0
init|;
name|m
operator|!=
name|NULL
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
operator|,
name|i
operator|++
control|)
block|{
name|priv
operator|->
name|tx_sge
index|[
name|i
index|]
operator|.
name|addr
operator|=
name|mapping
index|[
name|i
index|]
expr_stmt|;
name|priv
operator|->
name|tx_sge
index|[
name|i
index|]
operator|.
name|length
operator|=
name|m
operator|->
name|m_len
expr_stmt|;
block|}
name|priv
operator|->
name|tx_wr
operator|.
name|num_sge
operator|=
name|i
expr_stmt|;
name|priv
operator|->
name|tx_wr
operator|.
name|wr_id
operator|=
name|wr_id
operator||
name|IPOIB_OP_CM
expr_stmt|;
name|priv
operator|->
name|tx_wr
operator|.
name|opcode
operator|=
name|IB_WR_SEND
expr_stmt|;
return|return
name|ib_post_send
argument_list|(
name|tx
operator|->
name|qp
argument_list|,
operator|&
name|priv
operator|->
name|tx_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|ipoib_cm_send
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mb
parameter_list|,
name|struct
name|ipoib_cm_tx
modifier|*
name|tx
parameter_list|)
block|{
name|struct
name|ipoib_cm_tx_buf
modifier|*
name|tx_req
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|dev
init|=
name|priv
operator|->
name|dev
decl_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|priv
operator|->
name|tx_outstanding
operator|>
name|MAX_SEND_CQE
argument_list|)
condition|)
while|while
condition|(
name|ipoib_poll_tx
argument_list|(
name|priv
argument_list|)
condition|)
empty_stmt|;
comment|/* nothing */
name|m_adj
argument_list|(
name|mb
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ipoib_pseudoheader
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|mb
operator|->
name|m_pkthdr
operator|.
name|len
operator|>
name|tx
operator|->
name|mtu
argument_list|)
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"packet len %d (> %d) too long to send, dropping\n"
argument_list|,
name|mb
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|tx
operator|->
name|mtu
argument_list|)
expr_stmt|;
operator|++
name|dev
operator|->
name|if_oerrors
expr_stmt|;
name|ipoib_cm_mb_too_long
argument_list|(
name|priv
argument_list|,
name|mb
argument_list|,
name|IPOIB_CM_MTU
argument_list|(
name|tx
operator|->
name|mtu
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|ipoib_dbg_data
argument_list|(
name|priv
argument_list|,
literal|"sending packet: head 0x%x length %d connection 0x%x\n"
argument_list|,
name|tx
operator|->
name|tx_head
argument_list|,
name|mb
operator|->
name|m_pkthdr
operator|.
name|len
argument_list|,
name|tx
operator|->
name|qp
operator|->
name|qp_num
argument_list|)
expr_stmt|;
comment|/* 	 * We put the mb into the tx_ring _before_ we call post_send() 	 * because it's entirely possible that the completion handler will 	 * run before we execute anything after the post_send().  That 	 * means we have to make sure everything is properly recorded and 	 * our state is consistent before we call post_send(). 	 */
name|tx_req
operator|=
operator|&
name|tx
operator|->
name|tx_ring
index|[
name|tx
operator|->
name|tx_head
operator|&
operator|(
name|ipoib_sendq_size
operator|-
literal|1
operator|)
index|]
expr_stmt|;
name|tx_req
operator|->
name|mb
operator|=
name|mb
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|ipoib_dma_map_tx
argument_list|(
name|priv
operator|->
name|ca
argument_list|,
operator|(
expr|struct
name|ipoib_tx_buf
operator|*
operator|)
name|tx_req
argument_list|,
name|priv
operator|->
name|cm
operator|.
name|num_frags
argument_list|)
argument_list|)
condition|)
block|{
operator|++
name|dev
operator|->
name|if_oerrors
expr_stmt|;
if|if
condition|(
name|tx_req
operator|->
name|mb
condition|)
name|m_freem
argument_list|(
name|tx_req
operator|->
name|mb
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|unlikely
argument_list|(
name|post_send
argument_list|(
name|priv
argument_list|,
name|tx
argument_list|,
name|tx_req
argument_list|,
name|tx
operator|->
name|tx_head
operator|&
operator|(
name|ipoib_sendq_size
operator|-
literal|1
operator|)
argument_list|)
argument_list|)
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"post_send failed\n"
argument_list|)
expr_stmt|;
operator|++
name|dev
operator|->
name|if_oerrors
expr_stmt|;
name|ipoib_dma_unmap_tx
argument_list|(
name|priv
operator|->
name|ca
argument_list|,
operator|(
expr|struct
name|ipoib_tx_buf
operator|*
operator|)
name|tx_req
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|mb
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|++
name|tx
operator|->
name|tx_head
expr_stmt|;
if|if
condition|(
operator|++
name|priv
operator|->
name|tx_outstanding
operator|==
name|ipoib_sendq_size
condition|)
block|{
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"TX ring 0x%x full, stopping kernel net queue\n"
argument_list|,
name|tx
operator|->
name|qp
operator|->
name|qp_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|ib_req_notify_cq
argument_list|(
name|priv
operator|->
name|send_cq
argument_list|,
name|IB_CQ_NEXT_COMP
argument_list|)
condition|)
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"request notify on send CQ failed\n"
argument_list|)
expr_stmt|;
name|dev
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_OACTIVE
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|ipoib_cm_handle_tx_wc
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ib_wc
modifier|*
name|wc
parameter_list|)
block|{
name|struct
name|ipoib_cm_tx
modifier|*
name|tx
init|=
name|wc
operator|->
name|qp
operator|->
name|qp_context
decl_stmt|;
name|unsigned
name|int
name|wr_id
init|=
name|wc
operator|->
name|wr_id
operator|&
operator|~
name|IPOIB_OP_CM
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|dev
init|=
name|priv
operator|->
name|dev
decl_stmt|;
name|struct
name|ipoib_cm_tx_buf
modifier|*
name|tx_req
decl_stmt|;
name|ipoib_dbg_data
argument_list|(
name|priv
argument_list|,
literal|"cm send completion: id %d, status: %d\n"
argument_list|,
name|wr_id
argument_list|,
name|wc
operator|->
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|wr_id
operator|>=
name|ipoib_sendq_size
argument_list|)
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"cm send completion event with wrid %d (> %d)\n"
argument_list|,
name|wr_id
argument_list|,
name|ipoib_sendq_size
argument_list|)
expr_stmt|;
return|return;
block|}
name|tx_req
operator|=
operator|&
name|tx
operator|->
name|tx_ring
index|[
name|wr_id
index|]
expr_stmt|;
name|ipoib_dma_unmap_tx
argument_list|(
name|priv
operator|->
name|ca
argument_list|,
operator|(
expr|struct
name|ipoib_tx_buf
operator|*
operator|)
name|tx_req
argument_list|)
expr_stmt|;
comment|/* FIXME: is this right? Shouldn't we only increment on success? */
operator|++
name|dev
operator|->
name|if_opackets
expr_stmt|;
name|dev
operator|->
name|if_obytes
operator|+=
name|tx_req
operator|->
name|mb
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
name|m_freem
argument_list|(
name|tx_req
operator|->
name|mb
argument_list|)
expr_stmt|;
operator|++
name|tx
operator|->
name|tx_tail
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
operator|--
name|priv
operator|->
name|tx_outstanding
operator|==
name|ipoib_sendq_size
operator|>>
literal|1
argument_list|)
operator|&&
operator|(
name|dev
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_OACTIVE
operator|)
operator|!=
literal|0
operator|&&
name|test_bit
argument_list|(
name|IPOIB_FLAG_ADMIN_UP
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
condition|)
name|dev
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
if|if
condition|(
name|wc
operator|->
name|status
operator|!=
name|IB_WC_SUCCESS
operator|&&
name|wc
operator|->
name|status
operator|!=
name|IB_WC_WR_FLUSH_ERR
condition|)
block|{
name|struct
name|ipoib_path
modifier|*
name|path
decl_stmt|;
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"failed cm send event "
literal|"(status=%d, wrid=%d vend_err %x)\n"
argument_list|,
name|wc
operator|->
name|status
argument_list|,
name|wr_id
argument_list|,
name|wc
operator|->
name|vendor_err
argument_list|)
expr_stmt|;
name|path
operator|=
name|tx
operator|->
name|path
expr_stmt|;
if|if
condition|(
name|path
condition|)
block|{
name|path
operator|->
name|cm
operator|=
name|NULL
expr_stmt|;
name|rb_erase
argument_list|(
operator|&
name|path
operator|->
name|rb_node
argument_list|,
operator|&
name|priv
operator|->
name|path_tree
argument_list|)
expr_stmt|;
name|list_del
argument_list|(
operator|&
name|path
operator|->
name|list
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|test_and_clear_bit
argument_list|(
name|IPOIB_FLAG_INITIALIZED
argument_list|,
operator|&
name|tx
operator|->
name|flags
argument_list|)
condition|)
block|{
name|list_move
argument_list|(
operator|&
name|tx
operator|->
name|list
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|reap_list
argument_list|)
expr_stmt|;
name|queue_work
argument_list|(
name|ipoib_workqueue
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|reap_task
argument_list|)
expr_stmt|;
block|}
name|clear_bit
argument_list|(
name|IPOIB_FLAG_OPER_UP
argument_list|,
operator|&
name|tx
operator|->
name|flags
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|ipoib_cm_dev_open
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|IPOIB_CM_SUPPORTED
argument_list|(
name|IF_LLADDR
argument_list|(
name|priv
operator|->
name|dev
argument_list|)
argument_list|)
condition|)
return|return
literal|0
return|;
name|priv
operator|->
name|cm
operator|.
name|id
operator|=
name|ib_create_cm_id
argument_list|(
name|priv
operator|->
name|ca
argument_list|,
name|ipoib_cm_rx_handler
argument_list|,
name|priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|priv
operator|->
name|cm
operator|.
name|id
argument_list|)
condition|)
block|{
name|printk
argument_list|(
name|KERN_WARNING
literal|"%s: failed to create CM ID\n"
argument_list|,
name|priv
operator|->
name|ca
operator|->
name|name
argument_list|)
expr_stmt|;
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|priv
operator|->
name|cm
operator|.
name|id
argument_list|)
expr_stmt|;
goto|goto
name|err_cm
goto|;
block|}
name|ret
operator|=
name|ib_cm_listen
argument_list|(
name|priv
operator|->
name|cm
operator|.
name|id
argument_list|,
name|cpu_to_be64
argument_list|(
name|IPOIB_CM_IETF_ID
operator||
name|priv
operator|->
name|qp
operator|->
name|qp_num
argument_list|)
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
name|KERN_WARNING
literal|"%s: failed to listen on ID 0x%llx\n"
argument_list|,
name|priv
operator|->
name|ca
operator|->
name|name
argument_list|,
name|IPOIB_CM_IETF_ID
operator||
name|priv
operator|->
name|qp
operator|->
name|qp_num
argument_list|)
expr_stmt|;
goto|goto
name|err_listen
goto|;
block|}
return|return
literal|0
return|;
name|err_listen
label|:
name|ib_destroy_cm_id
argument_list|(
name|priv
operator|->
name|cm
operator|.
name|id
argument_list|)
expr_stmt|;
name|err_cm
label|:
name|priv
operator|->
name|cm
operator|.
name|id
operator|=
name|NULL
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_cm_free_rx_reap_list
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|ipoib_cm_rx
modifier|*
name|rx
decl_stmt|,
modifier|*
name|n
decl_stmt|;
name|LIST_HEAD
argument_list|(
name|list
argument_list|)
expr_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|list_splice_init
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_reap_list
argument_list|,
operator|&
name|list
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|list_for_each_entry_safe
argument_list|(
argument|rx
argument_list|,
argument|n
argument_list|,
argument|&list
argument_list|,
argument|list
argument_list|)
block|{
name|ib_destroy_cm_id
argument_list|(
name|rx
operator|->
name|id
argument_list|)
expr_stmt|;
name|ib_destroy_qp
argument_list|(
name|rx
operator|->
name|qp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ipoib_cm_has_srq
argument_list|(
name|priv
argument_list|)
condition|)
block|{
name|ipoib_cm_free_rx_ring
argument_list|(
name|priv
argument_list|,
name|rx
operator|->
name|rx_ring
argument_list|)
expr_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
operator|--
name|priv
operator|->
name|cm
operator|.
name|nonsrq_conn_qp
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
name|kfree
argument_list|(
name|rx
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ipoib_cm_dev_stop
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|ipoib_cm_rx
modifier|*
name|p
decl_stmt|;
name|unsigned
name|long
name|begin
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|IPOIB_CM_SUPPORTED
argument_list|(
name|IF_LLADDR
argument_list|(
name|priv
operator|->
name|dev
argument_list|)
argument_list|)
operator|||
operator|!
name|priv
operator|->
name|cm
operator|.
name|id
condition|)
return|return;
name|ib_destroy_cm_id
argument_list|(
name|priv
operator|->
name|cm
operator|.
name|id
argument_list|)
expr_stmt|;
name|priv
operator|->
name|cm
operator|.
name|id
operator|=
name|NULL
expr_stmt|;
name|cancel_work_sync
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_reap_task
argument_list|)
expr_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|list_empty
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|passive_ids
argument_list|)
condition|)
block|{
name|p
operator|=
name|list_entry
argument_list|(
name|priv
operator|->
name|cm
operator|.
name|passive_ids
operator|.
name|next
argument_list|,
name|typeof
argument_list|(
operator|*
name|p
argument_list|)
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|list_move
argument_list|(
operator|&
name|p
operator|->
name|list
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_error_list
argument_list|)
expr_stmt|;
name|p
operator|->
name|state
operator|=
name|IPOIB_CM_RX_ERROR
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_modify_qp
argument_list|(
name|p
operator|->
name|qp
argument_list|,
operator|&
name|ipoib_cm_err_attr
argument_list|,
name|IB_QP_STATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"unable to move qp to error state: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
comment|/* Wait for all RX to be drained */
name|begin
operator|=
name|jiffies
expr_stmt|;
while|while
condition|(
operator|!
name|list_empty
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_error_list
argument_list|)
operator|||
operator|!
name|list_empty
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_flush_list
argument_list|)
operator|||
operator|!
name|list_empty
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_drain_list
argument_list|)
condition|)
block|{
if|if
condition|(
name|time_after
argument_list|(
name|jiffies
argument_list|,
name|begin
operator|+
literal|5
operator|*
name|HZ
argument_list|)
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"RX drain timing out\n"
argument_list|)
expr_stmt|;
comment|/* 			 * assume the HW is wedged and just free up everything. 			 */
name|list_splice_init
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_flush_list
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_reap_list
argument_list|)
expr_stmt|;
name|list_splice_init
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_error_list
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_reap_list
argument_list|)
expr_stmt|;
name|list_splice_init
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_drain_list
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_reap_list
argument_list|)
expr_stmt|;
break|break;
block|}
name|spin_unlock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|ipoib_drain_cq
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
name|spin_unlock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ipoib_cm_free_rx_reap_list
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|cancel_delayed_work
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|stale_task
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ipoib_cm_rep_handler
parameter_list|(
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|,
name|struct
name|ib_cm_event
modifier|*
name|event
parameter_list|)
block|{
name|struct
name|ipoib_cm_tx
modifier|*
name|p
init|=
name|cm_id
operator|->
name|context
decl_stmt|;
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
init|=
name|p
operator|->
name|priv
decl_stmt|;
name|struct
name|ipoib_cm_data
modifier|*
name|data
init|=
name|event
operator|->
name|private_data
decl_stmt|;
name|struct
name|ifqueue
name|mbqueue
decl_stmt|;
name|struct
name|ib_qp_attr
name|qp_attr
decl_stmt|;
name|int
name|qp_attr_mask
decl_stmt|,
name|ret
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mb
decl_stmt|;
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"cm rep handler\n"
argument_list|)
expr_stmt|;
name|p
operator|->
name|mtu
operator|=
name|be32_to_cpu
argument_list|(
name|data
operator|->
name|mtu
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|mtu
operator|<=
name|IPOIB_ENCAP_LEN
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"Rejecting connection: mtu %d<= %d\n"
argument_list|,
name|p
operator|->
name|mtu
argument_list|,
name|IPOIB_ENCAP_LEN
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|qp_attr
operator|.
name|qp_state
operator|=
name|IB_QPS_RTR
expr_stmt|;
name|ret
operator|=
name|ib_cm_init_qp_attr
argument_list|(
name|cm_id
argument_list|,
operator|&
name|qp_attr
argument_list|,
operator|&
name|qp_attr_mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"failed to init QP attr for RTR: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|qp_attr
operator|.
name|rq_psn
operator|=
literal|0
comment|/* FIXME */
expr_stmt|;
name|ret
operator|=
name|ib_modify_qp
argument_list|(
name|p
operator|->
name|qp
argument_list|,
operator|&
name|qp_attr
argument_list|,
name|qp_attr_mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"failed to modify QP to RTR: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|qp_attr
operator|.
name|qp_state
operator|=
name|IB_QPS_RTS
expr_stmt|;
name|ret
operator|=
name|ib_cm_init_qp_attr
argument_list|(
name|cm_id
argument_list|,
operator|&
name|qp_attr
argument_list|,
operator|&
name|qp_attr_mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"failed to init QP attr for RTS: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
name|ib_modify_qp
argument_list|(
name|p
operator|->
name|qp
argument_list|,
operator|&
name|qp_attr
argument_list|,
name|qp_attr_mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"failed to modify QP to RTS: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|bzero
argument_list|(
operator|&
name|mbqueue
argument_list|,
sizeof|sizeof
argument_list|(
name|mbqueue
argument_list|)
argument_list|)
expr_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|set_bit
argument_list|(
name|IPOIB_FLAG_OPER_UP
argument_list|,
operator|&
name|p
operator|->
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|path
condition|)
for|for
control|(
init|;
condition|;
control|)
block|{
name|_IF_DEQUEUE
argument_list|(
operator|&
name|p
operator|->
name|path
operator|->
name|queue
argument_list|,
name|mb
argument_list|)
expr_stmt|;
if|if
condition|(
name|mb
operator|==
name|NULL
condition|)
break|break;
name|_IF_ENQUEUE
argument_list|(
operator|&
name|mbqueue
argument_list|,
name|mb
argument_list|)
expr_stmt|;
block|}
name|spin_unlock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|struct
name|ifnet
modifier|*
name|dev
init|=
name|p
operator|->
name|priv
operator|->
name|dev
decl_stmt|;
name|_IF_DEQUEUE
argument_list|(
operator|&
name|mbqueue
argument_list|,
name|mb
argument_list|)
expr_stmt|;
if|if
condition|(
name|mb
operator|==
name|NULL
condition|)
break|break;
name|mb
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|dev
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|if_transmit
argument_list|(
name|dev
argument_list|,
name|mb
argument_list|)
condition|)
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"dev_queue_xmit failed "
literal|"to requeue packet\n"
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|ib_send_cm_rtu
argument_list|(
name|cm_id
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"failed to send RTU: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ib_qp
modifier|*
name|ipoib_cm_create_tx_qp
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ipoib_cm_tx
modifier|*
name|tx
parameter_list|)
block|{
name|struct
name|ib_qp_init_attr
name|attr
init|=
block|{
operator|.
name|send_cq
operator|=
name|priv
operator|->
name|send_cq
block|,
operator|.
name|recv_cq
operator|=
name|priv
operator|->
name|recv_cq
block|,
operator|.
name|srq
operator|=
name|priv
operator|->
name|cm
operator|.
name|srq
block|,
operator|.
name|cap
operator|.
name|max_send_wr
operator|=
name|ipoib_sendq_size
block|,
operator|.
name|cap
operator|.
name|max_send_sge
operator|=
name|priv
operator|->
name|cm
operator|.
name|num_frags
block|,
operator|.
name|sq_sig_type
operator|=
name|IB_SIGNAL_ALL_WR
block|,
operator|.
name|qp_type
operator|=
name|IB_QPT_RC
block|,
operator|.
name|qp_context
operator|=
name|tx
block|}
decl_stmt|;
return|return
name|ib_create_qp
argument_list|(
name|priv
operator|->
name|pd
argument_list|,
operator|&
name|attr
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ipoib_cm_send_req
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ib_cm_id
modifier|*
name|id
parameter_list|,
name|struct
name|ib_qp
modifier|*
name|qp
parameter_list|,
name|u32
name|qpn
parameter_list|,
name|struct
name|ib_sa_path_rec
modifier|*
name|pathrec
parameter_list|)
block|{
name|struct
name|ipoib_cm_data
name|data
init|=
block|{}
decl_stmt|;
name|struct
name|ib_cm_req_param
name|req
init|=
block|{}
decl_stmt|;
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"cm send req\n"
argument_list|)
expr_stmt|;
name|data
operator|.
name|qpn
operator|=
name|cpu_to_be32
argument_list|(
name|priv
operator|->
name|qp
operator|->
name|qp_num
argument_list|)
expr_stmt|;
name|data
operator|.
name|mtu
operator|=
name|cpu_to_be32
argument_list|(
name|priv
operator|->
name|cm
operator|.
name|max_cm_mtu
argument_list|)
expr_stmt|;
name|req
operator|.
name|primary_path
operator|=
name|pathrec
expr_stmt|;
name|req
operator|.
name|alternate_path
operator|=
name|NULL
expr_stmt|;
name|req
operator|.
name|service_id
operator|=
name|cpu_to_be64
argument_list|(
name|IPOIB_CM_IETF_ID
operator||
name|qpn
argument_list|)
expr_stmt|;
name|req
operator|.
name|qp_num
operator|=
name|qp
operator|->
name|qp_num
expr_stmt|;
name|req
operator|.
name|qp_type
operator|=
name|qp
operator|->
name|qp_type
expr_stmt|;
name|req
operator|.
name|private_data
operator|=
operator|&
name|data
expr_stmt|;
name|req
operator|.
name|private_data_len
operator|=
sizeof|sizeof
name|data
expr_stmt|;
name|req
operator|.
name|flow_control
operator|=
literal|0
expr_stmt|;
name|req
operator|.
name|starting_psn
operator|=
literal|0
expr_stmt|;
comment|/* FIXME */
comment|/* 	 * Pick some arbitrary defaults here; we could make these 	 * module parameters if anyone cared about setting them. 	 */
name|req
operator|.
name|responder_resources
operator|=
literal|4
expr_stmt|;
name|req
operator|.
name|remote_cm_response_timeout
operator|=
literal|20
expr_stmt|;
name|req
operator|.
name|local_cm_response_timeout
operator|=
literal|20
expr_stmt|;
name|req
operator|.
name|retry_count
operator|=
literal|0
expr_stmt|;
comment|/* RFC draft warns against retries */
name|req
operator|.
name|rnr_retry_count
operator|=
literal|0
expr_stmt|;
comment|/* RFC draft warns against retries */
name|req
operator|.
name|max_cm_retries
operator|=
literal|15
expr_stmt|;
name|req
operator|.
name|srq
operator|=
name|ipoib_cm_has_srq
argument_list|(
name|priv
argument_list|)
expr_stmt|;
return|return
name|ib_send_cm_req
argument_list|(
name|id
argument_list|,
operator|&
name|req
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ipoib_cm_modify_tx_init
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|,
name|struct
name|ib_qp
modifier|*
name|qp
parameter_list|)
block|{
name|struct
name|ib_qp_attr
name|qp_attr
decl_stmt|;
name|int
name|qp_attr_mask
decl_stmt|,
name|ret
decl_stmt|;
name|ret
operator|=
name|ib_find_pkey
argument_list|(
name|priv
operator|->
name|ca
argument_list|,
name|priv
operator|->
name|port
argument_list|,
name|priv
operator|->
name|pkey
argument_list|,
operator|&
name|qp_attr
operator|.
name|pkey_index
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"pkey 0x%x not found: %d\n"
argument_list|,
name|priv
operator|->
name|pkey
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|qp_attr
operator|.
name|qp_state
operator|=
name|IB_QPS_INIT
expr_stmt|;
name|qp_attr
operator|.
name|qp_access_flags
operator|=
name|IB_ACCESS_LOCAL_WRITE
expr_stmt|;
name|qp_attr
operator|.
name|port_num
operator|=
name|priv
operator|->
name|port
expr_stmt|;
name|qp_attr_mask
operator|=
name|IB_QP_STATE
operator||
name|IB_QP_ACCESS_FLAGS
operator||
name|IB_QP_PKEY_INDEX
operator||
name|IB_QP_PORT
expr_stmt|;
name|ret
operator|=
name|ib_modify_qp
argument_list|(
name|qp
argument_list|,
operator|&
name|qp_attr
argument_list|,
name|qp_attr_mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"failed to modify tx QP to INIT: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ipoib_cm_tx_init
parameter_list|(
name|struct
name|ipoib_cm_tx
modifier|*
name|p
parameter_list|,
name|u32
name|qpn
parameter_list|,
name|struct
name|ib_sa_path_rec
modifier|*
name|pathrec
parameter_list|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
init|=
name|p
operator|->
name|priv
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|p
operator|->
name|tx_ring
operator|=
name|kzalloc
argument_list|(
name|ipoib_sendq_size
operator|*
sizeof|sizeof
expr|*
name|p
operator|->
name|tx_ring
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
operator|->
name|tx_ring
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"failed to allocate tx ring\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|err_tx
goto|;
block|}
name|memset
argument_list|(
name|p
operator|->
name|tx_ring
argument_list|,
literal|0
argument_list|,
name|ipoib_sendq_size
operator|*
sizeof|sizeof
expr|*
name|p
operator|->
name|tx_ring
argument_list|)
expr_stmt|;
name|p
operator|->
name|qp
operator|=
name|ipoib_cm_create_tx_qp
argument_list|(
name|p
operator|->
name|priv
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|p
operator|->
name|qp
argument_list|)
condition|)
block|{
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|p
operator|->
name|qp
argument_list|)
expr_stmt|;
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"failed to allocate tx qp: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|err_qp
goto|;
block|}
name|p
operator|->
name|id
operator|=
name|ib_create_cm_id
argument_list|(
name|priv
operator|->
name|ca
argument_list|,
name|ipoib_cm_tx_handler
argument_list|,
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|p
operator|->
name|id
argument_list|)
condition|)
block|{
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|p
operator|->
name|id
argument_list|)
expr_stmt|;
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"failed to create tx cm id: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|err_id
goto|;
block|}
name|ret
operator|=
name|ipoib_cm_modify_tx_init
argument_list|(
name|p
operator|->
name|priv
argument_list|,
name|p
operator|->
name|id
argument_list|,
name|p
operator|->
name|qp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"failed to modify tx qp to rtr: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|err_modify
goto|;
block|}
name|ret
operator|=
name|ipoib_cm_send_req
argument_list|(
name|p
operator|->
name|priv
argument_list|,
name|p
operator|->
name|id
argument_list|,
name|p
operator|->
name|qp
argument_list|,
name|qpn
argument_list|,
name|pathrec
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"failed to send cm req: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|err_send_cm
goto|;
block|}
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"Request connection 0x%x for gid %pI6 qpn 0x%x\n"
argument_list|,
name|p
operator|->
name|qp
operator|->
name|qp_num
argument_list|,
name|pathrec
operator|->
name|dgid
operator|.
name|raw
argument_list|,
name|qpn
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|err_send_cm
label|:
name|err_modify
label|:
name|ib_destroy_cm_id
argument_list|(
name|p
operator|->
name|id
argument_list|)
expr_stmt|;
name|err_id
label|:
name|p
operator|->
name|id
operator|=
name|NULL
expr_stmt|;
name|ib_destroy_qp
argument_list|(
name|p
operator|->
name|qp
argument_list|)
expr_stmt|;
name|err_qp
label|:
name|p
operator|->
name|qp
operator|=
name|NULL
expr_stmt|;
name|kfree
argument_list|(
name|p
operator|->
name|tx_ring
argument_list|)
expr_stmt|;
name|err_tx
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_cm_tx_destroy
parameter_list|(
name|struct
name|ipoib_cm_tx
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
init|=
name|p
operator|->
name|priv
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|dev
init|=
name|priv
operator|->
name|dev
decl_stmt|;
name|struct
name|ipoib_cm_tx_buf
modifier|*
name|tx_req
decl_stmt|;
name|unsigned
name|long
name|begin
decl_stmt|;
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"Destroy active connection 0x%x head 0x%x tail 0x%x\n"
argument_list|,
name|p
operator|->
name|qp
condition|?
name|p
operator|->
name|qp
operator|->
name|qp_num
else|:
literal|0
argument_list|,
name|p
operator|->
name|tx_head
argument_list|,
name|p
operator|->
name|tx_tail
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|path
condition|)
name|ipoib_path_free
argument_list|(
name|priv
argument_list|,
name|p
operator|->
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|id
condition|)
name|ib_destroy_cm_id
argument_list|(
name|p
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|tx_ring
condition|)
block|{
comment|/* Wait for all sends to complete */
name|begin
operator|=
name|jiffies
expr_stmt|;
while|while
condition|(
operator|(
name|int
operator|)
name|p
operator|->
name|tx_tail
operator|-
operator|(
name|int
operator|)
name|p
operator|->
name|tx_head
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|time_after
argument_list|(
name|jiffies
argument_list|,
name|begin
operator|+
literal|5
operator|*
name|HZ
argument_list|)
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"timing out; %d sends not completed\n"
argument_list|,
name|p
operator|->
name|tx_head
operator|-
name|p
operator|->
name|tx_tail
argument_list|)
expr_stmt|;
goto|goto
name|timeout
goto|;
block|}
name|msleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|timeout
label|:
while|while
condition|(
operator|(
name|int
operator|)
name|p
operator|->
name|tx_tail
operator|-
operator|(
name|int
operator|)
name|p
operator|->
name|tx_head
operator|<
literal|0
condition|)
block|{
name|tx_req
operator|=
operator|&
name|p
operator|->
name|tx_ring
index|[
name|p
operator|->
name|tx_tail
operator|&
operator|(
name|ipoib_sendq_size
operator|-
literal|1
operator|)
index|]
expr_stmt|;
name|ipoib_dma_unmap_tx
argument_list|(
name|priv
operator|->
name|ca
argument_list|,
operator|(
expr|struct
name|ipoib_tx_buf
operator|*
operator|)
name|tx_req
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|tx_req
operator|->
name|mb
argument_list|)
expr_stmt|;
operator|++
name|p
operator|->
name|tx_tail
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
operator|--
name|priv
operator|->
name|tx_outstanding
operator|==
name|ipoib_sendq_size
operator|>>
literal|1
argument_list|)
operator|&&
operator|(
name|dev
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_OACTIVE
operator|)
operator|!=
literal|0
operator|&&
name|test_bit
argument_list|(
name|IPOIB_FLAG_ADMIN_UP
argument_list|,
operator|&
name|priv
operator|->
name|flags
argument_list|)
condition|)
name|dev
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
block|}
if|if
condition|(
name|p
operator|->
name|qp
condition|)
name|ib_destroy_qp
argument_list|(
name|p
operator|->
name|qp
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|p
operator|->
name|tx_ring
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ipoib_cm_tx_handler
parameter_list|(
name|struct
name|ib_cm_id
modifier|*
name|cm_id
parameter_list|,
name|struct
name|ib_cm_event
modifier|*
name|event
parameter_list|)
block|{
name|struct
name|ipoib_cm_tx
modifier|*
name|tx
init|=
name|cm_id
operator|->
name|context
decl_stmt|;
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
init|=
name|tx
operator|->
name|priv
decl_stmt|;
name|struct
name|ipoib_path
modifier|*
name|path
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|ret
decl_stmt|;
switch|switch
condition|(
name|event
operator|->
name|event
condition|)
block|{
case|case
name|IB_CM_DREQ_RECEIVED
case|:
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"DREQ received.\n"
argument_list|)
expr_stmt|;
name|ib_send_cm_drep
argument_list|(
name|cm_id
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_REP_RECEIVED
case|:
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"REP received.\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ipoib_cm_rep_handler
argument_list|(
name|cm_id
argument_list|,
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|ib_send_cm_rej
argument_list|(
name|cm_id
argument_list|,
name|IB_CM_REJ_CONSUMER_DEFINED
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_CM_REQ_ERROR
case|:
case|case
name|IB_CM_REJ_RECEIVED
case|:
case|case
name|IB_CM_TIMEWAIT_EXIT
case|:
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"CM error %d.\n"
argument_list|,
name|event
operator|->
name|event
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|path
operator|=
name|tx
operator|->
name|path
expr_stmt|;
if|if
condition|(
name|path
condition|)
block|{
name|path
operator|->
name|cm
operator|=
name|NULL
expr_stmt|;
name|tx
operator|->
name|path
operator|=
name|NULL
expr_stmt|;
name|rb_erase
argument_list|(
operator|&
name|path
operator|->
name|rb_node
argument_list|,
operator|&
name|priv
operator|->
name|path_tree
argument_list|)
expr_stmt|;
name|list_del
argument_list|(
operator|&
name|path
operator|->
name|list
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|test_and_clear_bit
argument_list|(
name|IPOIB_FLAG_INITIALIZED
argument_list|,
operator|&
name|tx
operator|->
name|flags
argument_list|)
condition|)
block|{
name|list_move
argument_list|(
operator|&
name|tx
operator|->
name|list
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|reap_list
argument_list|)
expr_stmt|;
name|queue_work
argument_list|(
name|ipoib_workqueue
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|reap_task
argument_list|)
expr_stmt|;
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|path
condition|)
name|ipoib_path_free
argument_list|(
name|tx
operator|->
name|priv
argument_list|,
name|path
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|struct
name|ipoib_cm_tx
modifier|*
name|ipoib_cm_create_tx
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|ipoib_path
modifier|*
name|path
parameter_list|)
block|{
name|struct
name|ipoib_cm_tx
modifier|*
name|tx
decl_stmt|;
name|tx
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
expr|*
name|tx
argument_list|,
name|GFP_ATOMIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tx
condition|)
return|return
name|NULL
return|;
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"Creating cm tx\n"
argument_list|)
expr_stmt|;
name|path
operator|->
name|cm
operator|=
name|tx
expr_stmt|;
name|tx
operator|->
name|path
operator|=
name|path
expr_stmt|;
name|tx
operator|->
name|priv
operator|=
name|priv
expr_stmt|;
name|list_add
argument_list|(
operator|&
name|tx
operator|->
name|list
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|start_list
argument_list|)
expr_stmt|;
name|set_bit
argument_list|(
name|IPOIB_FLAG_INITIALIZED
argument_list|,
operator|&
name|tx
operator|->
name|flags
argument_list|)
expr_stmt|;
name|queue_work
argument_list|(
name|ipoib_workqueue
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|start_task
argument_list|)
expr_stmt|;
return|return
name|tx
return|;
block|}
end_function

begin_function
name|void
name|ipoib_cm_destroy_tx
parameter_list|(
name|struct
name|ipoib_cm_tx
modifier|*
name|tx
parameter_list|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
init|=
name|tx
operator|->
name|priv
decl_stmt|;
if|if
condition|(
name|test_and_clear_bit
argument_list|(
name|IPOIB_FLAG_INITIALIZED
argument_list|,
operator|&
name|tx
operator|->
name|flags
argument_list|)
condition|)
block|{
name|spin_lock
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|list_move
argument_list|(
operator|&
name|tx
operator|->
name|list
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|reap_list
argument_list|)
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|queue_work
argument_list|(
name|ipoib_workqueue
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|reap_task
argument_list|)
expr_stmt|;
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"Reap connection for gid %pI6\n"
argument_list|,
name|tx
operator|->
name|path
operator|->
name|pathrec
operator|.
name|dgid
operator|.
name|raw
argument_list|)
expr_stmt|;
name|tx
operator|->
name|path
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_cm_tx_start
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|ipoib_dev_priv
argument_list|,
name|cm
operator|.
name|start_task
argument_list|)
decl_stmt|;
name|struct
name|ipoib_path
modifier|*
name|path
decl_stmt|;
name|struct
name|ipoib_cm_tx
modifier|*
name|p
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|ib_sa_path_rec
name|pathrec
decl_stmt|;
name|u32
name|qpn
decl_stmt|;
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"cm start task\n"
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|list_empty
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|start_list
argument_list|)
condition|)
block|{
name|p
operator|=
name|list_entry
argument_list|(
name|priv
operator|->
name|cm
operator|.
name|start_list
operator|.
name|next
argument_list|,
name|typeof
argument_list|(
operator|*
name|p
argument_list|)
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|list_del_init
argument_list|(
operator|&
name|p
operator|->
name|list
argument_list|)
expr_stmt|;
name|path
operator|=
name|p
operator|->
name|path
expr_stmt|;
name|qpn
operator|=
name|IPOIB_QPN
argument_list|(
name|path
operator|->
name|hwaddr
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|pathrec
argument_list|,
operator|&
name|p
operator|->
name|path
operator|->
name|pathrec
argument_list|,
sizeof|sizeof
name|pathrec
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ipoib_cm_tx_init
argument_list|(
name|p
argument_list|,
name|qpn
argument_list|,
operator|&
name|pathrec
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|path
operator|=
name|p
operator|->
name|path
expr_stmt|;
if|if
condition|(
name|path
condition|)
block|{
name|path
operator|->
name|cm
operator|=
name|NULL
expr_stmt|;
name|rb_erase
argument_list|(
operator|&
name|path
operator|->
name|rb_node
argument_list|,
operator|&
name|priv
operator|->
name|path_tree
argument_list|)
expr_stmt|;
name|list_del
argument_list|(
operator|&
name|path
operator|->
name|list
argument_list|)
expr_stmt|;
name|ipoib_path_free
argument_list|(
name|priv
argument_list|,
name|path
argument_list|)
expr_stmt|;
block|}
name|list_del
argument_list|(
operator|&
name|p
operator|->
name|list
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_cm_tx_reap
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|ipoib_dev_priv
argument_list|,
name|cm
operator|.
name|reap_task
argument_list|)
decl_stmt|;
name|struct
name|ipoib_cm_tx
modifier|*
name|p
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|list_empty
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|reap_list
argument_list|)
condition|)
block|{
name|p
operator|=
name|list_entry
argument_list|(
name|priv
operator|->
name|cm
operator|.
name|reap_list
operator|.
name|next
argument_list|,
name|typeof
argument_list|(
operator|*
name|p
argument_list|)
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|list_del
argument_list|(
operator|&
name|p
operator|->
name|list
argument_list|)
expr_stmt|;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|ipoib_cm_tx_destroy
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_cm_mb_reap
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|ipoib_dev_priv
argument_list|,
name|cm
operator|.
name|mb_task
argument_list|)
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mb
decl_stmt|;
name|unsigned
name|long
name|flags
decl_stmt|;
name|unsigned
name|mtu
init|=
name|priv
operator|->
name|mcast_mtu
decl_stmt|;
name|uint16_t
name|proto
decl_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|IF_DEQUEUE
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|mb_queue
argument_list|,
name|mb
argument_list|)
expr_stmt|;
if|if
condition|(
name|mb
operator|==
name|NULL
condition|)
break|break;
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|proto
operator|=
name|htons
argument_list|(
operator|*
name|mtod
argument_list|(
name|mb
argument_list|,
name|uint16_t
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|m_adj
argument_list|(
name|mb
argument_list|,
name|IPOIB_ENCAP_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|proto
operator|==
name|ETHERTYPE_IP
condition|)
name|icmp_error
argument_list|(
name|mb
argument_list|,
name|ICMP_UNREACH
argument_list|,
name|ICMP_UNREACH_NEEDFRAG
argument_list|,
literal|0
argument_list|,
name|mtu
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|INET6
argument_list|)
elseif|else
if|if
condition|(
name|proto
operator|==
name|ETHERTYPE_IPV6
condition|)
name|icmp6_error
argument_list|(
name|mb
argument_list|,
name|ICMP6_PACKET_TOO_BIG
argument_list|,
literal|0
argument_list|,
name|mtu
argument_list|)
expr_stmt|;
endif|#
directive|endif
else|else
name|m_freem
argument_list|(
name|mb
argument_list|)
expr_stmt|;
name|spin_lock_irqsave
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
name|spin_unlock_irqrestore
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ipoib_cm_mb_too_long
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|struct
name|mbuf
modifier|*
name|mb
parameter_list|,
name|unsigned
name|int
name|mtu
parameter_list|)
block|{
name|int
name|e
init|=
name|priv
operator|->
name|cm
operator|.
name|mb_queue
operator|.
name|ifq_len
decl_stmt|;
name|IF_ENQUEUE
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|mb_queue
argument_list|,
name|mb
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
literal|0
condition|)
name|queue_work
argument_list|(
name|ipoib_workqueue
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|mb_task
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_cm_rx_reap
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|ipoib_cm_free_rx_reap_list
argument_list|(
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|ipoib_dev_priv
argument_list|,
name|cm
operator|.
name|rx_reap_task
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_cm_stale_task
parameter_list|(
name|struct
name|work_struct
modifier|*
name|work
parameter_list|)
block|{
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
init|=
name|container_of
argument_list|(
name|work
argument_list|,
expr|struct
name|ipoib_dev_priv
argument_list|,
name|cm
operator|.
name|stale_task
operator|.
name|work
argument_list|)
decl_stmt|;
name|struct
name|ipoib_cm_rx
modifier|*
name|p
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|list_empty
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|passive_ids
argument_list|)
condition|)
block|{
comment|/* List is sorted by LRU, start from tail, 		 * stop when we see a recently used entry */
name|p
operator|=
name|list_entry
argument_list|(
name|priv
operator|->
name|cm
operator|.
name|passive_ids
operator|.
name|prev
argument_list|,
name|typeof
argument_list|(
operator|*
name|p
argument_list|)
argument_list|,
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|time_before_eq
argument_list|(
name|jiffies
argument_list|,
name|p
operator|->
name|jiffies
operator|+
name|IPOIB_CM_RX_TIMEOUT
argument_list|)
condition|)
break|break;
name|list_move
argument_list|(
operator|&
name|p
operator|->
name|list
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_error_list
argument_list|)
expr_stmt|;
name|p
operator|->
name|state
operator|=
name|IPOIB_CM_RX_ERROR
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_modify_qp
argument_list|(
name|p
operator|->
name|qp
argument_list|,
operator|&
name|ipoib_cm_err_attr
argument_list|,
name|IB_QP_STATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"unable to move qp to error state: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|spin_lock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|list_empty
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|passive_ids
argument_list|)
condition|)
name|queue_delayed_work
argument_list|(
name|ipoib_workqueue
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|stale_task
argument_list|,
name|IPOIB_CM_RX_DELAY
argument_list|)
expr_stmt|;
name|spin_unlock_irq
argument_list|(
operator|&
name|priv
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipoib_cm_create_srq
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|,
name|int
name|max_sge
parameter_list|)
block|{
name|struct
name|ib_srq_init_attr
name|srq_init_attr
init|=
block|{
operator|.
name|attr
operator|=
block|{
operator|.
name|max_wr
operator|=
name|ipoib_recvq_size
block|,
operator|.
name|max_sge
operator|=
name|max_sge
block|}
block|}
decl_stmt|;
name|priv
operator|->
name|cm
operator|.
name|srq
operator|=
name|ib_create_srq
argument_list|(
name|priv
operator|->
name|pd
argument_list|,
operator|&
name|srq_init_attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|priv
operator|->
name|cm
operator|.
name|srq
argument_list|)
condition|)
block|{
if|if
condition|(
name|PTR_ERR
argument_list|(
name|priv
operator|->
name|cm
operator|.
name|srq
argument_list|)
operator|!=
operator|-
name|ENOSYS
condition|)
name|printk
argument_list|(
name|KERN_WARNING
literal|"%s: failed to allocate SRQ, error %ld\n"
argument_list|,
name|priv
operator|->
name|ca
operator|->
name|name
argument_list|,
name|PTR_ERR
argument_list|(
name|priv
operator|->
name|cm
operator|.
name|srq
argument_list|)
argument_list|)
expr_stmt|;
name|priv
operator|->
name|cm
operator|.
name|srq
operator|=
name|NULL
expr_stmt|;
return|return;
block|}
name|priv
operator|->
name|cm
operator|.
name|srq_ring
operator|=
name|kzalloc
argument_list|(
name|ipoib_recvq_size
operator|*
sizeof|sizeof
expr|*
name|priv
operator|->
name|cm
operator|.
name|srq_ring
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|cm
operator|.
name|srq_ring
condition|)
block|{
name|printk
argument_list|(
name|KERN_WARNING
literal|"%s: failed to allocate CM SRQ ring (%d entries)\n"
argument_list|,
name|priv
operator|->
name|ca
operator|->
name|name
argument_list|,
name|ipoib_recvq_size
argument_list|)
expr_stmt|;
name|ib_destroy_srq
argument_list|(
name|priv
operator|->
name|cm
operator|.
name|srq
argument_list|)
expr_stmt|;
name|priv
operator|->
name|cm
operator|.
name|srq
operator|=
name|NULL
expr_stmt|;
return|return;
block|}
name|memset
argument_list|(
name|priv
operator|->
name|cm
operator|.
name|srq_ring
argument_list|,
literal|0
argument_list|,
name|ipoib_recvq_size
operator|*
sizeof|sizeof
expr|*
name|priv
operator|->
name|cm
operator|.
name|srq_ring
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ipoib_cm_dev_init
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|dev
init|=
name|priv
operator|->
name|dev
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|struct
name|ib_device_attr
name|attr
decl_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|passive_ids
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|reap_list
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|start_list
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_error_list
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_flush_list
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_drain_list
argument_list|)
expr_stmt|;
name|INIT_LIST_HEAD
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_reap_list
argument_list|)
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|start_task
argument_list|,
name|ipoib_cm_tx_start
argument_list|)
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|reap_task
argument_list|,
name|ipoib_cm_tx_reap
argument_list|)
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|mb_task
argument_list|,
name|ipoib_cm_mb_reap
argument_list|)
expr_stmt|;
name|INIT_WORK
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_reap_task
argument_list|,
name|ipoib_cm_rx_reap
argument_list|)
expr_stmt|;
name|INIT_DELAYED_WORK
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|stale_task
argument_list|,
name|ipoib_cm_stale_task
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|mb_queue
argument_list|,
sizeof|sizeof
argument_list|(
name|priv
operator|->
name|cm
operator|.
name|mb_queue
argument_list|)
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|mb_queue
operator|.
name|ifq_mtx
argument_list|,
name|dev
operator|->
name|if_xname
argument_list|,
literal|"if send queue"
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_query_device
argument_list|(
name|priv
operator|->
name|ca
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
name|KERN_WARNING
literal|"ib_query_device() failed with %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"max_srq_sge=%d\n"
argument_list|,
name|attr
operator|.
name|max_srq_sge
argument_list|)
expr_stmt|;
name|attr
operator|.
name|max_srq_sge
operator|=
name|min_t
argument_list|(
name|int
argument_list|,
name|IPOIB_CM_RX_SG
argument_list|,
name|attr
operator|.
name|max_srq_sge
argument_list|)
expr_stmt|;
name|ipoib_cm_create_srq
argument_list|(
name|priv
argument_list|,
name|attr
operator|.
name|max_srq_sge
argument_list|)
expr_stmt|;
if|if
condition|(
name|ipoib_cm_has_srq
argument_list|(
name|priv
argument_list|)
condition|)
block|{
name|priv
operator|->
name|cm
operator|.
name|max_cm_mtu
operator|=
name|attr
operator|.
name|max_srq_sge
operator|*
name|MJUMPAGESIZE
expr_stmt|;
name|priv
operator|->
name|cm
operator|.
name|num_frags
operator|=
name|attr
operator|.
name|max_srq_sge
expr_stmt|;
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"max_cm_mtu = 0x%x, num_frags=%d\n"
argument_list|,
name|priv
operator|->
name|cm
operator|.
name|max_cm_mtu
argument_list|,
name|priv
operator|->
name|cm
operator|.
name|num_frags
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|priv
operator|->
name|cm
operator|.
name|max_cm_mtu
operator|=
name|IPOIB_CM_MAX_MTU
expr_stmt|;
name|priv
operator|->
name|cm
operator|.
name|num_frags
operator|=
name|IPOIB_CM_RX_SG
expr_stmt|;
block|}
name|ipoib_cm_init_rx_wr
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|rx_wr
argument_list|,
name|priv
operator|->
name|cm
operator|.
name|rx_sge
argument_list|)
expr_stmt|;
if|if
condition|(
name|ipoib_cm_has_srq
argument_list|(
name|priv
argument_list|)
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ipoib_recvq_size
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
operator|!
name|ipoib_cm_alloc_rx_mb
argument_list|(
name|priv
argument_list|,
operator|&
name|priv
operator|->
name|cm
operator|.
name|srq_ring
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"failed to allocate "
literal|"receive buffer %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|ipoib_cm_dev_cleanup
argument_list|(
name|priv
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
if|if
condition|(
name|ipoib_cm_post_receive_srq
argument_list|(
name|priv
argument_list|,
name|i
argument_list|)
condition|)
block|{
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"ipoib_cm_post_receive_srq "
literal|"failed for buf %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|ipoib_cm_dev_cleanup
argument_list|(
name|priv
argument_list|)
expr_stmt|;
return|return
operator|-
name|EIO
return|;
block|}
block|}
block|}
name|IF_LLADDR
argument_list|(
name|priv
operator|->
name|dev
argument_list|)
index|[
literal|0
index|]
operator|=
name|IPOIB_FLAGS_RC
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|ipoib_cm_dev_cleanup
parameter_list|(
name|struct
name|ipoib_dev_priv
modifier|*
name|priv
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|cm
operator|.
name|srq
condition|)
return|return;
name|ipoib_dbg
argument_list|(
name|priv
argument_list|,
literal|"Cleanup ipoib connected mode.\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_destroy_srq
argument_list|(
name|priv
operator|->
name|cm
operator|.
name|srq
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|ipoib_warn
argument_list|(
name|priv
argument_list|,
literal|"ib_destroy_srq failed: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|priv
operator|->
name|cm
operator|.
name|srq
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|priv
operator|->
name|cm
operator|.
name|srq_ring
condition|)
return|return;
name|ipoib_cm_free_rx_ring
argument_list|(
name|priv
argument_list|,
name|priv
operator|->
name|cm
operator|.
name|srq_ring
argument_list|)
expr_stmt|;
name|priv
operator|->
name|cm
operator|.
name|srq_ring
operator|=
name|NULL
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|priv
operator|->
name|cm
operator|.
name|mb_queue
operator|.
name|ifq_mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_INFINIBAND_IPOIB_CM */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * pccard noise interface.  * Nate Williams, October 1997.  * This file is in the public domain.  */
end_comment

begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<machine/clock.h>
end_include

begin_include
include|#
directive|include
file|<pccard/driver.h>
end_include

begin_decl_stmt
specifier|static
name|enum
name|beepstate
name|allow_beep
init|=
name|BEEP_OFF
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|melody_type
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|MAX_TONE_MODE
value|3
end_define

begin_define
define|#
directive|define
name|MAX_STATE
value|4
end_define

begin_struct
struct|struct
name|tone
block|{
name|int
name|pitch
decl_stmt|;
name|int
name|duration
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|tone
name|silent_beep
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|tone
name|success_beep
index|[]
init|=
block|{
block|{
literal|1200
block|,
literal|40
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|tone
name|failure_beep
index|[]
init|=
block|{
block|{
literal|3200
block|,
literal|40
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|tone
name|insert_remove_beep
index|[]
init|=
block|{
block|{
literal|1600
block|,
literal|20
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|tone
name|success_melody_beep
index|[]
init|=
block|{
block|{
literal|1200
block|,
literal|7
block|}
block|,
block|{
literal|1000
block|,
literal|7
block|}
block|,
block|{
literal|800
block|,
literal|15
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|tone
name|failure_melody_beep
index|[]
init|=
block|{
block|{
literal|2000
block|,
literal|7
block|}
block|,
block|{
literal|2400
block|,
literal|7
block|}
block|,
block|{
literal|2800
block|,
literal|15
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|tone
name|insert_melody_beep
index|[]
init|=
block|{
block|{
literal|1600
block|,
literal|10
block|}
block|,
block|{
literal|1200
block|,
literal|5
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|tone
name|remove_melody_beep
index|[]
init|=
block|{
block|{
literal|1200
block|,
literal|10
block|}
block|,
block|{
literal|1600
block|,
literal|5
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|tone
modifier|*
name|melody_table
index|[
name|MAX_TONE_MODE
index|]
index|[
name|MAX_STATE
index|]
init|=
block|{
block|{
comment|/* silent mode */
name|silent_beep
block|,
name|silent_beep
block|,
name|silent_beep
block|,
name|silent_beep
block|, 	}
block|,
block|{
comment|/* simple beep mode */
name|success_beep
block|,
name|failure_beep
block|,
name|insert_remove_beep
block|,
name|insert_remove_beep
block|, 	}
block|,
block|{
comment|/* melody beep mode */
name|success_melody_beep
block|,
name|failure_melody_beep
block|,
name|insert_melody_beep
block|,
name|remove_melody_beep
block|, 	}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|pccard_beep_sub
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|tone
modifier|*
name|melody
decl_stmt|;
name|melody
operator|=
operator|(
expr|struct
name|tone
operator|*
operator|)
name|arg
expr_stmt|;
if|if
condition|(
name|melody
operator|->
name|pitch
operator|!=
literal|0
condition|)
block|{
name|sysbeep
argument_list|(
name|melody
operator|->
name|pitch
argument_list|,
name|melody
operator|->
name|duration
argument_list|)
expr_stmt|;
name|timeout
argument_list|(
name|pccard_beep_sub
argument_list|,
name|melody
operator|+
literal|1
argument_list|,
name|melody
operator|->
name|duration
argument_list|)
expr_stmt|;
block|}
else|else
name|allow_beep
operator|=
name|BEEP_ON
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|pccard_beep_start
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|tone
modifier|*
name|melody
decl_stmt|;
name|melody
operator|=
operator|(
expr|struct
name|tone
operator|*
operator|)
name|arg
expr_stmt|;
if|if
condition|(
name|allow_beep
operator|==
name|BEEP_ON
operator|&&
name|melody
operator|->
name|pitch
operator|!=
literal|0
condition|)
block|{
name|allow_beep
operator|=
name|BEEP_OFF
expr_stmt|;
name|sysbeep
argument_list|(
name|melody
operator|->
name|pitch
argument_list|,
name|melody
operator|->
name|duration
argument_list|)
expr_stmt|;
name|timeout
argument_list|(
name|pccard_beep_sub
argument_list|,
name|melody
operator|+
literal|1
argument_list|,
name|melody
operator|->
name|duration
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|pccard_success_beep
parameter_list|(
name|void
parameter_list|)
block|{
name|pccard_beep_start
argument_list|(
name|melody_table
index|[
name|melody_type
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|pccard_failure_beep
parameter_list|(
name|void
parameter_list|)
block|{
name|pccard_beep_start
argument_list|(
name|melody_table
index|[
name|melody_type
index|]
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|pccard_insert_beep
parameter_list|(
name|void
parameter_list|)
block|{
name|pccard_beep_start
argument_list|(
name|melody_table
index|[
name|melody_type
index|]
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|pccard_remove_beep
parameter_list|(
name|void
parameter_list|)
block|{
name|pccard_beep_start
argument_list|(
name|melody_table
index|[
name|melody_type
index|]
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|pccard_beep_select
parameter_list|(
name|int
name|type
parameter_list|)
block|{
name|int
name|errcode
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|type
operator|==
literal|0
condition|)
block|{
name|allow_beep
operator|=
name|BEEP_OFF
expr_stmt|;
name|melody_type
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|type
operator|<
literal|0
operator|||
name|MAX_TONE_MODE
operator|-
literal|1
operator|<
name|type
condition|)
block|{
name|errcode
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|allow_beep
operator|=
name|BEEP_ON
expr_stmt|;
name|melody_type
operator|=
name|type
expr_stmt|;
block|}
return|return
operator|(
name|errcode
operator|)
return|;
block|}
end_function

end_unit


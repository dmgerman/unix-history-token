begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2000 Matthew Jacob  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions, and the following disclaimer,  *    without modification, immediately at the beginning of the file.  * 2. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR  * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/sx.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_ccb.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_periph.h>
end_include

begin_include
include|#
directive|include
file|<cam/scsi/scsi_enc.h>
end_include

begin_include
include|#
directive|include
file|<cam/scsi/scsi_enc_internal.h>
end_include

begin_include
include|#
directive|include
file|<cam/scsi/scsi_message.h>
end_include

begin_comment
comment|/*  * SAF-TE Type Device Emulation  */
end_comment

begin_function_decl
specifier|static
name|int
name|safte_set_enc_status
parameter_list|(
name|enc_softc_t
modifier|*
name|enc
parameter_list|,
name|uint8_t
name|encstat
parameter_list|,
name|int
name|slpflag
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|ALL_ENC_STAT
value|(SES_ENCSTAT_CRITICAL | SES_ENCSTAT_UNRECOV | \ 	SES_ENCSTAT_NONCRITICAL | SES_ENCSTAT_INFO)
end_define

begin_comment
comment|/*  * SAF-TE specific defines- Mandatory ones only...  */
end_comment

begin_comment
comment|/*  * READ BUFFER ('get' commands) IDs- placed in offset 2 of cdb  */
end_comment

begin_define
define|#
directive|define
name|SAFTE_RD_RDCFG
value|0x00
end_define

begin_comment
comment|/* read enclosure configuration */
end_comment

begin_define
define|#
directive|define
name|SAFTE_RD_RDESTS
value|0x01
end_define

begin_comment
comment|/* read enclosure status */
end_comment

begin_define
define|#
directive|define
name|SAFTE_RD_RDDSTS
value|0x04
end_define

begin_comment
comment|/* read drive slot status */
end_comment

begin_define
define|#
directive|define
name|SAFTE_RD_RDGFLG
value|0x05
end_define

begin_comment
comment|/* read global flags */
end_comment

begin_comment
comment|/*  * WRITE BUFFER ('set' commands) IDs- placed in offset 0 of databuf  */
end_comment

begin_define
define|#
directive|define
name|SAFTE_WT_DSTAT
value|0x10
end_define

begin_comment
comment|/* write device slot status */
end_comment

begin_define
define|#
directive|define
name|SAFTE_WT_SLTOP
value|0x12
end_define

begin_comment
comment|/* perform slot operation */
end_comment

begin_define
define|#
directive|define
name|SAFTE_WT_FANSPD
value|0x13
end_define

begin_comment
comment|/* set fan speed */
end_comment

begin_define
define|#
directive|define
name|SAFTE_WT_ACTPWS
value|0x14
end_define

begin_comment
comment|/* turn on/off power supply */
end_comment

begin_define
define|#
directive|define
name|SAFTE_WT_GLOBAL
value|0x15
end_define

begin_comment
comment|/* send global command */
end_comment

begin_define
define|#
directive|define
name|SAFT_SCRATCH
value|64
end_define

begin_define
define|#
directive|define
name|SCSZ
value|0x8000
end_define

begin_typedef
typedef|typedef
enum|enum
block|{
name|SAFTE_UPDATE_NONE
block|,
name|SAFTE_UPDATE_READCONFIG
block|,
name|SAFTE_UPDATE_READGFLAGS
block|,
name|SAFTE_UPDATE_READENCSTATUS
block|,
name|SAFTE_UPDATE_READSLOTSTATUS
block|,
name|SAFTE_PROCESS_CONTROL_REQS
block|,
name|SAFTE_NUM_UPDATE_STATES
block|}
name|safte_update_action
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|fsm_fill_handler_t
name|safte_fill_read_buf_io
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|fsm_fill_handler_t
name|safte_fill_control_request
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|fsm_done_handler_t
name|safte_process_config
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|fsm_done_handler_t
name|safte_process_gflags
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|fsm_done_handler_t
name|safte_process_status
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|fsm_done_handler_t
name|safte_process_slotstatus
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|fsm_done_handler_t
name|safte_process_control_request
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|enc_fsm_state
name|enc_fsm_states
index|[
name|SAFTE_NUM_UPDATE_STATES
index|]
init|=
block|{
block|{
literal|"SAFTE_UPDATE_NONE"
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
block|,
block|{
literal|"SAFTE_UPDATE_READCONFIG"
block|,
name|SAFTE_RD_RDCFG
block|,
name|SAFT_SCRATCH
block|,
literal|60
operator|*
literal|1000
block|,
name|safte_fill_read_buf_io
block|,
name|safte_process_config
block|,
name|enc_error
block|}
block|,
block|{
literal|"SAFTE_UPDATE_READGFLAGS"
block|,
name|SAFTE_RD_RDGFLG
block|,
literal|16
block|,
literal|60
operator|*
literal|1000
block|,
name|safte_fill_read_buf_io
block|,
name|safte_process_gflags
block|,
name|enc_error
block|}
block|,
block|{
literal|"SAFTE_UPDATE_READENCSTATUS"
block|,
name|SAFTE_RD_RDESTS
block|,
name|SCSZ
block|,
literal|60
operator|*
literal|1000
block|,
name|safte_fill_read_buf_io
block|,
name|safte_process_status
block|,
name|enc_error
block|}
block|,
block|{
literal|"SAFTE_UPDATE_READSLOTSTATUS"
block|,
name|SAFTE_RD_RDDSTS
block|,
name|SCSZ
block|,
literal|60
operator|*
literal|1000
block|,
name|safte_fill_read_buf_io
block|,
name|safte_process_slotstatus
block|,
name|enc_error
block|}
block|,
block|{
literal|"SAFTE_PROCESS_CONTROL_REQS"
block|,
literal|0
block|,
name|SCSZ
block|,
literal|60
operator|*
literal|1000
block|,
name|safte_fill_control_request
block|,
name|safte_process_control_request
block|,
name|enc_error
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_typedef
typedef|typedef
struct|struct
name|safte_control_request
block|{
name|int
name|elm_idx
decl_stmt|;
name|uint8_t
name|elm_stat
index|[
literal|4
index|]
decl_stmt|;
name|int
name|result
decl_stmt|;
name|TAILQ_ENTRY
argument_list|(
argument|safte_control_request
argument_list|)
name|links
expr_stmt|;
block|}
name|safte_control_request_t
typedef|;
end_typedef

begin_expr_stmt
name|TAILQ_HEAD
argument_list|(
name|safte_control_reqlist
argument_list|,
name|safte_control_request
argument_list|)
expr_stmt|;
end_expr_stmt

begin_typedef
typedef|typedef
name|struct
name|safte_control_reqlist
name|safte_control_reqlist_t
typedef|;
end_typedef

begin_enum
enum|enum
block|{
name|SES_SETSTATUS_ENC_IDX
init|=
operator|-
literal|1
block|}
enum|;
end_enum

begin_function
specifier|static
name|void
name|safte_terminate_control_requests
parameter_list|(
name|safte_control_reqlist_t
modifier|*
name|reqlist
parameter_list|,
name|int
name|result
parameter_list|)
block|{
name|safte_control_request_t
modifier|*
name|req
decl_stmt|;
while|while
condition|(
operator|(
name|req
operator|=
name|TAILQ_FIRST
argument_list|(
name|reqlist
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
name|reqlist
argument_list|,
name|req
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|req
operator|->
name|result
operator|=
name|result
expr_stmt|;
name|wakeup
argument_list|(
name|req
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_struct
struct|struct
name|scfg
block|{
comment|/* 	 * Cached Configuration 	 */
name|uint8_t
name|Nfans
decl_stmt|;
comment|/* Number of Fans */
name|uint8_t
name|Npwr
decl_stmt|;
comment|/* Number of Power Supplies */
name|uint8_t
name|Nslots
decl_stmt|;
comment|/* Number of Device Slots */
name|uint8_t
name|DoorLock
decl_stmt|;
comment|/* Door Lock Installed */
name|uint8_t
name|Ntherm
decl_stmt|;
comment|/* Number of Temperature Sensors */
name|uint8_t
name|Nspkrs
decl_stmt|;
comment|/* Number of Speakers */
name|uint8_t
name|Ntstats
decl_stmt|;
comment|/* Number of Thermostats */
comment|/* 	 * Cached Flag Bytes for Global Status 	 */
name|uint8_t
name|flag1
decl_stmt|;
name|uint8_t
name|flag2
decl_stmt|;
comment|/* 	 * What object index ID is where various slots start. 	 */
name|uint8_t
name|pwroff
decl_stmt|;
name|uint8_t
name|slotoff
decl_stmt|;
define|#
directive|define
name|SAFT_ALARM_OFFSET
parameter_list|(
name|cc
parameter_list|)
value|(cc)->slotoff - 1
name|encioc_enc_status_t
name|adm_status
decl_stmt|;
name|encioc_enc_status_t
name|enc_status
decl_stmt|;
name|encioc_enc_status_t
name|slot_status
decl_stmt|;
name|safte_control_reqlist_t
name|requests
decl_stmt|;
name|safte_control_request_t
modifier|*
name|current_request
decl_stmt|;
name|int
name|current_request_stage
decl_stmt|;
name|int
name|current_request_stages
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|SAFT_FLG1_ALARM
value|0x1
end_define

begin_define
define|#
directive|define
name|SAFT_FLG1_GLOBFAIL
value|0x2
end_define

begin_define
define|#
directive|define
name|SAFT_FLG1_GLOBWARN
value|0x4
end_define

begin_define
define|#
directive|define
name|SAFT_FLG1_ENCPWROFF
value|0x8
end_define

begin_define
define|#
directive|define
name|SAFT_FLG1_ENCFANFAIL
value|0x10
end_define

begin_define
define|#
directive|define
name|SAFT_FLG1_ENCPWRFAIL
value|0x20
end_define

begin_define
define|#
directive|define
name|SAFT_FLG1_ENCDRVFAIL
value|0x40
end_define

begin_define
define|#
directive|define
name|SAFT_FLG1_ENCDRVWARN
value|0x80
end_define

begin_define
define|#
directive|define
name|SAFT_FLG2_LOCKDOOR
value|0x4
end_define

begin_define
define|#
directive|define
name|SAFT_PRIVATE
value|sizeof (struct scfg)
end_define

begin_decl_stmt
specifier|static
name|char
modifier|*
name|safte_2little
init|=
literal|"Too Little Data Returned (%d) at line %d\n"
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|SAFT_BAIL
parameter_list|(
name|r
parameter_list|,
name|x
parameter_list|)
define|\
value|if ((r)>= (x)) { \ 		ENC_VLOG(enc, safte_2little, x, __LINE__);\ 		return (EIO); \ 	}
end_define

begin_decl_stmt
name|int
name|emulate_array_devices
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_DECL
argument_list|(
name|_kern_cam_enc
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_kern_cam_enc
argument_list|,
name|OID_AUTO
argument_list|,
name|emulate_array_devices
argument_list|,
name|CTLFLAG_RWTUN
argument_list|,
operator|&
name|emulate_array_devices
argument_list|,
literal|0
argument_list|,
literal|"Emulate Array Devices for SAF-TE"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|safte_fill_read_buf_io
parameter_list|(
name|enc_softc_t
modifier|*
name|enc
parameter_list|,
name|struct
name|enc_fsm_state
modifier|*
name|state
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|)
block|{
if|if
condition|(
name|state
operator|->
name|page_code
operator|!=
name|SAFTE_RD_RDCFG
operator|&&
name|enc
operator|->
name|enc_cache
operator|.
name|nelms
operator|==
literal|0
condition|)
block|{
name|enc_update_request
argument_list|(
name|enc
argument_list|,
name|SAFTE_UPDATE_READCONFIG
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|enc
operator|->
name|enc_type
operator|==
name|ENC_SEMB_SAFT
condition|)
block|{
name|semb_read_buffer
argument_list|(
operator|&
name|ccb
operator|->
name|ataio
argument_list|,
comment|/*retries*/
literal|5
argument_list|,
name|NULL
argument_list|,
name|MSG_SIMPLE_Q_TAG
argument_list|,
name|state
operator|->
name|page_code
argument_list|,
name|buf
argument_list|,
name|state
operator|->
name|buf_size
argument_list|,
name|state
operator|->
name|timeout
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|scsi_read_buffer
argument_list|(
operator|&
name|ccb
operator|->
name|csio
argument_list|,
comment|/*retries*/
literal|5
argument_list|,
name|NULL
argument_list|,
name|MSG_SIMPLE_Q_TAG
argument_list|,
literal|1
argument_list|,
name|state
operator|->
name|page_code
argument_list|,
literal|0
argument_list|,
name|buf
argument_list|,
name|state
operator|->
name|buf_size
argument_list|,
name|SSD_FULL_SIZE
argument_list|,
name|state
operator|->
name|timeout
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|safte_process_config
parameter_list|(
name|enc_softc_t
modifier|*
name|enc
parameter_list|,
name|struct
name|enc_fsm_state
modifier|*
name|state
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|,
name|uint8_t
modifier|*
modifier|*
name|bufp
parameter_list|,
name|int
name|error
parameter_list|,
name|int
name|xfer_len
parameter_list|)
block|{
name|struct
name|scfg
modifier|*
name|cfg
decl_stmt|;
name|uint8_t
modifier|*
name|buf
init|=
operator|*
name|bufp
decl_stmt|;
name|int
name|i
decl_stmt|,
name|r
decl_stmt|;
name|cfg
operator|=
name|enc
operator|->
name|enc_private
expr_stmt|;
if|if
condition|(
name|cfg
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|xfer_len
operator|<
literal|6
condition|)
block|{
name|ENC_VLOG
argument_list|(
name|enc
argument_list|,
literal|"too little data (%d) for configuration\n"
argument_list|,
name|xfer_len
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|cfg
operator|->
name|Nfans
operator|=
name|buf
index|[
literal|0
index|]
expr_stmt|;
name|cfg
operator|->
name|Npwr
operator|=
name|buf
index|[
literal|1
index|]
expr_stmt|;
name|cfg
operator|->
name|Nslots
operator|=
name|buf
index|[
literal|2
index|]
expr_stmt|;
name|cfg
operator|->
name|DoorLock
operator|=
name|buf
index|[
literal|3
index|]
expr_stmt|;
name|cfg
operator|->
name|Ntherm
operator|=
name|buf
index|[
literal|4
index|]
expr_stmt|;
name|cfg
operator|->
name|Nspkrs
operator|=
name|buf
index|[
literal|5
index|]
expr_stmt|;
if|if
condition|(
name|xfer_len
operator|>=
literal|7
condition|)
name|cfg
operator|->
name|Ntstats
operator|=
name|buf
index|[
literal|6
index|]
operator|&
literal|0x0f
expr_stmt|;
else|else
name|cfg
operator|->
name|Ntstats
operator|=
literal|0
expr_stmt|;
name|ENC_VLOG
argument_list|(
name|enc
argument_list|,
literal|"Nfans %d Npwr %d Nslots %d Lck %d Ntherm %d Nspkrs %d "
literal|"Ntstats %d\n"
argument_list|,
name|cfg
operator|->
name|Nfans
argument_list|,
name|cfg
operator|->
name|Npwr
argument_list|,
name|cfg
operator|->
name|Nslots
argument_list|,
name|cfg
operator|->
name|DoorLock
argument_list|,
name|cfg
operator|->
name|Ntherm
argument_list|,
name|cfg
operator|->
name|Nspkrs
argument_list|,
name|cfg
operator|->
name|Ntstats
argument_list|)
expr_stmt|;
name|enc
operator|->
name|enc_cache
operator|.
name|nelms
operator|=
name|cfg
operator|->
name|Nfans
operator|+
name|cfg
operator|->
name|Npwr
operator|+
name|cfg
operator|->
name|Nslots
operator|+
name|cfg
operator|->
name|DoorLock
operator|+
name|cfg
operator|->
name|Ntherm
operator|+
name|cfg
operator|->
name|Nspkrs
operator|+
name|cfg
operator|->
name|Ntstats
operator|+
literal|1
expr_stmt|;
name|ENC_FREE_AND_NULL
argument_list|(
name|enc
operator|->
name|enc_cache
operator|.
name|elm_map
argument_list|)
expr_stmt|;
name|enc
operator|->
name|enc_cache
operator|.
name|elm_map
operator|=
name|ENC_MALLOCZ
argument_list|(
name|enc
operator|->
name|enc_cache
operator|.
name|nelms
operator|*
sizeof|sizeof
argument_list|(
name|enc_element_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|enc
operator|->
name|enc_cache
operator|.
name|elm_map
operator|==
name|NULL
condition|)
block|{
name|enc
operator|->
name|enc_cache
operator|.
name|nelms
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|r
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Note that this is all arranged for the convenience 	 * in later fetches of status. 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cfg
operator|->
name|Nfans
condition|;
name|i
operator|++
control|)
name|enc
operator|->
name|enc_cache
operator|.
name|elm_map
index|[
name|r
operator|++
index|]
operator|.
name|enctype
operator|=
name|ELMTYP_FAN
expr_stmt|;
name|cfg
operator|->
name|pwroff
operator|=
operator|(
name|uint8_t
operator|)
name|r
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cfg
operator|->
name|Npwr
condition|;
name|i
operator|++
control|)
name|enc
operator|->
name|enc_cache
operator|.
name|elm_map
index|[
name|r
operator|++
index|]
operator|.
name|enctype
operator|=
name|ELMTYP_POWER
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cfg
operator|->
name|DoorLock
condition|;
name|i
operator|++
control|)
name|enc
operator|->
name|enc_cache
operator|.
name|elm_map
index|[
name|r
operator|++
index|]
operator|.
name|enctype
operator|=
name|ELMTYP_DOORLOCK
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|Nspkrs
operator|>
literal|0
condition|)
name|enc
operator|->
name|enc_cache
operator|.
name|elm_map
index|[
name|r
operator|++
index|]
operator|.
name|enctype
operator|=
name|ELMTYP_ALARM
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cfg
operator|->
name|Ntherm
condition|;
name|i
operator|++
control|)
name|enc
operator|->
name|enc_cache
operator|.
name|elm_map
index|[
name|r
operator|++
index|]
operator|.
name|enctype
operator|=
name|ELMTYP_THERM
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|cfg
operator|->
name|Ntstats
condition|;
name|i
operator|++
control|)
name|enc
operator|->
name|enc_cache
operator|.
name|elm_map
index|[
name|r
operator|++
index|]
operator|.
name|enctype
operator|=
name|ELMTYP_THERM
expr_stmt|;
name|cfg
operator|->
name|slotoff
operator|=
operator|(
name|uint8_t
operator|)
name|r
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cfg
operator|->
name|Nslots
condition|;
name|i
operator|++
control|)
name|enc
operator|->
name|enc_cache
operator|.
name|elm_map
index|[
name|r
operator|++
index|]
operator|.
name|enctype
operator|=
name|emulate_array_devices
condition|?
name|ELMTYP_ARRAY_DEV
else|:
name|ELMTYP_DEVICE
expr_stmt|;
name|enc_update_request
argument_list|(
name|enc
argument_list|,
name|SAFTE_UPDATE_READGFLAGS
argument_list|)
expr_stmt|;
name|enc_update_request
argument_list|(
name|enc
argument_list|,
name|SAFTE_UPDATE_READENCSTATUS
argument_list|)
expr_stmt|;
name|enc_update_request
argument_list|(
name|enc
argument_list|,
name|SAFTE_UPDATE_READSLOTSTATUS
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|safte_process_gflags
parameter_list|(
name|enc_softc_t
modifier|*
name|enc
parameter_list|,
name|struct
name|enc_fsm_state
modifier|*
name|state
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|,
name|uint8_t
modifier|*
modifier|*
name|bufp
parameter_list|,
name|int
name|error
parameter_list|,
name|int
name|xfer_len
parameter_list|)
block|{
name|struct
name|scfg
modifier|*
name|cfg
decl_stmt|;
name|uint8_t
modifier|*
name|buf
init|=
operator|*
name|bufp
decl_stmt|;
name|cfg
operator|=
name|enc
operator|->
name|enc_private
expr_stmt|;
if|if
condition|(
name|cfg
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|SAFT_BAIL
argument_list|(
literal|3
argument_list|,
name|xfer_len
argument_list|)
expr_stmt|;
name|cfg
operator|->
name|flag1
operator|=
name|buf
index|[
literal|1
index|]
expr_stmt|;
name|cfg
operator|->
name|flag2
operator|=
name|buf
index|[
literal|2
index|]
expr_stmt|;
name|cfg
operator|->
name|adm_status
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|flag1
operator|&
name|SAFT_FLG1_GLOBFAIL
condition|)
name|cfg
operator|->
name|adm_status
operator||=
name|SES_ENCSTAT_CRITICAL
expr_stmt|;
elseif|else
if|if
condition|(
name|cfg
operator|->
name|flag1
operator|&
name|SAFT_FLG1_GLOBWARN
condition|)
name|cfg
operator|->
name|adm_status
operator||=
name|SES_ENCSTAT_NONCRITICAL
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|safte_process_status
parameter_list|(
name|enc_softc_t
modifier|*
name|enc
parameter_list|,
name|struct
name|enc_fsm_state
modifier|*
name|state
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|,
name|uint8_t
modifier|*
modifier|*
name|bufp
parameter_list|,
name|int
name|error
parameter_list|,
name|int
name|xfer_len
parameter_list|)
block|{
name|struct
name|scfg
modifier|*
name|cfg
decl_stmt|;
name|uint8_t
modifier|*
name|buf
init|=
operator|*
name|bufp
decl_stmt|;
name|int
name|oid
decl_stmt|,
name|r
decl_stmt|,
name|i
decl_stmt|,
name|nitems
decl_stmt|;
name|uint16_t
name|tempflags
decl_stmt|;
name|enc_cache_t
modifier|*
name|cache
init|=
operator|&
name|enc
operator|->
name|enc_cache
decl_stmt|;
name|cfg
operator|=
name|enc
operator|->
name|enc_private
expr_stmt|;
if|if
condition|(
name|cfg
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|oid
operator|=
name|r
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|enc_status
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|nitems
operator|=
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cfg
operator|->
name|Nfans
condition|;
name|i
operator|++
control|)
block|{
name|SAFT_BAIL
argument_list|(
name|r
argument_list|,
name|xfer_len
argument_list|)
expr_stmt|;
comment|/* 		 * 0 = Fan Operational 		 * 1 = Fan is malfunctioning 		 * 2 = Fan is not present 		 * 0x80 = Unknown or Not Reportable Status 		 */
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
comment|/* resvd */
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* resvd */
if|if
condition|(
name|cfg
operator|->
name|flag1
operator|&
name|SAFT_FLG1_ENCFANFAIL
condition|)
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|3
index|]
operator||=
literal|0x40
expr_stmt|;
else|else
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|3
index|]
operator|&=
operator|~
literal|0x40
expr_stmt|;
switch|switch
condition|(
operator|(
name|int
operator|)
name|buf
index|[
name|r
index|]
condition|)
block|{
case|case
literal|0
case|:
name|nitems
operator|++
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator|=
name|SES_OBJSTAT_OK
expr_stmt|;
if|if
condition|(
operator|(
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|3
index|]
operator|&
literal|0x37
operator|)
operator|==
literal|0
condition|)
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|3
index|]
operator||=
literal|0x27
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator|=
name|SES_OBJSTAT_CRIT
expr_stmt|;
comment|/* 			 * FAIL and FAN STOPPED synthesized 			 */
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|3
index|]
operator||=
literal|0x10
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|3
index|]
operator|&=
operator|~
literal|0x07
expr_stmt|;
comment|/* 			 * Enclosure marked with CRITICAL error 			 * if only one fan or no thermometers, 			 * else the NONCRITICAL error is set. 			 */
if|if
condition|(
name|cfg
operator|->
name|Nfans
operator|==
literal|1
operator|||
operator|(
name|cfg
operator|->
name|Ntherm
operator|+
name|cfg
operator|->
name|Ntstats
operator|)
operator|==
literal|0
condition|)
name|cfg
operator|->
name|enc_status
operator||=
name|SES_ENCSTAT_CRITICAL
expr_stmt|;
else|else
name|cfg
operator|->
name|enc_status
operator||=
name|SES_ENCSTAT_NONCRITICAL
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator|=
name|SES_OBJSTAT_NOTINSTALLED
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|3
index|]
operator||=
literal|0x10
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|3
index|]
operator|&=
operator|~
literal|0x07
expr_stmt|;
comment|/* 			 * Enclosure marked with CRITICAL error 			 * if only one fan or no thermometers, 			 * else the NONCRITICAL error is set. 			 */
if|if
condition|(
name|cfg
operator|->
name|Nfans
operator|==
literal|1
condition|)
name|cfg
operator|->
name|enc_status
operator||=
name|SES_ENCSTAT_CRITICAL
expr_stmt|;
else|else
name|cfg
operator|->
name|enc_status
operator||=
name|SES_ENCSTAT_NONCRITICAL
expr_stmt|;
break|break;
case|case
literal|0x80
case|:
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator|=
name|SES_OBJSTAT_UNKNOWN
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|enc_status
operator||=
name|SES_ENCSTAT_INFO
expr_stmt|;
break|break;
default|default:
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator|=
name|SES_OBJSTAT_UNSUPPORTED
expr_stmt|;
name|ENC_VLOG
argument_list|(
name|enc
argument_list|,
literal|"Unknown fan%d status 0x%x\n"
argument_list|,
name|i
argument_list|,
name|buf
index|[
name|r
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
break|break;
block|}
name|cache
operator|->
name|elm_map
index|[
name|oid
operator|++
index|]
operator|.
name|svalid
operator|=
literal|1
expr_stmt|;
name|r
operator|++
expr_stmt|;
block|}
comment|/* 	 * No matter how you cut it, no cooling elements when there 	 * should be some there is critical. 	 */
if|if
condition|(
name|cfg
operator|->
name|Nfans
operator|&&
name|nitems
operator|==
literal|0
condition|)
name|cfg
operator|->
name|enc_status
operator||=
name|SES_ENCSTAT_CRITICAL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cfg
operator|->
name|Npwr
condition|;
name|i
operator|++
control|)
block|{
name|SAFT_BAIL
argument_list|(
name|r
argument_list|,
name|xfer_len
argument_list|)
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator|=
name|SES_OBJSTAT_UNKNOWN
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
comment|/* resvd */
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
comment|/* resvd */
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|3
index|]
operator|=
literal|0x20
expr_stmt|;
comment|/* requested on */
switch|switch
condition|(
name|buf
index|[
name|r
index|]
condition|)
block|{
case|case
literal|0x00
case|:
comment|/* pws operational and on */
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator|=
name|SES_OBJSTAT_OK
expr_stmt|;
break|break;
case|case
literal|0x01
case|:
comment|/* pws operational and off */
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator|=
name|SES_OBJSTAT_OK
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|3
index|]
operator|=
literal|0x10
expr_stmt|;
name|cfg
operator|->
name|enc_status
operator||=
name|SES_ENCSTAT_INFO
expr_stmt|;
break|break;
case|case
literal|0x10
case|:
comment|/* pws is malfunctioning and commanded on */
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator|=
name|SES_OBJSTAT_CRIT
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|3
index|]
operator|=
literal|0x61
expr_stmt|;
name|cfg
operator|->
name|enc_status
operator||=
name|SES_ENCSTAT_NONCRITICAL
expr_stmt|;
break|break;
case|case
literal|0x11
case|:
comment|/* pws is malfunctioning and commanded off */
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator|=
name|SES_OBJSTAT_NONCRIT
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|3
index|]
operator|=
literal|0x51
expr_stmt|;
name|cfg
operator|->
name|enc_status
operator||=
name|SES_ENCSTAT_NONCRITICAL
expr_stmt|;
break|break;
case|case
literal|0x20
case|:
comment|/* pws is not present */
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator|=
name|SES_OBJSTAT_NOTINSTALLED
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|enc_status
operator||=
name|SES_ENCSTAT_INFO
expr_stmt|;
break|break;
case|case
literal|0x21
case|:
comment|/* pws is present */
comment|/* 			 * This is for enclosures that cannot tell whether the 			 * device is on or malfunctioning, but know that it is 			 * present. Just fall through. 			 */
comment|/* FALLTHROUGH */
case|case
literal|0x80
case|:
comment|/* Unknown or Not Reportable Status */
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator|=
name|SES_OBJSTAT_UNKNOWN
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|enc_status
operator||=
name|SES_ENCSTAT_INFO
expr_stmt|;
break|break;
default|default:
name|ENC_VLOG
argument_list|(
name|enc
argument_list|,
literal|"unknown power supply %d status (0x%x)\n"
argument_list|,
name|i
argument_list|,
name|buf
index|[
name|r
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
break|break;
block|}
name|enc
operator|->
name|enc_cache
operator|.
name|elm_map
index|[
name|oid
operator|++
index|]
operator|.
name|svalid
operator|=
literal|1
expr_stmt|;
name|r
operator|++
expr_stmt|;
block|}
comment|/* 	 * Copy Slot SCSI IDs 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cfg
operator|->
name|Nslots
condition|;
name|i
operator|++
control|)
block|{
name|SAFT_BAIL
argument_list|(
name|r
argument_list|,
name|xfer_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|cache
operator|->
name|elm_map
index|[
name|cfg
operator|->
name|slotoff
operator|+
name|i
index|]
operator|.
name|enctype
operator|==
name|ELMTYP_DEVICE
condition|)
name|cache
operator|->
name|elm_map
index|[
name|cfg
operator|->
name|slotoff
operator|+
name|i
index|]
operator|.
name|encstat
index|[
literal|1
index|]
operator|=
name|buf
index|[
name|r
index|]
expr_stmt|;
name|r
operator|++
expr_stmt|;
block|}
comment|/* 	 * We always have doorlock status, no matter what, 	 * but we only save the status if we have one. 	 */
name|SAFT_BAIL
argument_list|(
name|r
argument_list|,
name|xfer_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|DoorLock
condition|)
block|{
comment|/* 		 * 0 = Door Locked 		 * 1 = Door Unlocked, or no Lock Installed 		 * 0x80 = Unknown or Not Reportable Status 		 */
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|buf
index|[
name|r
index|]
condition|)
block|{
case|case
literal|0
case|:
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator|=
name|SES_OBJSTAT_OK
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator|=
name|SES_OBJSTAT_OK
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|3
index|]
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|0x80
case|:
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator|=
name|SES_OBJSTAT_UNKNOWN
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|enc_status
operator||=
name|SES_ENCSTAT_INFO
expr_stmt|;
break|break;
default|default:
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator|=
name|SES_OBJSTAT_UNSUPPORTED
expr_stmt|;
name|ENC_VLOG
argument_list|(
name|enc
argument_list|,
literal|"unknown lock status 0x%x\n"
argument_list|,
name|buf
index|[
name|r
index|]
operator|&
literal|0xff
argument_list|)
expr_stmt|;
break|break;
block|}
name|cache
operator|->
name|elm_map
index|[
name|oid
operator|++
index|]
operator|.
name|svalid
operator|=
literal|1
expr_stmt|;
block|}
name|r
operator|++
expr_stmt|;
comment|/* 	 * We always have speaker status, no matter what, 	 * but we only save the status if we have one. 	 */
name|SAFT_BAIL
argument_list|(
name|r
argument_list|,
name|xfer_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|Nspkrs
condition|)
block|{
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator|=
name|SES_OBJSTAT_OK
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|buf
index|[
name|r
index|]
operator|==
literal|0
condition|)
block|{
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator||=
name|SESCTL_DISABLE
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|3
index|]
operator||=
literal|0x40
expr_stmt|;
block|}
name|cache
operator|->
name|elm_map
index|[
name|oid
operator|++
index|]
operator|.
name|svalid
operator|=
literal|1
expr_stmt|;
block|}
name|r
operator|++
expr_stmt|;
comment|/* 	 * Now, for "pseudo" thermometers, we have two bytes 	 * of information in enclosure status- 16 bits. Actually, 	 * the MSB is a single TEMP ALERT flag indicating whether 	 * any other bits are set, but, thanks to fuzzy thinking, 	 * in the SAF-TE spec, this can also be set even if no 	 * other bits are set, thus making this really another 	 * binary temperature sensor. 	 */
name|SAFT_BAIL
argument_list|(
name|r
operator|+
name|cfg
operator|->
name|Ntherm
argument_list|,
name|xfer_len
argument_list|)
expr_stmt|;
name|tempflags
operator|=
name|buf
index|[
name|r
operator|+
name|cfg
operator|->
name|Ntherm
index|]
expr_stmt|;
name|SAFT_BAIL
argument_list|(
name|r
operator|+
name|cfg
operator|->
name|Ntherm
operator|+
literal|1
argument_list|,
name|xfer_len
argument_list|)
expr_stmt|;
name|tempflags
operator||=
operator|(
name|tempflags
operator|<<
literal|8
operator|)
operator||
name|buf
index|[
name|r
operator|+
name|cfg
operator|->
name|Ntherm
operator|+
literal|1
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cfg
operator|->
name|Ntherm
condition|;
name|i
operator|++
control|)
block|{
name|SAFT_BAIL
argument_list|(
name|r
argument_list|,
name|xfer_len
argument_list|)
expr_stmt|;
comment|/* 		 * Status is a range from -10 to 245 deg Celsius, 		 * which we need to normalize to -20 to -245 according 		 * to the latest SCSI spec, which makes little 		 * sense since this would overflow an 8bit value. 		 * Well, still, the base normalization is -20, 		 * not -10, so we have to adjust. 		 * 		 * So what's over and under temperature? 		 * Hmm- we'll state that 'normal' operating 		 * is 10 to 40 deg Celsius. 		 */
comment|/* 		 * Actually.... All of the units that people out in the world 		 * seem to have do not come even close to setting a value that 		 * complies with this spec. 		 * 		 * The closest explanation I could find was in an 		 * LSI-Logic manual, which seemed to indicate that 		 * this value would be set by whatever the I2C code 		 * would interpolate from the output of an LM75 		 * temperature sensor. 		 * 		 * This means that it is impossible to use the actual 		 * numeric value to predict anything. But we don't want 		 * to lose the value. So, we'll propagate the *uncorrected* 		 * value and set SES_OBJSTAT_NOTAVAIL. We'll depend on the 		 * temperature flags for warnings. 		 */
if|if
condition|(
name|tempflags
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
block|{
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator|=
name|SES_OBJSTAT_CRIT
expr_stmt|;
name|cfg
operator|->
name|enc_status
operator||=
name|SES_ENCSTAT_CRITICAL
expr_stmt|;
block|}
else|else
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator|=
name|SES_OBJSTAT_OK
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|2
index|]
operator|=
name|buf
index|[
name|r
index|]
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
operator|++
index|]
operator|.
name|svalid
operator|=
literal|1
expr_stmt|;
name|r
operator|++
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|cfg
operator|->
name|Ntstats
condition|;
name|i
operator|++
control|)
block|{
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|tempflags
operator|&
operator|(
literal|1
operator|<<
operator|(
operator|(
name|i
operator|==
name|cfg
operator|->
name|Ntstats
operator|)
condition|?
literal|15
else|:
operator|(
name|cfg
operator|->
name|Ntherm
operator|+
name|i
operator|)
operator|)
operator|)
condition|)
block|{
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator|=
name|SES_OBJSTAT_CRIT
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
literal|4
index|]
operator|.
name|encstat
index|[
literal|2
index|]
operator|=
literal|0xff
expr_stmt|;
comment|/* 			 * Set 'over temperature' failure. 			 */
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|3
index|]
operator|=
literal|8
expr_stmt|;
name|cfg
operator|->
name|enc_status
operator||=
name|SES_ENCSTAT_CRITICAL
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * We used to say 'not available' and synthesize a 			 * nominal 30 deg (C)- that was wrong. Actually, 			 * Just say 'OK', and use the reserved value of 			 * zero. 			 */
if|if
condition|(
operator|(
name|cfg
operator|->
name|Ntherm
operator|+
name|cfg
operator|->
name|Ntstats
operator|)
operator|==
literal|0
condition|)
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator|=
name|SES_OBJSTAT_NOTAVAIL
expr_stmt|;
else|else
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator|=
name|SES_OBJSTAT_OK
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|cache
operator|->
name|elm_map
index|[
name|oid
operator|++
index|]
operator|.
name|svalid
operator|=
literal|1
expr_stmt|;
block|}
name|r
operator|+=
literal|2
expr_stmt|;
name|cache
operator|->
name|enc_status
operator|=
name|cfg
operator|->
name|enc_status
operator||
name|cfg
operator|->
name|slot_status
operator||
name|cfg
operator|->
name|adm_status
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|safte_process_slotstatus
parameter_list|(
name|enc_softc_t
modifier|*
name|enc
parameter_list|,
name|struct
name|enc_fsm_state
modifier|*
name|state
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|,
name|uint8_t
modifier|*
modifier|*
name|bufp
parameter_list|,
name|int
name|error
parameter_list|,
name|int
name|xfer_len
parameter_list|)
block|{
name|struct
name|scfg
modifier|*
name|cfg
decl_stmt|;
name|uint8_t
modifier|*
name|buf
init|=
operator|*
name|bufp
decl_stmt|;
name|enc_cache_t
modifier|*
name|cache
init|=
operator|&
name|enc
operator|->
name|enc_cache
decl_stmt|;
name|int
name|oid
decl_stmt|,
name|r
decl_stmt|,
name|i
decl_stmt|;
name|cfg
operator|=
name|enc
operator|->
name|enc_private
expr_stmt|;
if|if
condition|(
name|cfg
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|cfg
operator|->
name|slot_status
operator|=
literal|0
expr_stmt|;
name|oid
operator|=
name|cfg
operator|->
name|slotoff
expr_stmt|;
for|for
control|(
name|r
operator|=
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cfg
operator|->
name|Nslots
condition|;
name|i
operator|++
operator|,
name|r
operator|+=
literal|4
control|)
block|{
name|SAFT_BAIL
argument_list|(
name|r
operator|+
literal|3
argument_list|,
name|xfer_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|enctype
operator|==
name|ELMTYP_ARRAY_DEV
condition|)
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|2
index|]
operator|&=
name|SESCTL_RQSID
expr_stmt|;
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|buf
index|[
name|r
operator|+
literal|3
index|]
operator|&
literal|0x01
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* no device */
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator|=
name|SES_OBJSTAT_NOTINSTALLED
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|buf
index|[
name|r
operator|+
literal|0
index|]
operator|&
literal|0x02
condition|)
block|{
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator|=
name|SES_OBJSTAT_CRIT
expr_stmt|;
name|cfg
operator|->
name|slot_status
operator||=
name|SES_ENCSTAT_CRITICAL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|buf
index|[
name|r
operator|+
literal|0
index|]
operator|&
literal|0x40
condition|)
block|{
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator|=
name|SES_OBJSTAT_NONCRIT
expr_stmt|;
name|cfg
operator|->
name|slot_status
operator||=
name|SES_ENCSTAT_NONCRITICAL
expr_stmt|;
block|}
else|else
block|{
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator|=
name|SES_OBJSTAT_OK
expr_stmt|;
block|}
if|if
condition|(
name|buf
index|[
name|r
operator|+
literal|3
index|]
operator|&
literal|0x2
condition|)
block|{
if|if
condition|(
name|buf
index|[
name|r
operator|+
literal|3
index|]
operator|&
literal|0x01
condition|)
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|2
index|]
operator||=
name|SESCTL_RQSRMV
expr_stmt|;
else|else
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|2
index|]
operator||=
name|SESCTL_RQSINS
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|buf
index|[
name|r
operator|+
literal|3
index|]
operator|&
literal|0x04
operator|)
operator|==
literal|0
condition|)
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|3
index|]
operator||=
name|SESCTL_DEVOFF
expr_stmt|;
if|if
condition|(
name|buf
index|[
name|r
operator|+
literal|0
index|]
operator|&
literal|0x02
condition|)
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|3
index|]
operator||=
name|SESCTL_RQSFLT
expr_stmt|;
if|if
condition|(
name|buf
index|[
name|r
operator|+
literal|0
index|]
operator|&
literal|0x40
condition|)
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|0
index|]
operator||=
name|SESCTL_PRDFAIL
expr_stmt|;
if|if
condition|(
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|enctype
operator|==
name|ELMTYP_ARRAY_DEV
condition|)
block|{
if|if
condition|(
name|buf
index|[
name|r
operator|+
literal|0
index|]
operator|&
literal|0x01
condition|)
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|1
index|]
operator||=
literal|0x80
expr_stmt|;
if|if
condition|(
name|buf
index|[
name|r
operator|+
literal|0
index|]
operator|&
literal|0x04
condition|)
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|1
index|]
operator||=
literal|0x02
expr_stmt|;
if|if
condition|(
name|buf
index|[
name|r
operator|+
literal|0
index|]
operator|&
literal|0x08
condition|)
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|1
index|]
operator||=
literal|0x04
expr_stmt|;
if|if
condition|(
name|buf
index|[
name|r
operator|+
literal|0
index|]
operator|&
literal|0x10
condition|)
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|1
index|]
operator||=
literal|0x08
expr_stmt|;
if|if
condition|(
name|buf
index|[
name|r
operator|+
literal|0
index|]
operator|&
literal|0x20
condition|)
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|1
index|]
operator||=
literal|0x10
expr_stmt|;
if|if
condition|(
name|buf
index|[
name|r
operator|+
literal|1
index|]
operator|&
literal|0x01
condition|)
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|1
index|]
operator||=
literal|0x20
expr_stmt|;
if|if
condition|(
name|buf
index|[
name|r
operator|+
literal|1
index|]
operator|&
literal|0x02
condition|)
name|cache
operator|->
name|elm_map
index|[
name|oid
index|]
operator|.
name|encstat
index|[
literal|1
index|]
operator||=
literal|0x01
expr_stmt|;
block|}
name|cache
operator|->
name|elm_map
index|[
name|oid
operator|++
index|]
operator|.
name|svalid
operator|=
literal|1
expr_stmt|;
block|}
name|cache
operator|->
name|enc_status
operator|=
name|cfg
operator|->
name|enc_status
operator||
name|cfg
operator|->
name|slot_status
operator||
name|cfg
operator|->
name|adm_status
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|safte_fill_control_request
parameter_list|(
name|enc_softc_t
modifier|*
name|enc
parameter_list|,
name|struct
name|enc_fsm_state
modifier|*
name|state
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|scfg
modifier|*
name|cfg
decl_stmt|;
name|enc_element_t
modifier|*
name|ep
decl_stmt|,
modifier|*
name|ep1
decl_stmt|;
name|safte_control_request_t
modifier|*
name|req
decl_stmt|;
name|int
name|i
decl_stmt|,
name|idx
decl_stmt|,
name|xfer_len
decl_stmt|;
name|cfg
operator|=
name|enc
operator|->
name|enc_private
expr_stmt|;
if|if
condition|(
name|cfg
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|enc
operator|->
name|enc_cache
operator|.
name|nelms
operator|==
literal|0
condition|)
block|{
name|enc_update_request
argument_list|(
name|enc
argument_list|,
name|SAFTE_UPDATE_READCONFIG
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|cfg
operator|->
name|current_request
operator|==
name|NULL
condition|)
block|{
name|cfg
operator|->
name|current_request
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|cfg
operator|->
name|requests
argument_list|)
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|cfg
operator|->
name|requests
argument_list|,
name|cfg
operator|->
name|current_request
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|cfg
operator|->
name|current_request_stage
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|current_request_stages
operator|=
literal|1
expr_stmt|;
block|}
name|req
operator|=
name|cfg
operator|->
name|current_request
expr_stmt|;
name|idx
operator|=
operator|(
name|int
operator|)
name|req
operator|->
name|elm_idx
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|elm_idx
operator|==
name|SES_SETSTATUS_ENC_IDX
condition|)
block|{
name|cfg
operator|->
name|adm_status
operator|=
name|req
operator|->
name|elm_stat
index|[
literal|0
index|]
operator|&
name|ALL_ENC_STAT
expr_stmt|;
name|cfg
operator|->
name|flag1
operator|&=
operator|~
operator|(
name|SAFT_FLG1_GLOBFAIL
operator||
name|SAFT_FLG1_GLOBWARN
operator|)
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|elm_stat
index|[
literal|0
index|]
operator|&
operator|(
name|SES_ENCSTAT_CRITICAL
operator||
name|SES_ENCSTAT_UNRECOV
operator|)
condition|)
name|cfg
operator|->
name|flag1
operator||=
name|SAFT_FLG1_GLOBFAIL
expr_stmt|;
elseif|else
if|if
condition|(
name|req
operator|->
name|elm_stat
index|[
literal|0
index|]
operator|&
name|SES_ENCSTAT_NONCRITICAL
condition|)
name|cfg
operator|->
name|flag1
operator||=
name|SAFT_FLG1_GLOBWARN
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|SAFTE_WT_GLOBAL
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|cfg
operator|->
name|flag1
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
name|cfg
operator|->
name|flag2
expr_stmt|;
name|buf
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|xfer_len
operator|=
literal|16
expr_stmt|;
block|}
else|else
block|{
name|ep
operator|=
operator|&
name|enc
operator|->
name|enc_cache
operator|.
name|elm_map
index|[
name|idx
index|]
expr_stmt|;
switch|switch
condition|(
name|ep
operator|->
name|enctype
condition|)
block|{
case|case
name|ELMTYP_DEVICE
case|:
case|case
name|ELMTYP_ARRAY_DEV
case|:
switch|switch
condition|(
name|cfg
operator|->
name|current_request_stage
condition|)
block|{
case|case
literal|0
case|:
name|ep
operator|->
name|priv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|elm_stat
index|[
literal|0
index|]
operator|&
name|SESCTL_PRDFAIL
condition|)
name|ep
operator|->
name|priv
operator||=
literal|0x40
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|elm_stat
index|[
literal|3
index|]
operator|&
name|SESCTL_RQSFLT
condition|)
name|ep
operator|->
name|priv
operator||=
literal|0x02
expr_stmt|;
if|if
condition|(
name|ep
operator|->
name|enctype
operator|==
name|ELMTYP_ARRAY_DEV
condition|)
block|{
if|if
condition|(
name|req
operator|->
name|elm_stat
index|[
literal|1
index|]
operator|&
literal|0x01
condition|)
name|ep
operator|->
name|priv
operator||=
literal|0x200
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|elm_stat
index|[
literal|1
index|]
operator|&
literal|0x02
condition|)
name|ep
operator|->
name|priv
operator||=
literal|0x04
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|elm_stat
index|[
literal|1
index|]
operator|&
literal|0x04
condition|)
name|ep
operator|->
name|priv
operator||=
literal|0x08
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|elm_stat
index|[
literal|1
index|]
operator|&
literal|0x08
condition|)
name|ep
operator|->
name|priv
operator||=
literal|0x10
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|elm_stat
index|[
literal|1
index|]
operator|&
literal|0x10
condition|)
name|ep
operator|->
name|priv
operator||=
literal|0x20
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|elm_stat
index|[
literal|1
index|]
operator|&
literal|0x20
condition|)
name|ep
operator|->
name|priv
operator||=
literal|0x100
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|elm_stat
index|[
literal|1
index|]
operator|&
literal|0x80
condition|)
name|ep
operator|->
name|priv
operator||=
literal|0x01
expr_stmt|;
block|}
if|if
condition|(
name|ep
operator|->
name|priv
operator|==
literal|0
condition|)
name|ep
operator|->
name|priv
operator||=
literal|0x01
expr_stmt|;
comment|/* no errors */
name|buf
index|[
literal|0
index|]
operator|=
name|SAFTE_WT_DSTAT
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cfg
operator|->
name|Nslots
condition|;
name|i
operator|++
control|)
block|{
name|ep1
operator|=
operator|&
name|enc
operator|->
name|enc_cache
operator|.
name|elm_map
index|[
name|cfg
operator|->
name|slotoff
operator|+
name|i
index|]
expr_stmt|;
name|buf
index|[
literal|1
operator|+
operator|(
literal|3
operator|*
name|i
operator|)
index|]
operator|=
name|ep1
operator|->
name|priv
expr_stmt|;
name|buf
index|[
literal|2
operator|+
operator|(
literal|3
operator|*
name|i
operator|)
index|]
operator|=
name|ep1
operator|->
name|priv
operator|>>
literal|8
expr_stmt|;
block|}
name|xfer_len
operator|=
name|cfg
operator|->
name|Nslots
operator|*
literal|3
operator|+
literal|1
expr_stmt|;
define|#
directive|define
name|DEVON
parameter_list|(
name|x
parameter_list|)
value|(!(((x)[2]& SESCTL_RQSINS) |	\ 			   ((x)[2]& SESCTL_RQSRMV) |	\ 			   ((x)[3]& SESCTL_DEVOFF)))
if|if
condition|(
name|DEVON
argument_list|(
name|req
operator|->
name|elm_stat
argument_list|)
operator|!=
name|DEVON
argument_list|(
name|ep
operator|->
name|encstat
argument_list|)
condition|)
name|cfg
operator|->
name|current_request_stages
operator|++
expr_stmt|;
define|#
directive|define
name|IDON
parameter_list|(
name|x
parameter_list|)
value|(!!((x)[2]& SESCTL_RQSID))
if|if
condition|(
name|IDON
argument_list|(
name|req
operator|->
name|elm_stat
argument_list|)
operator|!=
name|IDON
argument_list|(
name|ep
operator|->
name|encstat
argument_list|)
condition|)
name|cfg
operator|->
name|current_request_stages
operator|++
expr_stmt|;
break|break;
case|case
literal|1
case|:
case|case
literal|2
case|:
name|buf
index|[
literal|0
index|]
operator|=
name|SAFTE_WT_SLTOP
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|idx
operator|-
name|cfg
operator|->
name|slotoff
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|current_request_stage
operator|==
literal|1
operator|&&
name|DEVON
argument_list|(
name|req
operator|->
name|elm_stat
argument_list|)
operator|!=
name|DEVON
argument_list|(
name|ep
operator|->
name|encstat
argument_list|)
condition|)
block|{
if|if
condition|(
name|DEVON
argument_list|(
name|req
operator|->
name|elm_stat
argument_list|)
condition|)
name|buf
index|[
literal|2
index|]
operator|=
literal|0x01
expr_stmt|;
else|else
name|buf
index|[
literal|2
index|]
operator|=
literal|0x02
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|IDON
argument_list|(
name|req
operator|->
name|elm_stat
argument_list|)
condition|)
name|buf
index|[
literal|2
index|]
operator|=
literal|0x04
expr_stmt|;
else|else
name|buf
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
name|ep
operator|->
name|encstat
index|[
literal|2
index|]
operator|&=
operator|~
name|SESCTL_RQSID
expr_stmt|;
name|ep
operator|->
name|encstat
index|[
literal|2
index|]
operator||=
name|req
operator|->
name|elm_stat
index|[
literal|2
index|]
operator|&
name|SESCTL_RQSID
expr_stmt|;
block|}
name|xfer_len
operator|=
literal|64
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
break|break;
case|case
name|ELMTYP_POWER
case|:
name|cfg
operator|->
name|current_request_stages
operator|=
literal|2
expr_stmt|;
switch|switch
condition|(
name|cfg
operator|->
name|current_request_stage
condition|)
block|{
case|case
literal|0
case|:
if|if
condition|(
name|req
operator|->
name|elm_stat
index|[
literal|3
index|]
operator|&
name|SESCTL_RQSTFAIL
condition|)
block|{
name|cfg
operator|->
name|flag1
operator||=
name|SAFT_FLG1_ENCPWRFAIL
expr_stmt|;
block|}
else|else
block|{
name|cfg
operator|->
name|flag1
operator|&=
operator|~
name|SAFT_FLG1_ENCPWRFAIL
expr_stmt|;
block|}
name|buf
index|[
literal|0
index|]
operator|=
name|SAFTE_WT_GLOBAL
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|cfg
operator|->
name|flag1
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
name|cfg
operator|->
name|flag2
expr_stmt|;
name|buf
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|xfer_len
operator|=
literal|16
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|buf
index|[
literal|0
index|]
operator|=
name|SAFTE_WT_ACTPWS
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|idx
operator|-
name|cfg
operator|->
name|pwroff
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|elm_stat
index|[
literal|3
index|]
operator|&
name|SESCTL_RQSTON
condition|)
name|buf
index|[
literal|2
index|]
operator|=
literal|0x01
expr_stmt|;
else|else
name|buf
index|[
literal|2
index|]
operator|=
literal|0x00
expr_stmt|;
name|buf
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|xfer_len
operator|=
literal|16
expr_stmt|;
default|default:
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
break|break;
case|case
name|ELMTYP_FAN
case|:
if|if
condition|(
operator|(
name|req
operator|->
name|elm_stat
index|[
literal|3
index|]
operator|&
literal|0x7
operator|)
operator|!=
literal|0
condition|)
name|cfg
operator|->
name|current_request_stages
operator|=
literal|2
expr_stmt|;
switch|switch
condition|(
name|cfg
operator|->
name|current_request_stage
condition|)
block|{
case|case
literal|0
case|:
if|if
condition|(
name|req
operator|->
name|elm_stat
index|[
literal|3
index|]
operator|&
name|SESCTL_RQSTFAIL
condition|)
name|cfg
operator|->
name|flag1
operator||=
name|SAFT_FLG1_ENCFANFAIL
expr_stmt|;
else|else
name|cfg
operator|->
name|flag1
operator|&=
operator|~
name|SAFT_FLG1_ENCFANFAIL
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|SAFTE_WT_GLOBAL
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|cfg
operator|->
name|flag1
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
name|cfg
operator|->
name|flag2
expr_stmt|;
name|buf
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|xfer_len
operator|=
literal|16
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|buf
index|[
literal|0
index|]
operator|=
name|SAFTE_WT_FANSPD
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|idx
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|elm_stat
index|[
literal|3
index|]
operator|&
name|SESCTL_RQSTON
condition|)
block|{
if|if
condition|(
operator|(
name|req
operator|->
name|elm_stat
index|[
literal|3
index|]
operator|&
literal|0x7
operator|)
operator|==
literal|7
condition|)
name|buf
index|[
literal|2
index|]
operator|=
literal|4
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|req
operator|->
name|elm_stat
index|[
literal|3
index|]
operator|&
literal|0x7
operator|)
operator|>=
literal|5
condition|)
name|buf
index|[
literal|2
index|]
operator|=
literal|3
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|req
operator|->
name|elm_stat
index|[
literal|3
index|]
operator|&
literal|0x7
operator|)
operator|>=
literal|3
condition|)
name|buf
index|[
literal|2
index|]
operator|=
literal|2
expr_stmt|;
else|else
name|buf
index|[
literal|2
index|]
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|buf
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|buf
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|xfer_len
operator|=
literal|16
expr_stmt|;
name|ep
operator|->
name|encstat
index|[
literal|3
index|]
operator|=
name|req
operator|->
name|elm_stat
index|[
literal|3
index|]
operator|&
literal|0x67
expr_stmt|;
default|default:
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
break|break;
case|case
name|ELMTYP_DOORLOCK
case|:
if|if
condition|(
name|req
operator|->
name|elm_stat
index|[
literal|3
index|]
operator|&
literal|0x1
condition|)
name|cfg
operator|->
name|flag2
operator|&=
operator|~
name|SAFT_FLG2_LOCKDOOR
expr_stmt|;
else|else
name|cfg
operator|->
name|flag2
operator||=
name|SAFT_FLG2_LOCKDOOR
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|SAFTE_WT_GLOBAL
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|cfg
operator|->
name|flag1
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
name|cfg
operator|->
name|flag2
expr_stmt|;
name|buf
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|xfer_len
operator|=
literal|16
expr_stmt|;
break|break;
case|case
name|ELMTYP_ALARM
case|:
if|if
condition|(
operator|(
name|req
operator|->
name|elm_stat
index|[
literal|0
index|]
operator|&
name|SESCTL_DISABLE
operator|)
operator|||
operator|(
name|req
operator|->
name|elm_stat
index|[
literal|3
index|]
operator|&
literal|0x40
operator|)
condition|)
block|{
name|cfg
operator|->
name|flag2
operator|&=
operator|~
name|SAFT_FLG1_ALARM
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|req
operator|->
name|elm_stat
index|[
literal|3
index|]
operator|&
literal|0x0f
operator|)
operator|!=
literal|0
condition|)
block|{
name|cfg
operator|->
name|flag2
operator||=
name|SAFT_FLG1_ALARM
expr_stmt|;
block|}
else|else
block|{
name|cfg
operator|->
name|flag2
operator|&=
operator|~
name|SAFT_FLG1_ALARM
expr_stmt|;
block|}
name|buf
index|[
literal|0
index|]
operator|=
name|SAFTE_WT_GLOBAL
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|cfg
operator|->
name|flag1
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
name|cfg
operator|->
name|flag2
expr_stmt|;
name|buf
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|xfer_len
operator|=
literal|16
expr_stmt|;
name|ep
operator|->
name|encstat
index|[
literal|3
index|]
operator|=
name|req
operator|->
name|elm_stat
index|[
literal|3
index|]
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
block|}
if|if
condition|(
name|enc
operator|->
name|enc_type
operator|==
name|ENC_SEMB_SAFT
condition|)
block|{
name|semb_write_buffer
argument_list|(
operator|&
name|ccb
operator|->
name|ataio
argument_list|,
comment|/*retries*/
literal|5
argument_list|,
name|NULL
argument_list|,
name|MSG_SIMPLE_Q_TAG
argument_list|,
name|buf
argument_list|,
name|xfer_len
argument_list|,
name|state
operator|->
name|timeout
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|scsi_write_buffer
argument_list|(
operator|&
name|ccb
operator|->
name|csio
argument_list|,
comment|/*retries*/
literal|5
argument_list|,
name|NULL
argument_list|,
name|MSG_SIMPLE_Q_TAG
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|buf
argument_list|,
name|xfer_len
argument_list|,
name|SSD_FULL_SIZE
argument_list|,
name|state
operator|->
name|timeout
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|safte_process_control_request
parameter_list|(
name|enc_softc_t
modifier|*
name|enc
parameter_list|,
name|struct
name|enc_fsm_state
modifier|*
name|state
parameter_list|,
name|union
name|ccb
modifier|*
name|ccb
parameter_list|,
name|uint8_t
modifier|*
modifier|*
name|bufp
parameter_list|,
name|int
name|error
parameter_list|,
name|int
name|xfer_len
parameter_list|)
block|{
name|struct
name|scfg
modifier|*
name|cfg
decl_stmt|;
name|safte_control_request_t
modifier|*
name|req
decl_stmt|;
name|int
name|idx
decl_stmt|,
name|type
decl_stmt|;
name|cfg
operator|=
name|enc
operator|->
name|enc_private
expr_stmt|;
if|if
condition|(
name|cfg
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|req
operator|=
name|cfg
operator|->
name|current_request
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|result
operator|==
literal|0
condition|)
name|req
operator|->
name|result
operator|=
name|error
expr_stmt|;
if|if
condition|(
operator|++
name|cfg
operator|->
name|current_request_stage
operator|>=
name|cfg
operator|->
name|current_request_stages
condition|)
block|{
name|idx
operator|=
name|req
operator|->
name|elm_idx
expr_stmt|;
if|if
condition|(
name|idx
operator|==
name|SES_SETSTATUS_ENC_IDX
condition|)
name|type
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|type
operator|=
name|enc
operator|->
name|enc_cache
operator|.
name|elm_map
index|[
name|idx
index|]
operator|.
name|enctype
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|ELMTYP_DEVICE
operator|||
name|type
operator|==
name|ELMTYP_ARRAY_DEV
condition|)
name|enc_update_request
argument_list|(
name|enc
argument_list|,
name|SAFTE_UPDATE_READSLOTSTATUS
argument_list|)
expr_stmt|;
else|else
name|enc_update_request
argument_list|(
name|enc
argument_list|,
name|SAFTE_UPDATE_READENCSTATUS
argument_list|)
expr_stmt|;
name|cfg
operator|->
name|current_request
operator|=
name|NULL
expr_stmt|;
name|wakeup
argument_list|(
name|req
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|enc_update_request
argument_list|(
name|enc
argument_list|,
name|SAFTE_PROCESS_CONTROL_REQS
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|safte_softc_invalidate
parameter_list|(
name|enc_softc_t
modifier|*
name|enc
parameter_list|)
block|{
name|struct
name|scfg
modifier|*
name|cfg
decl_stmt|;
name|cfg
operator|=
name|enc
operator|->
name|enc_private
expr_stmt|;
name|safte_terminate_control_requests
argument_list|(
operator|&
name|cfg
operator|->
name|requests
argument_list|,
name|ENXIO
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|safte_softc_cleanup
parameter_list|(
name|enc_softc_t
modifier|*
name|enc
parameter_list|)
block|{
name|ENC_FREE_AND_NULL
argument_list|(
name|enc
operator|->
name|enc_cache
operator|.
name|elm_map
argument_list|)
expr_stmt|;
name|ENC_FREE_AND_NULL
argument_list|(
name|enc
operator|->
name|enc_private
argument_list|)
expr_stmt|;
name|enc
operator|->
name|enc_cache
operator|.
name|nelms
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|safte_init_enc
parameter_list|(
name|enc_softc_t
modifier|*
name|enc
parameter_list|)
block|{
name|struct
name|scfg
modifier|*
name|cfg
decl_stmt|;
name|int
name|err
decl_stmt|;
specifier|static
name|char
name|cdb0
index|[
literal|6
index|]
init|=
block|{
name|SEND_DIAGNOSTIC
block|}
decl_stmt|;
name|cfg
operator|=
name|enc
operator|->
name|enc_private
expr_stmt|;
if|if
condition|(
name|cfg
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|err
operator|=
name|enc_runcmd
argument_list|(
name|enc
argument_list|,
name|cdb0
argument_list|,
literal|6
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
return|return
operator|(
name|err
operator|)
return|;
block|}
name|DELAY
argument_list|(
literal|5000
argument_list|)
expr_stmt|;
name|cfg
operator|->
name|flag1
operator|=
literal|0
expr_stmt|;
name|cfg
operator|->
name|flag2
operator|=
literal|0
expr_stmt|;
name|err
operator|=
name|safte_set_enc_status
argument_list|(
name|enc
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|safte_get_enc_status
parameter_list|(
name|enc_softc_t
modifier|*
name|enc
parameter_list|,
name|int
name|slpflg
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|safte_set_enc_status
parameter_list|(
name|enc_softc_t
modifier|*
name|enc
parameter_list|,
name|uint8_t
name|encstat
parameter_list|,
name|int
name|slpflag
parameter_list|)
block|{
name|struct
name|scfg
modifier|*
name|cfg
decl_stmt|;
name|safte_control_request_t
name|req
decl_stmt|;
name|cfg
operator|=
name|enc
operator|->
name|enc_private
expr_stmt|;
if|if
condition|(
name|cfg
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|req
operator|.
name|elm_idx
operator|=
name|SES_SETSTATUS_ENC_IDX
expr_stmt|;
name|req
operator|.
name|elm_stat
index|[
literal|0
index|]
operator|=
name|encstat
operator|&
literal|0xf
expr_stmt|;
name|req
operator|.
name|result
operator|=
literal|0
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|cfg
operator|->
name|requests
argument_list|,
operator|&
name|req
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|enc_update_request
argument_list|(
name|enc
argument_list|,
name|SAFTE_PROCESS_CONTROL_REQS
argument_list|)
expr_stmt|;
name|cam_periph_sleep
argument_list|(
name|enc
operator|->
name|periph
argument_list|,
operator|&
name|req
argument_list|,
name|PUSER
argument_list|,
literal|"encstat"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|req
operator|.
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|safte_get_elm_status
parameter_list|(
name|enc_softc_t
modifier|*
name|enc
parameter_list|,
name|encioc_elm_status_t
modifier|*
name|elms
parameter_list|,
name|int
name|slpflg
parameter_list|)
block|{
name|int
name|i
init|=
operator|(
name|int
operator|)
name|elms
operator|->
name|elm_idx
decl_stmt|;
name|elms
operator|->
name|cstat
index|[
literal|0
index|]
operator|=
name|enc
operator|->
name|enc_cache
operator|.
name|elm_map
index|[
name|i
index|]
operator|.
name|encstat
index|[
literal|0
index|]
expr_stmt|;
name|elms
operator|->
name|cstat
index|[
literal|1
index|]
operator|=
name|enc
operator|->
name|enc_cache
operator|.
name|elm_map
index|[
name|i
index|]
operator|.
name|encstat
index|[
literal|1
index|]
expr_stmt|;
name|elms
operator|->
name|cstat
index|[
literal|2
index|]
operator|=
name|enc
operator|->
name|enc_cache
operator|.
name|elm_map
index|[
name|i
index|]
operator|.
name|encstat
index|[
literal|2
index|]
expr_stmt|;
name|elms
operator|->
name|cstat
index|[
literal|3
index|]
operator|=
name|enc
operator|->
name|enc_cache
operator|.
name|elm_map
index|[
name|i
index|]
operator|.
name|encstat
index|[
literal|3
index|]
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|safte_set_elm_status
parameter_list|(
name|enc_softc_t
modifier|*
name|enc
parameter_list|,
name|encioc_elm_status_t
modifier|*
name|elms
parameter_list|,
name|int
name|slpflag
parameter_list|)
block|{
name|struct
name|scfg
modifier|*
name|cfg
decl_stmt|;
name|safte_control_request_t
name|req
decl_stmt|;
name|cfg
operator|=
name|enc
operator|->
name|enc_private
expr_stmt|;
if|if
condition|(
name|cfg
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
comment|/* If this is clear, we don't do diddly.  */
if|if
condition|(
operator|(
name|elms
operator|->
name|cstat
index|[
literal|0
index|]
operator|&
name|SESCTL_CSEL
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|req
operator|.
name|elm_idx
operator|=
name|elms
operator|->
name|elm_idx
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|req
operator|.
name|elm_stat
argument_list|,
name|elms
operator|->
name|cstat
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|.
name|elm_stat
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|.
name|result
operator|=
literal|0
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|cfg
operator|->
name|requests
argument_list|,
operator|&
name|req
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|enc_update_request
argument_list|(
name|enc
argument_list|,
name|SAFTE_PROCESS_CONTROL_REQS
argument_list|)
expr_stmt|;
name|cam_periph_sleep
argument_list|(
name|enc
operator|->
name|periph
argument_list|,
operator|&
name|req
argument_list|,
name|PUSER
argument_list|,
literal|"encstat"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|req
operator|.
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|safte_poll_status
parameter_list|(
name|enc_softc_t
modifier|*
name|enc
parameter_list|)
block|{
name|enc_update_request
argument_list|(
name|enc
argument_list|,
name|SAFTE_UPDATE_READENCSTATUS
argument_list|)
expr_stmt|;
name|enc_update_request
argument_list|(
name|enc
argument_list|,
name|SAFTE_UPDATE_READSLOTSTATUS
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|enc_vec
name|safte_enc_vec
init|=
block|{
operator|.
name|softc_invalidate
operator|=
name|safte_softc_invalidate
block|,
operator|.
name|softc_cleanup
operator|=
name|safte_softc_cleanup
block|,
operator|.
name|init_enc
operator|=
name|safte_init_enc
block|,
operator|.
name|get_enc_status
operator|=
name|safte_get_enc_status
block|,
operator|.
name|set_enc_status
operator|=
name|safte_set_enc_status
block|,
operator|.
name|get_elm_status
operator|=
name|safte_get_elm_status
block|,
operator|.
name|set_elm_status
operator|=
name|safte_set_elm_status
block|,
operator|.
name|poll_status
operator|=
name|safte_poll_status
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|safte_softc_init
parameter_list|(
name|enc_softc_t
modifier|*
name|enc
parameter_list|)
block|{
name|struct
name|scfg
modifier|*
name|cfg
decl_stmt|;
name|enc
operator|->
name|enc_vec
operator|=
name|safte_enc_vec
expr_stmt|;
name|enc
operator|->
name|enc_fsm_states
operator|=
name|enc_fsm_states
expr_stmt|;
if|if
condition|(
name|enc
operator|->
name|enc_private
operator|==
name|NULL
condition|)
block|{
name|enc
operator|->
name|enc_private
operator|=
name|ENC_MALLOCZ
argument_list|(
name|SAFT_PRIVATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|enc
operator|->
name|enc_private
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|cfg
operator|=
name|enc
operator|->
name|enc_private
expr_stmt|;
name|enc
operator|->
name|enc_cache
operator|.
name|nelms
operator|=
literal|0
expr_stmt|;
name|enc
operator|->
name|enc_cache
operator|.
name|enc_status
operator|=
literal|0
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|cfg
operator|->
name|requests
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


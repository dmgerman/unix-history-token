begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$NecBSD: scsi_low.c,v 1.24.10.8 2001/06/26 07:39:44 honda Exp $	*/
end_comment

begin_comment
comment|/*	$NetBSD$	*/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|SCSI_LOW_STATICS
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_DEBUG
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_NEGOTIATE_BEFORE_SENSE
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_START_UP_CHECK
end_define

begin_comment
comment|/* #define	SCSI_LOW_INFO_DETAIL */
end_comment

begin_comment
comment|/* #define	SCSI_LOW_QCLEAR_AFTER_CA */
end_comment

begin_comment
comment|/* #define	SCSI_LOW_FLAGS_QUIRKS_OK */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__NetBSD__
end_ifdef

begin_define
define|#
directive|define
name|SCSI_LOW_TARGET_OPEN
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* __NetBSD__ */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_define
define|#
directive|define
name|SCSI_LOW_FLAGS_QUIRKS_OK
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* __FreeBSD__ */
end_comment

begin_comment
comment|/*-  * [NetBSD for NEC PC-98 series]  *  Copyright (c) 1995, 1996, 1997, 1998, 1999, 2000, 2001  *	NetBSD/pc98 porting staff. All rights reserved.  *  Copyright (c) 1995, 1996, 1997, 1998, 1999, 2000, 2001  *	Naofumi HONDA. All rights reserved.  *  * [Ported for FreeBSD CAM]  *  Copyright (c) 2000, 2001  *      MITSUNAGA Noriaki, NOKUBI Hirotaka and TAKAHASHI Yoshihiro.  *      All rights reserved.  *   *  Redistribution and use in source and binary forms, with or without  *  modification, are permitted provided that the following conditions  *  are met:  *  1. Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *  2. Redistributions in binary form must reproduce the above copyright  *     notice, this list of conditions and the following disclaimer in the  *     documentation and/or other materials provided with the distribution.  *  3. The name of the author may not be used to endorse or promote products  *     derived from this software without specific prior written permission.  *   * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT,  * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR  * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN  * ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*<On the nexus establishment>  * When our host is reselected,   * nexus establish processes are little complicated.  * Normal steps are followings:  * 1) Our host selected by target => target nexus (slp->sl_Tnexus)   * 2) Identify msgin => lun nexus (slp->sl_Lnexus)  * 3) Qtag msg => ccb nexus (slp->sl_Qnexus)  */
end_comment

begin_include
include|#
directive|include
file|"opt_ddb.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_if
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|500001
end_if

begin_include
include|#
directive|include
file|<sys/bio.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<machine/clock.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* __FreeBSD__ */
end_comment

begin_include
include|#
directive|include
file|<sys/buf.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__NetBSD__
end_ifdef

begin_include
include|#
directive|include
file|<sys/device.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/intr.h>
end_include

begin_include
include|#
directive|include
file|<machine/dvcfg.h>
end_include

begin_include
include|#
directive|include
file|<dev/cons.h>
end_include

begin_include
include|#
directive|include
file|<dev/scsipi/scsipi_all.h>
end_include

begin_include
include|#
directive|include
file|<dev/scsipi/scsipiconf.h>
end_include

begin_include
include|#
directive|include
file|<dev/scsipi/scsipi_disk.h>
end_include

begin_include
include|#
directive|include
file|<dev/scsipi/scsi_all.h>
end_include

begin_include
include|#
directive|include
file|<dev/scsipi/scsiconf.h>
end_include

begin_include
include|#
directive|include
file|<sys/scsiio.h>
end_include

begin_include
include|#
directive|include
file|<i386/Cbus/dev/scsi_low.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* __NetBSD__ */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_include
include|#
directive|include
file|<cam/cam.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_ccb.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_sim.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_debug.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_periph.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam_xpt_periph.h>
end_include

begin_include
include|#
directive|include
file|<cam/scsi/scsi_all.h>
end_include

begin_include
include|#
directive|include
file|<cam/scsi/scsi_message.h>
end_include

begin_include
include|#
directive|include
file|<cam/scsi/scsi_low.h>
end_include

begin_include
include|#
directive|include
file|<sys/cons.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* __FreeBSD__ */
end_comment

begin_comment
comment|/**************************************************************  * Constants  **************************************************************/
end_comment

begin_define
define|#
directive|define
name|SCSI_LOW_POLL_HZ
value|1000
end_define

begin_comment
comment|/* functions return values */
end_comment

begin_define
define|#
directive|define
name|SCSI_LOW_START_NO_QTAG
value|0
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_START_QTAG
value|1
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_DONE_COMPLETE
value|0
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_DONE_RETRY
value|1
end_define

begin_comment
comment|/* internal disk flags */
end_comment

begin_define
define|#
directive|define
name|SCSI_LOW_DISK_DISC
value|0x00000001
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_DISK_QTAG
value|0x00000002
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_DISK_LINK
value|0x00000004
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_DISK_PARITY
value|0x00000008
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_DISK_SYNC
value|0x00010000
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_DISK_WIDE_16
value|0x00020000
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_DISK_WIDE_32
value|0x00040000
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_DISK_WIDE
value|(SCSI_LOW_DISK_WIDE_16 | SCSI_LOW_DISK_WIDE_32)
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_DISK_LFLAGS
value|0x0000ffff
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_DISK_TFLAGS
value|0xffff0000
end_define

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_SCSILOW
argument_list|,
literal|"SCSI low"
argument_list|,
literal|"SCSI low buffers"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/**************************************************************  * Declarations  **************************************************************/
end_comment

begin_comment
comment|/* static */
end_comment

begin_function_decl
name|void
name|scsi_low_info
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|struct
name|targ_info
modifier|*
parameter_list|,
name|u_char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scsi_low_engage
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|slccb
modifier|*
name|scsi_low_establish_ccb
parameter_list|(
name|struct
name|targ_info
modifier|*
parameter_list|,
name|struct
name|lun_info
modifier|*
parameter_list|,
name|scsi_low_tag_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_done
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|struct
name|slccb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_setup_done
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|struct
name|slccb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scsi_low_bus_release
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|struct
name|targ_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scsi_low_twiddle_wait
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|lun_info
modifier|*
name|scsi_low_alloc_li
parameter_list|(
name|struct
name|targ_info
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|targ_info
modifier|*
name|scsi_low_alloc_ti
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scsi_low_calcf_lun
parameter_list|(
name|struct
name|lun_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scsi_low_calcf_target
parameter_list|(
name|struct
name|targ_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scsi_low_calcf_show
parameter_list|(
name|struct
name|lun_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scsi_low_reset_nexus
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scsi_low_reset_nexus_target
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|struct
name|targ_info
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scsi_low_reset_nexus_lun
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|struct
name|lun_info
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_init
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scsi_low_start
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scsi_low_free_ti
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_alloc_qtag
parameter_list|(
name|struct
name|slccb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_dealloc_qtag
parameter_list|(
name|struct
name|slccb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_enqueue
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|struct
name|targ_info
modifier|*
parameter_list|,
name|struct
name|lun_info
modifier|*
parameter_list|,
name|struct
name|slccb
modifier|*
parameter_list|,
name|u_int
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_message_enqueue
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|struct
name|targ_info
modifier|*
parameter_list|,
name|struct
name|lun_info
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scsi_low_unit_ready_cmd
parameter_list|(
name|struct
name|slccb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scsi_low_timeout
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_timeout_check
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|SCSI_LOW_START_UP_CHECK
end_ifdef

begin_function_decl
specifier|static
name|int
name|scsi_low_start_up
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SCSI_LOW_START_UP_CHECK */
end_comment

begin_function_decl
specifier|static
name|int
name|scsi_low_abort_ccb
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|struct
name|slccb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|slccb
modifier|*
name|scsi_low_revoke_ccb
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|struct
name|slccb
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|int
name|scsi_low_version_major
init|=
literal|2
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|scsi_low_version_minor
init|=
literal|17
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|scsi_low_softc_tab
name|sl_tab
init|=
name|LIST_HEAD_INITIALIZER
argument_list|(
name|sl_tab
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**************************************************************  * Debug, Run test and Statics  **************************************************************/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|SCSI_LOW_INFO_DETAIL
end_ifdef

begin_define
define|#
directive|define
name|SCSI_LOW_INFO
parameter_list|(
name|slp
parameter_list|,
name|ti
parameter_list|,
name|s
parameter_list|)
value|scsi_low_info((slp), (ti), (s))
end_define

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* !SCSI_LOW_INFO_DETAIL */
end_comment

begin_define
define|#
directive|define
name|SCSI_LOW_INFO
parameter_list|(
name|slp
parameter_list|,
name|ti
parameter_list|,
name|s
parameter_list|)
value|printf("%s: %s\n", (slp)->sl_xname, (s))
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !SCSI_LOW_INFO_DETAIL */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|SCSI_LOW_STATICS
end_ifdef

begin_struct
specifier|static
struct|struct
name|scsi_low_statics
block|{
name|int
name|nexus_win
decl_stmt|;
name|int
name|nexus_fail
decl_stmt|;
name|int
name|nexus_disconnected
decl_stmt|;
name|int
name|nexus_reselected
decl_stmt|;
name|int
name|nexus_conflict
decl_stmt|;
block|}
name|scsi_low_statics
struct|;
end_struct

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SCSI_LOW_STATICS */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|SCSI_LOW_DEBUG
end_ifdef

begin_define
define|#
directive|define
name|SCSI_LOW_DEBUG_DONE
value|0x00001
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_DEBUG_DISC
value|0x00002
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_DEBUG_SENSE
value|0x00004
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_DEBUG_CALCF
value|0x00008
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_DEBUG_ACTION
value|0x10000
end_define

begin_decl_stmt
name|int
name|scsi_low_debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|SCSI_LOW_MAX_ATTEN_CHECK
value|32
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_ATTEN_CHECK
value|0x0001
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_CMDLNK_CHECK
value|0x0002
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_ABORT_CHECK
value|0x0004
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_NEXUS_CHECK
value|0x0008
end_define

begin_decl_stmt
name|int
name|scsi_low_test
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|scsi_low_test_id
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|scsi_low_test_abort
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|struct
name|targ_info
modifier|*
parameter_list|,
name|struct
name|lun_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scsi_low_test_cmdlnk
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|struct
name|slccb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scsi_low_test_atten
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|struct
name|targ_info
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|SCSI_LOW_DEBUG_TEST_GO
parameter_list|(
name|fl
parameter_list|,
name|id
parameter_list|)
define|\
value|((scsi_low_test& (fl)) != 0&& (scsi_low_test_id& (1<< (id))) == 0)
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_DEBUG_GO
parameter_list|(
name|fl
parameter_list|,
name|id
parameter_list|)
define|\
value|((scsi_low_debug& (fl)) != 0&& (scsi_low_test_id& (1<< (id))) == 0)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SCSI_LOW_DEBUG */
end_comment

begin_comment
comment|/**************************************************************  * CCB  **************************************************************/
end_comment

begin_macro
name|GENERIC_CCB_STATIC_ALLOC
argument_list|(
argument|scsi_low
argument_list|,
argument|slccb
argument_list|)
end_macro

begin_macro
name|GENERIC_CCB
argument_list|(
argument|scsi_low
argument_list|,
argument|slccb
argument_list|,
argument|ccb_chain
argument_list|)
end_macro

begin_comment
comment|/**************************************************************  * Inline functions  **************************************************************/
end_comment

begin_define
define|#
directive|define
name|SCSI_LOW_INLINE
value|static __inline
end_define

begin_function_decl
name|SCSI_LOW_INLINE
name|void
name|scsi_low_activate_qtag
parameter_list|(
name|struct
name|slccb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|SCSI_LOW_INLINE
name|void
name|scsi_low_deactivate_qtag
parameter_list|(
name|struct
name|slccb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|SCSI_LOW_INLINE
name|void
name|scsi_low_ccb_message_assert
parameter_list|(
name|struct
name|slccb
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|SCSI_LOW_INLINE
name|void
name|scsi_low_ccb_message_exec
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|struct
name|slccb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|SCSI_LOW_INLINE
name|void
name|scsi_low_ccb_message_retry
parameter_list|(
name|struct
name|slccb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|SCSI_LOW_INLINE
name|void
name|scsi_low_ccb_message_clear
parameter_list|(
name|struct
name|slccb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|SCSI_LOW_INLINE
name|void
name|scsi_low_init_msgsys
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|struct
name|targ_info
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|SCSI_LOW_INLINE
name|void
name|scsi_low_activate_qtag
parameter_list|(
name|cb
parameter_list|)
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
block|{
name|struct
name|lun_info
modifier|*
name|li
init|=
name|cb
operator|->
name|li
decl_stmt|;
if|if
condition|(
name|cb
operator|->
name|ccb_tag
operator|!=
name|SCSI_LOW_UNKTAG
condition|)
return|return;
name|li
operator|->
name|li_nqio
operator|++
expr_stmt|;
name|cb
operator|->
name|ccb_tag
operator|=
name|cb
operator|->
name|ccb_otag
expr_stmt|;
block|}
end_function

begin_function
name|SCSI_LOW_INLINE
name|void
name|scsi_low_deactivate_qtag
parameter_list|(
name|cb
parameter_list|)
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
block|{
name|struct
name|lun_info
modifier|*
name|li
init|=
name|cb
operator|->
name|li
decl_stmt|;
if|if
condition|(
name|cb
operator|->
name|ccb_tag
operator|==
name|SCSI_LOW_UNKTAG
condition|)
return|return;
name|li
operator|->
name|li_nqio
operator|--
expr_stmt|;
name|cb
operator|->
name|ccb_tag
operator|=
name|SCSI_LOW_UNKTAG
expr_stmt|;
block|}
end_function

begin_function
name|SCSI_LOW_INLINE
name|void
name|scsi_low_ccb_message_exec
parameter_list|(
name|slp
parameter_list|,
name|cb
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
block|{
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|cb
operator|->
name|ti
argument_list|,
name|cb
operator|->
name|ccb_msgoutflag
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cb
operator|->
name|ccb_msgoutflag
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|SCSI_LOW_INLINE
name|void
name|scsi_low_ccb_message_assert
parameter_list|(
name|cb
parameter_list|,
name|msg
parameter_list|)
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
name|u_int
name|msg
decl_stmt|;
block|{
name|cb
operator|->
name|ccb_msgoutflag
operator|=
name|cb
operator|->
name|ccb_omsgoutflag
operator|=
name|msg
expr_stmt|;
block|}
end_function

begin_function
name|SCSI_LOW_INLINE
name|void
name|scsi_low_ccb_message_retry
parameter_list|(
name|cb
parameter_list|)
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
block|{
name|cb
operator|->
name|ccb_msgoutflag
operator|=
name|cb
operator|->
name|ccb_omsgoutflag
expr_stmt|;
block|}
end_function

begin_function
name|SCSI_LOW_INLINE
name|void
name|scsi_low_ccb_message_clear
parameter_list|(
name|cb
parameter_list|)
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
block|{
name|cb
operator|->
name|ccb_msgoutflag
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|SCSI_LOW_INLINE
name|void
name|scsi_low_init_msgsys
parameter_list|(
name|slp
parameter_list|,
name|ti
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
block|{
name|ti
operator|->
name|ti_msginptr
operator|=
literal|0
expr_stmt|;
name|ti
operator|->
name|ti_emsgflags
operator|=
name|ti
operator|->
name|ti_msgflags
operator|=
name|ti
operator|->
name|ti_omsgflags
operator|=
literal|0
expr_stmt|;
name|SCSI_LOW_DEASSERT_ATN
argument_list|(
name|slp
argument_list|)
expr_stmt|;
name|SCSI_LOW_SETUP_MSGPHASE
argument_list|(
name|slp
argument_list|,
name|MSGPH_NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*=============================================================  * START OF OS switch  (All OS depend fucntions should be here)  =============================================================*/
end_comment

begin_comment
comment|/* common os depend utitlities */
end_comment

begin_define
define|#
directive|define
name|SCSI_LOW_CMD_RESIDUAL_CHK
value|0x0001
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_CMD_ORDERED_QTAG
value|0x0002
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_CMD_ABORT_WARNING
value|0x0004
end_define

begin_decl_stmt
specifier|static
name|u_int8_t
name|scsi_low_cmd_flags
index|[
literal|256
index|]
init|=
block|{
comment|/*	0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f */
comment|/*0*/
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|5
block|,
literal|0
block|,
literal|5
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/*1*/
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
literal|2
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
comment|/*2*/
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|5
block|,
literal|0
block|,
literal|5
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|5
block|,
literal|5
block|,
comment|/*3*/
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|5
block|,
literal|5
block|, }
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|scsi_low_error_code
block|{
name|int
name|error_bits
decl_stmt|;
name|int
name|error_code
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|struct
name|slccb
modifier|*
name|scsi_low_find_ccb
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|u_int
parameter_list|,
name|u_int
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_translate_error_code
parameter_list|(
name|struct
name|slccb
modifier|*
parameter_list|,
name|struct
name|scsi_low_error_code
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|struct
name|slccb
modifier|*
name|scsi_low_find_ccb
parameter_list|(
name|slp
parameter_list|,
name|target
parameter_list|,
name|lun
parameter_list|,
name|osdep
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|u_int
name|target
decl_stmt|,
name|lun
decl_stmt|;
name|void
modifier|*
name|osdep
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
name|ti
operator|=
name|slp
operator|->
name|sl_ti
index|[
name|target
index|]
expr_stmt|;
name|li
operator|=
name|scsi_low_alloc_li
argument_list|(
name|ti
argument_list|,
name|lun
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|li
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
operator|(
name|cb
operator|=
name|slp
operator|->
name|sl_Qnexus
operator|)
operator|!=
name|NULL
operator|&&
name|cb
operator|->
name|osdep
operator|==
name|osdep
condition|)
return|return
name|cb
return|;
for|for
control|(
name|cb
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|slp
operator|->
name|sl_start
argument_list|)
init|;
name|cb
operator|!=
name|NULL
condition|;
name|cb
operator|=
name|TAILQ_NEXT
argument_list|(
name|cb
argument_list|,
name|ccb_chain
argument_list|)
control|)
block|{
if|if
condition|(
name|cb
operator|->
name|osdep
operator|==
name|osdep
condition|)
return|return
name|cb
return|;
block|}
for|for
control|(
name|cb
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|li
operator|->
name|li_discq
argument_list|)
init|;
name|cb
operator|!=
name|NULL
condition|;
name|cb
operator|=
name|TAILQ_NEXT
argument_list|(
name|cb
argument_list|,
name|ccb_chain
argument_list|)
control|)
block|{
if|if
condition|(
name|cb
operator|->
name|osdep
operator|==
name|osdep
condition|)
return|return
name|cb
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_translate_error_code
parameter_list|(
name|cb
parameter_list|,
name|tp
parameter_list|)
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
name|struct
name|scsi_low_error_code
modifier|*
name|tp
decl_stmt|;
block|{
if|if
condition|(
name|cb
operator|->
name|ccb_error
operator|==
literal|0
condition|)
return|return
name|tp
operator|->
name|error_code
return|;
for|for
control|(
name|tp
operator|++
init|;
operator|(
name|cb
operator|->
name|ccb_error
operator|&
name|tp
operator|->
name|error_bits
operator|)
operator|==
literal|0
condition|;
name|tp
operator|++
control|)
empty_stmt|;
return|return
name|tp
operator|->
name|error_code
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SCSI_LOW_INTERFACE_XS
end_ifdef

begin_comment
comment|/**************************************************************  * SCSI INTERFACE (XS)  **************************************************************/
end_comment

begin_define
define|#
directive|define
name|SCSI_LOW_MINPHYS
value|0x10000
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_MALLOC
parameter_list|(
name|size
parameter_list|)
value|malloc((size), M_SCSILOW, M_NOWAIT)
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_FREE
parameter_list|(
name|pt
parameter_list|)
value|free((pt), M_SCSILOW)
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_ALLOC_CCB
parameter_list|(
name|flags
parameter_list|)
value|scsi_low_get_ccb((flags))
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_XS_POLL_HZ
value|1000
end_define

begin_function_decl
specifier|static
name|int
name|scsi_low_poll_xs
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|struct
name|slccb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scsi_low_scsi_minphys_xs
parameter_list|(
name|struct
name|buf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|SCSI_LOW_TARGET_OPEN
end_ifdef

begin_function_decl
specifier|static
name|int
name|scsi_low_target_open
parameter_list|(
name|struct
name|scsipi_link
modifier|*
parameter_list|,
name|struct
name|cfdata
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SCSI_LOW_TARGET_OPEN */
end_comment

begin_function_decl
specifier|static
name|int
name|scsi_low_scsi_cmd_xs
parameter_list|(
name|struct
name|scsipi_xfer
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_enable_xs
parameter_list|(
name|void
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_ioctl_xs
parameter_list|(
name|struct
name|scsipi_link
modifier|*
parameter_list|,
name|u_long
parameter_list|,
name|caddr_t
parameter_list|,
name|int
parameter_list|,
name|struct
name|proc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_attach_xs
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_world_start_xs
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_dettach_xs
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_ccb_setup_xs
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|struct
name|slccb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_done_xs
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|struct
name|slccb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scsi_low_timeout_xs
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|u_int
name|scsi_low_translate_quirks_xs
parameter_list|(
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scsi_low_setup_quirks_xs
parameter_list|(
name|struct
name|targ_info
modifier|*
parameter_list|,
name|struct
name|lun_info
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|struct
name|scsi_low_osdep_funcs
name|scsi_low_osdep_funcs_xs
init|=
block|{
name|scsi_low_attach_xs
block|,
name|scsi_low_world_start_xs
block|,
name|scsi_low_dettach_xs
block|,
name|scsi_low_ccb_setup_xs
block|,
name|scsi_low_done_xs
block|,
name|scsi_low_timeout_xs
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|scsipi_device
name|scsi_low_dev
init|=
block|{
name|NULL
block|,
comment|/* Use default error handler */
name|NULL
block|,
comment|/* have a queue, served by this */
name|NULL
block|,
comment|/* have no async handler */
name|NULL
block|,
comment|/* Use default 'done' routine */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|scsi_low_error_code
name|scsi_low_error_code_xs
index|[]
init|=
block|{
block|{
literal|0
block|,
name|XS_NOERROR
block|}
block|,
block|{
name|SENSEIO
block|,
name|XS_SENSE
block|}
block|,
block|{
name|BUSYERR
block|,
name|XS_BUSY
block|}
block|,
block|{
name|SELTIMEOUTIO
block|,
name|XS_SELTIMEOUT
block|}
block|,
block|{
name|TIMEOUTIO
block|,
name|XS_TIMEOUT
block|}
block|,
block|{
operator|-
literal|1
block|,
name|XS_DRIVER_STUFFUP
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|scsi_low_ioctl_xs
parameter_list|(
name|link
parameter_list|,
name|cmd
parameter_list|,
name|addr
parameter_list|,
name|flag
parameter_list|,
name|p
parameter_list|)
name|struct
name|scsipi_link
modifier|*
name|link
decl_stmt|;
name|u_long
name|cmd
decl_stmt|;
name|caddr_t
name|addr
decl_stmt|;
name|int
name|flag
decl_stmt|;
name|struct
name|proc
modifier|*
name|p
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|int
name|s
decl_stmt|,
name|error
init|=
name|ENOTTY
decl_stmt|;
name|slp
operator|=
operator|(
expr|struct
name|scsi_low_softc
operator|*
operator|)
name|link
operator|->
name|adapter_softc
expr_stmt|;
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_flags
operator|&
name|HW_INACTIVE
operator|)
operator|!=
literal|0
condition|)
return|return
name|ENXIO
return|;
if|if
condition|(
name|cmd
operator|==
name|SCBUSIORESET
condition|)
block|{
name|s
operator|=
name|SCSI_LOW_SPLSCSI
argument_list|()
expr_stmt|;
name|scsi_low_restart
argument_list|(
name|slp
argument_list|,
name|SCSI_LOW_RESTART_HARD
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_ioctl
operator|!=
literal|0
condition|)
block|{
name|error
operator|=
call|(
modifier|*
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_ioctl
call|)
argument_list|(
name|slp
argument_list|,
name|cmd
argument_list|,
name|addr
argument_list|,
name|flag
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_enable_xs
parameter_list|(
name|arg
parameter_list|,
name|enable
parameter_list|)
name|void
modifier|*
name|arg
decl_stmt|;
name|int
name|enable
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
name|arg
decl_stmt|;
if|if
condition|(
name|enable
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_flags
operator|&
name|HW_INACTIVE
operator|)
operator|!=
literal|0
condition|)
return|return
name|ENXIO
return|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_flags
operator|&
name|HW_INACTIVE
operator|)
operator|!=
literal|0
operator|||
operator|(
name|slp
operator|->
name|sl_flags
operator|&
name|HW_POWERCTRL
operator|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|slp
operator|->
name|sl_flags
operator||=
name|HW_POWDOWN
expr_stmt|;
if|if
condition|(
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_power
operator|!=
name|NULL
condition|)
block|{
call|(
modifier|*
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_power
call|)
argument_list|(
name|slp
argument_list|,
name|SCSI_LOW_POWDOWN
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|scsi_low_scsi_minphys_xs
parameter_list|(
name|bp
parameter_list|)
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
block|{
if|if
condition|(
name|bp
operator|->
name|b_bcount
operator|>
name|SCSI_LOW_MINPHYS
condition|)
name|bp
operator|->
name|b_bcount
operator|=
name|SCSI_LOW_MINPHYS
expr_stmt|;
name|minphys
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_poll_xs
parameter_list|(
name|slp
parameter_list|,
name|cb
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
block|{
name|struct
name|scsipi_xfer
modifier|*
name|xs
init|=
name|cb
operator|->
name|osdep
decl_stmt|;
name|int
name|tcount
decl_stmt|;
name|cb
operator|->
name|ccb_flags
operator||=
name|CCB_NOSDONE
expr_stmt|;
name|tcount
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|slp
operator|->
name|sl_nio
operator|>
literal|0
condition|)
block|{
name|SCSI_LOW_DELAY
argument_list|(
operator|(
literal|1000
operator|*
literal|1000
operator|)
operator|/
name|SCSI_LOW_XS_POLL_HZ
argument_list|)
expr_stmt|;
call|(
modifier|*
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_poll
call|)
argument_list|(
name|slp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_flags
operator|&
operator|(
name|HW_INACTIVE
operator||
name|HW_INITIALIZING
operator|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|cb
operator|->
name|ccb_flags
operator||=
name|CCB_NORETRY
expr_stmt|;
name|cb
operator|->
name|ccb_error
operator||=
name|FATALIO
expr_stmt|;
operator|(
name|void
operator|)
name|scsi_low_revoke_ccb
argument_list|(
name|slp
argument_list|,
name|cb
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s: hardware inactive in poll mode\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|xs
operator|->
name|flags
operator|&
name|ITSDONE
operator|)
operator|!=
literal|0
condition|)
break|break;
if|if
condition|(
name|tcount
operator|++
operator|<
name|SCSI_LOW_XS_POLL_HZ
operator|/
name|SCSI_LOW_TIMEOUT_HZ
condition|)
continue|continue;
name|tcount
operator|=
literal|0
expr_stmt|;
name|scsi_low_timeout_check
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
name|xs
operator|->
name|flags
operator||=
name|ITSDONE
expr_stmt|;
name|scsipi_done
argument_list|(
name|xs
argument_list|)
expr_stmt|;
return|return
name|COMPLETE
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_scsi_cmd_xs
parameter_list|(
name|xs
parameter_list|)
name|struct
name|scsipi_xfer
modifier|*
name|xs
decl_stmt|;
block|{
name|struct
name|scsipi_link
modifier|*
name|splp
init|=
name|xs
operator|->
name|sc_link
decl_stmt|;
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
name|splp
operator|->
name|adapter_softc
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
name|int
name|s
decl_stmt|,
name|targ
decl_stmt|,
name|lun
decl_stmt|,
name|flags
decl_stmt|,
name|rv
decl_stmt|;
if|if
condition|(
operator|(
name|cb
operator|=
name|SCSI_LOW_ALLOC_CCB
argument_list|(
name|xs
operator|->
name|flags
operator|&
name|SCSI_NOSLEEP
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|TRY_AGAIN_LATER
return|;
name|targ
operator|=
name|splp
operator|->
name|scsipi_scsi
operator|.
name|target
operator|,
name|lun
operator|=
name|splp
operator|->
name|scsipi_scsi
operator|.
name|lun
expr_stmt|;
name|ti
operator|=
name|slp
operator|->
name|sl_ti
index|[
name|targ
index|]
expr_stmt|;
name|cb
operator|->
name|osdep
operator|=
name|xs
expr_stmt|;
name|cb
operator|->
name|bp
operator|=
name|xs
operator|->
name|bp
expr_stmt|;
if|if
condition|(
operator|(
name|xs
operator|->
name|flags
operator|&
name|SCSI_POLL
operator|)
operator|==
literal|0
condition|)
name|flags
operator|=
name|CCB_AUTOSENSE
expr_stmt|;
else|else
name|flags
operator|=
name|CCB_AUTOSENSE
operator||
name|CCB_POLLED
expr_stmt|;
name|s
operator|=
name|SCSI_LOW_SPLSCSI
argument_list|()
expr_stmt|;
name|li
operator|=
name|scsi_low_alloc_li
argument_list|(
name|ti
argument_list|,
name|lun
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|u_int
operator|)
name|splp
operator|->
name|quirks
operator|!=
name|li
operator|->
name|li_sloi
operator|.
name|sloi_quirks
condition|)
block|{
name|scsi_low_setup_quirks_xs
argument_list|(
name|ti
argument_list|,
name|li
argument_list|,
operator|(
name|u_int
operator|)
name|splp
operator|->
name|quirks
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|xs
operator|->
name|flags
operator|&
name|SCSI_RESET
operator|)
operator|!=
literal|0
condition|)
block|{
name|flags
operator||=
name|CCB_NORETRY
operator||
name|CCB_URGENT
expr_stmt|;
name|scsi_low_enqueue
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|li
argument_list|,
name|cb
argument_list|,
name|flags
argument_list|,
name|SCSI_LOW_MSG_RESET
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ti
operator|->
name|ti_setup_msg
operator|!=
literal|0
condition|)
block|{
name|scsi_low_message_enqueue
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|li
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
name|flags
operator||=
name|CCB_SCSIIO
expr_stmt|;
name|scsi_low_enqueue
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|li
argument_list|,
name|cb
argument_list|,
name|flags
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|SCSI_LOW_DEBUG
if|if
condition|(
name|SCSI_LOW_DEBUG_TEST_GO
argument_list|(
name|SCSI_LOW_ABORT_CHECK
argument_list|,
name|ti
operator|->
name|ti_id
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|scsi_low_test_abort
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|li
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_DEBUG */
if|if
condition|(
operator|(
name|cb
operator|->
name|ccb_flags
operator|&
name|CCB_POLLED
operator|)
operator|!=
literal|0
condition|)
block|{
name|rv
operator|=
name|scsi_low_poll_xs
argument_list|(
name|slp
argument_list|,
name|cb
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rv
operator|=
name|SUCCESSFULLY_QUEUED
expr_stmt|;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|rv
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_attach_xs
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|struct
name|scsipi_adapter
modifier|*
name|sap
decl_stmt|;
name|struct
name|scsipi_link
modifier|*
name|splp
decl_stmt|;
name|strncpy
argument_list|(
name|slp
operator|->
name|sl_xname
argument_list|,
name|slp
operator|->
name|sl_dev
operator|.
name|dv_xname
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|sap
operator|=
name|SCSI_LOW_MALLOC
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|sap
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sap
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|splp
operator|=
name|SCSI_LOW_MALLOC
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|splp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|splp
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|SCSI_LOW_BZERO
argument_list|(
name|sap
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sap
argument_list|)
argument_list|)
expr_stmt|;
name|SCSI_LOW_BZERO
argument_list|(
name|splp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|splp
argument_list|)
argument_list|)
expr_stmt|;
name|sap
operator|->
name|scsipi_cmd
operator|=
name|scsi_low_scsi_cmd_xs
expr_stmt|;
name|sap
operator|->
name|scsipi_minphys
operator|=
name|scsi_low_scsi_minphys_xs
expr_stmt|;
name|sap
operator|->
name|scsipi_enable
operator|=
name|scsi_low_enable_xs
expr_stmt|;
name|sap
operator|->
name|scsipi_ioctl
operator|=
name|scsi_low_ioctl_xs
expr_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_TARGET_OPEN
name|sap
operator|->
name|open_target_lu
operator|=
name|scsi_low_target_open
expr_stmt|;
endif|#
directive|endif
comment|/* SCSI_LOW_TARGET_OPEN */
name|splp
operator|->
name|adapter_softc
operator|=
name|slp
expr_stmt|;
name|splp
operator|->
name|scsipi_scsi
operator|.
name|adapter_target
operator|=
name|slp
operator|->
name|sl_hostid
expr_stmt|;
name|splp
operator|->
name|scsipi_scsi
operator|.
name|max_target
operator|=
name|slp
operator|->
name|sl_ntargs
operator|-
literal|1
expr_stmt|;
name|splp
operator|->
name|scsipi_scsi
operator|.
name|max_lun
operator|=
name|slp
operator|->
name|sl_nluns
operator|-
literal|1
expr_stmt|;
name|splp
operator|->
name|scsipi_scsi
operator|.
name|channel
operator|=
name|SCSI_CHANNEL_ONLY_ONE
expr_stmt|;
name|splp
operator|->
name|openings
operator|=
name|slp
operator|->
name|sl_openings
expr_stmt|;
name|splp
operator|->
name|type
operator|=
name|BUS_SCSI
expr_stmt|;
name|splp
operator|->
name|adapter_softc
operator|=
name|slp
expr_stmt|;
name|splp
operator|->
name|adapter
operator|=
name|sap
expr_stmt|;
name|splp
operator|->
name|device
operator|=
operator|&
name|scsi_low_dev
expr_stmt|;
name|slp
operator|->
name|sl_si
operator|.
name|si_splp
operator|=
name|splp
expr_stmt|;
name|slp
operator|->
name|sl_show_result
operator|=
name|SHOW_ALL_NEG
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_world_start_xs
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_dettach_xs
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
comment|/* 	 * scsipi does not have dettach bus fucntion. 	 * 	scsipi_dettach_scsibus(slp->sl_si.si_splp); 	*/
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_ccb_setup_xs
parameter_list|(
name|slp
parameter_list|,
name|cb
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
block|{
name|struct
name|scsipi_xfer
modifier|*
name|xs
init|=
operator|(
expr|struct
name|scsipi_xfer
operator|*
operator|)
name|cb
operator|->
name|osdep
decl_stmt|;
if|if
condition|(
operator|(
name|cb
operator|->
name|ccb_flags
operator|&
name|CCB_SCSIIO
operator|)
operator|!=
literal|0
condition|)
block|{
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_cmd
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
name|xs
operator|->
name|cmd
expr_stmt|;
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_cmdlen
operator|=
name|xs
operator|->
name|cmdlen
expr_stmt|;
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_data
operator|=
name|xs
operator|->
name|data
expr_stmt|;
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_datalen
operator|=
name|xs
operator|->
name|datalen
expr_stmt|;
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_direction
operator|=
operator|(
name|xs
operator|->
name|flags
operator|&
name|SCSI_DATA_OUT
operator|)
condition|?
name|SCSI_LOW_WRITE
else|:
name|SCSI_LOW_READ
expr_stmt|;
name|cb
operator|->
name|ccb_tcmax
operator|=
name|xs
operator|->
name|timeout
operator|/
literal|1000
expr_stmt|;
block|}
else|else
block|{
name|scsi_low_unit_ready_cmd
argument_list|(
name|cb
argument_list|)
expr_stmt|;
block|}
return|return
name|SCSI_LOW_START_QTAG
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_done_xs
parameter_list|(
name|slp
parameter_list|,
name|cb
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
block|{
name|struct
name|scsipi_xfer
modifier|*
name|xs
decl_stmt|;
name|xs
operator|=
operator|(
expr|struct
name|scsipi_xfer
operator|*
operator|)
name|cb
operator|->
name|osdep
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|ccb_error
operator|==
literal|0
condition|)
block|{
name|xs
operator|->
name|error
operator|=
name|XS_NOERROR
expr_stmt|;
name|xs
operator|->
name|resid
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|cb
operator|->
name|ccb_rcnt
operator|>=
name|slp
operator|->
name|sl_max_retry
condition|)
name|cb
operator|->
name|ccb_error
operator||=
name|ABORTIO
expr_stmt|;
if|if
condition|(
operator|(
name|cb
operator|->
name|ccb_flags
operator|&
name|CCB_NORETRY
operator|)
operator|==
literal|0
operator|&&
operator|(
name|cb
operator|->
name|ccb_error
operator|&
name|ABORTIO
operator|)
operator|==
literal|0
condition|)
return|return
name|EJUSTRETURN
return|;
if|if
condition|(
operator|(
name|cb
operator|->
name|ccb_error
operator|&
name|SENSEIO
operator|)
operator|!=
literal|0
condition|)
block|{
name|xs
operator|->
name|sense
operator|.
name|scsi_sense
operator|=
name|cb
operator|->
name|ccb_sense
expr_stmt|;
block|}
name|xs
operator|->
name|error
operator|=
name|scsi_low_translate_error_code
argument_list|(
name|cb
argument_list|,
operator|&
name|scsi_low_error_code_xs
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_DIAGNOSTIC
if|if
condition|(
operator|(
name|cb
operator|->
name|ccb_flags
operator|&
name|CCB_SILENT
operator|)
operator|==
literal|0
operator|&&
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_cmdlen
operator|>
literal|0
operator|&&
operator|(
name|scsi_low_cmd_flags
index|[
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_cmd
index|[
literal|0
index|]
index|]
operator|&
name|SCSI_LOW_CMD_ABORT_WARNING
operator|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: WARNING: scsi_low IO abort\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
name|scsi_low_print
argument_list|(
name|slp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_DIAGNOSTIC */
block|}
if|if
condition|(
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_status
operator|==
name|ST_UNKNOWN
condition|)
name|xs
operator|->
name|status
operator|=
literal|0
expr_stmt|;
comment|/* XXX */
else|else
name|xs
operator|->
name|status
operator|=
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_status
expr_stmt|;
name|xs
operator|->
name|flags
operator||=
name|ITSDONE
expr_stmt|;
if|if
condition|(
operator|(
name|cb
operator|->
name|ccb_flags
operator|&
name|CCB_NOSDONE
operator|)
operator|==
literal|0
condition|)
name|scsipi_done
argument_list|(
name|xs
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|scsi_low_timeout_xs
parameter_list|(
name|slp
parameter_list|,
name|ch
parameter_list|,
name|action
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|int
name|ch
decl_stmt|;
name|int
name|action
decl_stmt|;
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
name|SCSI_LOW_TIMEOUT_CH_IO
case|:
switch|switch
condition|(
name|action
condition|)
block|{
case|case
name|SCSI_LOW_TIMEOUT_START
case|:
name|timeout
argument_list|(
name|scsi_low_timeout
argument_list|,
name|slp
argument_list|,
name|hz
operator|/
name|SCSI_LOW_TIMEOUT_HZ
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSI_LOW_TIMEOUT_STOP
case|:
name|untimeout
argument_list|(
name|scsi_low_timeout
argument_list|,
name|slp
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|SCSI_LOW_TIMEOUT_CH_ENGAGE
case|:
switch|switch
condition|(
name|action
condition|)
block|{
case|case
name|SCSI_LOW_TIMEOUT_START
case|:
name|timeout
argument_list|(
name|scsi_low_engage
argument_list|,
name|slp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSI_LOW_TIMEOUT_STOP
case|:
name|untimeout
argument_list|(
name|scsi_low_engage
argument_list|,
name|slp
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|SCSI_LOW_TIMEOUT_CH_RECOVER
case|:
break|break;
block|}
block|}
end_function

begin_function
name|u_int
name|scsi_low_translate_quirks_xs
parameter_list|(
name|quirks
parameter_list|)
name|u_int
name|quirks
decl_stmt|;
block|{
name|u_int
name|flags
decl_stmt|;
name|flags
operator|=
name|SCSI_LOW_DISK_LFLAGS
operator||
name|SCSI_LOW_DISK_TFLAGS
expr_stmt|;
ifdef|#
directive|ifdef
name|SDEV_NODISC
if|if
condition|(
name|quirks
operator|&
name|SDEV_NODISC
condition|)
name|flags
operator|&=
operator|~
name|SCSI_LOW_DISK_DISC
expr_stmt|;
endif|#
directive|endif
comment|/* SDEV_NODISC */
ifdef|#
directive|ifdef
name|SDEV_NOPARITY
if|if
condition|(
name|quirks
operator|&
name|SDEV_NOPARITY
condition|)
name|flags
operator|&=
operator|~
name|SCSI_LOW_DISK_PARITY
expr_stmt|;
endif|#
directive|endif
comment|/* SDEV_NOPARITY */
ifdef|#
directive|ifdef
name|SDEV_NOCMDLNK
if|if
condition|(
name|quirks
operator|&
name|SDEV_NOCMDLNK
condition|)
name|flags
operator|&=
operator|~
name|SCSI_LOW_DISK_LINK
expr_stmt|;
endif|#
directive|endif
comment|/* SDEV_NOCMDLNK */
ifdef|#
directive|ifdef
name|SDEV_NOTAG
if|if
condition|(
name|quirks
operator|&
name|SDEV_NOTAG
condition|)
name|flags
operator|&=
operator|~
name|SCSI_LOW_DISK_QTAG
expr_stmt|;
endif|#
directive|endif
comment|/* SDEV_NOTAG */
ifdef|#
directive|ifdef
name|SDEV_NOSYNC
if|if
condition|(
name|quirks
operator|&
name|SDEV_NOSYNC
condition|)
name|flags
operator|&=
operator|~
name|SCSI_LOW_DISK_SYNC
expr_stmt|;
endif|#
directive|endif
comment|/* SDEV_NOSYNC */
return|return
name|flags
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|scsi_low_setup_quirks_xs
parameter_list|(
name|ti
parameter_list|,
name|li
parameter_list|,
name|flags
parameter_list|)
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
name|u_int
name|flags
decl_stmt|;
block|{
name|u_int
name|quirks
decl_stmt|;
name|li
operator|->
name|li_sloi
operator|.
name|sloi_quirks
operator|=
name|flags
expr_stmt|;
name|quirks
operator|=
name|scsi_low_translate_quirks_xs
argument_list|(
name|flags
argument_list|)
expr_stmt|;
name|ti
operator|->
name|ti_quirks
operator|=
name|quirks
operator|&
name|SCSI_LOW_DISK_TFLAGS
expr_stmt|;
name|li
operator|->
name|li_quirks
operator|=
name|quirks
operator|&
name|SCSI_LOW_DISK_LFLAGS
expr_stmt|;
name|ti
operator|->
name|ti_flags_valid
operator||=
name|SCSI_LOW_TARG_FLAGS_QUIRKS_VALID
expr_stmt|;
name|li
operator|->
name|li_flags_valid
operator||=
name|SCSI_LOW_LUN_FLAGS_QUIRKS_VALID
expr_stmt|;
name|scsi_low_calcf_target
argument_list|(
name|ti
argument_list|)
expr_stmt|;
name|scsi_low_calcf_lun
argument_list|(
name|li
argument_list|)
expr_stmt|;
name|scsi_low_calcf_show
argument_list|(
name|li
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SCSI_LOW_TARGET_OPEN
end_ifdef

begin_function
specifier|static
name|int
name|scsi_low_target_open
parameter_list|(
name|link
parameter_list|,
name|cf
parameter_list|)
name|struct
name|scsipi_link
modifier|*
name|link
decl_stmt|;
name|struct
name|cfdata
modifier|*
name|cf
decl_stmt|;
block|{
name|u_int
name|target
init|=
name|link
operator|->
name|scsipi_scsi
operator|.
name|target
decl_stmt|;
name|u_int
name|lun
init|=
name|link
operator|->
name|scsipi_scsi
operator|.
name|lun
decl_stmt|;
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
name|slp
operator|=
operator|(
expr|struct
name|scsi_low_softc
operator|*
operator|)
name|link
operator|->
name|adapter_softc
expr_stmt|;
name|ti
operator|=
name|slp
operator|->
name|sl_ti
index|[
name|target
index|]
expr_stmt|;
name|li
operator|=
name|scsi_low_alloc_li
argument_list|(
name|ti
argument_list|,
name|lun
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|li
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|li
operator|->
name|li_cfgflags
operator|=
name|cf
operator|->
name|cf_flags
expr_stmt|;
name|scsi_low_setup_quirks_xs
argument_list|(
name|ti
argument_list|,
name|li
argument_list|,
operator|(
name|u_int
operator|)
name|link
operator|->
name|quirks
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SCSI_LOW_TARGET_OPEN */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SCSI_LOW_INTERFACE_XS */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|SCSI_LOW_INTERFACE_CAM
end_ifdef

begin_comment
comment|/**************************************************************  * SCSI INTERFACE (CAM)  **************************************************************/
end_comment

begin_define
define|#
directive|define
name|SCSI_LOW_MALLOC
parameter_list|(
name|size
parameter_list|)
value|malloc((size), M_SCSILOW, M_NOWAIT)
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_FREE
parameter_list|(
name|pt
parameter_list|)
value|free((pt), M_SCSILOW)
end_define

begin_define
define|#
directive|define
name|SCSI_LOW_ALLOC_CCB
parameter_list|(
name|flags
parameter_list|)
value|scsi_low_get_ccb()
end_define

begin_function_decl
specifier|static
name|void
name|scsi_low_poll_cam
parameter_list|(
name|struct
name|cam_sim
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scsi_low_cam_rescan_callback
parameter_list|(
name|struct
name|cam_periph
modifier|*
parameter_list|,
name|union
name|ccb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scsi_low_rescan_bus_cam
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|scsi_low_scsi_action_cam
parameter_list|(
name|struct
name|cam_sim
modifier|*
parameter_list|,
name|union
name|ccb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_attach_cam
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_world_start_cam
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_dettach_cam
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_ccb_setup_cam
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|struct
name|slccb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_done_cam
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|struct
name|slccb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scsi_low_timeout_cam
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|struct
name|scsi_low_osdep_funcs
name|scsi_low_osdep_funcs_cam
init|=
block|{
name|scsi_low_attach_cam
block|,
name|scsi_low_world_start_cam
block|,
name|scsi_low_dettach_cam
block|,
name|scsi_low_ccb_setup_cam
block|,
name|scsi_low_done_cam
block|,
name|scsi_low_timeout_cam
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|scsi_low_error_code
name|scsi_low_error_code_cam
index|[]
init|=
block|{
block|{
literal|0
block|,
name|CAM_REQ_CMP
block|}
block|,
block|{
name|SENSEIO
block|,
name|CAM_AUTOSNS_VALID
operator||
name|CAM_REQ_CMP_ERR
block|}
block|,
block|{
name|SENSEERR
block|,
name|CAM_AUTOSENSE_FAIL
block|}
block|,
block|{
name|UACAERR
block|,
name|CAM_SCSI_STATUS_ERROR
block|}
block|,
block|{
name|BUSYERR
operator||
name|STATERR
block|,
name|CAM_SCSI_STATUS_ERROR
block|}
block|,
block|{
name|SELTIMEOUTIO
block|,
name|CAM_SEL_TIMEOUT
block|}
block|,
block|{
name|TIMEOUTIO
block|,
name|CAM_CMD_TIMEOUT
block|}
block|,
block|{
name|PDMAERR
block|,
name|CAM_DATA_RUN_ERR
block|}
block|,
block|{
name|PARITYERR
block|,
name|CAM_UNCOR_PARITY
block|}
block|,
block|{
name|UBFERR
block|,
name|CAM_UNEXP_BUSFREE
block|}
block|,
block|{
name|ABORTIO
block|,
name|CAM_REQ_ABORTED
block|}
block|,
block|{
operator|-
literal|1
block|,
name|CAM_UNREC_HBA_ERROR
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|SIM2SLP
parameter_list|(
name|sim
parameter_list|)
value|((struct scsi_low_softc *) cam_sim_softc((sim)))
end_define

begin_comment
comment|/* XXX:  * Please check a polling hz, currently we assume scsi_low_poll() is  * called each 1 ms.  */
end_comment

begin_define
define|#
directive|define
name|SCSI_LOW_CAM_POLL_HZ
value|1000
end_define

begin_comment
comment|/* OK ? */
end_comment

begin_function
specifier|static
name|void
name|scsi_low_poll_cam
parameter_list|(
name|sim
parameter_list|)
name|struct
name|cam_sim
modifier|*
name|sim
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
name|SIM2SLP
argument_list|(
name|sim
argument_list|)
decl_stmt|;
call|(
modifier|*
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_poll
call|)
argument_list|(
name|slp
argument_list|)
expr_stmt|;
if|if
condition|(
name|slp
operator|->
name|sl_si
operator|.
name|si_poll_count
operator|++
operator|>=
name|SCSI_LOW_CAM_POLL_HZ
operator|/
name|SCSI_LOW_TIMEOUT_HZ
condition|)
block|{
name|slp
operator|->
name|sl_si
operator|.
name|si_poll_count
operator|=
literal|0
expr_stmt|;
name|scsi_low_timeout_check
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|scsi_low_cam_rescan_callback
parameter_list|(
name|periph
parameter_list|,
name|ccb
parameter_list|)
name|struct
name|cam_periph
modifier|*
name|periph
decl_stmt|;
name|union
name|ccb
modifier|*
name|ccb
decl_stmt|;
block|{
name|xpt_free_path
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|path
argument_list|)
expr_stmt|;
name|xpt_free_ccb
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|scsi_low_rescan_bus_cam
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|struct
name|cam_path
modifier|*
name|path
decl_stmt|;
name|union
name|ccb
modifier|*
name|ccb
init|=
name|xpt_alloc_ccb
argument_list|(
name|NULL
argument_list|)
decl_stmt|;
name|cam_status
name|status
decl_stmt|;
name|bzero
argument_list|(
name|ccb
argument_list|,
sizeof|sizeof
argument_list|(
expr|union
name|ccb
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|xpt_create_path
argument_list|(
operator|&
name|path
argument_list|,
name|xpt_periph
argument_list|,
name|cam_sim_path
argument_list|(
name|slp
operator|->
name|sl_si
operator|.
name|sim
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|CAM_REQ_CMP
condition|)
return|return;
name|xpt_setup_ccb
argument_list|(
operator|&
name|ccb
operator|->
name|ccb_h
argument_list|,
name|path
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
operator|=
name|XPT_SCAN_BUS
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|cbfcnp
operator|=
name|scsi_low_cam_rescan_callback
expr_stmt|;
name|ccb
operator|->
name|crcn
operator|.
name|flags
operator|=
name|CAM_FLAG_NONE
expr_stmt|;
name|xpt_action
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|scsi_low_scsi_action_cam
parameter_list|(
name|sim
parameter_list|,
name|ccb
parameter_list|)
name|struct
name|cam_sim
modifier|*
name|sim
decl_stmt|;
name|union
name|ccb
modifier|*
name|ccb
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
name|SIM2SLP
argument_list|(
name|sim
argument_list|)
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
name|u_int
name|lun
decl_stmt|,
name|flags
decl_stmt|,
name|msg
decl_stmt|,
name|target
decl_stmt|;
name|int
name|s
decl_stmt|,
name|rv
decl_stmt|;
name|target
operator|=
call|(
name|u_int
call|)
argument_list|(
name|ccb
operator|->
name|ccb_h
operator|.
name|target_id
argument_list|)
expr_stmt|;
name|lun
operator|=
operator|(
name|u_int
operator|)
name|ccb
operator|->
name|ccb_h
operator|.
name|target_lun
expr_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_DEBUG
if|if
condition|(
name|SCSI_LOW_DEBUG_GO
argument_list|(
name|SCSI_LOW_DEBUG_ACTION
argument_list|,
name|target
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: cam_action: func code 0x%x target: %d, lun: %d\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|,
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
argument_list|,
name|target
argument_list|,
name|lun
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_DEBUG */
switch|switch
condition|(
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
condition|)
block|{
case|case
name|XPT_SCSI_IO
case|:
comment|/* Execute the requested I/O operation */
ifdef|#
directive|ifdef
name|SCSI_LOW_DIAGNOSTIC
if|if
condition|(
name|target
operator|==
name|CAM_TARGET_WILDCARD
operator|||
name|lun
operator|==
name|CAM_LUN_WILDCARD
condition|)
block|{
name|printf
argument_list|(
literal|"%s: invalid target/lun\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_DIAGNOSTIC */
if|if
condition|(
operator|(
operator|(
name|cb
operator|=
name|SCSI_LOW_ALLOC_CCB
argument_list|(
literal|1
argument_list|)
operator|)
operator|==
name|NULL
operator|)
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_RESRC_UNAVAIL
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
return|return;
block|}
name|ti
operator|=
name|slp
operator|->
name|sl_ti
index|[
name|target
index|]
expr_stmt|;
name|cb
operator|->
name|osdep
operator|=
name|ccb
expr_stmt|;
name|cb
operator|->
name|bp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIS_AUTOSENSE
operator|)
operator|==
literal|0
condition|)
name|flags
operator|=
name|CCB_AUTOSENSE
operator||
name|CCB_SCSIIO
expr_stmt|;
else|else
name|flags
operator|=
name|CCB_SCSIIO
expr_stmt|;
name|s
operator|=
name|SCSI_LOW_SPLSCSI
argument_list|()
expr_stmt|;
name|li
operator|=
name|scsi_low_alloc_li
argument_list|(
name|ti
argument_list|,
name|lun
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ti
operator|->
name|ti_setup_msg
operator|!=
literal|0
condition|)
block|{
name|scsi_low_message_enqueue
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|li
argument_list|,
name|CCB_AUTOSENSE
argument_list|)
expr_stmt|;
block|}
name|scsi_low_enqueue
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|li
argument_list|,
name|cb
argument_list|,
name|flags
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_DEBUG
if|if
condition|(
name|SCSI_LOW_DEBUG_TEST_GO
argument_list|(
name|SCSI_LOW_ABORT_CHECK
argument_list|,
name|target
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|scsi_low_test_abort
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|li
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_DEBUG */
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
break|break;
case|case
name|XPT_EN_LUN
case|:
comment|/* Enable LUN as a target */
case|case
name|XPT_TARGET_IO
case|:
comment|/* Execute target I/O request */
case|case
name|XPT_ACCEPT_TARGET_IO
case|:
comment|/* Accept Host Target Mode CDB */
case|case
name|XPT_CONT_TARGET_IO
case|:
comment|/* Continue Host Target I/O Connection*/
comment|/* XXX Implement */
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
case|case
name|XPT_ABORT
case|:
comment|/* Abort the specified CCB */
ifdef|#
directive|ifdef
name|SCSI_LOW_DIAGNOSTIC
if|if
condition|(
name|target
operator|==
name|CAM_TARGET_WILDCARD
operator|||
name|lun
operator|==
name|CAM_LUN_WILDCARD
condition|)
block|{
name|printf
argument_list|(
literal|"%s: invalid target/lun\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_DIAGNOSTIC */
name|s
operator|=
name|SCSI_LOW_SPLSCSI
argument_list|()
expr_stmt|;
name|cb
operator|=
name|scsi_low_find_ccb
argument_list|(
name|slp
argument_list|,
name|target
argument_list|,
name|lun
argument_list|,
name|ccb
operator|->
name|cab
operator|.
name|abort_ccb
argument_list|)
expr_stmt|;
name|rv
operator|=
name|scsi_low_abort_ccb
argument_list|(
name|slp
argument_list|,
name|cb
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|==
literal|0
condition|)
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
else|else
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
case|case
name|XPT_SET_TRAN_SETTINGS
case|:
block|{
name|struct
name|ccb_trans_settings_scsi
modifier|*
name|scsi
decl_stmt|;
name|struct
name|ccb_trans_settings_spi
modifier|*
name|spi
decl_stmt|;
name|struct
name|ccb_trans_settings
modifier|*
name|cts
decl_stmt|;
name|u_int
name|val
decl_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_DIAGNOSTIC
if|if
condition|(
name|target
operator|==
name|CAM_TARGET_WILDCARD
condition|)
block|{
name|printf
argument_list|(
literal|"%s: invalid target\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_DIAGNOSTIC */
name|cts
operator|=
operator|&
name|ccb
operator|->
name|cts
expr_stmt|;
name|ti
operator|=
name|slp
operator|->
name|sl_ti
index|[
name|target
index|]
expr_stmt|;
if|if
condition|(
name|lun
operator|==
name|CAM_LUN_WILDCARD
condition|)
name|lun
operator|=
literal|0
expr_stmt|;
name|s
operator|=
name|SCSI_LOW_SPLSCSI
argument_list|()
expr_stmt|;
name|scsi
operator|=
operator|&
name|cts
operator|->
name|proto_specific
operator|.
name|scsi
expr_stmt|;
name|spi
operator|=
operator|&
name|cts
operator|->
name|xport_specific
operator|.
name|spi
expr_stmt|;
if|if
condition|(
operator|(
name|spi
operator|->
name|valid
operator|&
operator|(
name|CTS_SPI_VALID_BUS_WIDTH
operator||
name|CTS_SPI_VALID_SYNC_RATE
operator||
name|CTS_SPI_VALID_SYNC_OFFSET
operator|)
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|spi
operator|->
name|valid
operator|&
name|CTS_SPI_VALID_BUS_WIDTH
condition|)
block|{
name|val
operator|=
name|spi
operator|->
name|bus_width
expr_stmt|;
if|if
condition|(
name|val
operator|<
name|ti
operator|->
name|ti_width
condition|)
name|ti
operator|->
name|ti_width
operator|=
name|val
expr_stmt|;
block|}
if|if
condition|(
name|spi
operator|->
name|valid
operator|&
name|CTS_SPI_VALID_SYNC_RATE
condition|)
block|{
name|val
operator|=
name|spi
operator|->
name|sync_period
expr_stmt|;
if|if
condition|(
name|val
operator|==
literal|0
operator|||
name|val
operator|>
name|ti
operator|->
name|ti_maxsynch
operator|.
name|period
condition|)
name|ti
operator|->
name|ti_maxsynch
operator|.
name|period
operator|=
name|val
expr_stmt|;
block|}
if|if
condition|(
name|spi
operator|->
name|valid
operator|&
name|CTS_SPI_VALID_SYNC_OFFSET
condition|)
block|{
name|val
operator|=
name|spi
operator|->
name|sync_offset
expr_stmt|;
if|if
condition|(
name|val
operator|<
name|ti
operator|->
name|ti_maxsynch
operator|.
name|offset
condition|)
name|ti
operator|->
name|ti_maxsynch
operator|.
name|offset
operator|=
name|val
expr_stmt|;
block|}
name|ti
operator|->
name|ti_flags_valid
operator||=
name|SCSI_LOW_TARG_FLAGS_QUIRKS_VALID
expr_stmt|;
name|scsi_low_calcf_target
argument_list|(
name|ti
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|spi
operator|->
name|valid
operator|&
name|CTS_SPI_FLAGS_DISC_ENB
operator|)
operator|!=
literal|0
operator|||
operator|(
name|scsi
operator|->
name|flags
operator|&
name|CTS_SCSI_FLAGS_TAG_ENB
operator|)
operator|!=
literal|0
condition|)
block|{
name|li
operator|=
name|scsi_low_alloc_li
argument_list|(
name|ti
argument_list|,
name|lun
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|spi
operator|->
name|valid
operator|&
name|CTS_SPI_FLAGS_DISC_ENB
condition|)
block|{
name|li
operator|->
name|li_quirks
operator||=
name|SCSI_LOW_DISK_DISC
expr_stmt|;
block|}
else|else
block|{
name|li
operator|->
name|li_quirks
operator|&=
operator|~
name|SCSI_LOW_DISK_DISC
expr_stmt|;
block|}
if|if
condition|(
name|scsi
operator|->
name|flags
operator|&
name|CTS_SCSI_FLAGS_TAG_ENB
condition|)
block|{
name|li
operator|->
name|li_quirks
operator||=
name|SCSI_LOW_DISK_QTAG
expr_stmt|;
block|}
else|else
block|{
name|li
operator|->
name|li_quirks
operator|&=
operator|~
name|SCSI_LOW_DISK_QTAG
expr_stmt|;
block|}
name|li
operator|->
name|li_flags_valid
operator||=
name|SCSI_LOW_LUN_FLAGS_QUIRKS_VALID
expr_stmt|;
name|scsi_low_calcf_target
argument_list|(
name|ti
argument_list|)
expr_stmt|;
name|scsi_low_calcf_lun
argument_list|(
name|li
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_show_result
operator|&
name|SHOW_CALCF_RES
operator|)
operator|!=
literal|0
condition|)
name|scsi_low_calcf_show
argument_list|(
name|li
argument_list|)
expr_stmt|;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|XPT_GET_TRAN_SETTINGS
case|:
block|{
name|struct
name|ccb_trans_settings
modifier|*
name|cts
decl_stmt|;
name|u_int
name|diskflags
decl_stmt|;
name|cts
operator|=
operator|&
name|ccb
operator|->
name|cts
expr_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_DIAGNOSTIC
if|if
condition|(
name|target
operator|==
name|CAM_TARGET_WILDCARD
condition|)
block|{
name|printf
argument_list|(
literal|"%s: invalid target\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_DIAGNOSTIC */
name|ti
operator|=
name|slp
operator|->
name|sl_ti
index|[
name|target
index|]
expr_stmt|;
if|if
condition|(
name|lun
operator|==
name|CAM_LUN_WILDCARD
condition|)
name|lun
operator|=
literal|0
expr_stmt|;
name|s
operator|=
name|SCSI_LOW_SPLSCSI
argument_list|()
expr_stmt|;
name|li
operator|=
name|scsi_low_alloc_li
argument_list|(
name|ti
argument_list|,
name|lun
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|li
operator|!=
name|NULL
operator|&&
name|cts
operator|->
name|type
operator|==
name|CTS_TYPE_CURRENT_SETTINGS
condition|)
block|{
name|struct
name|ccb_trans_settings_scsi
modifier|*
name|scsi
init|=
operator|&
name|cts
operator|->
name|proto_specific
operator|.
name|scsi
decl_stmt|;
name|struct
name|ccb_trans_settings_spi
modifier|*
name|spi
init|=
operator|&
name|cts
operator|->
name|xport_specific
operator|.
name|spi
decl_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_DIAGNOSTIC
if|if
condition|(
name|li
operator|->
name|li_flags_valid
operator|!=
name|SCSI_LOW_LUN_FLAGS_ALL_VALID
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_FUNC_NOTAVAIL
expr_stmt|;
name|printf
argument_list|(
literal|"%s: invalid GET_TRANS_CURRENT_SETTINGS call\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
goto|goto
name|settings_out
goto|;
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_DIAGNOSTIC */
name|cts
operator|->
name|protocol
operator|=
name|PROTO_SCSI
expr_stmt|;
name|cts
operator|->
name|protocol_version
operator|=
name|SCSI_REV_2
expr_stmt|;
name|cts
operator|->
name|transport
operator|=
name|XPORT_SPI
expr_stmt|;
name|cts
operator|->
name|transport_version
operator|=
literal|2
expr_stmt|;
name|scsi
operator|->
name|flags
operator|&=
operator|~
name|CTS_SCSI_FLAGS_TAG_ENB
expr_stmt|;
name|spi
operator|->
name|flags
operator|&=
operator|~
name|CTS_SPI_FLAGS_DISC_ENB
expr_stmt|;
name|diskflags
operator|=
name|li
operator|->
name|li_diskflags
operator|&
name|li
operator|->
name|li_cfgflags
expr_stmt|;
if|if
condition|(
name|diskflags
operator|&
name|SCSI_LOW_DISK_DISC
condition|)
name|spi
operator|->
name|flags
operator||=
name|CTS_SPI_FLAGS_DISC_ENB
expr_stmt|;
if|if
condition|(
name|diskflags
operator|&
name|SCSI_LOW_DISK_QTAG
condition|)
name|scsi
operator|->
name|flags
operator||=
name|CTS_SCSI_FLAGS_TAG_ENB
expr_stmt|;
name|spi
operator|->
name|sync_period
operator|=
name|ti
operator|->
name|ti_maxsynch
operator|.
name|period
expr_stmt|;
name|spi
operator|->
name|valid
operator||=
name|CTS_SPI_VALID_SYNC_RATE
expr_stmt|;
name|spi
operator|->
name|sync_offset
operator|=
name|ti
operator|->
name|ti_maxsynch
operator|.
name|offset
expr_stmt|;
name|spi
operator|->
name|valid
operator||=
name|CTS_SPI_VALID_SYNC_OFFSET
expr_stmt|;
name|spi
operator|->
name|valid
operator||=
name|CTS_SPI_VALID_BUS_WIDTH
expr_stmt|;
name|spi
operator|->
name|bus_width
operator|=
name|ti
operator|->
name|ti_width
expr_stmt|;
if|if
condition|(
name|cts
operator|->
name|ccb_h
operator|.
name|target_lun
operator|!=
name|CAM_LUN_WILDCARD
condition|)
block|{
name|scsi
operator|->
name|valid
operator|=
name|CTS_SCSI_VALID_TQ
expr_stmt|;
name|spi
operator|->
name|valid
operator||=
name|CTS_SPI_VALID_DISC
expr_stmt|;
block|}
else|else
name|scsi
operator|->
name|valid
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_FUNC_NOTAVAIL
expr_stmt|;
name|settings_out
label|:
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|XPT_CALC_GEOMETRY
case|:
block|{
comment|/* not yet HN2 */
name|cam_calc_geometry
argument_list|(
operator|&
name|ccb
operator|->
name|ccg
argument_list|,
comment|/*extended*/
literal|1
argument_list|)
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|XPT_RESET_BUS
case|:
comment|/* Reset the specified SCSI bus */
name|s
operator|=
name|SCSI_LOW_SPLSCSI
argument_list|()
expr_stmt|;
name|scsi_low_restart
argument_list|(
name|slp
argument_list|,
name|SCSI_LOW_RESTART_HARD
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
case|case
name|XPT_TERM_IO
case|:
comment|/* Terminate the I/O process */
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
case|case
name|XPT_RESET_DEV
case|:
comment|/* Bus Device Reset the specified SCSI device */
ifdef|#
directive|ifdef
name|SCSI_LOW_DIAGNOSTIC
if|if
condition|(
name|target
operator|==
name|CAM_TARGET_WILDCARD
condition|)
block|{
name|printf
argument_list|(
literal|"%s: invalid target\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_DIAGNOSTIC */
name|msg
operator|=
name|SCSI_LOW_MSG_RESET
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|cb
operator|=
name|SCSI_LOW_ALLOC_CCB
argument_list|(
literal|1
argument_list|)
operator|)
operator|==
name|NULL
operator|)
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_RESRC_UNAVAIL
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
return|return;
block|}
name|ti
operator|=
name|slp
operator|->
name|sl_ti
index|[
name|target
index|]
expr_stmt|;
if|if
condition|(
name|lun
operator|==
name|CAM_LUN_WILDCARD
condition|)
name|lun
operator|=
literal|0
expr_stmt|;
name|cb
operator|->
name|osdep
operator|=
name|ccb
expr_stmt|;
name|cb
operator|->
name|bp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIS_AUTOSENSE
operator|)
operator|==
literal|0
condition|)
name|flags
operator|=
name|CCB_AUTOSENSE
operator||
name|CCB_NORETRY
operator||
name|CCB_URGENT
expr_stmt|;
else|else
name|flags
operator|=
name|CCB_NORETRY
operator||
name|CCB_URGENT
expr_stmt|;
name|s
operator|=
name|SCSI_LOW_SPLSCSI
argument_list|()
expr_stmt|;
name|li
operator|=
name|scsi_low_alloc_li
argument_list|(
name|ti
argument_list|,
name|lun
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|scsi_low_enqueue
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|li
argument_list|,
name|cb
argument_list|,
name|flags
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
break|break;
case|case
name|XPT_PATH_INQ
case|:
block|{
comment|/* Path routing inquiry */
name|struct
name|ccb_pathinq
modifier|*
name|cpi
init|=
operator|&
name|ccb
operator|->
name|cpi
decl_stmt|;
name|cpi
operator|->
name|version_num
operator|=
name|scsi_low_version_major
expr_stmt|;
name|cpi
operator|->
name|hba_inquiry
operator|=
name|PI_TAG_ABLE
operator||
name|PI_LINKED_CDB
expr_stmt|;
name|ti
operator|=
name|slp
operator|->
name|sl_ti
index|[
name|slp
operator|->
name|sl_hostid
index|]
expr_stmt|;
comment|/* host id */
if|if
condition|(
name|ti
operator|->
name|ti_width
operator|>
name|SCSI_LOW_BUS_WIDTH_8
condition|)
name|cpi
operator|->
name|hba_inquiry
operator||=
name|PI_WIDE_16
expr_stmt|;
if|if
condition|(
name|ti
operator|->
name|ti_width
operator|>
name|SCSI_LOW_BUS_WIDTH_16
condition|)
name|cpi
operator|->
name|hba_inquiry
operator||=
name|PI_WIDE_32
expr_stmt|;
if|if
condition|(
name|ti
operator|->
name|ti_maxsynch
operator|.
name|offset
operator|>
literal|0
condition|)
name|cpi
operator|->
name|hba_inquiry
operator||=
name|PI_SDTR_ABLE
expr_stmt|;
name|cpi
operator|->
name|target_sprt
operator|=
literal|0
expr_stmt|;
name|cpi
operator|->
name|hba_misc
operator|=
literal|0
expr_stmt|;
name|cpi
operator|->
name|hba_eng_cnt
operator|=
literal|0
expr_stmt|;
name|cpi
operator|->
name|max_target
operator|=
name|slp
operator|->
name|sl_ntargs
operator|-
literal|1
expr_stmt|;
name|cpi
operator|->
name|max_lun
operator|=
name|slp
operator|->
name|sl_nluns
operator|-
literal|1
expr_stmt|;
name|cpi
operator|->
name|initiator_id
operator|=
name|slp
operator|->
name|sl_hostid
expr_stmt|;
name|cpi
operator|->
name|bus_id
operator|=
name|cam_sim_bus
argument_list|(
name|sim
argument_list|)
expr_stmt|;
name|cpi
operator|->
name|base_transfer_speed
operator|=
literal|3300
expr_stmt|;
name|cpi
operator|->
name|transport
operator|=
name|XPORT_SPI
expr_stmt|;
name|cpi
operator|->
name|transport_version
operator|=
literal|2
expr_stmt|;
name|cpi
operator|->
name|protocol
operator|=
name|PROTO_SCSI
expr_stmt|;
name|cpi
operator|->
name|protocol_version
operator|=
name|SCSI_REV_2
expr_stmt|;
name|strncpy
argument_list|(
name|cpi
operator|->
name|sim_vid
argument_list|,
literal|"FreeBSD"
argument_list|,
name|SIM_IDLEN
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|cpi
operator|->
name|hba_vid
argument_list|,
literal|"SCSI_LOW"
argument_list|,
name|HBA_IDLEN
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|cpi
operator|->
name|dev_name
argument_list|,
name|cam_sim_name
argument_list|(
name|sim
argument_list|)
argument_list|,
name|DEV_IDLEN
argument_list|)
expr_stmt|;
name|cpi
operator|->
name|unit_number
operator|=
name|cam_sim_unit
argument_list|(
name|sim
argument_list|)
expr_stmt|;
name|cpi
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
name|printf
argument_list|(
literal|"scsi_low: non support func_code = %d "
argument_list|,
name|ccb
operator|->
name|ccb_h
operator|.
name|func_code
argument_list|)
expr_stmt|;
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_INVALID
expr_stmt|;
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_attach_cam
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|struct
name|cam_devq
modifier|*
name|devq
decl_stmt|;
name|int
name|tagged_openings
decl_stmt|;
name|sprintf
argument_list|(
name|slp
operator|->
name|sl_xname
argument_list|,
literal|"%s%d"
argument_list|,
name|DEVPORT_DEVNAME
argument_list|(
name|slp
operator|->
name|sl_dev
argument_list|)
argument_list|,
name|DEVPORT_DEVUNIT
argument_list|(
name|slp
operator|->
name|sl_dev
argument_list|)
argument_list|)
expr_stmt|;
name|devq
operator|=
name|cam_simq_alloc
argument_list|(
name|SCSI_LOW_NCCB
argument_list|)
expr_stmt|;
if|if
condition|(
name|devq
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
comment|/* 	 * ask the adapter what subunits are present 	 */
name|tagged_openings
operator|=
name|min
argument_list|(
name|slp
operator|->
name|sl_openings
argument_list|,
name|SCSI_LOW_MAXNEXUS
argument_list|)
expr_stmt|;
name|slp
operator|->
name|sl_si
operator|.
name|sim
operator|=
name|cam_sim_alloc
argument_list|(
name|scsi_low_scsi_action_cam
argument_list|,
name|scsi_low_poll_cam
argument_list|,
name|DEVPORT_DEVNAME
argument_list|(
name|slp
operator|->
name|sl_dev
argument_list|)
argument_list|,
name|slp
argument_list|,
name|DEVPORT_DEVUNIT
argument_list|(
name|slp
operator|->
name|sl_dev
argument_list|)
argument_list|,
operator|&
name|Giant
argument_list|,
name|slp
operator|->
name|sl_openings
argument_list|,
name|tagged_openings
argument_list|,
name|devq
argument_list|)
expr_stmt|;
if|if
condition|(
name|slp
operator|->
name|sl_si
operator|.
name|sim
operator|==
name|NULL
condition|)
block|{
name|cam_simq_free
argument_list|(
name|devq
argument_list|)
expr_stmt|;
return|return
name|ENODEV
return|;
block|}
if|if
condition|(
name|xpt_bus_register
argument_list|(
name|slp
operator|->
name|sl_si
operator|.
name|sim
argument_list|,
literal|0
argument_list|)
operator|!=
name|CAM_SUCCESS
condition|)
block|{
name|free
argument_list|(
name|slp
operator|->
name|sl_si
operator|.
name|sim
argument_list|,
name|M_SCSILOW
argument_list|)
expr_stmt|;
return|return
name|ENODEV
return|;
block|}
if|if
condition|(
name|xpt_create_path
argument_list|(
operator|&
name|slp
operator|->
name|sl_si
operator|.
name|path
argument_list|,
comment|/*periph*/
name|NULL
argument_list|,
name|cam_sim_path
argument_list|(
name|slp
operator|->
name|sl_si
operator|.
name|sim
argument_list|)
argument_list|,
name|CAM_TARGET_WILDCARD
argument_list|,
name|CAM_LUN_WILDCARD
argument_list|)
operator|!=
name|CAM_REQ_CMP
condition|)
block|{
name|xpt_bus_deregister
argument_list|(
name|cam_sim_path
argument_list|(
name|slp
operator|->
name|sl_si
operator|.
name|sim
argument_list|)
argument_list|)
expr_stmt|;
name|cam_sim_free
argument_list|(
name|slp
operator|->
name|sl_si
operator|.
name|sim
argument_list|,
comment|/*free_simq*/
name|TRUE
argument_list|)
expr_stmt|;
return|return
name|ENODEV
return|;
block|}
name|slp
operator|->
name|sl_show_result
operator|=
name|SHOW_CALCF_RES
expr_stmt|;
comment|/* OK ? */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_world_start_cam
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
if|if
condition|(
operator|!
name|cold
condition|)
name|scsi_low_rescan_bus_cam
argument_list|(
name|slp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_dettach_cam
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|xpt_async
argument_list|(
name|AC_LOST_DEVICE
argument_list|,
name|slp
operator|->
name|sl_si
operator|.
name|path
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|xpt_free_path
argument_list|(
name|slp
operator|->
name|sl_si
operator|.
name|path
argument_list|)
expr_stmt|;
name|xpt_bus_deregister
argument_list|(
name|cam_sim_path
argument_list|(
name|slp
operator|->
name|sl_si
operator|.
name|sim
argument_list|)
argument_list|)
expr_stmt|;
name|cam_sim_free
argument_list|(
name|slp
operator|->
name|sl_si
operator|.
name|sim
argument_list|,
comment|/* free_devq */
name|TRUE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_ccb_setup_cam
parameter_list|(
name|slp
parameter_list|,
name|cb
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
block|{
name|union
name|ccb
modifier|*
name|ccb
init|=
operator|(
expr|union
name|ccb
operator|*
operator|)
name|cb
operator|->
name|osdep
decl_stmt|;
if|if
condition|(
operator|(
name|cb
operator|->
name|ccb_flags
operator|&
name|CCB_SCSIIO
operator|)
operator|!=
literal|0
condition|)
block|{
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_cmd
operator|=
name|ccb
operator|->
name|csio
operator|.
name|cdb_io
operator|.
name|cdb_bytes
expr_stmt|;
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_cmdlen
operator|=
operator|(
name|int
operator|)
name|ccb
operator|->
name|csio
operator|.
name|cdb_len
expr_stmt|;
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_data
operator|=
name|ccb
operator|->
name|csio
operator|.
name|data_ptr
expr_stmt|;
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_datalen
operator|=
operator|(
name|int
operator|)
name|ccb
operator|->
name|csio
operator|.
name|dxfer_len
expr_stmt|;
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|flags
operator|&
name|CAM_DIR_MASK
operator|)
operator|==
name|CAM_DIR_OUT
condition|)
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_direction
operator|=
name|SCSI_LOW_WRITE
expr_stmt|;
else|else
comment|/* if((ccb->ccb_h.flags& CAM_DIR_MASK) == CAM_DIR_IN) */
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_direction
operator|=
name|SCSI_LOW_READ
expr_stmt|;
name|cb
operator|->
name|ccb_tcmax
operator|=
name|ccb
operator|->
name|ccb_h
operator|.
name|timeout
operator|/
literal|1000
expr_stmt|;
block|}
else|else
block|{
name|scsi_low_unit_ready_cmd
argument_list|(
name|cb
argument_list|)
expr_stmt|;
block|}
return|return
name|SCSI_LOW_START_QTAG
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_done_cam
parameter_list|(
name|slp
parameter_list|,
name|cb
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
block|{
name|union
name|ccb
modifier|*
name|ccb
decl_stmt|;
name|ccb
operator|=
operator|(
expr|union
name|ccb
operator|*
operator|)
name|cb
operator|->
name|osdep
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|ccb_error
operator|==
literal|0
condition|)
block|{
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|CAM_REQ_CMP
expr_stmt|;
name|ccb
operator|->
name|csio
operator|.
name|resid
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|cb
operator|->
name|ccb_rcnt
operator|>=
name|slp
operator|->
name|sl_max_retry
condition|)
name|cb
operator|->
name|ccb_error
operator||=
name|ABORTIO
expr_stmt|;
if|if
condition|(
operator|(
name|cb
operator|->
name|ccb_flags
operator|&
name|CCB_NORETRY
operator|)
operator|==
literal|0
operator|&&
operator|(
name|cb
operator|->
name|ccb_error
operator|&
name|ABORTIO
operator|)
operator|==
literal|0
condition|)
return|return
name|EJUSTRETURN
return|;
if|if
condition|(
operator|(
name|cb
operator|->
name|ccb_error
operator|&
name|SENSEIO
operator|)
operator|!=
literal|0
condition|)
block|{
name|memcpy
argument_list|(
operator|&
name|ccb
operator|->
name|csio
operator|.
name|sense_data
argument_list|,
operator|&
name|cb
operator|->
name|ccb_sense
argument_list|,
sizeof|sizeof
argument_list|(
name|ccb
operator|->
name|csio
operator|.
name|sense_data
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|=
name|scsi_low_translate_error_code
argument_list|(
name|cb
argument_list|,
operator|&
name|scsi_low_error_code_cam
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_DIAGNOSTIC
if|if
condition|(
operator|(
name|cb
operator|->
name|ccb_flags
operator|&
name|CCB_SILENT
operator|)
operator|==
literal|0
operator|&&
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_cmdlen
operator|>
literal|0
operator|&&
operator|(
name|scsi_low_cmd_flags
index|[
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_cmd
index|[
literal|0
index|]
index|]
operator|&
name|SCSI_LOW_CMD_ABORT_WARNING
operator|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: WARNING: scsi_low IO abort\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
name|scsi_low_print
argument_list|(
name|slp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_DIAGNOSTIC */
block|}
if|if
condition|(
operator|(
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator|&
name|CAM_STATUS_MASK
operator|)
operator|==
literal|0
condition|)
name|ccb
operator|->
name|ccb_h
operator|.
name|status
operator||=
name|CAM_REQ_CMP_ERR
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_status
operator|==
name|ST_UNKNOWN
condition|)
name|ccb
operator|->
name|csio
operator|.
name|scsi_status
operator|=
literal|0
expr_stmt|;
comment|/* XXX */
else|else
name|ccb
operator|->
name|csio
operator|.
name|scsi_status
operator|=
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_status
expr_stmt|;
if|if
condition|(
operator|(
name|cb
operator|->
name|ccb_flags
operator|&
name|CCB_NOSDONE
operator|)
operator|==
literal|0
condition|)
name|xpt_done
argument_list|(
name|ccb
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|scsi_low_timeout_cam
parameter_list|(
name|slp
parameter_list|,
name|ch
parameter_list|,
name|action
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|int
name|ch
decl_stmt|;
name|int
name|action
decl_stmt|;
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
name|SCSI_LOW_TIMEOUT_CH_IO
case|:
switch|switch
condition|(
name|action
condition|)
block|{
case|case
name|SCSI_LOW_TIMEOUT_START
case|:
name|slp
operator|->
name|sl_si
operator|.
name|timeout_ch
operator|=
name|timeout
argument_list|(
name|scsi_low_timeout
argument_list|,
name|slp
argument_list|,
name|hz
operator|/
name|SCSI_LOW_TIMEOUT_HZ
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSI_LOW_TIMEOUT_STOP
case|:
name|untimeout
argument_list|(
name|scsi_low_timeout
argument_list|,
name|slp
argument_list|,
name|slp
operator|->
name|sl_si
operator|.
name|timeout_ch
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|SCSI_LOW_TIMEOUT_CH_ENGAGE
case|:
switch|switch
condition|(
name|action
condition|)
block|{
case|case
name|SCSI_LOW_TIMEOUT_START
case|:
name|slp
operator|->
name|sl_si
operator|.
name|engage_ch
operator|=
name|timeout
argument_list|(
name|scsi_low_engage
argument_list|,
name|slp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSI_LOW_TIMEOUT_STOP
case|:
name|untimeout
argument_list|(
name|scsi_low_engage
argument_list|,
name|slp
argument_list|,
name|slp
operator|->
name|sl_si
operator|.
name|engage_ch
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|SCSI_LOW_TIMEOUT_CH_RECOVER
case|:
break|break;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SCSI_LOW_INTERFACE_CAM */
end_comment

begin_comment
comment|/*=============================================================  * END OF OS switch  (All OS depend fucntions should be above)  =============================================================*/
end_comment

begin_comment
comment|/**************************************************************  * scsi low deactivate and activate  **************************************************************/
end_comment

begin_function
name|int
name|scsi_low_is_busy
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
if|if
condition|(
name|slp
operator|->
name|sl_nio
operator|>
literal|0
condition|)
return|return
name|EBUSY
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|scsi_low_deactivate
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|int
name|s
decl_stmt|;
name|s
operator|=
name|SCSI_LOW_SPLSCSI
argument_list|()
expr_stmt|;
name|slp
operator|->
name|sl_flags
operator||=
name|HW_INACTIVE
expr_stmt|;
call|(
modifier|*
name|slp
operator|->
name|sl_osdep_fp
operator|->
name|scsi_low_osdep_timeout
call|)
argument_list|(
name|slp
argument_list|,
name|SCSI_LOW_TIMEOUT_CH_IO
argument_list|,
name|SCSI_LOW_TIMEOUT_STOP
argument_list|)
expr_stmt|;
call|(
modifier|*
name|slp
operator|->
name|sl_osdep_fp
operator|->
name|scsi_low_osdep_timeout
call|)
argument_list|(
name|slp
argument_list|,
name|SCSI_LOW_TIMEOUT_CH_ENGAGE
argument_list|,
name|SCSI_LOW_TIMEOUT_STOP
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|scsi_low_activate
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|int
name|error
decl_stmt|,
name|s
decl_stmt|;
name|s
operator|=
name|SCSI_LOW_SPLSCSI
argument_list|()
expr_stmt|;
name|slp
operator|->
name|sl_flags
operator|&=
operator|~
name|HW_INACTIVE
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|scsi_low_restart
argument_list|(
name|slp
argument_list|,
name|SCSI_LOW_RESTART_HARD
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|slp
operator|->
name|sl_flags
operator||=
name|HW_INACTIVE
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|slp
operator|->
name|sl_timeout_count
operator|=
literal|0
expr_stmt|;
call|(
modifier|*
name|slp
operator|->
name|sl_osdep_fp
operator|->
name|scsi_low_osdep_timeout
call|)
argument_list|(
name|slp
argument_list|,
name|SCSI_LOW_TIMEOUT_CH_IO
argument_list|,
name|SCSI_LOW_TIMEOUT_START
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**************************************************************  * scsi low log  **************************************************************/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|SCSI_LOW_DIAGNOSTIC
end_ifdef

begin_function_decl
specifier|static
name|void
name|scsi_low_msg_log_init
parameter_list|(
name|struct
name|scsi_low_msg_log
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scsi_low_msg_log_write
parameter_list|(
name|struct
name|scsi_low_msg_log
modifier|*
parameter_list|,
name|u_int8_t
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|scsi_low_msg_log_show
parameter_list|(
name|struct
name|scsi_low_msg_log
modifier|*
parameter_list|,
name|char
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|scsi_low_msg_log_init
parameter_list|(
name|slmlp
parameter_list|)
name|struct
name|scsi_low_msg_log
modifier|*
name|slmlp
decl_stmt|;
block|{
name|slmlp
operator|->
name|slml_ptr
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|scsi_low_msg_log_write
parameter_list|(
name|slmlp
parameter_list|,
name|datap
parameter_list|,
name|len
parameter_list|)
name|struct
name|scsi_low_msg_log
modifier|*
name|slmlp
decl_stmt|;
name|u_int8_t
modifier|*
name|datap
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
name|int
name|ptr
decl_stmt|,
name|ind
decl_stmt|;
if|if
condition|(
name|slmlp
operator|->
name|slml_ptr
operator|>=
name|SCSI_LOW_MSG_LOG_DATALEN
condition|)
return|return;
name|ptr
operator|=
name|slmlp
operator|->
name|slml_ptr
operator|++
expr_stmt|;
for|for
control|(
name|ind
operator|=
literal|0
init|;
name|ind
operator|<
sizeof|sizeof
argument_list|(
name|slmlp
operator|->
name|slml_msg
index|[
literal|0
index|]
argument_list|)
operator|&&
name|ind
operator|<
name|len
condition|;
name|ind
operator|++
control|)
name|slmlp
operator|->
name|slml_msg
index|[
name|ptr
index|]
operator|.
name|msg
index|[
name|ind
index|]
operator|=
name|datap
index|[
name|ind
index|]
expr_stmt|;
for|for
control|(
init|;
name|ind
operator|<
sizeof|sizeof
argument_list|(
name|slmlp
operator|->
name|slml_msg
index|[
literal|0
index|]
argument_list|)
condition|;
name|ind
operator|++
control|)
name|slmlp
operator|->
name|slml_msg
index|[
name|ptr
index|]
operator|.
name|msg
index|[
name|ind
index|]
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|scsi_low_msg_log_show
parameter_list|(
name|slmlp
parameter_list|,
name|s
parameter_list|,
name|len
parameter_list|)
name|struct
name|scsi_low_msg_log
modifier|*
name|slmlp
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
name|int
name|ptr
decl_stmt|,
name|ind
decl_stmt|;
name|printf
argument_list|(
literal|"%s: (%d) "
argument_list|,
name|s
argument_list|,
name|slmlp
operator|->
name|slml_ptr
argument_list|)
expr_stmt|;
for|for
control|(
name|ptr
operator|=
literal|0
init|;
name|ptr
operator|<
name|slmlp
operator|->
name|slml_ptr
condition|;
name|ptr
operator|++
control|)
block|{
for|for
control|(
name|ind
operator|=
literal|0
init|;
name|ind
operator|<
name|len
operator|&&
name|ind
operator|<
sizeof|sizeof
argument_list|(
name|slmlp
operator|->
name|slml_msg
index|[
literal|0
index|]
argument_list|)
condition|;
name|ind
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"[%x]"
argument_list|,
operator|(
name|u_int
operator|)
name|slmlp
operator|->
name|slml_msg
index|[
name|ptr
index|]
operator|.
name|msg
index|[
name|ind
index|]
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|">"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SCSI_LOW_DIAGNOSTIC */
end_comment

begin_comment
comment|/**************************************************************  * power control  **************************************************************/
end_comment

begin_function
specifier|static
name|void
name|scsi_low_engage
parameter_list|(
name|arg
parameter_list|)
name|void
modifier|*
name|arg
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
name|arg
decl_stmt|;
name|int
name|s
init|=
name|SCSI_LOW_SPLSCSI
argument_list|()
decl_stmt|;
switch|switch
condition|(
name|slp
operator|->
name|sl_rstep
condition|)
block|{
case|case
literal|0
case|:
name|slp
operator|->
name|sl_rstep
operator|++
expr_stmt|;
call|(
modifier|*
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_power
call|)
argument_list|(
name|slp
argument_list|,
name|SCSI_LOW_ENGAGE
argument_list|)
expr_stmt|;
call|(
modifier|*
name|slp
operator|->
name|sl_osdep_fp
operator|->
name|scsi_low_osdep_timeout
call|)
argument_list|(
name|slp
argument_list|,
name|SCSI_LOW_TIMEOUT_CH_ENGAGE
argument_list|,
name|SCSI_LOW_TIMEOUT_START
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|slp
operator|->
name|sl_rstep
operator|++
expr_stmt|;
name|slp
operator|->
name|sl_flags
operator|&=
operator|~
name|HW_RESUME
expr_stmt|;
name|scsi_low_start
argument_list|(
name|slp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
break|break;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_init
parameter_list|(
name|slp
parameter_list|,
name|flags
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|u_int
name|flags
decl_stmt|;
block|{
name|int
name|rv
init|=
literal|0
decl_stmt|;
name|slp
operator|->
name|sl_flags
operator||=
name|HW_INITIALIZING
expr_stmt|;
comment|/* clear power control timeout */
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_flags
operator|&
name|HW_POWERCTRL
operator|)
operator|!=
literal|0
condition|)
block|{
call|(
modifier|*
name|slp
operator|->
name|sl_osdep_fp
operator|->
name|scsi_low_osdep_timeout
call|)
argument_list|(
name|slp
argument_list|,
name|SCSI_LOW_TIMEOUT_CH_ENGAGE
argument_list|,
name|SCSI_LOW_TIMEOUT_STOP
argument_list|)
expr_stmt|;
name|slp
operator|->
name|sl_flags
operator|&=
operator|~
operator|(
name|HW_POWDOWN
operator||
name|HW_RESUME
operator|)
expr_stmt|;
name|slp
operator|->
name|sl_active
operator|=
literal|1
expr_stmt|;
name|slp
operator|->
name|sl_powc
operator|=
name|SCSI_LOW_POWDOWN_TC
expr_stmt|;
block|}
comment|/* reset current nexus */
name|scsi_low_reset_nexus
argument_list|(
name|slp
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_flags
operator|&
name|HW_INACTIVE
operator|)
operator|!=
literal|0
condition|)
block|{
name|rv
operator|=
name|EBUSY
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|flags
operator|!=
name|SCSI_LOW_RESTART_SOFT
condition|)
block|{
name|rv
operator|=
operator|(
call|(
modifier|*
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_init
call|)
argument_list|(
name|slp
argument_list|,
name|flags
argument_list|)
operator|)
expr_stmt|;
block|}
name|out
label|:
name|slp
operator|->
name|sl_flags
operator|&=
operator|~
name|HW_INITIALIZING
expr_stmt|;
return|return
name|rv
return|;
block|}
end_function

begin_comment
comment|/**************************************************************  * allocate lun_info  **************************************************************/
end_comment

begin_function
specifier|static
name|struct
name|lun_info
modifier|*
name|scsi_low_alloc_li
parameter_list|(
name|ti
parameter_list|,
name|lun
parameter_list|,
name|alloc
parameter_list|)
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|int
name|lun
decl_stmt|;
name|int
name|alloc
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
name|ti
operator|->
name|ti_sc
decl_stmt|;
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
name|li
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|ti
operator|->
name|ti_litab
argument_list|)
expr_stmt|;
if|if
condition|(
name|li
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|li
operator|->
name|li_lun
operator|==
name|lun
condition|)
return|return
name|li
return|;
while|while
condition|(
operator|(
name|li
operator|=
name|LIST_NEXT
argument_list|(
name|li
argument_list|,
name|lun_chain
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|li
operator|->
name|li_lun
operator|==
name|lun
condition|)
block|{
name|LIST_REMOVE
argument_list|(
name|li
argument_list|,
name|lun_chain
argument_list|)
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|ti
operator|->
name|ti_litab
argument_list|,
name|li
argument_list|,
name|lun_chain
argument_list|)
expr_stmt|;
return|return
name|li
return|;
block|}
block|}
block|}
if|if
condition|(
name|alloc
operator|==
literal|0
condition|)
return|return
name|li
return|;
name|li
operator|=
name|SCSI_LOW_MALLOC
argument_list|(
name|ti
operator|->
name|ti_lunsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|li
operator|==
name|NULL
condition|)
name|panic
argument_list|(
literal|"no lun info mem"
argument_list|)
expr_stmt|;
name|SCSI_LOW_BZERO
argument_list|(
name|li
argument_list|,
name|ti
operator|->
name|ti_lunsize
argument_list|)
expr_stmt|;
name|li
operator|->
name|li_lun
operator|=
name|lun
expr_stmt|;
name|li
operator|->
name|li_ti
operator|=
name|ti
expr_stmt|;
name|li
operator|->
name|li_cfgflags
operator|=
name|SCSI_LOW_SYNC
operator||
name|SCSI_LOW_LINK
operator||
name|SCSI_LOW_DISC
operator||
name|SCSI_LOW_QTAG
expr_stmt|;
name|li
operator|->
name|li_quirks
operator|=
name|li
operator|->
name|li_diskflags
operator|=
name|SCSI_LOW_DISK_LFLAGS
expr_stmt|;
name|li
operator|->
name|li_flags_valid
operator|=
name|SCSI_LOW_LUN_FLAGS_USER_VALID
expr_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_FLAGS_QUIRKS_OK
name|li
operator|->
name|li_flags_valid
operator||=
name|SCSI_LOW_LUN_FLAGS_QUIRKS_VALID
expr_stmt|;
endif|#
directive|endif
comment|/* SCSI_LOW_FLAGS_QUIRKS_OK */
name|li
operator|->
name|li_qtagbits
operator|=
operator|(
name|u_int
operator|)
operator|-
literal|1
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|li
operator|->
name|li_discq
argument_list|)
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|ti
operator|->
name|ti_litab
argument_list|,
name|li
argument_list|,
name|lun_chain
argument_list|)
expr_stmt|;
comment|/* host specific structure initialization per lun */
if|if
condition|(
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_lun_init
operator|!=
name|NULL
condition|)
call|(
modifier|*
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_lun_init
call|)
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|li
argument_list|,
name|SCSI_LOW_INFO_ALLOC
argument_list|)
expr_stmt|;
name|scsi_low_calcf_lun
argument_list|(
name|li
argument_list|)
expr_stmt|;
return|return
name|li
return|;
block|}
end_function

begin_comment
comment|/**************************************************************  * allocate targ_info  **************************************************************/
end_comment

begin_function
specifier|static
name|struct
name|targ_info
modifier|*
name|scsi_low_alloc_ti
parameter_list|(
name|slp
parameter_list|,
name|targ
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|int
name|targ
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
if|if
condition|(
name|TAILQ_FIRST
argument_list|(
operator|&
name|slp
operator|->
name|sl_titab
argument_list|)
operator|==
name|NULL
condition|)
name|TAILQ_INIT
argument_list|(
operator|&
name|slp
operator|->
name|sl_titab
argument_list|)
expr_stmt|;
name|ti
operator|=
name|SCSI_LOW_MALLOC
argument_list|(
name|slp
operator|->
name|sl_targsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|ti
operator|==
name|NULL
condition|)
name|panic
argument_list|(
literal|"%s short of memory"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
name|SCSI_LOW_BZERO
argument_list|(
name|ti
argument_list|,
name|slp
operator|->
name|sl_targsize
argument_list|)
expr_stmt|;
name|ti
operator|->
name|ti_id
operator|=
name|targ
expr_stmt|;
name|ti
operator|->
name|ti_sc
operator|=
name|slp
expr_stmt|;
name|slp
operator|->
name|sl_ti
index|[
name|targ
index|]
operator|=
name|ti
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|slp
operator|->
name|sl_titab
argument_list|,
name|ti
argument_list|,
name|ti_chain
argument_list|)
expr_stmt|;
name|LIST_INIT
argument_list|(
operator|&
name|ti
operator|->
name|ti_litab
argument_list|)
expr_stmt|;
name|ti
operator|->
name|ti_quirks
operator|=
name|ti
operator|->
name|ti_diskflags
operator|=
name|SCSI_LOW_DISK_TFLAGS
expr_stmt|;
name|ti
operator|->
name|ti_owidth
operator|=
name|SCSI_LOW_BUS_WIDTH_8
expr_stmt|;
name|ti
operator|->
name|ti_flags_valid
operator|=
name|SCSI_LOW_TARG_FLAGS_USER_VALID
expr_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_FLAGS_QUIRKS_OK
name|ti
operator|->
name|ti_flags_valid
operator||=
name|SCSI_LOW_TARG_FLAGS_QUIRKS_VALID
expr_stmt|;
endif|#
directive|endif
comment|/* SCSI_LOW_FLAGS_QUIRKS_OK */
if|if
condition|(
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_targ_init
operator|!=
name|NULL
condition|)
block|{
call|(
modifier|*
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_targ_init
call|)
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_INFO_ALLOC
argument_list|)
expr_stmt|;
block|}
name|scsi_low_calcf_target
argument_list|(
name|ti
argument_list|)
expr_stmt|;
return|return
name|ti
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|scsi_low_free_ti
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|,
modifier|*
name|tib
decl_stmt|;
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|,
modifier|*
name|nli
decl_stmt|;
for|for
control|(
name|ti
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|slp
operator|->
name|sl_titab
argument_list|)
init|;
name|ti
condition|;
name|ti
operator|=
name|tib
control|)
block|{
for|for
control|(
name|li
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|ti
operator|->
name|ti_litab
argument_list|)
init|;
name|li
operator|!=
name|NULL
condition|;
name|li
operator|=
name|nli
control|)
block|{
if|if
condition|(
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_lun_init
operator|!=
name|NULL
condition|)
block|{
call|(
modifier|*
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_lun_init
call|)
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|li
argument_list|,
name|SCSI_LOW_INFO_DEALLOC
argument_list|)
expr_stmt|;
block|}
name|nli
operator|=
name|LIST_NEXT
argument_list|(
name|li
argument_list|,
name|lun_chain
argument_list|)
expr_stmt|;
name|SCSI_LOW_FREE
argument_list|(
name|li
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_targ_init
operator|!=
name|NULL
condition|)
block|{
call|(
modifier|*
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_targ_init
call|)
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_INFO_DEALLOC
argument_list|)
expr_stmt|;
block|}
name|tib
operator|=
name|TAILQ_NEXT
argument_list|(
name|ti
argument_list|,
name|ti_chain
argument_list|)
expr_stmt|;
name|SCSI_LOW_FREE
argument_list|(
name|ti
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**************************************************************  * timeout  **************************************************************/
end_comment

begin_function
name|void
name|scsi_low_bus_idle
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|slp
operator|->
name|sl_retry_sel
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|slp
operator|->
name|sl_Tnexus
operator|==
name|NULL
condition|)
name|scsi_low_start
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|scsi_low_timeout
parameter_list|(
name|arg
parameter_list|)
name|void
modifier|*
name|arg
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
name|arg
decl_stmt|;
name|int
name|s
decl_stmt|;
name|s
operator|=
name|SCSI_LOW_SPLSCSI
argument_list|()
expr_stmt|;
operator|(
name|void
operator|)
name|scsi_low_timeout_check
argument_list|(
name|slp
argument_list|)
expr_stmt|;
call|(
modifier|*
name|slp
operator|->
name|sl_osdep_fp
operator|->
name|scsi_low_osdep_timeout
call|)
argument_list|(
name|slp
argument_list|,
name|SCSI_LOW_TIMEOUT_CH_IO
argument_list|,
name|SCSI_LOW_TIMEOUT_START
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_timeout_check
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
init|=
name|NULL
decl_stmt|;
comment|/* XXX */
comment|/* selection restart */
if|if
condition|(
name|slp
operator|->
name|sl_retry_sel
operator|!=
literal|0
condition|)
block|{
name|slp
operator|->
name|sl_retry_sel
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|slp
operator|->
name|sl_Tnexus
operator|!=
name|NULL
condition|)
goto|goto
name|step1
goto|;
name|cb
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|slp
operator|->
name|sl_start
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|==
name|NULL
condition|)
goto|goto
name|step1
goto|;
if|if
condition|(
name|cb
operator|->
name|ccb_selrcnt
operator|>=
name|SCSI_LOW_MAX_SELECTION_RETRY
condition|)
block|{
name|cb
operator|->
name|ccb_flags
operator||=
name|CCB_NORETRY
expr_stmt|;
name|cb
operator|->
name|ccb_error
operator||=
name|SELTIMEOUTIO
expr_stmt|;
if|if
condition|(
name|scsi_low_revoke_ccb
argument_list|(
name|slp
argument_list|,
name|cb
argument_list|,
literal|1
argument_list|)
operator|!=
name|NULL
condition|)
name|panic
argument_list|(
literal|"%s: ccb not finished"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|slp
operator|->
name|sl_Tnexus
operator|==
name|NULL
condition|)
name|scsi_low_start
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
comment|/* call hardware timeout */
name|step1
label|:
if|if
condition|(
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_timeout
operator|!=
name|NULL
condition|)
block|{
call|(
modifier|*
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_timeout
call|)
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|slp
operator|->
name|sl_timeout_count
operator|++
operator|<
name|SCSI_LOW_TIMEOUT_CHECK_INTERVAL
operator|*
name|SCSI_LOW_TIMEOUT_HZ
condition|)
return|return
literal|0
return|;
name|slp
operator|->
name|sl_timeout_count
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|slp
operator|->
name|sl_nio
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|cb
operator|=
name|slp
operator|->
name|sl_Qnexus
operator|)
operator|!=
name|NULL
condition|)
block|{
name|cb
operator|->
name|ccb_tc
operator|-=
name|SCSI_LOW_TIMEOUT_CHECK_INTERVAL
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|ccb_tc
operator|<
literal|0
condition|)
goto|goto
name|bus_reset
goto|;
block|}
elseif|else
if|if
condition|(
name|slp
operator|->
name|sl_disc
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|cb
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|slp
operator|->
name|sl_start
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|cb
operator|->
name|ccb_tc
operator|-=
name|SCSI_LOW_TIMEOUT_CHECK_INTERVAL
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|ccb_tc
operator|<
literal|0
condition|)
goto|goto
name|bus_reset
goto|;
block|}
else|else
for|for
control|(
name|ti
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|slp
operator|->
name|sl_titab
argument_list|)
init|;
name|ti
operator|!=
name|NULL
condition|;
name|ti
operator|=
name|TAILQ_NEXT
argument_list|(
name|ti
argument_list|,
name|ti_chain
argument_list|)
control|)
block|{
if|if
condition|(
name|ti
operator|->
name|ti_disc
operator|==
literal|0
condition|)
continue|continue;
for|for
control|(
name|li
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|ti
operator|->
name|ti_litab
argument_list|)
init|;
name|li
operator|!=
name|NULL
condition|;
name|li
operator|=
name|LIST_NEXT
argument_list|(
name|li
argument_list|,
name|lun_chain
argument_list|)
control|)
block|{
for|for
control|(
name|cb
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|li
operator|->
name|li_discq
argument_list|)
init|;
name|cb
operator|!=
name|NULL
condition|;
name|cb
operator|=
name|TAILQ_NEXT
argument_list|(
name|cb
argument_list|,
name|ccb_chain
argument_list|)
control|)
block|{
name|cb
operator|->
name|ccb_tc
operator|-=
name|SCSI_LOW_TIMEOUT_CHECK_INTERVAL
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|ccb_tc
operator|<
literal|0
condition|)
goto|goto
name|bus_reset
goto|;
block|}
block|}
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_flags
operator|&
name|HW_POWERCTRL
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_flags
operator|&
operator|(
name|HW_POWDOWN
operator||
name|HW_RESUME
operator|)
operator|)
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|slp
operator|->
name|sl_active
operator|!=
literal|0
condition|)
block|{
name|slp
operator|->
name|sl_powc
operator|=
name|SCSI_LOW_POWDOWN_TC
expr_stmt|;
name|slp
operator|->
name|sl_active
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
name|slp
operator|->
name|sl_powc
operator|--
expr_stmt|;
if|if
condition|(
name|slp
operator|->
name|sl_powc
operator|<
literal|0
condition|)
block|{
name|slp
operator|->
name|sl_powc
operator|=
name|SCSI_LOW_POWDOWN_TC
expr_stmt|;
name|slp
operator|->
name|sl_flags
operator||=
name|HW_POWDOWN
expr_stmt|;
call|(
modifier|*
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_power
call|)
argument_list|(
name|slp
argument_list|,
name|SCSI_LOW_POWDOWN
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
name|bus_reset
label|:
name|cb
operator|->
name|ccb_error
operator||=
name|TIMEOUTIO
expr_stmt|;
name|printf
argument_list|(
literal|"%s: slccb (0x%lx) timeout!\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|,
operator|(
name|u_long
operator|)
name|cb
argument_list|)
expr_stmt|;
name|scsi_low_info
argument_list|(
name|slp
argument_list|,
name|NULL
argument_list|,
literal|"scsi bus hangup. try to recover."
argument_list|)
expr_stmt|;
name|scsi_low_init
argument_list|(
name|slp
argument_list|,
name|SCSI_LOW_RESTART_HARD
argument_list|)
expr_stmt|;
name|scsi_low_start
argument_list|(
name|slp
argument_list|)
expr_stmt|;
return|return
name|ERESTART
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_abort_ccb
parameter_list|(
name|slp
parameter_list|,
name|cb
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
name|u_int
name|msg
decl_stmt|;
if|if
condition|(
name|cb
operator|==
name|NULL
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
operator|(
name|cb
operator|->
name|ccb_omsgoutflag
operator|&
operator|(
name|SCSI_LOW_MSG_ABORT
operator||
name|SCSI_LOW_MSG_ABORT_QTAG
operator|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|EBUSY
return|;
name|ti
operator|=
name|cb
operator|->
name|ti
expr_stmt|;
name|li
operator|=
name|cb
operator|->
name|li
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|ccb_tag
operator|==
name|SCSI_LOW_UNKTAG
condition|)
name|msg
operator|=
name|SCSI_LOW_MSG_ABORT
expr_stmt|;
else|else
name|msg
operator|=
name|SCSI_LOW_MSG_ABORT_QTAG
expr_stmt|;
name|cb
operator|->
name|ccb_error
operator||=
name|ABORTIO
expr_stmt|;
name|cb
operator|->
name|ccb_flags
operator||=
name|CCB_NORETRY
expr_stmt|;
name|scsi_low_ccb_message_assert
argument_list|(
name|cb
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|==
name|slp
operator|->
name|sl_Qnexus
condition|)
block|{
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|cb
operator|->
name|ccb_flags
operator|&
name|CCB_DISCQ
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|scsi_low_revoke_ccb
argument_list|(
name|slp
argument_list|,
name|cb
argument_list|,
literal|0
argument_list|)
operator|==
name|NULL
condition|)
name|panic
argument_list|(
literal|"%s: revoked ccb done"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
name|cb
operator|->
name|ccb_flags
operator||=
name|CCB_STARTQ
expr_stmt|;
name|TAILQ_INSERT_HEAD
argument_list|(
operator|&
name|slp
operator|->
name|sl_start
argument_list|,
name|cb
argument_list|,
name|ccb_chain
argument_list|)
expr_stmt|;
if|if
condition|(
name|slp
operator|->
name|sl_Tnexus
operator|==
name|NULL
condition|)
name|scsi_low_start
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|scsi_low_revoke_ccb
argument_list|(
name|slp
argument_list|,
name|cb
argument_list|,
literal|1
argument_list|)
operator|!=
name|NULL
condition|)
name|panic
argument_list|(
literal|"%s: revoked ccb retried"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**************************************************************  * Generic SCSI INTERFACE  **************************************************************/
end_comment

begin_function
name|int
name|scsi_low_attach
parameter_list|(
name|slp
parameter_list|,
name|openings
parameter_list|,
name|ntargs
parameter_list|,
name|nluns
parameter_list|,
name|targsize
parameter_list|,
name|lunsize
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|int
name|openings
decl_stmt|,
name|ntargs
decl_stmt|,
name|nluns
decl_stmt|,
name|targsize
decl_stmt|,
name|lunsize
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
name|int
name|s
decl_stmt|,
name|i
decl_stmt|,
name|nccb
decl_stmt|,
name|rv
decl_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_INTERFACE_XS
name|slp
operator|->
name|sl_osdep_fp
operator|=
operator|&
name|scsi_low_osdep_funcs_xs
expr_stmt|;
endif|#
directive|endif
comment|/* SCSI_LOW_INTERFACE_XS */
ifdef|#
directive|ifdef
name|SCSI_LOW_INTERFACE_CAM
name|slp
operator|->
name|sl_osdep_fp
operator|=
operator|&
name|scsi_low_osdep_funcs_cam
expr_stmt|;
endif|#
directive|endif
comment|/* SCSI_LOW_INTERFACE_CAM */
if|if
condition|(
name|slp
operator|->
name|sl_osdep_fp
operator|==
name|NULL
condition|)
name|panic
argument_list|(
literal|"scsi_low: interface not spcified"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntargs
operator|>
name|SCSI_LOW_NTARGETS
condition|)
block|{
name|printf
argument_list|(
literal|"scsi_low: %d targets are too large\n"
argument_list|,
name|ntargs
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"change kernel options SCSI_LOW_NTARGETS"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
if|if
condition|(
name|openings
operator|<=
literal|0
condition|)
name|slp
operator|->
name|sl_openings
operator|=
operator|(
name|SCSI_LOW_NCCB
operator|/
name|ntargs
operator|)
expr_stmt|;
else|else
name|slp
operator|->
name|sl_openings
operator|=
name|openings
expr_stmt|;
name|slp
operator|->
name|sl_ntargs
operator|=
name|ntargs
expr_stmt|;
name|slp
operator|->
name|sl_nluns
operator|=
name|nluns
expr_stmt|;
name|slp
operator|->
name|sl_max_retry
operator|=
name|SCSI_LOW_MAX_RETRY
expr_stmt|;
if|if
condition|(
name|lunsize
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|lun_info
argument_list|)
condition|)
name|lunsize
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|lun_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|targsize
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|targ_info
argument_list|)
condition|)
name|targsize
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|targ_info
argument_list|)
expr_stmt|;
name|slp
operator|->
name|sl_targsize
operator|=
name|targsize
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ntargs
condition|;
name|i
operator|++
control|)
block|{
name|ti
operator|=
name|scsi_low_alloc_ti
argument_list|(
name|slp
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|ti
operator|->
name|ti_lunsize
operator|=
name|lunsize
expr_stmt|;
name|li
operator|=
name|scsi_low_alloc_li
argument_list|(
name|ti
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* initialize queue */
name|nccb
operator|=
name|openings
operator|*
name|ntargs
expr_stmt|;
if|if
condition|(
name|nccb
operator|>=
name|SCSI_LOW_NCCB
operator|||
name|nccb
operator|<=
literal|0
condition|)
name|nccb
operator|=
name|SCSI_LOW_NCCB
expr_stmt|;
name|scsi_low_init_ccbque
argument_list|(
name|nccb
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|slp
operator|->
name|sl_start
argument_list|)
expr_stmt|;
comment|/* call os depend attach */
name|s
operator|=
name|SCSI_LOW_SPLSCSI
argument_list|()
expr_stmt|;
name|rv
operator|=
call|(
modifier|*
name|slp
operator|->
name|sl_osdep_fp
operator|->
name|scsi_low_osdep_attach
call|)
argument_list|(
name|slp
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s: scsi_low_attach: osdep attach failed\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
comment|/* check hardware */
name|SCSI_LOW_DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
comment|/* wait for 1ms */
if|if
condition|(
name|scsi_low_init
argument_list|(
name|slp
argument_list|,
name|SCSI_LOW_RESTART_HARD
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s: scsi_low_attach: initialization failed\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
comment|/* start watch dog */
name|slp
operator|->
name|sl_timeout_count
operator|=
literal|0
expr_stmt|;
call|(
modifier|*
name|slp
operator|->
name|sl_osdep_fp
operator|->
name|scsi_low_osdep_timeout
call|)
argument_list|(
name|slp
argument_list|,
name|SCSI_LOW_TIMEOUT_CH_IO
argument_list|,
name|SCSI_LOW_TIMEOUT_START
argument_list|)
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|sl_tab
argument_list|,
name|slp
argument_list|,
name|sl_chain
argument_list|)
expr_stmt|;
comment|/* fake call */
name|scsi_low_abort_ccb
argument_list|(
name|slp
argument_list|,
name|scsi_low_find_ccb
argument_list|(
name|slp
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_START_UP_CHECK
comment|/* probing devices */
name|scsi_low_start_up
argument_list|(
name|slp
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SCSI_LOW_START_UP_CHECK */
comment|/* call os depend attach done*/
call|(
modifier|*
name|slp
operator|->
name|sl_osdep_fp
operator|->
name|scsi_low_osdep_world_start
call|)
argument_list|(
name|slp
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|scsi_low_dettach
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|int
name|s
decl_stmt|,
name|rv
decl_stmt|;
name|s
operator|=
name|SCSI_LOW_SPLSCSI
argument_list|()
expr_stmt|;
if|if
condition|(
name|scsi_low_is_busy
argument_list|(
name|slp
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|EBUSY
return|;
block|}
name|scsi_low_deactivate
argument_list|(
name|slp
argument_list|)
expr_stmt|;
name|rv
operator|=
call|(
modifier|*
name|slp
operator|->
name|sl_osdep_fp
operator|->
name|scsi_low_osdep_dettach
call|)
argument_list|(
name|slp
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|EBUSY
return|;
block|}
name|scsi_low_free_ti
argument_list|(
name|slp
argument_list|)
expr_stmt|;
name|LIST_REMOVE
argument_list|(
name|slp
argument_list|,
name|sl_chain
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**************************************************************  * Generic enqueue  **************************************************************/
end_comment

begin_function
specifier|static
name|int
name|scsi_low_enqueue
parameter_list|(
name|slp
parameter_list|,
name|ti
parameter_list|,
name|li
parameter_list|,
name|cb
parameter_list|,
name|flags
parameter_list|,
name|msg
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
name|u_int
name|flags
decl_stmt|,
name|msg
decl_stmt|;
block|{
name|cb
operator|->
name|ti
operator|=
name|ti
expr_stmt|;
name|cb
operator|->
name|li
operator|=
name|li
expr_stmt|;
name|scsi_low_ccb_message_assert
argument_list|(
name|cb
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|cb
operator|->
name|ccb_otag
operator|=
name|cb
operator|->
name|ccb_tag
operator|=
name|SCSI_LOW_UNKTAG
expr_stmt|;
name|scsi_low_alloc_qtag
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|cb
operator|->
name|ccb_flags
operator|=
name|flags
operator||
name|CCB_STARTQ
expr_stmt|;
name|cb
operator|->
name|ccb_tc
operator|=
name|cb
operator|->
name|ccb_tcmax
operator|=
name|SCSI_LOW_MIN_TOUT
expr_stmt|;
name|cb
operator|->
name|ccb_error
operator||=
name|PENDINGIO
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|CCB_URGENT
operator|)
operator|!=
literal|0
condition|)
block|{
name|TAILQ_INSERT_HEAD
argument_list|(
operator|&
name|slp
operator|->
name|sl_start
argument_list|,
name|cb
argument_list|,
name|ccb_chain
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|slp
operator|->
name|sl_start
argument_list|,
name|cb
argument_list|,
name|ccb_chain
argument_list|)
expr_stmt|;
block|}
name|slp
operator|->
name|sl_nio
operator|++
expr_stmt|;
if|if
condition|(
name|slp
operator|->
name|sl_Tnexus
operator|==
name|NULL
condition|)
name|scsi_low_start
argument_list|(
name|slp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_message_enqueue
parameter_list|(
name|slp
parameter_list|,
name|ti
parameter_list|,
name|li
parameter_list|,
name|flags
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
name|u_int
name|flags
decl_stmt|;
block|{
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
name|u_int
name|tmsgflags
decl_stmt|;
name|tmsgflags
operator|=
name|ti
operator|->
name|ti_setup_msg
expr_stmt|;
name|ti
operator|->
name|ti_setup_msg
operator|=
literal|0
expr_stmt|;
name|flags
operator||=
name|CCB_NORETRY
expr_stmt|;
if|if
condition|(
operator|(
name|cb
operator|=
name|SCSI_LOW_ALLOC_CCB
argument_list|(
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|ENOMEM
return|;
name|cb
operator|->
name|osdep
operator|=
name|NULL
expr_stmt|;
name|cb
operator|->
name|bp
operator|=
name|NULL
expr_stmt|;
name|scsi_low_enqueue
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|li
argument_list|,
name|cb
argument_list|,
name|flags
argument_list|,
name|tmsgflags
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**************************************************************  * Generic Start& Done  **************************************************************/
end_comment

begin_define
define|#
directive|define
name|SLSC_MODE_SENSE_SHORT
value|0x1a
end_define

begin_decl_stmt
specifier|static
name|u_int8_t
name|ss_cmd
index|[
literal|6
index|]
init|=
block|{
name|START_STOP
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|SSS_START
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_int8_t
name|sms_cmd
index|[
literal|6
index|]
init|=
block|{
name|SLSC_MODE_SENSE_SHORT
block|,
literal|0x08
block|,
literal|0x0a
block|,
literal|0
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_low_mode_sense_data
argument_list|)
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_int8_t
name|inq_cmd
index|[
literal|6
index|]
init|=
block|{
name|INQUIRY
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_low_inq_data
argument_list|)
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_int8_t
name|unit_ready_cmd
index|[
literal|6
index|]
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|scsi_low_setup_start
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|struct
name|targ_info
modifier|*
parameter_list|,
name|struct
name|lun_info
modifier|*
parameter_list|,
name|struct
name|slccb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_sense_abort_start
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|struct
name|targ_info
modifier|*
parameter_list|,
name|struct
name|lun_info
modifier|*
parameter_list|,
name|struct
name|slccb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_resume
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|scsi_low_unit_ready_cmd
parameter_list|(
name|cb
parameter_list|)
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
block|{
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_cmd
operator|=
name|unit_ready_cmd
expr_stmt|;
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_cmdlen
operator|=
sizeof|sizeof
argument_list|(
name|unit_ready_cmd
argument_list|)
expr_stmt|;
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_datalen
operator|=
literal|0
expr_stmt|;
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_direction
operator|=
name|SCSI_LOW_READ
expr_stmt|;
name|cb
operator|->
name|ccb_tcmax
operator|=
literal|15
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_sense_abort_start
parameter_list|(
name|slp
parameter_list|,
name|ti
parameter_list|,
name|li
parameter_list|,
name|cb
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
block|{
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_cmdlen
operator|=
literal|6
expr_stmt|;
name|SCSI_LOW_BZERO
argument_list|(
name|cb
operator|->
name|ccb_scsi_cmd
argument_list|,
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_cmdlen
argument_list|)
expr_stmt|;
name|cb
operator|->
name|ccb_scsi_cmd
index|[
literal|0
index|]
operator|=
name|REQUEST_SENSE
expr_stmt|;
name|cb
operator|->
name|ccb_scsi_cmd
index|[
literal|4
index|]
operator|=
sizeof|sizeof
argument_list|(
name|cb
operator|->
name|ccb_sense
argument_list|)
expr_stmt|;
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_cmd
operator|=
name|cb
operator|->
name|ccb_scsi_cmd
expr_stmt|;
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_data
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|cb
operator|->
name|ccb_sense
expr_stmt|;
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_datalen
operator|=
sizeof|sizeof
argument_list|(
name|cb
operator|->
name|ccb_sense
argument_list|)
expr_stmt|;
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_direction
operator|=
name|SCSI_LOW_READ
expr_stmt|;
name|cb
operator|->
name|ccb_tcmax
operator|=
literal|15
expr_stmt|;
name|scsi_low_ccb_message_clear
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|cb
operator|->
name|ccb_flags
operator|&
name|CCB_CLEARQ
operator|)
operator|!=
literal|0
condition|)
block|{
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_MSG_ABORT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SCSI_LOW_BZERO
argument_list|(
operator|&
name|cb
operator|->
name|ccb_sense
argument_list|,
sizeof|sizeof
argument_list|(
name|cb
operator|->
name|ccb_sense
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_NEGOTIATE_BEFORE_SENSE
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|ti
operator|->
name|ti_setup_msg_done
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SCSI_LOW_NEGOTIATE_BEFORE_SENSE */
block|}
return|return
name|SCSI_LOW_START_NO_QTAG
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_setup_start
parameter_list|(
name|slp
parameter_list|,
name|ti
parameter_list|,
name|li
parameter_list|,
name|cb
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
block|{
switch|switch
condition|(
name|li
operator|->
name|li_state
condition|)
block|{
case|case
name|SCSI_LOW_LUN_SLEEP
case|:
name|scsi_low_unit_ready_cmd
argument_list|(
name|cb
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSI_LOW_LUN_START
case|:
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_cmd
operator|=
name|ss_cmd
expr_stmt|;
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_cmdlen
operator|=
sizeof|sizeof
argument_list|(
name|ss_cmd
argument_list|)
expr_stmt|;
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_datalen
operator|=
literal|0
expr_stmt|;
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_direction
operator|=
name|SCSI_LOW_READ
expr_stmt|;
name|cb
operator|->
name|ccb_tcmax
operator|=
literal|30
expr_stmt|;
break|break;
case|case
name|SCSI_LOW_LUN_INQ
case|:
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_cmd
operator|=
name|inq_cmd
expr_stmt|;
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_cmdlen
operator|=
sizeof|sizeof
argument_list|(
name|inq_cmd
argument_list|)
expr_stmt|;
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_data
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|li
operator|->
name|li_inq
expr_stmt|;
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_datalen
operator|=
sizeof|sizeof
argument_list|(
name|li
operator|->
name|li_inq
argument_list|)
expr_stmt|;
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_direction
operator|=
name|SCSI_LOW_READ
expr_stmt|;
name|cb
operator|->
name|ccb_tcmax
operator|=
literal|15
expr_stmt|;
break|break;
case|case
name|SCSI_LOW_LUN_MODEQ
case|:
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_cmd
operator|=
name|sms_cmd
expr_stmt|;
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_cmdlen
operator|=
sizeof|sizeof
argument_list|(
name|sms_cmd
argument_list|)
expr_stmt|;
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_data
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|li
operator|->
name|li_sms
expr_stmt|;
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_datalen
operator|=
sizeof|sizeof
argument_list|(
name|li
operator|->
name|li_sms
argument_list|)
expr_stmt|;
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_direction
operator|=
name|SCSI_LOW_READ
expr_stmt|;
name|cb
operator|->
name|ccb_tcmax
operator|=
literal|15
expr_stmt|;
return|return
name|SCSI_LOW_START_QTAG
return|;
default|default:
name|panic
argument_list|(
literal|"%s: no setup phase"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
block|}
return|return
name|SCSI_LOW_START_NO_QTAG
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_resume
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
if|if
condition|(
name|slp
operator|->
name|sl_flags
operator|&
name|HW_RESUME
condition|)
return|return
name|EJUSTRETURN
return|;
name|slp
operator|->
name|sl_flags
operator|&=
operator|~
name|HW_POWDOWN
expr_stmt|;
if|if
condition|(
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_power
operator|!=
name|NULL
condition|)
block|{
name|slp
operator|->
name|sl_flags
operator||=
name|HW_RESUME
expr_stmt|;
name|slp
operator|->
name|sl_rstep
operator|=
literal|0
expr_stmt|;
call|(
modifier|*
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_power
call|)
argument_list|(
name|slp
argument_list|,
name|SCSI_LOW_ENGAGE
argument_list|)
expr_stmt|;
call|(
modifier|*
name|slp
operator|->
name|sl_osdep_fp
operator|->
name|scsi_low_osdep_timeout
call|)
argument_list|(
name|slp
argument_list|,
name|SCSI_LOW_TIMEOUT_CH_ENGAGE
argument_list|,
name|SCSI_LOW_TIMEOUT_START
argument_list|)
expr_stmt|;
return|return
name|EJUSTRETURN
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|scsi_low_start
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
name|int
name|rv
decl_stmt|;
comment|/* check hardware exists or under initializations ? */
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_flags
operator|&
operator|(
name|HW_INACTIVE
operator||
name|HW_INITIALIZING
operator|)
operator|)
operator|!=
literal|0
condition|)
return|return;
comment|/* check hardware power up ? */
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_flags
operator|&
name|HW_POWERCTRL
operator|)
operator|!=
literal|0
condition|)
block|{
name|slp
operator|->
name|sl_active
operator|++
expr_stmt|;
if|if
condition|(
name|slp
operator|->
name|sl_flags
operator|&
operator|(
name|HW_POWDOWN
operator||
name|HW_RESUME
operator|)
condition|)
block|{
if|if
condition|(
name|scsi_low_resume
argument_list|(
name|slp
argument_list|)
operator|==
name|EJUSTRETURN
condition|)
return|return;
block|}
block|}
comment|/* setup nexus */
ifdef|#
directive|ifdef
name|SCSI_LOW_DIAGNOSTIC
if|if
condition|(
name|slp
operator|->
name|sl_Tnexus
operator|||
name|slp
operator|->
name|sl_Lnexus
operator|||
name|slp
operator|->
name|sl_Qnexus
condition|)
block|{
name|scsi_low_info
argument_list|(
name|slp
argument_list|,
name|NULL
argument_list|,
literal|"NEXUS INCOSISTENT"
argument_list|)
expr_stmt|;
name|panic
argument_list|(
literal|"%s: inconsistent"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_DIAGNOSTIC */
for|for
control|(
name|cb
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|slp
operator|->
name|sl_start
argument_list|)
init|;
name|cb
operator|!=
name|NULL
condition|;
name|cb
operator|=
name|TAILQ_NEXT
argument_list|(
name|cb
argument_list|,
name|ccb_chain
argument_list|)
control|)
block|{
name|li
operator|=
name|cb
operator|->
name|li
expr_stmt|;
if|if
condition|(
name|li
operator|->
name|li_disc
operator|==
literal|0
condition|)
block|{
goto|goto
name|scsi_low_cmd_start
goto|;
block|}
elseif|else
if|if
condition|(
name|li
operator|->
name|li_nqio
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|li
operator|->
name|li_nqio
operator|<
name|li
operator|->
name|li_maxnqio
operator|||
operator|(
name|cb
operator|->
name|ccb_flags
operator|&
operator|(
name|CCB_SENSE
operator||
name|CCB_CLEARQ
operator|)
operator|)
operator|!=
literal|0
condition|)
goto|goto
name|scsi_low_cmd_start
goto|;
block|}
block|}
return|return;
name|scsi_low_cmd_start
label|:
name|cb
operator|->
name|ccb_flags
operator|&=
operator|~
name|CCB_STARTQ
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|slp
operator|->
name|sl_start
argument_list|,
name|cb
argument_list|,
name|ccb_chain
argument_list|)
expr_stmt|;
name|ti
operator|=
name|cb
operator|->
name|ti
expr_stmt|;
comment|/* clear all error flag bits (for restart) */
name|cb
operator|->
name|ccb_error
operator|=
literal|0
expr_stmt|;
name|cb
operator|->
name|ccb_datalen
operator|=
operator|-
literal|1
expr_stmt|;
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_status
operator|=
name|ST_UNKNOWN
expr_stmt|;
comment|/* setup nexus pointer */
name|slp
operator|->
name|sl_Qnexus
operator|=
name|cb
expr_stmt|;
name|slp
operator|->
name|sl_Lnexus
operator|=
name|li
expr_stmt|;
name|slp
operator|->
name|sl_Tnexus
operator|=
name|ti
expr_stmt|;
comment|/* initialize msgsys */
name|scsi_low_init_msgsys
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|)
expr_stmt|;
comment|/* exec cmd */
if|if
condition|(
operator|(
name|cb
operator|->
name|ccb_flags
operator|&
operator|(
name|CCB_SENSE
operator||
name|CCB_CLEARQ
operator|)
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* CA state or forced abort */
name|rv
operator|=
name|scsi_low_sense_abort_start
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|li
argument_list|,
name|cb
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|li
operator|->
name|li_state
operator|>=
name|SCSI_LOW_LUN_OK
condition|)
block|{
name|cb
operator|->
name|ccb_flags
operator|&=
operator|~
name|CCB_INTERNAL
expr_stmt|;
name|rv
operator|=
call|(
modifier|*
name|slp
operator|->
name|sl_osdep_fp
operator|->
name|scsi_low_osdep_ccb_setup
call|)
argument_list|(
name|slp
argument_list|,
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|ccb_msgoutflag
operator|!=
literal|0
condition|)
block|{
name|scsi_low_ccb_message_exec
argument_list|(
name|slp
argument_list|,
name|cb
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|cb
operator|->
name|ccb_flags
operator||=
name|CCB_INTERNAL
expr_stmt|;
name|rv
operator|=
name|scsi_low_setup_start
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|li
argument_list|,
name|cb
argument_list|)
expr_stmt|;
block|}
comment|/* allocate qtag */
define|#
directive|define
name|SCSI_LOW_QTAG_OK
value|(SCSI_LOW_QTAG | SCSI_LOW_DISC)
if|if
condition|(
name|rv
operator|==
name|SCSI_LOW_START_QTAG
operator|&&
operator|(
name|li
operator|->
name|li_flags
operator|&
name|SCSI_LOW_QTAG_OK
operator|)
operator|==
name|SCSI_LOW_QTAG_OK
operator|&&
name|li
operator|->
name|li_maxnqio
operator|>
literal|0
condition|)
block|{
name|u_int
name|qmsg
decl_stmt|;
name|scsi_low_activate_qtag
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|scsi_low_cmd_flags
index|[
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_cmd
index|[
literal|0
index|]
index|]
operator|&
name|SCSI_LOW_CMD_ORDERED_QTAG
operator|)
operator|!=
literal|0
condition|)
name|qmsg
operator|=
name|SCSI_LOW_MSG_ORDERED_QTAG
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|cb
operator|->
name|ccb_flags
operator|&
name|CCB_URGENT
operator|)
operator|!=
literal|0
condition|)
name|qmsg
operator|=
name|SCSI_LOW_MSG_HEAD_QTAG
expr_stmt|;
else|else
name|qmsg
operator|=
name|SCSI_LOW_MSG_SIMPLE_QTAG
expr_stmt|;
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|qmsg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* timeout */
if|if
condition|(
name|cb
operator|->
name|ccb_tcmax
operator|<
name|SCSI_LOW_MIN_TOUT
condition|)
name|cb
operator|->
name|ccb_tcmax
operator|=
name|SCSI_LOW_MIN_TOUT
expr_stmt|;
name|cb
operator|->
name|ccb_tc
operator|=
name|cb
operator|->
name|ccb_tcmax
expr_stmt|;
comment|/* setup saved scsi data pointer */
name|cb
operator|->
name|ccb_sscp
operator|=
name|cb
operator|->
name|ccb_scp
expr_stmt|;
comment|/* setup current scsi pointer */
name|slp
operator|->
name|sl_scp
operator|=
name|cb
operator|->
name|ccb_sscp
expr_stmt|;
name|slp
operator|->
name|sl_error
operator|=
name|cb
operator|->
name|ccb_error
expr_stmt|;
comment|/* assert always an identify msg */
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_MSG_IDENTIFY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* debug section */
ifdef|#
directive|ifdef
name|SCSI_LOW_DIAGNOSTIC
name|scsi_low_msg_log_init
argument_list|(
operator|&
name|ti
operator|->
name|ti_log_msgin
argument_list|)
expr_stmt|;
name|scsi_low_msg_log_init
argument_list|(
operator|&
name|ti
operator|->
name|ti_log_msgout
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SCSI_LOW_DIAGNOSTIC */
comment|/* selection start */
name|slp
operator|->
name|sl_selid
operator|=
name|cb
expr_stmt|;
name|rv
operator|=
operator|(
call|(
modifier|*
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_start_bus
call|)
argument_list|(
name|slp
argument_list|,
name|cb
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|rv
operator|==
name|SCSI_LOW_START_OK
condition|)
block|{
ifdef|#
directive|ifdef
name|SCSI_LOW_STATICS
name|scsi_low_statics
operator|.
name|nexus_win
operator|++
expr_stmt|;
endif|#
directive|endif
comment|/* SCSI_LOW_STATICS */
return|return;
block|}
name|scsi_low_arbit_fail
argument_list|(
name|slp
argument_list|,
name|cb
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_STATICS
name|scsi_low_statics
operator|.
name|nexus_fail
operator|++
expr_stmt|;
endif|#
directive|endif
comment|/* SCSI_LOW_STATICS */
block|}
end_function

begin_function
name|void
name|scsi_low_arbit_fail
parameter_list|(
name|slp
parameter_list|,
name|cb
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
init|=
name|cb
operator|->
name|ti
decl_stmt|;
name|scsi_low_deactivate_qtag
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|scsi_low_ccb_message_retry
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|cb
operator|->
name|ccb_flags
operator||=
name|CCB_STARTQ
expr_stmt|;
name|TAILQ_INSERT_HEAD
argument_list|(
operator|&
name|slp
operator|->
name|sl_start
argument_list|,
name|cb
argument_list|,
name|ccb_chain
argument_list|)
expr_stmt|;
name|scsi_low_bus_release
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|)
expr_stmt|;
name|cb
operator|->
name|ccb_selrcnt
operator|++
expr_stmt|;
if|if
condition|(
name|slp
operator|->
name|sl_disc
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|SCSI_LOW_DIAGNOSTIC
name|printf
argument_list|(
literal|"%s: try selection again\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SCSI_LOW_DIAGNOSTIC */
name|slp
operator|->
name|sl_retry_sel
operator|=
literal|1
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|scsi_low_bus_release
parameter_list|(
name|slp
parameter_list|,
name|ti
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
block|{
if|if
condition|(
name|ti
operator|->
name|ti_disc
operator|>
literal|0
condition|)
block|{
name|SCSI_LOW_SETUP_PHASE
argument_list|(
name|ti
argument_list|,
name|PH_DISC
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SCSI_LOW_SETUP_PHASE
argument_list|(
name|ti
argument_list|,
name|PH_NULL
argument_list|)
expr_stmt|;
block|}
comment|/* clear all nexus pointer */
name|slp
operator|->
name|sl_Qnexus
operator|=
name|NULL
expr_stmt|;
name|slp
operator|->
name|sl_Lnexus
operator|=
name|NULL
expr_stmt|;
name|slp
operator|->
name|sl_Tnexus
operator|=
name|NULL
expr_stmt|;
comment|/* clear selection assert */
name|slp
operator|->
name|sl_selid
operator|=
name|NULL
expr_stmt|;
comment|/* clear nexus data */
name|slp
operator|->
name|sl_scp
operator|.
name|scp_direction
operator|=
name|SCSI_LOW_RWUNK
expr_stmt|;
comment|/* clear phase change counter */
name|slp
operator|->
name|sl_ph_count
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_setup_done
parameter_list|(
name|slp
parameter_list|,
name|cb
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
name|ti
operator|=
name|cb
operator|->
name|ti
expr_stmt|;
name|li
operator|=
name|cb
operator|->
name|li
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|ccb_rcnt
operator|>=
name|slp
operator|->
name|sl_max_retry
condition|)
block|{
name|cb
operator|->
name|ccb_error
operator||=
name|ABORTIO
expr_stmt|;
return|return
name|SCSI_LOW_DONE_COMPLETE
return|;
block|}
comment|/* XXX: special huck for selection timeout */
if|if
condition|(
name|li
operator|->
name|li_state
operator|==
name|SCSI_LOW_LUN_SLEEP
operator|&&
operator|(
name|cb
operator|->
name|ccb_error
operator|&
name|SELTIMEOUTIO
operator|)
operator|!=
literal|0
condition|)
block|{
name|cb
operator|->
name|ccb_error
operator||=
name|ABORTIO
expr_stmt|;
return|return
name|SCSI_LOW_DONE_COMPLETE
return|;
block|}
switch|switch
condition|(
name|li
operator|->
name|li_state
condition|)
block|{
case|case
name|SCSI_LOW_LUN_INQ
case|:
if|if
condition|(
name|cb
operator|->
name|ccb_error
operator|!=
literal|0
condition|)
block|{
name|li
operator|->
name|li_diskflags
operator|&=
operator|~
operator|(
name|SCSI_LOW_DISK_LINK
operator||
name|SCSI_LOW_DISK_QTAG
operator|)
expr_stmt|;
if|if
condition|(
name|li
operator|->
name|li_lun
operator|>
literal|0
condition|)
goto|goto
name|resume
goto|;
name|ti
operator|->
name|ti_diskflags
operator|&=
operator|~
operator|(
name|SCSI_LOW_DISK_SYNC
operator||
name|SCSI_LOW_DISK_WIDE
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|li
operator|->
name|li_inq
operator|.
name|sd_version
operator|&
literal|7
operator|)
operator|>=
literal|2
operator|||
operator|(
name|li
operator|->
name|li_inq
operator|.
name|sd_len
operator|>=
literal|4
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|li
operator|->
name|li_inq
operator|.
name|sd_support
operator|&
literal|0x2
operator|)
operator|==
literal|0
condition|)
name|li
operator|->
name|li_diskflags
operator|&=
operator|~
name|SCSI_LOW_DISK_QTAG
expr_stmt|;
if|if
condition|(
operator|(
name|li
operator|->
name|li_inq
operator|.
name|sd_support
operator|&
literal|0x8
operator|)
operator|==
literal|0
condition|)
name|li
operator|->
name|li_diskflags
operator|&=
operator|~
name|SCSI_LOW_DISK_LINK
expr_stmt|;
if|if
condition|(
name|li
operator|->
name|li_lun
operator|>
literal|0
condition|)
goto|goto
name|resume
goto|;
if|if
condition|(
operator|(
name|li
operator|->
name|li_inq
operator|.
name|sd_support
operator|&
literal|0x10
operator|)
operator|==
literal|0
condition|)
name|ti
operator|->
name|ti_diskflags
operator|&=
operator|~
name|SCSI_LOW_DISK_SYNC
expr_stmt|;
if|if
condition|(
operator|(
name|li
operator|->
name|li_inq
operator|.
name|sd_support
operator|&
literal|0x20
operator|)
operator|==
literal|0
condition|)
name|ti
operator|->
name|ti_diskflags
operator|&=
operator|~
name|SCSI_LOW_DISK_WIDE_16
expr_stmt|;
if|if
condition|(
operator|(
name|li
operator|->
name|li_inq
operator|.
name|sd_support
operator|&
literal|0x40
operator|)
operator|==
literal|0
condition|)
name|ti
operator|->
name|ti_diskflags
operator|&=
operator|~
name|SCSI_LOW_DISK_WIDE_32
expr_stmt|;
block|}
else|else
block|{
name|li
operator|->
name|li_diskflags
operator|&=
operator|~
operator|(
name|SCSI_LOW_DISK_QTAG
operator||
name|SCSI_LOW_DISK_LINK
operator|)
expr_stmt|;
if|if
condition|(
name|li
operator|->
name|li_lun
operator|>
literal|0
condition|)
goto|goto
name|resume
goto|;
name|ti
operator|->
name|ti_diskflags
operator|&=
operator|~
name|SCSI_LOW_DISK_WIDE
expr_stmt|;
block|}
name|ti
operator|->
name|ti_flags_valid
operator||=
name|SCSI_LOW_TARG_FLAGS_DISK_VALID
expr_stmt|;
name|resume
label|:
name|scsi_low_calcf_target
argument_list|(
name|ti
argument_list|)
expr_stmt|;
name|scsi_low_calcf_lun
argument_list|(
name|li
argument_list|)
expr_stmt|;
break|break;
case|case
name|SCSI_LOW_LUN_MODEQ
case|:
if|if
condition|(
name|cb
operator|->
name|ccb_error
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|cb
operator|->
name|ccb_error
operator|&
name|SENSEIO
condition|)
block|{
ifdef|#
directive|ifdef
name|SCSI_LOW_DEBUG
if|if
condition|(
name|scsi_low_debug
operator|&
name|SCSI_LOW_DEBUG_SENSE
condition|)
block|{
name|printf
argument_list|(
literal|"SENSE: [%x][%x][%x][%x][%x]\n"
argument_list|,
operator|(
name|u_int
operator|)
name|cb
operator|->
name|ccb_sense
operator|.
name|error_code
argument_list|,
operator|(
name|u_int
operator|)
name|cb
operator|->
name|ccb_sense
operator|.
name|segment
argument_list|,
operator|(
name|u_int
operator|)
name|cb
operator|->
name|ccb_sense
operator|.
name|flags
argument_list|,
operator|(
name|u_int
operator|)
name|cb
operator|->
name|ccb_sense
operator|.
name|add_sense_code
argument_list|,
operator|(
name|u_int
operator|)
name|cb
operator|->
name|ccb_sense
operator|.
name|add_sense_code_qual
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_DEBUG */
block|}
else|else
block|{
name|li
operator|->
name|li_diskflags
operator|&=
operator|~
name|SCSI_LOW_DISK_QTAG
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|li
operator|->
name|li_sms
operator|.
name|sms_cmp
operator|.
name|cmp_page
operator|&
literal|0x3f
operator|)
operator|==
literal|0x0a
condition|)
block|{
if|if
condition|(
name|li
operator|->
name|li_sms
operator|.
name|sms_cmp
operator|.
name|cmp_qc
operator|&
literal|0x02
condition|)
name|li
operator|->
name|li_qflags
operator||=
name|SCSI_LOW_QFLAG_CA_QCLEAR
expr_stmt|;
else|else
name|li
operator|->
name|li_qflags
operator|&=
operator|~
name|SCSI_LOW_QFLAG_CA_QCLEAR
expr_stmt|;
if|if
condition|(
operator|(
name|li
operator|->
name|li_sms
operator|.
name|sms_cmp
operator|.
name|cmp_qc
operator|&
literal|0x01
operator|)
operator|!=
literal|0
condition|)
name|li
operator|->
name|li_diskflags
operator|&=
operator|~
name|SCSI_LOW_DISK_QTAG
expr_stmt|;
block|}
name|li
operator|->
name|li_flags_valid
operator||=
name|SCSI_LOW_LUN_FLAGS_DISK_VALID
expr_stmt|;
name|scsi_low_calcf_lun
argument_list|(
name|li
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|li
operator|->
name|li_state
operator|++
expr_stmt|;
if|if
condition|(
name|li
operator|->
name|li_state
operator|==
name|SCSI_LOW_LUN_OK
condition|)
block|{
name|scsi_low_calcf_target
argument_list|(
name|ti
argument_list|)
expr_stmt|;
name|scsi_low_calcf_lun
argument_list|(
name|li
argument_list|)
expr_stmt|;
if|if
condition|(
name|li
operator|->
name|li_flags_valid
operator|==
name|SCSI_LOW_LUN_FLAGS_ALL_VALID
operator|&&
operator|(
name|slp
operator|->
name|sl_show_result
operator|&
name|SHOW_CALCF_RES
operator|)
operator|!=
literal|0
condition|)
block|{
name|scsi_low_calcf_show
argument_list|(
name|li
argument_list|)
expr_stmt|;
block|}
block|}
name|cb
operator|->
name|ccb_rcnt
operator|--
expr_stmt|;
return|return
name|SCSI_LOW_DONE_RETRY
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_done
parameter_list|(
name|slp
parameter_list|,
name|cb
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
block|{
name|int
name|rv
decl_stmt|;
if|if
condition|(
name|cb
operator|->
name|ccb_error
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|cb
operator|->
name|ccb_flags
operator|&
operator|(
name|CCB_SENSE
operator||
name|CCB_CLEARQ
operator|)
operator|)
operator|!=
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|SCSI_LOW_QCLEAR_AFTER_CA
comment|/* XXX: 			 * SCSI-2 draft suggests  			 * page 0x0a QErr bit determins if 			 * the target aborts or continues 			 * the queueing io's after CA state resolved. 			 * However many targets seem not to support 			 * the page 0x0a. Thus we should manually clear the 			 * queuing io's after CA state. 			 */
if|if
condition|(
operator|(
name|cb
operator|->
name|ccb_flags
operator|&
name|CCB_CLEARQ
operator|)
operator|==
literal|0
condition|)
block|{
name|cb
operator|->
name|ccb_rcnt
operator|--
expr_stmt|;
name|cb
operator|->
name|ccb_flags
operator||=
name|CCB_CLEARQ
expr_stmt|;
goto|goto
name|retry
goto|;
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_QCLEAR_AFTER_CA */
if|if
condition|(
operator|(
name|cb
operator|->
name|ccb_flags
operator|&
name|CCB_SENSE
operator|)
operator|!=
literal|0
condition|)
name|cb
operator|->
name|ccb_error
operator||=
operator|(
name|SENSEIO
operator||
name|ABORTIO
operator|)
expr_stmt|;
name|cb
operator|->
name|ccb_flags
operator|&=
operator|~
operator|(
name|CCB_SENSE
operator||
name|CCB_CLEARQ
operator|)
expr_stmt|;
block|}
else|else
switch|switch
condition|(
name|cb
operator|->
name|ccb_sscp
operator|.
name|scp_status
condition|)
block|{
case|case
name|ST_GOOD
case|:
case|case
name|ST_MET
case|:
case|case
name|ST_INTERGOOD
case|:
case|case
name|ST_INTERMET
case|:
if|if
condition|(
name|cb
operator|->
name|ccb_datalen
operator|==
literal|0
operator|||
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_datalen
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_cmdlen
operator|>
literal|0
operator|&&
operator|(
name|scsi_low_cmd_flags
index|[
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_cmd
index|[
literal|0
index|]
index|]
operator|&
name|SCSI_LOW_CMD_RESIDUAL_CHK
operator|)
operator|==
literal|0
condition|)
break|break;
name|cb
operator|->
name|ccb_error
operator||=
name|PDMAERR
expr_stmt|;
break|break;
case|case
name|ST_BUSY
case|:
case|case
name|ST_QUEFULL
case|:
name|cb
operator|->
name|ccb_error
operator||=
operator|(
name|BUSYERR
operator||
name|STATERR
operator|)
expr_stmt|;
break|break;
case|case
name|ST_CONFLICT
case|:
name|cb
operator|->
name|ccb_error
operator||=
operator|(
name|STATERR
operator||
name|ABORTIO
operator|)
expr_stmt|;
break|break;
case|case
name|ST_CHKCOND
case|:
case|case
name|ST_CMDTERM
case|:
if|if
condition|(
name|cb
operator|->
name|ccb_flags
operator|&
operator|(
name|CCB_AUTOSENSE
operator||
name|CCB_INTERNAL
operator|)
condition|)
block|{
name|cb
operator|->
name|ccb_rcnt
operator|--
expr_stmt|;
name|cb
operator|->
name|ccb_flags
operator||=
name|CCB_SENSE
expr_stmt|;
goto|goto
name|retry
goto|;
block|}
name|cb
operator|->
name|ccb_error
operator||=
operator|(
name|UACAERR
operator||
name|STATERR
operator||
name|ABORTIO
operator|)
expr_stmt|;
break|break;
case|case
name|ST_UNKNOWN
case|:
default|default:
name|cb
operator|->
name|ccb_error
operator||=
name|FATALIO
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
if|if
condition|(
name|cb
operator|->
name|ccb_flags
operator|&
name|CCB_SENSE
condition|)
block|{
name|cb
operator|->
name|ccb_error
operator||=
operator|(
name|SENSEERR
operator||
name|ABORTIO
operator|)
expr_stmt|;
block|}
name|cb
operator|->
name|ccb_flags
operator|&=
operator|~
operator|(
name|CCB_CLEARQ
operator||
name|CCB_SENSE
operator|)
expr_stmt|;
block|}
comment|/* internal ccb */
if|if
condition|(
operator|(
name|cb
operator|->
name|ccb_flags
operator|&
name|CCB_INTERNAL
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|scsi_low_setup_done
argument_list|(
name|slp
argument_list|,
name|cb
argument_list|)
operator|==
name|SCSI_LOW_DONE_RETRY
condition|)
goto|goto
name|retry
goto|;
block|}
comment|/* check a ccb msgout flag */
if|if
condition|(
name|cb
operator|->
name|ccb_omsgoutflag
operator|!=
literal|0
condition|)
block|{
define|#
directive|define
name|SCSI_LOW_MSG_ABORT_OK
value|(SCSI_LOW_MSG_ABORT | \ 				 SCSI_LOW_MSG_ABORT_QTAG | \ 				 SCSI_LOW_MSG_CLEAR_QTAG | \ 				 SCSI_LOW_MSG_TERMIO)
if|if
condition|(
operator|(
name|cb
operator|->
name|ccb_omsgoutflag
operator|&
name|SCSI_LOW_MSG_ABORT_OK
operator|)
operator|!=
literal|0
condition|)
block|{
name|cb
operator|->
name|ccb_error
operator||=
name|ABORTIO
expr_stmt|;
block|}
block|}
comment|/* call OS depend done */
if|if
condition|(
name|cb
operator|->
name|osdep
operator|!=
name|NULL
condition|)
block|{
name|rv
operator|=
call|(
modifier|*
name|slp
operator|->
name|sl_osdep_fp
operator|->
name|scsi_low_osdep_done
call|)
argument_list|(
name|slp
argument_list|,
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|==
name|EJUSTRETURN
condition|)
goto|goto
name|retry
goto|;
block|}
elseif|else
if|if
condition|(
name|cb
operator|->
name|ccb_error
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|cb
operator|->
name|ccb_rcnt
operator|>=
name|slp
operator|->
name|sl_max_retry
condition|)
name|cb
operator|->
name|ccb_error
operator||=
name|ABORTIO
expr_stmt|;
if|if
condition|(
operator|(
name|cb
operator|->
name|ccb_flags
operator|&
name|CCB_NORETRY
operator|)
operator|==
literal|0
operator|&&
operator|(
name|cb
operator|->
name|ccb_error
operator|&
name|ABORTIO
operator|)
operator|==
literal|0
condition|)
goto|goto
name|retry
goto|;
block|}
comment|/* free our target */
ifdef|#
directive|ifdef
name|SCSI_LOW_DEBUG
if|if
condition|(
name|SCSI_LOW_DEBUG_GO
argument_list|(
name|SCSI_LOW_DEBUG_DONE
argument_list|,
name|cb
operator|->
name|ti
operator|->
name|ti_id
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|">> SCSI_LOW_DONE_COMPLETE ===============\n"
argument_list|)
expr_stmt|;
name|scsi_low_print
argument_list|(
name|slp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_DEBUG */
name|scsi_low_deactivate_qtag
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|scsi_low_dealloc_qtag
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|scsi_low_free_ccb
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|slp
operator|->
name|sl_nio
operator|--
expr_stmt|;
return|return
name|SCSI_LOW_DONE_COMPLETE
return|;
name|retry
label|:
ifdef|#
directive|ifdef
name|SCSI_LOW_DEBUG
if|if
condition|(
name|SCSI_LOW_DEBUG_GO
argument_list|(
name|SCSI_LOW_DEBUG_DONE
argument_list|,
name|cb
operator|->
name|ti
operator|->
name|ti_id
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"** SCSI_LOW_DONE_RETRY ===============\n"
argument_list|)
expr_stmt|;
name|scsi_low_print
argument_list|(
name|slp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_DEBUG */
name|cb
operator|->
name|ccb_rcnt
operator|++
expr_stmt|;
name|scsi_low_deactivate_qtag
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|scsi_low_ccb_message_retry
argument_list|(
name|cb
argument_list|)
expr_stmt|;
return|return
name|SCSI_LOW_DONE_RETRY
return|;
block|}
end_function

begin_comment
comment|/**************************************************************  * Reset  **************************************************************/
end_comment

begin_function
specifier|static
name|void
name|scsi_low_reset_nexus_target
parameter_list|(
name|slp
parameter_list|,
name|ti
parameter_list|,
name|fdone
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|int
name|fdone
decl_stmt|;
block|{
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
for|for
control|(
name|li
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|ti
operator|->
name|ti_litab
argument_list|)
init|;
name|li
operator|!=
name|NULL
condition|;
name|li
operator|=
name|LIST_NEXT
argument_list|(
name|li
argument_list|,
name|lun_chain
argument_list|)
control|)
block|{
name|scsi_low_reset_nexus_lun
argument_list|(
name|slp
argument_list|,
name|li
argument_list|,
name|fdone
argument_list|)
expr_stmt|;
name|li
operator|->
name|li_state
operator|=
name|SCSI_LOW_LUN_SLEEP
expr_stmt|;
name|li
operator|->
name|li_maxnqio
operator|=
literal|0
expr_stmt|;
block|}
name|ti
operator|->
name|ti_disc
operator|=
literal|0
expr_stmt|;
name|ti
operator|->
name|ti_setup_msg
operator|=
literal|0
expr_stmt|;
name|ti
operator|->
name|ti_setup_msg_done
operator|=
literal|0
expr_stmt|;
name|ti
operator|->
name|ti_osynch
operator|.
name|offset
operator|=
name|ti
operator|->
name|ti_osynch
operator|.
name|period
operator|=
literal|0
expr_stmt|;
name|ti
operator|->
name|ti_owidth
operator|=
name|SCSI_LOW_BUS_WIDTH_8
expr_stmt|;
name|ti
operator|->
name|ti_diskflags
operator|=
name|SCSI_LOW_DISK_TFLAGS
expr_stmt|;
name|ti
operator|->
name|ti_flags_valid
operator|&=
operator|~
name|SCSI_LOW_TARG_FLAGS_DISK_VALID
expr_stmt|;
if|if
condition|(
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_targ_init
operator|!=
name|NULL
condition|)
block|{
operator|(
call|(
modifier|*
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_targ_init
call|)
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_INFO_REVOKE
argument_list|)
operator|)
expr_stmt|;
block|}
name|scsi_low_calcf_target
argument_list|(
name|ti
argument_list|)
expr_stmt|;
for|for
control|(
name|li
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|ti
operator|->
name|ti_litab
argument_list|)
init|;
name|li
operator|!=
name|NULL
condition|;
name|li
operator|=
name|LIST_NEXT
argument_list|(
name|li
argument_list|,
name|lun_chain
argument_list|)
control|)
block|{
name|li
operator|->
name|li_flags
operator|=
literal|0
expr_stmt|;
name|li
operator|->
name|li_diskflags
operator|=
name|SCSI_LOW_DISK_LFLAGS
expr_stmt|;
name|li
operator|->
name|li_flags_valid
operator|&=
operator|~
name|SCSI_LOW_LUN_FLAGS_DISK_VALID
expr_stmt|;
if|if
condition|(
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_lun_init
operator|!=
name|NULL
condition|)
block|{
operator|(
call|(
modifier|*
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_lun_init
call|)
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|li
argument_list|,
name|SCSI_LOW_INFO_REVOKE
argument_list|)
operator|)
expr_stmt|;
block|}
name|scsi_low_calcf_lun
argument_list|(
name|li
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|scsi_low_reset_nexus
parameter_list|(
name|slp
parameter_list|,
name|fdone
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|int
name|fdone
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|,
modifier|*
name|topcb
decl_stmt|;
if|if
condition|(
operator|(
name|cb
operator|=
name|slp
operator|->
name|sl_Qnexus
operator|)
operator|!=
name|NULL
condition|)
block|{
name|topcb
operator|=
name|scsi_low_revoke_ccb
argument_list|(
name|slp
argument_list|,
name|cb
argument_list|,
name|fdone
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|topcb
operator|=
name|NULL
expr_stmt|;
block|}
for|for
control|(
name|ti
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|slp
operator|->
name|sl_titab
argument_list|)
init|;
name|ti
operator|!=
name|NULL
condition|;
name|ti
operator|=
name|TAILQ_NEXT
argument_list|(
name|ti
argument_list|,
name|ti_chain
argument_list|)
control|)
block|{
name|scsi_low_reset_nexus_target
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|fdone
argument_list|)
expr_stmt|;
name|scsi_low_bus_release
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|)
expr_stmt|;
name|scsi_low_init_msgsys
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|topcb
operator|!=
name|NULL
condition|)
block|{
name|topcb
operator|->
name|ccb_flags
operator||=
name|CCB_STARTQ
expr_stmt|;
name|TAILQ_INSERT_HEAD
argument_list|(
operator|&
name|slp
operator|->
name|sl_start
argument_list|,
name|topcb
argument_list|,
name|ccb_chain
argument_list|)
expr_stmt|;
block|}
name|slp
operator|->
name|sl_disc
operator|=
literal|0
expr_stmt|;
name|slp
operator|->
name|sl_retry_sel
operator|=
literal|0
expr_stmt|;
name|slp
operator|->
name|sl_flags
operator|&=
operator|~
name|HW_PDMASTART
expr_stmt|;
block|}
end_function

begin_comment
comment|/* misc */
end_comment

begin_decl_stmt
specifier|static
name|int
name|tw_pos
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|tw_chars
index|[]
init|=
literal|"|/-\\"
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|TWIDDLEWAIT
value|10000
end_define

begin_function
specifier|static
name|void
name|scsi_low_twiddle_wait
parameter_list|(
name|void
parameter_list|)
block|{
name|cnputc
argument_list|(
literal|'\b'
argument_list|)
expr_stmt|;
name|cnputc
argument_list|(
name|tw_chars
index|[
name|tw_pos
operator|++
index|]
argument_list|)
expr_stmt|;
name|tw_pos
operator|%=
operator|(
sizeof|sizeof
argument_list|(
name|tw_chars
argument_list|)
operator|-
literal|1
operator|)
expr_stmt|;
name|SCSI_LOW_DELAY
argument_list|(
name|TWIDDLEWAIT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|scsi_low_bus_reset
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
call|(
modifier|*
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_bus_reset
call|)
argument_list|(
name|slp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s: try to reset scsi bus  "
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|SCSI2_RESET_DELAY
operator|/
name|TWIDDLEWAIT
condition|;
name|i
operator|++
control|)
name|scsi_low_twiddle_wait
argument_list|()
expr_stmt|;
name|cnputc
argument_list|(
literal|'\b'
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|scsi_low_restart
parameter_list|(
name|slp
parameter_list|,
name|flags
parameter_list|,
name|s
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|u_char
modifier|*
name|s
decl_stmt|;
block|{
name|int
name|error
decl_stmt|;
if|if
condition|(
name|s
operator|!=
name|NULL
condition|)
name|printf
argument_list|(
literal|"%s: scsi bus restart. reason: %s\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|,
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|scsi_low_init
argument_list|(
name|slp
argument_list|,
name|flags
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
name|scsi_low_start
argument_list|(
name|slp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**************************************************************  * disconnect and reselect  **************************************************************/
end_comment

begin_define
define|#
directive|define
name|MSGCMD_LUN
parameter_list|(
name|msg
parameter_list|)
value|(msg& 0x07)
end_define

begin_function
specifier|static
name|struct
name|slccb
modifier|*
name|scsi_low_establish_ccb
parameter_list|(
name|ti
parameter_list|,
name|li
parameter_list|,
name|tag
parameter_list|)
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
name|scsi_low_tag_t
name|tag
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
name|ti
operator|->
name|ti_sc
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
if|if
condition|(
name|li
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|cb
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|li
operator|->
name|li_discq
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|cb
operator|!=
name|NULL
condition|;
name|cb
operator|=
name|TAILQ_NEXT
argument_list|(
name|cb
argument_list|,
name|ccb_chain
argument_list|)
control|)
if|if
condition|(
name|cb
operator|->
name|ccb_tag
operator|==
name|tag
condition|)
goto|goto
name|found
goto|;
return|return
name|cb
return|;
comment|/*  	 * establish our ccb nexus 	 */
name|found
label|:
ifdef|#
directive|ifdef
name|SCSI_LOW_DEBUG
if|if
condition|(
name|SCSI_LOW_DEBUG_TEST_GO
argument_list|(
name|SCSI_LOW_NEXUS_CHECK
argument_list|,
name|ti
operator|->
name|ti_id
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: nexus(0x%lx) abort check start\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|,
operator|(
name|u_long
operator|)
name|cb
argument_list|)
expr_stmt|;
name|cb
operator|->
name|ccb_flags
operator||=
operator|(
name|CCB_NORETRY
operator||
name|CCB_SILENT
operator|)
expr_stmt|;
name|scsi_low_revoke_ccb
argument_list|(
name|slp
argument_list|,
name|cb
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|SCSI_LOW_DEBUG_TEST_GO
argument_list|(
name|SCSI_LOW_ATTEN_CHECK
argument_list|,
name|ti
operator|->
name|ti_id
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|cb
operator|->
name|ccb_omsgoutflag
operator|==
literal|0
condition|)
name|scsi_low_ccb_message_assert
argument_list|(
name|cb
argument_list|,
name|SCSI_LOW_MSG_NOOP
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_DEBUG */
name|TAILQ_REMOVE
argument_list|(
operator|&
name|li
operator|->
name|li_discq
argument_list|,
name|cb
argument_list|,
name|ccb_chain
argument_list|)
expr_stmt|;
name|cb
operator|->
name|ccb_flags
operator|&=
operator|~
name|CCB_DISCQ
expr_stmt|;
name|slp
operator|->
name|sl_Qnexus
operator|=
name|cb
expr_stmt|;
name|slp
operator|->
name|sl_scp
operator|=
name|cb
operator|->
name|ccb_sscp
expr_stmt|;
name|slp
operator|->
name|sl_error
operator||=
name|cb
operator|->
name|ccb_error
expr_stmt|;
name|slp
operator|->
name|sl_disc
operator|--
expr_stmt|;
name|ti
operator|->
name|ti_disc
operator|--
expr_stmt|;
name|li
operator|->
name|li_disc
operator|--
expr_stmt|;
comment|/* inform "ccb nexus established" to the host driver */
call|(
modifier|*
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_establish_ccb_nexus
call|)
argument_list|(
name|slp
argument_list|)
expr_stmt|;
comment|/* check msg */
if|if
condition|(
name|cb
operator|->
name|ccb_msgoutflag
operator|!=
literal|0
condition|)
block|{
name|scsi_low_ccb_message_exec
argument_list|(
name|slp
argument_list|,
name|cb
argument_list|)
expr_stmt|;
block|}
return|return
name|cb
return|;
block|}
end_function

begin_function
name|struct
name|targ_info
modifier|*
name|scsi_low_reselected
parameter_list|(
name|slp
parameter_list|,
name|targ
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|u_int
name|targ
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
name|u_char
modifier|*
name|s
decl_stmt|;
comment|/*  	 * Check select vs reselected collision. 	 */
if|if
condition|(
operator|(
name|cb
operator|=
name|slp
operator|->
name|sl_selid
operator|)
operator|!=
name|NULL
condition|)
block|{
name|scsi_low_arbit_fail
argument_list|(
name|slp
argument_list|,
name|cb
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_STATICS
name|scsi_low_statics
operator|.
name|nexus_conflict
operator|++
expr_stmt|;
endif|#
directive|endif
comment|/* SCSI_LOW_STATICS */
block|}
comment|/*  	 * Check if no current active nexus. 	 */
if|if
condition|(
name|slp
operator|->
name|sl_Tnexus
operator|!=
name|NULL
condition|)
block|{
name|s
operator|=
literal|"host busy"
expr_stmt|;
goto|goto
name|world_restart
goto|;
block|}
comment|/*  	 * Check a valid target id asserted ? 	 */
if|if
condition|(
name|targ
operator|>=
name|slp
operator|->
name|sl_ntargs
operator|||
name|targ
operator|==
name|slp
operator|->
name|sl_hostid
condition|)
block|{
name|s
operator|=
literal|"scsi id illegal"
expr_stmt|;
goto|goto
name|world_restart
goto|;
block|}
comment|/*  	 * Check the target scsi status. 	 */
name|ti
operator|=
name|slp
operator|->
name|sl_ti
index|[
name|targ
index|]
expr_stmt|;
if|if
condition|(
name|ti
operator|->
name|ti_phase
operator|!=
name|PH_DISC
operator|&&
name|ti
operator|->
name|ti_phase
operator|!=
name|PH_NULL
condition|)
block|{
name|s
operator|=
literal|"phase mismatch"
expr_stmt|;
goto|goto
name|world_restart
goto|;
block|}
comment|/*  	 * Setup init msgsys 	 */
name|slp
operator|->
name|sl_error
operator|=
literal|0
expr_stmt|;
name|scsi_low_init_msgsys
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|)
expr_stmt|;
comment|/*  	 * Establish our target nexus 	 */
name|SCSI_LOW_SETUP_PHASE
argument_list|(
name|ti
argument_list|,
name|PH_RESEL
argument_list|)
expr_stmt|;
name|slp
operator|->
name|sl_Tnexus
operator|=
name|ti
expr_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_STATICS
name|scsi_low_statics
operator|.
name|nexus_reselected
operator|++
expr_stmt|;
endif|#
directive|endif
comment|/* SCSI_LOW_STATICS */
return|return
name|ti
return|;
name|world_restart
label|:
name|printf
argument_list|(
literal|"%s: reselect(%x:unknown) %s\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|,
name|targ
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|scsi_low_restart
argument_list|(
name|slp
argument_list|,
name|SCSI_LOW_RESTART_HARD
argument_list|,
literal|"reselect: scsi world confused"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**************************************************************  * cmd out pointer setup  **************************************************************/
end_comment

begin_function
name|int
name|scsi_low_cmd
parameter_list|(
name|slp
parameter_list|,
name|ti
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
block|{
name|struct
name|slccb
modifier|*
name|cb
init|=
name|slp
operator|->
name|sl_Qnexus
decl_stmt|;
name|slp
operator|->
name|sl_ph_count
operator|++
expr_stmt|;
if|if
condition|(
name|cb
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * no ccb, abort! 		 */
name|slp
operator|->
name|sl_scp
operator|.
name|scp_cmd
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
operator|&
name|unit_ready_cmd
expr_stmt|;
name|slp
operator|->
name|sl_scp
operator|.
name|scp_cmdlen
operator|=
sizeof|sizeof
argument_list|(
name|unit_ready_cmd
argument_list|)
expr_stmt|;
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
operator|=
literal|0
expr_stmt|;
name|slp
operator|->
name|sl_scp
operator|.
name|scp_direction
operator|=
name|SCSI_LOW_READ
expr_stmt|;
name|slp
operator|->
name|sl_error
operator||=
name|FATALIO
expr_stmt|;
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_MSG_ABORT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SCSI_LOW_INFO
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
literal|"CMDOUT: ccb nexus not found"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|SCSI_LOW_DEBUG
if|if
condition|(
name|SCSI_LOW_DEBUG_TEST_GO
argument_list|(
name|SCSI_LOW_CMDLNK_CHECK
argument_list|,
name|ti
operator|->
name|ti_id
argument_list|)
condition|)
block|{
name|scsi_low_test_cmdlnk
argument_list|(
name|slp
argument_list|,
name|cb
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_DEBUG */
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**************************************************************  * data out pointer setup  **************************************************************/
end_comment

begin_function
name|int
name|scsi_low_data
parameter_list|(
name|slp
parameter_list|,
name|ti
parameter_list|,
name|bp
parameter_list|,
name|direction
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|struct
name|buf
modifier|*
modifier|*
name|bp
decl_stmt|;
name|int
name|direction
decl_stmt|;
block|{
name|struct
name|slccb
modifier|*
name|cb
init|=
name|slp
operator|->
name|sl_Qnexus
decl_stmt|;
if|if
condition|(
name|cb
operator|!=
name|NULL
operator|&&
name|direction
operator|==
name|cb
operator|->
name|ccb_sscp
operator|.
name|scp_direction
condition|)
block|{
operator|*
name|bp
operator|=
name|cb
operator|->
name|bp
expr_stmt|;
return|return
literal|0
return|;
block|}
name|slp
operator|->
name|sl_error
operator||=
operator|(
name|FATALIO
operator||
name|PDMAERR
operator|)
expr_stmt|;
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
operator|=
literal|0
expr_stmt|;
name|slp
operator|->
name|sl_scp
operator|.
name|scp_direction
operator|=
name|direction
expr_stmt|;
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_MSG_ABORT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ti
operator|->
name|ti_ophase
operator|!=
name|ti
operator|->
name|ti_phase
condition|)
block|{
name|char
modifier|*
name|s
decl_stmt|;
if|if
condition|(
name|cb
operator|==
name|NULL
condition|)
name|s
operator|=
literal|"DATA PHASE: ccb nexus not found"
expr_stmt|;
else|else
name|s
operator|=
literal|"DATA PHASE: xfer direction mismatch"
expr_stmt|;
name|SCSI_LOW_INFO
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|s
argument_list|)
expr_stmt|;
block|}
operator|*
name|bp
operator|=
name|NULL
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
end_function

begin_comment
comment|/**************************************************************  * MSG_SYS   **************************************************************/
end_comment

begin_define
define|#
directive|define
name|MSGINPTR_CLR
parameter_list|(
name|ti
parameter_list|)
value|{(ti)->ti_msginptr = 0; (ti)->ti_msginlen = 0;}
end_define

begin_define
define|#
directive|define
name|MSGIN_PERIOD
parameter_list|(
name|ti
parameter_list|)
value|((ti)->ti_msgin[3])
end_define

begin_define
define|#
directive|define
name|MSGIN_OFFSET
parameter_list|(
name|ti
parameter_list|)
value|((ti)->ti_msgin[4])
end_define

begin_define
define|#
directive|define
name|MSGIN_WIDTHP
parameter_list|(
name|ti
parameter_list|)
value|((ti)->ti_msgin[3])
end_define

begin_define
define|#
directive|define
name|MSGIN_DATA_LAST
value|0x30
end_define

begin_function_decl
specifier|static
name|int
name|scsi_low_errfunc_synch
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_errfunc_wide
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_errfunc_identify
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_errfunc_qtag
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_msgfunc_synch
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_msgfunc_wide
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_msgfunc_identify
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_msgfunc_abort
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_msgfunc_qabort
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_msgfunc_qtag
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_msgfunc_reset
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_struct
struct|struct
name|scsi_low_msgout_data
block|{
name|u_int
name|md_flags
decl_stmt|;
name|u_int8_t
name|md_msg
decl_stmt|;
name|int
function_decl|(
modifier|*
name|md_msgfunc
function_decl|)
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
name|int
function_decl|(
modifier|*
name|md_errfunc
function_decl|)
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
define|#
directive|define
name|MSG_RELEASE_ATN
value|0x0001
name|u_int
name|md_condition
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
name|struct
name|scsi_low_msgout_data
name|scsi_low_msgout_data
index|[]
init|=
block|{
comment|/* 0 */
block|{
name|SCSI_LOW_MSG_RESET
block|,
name|MSG_RESET
block|,
name|scsi_low_msgfunc_reset
block|,
name|NULL
block|,
name|MSG_RELEASE_ATN
block|}
block|,
comment|/* 1 */
block|{
name|SCSI_LOW_MSG_REJECT
block|,
name|MSG_REJECT
block|,
name|NULL
block|,
name|NULL
block|,
name|MSG_RELEASE_ATN
block|}
block|,
comment|/* 2 */
block|{
name|SCSI_LOW_MSG_PARITY
block|,
name|MSG_PARITY
block|,
name|NULL
block|,
name|NULL
block|,
name|MSG_RELEASE_ATN
block|}
block|,
comment|/* 3 */
block|{
name|SCSI_LOW_MSG_ERROR
block|,
name|MSG_I_ERROR
block|,
name|NULL
block|,
name|NULL
block|,
name|MSG_RELEASE_ATN
block|}
block|,
comment|/* 4 */
block|{
name|SCSI_LOW_MSG_IDENTIFY
block|,
name|MSG_IDENTIFY
block|,
name|scsi_low_msgfunc_identify
block|,
name|scsi_low_errfunc_identify
block|,
literal|0
block|}
block|,
comment|/* 5 */
block|{
name|SCSI_LOW_MSG_ABORT
block|,
name|MSG_ABORT
block|,
name|scsi_low_msgfunc_abort
block|,
name|NULL
block|,
name|MSG_RELEASE_ATN
block|}
block|,
comment|/* 6 */
block|{
name|SCSI_LOW_MSG_TERMIO
block|,
name|MSG_TERM_IO
block|,
name|NULL
block|,
name|NULL
block|,
name|MSG_RELEASE_ATN
block|}
block|,
comment|/* 7 */
block|{
name|SCSI_LOW_MSG_SIMPLE_QTAG
block|,
name|MSG_SIMPLE_QTAG
block|,
name|scsi_low_msgfunc_qtag
block|,
name|scsi_low_errfunc_qtag
block|,
literal|0
block|}
block|,
comment|/* 8 */
block|{
name|SCSI_LOW_MSG_ORDERED_QTAG
block|,
name|MSG_ORDERED_QTAG
block|,
name|scsi_low_msgfunc_qtag
block|,
name|scsi_low_errfunc_qtag
block|,
literal|0
block|}
block|,
comment|/* 9 */
block|{
name|SCSI_LOW_MSG_HEAD_QTAG
block|,
name|MSG_HEAD_QTAG
block|,
name|scsi_low_msgfunc_qtag
block|,
name|scsi_low_errfunc_qtag
block|,
literal|0
block|}
block|,
comment|/* 10 */
block|{
name|SCSI_LOW_MSG_ABORT_QTAG
block|,
name|MSG_ABORT_QTAG
block|,
name|scsi_low_msgfunc_qabort
block|,
name|NULL
block|,
name|MSG_RELEASE_ATN
block|}
block|,
comment|/* 11 */
block|{
name|SCSI_LOW_MSG_CLEAR_QTAG
block|,
name|MSG_CLEAR_QTAG
block|,
name|scsi_low_msgfunc_abort
block|,
name|NULL
block|,
name|MSG_RELEASE_ATN
block|}
block|,
comment|/* 12 */
block|{
name|SCSI_LOW_MSG_WIDE
block|,
name|MSG_EXTEND
block|,
name|scsi_low_msgfunc_wide
block|,
name|scsi_low_errfunc_wide
block|,
name|MSG_RELEASE_ATN
block|}
block|,
comment|/* 13 */
block|{
name|SCSI_LOW_MSG_SYNCH
block|,
name|MSG_EXTEND
block|,
name|scsi_low_msgfunc_synch
block|,
name|scsi_low_errfunc_synch
block|,
name|MSG_RELEASE_ATN
block|}
block|,
comment|/* 14 */
block|{
name|SCSI_LOW_MSG_NOOP
block|,
name|MSG_NOOP
block|,
name|NULL
block|,
name|NULL
block|,
name|MSG_RELEASE_ATN
block|}
block|,
comment|/* 15 */
block|{
name|SCSI_LOW_MSG_ALL
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|scsi_low_msginfunc_ext
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_synch
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_wide
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_msginfunc_msg_reject
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_msginfunc_rejop
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_msginfunc_rp
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_msginfunc_sdp
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_msginfunc_disc
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_msginfunc_cc
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_msginfunc_lcc
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_msginfunc_parity
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_msginfunc_noop
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_msginfunc_simple_qtag
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|scsi_low_msginfunc_i_wide_residue
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_struct
struct|struct
name|scsi_low_msgin_data
block|{
name|u_int
name|md_len
decl_stmt|;
name|int
function_decl|(
modifier|*
name|md_msgfunc
function_decl|)
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|)
function_decl|;
block|}
struct|;
end_struct

begin_decl_stmt
name|struct
name|scsi_low_msgin_data
name|scsi_low_msgin_data
index|[]
init|=
block|{
comment|/* 0 */
block|{
literal|1
block|,
name|scsi_low_msginfunc_cc
block|}
block|,
comment|/* 1 */
block|{
literal|2
block|,
name|scsi_low_msginfunc_ext
block|}
block|,
comment|/* 2 */
block|{
literal|1
block|,
name|scsi_low_msginfunc_sdp
block|}
block|,
comment|/* 3 */
block|{
literal|1
block|,
name|scsi_low_msginfunc_rp
block|}
block|,
comment|/* 4 */
block|{
literal|1
block|,
name|scsi_low_msginfunc_disc
block|}
block|,
comment|/* 5 */
block|{
literal|1
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 6 */
block|{
literal|1
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 7 */
block|{
literal|1
block|,
name|scsi_low_msginfunc_msg_reject
block|}
block|,
comment|/* 8 */
block|{
literal|1
block|,
name|scsi_low_msginfunc_noop
block|}
block|,
comment|/* 9 */
block|{
literal|1
block|,
name|scsi_low_msginfunc_parity
block|}
block|,
comment|/* a */
block|{
literal|1
block|,
name|scsi_low_msginfunc_lcc
block|}
block|,
comment|/* b */
block|{
literal|1
block|,
name|scsi_low_msginfunc_lcc
block|}
block|,
comment|/* c */
block|{
literal|1
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* d */
block|{
literal|2
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* e */
block|{
literal|1
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* f */
block|{
literal|1
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x10 */
block|{
literal|1
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x11 */
block|{
literal|1
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x12 */
block|{
literal|1
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x13 */
block|{
literal|1
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x14 */
block|{
literal|1
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x15 */
block|{
literal|1
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x16 */
block|{
literal|1
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x17 */
block|{
literal|1
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x18 */
block|{
literal|1
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x19 */
block|{
literal|1
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x1a */
block|{
literal|1
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x1b */
block|{
literal|1
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x1c */
block|{
literal|1
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x1d */
block|{
literal|1
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x1e */
block|{
literal|1
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x1f */
block|{
literal|1
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x20 */
block|{
literal|2
block|,
name|scsi_low_msginfunc_simple_qtag
block|}
block|,
comment|/* 0x21 */
block|{
literal|2
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x22 */
block|{
literal|2
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x23 */
block|{
literal|2
block|,
name|scsi_low_msginfunc_i_wide_residue
block|}
block|,
comment|/* 0x24 */
block|{
literal|2
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x25 */
block|{
literal|2
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x26 */
block|{
literal|2
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x27 */
block|{
literal|2
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x28 */
block|{
literal|2
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x29 */
block|{
literal|2
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x2a */
block|{
literal|2
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x2b */
block|{
literal|2
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x2c */
block|{
literal|2
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x2d */
block|{
literal|2
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x2e */
block|{
literal|2
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x2f */
block|{
literal|2
block|,
name|scsi_low_msginfunc_rejop
block|}
block|,
comment|/* 0x30 */
block|{
literal|1
block|,
name|scsi_low_msginfunc_rejop
block|}
comment|/* default rej op */
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**************************************************************  * msgout  **************************************************************/
end_comment

begin_function
specifier|static
name|int
name|scsi_low_msgfunc_synch
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
init|=
name|slp
operator|->
name|sl_Tnexus
decl_stmt|;
name|int
name|ptr
init|=
name|ti
operator|->
name|ti_msgoutlen
decl_stmt|;
name|ti
operator|->
name|ti_msgoutstr
index|[
name|ptr
operator|+
literal|1
index|]
operator|=
name|MSG_EXTEND_SYNCHLEN
expr_stmt|;
name|ti
operator|->
name|ti_msgoutstr
index|[
name|ptr
operator|+
literal|2
index|]
operator|=
name|MSG_EXTEND_SYNCHCODE
expr_stmt|;
name|ti
operator|->
name|ti_msgoutstr
index|[
name|ptr
operator|+
literal|3
index|]
operator|=
name|ti
operator|->
name|ti_maxsynch
operator|.
name|period
expr_stmt|;
name|ti
operator|->
name|ti_msgoutstr
index|[
name|ptr
operator|+
literal|4
index|]
operator|=
name|ti
operator|->
name|ti_maxsynch
operator|.
name|offset
expr_stmt|;
return|return
name|MSG_EXTEND_SYNCHLEN
operator|+
literal|2
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_msgfunc_wide
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
init|=
name|slp
operator|->
name|sl_Tnexus
decl_stmt|;
name|int
name|ptr
init|=
name|ti
operator|->
name|ti_msgoutlen
decl_stmt|;
name|ti
operator|->
name|ti_msgoutstr
index|[
name|ptr
operator|+
literal|1
index|]
operator|=
name|MSG_EXTEND_WIDELEN
expr_stmt|;
name|ti
operator|->
name|ti_msgoutstr
index|[
name|ptr
operator|+
literal|2
index|]
operator|=
name|MSG_EXTEND_WIDECODE
expr_stmt|;
name|ti
operator|->
name|ti_msgoutstr
index|[
name|ptr
operator|+
literal|3
index|]
operator|=
name|ti
operator|->
name|ti_width
expr_stmt|;
return|return
name|MSG_EXTEND_WIDELEN
operator|+
literal|2
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_msgfunc_identify
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
init|=
name|slp
operator|->
name|sl_Tnexus
decl_stmt|;
name|struct
name|lun_info
modifier|*
name|li
init|=
name|slp
operator|->
name|sl_Lnexus
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
init|=
name|slp
operator|->
name|sl_Qnexus
decl_stmt|;
name|int
name|ptr
init|=
name|ti
operator|->
name|ti_msgoutlen
decl_stmt|;
name|u_int8_t
name|msg
decl_stmt|;
name|msg
operator|=
name|MSG_IDENTIFY
expr_stmt|;
if|if
condition|(
name|cb
operator|==
name|NULL
condition|)
block|{
name|slp
operator|->
name|sl_error
operator||=
name|FATALIO
expr_stmt|;
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_MSG_ABORT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SCSI_LOW_INFO
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
literal|"MSGOUT: nexus unknown"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|scsi_low_is_disconnect_ok
argument_list|(
name|cb
argument_list|)
operator|!=
literal|0
condition|)
name|msg
operator||=
operator|(
name|MSG_IDENTIFY_DISCPRIV
operator||
name|li
operator|->
name|li_lun
operator|)
expr_stmt|;
else|else
name|msg
operator||=
name|li
operator|->
name|li_lun
expr_stmt|;
if|if
condition|(
name|ti
operator|->
name|ti_phase
operator|==
name|PH_MSGOUT
condition|)
block|{
call|(
modifier|*
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_establish_lun_nexus
call|)
argument_list|(
name|slp
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|ccb_tag
operator|==
name|SCSI_LOW_UNKTAG
condition|)
block|{
call|(
modifier|*
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_establish_ccb_nexus
call|)
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|ti
operator|->
name|ti_msgoutstr
index|[
name|ptr
operator|+
literal|0
index|]
operator|=
name|msg
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_msgfunc_abort
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|SCSI_LOW_SETUP_MSGPHASE
argument_list|(
name|slp
argument_list|,
name|MSGPH_ABORT
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_msgfunc_qabort
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|SCSI_LOW_SETUP_MSGPHASE
argument_list|(
name|slp
argument_list|,
name|MSGPH_TERM
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_msgfunc_reset
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|SCSI_LOW_SETUP_MSGPHASE
argument_list|(
name|slp
argument_list|,
name|MSGPH_RESET
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_msgfunc_qtag
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
init|=
name|slp
operator|->
name|sl_Tnexus
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
init|=
name|slp
operator|->
name|sl_Qnexus
decl_stmt|;
name|int
name|ptr
init|=
name|ti
operator|->
name|ti_msgoutlen
decl_stmt|;
if|if
condition|(
name|cb
operator|==
name|NULL
operator|||
name|cb
operator|->
name|ccb_tag
operator|==
name|SCSI_LOW_UNKTAG
condition|)
block|{
name|ti
operator|->
name|ti_msgoutstr
index|[
name|ptr
operator|+
literal|0
index|]
operator|=
name|MSG_NOOP
expr_stmt|;
return|return
literal|1
return|;
block|}
else|else
block|{
name|ti
operator|->
name|ti_msgoutstr
index|[
name|ptr
operator|+
literal|1
index|]
operator|=
operator|(
name|u_int8_t
operator|)
name|cb
operator|->
name|ccb_tag
expr_stmt|;
if|if
condition|(
name|ti
operator|->
name|ti_phase
operator|==
name|PH_MSGOUT
condition|)
block|{
call|(
modifier|*
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_establish_ccb_nexus
call|)
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|2
return|;
block|}
end_function

begin_comment
comment|/*  * The following functions are called when targets give unexpected  * responces in msgin (after msgout).  */
end_comment

begin_function
specifier|static
name|int
name|scsi_low_errfunc_identify
parameter_list|(
name|slp
parameter_list|,
name|msgflags
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|u_int
name|msgflags
decl_stmt|;
block|{
if|if
condition|(
name|slp
operator|->
name|sl_Lnexus
operator|!=
name|NULL
condition|)
block|{
name|slp
operator|->
name|sl_Lnexus
operator|->
name|li_cfgflags
operator|&=
operator|~
name|SCSI_LOW_DISC
expr_stmt|;
name|scsi_low_calcf_lun
argument_list|(
name|slp
operator|->
name|sl_Lnexus
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_errfunc_synch
parameter_list|(
name|slp
parameter_list|,
name|msgflags
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|u_int
name|msgflags
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
init|=
name|slp
operator|->
name|sl_Tnexus
decl_stmt|;
name|MSGIN_PERIOD
argument_list|(
name|ti
argument_list|)
operator|=
literal|0
expr_stmt|;
name|MSGIN_OFFSET
argument_list|(
name|ti
argument_list|)
operator|=
literal|0
expr_stmt|;
name|scsi_low_synch
argument_list|(
name|slp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_errfunc_wide
parameter_list|(
name|slp
parameter_list|,
name|msgflags
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|u_int
name|msgflags
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
init|=
name|slp
operator|->
name|sl_Tnexus
decl_stmt|;
name|MSGIN_WIDTHP
argument_list|(
name|ti
argument_list|)
operator|=
literal|0
expr_stmt|;
name|scsi_low_wide
argument_list|(
name|slp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_errfunc_qtag
parameter_list|(
name|slp
parameter_list|,
name|msgflags
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|u_int
name|msgflags
decl_stmt|;
block|{
if|if
condition|(
operator|(
name|msgflags
operator|&
name|SCSI_LOW_MSG_REJECT
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|slp
operator|->
name|sl_Qnexus
operator|!=
name|NULL
condition|)
block|{
name|scsi_low_deactivate_qtag
argument_list|(
name|slp
operator|->
name|sl_Qnexus
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|slp
operator|->
name|sl_Lnexus
operator|!=
name|NULL
condition|)
block|{
name|slp
operator|->
name|sl_Lnexus
operator|->
name|li_cfgflags
operator|&=
operator|~
name|SCSI_LOW_QTAG
expr_stmt|;
name|scsi_low_calcf_lun
argument_list|(
name|slp
operator|->
name|sl_Lnexus
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%s: scsi_low: qtag msg rejected\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|scsi_low_msgout
parameter_list|(
name|slp
parameter_list|,
name|ti
parameter_list|,
name|fl
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|u_int
name|fl
decl_stmt|;
block|{
name|struct
name|scsi_low_msgout_data
modifier|*
name|mdp
decl_stmt|;
name|int
name|len
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_DIAGNOSTIC
if|if
condition|(
name|ti
operator|!=
name|slp
operator|->
name|sl_Tnexus
condition|)
block|{
name|scsi_low_print
argument_list|(
name|slp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|panic
argument_list|(
literal|"scsi_low_msgout: Target nexus inconsistent"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_DIAGNOSTIC */
name|slp
operator|->
name|sl_ph_count
operator|++
expr_stmt|;
if|if
condition|(
name|slp
operator|->
name|sl_ph_count
operator|>
name|SCSI_LOW_MAX_PHCHANGES
condition|)
block|{
name|printf
argument_list|(
literal|"%s: too many phase changes\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
name|slp
operator|->
name|sl_error
operator||=
name|FATALIO
expr_stmt|;
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_MSG_ABORT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* STEP I. 	 * Scsi phase changes. 	 * Previously msgs asserted are accepted by our target or 	 * processed by scsi_low_msgin. 	 * Thus clear all saved informations. 	 */
if|if
condition|(
operator|(
name|fl
operator|&
name|SCSI_LOW_MSGOUT_INIT
operator|)
operator|!=
literal|0
condition|)
block|{
name|ti
operator|->
name|ti_omsgflags
operator|=
literal|0
expr_stmt|;
name|ti
operator|->
name|ti_emsgflags
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|slp
operator|->
name|sl_atten
operator|==
literal|0
condition|)
block|{
comment|/* STEP II. 	 * We did not assert attention, however still our target required 	 * msgs. Resend previous msgs.  	 */
name|ti
operator|->
name|ti_msgflags
operator||=
name|ti
operator|->
name|ti_omsgflags
expr_stmt|;
name|ti
operator|->
name|ti_omsgflags
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_DIAGNOSTIC
name|printf
argument_list|(
literal|"%s: scsi_low_msgout: retry msgout\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SCSI_LOW_DIAGNOSTIC */
block|}
comment|/* STEP III. 	 * We have no msgs. send MSG_NOOP (OK?) 	 */
if|if
condition|(
name|scsi_low_is_msgout_continue
argument_list|(
name|ti
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_MSG_NOOP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* STEP IV. 	 * Process all msgs 	 */
name|ti
operator|->
name|ti_msgoutlen
operator|=
literal|0
expr_stmt|;
name|slp
operator|->
name|sl_clear_atten
operator|=
literal|0
expr_stmt|;
name|mdp
operator|=
operator|&
name|scsi_low_msgout_data
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
init|;
name|mdp
operator|->
name|md_flags
operator|!=
name|SCSI_LOW_MSG_ALL
condition|;
name|mdp
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ti
operator|->
name|ti_msgflags
operator|&
name|mdp
operator|->
name|md_flags
operator|)
operator|!=
literal|0
condition|)
block|{
name|ti
operator|->
name|ti_omsgflags
operator||=
name|mdp
operator|->
name|md_flags
expr_stmt|;
name|ti
operator|->
name|ti_msgflags
operator|&=
operator|~
name|mdp
operator|->
name|md_flags
expr_stmt|;
name|ti
operator|->
name|ti_emsgflags
operator|=
name|mdp
operator|->
name|md_flags
expr_stmt|;
name|ti
operator|->
name|ti_msgoutstr
index|[
name|ti
operator|->
name|ti_msgoutlen
index|]
operator|=
name|mdp
operator|->
name|md_msg
expr_stmt|;
if|if
condition|(
name|mdp
operator|->
name|md_msgfunc
operator|!=
name|NULL
condition|)
name|len
operator|=
call|(
modifier|*
name|mdp
operator|->
name|md_msgfunc
call|)
argument_list|(
name|slp
argument_list|)
expr_stmt|;
else|else
name|len
operator|=
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_DIAGNOSTIC
name|scsi_low_msg_log_write
argument_list|(
operator|&
name|ti
operator|->
name|ti_log_msgout
argument_list|,
operator|&
name|ti
operator|->
name|ti_msgoutstr
index|[
name|ti
operator|->
name|ti_msgoutlen
index|]
argument_list|,
name|len
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SCSI_LOW_DIAGNOSTIC */
name|ti
operator|->
name|ti_msgoutlen
operator|+=
name|len
expr_stmt|;
if|if
condition|(
operator|(
name|mdp
operator|->
name|md_condition
operator|&
name|MSG_RELEASE_ATN
operator|)
operator|!=
literal|0
condition|)
block|{
name|slp
operator|->
name|sl_clear_atten
operator|=
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|fl
operator|&
name|SCSI_LOW_MSGOUT_UNIFY
operator|)
operator|==
literal|0
operator|||
name|ti
operator|->
name|ti_msgflags
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|ti
operator|->
name|ti_msgoutlen
operator|>=
name|SCSI_LOW_MAX_MSGLEN
operator|-
literal|5
condition|)
break|break;
block|}
block|}
if|if
condition|(
name|scsi_low_is_msgout_continue
argument_list|(
name|ti
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
name|slp
operator|->
name|sl_clear_atten
operator|=
literal|1
expr_stmt|;
return|return
name|ti
operator|->
name|ti_msgoutlen
return|;
block|}
end_function

begin_comment
comment|/**************************************************************  * msgin  **************************************************************/
end_comment

begin_function
specifier|static
name|int
name|scsi_low_msginfunc_noop
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_msginfunc_rejop
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
init|=
name|slp
operator|->
name|sl_Tnexus
decl_stmt|;
name|u_int8_t
name|msg
init|=
name|ti
operator|->
name|ti_msgin
index|[
literal|0
index|]
decl_stmt|;
name|printf
argument_list|(
literal|"%s: MSGIN: msg 0x%x rejected\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|,
operator|(
name|u_int
operator|)
name|msg
argument_list|)
expr_stmt|;
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_MSG_REJECT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_msginfunc_cc
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
name|SCSI_LOW_SETUP_MSGPHASE
argument_list|(
name|slp
argument_list|,
name|MSGPH_CMDC
argument_list|)
expr_stmt|;
comment|/* validate status */
if|if
condition|(
name|slp
operator|->
name|sl_Qnexus
operator|==
name|NULL
condition|)
return|return
name|ENOENT
return|;
name|slp
operator|->
name|sl_Qnexus
operator|->
name|ccb_sscp
operator|.
name|scp_status
operator|=
name|slp
operator|->
name|sl_scp
operator|.
name|scp_status
expr_stmt|;
name|li
operator|=
name|slp
operator|->
name|sl_Lnexus
expr_stmt|;
switch|switch
condition|(
name|slp
operator|->
name|sl_scp
operator|.
name|scp_status
condition|)
block|{
case|case
name|ST_GOOD
case|:
name|li
operator|->
name|li_maxnqio
operator|=
name|li
operator|->
name|li_maxnexus
expr_stmt|;
break|break;
case|case
name|ST_CHKCOND
case|:
name|li
operator|->
name|li_maxnqio
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|li
operator|->
name|li_qflags
operator|&
name|SCSI_LOW_QFLAG_CA_QCLEAR
condition|)
name|scsi_low_reset_nexus_lun
argument_list|(
name|slp
argument_list|,
name|li
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|ST_BUSY
case|:
name|li
operator|->
name|li_maxnqio
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|ST_QUEFULL
case|:
if|if
condition|(
name|li
operator|->
name|li_maxnexus
operator|>=
name|li
operator|->
name|li_nqio
condition|)
name|li
operator|->
name|li_maxnexus
operator|=
name|li
operator|->
name|li_nqio
operator|-
literal|1
expr_stmt|;
name|li
operator|->
name|li_maxnqio
operator|=
name|li
operator|->
name|li_maxnexus
expr_stmt|;
break|break;
case|case
name|ST_INTERGOOD
case|:
case|case
name|ST_INTERMET
case|:
name|slp
operator|->
name|sl_error
operator||=
name|MSGERR
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_msginfunc_lcc
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
name|struct
name|slccb
modifier|*
name|ncb
decl_stmt|,
modifier|*
name|cb
decl_stmt|;
name|ti
operator|=
name|slp
operator|->
name|sl_Tnexus
expr_stmt|;
name|li
operator|=
name|slp
operator|->
name|sl_Lnexus
expr_stmt|;
if|if
condition|(
operator|(
name|cb
operator|=
name|slp
operator|->
name|sl_Qnexus
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|bad
goto|;
name|cb
operator|->
name|ccb_sscp
operator|.
name|scp_status
operator|=
name|slp
operator|->
name|sl_scp
operator|.
name|scp_status
expr_stmt|;
switch|switch
condition|(
name|slp
operator|->
name|sl_scp
operator|.
name|scp_status
condition|)
block|{
case|case
name|ST_INTERGOOD
case|:
case|case
name|ST_INTERMET
case|:
name|li
operator|->
name|li_maxnqio
operator|=
name|li
operator|->
name|li_maxnexus
expr_stmt|;
break|break;
default|default:
name|slp
operator|->
name|sl_error
operator||=
name|MSGERR
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|li
operator|->
name|li_flags
operator|&
name|SCSI_LOW_LINK
operator|)
operator|==
literal|0
condition|)
goto|goto
name|bad
goto|;
name|cb
operator|->
name|ccb_error
operator||=
name|slp
operator|->
name|sl_error
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|ccb_error
operator|!=
literal|0
condition|)
goto|goto
name|bad
goto|;
for|for
control|(
name|ncb
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|slp
operator|->
name|sl_start
argument_list|)
init|;
name|ncb
operator|!=
name|NULL
condition|;
name|ncb
operator|=
name|TAILQ_NEXT
argument_list|(
name|ncb
argument_list|,
name|ccb_chain
argument_list|)
control|)
block|{
if|if
condition|(
name|ncb
operator|->
name|li
operator|==
name|li
condition|)
goto|goto
name|cmd_link_start
goto|;
block|}
name|bad
label|:
name|SCSI_LOW_SETUP_MSGPHASE
argument_list|(
name|slp
argument_list|,
name|MSGPH_LCTERM
argument_list|)
expr_stmt|;
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_MSG_REJECT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|EIO
return|;
name|cmd_link_start
label|:
name|ncb
operator|->
name|ccb_flags
operator|&=
operator|~
name|CCB_STARTQ
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|slp
operator|->
name|sl_start
argument_list|,
name|ncb
argument_list|,
name|ccb_chain
argument_list|)
expr_stmt|;
name|scsi_low_dealloc_qtag
argument_list|(
name|ncb
argument_list|)
expr_stmt|;
name|ncb
operator|->
name|ccb_tag
operator|=
name|cb
operator|->
name|ccb_tag
expr_stmt|;
name|ncb
operator|->
name|ccb_otag
operator|=
name|cb
operator|->
name|ccb_otag
expr_stmt|;
name|cb
operator|->
name|ccb_tag
operator|=
name|SCSI_LOW_UNKTAG
expr_stmt|;
name|cb
operator|->
name|ccb_otag
operator|=
name|SCSI_LOW_UNKTAG
expr_stmt|;
if|if
condition|(
name|scsi_low_done
argument_list|(
name|slp
argument_list|,
name|cb
argument_list|)
operator|==
name|SCSI_LOW_DONE_RETRY
condition|)
name|panic
argument_list|(
literal|"%s: linked ccb retried"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
name|slp
operator|->
name|sl_Qnexus
operator|=
name|ncb
expr_stmt|;
name|slp
operator|->
name|sl_ph_count
operator|=
literal|0
expr_stmt|;
name|ncb
operator|->
name|ccb_error
operator|=
literal|0
expr_stmt|;
name|ncb
operator|->
name|ccb_datalen
operator|=
operator|-
literal|1
expr_stmt|;
name|ncb
operator|->
name|ccb_scp
operator|.
name|scp_status
operator|=
name|ST_UNKNOWN
expr_stmt|;
name|ncb
operator|->
name|ccb_flags
operator|&=
operator|~
name|CCB_INTERNAL
expr_stmt|;
name|scsi_low_init_msgsys
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|)
expr_stmt|;
call|(
modifier|*
name|slp
operator|->
name|sl_osdep_fp
operator|->
name|scsi_low_osdep_ccb_setup
call|)
argument_list|(
name|slp
argument_list|,
name|ncb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ncb
operator|->
name|ccb_tcmax
operator|<
name|SCSI_LOW_MIN_TOUT
condition|)
name|ncb
operator|->
name|ccb_tcmax
operator|=
name|SCSI_LOW_MIN_TOUT
expr_stmt|;
name|ncb
operator|->
name|ccb_tc
operator|=
name|ncb
operator|->
name|ccb_tcmax
expr_stmt|;
comment|/* setup saved scsi data pointer */
name|ncb
operator|->
name|ccb_sscp
operator|=
name|ncb
operator|->
name|ccb_scp
expr_stmt|;
name|slp
operator|->
name|sl_scp
operator|=
name|ncb
operator|->
name|ccb_sscp
expr_stmt|;
name|slp
operator|->
name|sl_error
operator|=
name|ncb
operator|->
name|ccb_error
expr_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_DIAGNOSTIC
name|scsi_low_msg_log_init
argument_list|(
operator|&
name|ti
operator|->
name|ti_log_msgin
argument_list|)
expr_stmt|;
name|scsi_low_msg_log_init
argument_list|(
operator|&
name|ti
operator|->
name|ti_log_msgout
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SCSI_LOW_DIAGNOSTIC */
return|return
name|EJUSTRETURN
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_msginfunc_disc
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|SCSI_LOW_SETUP_MSGPHASE
argument_list|(
name|slp
argument_list|,
name|MSGPH_DISC
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_msginfunc_sdp
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|struct
name|slccb
modifier|*
name|cb
init|=
name|slp
operator|->
name|sl_Qnexus
decl_stmt|;
if|if
condition|(
name|cb
operator|!=
name|NULL
condition|)
block|{
name|cb
operator|->
name|ccb_sscp
operator|.
name|scp_datalen
operator|=
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
expr_stmt|;
name|cb
operator|->
name|ccb_sscp
operator|.
name|scp_data
operator|=
name|slp
operator|->
name|sl_scp
operator|.
name|scp_data
expr_stmt|;
block|}
else|else
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|slp
operator|->
name|sl_Tnexus
argument_list|,
name|SCSI_LOW_MSG_REJECT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_msginfunc_rp
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
if|if
condition|(
name|slp
operator|->
name|sl_Qnexus
operator|!=
name|NULL
condition|)
name|slp
operator|->
name|sl_scp
operator|=
name|slp
operator|->
name|sl_Qnexus
operator|->
name|ccb_sscp
expr_stmt|;
else|else
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|slp
operator|->
name|sl_Tnexus
argument_list|,
name|SCSI_LOW_MSG_REJECT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_synch
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
init|=
name|slp
operator|->
name|sl_Tnexus
decl_stmt|;
name|u_int
name|period
init|=
literal|0
decl_stmt|,
name|offset
init|=
literal|0
decl_stmt|,
name|speed
decl_stmt|;
name|u_char
modifier|*
name|s
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|(
name|MSGIN_PERIOD
argument_list|(
name|ti
argument_list|)
operator|>=
name|ti
operator|->
name|ti_maxsynch
operator|.
name|period
operator|&&
name|MSGIN_OFFSET
argument_list|(
name|ti
argument_list|)
operator|<=
name|ti
operator|->
name|ti_maxsynch
operator|.
name|offset
operator|)
operator|||
name|MSGIN_OFFSET
argument_list|(
name|ti
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|offset
operator|=
name|MSGIN_OFFSET
argument_list|(
name|ti
argument_list|)
operator|)
operator|!=
literal|0
condition|)
name|period
operator|=
name|MSGIN_PERIOD
argument_list|(
name|ti
argument_list|)
expr_stmt|;
name|s
operator|=
name|offset
condition|?
literal|"synchronous"
else|:
literal|"async"
expr_stmt|;
block|}
else|else
block|{
comment|/* XXX: 		 * Target seems to be brain damaged. 		 * Force async transfer. 		 */
name|ti
operator|->
name|ti_maxsynch
operator|.
name|period
operator|=
literal|0
expr_stmt|;
name|ti
operator|->
name|ti_maxsynch
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
name|printf
argument_list|(
literal|"%s: target brain damaged. async transfer\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|ti
operator|->
name|ti_maxsynch
operator|.
name|period
operator|=
name|period
expr_stmt|;
name|ti
operator|->
name|ti_maxsynch
operator|.
name|offset
operator|=
name|offset
expr_stmt|;
name|error
operator|=
call|(
modifier|*
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_msg
call|)
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_MSG_SYNCH
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
comment|/* XXX: 		 * Current period and offset are not acceptable  		 * for our adapter. 		 * The adapter changes max synch and max offset. 		 */
name|printf
argument_list|(
literal|"%s: synch neg failed. retry synch msg neg ...\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|ti
operator|->
name|ti_osynch
operator|=
name|ti
operator|->
name|ti_maxsynch
expr_stmt|;
if|if
condition|(
name|offset
operator|>
literal|0
condition|)
block|{
name|ti
operator|->
name|ti_setup_msg_done
operator||=
name|SCSI_LOW_MSG_SYNCH
expr_stmt|;
block|}
comment|/* inform data */
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_show_result
operator|&
name|SHOW_SYNCH_NEG
operator|)
operator|!=
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|SCSI_LOW_NEGOTIATE_BEFORE_SENSE
name|struct
name|slccb
modifier|*
name|cb
init|=
name|slp
operator|->
name|sl_Qnexus
decl_stmt|;
if|if
condition|(
name|cb
operator|!=
name|NULL
operator|&&
operator|(
name|cb
operator|->
name|ccb_flags
operator|&
name|CCB_SENSE
operator|)
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
endif|#
directive|endif
comment|/* SCSI_LOW_NEGOTIATE_BEFORE_SENSE */
name|printf
argument_list|(
literal|"%s(%d:*):<%s> offset %d period %dns "
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|,
name|ti
operator|->
name|ti_id
argument_list|,
name|s
argument_list|,
name|offset
argument_list|,
name|period
operator|*
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|period
operator|!=
literal|0
condition|)
block|{
name|speed
operator|=
literal|1000
operator|*
literal|10
operator|/
operator|(
name|period
operator|*
literal|4
operator|)
expr_stmt|;
name|printf
argument_list|(
literal|"%d.%d M/s"
argument_list|,
name|speed
operator|/
literal|10
argument_list|,
name|speed
operator|%
literal|10
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_wide
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
init|=
name|slp
operator|->
name|sl_Tnexus
decl_stmt|;
name|int
name|error
decl_stmt|;
name|ti
operator|->
name|ti_width
operator|=
name|MSGIN_WIDTHP
argument_list|(
name|ti
argument_list|)
expr_stmt|;
name|error
operator|=
call|(
modifier|*
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_msg
call|)
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_MSG_WIDE
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
comment|/* XXX: 		 * Current width is not acceptable for our adapter. 		 * The adapter changes max width. 		 */
name|printf
argument_list|(
literal|"%s: wide neg failed. retry wide msg neg ...\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|ti
operator|->
name|ti_owidth
operator|=
name|ti
operator|->
name|ti_width
expr_stmt|;
if|if
condition|(
name|ti
operator|->
name|ti_width
operator|>
name|SCSI_LOW_BUS_WIDTH_8
condition|)
block|{
name|ti
operator|->
name|ti_setup_msg_done
operator||=
operator|(
name|SCSI_LOW_MSG_SYNCH
operator||
name|SCSI_LOW_MSG_WIDE
operator|)
expr_stmt|;
block|}
comment|/* inform data */
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_show_result
operator|&
name|SHOW_WIDE_NEG
operator|)
operator|!=
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|SCSI_LOW_NEGOTIATE_BEFORE_SENSE
name|struct
name|slccb
modifier|*
name|cb
init|=
name|slp
operator|->
name|sl_Qnexus
decl_stmt|;
if|if
condition|(
name|cb
operator|!=
name|NULL
operator|&&
operator|(
name|cb
operator|->
name|ccb_flags
operator|&
name|CCB_SENSE
operator|)
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
endif|#
directive|endif
comment|/* SCSI_LOW_NEGOTIATE_BEFORE_SENSE */
name|printf
argument_list|(
literal|"%s(%d:*): transfer width %d bits\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|,
name|ti
operator|->
name|ti_id
argument_list|,
literal|1
operator|<<
operator|(
literal|3
operator|+
name|ti
operator|->
name|ti_width
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_msginfunc_simple_qtag
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
init|=
name|slp
operator|->
name|sl_Tnexus
decl_stmt|;
name|scsi_low_tag_t
name|etag
init|=
operator|(
name|scsi_low_tag_t
operator|)
name|ti
operator|->
name|ti_msgin
index|[
literal|1
index|]
decl_stmt|;
if|if
condition|(
name|slp
operator|->
name|sl_Qnexus
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|slp
operator|->
name|sl_Qnexus
operator|->
name|ccb_tag
operator|!=
name|etag
condition|)
block|{
name|slp
operator|->
name|sl_error
operator||=
name|FATALIO
expr_stmt|;
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_MSG_ABORT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SCSI_LOW_INFO
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
literal|"MSGIN: qtag mismatch"
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|scsi_low_establish_ccb
argument_list|(
name|ti
argument_list|,
name|slp
operator|->
name|sl_Lnexus
argument_list|,
name|etag
argument_list|)
operator|==
name|NULL
condition|)
block|{
ifdef|#
directive|ifdef
name|SCSI_LOW_DEBUG
if|if
condition|(
name|SCSI_LOW_DEBUG_TEST_GO
argument_list|(
name|SCSI_LOW_NEXUS_CHECK
argument_list|,
name|ti
operator|->
name|ti_id
argument_list|)
condition|)
return|return
literal|0
return|;
endif|#
directive|endif
comment|/* SCSI_LOW_DEBUG */
name|slp
operator|->
name|sl_error
operator||=
name|FATALIO
expr_stmt|;
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_MSG_ABORT_QTAG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SCSI_LOW_INFO
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
literal|"MSGIN: taged ccb not found"
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_msginfunc_i_wide_residue
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
init|=
name|slp
operator|->
name|sl_Tnexus
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
init|=
name|slp
operator|->
name|sl_Qnexus
decl_stmt|;
name|int
name|res
init|=
operator|(
name|int
operator|)
name|ti
operator|->
name|ti_msgin
index|[
literal|1
index|]
decl_stmt|;
if|if
condition|(
name|cb
operator|==
name|NULL
operator|||
name|res
operator|<=
literal|0
operator|||
operator|(
name|ti
operator|->
name|ti_width
operator|==
name|SCSI_LOW_BUS_WIDTH_16
operator|&&
name|res
operator|>
literal|1
operator|)
operator|||
operator|(
name|ti
operator|->
name|ti_width
operator|==
name|SCSI_LOW_BUS_WIDTH_32
operator|&&
name|res
operator|>
literal|3
operator|)
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
operator|+
name|res
operator|>
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_datalen
condition|)
return|return
name|EINVAL
return|;
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
operator|+=
name|res
expr_stmt|;
name|slp
operator|->
name|sl_scp
operator|.
name|scp_data
operator|-=
name|res
expr_stmt|;
name|scsi_low_data_finish
argument_list|(
name|slp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_msginfunc_ext
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|struct
name|slccb
modifier|*
name|cb
init|=
name|slp
operator|->
name|sl_Qnexus
decl_stmt|;
name|struct
name|lun_info
modifier|*
name|li
init|=
name|slp
operator|->
name|sl_Lnexus
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
init|=
name|slp
operator|->
name|sl_Tnexus
decl_stmt|;
name|int
name|count
decl_stmt|,
name|retry
decl_stmt|;
name|u_int32_t
modifier|*
name|ptr
decl_stmt|;
if|if
condition|(
name|ti
operator|->
name|ti_msginptr
operator|==
literal|2
condition|)
block|{
name|ti
operator|->
name|ti_msginlen
operator|=
name|ti
operator|->
name|ti_msgin
index|[
literal|1
index|]
operator|+
literal|2
expr_stmt|;
return|return
literal|0
return|;
block|}
switch|switch
condition|(
name|MKMSG_EXTEND
argument_list|(
name|ti
operator|->
name|ti_msgin
index|[
literal|1
index|]
argument_list|,
name|ti
operator|->
name|ti_msgin
index|[
literal|2
index|]
argument_list|)
condition|)
block|{
case|case
name|MKMSG_EXTEND
argument_list|(
name|MSG_EXTEND_MDPLEN
argument_list|,
name|MSG_EXTEND_MDPCODE
argument_list|)
case|:
if|if
condition|(
name|cb
operator|==
name|NULL
condition|)
break|break;
name|ptr
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
operator|&
name|ti
operator|->
name|ti_msgin
index|[
literal|3
index|]
operator|)
expr_stmt|;
name|count
operator|=
operator|(
name|int
operator|)
name|htonl
argument_list|(
call|(
name|long
call|)
argument_list|(
operator|*
name|ptr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
operator|-
name|count
operator|<
literal|0
operator|||
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
operator|-
name|count
operator|>
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_datalen
condition|)
break|break;
name|slp
operator|->
name|sl_scp
operator|.
name|scp_datalen
operator|-=
name|count
expr_stmt|;
name|slp
operator|->
name|sl_scp
operator|.
name|scp_data
operator|+=
name|count
expr_stmt|;
return|return
literal|0
return|;
case|case
name|MKMSG_EXTEND
argument_list|(
name|MSG_EXTEND_SYNCHLEN
argument_list|,
name|MSG_EXTEND_SYNCHCODE
argument_list|)
case|:
if|if
condition|(
name|li
operator|==
name|NULL
condition|)
break|break;
name|retry
operator|=
name|scsi_low_synch
argument_list|(
name|slp
argument_list|)
expr_stmt|;
if|if
condition|(
name|retry
operator|!=
literal|0
operator|||
operator|(
name|ti
operator|->
name|ti_emsgflags
operator|&
name|SCSI_LOW_MSG_SYNCH
operator|)
operator|==
literal|0
condition|)
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_MSG_SYNCH
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_DEBUG
if|if
condition|(
name|SCSI_LOW_DEBUG_TEST_GO
argument_list|(
name|SCSI_LOW_ATTEN_CHECK
argument_list|,
name|ti
operator|->
name|ti_id
argument_list|)
condition|)
block|{
name|scsi_low_test_atten
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_MSG_SYNCH
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_DEBUG */
return|return
literal|0
return|;
case|case
name|MKMSG_EXTEND
argument_list|(
name|MSG_EXTEND_WIDELEN
argument_list|,
name|MSG_EXTEND_WIDECODE
argument_list|)
case|:
if|if
condition|(
name|li
operator|==
name|NULL
condition|)
break|break;
name|retry
operator|=
name|scsi_low_wide
argument_list|(
name|slp
argument_list|)
expr_stmt|;
if|if
condition|(
name|retry
operator|!=
literal|0
operator|||
operator|(
name|ti
operator|->
name|ti_emsgflags
operator|&
name|SCSI_LOW_MSG_WIDE
operator|)
operator|==
literal|0
condition|)
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_MSG_WIDE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
default|default:
break|break;
block|}
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_MSG_REJECT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_msginfunc_parity
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
init|=
name|slp
operator|->
name|sl_Tnexus
decl_stmt|;
comment|/* only I -> T, invalid! */
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_MSG_REJECT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_msginfunc_msg_reject
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
init|=
name|slp
operator|->
name|sl_Tnexus
decl_stmt|;
name|struct
name|scsi_low_msgout_data
modifier|*
name|mdp
decl_stmt|;
name|u_int
name|msgflags
decl_stmt|;
if|if
condition|(
name|ti
operator|->
name|ti_emsgflags
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: msg flags [0x%x] rejected\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|,
name|ti
operator|->
name|ti_emsgflags
argument_list|)
expr_stmt|;
name|msgflags
operator|=
name|SCSI_LOW_MSG_REJECT
expr_stmt|;
name|mdp
operator|=
operator|&
name|scsi_low_msgout_data
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
init|;
name|mdp
operator|->
name|md_flags
operator|!=
name|SCSI_LOW_MSG_ALL
condition|;
name|mdp
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ti
operator|->
name|ti_emsgflags
operator|&
name|mdp
operator|->
name|md_flags
operator|)
operator|!=
literal|0
condition|)
block|{
name|ti
operator|->
name|ti_emsgflags
operator|&=
operator|~
name|mdp
operator|->
name|md_flags
expr_stmt|;
if|if
condition|(
name|mdp
operator|->
name|md_errfunc
operator|!=
name|NULL
condition|)
call|(
modifier|*
name|mdp
operator|->
name|md_errfunc
call|)
argument_list|(
name|slp
argument_list|,
name|msgflags
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return
literal|0
return|;
block|}
else|else
block|{
name|SCSI_LOW_INFO
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
literal|"MSGIN: rejected msg not found"
argument_list|)
expr_stmt|;
name|slp
operator|->
name|sl_error
operator||=
name|MSGERR
expr_stmt|;
block|}
return|return
name|EINVAL
return|;
block|}
end_function

begin_function
name|int
name|scsi_low_msgin
parameter_list|(
name|slp
parameter_list|,
name|ti
parameter_list|,
name|c
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|u_int
name|c
decl_stmt|;
block|{
name|struct
name|scsi_low_msgin_data
modifier|*
name|sdp
decl_stmt|;
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
name|u_int8_t
name|msg
decl_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_DIAGNOSTIC
if|if
condition|(
name|ti
operator|!=
name|slp
operator|->
name|sl_Tnexus
condition|)
block|{
name|scsi_low_print
argument_list|(
name|slp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|panic
argument_list|(
literal|"scsi_low_msgin: Target nexus inconsistent"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_DIAGNOSTIC */
comment|/* 	 * Phase changes, clear the pointer. 	 */
if|if
condition|(
name|ti
operator|->
name|ti_ophase
operator|!=
name|ti
operator|->
name|ti_phase
condition|)
block|{
name|MSGINPTR_CLR
argument_list|(
name|ti
argument_list|)
expr_stmt|;
name|ti
operator|->
name|ti_msgin_parity_error
operator|=
literal|0
expr_stmt|;
name|slp
operator|->
name|sl_ph_count
operator|++
expr_stmt|;
if|if
condition|(
name|slp
operator|->
name|sl_ph_count
operator|>
name|SCSI_LOW_MAX_PHCHANGES
condition|)
block|{
name|printf
argument_list|(
literal|"%s: too many phase changes\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
name|slp
operator|->
name|sl_error
operator||=
name|FATALIO
expr_stmt|;
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_MSG_ABORT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * Store a current messages byte into buffer and  	 * wait for the completion of the current msg. 	 */
name|ti
operator|->
name|ti_msgin
index|[
name|ti
operator|->
name|ti_msginptr
operator|++
index|]
operator|=
operator|(
name|u_int8_t
operator|)
name|c
expr_stmt|;
if|if
condition|(
name|ti
operator|->
name|ti_msginptr
operator|>=
name|SCSI_LOW_MAX_MSGLEN
condition|)
block|{
name|ti
operator|->
name|ti_msginptr
operator|=
name|SCSI_LOW_MAX_MSGLEN
operator|-
literal|1
expr_stmt|;
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_MSG_REJECT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Check parity errors. 	 */
if|if
condition|(
operator|(
name|c
operator|&
name|SCSI_LOW_DATA_PE
operator|)
operator|!=
literal|0
condition|)
block|{
name|ti
operator|->
name|ti_msgin_parity_error
operator|++
expr_stmt|;
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_MSG_PARITY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|ti
operator|->
name|ti_msgin_parity_error
operator|!=
literal|0
condition|)
goto|goto
name|out
goto|;
comment|/* 	 * Calculate messages length. 	 */
name|msg
operator|=
name|ti
operator|->
name|ti_msgin
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|msg
operator|<
name|MSGIN_DATA_LAST
condition|)
name|sdp
operator|=
operator|&
name|scsi_low_msgin_data
index|[
name|msg
index|]
expr_stmt|;
else|else
name|sdp
operator|=
operator|&
name|scsi_low_msgin_data
index|[
name|MSGIN_DATA_LAST
index|]
expr_stmt|;
if|if
condition|(
name|ti
operator|->
name|ti_msginlen
operator|==
literal|0
condition|)
block|{
name|ti
operator|->
name|ti_msginlen
operator|=
name|sdp
operator|->
name|md_len
expr_stmt|;
block|}
comment|/* 	 * Check comletion. 	 */
if|if
condition|(
name|ti
operator|->
name|ti_msginptr
operator|<
name|ti
operator|->
name|ti_msginlen
condition|)
return|return
name|EJUSTRETURN
return|;
comment|/* 	 * Do process. 	 */
if|if
condition|(
operator|(
name|msg
operator|&
name|MSG_IDENTIFY
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
call|(
modifier|*
name|sdp
operator|->
name|md_msgfunc
call|)
argument_list|(
name|slp
argument_list|)
operator|)
operator|==
name|EJUSTRETURN
condition|)
return|return
name|EJUSTRETURN
return|;
block|}
else|else
block|{
name|li
operator|=
name|slp
operator|->
name|sl_Lnexus
expr_stmt|;
if|if
condition|(
name|li
operator|==
name|NULL
condition|)
block|{
name|li
operator|=
name|scsi_low_alloc_li
argument_list|(
name|ti
argument_list|,
name|MSGCMD_LUN
argument_list|(
name|msg
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|li
operator|==
name|NULL
condition|)
goto|goto
name|badlun
goto|;
name|slp
operator|->
name|sl_Lnexus
operator|=
name|li
expr_stmt|;
call|(
modifier|*
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_establish_lun_nexus
call|)
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|MSGCMD_LUN
argument_list|(
name|msg
argument_list|)
operator|!=
name|li
operator|->
name|li_lun
condition|)
goto|goto
name|badlun
goto|;
block|}
if|if
condition|(
name|slp
operator|->
name|sl_Qnexus
operator|==
name|NULL
operator|&&
name|li
operator|->
name|li_nqio
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|scsi_low_establish_ccb
argument_list|(
name|ti
argument_list|,
name|li
argument_list|,
name|SCSI_LOW_UNKTAG
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|SCSI_LOW_DEBUG
if|if
condition|(
name|SCSI_LOW_DEBUG_TEST_GO
argument_list|(
name|SCSI_LOW_NEXUS_CHECK
argument_list|,
name|ti
operator|->
name|ti_id
argument_list|)
operator|!=
literal|0
condition|)
block|{
goto|goto
name|out
goto|;
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_DEBUG */
goto|goto
name|badlun
goto|;
block|}
block|}
block|}
goto|goto
name|out
goto|;
comment|/* 	 * Msg process completed, reset msgin pointer and assert ATN if desired. 	 */
name|badlun
label|:
name|slp
operator|->
name|sl_error
operator||=
name|FATALIO
expr_stmt|;
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|SCSI_LOW_MSG_ABORT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SCSI_LOW_INFO
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
literal|"MSGIN: identify wrong"
argument_list|)
expr_stmt|;
name|out
label|:
if|if
condition|(
name|ti
operator|->
name|ti_msginptr
operator|<
name|ti
operator|->
name|ti_msginlen
condition|)
return|return
name|EJUSTRETURN
return|;
ifdef|#
directive|ifdef
name|SCSI_LOW_DIAGNOSTIC
name|scsi_low_msg_log_write
argument_list|(
operator|&
name|ti
operator|->
name|ti_log_msgin
argument_list|,
operator|&
name|ti
operator|->
name|ti_msgin
index|[
literal|0
index|]
argument_list|,
name|ti
operator|->
name|ti_msginlen
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SCSI_LOW_DIAGNOSTIC */
name|MSGINPTR_CLR
argument_list|(
name|ti
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**********************************************************  * disconnect  **********************************************************/
end_comment

begin_function
name|int
name|scsi_low_disconnected
parameter_list|(
name|slp
parameter_list|,
name|ti
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
block|{
name|struct
name|slccb
modifier|*
name|cb
init|=
name|slp
operator|->
name|sl_Qnexus
decl_stmt|;
comment|/* check phase completion */
switch|switch
condition|(
name|slp
operator|->
name|sl_msgphase
condition|)
block|{
case|case
name|MSGPH_RESET
case|:
name|scsi_low_statusin
argument_list|(
name|slp
argument_list|,
name|slp
operator|->
name|sl_Tnexus
argument_list|,
name|ST_GOOD
argument_list|)
expr_stmt|;
name|scsi_low_msginfunc_cc
argument_list|(
name|slp
argument_list|)
expr_stmt|;
name|scsi_low_reset_nexus_target
argument_list|(
name|slp
argument_list|,
name|slp
operator|->
name|sl_Tnexus
argument_list|,
literal|0
argument_list|)
expr_stmt|;
goto|goto
name|io_resume
goto|;
case|case
name|MSGPH_ABORT
case|:
name|scsi_low_statusin
argument_list|(
name|slp
argument_list|,
name|slp
operator|->
name|sl_Tnexus
argument_list|,
name|ST_GOOD
argument_list|)
expr_stmt|;
name|scsi_low_msginfunc_cc
argument_list|(
name|slp
argument_list|)
expr_stmt|;
name|scsi_low_reset_nexus_lun
argument_list|(
name|slp
argument_list|,
name|slp
operator|->
name|sl_Lnexus
argument_list|,
literal|0
argument_list|)
expr_stmt|;
goto|goto
name|io_resume
goto|;
case|case
name|MSGPH_TERM
case|:
name|scsi_low_statusin
argument_list|(
name|slp
argument_list|,
name|slp
operator|->
name|sl_Tnexus
argument_list|,
name|ST_GOOD
argument_list|)
expr_stmt|;
name|scsi_low_msginfunc_cc
argument_list|(
name|slp
argument_list|)
expr_stmt|;
goto|goto
name|io_resume
goto|;
case|case
name|MSGPH_DISC
case|:
if|if
condition|(
name|cb
operator|!=
name|NULL
condition|)
block|{
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
name|li
operator|=
name|cb
operator|->
name|li
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|li
operator|->
name|li_discq
argument_list|,
name|cb
argument_list|,
name|ccb_chain
argument_list|)
expr_stmt|;
name|cb
operator|->
name|ccb_flags
operator||=
name|CCB_DISCQ
expr_stmt|;
name|cb
operator|->
name|ccb_error
operator||=
name|slp
operator|->
name|sl_error
expr_stmt|;
name|li
operator|->
name|li_disc
operator|++
expr_stmt|;
name|ti
operator|->
name|ti_disc
operator|++
expr_stmt|;
name|slp
operator|->
name|sl_disc
operator|++
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|SCSI_LOW_STATICS
name|scsi_low_statics
operator|.
name|nexus_disconnected
operator|++
expr_stmt|;
endif|#
directive|endif
comment|/* SCSI_LOW_STATICS */
ifdef|#
directive|ifdef
name|SCSI_LOW_DEBUG
if|if
condition|(
name|SCSI_LOW_DEBUG_GO
argument_list|(
name|SCSI_LOW_DEBUG_DISC
argument_list|,
name|ti
operator|->
name|ti_id
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"## SCSI_LOW_DISCONNECTED ===============\n"
argument_list|)
expr_stmt|;
name|scsi_low_print
argument_list|(
name|slp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_DEBUG */
break|break;
case|case
name|MSGPH_NULL
case|:
name|slp
operator|->
name|sl_error
operator||=
name|FATALIO
expr_stmt|;
if|if
condition|(
name|ti
operator|->
name|ti_phase
operator|==
name|PH_SELSTART
condition|)
name|slp
operator|->
name|sl_error
operator||=
name|SELTIMEOUTIO
expr_stmt|;
else|else
name|slp
operator|->
name|sl_error
operator||=
name|UBFERR
expr_stmt|;
comment|/* fall through */
case|case
name|MSGPH_LCTERM
case|:
case|case
name|MSGPH_CMDC
case|:
name|io_resume
label|:
if|if
condition|(
name|cb
operator|==
name|NULL
condition|)
break|break;
ifdef|#
directive|ifdef
name|SCSI_LOW_DEBUG
if|if
condition|(
name|SCSI_LOW_DEBUG_TEST_GO
argument_list|(
name|SCSI_LOW_ATTEN_CHECK
argument_list|,
name|ti
operator|->
name|ti_id
argument_list|)
condition|)
block|{
if|if
condition|(
name|cb
operator|->
name|ccb_omsgoutflag
operator|==
name|SCSI_LOW_MSG_NOOP
operator|&&
operator|(
name|cb
operator|->
name|ccb_msgoutflag
operator|!=
literal|0
operator|||
operator|(
name|ti
operator|->
name|ti_msgflags
operator|&
name|SCSI_LOW_MSG_NOOP
operator|)
operator|)
condition|)
block|{
name|scsi_low_info
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
literal|"ATTEN CHECK FAILED"
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_DEBUG */
name|cb
operator|->
name|ccb_error
operator||=
name|slp
operator|->
name|sl_error
expr_stmt|;
if|if
condition|(
name|scsi_low_done
argument_list|(
name|slp
argument_list|,
name|cb
argument_list|)
operator|==
name|SCSI_LOW_DONE_RETRY
condition|)
block|{
name|cb
operator|->
name|ccb_flags
operator||=
name|CCB_STARTQ
expr_stmt|;
name|TAILQ_INSERT_HEAD
argument_list|(
operator|&
name|slp
operator|->
name|sl_start
argument_list|,
name|cb
argument_list|,
name|ccb_chain
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
name|scsi_low_bus_release
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|)
expr_stmt|;
name|scsi_low_start
argument_list|(
name|slp
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/**********************************************************  * TAG operations  **********************************************************/
end_comment

begin_function
specifier|static
name|int
name|scsi_low_alloc_qtag
parameter_list|(
name|cb
parameter_list|)
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
block|{
name|struct
name|lun_info
modifier|*
name|li
init|=
name|cb
operator|->
name|li
decl_stmt|;
name|scsi_low_tag_t
name|etag
decl_stmt|;
if|if
condition|(
name|cb
operator|->
name|ccb_otag
operator|!=
name|SCSI_LOW_UNKTAG
condition|)
return|return
literal|0
return|;
ifndef|#
directive|ifndef
name|SCSI_LOW_ALT_QTAG_ALLOCATE
name|etag
operator|=
name|ffs
argument_list|(
name|li
operator|->
name|li_qtagbits
argument_list|)
expr_stmt|;
if|if
condition|(
name|etag
operator|==
literal|0
condition|)
return|return
name|ENOSPC
return|;
name|li
operator|->
name|li_qtagbits
operator|&=
operator|~
operator|(
literal|1
operator|<<
operator|(
name|etag
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
name|cb
operator|->
name|ccb_otag
operator|=
name|etag
expr_stmt|;
return|return
literal|0
return|;
else|#
directive|else
comment|/* SCSI_LOW_ALT_QTAG_ALLOCATE */
for|for
control|(
name|etag
operator|=
name|li
operator|->
name|li_qd
init|;
name|li
operator|->
name|li_qd
operator|<
name|SCSI_LOW_MAXNEXUS
condition|;
name|li
operator|->
name|li_qd
operator|++
control|)
if|if
condition|(
name|li
operator|->
name|li_qtagarray
index|[
name|li
operator|->
name|li_qd
index|]
operator|==
literal|0
condition|)
goto|goto
name|found
goto|;
for|for
control|(
name|li
operator|->
name|li_qd
operator|=
literal|0
init|;
name|li
operator|->
name|li_qd
operator|<
name|etag
condition|;
name|li
operator|->
name|li_qd
operator|++
control|)
if|if
condition|(
name|li
operator|->
name|li_qtagarray
index|[
name|li
operator|->
name|li_qd
index|]
operator|==
literal|0
condition|)
goto|goto
name|found
goto|;
return|return
name|ENOSPC
return|;
name|found
label|:
name|li
operator|->
name|li_qtagarray
index|[
name|li
operator|->
name|li_qd
index|]
operator|++
expr_stmt|;
name|cb
operator|->
name|ccb_otag
operator|=
operator|(
name|li
operator|->
name|li_qd
operator|++
operator|)
expr_stmt|;
return|return
literal|0
return|;
endif|#
directive|endif
comment|/* SCSI_LOW_ALT_QTAG_ALLOCATE */
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_dealloc_qtag
parameter_list|(
name|cb
parameter_list|)
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
block|{
name|struct
name|lun_info
modifier|*
name|li
init|=
name|cb
operator|->
name|li
decl_stmt|;
name|scsi_low_tag_t
name|etag
decl_stmt|;
if|if
condition|(
name|cb
operator|->
name|ccb_otag
operator|==
name|SCSI_LOW_UNKTAG
condition|)
return|return
literal|0
return|;
ifndef|#
directive|ifndef
name|SCSI_LOW_ALT_QTAG_ALLOCATE
name|etag
operator|=
name|cb
operator|->
name|ccb_otag
operator|-
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_DIAGNOSTIC
if|if
condition|(
name|etag
operator|>=
sizeof|sizeof
argument_list|(
name|li
operator|->
name|li_qtagbits
argument_list|)
operator|*
name|NBBY
condition|)
name|panic
argument_list|(
literal|"scsi_low_dealloc_tag: illegal tag"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SCSI_LOW_DIAGNOSTIC */
name|li
operator|->
name|li_qtagbits
operator||=
operator|(
literal|1
operator|<<
name|etag
operator|)
expr_stmt|;
else|#
directive|else
comment|/* SCSI_LOW_ALT_QTAG_ALLOCATE */
name|etag
operator|=
name|cb
operator|->
name|ccb_otag
expr_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_DIAGNOSTIC
if|if
condition|(
name|etag
operator|>=
name|SCSI_LOW_MAXNEXUS
condition|)
name|panic
argument_list|(
literal|"scsi_low_dealloc_tag: illegal tag"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SCSI_LOW_DIAGNOSTIC */
name|li
operator|->
name|li_qtagarray
index|[
name|etag
index|]
operator|--
expr_stmt|;
endif|#
directive|endif
comment|/* SCSI_LOW_ALT_QTAG_ALLOCATE */
name|cb
operator|->
name|ccb_otag
operator|=
name|SCSI_LOW_UNKTAG
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|slccb
modifier|*
name|scsi_low_revoke_ccb
parameter_list|(
name|slp
parameter_list|,
name|cb
parameter_list|,
name|fdone
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
name|int
name|fdone
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
init|=
name|cb
operator|->
name|ti
decl_stmt|;
name|struct
name|lun_info
modifier|*
name|li
init|=
name|cb
operator|->
name|li
decl_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_DIAGNOSTIC
if|if
condition|(
operator|(
name|cb
operator|->
name|ccb_flags
operator|&
operator|(
name|CCB_STARTQ
operator||
name|CCB_DISCQ
operator|)
operator|)
operator|==
operator|(
name|CCB_STARTQ
operator||
name|CCB_DISCQ
operator|)
condition|)
block|{
name|panic
argument_list|(
literal|"%s: ccb in both queue"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_DIAGNOSTIC */
if|if
condition|(
operator|(
name|cb
operator|->
name|ccb_flags
operator|&
name|CCB_STARTQ
operator|)
operator|!=
literal|0
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|slp
operator|->
name|sl_start
argument_list|,
name|cb
argument_list|,
name|ccb_chain
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|cb
operator|->
name|ccb_flags
operator|&
name|CCB_DISCQ
operator|)
operator|!=
literal|0
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|li
operator|->
name|li_discq
argument_list|,
name|cb
argument_list|,
name|ccb_chain
argument_list|)
expr_stmt|;
name|li
operator|->
name|li_disc
operator|--
expr_stmt|;
name|ti
operator|->
name|ti_disc
operator|--
expr_stmt|;
name|slp
operator|->
name|sl_disc
operator|--
expr_stmt|;
block|}
name|cb
operator|->
name|ccb_flags
operator|&=
operator|~
operator|(
name|CCB_STARTQ
operator||
name|CCB_DISCQ
operator||
name|CCB_SENSE
operator||
name|CCB_CLEARQ
operator||
name|CCB_INTERNAL
operator|)
expr_stmt|;
if|if
condition|(
name|fdone
operator|!=
literal|0
operator|&&
operator|(
name|cb
operator|->
name|ccb_rcnt
operator|++
operator|>=
name|slp
operator|->
name|sl_max_retry
operator|||
operator|(
name|cb
operator|->
name|ccb_flags
operator|&
name|CCB_NORETRY
operator|)
operator|!=
literal|0
operator|)
condition|)
block|{
name|cb
operator|->
name|ccb_error
operator||=
name|FATALIO
expr_stmt|;
name|cb
operator|->
name|ccb_flags
operator|&=
operator|~
name|CCB_AUTOSENSE
expr_stmt|;
if|if
condition|(
name|scsi_low_done
argument_list|(
name|slp
argument_list|,
name|cb
argument_list|)
operator|!=
name|SCSI_LOW_DONE_COMPLETE
condition|)
name|panic
argument_list|(
literal|"%s: done ccb retried"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
else|else
block|{
name|cb
operator|->
name|ccb_error
operator||=
name|PENDINGIO
expr_stmt|;
name|scsi_low_deactivate_qtag
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|scsi_low_ccb_message_retry
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|cb
operator|->
name|ccb_tc
operator|=
name|cb
operator|->
name|ccb_tcmax
operator|=
name|SCSI_LOW_MIN_TOUT
expr_stmt|;
return|return
name|cb
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|scsi_low_reset_nexus_lun
parameter_list|(
name|slp
parameter_list|,
name|li
parameter_list|,
name|fdone
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
name|int
name|fdone
decl_stmt|;
block|{
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|,
modifier|*
name|ncb
decl_stmt|,
modifier|*
name|ecb
decl_stmt|;
if|if
condition|(
name|li
operator|==
name|NULL
condition|)
return|return;
name|ecb
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|cb
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|li
operator|->
name|li_discq
argument_list|)
init|;
name|cb
operator|!=
name|NULL
condition|;
name|cb
operator|=
name|ncb
control|)
block|{
name|ncb
operator|=
name|TAILQ_NEXT
argument_list|(
name|cb
argument_list|,
name|ccb_chain
argument_list|)
expr_stmt|;
name|cb
operator|=
name|scsi_low_revoke_ccb
argument_list|(
name|slp
argument_list|,
name|cb
argument_list|,
name|fdone
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|!=
name|NULL
condition|)
block|{
comment|/* 			 * presumely keep ordering of io 			 */
name|cb
operator|->
name|ccb_flags
operator||=
name|CCB_STARTQ
expr_stmt|;
if|if
condition|(
name|ecb
operator|==
name|NULL
condition|)
block|{
name|TAILQ_INSERT_HEAD
argument_list|(
operator|&
name|slp
operator|->
name|sl_start
argument_list|,\
name|cb
argument_list|,
name|ccb_chain
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|TAILQ_INSERT_AFTER
argument_list|(
operator|&
name|slp
operator|->
name|sl_start
argument_list|,\
name|ecb
argument_list|,
name|cb
argument_list|,
name|ccb_chain
argument_list|)
expr_stmt|;
block|}
name|ecb
operator|=
name|cb
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/**************************************************************  * Qurik setup  **************************************************************/
end_comment

begin_function
specifier|static
name|void
name|scsi_low_calcf_lun
parameter_list|(
name|li
parameter_list|)
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
init|=
name|li
operator|->
name|li_ti
decl_stmt|;
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
name|ti
operator|->
name|ti_sc
decl_stmt|;
name|u_int
name|cfgflags
decl_stmt|,
name|diskflags
decl_stmt|;
if|if
condition|(
name|li
operator|->
name|li_flags_valid
operator|==
name|SCSI_LOW_LUN_FLAGS_ALL_VALID
condition|)
name|cfgflags
operator|=
name|li
operator|->
name|li_cfgflags
expr_stmt|;
else|else
name|cfgflags
operator|=
literal|0
expr_stmt|;
name|diskflags
operator|=
name|li
operator|->
name|li_diskflags
operator|&
name|li
operator|->
name|li_quirks
expr_stmt|;
comment|/* disconnect */
name|li
operator|->
name|li_flags
operator|&=
operator|~
name|SCSI_LOW_DISC
expr_stmt|;
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_cfgflags
operator|&
name|CFG_NODISC
operator|)
operator|==
literal|0
operator|&&
operator|(
name|diskflags
operator|&
name|SCSI_LOW_DISK_DISC
operator|)
operator|!=
literal|0
operator|&&
operator|(
name|cfgflags
operator|&
name|SCSI_LOW_DISC
operator|)
operator|!=
literal|0
condition|)
name|li
operator|->
name|li_flags
operator||=
name|SCSI_LOW_DISC
expr_stmt|;
comment|/* parity */
name|li
operator|->
name|li_flags
operator||=
name|SCSI_LOW_NOPARITY
expr_stmt|;
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_cfgflags
operator|&
name|CFG_NOPARITY
operator|)
operator|==
literal|0
operator|&&
operator|(
name|diskflags
operator|&
name|SCSI_LOW_DISK_PARITY
operator|)
operator|!=
literal|0
operator|&&
operator|(
name|cfgflags
operator|&
name|SCSI_LOW_NOPARITY
operator|)
operator|==
literal|0
condition|)
name|li
operator|->
name|li_flags
operator|&=
operator|~
name|SCSI_LOW_NOPARITY
expr_stmt|;
comment|/* qtag */
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_cfgflags
operator|&
name|CFG_NOQTAG
operator|)
operator|==
literal|0
operator|&&
operator|(
name|cfgflags
operator|&
name|SCSI_LOW_QTAG
operator|)
operator|!=
literal|0
operator|&&
operator|(
name|diskflags
operator|&
name|SCSI_LOW_DISK_QTAG
operator|)
operator|!=
literal|0
condition|)
block|{
name|li
operator|->
name|li_flags
operator||=
name|SCSI_LOW_QTAG
expr_stmt|;
name|li
operator|->
name|li_maxnexus
operator|=
name|SCSI_LOW_MAXNEXUS
expr_stmt|;
name|li
operator|->
name|li_maxnqio
operator|=
name|li
operator|->
name|li_maxnexus
expr_stmt|;
block|}
else|else
block|{
name|li
operator|->
name|li_flags
operator|&=
operator|~
name|SCSI_LOW_QTAG
expr_stmt|;
name|li
operator|->
name|li_maxnexus
operator|=
literal|0
expr_stmt|;
name|li
operator|->
name|li_maxnqio
operator|=
name|li
operator|->
name|li_maxnexus
expr_stmt|;
block|}
comment|/* cmd link */
name|li
operator|->
name|li_flags
operator|&=
operator|~
name|SCSI_LOW_LINK
expr_stmt|;
if|if
condition|(
operator|(
name|cfgflags
operator|&
name|SCSI_LOW_LINK
operator|)
operator|!=
literal|0
operator|&&
operator|(
name|diskflags
operator|&
name|SCSI_LOW_DISK_LINK
operator|)
operator|!=
literal|0
condition|)
name|li
operator|->
name|li_flags
operator||=
name|SCSI_LOW_LINK
expr_stmt|;
comment|/* compatible flags */
name|li
operator|->
name|li_flags
operator|&=
operator|~
name|SCSI_LOW_SYNC
expr_stmt|;
if|if
condition|(
name|ti
operator|->
name|ti_maxsynch
operator|.
name|offset
operator|>
literal|0
condition|)
name|li
operator|->
name|li_flags
operator||=
name|SCSI_LOW_SYNC
expr_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_DEBUG
if|if
condition|(
name|SCSI_LOW_DEBUG_GO
argument_list|(
name|SCSI_LOW_DEBUG_CALCF
argument_list|,
name|ti
operator|->
name|ti_id
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|scsi_low_calcf_show
argument_list|(
name|li
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_DEBUG */
block|}
end_function

begin_function
specifier|static
name|void
name|scsi_low_calcf_target
parameter_list|(
name|ti
parameter_list|)
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
block|{
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
name|ti
operator|->
name|ti_sc
decl_stmt|;
name|u_int
name|offset
decl_stmt|,
name|period
decl_stmt|,
name|diskflags
decl_stmt|;
name|diskflags
operator|=
name|ti
operator|->
name|ti_diskflags
operator|&
name|ti
operator|->
name|ti_quirks
expr_stmt|;
comment|/* synch */
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_cfgflags
operator|&
name|CFG_ASYNC
operator|)
operator|==
literal|0
operator|&&
operator|(
name|diskflags
operator|&
name|SCSI_LOW_DISK_SYNC
operator|)
operator|!=
literal|0
condition|)
block|{
name|offset
operator|=
name|ti
operator|->
name|ti_maxsynch
operator|.
name|offset
expr_stmt|;
name|period
operator|=
name|ti
operator|->
name|ti_maxsynch
operator|.
name|period
expr_stmt|;
if|if
condition|(
name|offset
operator|==
literal|0
operator|||
name|period
operator|==
literal|0
condition|)
name|offset
operator|=
name|period
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|offset
operator|=
name|period
operator|=
literal|0
expr_stmt|;
block|}
name|ti
operator|->
name|ti_maxsynch
operator|.
name|offset
operator|=
name|offset
expr_stmt|;
name|ti
operator|->
name|ti_maxsynch
operator|.
name|period
operator|=
name|period
expr_stmt|;
comment|/* wide */
if|if
condition|(
operator|(
name|diskflags
operator|&
name|SCSI_LOW_DISK_WIDE_32
operator|)
operator|==
literal|0
operator|&&
name|ti
operator|->
name|ti_width
operator|>
name|SCSI_LOW_BUS_WIDTH_16
condition|)
name|ti
operator|->
name|ti_width
operator|=
name|SCSI_LOW_BUS_WIDTH_16
expr_stmt|;
if|if
condition|(
operator|(
name|diskflags
operator|&
name|SCSI_LOW_DISK_WIDE_16
operator|)
operator|==
literal|0
operator|&&
name|ti
operator|->
name|ti_width
operator|>
name|SCSI_LOW_BUS_WIDTH_8
condition|)
name|ti
operator|->
name|ti_width
operator|=
name|SCSI_LOW_BUS_WIDTH_8
expr_stmt|;
if|if
condition|(
name|ti
operator|->
name|ti_flags_valid
operator|==
name|SCSI_LOW_TARG_FLAGS_ALL_VALID
condition|)
block|{
if|if
condition|(
name|ti
operator|->
name|ti_maxsynch
operator|.
name|offset
operator|!=
name|ti
operator|->
name|ti_osynch
operator|.
name|offset
operator|||
name|ti
operator|->
name|ti_maxsynch
operator|.
name|period
operator|!=
name|ti
operator|->
name|ti_osynch
operator|.
name|period
condition|)
name|ti
operator|->
name|ti_setup_msg
operator||=
name|SCSI_LOW_MSG_SYNCH
expr_stmt|;
if|if
condition|(
name|ti
operator|->
name|ti_width
operator|!=
name|ti
operator|->
name|ti_owidth
condition|)
name|ti
operator|->
name|ti_setup_msg
operator||=
operator|(
name|SCSI_LOW_MSG_WIDE
operator||
name|SCSI_LOW_MSG_SYNCH
operator|)
expr_stmt|;
name|ti
operator|->
name|ti_osynch
operator|=
name|ti
operator|->
name|ti_maxsynch
expr_stmt|;
name|ti
operator|->
name|ti_owidth
operator|=
name|ti
operator|->
name|ti_width
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|SCSI_LOW_DEBUG
if|if
condition|(
name|SCSI_LOW_DEBUG_GO
argument_list|(
name|SCSI_LOW_DEBUG_CALCF
argument_list|,
name|ti
operator|->
name|ti_id
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s(%d:*): max period(%dns) offset(%d) width(%d)\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|,
name|ti
operator|->
name|ti_id
argument_list|,
name|ti
operator|->
name|ti_maxsynch
operator|.
name|period
operator|*
literal|4
argument_list|,
name|ti
operator|->
name|ti_maxsynch
operator|.
name|offset
argument_list|,
name|ti
operator|->
name|ti_width
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* SCSI_LOW_DEBUG */
block|}
end_function

begin_function
specifier|static
name|void
name|scsi_low_calcf_show
parameter_list|(
name|li
parameter_list|)
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
init|=
name|li
operator|->
name|li_ti
decl_stmt|;
name|struct
name|scsi_low_softc
modifier|*
name|slp
init|=
name|ti
operator|->
name|ti_sc
decl_stmt|;
name|printf
argument_list|(
literal|"%s(%d:%d): period(%d ns) offset(%d) width(%d) flags 0x%b\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|,
name|ti
operator|->
name|ti_id
argument_list|,
name|li
operator|->
name|li_lun
argument_list|,
name|ti
operator|->
name|ti_maxsynch
operator|.
name|period
operator|*
literal|4
argument_list|,
name|ti
operator|->
name|ti_maxsynch
operator|.
name|offset
argument_list|,
name|ti
operator|->
name|ti_width
argument_list|,
name|li
operator|->
name|li_flags
argument_list|,
name|SCSI_LOW_BITS
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SCSI_LOW_START_UP_CHECK
end_ifdef

begin_comment
comment|/**************************************************************  * scsi world start up  **************************************************************/
end_comment

begin_function_decl
specifier|static
name|int
name|scsi_low_poll
parameter_list|(
name|struct
name|scsi_low_softc
modifier|*
parameter_list|,
name|struct
name|slccb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|scsi_low_start_up
parameter_list|(
name|slp
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
block|{
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
name|int
name|target
decl_stmt|,
name|lun
decl_stmt|;
name|printf
argument_list|(
literal|"%s: scsi_low: probing all devices ....\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
for|for
control|(
name|target
operator|=
literal|0
init|;
name|target
operator|<
name|slp
operator|->
name|sl_ntargs
condition|;
name|target
operator|++
control|)
block|{
if|if
condition|(
name|target
operator|==
name|slp
operator|->
name|sl_hostid
condition|)
block|{
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_show_result
operator|&
name|SHOW_PROBE_RES
operator|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: scsi_low: target %d (host card)\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|,
name|target
argument_list|)
expr_stmt|;
block|}
continue|continue;
block|}
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_show_result
operator|&
name|SHOW_PROBE_RES
operator|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: scsi_low: target %d lun "
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|,
name|target
argument_list|)
expr_stmt|;
block|}
name|ti
operator|=
name|slp
operator|->
name|sl_ti
index|[
name|target
index|]
expr_stmt|;
for|for
control|(
name|lun
operator|=
literal|0
init|;
name|lun
operator|<
name|slp
operator|->
name|sl_nluns
condition|;
name|lun
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|cb
operator|=
name|SCSI_LOW_ALLOC_CCB
argument_list|(
literal|1
argument_list|)
operator|)
operator|==
name|NULL
condition|)
break|break;
name|cb
operator|->
name|osdep
operator|=
name|NULL
expr_stmt|;
name|cb
operator|->
name|bp
operator|=
name|NULL
expr_stmt|;
name|li
operator|=
name|scsi_low_alloc_li
argument_list|(
name|ti
argument_list|,
name|lun
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|scsi_low_enqueue
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|li
argument_list|,
name|cb
argument_list|,
name|CCB_AUTOSENSE
operator||
name|CCB_POLLED
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|scsi_low_poll
argument_list|(
name|slp
argument_list|,
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|li
operator|->
name|li_state
operator|!=
name|SCSI_LOW_LUN_OK
condition|)
break|break;
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_show_result
operator|&
name|SHOW_PROBE_RES
operator|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%d "
argument_list|,
name|lun
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|slp
operator|->
name|sl_show_result
operator|&
name|SHOW_PROBE_RES
operator|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scsi_low_poll
parameter_list|(
name|slp
parameter_list|,
name|cb
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
block|{
name|int
name|tcount
decl_stmt|;
name|tcount
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|slp
operator|->
name|sl_nio
operator|>
literal|0
condition|)
block|{
name|SCSI_LOW_DELAY
argument_list|(
operator|(
literal|1000
operator|*
literal|1000
operator|)
operator|/
name|SCSI_LOW_POLL_HZ
argument_list|)
expr_stmt|;
call|(
modifier|*
name|slp
operator|->
name|sl_funcs
operator|->
name|scsi_low_poll
call|)
argument_list|(
name|slp
argument_list|)
expr_stmt|;
if|if
condition|(
name|tcount
operator|++
operator|<
name|SCSI_LOW_POLL_HZ
operator|/
name|SCSI_LOW_TIMEOUT_HZ
condition|)
continue|continue;
name|tcount
operator|=
literal|0
expr_stmt|;
name|scsi_low_timeout_check
argument_list|(
name|slp
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SCSI_LOW_START_UP_CHECK */
end_comment

begin_comment
comment|/**********************************************************  * DEBUG SECTION  **********************************************************/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|SCSI_LOW_DEBUG
end_ifdef

begin_function
specifier|static
name|void
name|scsi_low_test_abort
parameter_list|(
name|slp
parameter_list|,
name|ti
parameter_list|,
name|li
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
block|{
name|struct
name|slccb
modifier|*
name|acb
decl_stmt|;
if|if
condition|(
name|li
operator|->
name|li_disc
operator|>
literal|1
condition|)
block|{
name|acb
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|li
operator|->
name|li_discq
argument_list|)
expr_stmt|;
if|if
condition|(
name|scsi_low_abort_ccb
argument_list|(
name|slp
argument_list|,
name|acb
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: aborting ccb(0x%lx) start\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|,
operator|(
name|u_long
operator|)
name|acb
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|scsi_low_test_atten
parameter_list|(
name|slp
parameter_list|,
name|ti
parameter_list|,
name|msg
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|u_int
name|msg
decl_stmt|;
block|{
if|if
condition|(
name|slp
operator|->
name|sl_ph_count
operator|<
name|SCSI_LOW_MAX_ATTEN_CHECK
condition|)
name|scsi_low_assert_msg
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|,
name|msg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"%s: atten check OK\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|scsi_low_test_cmdlnk
parameter_list|(
name|slp
parameter_list|,
name|cb
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
block|{
define|#
directive|define
name|SCSI_LOW_CMDLNK_NOK
value|(CCB_INTERNAL | CCB_SENSE | CCB_CLEARQ)
if|if
condition|(
operator|(
name|cb
operator|->
name|ccb_flags
operator|&
name|SCSI_LOW_CMDLNK_NOK
operator|)
operator|!=
literal|0
condition|)
return|return;
name|memcpy
argument_list|(
name|cb
operator|->
name|ccb_scsi_cmd
argument_list|,
name|slp
operator|->
name|sl_scp
operator|.
name|scp_cmd
argument_list|,
name|slp
operator|->
name|sl_scp
operator|.
name|scp_cmdlen
argument_list|)
expr_stmt|;
name|cb
operator|->
name|ccb_scsi_cmd
index|[
name|slp
operator|->
name|sl_scp
operator|.
name|scp_cmdlen
operator|-
literal|1
index|]
operator||=
literal|1
expr_stmt|;
name|slp
operator|->
name|sl_scp
operator|.
name|scp_cmd
operator|=
name|cb
operator|->
name|ccb_scsi_cmd
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SCSI_LOW_DEBUG */
end_comment

begin_comment
comment|/* static */
end_comment

begin_function
name|void
name|scsi_low_info
parameter_list|(
name|slp
parameter_list|,
name|ti
parameter_list|,
name|s
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
name|u_char
modifier|*
name|s
decl_stmt|;
block|{
if|if
condition|(
name|slp
operator|==
name|NULL
condition|)
name|slp
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|sl_tab
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
name|s
operator|=
literal|"no message"
expr_stmt|;
name|printf
argument_list|(
literal|">>>>> SCSI_LOW_INFO(0x%lx): %s\n"
argument_list|,
operator|(
name|u_long
operator|)
name|slp
operator|->
name|sl_Tnexus
argument_list|,
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|ti
operator|==
name|NULL
condition|)
block|{
for|for
control|(
name|ti
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|slp
operator|->
name|sl_titab
argument_list|)
init|;
name|ti
operator|!=
name|NULL
condition|;
name|ti
operator|=
name|TAILQ_NEXT
argument_list|(
name|ti
argument_list|,
name|ti_chain
argument_list|)
control|)
block|{
name|scsi_low_print
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|scsi_low_print
argument_list|(
name|slp
argument_list|,
name|ti
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_decl_stmt
specifier|static
name|u_char
modifier|*
name|phase
index|[]
init|=
block|{
literal|"FREE"
block|,
literal|"ARBSTART"
block|,
literal|"SELSTART"
block|,
literal|"SELECTED"
block|,
literal|"CMDOUT"
block|,
literal|"DATA"
block|,
literal|"MSGIN"
block|,
literal|"MSGOUT"
block|,
literal|"STATIN"
block|,
literal|"DISC"
block|,
literal|"RESEL"
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|scsi_low_print
parameter_list|(
name|slp
parameter_list|,
name|ti
parameter_list|)
name|struct
name|scsi_low_softc
modifier|*
name|slp
decl_stmt|;
name|struct
name|targ_info
modifier|*
name|ti
decl_stmt|;
block|{
name|struct
name|lun_info
modifier|*
name|li
decl_stmt|;
name|struct
name|slccb
modifier|*
name|cb
decl_stmt|;
name|struct
name|sc_p
modifier|*
name|sp
decl_stmt|;
if|if
condition|(
name|ti
operator|==
name|NULL
operator|||
name|ti
operator|==
name|slp
operator|->
name|sl_Tnexus
condition|)
block|{
name|ti
operator|=
name|slp
operator|->
name|sl_Tnexus
expr_stmt|;
name|li
operator|=
name|slp
operator|->
name|sl_Lnexus
expr_stmt|;
name|cb
operator|=
name|slp
operator|->
name|sl_Qnexus
expr_stmt|;
block|}
else|else
block|{
name|li
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|ti
operator|->
name|ti_litab
argument_list|)
expr_stmt|;
name|cb
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|li
operator|->
name|li_discq
argument_list|)
expr_stmt|;
block|}
name|sp
operator|=
operator|&
name|slp
operator|->
name|sl_scp
expr_stmt|;
name|printf
argument_list|(
literal|"%s: === NEXUS T(0x%lx) L(0x%lx) Q(0x%lx) NIO(%d) ===\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|,
operator|(
name|u_long
operator|)
name|ti
argument_list|,
operator|(
name|u_long
operator|)
name|li
argument_list|,
operator|(
name|u_long
operator|)
name|cb
argument_list|,
name|slp
operator|->
name|sl_nio
argument_list|)
expr_stmt|;
comment|/* target stat */
if|if
condition|(
name|ti
operator|!=
name|NULL
condition|)
block|{
name|u_int
name|flags
init|=
literal|0
decl_stmt|,
name|maxnqio
init|=
literal|0
decl_stmt|,
name|nqio
init|=
literal|0
decl_stmt|;
name|int
name|lun
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|li
operator|!=
name|NULL
condition|)
block|{
name|lun
operator|=
name|li
operator|->
name|li_lun
expr_stmt|;
name|flags
operator|=
name|li
operator|->
name|li_flags
expr_stmt|;
name|maxnqio
operator|=
name|li
operator|->
name|li_maxnqio
expr_stmt|;
name|nqio
operator|=
name|li
operator|->
name|li_nqio
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%s(%d:%d) ph<%s> => ph<%s> DISC(%d) QIO(%d:%d)\n"
argument_list|,
name|slp
operator|->
name|sl_xname
argument_list|,
name|ti
operator|->
name|ti_id
argument_list|,
name|lun
argument_list|,
name|phase
index|[
operator|(
name|int
operator|)
name|ti
operator|->
name|ti_ophase
index|]
argument_list|,
name|phase
index|[
operator|(
name|int
operator|)
name|ti
operator|->
name|ti_phase
index|]
argument_list|,
name|ti
operator|->
name|ti_disc
argument_list|,
name|nqio
argument_list|,
name|maxnqio
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|!=
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"CCB: cmd[0] 0x%x clen 0x%x dlen 0x%x<0x%x stat 0x%x err %b\n"
argument_list|,
operator|(
name|u_int
operator|)
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_cmd
index|[
literal|0
index|]
argument_list|,
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_cmdlen
argument_list|,
name|cb
operator|->
name|ccb_datalen
argument_list|,
name|cb
operator|->
name|ccb_scp
operator|.
name|scp_datalen
argument_list|,
operator|(
name|u_int
operator|)
name|cb
operator|->
name|ccb_sscp
operator|.
name|scp_status
argument_list|,
name|cb
operator|->
name|ccb_error
argument_list|,
name|SCSI_LOW_ERRORBITS
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"MSGIN: ptr(%x) [%x][%x][%x][%x][%x] attention: %d\n"
argument_list|,
call|(
name|u_int
call|)
argument_list|(
name|ti
operator|->
name|ti_msginptr
argument_list|)
argument_list|,
call|(
name|u_int
call|)
argument_list|(
name|ti
operator|->
name|ti_msgin
index|[
literal|0
index|]
argument_list|)
argument_list|,
call|(
name|u_int
call|)
argument_list|(
name|ti
operator|->
name|ti_msgin
index|[
literal|1
index|]
argument_list|)
argument_list|,
call|(
name|u_int
call|)
argument_list|(
name|ti
operator|->
name|ti_msgin
index|[
literal|2
index|]
argument_list|)
argument_list|,
call|(
name|u_int
call|)
argument_list|(
name|ti
operator|->
name|ti_msgin
index|[
literal|3
index|]
argument_list|)
argument_list|,
call|(
name|u_int
call|)
argument_list|(
name|ti
operator|->
name|ti_msgin
index|[
literal|4
index|]
argument_list|)
argument_list|,
name|slp
operator|->
name|sl_atten
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"MSGOUT: msgflags 0x%x [%x][%x][%x][%x][%x] msgoutlen %d C_FLAGS: %b\n"
argument_list|,
operator|(
name|u_int
operator|)
name|ti
operator|->
name|ti_msgflags
argument_list|,
call|(
name|u_int
call|)
argument_list|(
name|ti
operator|->
name|ti_msgoutstr
index|[
literal|0
index|]
argument_list|)
argument_list|,
call|(
name|u_int
call|)
argument_list|(
name|ti
operator|->
name|ti_msgoutstr
index|[
literal|1
index|]
argument_list|)
argument_list|,
call|(
name|u_int
call|)
argument_list|(
name|ti
operator|->
name|ti_msgoutstr
index|[
literal|2
index|]
argument_list|)
argument_list|,
call|(
name|u_int
call|)
argument_list|(
name|ti
operator|->
name|ti_msgoutstr
index|[
literal|3
index|]
argument_list|)
argument_list|,
call|(
name|u_int
call|)
argument_list|(
name|ti
operator|->
name|ti_msgoutstr
index|[
literal|4
index|]
argument_list|)
argument_list|,
name|ti
operator|->
name|ti_msgoutlen
argument_list|,
name|flags
argument_list|,
name|SCSI_LOW_BITS
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SCSI_LOW_DIAGNOSTIC
name|scsi_low_msg_log_show
argument_list|(
operator|&
name|ti
operator|->
name|ti_log_msgin
argument_list|,
literal|"MIN LOG "
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|scsi_low_msg_log_show
argument_list|(
operator|&
name|ti
operator|->
name|ti_log_msgout
argument_list|,
literal|"MOUT LOG"
argument_list|,
literal|2
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SCSI_LOW_DIAGNOSTIC */
block|}
name|printf
argument_list|(
literal|"SCB: daddr 0x%lx dlen 0x%x stat 0x%x err %b\n"
argument_list|,
operator|(
name|u_long
operator|)
name|sp
operator|->
name|scp_data
argument_list|,
name|sp
operator|->
name|scp_datalen
argument_list|,
operator|(
name|u_int
operator|)
name|sp
operator|->
name|scp_status
argument_list|,
name|slp
operator|->
name|sl_error
argument_list|,
name|SCSI_LOW_ERRORBITS
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


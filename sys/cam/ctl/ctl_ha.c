begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2015 Alexander Motin<mav@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer,  *    without modification, immediately at the beginning of the file.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/kthread.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/limits.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/condvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/socketvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp.h>
end_include

begin_include
include|#
directive|include
file|<vm/uma.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam.h>
end_include

begin_include
include|#
directive|include
file|<cam/scsi/scsi_all.h>
end_include

begin_include
include|#
directive|include
file|<cam/scsi/scsi_da.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_io.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_frontend.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_util.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_backend.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_ha.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_private.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_debug.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_error.h>
end_include

begin_if
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|<
literal|1100000
operator|)
end_if

begin_struct
struct|struct
name|mbufq
block|{
name|struct
name|mbuf
modifier|*
name|head
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|tail
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|mbufq_init
parameter_list|(
name|struct
name|mbufq
modifier|*
name|q
parameter_list|,
name|int
name|limit
parameter_list|)
block|{
name|q
operator|->
name|head
operator|=
name|q
operator|->
name|tail
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mbufq_drain
parameter_list|(
name|struct
name|mbufq
modifier|*
name|q
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
while|while
condition|(
operator|(
name|m
operator|=
name|q
operator|->
name|head
operator|)
operator|!=
name|NULL
condition|)
block|{
name|q
operator|->
name|head
operator|=
name|m
operator|->
name|m_nextpkt
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
name|q
operator|->
name|tail
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|mbuf
modifier|*
name|mbufq_dequeue
parameter_list|(
name|struct
name|mbufq
modifier|*
name|q
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|m
operator|=
name|q
operator|->
name|head
expr_stmt|;
if|if
condition|(
name|m
condition|)
block|{
if|if
condition|(
name|q
operator|->
name|tail
operator|==
name|m
condition|)
name|q
operator|->
name|tail
operator|=
name|NULL
expr_stmt|;
name|q
operator|->
name|head
operator|=
name|m
operator|->
name|m_nextpkt
expr_stmt|;
name|m
operator|->
name|m_nextpkt
operator|=
name|NULL
expr_stmt|;
block|}
return|return
operator|(
name|m
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mbufq_enqueue
parameter_list|(
name|struct
name|mbufq
modifier|*
name|q
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|m
operator|->
name|m_nextpkt
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|q
operator|->
name|tail
condition|)
name|q
operator|->
name|tail
operator|->
name|m_nextpkt
operator|=
name|m
expr_stmt|;
else|else
name|q
operator|->
name|head
operator|=
name|m
expr_stmt|;
name|q
operator|->
name|tail
operator|=
name|m
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u_int
name|sbavail
parameter_list|(
name|struct
name|sockbuf
modifier|*
name|sb
parameter_list|)
block|{
return|return
operator|(
name|sb
operator|->
name|sb_cc
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|(
name|__FreeBSD_version
operator|<
literal|1000000
operator|)
end_if

begin_define
define|#
directive|define
name|mtodo
parameter_list|(
name|m
parameter_list|,
name|o
parameter_list|)
value|((void *)(((m)->m_data) + (o)))
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_struct
struct|struct
name|ha_msg_wire
block|{
name|uint32_t
name|channel
decl_stmt|;
name|uint32_t
name|length
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|ha_dt_msg_wire
block|{
name|ctl_ha_dt_cmd
name|command
decl_stmt|;
name|uint32_t
name|size
decl_stmt|;
name|uint8_t
modifier|*
name|local
decl_stmt|;
name|uint8_t
modifier|*
name|remote
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|ha_softc
block|{
name|struct
name|ctl_softc
modifier|*
name|ha_ctl_softc
decl_stmt|;
name|ctl_evt_handler
name|ha_handler
index|[
name|CTL_HA_CHAN_MAX
index|]
decl_stmt|;
name|char
name|ha_peer
index|[
literal|128
index|]
decl_stmt|;
name|struct
name|sockaddr_in
name|ha_peer_in
decl_stmt|;
name|struct
name|socket
modifier|*
name|ha_lso
decl_stmt|;
name|struct
name|socket
modifier|*
name|ha_so
decl_stmt|;
name|struct
name|mbufq
name|ha_sendq
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|ha_sending
decl_stmt|;
name|struct
name|mtx
name|ha_lock
decl_stmt|;
name|int
name|ha_connect
decl_stmt|;
name|int
name|ha_listen
decl_stmt|;
name|int
name|ha_connected
decl_stmt|;
name|int
name|ha_receiving
decl_stmt|;
name|int
name|ha_wakeup
decl_stmt|;
name|int
name|ha_disconnect
decl_stmt|;
name|int
name|ha_shutdown
decl_stmt|;
name|eventhandler_tag
name|ha_shutdown_eh
decl_stmt|;
name|TAILQ_HEAD
argument_list|(
argument_list|,
argument|ctl_ha_dt_req
argument_list|)
name|ha_dts
expr_stmt|;
block|}
name|ha_softc
struct|;
end_struct

begin_function
specifier|static
name|void
name|ctl_ha_conn_wake
parameter_list|(
name|struct
name|ha_softc
modifier|*
name|softc
parameter_list|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
name|softc
operator|->
name|ha_wakeup
operator|=
literal|1
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
name|wakeup
argument_list|(
operator|&
name|softc
operator|->
name|ha_wakeup
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ctl_ha_lupcall
parameter_list|(
name|struct
name|socket
modifier|*
name|so
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|waitflag
parameter_list|)
block|{
name|struct
name|ha_softc
modifier|*
name|softc
init|=
name|arg
decl_stmt|;
name|ctl_ha_conn_wake
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
operator|(
name|SU_OK
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ctl_ha_rupcall
parameter_list|(
name|struct
name|socket
modifier|*
name|so
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|waitflag
parameter_list|)
block|{
name|struct
name|ha_softc
modifier|*
name|softc
init|=
name|arg
decl_stmt|;
name|wakeup
argument_list|(
operator|&
name|softc
operator|->
name|ha_receiving
argument_list|)
expr_stmt|;
return|return
operator|(
name|SU_OK
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ctl_ha_supcall
parameter_list|(
name|struct
name|socket
modifier|*
name|so
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|waitflag
parameter_list|)
block|{
name|struct
name|ha_softc
modifier|*
name|softc
init|=
name|arg
decl_stmt|;
name|ctl_ha_conn_wake
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
operator|(
name|SU_OK
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ctl_ha_evt
parameter_list|(
name|struct
name|ha_softc
modifier|*
name|softc
parameter_list|,
name|ctl_ha_channel
name|ch
parameter_list|,
name|ctl_ha_event
name|evt
parameter_list|,
name|int
name|param
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|ch
operator|<
name|CTL_HA_CHAN_MAX
condition|)
block|{
if|if
condition|(
name|softc
operator|->
name|ha_handler
index|[
name|ch
index|]
condition|)
name|softc
operator|->
name|ha_handler
index|[
name|ch
index|]
operator|(
name|ch
operator|,
name|evt
operator|,
name|param
operator|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CTL_HA_CHAN_MAX
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|softc
operator|->
name|ha_handler
index|[
name|i
index|]
condition|)
name|softc
operator|->
name|ha_handler
index|[
name|i
index|]
operator|(
name|i
operator|,
name|evt
operator|,
name|param
operator|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ctl_ha_close
parameter_list|(
name|struct
name|ha_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|socket
modifier|*
name|so
init|=
name|softc
operator|->
name|ha_so
decl_stmt|;
name|int
name|report
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|softc
operator|->
name|ha_connected
operator|||
name|softc
operator|->
name|ha_disconnect
condition|)
block|{
name|softc
operator|->
name|ha_connected
operator|=
literal|0
expr_stmt|;
name|mbufq_drain
argument_list|(
operator|&
name|softc
operator|->
name|ha_sendq
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|softc
operator|->
name|ha_sending
argument_list|)
expr_stmt|;
name|softc
operator|->
name|ha_sending
operator|=
name|NULL
expr_stmt|;
name|report
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|so
condition|)
block|{
name|SOCKBUF_LOCK
argument_list|(
operator|&
name|so
operator|->
name|so_rcv
argument_list|)
expr_stmt|;
name|soupcall_clear
argument_list|(
name|so
argument_list|,
name|SO_RCV
argument_list|)
expr_stmt|;
while|while
condition|(
name|softc
operator|->
name|ha_receiving
condition|)
block|{
name|wakeup
argument_list|(
operator|&
name|softc
operator|->
name|ha_receiving
argument_list|)
expr_stmt|;
name|msleep
argument_list|(
operator|&
name|softc
operator|->
name|ha_receiving
argument_list|,
name|SOCKBUF_MTX
argument_list|(
operator|&
name|so
operator|->
name|so_rcv
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|"ha_rx exit"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|SOCKBUF_UNLOCK
argument_list|(
operator|&
name|so
operator|->
name|so_rcv
argument_list|)
expr_stmt|;
name|SOCKBUF_LOCK
argument_list|(
operator|&
name|so
operator|->
name|so_snd
argument_list|)
expr_stmt|;
name|soupcall_clear
argument_list|(
name|so
argument_list|,
name|SO_SND
argument_list|)
expr_stmt|;
name|SOCKBUF_UNLOCK
argument_list|(
operator|&
name|so
operator|->
name|so_snd
argument_list|)
expr_stmt|;
name|softc
operator|->
name|ha_so
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|ha_connect
condition|)
name|pause
argument_list|(
literal|"reconnect"
argument_list|,
name|hz
operator|/
literal|2
argument_list|)
expr_stmt|;
name|soclose
argument_list|(
name|so
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|report
condition|)
block|{
name|ctl_ha_evt
argument_list|(
name|softc
argument_list|,
name|CTL_HA_CHAN_MAX
argument_list|,
name|CTL_HA_EVT_LINK_CHANGE
argument_list|,
operator|(
name|softc
operator|->
name|ha_connect
operator|||
name|softc
operator|->
name|ha_listen
operator|)
condition|?
name|CTL_HA_LINK_UNKNOWN
else|:
name|CTL_HA_LINK_OFFLINE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ctl_ha_lclose
parameter_list|(
name|struct
name|ha_softc
modifier|*
name|softc
parameter_list|)
block|{
if|if
condition|(
name|softc
operator|->
name|ha_lso
condition|)
block|{
name|SOCKBUF_LOCK
argument_list|(
operator|&
name|softc
operator|->
name|ha_lso
operator|->
name|so_rcv
argument_list|)
expr_stmt|;
name|soupcall_clear
argument_list|(
name|softc
operator|->
name|ha_lso
argument_list|,
name|SO_RCV
argument_list|)
expr_stmt|;
name|SOCKBUF_UNLOCK
argument_list|(
operator|&
name|softc
operator|->
name|ha_lso
operator|->
name|so_rcv
argument_list|)
expr_stmt|;
name|soclose
argument_list|(
name|softc
operator|->
name|ha_lso
argument_list|)
expr_stmt|;
name|softc
operator|->
name|ha_lso
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ctl_ha_rx_thread
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ha_softc
modifier|*
name|softc
init|=
name|arg
decl_stmt|;
name|struct
name|socket
modifier|*
name|so
init|=
name|softc
operator|->
name|ha_so
decl_stmt|;
name|struct
name|ha_msg_wire
name|wire_hdr
decl_stmt|;
name|struct
name|uio
name|uio
decl_stmt|;
name|struct
name|iovec
name|iov
decl_stmt|;
name|int
name|error
decl_stmt|,
name|flags
decl_stmt|,
name|next
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|wire_hdr
argument_list|,
sizeof|sizeof
argument_list|(
name|wire_hdr
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|wire_hdr
operator|.
name|length
operator|>
literal|0
condition|)
name|next
operator|=
name|wire_hdr
operator|.
name|length
expr_stmt|;
else|else
name|next
operator|=
sizeof|sizeof
argument_list|(
name|wire_hdr
argument_list|)
expr_stmt|;
name|SOCKBUF_LOCK
argument_list|(
operator|&
name|so
operator|->
name|so_rcv
argument_list|)
expr_stmt|;
while|while
condition|(
name|sbavail
argument_list|(
operator|&
name|so
operator|->
name|so_rcv
argument_list|)
operator|<
name|next
operator|||
name|softc
operator|->
name|ha_disconnect
condition|)
block|{
if|if
condition|(
name|softc
operator|->
name|ha_connected
operator|==
literal|0
operator|||
name|softc
operator|->
name|ha_disconnect
operator|||
name|so
operator|->
name|so_error
operator|||
operator|(
name|so
operator|->
name|so_rcv
operator|.
name|sb_state
operator|&
name|SBS_CANTRCVMORE
operator|)
condition|)
block|{
goto|goto
name|errout
goto|;
block|}
name|so
operator|->
name|so_rcv
operator|.
name|sb_lowat
operator|=
name|next
expr_stmt|;
name|msleep
argument_list|(
operator|&
name|softc
operator|->
name|ha_receiving
argument_list|,
name|SOCKBUF_MTX
argument_list|(
operator|&
name|so
operator|->
name|so_rcv
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|"-"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|SOCKBUF_UNLOCK
argument_list|(
operator|&
name|so
operator|->
name|so_rcv
argument_list|)
expr_stmt|;
if|if
condition|(
name|wire_hdr
operator|.
name|length
operator|==
literal|0
condition|)
block|{
name|iov
operator|.
name|iov_base
operator|=
operator|&
name|wire_hdr
expr_stmt|;
name|iov
operator|.
name|iov_len
operator|=
sizeof|sizeof
argument_list|(
name|wire_hdr
argument_list|)
expr_stmt|;
name|uio
operator|.
name|uio_iov
operator|=
operator|&
name|iov
expr_stmt|;
name|uio
operator|.
name|uio_iovcnt
operator|=
literal|1
expr_stmt|;
name|uio
operator|.
name|uio_rw
operator|=
name|UIO_READ
expr_stmt|;
name|uio
operator|.
name|uio_segflg
operator|=
name|UIO_SYSSPACE
expr_stmt|;
name|uio
operator|.
name|uio_td
operator|=
name|curthread
expr_stmt|;
name|uio
operator|.
name|uio_resid
operator|=
sizeof|sizeof
argument_list|(
name|wire_hdr
argument_list|)
expr_stmt|;
name|flags
operator|=
name|MSG_DONTWAIT
expr_stmt|;
name|error
operator|=
name|soreceive
argument_list|(
name|softc
operator|->
name|ha_so
argument_list|,
name|NULL
argument_list|,
operator|&
name|uio
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: header receive error %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|SOCKBUF_LOCK
argument_list|(
operator|&
name|so
operator|->
name|so_rcv
argument_list|)
expr_stmt|;
goto|goto
name|errout
goto|;
block|}
block|}
else|else
block|{
name|ctl_ha_evt
argument_list|(
name|softc
argument_list|,
name|wire_hdr
operator|.
name|channel
argument_list|,
name|CTL_HA_EVT_MSG_RECV
argument_list|,
name|wire_hdr
operator|.
name|length
argument_list|)
expr_stmt|;
name|wire_hdr
operator|.
name|length
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|errout
label|:
name|softc
operator|->
name|ha_receiving
operator|=
literal|0
expr_stmt|;
name|wakeup
argument_list|(
operator|&
name|softc
operator|->
name|ha_receiving
argument_list|)
expr_stmt|;
name|SOCKBUF_UNLOCK
argument_list|(
operator|&
name|so
operator|->
name|so_rcv
argument_list|)
expr_stmt|;
name|ctl_ha_conn_wake
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|kthread_exit
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ctl_ha_send
parameter_list|(
name|struct
name|ha_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|socket
modifier|*
name|so
init|=
name|softc
operator|->
name|ha_so
decl_stmt|;
name|int
name|error
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|softc
operator|->
name|ha_sending
operator|==
name|NULL
condition|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
name|softc
operator|->
name|ha_sending
operator|=
name|mbufq_dequeue
argument_list|(
operator|&
name|softc
operator|->
name|ha_sendq
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|ha_sending
operator|==
name|NULL
condition|)
block|{
name|so
operator|->
name|so_snd
operator|.
name|sb_lowat
operator|=
name|so
operator|->
name|so_snd
operator|.
name|sb_hiwat
operator|+
literal|1
expr_stmt|;
break|break;
block|}
block|}
name|SOCKBUF_LOCK
argument_list|(
operator|&
name|so
operator|->
name|so_snd
argument_list|)
expr_stmt|;
if|if
condition|(
name|sbspace
argument_list|(
operator|&
name|so
operator|->
name|so_snd
argument_list|)
operator|<
name|softc
operator|->
name|ha_sending
operator|->
name|m_pkthdr
operator|.
name|len
condition|)
block|{
name|so
operator|->
name|so_snd
operator|.
name|sb_lowat
operator|=
name|softc
operator|->
name|ha_sending
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
name|SOCKBUF_UNLOCK
argument_list|(
operator|&
name|so
operator|->
name|so_snd
argument_list|)
expr_stmt|;
break|break;
block|}
name|SOCKBUF_UNLOCK
argument_list|(
operator|&
name|so
operator|->
name|so_snd
argument_list|)
expr_stmt|;
name|error
operator|=
name|sosend
argument_list|(
name|softc
operator|->
name|ha_so
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|softc
operator|->
name|ha_sending
argument_list|,
name|NULL
argument_list|,
name|MSG_DONTWAIT
argument_list|,
name|curthread
argument_list|)
expr_stmt|;
name|softc
operator|->
name|ha_sending
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: sosend() error %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
empty_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ctl_ha_sock_setup
parameter_list|(
name|struct
name|ha_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|sockopt
name|opt
decl_stmt|;
name|struct
name|socket
modifier|*
name|so
init|=
name|softc
operator|->
name|ha_so
decl_stmt|;
name|int
name|error
decl_stmt|,
name|val
decl_stmt|;
name|val
operator|=
literal|1024
operator|*
literal|1024
expr_stmt|;
name|error
operator|=
name|soreserve
argument_list|(
name|so
argument_list|,
name|val
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|printf
argument_list|(
literal|"%s: soreserve failed %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|SOCKBUF_LOCK
argument_list|(
operator|&
name|so
operator|->
name|so_rcv
argument_list|)
expr_stmt|;
name|so
operator|->
name|so_rcv
operator|.
name|sb_lowat
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ha_msg_wire
argument_list|)
expr_stmt|;
name|soupcall_set
argument_list|(
name|so
argument_list|,
name|SO_RCV
argument_list|,
name|ctl_ha_rupcall
argument_list|,
name|softc
argument_list|)
expr_stmt|;
name|SOCKBUF_UNLOCK
argument_list|(
operator|&
name|so
operator|->
name|so_rcv
argument_list|)
expr_stmt|;
name|SOCKBUF_LOCK
argument_list|(
operator|&
name|so
operator|->
name|so_snd
argument_list|)
expr_stmt|;
name|so
operator|->
name|so_snd
operator|.
name|sb_lowat
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ha_msg_wire
argument_list|)
expr_stmt|;
name|soupcall_set
argument_list|(
name|so
argument_list|,
name|SO_SND
argument_list|,
name|ctl_ha_supcall
argument_list|,
name|softc
argument_list|)
expr_stmt|;
name|SOCKBUF_UNLOCK
argument_list|(
operator|&
name|so
operator|->
name|so_snd
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|opt
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockopt
argument_list|)
argument_list|)
expr_stmt|;
name|opt
operator|.
name|sopt_dir
operator|=
name|SOPT_SET
expr_stmt|;
name|opt
operator|.
name|sopt_level
operator|=
name|SOL_SOCKET
expr_stmt|;
name|opt
operator|.
name|sopt_name
operator|=
name|SO_KEEPALIVE
expr_stmt|;
name|opt
operator|.
name|sopt_val
operator|=
operator|&
name|val
expr_stmt|;
name|opt
operator|.
name|sopt_valsize
operator|=
sizeof|sizeof
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
literal|1
expr_stmt|;
name|error
operator|=
name|sosetopt
argument_list|(
name|so
argument_list|,
operator|&
name|opt
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|printf
argument_list|(
literal|"%s: KEEPALIVE setting failed %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|opt
operator|.
name|sopt_level
operator|=
name|IPPROTO_TCP
expr_stmt|;
name|opt
operator|.
name|sopt_name
operator|=
name|TCP_NODELAY
expr_stmt|;
name|val
operator|=
literal|1
expr_stmt|;
name|error
operator|=
name|sosetopt
argument_list|(
name|so
argument_list|,
operator|&
name|opt
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|printf
argument_list|(
literal|"%s: NODELAY setting failed %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|opt
operator|.
name|sopt_name
operator|=
name|TCP_KEEPINIT
expr_stmt|;
name|val
operator|=
literal|3
expr_stmt|;
name|error
operator|=
name|sosetopt
argument_list|(
name|so
argument_list|,
operator|&
name|opt
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|printf
argument_list|(
literal|"%s: KEEPINIT setting failed %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|opt
operator|.
name|sopt_name
operator|=
name|TCP_KEEPIDLE
expr_stmt|;
name|val
operator|=
literal|1
expr_stmt|;
name|error
operator|=
name|sosetopt
argument_list|(
name|so
argument_list|,
operator|&
name|opt
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|printf
argument_list|(
literal|"%s: KEEPIDLE setting failed %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|opt
operator|.
name|sopt_name
operator|=
name|TCP_KEEPINTVL
expr_stmt|;
name|val
operator|=
literal|1
expr_stmt|;
name|error
operator|=
name|sosetopt
argument_list|(
name|so
argument_list|,
operator|&
name|opt
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|printf
argument_list|(
literal|"%s: KEEPINTVL setting failed %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|opt
operator|.
name|sopt_name
operator|=
name|TCP_KEEPCNT
expr_stmt|;
name|val
operator|=
literal|5
expr_stmt|;
name|error
operator|=
name|sosetopt
argument_list|(
name|so
argument_list|,
operator|&
name|opt
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|printf
argument_list|(
literal|"%s: KEEPCNT setting failed %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ctl_ha_connect
parameter_list|(
name|struct
name|ha_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|thread
modifier|*
name|td
init|=
name|curthread
decl_stmt|;
name|struct
name|sockaddr_in
name|sa
decl_stmt|;
name|struct
name|socket
modifier|*
name|so
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* Create the socket */
name|error
operator|=
name|socreate
argument_list|(
name|PF_INET
argument_list|,
operator|&
name|so
argument_list|,
name|SOCK_STREAM
argument_list|,
name|IPPROTO_TCP
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: socreate() error %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|softc
operator|->
name|ha_so
operator|=
name|so
expr_stmt|;
name|ctl_ha_sock_setup
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sa
argument_list|,
operator|&
name|softc
operator|->
name|ha_peer_in
argument_list|,
sizeof|sizeof
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|soconnect
argument_list|(
name|so
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sa
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"%s: soconnect() error %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|out
label|:
name|ctl_ha_close
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ctl_ha_accept
parameter_list|(
name|struct
name|ha_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|socket
modifier|*
name|so
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|sap
decl_stmt|;
name|int
name|error
decl_stmt|;
name|ACCEPT_LOCK
argument_list|()
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|ha_lso
operator|->
name|so_rcv
operator|.
name|sb_state
operator|&
name|SBS_CANTRCVMORE
condition|)
name|softc
operator|->
name|ha_lso
operator|->
name|so_error
operator|=
name|ECONNABORTED
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|ha_lso
operator|->
name|so_error
condition|)
block|{
name|error
operator|=
name|softc
operator|->
name|ha_lso
operator|->
name|so_error
expr_stmt|;
name|softc
operator|->
name|ha_lso
operator|->
name|so_error
operator|=
literal|0
expr_stmt|;
name|ACCEPT_UNLOCK
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"%s: socket error %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|so
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|softc
operator|->
name|ha_lso
operator|->
name|so_comp
argument_list|)
expr_stmt|;
if|if
condition|(
name|so
operator|==
name|NULL
condition|)
block|{
name|ACCEPT_UNLOCK
argument_list|()
expr_stmt|;
return|return
operator|(
name|EWOULDBLOCK
operator|)
return|;
block|}
name|KASSERT
argument_list|(
operator|!
operator|(
name|so
operator|->
name|so_qstate
operator|&
name|SQ_INCOMP
operator|)
argument_list|,
operator|(
literal|"accept1: so SQ_INCOMP"
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|so
operator|->
name|so_qstate
operator|&
name|SQ_COMP
argument_list|,
operator|(
literal|"accept1: so not SQ_COMP"
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * Before changing the flags on the socket, we have to bump the 	 * reference count.  Otherwise, if the protocol calls sofree(), 	 * the socket will be released due to a zero refcount. 	 */
name|SOCK_LOCK
argument_list|(
name|so
argument_list|)
expr_stmt|;
comment|/* soref() and so_state update */
name|soref
argument_list|(
name|so
argument_list|)
expr_stmt|;
comment|/* file descriptor reference */
name|TAILQ_REMOVE
argument_list|(
operator|&
name|softc
operator|->
name|ha_lso
operator|->
name|so_comp
argument_list|,
name|so
argument_list|,
name|so_list
argument_list|)
expr_stmt|;
name|softc
operator|->
name|ha_lso
operator|->
name|so_qlen
operator|--
expr_stmt|;
name|so
operator|->
name|so_state
operator||=
name|SS_NBIO
expr_stmt|;
name|so
operator|->
name|so_qstate
operator|&=
operator|~
name|SQ_COMP
expr_stmt|;
name|so
operator|->
name|so_head
operator|=
name|NULL
expr_stmt|;
name|SOCK_UNLOCK
argument_list|(
name|so
argument_list|)
expr_stmt|;
name|ACCEPT_UNLOCK
argument_list|()
expr_stmt|;
name|sap
operator|=
name|NULL
expr_stmt|;
name|error
operator|=
name|soaccept
argument_list|(
name|so
argument_list|,
operator|&
name|sap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: soaccept() error %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|sap
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|sap
argument_list|,
name|M_SONAME
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|sap
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|sap
argument_list|,
name|M_SONAME
argument_list|)
expr_stmt|;
name|softc
operator|->
name|ha_so
operator|=
name|so
expr_stmt|;
name|ctl_ha_sock_setup
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|out
label|:
name|ctl_ha_lclose
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ctl_ha_listen
parameter_list|(
name|struct
name|ha_softc
modifier|*
name|softc
parameter_list|)
block|{
name|struct
name|thread
modifier|*
name|td
init|=
name|curthread
decl_stmt|;
name|struct
name|sockaddr_in
name|sa
decl_stmt|;
name|struct
name|sockopt
name|opt
decl_stmt|;
name|int
name|error
decl_stmt|,
name|val
decl_stmt|;
comment|/* Create the socket */
if|if
condition|(
name|softc
operator|->
name|ha_lso
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|socreate
argument_list|(
name|PF_INET
argument_list|,
operator|&
name|softc
operator|->
name|ha_lso
argument_list|,
name|SOCK_STREAM
argument_list|,
name|IPPROTO_TCP
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: socreate() error %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|bzero
argument_list|(
operator|&
name|opt
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockopt
argument_list|)
argument_list|)
expr_stmt|;
name|opt
operator|.
name|sopt_dir
operator|=
name|SOPT_SET
expr_stmt|;
name|opt
operator|.
name|sopt_level
operator|=
name|SOL_SOCKET
expr_stmt|;
name|opt
operator|.
name|sopt_name
operator|=
name|SO_REUSEADDR
expr_stmt|;
name|opt
operator|.
name|sopt_val
operator|=
operator|&
name|val
expr_stmt|;
name|opt
operator|.
name|sopt_valsize
operator|=
sizeof|sizeof
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
literal|1
expr_stmt|;
name|error
operator|=
name|sosetopt
argument_list|(
name|softc
operator|->
name|ha_lso
argument_list|,
operator|&
name|opt
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"%s: REUSEADDR setting failed %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
name|bzero
argument_list|(
operator|&
name|opt
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockopt
argument_list|)
argument_list|)
expr_stmt|;
name|opt
operator|.
name|sopt_dir
operator|=
name|SOPT_SET
expr_stmt|;
name|opt
operator|.
name|sopt_level
operator|=
name|SOL_SOCKET
expr_stmt|;
name|opt
operator|.
name|sopt_name
operator|=
name|SO_REUSEPORT
expr_stmt|;
name|opt
operator|.
name|sopt_val
operator|=
operator|&
name|val
expr_stmt|;
name|opt
operator|.
name|sopt_valsize
operator|=
sizeof|sizeof
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
literal|1
expr_stmt|;
name|error
operator|=
name|sosetopt
argument_list|(
name|softc
operator|->
name|ha_lso
argument_list|,
operator|&
name|opt
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"%s: REUSEPORT setting failed %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
name|SOCKBUF_LOCK
argument_list|(
operator|&
name|softc
operator|->
name|ha_lso
operator|->
name|so_rcv
argument_list|)
expr_stmt|;
name|soupcall_set
argument_list|(
name|softc
operator|->
name|ha_lso
argument_list|,
name|SO_RCV
argument_list|,
name|ctl_ha_lupcall
argument_list|,
name|softc
argument_list|)
expr_stmt|;
name|SOCKBUF_UNLOCK
argument_list|(
operator|&
name|softc
operator|->
name|ha_lso
operator|->
name|so_rcv
argument_list|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
operator|&
name|sa
argument_list|,
operator|&
name|softc
operator|->
name|ha_peer_in
argument_list|,
sizeof|sizeof
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|sobind
argument_list|(
name|softc
operator|->
name|ha_lso
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sa
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: sobind() error %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|error
operator|=
name|solisten
argument_list|(
name|softc
operator|->
name|ha_lso
argument_list|,
literal|1
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: solisten() error %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|out
label|:
name|ctl_ha_lclose
argument_list|(
name|softc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ctl_ha_conn_thread
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ha_softc
modifier|*
name|softc
init|=
name|arg
decl_stmt|;
name|int
name|error
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|softc
operator|->
name|ha_disconnect
operator|||
name|softc
operator|->
name|ha_shutdown
condition|)
block|{
name|ctl_ha_close
argument_list|(
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|ha_disconnect
operator|==
literal|2
operator|||
name|softc
operator|->
name|ha_shutdown
condition|)
name|ctl_ha_lclose
argument_list|(
name|softc
argument_list|)
expr_stmt|;
name|softc
operator|->
name|ha_disconnect
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|ha_shutdown
condition|)
break|break;
block|}
elseif|else
if|if
condition|(
name|softc
operator|->
name|ha_so
operator|!=
name|NULL
operator|&&
operator|(
name|softc
operator|->
name|ha_so
operator|->
name|so_error
operator|||
name|softc
operator|->
name|ha_so
operator|->
name|so_rcv
operator|.
name|sb_state
operator|&
name|SBS_CANTRCVMORE
operator|)
condition|)
name|ctl_ha_close
argument_list|(
name|softc
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|ha_so
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|softc
operator|->
name|ha_lso
operator|!=
name|NULL
condition|)
name|ctl_ha_accept
argument_list|(
name|softc
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|softc
operator|->
name|ha_listen
condition|)
name|ctl_ha_listen
argument_list|(
name|softc
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|softc
operator|->
name|ha_connect
condition|)
name|ctl_ha_connect
argument_list|(
name|softc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|softc
operator|->
name|ha_so
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|softc
operator|->
name|ha_connected
operator|==
literal|0
operator|&&
name|softc
operator|->
name|ha_so
operator|->
name|so_error
operator|==
literal|0
operator|&&
operator|(
name|softc
operator|->
name|ha_so
operator|->
name|so_state
operator|&
name|SS_ISCONNECTING
operator|)
operator|==
literal|0
condition|)
block|{
name|softc
operator|->
name|ha_connected
operator|=
literal|1
expr_stmt|;
name|ctl_ha_evt
argument_list|(
name|softc
argument_list|,
name|CTL_HA_CHAN_MAX
argument_list|,
name|CTL_HA_EVT_LINK_CHANGE
argument_list|,
name|CTL_HA_LINK_ONLINE
argument_list|)
expr_stmt|;
name|softc
operator|->
name|ha_receiving
operator|=
literal|1
expr_stmt|;
name|error
operator|=
name|kproc_kthread_add
argument_list|(
name|ctl_ha_rx_thread
argument_list|,
name|softc
argument_list|,
operator|&
name|softc
operator|->
name|ha_ctl_softc
operator|->
name|ctl_proc
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|"ctl"
argument_list|,
literal|"ha_rx"
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Error creating CTL HA rx thread!\n"
argument_list|)
expr_stmt|;
name|softc
operator|->
name|ha_receiving
operator|=
literal|0
expr_stmt|;
name|softc
operator|->
name|ha_disconnect
operator|=
literal|1
expr_stmt|;
block|}
block|}
name|ctl_ha_send
argument_list|(
name|softc
argument_list|)
expr_stmt|;
block|}
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|ha_so
operator|!=
name|NULL
operator|&&
operator|(
name|softc
operator|->
name|ha_so
operator|->
name|so_error
operator|||
name|softc
operator|->
name|ha_so
operator|->
name|so_rcv
operator|.
name|sb_state
operator|&
name|SBS_CANTRCVMORE
operator|)
condition|)
empty_stmt|;
elseif|else
if|if
condition|(
operator|!
name|softc
operator|->
name|ha_wakeup
condition|)
name|msleep
argument_list|(
operator|&
name|softc
operator|->
name|ha_wakeup
argument_list|,
operator|&
name|softc
operator|->
name|ha_lock
argument_list|,
literal|0
argument_list|,
literal|"-"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
name|softc
operator|->
name|ha_wakeup
operator|=
literal|0
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
block|}
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
name|softc
operator|->
name|ha_shutdown
operator|=
literal|2
expr_stmt|;
name|wakeup
argument_list|(
operator|&
name|softc
operator|->
name|ha_wakeup
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
name|kthread_exit
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ctl_ha_peer_sysctl
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|ha_softc
modifier|*
name|softc
init|=
operator|(
expr|struct
name|ha_softc
operator|*
operator|)
name|arg1
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|sa
decl_stmt|;
name|int
name|error
decl_stmt|,
name|b1
decl_stmt|,
name|b2
decl_stmt|,
name|b3
decl_stmt|,
name|b4
decl_stmt|,
name|p
decl_stmt|,
name|num
decl_stmt|;
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|strlcpy
argument_list|(
name|buf
argument_list|,
name|softc
operator|->
name|ha_peer
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|sysctl_handle_string
argument_list|(
name|oidp
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|!=
literal|0
operator|)
operator|||
operator|(
name|req
operator|->
name|newptr
operator|==
name|NULL
operator|)
operator|||
name|strncmp
argument_list|(
name|buf
argument_list|,
name|softc
operator|->
name|ha_peer
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|sa
operator|=
operator|&
name|softc
operator|->
name|ha_peer_in
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|num
operator|=
name|sscanf
argument_list|(
name|buf
argument_list|,
literal|"connect %d.%d.%d.%d:%d"
argument_list|,
operator|&
name|b1
argument_list|,
operator|&
name|b2
argument_list|,
operator|&
name|b3
argument_list|,
operator|&
name|b4
argument_list|,
operator|&
name|p
argument_list|)
operator|)
operator|>=
literal|4
condition|)
block|{
name|softc
operator|->
name|ha_connect
operator|=
literal|1
expr_stmt|;
name|softc
operator|->
name|ha_listen
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|num
operator|=
name|sscanf
argument_list|(
name|buf
argument_list|,
literal|"listen %d.%d.%d.%d:%d"
argument_list|,
operator|&
name|b1
argument_list|,
operator|&
name|b2
argument_list|,
operator|&
name|b3
argument_list|,
operator|&
name|b4
argument_list|,
operator|&
name|p
argument_list|)
operator|)
operator|>=
literal|4
condition|)
block|{
name|softc
operator|->
name|ha_connect
operator|=
literal|0
expr_stmt|;
name|softc
operator|->
name|ha_listen
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|softc
operator|->
name|ha_connect
operator|=
literal|0
expr_stmt|;
name|softc
operator|->
name|ha_listen
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|!=
literal|0
condition|)
block|{
name|buf
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
block|}
name|strlcpy
argument_list|(
name|softc
operator|->
name|ha_peer
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|softc
operator|->
name|ha_peer
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|ha_connect
operator|||
name|softc
operator|->
name|ha_listen
condition|)
block|{
name|memset
argument_list|(
name|sa
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|sa
operator|->
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
name|sa
operator|->
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|sa
operator|->
name|sin_port
operator|=
name|htons
argument_list|(
operator|(
name|num
operator|>=
literal|5
operator|)
condition|?
name|p
else|:
literal|999
argument_list|)
expr_stmt|;
name|sa
operator|->
name|sin_addr
operator|.
name|s_addr
operator|=
name|htonl
argument_list|(
operator|(
name|b1
operator|<<
literal|24
operator|)
operator|+
operator|(
name|b2
operator|<<
literal|16
operator|)
operator|+
operator|(
name|b3
operator|<<
literal|8
operator|)
operator|+
name|b4
argument_list|)
expr_stmt|;
block|}
name|softc
operator|->
name|ha_disconnect
operator|=
literal|2
expr_stmt|;
name|softc
operator|->
name|ha_wakeup
operator|=
literal|1
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
name|wakeup
argument_list|(
operator|&
name|softc
operator|->
name|ha_wakeup
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|ctl_ha_status
name|ctl_ha_msg_register
parameter_list|(
name|ctl_ha_channel
name|channel
parameter_list|,
name|ctl_evt_handler
name|handler
parameter_list|)
block|{
name|struct
name|ha_softc
modifier|*
name|softc
init|=
operator|&
name|ha_softc
decl_stmt|;
name|KASSERT
argument_list|(
name|channel
operator|<
name|CTL_HA_CHAN_MAX
argument_list|,
operator|(
literal|"Wrong CTL HA channel %d"
operator|,
name|channel
operator|)
argument_list|)
expr_stmt|;
name|softc
operator|->
name|ha_handler
index|[
name|channel
index|]
operator|=
name|handler
expr_stmt|;
return|return
operator|(
name|CTL_HA_STATUS_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|ctl_ha_status
name|ctl_ha_msg_deregister
parameter_list|(
name|ctl_ha_channel
name|channel
parameter_list|)
block|{
name|struct
name|ha_softc
modifier|*
name|softc
init|=
operator|&
name|ha_softc
decl_stmt|;
name|KASSERT
argument_list|(
name|channel
operator|<
name|CTL_HA_CHAN_MAX
argument_list|,
operator|(
literal|"Wrong CTL HA channel %d"
operator|,
name|channel
operator|)
argument_list|)
expr_stmt|;
name|softc
operator|->
name|ha_handler
index|[
name|channel
index|]
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|CTL_HA_STATUS_SUCCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Receive a message of the specified size.  */
end_comment

begin_function
name|ctl_ha_status
name|ctl_ha_msg_recv
parameter_list|(
name|ctl_ha_channel
name|channel
parameter_list|,
name|void
modifier|*
name|addr
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|wait
parameter_list|)
block|{
name|struct
name|ha_softc
modifier|*
name|softc
init|=
operator|&
name|ha_softc
decl_stmt|;
name|struct
name|uio
name|uio
decl_stmt|;
name|struct
name|iovec
name|iov
decl_stmt|;
name|int
name|error
decl_stmt|,
name|flags
decl_stmt|;
if|if
condition|(
operator|!
name|softc
operator|->
name|ha_connected
condition|)
return|return
operator|(
name|CTL_HA_STATUS_DISCONNECT
operator|)
return|;
name|iov
operator|.
name|iov_base
operator|=
name|addr
expr_stmt|;
name|iov
operator|.
name|iov_len
operator|=
name|len
expr_stmt|;
name|uio
operator|.
name|uio_iov
operator|=
operator|&
name|iov
expr_stmt|;
name|uio
operator|.
name|uio_iovcnt
operator|=
literal|1
expr_stmt|;
name|uio
operator|.
name|uio_rw
operator|=
name|UIO_READ
expr_stmt|;
name|uio
operator|.
name|uio_segflg
operator|=
name|UIO_SYSSPACE
expr_stmt|;
name|uio
operator|.
name|uio_td
operator|=
name|curthread
expr_stmt|;
name|uio
operator|.
name|uio_resid
operator|=
name|len
expr_stmt|;
name|flags
operator|=
name|wait
condition|?
literal|0
else|:
name|MSG_DONTWAIT
expr_stmt|;
name|error
operator|=
name|soreceive
argument_list|(
name|softc
operator|->
name|ha_so
argument_list|,
name|NULL
argument_list|,
operator|&
name|uio
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
return|return
operator|(
name|CTL_HA_STATUS_SUCCESS
operator|)
return|;
comment|/* Consider all errors fatal for HA sanity. */
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|ha_connected
condition|)
block|{
name|softc
operator|->
name|ha_disconnect
operator|=
literal|1
expr_stmt|;
name|softc
operator|->
name|ha_wakeup
operator|=
literal|1
expr_stmt|;
name|wakeup
argument_list|(
operator|&
name|softc
operator|->
name|ha_wakeup
argument_list|)
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_HA_STATUS_ERROR
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Send a message of the specified size.  */
end_comment

begin_function
name|ctl_ha_status
name|ctl_ha_msg_send2
parameter_list|(
name|ctl_ha_channel
name|channel
parameter_list|,
specifier|const
name|void
modifier|*
name|addr
parameter_list|,
name|size_t
name|len
parameter_list|,
specifier|const
name|void
modifier|*
name|addr2
parameter_list|,
name|size_t
name|len2
parameter_list|,
name|int
name|wait
parameter_list|)
block|{
name|struct
name|ha_softc
modifier|*
name|softc
init|=
operator|&
name|ha_softc
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|mb
decl_stmt|,
modifier|*
name|newmb
decl_stmt|;
name|struct
name|ha_msg_wire
name|hdr
decl_stmt|;
name|size_t
name|copylen
decl_stmt|,
name|off
decl_stmt|;
if|if
condition|(
operator|!
name|softc
operator|->
name|ha_connected
condition|)
return|return
operator|(
name|CTL_HA_STATUS_DISCONNECT
operator|)
return|;
name|newmb
operator|=
name|m_getm2
argument_list|(
name|NULL
argument_list|,
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
operator|+
name|len
operator|+
name|len2
argument_list|,
name|wait
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|newmb
operator|==
name|NULL
condition|)
block|{
comment|/* Consider all errors fatal for HA sanity. */
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|ha_connected
condition|)
block|{
name|softc
operator|->
name|ha_disconnect
operator|=
literal|1
expr_stmt|;
name|softc
operator|->
name|ha_wakeup
operator|=
literal|1
expr_stmt|;
name|wakeup
argument_list|(
operator|&
name|softc
operator|->
name|ha_wakeup
argument_list|)
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s: Can't allocate mbuf chain\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_HA_STATUS_ERROR
operator|)
return|;
block|}
name|hdr
operator|.
name|channel
operator|=
name|channel
expr_stmt|;
name|hdr
operator|.
name|length
operator|=
name|len
operator|+
name|len2
expr_stmt|;
name|mb
operator|=
name|newmb
expr_stmt|;
name|memcpy
argument_list|(
name|mtodo
argument_list|(
name|mb
argument_list|,
literal|0
argument_list|)
argument_list|,
operator|&
name|hdr
argument_list|,
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
name|mb
operator|->
name|m_len
operator|+=
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
expr_stmt|;
name|off
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
name|mb
operator|!=
name|NULL
operator|&&
name|off
operator|<
name|len
condition|;
name|mb
operator|=
name|mb
operator|->
name|m_next
control|)
block|{
name|copylen
operator|=
name|min
argument_list|(
name|M_TRAILINGSPACE
argument_list|(
name|mb
argument_list|)
argument_list|,
name|len
operator|-
name|off
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|mtodo
argument_list|(
name|mb
argument_list|,
name|mb
operator|->
name|m_len
argument_list|)
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|addr
operator|+
name|off
argument_list|,
name|copylen
argument_list|)
expr_stmt|;
name|mb
operator|->
name|m_len
operator|+=
name|copylen
expr_stmt|;
name|off
operator|+=
name|copylen
expr_stmt|;
if|if
condition|(
name|off
operator|==
name|len
condition|)
break|break;
block|}
name|KASSERT
argument_list|(
name|off
operator|==
name|len
argument_list|,
operator|(
literal|"%s: off (%zu) != len (%zu)"
operator|,
name|__func__
operator|,
name|off
operator|,
name|len
operator|)
argument_list|)
expr_stmt|;
name|off
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
name|mb
operator|!=
name|NULL
operator|&&
name|off
operator|<
name|len2
condition|;
name|mb
operator|=
name|mb
operator|->
name|m_next
control|)
block|{
name|copylen
operator|=
name|min
argument_list|(
name|M_TRAILINGSPACE
argument_list|(
name|mb
argument_list|)
argument_list|,
name|len2
operator|-
name|off
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|mtodo
argument_list|(
name|mb
argument_list|,
name|mb
operator|->
name|m_len
argument_list|)
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|addr2
operator|+
name|off
argument_list|,
name|copylen
argument_list|)
expr_stmt|;
name|mb
operator|->
name|m_len
operator|+=
name|copylen
expr_stmt|;
name|off
operator|+=
name|copylen
expr_stmt|;
block|}
name|KASSERT
argument_list|(
name|off
operator|==
name|len2
argument_list|,
operator|(
literal|"%s: off (%zu) != len2 (%zu)"
operator|,
name|__func__
operator|,
name|off
operator|,
name|len2
operator|)
argument_list|)
expr_stmt|;
name|newmb
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
operator|+
name|len
operator|+
name|len2
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|softc
operator|->
name|ha_connected
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|newmb
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_HA_STATUS_DISCONNECT
operator|)
return|;
block|}
name|mbufq_enqueue
argument_list|(
operator|&
name|softc
operator|->
name|ha_sendq
argument_list|,
name|newmb
argument_list|)
expr_stmt|;
name|softc
operator|->
name|ha_wakeup
operator|=
literal|1
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
name|wakeup
argument_list|(
operator|&
name|softc
operator|->
name|ha_wakeup
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_HA_STATUS_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
name|ctl_ha_status
name|ctl_ha_msg_send
parameter_list|(
name|ctl_ha_channel
name|channel
parameter_list|,
specifier|const
name|void
modifier|*
name|addr
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|wait
parameter_list|)
block|{
return|return
operator|(
name|ctl_ha_msg_send2
argument_list|(
name|channel
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|wait
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|ctl_ha_status
name|ctl_ha_msg_abort
parameter_list|(
name|ctl_ha_channel
name|channel
parameter_list|)
block|{
name|struct
name|ha_softc
modifier|*
name|softc
init|=
operator|&
name|ha_softc
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
name|softc
operator|->
name|ha_disconnect
operator|=
literal|1
expr_stmt|;
name|softc
operator|->
name|ha_wakeup
operator|=
literal|1
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
name|wakeup
argument_list|(
operator|&
name|softc
operator|->
name|ha_wakeup
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_HA_STATUS_SUCCESS
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Allocate a data transfer request structure.  */
end_comment

begin_function
name|struct
name|ctl_ha_dt_req
modifier|*
name|ctl_dt_req_alloc
parameter_list|(
name|void
parameter_list|)
block|{
return|return
operator|(
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ctl_ha_dt_req
argument_list|)
argument_list|,
name|M_CTL
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Free a data transfer request structure.  */
end_comment

begin_function
name|void
name|ctl_dt_req_free
parameter_list|(
name|struct
name|ctl_ha_dt_req
modifier|*
name|req
parameter_list|)
block|{
name|free
argument_list|(
name|req
argument_list|,
name|M_CTL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Issue a DMA request for a single buffer.  */
end_comment

begin_function
name|ctl_ha_status
name|ctl_dt_single
parameter_list|(
name|struct
name|ctl_ha_dt_req
modifier|*
name|req
parameter_list|)
block|{
name|struct
name|ha_softc
modifier|*
name|softc
init|=
operator|&
name|ha_softc
decl_stmt|;
name|struct
name|ha_dt_msg_wire
name|wire_dt
decl_stmt|;
name|ctl_ha_status
name|status
decl_stmt|;
name|wire_dt
operator|.
name|command
operator|=
name|req
operator|->
name|command
expr_stmt|;
name|wire_dt
operator|.
name|size
operator|=
name|req
operator|->
name|size
expr_stmt|;
name|wire_dt
operator|.
name|local
operator|=
name|req
operator|->
name|local
expr_stmt|;
name|wire_dt
operator|.
name|remote
operator|=
name|req
operator|->
name|remote
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|command
operator|==
name|CTL_HA_DT_CMD_READ
operator|&&
name|req
operator|->
name|callback
operator|!=
name|NULL
condition|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|softc
operator|->
name|ha_dts
argument_list|,
name|req
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
name|ctl_ha_msg_send
argument_list|(
name|CTL_HA_CHAN_DATA
argument_list|,
operator|&
name|wire_dt
argument_list|,
sizeof|sizeof
argument_list|(
name|wire_dt
argument_list|)
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_HA_STATUS_WAIT
operator|)
return|;
block|}
if|if
condition|(
name|req
operator|->
name|command
operator|==
name|CTL_HA_DT_CMD_READ
condition|)
block|{
name|status
operator|=
name|ctl_ha_msg_send
argument_list|(
name|CTL_HA_CHAN_DATA
argument_list|,
operator|&
name|wire_dt
argument_list|,
sizeof|sizeof
argument_list|(
name|wire_dt
argument_list|)
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|ctl_ha_msg_send2
argument_list|(
name|CTL_HA_CHAN_DATA
argument_list|,
operator|&
name|wire_dt
argument_list|,
sizeof|sizeof
argument_list|(
name|wire_dt
argument_list|)
argument_list|,
name|req
operator|->
name|local
argument_list|,
name|req
operator|->
name|size
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ctl_dt_event_handler
parameter_list|(
name|ctl_ha_channel
name|channel
parameter_list|,
name|ctl_ha_event
name|event
parameter_list|,
name|int
name|param
parameter_list|)
block|{
name|struct
name|ha_softc
modifier|*
name|softc
init|=
operator|&
name|ha_softc
decl_stmt|;
name|struct
name|ctl_ha_dt_req
modifier|*
name|req
decl_stmt|;
name|ctl_ha_status
name|isc_status
decl_stmt|;
if|if
condition|(
name|event
operator|==
name|CTL_HA_EVT_MSG_RECV
condition|)
block|{
name|struct
name|ha_dt_msg_wire
name|wire_dt
decl_stmt|;
name|uint8_t
modifier|*
name|tmp
decl_stmt|;
name|int
name|size
decl_stmt|;
name|size
operator|=
name|min
argument_list|(
sizeof|sizeof
argument_list|(
name|wire_dt
argument_list|)
argument_list|,
name|param
argument_list|)
expr_stmt|;
name|isc_status
operator|=
name|ctl_ha_msg_recv
argument_list|(
name|CTL_HA_CHAN_DATA
argument_list|,
operator|&
name|wire_dt
argument_list|,
name|size
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
name|isc_status
operator|!=
name|CTL_HA_STATUS_SUCCESS
condition|)
block|{
name|printf
argument_list|(
literal|"%s: Error receiving message: %d\n"
argument_list|,
name|__func__
argument_list|,
name|isc_status
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wire_dt
operator|.
name|command
operator|==
name|CTL_HA_DT_CMD_READ
condition|)
block|{
name|wire_dt
operator|.
name|command
operator|=
name|CTL_HA_DT_CMD_WRITE
expr_stmt|;
name|tmp
operator|=
name|wire_dt
operator|.
name|local
expr_stmt|;
name|wire_dt
operator|.
name|local
operator|=
name|wire_dt
operator|.
name|remote
expr_stmt|;
name|wire_dt
operator|.
name|remote
operator|=
name|tmp
expr_stmt|;
name|ctl_ha_msg_send2
argument_list|(
name|CTL_HA_CHAN_DATA
argument_list|,
operator|&
name|wire_dt
argument_list|,
sizeof|sizeof
argument_list|(
name|wire_dt
argument_list|)
argument_list|,
name|wire_dt
operator|.
name|local
argument_list|,
name|wire_dt
operator|.
name|size
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wire_dt
operator|.
name|command
operator|==
name|CTL_HA_DT_CMD_WRITE
condition|)
block|{
name|isc_status
operator|=
name|ctl_ha_msg_recv
argument_list|(
name|CTL_HA_CHAN_DATA
argument_list|,
name|wire_dt
operator|.
name|remote
argument_list|,
name|wire_dt
operator|.
name|size
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|req
argument_list|,
argument|&softc->ha_dts
argument_list|,
argument|links
argument_list|)
block|{
if|if
condition|(
name|req
operator|->
name|local
operator|==
name|wire_dt
operator|.
name|remote
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|softc
operator|->
name|ha_dts
argument_list|,
name|req
argument_list|,
name|links
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
condition|)
block|{
name|req
operator|->
name|ret
operator|=
name|isc_status
expr_stmt|;
name|req
operator|->
name|callback
argument_list|(
name|req
argument_list|)
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|event
operator|==
name|CTL_HA_EVT_LINK_CHANGE
condition|)
block|{
name|CTL_DEBUG_PRINT
argument_list|(
operator|(
literal|"%s: Link state change to %d\n"
operator|,
name|__func__
operator|,
name|param
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|param
operator|!=
name|CTL_HA_LINK_ONLINE
condition|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|req
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|softc
operator|->
name|ha_dts
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|softc
operator|->
name|ha_dts
argument_list|,
name|req
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
name|req
operator|->
name|ret
operator|=
name|CTL_HA_STATUS_DISCONNECT
expr_stmt|;
name|req
operator|->
name|callback
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%s: Unknown event %d\n"
argument_list|,
name|__func__
argument_list|,
name|event
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|ctl_ha_status
name|ctl_ha_msg_init
parameter_list|(
name|struct
name|ctl_softc
modifier|*
name|ctl_softc
parameter_list|)
block|{
name|struct
name|ha_softc
modifier|*
name|softc
init|=
operator|&
name|ha_softc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|softc
operator|->
name|ha_ctl_softc
operator|=
name|ctl_softc
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|,
literal|"CTL HA mutex"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|mbufq_init
argument_list|(
operator|&
name|softc
operator|->
name|ha_sendq
argument_list|,
name|INT_MAX
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|softc
operator|->
name|ha_dts
argument_list|)
expr_stmt|;
name|error
operator|=
name|kproc_kthread_add
argument_list|(
name|ctl_ha_conn_thread
argument_list|,
name|softc
argument_list|,
operator|&
name|ctl_softc
operator|->
name|ctl_proc
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|"ctl"
argument_list|,
literal|"ha_tx"
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"error creating CTL HA connection thread!\n"
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_HA_STATUS_ERROR
operator|)
return|;
block|}
name|softc
operator|->
name|ha_shutdown_eh
operator|=
name|EVENTHANDLER_REGISTER
argument_list|(
name|shutdown_pre_sync
argument_list|,
name|ctl_ha_msg_shutdown
argument_list|,
name|ctl_softc
argument_list|,
name|SHUTDOWN_PRI_FIRST
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|ctl_softc
operator|->
name|sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|ctl_softc
operator|->
name|sysctl_tree
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"ha_peer"
argument_list|,
name|CTLTYPE_STRING
operator||
name|CTLFLAG_RWTUN
argument_list|,
name|softc
argument_list|,
literal|0
argument_list|,
name|ctl_ha_peer_sysctl
argument_list|,
literal|"A"
argument_list|,
literal|"HA peer connection method"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctl_ha_msg_register
argument_list|(
name|CTL_HA_CHAN_DATA
argument_list|,
name|ctl_dt_event_handler
argument_list|)
operator|!=
name|CTL_HA_STATUS_SUCCESS
condition|)
block|{
name|printf
argument_list|(
literal|"%s: ctl_ha_msg_register failed.\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|CTL_HA_STATUS_SUCCESS
operator|)
return|;
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_function
name|void
name|ctl_ha_msg_shutdown
parameter_list|(
name|struct
name|ctl_softc
modifier|*
name|ctl_softc
parameter_list|)
block|{
name|struct
name|ha_softc
modifier|*
name|softc
init|=
operator|&
name|ha_softc
decl_stmt|;
comment|/* Disconnect and shutdown threads. */
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|ha_shutdown
operator|<
literal|2
condition|)
block|{
name|softc
operator|->
name|ha_shutdown
operator|=
literal|1
expr_stmt|;
name|softc
operator|->
name|ha_wakeup
operator|=
literal|1
expr_stmt|;
name|wakeup
argument_list|(
operator|&
name|softc
operator|->
name|ha_wakeup
argument_list|)
expr_stmt|;
while|while
condition|(
name|softc
operator|->
name|ha_shutdown
operator|<
literal|2
condition|)
block|{
name|msleep
argument_list|(
operator|&
name|softc
operator|->
name|ha_wakeup
argument_list|,
operator|&
name|softc
operator|->
name|ha_lock
argument_list|,
literal|0
argument_list|,
literal|"shutdown"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
block|}
block|}
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_function
name|ctl_ha_status
name|ctl_ha_msg_destroy
parameter_list|(
name|struct
name|ctl_softc
modifier|*
name|ctl_softc
parameter_list|)
block|{
name|struct
name|ha_softc
modifier|*
name|softc
init|=
operator|&
name|ha_softc
decl_stmt|;
if|if
condition|(
name|softc
operator|->
name|ha_shutdown_eh
operator|!=
name|NULL
condition|)
block|{
name|EVENTHANDLER_DEREGISTER
argument_list|(
name|shutdown_pre_sync
argument_list|,
name|softc
operator|->
name|ha_shutdown_eh
argument_list|)
expr_stmt|;
name|softc
operator|->
name|ha_shutdown_eh
operator|=
name|NULL
expr_stmt|;
block|}
name|ctl_ha_msg_shutdown
argument_list|(
name|ctl_softc
argument_list|)
expr_stmt|;
comment|/* Just in case. */
if|if
condition|(
name|ctl_ha_msg_deregister
argument_list|(
name|CTL_HA_CHAN_DATA
argument_list|)
operator|!=
name|CTL_HA_STATUS_SUCCESS
condition|)
name|printf
argument_list|(
literal|"%s: ctl_ha_msg_deregister failed.\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|softc
operator|->
name|ha_lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_HA_STATUS_SUCCESS
operator|)
return|;
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

end_unit


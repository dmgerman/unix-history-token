begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2003, 2008 Silicon Graphics International Corp.  * Copyright (c) 2012 The FreeBSD Foundation  * Copyright (c) 2014-2017 Alexander Motin<mav@FreeBSD.org>  * All rights reserved.  *  * Portions of this software were developed by Edward Tomasz Napierala  * under sponsorship from the FreeBSD Foundation.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions, and the following disclaimer,  *    without modification.  * 2. Redistributions in binary form must reproduce at minimum a disclaimer  *    substantially similar to the "NO WARRANTY" disclaimer below  *    ("Disclaimer") and any redistribution must be conditioned upon  *    including a substantially similar Disclaimer requirement for further  *    binary redistribution.  *  * NO WARRANTY  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT  * HOLDERS OR CONTRIBUTORS BE LIABLE FOR SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING  * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGES.  *  * $Id: //depot/users/kenm/FreeBSD-test2/sys/cam/ctl/ctl_backend_ramdisk.c#3 $  */
end_comment

begin_comment
comment|/*  * CAM Target Layer black hole and RAM disk backend.  *  * Author: Ken Merry<ken@FreeBSD.org>  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/condvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/limits.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/sx.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioccom.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<cam/scsi/scsi_all.h>
end_include

begin_include
include|#
directive|include
file|<cam/scsi/scsi_da.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_io.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_util.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_backend.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_debug.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_ha.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_private.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_error.h>
end_include

begin_define
define|#
directive|define
name|PRIV
parameter_list|(
name|io
parameter_list|)
define|\
value|((struct ctl_ptr_len_flags *)&(io)->io_hdr.ctl_private[CTL_PRIV_BACKEND])
end_define

begin_define
define|#
directive|define
name|ARGS
parameter_list|(
name|io
parameter_list|)
define|\
value|((struct ctl_lba_len_flags *)&(io)->io_hdr.ctl_private[CTL_PRIV_LBA_LEN])
end_define

begin_define
define|#
directive|define
name|PPP
value|(PAGE_SIZE / sizeof(uint8_t **))
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|__LP64__
end_ifdef

begin_define
define|#
directive|define
name|PPPS
value|(PAGE_SHIFT - 3)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|PPPS
value|(PAGE_SHIFT - 2)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|SGPP
value|(PAGE_SIZE / sizeof(struct ctl_sg_entry))
end_define

begin_define
define|#
directive|define
name|P_UNMAPPED
value|NULL
end_define

begin_comment
comment|/* Page is unmapped. */
end_comment

begin_define
define|#
directive|define
name|P_ANCHORED
value|((void *)(uintptr_t)1)
end_define

begin_comment
comment|/* Page is anchored. */
end_comment

begin_typedef
typedef|typedef
enum|enum
block|{
name|GP_READ
block|,
comment|/* Return data page or zero page. */
name|GP_WRITE
block|,
comment|/* Return data page, try allocate if none. */
name|GP_ANCHOR
block|,
comment|/* Return data page, try anchor if none. */
name|GP_OTHER
block|,
comment|/* Return what present, do not allocate/anchor. */
block|}
name|getpage_op_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
enum|enum
block|{
name|CTL_BE_RAMDISK_LUN_UNCONFIGURED
init|=
literal|0x01
block|,
name|CTL_BE_RAMDISK_LUN_CONFIG_ERR
init|=
literal|0x02
block|,
name|CTL_BE_RAMDISK_LUN_WAITING
init|=
literal|0x04
block|}
name|ctl_be_ramdisk_lun_flags
typedef|;
end_typedef

begin_struct
struct|struct
name|ctl_be_ramdisk_lun
block|{
name|struct
name|ctl_lun_create_params
name|params
decl_stmt|;
name|char
name|lunname
index|[
literal|32
index|]
decl_stmt|;
name|int
name|indir
decl_stmt|;
name|uint8_t
modifier|*
modifier|*
name|pages
decl_stmt|;
name|uint8_t
modifier|*
name|zero_page
decl_stmt|;
name|struct
name|sx
name|page_lock
decl_stmt|;
name|u_int
name|pblocksize
decl_stmt|;
name|u_int
name|pblockmul
decl_stmt|;
name|uint64_t
name|size_bytes
decl_stmt|;
name|uint64_t
name|size_blocks
decl_stmt|;
name|uint64_t
name|cap_bytes
decl_stmt|;
name|uint64_t
name|cap_used
decl_stmt|;
name|struct
name|ctl_be_ramdisk_softc
modifier|*
name|softc
decl_stmt|;
name|ctl_be_ramdisk_lun_flags
name|flags
decl_stmt|;
name|STAILQ_ENTRY
argument_list|(
argument|ctl_be_ramdisk_lun
argument_list|)
name|links
expr_stmt|;
name|struct
name|ctl_be_lun
name|cbe_lun
decl_stmt|;
name|struct
name|taskqueue
modifier|*
name|io_taskqueue
decl_stmt|;
name|struct
name|task
name|io_task
decl_stmt|;
name|STAILQ_HEAD
argument_list|(
argument_list|,
argument|ctl_io_hdr
argument_list|)
name|cont_queue
expr_stmt|;
name|struct
name|mtx_padalign
name|queue_lock
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|ctl_be_ramdisk_softc
block|{
name|struct
name|mtx
name|lock
decl_stmt|;
name|int
name|num_luns
decl_stmt|;
name|STAILQ_HEAD
argument_list|(
argument_list|,
argument|ctl_be_ramdisk_lun
argument_list|)
name|lun_list
expr_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|ctl_be_ramdisk_softc
name|rd_softc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|struct
name|ctl_softc
modifier|*
name|control_softc
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|ctl_backend_ramdisk_init
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ctl_backend_ramdisk_shutdown
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ctl_backend_ramdisk_move_done
parameter_list|(
name|union
name|ctl_io
modifier|*
name|io
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ctl_backend_ramdisk_compare
parameter_list|(
name|union
name|ctl_io
modifier|*
name|io
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ctl_backend_ramdisk_rw
parameter_list|(
name|union
name|ctl_io
modifier|*
name|io
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ctl_backend_ramdisk_submit
parameter_list|(
name|union
name|ctl_io
modifier|*
name|io
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ctl_backend_ramdisk_worker
parameter_list|(
name|void
modifier|*
name|context
parameter_list|,
name|int
name|pending
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ctl_backend_ramdisk_config_read
parameter_list|(
name|union
name|ctl_io
modifier|*
name|io
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ctl_backend_ramdisk_config_write
parameter_list|(
name|union
name|ctl_io
modifier|*
name|io
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint64_t
name|ctl_backend_ramdisk_lun_attr
parameter_list|(
name|void
modifier|*
name|be_lun
parameter_list|,
specifier|const
name|char
modifier|*
name|attrname
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ctl_backend_ramdisk_ioctl
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|addr
parameter_list|,
name|int
name|flag
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ctl_backend_ramdisk_rm
parameter_list|(
name|struct
name|ctl_be_ramdisk_softc
modifier|*
name|softc
parameter_list|,
name|struct
name|ctl_lun_req
modifier|*
name|req
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ctl_backend_ramdisk_create
parameter_list|(
name|struct
name|ctl_be_ramdisk_softc
modifier|*
name|softc
parameter_list|,
name|struct
name|ctl_lun_req
modifier|*
name|req
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ctl_backend_ramdisk_modify
parameter_list|(
name|struct
name|ctl_be_ramdisk_softc
modifier|*
name|softc
parameter_list|,
name|struct
name|ctl_lun_req
modifier|*
name|req
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ctl_backend_ramdisk_lun_shutdown
parameter_list|(
name|void
modifier|*
name|be_lun
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ctl_backend_ramdisk_lun_config_status
parameter_list|(
name|void
modifier|*
name|be_lun
parameter_list|,
name|ctl_lun_config_status
name|status
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|struct
name|ctl_backend_driver
name|ctl_be_ramdisk_driver
init|=
block|{
operator|.
name|name
operator|=
literal|"ramdisk"
block|,
operator|.
name|flags
operator|=
name|CTL_BE_FLAG_HAS_CONFIG
block|,
operator|.
name|init
operator|=
name|ctl_backend_ramdisk_init
block|,
operator|.
name|shutdown
operator|=
name|ctl_backend_ramdisk_shutdown
block|,
operator|.
name|data_submit
operator|=
name|ctl_backend_ramdisk_submit
block|,
operator|.
name|data_move_done
operator|=
name|ctl_backend_ramdisk_move_done
block|,
operator|.
name|config_read
operator|=
name|ctl_backend_ramdisk_config_read
block|,
operator|.
name|config_write
operator|=
name|ctl_backend_ramdisk_config_write
block|,
operator|.
name|ioctl
operator|=
name|ctl_backend_ramdisk_ioctl
block|,
operator|.
name|lun_attr
operator|=
name|ctl_backend_ramdisk_lun_attr
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_RAMDISK
argument_list|,
literal|"ramdisk"
argument_list|,
literal|"Memory used for CTL RAMdisk"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|CTL_BACKEND_DECLARE
argument_list|(
name|cbr
argument_list|,
name|ctl_be_ramdisk_driver
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|ctl_backend_ramdisk_init
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|ctl_be_ramdisk_softc
modifier|*
name|softc
init|=
operator|&
name|rd_softc
decl_stmt|;
name|memset
argument_list|(
name|softc
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|softc
argument_list|)
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|,
literal|"ctlramdisk"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|STAILQ_INIT
argument_list|(
operator|&
name|softc
operator|->
name|lun_list
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ctl_backend_ramdisk_shutdown
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|ctl_be_ramdisk_softc
modifier|*
name|softc
init|=
operator|&
name|rd_softc
decl_stmt|;
name|struct
name|ctl_be_ramdisk_lun
modifier|*
name|lun
decl_stmt|,
modifier|*
name|next_lun
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|STAILQ_FOREACH_SAFE
argument_list|(
argument|lun
argument_list|,
argument|&softc->lun_list
argument_list|,
argument|links
argument_list|,
argument|next_lun
argument_list|)
block|{
comment|/* 		 * Drop our lock here.  Since ctl_invalidate_lun() can call 		 * back into us, this could potentially lead to a recursive 		 * lock of the same mutex, which would cause a hang. 		 */
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|ctl_disable_lun
argument_list|(
operator|&
name|lun
operator|->
name|cbe_lun
argument_list|)
expr_stmt|;
name|ctl_invalidate_lun
argument_list|(
operator|&
name|lun
operator|->
name|cbe_lun
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
modifier|*
name|ctl_backend_ramdisk_getpage
parameter_list|(
name|struct
name|ctl_be_ramdisk_lun
modifier|*
name|be_lun
parameter_list|,
name|off_t
name|pn
parameter_list|,
name|getpage_op_t
name|op
parameter_list|)
block|{
name|uint8_t
modifier|*
modifier|*
name|p
decl_stmt|,
modifier|*
modifier|*
modifier|*
name|pp
decl_stmt|;
name|off_t
name|i
decl_stmt|;
name|int
name|s
decl_stmt|;
if|if
condition|(
name|be_lun
operator|->
name|cap_bytes
operator|==
literal|0
condition|)
block|{
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|GP_READ
case|:
return|return
operator|(
name|be_lun
operator|->
name|zero_page
operator|)
return|;
case|case
name|GP_WRITE
case|:
return|return
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|be_lun
operator|->
name|pages
operator|)
return|;
case|case
name|GP_ANCHOR
case|:
return|return
operator|(
name|P_ANCHORED
operator|)
return|;
default|default:
return|return
operator|(
name|P_UNMAPPED
operator|)
return|;
block|}
block|}
if|if
condition|(
name|op
operator|==
name|GP_WRITE
operator|||
name|op
operator|==
name|GP_ANCHOR
condition|)
block|{
name|sx_xlock
argument_list|(
operator|&
name|be_lun
operator|->
name|page_lock
argument_list|)
expr_stmt|;
name|pp
operator|=
operator|&
name|be_lun
operator|->
name|pages
expr_stmt|;
for|for
control|(
name|s
operator|=
operator|(
name|be_lun
operator|->
name|indir
operator|-
literal|1
operator|)
operator|*
name|PPPS
init|;
name|s
operator|>=
literal|0
condition|;
name|s
operator|-=
name|PPPS
control|)
block|{
if|if
condition|(
operator|*
name|pp
operator|==
name|NULL
condition|)
block|{
operator|*
name|pp
operator|=
name|malloc
argument_list|(
name|PAGE_SIZE
argument_list|,
name|M_RAMDISK
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
block|}
name|i
operator|=
name|pn
operator|>>
name|s
expr_stmt|;
name|pp
operator|=
operator|(
name|uint8_t
operator|*
operator|*
operator|*
operator|)
operator|&
operator|(
operator|*
name|pp
operator|)
index|[
name|i
index|]
expr_stmt|;
name|pn
operator|-=
name|i
operator|<<
name|s
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|pp
operator|==
name|P_UNMAPPED
operator|&&
name|be_lun
operator|->
name|cap_used
operator|<
name|be_lun
operator|->
name|cap_bytes
condition|)
block|{
if|if
condition|(
name|op
operator|==
name|GP_WRITE
condition|)
block|{
operator|*
name|pp
operator|=
name|malloc
argument_list|(
name|be_lun
operator|->
name|pblocksize
argument_list|,
name|M_RAMDISK
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
block|}
else|else
operator|*
name|pp
operator|=
name|P_ANCHORED
expr_stmt|;
name|be_lun
operator|->
name|cap_used
operator|+=
name|be_lun
operator|->
name|pblocksize
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|pp
operator|==
name|P_ANCHORED
operator|&&
name|op
operator|==
name|GP_WRITE
condition|)
block|{
operator|*
name|pp
operator|=
name|malloc
argument_list|(
name|be_lun
operator|->
name|pblocksize
argument_list|,
name|M_RAMDISK
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
block|}
name|sx_xunlock
argument_list|(
operator|&
name|be_lun
operator|->
name|page_lock
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|uint8_t
operator|*
operator|)
operator|*
name|pp
operator|)
return|;
block|}
else|else
block|{
name|sx_slock
argument_list|(
operator|&
name|be_lun
operator|->
name|page_lock
argument_list|)
expr_stmt|;
name|p
operator|=
name|be_lun
operator|->
name|pages
expr_stmt|;
for|for
control|(
name|s
operator|=
operator|(
name|be_lun
operator|->
name|indir
operator|-
literal|1
operator|)
operator|*
name|PPPS
init|;
name|s
operator|>=
literal|0
condition|;
name|s
operator|-=
name|PPPS
control|)
block|{
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
break|break;
name|i
operator|=
name|pn
operator|>>
name|s
expr_stmt|;
name|p
operator|=
operator|(
name|uint8_t
operator|*
operator|*
operator|)
name|p
index|[
name|i
index|]
expr_stmt|;
name|pn
operator|-=
name|i
operator|<<
name|s
expr_stmt|;
block|}
name|sx_sunlock
argument_list|(
operator|&
name|be_lun
operator|->
name|page_lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|==
name|P_UNMAPPED
operator|||
name|p
operator|==
name|P_ANCHORED
operator|)
operator|&&
name|op
operator|==
name|GP_READ
condition|)
return|return
operator|(
name|be_lun
operator|->
name|zero_page
operator|)
return|;
return|return
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|p
operator|)
return|;
block|}
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_function
specifier|static
name|void
name|ctl_backend_ramdisk_unmappage
parameter_list|(
name|struct
name|ctl_be_ramdisk_lun
modifier|*
name|be_lun
parameter_list|,
name|off_t
name|pn
parameter_list|)
block|{
name|uint8_t
modifier|*
modifier|*
modifier|*
name|pp
decl_stmt|;
name|off_t
name|i
decl_stmt|;
name|int
name|s
decl_stmt|;
if|if
condition|(
name|be_lun
operator|->
name|cap_bytes
operator|==
literal|0
condition|)
return|return;
name|sx_xlock
argument_list|(
operator|&
name|be_lun
operator|->
name|page_lock
argument_list|)
expr_stmt|;
name|pp
operator|=
operator|&
name|be_lun
operator|->
name|pages
expr_stmt|;
for|for
control|(
name|s
operator|=
operator|(
name|be_lun
operator|->
name|indir
operator|-
literal|1
operator|)
operator|*
name|PPPS
init|;
name|s
operator|>=
literal|0
condition|;
name|s
operator|-=
name|PPPS
control|)
block|{
if|if
condition|(
operator|*
name|pp
operator|==
name|NULL
condition|)
goto|goto
name|noindir
goto|;
name|i
operator|=
name|pn
operator|>>
name|s
expr_stmt|;
name|pp
operator|=
operator|(
name|uint8_t
operator|*
operator|*
operator|*
operator|)
operator|&
operator|(
operator|*
name|pp
operator|)
index|[
name|i
index|]
expr_stmt|;
name|pn
operator|-=
name|i
operator|<<
name|s
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|pp
operator|==
name|P_ANCHORED
condition|)
block|{
name|be_lun
operator|->
name|cap_used
operator|-=
name|be_lun
operator|->
name|pblocksize
expr_stmt|;
operator|*
name|pp
operator|=
name|P_UNMAPPED
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|pp
operator|!=
name|P_UNMAPPED
condition|)
block|{
name|free
argument_list|(
operator|*
name|pp
argument_list|,
name|M_RAMDISK
argument_list|)
expr_stmt|;
name|be_lun
operator|->
name|cap_used
operator|-=
name|be_lun
operator|->
name|pblocksize
expr_stmt|;
operator|*
name|pp
operator|=
name|P_UNMAPPED
expr_stmt|;
block|}
name|noindir
label|:
name|sx_xunlock
argument_list|(
operator|&
name|be_lun
operator|->
name|page_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_function
specifier|static
name|void
name|ctl_backend_ramdisk_anchorpage
parameter_list|(
name|struct
name|ctl_be_ramdisk_lun
modifier|*
name|be_lun
parameter_list|,
name|off_t
name|pn
parameter_list|)
block|{
name|uint8_t
modifier|*
modifier|*
modifier|*
name|pp
decl_stmt|;
name|off_t
name|i
decl_stmt|;
name|int
name|s
decl_stmt|;
if|if
condition|(
name|be_lun
operator|->
name|cap_bytes
operator|==
literal|0
condition|)
return|return;
name|sx_xlock
argument_list|(
operator|&
name|be_lun
operator|->
name|page_lock
argument_list|)
expr_stmt|;
name|pp
operator|=
operator|&
name|be_lun
operator|->
name|pages
expr_stmt|;
for|for
control|(
name|s
operator|=
operator|(
name|be_lun
operator|->
name|indir
operator|-
literal|1
operator|)
operator|*
name|PPPS
init|;
name|s
operator|>=
literal|0
condition|;
name|s
operator|-=
name|PPPS
control|)
block|{
if|if
condition|(
operator|*
name|pp
operator|==
name|NULL
condition|)
goto|goto
name|noindir
goto|;
name|i
operator|=
name|pn
operator|>>
name|s
expr_stmt|;
name|pp
operator|=
operator|(
name|uint8_t
operator|*
operator|*
operator|*
operator|)
operator|&
operator|(
operator|*
name|pp
operator|)
index|[
name|i
index|]
expr_stmt|;
name|pn
operator|-=
name|i
operator|<<
name|s
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|pp
operator|==
name|P_UNMAPPED
operator|&&
name|be_lun
operator|->
name|cap_used
operator|<
name|be_lun
operator|->
name|cap_bytes
condition|)
block|{
name|be_lun
operator|->
name|cap_used
operator|+=
name|be_lun
operator|->
name|pblocksize
expr_stmt|;
operator|*
name|pp
operator|=
name|P_ANCHORED
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|pp
operator|!=
name|P_ANCHORED
condition|)
block|{
name|free
argument_list|(
operator|*
name|pp
argument_list|,
name|M_RAMDISK
argument_list|)
expr_stmt|;
operator|*
name|pp
operator|=
name|P_ANCHORED
expr_stmt|;
block|}
name|noindir
label|:
name|sx_xunlock
argument_list|(
operator|&
name|be_lun
operator|->
name|page_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_function
specifier|static
name|void
name|ctl_backend_ramdisk_freeallpages
parameter_list|(
name|uint8_t
modifier|*
modifier|*
name|p
parameter_list|,
name|int
name|indir
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|indir
operator|==
literal|0
condition|)
block|{
name|free
argument_list|(
name|p
argument_list|,
name|M_RAMDISK
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|PPP
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|p
index|[
name|i
index|]
operator|==
name|NULL
condition|)
continue|continue;
name|ctl_backend_ramdisk_freeallpages
argument_list|(
operator|(
name|uint8_t
operator|*
operator|*
operator|)
name|p
index|[
name|i
index|]
argument_list|,
name|indir
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|p
argument_list|,
name|M_RAMDISK
argument_list|)
expr_stmt|;
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_function
specifier|static
name|size_t
name|cmp
parameter_list|(
name|uint8_t
modifier|*
name|a
parameter_list|,
name|uint8_t
modifier|*
name|b
parameter_list|,
name|size_t
name|size
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|a
index|[
name|i
index|]
operator|!=
name|b
index|[
name|i
index|]
condition|)
break|break;
block|}
return|return
operator|(
name|i
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ctl_backend_ramdisk_cmp
parameter_list|(
name|union
name|ctl_io
modifier|*
name|io
parameter_list|)
block|{
name|struct
name|ctl_be_lun
modifier|*
name|cbe_lun
init|=
name|CTL_BACKEND_LUN
argument_list|(
name|io
argument_list|)
decl_stmt|;
name|struct
name|ctl_be_ramdisk_lun
modifier|*
name|be_lun
init|=
name|cbe_lun
operator|->
name|be_lun
decl_stmt|;
name|uint8_t
modifier|*
name|page
decl_stmt|;
name|uint8_t
name|info
index|[
literal|8
index|]
decl_stmt|;
name|uint64_t
name|lba
decl_stmt|;
name|u_int
name|lbaoff
decl_stmt|,
name|lbas
decl_stmt|,
name|res
decl_stmt|,
name|off
decl_stmt|;
name|lbas
operator|=
name|io
operator|->
name|scsiio
operator|.
name|kern_data_len
operator|/
name|cbe_lun
operator|->
name|blocksize
expr_stmt|;
name|lba
operator|=
name|ARGS
argument_list|(
name|io
argument_list|)
operator|->
name|lba
operator|+
name|PRIV
argument_list|(
name|io
argument_list|)
operator|->
name|len
operator|-
name|lbas
expr_stmt|;
name|off
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
name|lbas
operator|>
literal|0
condition|;
name|lbas
operator|--
operator|,
name|lba
operator|++
control|)
block|{
name|page
operator|=
name|ctl_backend_ramdisk_getpage
argument_list|(
name|be_lun
argument_list|,
name|lba
operator|>>
name|cbe_lun
operator|->
name|pblockexp
argument_list|,
name|GP_READ
argument_list|)
expr_stmt|;
name|lbaoff
operator|=
name|lba
operator|&
operator|~
operator|(
name|UINT_MAX
operator|<<
name|cbe_lun
operator|->
name|pblockexp
operator|)
expr_stmt|;
name|page
operator|+=
name|lbaoff
operator|*
name|cbe_lun
operator|->
name|blocksize
expr_stmt|;
name|res
operator|=
name|cmp
argument_list|(
name|io
operator|->
name|scsiio
operator|.
name|kern_data_ptr
operator|+
name|off
argument_list|,
name|page
argument_list|,
name|cbe_lun
operator|->
name|blocksize
argument_list|)
expr_stmt|;
name|off
operator|+=
name|res
expr_stmt|;
if|if
condition|(
name|res
operator|<
name|cbe_lun
operator|->
name|blocksize
condition|)
break|break;
block|}
if|if
condition|(
name|lbas
operator|>
literal|0
condition|)
block|{
name|off
operator|+=
name|io
operator|->
name|scsiio
operator|.
name|kern_rel_offset
operator|-
name|io
operator|->
name|scsiio
operator|.
name|kern_data_len
expr_stmt|;
name|scsi_u64to8b
argument_list|(
name|off
argument_list|,
name|info
argument_list|)
expr_stmt|;
name|ctl_set_sense
argument_list|(
operator|&
name|io
operator|->
name|scsiio
argument_list|,
comment|/*current_error*/
literal|1
argument_list|,
comment|/*sense_key*/
name|SSD_KEY_MISCOMPARE
argument_list|,
comment|/*asc*/
literal|0x1D
argument_list|,
comment|/*ascq*/
literal|0x00
argument_list|,
comment|/*type*/
name|SSD_ELEM_INFO
argument_list|,
comment|/*size*/
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|,
comment|/*data*/
operator|&
name|info
argument_list|,
comment|/*type*/
name|SSD_ELEM_NONE
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ctl_backend_ramdisk_move_done
parameter_list|(
name|union
name|ctl_io
modifier|*
name|io
parameter_list|)
block|{
name|struct
name|ctl_be_lun
modifier|*
name|cbe_lun
init|=
name|CTL_BACKEND_LUN
argument_list|(
name|io
argument_list|)
decl_stmt|;
name|struct
name|ctl_be_ramdisk_lun
modifier|*
name|be_lun
init|=
name|cbe_lun
operator|->
name|be_lun
decl_stmt|;
ifdef|#
directive|ifdef
name|CTL_TIME_IO
name|struct
name|bintime
name|cur_bt
decl_stmt|;
endif|#
directive|endif
name|CTL_DEBUG_PRINT
argument_list|(
operator|(
literal|"ctl_backend_ramdisk_move_done\n"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CTL_TIME_IO
name|getbinuptime
argument_list|(
operator|&
name|cur_bt
argument_list|)
expr_stmt|;
name|bintime_sub
argument_list|(
operator|&
name|cur_bt
argument_list|,
operator|&
name|io
operator|->
name|io_hdr
operator|.
name|dma_start_bt
argument_list|)
expr_stmt|;
name|bintime_add
argument_list|(
operator|&
name|io
operator|->
name|io_hdr
operator|.
name|dma_bt
argument_list|,
operator|&
name|cur_bt
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|io
operator|->
name|io_hdr
operator|.
name|num_dmas
operator|++
expr_stmt|;
if|if
condition|(
name|io
operator|->
name|scsiio
operator|.
name|kern_sg_entries
operator|>
literal|0
condition|)
name|free
argument_list|(
name|io
operator|->
name|scsiio
operator|.
name|kern_data_ptr
argument_list|,
name|M_RAMDISK
argument_list|)
expr_stmt|;
name|io
operator|->
name|scsiio
operator|.
name|kern_rel_offset
operator|+=
name|io
operator|->
name|scsiio
operator|.
name|kern_data_len
expr_stmt|;
if|if
condition|(
name|io
operator|->
name|io_hdr
operator|.
name|flags
operator|&
name|CTL_FLAG_ABORT
condition|)
block|{
empty_stmt|;
block|}
elseif|else
if|if
condition|(
name|io
operator|->
name|io_hdr
operator|.
name|port_status
operator|!=
literal|0
operator|&&
operator|(
operator|(
name|io
operator|->
name|io_hdr
operator|.
name|status
operator|&
name|CTL_STATUS_MASK
operator|)
operator|==
name|CTL_STATUS_NONE
operator|||
operator|(
name|io
operator|->
name|io_hdr
operator|.
name|status
operator|&
name|CTL_STATUS_MASK
operator|)
operator|==
name|CTL_SUCCESS
operator|)
condition|)
block|{
name|ctl_set_internal_failure
argument_list|(
operator|&
name|io
operator|->
name|scsiio
argument_list|,
comment|/*sks_valid*/
literal|1
argument_list|,
comment|/*retry_count*/
name|io
operator|->
name|io_hdr
operator|.
name|port_status
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|io
operator|->
name|scsiio
operator|.
name|kern_data_resid
operator|!=
literal|0
operator|&&
operator|(
name|io
operator|->
name|io_hdr
operator|.
name|flags
operator|&
name|CTL_FLAG_DATA_MASK
operator|)
operator|==
name|CTL_FLAG_DATA_OUT
operator|&&
operator|(
operator|(
name|io
operator|->
name|io_hdr
operator|.
name|status
operator|&
name|CTL_STATUS_MASK
operator|)
operator|==
name|CTL_STATUS_NONE
operator|||
operator|(
name|io
operator|->
name|io_hdr
operator|.
name|status
operator|&
name|CTL_STATUS_MASK
operator|)
operator|==
name|CTL_SUCCESS
operator|)
condition|)
block|{
name|ctl_set_invalid_field_ciu
argument_list|(
operator|&
name|io
operator|->
name|scsiio
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|io
operator|->
name|io_hdr
operator|.
name|port_status
operator|==
literal|0
operator|)
operator|&&
operator|(
operator|(
name|io
operator|->
name|io_hdr
operator|.
name|status
operator|&
name|CTL_STATUS_MASK
operator|)
operator|==
name|CTL_STATUS_NONE
operator|)
condition|)
block|{
if|if
condition|(
name|ARGS
argument_list|(
name|io
argument_list|)
operator|->
name|flags
operator|&
name|CTL_LLF_COMPARE
condition|)
block|{
comment|/* We have data block ready for comparison. */
if|if
condition|(
name|ctl_backend_ramdisk_cmp
argument_list|(
name|io
argument_list|)
condition|)
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|ARGS
argument_list|(
name|io
argument_list|)
operator|->
name|len
operator|>
name|PRIV
argument_list|(
name|io
argument_list|)
operator|->
name|len
condition|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|be_lun
operator|->
name|queue_lock
argument_list|)
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|be_lun
operator|->
name|cont_queue
argument_list|,
operator|&
name|io
operator|->
name|io_hdr
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|be_lun
operator|->
name|queue_lock
argument_list|)
expr_stmt|;
name|taskqueue_enqueue
argument_list|(
name|be_lun
operator|->
name|io_taskqueue
argument_list|,
operator|&
name|be_lun
operator|->
name|io_task
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|ctl_set_success
argument_list|(
operator|&
name|io
operator|->
name|scsiio
argument_list|)
expr_stmt|;
block|}
name|done
label|:
name|ctl_data_submit_done
argument_list|(
name|io
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ctl_backend_ramdisk_compare
parameter_list|(
name|union
name|ctl_io
modifier|*
name|io
parameter_list|)
block|{
name|struct
name|ctl_be_lun
modifier|*
name|cbe_lun
init|=
name|CTL_BACKEND_LUN
argument_list|(
name|io
argument_list|)
decl_stmt|;
name|u_int
name|lbas
decl_stmt|,
name|len
decl_stmt|;
name|lbas
operator|=
name|ARGS
argument_list|(
name|io
argument_list|)
operator|->
name|len
operator|-
name|PRIV
argument_list|(
name|io
argument_list|)
operator|->
name|len
expr_stmt|;
name|lbas
operator|=
name|MIN
argument_list|(
name|lbas
argument_list|,
literal|131072
operator|/
name|cbe_lun
operator|->
name|blocksize
argument_list|)
expr_stmt|;
name|len
operator|=
name|lbas
operator|*
name|cbe_lun
operator|->
name|blocksize
expr_stmt|;
name|io
operator|->
name|scsiio
operator|.
name|be_move_done
operator|=
name|ctl_backend_ramdisk_move_done
expr_stmt|;
name|io
operator|->
name|scsiio
operator|.
name|kern_data_ptr
operator|=
name|malloc
argument_list|(
name|len
argument_list|,
name|M_RAMDISK
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|io
operator|->
name|scsiio
operator|.
name|kern_data_len
operator|=
name|len
expr_stmt|;
name|io
operator|->
name|scsiio
operator|.
name|kern_sg_entries
operator|=
literal|0
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|flags
operator||=
name|CTL_FLAG_ALLOCATED
expr_stmt|;
name|PRIV
argument_list|(
name|io
argument_list|)
operator|->
name|len
operator|+=
name|lbas
expr_stmt|;
ifdef|#
directive|ifdef
name|CTL_TIME_IO
name|getbinuptime
argument_list|(
operator|&
name|io
operator|->
name|io_hdr
operator|.
name|dma_start_bt
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ctl_datamove
argument_list|(
name|io
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ctl_backend_ramdisk_rw
parameter_list|(
name|union
name|ctl_io
modifier|*
name|io
parameter_list|)
block|{
name|struct
name|ctl_be_lun
modifier|*
name|cbe_lun
init|=
name|CTL_BACKEND_LUN
argument_list|(
name|io
argument_list|)
decl_stmt|;
name|struct
name|ctl_be_ramdisk_lun
modifier|*
name|be_lun
init|=
name|cbe_lun
operator|->
name|be_lun
decl_stmt|;
name|struct
name|ctl_sg_entry
modifier|*
name|sg_entries
decl_stmt|;
name|uint8_t
modifier|*
name|page
decl_stmt|;
name|uint64_t
name|lba
decl_stmt|;
name|u_int
name|i
decl_stmt|,
name|len
decl_stmt|,
name|lbaoff
decl_stmt|,
name|lbas
decl_stmt|,
name|sgs
decl_stmt|,
name|off
decl_stmt|;
name|getpage_op_t
name|op
decl_stmt|;
name|lba
operator|=
name|ARGS
argument_list|(
name|io
argument_list|)
operator|->
name|lba
operator|+
name|PRIV
argument_list|(
name|io
argument_list|)
operator|->
name|len
expr_stmt|;
name|lbaoff
operator|=
name|lba
operator|&
operator|~
operator|(
name|UINT_MAX
operator|<<
name|cbe_lun
operator|->
name|pblockexp
operator|)
expr_stmt|;
name|lbas
operator|=
name|ARGS
argument_list|(
name|io
argument_list|)
operator|->
name|len
operator|-
name|PRIV
argument_list|(
name|io
argument_list|)
operator|->
name|len
expr_stmt|;
name|lbas
operator|=
name|MIN
argument_list|(
name|lbas
argument_list|,
operator|(
name|SGPP
operator|<<
name|cbe_lun
operator|->
name|pblockexp
operator|)
operator|-
name|lbaoff
argument_list|)
expr_stmt|;
name|sgs
operator|=
operator|(
name|lbas
operator|+
name|lbaoff
operator|+
name|be_lun
operator|->
name|pblockmul
operator|-
literal|1
operator|)
operator|>>
name|cbe_lun
operator|->
name|pblockexp
expr_stmt|;
name|off
operator|=
name|lbaoff
operator|*
name|cbe_lun
operator|->
name|blocksize
expr_stmt|;
name|op
operator|=
operator|(
name|ARGS
argument_list|(
name|io
argument_list|)
operator|->
name|flags
operator|&
name|CTL_LLF_WRITE
operator|)
condition|?
name|GP_WRITE
else|:
name|GP_READ
expr_stmt|;
if|if
condition|(
name|sgs
operator|>
literal|1
condition|)
block|{
name|io
operator|->
name|scsiio
operator|.
name|kern_data_ptr
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ctl_sg_entry
argument_list|)
operator|*
name|sgs
argument_list|,
name|M_RAMDISK
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|sg_entries
operator|=
operator|(
expr|struct
name|ctl_sg_entry
operator|*
operator|)
name|io
operator|->
name|scsiio
operator|.
name|kern_data_ptr
expr_stmt|;
name|len
operator|=
name|lbas
operator|*
name|cbe_lun
operator|->
name|blocksize
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sgs
condition|;
name|i
operator|++
control|)
block|{
name|page
operator|=
name|ctl_backend_ramdisk_getpage
argument_list|(
name|be_lun
argument_list|,
operator|(
name|lba
operator|>>
name|cbe_lun
operator|->
name|pblockexp
operator|)
operator|+
name|i
argument_list|,
name|op
argument_list|)
expr_stmt|;
if|if
condition|(
name|page
operator|==
name|P_UNMAPPED
operator|||
name|page
operator|==
name|P_ANCHORED
condition|)
block|{
name|free
argument_list|(
name|io
operator|->
name|scsiio
operator|.
name|kern_data_ptr
argument_list|,
name|M_RAMDISK
argument_list|)
expr_stmt|;
name|nospc
label|:
name|ctl_set_space_alloc_fail
argument_list|(
operator|&
name|io
operator|->
name|scsiio
argument_list|)
expr_stmt|;
name|ctl_data_submit_done
argument_list|(
name|io
argument_list|)
expr_stmt|;
return|return;
block|}
name|sg_entries
index|[
name|i
index|]
operator|.
name|addr
operator|=
name|page
operator|+
name|off
expr_stmt|;
name|sg_entries
index|[
name|i
index|]
operator|.
name|len
operator|=
name|MIN
argument_list|(
name|len
argument_list|,
name|be_lun
operator|->
name|pblocksize
operator|-
name|off
argument_list|)
expr_stmt|;
name|len
operator|-=
name|sg_entries
index|[
name|i
index|]
operator|.
name|len
expr_stmt|;
name|off
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
name|page
operator|=
name|ctl_backend_ramdisk_getpage
argument_list|(
name|be_lun
argument_list|,
name|lba
operator|>>
name|cbe_lun
operator|->
name|pblockexp
argument_list|,
name|op
argument_list|)
expr_stmt|;
if|if
condition|(
name|page
operator|==
name|P_UNMAPPED
operator|||
name|page
operator|==
name|P_ANCHORED
condition|)
goto|goto
name|nospc
goto|;
name|sgs
operator|=
literal|0
expr_stmt|;
name|io
operator|->
name|scsiio
operator|.
name|kern_data_ptr
operator|=
name|page
operator|+
name|off
expr_stmt|;
block|}
name|io
operator|->
name|scsiio
operator|.
name|be_move_done
operator|=
name|ctl_backend_ramdisk_move_done
expr_stmt|;
name|io
operator|->
name|scsiio
operator|.
name|kern_data_len
operator|=
name|lbas
operator|*
name|cbe_lun
operator|->
name|blocksize
expr_stmt|;
name|io
operator|->
name|scsiio
operator|.
name|kern_sg_entries
operator|=
name|sgs
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|flags
operator||=
name|CTL_FLAG_ALLOCATED
expr_stmt|;
name|PRIV
argument_list|(
name|io
argument_list|)
operator|->
name|len
operator|+=
name|lbas
expr_stmt|;
if|if
condition|(
operator|(
name|ARGS
argument_list|(
name|io
argument_list|)
operator|->
name|flags
operator|&
name|CTL_LLF_READ
operator|)
operator|&&
name|ARGS
argument_list|(
name|io
argument_list|)
operator|->
name|len
operator|<=
name|PRIV
argument_list|(
name|io
argument_list|)
operator|->
name|len
condition|)
block|{
name|ctl_set_success
argument_list|(
operator|&
name|io
operator|->
name|scsiio
argument_list|)
expr_stmt|;
name|ctl_serseq_done
argument_list|(
name|io
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CTL_TIME_IO
name|getbinuptime
argument_list|(
operator|&
name|io
operator|->
name|io_hdr
operator|.
name|dma_start_bt
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ctl_datamove
argument_list|(
name|io
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ctl_backend_ramdisk_submit
parameter_list|(
name|union
name|ctl_io
modifier|*
name|io
parameter_list|)
block|{
name|struct
name|ctl_lba_len_flags
modifier|*
name|lbalen
init|=
name|ARGS
argument_list|(
name|io
argument_list|)
decl_stmt|;
if|if
condition|(
name|lbalen
operator|->
name|flags
operator|&
name|CTL_LLF_VERIFY
condition|)
block|{
name|ctl_set_success
argument_list|(
operator|&
name|io
operator|->
name|scsiio
argument_list|)
expr_stmt|;
name|ctl_data_submit_done
argument_list|(
name|io
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_RETVAL_COMPLETE
operator|)
return|;
block|}
name|PRIV
argument_list|(
name|io
argument_list|)
operator|->
name|len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|lbalen
operator|->
name|flags
operator|&
name|CTL_LLF_COMPARE
condition|)
name|ctl_backend_ramdisk_compare
argument_list|(
name|io
argument_list|)
expr_stmt|;
else|else
name|ctl_backend_ramdisk_rw
argument_list|(
name|io
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_RETVAL_COMPLETE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ctl_backend_ramdisk_worker
parameter_list|(
name|void
modifier|*
name|context
parameter_list|,
name|int
name|pending
parameter_list|)
block|{
name|struct
name|ctl_be_ramdisk_lun
modifier|*
name|be_lun
decl_stmt|;
name|union
name|ctl_io
modifier|*
name|io
decl_stmt|;
name|be_lun
operator|=
operator|(
expr|struct
name|ctl_be_ramdisk_lun
operator|*
operator|)
name|context
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|be_lun
operator|->
name|queue_lock
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|io
operator|=
operator|(
expr|union
name|ctl_io
operator|*
operator|)
name|STAILQ_FIRST
argument_list|(
operator|&
name|be_lun
operator|->
name|cont_queue
argument_list|)
expr_stmt|;
if|if
condition|(
name|io
operator|!=
name|NULL
condition|)
block|{
name|STAILQ_REMOVE
argument_list|(
operator|&
name|be_lun
operator|->
name|cont_queue
argument_list|,
operator|&
name|io
operator|->
name|io_hdr
argument_list|,
name|ctl_io_hdr
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|be_lun
operator|->
name|queue_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ARGS
argument_list|(
name|io
argument_list|)
operator|->
name|flags
operator|&
name|CTL_LLF_COMPARE
condition|)
name|ctl_backend_ramdisk_compare
argument_list|(
name|io
argument_list|)
expr_stmt|;
else|else
name|ctl_backend_ramdisk_rw
argument_list|(
name|io
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|be_lun
operator|->
name|queue_lock
argument_list|)
expr_stmt|;
continue|continue;
block|}
comment|/* 		 * If we get here, there is no work left in the queues, so 		 * just break out and let the task queue go to sleep. 		 */
break|break;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|be_lun
operator|->
name|queue_lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ctl_backend_ramdisk_gls
parameter_list|(
name|union
name|ctl_io
modifier|*
name|io
parameter_list|)
block|{
name|struct
name|ctl_be_lun
modifier|*
name|cbe_lun
init|=
name|CTL_BACKEND_LUN
argument_list|(
name|io
argument_list|)
decl_stmt|;
name|struct
name|ctl_be_ramdisk_lun
modifier|*
name|be_lun
init|=
name|cbe_lun
operator|->
name|be_lun
decl_stmt|;
name|struct
name|scsi_get_lba_status_data
modifier|*
name|data
decl_stmt|;
name|uint8_t
modifier|*
name|page
decl_stmt|;
name|u_int
name|lbaoff
decl_stmt|;
name|data
operator|=
operator|(
expr|struct
name|scsi_get_lba_status_data
operator|*
operator|)
name|io
operator|->
name|scsiio
operator|.
name|kern_data_ptr
expr_stmt|;
name|scsi_u64to8b
argument_list|(
name|ARGS
argument_list|(
name|io
argument_list|)
operator|->
name|lba
argument_list|,
name|data
operator|->
name|descr
index|[
literal|0
index|]
operator|.
name|addr
argument_list|)
expr_stmt|;
name|lbaoff
operator|=
name|ARGS
argument_list|(
name|io
argument_list|)
operator|->
name|lba
operator|&
operator|~
operator|(
name|UINT_MAX
operator|<<
name|cbe_lun
operator|->
name|pblockexp
operator|)
expr_stmt|;
name|scsi_ulto4b
argument_list|(
name|be_lun
operator|->
name|pblockmul
operator|-
name|lbaoff
argument_list|,
name|data
operator|->
name|descr
index|[
literal|0
index|]
operator|.
name|length
argument_list|)
expr_stmt|;
name|page
operator|=
name|ctl_backend_ramdisk_getpage
argument_list|(
name|be_lun
argument_list|,
name|ARGS
argument_list|(
name|io
argument_list|)
operator|->
name|lba
operator|>>
name|cbe_lun
operator|->
name|pblockexp
argument_list|,
name|GP_OTHER
argument_list|)
expr_stmt|;
if|if
condition|(
name|page
operator|==
name|P_UNMAPPED
condition|)
name|data
operator|->
name|descr
index|[
literal|0
index|]
operator|.
name|status
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|page
operator|==
name|P_ANCHORED
condition|)
name|data
operator|->
name|descr
index|[
literal|0
index|]
operator|.
name|status
operator|=
literal|2
expr_stmt|;
else|else
name|data
operator|->
name|descr
index|[
literal|0
index|]
operator|.
name|status
operator|=
literal|0
expr_stmt|;
name|ctl_config_read_done
argument_list|(
name|io
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_RETVAL_COMPLETE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ctl_backend_ramdisk_config_read
parameter_list|(
name|union
name|ctl_io
modifier|*
name|io
parameter_list|)
block|{
name|int
name|retval
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|io
operator|->
name|scsiio
operator|.
name|cdb
index|[
literal|0
index|]
condition|)
block|{
case|case
name|SERVICE_ACTION_IN
case|:
if|if
condition|(
name|io
operator|->
name|scsiio
operator|.
name|cdb
index|[
literal|1
index|]
operator|==
name|SGLS_SERVICE_ACTION
condition|)
block|{
name|retval
operator|=
name|ctl_backend_ramdisk_gls
argument_list|(
name|io
argument_list|)
expr_stmt|;
break|break;
block|}
name|ctl_set_invalid_field
argument_list|(
operator|&
name|io
operator|->
name|scsiio
argument_list|,
comment|/*sks_valid*/
literal|1
argument_list|,
comment|/*command*/
literal|1
argument_list|,
comment|/*field*/
literal|1
argument_list|,
comment|/*bit_valid*/
literal|1
argument_list|,
comment|/*bit*/
literal|4
argument_list|)
expr_stmt|;
name|ctl_config_read_done
argument_list|(
name|io
argument_list|)
expr_stmt|;
name|retval
operator|=
name|CTL_RETVAL_COMPLETE
expr_stmt|;
break|break;
default|default:
name|ctl_set_invalid_opcode
argument_list|(
operator|&
name|io
operator|->
name|scsiio
argument_list|)
expr_stmt|;
name|ctl_config_read_done
argument_list|(
name|io
argument_list|)
expr_stmt|;
name|retval
operator|=
name|CTL_RETVAL_COMPLETE
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ctl_backend_ramdisk_delete
parameter_list|(
name|struct
name|ctl_be_lun
modifier|*
name|cbe_lun
parameter_list|,
name|off_t
name|lba
parameter_list|,
name|off_t
name|len
parameter_list|,
name|int
name|anchor
parameter_list|)
block|{
name|struct
name|ctl_be_ramdisk_lun
modifier|*
name|be_lun
init|=
name|cbe_lun
operator|->
name|be_lun
decl_stmt|;
name|uint8_t
modifier|*
name|page
decl_stmt|;
name|uint64_t
name|p
decl_stmt|,
name|lp
decl_stmt|;
name|u_int
name|lbaoff
decl_stmt|;
name|getpage_op_t
name|op
init|=
name|anchor
condition|?
name|GP_ANCHOR
else|:
name|GP_OTHER
decl_stmt|;
comment|/* Partially zero first partial page. */
name|p
operator|=
name|lba
operator|>>
name|cbe_lun
operator|->
name|pblockexp
expr_stmt|;
name|lbaoff
operator|=
name|lba
operator|&
operator|~
operator|(
name|UINT_MAX
operator|<<
name|cbe_lun
operator|->
name|pblockexp
operator|)
expr_stmt|;
if|if
condition|(
name|lbaoff
operator|!=
literal|0
condition|)
block|{
name|page
operator|=
name|ctl_backend_ramdisk_getpage
argument_list|(
name|be_lun
argument_list|,
name|p
argument_list|,
name|op
argument_list|)
expr_stmt|;
if|if
condition|(
name|page
operator|!=
name|P_UNMAPPED
operator|&&
name|page
operator|!=
name|P_ANCHORED
condition|)
block|{
name|memset
argument_list|(
name|page
operator|+
name|lbaoff
operator|*
name|cbe_lun
operator|->
name|blocksize
argument_list|,
literal|0
argument_list|,
name|min
argument_list|(
name|len
argument_list|,
name|be_lun
operator|->
name|pblockmul
operator|-
name|lbaoff
argument_list|)
operator|*
name|cbe_lun
operator|->
name|blocksize
argument_list|)
expr_stmt|;
block|}
name|p
operator|++
expr_stmt|;
block|}
comment|/* Partially zero last partial page. */
name|lp
operator|=
operator|(
name|lba
operator|+
name|len
operator|)
operator|>>
name|cbe_lun
operator|->
name|pblockexp
expr_stmt|;
name|lbaoff
operator|=
operator|(
name|lba
operator|+
name|len
operator|)
operator|&
operator|~
operator|(
name|UINT_MAX
operator|<<
name|cbe_lun
operator|->
name|pblockexp
operator|)
expr_stmt|;
if|if
condition|(
name|p
operator|<=
name|lp
operator|&&
name|lbaoff
operator|!=
literal|0
condition|)
block|{
name|page
operator|=
name|ctl_backend_ramdisk_getpage
argument_list|(
name|be_lun
argument_list|,
name|lp
argument_list|,
name|op
argument_list|)
expr_stmt|;
if|if
condition|(
name|page
operator|!=
name|P_UNMAPPED
operator|&&
name|page
operator|!=
name|P_ANCHORED
condition|)
name|memset
argument_list|(
name|page
argument_list|,
literal|0
argument_list|,
name|lbaoff
operator|*
name|cbe_lun
operator|->
name|blocksize
argument_list|)
expr_stmt|;
block|}
comment|/* Delete remaining full pages. */
if|if
condition|(
name|anchor
condition|)
block|{
for|for
control|(
init|;
name|p
operator|<
name|lp
condition|;
name|p
operator|++
control|)
name|ctl_backend_ramdisk_anchorpage
argument_list|(
name|be_lun
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
init|;
name|p
operator|<
name|lp
condition|;
name|p
operator|++
control|)
name|ctl_backend_ramdisk_unmappage
argument_list|(
name|be_lun
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ctl_backend_ramdisk_ws
parameter_list|(
name|union
name|ctl_io
modifier|*
name|io
parameter_list|)
block|{
name|struct
name|ctl_be_lun
modifier|*
name|cbe_lun
init|=
name|CTL_BACKEND_LUN
argument_list|(
name|io
argument_list|)
decl_stmt|;
name|struct
name|ctl_be_ramdisk_lun
modifier|*
name|be_lun
init|=
name|cbe_lun
operator|->
name|be_lun
decl_stmt|;
name|struct
name|ctl_lba_len_flags
modifier|*
name|lbalen
init|=
name|ARGS
argument_list|(
name|io
argument_list|)
decl_stmt|;
name|uint8_t
modifier|*
name|page
decl_stmt|;
name|uint64_t
name|lba
decl_stmt|;
name|u_int
name|lbaoff
decl_stmt|,
name|lbas
decl_stmt|;
if|if
condition|(
name|lbalen
operator|->
name|flags
operator|&
operator|~
operator|(
name|SWS_LBDATA
operator||
name|SWS_UNMAP
operator||
name|SWS_ANCHOR
operator||
name|SWS_NDOB
operator|)
condition|)
block|{
name|ctl_set_invalid_field
argument_list|(
operator|&
name|io
operator|->
name|scsiio
argument_list|,
comment|/*sks_valid*/
literal|1
argument_list|,
comment|/*command*/
literal|1
argument_list|,
comment|/*field*/
literal|1
argument_list|,
comment|/*bit_valid*/
literal|0
argument_list|,
comment|/*bit*/
literal|0
argument_list|)
expr_stmt|;
name|ctl_config_write_done
argument_list|(
name|io
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|lbalen
operator|->
name|flags
operator|&
name|SWS_UNMAP
condition|)
block|{
name|ctl_backend_ramdisk_delete
argument_list|(
name|cbe_lun
argument_list|,
name|lbalen
operator|->
name|lba
argument_list|,
name|lbalen
operator|->
name|len
argument_list|,
operator|(
name|lbalen
operator|->
name|flags
operator|&
name|SWS_ANCHOR
operator|)
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|ctl_set_success
argument_list|(
operator|&
name|io
operator|->
name|scsiio
argument_list|)
expr_stmt|;
name|ctl_config_write_done
argument_list|(
name|io
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|lba
operator|=
name|lbalen
operator|->
name|lba
operator|,
name|lbas
operator|=
name|lbalen
operator|->
name|len
init|;
name|lbas
operator|>
literal|0
condition|;
name|lba
operator|++
operator|,
name|lbas
operator|--
control|)
block|{
name|page
operator|=
name|ctl_backend_ramdisk_getpage
argument_list|(
name|be_lun
argument_list|,
name|lba
operator|>>
name|cbe_lun
operator|->
name|pblockexp
argument_list|,
name|GP_WRITE
argument_list|)
expr_stmt|;
if|if
condition|(
name|page
operator|==
name|P_UNMAPPED
operator|||
name|page
operator|==
name|P_ANCHORED
condition|)
block|{
name|ctl_set_space_alloc_fail
argument_list|(
operator|&
name|io
operator|->
name|scsiio
argument_list|)
expr_stmt|;
name|ctl_data_submit_done
argument_list|(
name|io
argument_list|)
expr_stmt|;
return|return;
block|}
name|lbaoff
operator|=
name|lba
operator|&
operator|~
operator|(
name|UINT_MAX
operator|<<
name|cbe_lun
operator|->
name|pblockexp
operator|)
expr_stmt|;
name|page
operator|+=
name|lbaoff
operator|*
name|cbe_lun
operator|->
name|blocksize
expr_stmt|;
if|if
condition|(
name|lbalen
operator|->
name|flags
operator|&
name|SWS_NDOB
condition|)
block|{
name|memset
argument_list|(
name|page
argument_list|,
literal|0
argument_list|,
name|cbe_lun
operator|->
name|blocksize
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|memcpy
argument_list|(
name|page
argument_list|,
name|io
operator|->
name|scsiio
operator|.
name|kern_data_ptr
argument_list|,
name|cbe_lun
operator|->
name|blocksize
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|lbalen
operator|->
name|flags
operator|&
name|SWS_LBDATA
condition|)
name|scsi_ulto4b
argument_list|(
name|lba
argument_list|,
name|page
argument_list|)
expr_stmt|;
block|}
name|ctl_set_success
argument_list|(
operator|&
name|io
operator|->
name|scsiio
argument_list|)
expr_stmt|;
name|ctl_config_write_done
argument_list|(
name|io
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ctl_backend_ramdisk_unmap
parameter_list|(
name|union
name|ctl_io
modifier|*
name|io
parameter_list|)
block|{
name|struct
name|ctl_be_lun
modifier|*
name|cbe_lun
init|=
name|CTL_BACKEND_LUN
argument_list|(
name|io
argument_list|)
decl_stmt|;
name|struct
name|ctl_ptr_len_flags
modifier|*
name|ptrlen
init|=
operator|(
expr|struct
name|ctl_ptr_len_flags
operator|*
operator|)
name|ARGS
argument_list|(
name|io
argument_list|)
decl_stmt|;
name|struct
name|scsi_unmap_desc
modifier|*
name|buf
decl_stmt|,
modifier|*
name|end
decl_stmt|;
if|if
condition|(
operator|(
name|ptrlen
operator|->
name|flags
operator|&
operator|~
name|SU_ANCHOR
operator|)
operator|!=
literal|0
condition|)
block|{
name|ctl_set_invalid_field
argument_list|(
operator|&
name|io
operator|->
name|scsiio
argument_list|,
comment|/*sks_valid*/
literal|0
argument_list|,
comment|/*command*/
literal|0
argument_list|,
comment|/*field*/
literal|0
argument_list|,
comment|/*bit_valid*/
literal|0
argument_list|,
comment|/*bit*/
literal|0
argument_list|)
expr_stmt|;
name|ctl_config_write_done
argument_list|(
name|io
argument_list|)
expr_stmt|;
return|return;
block|}
name|buf
operator|=
operator|(
expr|struct
name|scsi_unmap_desc
operator|*
operator|)
name|ptrlen
operator|->
name|ptr
expr_stmt|;
name|end
operator|=
name|buf
operator|+
name|ptrlen
operator|->
name|len
operator|/
sizeof|sizeof
argument_list|(
operator|*
name|buf
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|buf
operator|<
name|end
condition|;
name|buf
operator|++
control|)
block|{
name|ctl_backend_ramdisk_delete
argument_list|(
name|cbe_lun
argument_list|,
name|scsi_8btou64
argument_list|(
name|buf
operator|->
name|lba
argument_list|)
argument_list|,
name|scsi_4btoul
argument_list|(
name|buf
operator|->
name|length
argument_list|)
argument_list|,
operator|(
name|ptrlen
operator|->
name|flags
operator|&
name|SU_ANCHOR
operator|)
operator|!=
literal|0
argument_list|)
expr_stmt|;
block|}
name|ctl_set_success
argument_list|(
operator|&
name|io
operator|->
name|scsiio
argument_list|)
expr_stmt|;
name|ctl_config_write_done
argument_list|(
name|io
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ctl_backend_ramdisk_config_write
parameter_list|(
name|union
name|ctl_io
modifier|*
name|io
parameter_list|)
block|{
name|struct
name|ctl_be_lun
modifier|*
name|cbe_lun
init|=
name|CTL_BACKEND_LUN
argument_list|(
name|io
argument_list|)
decl_stmt|;
name|int
name|retval
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|io
operator|->
name|scsiio
operator|.
name|cdb
index|[
literal|0
index|]
condition|)
block|{
case|case
name|SYNCHRONIZE_CACHE
case|:
case|case
name|SYNCHRONIZE_CACHE_16
case|:
comment|/* We have no cache to flush. */
name|ctl_set_success
argument_list|(
operator|&
name|io
operator|->
name|scsiio
argument_list|)
expr_stmt|;
name|ctl_config_write_done
argument_list|(
name|io
argument_list|)
expr_stmt|;
break|break;
case|case
name|START_STOP_UNIT
case|:
block|{
name|struct
name|scsi_start_stop_unit
modifier|*
name|cdb
decl_stmt|;
name|cdb
operator|=
operator|(
expr|struct
name|scsi_start_stop_unit
operator|*
operator|)
name|io
operator|->
name|scsiio
operator|.
name|cdb
expr_stmt|;
if|if
condition|(
operator|(
name|cdb
operator|->
name|how
operator|&
name|SSS_PC_MASK
operator|)
operator|!=
literal|0
condition|)
block|{
name|ctl_set_success
argument_list|(
operator|&
name|io
operator|->
name|scsiio
argument_list|)
expr_stmt|;
name|ctl_config_write_done
argument_list|(
name|io
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|cdb
operator|->
name|how
operator|&
name|SSS_START
condition|)
block|{
if|if
condition|(
name|cdb
operator|->
name|how
operator|&
name|SSS_LOEJ
condition|)
name|ctl_lun_has_media
argument_list|(
name|cbe_lun
argument_list|)
expr_stmt|;
name|ctl_start_lun
argument_list|(
name|cbe_lun
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ctl_stop_lun
argument_list|(
name|cbe_lun
argument_list|)
expr_stmt|;
if|if
condition|(
name|cdb
operator|->
name|how
operator|&
name|SSS_LOEJ
condition|)
name|ctl_lun_ejected
argument_list|(
name|cbe_lun
argument_list|)
expr_stmt|;
block|}
name|ctl_set_success
argument_list|(
operator|&
name|io
operator|->
name|scsiio
argument_list|)
expr_stmt|;
name|ctl_config_write_done
argument_list|(
name|io
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|PREVENT_ALLOW
case|:
name|ctl_set_success
argument_list|(
operator|&
name|io
operator|->
name|scsiio
argument_list|)
expr_stmt|;
name|ctl_config_write_done
argument_list|(
name|io
argument_list|)
expr_stmt|;
break|break;
case|case
name|WRITE_SAME_10
case|:
case|case
name|WRITE_SAME_16
case|:
name|ctl_backend_ramdisk_ws
argument_list|(
name|io
argument_list|)
expr_stmt|;
break|break;
case|case
name|UNMAP
case|:
name|ctl_backend_ramdisk_unmap
argument_list|(
name|io
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ctl_set_invalid_opcode
argument_list|(
operator|&
name|io
operator|->
name|scsiio
argument_list|)
expr_stmt|;
name|ctl_config_write_done
argument_list|(
name|io
argument_list|)
expr_stmt|;
name|retval
operator|=
name|CTL_RETVAL_COMPLETE
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|ctl_backend_ramdisk_lun_attr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
specifier|const
name|char
modifier|*
name|attrname
parameter_list|)
block|{
name|struct
name|ctl_be_ramdisk_lun
modifier|*
name|be_lun
init|=
name|arg
decl_stmt|;
name|uint64_t
name|val
decl_stmt|;
name|val
operator|=
name|UINT64_MAX
expr_stmt|;
if|if
condition|(
name|be_lun
operator|->
name|cap_bytes
operator|==
literal|0
condition|)
return|return
operator|(
name|val
operator|)
return|;
name|sx_slock
argument_list|(
operator|&
name|be_lun
operator|->
name|page_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|attrname
argument_list|,
literal|"blocksused"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|val
operator|=
name|be_lun
operator|->
name|cap_used
operator|/
name|be_lun
operator|->
name|cbe_lun
operator|.
name|blocksize
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|attrname
argument_list|,
literal|"blocksavail"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|val
operator|=
operator|(
name|be_lun
operator|->
name|cap_bytes
operator|-
name|be_lun
operator|->
name|cap_used
operator|)
operator|/
name|be_lun
operator|->
name|cbe_lun
operator|.
name|blocksize
expr_stmt|;
block|}
name|sx_sunlock
argument_list|(
operator|&
name|be_lun
operator|->
name|page_lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|val
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ctl_backend_ramdisk_ioctl
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|addr
parameter_list|,
name|int
name|flag
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
name|struct
name|ctl_be_ramdisk_softc
modifier|*
name|softc
init|=
operator|&
name|rd_softc
decl_stmt|;
name|struct
name|ctl_lun_req
modifier|*
name|lun_req
decl_stmt|;
name|int
name|retval
decl_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|CTL_LUN_REQ
case|:
name|lun_req
operator|=
operator|(
expr|struct
name|ctl_lun_req
operator|*
operator|)
name|addr
expr_stmt|;
switch|switch
condition|(
name|lun_req
operator|->
name|reqtype
condition|)
block|{
case|case
name|CTL_LUNREQ_CREATE
case|:
name|retval
operator|=
name|ctl_backend_ramdisk_create
argument_list|(
name|softc
argument_list|,
name|lun_req
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTL_LUNREQ_RM
case|:
name|retval
operator|=
name|ctl_backend_ramdisk_rm
argument_list|(
name|softc
argument_list|,
name|lun_req
argument_list|)
expr_stmt|;
break|break;
case|case
name|CTL_LUNREQ_MODIFY
case|:
name|retval
operator|=
name|ctl_backend_ramdisk_modify
argument_list|(
name|softc
argument_list|,
name|lun_req
argument_list|)
expr_stmt|;
break|break;
default|default:
name|lun_req
operator|->
name|status
operator|=
name|CTL_LUN_ERROR
expr_stmt|;
name|snprintf
argument_list|(
name|lun_req
operator|->
name|error_str
argument_list|,
sizeof|sizeof
argument_list|(
name|lun_req
operator|->
name|error_str
argument_list|)
argument_list|,
literal|"%s: invalid LUN request type %d"
argument_list|,
name|__func__
argument_list|,
name|lun_req
operator|->
name|reqtype
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
default|default:
name|retval
operator|=
name|ENOTTY
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ctl_backend_ramdisk_rm
parameter_list|(
name|struct
name|ctl_be_ramdisk_softc
modifier|*
name|softc
parameter_list|,
name|struct
name|ctl_lun_req
modifier|*
name|req
parameter_list|)
block|{
name|struct
name|ctl_be_ramdisk_lun
modifier|*
name|be_lun
decl_stmt|;
name|struct
name|ctl_lun_rm_params
modifier|*
name|params
decl_stmt|;
name|int
name|retval
decl_stmt|;
name|params
operator|=
operator|&
name|req
operator|->
name|reqdata
operator|.
name|rm
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|STAILQ_FOREACH
argument_list|(
argument|be_lun
argument_list|,
argument|&softc->lun_list
argument_list|,
argument|links
argument_list|)
block|{
if|if
condition|(
name|be_lun
operator|->
name|cbe_lun
operator|.
name|lun_id
operator|==
name|params
operator|->
name|lun_id
condition|)
break|break;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|be_lun
operator|==
name|NULL
condition|)
block|{
name|snprintf
argument_list|(
name|req
operator|->
name|error_str
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|->
name|error_str
argument_list|)
argument_list|,
literal|"%s: LUN %u is not managed by the ramdisk backend"
argument_list|,
name|__func__
argument_list|,
name|params
operator|->
name|lun_id
argument_list|)
expr_stmt|;
goto|goto
name|bailout_error
goto|;
block|}
name|retval
operator|=
name|ctl_disable_lun
argument_list|(
operator|&
name|be_lun
operator|->
name|cbe_lun
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
literal|0
condition|)
block|{
name|snprintf
argument_list|(
name|req
operator|->
name|error_str
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|->
name|error_str
argument_list|)
argument_list|,
literal|"%s: error %d returned from ctl_disable_lun() for "
literal|"LUN %d"
argument_list|,
name|__func__
argument_list|,
name|retval
argument_list|,
name|params
operator|->
name|lun_id
argument_list|)
expr_stmt|;
goto|goto
name|bailout_error
goto|;
block|}
comment|/* 	 * Set the waiting flag before we invalidate the LUN.  Our shutdown 	 * routine can be called any time after we invalidate the LUN, 	 * and can be called from our context. 	 * 	 * This tells the shutdown routine that we're waiting, or we're 	 * going to wait for the shutdown to happen. 	 */
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|be_lun
operator|->
name|flags
operator||=
name|CTL_BE_RAMDISK_LUN_WAITING
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|retval
operator|=
name|ctl_invalidate_lun
argument_list|(
operator|&
name|be_lun
operator|->
name|cbe_lun
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
literal|0
condition|)
block|{
name|snprintf
argument_list|(
name|req
operator|->
name|error_str
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|->
name|error_str
argument_list|)
argument_list|,
literal|"%s: error %d returned from ctl_invalidate_lun() for "
literal|"LUN %d"
argument_list|,
name|__func__
argument_list|,
name|retval
argument_list|,
name|params
operator|->
name|lun_id
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|be_lun
operator|->
name|flags
operator|&=
operator|~
name|CTL_BE_RAMDISK_LUN_WAITING
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
goto|goto
name|bailout_error
goto|;
block|}
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|be_lun
operator|->
name|flags
operator|&
name|CTL_BE_RAMDISK_LUN_UNCONFIGURED
operator|)
operator|==
literal|0
condition|)
block|{
name|retval
operator|=
name|msleep
argument_list|(
name|be_lun
argument_list|,
operator|&
name|softc
operator|->
name|lock
argument_list|,
name|PCATCH
argument_list|,
literal|"ctlram"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|==
name|EINTR
condition|)
break|break;
block|}
name|be_lun
operator|->
name|flags
operator|&=
operator|~
name|CTL_BE_RAMDISK_LUN_WAITING
expr_stmt|;
comment|/* 	 * We only remove this LUN from the list and free it (below) if 	 * retval == 0.  If the user interrupted the wait, we just bail out 	 * without actually freeing the LUN.  We let the shutdown routine 	 * free the LUN if that happens. 	 */
if|if
condition|(
name|retval
operator|==
literal|0
condition|)
block|{
name|STAILQ_REMOVE
argument_list|(
operator|&
name|softc
operator|->
name|lun_list
argument_list|,
name|be_lun
argument_list|,
name|ctl_be_ramdisk_lun
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|softc
operator|->
name|num_luns
operator|--
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|==
literal|0
condition|)
block|{
name|taskqueue_drain_all
argument_list|(
name|be_lun
operator|->
name|io_taskqueue
argument_list|)
expr_stmt|;
name|taskqueue_free
argument_list|(
name|be_lun
operator|->
name|io_taskqueue
argument_list|)
expr_stmt|;
name|ctl_free_opts
argument_list|(
operator|&
name|be_lun
operator|->
name|cbe_lun
operator|.
name|options
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|be_lun
operator|->
name|zero_page
argument_list|,
name|M_RAMDISK
argument_list|)
expr_stmt|;
name|ctl_backend_ramdisk_freeallpages
argument_list|(
name|be_lun
operator|->
name|pages
argument_list|,
name|be_lun
operator|->
name|indir
argument_list|)
expr_stmt|;
name|sx_destroy
argument_list|(
operator|&
name|be_lun
operator|->
name|page_lock
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|be_lun
operator|->
name|queue_lock
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|be_lun
argument_list|,
name|M_RAMDISK
argument_list|)
expr_stmt|;
block|}
name|req
operator|->
name|status
operator|=
name|CTL_LUN_OK
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
name|bailout_error
label|:
name|req
operator|->
name|status
operator|=
name|CTL_LUN_ERROR
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ctl_backend_ramdisk_create
parameter_list|(
name|struct
name|ctl_be_ramdisk_softc
modifier|*
name|softc
parameter_list|,
name|struct
name|ctl_lun_req
modifier|*
name|req
parameter_list|)
block|{
name|struct
name|ctl_be_ramdisk_lun
modifier|*
name|be_lun
decl_stmt|;
name|struct
name|ctl_be_lun
modifier|*
name|cbe_lun
decl_stmt|;
name|struct
name|ctl_lun_create_params
modifier|*
name|params
decl_stmt|;
name|char
modifier|*
name|value
decl_stmt|;
name|char
name|tmpstr
index|[
literal|32
index|]
decl_stmt|;
name|uint64_t
name|t
decl_stmt|;
name|int
name|retval
decl_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
name|params
operator|=
operator|&
name|req
operator|->
name|reqdata
operator|.
name|create
expr_stmt|;
name|be_lun
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|be_lun
argument_list|)
argument_list|,
name|M_RAMDISK
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
expr_stmt|;
name|cbe_lun
operator|=
operator|&
name|be_lun
operator|->
name|cbe_lun
expr_stmt|;
name|cbe_lun
operator|->
name|be_lun
operator|=
name|be_lun
expr_stmt|;
name|be_lun
operator|->
name|params
operator|=
name|req
operator|->
name|reqdata
operator|.
name|create
expr_stmt|;
name|be_lun
operator|->
name|softc
operator|=
name|softc
expr_stmt|;
name|sprintf
argument_list|(
name|be_lun
operator|->
name|lunname
argument_list|,
literal|"cram%d"
argument_list|,
name|softc
operator|->
name|num_luns
argument_list|)
expr_stmt|;
name|ctl_init_opts
argument_list|(
operator|&
name|cbe_lun
operator|->
name|options
argument_list|,
name|req
operator|->
name|num_be_args
argument_list|,
name|req
operator|->
name|kern_be_args
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|flags
operator|&
name|CTL_LUN_FLAG_DEV_TYPE
condition|)
name|cbe_lun
operator|->
name|lun_type
operator|=
name|params
operator|->
name|device_type
expr_stmt|;
else|else
name|cbe_lun
operator|->
name|lun_type
operator|=
name|T_DIRECT
expr_stmt|;
name|be_lun
operator|->
name|flags
operator|=
name|CTL_BE_RAMDISK_LUN_UNCONFIGURED
expr_stmt|;
name|cbe_lun
operator|->
name|flags
operator|=
literal|0
expr_stmt|;
name|value
operator|=
name|ctl_get_opt
argument_list|(
operator|&
name|cbe_lun
operator|->
name|options
argument_list|,
literal|"ha_role"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|value
argument_list|,
literal|"primary"
argument_list|)
operator|==
literal|0
condition|)
name|cbe_lun
operator|->
name|flags
operator||=
name|CTL_LUN_FLAG_PRIMARY
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|control_softc
operator|->
name|flags
operator|&
name|CTL_FLAG_ACTIVE_SHELF
condition|)
name|cbe_lun
operator|->
name|flags
operator||=
name|CTL_LUN_FLAG_PRIMARY
expr_stmt|;
name|be_lun
operator|->
name|pblocksize
operator|=
name|PAGE_SIZE
expr_stmt|;
name|value
operator|=
name|ctl_get_opt
argument_list|(
operator|&
name|cbe_lun
operator|->
name|options
argument_list|,
literal|"pblocksize"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|!=
name|NULL
condition|)
block|{
name|ctl_expand_number
argument_list|(
name|value
argument_list|,
operator|&
name|t
argument_list|)
expr_stmt|;
name|be_lun
operator|->
name|pblocksize
operator|=
name|t
expr_stmt|;
block|}
if|if
condition|(
name|be_lun
operator|->
name|pblocksize
operator|<
literal|512
operator|||
name|be_lun
operator|->
name|pblocksize
operator|>
literal|131072
condition|)
block|{
name|snprintf
argument_list|(
name|req
operator|->
name|error_str
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|->
name|error_str
argument_list|)
argument_list|,
literal|"%s: unsupported pblocksize %u"
argument_list|,
name|__func__
argument_list|,
name|be_lun
operator|->
name|pblocksize
argument_list|)
expr_stmt|;
goto|goto
name|bailout_error
goto|;
block|}
if|if
condition|(
name|cbe_lun
operator|->
name|lun_type
operator|==
name|T_DIRECT
operator|||
name|cbe_lun
operator|->
name|lun_type
operator|==
name|T_CDROM
condition|)
block|{
if|if
condition|(
name|params
operator|->
name|blocksize_bytes
operator|!=
literal|0
condition|)
name|cbe_lun
operator|->
name|blocksize
operator|=
name|params
operator|->
name|blocksize_bytes
expr_stmt|;
elseif|else
if|if
condition|(
name|cbe_lun
operator|->
name|lun_type
operator|==
name|T_CDROM
condition|)
name|cbe_lun
operator|->
name|blocksize
operator|=
literal|2048
expr_stmt|;
else|else
name|cbe_lun
operator|->
name|blocksize
operator|=
literal|512
expr_stmt|;
name|be_lun
operator|->
name|pblockmul
operator|=
name|be_lun
operator|->
name|pblocksize
operator|/
name|cbe_lun
operator|->
name|blocksize
expr_stmt|;
if|if
condition|(
name|be_lun
operator|->
name|pblockmul
operator|<
literal|1
operator|||
operator|!
name|powerof2
argument_list|(
name|be_lun
operator|->
name|pblockmul
argument_list|)
condition|)
block|{
name|snprintf
argument_list|(
name|req
operator|->
name|error_str
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|->
name|error_str
argument_list|)
argument_list|,
literal|"%s: pblocksize %u not exp2 of blocksize %u"
argument_list|,
name|__func__
argument_list|,
name|be_lun
operator|->
name|pblocksize
argument_list|,
name|cbe_lun
operator|->
name|blocksize
argument_list|)
expr_stmt|;
goto|goto
name|bailout_error
goto|;
block|}
if|if
condition|(
name|params
operator|->
name|lun_size_bytes
operator|<
name|cbe_lun
operator|->
name|blocksize
condition|)
block|{
name|snprintf
argument_list|(
name|req
operator|->
name|error_str
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|->
name|error_str
argument_list|)
argument_list|,
literal|"%s: LUN size %ju< blocksize %u"
argument_list|,
name|__func__
argument_list|,
name|params
operator|->
name|lun_size_bytes
argument_list|,
name|cbe_lun
operator|->
name|blocksize
argument_list|)
expr_stmt|;
goto|goto
name|bailout_error
goto|;
block|}
name|be_lun
operator|->
name|size_blocks
operator|=
name|params
operator|->
name|lun_size_bytes
operator|/
name|cbe_lun
operator|->
name|blocksize
expr_stmt|;
name|be_lun
operator|->
name|size_bytes
operator|=
name|be_lun
operator|->
name|size_blocks
operator|*
name|cbe_lun
operator|->
name|blocksize
expr_stmt|;
name|be_lun
operator|->
name|indir
operator|=
literal|0
expr_stmt|;
name|t
operator|=
name|be_lun
operator|->
name|size_bytes
operator|/
name|be_lun
operator|->
name|pblocksize
expr_stmt|;
while|while
condition|(
name|t
operator|>
literal|1
condition|)
block|{
name|t
operator|/=
name|PPP
expr_stmt|;
name|be_lun
operator|->
name|indir
operator|++
expr_stmt|;
block|}
name|cbe_lun
operator|->
name|maxlba
operator|=
name|be_lun
operator|->
name|size_blocks
operator|-
literal|1
expr_stmt|;
name|cbe_lun
operator|->
name|pblockexp
operator|=
name|fls
argument_list|(
name|be_lun
operator|->
name|pblockmul
argument_list|)
operator|-
literal|1
expr_stmt|;
name|cbe_lun
operator|->
name|pblockoff
operator|=
literal|0
expr_stmt|;
name|cbe_lun
operator|->
name|ublockexp
operator|=
name|cbe_lun
operator|->
name|pblockexp
expr_stmt|;
name|cbe_lun
operator|->
name|ublockoff
operator|=
literal|0
expr_stmt|;
name|cbe_lun
operator|->
name|atomicblock
operator|=
name|be_lun
operator|->
name|pblocksize
expr_stmt|;
name|cbe_lun
operator|->
name|opttxferlen
operator|=
name|SGPP
operator|*
name|be_lun
operator|->
name|pblocksize
expr_stmt|;
name|value
operator|=
name|ctl_get_opt
argument_list|(
operator|&
name|cbe_lun
operator|->
name|options
argument_list|,
literal|"capacity"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|!=
name|NULL
condition|)
name|ctl_expand_number
argument_list|(
name|value
argument_list|,
operator|&
name|be_lun
operator|->
name|cap_bytes
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|be_lun
operator|->
name|pblockmul
operator|=
literal|1
expr_stmt|;
name|cbe_lun
operator|->
name|pblockexp
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Tell the user the blocksize we ended up using */
name|params
operator|->
name|blocksize_bytes
operator|=
name|cbe_lun
operator|->
name|blocksize
expr_stmt|;
name|params
operator|->
name|lun_size_bytes
operator|=
name|be_lun
operator|->
name|size_bytes
expr_stmt|;
name|value
operator|=
name|ctl_get_opt
argument_list|(
operator|&
name|cbe_lun
operator|->
name|options
argument_list|,
literal|"unmap"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
operator|||
name|strcmp
argument_list|(
name|value
argument_list|,
literal|"off"
argument_list|)
operator|!=
literal|0
condition|)
name|cbe_lun
operator|->
name|flags
operator||=
name|CTL_LUN_FLAG_UNMAP
expr_stmt|;
name|value
operator|=
name|ctl_get_opt
argument_list|(
operator|&
name|cbe_lun
operator|->
name|options
argument_list|,
literal|"readonly"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|value
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|cbe_lun
operator|->
name|flags
operator||=
name|CTL_LUN_FLAG_READONLY
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cbe_lun
operator|->
name|lun_type
operator|!=
name|T_DIRECT
condition|)
name|cbe_lun
operator|->
name|flags
operator||=
name|CTL_LUN_FLAG_READONLY
expr_stmt|;
name|cbe_lun
operator|->
name|serseq
operator|=
name|CTL_LUN_SERSEQ_OFF
expr_stmt|;
name|value
operator|=
name|ctl_get_opt
argument_list|(
operator|&
name|cbe_lun
operator|->
name|options
argument_list|,
literal|"serseq"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|value
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|cbe_lun
operator|->
name|serseq
operator|=
name|CTL_LUN_SERSEQ_ON
expr_stmt|;
elseif|else
if|if
condition|(
name|value
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|value
argument_list|,
literal|"read"
argument_list|)
operator|==
literal|0
condition|)
name|cbe_lun
operator|->
name|serseq
operator|=
name|CTL_LUN_SERSEQ_READ
expr_stmt|;
elseif|else
if|if
condition|(
name|value
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|value
argument_list|,
literal|"off"
argument_list|)
operator|==
literal|0
condition|)
name|cbe_lun
operator|->
name|serseq
operator|=
name|CTL_LUN_SERSEQ_OFF
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|flags
operator|&
name|CTL_LUN_FLAG_ID_REQ
condition|)
block|{
name|cbe_lun
operator|->
name|req_lun_id
operator|=
name|params
operator|->
name|req_lun_id
expr_stmt|;
name|cbe_lun
operator|->
name|flags
operator||=
name|CTL_LUN_FLAG_ID_REQ
expr_stmt|;
block|}
else|else
name|cbe_lun
operator|->
name|req_lun_id
operator|=
literal|0
expr_stmt|;
name|cbe_lun
operator|->
name|lun_shutdown
operator|=
name|ctl_backend_ramdisk_lun_shutdown
expr_stmt|;
name|cbe_lun
operator|->
name|lun_config_status
operator|=
name|ctl_backend_ramdisk_lun_config_status
expr_stmt|;
name|cbe_lun
operator|->
name|be
operator|=
operator|&
name|ctl_be_ramdisk_driver
expr_stmt|;
if|if
condition|(
operator|(
name|params
operator|->
name|flags
operator|&
name|CTL_LUN_FLAG_SERIAL_NUM
operator|)
operator|==
literal|0
condition|)
block|{
name|snprintf
argument_list|(
name|tmpstr
argument_list|,
sizeof|sizeof
argument_list|(
name|tmpstr
argument_list|)
argument_list|,
literal|"MYSERIAL%4d"
argument_list|,
name|softc
operator|->
name|num_luns
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|cbe_lun
operator|->
name|serial_num
argument_list|,
name|tmpstr
argument_list|,
name|MIN
argument_list|(
sizeof|sizeof
argument_list|(
name|cbe_lun
operator|->
name|serial_num
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|tmpstr
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Tell the user what we used for a serial number */
name|strncpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|params
operator|->
name|serial_num
argument_list|,
name|tmpstr
argument_list|,
name|MIN
argument_list|(
sizeof|sizeof
argument_list|(
name|params
operator|->
name|serial_num
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|tmpstr
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strncpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|cbe_lun
operator|->
name|serial_num
argument_list|,
name|params
operator|->
name|serial_num
argument_list|,
name|MIN
argument_list|(
sizeof|sizeof
argument_list|(
name|cbe_lun
operator|->
name|serial_num
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|params
operator|->
name|serial_num
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|params
operator|->
name|flags
operator|&
name|CTL_LUN_FLAG_DEVID
operator|)
operator|==
literal|0
condition|)
block|{
name|snprintf
argument_list|(
name|tmpstr
argument_list|,
sizeof|sizeof
argument_list|(
name|tmpstr
argument_list|)
argument_list|,
literal|"MYDEVID%4d"
argument_list|,
name|softc
operator|->
name|num_luns
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|cbe_lun
operator|->
name|device_id
argument_list|,
name|tmpstr
argument_list|,
name|MIN
argument_list|(
sizeof|sizeof
argument_list|(
name|cbe_lun
operator|->
name|device_id
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|tmpstr
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Tell the user what we used for a device ID */
name|strncpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|params
operator|->
name|device_id
argument_list|,
name|tmpstr
argument_list|,
name|MIN
argument_list|(
sizeof|sizeof
argument_list|(
name|params
operator|->
name|device_id
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|tmpstr
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|strncpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|cbe_lun
operator|->
name|device_id
argument_list|,
name|params
operator|->
name|device_id
argument_list|,
name|MIN
argument_list|(
sizeof|sizeof
argument_list|(
name|cbe_lun
operator|->
name|device_id
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|params
operator|->
name|device_id
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|STAILQ_INIT
argument_list|(
operator|&
name|be_lun
operator|->
name|cont_queue
argument_list|)
expr_stmt|;
name|sx_init
argument_list|(
operator|&
name|be_lun
operator|->
name|page_lock
argument_list|,
literal|"cram page lock"
argument_list|)
expr_stmt|;
if|if
condition|(
name|be_lun
operator|->
name|cap_bytes
operator|==
literal|0
condition|)
block|{
name|be_lun
operator|->
name|indir
operator|=
literal|0
expr_stmt|;
name|be_lun
operator|->
name|pages
operator|=
name|malloc
argument_list|(
name|be_lun
operator|->
name|pblocksize
argument_list|,
name|M_RAMDISK
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
block|}
name|be_lun
operator|->
name|zero_page
operator|=
name|malloc
argument_list|(
name|be_lun
operator|->
name|pblocksize
argument_list|,
name|M_RAMDISK
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|be_lun
operator|->
name|queue_lock
argument_list|,
literal|"cram queue lock"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|TASK_INIT
argument_list|(
operator|&
name|be_lun
operator|->
name|io_task
argument_list|,
comment|/*priority*/
literal|0
argument_list|,
name|ctl_backend_ramdisk_worker
argument_list|,
name|be_lun
argument_list|)
expr_stmt|;
name|be_lun
operator|->
name|io_taskqueue
operator|=
name|taskqueue_create
argument_list|(
name|be_lun
operator|->
name|lunname
argument_list|,
name|M_WAITOK
argument_list|,
name|taskqueue_thread_enqueue
argument_list|,
comment|/*context*/
operator|&
name|be_lun
operator|->
name|io_taskqueue
argument_list|)
expr_stmt|;
if|if
condition|(
name|be_lun
operator|->
name|io_taskqueue
operator|==
name|NULL
condition|)
block|{
name|snprintf
argument_list|(
name|req
operator|->
name|error_str
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|->
name|error_str
argument_list|)
argument_list|,
literal|"%s: Unable to create taskqueue"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
goto|goto
name|bailout_error
goto|;
block|}
name|retval
operator|=
name|taskqueue_start_threads
argument_list|(
operator|&
name|be_lun
operator|->
name|io_taskqueue
argument_list|,
comment|/*num threads*/
literal|1
argument_list|,
comment|/*priority*/
name|PWAIT
argument_list|,
comment|/*thread name*/
literal|"%s taskq"
argument_list|,
name|be_lun
operator|->
name|lunname
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
literal|0
condition|)
goto|goto
name|bailout_error
goto|;
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|softc
operator|->
name|num_luns
operator|++
expr_stmt|;
name|STAILQ_INSERT_TAIL
argument_list|(
operator|&
name|softc
operator|->
name|lun_list
argument_list|,
name|be_lun
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|retval
operator|=
name|ctl_add_lun
argument_list|(
operator|&
name|be_lun
operator|->
name|cbe_lun
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|!=
literal|0
condition|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|STAILQ_REMOVE
argument_list|(
operator|&
name|softc
operator|->
name|lun_list
argument_list|,
name|be_lun
argument_list|,
name|ctl_be_ramdisk_lun
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|softc
operator|->
name|num_luns
operator|--
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|req
operator|->
name|error_str
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|->
name|error_str
argument_list|)
argument_list|,
literal|"%s: ctl_add_lun() returned error %d, see dmesg for "
literal|"details"
argument_list|,
name|__func__
argument_list|,
name|retval
argument_list|)
expr_stmt|;
name|retval
operator|=
literal|0
expr_stmt|;
goto|goto
name|bailout_error
goto|;
block|}
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* 	 * Tell the config_status routine that we're waiting so it won't 	 * clean up the LUN in the event of an error. 	 */
name|be_lun
operator|->
name|flags
operator||=
name|CTL_BE_RAMDISK_LUN_WAITING
expr_stmt|;
while|while
condition|(
name|be_lun
operator|->
name|flags
operator|&
name|CTL_BE_RAMDISK_LUN_UNCONFIGURED
condition|)
block|{
name|retval
operator|=
name|msleep
argument_list|(
name|be_lun
argument_list|,
operator|&
name|softc
operator|->
name|lock
argument_list|,
name|PCATCH
argument_list|,
literal|"ctlram"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|retval
operator|==
name|EINTR
condition|)
break|break;
block|}
name|be_lun
operator|->
name|flags
operator|&=
operator|~
name|CTL_BE_RAMDISK_LUN_WAITING
expr_stmt|;
if|if
condition|(
name|be_lun
operator|->
name|flags
operator|&
name|CTL_BE_RAMDISK_LUN_CONFIG_ERR
condition|)
block|{
name|snprintf
argument_list|(
name|req
operator|->
name|error_str
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|->
name|error_str
argument_list|)
argument_list|,
literal|"%s: LUN configuration error, see dmesg for details"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|STAILQ_REMOVE
argument_list|(
operator|&
name|softc
operator|->
name|lun_list
argument_list|,
name|be_lun
argument_list|,
name|ctl_be_ramdisk_lun
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|softc
operator|->
name|num_luns
operator|--
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
goto|goto
name|bailout_error
goto|;
block|}
else|else
block|{
name|params
operator|->
name|req_lun_id
operator|=
name|cbe_lun
operator|->
name|lun_id
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|req
operator|->
name|status
operator|=
name|CTL_LUN_OK
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
name|bailout_error
label|:
name|req
operator|->
name|status
operator|=
name|CTL_LUN_ERROR
expr_stmt|;
if|if
condition|(
name|be_lun
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|be_lun
operator|->
name|io_taskqueue
operator|!=
name|NULL
condition|)
name|taskqueue_free
argument_list|(
name|be_lun
operator|->
name|io_taskqueue
argument_list|)
expr_stmt|;
name|ctl_free_opts
argument_list|(
operator|&
name|cbe_lun
operator|->
name|options
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|be_lun
operator|->
name|zero_page
argument_list|,
name|M_RAMDISK
argument_list|)
expr_stmt|;
name|ctl_backend_ramdisk_freeallpages
argument_list|(
name|be_lun
operator|->
name|pages
argument_list|,
name|be_lun
operator|->
name|indir
argument_list|)
expr_stmt|;
name|sx_destroy
argument_list|(
operator|&
name|be_lun
operator|->
name|page_lock
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|be_lun
operator|->
name|queue_lock
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|be_lun
argument_list|,
name|M_RAMDISK
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ctl_backend_ramdisk_modify
parameter_list|(
name|struct
name|ctl_be_ramdisk_softc
modifier|*
name|softc
parameter_list|,
name|struct
name|ctl_lun_req
modifier|*
name|req
parameter_list|)
block|{
name|struct
name|ctl_be_ramdisk_lun
modifier|*
name|be_lun
decl_stmt|;
name|struct
name|ctl_be_lun
modifier|*
name|cbe_lun
decl_stmt|;
name|struct
name|ctl_lun_modify_params
modifier|*
name|params
decl_stmt|;
name|char
modifier|*
name|value
decl_stmt|;
name|uint32_t
name|blocksize
decl_stmt|;
name|int
name|wasprim
decl_stmt|;
name|params
operator|=
operator|&
name|req
operator|->
name|reqdata
operator|.
name|modify
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|STAILQ_FOREACH
argument_list|(
argument|be_lun
argument_list|,
argument|&softc->lun_list
argument_list|,
argument|links
argument_list|)
block|{
if|if
condition|(
name|be_lun
operator|->
name|cbe_lun
operator|.
name|lun_id
operator|==
name|params
operator|->
name|lun_id
condition|)
break|break;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|be_lun
operator|==
name|NULL
condition|)
block|{
name|snprintf
argument_list|(
name|req
operator|->
name|error_str
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|->
name|error_str
argument_list|)
argument_list|,
literal|"%s: LUN %u is not managed by the ramdisk backend"
argument_list|,
name|__func__
argument_list|,
name|params
operator|->
name|lun_id
argument_list|)
expr_stmt|;
goto|goto
name|bailout_error
goto|;
block|}
name|cbe_lun
operator|=
operator|&
name|be_lun
operator|->
name|cbe_lun
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|lun_size_bytes
operator|!=
literal|0
condition|)
name|be_lun
operator|->
name|params
operator|.
name|lun_size_bytes
operator|=
name|params
operator|->
name|lun_size_bytes
expr_stmt|;
name|ctl_update_opts
argument_list|(
operator|&
name|cbe_lun
operator|->
name|options
argument_list|,
name|req
operator|->
name|num_be_args
argument_list|,
name|req
operator|->
name|kern_be_args
argument_list|)
expr_stmt|;
name|wasprim
operator|=
operator|(
name|cbe_lun
operator|->
name|flags
operator|&
name|CTL_LUN_FLAG_PRIMARY
operator|)
expr_stmt|;
name|value
operator|=
name|ctl_get_opt
argument_list|(
operator|&
name|cbe_lun
operator|->
name|options
argument_list|,
literal|"ha_role"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|value
argument_list|,
literal|"primary"
argument_list|)
operator|==
literal|0
condition|)
name|cbe_lun
operator|->
name|flags
operator||=
name|CTL_LUN_FLAG_PRIMARY
expr_stmt|;
else|else
name|cbe_lun
operator|->
name|flags
operator|&=
operator|~
name|CTL_LUN_FLAG_PRIMARY
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|control_softc
operator|->
name|flags
operator|&
name|CTL_FLAG_ACTIVE_SHELF
condition|)
name|cbe_lun
operator|->
name|flags
operator||=
name|CTL_LUN_FLAG_PRIMARY
expr_stmt|;
else|else
name|cbe_lun
operator|->
name|flags
operator|&=
operator|~
name|CTL_LUN_FLAG_PRIMARY
expr_stmt|;
if|if
condition|(
name|wasprim
operator|!=
operator|(
name|cbe_lun
operator|->
name|flags
operator|&
name|CTL_LUN_FLAG_PRIMARY
operator|)
condition|)
block|{
if|if
condition|(
name|cbe_lun
operator|->
name|flags
operator|&
name|CTL_LUN_FLAG_PRIMARY
condition|)
name|ctl_lun_primary
argument_list|(
name|cbe_lun
argument_list|)
expr_stmt|;
else|else
name|ctl_lun_secondary
argument_list|(
name|cbe_lun
argument_list|)
expr_stmt|;
block|}
name|blocksize
operator|=
name|be_lun
operator|->
name|cbe_lun
operator|.
name|blocksize
expr_stmt|;
if|if
condition|(
name|be_lun
operator|->
name|params
operator|.
name|lun_size_bytes
operator|<
name|blocksize
condition|)
block|{
name|snprintf
argument_list|(
name|req
operator|->
name|error_str
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|->
name|error_str
argument_list|)
argument_list|,
literal|"%s: LUN size %ju< blocksize %u"
argument_list|,
name|__func__
argument_list|,
name|be_lun
operator|->
name|params
operator|.
name|lun_size_bytes
argument_list|,
name|blocksize
argument_list|)
expr_stmt|;
goto|goto
name|bailout_error
goto|;
block|}
name|be_lun
operator|->
name|size_blocks
operator|=
name|be_lun
operator|->
name|params
operator|.
name|lun_size_bytes
operator|/
name|blocksize
expr_stmt|;
name|be_lun
operator|->
name|size_bytes
operator|=
name|be_lun
operator|->
name|size_blocks
operator|*
name|blocksize
expr_stmt|;
name|be_lun
operator|->
name|cbe_lun
operator|.
name|maxlba
operator|=
name|be_lun
operator|->
name|size_blocks
operator|-
literal|1
expr_stmt|;
name|ctl_lun_capacity_changed
argument_list|(
operator|&
name|be_lun
operator|->
name|cbe_lun
argument_list|)
expr_stmt|;
comment|/* Tell the user the exact size we ended up using */
name|params
operator|->
name|lun_size_bytes
operator|=
name|be_lun
operator|->
name|size_bytes
expr_stmt|;
name|req
operator|->
name|status
operator|=
name|CTL_LUN_OK
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|bailout_error
label|:
name|req
operator|->
name|status
operator|=
name|CTL_LUN_ERROR
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ctl_backend_ramdisk_lun_shutdown
parameter_list|(
name|void
modifier|*
name|be_lun
parameter_list|)
block|{
name|struct
name|ctl_be_ramdisk_lun
modifier|*
name|lun
init|=
name|be_lun
decl_stmt|;
name|struct
name|ctl_be_ramdisk_softc
modifier|*
name|softc
init|=
name|lun
operator|->
name|softc
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|lun
operator|->
name|flags
operator||=
name|CTL_BE_RAMDISK_LUN_UNCONFIGURED
expr_stmt|;
if|if
condition|(
name|lun
operator|->
name|flags
operator|&
name|CTL_BE_RAMDISK_LUN_WAITING
condition|)
block|{
name|wakeup
argument_list|(
name|lun
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|STAILQ_REMOVE
argument_list|(
operator|&
name|softc
operator|->
name|lun_list
argument_list|,
name|lun
argument_list|,
name|ctl_be_ramdisk_lun
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|softc
operator|->
name|num_luns
operator|--
expr_stmt|;
name|free
argument_list|(
name|be_lun
argument_list|,
name|M_RAMDISK
argument_list|)
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ctl_backend_ramdisk_lun_config_status
parameter_list|(
name|void
modifier|*
name|be_lun
parameter_list|,
name|ctl_lun_config_status
name|status
parameter_list|)
block|{
name|struct
name|ctl_be_ramdisk_lun
modifier|*
name|lun
decl_stmt|;
name|struct
name|ctl_be_ramdisk_softc
modifier|*
name|softc
decl_stmt|;
name|lun
operator|=
operator|(
expr|struct
name|ctl_be_ramdisk_lun
operator|*
operator|)
name|be_lun
expr_stmt|;
name|softc
operator|=
name|lun
operator|->
name|softc
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|CTL_LUN_CONFIG_OK
condition|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|lun
operator|->
name|flags
operator|&=
operator|~
name|CTL_BE_RAMDISK_LUN_UNCONFIGURED
expr_stmt|;
if|if
condition|(
name|lun
operator|->
name|flags
operator|&
name|CTL_BE_RAMDISK_LUN_WAITING
condition|)
name|wakeup
argument_list|(
name|lun
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* 		 * We successfully added the LUN, attempt to enable it. 		 */
if|if
condition|(
name|ctl_enable_lun
argument_list|(
operator|&
name|lun
operator|->
name|cbe_lun
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: ctl_enable_lun() failed!\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctl_invalidate_lun
argument_list|(
operator|&
name|lun
operator|->
name|cbe_lun
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: ctl_invalidate_lun() failed!\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
name|mtx_lock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
name|lun
operator|->
name|flags
operator|&=
operator|~
name|CTL_BE_RAMDISK_LUN_UNCONFIGURED
expr_stmt|;
comment|/* 	 * If we have a user waiting, let him handle the cleanup.  If not, 	 * clean things up here. 	 */
if|if
condition|(
name|lun
operator|->
name|flags
operator|&
name|CTL_BE_RAMDISK_LUN_WAITING
condition|)
block|{
name|lun
operator|->
name|flags
operator||=
name|CTL_BE_RAMDISK_LUN_CONFIG_ERR
expr_stmt|;
name|wakeup
argument_list|(
name|lun
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|STAILQ_REMOVE
argument_list|(
operator|&
name|softc
operator|->
name|lun_list
argument_list|,
name|lun
argument_list|,
name|ctl_be_ramdisk_lun
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|softc
operator|->
name|num_luns
operator|--
expr_stmt|;
name|free
argument_list|(
name|lun
argument_list|,
name|M_RAMDISK
argument_list|)
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|softc
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


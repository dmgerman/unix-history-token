begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2014 Alexander Motin<mav@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer,  *    without modification, immediately at the beginning of the file.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/condvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<machine/atomic.h>
end_include

begin_include
include|#
directive|include
file|<cam/cam.h>
end_include

begin_include
include|#
directive|include
file|<cam/scsi/scsi_all.h>
end_include

begin_include
include|#
directive|include
file|<cam/scsi/scsi_da.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_io.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_frontend.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_frontend_internal.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_util.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_backend.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_ha.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_private.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_debug.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_scsi_all.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_tpc.h>
end_include

begin_include
include|#
directive|include
file|<cam/ctl/ctl_error.h>
end_include

begin_define
define|#
directive|define
name|TPC_MAX_CSCDS
value|64
end_define

begin_define
define|#
directive|define
name|TPC_MAX_SEGS
value|64
end_define

begin_define
define|#
directive|define
name|TPC_MAX_SEG
value|0
end_define

begin_define
define|#
directive|define
name|TPC_MAX_LIST
value|8192
end_define

begin_define
define|#
directive|define
name|TPC_MAX_INLINE
value|0
end_define

begin_define
define|#
directive|define
name|TPC_MAX_LISTS
value|255
end_define

begin_define
define|#
directive|define
name|TPC_MAX_IO_SIZE
value|(1024 * 1024)
end_define

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_CTL_TPC
argument_list|,
literal|"ctltpc"
argument_list|,
literal|"CTL TPC"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_typedef
typedef|typedef
enum|enum
block|{
name|TPC_ERR_RETRY
init|=
literal|0x000
block|,
name|TPC_ERR_FAIL
init|=
literal|0x001
block|,
name|TPC_ERR_MASK
init|=
literal|0x0ff
block|,
name|TPC_ERR_NO_DECREMENT
init|=
literal|0x100
block|}
name|tpc_error_action
typedef|;
end_typedef

begin_struct_decl
struct_decl|struct
name|tpc_list
struct_decl|;
end_struct_decl

begin_expr_stmt
name|TAILQ_HEAD
argument_list|(
name|runl
argument_list|,
name|tpc_io
argument_list|)
expr_stmt|;
end_expr_stmt

begin_struct
struct|struct
name|tpc_io
block|{
name|union
name|ctl_io
modifier|*
name|io
decl_stmt|;
name|uint64_t
name|lun
decl_stmt|;
name|struct
name|tpc_list
modifier|*
name|list
decl_stmt|;
name|struct
name|runl
name|run
decl_stmt|;
name|TAILQ_ENTRY
argument_list|(
argument|tpc_io
argument_list|)
name|rlinks
expr_stmt|;
name|TAILQ_ENTRY
argument_list|(
argument|tpc_io
argument_list|)
name|links
expr_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|tpc_list
block|{
name|uint8_t
name|service_action
decl_stmt|;
name|int
name|init_port
decl_stmt|;
name|uint32_t
name|init_idx
decl_stmt|;
name|uint32_t
name|list_id
decl_stmt|;
name|uint8_t
name|flags
decl_stmt|;
name|uint8_t
modifier|*
name|params
decl_stmt|;
name|struct
name|scsi_ec_cscd
modifier|*
name|cscd
decl_stmt|;
name|struct
name|scsi_ec_segment
modifier|*
name|seg
index|[
name|TPC_MAX_SEGS
index|]
decl_stmt|;
name|uint8_t
modifier|*
name|inl
decl_stmt|;
name|int
name|ncscd
decl_stmt|;
name|int
name|nseg
decl_stmt|;
name|int
name|leninl
decl_stmt|;
name|int
name|curseg
decl_stmt|;
name|off_t
name|curbytes
decl_stmt|;
name|int
name|curops
decl_stmt|;
name|int
name|stage
decl_stmt|;
name|uint8_t
modifier|*
name|buf
decl_stmt|;
name|int
name|segbytes
decl_stmt|;
name|int
name|tbdio
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|abort
decl_stmt|;
name|int
name|completed
decl_stmt|;
name|TAILQ_HEAD
argument_list|(
argument_list|,
argument|tpc_io
argument_list|)
name|allio
expr_stmt|;
name|struct
name|scsi_sense_data
name|sense_data
decl_stmt|;
name|uint8_t
name|sense_len
decl_stmt|;
name|uint8_t
name|scsi_status
decl_stmt|;
name|struct
name|ctl_scsiio
modifier|*
name|ctsio
decl_stmt|;
name|struct
name|ctl_lun
modifier|*
name|lun
decl_stmt|;
name|TAILQ_ENTRY
argument_list|(
argument|tpc_list
argument_list|)
name|links
expr_stmt|;
block|}
struct|;
end_struct

begin_function
name|void
name|ctl_tpc_init
parameter_list|(
name|struct
name|ctl_lun
modifier|*
name|lun
parameter_list|)
block|{
name|TAILQ_INIT
argument_list|(
operator|&
name|lun
operator|->
name|tpc_lists
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ctl_tpc_shutdown
parameter_list|(
name|struct
name|ctl_lun
modifier|*
name|lun
parameter_list|)
block|{
name|struct
name|tpc_list
modifier|*
name|list
decl_stmt|;
while|while
condition|(
operator|(
name|list
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|lun
operator|->
name|tpc_lists
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|lun
operator|->
name|tpc_lists
argument_list|,
name|list
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|list
operator|->
name|completed
argument_list|,
operator|(
literal|"Not completed TPC (%p) on shutdown"
operator|,
name|list
operator|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|list
argument_list|,
name|M_CTL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|ctl_inquiry_evpd_tpc
parameter_list|(
name|struct
name|ctl_scsiio
modifier|*
name|ctsio
parameter_list|,
name|int
name|alloc_len
parameter_list|)
block|{
name|struct
name|scsi_vpd_tpc
modifier|*
name|tpc_ptr
decl_stmt|;
name|struct
name|scsi_vpd_tpc_descriptor
modifier|*
name|d_ptr
decl_stmt|;
name|struct
name|scsi_vpd_tpc_descriptor_sc
modifier|*
name|sc_ptr
decl_stmt|;
name|struct
name|scsi_vpd_tpc_descriptor_sc_descr
modifier|*
name|scd_ptr
decl_stmt|;
name|struct
name|scsi_vpd_tpc_descriptor_pd
modifier|*
name|pd_ptr
decl_stmt|;
name|struct
name|scsi_vpd_tpc_descriptor_sd
modifier|*
name|sd_ptr
decl_stmt|;
name|struct
name|scsi_vpd_tpc_descriptor_sdid
modifier|*
name|sdid_ptr
decl_stmt|;
name|struct
name|scsi_vpd_tpc_descriptor_gco
modifier|*
name|gco_ptr
decl_stmt|;
name|struct
name|ctl_lun
modifier|*
name|lun
decl_stmt|;
name|int
name|data_len
decl_stmt|;
name|lun
operator|=
operator|(
expr|struct
name|ctl_lun
operator|*
operator|)
name|ctsio
operator|->
name|io_hdr
operator|.
name|ctl_private
index|[
name|CTL_PRIV_LUN
index|]
operator|.
name|ptr
expr_stmt|;
name|data_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_vpd_tpc
argument_list|)
operator|+
name|roundup2
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_vpd_tpc_descriptor_sc
argument_list|)
operator|+
literal|2
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_vpd_tpc_descriptor_sc_descr
argument_list|)
operator|+
literal|7
argument_list|,
literal|4
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_vpd_tpc_descriptor_pd
argument_list|)
operator|+
name|roundup2
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_vpd_tpc_descriptor_sd
argument_list|)
operator|+
literal|4
argument_list|,
literal|4
argument_list|)
operator|+
name|roundup2
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_vpd_tpc_descriptor_sdid
argument_list|)
operator|+
literal|2
argument_list|,
literal|4
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_vpd_tpc_descriptor_gco
argument_list|)
expr_stmt|;
name|ctsio
operator|->
name|kern_data_ptr
operator|=
name|malloc
argument_list|(
name|data_len
argument_list|,
name|M_CTL
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|tpc_ptr
operator|=
operator|(
expr|struct
name|scsi_vpd_tpc
operator|*
operator|)
name|ctsio
operator|->
name|kern_data_ptr
expr_stmt|;
name|ctsio
operator|->
name|kern_sg_entries
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|data_len
operator|<
name|alloc_len
condition|)
block|{
name|ctsio
operator|->
name|residual
operator|=
name|alloc_len
operator|-
name|data_len
expr_stmt|;
name|ctsio
operator|->
name|kern_data_len
operator|=
name|data_len
expr_stmt|;
name|ctsio
operator|->
name|kern_total_len
operator|=
name|data_len
expr_stmt|;
block|}
else|else
block|{
name|ctsio
operator|->
name|residual
operator|=
literal|0
expr_stmt|;
name|ctsio
operator|->
name|kern_data_len
operator|=
name|alloc_len
expr_stmt|;
name|ctsio
operator|->
name|kern_total_len
operator|=
name|alloc_len
expr_stmt|;
block|}
name|ctsio
operator|->
name|kern_data_resid
operator|=
literal|0
expr_stmt|;
name|ctsio
operator|->
name|kern_rel_offset
operator|=
literal|0
expr_stmt|;
name|ctsio
operator|->
name|kern_sg_entries
operator|=
literal|0
expr_stmt|;
comment|/* 	 * The control device is always connected.  The disk device, on the 	 * other hand, may not be online all the time. 	 */
if|if
condition|(
name|lun
operator|!=
name|NULL
condition|)
name|tpc_ptr
operator|->
name|device
operator|=
operator|(
name|SID_QUAL_LU_CONNECTED
operator|<<
literal|5
operator|)
operator||
name|lun
operator|->
name|be_lun
operator|->
name|lun_type
expr_stmt|;
else|else
name|tpc_ptr
operator|->
name|device
operator|=
operator|(
name|SID_QUAL_LU_OFFLINE
operator|<<
literal|5
operator|)
operator||
name|T_DIRECT
expr_stmt|;
name|tpc_ptr
operator|->
name|page_code
operator|=
name|SVPD_SCSI_TPC
expr_stmt|;
name|scsi_ulto2b
argument_list|(
name|data_len
operator|-
literal|4
argument_list|,
name|tpc_ptr
operator|->
name|page_length
argument_list|)
expr_stmt|;
comment|/* Supported commands */
name|d_ptr
operator|=
operator|(
expr|struct
name|scsi_vpd_tpc_descriptor
operator|*
operator|)
operator|&
name|tpc_ptr
operator|->
name|descr
index|[
literal|0
index|]
expr_stmt|;
name|sc_ptr
operator|=
operator|(
expr|struct
name|scsi_vpd_tpc_descriptor_sc
operator|*
operator|)
name|d_ptr
expr_stmt|;
name|scsi_ulto2b
argument_list|(
name|SVPD_TPC_SC
argument_list|,
name|sc_ptr
operator|->
name|desc_type
argument_list|)
expr_stmt|;
name|sc_ptr
operator|->
name|list_length
operator|=
literal|2
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|scd_ptr
argument_list|)
operator|+
literal|7
expr_stmt|;
name|scsi_ulto2b
argument_list|(
name|roundup2
argument_list|(
literal|1
operator|+
name|sc_ptr
operator|->
name|list_length
argument_list|,
literal|4
argument_list|)
argument_list|,
name|sc_ptr
operator|->
name|desc_length
argument_list|)
expr_stmt|;
name|scd_ptr
operator|=
operator|&
name|sc_ptr
operator|->
name|descr
index|[
literal|0
index|]
expr_stmt|;
name|scd_ptr
operator|->
name|opcode
operator|=
name|EXTENDED_COPY
expr_stmt|;
name|scd_ptr
operator|->
name|sa_length
operator|=
literal|3
expr_stmt|;
name|scd_ptr
operator|->
name|supported_service_actions
index|[
literal|0
index|]
operator|=
name|EC_EC_LID1
expr_stmt|;
name|scd_ptr
operator|->
name|supported_service_actions
index|[
literal|1
index|]
operator|=
name|EC_EC_LID4
expr_stmt|;
name|scd_ptr
operator|->
name|supported_service_actions
index|[
literal|2
index|]
operator|=
name|EC_COA
expr_stmt|;
name|scd_ptr
operator|=
operator|(
expr|struct
name|scsi_vpd_tpc_descriptor_sc_descr
operator|*
operator|)
operator|&
name|scd_ptr
operator|->
name|supported_service_actions
index|[
name|scd_ptr
operator|->
name|sa_length
index|]
expr_stmt|;
name|scd_ptr
operator|->
name|opcode
operator|=
name|RECEIVE_COPY_STATUS
expr_stmt|;
name|scd_ptr
operator|->
name|sa_length
operator|=
literal|4
expr_stmt|;
name|scd_ptr
operator|->
name|supported_service_actions
index|[
literal|0
index|]
operator|=
name|RCS_RCS_LID1
expr_stmt|;
name|scd_ptr
operator|->
name|supported_service_actions
index|[
literal|1
index|]
operator|=
name|RCS_RCFD
expr_stmt|;
name|scd_ptr
operator|->
name|supported_service_actions
index|[
literal|2
index|]
operator|=
name|RCS_RCS_LID4
expr_stmt|;
name|scd_ptr
operator|->
name|supported_service_actions
index|[
literal|3
index|]
operator|=
name|RCS_RCOP
expr_stmt|;
comment|/* Parameter data. */
name|d_ptr
operator|=
operator|(
expr|struct
name|scsi_vpd_tpc_descriptor
operator|*
operator|)
operator|(
operator|&
name|d_ptr
operator|->
name|parameters
index|[
literal|0
index|]
operator|+
name|scsi_2btoul
argument_list|(
name|d_ptr
operator|->
name|desc_length
argument_list|)
operator|)
expr_stmt|;
name|pd_ptr
operator|=
operator|(
expr|struct
name|scsi_vpd_tpc_descriptor_pd
operator|*
operator|)
name|d_ptr
expr_stmt|;
name|scsi_ulto2b
argument_list|(
name|SVPD_TPC_PD
argument_list|,
name|pd_ptr
operator|->
name|desc_type
argument_list|)
expr_stmt|;
name|scsi_ulto2b
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|pd_ptr
argument_list|)
operator|-
literal|4
argument_list|,
name|pd_ptr
operator|->
name|desc_length
argument_list|)
expr_stmt|;
name|scsi_ulto2b
argument_list|(
name|TPC_MAX_CSCDS
argument_list|,
name|pd_ptr
operator|->
name|maximum_cscd_descriptor_count
argument_list|)
expr_stmt|;
name|scsi_ulto2b
argument_list|(
name|TPC_MAX_SEGS
argument_list|,
name|pd_ptr
operator|->
name|maximum_segment_descriptor_count
argument_list|)
expr_stmt|;
name|scsi_ulto4b
argument_list|(
name|TPC_MAX_LIST
argument_list|,
name|pd_ptr
operator|->
name|maximum_descriptor_list_length
argument_list|)
expr_stmt|;
name|scsi_ulto4b
argument_list|(
name|TPC_MAX_INLINE
argument_list|,
name|pd_ptr
operator|->
name|maximum_inline_data_length
argument_list|)
expr_stmt|;
comment|/* Supported Descriptors */
name|d_ptr
operator|=
operator|(
expr|struct
name|scsi_vpd_tpc_descriptor
operator|*
operator|)
operator|(
operator|&
name|d_ptr
operator|->
name|parameters
index|[
literal|0
index|]
operator|+
name|scsi_2btoul
argument_list|(
name|d_ptr
operator|->
name|desc_length
argument_list|)
operator|)
expr_stmt|;
name|sd_ptr
operator|=
operator|(
expr|struct
name|scsi_vpd_tpc_descriptor_sd
operator|*
operator|)
name|d_ptr
expr_stmt|;
name|scsi_ulto2b
argument_list|(
name|SVPD_TPC_SD
argument_list|,
name|sd_ptr
operator|->
name|desc_type
argument_list|)
expr_stmt|;
name|scsi_ulto2b
argument_list|(
name|roundup2
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|sd_ptr
argument_list|)
operator|-
literal|4
operator|+
literal|4
argument_list|,
literal|4
argument_list|)
argument_list|,
name|sd_ptr
operator|->
name|desc_length
argument_list|)
expr_stmt|;
name|sd_ptr
operator|->
name|list_length
operator|=
literal|4
expr_stmt|;
name|sd_ptr
operator|->
name|supported_descriptor_codes
index|[
literal|0
index|]
operator|=
name|EC_SEG_B2B
expr_stmt|;
name|sd_ptr
operator|->
name|supported_descriptor_codes
index|[
literal|1
index|]
operator|=
name|EC_SEG_VERIFY
expr_stmt|;
name|sd_ptr
operator|->
name|supported_descriptor_codes
index|[
literal|2
index|]
operator|=
name|EC_SEG_REGISTER_KEY
expr_stmt|;
name|sd_ptr
operator|->
name|supported_descriptor_codes
index|[
literal|3
index|]
operator|=
name|EC_CSCD_ID
expr_stmt|;
comment|/* Supported CSCD Descriptor IDs */
name|d_ptr
operator|=
operator|(
expr|struct
name|scsi_vpd_tpc_descriptor
operator|*
operator|)
operator|(
operator|&
name|d_ptr
operator|->
name|parameters
index|[
literal|0
index|]
operator|+
name|scsi_2btoul
argument_list|(
name|d_ptr
operator|->
name|desc_length
argument_list|)
operator|)
expr_stmt|;
name|sdid_ptr
operator|=
operator|(
expr|struct
name|scsi_vpd_tpc_descriptor_sdid
operator|*
operator|)
name|d_ptr
expr_stmt|;
name|scsi_ulto2b
argument_list|(
name|SVPD_TPC_SDID
argument_list|,
name|sdid_ptr
operator|->
name|desc_type
argument_list|)
expr_stmt|;
name|scsi_ulto2b
argument_list|(
name|roundup2
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|sdid_ptr
argument_list|)
operator|-
literal|4
operator|+
literal|2
argument_list|,
literal|4
argument_list|)
argument_list|,
name|sdid_ptr
operator|->
name|desc_length
argument_list|)
expr_stmt|;
name|scsi_ulto2b
argument_list|(
literal|2
argument_list|,
name|sdid_ptr
operator|->
name|list_length
argument_list|)
expr_stmt|;
name|scsi_ulto2b
argument_list|(
literal|0xffff
argument_list|,
operator|&
name|sdid_ptr
operator|->
name|supported_descriptor_ids
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
comment|/* General Copy Operations */
name|d_ptr
operator|=
operator|(
expr|struct
name|scsi_vpd_tpc_descriptor
operator|*
operator|)
operator|(
operator|&
name|d_ptr
operator|->
name|parameters
index|[
literal|0
index|]
operator|+
name|scsi_2btoul
argument_list|(
name|d_ptr
operator|->
name|desc_length
argument_list|)
operator|)
expr_stmt|;
name|gco_ptr
operator|=
operator|(
expr|struct
name|scsi_vpd_tpc_descriptor_gco
operator|*
operator|)
name|d_ptr
expr_stmt|;
name|scsi_ulto2b
argument_list|(
name|SVPD_TPC_GCO
argument_list|,
name|gco_ptr
operator|->
name|desc_type
argument_list|)
expr_stmt|;
name|scsi_ulto2b
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|gco_ptr
argument_list|)
operator|-
literal|4
argument_list|,
name|gco_ptr
operator|->
name|desc_length
argument_list|)
expr_stmt|;
name|scsi_ulto4b
argument_list|(
name|TPC_MAX_LISTS
argument_list|,
name|gco_ptr
operator|->
name|total_concurrent_copies
argument_list|)
expr_stmt|;
name|scsi_ulto4b
argument_list|(
name|TPC_MAX_LISTS
argument_list|,
name|gco_ptr
operator|->
name|maximum_identified_concurrent_copies
argument_list|)
expr_stmt|;
name|scsi_ulto4b
argument_list|(
name|TPC_MAX_SEG
argument_list|,
name|gco_ptr
operator|->
name|maximum_segment_length
argument_list|)
expr_stmt|;
name|gco_ptr
operator|->
name|data_segment_granularity
operator|=
literal|0
expr_stmt|;
name|gco_ptr
operator|->
name|inline_data_granularity
operator|=
literal|0
expr_stmt|;
name|ctsio
operator|->
name|scsi_status
operator|=
name|SCSI_STATUS_OK
expr_stmt|;
name|ctsio
operator|->
name|io_hdr
operator|.
name|flags
operator||=
name|CTL_FLAG_ALLOCATED
expr_stmt|;
name|ctsio
operator|->
name|be_move_done
operator|=
name|ctl_config_move_done
expr_stmt|;
name|ctl_datamove
argument_list|(
operator|(
expr|union
name|ctl_io
operator|*
operator|)
name|ctsio
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_RETVAL_COMPLETE
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ctl_receive_copy_operating_parameters
parameter_list|(
name|struct
name|ctl_scsiio
modifier|*
name|ctsio
parameter_list|)
block|{
name|struct
name|ctl_lun
modifier|*
name|lun
decl_stmt|;
name|struct
name|scsi_receive_copy_operating_parameters
modifier|*
name|cdb
decl_stmt|;
name|struct
name|scsi_receive_copy_operating_parameters_data
modifier|*
name|data
decl_stmt|;
name|int
name|retval
decl_stmt|;
name|int
name|alloc_len
decl_stmt|,
name|total_len
decl_stmt|;
name|CTL_DEBUG_PRINT
argument_list|(
operator|(
literal|"ctl_report_supported_tmf\n"
operator|)
argument_list|)
expr_stmt|;
name|cdb
operator|=
operator|(
expr|struct
name|scsi_receive_copy_operating_parameters
operator|*
operator|)
name|ctsio
operator|->
name|cdb
expr_stmt|;
name|lun
operator|=
operator|(
expr|struct
name|ctl_lun
operator|*
operator|)
name|ctsio
operator|->
name|io_hdr
operator|.
name|ctl_private
index|[
name|CTL_PRIV_LUN
index|]
operator|.
name|ptr
expr_stmt|;
name|retval
operator|=
name|CTL_RETVAL_COMPLETE
expr_stmt|;
name|total_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
operator|+
literal|4
expr_stmt|;
name|alloc_len
operator|=
name|scsi_4btoul
argument_list|(
name|cdb
operator|->
name|length
argument_list|)
expr_stmt|;
name|ctsio
operator|->
name|kern_data_ptr
operator|=
name|malloc
argument_list|(
name|total_len
argument_list|,
name|M_CTL
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|ctsio
operator|->
name|kern_sg_entries
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|total_len
operator|<
name|alloc_len
condition|)
block|{
name|ctsio
operator|->
name|residual
operator|=
name|alloc_len
operator|-
name|total_len
expr_stmt|;
name|ctsio
operator|->
name|kern_data_len
operator|=
name|total_len
expr_stmt|;
name|ctsio
operator|->
name|kern_total_len
operator|=
name|total_len
expr_stmt|;
block|}
else|else
block|{
name|ctsio
operator|->
name|residual
operator|=
literal|0
expr_stmt|;
name|ctsio
operator|->
name|kern_data_len
operator|=
name|alloc_len
expr_stmt|;
name|ctsio
operator|->
name|kern_total_len
operator|=
name|alloc_len
expr_stmt|;
block|}
name|ctsio
operator|->
name|kern_data_resid
operator|=
literal|0
expr_stmt|;
name|ctsio
operator|->
name|kern_rel_offset
operator|=
literal|0
expr_stmt|;
name|data
operator|=
operator|(
expr|struct
name|scsi_receive_copy_operating_parameters_data
operator|*
operator|)
name|ctsio
operator|->
name|kern_data_ptr
expr_stmt|;
name|scsi_ulto4b
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
operator|-
literal|4
operator|+
literal|4
argument_list|,
name|data
operator|->
name|length
argument_list|)
expr_stmt|;
name|data
operator|->
name|snlid
operator|=
name|RCOP_SNLID
expr_stmt|;
name|scsi_ulto2b
argument_list|(
name|TPC_MAX_CSCDS
argument_list|,
name|data
operator|->
name|maximum_cscd_descriptor_count
argument_list|)
expr_stmt|;
name|scsi_ulto2b
argument_list|(
name|TPC_MAX_SEGS
argument_list|,
name|data
operator|->
name|maximum_segment_descriptor_count
argument_list|)
expr_stmt|;
name|scsi_ulto4b
argument_list|(
name|TPC_MAX_LIST
argument_list|,
name|data
operator|->
name|maximum_descriptor_list_length
argument_list|)
expr_stmt|;
name|scsi_ulto4b
argument_list|(
name|TPC_MAX_SEG
argument_list|,
name|data
operator|->
name|maximum_segment_length
argument_list|)
expr_stmt|;
name|scsi_ulto4b
argument_list|(
name|TPC_MAX_INLINE
argument_list|,
name|data
operator|->
name|maximum_inline_data_length
argument_list|)
expr_stmt|;
name|scsi_ulto4b
argument_list|(
literal|0
argument_list|,
name|data
operator|->
name|held_data_limit
argument_list|)
expr_stmt|;
name|scsi_ulto4b
argument_list|(
literal|0
argument_list|,
name|data
operator|->
name|maximum_stream_device_transfer_size
argument_list|)
expr_stmt|;
name|scsi_ulto2b
argument_list|(
name|TPC_MAX_LISTS
argument_list|,
name|data
operator|->
name|total_concurrent_copies
argument_list|)
expr_stmt|;
name|data
operator|->
name|maximum_concurrent_copies
operator|=
name|TPC_MAX_LISTS
expr_stmt|;
name|data
operator|->
name|data_segment_granularity
operator|=
literal|0
expr_stmt|;
name|data
operator|->
name|inline_data_granularity
operator|=
literal|0
expr_stmt|;
name|data
operator|->
name|held_data_granularity
operator|=
literal|0
expr_stmt|;
name|data
operator|->
name|implemented_descriptor_list_length
operator|=
literal|4
expr_stmt|;
name|data
operator|->
name|list_of_implemented_descriptor_type_codes
index|[
literal|0
index|]
operator|=
name|EC_SEG_B2B
expr_stmt|;
name|data
operator|->
name|list_of_implemented_descriptor_type_codes
index|[
literal|1
index|]
operator|=
name|EC_SEG_VERIFY
expr_stmt|;
name|data
operator|->
name|list_of_implemented_descriptor_type_codes
index|[
literal|2
index|]
operator|=
name|EC_SEG_REGISTER_KEY
expr_stmt|;
name|data
operator|->
name|list_of_implemented_descriptor_type_codes
index|[
literal|3
index|]
operator|=
name|EC_CSCD_ID
expr_stmt|;
name|ctsio
operator|->
name|io_hdr
operator|.
name|flags
operator||=
name|CTL_FLAG_ALLOCATED
expr_stmt|;
name|ctsio
operator|->
name|be_move_done
operator|=
name|ctl_config_move_done
expr_stmt|;
name|ctl_datamove
argument_list|(
operator|(
expr|union
name|ctl_io
operator|*
operator|)
name|ctsio
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|tpc_list
modifier|*
name|tpc_find_list
parameter_list|(
name|struct
name|ctl_lun
modifier|*
name|lun
parameter_list|,
name|uint32_t
name|list_id
parameter_list|,
name|uint32_t
name|init_idx
parameter_list|)
block|{
name|struct
name|tpc_list
modifier|*
name|list
decl_stmt|;
name|mtx_assert
argument_list|(
operator|&
name|lun
operator|->
name|lun_lock
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|list
argument_list|,
argument|&lun->tpc_lists
argument_list|,
argument|links
argument_list|)
block|{
if|if
condition|(
operator|(
name|list
operator|->
name|flags
operator|&
name|EC_LIST_ID_USAGE_MASK
operator|)
operator|!=
name|EC_LIST_ID_USAGE_NONE
operator|&&
name|list
operator|->
name|list_id
operator|==
name|list_id
operator|&&
name|list
operator|->
name|init_idx
operator|==
name|init_idx
condition|)
break|break;
block|}
return|return
operator|(
name|list
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ctl_receive_copy_status_lid1
parameter_list|(
name|struct
name|ctl_scsiio
modifier|*
name|ctsio
parameter_list|)
block|{
name|struct
name|ctl_lun
modifier|*
name|lun
decl_stmt|;
name|struct
name|scsi_receive_copy_status_lid1
modifier|*
name|cdb
decl_stmt|;
name|struct
name|scsi_receive_copy_status_lid1_data
modifier|*
name|data
decl_stmt|;
name|struct
name|tpc_list
modifier|*
name|list
decl_stmt|;
name|struct
name|tpc_list
name|list_copy
decl_stmt|;
name|int
name|retval
decl_stmt|;
name|int
name|alloc_len
decl_stmt|,
name|total_len
decl_stmt|;
name|uint32_t
name|list_id
decl_stmt|;
name|CTL_DEBUG_PRINT
argument_list|(
operator|(
literal|"ctl_receive_copy_status_lid1\n"
operator|)
argument_list|)
expr_stmt|;
name|cdb
operator|=
operator|(
expr|struct
name|scsi_receive_copy_status_lid1
operator|*
operator|)
name|ctsio
operator|->
name|cdb
expr_stmt|;
name|lun
operator|=
operator|(
expr|struct
name|ctl_lun
operator|*
operator|)
name|ctsio
operator|->
name|io_hdr
operator|.
name|ctl_private
index|[
name|CTL_PRIV_LUN
index|]
operator|.
name|ptr
expr_stmt|;
name|retval
operator|=
name|CTL_RETVAL_COMPLETE
expr_stmt|;
name|list_id
operator|=
name|cdb
operator|->
name|list_identifier
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|lun
operator|->
name|lun_lock
argument_list|)
expr_stmt|;
name|list
operator|=
name|tpc_find_list
argument_list|(
name|lun
argument_list|,
name|list_id
argument_list|,
name|ctl_get_resindex
argument_list|(
operator|&
name|ctsio
operator|->
name|io_hdr
operator|.
name|nexus
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|list
operator|==
name|NULL
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|lun
operator|->
name|lun_lock
argument_list|)
expr_stmt|;
name|ctl_set_invalid_field
argument_list|(
name|ctsio
argument_list|,
comment|/*sks_valid*/
literal|1
argument_list|,
comment|/*command*/
literal|1
argument_list|,
comment|/*field*/
literal|2
argument_list|,
comment|/*bit_valid*/
literal|0
argument_list|,
comment|/*bit*/
literal|0
argument_list|)
expr_stmt|;
name|ctl_done
argument_list|(
operator|(
expr|union
name|ctl_io
operator|*
operator|)
name|ctsio
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
name|list_copy
operator|=
operator|*
name|list
expr_stmt|;
if|if
condition|(
name|list
operator|->
name|completed
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|lun
operator|->
name|tpc_lists
argument_list|,
name|list
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|list
argument_list|,
name|M_CTL
argument_list|)
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|lun
operator|->
name|lun_lock
argument_list|)
expr_stmt|;
name|total_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
expr_stmt|;
name|alloc_len
operator|=
name|scsi_4btoul
argument_list|(
name|cdb
operator|->
name|length
argument_list|)
expr_stmt|;
name|ctsio
operator|->
name|kern_data_ptr
operator|=
name|malloc
argument_list|(
name|total_len
argument_list|,
name|M_CTL
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|ctsio
operator|->
name|kern_sg_entries
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|total_len
operator|<
name|alloc_len
condition|)
block|{
name|ctsio
operator|->
name|residual
operator|=
name|alloc_len
operator|-
name|total_len
expr_stmt|;
name|ctsio
operator|->
name|kern_data_len
operator|=
name|total_len
expr_stmt|;
name|ctsio
operator|->
name|kern_total_len
operator|=
name|total_len
expr_stmt|;
block|}
else|else
block|{
name|ctsio
operator|->
name|residual
operator|=
literal|0
expr_stmt|;
name|ctsio
operator|->
name|kern_data_len
operator|=
name|alloc_len
expr_stmt|;
name|ctsio
operator|->
name|kern_total_len
operator|=
name|alloc_len
expr_stmt|;
block|}
name|ctsio
operator|->
name|kern_data_resid
operator|=
literal|0
expr_stmt|;
name|ctsio
operator|->
name|kern_rel_offset
operator|=
literal|0
expr_stmt|;
name|data
operator|=
operator|(
expr|struct
name|scsi_receive_copy_status_lid1_data
operator|*
operator|)
name|ctsio
operator|->
name|kern_data_ptr
expr_stmt|;
name|scsi_ulto4b
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
operator|-
literal|4
argument_list|,
name|data
operator|->
name|available_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|list_copy
operator|.
name|completed
condition|)
block|{
if|if
condition|(
name|list_copy
operator|.
name|error
operator|||
name|list_copy
operator|.
name|abort
condition|)
name|data
operator|->
name|copy_command_status
operator|=
name|RCS_CCS_ERROR
expr_stmt|;
else|else
name|data
operator|->
name|copy_command_status
operator|=
name|RCS_CCS_COMPLETED
expr_stmt|;
block|}
else|else
name|data
operator|->
name|copy_command_status
operator|=
name|RCS_CCS_INPROG
expr_stmt|;
name|scsi_ulto2b
argument_list|(
name|list_copy
operator|.
name|curseg
argument_list|,
name|data
operator|->
name|segments_processed
argument_list|)
expr_stmt|;
if|if
condition|(
name|list_copy
operator|.
name|curbytes
operator|<=
name|UINT32_MAX
condition|)
block|{
name|data
operator|->
name|transfer_count_units
operator|=
name|RCS_TC_BYTES
expr_stmt|;
name|scsi_ulto4b
argument_list|(
name|list_copy
operator|.
name|curbytes
argument_list|,
name|data
operator|->
name|transfer_count
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|data
operator|->
name|transfer_count_units
operator|=
name|RCS_TC_MBYTES
expr_stmt|;
name|scsi_ulto4b
argument_list|(
name|list_copy
operator|.
name|curbytes
operator|>>
literal|20
argument_list|,
name|data
operator|->
name|transfer_count
argument_list|)
expr_stmt|;
block|}
name|ctsio
operator|->
name|io_hdr
operator|.
name|flags
operator||=
name|CTL_FLAG_ALLOCATED
expr_stmt|;
name|ctsio
operator|->
name|be_move_done
operator|=
name|ctl_config_move_done
expr_stmt|;
name|ctl_datamove
argument_list|(
operator|(
expr|union
name|ctl_io
operator|*
operator|)
name|ctsio
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ctl_receive_copy_failure_details
parameter_list|(
name|struct
name|ctl_scsiio
modifier|*
name|ctsio
parameter_list|)
block|{
name|struct
name|ctl_lun
modifier|*
name|lun
decl_stmt|;
name|struct
name|scsi_receive_copy_failure_details
modifier|*
name|cdb
decl_stmt|;
name|struct
name|scsi_receive_copy_failure_details_data
modifier|*
name|data
decl_stmt|;
name|struct
name|tpc_list
modifier|*
name|list
decl_stmt|;
name|struct
name|tpc_list
name|list_copy
decl_stmt|;
name|int
name|retval
decl_stmt|;
name|int
name|alloc_len
decl_stmt|,
name|total_len
decl_stmt|;
name|uint32_t
name|list_id
decl_stmt|;
name|CTL_DEBUG_PRINT
argument_list|(
operator|(
literal|"ctl_receive_copy_failure_details\n"
operator|)
argument_list|)
expr_stmt|;
name|cdb
operator|=
operator|(
expr|struct
name|scsi_receive_copy_failure_details
operator|*
operator|)
name|ctsio
operator|->
name|cdb
expr_stmt|;
name|lun
operator|=
operator|(
expr|struct
name|ctl_lun
operator|*
operator|)
name|ctsio
operator|->
name|io_hdr
operator|.
name|ctl_private
index|[
name|CTL_PRIV_LUN
index|]
operator|.
name|ptr
expr_stmt|;
name|retval
operator|=
name|CTL_RETVAL_COMPLETE
expr_stmt|;
name|list_id
operator|=
name|cdb
operator|->
name|list_identifier
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|lun
operator|->
name|lun_lock
argument_list|)
expr_stmt|;
name|list
operator|=
name|tpc_find_list
argument_list|(
name|lun
argument_list|,
name|list_id
argument_list|,
name|ctl_get_resindex
argument_list|(
operator|&
name|ctsio
operator|->
name|io_hdr
operator|.
name|nexus
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|list
operator|==
name|NULL
operator|||
operator|!
name|list
operator|->
name|completed
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|lun
operator|->
name|lun_lock
argument_list|)
expr_stmt|;
name|ctl_set_invalid_field
argument_list|(
name|ctsio
argument_list|,
comment|/*sks_valid*/
literal|1
argument_list|,
comment|/*command*/
literal|1
argument_list|,
comment|/*field*/
literal|2
argument_list|,
comment|/*bit_valid*/
literal|0
argument_list|,
comment|/*bit*/
literal|0
argument_list|)
expr_stmt|;
name|ctl_done
argument_list|(
operator|(
expr|union
name|ctl_io
operator|*
operator|)
name|ctsio
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
name|list_copy
operator|=
operator|*
name|list
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|lun
operator|->
name|tpc_lists
argument_list|,
name|list
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|list
argument_list|,
name|M_CTL
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|lun
operator|->
name|lun_lock
argument_list|)
expr_stmt|;
name|total_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
operator|+
name|list_copy
operator|.
name|sense_len
expr_stmt|;
name|alloc_len
operator|=
name|scsi_4btoul
argument_list|(
name|cdb
operator|->
name|length
argument_list|)
expr_stmt|;
name|ctsio
operator|->
name|kern_data_ptr
operator|=
name|malloc
argument_list|(
name|total_len
argument_list|,
name|M_CTL
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|ctsio
operator|->
name|kern_sg_entries
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|total_len
operator|<
name|alloc_len
condition|)
block|{
name|ctsio
operator|->
name|residual
operator|=
name|alloc_len
operator|-
name|total_len
expr_stmt|;
name|ctsio
operator|->
name|kern_data_len
operator|=
name|total_len
expr_stmt|;
name|ctsio
operator|->
name|kern_total_len
operator|=
name|total_len
expr_stmt|;
block|}
else|else
block|{
name|ctsio
operator|->
name|residual
operator|=
literal|0
expr_stmt|;
name|ctsio
operator|->
name|kern_data_len
operator|=
name|alloc_len
expr_stmt|;
name|ctsio
operator|->
name|kern_total_len
operator|=
name|alloc_len
expr_stmt|;
block|}
name|ctsio
operator|->
name|kern_data_resid
operator|=
literal|0
expr_stmt|;
name|ctsio
operator|->
name|kern_rel_offset
operator|=
literal|0
expr_stmt|;
name|data
operator|=
operator|(
expr|struct
name|scsi_receive_copy_failure_details_data
operator|*
operator|)
name|ctsio
operator|->
name|kern_data_ptr
expr_stmt|;
if|if
condition|(
name|list_copy
operator|.
name|completed
operator|&&
operator|(
name|list_copy
operator|.
name|error
operator|||
name|list_copy
operator|.
name|abort
operator|)
condition|)
block|{
name|scsi_ulto4b
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
operator|-
literal|4
argument_list|,
name|data
operator|->
name|available_data
argument_list|)
expr_stmt|;
name|data
operator|->
name|copy_command_status
operator|=
name|RCS_CCS_ERROR
expr_stmt|;
block|}
else|else
name|scsi_ulto4b
argument_list|(
literal|0
argument_list|,
name|data
operator|->
name|available_data
argument_list|)
expr_stmt|;
name|scsi_ulto2b
argument_list|(
name|list_copy
operator|.
name|sense_len
argument_list|,
name|data
operator|->
name|sense_data_length
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|data
operator|->
name|sense_data
argument_list|,
operator|&
name|list_copy
operator|.
name|sense_data
argument_list|,
name|list_copy
operator|.
name|sense_len
argument_list|)
expr_stmt|;
name|ctsio
operator|->
name|io_hdr
operator|.
name|flags
operator||=
name|CTL_FLAG_ALLOCATED
expr_stmt|;
name|ctsio
operator|->
name|be_move_done
operator|=
name|ctl_config_move_done
expr_stmt|;
name|ctl_datamove
argument_list|(
operator|(
expr|union
name|ctl_io
operator|*
operator|)
name|ctsio
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ctl_receive_copy_status_lid4
parameter_list|(
name|struct
name|ctl_scsiio
modifier|*
name|ctsio
parameter_list|)
block|{
name|struct
name|ctl_lun
modifier|*
name|lun
decl_stmt|;
name|struct
name|scsi_receive_copy_status_lid4
modifier|*
name|cdb
decl_stmt|;
name|struct
name|scsi_receive_copy_status_lid4_data
modifier|*
name|data
decl_stmt|;
name|struct
name|tpc_list
modifier|*
name|list
decl_stmt|;
name|struct
name|tpc_list
name|list_copy
decl_stmt|;
name|int
name|retval
decl_stmt|;
name|int
name|alloc_len
decl_stmt|,
name|total_len
decl_stmt|;
name|uint32_t
name|list_id
decl_stmt|;
name|CTL_DEBUG_PRINT
argument_list|(
operator|(
literal|"ctl_receive_copy_status_lid4\n"
operator|)
argument_list|)
expr_stmt|;
name|cdb
operator|=
operator|(
expr|struct
name|scsi_receive_copy_status_lid4
operator|*
operator|)
name|ctsio
operator|->
name|cdb
expr_stmt|;
name|lun
operator|=
operator|(
expr|struct
name|ctl_lun
operator|*
operator|)
name|ctsio
operator|->
name|io_hdr
operator|.
name|ctl_private
index|[
name|CTL_PRIV_LUN
index|]
operator|.
name|ptr
expr_stmt|;
name|retval
operator|=
name|CTL_RETVAL_COMPLETE
expr_stmt|;
name|list_id
operator|=
name|scsi_4btoul
argument_list|(
name|cdb
operator|->
name|list_identifier
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|lun
operator|->
name|lun_lock
argument_list|)
expr_stmt|;
name|list
operator|=
name|tpc_find_list
argument_list|(
name|lun
argument_list|,
name|list_id
argument_list|,
name|ctl_get_resindex
argument_list|(
operator|&
name|ctsio
operator|->
name|io_hdr
operator|.
name|nexus
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|list
operator|==
name|NULL
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|lun
operator|->
name|lun_lock
argument_list|)
expr_stmt|;
name|ctl_set_invalid_field
argument_list|(
name|ctsio
argument_list|,
comment|/*sks_valid*/
literal|1
argument_list|,
comment|/*command*/
literal|1
argument_list|,
comment|/*field*/
literal|2
argument_list|,
comment|/*bit_valid*/
literal|0
argument_list|,
comment|/*bit*/
literal|0
argument_list|)
expr_stmt|;
name|ctl_done
argument_list|(
operator|(
expr|union
name|ctl_io
operator|*
operator|)
name|ctsio
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
name|list_copy
operator|=
operator|*
name|list
expr_stmt|;
if|if
condition|(
name|list
operator|->
name|completed
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|lun
operator|->
name|tpc_lists
argument_list|,
name|list
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|list
argument_list|,
name|M_CTL
argument_list|)
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|lun
operator|->
name|lun_lock
argument_list|)
expr_stmt|;
name|total_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
operator|+
name|list_copy
operator|.
name|sense_len
expr_stmt|;
name|alloc_len
operator|=
name|scsi_4btoul
argument_list|(
name|cdb
operator|->
name|length
argument_list|)
expr_stmt|;
name|ctsio
operator|->
name|kern_data_ptr
operator|=
name|malloc
argument_list|(
name|total_len
argument_list|,
name|M_CTL
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|ctsio
operator|->
name|kern_sg_entries
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|total_len
operator|<
name|alloc_len
condition|)
block|{
name|ctsio
operator|->
name|residual
operator|=
name|alloc_len
operator|-
name|total_len
expr_stmt|;
name|ctsio
operator|->
name|kern_data_len
operator|=
name|total_len
expr_stmt|;
name|ctsio
operator|->
name|kern_total_len
operator|=
name|total_len
expr_stmt|;
block|}
else|else
block|{
name|ctsio
operator|->
name|residual
operator|=
literal|0
expr_stmt|;
name|ctsio
operator|->
name|kern_data_len
operator|=
name|alloc_len
expr_stmt|;
name|ctsio
operator|->
name|kern_total_len
operator|=
name|alloc_len
expr_stmt|;
block|}
name|ctsio
operator|->
name|kern_data_resid
operator|=
literal|0
expr_stmt|;
name|ctsio
operator|->
name|kern_rel_offset
operator|=
literal|0
expr_stmt|;
name|data
operator|=
operator|(
expr|struct
name|scsi_receive_copy_status_lid4_data
operator|*
operator|)
name|ctsio
operator|->
name|kern_data_ptr
expr_stmt|;
name|scsi_ulto4b
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
operator|-
literal|4
argument_list|,
name|data
operator|->
name|available_data
argument_list|)
expr_stmt|;
name|data
operator|->
name|response_to_service_action
operator|=
name|list_copy
operator|.
name|service_action
expr_stmt|;
if|if
condition|(
name|list_copy
operator|.
name|completed
condition|)
block|{
if|if
condition|(
name|list_copy
operator|.
name|error
condition|)
name|data
operator|->
name|copy_command_status
operator|=
name|RCS_CCS_ERROR
expr_stmt|;
elseif|else
if|if
condition|(
name|list_copy
operator|.
name|abort
condition|)
name|data
operator|->
name|copy_command_status
operator|=
name|RCS_CCS_ABORTED
expr_stmt|;
else|else
name|data
operator|->
name|copy_command_status
operator|=
name|RCS_CCS_COMPLETED
expr_stmt|;
block|}
else|else
name|data
operator|->
name|copy_command_status
operator|=
name|RCS_CCS_INPROG_FG
expr_stmt|;
name|scsi_ulto2b
argument_list|(
name|list_copy
operator|.
name|curops
argument_list|,
name|data
operator|->
name|operation_counter
argument_list|)
expr_stmt|;
name|scsi_ulto4b
argument_list|(
name|UINT32_MAX
argument_list|,
name|data
operator|->
name|estimated_status_update_delay
argument_list|)
expr_stmt|;
if|if
condition|(
name|list_copy
operator|.
name|curbytes
operator|<=
name|UINT32_MAX
condition|)
block|{
name|data
operator|->
name|transfer_count_units
operator|=
name|RCS_TC_BYTES
expr_stmt|;
name|scsi_ulto4b
argument_list|(
name|list_copy
operator|.
name|curbytes
argument_list|,
name|data
operator|->
name|transfer_count
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|data
operator|->
name|transfer_count_units
operator|=
name|RCS_TC_MBYTES
expr_stmt|;
name|scsi_ulto4b
argument_list|(
name|list_copy
operator|.
name|curbytes
operator|>>
literal|20
argument_list|,
name|data
operator|->
name|transfer_count
argument_list|)
expr_stmt|;
block|}
name|scsi_ulto2b
argument_list|(
name|list_copy
operator|.
name|curseg
argument_list|,
name|data
operator|->
name|segments_processed
argument_list|)
expr_stmt|;
name|data
operator|->
name|sense_data_length
operator|=
name|list_copy
operator|.
name|sense_len
expr_stmt|;
name|memcpy
argument_list|(
name|data
operator|->
name|sense_data
argument_list|,
operator|&
name|list_copy
operator|.
name|sense_data
argument_list|,
name|list_copy
operator|.
name|sense_len
argument_list|)
expr_stmt|;
name|ctsio
operator|->
name|io_hdr
operator|.
name|flags
operator||=
name|CTL_FLAG_ALLOCATED
expr_stmt|;
name|ctsio
operator|->
name|be_move_done
operator|=
name|ctl_config_move_done
expr_stmt|;
name|ctl_datamove
argument_list|(
operator|(
expr|union
name|ctl_io
operator|*
operator|)
name|ctsio
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ctl_copy_operation_abort
parameter_list|(
name|struct
name|ctl_scsiio
modifier|*
name|ctsio
parameter_list|)
block|{
name|struct
name|ctl_lun
modifier|*
name|lun
decl_stmt|;
name|struct
name|scsi_copy_operation_abort
modifier|*
name|cdb
decl_stmt|;
name|struct
name|tpc_list
modifier|*
name|list
decl_stmt|;
name|int
name|retval
decl_stmt|;
name|uint32_t
name|list_id
decl_stmt|;
name|CTL_DEBUG_PRINT
argument_list|(
operator|(
literal|"ctl_copy_operation_abort\n"
operator|)
argument_list|)
expr_stmt|;
name|cdb
operator|=
operator|(
expr|struct
name|scsi_copy_operation_abort
operator|*
operator|)
name|ctsio
operator|->
name|cdb
expr_stmt|;
name|lun
operator|=
operator|(
expr|struct
name|ctl_lun
operator|*
operator|)
name|ctsio
operator|->
name|io_hdr
operator|.
name|ctl_private
index|[
name|CTL_PRIV_LUN
index|]
operator|.
name|ptr
expr_stmt|;
name|retval
operator|=
name|CTL_RETVAL_COMPLETE
expr_stmt|;
name|list_id
operator|=
name|scsi_4btoul
argument_list|(
name|cdb
operator|->
name|list_identifier
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|lun
operator|->
name|lun_lock
argument_list|)
expr_stmt|;
name|list
operator|=
name|tpc_find_list
argument_list|(
name|lun
argument_list|,
name|list_id
argument_list|,
name|ctl_get_resindex
argument_list|(
operator|&
name|ctsio
operator|->
name|io_hdr
operator|.
name|nexus
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|list
operator|==
name|NULL
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|lun
operator|->
name|lun_lock
argument_list|)
expr_stmt|;
name|ctl_set_invalid_field
argument_list|(
name|ctsio
argument_list|,
comment|/*sks_valid*/
literal|1
argument_list|,
comment|/*command*/
literal|1
argument_list|,
comment|/*field*/
literal|2
argument_list|,
comment|/*bit_valid*/
literal|0
argument_list|,
comment|/*bit*/
literal|0
argument_list|)
expr_stmt|;
name|ctl_done
argument_list|(
operator|(
expr|union
name|ctl_io
operator|*
operator|)
name|ctsio
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
name|list
operator|->
name|abort
operator|=
literal|1
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|lun
operator|->
name|lun_lock
argument_list|)
expr_stmt|;
name|ctl_set_success
argument_list|(
name|ctsio
argument_list|)
expr_stmt|;
name|ctl_done
argument_list|(
operator|(
expr|union
name|ctl_io
operator|*
operator|)
name|ctsio
argument_list|)
expr_stmt|;
return|return
operator|(
name|retval
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|tpc_resolve
parameter_list|(
name|struct
name|tpc_list
modifier|*
name|list
parameter_list|,
name|uint16_t
name|idx
parameter_list|,
name|uint32_t
modifier|*
name|ss
parameter_list|)
block|{
if|if
condition|(
name|idx
operator|==
literal|0xffff
condition|)
block|{
if|if
condition|(
name|ss
operator|&&
name|list
operator|->
name|lun
operator|->
name|be_lun
condition|)
operator|*
name|ss
operator|=
name|list
operator|->
name|lun
operator|->
name|be_lun
operator|->
name|blocksize
expr_stmt|;
return|return
operator|(
name|list
operator|->
name|lun
operator|->
name|lun
operator|)
return|;
block|}
if|if
condition|(
name|idx
operator|>=
name|list
operator|->
name|ncscd
condition|)
return|return
operator|(
name|UINT64_MAX
operator|)
return|;
return|return
operator|(
name|tpcl_resolve
argument_list|(
name|list
operator|->
name|init_port
argument_list|,
operator|&
name|list
operator|->
name|cscd
index|[
name|idx
index|]
argument_list|,
name|ss
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tpc_process_b2b
parameter_list|(
name|struct
name|tpc_list
modifier|*
name|list
parameter_list|)
block|{
name|struct
name|scsi_ec_segment_b2b
modifier|*
name|seg
decl_stmt|;
name|struct
name|scsi_ec_cscd_dtsp
modifier|*
name|sdstp
decl_stmt|,
modifier|*
name|ddstp
decl_stmt|;
name|struct
name|tpc_io
modifier|*
name|tior
decl_stmt|,
modifier|*
name|tiow
decl_stmt|;
name|struct
name|runl
name|run
decl_stmt|,
modifier|*
name|prun
decl_stmt|;
name|uint64_t
name|sl
decl_stmt|,
name|dl
decl_stmt|;
name|off_t
name|srclba
decl_stmt|,
name|dstlba
decl_stmt|,
name|numbytes
decl_stmt|,
name|donebytes
decl_stmt|,
name|roundbytes
decl_stmt|;
name|int
name|numlba
decl_stmt|;
name|uint32_t
name|srcblock
decl_stmt|,
name|dstblock
decl_stmt|;
if|if
condition|(
name|list
operator|->
name|stage
operator|==
literal|1
condition|)
block|{
name|complete
label|:
while|while
condition|(
operator|(
name|tior
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|list
operator|->
name|allio
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|list
operator|->
name|allio
argument_list|,
name|tior
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|ctl_free_io
argument_list|(
name|tior
operator|->
name|io
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tior
argument_list|,
name|M_CTL
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|list
operator|->
name|buf
argument_list|,
name|M_CTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|list
operator|->
name|abort
condition|)
block|{
name|ctl_set_task_aborted
argument_list|(
name|list
operator|->
name|ctsio
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_RETVAL_ERROR
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|list
operator|->
name|error
condition|)
block|{
name|ctl_set_sense
argument_list|(
name|list
operator|->
name|ctsio
argument_list|,
comment|/*current_error*/
literal|1
argument_list|,
comment|/*sense_key*/
name|SSD_KEY_COPY_ABORTED
argument_list|,
comment|/*asc*/
literal|0x0d
argument_list|,
comment|/*ascq*/
literal|0x01
argument_list|,
name|SSD_ELEM_NONE
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_RETVAL_ERROR
operator|)
return|;
block|}
else|else
block|{
name|list
operator|->
name|curbytes
operator|+=
name|list
operator|->
name|segbytes
expr_stmt|;
return|return
operator|(
name|CTL_RETVAL_COMPLETE
operator|)
return|;
block|}
block|}
name|TAILQ_INIT
argument_list|(
operator|&
name|list
operator|->
name|allio
argument_list|)
expr_stmt|;
name|seg
operator|=
operator|(
expr|struct
name|scsi_ec_segment_b2b
operator|*
operator|)
name|list
operator|->
name|seg
index|[
name|list
operator|->
name|curseg
index|]
expr_stmt|;
name|sl
operator|=
name|tpc_resolve
argument_list|(
name|list
argument_list|,
name|scsi_2btoul
argument_list|(
name|seg
operator|->
name|src_cscd
argument_list|)
argument_list|,
operator|&
name|srcblock
argument_list|)
expr_stmt|;
name|dl
operator|=
name|tpc_resolve
argument_list|(
name|list
argument_list|,
name|scsi_2btoul
argument_list|(
name|seg
operator|->
name|dst_cscd
argument_list|)
argument_list|,
operator|&
name|dstblock
argument_list|)
expr_stmt|;
if|if
condition|(
name|sl
operator|>=
name|CTL_MAX_LUNS
operator|||
name|dl
operator|>=
name|CTL_MAX_LUNS
condition|)
block|{
name|ctl_set_sense
argument_list|(
name|list
operator|->
name|ctsio
argument_list|,
comment|/*current_error*/
literal|1
argument_list|,
comment|/*sense_key*/
name|SSD_KEY_COPY_ABORTED
argument_list|,
comment|/*asc*/
literal|0x08
argument_list|,
comment|/*ascq*/
literal|0x04
argument_list|,
name|SSD_ELEM_NONE
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_RETVAL_ERROR
operator|)
return|;
block|}
name|sdstp
operator|=
operator|&
name|list
operator|->
name|cscd
index|[
name|scsi_2btoul
argument_list|(
name|seg
operator|->
name|src_cscd
argument_list|)
index|]
operator|.
name|dtsp
expr_stmt|;
if|if
condition|(
name|scsi_3btoul
argument_list|(
name|sdstp
operator|->
name|block_length
argument_list|)
operator|!=
literal|0
condition|)
name|srcblock
operator|=
name|scsi_3btoul
argument_list|(
name|sdstp
operator|->
name|block_length
argument_list|)
expr_stmt|;
name|ddstp
operator|=
operator|&
name|list
operator|->
name|cscd
index|[
name|scsi_2btoul
argument_list|(
name|seg
operator|->
name|dst_cscd
argument_list|)
index|]
operator|.
name|dtsp
expr_stmt|;
if|if
condition|(
name|scsi_3btoul
argument_list|(
name|ddstp
operator|->
name|block_length
argument_list|)
operator|!=
literal|0
condition|)
name|dstblock
operator|=
name|scsi_3btoul
argument_list|(
name|ddstp
operator|->
name|block_length
argument_list|)
expr_stmt|;
name|numlba
operator|=
name|scsi_2btoul
argument_list|(
name|seg
operator|->
name|number_of_blocks
argument_list|)
expr_stmt|;
if|if
condition|(
name|seg
operator|->
name|flags
operator|&
name|EC_SEG_DC
condition|)
name|numbytes
operator|=
operator|(
name|off_t
operator|)
name|numlba
operator|*
name|dstblock
expr_stmt|;
else|else
name|numbytes
operator|=
operator|(
name|off_t
operator|)
name|numlba
operator|*
name|srcblock
expr_stmt|;
name|srclba
operator|=
name|scsi_8btou64
argument_list|(
name|seg
operator|->
name|src_lba
argument_list|)
expr_stmt|;
name|dstlba
operator|=
name|scsi_8btou64
argument_list|(
name|seg
operator|->
name|dst_lba
argument_list|)
expr_stmt|;
comment|//	printf("Copy %ju bytes from %ju @ %ju to %ju @ %ju\n",
comment|//	    (uintmax_t)numbytes, sl, scsi_8btou64(seg->src_lba),
comment|//	    dl, scsi_8btou64(seg->dst_lba));
if|if
condition|(
name|numbytes
operator|==
literal|0
condition|)
return|return
operator|(
name|CTL_RETVAL_COMPLETE
operator|)
return|;
if|if
condition|(
name|numbytes
operator|%
name|srcblock
operator|!=
literal|0
operator|||
name|numbytes
operator|%
name|dstblock
operator|!=
literal|0
condition|)
block|{
name|ctl_set_sense
argument_list|(
name|list
operator|->
name|ctsio
argument_list|,
comment|/*current_error*/
literal|1
argument_list|,
comment|/*sense_key*/
name|SSD_KEY_COPY_ABORTED
argument_list|,
comment|/*asc*/
literal|0x26
argument_list|,
comment|/*ascq*/
literal|0x0A
argument_list|,
name|SSD_ELEM_NONE
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_RETVAL_ERROR
operator|)
return|;
block|}
name|list
operator|->
name|buf
operator|=
name|malloc
argument_list|(
name|numbytes
argument_list|,
name|M_CTL
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|list
operator|->
name|segbytes
operator|=
name|numbytes
expr_stmt|;
name|donebytes
operator|=
literal|0
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|run
argument_list|)
expr_stmt|;
name|prun
operator|=
operator|&
name|run
expr_stmt|;
name|list
operator|->
name|tbdio
operator|=
literal|1
expr_stmt|;
while|while
condition|(
name|donebytes
operator|<
name|numbytes
condition|)
block|{
name|roundbytes
operator|=
name|MIN
argument_list|(
name|numbytes
operator|-
name|donebytes
argument_list|,
name|TPC_MAX_IO_SIZE
argument_list|)
expr_stmt|;
name|tior
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|tior
argument_list|)
argument_list|,
name|M_CTL
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|tior
operator|->
name|run
argument_list|)
expr_stmt|;
name|tior
operator|->
name|list
operator|=
name|list
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|list
operator|->
name|allio
argument_list|,
name|tior
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|tior
operator|->
name|io
operator|=
name|tpcl_alloc_io
argument_list|()
expr_stmt|;
if|if
condition|(
name|tior
operator|->
name|io
operator|==
name|NULL
condition|)
block|{
name|list
operator|->
name|error
operator|=
literal|1
expr_stmt|;
goto|goto
name|complete
goto|;
block|}
name|ctl_scsi_read_write
argument_list|(
name|tior
operator|->
name|io
argument_list|,
comment|/*data_ptr*/
operator|&
name|list
operator|->
name|buf
index|[
name|donebytes
index|]
argument_list|,
comment|/*data_len*/
name|roundbytes
argument_list|,
comment|/*read_op*/
literal|1
argument_list|,
comment|/*byte2*/
literal|0
argument_list|,
comment|/*minimum_cdb_size*/
literal|0
argument_list|,
comment|/*lba*/
name|srclba
operator|+
name|donebytes
operator|/
name|srcblock
argument_list|,
comment|/*num_blocks*/
name|roundbytes
operator|/
name|srcblock
argument_list|,
comment|/*tag_type*/
name|CTL_TAG_SIMPLE
argument_list|,
comment|/*control*/
literal|0
argument_list|)
expr_stmt|;
name|tior
operator|->
name|io
operator|->
name|io_hdr
operator|.
name|retries
operator|=
literal|3
expr_stmt|;
name|tior
operator|->
name|lun
operator|=
name|sl
expr_stmt|;
name|tior
operator|->
name|io
operator|->
name|io_hdr
operator|.
name|ctl_private
index|[
name|CTL_PRIV_FRONTEND
index|]
operator|.
name|ptr
operator|=
name|tior
expr_stmt|;
name|tiow
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|tior
argument_list|)
argument_list|,
name|M_CTL
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|tiow
operator|->
name|run
argument_list|)
expr_stmt|;
name|tiow
operator|->
name|list
operator|=
name|list
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|list
operator|->
name|allio
argument_list|,
name|tiow
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|tiow
operator|->
name|io
operator|=
name|tpcl_alloc_io
argument_list|()
expr_stmt|;
if|if
condition|(
name|tiow
operator|->
name|io
operator|==
name|NULL
condition|)
block|{
name|list
operator|->
name|error
operator|=
literal|1
expr_stmt|;
goto|goto
name|complete
goto|;
block|}
name|ctl_scsi_read_write
argument_list|(
name|tiow
operator|->
name|io
argument_list|,
comment|/*data_ptr*/
operator|&
name|list
operator|->
name|buf
index|[
name|donebytes
index|]
argument_list|,
comment|/*data_len*/
name|roundbytes
argument_list|,
comment|/*read_op*/
literal|0
argument_list|,
comment|/*byte2*/
literal|0
argument_list|,
comment|/*minimum_cdb_size*/
literal|0
argument_list|,
comment|/*lba*/
name|dstlba
operator|+
name|donebytes
operator|/
name|dstblock
argument_list|,
comment|/*num_blocks*/
name|roundbytes
operator|/
name|dstblock
argument_list|,
comment|/*tag_type*/
name|CTL_TAG_SIMPLE
argument_list|,
comment|/*control*/
literal|0
argument_list|)
expr_stmt|;
name|tiow
operator|->
name|io
operator|->
name|io_hdr
operator|.
name|retries
operator|=
literal|3
expr_stmt|;
name|tiow
operator|->
name|lun
operator|=
name|dl
expr_stmt|;
name|tiow
operator|->
name|io
operator|->
name|io_hdr
operator|.
name|ctl_private
index|[
name|CTL_PRIV_FRONTEND
index|]
operator|.
name|ptr
operator|=
name|tior
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|tior
operator|->
name|run
argument_list|,
name|tiow
argument_list|,
name|rlinks
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
name|prun
argument_list|,
name|tior
argument_list|,
name|rlinks
argument_list|)
expr_stmt|;
name|prun
operator|=
operator|&
name|tior
operator|->
name|run
expr_stmt|;
name|donebytes
operator|+=
name|roundbytes
expr_stmt|;
block|}
while|while
condition|(
operator|(
name|tior
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|run
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|run
argument_list|,
name|tior
argument_list|,
name|rlinks
argument_list|)
expr_stmt|;
if|if
condition|(
name|tpcl_queue
argument_list|(
name|tior
operator|->
name|io
argument_list|,
name|tior
operator|->
name|lun
argument_list|)
operator|!=
name|CTL_RETVAL_COMPLETE
condition|)
name|panic
argument_list|(
literal|"tpcl_queue() error"
argument_list|)
expr_stmt|;
block|}
name|list
operator|->
name|stage
operator|++
expr_stmt|;
return|return
operator|(
name|CTL_RETVAL_QUEUED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tpc_process_verify
parameter_list|(
name|struct
name|tpc_list
modifier|*
name|list
parameter_list|)
block|{
name|struct
name|scsi_ec_segment_verify
modifier|*
name|seg
decl_stmt|;
name|struct
name|tpc_io
modifier|*
name|tio
decl_stmt|;
name|uint64_t
name|sl
decl_stmt|;
if|if
condition|(
name|list
operator|->
name|stage
operator|==
literal|1
condition|)
block|{
name|complete
label|:
while|while
condition|(
operator|(
name|tio
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|list
operator|->
name|allio
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|list
operator|->
name|allio
argument_list|,
name|tio
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|ctl_free_io
argument_list|(
name|tio
operator|->
name|io
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tio
argument_list|,
name|M_CTL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|list
operator|->
name|abort
condition|)
block|{
name|ctl_set_task_aborted
argument_list|(
name|list
operator|->
name|ctsio
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_RETVAL_ERROR
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|list
operator|->
name|error
condition|)
block|{
name|ctl_set_sense
argument_list|(
name|list
operator|->
name|ctsio
argument_list|,
comment|/*current_error*/
literal|1
argument_list|,
comment|/*sense_key*/
name|SSD_KEY_COPY_ABORTED
argument_list|,
comment|/*asc*/
literal|0x0d
argument_list|,
comment|/*ascq*/
literal|0x01
argument_list|,
name|SSD_ELEM_NONE
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_RETVAL_ERROR
operator|)
return|;
block|}
else|else
return|return
operator|(
name|CTL_RETVAL_COMPLETE
operator|)
return|;
block|}
name|TAILQ_INIT
argument_list|(
operator|&
name|list
operator|->
name|allio
argument_list|)
expr_stmt|;
name|seg
operator|=
operator|(
expr|struct
name|scsi_ec_segment_verify
operator|*
operator|)
name|list
operator|->
name|seg
index|[
name|list
operator|->
name|curseg
index|]
expr_stmt|;
name|sl
operator|=
name|tpc_resolve
argument_list|(
name|list
argument_list|,
name|scsi_2btoul
argument_list|(
name|seg
operator|->
name|src_cscd
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|sl
operator|>=
name|CTL_MAX_LUNS
condition|)
block|{
name|ctl_set_sense
argument_list|(
name|list
operator|->
name|ctsio
argument_list|,
comment|/*current_error*/
literal|1
argument_list|,
comment|/*sense_key*/
name|SSD_KEY_COPY_ABORTED
argument_list|,
comment|/*asc*/
literal|0x08
argument_list|,
comment|/*ascq*/
literal|0x04
argument_list|,
name|SSD_ELEM_NONE
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_RETVAL_ERROR
operator|)
return|;
block|}
comment|//	printf("Verify %ju\n", sl);
if|if
condition|(
operator|(
name|seg
operator|->
name|tur
operator|&
literal|0x01
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
name|CTL_RETVAL_COMPLETE
operator|)
return|;
name|list
operator|->
name|tbdio
operator|=
literal|1
expr_stmt|;
name|tio
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|tio
argument_list|)
argument_list|,
name|M_CTL
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|tio
operator|->
name|run
argument_list|)
expr_stmt|;
name|tio
operator|->
name|list
operator|=
name|list
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|list
operator|->
name|allio
argument_list|,
name|tio
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|tio
operator|->
name|io
operator|=
name|tpcl_alloc_io
argument_list|()
expr_stmt|;
if|if
condition|(
name|tio
operator|->
name|io
operator|==
name|NULL
condition|)
block|{
name|list
operator|->
name|error
operator|=
literal|1
expr_stmt|;
goto|goto
name|complete
goto|;
block|}
name|ctl_scsi_tur
argument_list|(
name|tio
operator|->
name|io
argument_list|,
comment|/*tag_type*/
name|CTL_TAG_SIMPLE
argument_list|,
comment|/*control*/
literal|0
argument_list|)
expr_stmt|;
name|tio
operator|->
name|io
operator|->
name|io_hdr
operator|.
name|retries
operator|=
literal|3
expr_stmt|;
name|tio
operator|->
name|lun
operator|=
name|sl
expr_stmt|;
name|tio
operator|->
name|io
operator|->
name|io_hdr
operator|.
name|ctl_private
index|[
name|CTL_PRIV_FRONTEND
index|]
operator|.
name|ptr
operator|=
name|tio
expr_stmt|;
name|list
operator|->
name|stage
operator|++
expr_stmt|;
if|if
condition|(
name|tpcl_queue
argument_list|(
name|tio
operator|->
name|io
argument_list|,
name|tio
operator|->
name|lun
argument_list|)
operator|!=
name|CTL_RETVAL_COMPLETE
condition|)
name|panic
argument_list|(
literal|"tpcl_queue() error"
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_RETVAL_QUEUED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tpc_process_register_key
parameter_list|(
name|struct
name|tpc_list
modifier|*
name|list
parameter_list|)
block|{
name|struct
name|scsi_ec_segment_register_key
modifier|*
name|seg
decl_stmt|;
name|struct
name|tpc_io
modifier|*
name|tio
decl_stmt|;
name|uint64_t
name|dl
decl_stmt|;
name|int
name|datalen
decl_stmt|;
if|if
condition|(
name|list
operator|->
name|stage
operator|==
literal|1
condition|)
block|{
name|complete
label|:
while|while
condition|(
operator|(
name|tio
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|list
operator|->
name|allio
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|list
operator|->
name|allio
argument_list|,
name|tio
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|ctl_free_io
argument_list|(
name|tio
operator|->
name|io
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tio
argument_list|,
name|M_CTL
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|list
operator|->
name|buf
argument_list|,
name|M_CTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|list
operator|->
name|abort
condition|)
block|{
name|ctl_set_task_aborted
argument_list|(
name|list
operator|->
name|ctsio
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_RETVAL_ERROR
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|list
operator|->
name|error
condition|)
block|{
name|ctl_set_sense
argument_list|(
name|list
operator|->
name|ctsio
argument_list|,
comment|/*current_error*/
literal|1
argument_list|,
comment|/*sense_key*/
name|SSD_KEY_COPY_ABORTED
argument_list|,
comment|/*asc*/
literal|0x0d
argument_list|,
comment|/*ascq*/
literal|0x01
argument_list|,
name|SSD_ELEM_NONE
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_RETVAL_ERROR
operator|)
return|;
block|}
else|else
return|return
operator|(
name|CTL_RETVAL_COMPLETE
operator|)
return|;
block|}
name|TAILQ_INIT
argument_list|(
operator|&
name|list
operator|->
name|allio
argument_list|)
expr_stmt|;
name|seg
operator|=
operator|(
expr|struct
name|scsi_ec_segment_register_key
operator|*
operator|)
name|list
operator|->
name|seg
index|[
name|list
operator|->
name|curseg
index|]
expr_stmt|;
name|dl
operator|=
name|tpc_resolve
argument_list|(
name|list
argument_list|,
name|scsi_2btoul
argument_list|(
name|seg
operator|->
name|dst_cscd
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl
operator|>=
name|CTL_MAX_LUNS
condition|)
block|{
name|ctl_set_sense
argument_list|(
name|list
operator|->
name|ctsio
argument_list|,
comment|/*current_error*/
literal|1
argument_list|,
comment|/*sense_key*/
name|SSD_KEY_COPY_ABORTED
argument_list|,
comment|/*asc*/
literal|0x08
argument_list|,
comment|/*ascq*/
literal|0x04
argument_list|,
name|SSD_ELEM_NONE
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_RETVAL_ERROR
operator|)
return|;
block|}
comment|//	printf("Register Key %ju\n", dl);
name|list
operator|->
name|tbdio
operator|=
literal|1
expr_stmt|;
name|tio
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|tio
argument_list|)
argument_list|,
name|M_CTL
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|tio
operator|->
name|run
argument_list|)
expr_stmt|;
name|tio
operator|->
name|list
operator|=
name|list
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|list
operator|->
name|allio
argument_list|,
name|tio
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|tio
operator|->
name|io
operator|=
name|tpcl_alloc_io
argument_list|()
expr_stmt|;
if|if
condition|(
name|tio
operator|->
name|io
operator|==
name|NULL
condition|)
block|{
name|list
operator|->
name|error
operator|=
literal|1
expr_stmt|;
goto|goto
name|complete
goto|;
block|}
name|datalen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_per_res_out_parms
argument_list|)
expr_stmt|;
name|list
operator|->
name|buf
operator|=
name|malloc
argument_list|(
name|datalen
argument_list|,
name|M_CTL
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|ctl_scsi_persistent_res_out
argument_list|(
name|tio
operator|->
name|io
argument_list|,
name|list
operator|->
name|buf
argument_list|,
name|datalen
argument_list|,
name|SPRO_REGISTER
argument_list|,
operator|-
literal|1
argument_list|,
name|scsi_8btou64
argument_list|(
name|seg
operator|->
name|res_key
argument_list|)
argument_list|,
name|scsi_8btou64
argument_list|(
name|seg
operator|->
name|sa_res_key
argument_list|)
argument_list|,
comment|/*tag_type*/
name|CTL_TAG_SIMPLE
argument_list|,
comment|/*control*/
literal|0
argument_list|)
expr_stmt|;
name|tio
operator|->
name|io
operator|->
name|io_hdr
operator|.
name|retries
operator|=
literal|3
expr_stmt|;
name|tio
operator|->
name|lun
operator|=
name|dl
expr_stmt|;
name|tio
operator|->
name|io
operator|->
name|io_hdr
operator|.
name|ctl_private
index|[
name|CTL_PRIV_FRONTEND
index|]
operator|.
name|ptr
operator|=
name|tio
expr_stmt|;
name|list
operator|->
name|stage
operator|++
expr_stmt|;
if|if
condition|(
name|tpcl_queue
argument_list|(
name|tio
operator|->
name|io
argument_list|,
name|tio
operator|->
name|lun
argument_list|)
operator|!=
name|CTL_RETVAL_COMPLETE
condition|)
name|panic
argument_list|(
literal|"tpcl_queue() error"
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_RETVAL_QUEUED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|tpc_process
parameter_list|(
name|struct
name|tpc_list
modifier|*
name|list
parameter_list|)
block|{
name|struct
name|ctl_lun
modifier|*
name|lun
init|=
name|list
operator|->
name|lun
decl_stmt|;
name|struct
name|scsi_ec_segment
modifier|*
name|seg
decl_stmt|;
name|struct
name|ctl_scsiio
modifier|*
name|ctsio
init|=
name|list
operator|->
name|ctsio
decl_stmt|;
name|int
name|retval
init|=
name|CTL_RETVAL_COMPLETE
decl_stmt|;
comment|//printf("ZZZ %d cscd, %d segs\n", list->ncscd, list->nseg);
while|while
condition|(
name|list
operator|->
name|curseg
operator|<
name|list
operator|->
name|nseg
condition|)
block|{
name|seg
operator|=
name|list
operator|->
name|seg
index|[
name|list
operator|->
name|curseg
index|]
expr_stmt|;
switch|switch
condition|(
name|seg
operator|->
name|type_code
condition|)
block|{
case|case
name|EC_SEG_B2B
case|:
name|retval
operator|=
name|tpc_process_b2b
argument_list|(
name|list
argument_list|)
expr_stmt|;
break|break;
case|case
name|EC_SEG_VERIFY
case|:
name|retval
operator|=
name|tpc_process_verify
argument_list|(
name|list
argument_list|)
expr_stmt|;
break|break;
case|case
name|EC_SEG_REGISTER_KEY
case|:
name|retval
operator|=
name|tpc_process_register_key
argument_list|(
name|list
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ctl_set_sense
argument_list|(
name|ctsio
argument_list|,
comment|/*current_error*/
literal|1
argument_list|,
comment|/*sense_key*/
name|SSD_KEY_COPY_ABORTED
argument_list|,
comment|/*asc*/
literal|0x26
argument_list|,
comment|/*ascq*/
literal|0x09
argument_list|,
name|SSD_ELEM_NONE
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|retval
operator|==
name|CTL_RETVAL_QUEUED
condition|)
return|return;
if|if
condition|(
name|retval
operator|==
name|CTL_RETVAL_ERROR
condition|)
block|{
name|list
operator|->
name|error
operator|=
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|list
operator|->
name|curseg
operator|++
expr_stmt|;
name|list
operator|->
name|stage
operator|=
literal|0
expr_stmt|;
block|}
name|ctl_set_success
argument_list|(
name|ctsio
argument_list|)
expr_stmt|;
name|done
label|:
comment|//printf("ZZZ done\n");
name|mtx_lock
argument_list|(
operator|&
name|lun
operator|->
name|lun_lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|list
operator|->
name|flags
operator|&
name|EC_LIST_ID_USAGE_MASK
operator|)
operator|==
name|EC_LIST_ID_USAGE_NONE
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|lun
operator|->
name|tpc_lists
argument_list|,
name|list
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|list
argument_list|,
name|M_CTL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|list
operator|->
name|completed
operator|=
literal|1
expr_stmt|;
name|list
operator|->
name|sense_data
operator|=
name|ctsio
operator|->
name|sense_data
expr_stmt|;
name|list
operator|->
name|sense_len
operator|=
name|ctsio
operator|->
name|sense_len
expr_stmt|;
name|list
operator|->
name|scsi_status
operator|=
name|ctsio
operator|->
name|scsi_status
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|lun
operator|->
name|lun_lock
argument_list|)
expr_stmt|;
name|ctl_done
argument_list|(
operator|(
expr|union
name|ctl_io
operator|*
operator|)
name|ctsio
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * For any sort of check condition, busy, etc., we just retry.  We do not  * decrement the retry count for unit attention type errors.  These are  * normal, and we want to save the retry count for "real" errors.  Otherwise,  * we could end up with situations where a command will succeed in some  * situations and fail in others, depending on whether a unit attention is  * pending.  Also, some of our error recovery actions, most notably the  * LUN reset action, will cause a unit attention.  *  * We can add more detail here later if necessary.  */
end_comment

begin_function
specifier|static
name|tpc_error_action
name|tpc_checkcond_parse
parameter_list|(
name|union
name|ctl_io
modifier|*
name|io
parameter_list|)
block|{
name|tpc_error_action
name|error_action
decl_stmt|;
name|int
name|error_code
decl_stmt|,
name|sense_key
decl_stmt|,
name|asc
decl_stmt|,
name|ascq
decl_stmt|;
comment|/* 	 * Default to retrying the command. 	 */
name|error_action
operator|=
name|TPC_ERR_RETRY
expr_stmt|;
name|scsi_extract_sense_len
argument_list|(
operator|&
name|io
operator|->
name|scsiio
operator|.
name|sense_data
argument_list|,
name|io
operator|->
name|scsiio
operator|.
name|sense_len
argument_list|,
operator|&
name|error_code
argument_list|,
operator|&
name|sense_key
argument_list|,
operator|&
name|asc
argument_list|,
operator|&
name|ascq
argument_list|,
comment|/*show_errors*/
literal|1
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|error_code
condition|)
block|{
case|case
name|SSD_DEFERRED_ERROR
case|:
case|case
name|SSD_DESC_DEFERRED_ERROR
case|:
name|error_action
operator||=
name|TPC_ERR_NO_DECREMENT
expr_stmt|;
break|break;
case|case
name|SSD_CURRENT_ERROR
case|:
case|case
name|SSD_DESC_CURRENT_ERROR
case|:
default|default:
switch|switch
condition|(
name|sense_key
condition|)
block|{
case|case
name|SSD_KEY_UNIT_ATTENTION
case|:
name|error_action
operator||=
name|TPC_ERR_NO_DECREMENT
expr_stmt|;
break|break;
case|case
name|SSD_KEY_HARDWARE_ERROR
case|:
comment|/* 			 * This is our generic "something bad happened" 			 * error code.  It often isn't recoverable. 			 */
if|if
condition|(
operator|(
name|asc
operator|==
literal|0x44
operator|)
operator|&&
operator|(
name|ascq
operator|==
literal|0x00
operator|)
condition|)
name|error_action
operator|=
name|TPC_ERR_FAIL
expr_stmt|;
break|break;
case|case
name|SSD_KEY_NOT_READY
case|:
comment|/* 			 * If the LUN is powered down, there likely isn't 			 * much point in retrying right now. 			 */
if|if
condition|(
operator|(
name|asc
operator|==
literal|0x04
operator|)
operator|&&
operator|(
name|ascq
operator|==
literal|0x02
operator|)
condition|)
name|error_action
operator|=
name|TPC_ERR_FAIL
expr_stmt|;
comment|/* 			 * If the LUN is offline, there probably isn't much 			 * point in retrying, either. 			 */
if|if
condition|(
operator|(
name|asc
operator|==
literal|0x04
operator|)
operator|&&
operator|(
name|ascq
operator|==
literal|0x03
operator|)
condition|)
name|error_action
operator|=
name|TPC_ERR_FAIL
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
name|error_action
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|tpc_error_action
name|tpc_error_parse
parameter_list|(
name|union
name|ctl_io
modifier|*
name|io
parameter_list|)
block|{
name|tpc_error_action
name|error_action
init|=
name|TPC_ERR_RETRY
decl_stmt|;
switch|switch
condition|(
name|io
operator|->
name|io_hdr
operator|.
name|io_type
condition|)
block|{
case|case
name|CTL_IO_SCSI
case|:
switch|switch
condition|(
name|io
operator|->
name|io_hdr
operator|.
name|status
operator|&
name|CTL_STATUS_MASK
condition|)
block|{
case|case
name|CTL_SCSI_ERROR
case|:
switch|switch
condition|(
name|io
operator|->
name|scsiio
operator|.
name|scsi_status
condition|)
block|{
case|case
name|SCSI_STATUS_CHECK_COND
case|:
name|error_action
operator|=
name|tpc_checkcond_parse
argument_list|(
name|io
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
break|break;
default|default:
break|break;
block|}
break|break;
case|case
name|CTL_IO_TASK
case|:
break|break;
default|default:
name|panic
argument_list|(
literal|"%s: invalid ctl_io type %d\n"
argument_list|,
name|__func__
argument_list|,
name|io
operator|->
name|io_hdr
operator|.
name|io_type
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|error_action
operator|)
return|;
block|}
end_function

begin_function
name|void
name|tpc_done
parameter_list|(
name|union
name|ctl_io
modifier|*
name|io
parameter_list|)
block|{
name|struct
name|tpc_io
modifier|*
name|tio
decl_stmt|,
modifier|*
name|tior
decl_stmt|;
comment|/* 	 * Very minimal retry logic.  We basically retry if we got an error 	 * back, and the retry count is greater than 0.  If we ever want 	 * more sophisticated initiator type behavior, the CAM error 	 * recovery code in ../common might be helpful. 	 */
comment|//	if ((io->io_hdr.status& CTL_STATUS_MASK) != CTL_SUCCESS)
comment|//		ctl_io_error_print(io, NULL);
name|tio
operator|=
name|io
operator|->
name|io_hdr
operator|.
name|ctl_private
index|[
name|CTL_PRIV_FRONTEND
index|]
operator|.
name|ptr
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|io
operator|->
name|io_hdr
operator|.
name|status
operator|&
name|CTL_STATUS_MASK
operator|)
operator|!=
name|CTL_SUCCESS
operator|)
operator|&&
operator|(
name|io
operator|->
name|io_hdr
operator|.
name|retries
operator|>
literal|0
operator|)
condition|)
block|{
name|ctl_io_status
name|old_status
decl_stmt|;
name|tpc_error_action
name|error_action
decl_stmt|;
name|error_action
operator|=
name|tpc_error_parse
argument_list|(
name|io
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|error_action
operator|&
name|TPC_ERR_MASK
condition|)
block|{
case|case
name|TPC_ERR_FAIL
case|:
break|break;
case|case
name|TPC_ERR_RETRY
case|:
default|default:
if|if
condition|(
operator|(
name|error_action
operator|&
name|TPC_ERR_NO_DECREMENT
operator|)
operator|==
literal|0
condition|)
name|io
operator|->
name|io_hdr
operator|.
name|retries
operator|--
expr_stmt|;
name|old_status
operator|=
name|io
operator|->
name|io_hdr
operator|.
name|status
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|status
operator|=
name|CTL_STATUS_NONE
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|flags
operator|&=
operator|~
name|CTL_FLAG_ABORT
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|flags
operator|&=
operator|~
name|CTL_FLAG_SENT_2OTHER_SC
expr_stmt|;
if|if
condition|(
name|tpcl_queue
argument_list|(
name|io
argument_list|,
name|tio
operator|->
name|lun
argument_list|)
operator|!=
name|CTL_RETVAL_COMPLETE
condition|)
block|{
name|printf
argument_list|(
literal|"%s: error returned from ctl_queue()!\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|io
operator|->
name|io_hdr
operator|.
name|status
operator|=
name|old_status
expr_stmt|;
block|}
else|else
return|return;
block|}
block|}
if|if
condition|(
operator|(
name|io
operator|->
name|io_hdr
operator|.
name|status
operator|&
name|CTL_STATUS_MASK
operator|)
operator|!=
name|CTL_SUCCESS
condition|)
name|tio
operator|->
name|list
operator|->
name|error
operator|=
literal|1
expr_stmt|;
else|else
name|atomic_add_int
argument_list|(
operator|&
name|tio
operator|->
name|list
operator|->
name|curops
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tio
operator|->
name|list
operator|->
name|error
operator|&&
operator|!
name|tio
operator|->
name|list
operator|->
name|abort
condition|)
block|{
while|while
condition|(
operator|(
name|tior
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|tio
operator|->
name|run
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|tio
operator|->
name|run
argument_list|,
name|tior
argument_list|,
name|rlinks
argument_list|)
expr_stmt|;
name|atomic_add_int
argument_list|(
operator|&
name|tio
operator|->
name|list
operator|->
name|tbdio
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|tpcl_queue
argument_list|(
name|tior
operator|->
name|io
argument_list|,
name|tior
operator|->
name|lun
argument_list|)
operator|!=
name|CTL_RETVAL_COMPLETE
condition|)
name|panic
argument_list|(
literal|"tpcl_queue() error"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|atomic_fetchadd_int
argument_list|(
operator|&
name|tio
operator|->
name|list
operator|->
name|tbdio
argument_list|,
operator|-
literal|1
argument_list|)
operator|==
literal|1
condition|)
name|tpc_process
argument_list|(
name|tio
operator|->
name|list
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ctl_extended_copy_lid1
parameter_list|(
name|struct
name|ctl_scsiio
modifier|*
name|ctsio
parameter_list|)
block|{
name|struct
name|scsi_extended_copy
modifier|*
name|cdb
decl_stmt|;
name|struct
name|scsi_extended_copy_lid1_data
modifier|*
name|data
decl_stmt|;
name|struct
name|ctl_lun
modifier|*
name|lun
decl_stmt|;
name|struct
name|tpc_list
modifier|*
name|list
decl_stmt|,
modifier|*
name|tlist
decl_stmt|;
name|uint8_t
modifier|*
name|ptr
decl_stmt|;
name|char
modifier|*
name|value
decl_stmt|;
name|int
name|len
decl_stmt|,
name|off
decl_stmt|,
name|lencscd
decl_stmt|,
name|lenseg
decl_stmt|,
name|leninl
decl_stmt|,
name|nseg
decl_stmt|;
name|CTL_DEBUG_PRINT
argument_list|(
operator|(
literal|"ctl_extended_copy_lid1\n"
operator|)
argument_list|)
expr_stmt|;
name|lun
operator|=
operator|(
expr|struct
name|ctl_lun
operator|*
operator|)
name|ctsio
operator|->
name|io_hdr
operator|.
name|ctl_private
index|[
name|CTL_PRIV_LUN
index|]
operator|.
name|ptr
expr_stmt|;
name|cdb
operator|=
operator|(
expr|struct
name|scsi_extended_copy
operator|*
operator|)
name|ctsio
operator|->
name|cdb
expr_stmt|;
name|len
operator|=
name|scsi_4btoul
argument_list|(
name|cdb
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_extended_copy_lid1_data
argument_list|)
operator|||
name|len
operator|>
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_extended_copy_lid1_data
argument_list|)
operator|+
name|TPC_MAX_LIST
operator|+
name|TPC_MAX_INLINE
condition|)
block|{
name|ctl_set_invalid_field
argument_list|(
name|ctsio
argument_list|,
comment|/*sks_valid*/
literal|1
argument_list|,
comment|/*command*/
literal|1
argument_list|,
comment|/*field*/
literal|9
argument_list|,
comment|/*bit_valid*/
literal|0
argument_list|,
comment|/*bit*/
literal|0
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* 	 * If we've got a kernel request that hasn't been malloced yet, 	 * malloc it and tell the caller the data buffer is here. 	 */
if|if
condition|(
operator|(
name|ctsio
operator|->
name|io_hdr
operator|.
name|flags
operator|&
name|CTL_FLAG_ALLOCATED
operator|)
operator|==
literal|0
condition|)
block|{
name|ctsio
operator|->
name|kern_data_ptr
operator|=
name|malloc
argument_list|(
name|len
argument_list|,
name|M_CTL
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|ctsio
operator|->
name|kern_data_len
operator|=
name|len
expr_stmt|;
name|ctsio
operator|->
name|kern_total_len
operator|=
name|len
expr_stmt|;
name|ctsio
operator|->
name|kern_data_resid
operator|=
literal|0
expr_stmt|;
name|ctsio
operator|->
name|kern_rel_offset
operator|=
literal|0
expr_stmt|;
name|ctsio
operator|->
name|kern_sg_entries
operator|=
literal|0
expr_stmt|;
name|ctsio
operator|->
name|io_hdr
operator|.
name|flags
operator||=
name|CTL_FLAG_ALLOCATED
expr_stmt|;
name|ctsio
operator|->
name|be_move_done
operator|=
name|ctl_config_move_done
expr_stmt|;
name|ctl_datamove
argument_list|(
operator|(
expr|union
name|ctl_io
operator|*
operator|)
name|ctsio
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_RETVAL_COMPLETE
operator|)
return|;
block|}
name|data
operator|=
operator|(
expr|struct
name|scsi_extended_copy_lid1_data
operator|*
operator|)
name|ctsio
operator|->
name|kern_data_ptr
expr_stmt|;
name|lencscd
operator|=
name|scsi_2btoul
argument_list|(
name|data
operator|->
name|cscd_list_length
argument_list|)
expr_stmt|;
name|lenseg
operator|=
name|scsi_4btoul
argument_list|(
name|data
operator|->
name|segment_list_length
argument_list|)
expr_stmt|;
name|leninl
operator|=
name|scsi_4btoul
argument_list|(
name|data
operator|->
name|inline_data_length
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_extended_copy_lid1_data
argument_list|)
operator|+
name|lencscd
operator|+
name|lenseg
operator|+
name|leninl
operator|||
name|leninl
operator|>
name|TPC_MAX_INLINE
condition|)
block|{
name|ctl_set_invalid_field
argument_list|(
name|ctsio
argument_list|,
comment|/*sks_valid*/
literal|1
argument_list|,
comment|/*command*/
literal|0
argument_list|,
comment|/*field*/
literal|2
argument_list|,
comment|/*bit_valid*/
literal|0
argument_list|,
comment|/*bit*/
literal|0
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|lencscd
operator|>
name|TPC_MAX_CSCDS
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_ec_cscd
argument_list|)
condition|)
block|{
name|ctl_set_sense
argument_list|(
name|ctsio
argument_list|,
comment|/*current_error*/
literal|1
argument_list|,
comment|/*sense_key*/
name|SSD_KEY_ILLEGAL_REQUEST
argument_list|,
comment|/*asc*/
literal|0x26
argument_list|,
comment|/*ascq*/
literal|0x06
argument_list|,
name|SSD_ELEM_NONE
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|lencscd
operator|+
name|lenseg
operator|>
name|TPC_MAX_LIST
condition|)
block|{
name|ctl_set_param_len_error
argument_list|(
name|ctsio
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|list
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|tpc_list
argument_list|)
argument_list|,
name|M_CTL
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|list
operator|->
name|service_action
operator|=
name|cdb
operator|->
name|service_action
expr_stmt|;
name|value
operator|=
name|ctl_get_opt
argument_list|(
operator|&
name|lun
operator|->
name|be_lun
operator|->
name|options
argument_list|,
literal|"insecure_tpc"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|value
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|list
operator|->
name|init_port
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|list
operator|->
name|init_port
operator|=
name|ctsio
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|targ_port
expr_stmt|;
name|list
operator|->
name|init_idx
operator|=
name|ctl_get_resindex
argument_list|(
operator|&
name|ctsio
operator|->
name|io_hdr
operator|.
name|nexus
argument_list|)
expr_stmt|;
name|list
operator|->
name|list_id
operator|=
name|data
operator|->
name|list_identifier
expr_stmt|;
name|list
operator|->
name|flags
operator|=
name|data
operator|->
name|flags
expr_stmt|;
name|list
operator|->
name|params
operator|=
name|ctsio
operator|->
name|kern_data_ptr
expr_stmt|;
name|list
operator|->
name|cscd
operator|=
operator|(
expr|struct
name|scsi_ec_cscd
operator|*
operator|)
operator|&
name|data
operator|->
name|data
index|[
literal|0
index|]
expr_stmt|;
name|ptr
operator|=
operator|&
name|data
operator|->
name|data
index|[
name|lencscd
index|]
expr_stmt|;
for|for
control|(
name|nseg
operator|=
literal|0
operator|,
name|off
operator|=
literal|0
init|;
name|off
operator|<
name|lenseg
condition|;
name|nseg
operator|++
control|)
block|{
if|if
condition|(
name|nseg
operator|>=
name|TPC_MAX_SEGS
condition|)
block|{
name|free
argument_list|(
name|list
argument_list|,
name|M_CTL
argument_list|)
expr_stmt|;
name|ctl_set_sense
argument_list|(
name|ctsio
argument_list|,
comment|/*current_error*/
literal|1
argument_list|,
comment|/*sense_key*/
name|SSD_KEY_ILLEGAL_REQUEST
argument_list|,
comment|/*asc*/
literal|0x26
argument_list|,
comment|/*ascq*/
literal|0x08
argument_list|,
name|SSD_ELEM_NONE
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|list
operator|->
name|seg
index|[
name|nseg
index|]
operator|=
operator|(
expr|struct
name|scsi_ec_segment
operator|*
operator|)
operator|(
name|ptr
operator|+
name|off
operator|)
expr_stmt|;
name|off
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_ec_segment
argument_list|)
operator|+
name|scsi_2btoul
argument_list|(
name|list
operator|->
name|seg
index|[
name|nseg
index|]
operator|->
name|descr_length
argument_list|)
expr_stmt|;
block|}
name|list
operator|->
name|inl
operator|=
operator|&
name|data
operator|->
name|data
index|[
name|lencscd
operator|+
name|lenseg
index|]
expr_stmt|;
name|list
operator|->
name|ncscd
operator|=
name|lencscd
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_ec_cscd
argument_list|)
expr_stmt|;
name|list
operator|->
name|nseg
operator|=
name|nseg
expr_stmt|;
name|list
operator|->
name|leninl
operator|=
name|leninl
expr_stmt|;
name|list
operator|->
name|ctsio
operator|=
name|ctsio
expr_stmt|;
name|list
operator|->
name|lun
operator|=
name|lun
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|lun
operator|->
name|lun_lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|list
operator|->
name|flags
operator|&
name|EC_LIST_ID_USAGE_MASK
operator|)
operator|!=
name|EC_LIST_ID_USAGE_NONE
condition|)
block|{
name|tlist
operator|=
name|tpc_find_list
argument_list|(
name|lun
argument_list|,
name|list
operator|->
name|list_id
argument_list|,
name|list
operator|->
name|init_idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlist
operator|!=
name|NULL
operator|&&
operator|!
name|tlist
operator|->
name|completed
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|lun
operator|->
name|lun_lock
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|list
argument_list|,
name|M_CTL
argument_list|)
expr_stmt|;
name|ctl_set_invalid_field
argument_list|(
name|ctsio
argument_list|,
comment|/*sks_valid*/
literal|1
argument_list|,
comment|/*command*/
literal|0
argument_list|,
comment|/*field*/
literal|0
argument_list|,
comment|/*bit_valid*/
literal|0
argument_list|,
comment|/*bit*/
literal|0
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|tlist
operator|!=
name|NULL
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|lun
operator|->
name|tpc_lists
argument_list|,
name|tlist
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tlist
argument_list|,
name|M_CTL
argument_list|)
expr_stmt|;
block|}
block|}
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|lun
operator|->
name|tpc_lists
argument_list|,
name|list
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|lun
operator|->
name|lun_lock
argument_list|)
expr_stmt|;
name|tpc_process
argument_list|(
name|list
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_RETVAL_COMPLETE
operator|)
return|;
name|done
label|:
name|ctl_done
argument_list|(
operator|(
expr|union
name|ctl_io
operator|*
operator|)
name|ctsio
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_RETVAL_COMPLETE
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ctl_extended_copy_lid4
parameter_list|(
name|struct
name|ctl_scsiio
modifier|*
name|ctsio
parameter_list|)
block|{
name|struct
name|scsi_extended_copy
modifier|*
name|cdb
decl_stmt|;
name|struct
name|scsi_extended_copy_lid4_data
modifier|*
name|data
decl_stmt|;
name|struct
name|ctl_lun
modifier|*
name|lun
decl_stmt|;
name|struct
name|tpc_list
modifier|*
name|list
decl_stmt|,
modifier|*
name|tlist
decl_stmt|;
name|uint8_t
modifier|*
name|ptr
decl_stmt|;
name|char
modifier|*
name|value
decl_stmt|;
name|int
name|len
decl_stmt|,
name|off
decl_stmt|,
name|lencscd
decl_stmt|,
name|lenseg
decl_stmt|,
name|leninl
decl_stmt|,
name|nseg
decl_stmt|;
name|CTL_DEBUG_PRINT
argument_list|(
operator|(
literal|"ctl_extended_copy_lid4\n"
operator|)
argument_list|)
expr_stmt|;
name|lun
operator|=
operator|(
expr|struct
name|ctl_lun
operator|*
operator|)
name|ctsio
operator|->
name|io_hdr
operator|.
name|ctl_private
index|[
name|CTL_PRIV_LUN
index|]
operator|.
name|ptr
expr_stmt|;
name|cdb
operator|=
operator|(
expr|struct
name|scsi_extended_copy
operator|*
operator|)
name|ctsio
operator|->
name|cdb
expr_stmt|;
name|len
operator|=
name|scsi_4btoul
argument_list|(
name|cdb
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_extended_copy_lid4_data
argument_list|)
operator|||
name|len
operator|>
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_extended_copy_lid4_data
argument_list|)
operator|+
name|TPC_MAX_LIST
operator|+
name|TPC_MAX_INLINE
condition|)
block|{
name|ctl_set_invalid_field
argument_list|(
name|ctsio
argument_list|,
comment|/*sks_valid*/
literal|1
argument_list|,
comment|/*command*/
literal|1
argument_list|,
comment|/*field*/
literal|9
argument_list|,
comment|/*bit_valid*/
literal|0
argument_list|,
comment|/*bit*/
literal|0
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* 	 * If we've got a kernel request that hasn't been malloced yet, 	 * malloc it and tell the caller the data buffer is here. 	 */
if|if
condition|(
operator|(
name|ctsio
operator|->
name|io_hdr
operator|.
name|flags
operator|&
name|CTL_FLAG_ALLOCATED
operator|)
operator|==
literal|0
condition|)
block|{
name|ctsio
operator|->
name|kern_data_ptr
operator|=
name|malloc
argument_list|(
name|len
argument_list|,
name|M_CTL
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|ctsio
operator|->
name|kern_data_len
operator|=
name|len
expr_stmt|;
name|ctsio
operator|->
name|kern_total_len
operator|=
name|len
expr_stmt|;
name|ctsio
operator|->
name|kern_data_resid
operator|=
literal|0
expr_stmt|;
name|ctsio
operator|->
name|kern_rel_offset
operator|=
literal|0
expr_stmt|;
name|ctsio
operator|->
name|kern_sg_entries
operator|=
literal|0
expr_stmt|;
name|ctsio
operator|->
name|io_hdr
operator|.
name|flags
operator||=
name|CTL_FLAG_ALLOCATED
expr_stmt|;
name|ctsio
operator|->
name|be_move_done
operator|=
name|ctl_config_move_done
expr_stmt|;
name|ctl_datamove
argument_list|(
operator|(
expr|union
name|ctl_io
operator|*
operator|)
name|ctsio
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_RETVAL_COMPLETE
operator|)
return|;
block|}
name|data
operator|=
operator|(
expr|struct
name|scsi_extended_copy_lid4_data
operator|*
operator|)
name|ctsio
operator|->
name|kern_data_ptr
expr_stmt|;
name|lencscd
operator|=
name|scsi_2btoul
argument_list|(
name|data
operator|->
name|cscd_list_length
argument_list|)
expr_stmt|;
name|lenseg
operator|=
name|scsi_2btoul
argument_list|(
name|data
operator|->
name|segment_list_length
argument_list|)
expr_stmt|;
name|leninl
operator|=
name|scsi_2btoul
argument_list|(
name|data
operator|->
name|inline_data_length
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_extended_copy_lid4_data
argument_list|)
operator|+
name|lencscd
operator|+
name|lenseg
operator|+
name|leninl
operator|||
name|leninl
operator|>
name|TPC_MAX_INLINE
condition|)
block|{
name|ctl_set_invalid_field
argument_list|(
name|ctsio
argument_list|,
comment|/*sks_valid*/
literal|1
argument_list|,
comment|/*command*/
literal|0
argument_list|,
comment|/*field*/
literal|2
argument_list|,
comment|/*bit_valid*/
literal|0
argument_list|,
comment|/*bit*/
literal|0
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|lencscd
operator|>
name|TPC_MAX_CSCDS
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_ec_cscd
argument_list|)
condition|)
block|{
name|ctl_set_sense
argument_list|(
name|ctsio
argument_list|,
comment|/*current_error*/
literal|1
argument_list|,
comment|/*sense_key*/
name|SSD_KEY_ILLEGAL_REQUEST
argument_list|,
comment|/*asc*/
literal|0x26
argument_list|,
comment|/*ascq*/
literal|0x06
argument_list|,
name|SSD_ELEM_NONE
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|lencscd
operator|+
name|lenseg
operator|>
name|TPC_MAX_LIST
condition|)
block|{
name|ctl_set_param_len_error
argument_list|(
name|ctsio
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|list
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|tpc_list
argument_list|)
argument_list|,
name|M_CTL
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|list
operator|->
name|service_action
operator|=
name|cdb
operator|->
name|service_action
expr_stmt|;
name|value
operator|=
name|ctl_get_opt
argument_list|(
operator|&
name|lun
operator|->
name|be_lun
operator|->
name|options
argument_list|,
literal|"insecure_tpc"
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|!=
name|NULL
operator|&&
name|strcmp
argument_list|(
name|value
argument_list|,
literal|"on"
argument_list|)
operator|==
literal|0
condition|)
name|list
operator|->
name|init_port
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|list
operator|->
name|init_port
operator|=
name|ctsio
operator|->
name|io_hdr
operator|.
name|nexus
operator|.
name|targ_port
expr_stmt|;
name|list
operator|->
name|init_idx
operator|=
name|ctl_get_resindex
argument_list|(
operator|&
name|ctsio
operator|->
name|io_hdr
operator|.
name|nexus
argument_list|)
expr_stmt|;
name|list
operator|->
name|list_id
operator|=
name|scsi_4btoul
argument_list|(
name|data
operator|->
name|list_identifier
argument_list|)
expr_stmt|;
name|list
operator|->
name|flags
operator|=
name|data
operator|->
name|flags
expr_stmt|;
name|list
operator|->
name|params
operator|=
name|ctsio
operator|->
name|kern_data_ptr
expr_stmt|;
name|list
operator|->
name|cscd
operator|=
operator|(
expr|struct
name|scsi_ec_cscd
operator|*
operator|)
operator|&
name|data
operator|->
name|data
index|[
literal|0
index|]
expr_stmt|;
name|ptr
operator|=
operator|&
name|data
operator|->
name|data
index|[
name|lencscd
index|]
expr_stmt|;
for|for
control|(
name|nseg
operator|=
literal|0
operator|,
name|off
operator|=
literal|0
init|;
name|off
operator|<
name|lenseg
condition|;
name|nseg
operator|++
control|)
block|{
if|if
condition|(
name|nseg
operator|>=
name|TPC_MAX_SEGS
condition|)
block|{
name|free
argument_list|(
name|list
argument_list|,
name|M_CTL
argument_list|)
expr_stmt|;
name|ctl_set_sense
argument_list|(
name|ctsio
argument_list|,
comment|/*current_error*/
literal|1
argument_list|,
comment|/*sense_key*/
name|SSD_KEY_ILLEGAL_REQUEST
argument_list|,
comment|/*asc*/
literal|0x26
argument_list|,
comment|/*ascq*/
literal|0x08
argument_list|,
name|SSD_ELEM_NONE
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|list
operator|->
name|seg
index|[
name|nseg
index|]
operator|=
operator|(
expr|struct
name|scsi_ec_segment
operator|*
operator|)
operator|(
name|ptr
operator|+
name|off
operator|)
expr_stmt|;
name|off
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_ec_segment
argument_list|)
operator|+
name|scsi_2btoul
argument_list|(
name|list
operator|->
name|seg
index|[
name|nseg
index|]
operator|->
name|descr_length
argument_list|)
expr_stmt|;
block|}
name|list
operator|->
name|inl
operator|=
operator|&
name|data
operator|->
name|data
index|[
name|lencscd
operator|+
name|lenseg
index|]
expr_stmt|;
name|list
operator|->
name|ncscd
operator|=
name|lencscd
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|scsi_ec_cscd
argument_list|)
expr_stmt|;
name|list
operator|->
name|nseg
operator|=
name|nseg
expr_stmt|;
name|list
operator|->
name|leninl
operator|=
name|leninl
expr_stmt|;
name|list
operator|->
name|ctsio
operator|=
name|ctsio
expr_stmt|;
name|list
operator|->
name|lun
operator|=
name|lun
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|lun
operator|->
name|lun_lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|list
operator|->
name|flags
operator|&
name|EC_LIST_ID_USAGE_MASK
operator|)
operator|!=
name|EC_LIST_ID_USAGE_NONE
condition|)
block|{
name|tlist
operator|=
name|tpc_find_list
argument_list|(
name|lun
argument_list|,
name|list
operator|->
name|list_id
argument_list|,
name|list
operator|->
name|init_idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlist
operator|!=
name|NULL
operator|&&
operator|!
name|tlist
operator|->
name|completed
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|lun
operator|->
name|lun_lock
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|list
argument_list|,
name|M_CTL
argument_list|)
expr_stmt|;
name|ctl_set_invalid_field
argument_list|(
name|ctsio
argument_list|,
comment|/*sks_valid*/
literal|1
argument_list|,
comment|/*command*/
literal|0
argument_list|,
comment|/*field*/
literal|0
argument_list|,
comment|/*bit_valid*/
literal|0
argument_list|,
comment|/*bit*/
literal|0
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|tlist
operator|!=
name|NULL
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|lun
operator|->
name|tpc_lists
argument_list|,
name|tlist
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tlist
argument_list|,
name|M_CTL
argument_list|)
expr_stmt|;
block|}
block|}
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|lun
operator|->
name|tpc_lists
argument_list|,
name|list
argument_list|,
name|links
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|lun
operator|->
name|lun_lock
argument_list|)
expr_stmt|;
name|tpc_process
argument_list|(
name|list
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_RETVAL_COMPLETE
operator|)
return|;
name|done
label|:
name|ctl_done
argument_list|(
operator|(
expr|union
name|ctl_io
operator|*
operator|)
name|ctsio
argument_list|)
expr_stmt|;
return|return
operator|(
name|CTL_RETVAL_COMPLETE
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* -*- mode: c; tab-width: 8; c-basic-indent: 4; -*- */
end_comment

begin_comment
comment|/*     Alias.c provides supervisory control for the functions of the     packet aliasing software.  It consists of routines to monitor     TCP connection state, protocol-specific aliasing routines,     fragment handling and the following outside world functional     interfaces: SaveFragmentPtr, GetFragmentPtr, FragmentAliasIn,     PacketAliasIn and PacketAliasOut.      The other C program files are briefly described. The data     structure framework which holds information needed to translate     packets is encapsulated in alias_db.c.  Data is accessed by     function calls, so other segments of the program need not know     about the underlying data structures.  Alias_ftp.c contains     special code for modifying the ftp PORT command used to establish     data connections, while alias_irc.c does the same for IRC     DCC. Alias_util.c contains a few utility routines.      This software is placed into the public domain with no restrictions     on its distribution.      Version 1.0 August, 1996  (cjm)      Version 1.1 August 20, 1996  (cjm)         PPP host accepts incoming connections for ports 0 to 1023.         (Gary Roberts pointed out the need to handle incoming          connections.)      Version 1.2 September 7, 1996 (cjm)         Fragment handling error in alias_db.c corrected.         (Tom Torrance helped fix this problem.)      Version 1.4 September 16, 1996 (cjm)         - A more generalized method for handling incoming           connections, without the 0-1023 restriction, is           implemented in alias_db.c         - Improved ICMP support in alias.c.  Traceroute           packet streams can now be correctly aliased.         - TCP connection closing logic simplified in           alias.c and now allows for additional 1 minute           "grace period" after FIN or RST is observed.      Version 1.5 September 17, 1996 (cjm)         Corrected error in handling incoming UDP packets with 0 checksum.         (Tom Torrance helped fix this problem.)      Version 1.6 September 18, 1996 (cjm)         Simplified ICMP aliasing scheme.  Should now support         traceroute from Win95 as well as FreeBSD.      Version 1.7 January 9, 1997 (cjm)         - Out-of-order fragment handling.         - IP checksum error fixed for ftp transfers           from aliasing host.         - Integer return codes added to all           aliasing/de-aliasing functions.         - Some obsolete comments cleaned up.         - Differential checksum computations for           IP header (TCP, UDP and ICMP were already           differential).      Version 2.1 May 1997 (cjm)         - Added support for outgoing ICMP error           messages.         - Added two functions PacketAliasIn2()           and PacketAliasOut2() for dynamic address           control (e.g. round-robin allocation of           incoming packets).      Version 2.2 July 1997 (cjm)         - Rationalized API function names to begin           with "PacketAlias..."         - Eliminated PacketAliasIn2() and           PacketAliasOut2() as poorly conceived.      Version 2.3 Dec 1998 (dillon) 	- Major bounds checking additions, see FreeBSD/CVS      Version 3.1 May, 2000 (eds) 	- Added hooks to handle PPTP.      See HISTORY file for additional revisions.      $FreeBSD$ */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip_icmp.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp.h>
end_include

begin_include
include|#
directive|include
file|<netinet/udp.h>
end_include

begin_include
include|#
directive|include
file|"alias_local.h"
end_include

begin_include
include|#
directive|include
file|"alias.h"
end_include

begin_define
define|#
directive|define
name|NETBIOS_NS_PORT_NUMBER
value|137
end_define

begin_define
define|#
directive|define
name|NETBIOS_DGM_PORT_NUMBER
value|138
end_define

begin_define
define|#
directive|define
name|FTP_CONTROL_PORT_NUMBER
value|21
end_define

begin_define
define|#
directive|define
name|IRC_CONTROL_PORT_NUMBER_1
value|6667
end_define

begin_define
define|#
directive|define
name|IRC_CONTROL_PORT_NUMBER_2
value|6668
end_define

begin_define
define|#
directive|define
name|CUSEEME_PORT_NUMBER
value|7648
end_define

begin_define
define|#
directive|define
name|PPTP_CONTROL_PORT_NUMBER
value|1723
end_define

begin_comment
comment|/* TCP Handling Routines      TcpMonitorIn()  -- These routines monitor TCP connections, and     TcpMonitorOut()    delete a link when a connection is closed.  These routines look for SYN, FIN and RST flags to determine when TCP connections open and close.  When a TCP connection closes, the data structure containing packet aliasing information is deleted after a timeout period. */
end_comment

begin_comment
comment|/* Local prototypes */
end_comment

begin_function_decl
specifier|static
name|void
name|TcpMonitorIn
parameter_list|(
name|struct
name|ip
modifier|*
parameter_list|,
name|struct
name|alias_link
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|TcpMonitorOut
parameter_list|(
name|struct
name|ip
modifier|*
parameter_list|,
name|struct
name|alias_link
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|TcpMonitorIn
parameter_list|(
name|struct
name|ip
modifier|*
name|pip
parameter_list|,
name|struct
name|alias_link
modifier|*
name|link
parameter_list|)
block|{
name|struct
name|tcphdr
modifier|*
name|tc
decl_stmt|;
name|tc
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
switch|switch
condition|(
name|GetStateIn
argument_list|(
name|link
argument_list|)
condition|)
block|{
case|case
name|ALIAS_TCP_STATE_NOT_CONNECTED
case|:
if|if
condition|(
name|tc
operator|->
name|th_flags
operator|&
name|TH_RST
condition|)
name|SetStateIn
argument_list|(
name|link
argument_list|,
name|ALIAS_TCP_STATE_DISCONNECTED
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|tc
operator|->
name|th_flags
operator|&
name|TH_SYN
condition|)
name|SetStateIn
argument_list|(
name|link
argument_list|,
name|ALIAS_TCP_STATE_CONNECTED
argument_list|)
expr_stmt|;
break|break;
case|case
name|ALIAS_TCP_STATE_CONNECTED
case|:
if|if
condition|(
name|tc
operator|->
name|th_flags
operator|&
operator|(
name|TH_FIN
operator||
name|TH_RST
operator|)
condition|)
name|SetStateIn
argument_list|(
name|link
argument_list|,
name|ALIAS_TCP_STATE_DISCONNECTED
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|TcpMonitorOut
parameter_list|(
name|struct
name|ip
modifier|*
name|pip
parameter_list|,
name|struct
name|alias_link
modifier|*
name|link
parameter_list|)
block|{
name|struct
name|tcphdr
modifier|*
name|tc
decl_stmt|;
name|tc
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
switch|switch
condition|(
name|GetStateOut
argument_list|(
name|link
argument_list|)
condition|)
block|{
case|case
name|ALIAS_TCP_STATE_NOT_CONNECTED
case|:
if|if
condition|(
name|tc
operator|->
name|th_flags
operator|&
name|TH_RST
condition|)
name|SetStateOut
argument_list|(
name|link
argument_list|,
name|ALIAS_TCP_STATE_DISCONNECTED
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|tc
operator|->
name|th_flags
operator|&
name|TH_SYN
condition|)
name|SetStateOut
argument_list|(
name|link
argument_list|,
name|ALIAS_TCP_STATE_CONNECTED
argument_list|)
expr_stmt|;
break|break;
case|case
name|ALIAS_TCP_STATE_CONNECTED
case|:
if|if
condition|(
name|tc
operator|->
name|th_flags
operator|&
operator|(
name|TH_FIN
operator||
name|TH_RST
operator|)
condition|)
name|SetStateOut
argument_list|(
name|link
argument_list|,
name|ALIAS_TCP_STATE_DISCONNECTED
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/* Protocol Specific Packet Aliasing Routines       IcmpAliasIn(), IcmpAliasIn1(), IcmpAliasIn2(), IcmpAliasIn3()     IcmpAliasOut(), IcmpAliasOut1(), IcmpAliasOut2(), IcmpAliasOut3()     ProtoAliasIn(), ProtoAliasOut()     UdpAliasIn(), UdpAliasOut()     TcpAliasIn(), TcpAliasOut()     GreAliasIn()  These routines handle protocol specific details of packet aliasing. One may observe a certain amount of repetitive arithmetic in these functions, the purpose of which is to compute a revised checksum without actually summing over the entire data packet, which could be unnecessarily time consuming.  The purpose of the packet aliasing routines is to replace the source address of the outgoing packet and then correctly put it back for any incoming packets.  For TCP and UDP, ports are also re-mapped.  For ICMP echo/timestamp requests and replies, the following scheme is used: the ID number is replaced by an alias for the outgoing packet.  ICMP error messages are handled by looking at the IP fragment in the data section of the message.  For TCP and UDP protocols, a port number is chosen for an outgoing packet, and then incoming packets are identified by IP address and port numbers.  For TCP packets, there is additional logic in the event that sequence and ACK numbers have been altered (as in the case for FTP data port commands).  The port numbers used by the packet aliasing module are not true ports in the Unix sense.  No sockets are actually bound to ports. They are more correctly thought of as placeholders.  All packets go through the aliasing mechanism, whether they come from the gateway machine or other machines on a local area network. */
end_comment

begin_comment
comment|/* Local prototypes */
end_comment

begin_function_decl
specifier|static
name|int
name|IcmpAliasIn1
parameter_list|(
name|struct
name|ip
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|IcmpAliasIn2
parameter_list|(
name|struct
name|ip
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|IcmpAliasIn3
parameter_list|(
name|struct
name|ip
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|IcmpAliasIn
parameter_list|(
name|struct
name|ip
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|IcmpAliasOut1
parameter_list|(
name|struct
name|ip
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|IcmpAliasOut2
parameter_list|(
name|struct
name|ip
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|IcmpAliasOut3
parameter_list|(
name|struct
name|ip
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|IcmpAliasOut
parameter_list|(
name|struct
name|ip
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ProtoAliasIn
parameter_list|(
name|struct
name|ip
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ProtoAliasOut
parameter_list|(
name|struct
name|ip
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|UdpAliasOut
parameter_list|(
name|struct
name|ip
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|UdpAliasIn
parameter_list|(
name|struct
name|ip
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|TcpAliasOut
parameter_list|(
name|struct
name|ip
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|TcpAliasIn
parameter_list|(
name|struct
name|ip
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|GreAliasIn
parameter_list|(
name|struct
name|ip
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|IcmpAliasIn1
parameter_list|(
name|struct
name|ip
modifier|*
name|pip
parameter_list|)
block|{
comment|/*     De-alias incoming echo and timestamp replies */
name|struct
name|alias_link
modifier|*
name|link
decl_stmt|;
name|struct
name|icmp
modifier|*
name|ic
decl_stmt|;
name|ic
operator|=
operator|(
expr|struct
name|icmp
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
comment|/* Get source address from ICMP data field and restore original data */
name|link
operator|=
name|FindIcmpIn
argument_list|(
name|pip
operator|->
name|ip_src
argument_list|,
name|pip
operator|->
name|ip_dst
argument_list|,
name|ic
operator|->
name|icmp_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL
condition|)
block|{
name|u_short
name|original_id
decl_stmt|;
name|int
name|accumulate
decl_stmt|;
name|original_id
operator|=
name|GetOriginalPort
argument_list|(
name|link
argument_list|)
expr_stmt|;
comment|/* Adjust ICMP checksum */
name|accumulate
operator|=
name|ic
operator|->
name|icmp_id
expr_stmt|;
name|accumulate
operator|-=
name|original_id
expr_stmt|;
name|ADJUST_CHECKSUM
argument_list|(
argument|accumulate
argument_list|,
argument|ic->icmp_cksum
argument_list|)
comment|/* Put original sequence number back in */
name|ic
operator|->
name|icmp_id
operator|=
name|original_id
expr_stmt|;
comment|/* Put original address back into IP header */
block|{
name|struct
name|in_addr
name|original_address
decl_stmt|;
name|original_address
operator|=
name|GetOriginalAddress
argument_list|(
name|link
argument_list|)
expr_stmt|;
name|DifferentialChecksum
argument_list|(
operator|&
name|pip
operator|->
name|ip_sum
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|original_address
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|pip
operator|->
name|ip_dst
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pip
operator|->
name|ip_dst
operator|=
name|original_address
expr_stmt|;
block|}
return|return
operator|(
name|PKT_ALIAS_OK
operator|)
return|;
block|}
return|return
operator|(
name|PKT_ALIAS_IGNORED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|IcmpAliasIn2
parameter_list|(
name|struct
name|ip
modifier|*
name|pip
parameter_list|)
block|{
comment|/*     Alias incoming ICMP error messages containing     IP header and first 64 bits of datagram. */
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
name|struct
name|icmp
modifier|*
name|ic
decl_stmt|,
modifier|*
name|ic2
decl_stmt|;
name|struct
name|udphdr
modifier|*
name|ud
decl_stmt|;
name|struct
name|tcphdr
modifier|*
name|tc
decl_stmt|;
name|struct
name|alias_link
modifier|*
name|link
decl_stmt|;
name|ic
operator|=
operator|(
expr|struct
name|icmp
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|ic
operator|->
name|icmp_data
expr_stmt|;
name|ud
operator|=
operator|(
expr|struct
name|udphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ip
operator|+
operator|(
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|tc
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
name|ud
expr_stmt|;
name|ic2
operator|=
operator|(
expr|struct
name|icmp
operator|*
operator|)
name|ud
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|ip_p
operator|==
name|IPPROTO_UDP
condition|)
name|link
operator|=
name|FindUdpTcpIn
argument_list|(
name|ip
operator|->
name|ip_dst
argument_list|,
name|ip
operator|->
name|ip_src
argument_list|,
name|ud
operator|->
name|uh_dport
argument_list|,
name|ud
operator|->
name|uh_sport
argument_list|,
name|IPPROTO_UDP
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ip
operator|->
name|ip_p
operator|==
name|IPPROTO_TCP
condition|)
name|link
operator|=
name|FindUdpTcpIn
argument_list|(
name|ip
operator|->
name|ip_dst
argument_list|,
name|ip
operator|->
name|ip_src
argument_list|,
name|tc
operator|->
name|th_dport
argument_list|,
name|tc
operator|->
name|th_sport
argument_list|,
name|IPPROTO_TCP
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ip
operator|->
name|ip_p
operator|==
name|IPPROTO_ICMP
condition|)
block|{
if|if
condition|(
name|ic2
operator|->
name|icmp_type
operator|==
name|ICMP_ECHO
operator|||
name|ic2
operator|->
name|icmp_type
operator|==
name|ICMP_TSTAMP
condition|)
name|link
operator|=
name|FindIcmpIn
argument_list|(
name|ip
operator|->
name|ip_dst
argument_list|,
name|ip
operator|->
name|ip_src
argument_list|,
name|ic2
operator|->
name|icmp_id
argument_list|)
expr_stmt|;
else|else
name|link
operator|=
name|NULL
expr_stmt|;
block|}
else|else
name|link
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|ip
operator|->
name|ip_p
operator|==
name|IPPROTO_UDP
operator|||
name|ip
operator|->
name|ip_p
operator|==
name|IPPROTO_TCP
condition|)
block|{
name|u_short
modifier|*
name|sptr
decl_stmt|;
name|int
name|accumulate
decl_stmt|;
name|struct
name|in_addr
name|original_address
decl_stmt|;
name|u_short
name|original_port
decl_stmt|;
name|original_address
operator|=
name|GetOriginalAddress
argument_list|(
name|link
argument_list|)
expr_stmt|;
name|original_port
operator|=
name|GetOriginalPort
argument_list|(
name|link
argument_list|)
expr_stmt|;
comment|/* Adjust ICMP checksum */
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
operator|(
name|ip
operator|->
name|ip_src
operator|)
expr_stmt|;
name|accumulate
operator|=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|original_address
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
expr_stmt|;
name|accumulate
operator|+=
name|ud
operator|->
name|uh_sport
expr_stmt|;
name|accumulate
operator|-=
name|original_port
expr_stmt|;
name|ADJUST_CHECKSUM
argument_list|(
argument|accumulate
argument_list|,
argument|ic->icmp_cksum
argument_list|)
comment|/* Un-alias address in IP header */
name|DifferentialChecksum
argument_list|(
operator|&
name|pip
operator|->
name|ip_sum
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|original_address
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|pip
operator|->
name|ip_dst
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pip
operator|->
name|ip_dst
operator|=
name|original_address
expr_stmt|;
comment|/* Un-alias address and port number of original IP packet fragment contained in ICMP data section */
name|ip
operator|->
name|ip_src
operator|=
name|original_address
expr_stmt|;
name|ud
operator|->
name|uh_sport
operator|=
name|original_port
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pip
operator|->
name|ip_p
operator|==
name|IPPROTO_ICMP
condition|)
block|{
name|u_short
modifier|*
name|sptr
decl_stmt|;
name|int
name|accumulate
decl_stmt|;
name|struct
name|in_addr
name|original_address
decl_stmt|;
name|u_short
name|original_id
decl_stmt|;
name|original_address
operator|=
name|GetOriginalAddress
argument_list|(
name|link
argument_list|)
expr_stmt|;
name|original_id
operator|=
name|GetOriginalPort
argument_list|(
name|link
argument_list|)
expr_stmt|;
comment|/* Adjust ICMP checksum */
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
operator|(
name|ip
operator|->
name|ip_src
operator|)
expr_stmt|;
name|accumulate
operator|=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|original_address
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
expr_stmt|;
name|accumulate
operator|+=
name|ic2
operator|->
name|icmp_id
expr_stmt|;
name|accumulate
operator|-=
name|original_id
expr_stmt|;
name|ADJUST_CHECKSUM
argument_list|(
argument|accumulate
argument_list|,
argument|ic->icmp_cksum
argument_list|)
comment|/* Un-alias address in IP header */
name|DifferentialChecksum
argument_list|(
operator|&
name|pip
operator|->
name|ip_sum
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|original_address
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|pip
operator|->
name|ip_dst
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pip
operator|->
name|ip_dst
operator|=
name|original_address
expr_stmt|;
comment|/* Un-alias address of original IP packet and sequence number of     embedded ICMP datagram */
name|ip
operator|->
name|ip_src
operator|=
name|original_address
expr_stmt|;
name|ic2
operator|->
name|icmp_id
operator|=
name|original_id
expr_stmt|;
block|}
return|return
operator|(
name|PKT_ALIAS_OK
operator|)
return|;
block|}
return|return
operator|(
name|PKT_ALIAS_IGNORED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|IcmpAliasIn3
parameter_list|(
name|struct
name|ip
modifier|*
name|pip
parameter_list|)
block|{
name|struct
name|in_addr
name|original_address
decl_stmt|;
name|original_address
operator|=
name|FindOriginalAddress
argument_list|(
name|pip
operator|->
name|ip_dst
argument_list|)
expr_stmt|;
name|DifferentialChecksum
argument_list|(
operator|&
name|pip
operator|->
name|ip_sum
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|original_address
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|pip
operator|->
name|ip_dst
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pip
operator|->
name|ip_dst
operator|=
name|original_address
expr_stmt|;
return|return
name|PKT_ALIAS_OK
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|IcmpAliasIn
parameter_list|(
name|struct
name|ip
modifier|*
name|pip
parameter_list|)
block|{
name|int
name|iresult
decl_stmt|;
name|struct
name|icmp
modifier|*
name|ic
decl_stmt|;
comment|/* Return if proxy-only mode is enabled */
if|if
condition|(
name|packetAliasMode
operator|&
name|PKT_ALIAS_PROXY_ONLY
condition|)
return|return
name|PKT_ALIAS_OK
return|;
name|ic
operator|=
operator|(
expr|struct
name|icmp
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|iresult
operator|=
name|PKT_ALIAS_IGNORED
expr_stmt|;
switch|switch
condition|(
name|ic
operator|->
name|icmp_type
condition|)
block|{
case|case
name|ICMP_ECHOREPLY
case|:
case|case
name|ICMP_TSTAMPREPLY
case|:
if|if
condition|(
name|ic
operator|->
name|icmp_code
operator|==
literal|0
condition|)
block|{
name|iresult
operator|=
name|IcmpAliasIn1
argument_list|(
name|pip
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ICMP_UNREACH
case|:
case|case
name|ICMP_SOURCEQUENCH
case|:
case|case
name|ICMP_TIMXCEED
case|:
case|case
name|ICMP_PARAMPROB
case|:
name|iresult
operator|=
name|IcmpAliasIn2
argument_list|(
name|pip
argument_list|)
expr_stmt|;
break|break;
case|case
name|ICMP_ECHO
case|:
case|case
name|ICMP_TSTAMP
case|:
name|iresult
operator|=
name|IcmpAliasIn3
argument_list|(
name|pip
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|iresult
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|IcmpAliasOut1
parameter_list|(
name|struct
name|ip
modifier|*
name|pip
parameter_list|)
block|{
comment|/*     Alias ICMP echo and timestamp packets */
name|struct
name|alias_link
modifier|*
name|link
decl_stmt|;
name|struct
name|icmp
modifier|*
name|ic
decl_stmt|;
name|ic
operator|=
operator|(
expr|struct
name|icmp
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
comment|/* Save overwritten data for when echo packet returns */
name|link
operator|=
name|FindIcmpOut
argument_list|(
name|pip
operator|->
name|ip_src
argument_list|,
name|pip
operator|->
name|ip_dst
argument_list|,
name|ic
operator|->
name|icmp_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL
condition|)
block|{
name|u_short
name|alias_id
decl_stmt|;
name|int
name|accumulate
decl_stmt|;
name|alias_id
operator|=
name|GetAliasPort
argument_list|(
name|link
argument_list|)
expr_stmt|;
comment|/* Since data field is being modified, adjust ICMP checksum */
name|accumulate
operator|=
name|ic
operator|->
name|icmp_id
expr_stmt|;
name|accumulate
operator|-=
name|alias_id
expr_stmt|;
name|ADJUST_CHECKSUM
argument_list|(
argument|accumulate
argument_list|,
argument|ic->icmp_cksum
argument_list|)
comment|/* Alias sequence number */
name|ic
operator|->
name|icmp_id
operator|=
name|alias_id
expr_stmt|;
comment|/* Change source address */
block|{
name|struct
name|in_addr
name|alias_address
decl_stmt|;
name|alias_address
operator|=
name|GetAliasAddress
argument_list|(
name|link
argument_list|)
expr_stmt|;
name|DifferentialChecksum
argument_list|(
operator|&
name|pip
operator|->
name|ip_sum
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|alias_address
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|pip
operator|->
name|ip_src
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pip
operator|->
name|ip_src
operator|=
name|alias_address
expr_stmt|;
block|}
return|return
operator|(
name|PKT_ALIAS_OK
operator|)
return|;
block|}
return|return
operator|(
name|PKT_ALIAS_IGNORED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|IcmpAliasOut2
parameter_list|(
name|struct
name|ip
modifier|*
name|pip
parameter_list|)
block|{
comment|/*     Alias outgoing ICMP error messages containing     IP header and first 64 bits of datagram. */
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
name|struct
name|icmp
modifier|*
name|ic
decl_stmt|,
modifier|*
name|ic2
decl_stmt|;
name|struct
name|udphdr
modifier|*
name|ud
decl_stmt|;
name|struct
name|tcphdr
modifier|*
name|tc
decl_stmt|;
name|struct
name|alias_link
modifier|*
name|link
decl_stmt|;
name|ic
operator|=
operator|(
expr|struct
name|icmp
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|ic
operator|->
name|icmp_data
expr_stmt|;
name|ud
operator|=
operator|(
expr|struct
name|udphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|ip
operator|+
operator|(
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|tc
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
name|ud
expr_stmt|;
name|ic2
operator|=
operator|(
expr|struct
name|icmp
operator|*
operator|)
name|ud
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|ip_p
operator|==
name|IPPROTO_UDP
condition|)
name|link
operator|=
name|FindUdpTcpOut
argument_list|(
name|ip
operator|->
name|ip_dst
argument_list|,
name|ip
operator|->
name|ip_src
argument_list|,
name|ud
operator|->
name|uh_dport
argument_list|,
name|ud
operator|->
name|uh_sport
argument_list|,
name|IPPROTO_UDP
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ip
operator|->
name|ip_p
operator|==
name|IPPROTO_TCP
condition|)
name|link
operator|=
name|FindUdpTcpOut
argument_list|(
name|ip
operator|->
name|ip_dst
argument_list|,
name|ip
operator|->
name|ip_src
argument_list|,
name|tc
operator|->
name|th_dport
argument_list|,
name|tc
operator|->
name|th_sport
argument_list|,
name|IPPROTO_TCP
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ip
operator|->
name|ip_p
operator|==
name|IPPROTO_ICMP
condition|)
block|{
if|if
condition|(
name|ic2
operator|->
name|icmp_type
operator|==
name|ICMP_ECHO
operator|||
name|ic2
operator|->
name|icmp_type
operator|==
name|ICMP_TSTAMP
condition|)
name|link
operator|=
name|FindIcmpOut
argument_list|(
name|ip
operator|->
name|ip_dst
argument_list|,
name|ip
operator|->
name|ip_src
argument_list|,
name|ic2
operator|->
name|icmp_id
argument_list|)
expr_stmt|;
else|else
name|link
operator|=
name|NULL
expr_stmt|;
block|}
else|else
name|link
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|ip
operator|->
name|ip_p
operator|==
name|IPPROTO_UDP
operator|||
name|ip
operator|->
name|ip_p
operator|==
name|IPPROTO_TCP
condition|)
block|{
name|u_short
modifier|*
name|sptr
decl_stmt|;
name|int
name|accumulate
decl_stmt|;
name|struct
name|in_addr
name|alias_address
decl_stmt|;
name|u_short
name|alias_port
decl_stmt|;
name|alias_address
operator|=
name|GetAliasAddress
argument_list|(
name|link
argument_list|)
expr_stmt|;
name|alias_port
operator|=
name|GetAliasPort
argument_list|(
name|link
argument_list|)
expr_stmt|;
comment|/* Adjust ICMP checksum */
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
operator|(
name|ip
operator|->
name|ip_dst
operator|)
expr_stmt|;
name|accumulate
operator|=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|alias_address
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
expr_stmt|;
name|accumulate
operator|+=
name|ud
operator|->
name|uh_dport
expr_stmt|;
name|accumulate
operator|-=
name|alias_port
expr_stmt|;
name|ADJUST_CHECKSUM
argument_list|(
argument|accumulate
argument_list|,
argument|ic->icmp_cksum
argument_list|)
comment|/* Alias address in IP header */
name|DifferentialChecksum
argument_list|(
operator|&
name|pip
operator|->
name|ip_sum
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|alias_address
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|pip
operator|->
name|ip_src
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pip
operator|->
name|ip_src
operator|=
name|alias_address
expr_stmt|;
comment|/* Alias address and port number of original IP packet fragment contained in ICMP data section */
name|ip
operator|->
name|ip_dst
operator|=
name|alias_address
expr_stmt|;
name|ud
operator|->
name|uh_dport
operator|=
name|alias_port
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pip
operator|->
name|ip_p
operator|==
name|IPPROTO_ICMP
condition|)
block|{
name|u_short
modifier|*
name|sptr
decl_stmt|;
name|int
name|accumulate
decl_stmt|;
name|struct
name|in_addr
name|alias_address
decl_stmt|;
name|u_short
name|alias_id
decl_stmt|;
name|alias_address
operator|=
name|GetAliasAddress
argument_list|(
name|link
argument_list|)
expr_stmt|;
name|alias_id
operator|=
name|GetAliasPort
argument_list|(
name|link
argument_list|)
expr_stmt|;
comment|/* Adjust ICMP checksum */
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
operator|(
name|ip
operator|->
name|ip_dst
operator|)
expr_stmt|;
name|accumulate
operator|=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|alias_address
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
expr_stmt|;
name|accumulate
operator|+=
name|ic2
operator|->
name|icmp_id
expr_stmt|;
name|accumulate
operator|-=
name|alias_id
expr_stmt|;
name|ADJUST_CHECKSUM
argument_list|(
argument|accumulate
argument_list|,
argument|ic->icmp_cksum
argument_list|)
comment|/* Alias address in IP header */
name|DifferentialChecksum
argument_list|(
operator|&
name|pip
operator|->
name|ip_sum
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|alias_address
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|pip
operator|->
name|ip_src
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pip
operator|->
name|ip_src
operator|=
name|alias_address
expr_stmt|;
comment|/* Alias address of original IP packet and sequence number of     embedded ICMP datagram */
name|ip
operator|->
name|ip_dst
operator|=
name|alias_address
expr_stmt|;
name|ic2
operator|->
name|icmp_id
operator|=
name|alias_id
expr_stmt|;
block|}
return|return
operator|(
name|PKT_ALIAS_OK
operator|)
return|;
block|}
return|return
operator|(
name|PKT_ALIAS_IGNORED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|IcmpAliasOut3
parameter_list|(
name|struct
name|ip
modifier|*
name|pip
parameter_list|)
block|{
comment|/*   Handle outgoing echo and timestamp replies.  The   only thing which is done in this case is to alias   the source IP address of the packet. */
name|struct
name|in_addr
name|alias_addr
decl_stmt|;
name|alias_addr
operator|=
name|FindAliasAddress
argument_list|(
name|pip
operator|->
name|ip_src
argument_list|)
expr_stmt|;
name|DifferentialChecksum
argument_list|(
operator|&
name|pip
operator|->
name|ip_sum
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|alias_addr
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|pip
operator|->
name|ip_src
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pip
operator|->
name|ip_src
operator|=
name|alias_addr
expr_stmt|;
return|return
name|PKT_ALIAS_OK
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|IcmpAliasOut
parameter_list|(
name|struct
name|ip
modifier|*
name|pip
parameter_list|)
block|{
name|int
name|iresult
decl_stmt|;
name|struct
name|icmp
modifier|*
name|ic
decl_stmt|;
comment|/* Return if proxy-only mode is enabled */
if|if
condition|(
name|packetAliasMode
operator|&
name|PKT_ALIAS_PROXY_ONLY
condition|)
return|return
name|PKT_ALIAS_OK
return|;
name|ic
operator|=
operator|(
expr|struct
name|icmp
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|iresult
operator|=
name|PKT_ALIAS_IGNORED
expr_stmt|;
switch|switch
condition|(
name|ic
operator|->
name|icmp_type
condition|)
block|{
case|case
name|ICMP_ECHO
case|:
case|case
name|ICMP_TSTAMP
case|:
if|if
condition|(
name|ic
operator|->
name|icmp_code
operator|==
literal|0
condition|)
block|{
name|iresult
operator|=
name|IcmpAliasOut1
argument_list|(
name|pip
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ICMP_UNREACH
case|:
case|case
name|ICMP_SOURCEQUENCH
case|:
case|case
name|ICMP_TIMXCEED
case|:
case|case
name|ICMP_PARAMPROB
case|:
name|iresult
operator|=
name|IcmpAliasOut2
argument_list|(
name|pip
argument_list|)
expr_stmt|;
break|break;
case|case
name|ICMP_ECHOREPLY
case|:
case|case
name|ICMP_TSTAMPREPLY
case|:
name|iresult
operator|=
name|IcmpAliasOut3
argument_list|(
name|pip
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|iresult
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ProtoAliasIn
parameter_list|(
name|struct
name|ip
modifier|*
name|pip
parameter_list|)
block|{
comment|/*   Handle incoming IP packets. The   only thing which is done in this case is to alias   the dest IP address of the packet to our inside   machine. */
name|struct
name|alias_link
modifier|*
name|link
decl_stmt|;
comment|/* Return if proxy-only mode is enabled */
if|if
condition|(
name|packetAliasMode
operator|&
name|PKT_ALIAS_PROXY_ONLY
condition|)
return|return
name|PKT_ALIAS_OK
return|;
name|link
operator|=
name|FindProtoIn
argument_list|(
name|pip
operator|->
name|ip_src
argument_list|,
name|pip
operator|->
name|ip_dst
argument_list|,
name|pip
operator|->
name|ip_p
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL
condition|)
block|{
name|struct
name|in_addr
name|original_address
decl_stmt|;
name|original_address
operator|=
name|GetOriginalAddress
argument_list|(
name|link
argument_list|)
expr_stmt|;
comment|/* Restore original IP address */
name|DifferentialChecksum
argument_list|(
operator|&
name|pip
operator|->
name|ip_sum
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|original_address
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|pip
operator|->
name|ip_dst
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pip
operator|->
name|ip_dst
operator|=
name|original_address
expr_stmt|;
return|return
operator|(
name|PKT_ALIAS_OK
operator|)
return|;
block|}
return|return
operator|(
name|PKT_ALIAS_IGNORED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ProtoAliasOut
parameter_list|(
name|struct
name|ip
modifier|*
name|pip
parameter_list|)
block|{
comment|/*   Handle outgoing IP packets. The   only thing which is done in this case is to alias   the source IP address of the packet. */
name|struct
name|alias_link
modifier|*
name|link
decl_stmt|;
comment|/* Return if proxy-only mode is enabled */
if|if
condition|(
name|packetAliasMode
operator|&
name|PKT_ALIAS_PROXY_ONLY
condition|)
return|return
name|PKT_ALIAS_OK
return|;
name|link
operator|=
name|FindProtoOut
argument_list|(
name|pip
operator|->
name|ip_src
argument_list|,
name|pip
operator|->
name|ip_dst
argument_list|,
name|pip
operator|->
name|ip_p
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL
condition|)
block|{
name|struct
name|in_addr
name|alias_address
decl_stmt|;
name|alias_address
operator|=
name|GetAliasAddress
argument_list|(
name|link
argument_list|)
expr_stmt|;
comment|/* Change source address */
name|DifferentialChecksum
argument_list|(
operator|&
name|pip
operator|->
name|ip_sum
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|alias_address
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|pip
operator|->
name|ip_src
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pip
operator|->
name|ip_src
operator|=
name|alias_address
expr_stmt|;
return|return
operator|(
name|PKT_ALIAS_OK
operator|)
return|;
block|}
return|return
operator|(
name|PKT_ALIAS_IGNORED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|GreAliasIn
parameter_list|(
name|struct
name|ip
modifier|*
name|pip
parameter_list|)
block|{
name|u_short
name|call_id
decl_stmt|;
name|struct
name|alias_link
modifier|*
name|link
decl_stmt|;
comment|/* Return if proxy-only mode is enabled. */
if|if
condition|(
name|packetAliasMode
operator|&
name|PKT_ALIAS_PROXY_ONLY
condition|)
return|return
operator|(
name|PKT_ALIAS_OK
operator|)
return|;
if|if
condition|(
name|PptpGetCallID
argument_list|(
name|pip
argument_list|,
operator|&
name|call_id
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|link
operator|=
name|FindPptpIn
argument_list|(
name|pip
operator|->
name|ip_src
argument_list|,
name|pip
operator|->
name|ip_dst
argument_list|,
name|call_id
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|struct
name|in_addr
name|alias_address
decl_stmt|;
name|struct
name|in_addr
name|original_address
decl_stmt|;
name|alias_address
operator|=
name|GetAliasAddress
argument_list|(
name|link
argument_list|)
expr_stmt|;
name|original_address
operator|=
name|GetOriginalAddress
argument_list|(
name|link
argument_list|)
expr_stmt|;
name|PptpSetCallID
argument_list|(
name|pip
argument_list|,
name|GetOriginalPort
argument_list|(
name|link
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Restore original IP address. */
name|DifferentialChecksum
argument_list|(
operator|&
name|pip
operator|->
name|ip_sum
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|original_address
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|pip
operator|->
name|ip_dst
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pip
operator|->
name|ip_dst
operator|=
name|original_address
expr_stmt|;
return|return
operator|(
name|PKT_ALIAS_OK
operator|)
return|;
block|}
else|else
return|return
operator|(
name|PKT_ALIAS_IGNORED
operator|)
return|;
block|}
else|else
return|return
name|ProtoAliasIn
argument_list|(
name|pip
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|UdpAliasIn
parameter_list|(
name|struct
name|ip
modifier|*
name|pip
parameter_list|)
block|{
name|struct
name|udphdr
modifier|*
name|ud
decl_stmt|;
name|struct
name|alias_link
modifier|*
name|link
decl_stmt|;
comment|/* Return if proxy-only mode is enabled */
if|if
condition|(
name|packetAliasMode
operator|&
name|PKT_ALIAS_PROXY_ONLY
condition|)
return|return
name|PKT_ALIAS_OK
return|;
name|ud
operator|=
operator|(
expr|struct
name|udphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|link
operator|=
name|FindUdpTcpIn
argument_list|(
name|pip
operator|->
name|ip_src
argument_list|,
name|pip
operator|->
name|ip_dst
argument_list|,
name|ud
operator|->
name|uh_sport
argument_list|,
name|ud
operator|->
name|uh_dport
argument_list|,
name|IPPROTO_UDP
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL
condition|)
block|{
name|struct
name|in_addr
name|alias_address
decl_stmt|;
name|struct
name|in_addr
name|original_address
decl_stmt|;
name|u_short
name|alias_port
decl_stmt|;
name|int
name|accumulate
decl_stmt|;
name|u_short
modifier|*
name|sptr
decl_stmt|;
name|int
name|r
init|=
literal|0
decl_stmt|;
name|alias_address
operator|=
name|GetAliasAddress
argument_list|(
name|link
argument_list|)
expr_stmt|;
name|original_address
operator|=
name|GetOriginalAddress
argument_list|(
name|link
argument_list|)
expr_stmt|;
name|alias_port
operator|=
name|ud
operator|->
name|uh_dport
expr_stmt|;
name|ud
operator|->
name|uh_dport
operator|=
name|GetOriginalPort
argument_list|(
name|link
argument_list|)
expr_stmt|;
comment|/* If NETBIOS Datagram, It should be alias address in UDP Data, too */
if|if
condition|(
name|ntohs
argument_list|(
name|ud
operator|->
name|uh_dport
argument_list|)
operator|==
name|NETBIOS_DGM_PORT_NUMBER
operator|||
name|ntohs
argument_list|(
name|ud
operator|->
name|uh_sport
argument_list|)
operator|==
name|NETBIOS_DGM_PORT_NUMBER
condition|)
block|{
name|r
operator|=
name|AliasHandleUdpNbt
argument_list|(
name|pip
argument_list|,
name|link
argument_list|,
operator|&
name|original_address
argument_list|,
name|ud
operator|->
name|uh_dport
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ntohs
argument_list|(
name|ud
operator|->
name|uh_dport
argument_list|)
operator|==
name|NETBIOS_NS_PORT_NUMBER
operator|||
name|ntohs
argument_list|(
name|ud
operator|->
name|uh_sport
argument_list|)
operator|==
name|NETBIOS_NS_PORT_NUMBER
condition|)
block|{
name|r
operator|=
name|AliasHandleUdpNbtNS
argument_list|(
name|pip
argument_list|,
name|link
argument_list|,
operator|&
name|alias_address
argument_list|,
operator|&
name|alias_port
argument_list|,
operator|&
name|original_address
argument_list|,
operator|&
name|ud
operator|->
name|uh_dport
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ntohs
argument_list|(
name|ud
operator|->
name|uh_dport
argument_list|)
operator|==
name|CUSEEME_PORT_NUMBER
condition|)
name|AliasHandleCUSeeMeIn
argument_list|(
name|pip
argument_list|,
name|original_address
argument_list|)
expr_stmt|;
comment|/* If UDP checksum is not zero, then adjust since destination port */
comment|/* is being unaliased and destination port is being altered.       */
if|if
condition|(
name|ud
operator|->
name|uh_sum
operator|!=
literal|0
condition|)
block|{
name|accumulate
operator|=
name|alias_port
expr_stmt|;
name|accumulate
operator|-=
name|ud
operator|->
name|uh_dport
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|alias_address
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|original_address
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
expr_stmt|;
name|ADJUST_CHECKSUM
argument_list|(
argument|accumulate
argument_list|,
argument|ud->uh_sum
argument_list|)
block|}
comment|/* Restore original IP address */
name|DifferentialChecksum
argument_list|(
operator|&
name|pip
operator|->
name|ip_sum
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|original_address
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|pip
operator|->
name|ip_dst
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pip
operator|->
name|ip_dst
operator|=
name|original_address
expr_stmt|;
comment|/* 	 * If we cannot figure out the packet, ignore it. 	 */
if|if
condition|(
name|r
operator|<
literal|0
condition|)
return|return
operator|(
name|PKT_ALIAS_IGNORED
operator|)
return|;
else|else
return|return
operator|(
name|PKT_ALIAS_OK
operator|)
return|;
block|}
return|return
operator|(
name|PKT_ALIAS_IGNORED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|UdpAliasOut
parameter_list|(
name|struct
name|ip
modifier|*
name|pip
parameter_list|)
block|{
name|struct
name|udphdr
modifier|*
name|ud
decl_stmt|;
name|struct
name|alias_link
modifier|*
name|link
decl_stmt|;
comment|/* Return if proxy-only mode is enabled */
if|if
condition|(
name|packetAliasMode
operator|&
name|PKT_ALIAS_PROXY_ONLY
condition|)
return|return
name|PKT_ALIAS_OK
return|;
name|ud
operator|=
operator|(
expr|struct
name|udphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|link
operator|=
name|FindUdpTcpOut
argument_list|(
name|pip
operator|->
name|ip_src
argument_list|,
name|pip
operator|->
name|ip_dst
argument_list|,
name|ud
operator|->
name|uh_sport
argument_list|,
name|ud
operator|->
name|uh_dport
argument_list|,
name|IPPROTO_UDP
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL
condition|)
block|{
name|u_short
name|alias_port
decl_stmt|;
name|struct
name|in_addr
name|alias_address
decl_stmt|;
name|alias_address
operator|=
name|GetAliasAddress
argument_list|(
name|link
argument_list|)
expr_stmt|;
name|alias_port
operator|=
name|GetAliasPort
argument_list|(
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntohs
argument_list|(
name|ud
operator|->
name|uh_dport
argument_list|)
operator|==
name|CUSEEME_PORT_NUMBER
condition|)
name|AliasHandleCUSeeMeOut
argument_list|(
name|pip
argument_list|,
name|link
argument_list|)
expr_stmt|;
comment|/* If NETBIOS Datagram, It should be alias address in UDP Data, too */
if|if
condition|(
name|ntohs
argument_list|(
name|ud
operator|->
name|uh_dport
argument_list|)
operator|==
name|NETBIOS_DGM_PORT_NUMBER
operator|||
name|ntohs
argument_list|(
name|ud
operator|->
name|uh_sport
argument_list|)
operator|==
name|NETBIOS_DGM_PORT_NUMBER
condition|)
block|{
name|AliasHandleUdpNbt
argument_list|(
name|pip
argument_list|,
name|link
argument_list|,
operator|&
name|alias_address
argument_list|,
name|alias_port
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ntohs
argument_list|(
name|ud
operator|->
name|uh_dport
argument_list|)
operator|==
name|NETBIOS_NS_PORT_NUMBER
operator|||
name|ntohs
argument_list|(
name|ud
operator|->
name|uh_sport
argument_list|)
operator|==
name|NETBIOS_NS_PORT_NUMBER
condition|)
block|{
name|AliasHandleUdpNbtNS
argument_list|(
name|pip
argument_list|,
name|link
argument_list|,
operator|&
name|pip
operator|->
name|ip_src
argument_list|,
operator|&
name|ud
operator|->
name|uh_sport
argument_list|,
operator|&
name|alias_address
argument_list|,
operator|&
name|alias_port
argument_list|)
expr_stmt|;
block|}
comment|/* If UDP checksum is not zero, adjust since source port is */
comment|/* being aliased and source address is being altered        */
if|if
condition|(
name|ud
operator|->
name|uh_sum
operator|!=
literal|0
condition|)
block|{
name|int
name|accumulate
decl_stmt|;
name|u_short
modifier|*
name|sptr
decl_stmt|;
name|accumulate
operator|=
name|ud
operator|->
name|uh_sport
expr_stmt|;
name|accumulate
operator|-=
name|alias_port
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
operator|(
name|pip
operator|->
name|ip_src
operator|)
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|alias_address
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
expr_stmt|;
name|ADJUST_CHECKSUM
argument_list|(
argument|accumulate
argument_list|,
argument|ud->uh_sum
argument_list|)
block|}
comment|/* Put alias port in UDP header */
name|ud
operator|->
name|uh_sport
operator|=
name|alias_port
expr_stmt|;
comment|/* Change source address */
name|DifferentialChecksum
argument_list|(
operator|&
name|pip
operator|->
name|ip_sum
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|alias_address
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|pip
operator|->
name|ip_src
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pip
operator|->
name|ip_src
operator|=
name|alias_address
expr_stmt|;
return|return
operator|(
name|PKT_ALIAS_OK
operator|)
return|;
block|}
return|return
operator|(
name|PKT_ALIAS_IGNORED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|TcpAliasIn
parameter_list|(
name|struct
name|ip
modifier|*
name|pip
parameter_list|)
block|{
name|struct
name|tcphdr
modifier|*
name|tc
decl_stmt|;
name|struct
name|alias_link
modifier|*
name|link
decl_stmt|;
name|tc
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|link
operator|=
name|FindUdpTcpIn
argument_list|(
name|pip
operator|->
name|ip_src
argument_list|,
name|pip
operator|->
name|ip_dst
argument_list|,
name|tc
operator|->
name|th_sport
argument_list|,
name|tc
operator|->
name|th_dport
argument_list|,
name|IPPROTO_TCP
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL
condition|)
block|{
name|struct
name|in_addr
name|alias_address
decl_stmt|;
name|struct
name|in_addr
name|original_address
decl_stmt|;
name|struct
name|in_addr
name|proxy_address
decl_stmt|;
name|u_short
name|alias_port
decl_stmt|;
name|u_short
name|proxy_port
decl_stmt|;
name|int
name|accumulate
decl_stmt|;
name|u_short
modifier|*
name|sptr
decl_stmt|;
comment|/* Special processing for IP encoding protocols */
if|if
condition|(
name|ntohs
argument_list|(
name|tc
operator|->
name|th_dport
argument_list|)
operator|==
name|PPTP_CONTROL_PORT_NUMBER
operator|||
name|ntohs
argument_list|(
name|tc
operator|->
name|th_sport
argument_list|)
operator|==
name|PPTP_CONTROL_PORT_NUMBER
condition|)
name|AliasHandlePptpIn
argument_list|(
name|pip
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|alias_address
operator|=
name|GetAliasAddress
argument_list|(
name|link
argument_list|)
expr_stmt|;
name|original_address
operator|=
name|GetOriginalAddress
argument_list|(
name|link
argument_list|)
expr_stmt|;
name|proxy_address
operator|=
name|GetProxyAddress
argument_list|(
name|link
argument_list|)
expr_stmt|;
name|alias_port
operator|=
name|tc
operator|->
name|th_dport
expr_stmt|;
name|tc
operator|->
name|th_dport
operator|=
name|GetOriginalPort
argument_list|(
name|link
argument_list|)
expr_stmt|;
name|proxy_port
operator|=
name|GetProxyPort
argument_list|(
name|link
argument_list|)
expr_stmt|;
comment|/* Adjust TCP checksum since destination port is being unaliased */
comment|/* and destination port is being altered.                        */
name|accumulate
operator|=
name|alias_port
expr_stmt|;
name|accumulate
operator|-=
name|tc
operator|->
name|th_dport
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|alias_address
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|original_address
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
expr_stmt|;
comment|/* If this is a proxy, then modify the TCP source port and    checksum accumulation */
if|if
condition|(
name|proxy_port
operator|!=
literal|0
condition|)
block|{
name|accumulate
operator|+=
name|tc
operator|->
name|th_sport
expr_stmt|;
name|tc
operator|->
name|th_sport
operator|=
name|proxy_port
expr_stmt|;
name|accumulate
operator|-=
name|tc
operator|->
name|th_sport
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|pip
operator|->
name|ip_src
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|proxy_address
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
expr_stmt|;
block|}
comment|/* See if ACK number needs to be modified */
if|if
condition|(
name|GetAckModified
argument_list|(
name|link
argument_list|)
operator|==
literal|1
condition|)
block|{
name|int
name|delta
decl_stmt|;
name|delta
operator|=
name|GetDeltaAckIn
argument_list|(
name|pip
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|delta
operator|!=
literal|0
condition|)
block|{
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|tc
operator|->
name|th_ack
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
expr_stmt|;
name|tc
operator|->
name|th_ack
operator|=
name|htonl
argument_list|(
name|ntohl
argument_list|(
name|tc
operator|->
name|th_ack
argument_list|)
operator|-
name|delta
argument_list|)
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|tc
operator|->
name|th_ack
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
expr_stmt|;
block|}
block|}
name|ADJUST_CHECKSUM
argument_list|(
name|accumulate
argument_list|,
name|tc
operator|->
name|th_sum
argument_list|)
expr_stmt|;
comment|/* Restore original IP address */
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|pip
operator|->
name|ip_dst
expr_stmt|;
name|accumulate
operator|=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
expr_stmt|;
name|pip
operator|->
name|ip_dst
operator|=
name|original_address
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|pip
operator|->
name|ip_dst
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
expr_stmt|;
comment|/* If this is a transparent proxy packet, then modify the source    address */
if|if
condition|(
name|proxy_address
operator|.
name|s_addr
operator|!=
literal|0
condition|)
block|{
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|pip
operator|->
name|ip_src
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
expr_stmt|;
name|pip
operator|->
name|ip_src
operator|=
name|proxy_address
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|pip
operator|->
name|ip_src
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
expr_stmt|;
block|}
name|ADJUST_CHECKSUM
argument_list|(
name|accumulate
argument_list|,
name|pip
operator|->
name|ip_sum
argument_list|)
expr_stmt|;
comment|/* Monitor TCP connection state */
name|TcpMonitorIn
argument_list|(
name|pip
argument_list|,
name|link
argument_list|)
expr_stmt|;
return|return
operator|(
name|PKT_ALIAS_OK
operator|)
return|;
block|}
return|return
operator|(
name|PKT_ALIAS_IGNORED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|TcpAliasOut
parameter_list|(
name|struct
name|ip
modifier|*
name|pip
parameter_list|,
name|int
name|maxpacketsize
parameter_list|)
block|{
name|int
name|proxy_type
decl_stmt|;
name|u_short
name|dest_port
decl_stmt|;
name|u_short
name|proxy_server_port
decl_stmt|;
name|struct
name|in_addr
name|dest_address
decl_stmt|;
name|struct
name|in_addr
name|proxy_server_address
decl_stmt|;
name|struct
name|tcphdr
modifier|*
name|tc
decl_stmt|;
name|struct
name|alias_link
modifier|*
name|link
decl_stmt|;
name|tc
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pip
operator|+
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|)
expr_stmt|;
name|proxy_type
operator|=
name|ProxyCheck
argument_list|(
name|pip
argument_list|,
operator|&
name|proxy_server_address
argument_list|,
operator|&
name|proxy_server_port
argument_list|)
expr_stmt|;
if|if
condition|(
name|proxy_type
operator|==
literal|0
operator|&&
operator|(
name|packetAliasMode
operator|&
name|PKT_ALIAS_PROXY_ONLY
operator|)
condition|)
return|return
name|PKT_ALIAS_OK
return|;
comment|/* If this is a transparent proxy, save original destination,    then alter the destination and adjust checksums */
name|dest_port
operator|=
name|tc
operator|->
name|th_dport
expr_stmt|;
name|dest_address
operator|=
name|pip
operator|->
name|ip_dst
expr_stmt|;
if|if
condition|(
name|proxy_type
operator|!=
literal|0
condition|)
block|{
name|int
name|accumulate
decl_stmt|;
name|u_short
modifier|*
name|sptr
decl_stmt|;
name|accumulate
operator|=
name|tc
operator|->
name|th_dport
expr_stmt|;
name|tc
operator|->
name|th_dport
operator|=
name|proxy_server_port
expr_stmt|;
name|accumulate
operator|-=
name|tc
operator|->
name|th_dport
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
operator|(
name|pip
operator|->
name|ip_dst
operator|)
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|proxy_server_address
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
expr_stmt|;
name|ADJUST_CHECKSUM
argument_list|(
name|accumulate
argument_list|,
name|tc
operator|->
name|th_sum
argument_list|)
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
operator|(
name|pip
operator|->
name|ip_dst
operator|)
expr_stmt|;
name|accumulate
operator|=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
expr_stmt|;
name|pip
operator|->
name|ip_dst
operator|=
name|proxy_server_address
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
operator|(
name|pip
operator|->
name|ip_dst
operator|)
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
expr_stmt|;
name|ADJUST_CHECKSUM
argument_list|(
name|accumulate
argument_list|,
name|pip
operator|->
name|ip_sum
argument_list|)
expr_stmt|;
block|}
name|link
operator|=
name|FindUdpTcpOut
argument_list|(
name|pip
operator|->
name|ip_src
argument_list|,
name|pip
operator|->
name|ip_dst
argument_list|,
name|tc
operator|->
name|th_sport
argument_list|,
name|tc
operator|->
name|th_dport
argument_list|,
name|IPPROTO_TCP
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL
condition|)
block|{
name|u_short
name|alias_port
decl_stmt|;
name|struct
name|in_addr
name|alias_address
decl_stmt|;
name|int
name|accumulate
decl_stmt|;
name|u_short
modifier|*
name|sptr
decl_stmt|;
comment|/* Save original destination address, if this is a proxy packet.    Also modify packet to include destination encoding. */
if|if
condition|(
name|proxy_type
operator|!=
literal|0
condition|)
block|{
name|SetProxyPort
argument_list|(
name|link
argument_list|,
name|dest_port
argument_list|)
expr_stmt|;
name|SetProxyAddress
argument_list|(
name|link
argument_list|,
name|dest_address
argument_list|)
expr_stmt|;
name|ProxyModify
argument_list|(
name|link
argument_list|,
name|pip
argument_list|,
name|maxpacketsize
argument_list|,
name|proxy_type
argument_list|)
expr_stmt|;
block|}
comment|/* Get alias address and port */
name|alias_port
operator|=
name|GetAliasPort
argument_list|(
name|link
argument_list|)
expr_stmt|;
name|alias_address
operator|=
name|GetAliasAddress
argument_list|(
name|link
argument_list|)
expr_stmt|;
comment|/* Monitor TCP connection state */
name|TcpMonitorOut
argument_list|(
name|pip
argument_list|,
name|link
argument_list|)
expr_stmt|;
comment|/* Special processing for IP encoding protocols */
if|if
condition|(
name|ntohs
argument_list|(
name|tc
operator|->
name|th_dport
argument_list|)
operator|==
name|FTP_CONTROL_PORT_NUMBER
operator|||
name|ntohs
argument_list|(
name|tc
operator|->
name|th_sport
argument_list|)
operator|==
name|FTP_CONTROL_PORT_NUMBER
condition|)
name|AliasHandleFtpOut
argument_list|(
name|pip
argument_list|,
name|link
argument_list|,
name|maxpacketsize
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ntohs
argument_list|(
name|tc
operator|->
name|th_dport
argument_list|)
operator|==
name|IRC_CONTROL_PORT_NUMBER_1
operator|||
name|ntohs
argument_list|(
name|tc
operator|->
name|th_dport
argument_list|)
operator|==
name|IRC_CONTROL_PORT_NUMBER_2
condition|)
name|AliasHandleIrcOut
argument_list|(
name|pip
argument_list|,
name|link
argument_list|,
name|maxpacketsize
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ntohs
argument_list|(
name|tc
operator|->
name|th_dport
argument_list|)
operator|==
name|PPTP_CONTROL_PORT_NUMBER
operator|||
name|ntohs
argument_list|(
name|tc
operator|->
name|th_sport
argument_list|)
operator|==
name|PPTP_CONTROL_PORT_NUMBER
condition|)
name|AliasHandlePptpOut
argument_list|(
name|pip
argument_list|,
name|link
argument_list|)
expr_stmt|;
comment|/* Adjust TCP checksum since source port is being aliased */
comment|/* and source address is being altered                    */
name|accumulate
operator|=
name|tc
operator|->
name|th_sport
expr_stmt|;
name|tc
operator|->
name|th_sport
operator|=
name|alias_port
expr_stmt|;
name|accumulate
operator|-=
name|tc
operator|->
name|th_sport
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
operator|(
name|pip
operator|->
name|ip_src
operator|)
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|alias_address
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
expr_stmt|;
comment|/* Modify sequence number if necessary */
if|if
condition|(
name|GetAckModified
argument_list|(
name|link
argument_list|)
operator|==
literal|1
condition|)
block|{
name|int
name|delta
decl_stmt|;
name|delta
operator|=
name|GetDeltaSeqOut
argument_list|(
name|pip
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|delta
operator|!=
literal|0
condition|)
block|{
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|tc
operator|->
name|th_seq
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
expr_stmt|;
name|tc
operator|->
name|th_seq
operator|=
name|htonl
argument_list|(
name|ntohl
argument_list|(
name|tc
operator|->
name|th_seq
argument_list|)
operator|+
name|delta
argument_list|)
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
name|tc
operator|->
name|th_seq
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
expr_stmt|;
block|}
block|}
name|ADJUST_CHECKSUM
argument_list|(
argument|accumulate
argument_list|,
argument|tc->th_sum
argument_list|)
comment|/* Change source address */
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
operator|(
name|pip
operator|->
name|ip_src
operator|)
expr_stmt|;
name|accumulate
operator|=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|+=
operator|*
name|sptr
expr_stmt|;
name|pip
operator|->
name|ip_src
operator|=
name|alias_address
expr_stmt|;
name|sptr
operator|=
operator|(
name|u_short
operator|*
operator|)
operator|&
operator|(
name|pip
operator|->
name|ip_src
operator|)
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
operator|++
expr_stmt|;
name|accumulate
operator|-=
operator|*
name|sptr
expr_stmt|;
name|ADJUST_CHECKSUM
argument_list|(
argument|accumulate
argument_list|,
argument|pip->ip_sum
argument_list|)
return|return
operator|(
name|PKT_ALIAS_OK
operator|)
return|;
block|}
return|return
operator|(
name|PKT_ALIAS_IGNORED
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Fragment Handling      FragmentIn()     FragmentOut()  The packet aliasing module has a limited ability for handling IP fragments.  If the ICMP, TCP or UDP header is in the first fragment received, then the ID number of the IP packet is saved, and other fragments are identified according to their ID number and IP address they were sent from.  Pointers to unresolved fragments can also be saved and recalled when a header fragment is seen. */
end_comment

begin_comment
comment|/* Local prototypes */
end_comment

begin_function_decl
specifier|static
name|int
name|FragmentIn
parameter_list|(
name|struct
name|ip
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|FragmentOut
parameter_list|(
name|struct
name|ip
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|FragmentIn
parameter_list|(
name|struct
name|ip
modifier|*
name|pip
parameter_list|)
block|{
name|struct
name|alias_link
modifier|*
name|link
decl_stmt|;
name|link
operator|=
name|FindFragmentIn2
argument_list|(
name|pip
operator|->
name|ip_src
argument_list|,
name|pip
operator|->
name|ip_dst
argument_list|,
name|pip
operator|->
name|ip_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL
condition|)
block|{
name|struct
name|in_addr
name|original_address
decl_stmt|;
name|GetFragmentAddr
argument_list|(
name|link
argument_list|,
operator|&
name|original_address
argument_list|)
expr_stmt|;
name|DifferentialChecksum
argument_list|(
operator|&
name|pip
operator|->
name|ip_sum
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|original_address
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|pip
operator|->
name|ip_dst
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pip
operator|->
name|ip_dst
operator|=
name|original_address
expr_stmt|;
return|return
operator|(
name|PKT_ALIAS_OK
operator|)
return|;
block|}
return|return
operator|(
name|PKT_ALIAS_UNRESOLVED_FRAGMENT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|FragmentOut
parameter_list|(
name|struct
name|ip
modifier|*
name|pip
parameter_list|)
block|{
name|struct
name|in_addr
name|alias_address
decl_stmt|;
name|alias_address
operator|=
name|FindAliasAddress
argument_list|(
name|pip
operator|->
name|ip_src
argument_list|)
expr_stmt|;
name|DifferentialChecksum
argument_list|(
operator|&
name|pip
operator|->
name|ip_sum
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|alias_address
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|pip
operator|->
name|ip_src
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|pip
operator|->
name|ip_src
operator|=
name|alias_address
expr_stmt|;
return|return
operator|(
name|PKT_ALIAS_OK
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Outside World Access          PacketAliasSaveFragment()         PacketAliasGetFragment()         PacketAliasFragmentIn()         PacketAliasIn()         PacketAliasOut()  (prototypes in alias.h) */
end_comment

begin_function
name|int
name|PacketAliasSaveFragment
parameter_list|(
name|char
modifier|*
name|ptr
parameter_list|)
block|{
name|int
name|iresult
decl_stmt|;
name|struct
name|alias_link
modifier|*
name|link
decl_stmt|;
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
name|pip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|ptr
expr_stmt|;
name|link
operator|=
name|AddFragmentPtrLink
argument_list|(
name|pip
operator|->
name|ip_src
argument_list|,
name|pip
operator|->
name|ip_id
argument_list|)
expr_stmt|;
name|iresult
operator|=
name|PKT_ALIAS_ERROR
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL
condition|)
block|{
name|SetFragmentPtr
argument_list|(
name|link
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|iresult
operator|=
name|PKT_ALIAS_OK
expr_stmt|;
block|}
return|return
operator|(
name|iresult
operator|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|PacketAliasGetFragment
parameter_list|(
name|char
modifier|*
name|ptr
parameter_list|)
block|{
name|struct
name|alias_link
modifier|*
name|link
decl_stmt|;
name|char
modifier|*
name|fptr
decl_stmt|;
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
name|pip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|ptr
expr_stmt|;
name|link
operator|=
name|FindFragmentPtr
argument_list|(
name|pip
operator|->
name|ip_src
argument_list|,
name|pip
operator|->
name|ip_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL
condition|)
block|{
name|GetFragmentPtr
argument_list|(
name|link
argument_list|,
operator|&
name|fptr
argument_list|)
expr_stmt|;
name|SetFragmentPtr
argument_list|(
name|link
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|SetExpire
argument_list|(
name|link
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Deletes link */
return|return
operator|(
name|fptr
operator|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|NULL
operator|)
return|;
block|}
block|}
end_function

begin_function
name|void
name|PacketAliasFragmentIn
parameter_list|(
name|char
modifier|*
name|ptr
parameter_list|,
comment|/* Points to correctly de-aliased                                              header fragment */
name|char
modifier|*
name|ptr_fragment
comment|/* Points to fragment which must                                              be de-aliased   */
parameter_list|)
block|{
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
name|struct
name|ip
modifier|*
name|fpip
decl_stmt|;
name|pip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|ptr
expr_stmt|;
name|fpip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|ptr_fragment
expr_stmt|;
name|DifferentialChecksum
argument_list|(
operator|&
name|fpip
operator|->
name|ip_sum
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|pip
operator|->
name|ip_dst
argument_list|,
operator|(
name|u_short
operator|*
operator|)
operator|&
name|fpip
operator|->
name|ip_dst
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|fpip
operator|->
name|ip_dst
operator|=
name|pip
operator|->
name|ip_dst
expr_stmt|;
block|}
end_function

begin_function
name|int
name|PacketAliasIn
parameter_list|(
name|char
modifier|*
name|ptr
parameter_list|,
name|int
name|maxpacketsize
parameter_list|)
block|{
name|struct
name|in_addr
name|alias_addr
decl_stmt|;
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
name|int
name|iresult
decl_stmt|;
if|if
condition|(
name|packetAliasMode
operator|&
name|PKT_ALIAS_REVERSE
condition|)
block|{
name|packetAliasMode
operator|&=
operator|~
name|PKT_ALIAS_REVERSE
expr_stmt|;
name|iresult
operator|=
name|PacketAliasOut
argument_list|(
name|ptr
argument_list|,
name|maxpacketsize
argument_list|)
expr_stmt|;
name|packetAliasMode
operator||=
name|PKT_ALIAS_REVERSE
expr_stmt|;
return|return
name|iresult
return|;
block|}
name|HouseKeeping
argument_list|()
expr_stmt|;
name|ClearCheckNewLink
argument_list|()
expr_stmt|;
name|pip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|ptr
expr_stmt|;
name|alias_addr
operator|=
name|pip
operator|->
name|ip_dst
expr_stmt|;
comment|/* Defense against mangled packets */
if|if
condition|(
name|ntohs
argument_list|(
name|pip
operator|->
name|ip_len
argument_list|)
operator|>
name|maxpacketsize
operator|||
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|>
name|maxpacketsize
condition|)
return|return
name|PKT_ALIAS_IGNORED
return|;
name|iresult
operator|=
name|PKT_ALIAS_IGNORED
expr_stmt|;
if|if
condition|(
operator|(
name|ntohs
argument_list|(
name|pip
operator|->
name|ip_off
argument_list|)
operator|&
name|IP_OFFMASK
operator|)
operator|==
literal|0
condition|)
block|{
switch|switch
condition|(
name|pip
operator|->
name|ip_p
condition|)
block|{
case|case
name|IPPROTO_ICMP
case|:
name|iresult
operator|=
name|IcmpAliasIn
argument_list|(
name|pip
argument_list|)
expr_stmt|;
break|break;
case|case
name|IPPROTO_UDP
case|:
name|iresult
operator|=
name|UdpAliasIn
argument_list|(
name|pip
argument_list|)
expr_stmt|;
break|break;
case|case
name|IPPROTO_TCP
case|:
name|iresult
operator|=
name|TcpAliasIn
argument_list|(
name|pip
argument_list|)
expr_stmt|;
break|break;
case|case
name|IPPROTO_GRE
case|:
name|iresult
operator|=
name|GreAliasIn
argument_list|(
name|pip
argument_list|)
expr_stmt|;
break|break;
default|default:
name|iresult
operator|=
name|ProtoAliasIn
argument_list|(
name|pip
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ntohs
argument_list|(
name|pip
operator|->
name|ip_off
argument_list|)
operator|&
name|IP_MF
condition|)
block|{
name|struct
name|alias_link
modifier|*
name|link
decl_stmt|;
name|link
operator|=
name|FindFragmentIn1
argument_list|(
name|pip
operator|->
name|ip_src
argument_list|,
name|alias_addr
argument_list|,
name|pip
operator|->
name|ip_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|link
operator|!=
name|NULL
condition|)
block|{
name|iresult
operator|=
name|PKT_ALIAS_FOUND_HEADER_FRAGMENT
expr_stmt|;
name|SetFragmentAddr
argument_list|(
name|link
argument_list|,
name|pip
operator|->
name|ip_dst
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|iresult
operator|=
name|PKT_ALIAS_ERROR
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|iresult
operator|=
name|FragmentIn
argument_list|(
name|pip
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|iresult
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Unregistered address ranges */
end_comment

begin_comment
comment|/* 10.0.0.0   ->   10.255.255.255 */
end_comment

begin_define
define|#
directive|define
name|UNREG_ADDR_A_LOWER
value|0x0a000000
end_define

begin_define
define|#
directive|define
name|UNREG_ADDR_A_UPPER
value|0x0affffff
end_define

begin_comment
comment|/* 172.16.0.0  ->  172.31.255.255 */
end_comment

begin_define
define|#
directive|define
name|UNREG_ADDR_B_LOWER
value|0xac100000
end_define

begin_define
define|#
directive|define
name|UNREG_ADDR_B_UPPER
value|0xac1fffff
end_define

begin_comment
comment|/* 192.168.0.0 -> 192.168.255.255 */
end_comment

begin_define
define|#
directive|define
name|UNREG_ADDR_C_LOWER
value|0xc0a80000
end_define

begin_define
define|#
directive|define
name|UNREG_ADDR_C_UPPER
value|0xc0a8ffff
end_define

begin_function
name|int
name|PacketAliasOut
parameter_list|(
name|char
modifier|*
name|ptr
parameter_list|,
comment|/* valid IP packet */
name|int
name|maxpacketsize
comment|/* How much the packet data may grow                                        (FTP and IRC inline changes) */
parameter_list|)
block|{
name|int
name|iresult
decl_stmt|;
name|struct
name|in_addr
name|addr_save
decl_stmt|;
name|struct
name|ip
modifier|*
name|pip
decl_stmt|;
if|if
condition|(
name|packetAliasMode
operator|&
name|PKT_ALIAS_REVERSE
condition|)
block|{
name|packetAliasMode
operator|&=
operator|~
name|PKT_ALIAS_REVERSE
expr_stmt|;
name|iresult
operator|=
name|PacketAliasIn
argument_list|(
name|ptr
argument_list|,
name|maxpacketsize
argument_list|)
expr_stmt|;
name|packetAliasMode
operator||=
name|PKT_ALIAS_REVERSE
expr_stmt|;
return|return
name|iresult
return|;
block|}
name|HouseKeeping
argument_list|()
expr_stmt|;
name|ClearCheckNewLink
argument_list|()
expr_stmt|;
name|pip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|ptr
expr_stmt|;
comment|/* Defense against mangled packets */
if|if
condition|(
name|ntohs
argument_list|(
name|pip
operator|->
name|ip_len
argument_list|)
operator|>
name|maxpacketsize
operator|||
operator|(
name|pip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|>
name|maxpacketsize
condition|)
return|return
name|PKT_ALIAS_IGNORED
return|;
name|addr_save
operator|=
name|GetDefaultAliasAddress
argument_list|()
expr_stmt|;
if|if
condition|(
name|packetAliasMode
operator|&
name|PKT_ALIAS_UNREGISTERED_ONLY
condition|)
block|{
name|u_long
name|addr
decl_stmt|;
name|int
name|iclass
decl_stmt|;
name|iclass
operator|=
literal|0
expr_stmt|;
name|addr
operator|=
name|ntohl
argument_list|(
name|pip
operator|->
name|ip_src
operator|.
name|s_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
operator|>=
name|UNREG_ADDR_C_LOWER
operator|&&
name|addr
operator|<=
name|UNREG_ADDR_C_UPPER
condition|)
name|iclass
operator|=
literal|3
expr_stmt|;
elseif|else
if|if
condition|(
name|addr
operator|>=
name|UNREG_ADDR_B_LOWER
operator|&&
name|addr
operator|<=
name|UNREG_ADDR_B_UPPER
condition|)
name|iclass
operator|=
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|addr
operator|>=
name|UNREG_ADDR_A_LOWER
operator|&&
name|addr
operator|<=
name|UNREG_ADDR_A_UPPER
condition|)
name|iclass
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|iclass
operator|==
literal|0
condition|)
block|{
name|SetDefaultAliasAddress
argument_list|(
name|pip
operator|->
name|ip_src
argument_list|)
expr_stmt|;
block|}
block|}
name|iresult
operator|=
name|PKT_ALIAS_IGNORED
expr_stmt|;
if|if
condition|(
operator|(
name|ntohs
argument_list|(
name|pip
operator|->
name|ip_off
argument_list|)
operator|&
name|IP_OFFMASK
operator|)
operator|==
literal|0
condition|)
block|{
switch|switch
condition|(
name|pip
operator|->
name|ip_p
condition|)
block|{
case|case
name|IPPROTO_ICMP
case|:
name|iresult
operator|=
name|IcmpAliasOut
argument_list|(
name|pip
argument_list|)
expr_stmt|;
break|break;
case|case
name|IPPROTO_UDP
case|:
name|iresult
operator|=
name|UdpAliasOut
argument_list|(
name|pip
argument_list|)
expr_stmt|;
break|break;
case|case
name|IPPROTO_TCP
case|:
name|iresult
operator|=
name|TcpAliasOut
argument_list|(
name|pip
argument_list|,
name|maxpacketsize
argument_list|)
expr_stmt|;
break|break;
default|default:
name|iresult
operator|=
name|ProtoAliasOut
argument_list|(
name|pip
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|iresult
operator|=
name|FragmentOut
argument_list|(
name|pip
argument_list|)
expr_stmt|;
block|}
name|SetDefaultAliasAddress
argument_list|(
name|addr_save
argument_list|)
expr_stmt|;
return|return
operator|(
name|iresult
operator|)
return|;
block|}
end_function

end_unit


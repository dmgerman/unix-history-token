begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1999 FreeBSD(98) Porting Team.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer as  *    the first lines of this file unmodified.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHORS ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|"opt_syscons.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/consio.h>
end_include

begin_include
include|#
directive|include
file|<machine/pc/display.h>
end_include

begin_include
include|#
directive|include
file|<dev/syscons/syscons.h>
end_include

begin_include
include|#
directive|include
file|<dev/syscons/sctermvar.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|SC_DUMB_TERMINAL
end_ifndef

begin_define
define|#
directive|define
name|MAX_ESC_PAR
value|5
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|KANJI
end_ifdef

begin_define
define|#
directive|define
name|IS_KTYPE_ASCII_or_HANKAKU
parameter_list|(
name|A
parameter_list|)
value|(!((A)& 0xee))
end_define

begin_define
define|#
directive|define
name|IS_KTYPE_KANA
parameter_list|(
name|A
parameter_list|)
value|((A)& 0x11)
end_define

begin_define
define|#
directive|define
name|KTYPE_MASK_CTRL
parameter_list|(
name|A
parameter_list|)
value|((A)&= 0xF0)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* KANJI */
end_comment

begin_comment
comment|/* attribute flags */
end_comment

begin_typedef
typedef|typedef
struct|struct
block|{
name|u_short
name|fg
decl_stmt|;
comment|/* foreground color */
name|u_short
name|bg
decl_stmt|;
comment|/* background color */
block|}
name|color_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
name|int
name|flags
decl_stmt|;
define|#
directive|define
name|SCTERM_BUSY
value|(1<< 0)
name|int
name|esc
decl_stmt|;
name|int
name|num_param
decl_stmt|;
name|int
name|last_param
decl_stmt|;
name|int
name|param
index|[
name|MAX_ESC_PAR
index|]
decl_stmt|;
name|int
name|saved_xpos
decl_stmt|;
name|int
name|saved_ypos
decl_stmt|;
ifdef|#
directive|ifdef
name|KANJI
name|u_char
name|kanji_1st_char
decl_stmt|;
name|u_char
name|kanji_type
decl_stmt|;
define|#
directive|define
name|KTYPE_ASCII
value|0
comment|/* ASCII */
define|#
directive|define
name|KTYPE_KANA
value|1
comment|/* HANKAKU */
define|#
directive|define
name|KTYPE_JKANA
value|0x10
comment|/* JIS HANKAKU */
define|#
directive|define
name|KTYPE_7JIS
value|0x20
comment|/* JIS */
define|#
directive|define
name|KTYPE_SJIS
value|2
comment|/* Shift JIS */
define|#
directive|define
name|KTYPE_UJIS
value|4
comment|/* UJIS */
define|#
directive|define
name|KTYPE_SUKANA
value|3
comment|/* Shift JIS or UJIS HANKAKU */
define|#
directive|define
name|KTYPE_SUJIS
value|6
comment|/* SHift JIS or UJIS */
define|#
directive|define
name|KTYPE_KANIN
value|0x80
comment|/* Kanji Invoke sequence */
define|#
directive|define
name|KTYPE_ASCIN
value|0x40
comment|/* ASCII Invoke sequence */
endif|#
directive|endif
comment|/* KANJI */
name|int
name|attr_mask
decl_stmt|;
comment|/* current logical attr mask */
define|#
directive|define
name|NORMAL_ATTR
value|0x00
define|#
directive|define
name|BLINK_ATTR
value|0x01
define|#
directive|define
name|BOLD_ATTR
value|0x02
define|#
directive|define
name|UNDERLINE_ATTR
value|0x04
define|#
directive|define
name|REVERSE_ATTR
value|0x08
define|#
directive|define
name|FG_CHANGED
value|0x10
define|#
directive|define
name|BG_CHANGED
value|0x20
name|int
name|cur_attr
decl_stmt|;
comment|/* current hardware attr word */
name|color_t
name|cur_color
decl_stmt|;
comment|/* current hardware color */
name|color_t
name|std_color
decl_stmt|;
comment|/* normal hardware color */
name|color_t
name|rev_color
decl_stmt|;
comment|/* reverse hardware color */
name|color_t
name|dflt_std_color
decl_stmt|;
comment|/* default normal color */
name|color_t
name|dflt_rev_color
decl_stmt|;
comment|/* default reverse color */
block|}
name|term_stat
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|sc_term_init_t
name|scterm_init
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|sc_term_term_t
name|scterm_term
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|sc_term_puts_t
name|scterm_puts
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|sc_term_ioctl_t
name|scterm_ioctl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|sc_term_reset_t
name|scterm_reset
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|sc_term_default_attr_t
name|scterm_default_attr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|sc_term_clear_t
name|scterm_clear
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|sc_term_notify_t
name|scterm_notify
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|sc_term_input_t
name|scterm_input
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|sc_term_sw_t
name|sc_term_sc
init|=
block|{
block|{
name|NULL
block|,
name|NULL
block|}
block|,
literal|"sck"
block|,
comment|/* emulator name */
literal|"syscons kanji terminal"
block|,
comment|/* description */
literal|"*"
block|,
comment|/* matching renderer, any :-) */
sizeof|sizeof
argument_list|(
name|term_stat
argument_list|)
block|,
comment|/* softc size */
literal|0
block|,
name|scterm_init
block|,
name|scterm_term
block|,
name|scterm_puts
block|,
name|scterm_ioctl
block|,
name|scterm_reset
block|,
name|scterm_default_attr
block|,
name|scterm_clear
block|,
name|scterm_notify
block|,
name|scterm_input
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SCTERM_MODULE
argument_list|(
name|sc
argument_list|,
name|sc_term_sc
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|term_stat
name|reserved_term_stat
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|default_kanji
init|=
name|UJIS
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|scterm_scan_esc
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|term_stat
modifier|*
name|tcp
parameter_list|,
name|u_char
name|c
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|mask2attr
parameter_list|(
name|term_stat
modifier|*
name|tcp
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|KANJI
end_ifdef

begin_function
name|__inline
specifier|static
name|u_char
name|iskanji1
parameter_list|(
name|u_char
name|mode
parameter_list|,
name|u_char
name|c
parameter_list|)
block|{
if|if
condition|(
name|c
operator|>
literal|0x80
condition|)
block|{
if|if
condition|(
operator|(
name|c
operator|>=
literal|0xa1
operator|)
operator|&&
operator|(
name|c
operator|<=
literal|0xdf
operator|)
condition|)
block|{
if|if
condition|(
name|default_kanji
operator|==
name|UJIS
condition|)
block|{
comment|/* UJIS */
return|return
name|KTYPE_UJIS
return|;
block|}
if|if
condition|(
name|default_kanji
operator|==
name|SJIS
condition|)
block|{
comment|/* SJIS HANKAKU */
return|return
name|KTYPE_KANA
return|;
block|}
block|}
if|if
condition|(
name|c
operator|<=
literal|0x9f
condition|)
block|{
if|if
condition|(
name|c
operator|==
literal|0x8e
condition|)
block|{
comment|/* SJIS or UJIS HANKAKU */
return|return
name|KTYPE_SUKANA
return|;
block|}
comment|/* SJIS */
name|default_kanji
operator|=
name|SJIS
expr_stmt|;
return|return
name|KTYPE_SJIS
return|;
block|}
if|if
condition|(
operator|(
name|c
operator|>=
literal|0xe0
operator|)
operator|&&
operator|(
name|c
operator|<=
literal|0xef
operator|)
condition|)
block|{
comment|/* SJIS or UJIS */
return|return
name|KTYPE_SUJIS
return|;
block|}
if|if
condition|(
operator|(
name|c
operator|>=
literal|0xf0
operator|)
operator|&&
operator|(
name|c
operator|<=
literal|0xfe
operator|)
condition|)
block|{
comment|/* UJIS */
name|default_kanji
operator|=
name|UJIS
expr_stmt|;
return|return
name|KTYPE_UJIS
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
name|mode
operator|==
name|KTYPE_7JIS
operator|)
operator|&&
operator|(
name|c
operator|>=
literal|0x21
operator|)
operator|&&
operator|(
name|c
operator|<=
literal|0x7e
operator|)
condition|)
block|{
comment|/* JIS */
name|default_kanji
operator|=
name|UJIS
expr_stmt|;
return|return
name|KTYPE_7JIS
return|;
block|}
if|if
condition|(
operator|(
name|mode
operator|==
name|KTYPE_JKANA
operator|)
operator|&&
operator|(
name|c
operator|>=
literal|0x21
operator|)
operator|&&
operator|(
name|c
operator|<=
literal|0x5f
operator|)
condition|)
block|{
comment|/* JIS HANKAKU */
name|default_kanji
operator|=
name|UJIS
expr_stmt|;
return|return
name|KTYPE_JKANA
return|;
block|}
block|}
return|return
name|KTYPE_ASCII
return|;
block|}
end_function

begin_function
name|__inline
specifier|static
name|u_char
name|iskanji2
parameter_list|(
name|u_char
name|mode
parameter_list|,
name|u_char
name|c
parameter_list|)
block|{
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|KTYPE_7JIS
case|:
if|if
condition|(
operator|(
name|c
operator|>=
literal|0x21
operator|)
operator|&&
operator|(
name|c
operator|<=
literal|0x7e
operator|)
condition|)
block|{
comment|/* JIS */
return|return
name|KTYPE_7JIS
return|;
block|}
break|break;
case|case
name|KTYPE_SJIS
case|:
if|if
condition|(
operator|(
name|c
operator|>=
literal|0x40
operator|)
operator|&&
operator|(
name|c
operator|<=
literal|0xfc
operator|)
operator|&&
operator|(
name|c
operator|!=
literal|0x7f
operator|)
condition|)
block|{
comment|/* SJIS */
return|return
name|KTYPE_SJIS
return|;
block|}
break|break;
case|case
name|KTYPE_UJIS
case|:
if|if
condition|(
operator|(
name|c
operator|>=
literal|0xa1
operator|)
operator|&&
operator|(
name|c
operator|<=
literal|0xfe
operator|)
condition|)
block|{
comment|/* UJIS */
return|return
name|KTYPE_UJIS
return|;
block|}
break|break;
case|case
name|KTYPE_SUKANA
case|:
if|if
condition|(
operator|(
name|c
operator|>=
literal|0xa1
operator|)
operator|&&
operator|(
name|c
operator|<=
literal|0xdf
operator|)
operator|&&
operator|(
name|default_kanji
operator|==
name|UJIS
operator|)
condition|)
block|{
comment|/* UJIS HANKAKU */
return|return
name|KTYPE_KANA
return|;
block|}
if|if
condition|(
operator|(
name|c
operator|>=
literal|0x40
operator|)
operator|&&
operator|(
name|c
operator|<=
literal|0xfc
operator|)
operator|&&
operator|(
name|c
operator|!=
literal|0x7f
operator|)
condition|)
block|{
comment|/* SJIS */
name|default_kanji
operator|=
name|SJIS
expr_stmt|;
return|return
name|KTYPE_SJIS
return|;
block|}
break|break;
case|case
name|KTYPE_SUJIS
case|:
if|if
condition|(
operator|(
name|c
operator|>=
literal|0x40
operator|)
operator|&&
operator|(
name|c
operator|<=
literal|0xa0
operator|)
operator|&&
operator|(
name|c
operator|!=
literal|0x7f
operator|)
condition|)
block|{
comment|/* SJIS */
name|default_kanji
operator|=
name|SJIS
expr_stmt|;
return|return
name|KTYPE_SJIS
return|;
block|}
if|if
condition|(
operator|(
name|c
operator|==
literal|0xfd
operator|)
operator|||
operator|(
name|c
operator|==
literal|0xfe
operator|)
condition|)
block|{
comment|/* UJIS */
name|default_kanji
operator|=
name|UJIS
expr_stmt|;
return|return
name|KTYPE_UJIS
return|;
block|}
if|if
condition|(
operator|(
name|c
operator|>=
literal|0xa1
operator|)
operator|&&
operator|(
name|c
operator|<=
literal|0xfc
operator|)
condition|)
block|{
if|if
condition|(
name|default_kanji
operator|==
name|SJIS
condition|)
return|return
name|KTYPE_SJIS
return|;
if|if
condition|(
name|default_kanji
operator|==
name|UJIS
condition|)
return|return
name|KTYPE_UJIS
return|;
block|}
break|break;
block|}
return|return
name|KTYPE_ASCII
return|;
block|}
end_function

begin_comment
comment|/*  * JIS X0208-83 keisen conversion table  */
end_comment

begin_decl_stmt
specifier|static
name|u_short
name|keiConv
index|[
literal|32
index|]
init|=
block|{
literal|0x240c
block|,
literal|0x260c
block|,
literal|0x300c
block|,
literal|0x340c
block|,
literal|0x3c0c
block|,
literal|0x380c
block|,
literal|0x400c
block|,
literal|0x500c
block|,
literal|0x480c
block|,
literal|0x580c
block|,
literal|0x600c
block|,
literal|0x250c
block|,
literal|0x270c
block|,
literal|0x330c
block|,
literal|0x370c
block|,
literal|0x3f0c
block|,
literal|0x3b0c
block|,
literal|0x470c
block|,
literal|0x570c
block|,
literal|0x4f0c
block|,
literal|0x5f0c
block|,
literal|0x6f0c
block|,
literal|0x440c
block|,
literal|0x530c
block|,
literal|0x4c0c
block|,
literal|0x5b0c
block|,
literal|0x630c
block|,
literal|0x410c
block|,
literal|0x540c
block|,
literal|0x490c
block|,
literal|0x5c0c
block|,
literal|0x660c
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|u_short
name|kanji_convert
parameter_list|(
name|u_char
name|mode
parameter_list|,
name|u_char
name|h
parameter_list|,
name|u_char
name|l
parameter_list|)
block|{
name|u_short
name|tmp
decl_stmt|,
name|high
decl_stmt|,
name|low
decl_stmt|,
name|c
decl_stmt|;
name|high
operator|=
operator|(
name|u_short
operator|)
name|h
expr_stmt|;
name|low
operator|=
operator|(
name|u_short
operator|)
name|l
expr_stmt|;
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|KTYPE_SJIS
case|:
comment|/* SHIFT JIS */
if|if
condition|(
name|low
operator|>=
literal|0xe0
condition|)
block|{
name|low
operator|-=
literal|0x40
expr_stmt|;
block|}
name|low
operator|=
operator|(
name|low
operator|-
literal|0x81
operator|)
operator|*
literal|2
operator|+
literal|0x21
expr_stmt|;
if|if
condition|(
name|high
operator|>
literal|0x7f
condition|)
block|{
name|high
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|high
operator|>
literal|0x9d
condition|)
block|{
name|low
operator|++
expr_stmt|;
name|high
operator|-=
literal|0x9e
operator|-
literal|0x21
expr_stmt|;
block|}
else|else
block|{
name|high
operator|-=
literal|0x40
operator|-
literal|0x21
expr_stmt|;
block|}
name|high
operator|&=
literal|0x7F
expr_stmt|;
name|low
operator|&=
literal|0x7F
expr_stmt|;
name|tmp
operator|=
operator|(
operator|(
name|high
operator|<<
literal|8
operator|)
operator||
name|low
operator|)
operator|-
literal|0x20
expr_stmt|;
break|break;
case|case
name|KTYPE_7JIS
case|:
comment|/* JIS */
case|case
name|KTYPE_UJIS
case|:
comment|/* UJIS */
name|high
operator|&=
literal|0x7F
expr_stmt|;
name|low
operator|&=
literal|0x7F
expr_stmt|;
name|tmp
operator|=
operator|(
operator|(
name|high
operator|<<
literal|8
operator|)
operator||
name|low
operator|)
operator|-
literal|0x20
expr_stmt|;
break|break;
default|default:
name|tmp
operator|=
literal|0
expr_stmt|;
break|break;
block|}
comment|/* keisen */
name|c
operator|=
operator|(
operator|(
name|tmp
operator|&
literal|0xff
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
name|tmp
operator|>>
literal|8
operator|)
expr_stmt|;
comment|/* 0x2821 .. 0x2840 */
if|if
condition|(
literal|0x0821
operator|<=
name|c
operator|&&
name|c
operator|<=
literal|0x0840
condition|)
name|tmp
operator|=
name|keiConv
index|[
name|c
operator|-
literal|0x0821
index|]
expr_stmt|;
return|return
operator|(
name|tmp
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* KANJI */
end_comment

begin_function
specifier|static
name|int
name|scterm_init
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|void
modifier|*
modifier|*
name|softc
parameter_list|,
name|int
name|code
parameter_list|)
block|{
name|term_stat
modifier|*
name|tcp
decl_stmt|;
if|if
condition|(
operator|*
name|softc
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|reserved_term_stat
operator|.
name|flags
operator|&
name|SCTERM_BUSY
condition|)
return|return
name|EINVAL
return|;
operator|*
name|softc
operator|=
operator|&
name|reserved_term_stat
expr_stmt|;
block|}
name|tcp
operator|=
operator|*
name|softc
expr_stmt|;
switch|switch
condition|(
name|code
condition|)
block|{
case|case
name|SC_TE_COLD_INIT
case|:
name|bzero
argument_list|(
name|tcp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tcp
argument_list|)
argument_list|)
expr_stmt|;
name|tcp
operator|->
name|flags
operator|=
name|SCTERM_BUSY
expr_stmt|;
name|tcp
operator|->
name|esc
operator|=
literal|0
expr_stmt|;
name|tcp
operator|->
name|saved_xpos
operator|=
operator|-
literal|1
expr_stmt|;
name|tcp
operator|->
name|saved_ypos
operator|=
operator|-
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|KANJI
name|tcp
operator|->
name|kanji_1st_char
operator|=
literal|0
expr_stmt|;
name|tcp
operator|->
name|kanji_type
operator|=
name|KTYPE_ASCII
expr_stmt|;
endif|#
directive|endif
name|tcp
operator|->
name|attr_mask
operator|=
name|NORMAL_ATTR
expr_stmt|;
comment|/* XXX */
name|tcp
operator|->
name|dflt_std_color
operator|.
name|fg
operator|=
name|SC_NORM_ATTR
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|dflt_std_color
operator|.
name|bg
operator|=
operator|(
name|SC_NORM_ATTR
operator|>>
literal|4
operator|)
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|dflt_rev_color
operator|.
name|fg
operator|=
name|SC_NORM_REV_ATTR
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|dflt_rev_color
operator|.
name|bg
operator|=
operator|(
name|SC_NORM_REV_ATTR
operator|>>
literal|4
operator|)
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|std_color
operator|=
name|tcp
operator|->
name|dflt_std_color
expr_stmt|;
name|tcp
operator|->
name|rev_color
operator|=
name|tcp
operator|->
name|dflt_rev_color
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|=
name|tcp
operator|->
name|std_color
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
operator|++
name|sc_term_sc
operator|.
name|te_refcount
expr_stmt|;
break|break;
case|case
name|SC_TE_WARM_INIT
case|:
name|tcp
operator|->
name|esc
operator|=
literal|0
expr_stmt|;
name|tcp
operator|->
name|saved_xpos
operator|=
operator|-
literal|1
expr_stmt|;
name|tcp
operator|->
name|saved_ypos
operator|=
operator|-
literal|1
expr_stmt|;
if|#
directive|if
literal|0
block|tcp->std_color = tcp->dflt_std_color; 		tcp->rev_color = tcp->dflt_rev_color;
endif|#
directive|endif
name|tcp
operator|->
name|cur_color
operator|=
name|tcp
operator|->
name|std_color
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scterm_term
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|void
modifier|*
modifier|*
name|softc
parameter_list|)
block|{
if|if
condition|(
operator|*
name|softc
operator|==
operator|&
name|reserved_term_stat
condition|)
block|{
operator|*
name|softc
operator|=
name|NULL
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|reserved_term_stat
argument_list|,
sizeof|sizeof
argument_list|(
name|reserved_term_stat
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|--
name|sc_term_sc
operator|.
name|te_refcount
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|scterm_scan_esc
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|term_stat
modifier|*
name|tcp
parameter_list|,
name|u_char
name|c
parameter_list|)
block|{
specifier|static
name|u_char
name|ansi_col
index|[
literal|16
index|]
init|=
block|{
name|FG_BLACK
block|,
name|FG_RED
block|,
name|FG_GREEN
block|,
name|FG_BROWN
block|,
name|FG_BLUE
block|,
name|FG_MAGENTA
block|,
name|FG_CYAN
block|,
name|FG_LIGHTGREY
block|,
name|FG_DARKGREY
block|,
name|FG_LIGHTRED
block|,
name|FG_LIGHTGREEN
block|,
name|FG_YELLOW
block|,
name|FG_LIGHTBLUE
block|,
name|FG_LIGHTMAGENTA
block|,
name|FG_LIGHTCYAN
block|,
name|FG_WHITE
block|}
decl_stmt|;
specifier|static
name|int
name|cattrs
index|[]
init|=
block|{
literal|0
block|,
comment|/* block */
name|CONS_BLINK_CURSOR
block|,
comment|/* blinking block */
name|CONS_CHAR_CURSOR
block|,
comment|/* underline */
name|CONS_CHAR_CURSOR
operator||
name|CONS_BLINK_CURSOR
block|,
comment|/* blinking underline */
name|CONS_RESET_CURSOR
block|,
comment|/* reset to default */
name|CONS_HIDDEN_CURSOR
block|,
comment|/* hide cursor */
block|}
decl_stmt|;
specifier|static
name|int
name|tcattrs
index|[]
init|=
block|{
name|CONS_RESET_CURSOR
operator||
name|CONS_LOCAL_CURSOR
block|,
comment|/* normal */
name|CONS_HIDDEN_CURSOR
operator||
name|CONS_LOCAL_CURSOR
block|,
comment|/* invisible */
name|CONS_BLINK_CURSOR
operator||
name|CONS_LOCAL_CURSOR
block|,
comment|/* very visible */
block|}
decl_stmt|;
name|sc_softc_t
modifier|*
name|sc
decl_stmt|;
name|int
name|v0
decl_stmt|,
name|v1
decl_stmt|,
name|v2
decl_stmt|;
name|int
name|i
decl_stmt|,
name|n
decl_stmt|;
name|i
operator|=
name|n
operator|=
literal|0
expr_stmt|;
name|sc
operator|=
name|scp
operator|->
name|sc
expr_stmt|;
if|if
condition|(
name|tcp
operator|->
name|esc
operator|==
literal|1
condition|)
block|{
comment|/* seen ESC */
ifdef|#
directive|ifdef
name|KANJI
switch|switch
condition|(
name|tcp
operator|->
name|kanji_type
condition|)
block|{
case|case
name|KTYPE_KANIN
case|:
comment|/* Kanji Invoke sequence */
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'B'
case|:
case|case
literal|'@'
case|:
name|tcp
operator|->
name|kanji_type
operator|=
name|KTYPE_7JIS
expr_stmt|;
name|tcp
operator|->
name|esc
operator|=
literal|0
expr_stmt|;
name|tcp
operator|->
name|kanji_1st_char
operator|=
literal|0
expr_stmt|;
return|return;
default|default:
name|tcp
operator|->
name|kanji_type
operator|=
name|KTYPE_ASCII
expr_stmt|;
name|tcp
operator|->
name|esc
operator|=
literal|0
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|KTYPE_ASCIN
case|:
comment|/* Ascii Invoke sequence */
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'J'
case|:
case|case
literal|'B'
case|:
case|case
literal|'H'
case|:
name|tcp
operator|->
name|kanji_type
operator|=
name|KTYPE_ASCII
expr_stmt|;
name|tcp
operator|->
name|esc
operator|=
literal|0
expr_stmt|;
name|tcp
operator|->
name|kanji_1st_char
operator|=
literal|0
expr_stmt|;
return|return;
case|case
literal|'I'
case|:
name|tcp
operator|->
name|kanji_type
operator|=
name|KTYPE_JKANA
expr_stmt|;
name|tcp
operator|->
name|esc
operator|=
literal|0
expr_stmt|;
name|tcp
operator|->
name|kanji_1st_char
operator|=
literal|0
expr_stmt|;
return|return;
default|default:
name|tcp
operator|->
name|kanji_type
operator|=
name|KTYPE_ASCII
expr_stmt|;
name|tcp
operator|->
name|esc
operator|=
literal|0
expr_stmt|;
break|break;
block|}
break|break;
default|default:
break|break;
block|}
endif|#
directive|endif
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'7'
case|:
comment|/* Save cursor position */
name|tcp
operator|->
name|saved_xpos
operator|=
name|scp
operator|->
name|xpos
expr_stmt|;
name|tcp
operator|->
name|saved_ypos
operator|=
name|scp
operator|->
name|ypos
expr_stmt|;
break|break;
case|case
literal|'8'
case|:
comment|/* Restore saved cursor position */
if|if
condition|(
name|tcp
operator|->
name|saved_xpos
operator|>=
literal|0
operator|&&
name|tcp
operator|->
name|saved_ypos
operator|>=
literal|0
condition|)
name|sc_move_cursor
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|saved_xpos
argument_list|,
name|tcp
operator|->
name|saved_ypos
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'['
case|:
comment|/* Start ESC [ sequence */
name|tcp
operator|->
name|esc
operator|=
literal|2
expr_stmt|;
name|tcp
operator|->
name|last_param
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
name|tcp
operator|->
name|num_param
init|;
name|i
operator|<
name|MAX_ESC_PAR
condition|;
name|i
operator|++
control|)
name|tcp
operator|->
name|param
index|[
name|i
index|]
operator|=
literal|1
expr_stmt|;
name|tcp
operator|->
name|num_param
operator|=
literal|0
expr_stmt|;
return|return;
ifdef|#
directive|ifdef
name|KANJI
case|case
literal|'$'
case|:
comment|/* Kanji Invoke sequence */
name|tcp
operator|->
name|kanji_type
operator|=
name|KTYPE_KANIN
expr_stmt|;
return|return;
endif|#
directive|endif
case|case
literal|'M'
case|:
comment|/* Move cursor up 1 line, scroll if at top */
name|sc_term_up_scroll
argument_list|(
name|scp
argument_list|,
literal|1
argument_list|,
name|sc
operator|->
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|tcp
operator|->
name|cur_attr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
if|#
directive|if
name|notyet
case|case
literal|'Q'
case|:
name|tcp
operator|->
name|esc
operator|=
literal|4
expr_stmt|;
return|return;
endif|#
directive|endif
case|case
literal|'c'
case|:
comment|/* reset */
name|tcp
operator|->
name|attr_mask
operator|=
name|NORMAL_ATTR
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|=
name|tcp
operator|->
name|std_color
operator|=
name|tcp
operator|->
name|dflt_std_color
expr_stmt|;
name|tcp
operator|->
name|rev_color
operator|=
name|tcp
operator|->
name|dflt_rev_color
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
name|sc_change_cursor_shape
argument_list|(
name|scp
argument_list|,
name|CONS_RESET_CURSOR
operator||
name|CONS_LOCAL_CURSOR
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|sc_clear_screen
argument_list|(
name|scp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'('
case|:
comment|/* iso-2022: designate 94 character set to G0 */
ifdef|#
directive|ifdef
name|KANJI
name|tcp
operator|->
name|kanji_type
operator|=
name|KTYPE_ASCIN
expr_stmt|;
else|#
directive|else
name|tcp
operator|->
name|esc
operator|=
literal|5
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
block|}
elseif|else
if|if
condition|(
name|tcp
operator|->
name|esc
operator|==
literal|2
condition|)
block|{
comment|/* seen ESC [ */
if|if
condition|(
name|c
operator|>=
literal|'0'
operator|&&
name|c
operator|<=
literal|'9'
condition|)
block|{
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|<
name|MAX_ESC_PAR
condition|)
block|{
if|if
condition|(
name|tcp
operator|->
name|last_param
operator|!=
name|tcp
operator|->
name|num_param
condition|)
block|{
name|tcp
operator|->
name|last_param
operator|=
name|tcp
operator|->
name|num_param
expr_stmt|;
name|tcp
operator|->
name|param
index|[
name|tcp
operator|->
name|num_param
index|]
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|tcp
operator|->
name|param
index|[
name|tcp
operator|->
name|num_param
index|]
operator|*=
literal|10
expr_stmt|;
block|}
name|tcp
operator|->
name|param
index|[
name|tcp
operator|->
name|num_param
index|]
operator|+=
name|c
operator|-
literal|'0'
expr_stmt|;
return|return;
block|}
block|}
name|tcp
operator|->
name|num_param
operator|=
name|tcp
operator|->
name|last_param
operator|+
literal|1
expr_stmt|;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|';'
case|:
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|<
name|MAX_ESC_PAR
condition|)
return|return;
break|break;
case|case
literal|'='
case|:
name|tcp
operator|->
name|esc
operator|=
literal|3
expr_stmt|;
name|tcp
operator|->
name|last_param
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
name|tcp
operator|->
name|num_param
init|;
name|i
operator|<
name|MAX_ESC_PAR
condition|;
name|i
operator|++
control|)
name|tcp
operator|->
name|param
index|[
name|i
index|]
operator|=
literal|1
expr_stmt|;
name|tcp
operator|->
name|num_param
operator|=
literal|0
expr_stmt|;
return|return;
case|case
literal|'A'
case|:
comment|/* up n rows */
name|sc_term_up
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
comment|/* down n rows */
name|sc_term_down
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
comment|/* right n columns */
name|sc_term_right
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
comment|/* left n columns */
name|sc_term_left
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'E'
case|:
comment|/* cursor to start of line n lines down */
name|n
operator|=
name|tcp
operator|->
name|param
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
condition|)
name|n
operator|=
literal|1
expr_stmt|;
name|sc_move_cursor
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|,
name|scp
operator|->
name|ypos
operator|+
name|n
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'F'
case|:
comment|/* cursor to start of line n lines up */
name|n
operator|=
name|tcp
operator|->
name|param
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
condition|)
name|n
operator|=
literal|1
expr_stmt|;
name|sc_move_cursor
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|,
name|scp
operator|->
name|ypos
operator|-
name|n
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
comment|/* Cursor move */
case|case
literal|'H'
case|:
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|0
condition|)
name|sc_move_cursor
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|2
condition|)
name|sc_move_cursor
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|1
index|]
operator|-
literal|1
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'J'
case|:
comment|/* Clear all or part of display */
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|0
condition|)
name|n
operator|=
literal|0
expr_stmt|;
else|else
name|n
operator|=
name|tcp
operator|->
name|param
index|[
literal|0
index|]
expr_stmt|;
name|sc_term_clr_eos
argument_list|(
name|scp
argument_list|,
name|n
argument_list|,
name|sc
operator|->
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|tcp
operator|->
name|cur_attr
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'K'
case|:
comment|/* Clear all or part of line */
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|0
condition|)
name|n
operator|=
literal|0
expr_stmt|;
else|else
name|n
operator|=
name|tcp
operator|->
name|param
index|[
literal|0
index|]
expr_stmt|;
name|sc_term_clr_eol
argument_list|(
name|scp
argument_list|,
name|n
argument_list|,
name|sc
operator|->
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|tcp
operator|->
name|cur_attr
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'L'
case|:
comment|/* Insert n lines */
name|sc_term_ins_line
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|ypos
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|,
name|sc
operator|->
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|tcp
operator|->
name|cur_attr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'M'
case|:
comment|/* Delete n lines */
name|sc_term_del_line
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|ypos
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|,
name|sc
operator|->
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|tcp
operator|->
name|cur_attr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
comment|/* Delete n chars */
name|sc_term_del_char
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|,
name|sc
operator|->
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|tcp
operator|->
name|cur_attr
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'@'
case|:
comment|/* Insert n chars */
name|sc_term_ins_char
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|,
name|sc
operator|->
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|tcp
operator|->
name|cur_attr
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
comment|/* scroll up n lines */
name|sc_term_del_line
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|,
name|sc
operator|->
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|tcp
operator|->
name|cur_attr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'T'
case|:
comment|/* scroll down n lines */
name|sc_term_ins_line
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|,
name|sc
operator|->
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|tcp
operator|->
name|cur_attr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'X'
case|:
comment|/* erase n characters in line */
name|n
operator|=
name|tcp
operator|->
name|param
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|1
condition|)
name|n
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|n
operator|>
name|scp
operator|->
name|xsize
operator|-
name|scp
operator|->
name|xpos
condition|)
name|n
operator|=
name|scp
operator|->
name|xsize
operator|-
name|scp
operator|->
name|xpos
expr_stmt|;
name|sc_vtb_erase
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|scp
operator|->
name|cursor_pos
argument_list|,
name|n
argument_list|,
name|sc
operator|->
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|tcp
operator|->
name|cur_attr
argument_list|)
expr_stmt|;
name|mark_for_update
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|cursor_pos
argument_list|)
expr_stmt|;
name|mark_for_update
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|cursor_pos
operator|+
name|n
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'Z'
case|:
comment|/* move n tabs backwards */
name|sc_term_backtab
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'`'
case|:
comment|/* move cursor to column n */
name|sc_term_col
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'a'
case|:
comment|/* move cursor n columns to the right */
name|sc_term_right
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
comment|/* move cursor to row n */
name|sc_term_row
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'e'
case|:
comment|/* move cursor n rows down */
name|sc_term_down
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
comment|/* change attribute */
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|0
condition|)
block|{
name|tcp
operator|->
name|attr_mask
operator|=
name|NORMAL_ATTR
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|=
name|tcp
operator|->
name|std_color
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tcp
operator|->
name|num_param
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|n
operator|=
name|tcp
operator|->
name|param
index|[
name|i
index|]
condition|)
block|{
case|case
literal|0
case|:
comment|/* back to normal */
name|tcp
operator|->
name|attr_mask
operator|=
name|NORMAL_ATTR
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|=
name|tcp
operator|->
name|std_color
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* bold */
name|tcp
operator|->
name|attr_mask
operator||=
name|BOLD_ATTR
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/* underline */
name|tcp
operator|->
name|attr_mask
operator||=
name|UNDERLINE_ATTR
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
comment|/* blink */
name|tcp
operator|->
name|attr_mask
operator||=
name|BLINK_ATTR
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|7
case|:
comment|/* reverse */
name|tcp
operator|->
name|attr_mask
operator||=
name|REVERSE_ATTR
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|22
case|:
comment|/* remove bold (or dim) */
name|tcp
operator|->
name|attr_mask
operator|&=
operator|~
name|BOLD_ATTR
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|24
case|:
comment|/* remove underline */
name|tcp
operator|->
name|attr_mask
operator|&=
operator|~
name|UNDERLINE_ATTR
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|25
case|:
comment|/* remove blink */
name|tcp
operator|->
name|attr_mask
operator|&=
operator|~
name|BLINK_ATTR
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|27
case|:
comment|/* remove reverse */
name|tcp
operator|->
name|attr_mask
operator|&=
operator|~
name|REVERSE_ATTR
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|30
case|:
case|case
literal|31
case|:
comment|/* set ansi fg color */
case|case
literal|32
case|:
case|case
literal|33
case|:
case|case
literal|34
case|:
case|case
literal|35
case|:
case|case
literal|36
case|:
case|case
literal|37
case|:
name|tcp
operator|->
name|attr_mask
operator||=
name|FG_CHANGED
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|.
name|fg
operator|=
name|ansi_col
index|[
name|n
operator|-
literal|30
index|]
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|39
case|:
comment|/* restore fg color back to normal */
name|tcp
operator|->
name|attr_mask
operator|&=
operator|~
operator|(
name|FG_CHANGED
operator||
name|BOLD_ATTR
operator|)
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|.
name|fg
operator|=
name|tcp
operator|->
name|std_color
operator|.
name|fg
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|40
case|:
case|case
literal|41
case|:
comment|/* set ansi bg color */
case|case
literal|42
case|:
case|case
literal|43
case|:
case|case
literal|44
case|:
case|case
literal|45
case|:
case|case
literal|46
case|:
case|case
literal|47
case|:
name|tcp
operator|->
name|attr_mask
operator||=
name|BG_CHANGED
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|.
name|bg
operator|=
name|ansi_col
index|[
name|n
operator|-
literal|40
index|]
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|49
case|:
comment|/* restore bg color back to normal */
name|tcp
operator|->
name|attr_mask
operator|&=
operator|~
name|BG_CHANGED
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|.
name|bg
operator|=
name|tcp
operator|->
name|std_color
operator|.
name|bg
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
break|break;
case|case
literal|'s'
case|:
comment|/* Save cursor position */
name|tcp
operator|->
name|saved_xpos
operator|=
name|scp
operator|->
name|xpos
expr_stmt|;
name|tcp
operator|->
name|saved_ypos
operator|=
name|scp
operator|->
name|ypos
expr_stmt|;
break|break;
case|case
literal|'u'
case|:
comment|/* Restore saved cursor position */
if|if
condition|(
name|tcp
operator|->
name|saved_xpos
operator|>=
literal|0
operator|&&
name|tcp
operator|->
name|saved_ypos
operator|>=
literal|0
condition|)
name|sc_move_cursor
argument_list|(
name|scp
argument_list|,
name|tcp
operator|->
name|saved_xpos
argument_list|,
name|tcp
operator|->
name|saved_ypos
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|0
condition|)
name|n
operator|=
literal|0
expr_stmt|;
else|else
name|n
operator|=
name|tcp
operator|->
name|param
index|[
literal|0
index|]
expr_stmt|;
switch|switch
condition|(
name|n
condition|)
block|{
case|case
literal|0
case|:
comment|/* reset colors and attributes back to normal */
name|tcp
operator|->
name|attr_mask
operator|=
name|NORMAL_ATTR
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|=
name|tcp
operator|->
name|std_color
operator|=
name|tcp
operator|->
name|dflt_std_color
expr_stmt|;
name|tcp
operator|->
name|rev_color
operator|=
name|tcp
operator|->
name|dflt_rev_color
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* set ansi background */
name|tcp
operator|->
name|attr_mask
operator|&=
operator|~
name|BG_CHANGED
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|.
name|bg
operator|=
name|tcp
operator|->
name|std_color
operator|.
name|bg
operator|=
name|ansi_col
index|[
name|tcp
operator|->
name|param
index|[
literal|1
index|]
operator|&
literal|0x0f
index|]
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* set ansi foreground */
name|tcp
operator|->
name|attr_mask
operator|&=
operator|~
name|FG_CHANGED
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|.
name|fg
operator|=
name|tcp
operator|->
name|std_color
operator|.
name|fg
operator|=
name|ansi_col
index|[
name|tcp
operator|->
name|param
index|[
literal|1
index|]
operator|&
literal|0x0f
index|]
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
comment|/* set adapter attribute directly */
name|tcp
operator|->
name|attr_mask
operator|&=
operator|~
operator|(
name|FG_CHANGED
operator||
name|BG_CHANGED
operator|)
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|.
name|fg
operator|=
name|tcp
operator|->
name|std_color
operator|.
name|fg
operator|=
name|tcp
operator|->
name|param
index|[
literal|1
index|]
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|.
name|bg
operator|=
name|tcp
operator|->
name|std_color
operator|.
name|bg
operator|=
operator|(
name|tcp
operator|->
name|param
index|[
literal|1
index|]
operator|>>
literal|4
operator|)
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
comment|/* set ansi reverse background */
name|tcp
operator|->
name|rev_color
operator|.
name|bg
operator|=
name|ansi_col
index|[
name|tcp
operator|->
name|param
index|[
literal|1
index|]
operator|&
literal|0x0f
index|]
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
comment|/* set ansi reverse foreground */
name|tcp
operator|->
name|rev_color
operator|.
name|fg
operator|=
name|ansi_col
index|[
name|tcp
operator|->
name|param
index|[
literal|1
index|]
operator|&
literal|0x0f
index|]
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|7
case|:
comment|/* set adapter reverse attribute directly */
name|tcp
operator|->
name|rev_color
operator|.
name|fg
operator|=
name|tcp
operator|->
name|param
index|[
literal|1
index|]
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|rev_color
operator|.
name|bg
operator|=
operator|(
name|tcp
operator|->
name|param
index|[
literal|1
index|]
operator|>>
literal|4
operator|)
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|'z'
case|:
comment|/* switch to (virtual) console n */
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|1
condition|)
name|sc_switch_scr
argument_list|(
name|sc
argument_list|,
name|tcp
operator|->
name|param
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
elseif|else
if|if
condition|(
name|tcp
operator|->
name|esc
operator|==
literal|3
condition|)
block|{
comment|/* seen ESC [0-9]+ = */
if|if
condition|(
name|c
operator|>=
literal|'0'
operator|&&
name|c
operator|<=
literal|'9'
condition|)
block|{
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|<
name|MAX_ESC_PAR
condition|)
block|{
if|if
condition|(
name|tcp
operator|->
name|last_param
operator|!=
name|tcp
operator|->
name|num_param
condition|)
block|{
name|tcp
operator|->
name|last_param
operator|=
name|tcp
operator|->
name|num_param
expr_stmt|;
name|tcp
operator|->
name|param
index|[
name|tcp
operator|->
name|num_param
index|]
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|tcp
operator|->
name|param
index|[
name|tcp
operator|->
name|num_param
index|]
operator|*=
literal|10
expr_stmt|;
block|}
name|tcp
operator|->
name|param
index|[
name|tcp
operator|->
name|num_param
index|]
operator|+=
name|c
operator|-
literal|'0'
expr_stmt|;
return|return;
block|}
block|}
name|tcp
operator|->
name|num_param
operator|=
name|tcp
operator|->
name|last_param
operator|+
literal|1
expr_stmt|;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|';'
case|:
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|<
name|MAX_ESC_PAR
condition|)
return|return;
break|break;
case|case
literal|'A'
case|:
comment|/* set display border color */
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|1
condition|)
block|{
name|scp
operator|->
name|border
operator|=
name|tcp
operator|->
name|param
index|[
literal|0
index|]
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|scp
operator|==
name|sc
operator|->
name|cur_scp
condition|)
name|sc_set_border
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|border
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'B'
case|:
comment|/* set bell pitch and duration */
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|2
condition|)
block|{
name|scp
operator|->
name|bell_pitch
operator|=
name|tcp
operator|->
name|param
index|[
literal|0
index|]
expr_stmt|;
name|scp
operator|->
name|bell_duration
operator|=
operator|(
name|tcp
operator|->
name|param
index|[
literal|1
index|]
operator|*
name|hz
operator|+
literal|99
operator|)
operator|/
literal|100
expr_stmt|;
block|}
break|break;
case|case
literal|'C'
case|:
comment|/* set global/parmanent cursor type& shape */
name|i
operator|=
name|spltty
argument_list|()
expr_stmt|;
name|n
operator|=
name|tcp
operator|->
name|num_param
expr_stmt|;
name|v0
operator|=
name|tcp
operator|->
name|param
index|[
literal|0
index|]
expr_stmt|;
name|v1
operator|=
name|tcp
operator|->
name|param
index|[
literal|1
index|]
expr_stmt|;
name|v2
operator|=
name|tcp
operator|->
name|param
index|[
literal|2
index|]
expr_stmt|;
switch|switch
condition|(
name|n
condition|)
block|{
case|case
literal|1
case|:
comment|/* flags only */
if|if
condition|(
name|v0
operator|<
sizeof|sizeof
argument_list|(
name|cattrs
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|cattrs
index|[
literal|0
index|]
argument_list|)
condition|)
name|v0
operator|=
name|cattrs
index|[
name|v0
index|]
expr_stmt|;
else|else
comment|/* backward compatibility */
name|v0
operator|=
name|cattrs
index|[
name|v0
operator|&
literal|0x3
index|]
expr_stmt|;
name|sc_change_cursor_shape
argument_list|(
name|scp
argument_list|,
name|v0
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|v2
operator|=
literal|0
expr_stmt|;
name|v0
operator|&=
literal|0x1f
expr_stmt|;
comment|/* backward compatibility */
name|v1
operator|&=
literal|0x1f
expr_stmt|;
comment|/* FALL THROUGH */
case|case
literal|3
case|:
comment|/* base and height */
if|if
condition|(
name|v2
operator|==
literal|0
condition|)
comment|/* count from top */
name|sc_change_cursor_shape
argument_list|(
name|scp
argument_list|,
operator|-
literal|1
argument_list|,
name|scp
operator|->
name|font_size
operator|-
name|v1
operator|-
literal|1
argument_list|,
name|v1
operator|-
name|v0
operator|+
literal|1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|v2
operator|==
literal|1
condition|)
comment|/* count from bottom */
name|sc_change_cursor_shape
argument_list|(
name|scp
argument_list|,
operator|-
literal|1
argument_list|,
name|v0
argument_list|,
name|v1
operator|-
name|v0
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
name|splx
argument_list|(
name|i
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'F'
case|:
comment|/* set adapter foreground */
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|1
condition|)
block|{
name|tcp
operator|->
name|attr_mask
operator|&=
operator|~
name|FG_CHANGED
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|.
name|fg
operator|=
name|tcp
operator|->
name|std_color
operator|.
name|fg
operator|=
name|tcp
operator|->
name|param
index|[
literal|0
index|]
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'G'
case|:
comment|/* set adapter background */
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|1
condition|)
block|{
name|tcp
operator|->
name|attr_mask
operator|&=
operator|~
name|BG_CHANGED
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|.
name|bg
operator|=
name|tcp
operator|->
name|std_color
operator|.
name|bg
operator|=
name|tcp
operator|->
name|param
index|[
literal|0
index|]
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'H'
case|:
comment|/* set adapter reverse foreground */
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|1
condition|)
block|{
name|tcp
operator|->
name|rev_color
operator|.
name|fg
operator|=
name|tcp
operator|->
name|param
index|[
literal|0
index|]
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'I'
case|:
comment|/* set adapter reverse background */
if|if
condition|(
name|tcp
operator|->
name|num_param
operator|==
literal|1
condition|)
block|{
name|tcp
operator|->
name|rev_color
operator|.
name|bg
operator|=
name|tcp
operator|->
name|param
index|[
literal|0
index|]
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'S'
case|:
comment|/* set local/temporary cursor type& shape */
name|i
operator|=
name|spltty
argument_list|()
expr_stmt|;
name|n
operator|=
name|tcp
operator|->
name|num_param
expr_stmt|;
name|v0
operator|=
name|tcp
operator|->
name|param
index|[
literal|0
index|]
expr_stmt|;
switch|switch
condition|(
name|n
condition|)
block|{
case|case
literal|0
case|:
name|v0
operator|=
literal|0
expr_stmt|;
comment|/* FALL THROUGH */
case|case
literal|1
case|:
if|if
condition|(
name|v0
operator|<
sizeof|sizeof
argument_list|(
name|tcattrs
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|tcattrs
index|[
literal|0
index|]
argument_list|)
condition|)
name|sc_change_cursor_shape
argument_list|(
name|scp
argument_list|,
name|tcattrs
index|[
name|v0
index|]
argument_list|,
operator|-
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
name|splx
argument_list|(
name|i
argument_list|)
expr_stmt|;
break|break;
block|}
if|#
directive|if
name|notyet
block|}
elseif|else
if|if
condition|(
name|tcp
operator|->
name|esc
operator|==
literal|4
condition|)
block|{
comment|/* seen ESC Q */
comment|/* to be filled */
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
name|tcp
operator|->
name|esc
operator|==
literal|5
condition|)
block|{
comment|/* seen ESC ( */
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'B'
case|:
comment|/* iso-2022: desginate ASCII into G0 */
break|break;
comment|/* other items to be filled */
default|default:
break|break;
block|}
block|}
name|tcp
operator|->
name|esc
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|scterm_puts
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|u_char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|term_stat
modifier|*
name|tcp
decl_stmt|;
name|u_char
modifier|*
name|ptr
decl_stmt|;
ifdef|#
directive|ifdef
name|KANJI
name|u_short
name|kanji_code
decl_stmt|;
endif|#
directive|endif
name|tcp
operator|=
name|scp
operator|->
name|ts
expr_stmt|;
name|ptr
operator|=
name|buf
expr_stmt|;
name|outloop
label|:
name|scp
operator|->
name|sc
operator|->
name|write_in_progress
operator|++
expr_stmt|;
if|if
condition|(
name|tcp
operator|->
name|esc
condition|)
block|{
name|scterm_scan_esc
argument_list|(
name|scp
argument_list|,
name|tcp
argument_list|,
operator|*
name|ptr
operator|++
argument_list|)
expr_stmt|;
name|len
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|PRINTABLE
argument_list|(
operator|*
name|ptr
argument_list|)
condition|)
block|{
comment|/* Print only printables */
name|vm_offset_t
name|p
decl_stmt|;
name|u_char
modifier|*
name|map
decl_stmt|;
name|int
name|attr
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|cnt
decl_stmt|;
ifdef|#
directive|ifdef
name|KANJI
name|u_char
name|c
decl_stmt|;
endif|#
directive|endif
name|p
operator|=
name|sc_vtb_pointer
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|scp
operator|->
name|cursor_pos
argument_list|)
expr_stmt|;
name|map
operator|=
name|scp
operator|->
name|sc
operator|->
name|scr_map
expr_stmt|;
name|attr
operator|=
name|tcp
operator|->
name|cur_attr
expr_stmt|;
ifdef|#
directive|ifdef
name|KANJI
name|c
operator|=
operator|*
name|ptr
expr_stmt|;
if|if
condition|(
name|tcp
operator|->
name|kanji_1st_char
operator|==
literal|0
condition|)
block|{
name|tcp
operator|->
name|kanji_type
operator|=
name|iskanji1
argument_list|(
name|tcp
operator|->
name|kanji_type
argument_list|,
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IS_KTYPE_ASCII_or_HANKAKU
argument_list|(
name|tcp
operator|->
name|kanji_type
argument_list|)
condition|)
block|{
comment|/* not Ascii& not HANKAKU */
name|tcp
operator|->
name|kanji_1st_char
operator|=
name|c
expr_stmt|;
goto|goto
name|kanji_end
goto|;
block|}
elseif|else
if|if
condition|(
name|tcp
operator|->
name|kanji_type
operator|==
name|KTYPE_ASCII
condition|)
block|{
name|cnt
operator|=
name|imin
argument_list|(
name|len
argument_list|,
name|scp
operator|->
name|xsize
operator|-
name|scp
operator|->
name|xpos
argument_list|)
expr_stmt|;
name|i
operator|=
name|cnt
expr_stmt|;
do|do
block|{
name|p
operator|=
name|sc_vtb_putchar
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|p
argument_list|,
name|map
index|[
name|c
index|]
argument_list|,
name|attr
argument_list|)
expr_stmt|;
name|c
operator|=
operator|*
operator|++
name|ptr
expr_stmt|;
operator|--
name|i
expr_stmt|;
block|}
do|while
condition|(
name|i
operator|>
literal|0
operator|&&
name|PRINTABLE
argument_list|(
name|c
argument_list|)
operator|&&
name|iskanji1
argument_list|(
name|tcp
operator|->
name|kanji_type
argument_list|,
name|c
argument_list|)
operator|==
name|KTYPE_ASCII
condition|)
do|;
name|len
operator|-=
name|cnt
operator|-
name|i
expr_stmt|;
name|mark_for_update
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|cursor_pos
argument_list|)
expr_stmt|;
name|scp
operator|->
name|cursor_pos
operator|+=
name|cnt
operator|-
name|i
expr_stmt|;
name|mark_for_update
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|cursor_pos
operator|-
literal|1
argument_list|)
expr_stmt|;
name|scp
operator|->
name|xpos
operator|+=
name|cnt
operator|-
name|i
expr_stmt|;
name|KTYPE_MASK_CTRL
argument_list|(
name|tcp
operator|->
name|kanji_type
argument_list|)
expr_stmt|;
goto|goto
name|ascii_end
goto|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
name|tcp
operator|->
name|kanji_type
operator|=
name|iskanji2
argument_list|(
name|tcp
operator|->
name|kanji_type
argument_list|,
name|c
argument_list|)
operator|)
operator|&
literal|0xee
condition|)
block|{
comment|/* print kanji on TEXT VRAM */
name|kanji_code
operator|=
name|kanji_convert
argument_list|(
name|tcp
operator|->
name|kanji_type
argument_list|,
name|c
argument_list|,
name|tcp
operator|->
name|kanji_1st_char
argument_list|)
expr_stmt|;
name|mark_for_update
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|cursor_pos
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
block|{
comment|/* *cursor_pos = (kanji_code | (i*0x80)); */
name|p
operator|=
name|sc_vtb_putchar
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|p
argument_list|,
name|kanji_code
operator||
operator|(
operator|(
name|i
operator|==
literal|0
operator|)
condition|?
literal|0x00
else|:
literal|0x80
operator|)
argument_list|,
name|attr
argument_list|)
expr_stmt|;
operator|++
name|scp
operator|->
name|cursor_pos
expr_stmt|;
if|if
condition|(
operator|++
name|scp
operator|->
name|xpos
operator|>=
name|scp
operator|->
name|xsize
condition|)
block|{
name|scp
operator|->
name|xpos
operator|=
literal|0
expr_stmt|;
name|scp
operator|->
name|ypos
operator|++
expr_stmt|;
block|}
block|}
name|mark_for_update
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|cursor_pos
operator|-
literal|1
argument_list|)
expr_stmt|;
name|KTYPE_MASK_CTRL
argument_list|(
name|tcp
operator|->
name|kanji_type
argument_list|)
expr_stmt|;
name|tcp
operator|->
name|kanji_1st_char
operator|=
literal|0
expr_stmt|;
goto|goto
name|kanji_end
goto|;
block|}
else|else
block|{
name|tcp
operator|->
name|kanji_1st_char
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|IS_KTYPE_KANA
argument_list|(
name|tcp
operator|->
name|kanji_type
argument_list|)
condition|)
name|c
operator||=
literal|0x80
expr_stmt|;
name|KTYPE_MASK_CTRL
argument_list|(
name|tcp
operator|->
name|kanji_type
argument_list|)
expr_stmt|;
name|sc_vtb_putchar
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|p
argument_list|,
name|map
index|[
name|c
index|]
argument_list|,
name|attr
argument_list|)
expr_stmt|;
name|mark_for_update
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|cursor_pos
argument_list|)
expr_stmt|;
name|mark_for_update
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|cursor_pos
argument_list|)
expr_stmt|;
operator|++
name|scp
operator|->
name|cursor_pos
expr_stmt|;
operator|++
name|scp
operator|->
name|xpos
expr_stmt|;
name|kanji_end
label|:
operator|++
name|ptr
expr_stmt|;
operator|--
name|len
expr_stmt|;
name|ascii_end
label|:
else|#
directive|else
comment|/* !KANJI */
name|cnt
operator|=
name|imin
argument_list|(
name|len
argument_list|,
name|scp
operator|->
name|xsize
operator|-
name|scp
operator|->
name|xpos
argument_list|)
expr_stmt|;
name|i
operator|=
name|cnt
expr_stmt|;
do|do
block|{
comment|/* 		     * gcc-2.6.3 generates poor (un)sign extension code. 		     * Casting the pointers in the following to volatile should 		     * have no effect, but in fact speeds up this inner loop 		     * from 26 to 18 cycles (+ cache misses) on i486's. 		     */
define|#
directive|define
name|UCVP
parameter_list|(
name|ucp
parameter_list|)
value|((u_char volatile *)(ucp))
name|p
operator|=
name|sc_vtb_putchar
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|p
argument_list|,
name|UCVP
argument_list|(
name|map
argument_list|)
index|[
operator|*
name|UCVP
argument_list|(
name|ptr
argument_list|)
index|]
argument_list|,
name|attr
argument_list|)
expr_stmt|;
operator|++
name|ptr
expr_stmt|;
operator|--
name|i
expr_stmt|;
block|}
do|while
condition|(
name|i
operator|>
literal|0
operator|&&
name|PRINTABLE
argument_list|(
operator|*
name|ptr
argument_list|)
condition|)
do|;
name|len
operator|-=
name|cnt
operator|-
name|i
expr_stmt|;
name|mark_for_update
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|cursor_pos
argument_list|)
expr_stmt|;
name|scp
operator|->
name|cursor_pos
operator|+=
name|cnt
operator|-
name|i
expr_stmt|;
name|mark_for_update
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|cursor_pos
operator|-
literal|1
argument_list|)
expr_stmt|;
name|scp
operator|->
name|xpos
operator|+=
name|cnt
operator|-
name|i
expr_stmt|;
endif|#
directive|endif
comment|/* !KANJI */
if|if
condition|(
name|scp
operator|->
name|xpos
operator|>=
name|scp
operator|->
name|xsize
condition|)
block|{
name|scp
operator|->
name|xpos
operator|=
literal|0
expr_stmt|;
name|scp
operator|->
name|ypos
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
switch|switch
condition|(
operator|*
name|ptr
condition|)
block|{
case|case
literal|0x07
case|:
name|sc_bell
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|bell_pitch
argument_list|,
name|scp
operator|->
name|bell_duration
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x08
case|:
comment|/* non-destructive backspace */
if|if
condition|(
name|scp
operator|->
name|cursor_pos
operator|>
literal|0
condition|)
block|{
name|mark_for_update
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|cursor_pos
argument_list|)
expr_stmt|;
name|scp
operator|->
name|cursor_pos
operator|--
expr_stmt|;
name|mark_for_update
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|cursor_pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|scp
operator|->
name|xpos
operator|>
literal|0
condition|)
name|scp
operator|->
name|xpos
operator|--
expr_stmt|;
else|else
block|{
name|scp
operator|->
name|xpos
operator|+=
name|scp
operator|->
name|xsize
operator|-
literal|1
expr_stmt|;
name|scp
operator|->
name|ypos
operator|--
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|0x09
case|:
comment|/* non-destructive tab */
name|mark_for_update
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|cursor_pos
argument_list|)
expr_stmt|;
name|scp
operator|->
name|cursor_pos
operator|+=
operator|(
literal|8
operator|-
name|scp
operator|->
name|xpos
operator|%
literal|8u
operator|)
expr_stmt|;
name|scp
operator|->
name|xpos
operator|+=
operator|(
literal|8
operator|-
name|scp
operator|->
name|xpos
operator|%
literal|8u
operator|)
expr_stmt|;
if|if
condition|(
name|scp
operator|->
name|xpos
operator|>=
name|scp
operator|->
name|xsize
condition|)
block|{
name|scp
operator|->
name|xpos
operator|=
literal|0
expr_stmt|;
name|scp
operator|->
name|ypos
operator|++
expr_stmt|;
name|scp
operator|->
name|cursor_pos
operator|=
name|scp
operator|->
name|xsize
operator|*
name|scp
operator|->
name|ypos
expr_stmt|;
block|}
name|mark_for_update
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|cursor_pos
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0a
case|:
comment|/* newline, same pos */
name|mark_for_update
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|cursor_pos
argument_list|)
expr_stmt|;
name|scp
operator|->
name|cursor_pos
operator|+=
name|scp
operator|->
name|xsize
expr_stmt|;
name|mark_for_update
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|cursor_pos
argument_list|)
expr_stmt|;
name|scp
operator|->
name|ypos
operator|++
expr_stmt|;
break|break;
case|case
literal|0x0c
case|:
comment|/* form feed, clears screen */
name|sc_clear_screen
argument_list|(
name|scp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0d
case|:
comment|/* return, return to pos 0 */
name|mark_for_update
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|cursor_pos
argument_list|)
expr_stmt|;
name|scp
operator|->
name|cursor_pos
operator|-=
name|scp
operator|->
name|xpos
expr_stmt|;
name|mark_for_update
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|cursor_pos
argument_list|)
expr_stmt|;
name|scp
operator|->
name|xpos
operator|=
literal|0
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|PC98
case|case
literal|0x0e
case|:
comment|/* ^N */
name|tcp
operator|->
name|kanji_type
operator|=
name|KTYPE_JKANA
expr_stmt|;
name|tcp
operator|->
name|esc
operator|=
literal|0
expr_stmt|;
name|tcp
operator|->
name|kanji_1st_char
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|0x0f
case|:
comment|/* ^O */
name|tcp
operator|->
name|kanji_type
operator|=
name|KTYPE_ASCII
expr_stmt|;
name|tcp
operator|->
name|esc
operator|=
literal|0
expr_stmt|;
name|tcp
operator|->
name|kanji_1st_char
operator|=
literal|0
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* PC98 */
case|case
literal|0x1b
case|:
comment|/* start escape sequence */
name|tcp
operator|->
name|esc
operator|=
literal|1
expr_stmt|;
name|tcp
operator|->
name|num_param
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|ptr
operator|++
expr_stmt|;
name|len
operator|--
expr_stmt|;
block|}
name|sc_term_gen_scroll
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|sc
operator|->
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|tcp
operator|->
name|cur_attr
argument_list|)
expr_stmt|;
name|scp
operator|->
name|sc
operator|->
name|write_in_progress
operator|--
expr_stmt|;
if|if
condition|(
name|len
condition|)
goto|goto
name|outloop
goto|;
block|}
end_function

begin_function
specifier|static
name|int
name|scterm_ioctl
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|struct
name|tty
modifier|*
name|tp
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|,
name|int
name|flag
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
name|term_stat
modifier|*
name|tcp
init|=
name|scp
operator|->
name|ts
decl_stmt|;
name|vid_info_t
modifier|*
name|vi
decl_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|GIO_ATTR
case|:
comment|/* get current attributes */
comment|/* FIXME: */
operator|*
operator|(
name|int
operator|*
operator|)
name|data
operator|=
operator|(
name|tcp
operator|->
name|cur_attr
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
return|return
literal|0
return|;
case|case
name|CONS_GETINFO
case|:
comment|/* get current (virtual) console info */
name|vi
operator|=
operator|(
name|vid_info_t
operator|*
operator|)
name|data
expr_stmt|;
if|if
condition|(
name|vi
operator|->
name|size
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|vid_info
argument_list|)
condition|)
return|return
name|EINVAL
return|;
name|vi
operator|->
name|mv_norm
operator|.
name|fore
operator|=
name|tcp
operator|->
name|std_color
operator|.
name|fg
expr_stmt|;
name|vi
operator|->
name|mv_norm
operator|.
name|back
operator|=
name|tcp
operator|->
name|std_color
operator|.
name|bg
expr_stmt|;
name|vi
operator|->
name|mv_rev
operator|.
name|fore
operator|=
name|tcp
operator|->
name|rev_color
operator|.
name|fg
expr_stmt|;
name|vi
operator|->
name|mv_rev
operator|.
name|back
operator|=
name|tcp
operator|->
name|rev_color
operator|.
name|bg
expr_stmt|;
comment|/* 		 * The other fields are filled by the upper routine. XXX 		 */
return|return
name|ENOIOCTL
return|;
block|}
return|return
name|ENOIOCTL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|scterm_reset
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|code
parameter_list|)
block|{
comment|/* FIXME */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|scterm_default_attr
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|color
parameter_list|,
name|int
name|rev_color
parameter_list|)
block|{
name|term_stat
modifier|*
name|tcp
init|=
name|scp
operator|->
name|ts
decl_stmt|;
name|tcp
operator|->
name|dflt_std_color
operator|.
name|fg
operator|=
name|color
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|dflt_std_color
operator|.
name|bg
operator|=
operator|(
name|color
operator|>>
literal|4
operator|)
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|dflt_rev_color
operator|.
name|fg
operator|=
name|rev_color
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|dflt_rev_color
operator|.
name|bg
operator|=
operator|(
name|rev_color
operator|>>
literal|4
operator|)
operator|&
literal|0x0f
expr_stmt|;
name|tcp
operator|->
name|std_color
operator|=
name|tcp
operator|->
name|dflt_std_color
expr_stmt|;
name|tcp
operator|->
name|rev_color
operator|=
name|tcp
operator|->
name|dflt_rev_color
expr_stmt|;
name|tcp
operator|->
name|cur_color
operator|=
name|tcp
operator|->
name|std_color
expr_stmt|;
name|tcp
operator|->
name|cur_attr
operator|=
name|mask2attr
argument_list|(
name|tcp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|scterm_clear
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|)
block|{
name|term_stat
modifier|*
name|tcp
init|=
name|scp
operator|->
name|ts
decl_stmt|;
name|sc_move_cursor
argument_list|(
name|scp
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc_vtb_clear
argument_list|(
operator|&
name|scp
operator|->
name|vtb
argument_list|,
name|scp
operator|->
name|sc
operator|->
name|scr_map
index|[
literal|0x20
index|]
argument_list|,
name|tcp
operator|->
name|cur_attr
argument_list|)
expr_stmt|;
name|mark_all
argument_list|(
name|scp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|scterm_notify
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|event
parameter_list|)
block|{
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|SC_TE_NOTIFY_VTSWITCH_IN
case|:
break|break;
case|case
name|SC_TE_NOTIFY_VTSWITCH_OUT
case|:
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|scterm_input
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|int
name|c
parameter_list|,
name|struct
name|tty
modifier|*
name|tp
parameter_list|)
block|{
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/*  * Calculate hardware attributes word using logical attributes mask and  * hardware colors  */
end_comment

begin_comment
comment|/* FIXME */
end_comment

begin_function
specifier|static
name|int
name|mask2attr
parameter_list|(
name|term_stat
modifier|*
name|tcp
parameter_list|)
block|{
name|int
name|attr
decl_stmt|,
name|mask
init|=
name|tcp
operator|->
name|attr_mask
decl_stmt|;
if|if
condition|(
name|mask
operator|&
name|REVERSE_ATTR
condition|)
block|{
name|attr
operator|=
operator|(
operator|(
name|mask
operator|&
name|FG_CHANGED
operator|)
condition|?
name|tcp
operator|->
name|cur_color
operator|.
name|bg
else|:
name|tcp
operator|->
name|rev_color
operator|.
name|fg
operator|)
operator||
operator|(
operator|(
operator|(
name|mask
operator|&
name|BG_CHANGED
operator|)
condition|?
name|tcp
operator|->
name|cur_color
operator|.
name|fg
else|:
name|tcp
operator|->
name|rev_color
operator|.
name|bg
operator|)
operator|<<
literal|4
operator|)
expr_stmt|;
block|}
else|else
name|attr
operator|=
name|tcp
operator|->
name|cur_color
operator|.
name|fg
operator||
operator|(
name|tcp
operator|->
name|cur_color
operator|.
name|bg
operator|<<
literal|4
operator|)
expr_stmt|;
comment|/* XXX: underline mapping for Hercules adapter can be better */
if|if
condition|(
name|mask
operator|&
operator|(
name|BOLD_ATTR
operator||
name|UNDERLINE_ATTR
operator|)
condition|)
name|attr
operator|^=
literal|0x08
expr_stmt|;
if|if
condition|(
name|mask
operator|&
name|BLINK_ATTR
condition|)
name|attr
operator|^=
literal|0x80
expr_stmt|;
return|return
operator|(
name|attr
operator|<<
literal|8
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SC_DUMB_TERMINAL */
end_comment

end_unit


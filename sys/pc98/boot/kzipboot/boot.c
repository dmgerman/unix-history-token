begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * FreeBSD kernel unpacker.  * 1993 by Serge Vakulenko  * modified for FreeBSD 2.1 by Gary Jennejohn - 12FEB95  */
end_comment

begin_comment
comment|/*  * FreeBSD(98) port  * 1995 by KATO T. of Nagoya University  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/reboot.h>
end_include

begin_comment
comment|/* for RB_SERIAL */
end_comment

begin_include
include|#
directive|include
file|<machine/cpufunc.h>
end_include

begin_comment
comment|/* for inb/outb */
end_comment

begin_decl_stmt
name|short
modifier|*
name|videomem
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|curs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|cols
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|lines
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|int
name|port
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|PC98
end_ifdef

begin_decl_stmt
name|unsigned
name|char
name|bios
index|[
literal|0x200
index|]
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_decl_stmt
name|unsigned
name|char
name|bios
index|[
literal|0x100
index|]
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|extern
name|int
name|end
decl_stmt|,
name|edata
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
modifier|*
name|storage
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
modifier|*
name|inbuf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
modifier|*
name|outbuf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
modifier|*
name|window
decl_stmt|;
end_decl_stmt

begin_function_decl
name|void
name|decompress_kernel
parameter_list|(
name|void
modifier|*
name|dest
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|memcmp
parameter_list|(
specifier|const
name|void
modifier|*
name|arg1
parameter_list|,
specifier|const
name|void
modifier|*
name|arg2
parameter_list|,
name|unsigned
name|len
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|a
init|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|arg1
decl_stmt|;
name|unsigned
name|char
modifier|*
name|b
init|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|arg2
decl_stmt|;
for|for
control|(
init|;
name|len
operator|--
operator|>
literal|0
condition|;
operator|++
name|a
operator|,
operator|++
name|b
control|)
if|if
condition|(
operator|*
name|a
operator|<
operator|*
name|b
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
elseif|else
if|if
condition|(
operator|*
name|a
operator|>
operator|*
name|b
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|memcpy
parameter_list|(
name|void
modifier|*
name|to
parameter_list|,
specifier|const
name|void
modifier|*
name|from
parameter_list|,
name|unsigned
name|len
parameter_list|)
block|{
name|char
modifier|*
name|f
init|=
operator|(
name|char
operator|*
operator|)
name|from
decl_stmt|;
name|char
modifier|*
name|t
init|=
operator|(
name|char
operator|*
operator|)
name|to
decl_stmt|;
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
operator|*
name|t
operator|++
operator|=
operator|*
name|f
operator|++
expr_stmt|;
return|return
operator|(
name|to
operator|)
return|;
block|}
end_function

begin_function
name|void
name|serial_putchar
parameter_list|(
name|unsigned
name|char
name|c
parameter_list|)
block|{
name|unsigned
name|char
name|stat
decl_stmt|;
if|if
condition|(
name|c
operator|==
literal|'\n'
condition|)
name|serial_putchar
argument_list|(
literal|'\r'
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|PC98
do|do
block|{
name|stat
operator|=
name|inb
argument_list|(
name|COMCONSOLE
operator|+
literal|2
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|!
operator|(
name|stat
operator|&
literal|0x01
operator|)
condition|)
do|;
else|#
directive|else
do|do
block|{
name|stat
operator|=
name|inb
argument_list|(
name|COMCONSOLE
operator|+
literal|5
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|!
operator|(
name|stat
operator|&
literal|0x20
operator|)
condition|)
do|;
endif|#
directive|endif
name|outb
argument_list|(
name|COMCONSOLE
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|putchar
parameter_list|(
name|unsigned
name|char
name|c
parameter_list|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'\n'
case|:
name|curs
operator|=
operator|(
name|curs
operator|+
name|cols
operator|)
operator|/
name|cols
operator|*
name|cols
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|PC98
default|default:
name|videomem
index|[
name|curs
operator|++
index|]
operator|=
operator|(
name|c
operator|==
literal|0x5c
condition|?
literal|0xfc
else|:
name|c
operator|)
expr_stmt|;
break|break;
else|#
directive|else
default|default:
name|videomem
index|[
name|curs
operator|++
index|]
operator|=
literal|0x0700
operator||
name|c
expr_stmt|;
break|break;
endif|#
directive|endif
block|}
while|while
condition|(
name|curs
operator|>=
name|cols
operator|*
name|lines
condition|)
block|{
name|int
name|col
decl_stmt|;
name|memcpy
argument_list|(
name|videomem
argument_list|,
name|videomem
operator|+
name|cols
argument_list|,
operator|(
name|lines
operator|-
literal|1
operator|)
operator|*
name|cols
operator|*
literal|2
argument_list|)
expr_stmt|;
for|for
control|(
name|col
operator|=
literal|0
init|;
name|col
operator|<
name|cols
condition|;
name|col
operator|++
control|)
ifdef|#
directive|ifdef
name|PC98
name|videomem
index|[
operator|(
name|lines
operator|-
literal|1
operator|)
operator|*
name|cols
operator|+
name|col
index|]
operator|=
literal|0x20
expr_stmt|;
else|#
directive|else
name|videomem
index|[
operator|(
name|lines
operator|-
literal|1
operator|)
operator|*
name|cols
operator|+
name|col
index|]
operator|=
literal|0x720
expr_stmt|;
endif|#
directive|endif
name|curs
operator|-=
name|cols
expr_stmt|;
block|}
comment|/* set cursor position */
ifdef|#
directive|ifdef
name|PC98
while|while
condition|(
operator|(
name|inb
argument_list|(
literal|0x60
argument_list|)
operator|&
literal|0x04
operator|)
operator|==
literal|0
condition|)
block|{}
name|outb
argument_list|(
literal|0x62
argument_list|,
literal|0x49
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x60
argument_list|,
operator|(
name|curs
operator|+
literal|1
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|outb
argument_list|(
literal|0x60
argument_list|,
operator|(
name|curs
operator|+
literal|1
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
else|#
directive|else
name|outb
argument_list|(
name|port
argument_list|,
literal|0x0e
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|port
operator|+
literal|1
argument_list|,
name|curs
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|port
argument_list|,
literal|0x0f
argument_list|)
expr_stmt|;
name|outb
argument_list|(
name|port
operator|+
literal|1
argument_list|,
name|curs
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_decl_stmt
name|int
name|use_serial
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|putstr
parameter_list|(
name|char
modifier|*
name|s
parameter_list|)
block|{
while|while
condition|(
operator|*
name|s
condition|)
block|{
if|if
condition|(
name|use_serial
condition|)
name|serial_putchar
argument_list|(
operator|*
name|s
operator|++
argument_list|)
expr_stmt|;
else|else
name|putchar
argument_list|(
operator|*
name|s
operator|++
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|error
parameter_list|(
name|char
modifier|*
name|s
parameter_list|)
block|{
name|putstr
argument_list|(
literal|"\n\n"
argument_list|)
expr_stmt|;
name|putstr
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|putstr
argument_list|(
literal|"\n\n -- System halted"
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
empty_stmt|;
comment|/* Halt */
block|}
end_function

begin_function
name|void
name|boot
parameter_list|(
name|int
name|howto
parameter_list|)
block|{
name|int
name|l
decl_stmt|,
name|c
decl_stmt|,
modifier|*
name|p
decl_stmt|;
ifdef|#
directive|ifdef
name|PC98
name|unsigned
name|short
name|gdc_curaddr
decl_stmt|;
name|int
name|i
decl_stmt|;
endif|#
directive|endif
comment|/* clear bss */
for|for
control|(
name|p
operator|=
operator|&
name|edata
init|;
name|p
operator|<
operator|&
name|end
condition|;
operator|++
name|p
control|)
operator|*
name|p
operator|=
literal|0
expr_stmt|;
name|inbuf
operator|=
operator|(
name|void
operator|*
operator|)
literal|0x20000
expr_stmt|;
name|outbuf
operator|=
operator|(
name|void
operator|*
operator|)
literal|0x30000
expr_stmt|;
name|window
operator|=
operator|(
name|void
operator|*
operator|)
literal|0x40000
expr_stmt|;
name|storage
operator|=
operator|(
name|void
operator|*
operator|)
literal|0x50000
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|use_serial
operator|=
operator|(
name|howto
operator|&
name|RB_SERIAL
operator|)
operator|)
condition|)
block|{
ifdef|#
directive|ifdef
name|PC98
name|videomem
operator|=
operator|(
name|void
operator|*
operator|)
literal|0xa0000
expr_stmt|;
name|cols
operator|=
literal|80
expr_stmt|;
name|lines
operator|=
literal|25
expr_stmt|;
comment|/* Is FIFO buffer empty ? */
while|while
condition|(
operator|(
name|inb
argument_list|(
literal|0x60
argument_list|)
operator|&
literal|0x04
operator|)
operator|==
literal|0
condition|)
block|{}
name|outb
argument_list|(
literal|0x62
argument_list|,
literal|0xe0
argument_list|)
expr_stmt|;
comment|/* CSRR command */
comment|/* T-GDC busy ? */
while|while
condition|(
operator|(
name|inb
argument_list|(
literal|0x60
argument_list|)
operator|&
literal|0x01
operator|)
operator|==
literal|0
condition|)
block|{}
comment|/* read cursor address */
name|gdc_curaddr
operator|=
name|inb
argument_list|(
literal|0x62
argument_list|)
expr_stmt|;
name|gdc_curaddr
operator|+=
operator|(
name|inb
argument_list|(
literal|0x62
argument_list|)
operator|<<
literal|8
operator|)
expr_stmt|;
comment|/* ignore rest of data */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|inb
argument_list|(
literal|0x62
argument_list|)
expr_stmt|;
block|}
name|l
operator|=
name|gdc_curaddr
operator|/
literal|80
operator|+
literal|1
expr_stmt|;
name|c
operator|=
literal|0
expr_stmt|;
else|#
directive|else
comment|/* Test for monochrome video adapter */
if|if
condition|(
operator|(
operator|*
operator|(
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|0x410
operator|)
operator|&
literal|0x30
operator|)
operator|==
literal|0x30
condition|)
name|videomem
operator|=
operator|(
name|void
operator|*
operator|)
literal|0xb0000
expr_stmt|;
comment|/* monochrome */
else|else
name|videomem
operator|=
operator|(
name|void
operator|*
operator|)
literal|0xb8000
expr_stmt|;
comment|/* color */
name|port
operator|=
operator|*
operator|(
name|unsigned
name|short
operator|*
operator|)
literal|0x463
expr_stmt|;
name|cols
operator|=
operator|*
operator|(
name|unsigned
name|short
operator|*
operator|)
literal|0x44a
expr_stmt|;
name|lines
operator|=
literal|1
operator|+
operator|*
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|0x484
expr_stmt|;
name|c
operator|=
operator|*
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|0x450
expr_stmt|;
name|l
operator|=
operator|*
operator|(
name|unsigned
name|char
operator|*
operator|)
literal|0x451
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|lines
operator|<
literal|25
condition|)
name|lines
operator|=
literal|25
expr_stmt|;
name|curs
operator|=
name|l
operator|*
name|cols
operator|+
name|c
expr_stmt|;
if|if
condition|(
name|curs
operator|>
name|lines
operator|*
name|cols
condition|)
name|curs
operator|=
operator|(
name|lines
operator|-
literal|1
operator|)
operator|*
name|cols
expr_stmt|;
block|}
name|putstr
argument_list|(
literal|"Uncompressing kernel..."
argument_list|)
expr_stmt|;
name|decompress_kernel
argument_list|(
operator|(
name|void
operator|*
operator|)
name|KADDR
argument_list|)
expr_stmt|;
name|putstr
argument_list|(
literal|"done\n"
argument_list|)
expr_stmt|;
name|putstr
argument_list|(
literal|"Booting the kernel\n"
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


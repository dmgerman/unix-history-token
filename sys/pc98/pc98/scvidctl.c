begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1998 Kazutaka YOKOTA<yokota@zodiac.mech.utsunomiya-u.ac.jp>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer as  *    the first lines of this file unmodified.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * $Id: scvidctl.c,v 1.2 1999/01/18 08:38:08 kato Exp $  */
end_comment

begin_include
include|#
directive|include
file|"sc.h"
end_include

begin_include
include|#
directive|include
file|"opt_syscons.h"
end_include

begin_if
if|#
directive|if
name|NSC
operator|>
literal|0
end_if

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/signalvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/tty.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<machine/apm_bios.h>
end_include

begin_include
include|#
directive|include
file|<machine/console.h>
end_include

begin_include
include|#
directive|include
file|<dev/fb/fbreg.h>
end_include

begin_include
include|#
directive|include
file|<pc98/pc98/syscons.h>
end_include

begin_comment
comment|/* for compatibility with previous versions */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|old_video_adapter
block|{
name|int
name|va_index
decl_stmt|;
name|int
name|va_type
decl_stmt|;
name|int
name|va_flags
decl_stmt|;
define|#
directive|define
name|V_ADP_COLOR
value|(1<<0)
define|#
directive|define
name|V_ADP_MODECHANGE
value|(1<<1)
define|#
directive|define
name|V_ADP_STATESAVE
value|(1<<2)
define|#
directive|define
name|V_ADP_STATELOAD
value|(1<<3)
define|#
directive|define
name|V_ADP_FONT
value|(1<<4)
define|#
directive|define
name|V_ADP_PALETTE
value|(1<<5)
define|#
directive|define
name|V_ADP_BORDER
value|(1<<6)
define|#
directive|define
name|V_ADP_VESA
value|(1<<7)
name|int
name|va_crtc_addr
decl_stmt|;
name|u_int
name|va_window
decl_stmt|;
comment|/* virtual address */
name|size_t
name|va_window_size
decl_stmt|;
name|size_t
name|va_window_gran
decl_stmt|;
name|u_int
name|va_buffer
decl_stmt|;
comment|/* virtual address */
name|size_t
name|va_buffer_size
decl_stmt|;
name|int
name|va_initial_mode
decl_stmt|;
name|int
name|va_initial_bios_mode
decl_stmt|;
name|int
name|va_mode
decl_stmt|;
block|}
name|old_video_adapter_t
typedef|;
end_typedef

begin_define
define|#
directive|define
name|OLD_CONS_ADPINFO
value|_IOWR('c', 101, old_video_adapter_t)
end_define

begin_comment
comment|/* variables */
end_comment

begin_decl_stmt
specifier|extern
name|scr_stat
modifier|*
name|cur_console
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|fonts_loaded
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|sc_history_size
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|u_char
name|palette
index|[]
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|sc_set_text_mode
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|struct
name|tty
modifier|*
name|tp
parameter_list|,
name|int
name|mode
parameter_list|,
name|int
name|xsize
parameter_list|,
name|int
name|ysize
parameter_list|,
name|int
name|fontsize
parameter_list|)
block|{
name|video_info_t
name|info
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|s
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
operator|*
name|vidsw
index|[
name|scp
operator|->
name|ad
index|]
operator|->
name|get_info
operator|)
operator|(
name|scp
operator|->
name|adp
operator|,
name|mode
operator|,
operator|&
name|info
operator|)
condition|)
return|return
name|ENODEV
return|;
comment|/* adjust argument values */
if|if
condition|(
name|fontsize
operator|<=
literal|0
condition|)
name|fontsize
operator|=
name|info
operator|.
name|vi_cheight
expr_stmt|;
if|if
condition|(
name|fontsize
operator|<
literal|14
condition|)
block|{
name|fontsize
operator|=
literal|8
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fonts_loaded
operator|&
name|FONT_8
operator|)
condition|)
return|return
name|EINVAL
return|;
block|}
elseif|else
if|if
condition|(
name|fontsize
operator|>=
literal|16
condition|)
block|{
name|fontsize
operator|=
literal|16
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fonts_loaded
operator|&
name|FONT_16
operator|)
condition|)
return|return
name|EINVAL
return|;
block|}
else|else
block|{
name|fontsize
operator|=
literal|14
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fonts_loaded
operator|&
name|FONT_14
operator|)
condition|)
return|return
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|xsize
operator|<=
literal|0
operator|)
operator|||
operator|(
name|xsize
operator|>
name|info
operator|.
name|vi_width
operator|)
condition|)
name|xsize
operator|=
name|info
operator|.
name|vi_width
expr_stmt|;
if|if
condition|(
operator|(
name|ysize
operator|<=
literal|0
operator|)
operator|||
operator|(
name|ysize
operator|>
name|info
operator|.
name|vi_height
operator|)
condition|)
name|ysize
operator|=
name|info
operator|.
name|vi_height
expr_stmt|;
comment|/* stop screen saver, etc */
name|s
operator|=
name|spltty
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|sc_clean_up
argument_list|(
name|scp
argument_list|)
operator|)
condition|)
block|{
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
comment|/* set up scp */
if|if
condition|(
name|scp
operator|->
name|history
operator|!=
name|NULL
condition|)
name|i
operator|=
name|imax
argument_list|(
name|scp
operator|->
name|history_size
operator|/
name|scp
operator|->
name|xsize
operator|-
name|imax
argument_list|(
name|sc_history_size
argument_list|,
name|scp
operator|->
name|ysize
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|i
operator|=
literal|0
expr_stmt|;
comment|/*      * This is a kludge to fend off scrn_update() while we      * muck around with scp. XXX      */
name|scp
operator|->
name|status
operator||=
name|UNKNOWN_MODE
expr_stmt|;
name|scp
operator|->
name|status
operator|&=
operator|~
operator|(
name|GRAPHICS_MODE
operator||
name|PIXEL_MODE
operator|)
expr_stmt|;
name|scp
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
name|scp
operator|->
name|font_size
operator|=
name|fontsize
expr_stmt|;
name|scp
operator|->
name|xsize
operator|=
name|xsize
expr_stmt|;
name|scp
operator|->
name|ysize
operator|=
name|ysize
expr_stmt|;
name|scp
operator|->
name|xoff
operator|=
literal|0
expr_stmt|;
name|scp
operator|->
name|yoff
operator|=
literal|0
expr_stmt|;
name|scp
operator|->
name|xpixel
operator|=
name|scp
operator|->
name|xsize
operator|*
literal|8
expr_stmt|;
name|scp
operator|->
name|ypixel
operator|=
name|scp
operator|->
name|ysize
operator|*
name|fontsize
expr_stmt|;
comment|/* allocate buffers */
name|sc_alloc_scr_buffer
argument_list|(
name|scp
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ISMOUSEAVAIL
argument_list|(
name|scp
operator|->
name|adp
operator|->
name|va_flags
argument_list|)
condition|)
name|sc_alloc_cut_buffer
argument_list|(
name|scp
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|sc_alloc_history_buffer
argument_list|(
name|scp
argument_list|,
name|sc_history_size
argument_list|,
name|i
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|scp
operator|==
name|cur_console
condition|)
name|set_mode
argument_list|(
name|scp
argument_list|)
expr_stmt|;
name|scp
operator|->
name|status
operator|&=
operator|~
name|UNKNOWN_MODE
expr_stmt|;
if|if
condition|(
name|tp
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|tp
operator|->
name|t_winsize
operator|.
name|ws_col
operator|!=
name|scp
operator|->
name|xsize
operator|||
name|tp
operator|->
name|t_winsize
operator|.
name|ws_row
operator|!=
name|scp
operator|->
name|ysize
condition|)
block|{
name|tp
operator|->
name|t_winsize
operator|.
name|ws_col
operator|=
name|scp
operator|->
name|xsize
expr_stmt|;
name|tp
operator|->
name|t_winsize
operator|.
name|ws_row
operator|=
name|scp
operator|->
name|ysize
expr_stmt|;
name|pgsignal
argument_list|(
name|tp
operator|->
name|t_pgrp
argument_list|,
name|SIGWINCH
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sc_set_graphics_mode
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|struct
name|tty
modifier|*
name|tp
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
name|video_info_t
name|info
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|s
decl_stmt|;
if|if
condition|(
operator|(
operator|*
name|vidsw
index|[
name|scp
operator|->
name|ad
index|]
operator|->
name|get_info
operator|)
operator|(
name|scp
operator|->
name|adp
operator|,
name|mode
operator|,
operator|&
name|info
operator|)
condition|)
return|return
name|ENODEV
return|;
comment|/* stop screen saver, etc */
name|s
operator|=
name|spltty
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|sc_clean_up
argument_list|(
name|scp
argument_list|)
operator|)
condition|)
block|{
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
comment|/* set up scp */
name|scp
operator|->
name|status
operator||=
operator|(
name|UNKNOWN_MODE
operator||
name|GRAPHICS_MODE
operator|)
expr_stmt|;
name|scp
operator|->
name|status
operator|&=
operator|~
name|PIXEL_MODE
expr_stmt|;
name|scp
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
name|scp
operator|->
name|xoff
operator|=
literal|0
expr_stmt|;
name|scp
operator|->
name|yoff
operator|=
literal|0
expr_stmt|;
name|scp
operator|->
name|xpixel
operator|=
name|info
operator|.
name|vi_width
expr_stmt|;
name|scp
operator|->
name|ypixel
operator|=
name|info
operator|.
name|vi_height
expr_stmt|;
name|scp
operator|->
name|xsize
operator|=
name|info
operator|.
name|vi_width
operator|/
literal|8
expr_stmt|;
name|scp
operator|->
name|ysize
operator|=
name|info
operator|.
name|vi_height
operator|/
name|info
operator|.
name|vi_cheight
expr_stmt|;
name|scp
operator|->
name|font_size
operator|=
name|FONT_NONE
expr_stmt|;
comment|/* move the mouse cursor at the center of the screen */
name|sc_move_mouse
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|xpixel
operator|/
literal|2
argument_list|,
name|scp
operator|->
name|ypixel
operator|/
literal|2
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|scp
operator|==
name|cur_console
condition|)
name|set_mode
argument_list|(
name|scp
argument_list|)
expr_stmt|;
comment|/* clear_graphics();*/
name|scp
operator|->
name|status
operator|&=
operator|~
name|UNKNOWN_MODE
expr_stmt|;
if|if
condition|(
name|tp
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|tp
operator|->
name|t_winsize
operator|.
name|ws_xpixel
operator|!=
name|scp
operator|->
name|xpixel
operator|||
name|tp
operator|->
name|t_winsize
operator|.
name|ws_ypixel
operator|!=
name|scp
operator|->
name|ypixel
condition|)
block|{
name|tp
operator|->
name|t_winsize
operator|.
name|ws_xpixel
operator|=
name|scp
operator|->
name|xpixel
expr_stmt|;
name|tp
operator|->
name|t_winsize
operator|.
name|ws_ypixel
operator|=
name|scp
operator|->
name|ypixel
expr_stmt|;
name|pgsignal
argument_list|(
name|tp
operator|->
name|t_pgrp
argument_list|,
name|SIGWINCH
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sc_set_pixel_mode
parameter_list|(
name|scr_stat
modifier|*
name|scp
parameter_list|,
name|struct
name|tty
modifier|*
name|tp
parameter_list|,
name|int
name|xsize
parameter_list|,
name|int
name|ysize
parameter_list|,
name|int
name|fontsize
parameter_list|)
block|{
name|video_info_t
name|info
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|s
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
operator|*
name|vidsw
index|[
name|scp
operator|->
name|ad
index|]
operator|->
name|get_info
operator|)
operator|(
name|scp
operator|->
name|adp
operator|,
name|scp
operator|->
name|mode
operator|,
operator|&
name|info
operator|)
condition|)
return|return
name|ENODEV
return|;
comment|/* this shouldn't happen */
ifdef|#
directive|ifdef
name|SC_VIDEO_DEBUG
if|if
condition|(
name|scp
operator|->
name|scr_buf
operator|!=
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"set_pixel_mode(): mode:%x, col:%d, row:%d, font:%d\n"
argument_list|,
name|scp
operator|->
name|mode
argument_list|,
name|xsize
argument_list|,
name|ysize
argument_list|,
name|fontsize
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* adjust argument values */
if|if
condition|(
operator|(
name|fontsize
operator|<=
literal|0
operator|)
operator|||
operator|(
name|fontsize
operator|==
name|FONT_NONE
operator|)
condition|)
name|fontsize
operator|=
name|info
operator|.
name|vi_cheight
expr_stmt|;
if|if
condition|(
name|fontsize
operator|<
literal|14
condition|)
block|{
name|fontsize
operator|=
literal|8
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fonts_loaded
operator|&
name|FONT_8
operator|)
condition|)
return|return
name|EINVAL
return|;
block|}
elseif|else
if|if
condition|(
name|fontsize
operator|>=
literal|16
condition|)
block|{
name|fontsize
operator|=
literal|16
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fonts_loaded
operator|&
name|FONT_16
operator|)
condition|)
return|return
name|EINVAL
return|;
block|}
else|else
block|{
name|fontsize
operator|=
literal|14
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fonts_loaded
operator|&
name|FONT_14
operator|)
condition|)
return|return
name|EINVAL
return|;
block|}
if|if
condition|(
name|xsize
operator|<=
literal|0
condition|)
name|xsize
operator|=
name|info
operator|.
name|vi_width
operator|/
literal|8
expr_stmt|;
if|if
condition|(
name|ysize
operator|<=
literal|0
condition|)
name|ysize
operator|=
name|info
operator|.
name|vi_height
operator|/
name|fontsize
expr_stmt|;
ifdef|#
directive|ifdef
name|SC_VIDEO_DEBUG
if|if
condition|(
name|scp
operator|->
name|scr_buf
operator|!=
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"set_pixel_mode(): mode:%x, col:%d, row:%d, font:%d\n"
argument_list|,
name|scp
operator|->
name|mode
argument_list|,
name|xsize
argument_list|,
name|ysize
argument_list|,
name|fontsize
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"set_pixel_mode(): window:%x, %dx%d, xoff:%d, yoff:%d\n"
argument_list|,
name|scp
operator|->
name|adp
operator|->
name|va_window
argument_list|,
name|info
operator|.
name|vi_width
argument_list|,
name|info
operator|.
name|vi_height
argument_list|,
operator|(
name|info
operator|.
name|vi_width
operator|/
literal|8
operator|-
name|xsize
operator|)
operator|/
literal|2
argument_list|,
operator|(
name|info
operator|.
name|vi_height
operator|/
name|fontsize
operator|-
name|ysize
operator|)
operator|/
literal|2
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
operator|(
name|info
operator|.
name|vi_width
operator|<
name|xsize
operator|*
literal|8
operator|)
operator|||
operator|(
name|info
operator|.
name|vi_height
operator|<
name|ysize
operator|*
name|fontsize
operator|)
condition|)
return|return
name|EINVAL
return|;
comment|/* only 16 color, 4 plane modes are supported XXX */
if|if
condition|(
operator|(
name|info
operator|.
name|vi_depth
operator|!=
literal|4
operator|)
operator|||
operator|(
name|info
operator|.
name|vi_planes
operator|!=
literal|4
operator|)
condition|)
return|return
name|ENODEV
return|;
comment|/*      * set_pixel_mode() currently does not support video modes whose      * memory size is larger than 64K. Because such modes require      * bank switching to access the entire screen. XXX      */
if|if
condition|(
name|info
operator|.
name|vi_width
operator|*
name|info
operator|.
name|vi_height
operator|/
literal|8
operator|>
name|info
operator|.
name|vi_window_size
condition|)
return|return
name|ENODEV
return|;
comment|/* stop screen saver, etc */
name|s
operator|=
name|spltty
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|sc_clean_up
argument_list|(
name|scp
argument_list|)
operator|)
condition|)
block|{
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
comment|/* set up scp */
if|if
condition|(
name|scp
operator|->
name|history
operator|!=
name|NULL
condition|)
name|i
operator|=
name|imax
argument_list|(
name|scp
operator|->
name|history_size
operator|/
name|scp
operator|->
name|xsize
operator|-
name|imax
argument_list|(
name|sc_history_size
argument_list|,
name|scp
operator|->
name|ysize
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|i
operator|=
literal|0
expr_stmt|;
name|scp
operator|->
name|status
operator||=
operator|(
name|UNKNOWN_MODE
operator||
name|PIXEL_MODE
operator|)
expr_stmt|;
name|scp
operator|->
name|status
operator|&=
operator|~
operator|(
name|GRAPHICS_MODE
operator||
name|MOUSE_ENABLED
operator|)
expr_stmt|;
name|scp
operator|->
name|xsize
operator|=
name|xsize
expr_stmt|;
name|scp
operator|->
name|ysize
operator|=
name|ysize
expr_stmt|;
name|scp
operator|->
name|font_size
operator|=
name|fontsize
expr_stmt|;
name|scp
operator|->
name|xoff
operator|=
operator|(
name|scp
operator|->
name|xpixel
operator|/
literal|8
operator|-
name|xsize
operator|)
operator|/
literal|2
expr_stmt|;
name|scp
operator|->
name|yoff
operator|=
operator|(
name|scp
operator|->
name|ypixel
operator|/
name|fontsize
operator|-
name|ysize
operator|)
operator|/
literal|2
expr_stmt|;
comment|/* allocate buffers */
name|sc_alloc_scr_buffer
argument_list|(
name|scp
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ISMOUSEAVAIL
argument_list|(
name|scp
operator|->
name|adp
operator|->
name|va_flags
argument_list|)
condition|)
name|sc_alloc_cut_buffer
argument_list|(
name|scp
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|sc_alloc_history_buffer
argument_list|(
name|scp
argument_list|,
name|sc_history_size
argument_list|,
name|i
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|scp
operator|==
name|cur_console
condition|)
name|set_border
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|border
argument_list|)
expr_stmt|;
name|scp
operator|->
name|status
operator|&=
operator|~
name|UNKNOWN_MODE
expr_stmt|;
ifdef|#
directive|ifdef
name|SC_VIDEO_DEBUG
name|printf
argument_list|(
literal|"set_pixel_mode(): status:%x\n"
argument_list|,
name|scp
operator|->
name|status
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|tp
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|tp
operator|->
name|t_winsize
operator|.
name|ws_col
operator|!=
name|scp
operator|->
name|xsize
operator|||
name|tp
operator|->
name|t_winsize
operator|.
name|ws_row
operator|!=
name|scp
operator|->
name|ysize
condition|)
block|{
name|tp
operator|->
name|t_winsize
operator|.
name|ws_col
operator|=
name|scp
operator|->
name|xsize
expr_stmt|;
name|tp
operator|->
name|t_winsize
operator|.
name|ws_row
operator|=
name|scp
operator|->
name|ysize
expr_stmt|;
name|pgsignal
argument_list|(
name|tp
operator|->
name|t_pgrp
argument_list|,
name|SIGWINCH
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sc_vid_ioctl
parameter_list|(
name|struct
name|tty
modifier|*
name|tp
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|,
name|int
name|flag
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
block|{
name|scr_stat
modifier|*
name|scp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|s
decl_stmt|;
name|scp
operator|=
name|sc_get_scr_stat
argument_list|(
name|tp
operator|->
name|t_dev
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|CONS_CURRENT
case|:
comment|/* get current adapter type */
if|if
condition|(
name|scp
operator|->
name|adp
operator|==
name|NULL
condition|)
return|return
name|ENODEV
return|;
operator|*
operator|(
name|int
operator|*
operator|)
name|data
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_type
expr_stmt|;
return|return
literal|0
return|;
case|case
name|CONS_CURRENTADP
case|:
comment|/* get current adapter index */
operator|*
operator|(
name|int
operator|*
operator|)
name|data
operator|=
name|scp
operator|->
name|ad
expr_stmt|;
return|return
literal|0
return|;
case|case
name|OLD_CONS_ADPINFO
case|:
comment|/* adapter information */
if|if
condition|(
name|scp
operator|->
name|adp
operator|==
name|NULL
condition|)
return|return
name|ENODEV
return|;
operator|(
operator|(
name|old_video_adapter_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_index
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_index
expr_stmt|;
operator|(
operator|(
name|old_video_adapter_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_type
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_type
expr_stmt|;
operator|(
operator|(
name|old_video_adapter_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_flags
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_flags
expr_stmt|;
operator|(
operator|(
name|old_video_adapter_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_crtc_addr
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_crtc_addr
expr_stmt|;
operator|(
operator|(
name|old_video_adapter_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_window
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_window
expr_stmt|;
operator|(
operator|(
name|old_video_adapter_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_window_size
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_window_size
expr_stmt|;
operator|(
operator|(
name|old_video_adapter_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_window_gran
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_window_gran
expr_stmt|;
operator|(
operator|(
name|old_video_adapter_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_buffer
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_buffer
expr_stmt|;
operator|(
operator|(
name|old_video_adapter_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_buffer_size
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_buffer_size
expr_stmt|;
operator|(
operator|(
name|old_video_adapter_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_mode
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_mode
expr_stmt|;
operator|(
operator|(
name|old_video_adapter_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_initial_mode
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_initial_mode
expr_stmt|;
operator|(
operator|(
name|old_video_adapter_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_initial_bios_mode
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_initial_bios_mode
expr_stmt|;
return|return
literal|0
return|;
case|case
name|CONS_ADPINFO
case|:
comment|/* adapter information */
if|if
condition|(
name|scp
operator|->
name|adp
operator|==
name|NULL
condition|)
return|return
name|ENODEV
return|;
operator|(
operator|(
name|video_adapter_info_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_index
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_index
expr_stmt|;
operator|(
operator|(
name|video_adapter_info_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_type
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_type
expr_stmt|;
name|bcopy
argument_list|(
name|scp
operator|->
name|adp
operator|->
name|va_name
argument_list|,
operator|(
operator|(
name|video_adapter_info_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_name
argument_list|,
name|imin
argument_list|(
name|strlen
argument_list|(
name|scp
operator|->
name|adp
operator|->
name|va_name
argument_list|)
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|(
operator|(
name|video_adapter_info_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_name
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
operator|(
operator|(
name|video_adapter_info_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_unit
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_unit
expr_stmt|;
operator|(
operator|(
name|video_adapter_info_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_flags
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_flags
expr_stmt|;
operator|(
operator|(
name|video_adapter_info_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_io_base
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_io_base
expr_stmt|;
operator|(
operator|(
name|video_adapter_info_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_io_size
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_io_size
expr_stmt|;
operator|(
operator|(
name|video_adapter_info_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_crtc_addr
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_crtc_addr
expr_stmt|;
operator|(
operator|(
name|video_adapter_info_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_mem_base
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_mem_base
expr_stmt|;
operator|(
operator|(
name|video_adapter_info_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_mem_size
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_mem_size
expr_stmt|;
operator|(
operator|(
name|video_adapter_info_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_window
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_window
expr_stmt|;
operator|(
operator|(
name|video_adapter_info_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_window_size
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_window_size
expr_stmt|;
operator|(
operator|(
name|video_adapter_info_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_window_gran
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_window_gran
expr_stmt|;
operator|(
operator|(
name|video_adapter_info_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_buffer
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_buffer
expr_stmt|;
operator|(
operator|(
name|video_adapter_info_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_buffer_size
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_buffer_size
expr_stmt|;
operator|(
operator|(
name|video_adapter_info_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_mode
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_mode
expr_stmt|;
operator|(
operator|(
name|video_adapter_info_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_initial_mode
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_initial_mode
expr_stmt|;
operator|(
operator|(
name|video_adapter_info_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_initial_bios_mode
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_initial_bios_mode
expr_stmt|;
operator|(
operator|(
name|video_adapter_info_t
operator|*
operator|)
name|data
operator|)
operator|->
name|va_line_width
operator|=
name|scp
operator|->
name|adp
operator|->
name|va_line_width
expr_stmt|;
return|return
literal|0
return|;
case|case
name|CONS_GET
case|:
comment|/* get current video mode */
operator|*
operator|(
name|int
operator|*
operator|)
name|data
operator|=
name|scp
operator|->
name|mode
expr_stmt|;
return|return
literal|0
return|;
case|case
name|CONS_MODEINFO
case|:
comment|/* get mode information */
return|return
operator|(
operator|(
operator|*
name|vidsw
index|[
name|scp
operator|->
name|ad
index|]
operator|->
name|get_info
operator|)
operator|(
name|scp
operator|->
name|adp
operator|,
operator|(
operator|(
name|video_info_t
operator|*
operator|)
name|data
operator|)
operator|->
name|vi_mode
operator|,
operator|(
name|video_info_t
operator|*
operator|)
name|data
operator|)
condition|?
name|ENODEV
else|:
literal|0
operator|)
return|;
case|case
name|CONS_FINDMODE
case|:
comment|/* find a matching video mode */
return|return
operator|(
operator|(
operator|*
name|vidsw
index|[
name|scp
operator|->
name|ad
index|]
operator|->
name|query_mode
operator|)
operator|(
name|scp
operator|->
name|adp
operator|,
operator|(
name|video_info_t
operator|*
operator|)
name|data
operator|)
condition|?
name|ENODEV
else|:
literal|0
operator|)
return|;
case|case
name|CONS_SETWINORG
case|:
return|return
operator|(
operator|(
operator|*
name|vidsw
index|[
name|scp
operator|->
name|ad
index|]
operator|->
name|set_win_org
operator|)
operator|(
name|scp
operator|->
name|adp
operator|,
operator|*
operator|(
name|u_int
operator|*
operator|)
name|data
operator|)
condition|?
name|ENODEV
else|:
literal|0
operator|)
return|;
comment|/* generic text modes */
case|case
name|SW_TEXT_80x25
case|:
case|case
name|SW_TEXT_80x30
case|:
case|case
name|SW_TEXT_80x43
case|:
case|case
name|SW_TEXT_80x50
case|:
case|case
name|SW_TEXT_80x60
case|:
comment|/* FALL THROUGH */
comment|/* VGA TEXT MODES */
case|case
name|SW_VGA_C40x25
case|:
case|case
name|SW_VGA_C80x25
case|:
case|case
name|SW_VGA_M80x25
case|:
case|case
name|SW_VGA_C80x30
case|:
case|case
name|SW_VGA_M80x30
case|:
case|case
name|SW_VGA_C80x50
case|:
case|case
name|SW_VGA_M80x50
case|:
case|case
name|SW_VGA_C80x60
case|:
case|case
name|SW_VGA_M80x60
case|:
case|case
name|SW_B40x25
case|:
case|case
name|SW_C40x25
case|:
case|case
name|SW_B80x25
case|:
case|case
name|SW_C80x25
case|:
case|case
name|SW_ENH_B40x25
case|:
case|case
name|SW_ENH_C40x25
case|:
case|case
name|SW_ENH_B80x25
case|:
case|case
name|SW_ENH_C80x25
case|:
case|case
name|SW_ENH_B80x43
case|:
case|case
name|SW_ENH_C80x43
case|:
case|case
name|SW_EGAMONO80x25
case|:
ifdef|#
directive|ifdef
name|PC98
comment|/* PC98 TEXT MODES */
case|case
name|SW_PC98_80x25
case|:
case|case
name|SW_PC98_80x30
case|:
endif|#
directive|endif
if|if
condition|(
operator|!
operator|(
name|scp
operator|->
name|adp
operator|->
name|va_flags
operator|&
name|V_ADP_MODECHANGE
operator|)
condition|)
return|return
name|ENODEV
return|;
return|return
name|sc_set_text_mode
argument_list|(
name|scp
argument_list|,
name|tp
argument_list|,
name|cmd
operator|&
literal|0xff
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
return|;
comment|/* GRAPHICS MODES */
case|case
name|SW_BG320
case|:
case|case
name|SW_BG640
case|:
case|case
name|SW_CG320
case|:
case|case
name|SW_CG320_D
case|:
case|case
name|SW_CG640_E
case|:
case|case
name|SW_CG640x350
case|:
case|case
name|SW_ENH_CG640
case|:
case|case
name|SW_BG640x480
case|:
case|case
name|SW_CG640x480
case|:
case|case
name|SW_VGA_CG320
case|:
case|case
name|SW_VGA_MODEX
case|:
if|if
condition|(
operator|!
operator|(
name|scp
operator|->
name|adp
operator|->
name|va_flags
operator|&
name|V_ADP_MODECHANGE
operator|)
condition|)
return|return
name|ENODEV
return|;
return|return
name|sc_set_graphics_mode
argument_list|(
name|scp
argument_list|,
name|tp
argument_list|,
name|cmd
operator|&
literal|0xff
argument_list|)
return|;
case|case
name|KDSETMODE
case|:
comment|/* set current mode of this (virtual) console */
switch|switch
condition|(
operator|*
operator|(
name|int
operator|*
operator|)
name|data
condition|)
block|{
case|case
name|KD_TEXT
case|:
comment|/* switch to TEXT (known) mode */
comment|/* 	     * If scp->mode is of graphics modes, we don't know which 	     * text mode to switch back to... 	     */
if|if
condition|(
name|scp
operator|->
name|status
operator|&
name|GRAPHICS_MODE
condition|)
return|return
name|EINVAL
return|;
comment|/* restore fonts& palette ! */
if|#
directive|if
literal|0
block|if (ISFONTAVAIL(scp->adp->va_flags)&& !(scp->status& (GRAPHICS_MODE | PIXEL_MODE)))
comment|/* 		 * FONT KLUDGE 		 * Don't load fonts for now... XXX 		 */
block|if (fonts_loaded& FONT_8) 		    copy_font(scp, LOAD, 8, font_8); 		if (fonts_loaded& FONT_14) 		    copy_font(scp, LOAD, 14, font_14); 		if (fonts_loaded& FONT_16) 		    copy_font(scp, LOAD, 16, font_16); 	    }
endif|#
directive|endif
name|load_palette
argument_list|(
name|scp
operator|->
name|adp
argument_list|,
name|palette
argument_list|)
expr_stmt|;
comment|/* move hardware cursor out of the way */
operator|(
operator|*
name|vidsw
index|[
name|scp
operator|->
name|ad
index|]
operator|->
name|set_hw_cursor
operator|)
operator|(
name|scp
operator|->
name|adp
operator|,
operator|-
literal|1
operator|,
operator|-
literal|1
operator|)
expr_stmt|;
comment|/* FALL THROUGH */
case|case
name|KD_TEXT1
case|:
comment|/* switch to TEXT (known) mode */
comment|/* 	     * If scp->mode is of graphics modes, we don't know which 	     * text/pixel mode to switch back to... 	     */
if|if
condition|(
name|scp
operator|->
name|status
operator|&
name|GRAPHICS_MODE
condition|)
return|return
name|EINVAL
return|;
name|s
operator|=
name|spltty
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|sc_clean_up
argument_list|(
name|scp
argument_list|)
operator|)
condition|)
block|{
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
ifndef|#
directive|ifndef
name|PC98
name|scp
operator|->
name|status
operator||=
name|UNKNOWN_MODE
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
comment|/* no restore fonts& palette */
if|if
condition|(
name|scp
operator|==
name|cur_console
condition|)
name|set_mode
argument_list|(
name|scp
argument_list|)
expr_stmt|;
name|sc_clear_screen
argument_list|(
name|scp
argument_list|)
expr_stmt|;
name|scp
operator|->
name|status
operator|&=
operator|~
name|UNKNOWN_MODE
expr_stmt|;
else|#
directive|else
comment|/* PC98 */
name|scp
operator|->
name|status
operator|&=
operator|~
name|UNKNOWN_MODE
expr_stmt|;
comment|/* no restore fonts& palette */
if|if
condition|(
name|scp
operator|==
name|cur_console
condition|)
name|set_mode
argument_list|(
name|scp
argument_list|)
expr_stmt|;
name|sc_clear_screen
argument_list|(
name|scp
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* PC98 */
return|return
literal|0
return|;
case|case
name|KD_PIXEL
case|:
comment|/* pixel (raster) display */
if|if
condition|(
operator|!
operator|(
name|scp
operator|->
name|status
operator|&
operator|(
name|GRAPHICS_MODE
operator||
name|PIXEL_MODE
operator|)
operator|)
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
name|scp
operator|->
name|status
operator|&
name|GRAPHICS_MODE
condition|)
return|return
name|sc_set_pixel_mode
argument_list|(
name|scp
argument_list|,
name|tp
argument_list|,
name|scp
operator|->
name|xsize
argument_list|,
name|scp
operator|->
name|ysize
argument_list|,
name|scp
operator|->
name|font_size
argument_list|)
return|;
name|s
operator|=
name|spltty
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|sc_clean_up
argument_list|(
name|scp
argument_list|)
operator|)
condition|)
block|{
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|scp
operator|->
name|status
operator||=
operator|(
name|UNKNOWN_MODE
operator||
name|PIXEL_MODE
operator|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|scp
operator|==
name|cur_console
condition|)
block|{
name|set_mode
argument_list|(
name|scp
argument_list|)
expr_stmt|;
name|load_palette
argument_list|(
name|scp
operator|->
name|adp
argument_list|,
name|palette
argument_list|)
expr_stmt|;
block|}
name|sc_clear_screen
argument_list|(
name|scp
argument_list|)
expr_stmt|;
name|scp
operator|->
name|status
operator|&=
operator|~
name|UNKNOWN_MODE
expr_stmt|;
return|return
literal|0
return|;
case|case
name|KD_GRAPHICS
case|:
comment|/* switch to GRAPHICS (unknown) mode */
name|s
operator|=
name|spltty
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|sc_clean_up
argument_list|(
name|scp
argument_list|)
operator|)
condition|)
block|{
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|scp
operator|->
name|status
operator||=
name|UNKNOWN_MODE
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|PC98
if|if
condition|(
name|scp
operator|==
name|cur_console
condition|)
name|set_mode
argument_list|(
name|scp
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
literal|0
return|;
default|default:
return|return
name|EINVAL
return|;
block|}
comment|/* NOT REACHED */
case|case
name|KDRASTER
case|:
comment|/* set pixel (raster) display mode */
if|if
condition|(
name|ISUNKNOWNSC
argument_list|(
name|scp
argument_list|)
operator|||
name|ISTEXTSC
argument_list|(
name|scp
argument_list|)
condition|)
return|return
name|ENODEV
return|;
return|return
name|sc_set_pixel_mode
argument_list|(
name|scp
argument_list|,
name|tp
argument_list|,
operator|(
operator|(
name|int
operator|*
operator|)
name|data
operator|)
index|[
literal|0
index|]
argument_list|,
operator|(
operator|(
name|int
operator|*
operator|)
name|data
operator|)
index|[
literal|1
index|]
argument_list|,
operator|(
operator|(
name|int
operator|*
operator|)
name|data
operator|)
index|[
literal|2
index|]
argument_list|)
return|;
case|case
name|KDGETMODE
case|:
comment|/* get current mode of this (virtual) console */
comment|/*  	 * From the user program's point of view, KD_PIXEL is the same  	 * as KD_TEXT...  	 */
operator|*
name|data
operator|=
name|ISGRAPHSC
argument_list|(
name|scp
argument_list|)
condition|?
name|KD_GRAPHICS
else|:
name|KD_TEXT
expr_stmt|;
return|return
literal|0
return|;
case|case
name|KDSBORDER
case|:
comment|/* set border color of this (virtual) console */
name|scp
operator|->
name|border
operator|=
operator|*
name|data
expr_stmt|;
if|if
condition|(
name|scp
operator|==
name|cur_console
condition|)
name|set_border
argument_list|(
name|scp
argument_list|,
name|scp
operator|->
name|border
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|ENOIOCTL
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NSC> 0 */
end_comment

end_unit


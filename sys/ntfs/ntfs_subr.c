begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$NetBSD: ntfs_subr.c,v 1.2 1999/05/06 15:43:19 christos Exp $	*/
end_comment

begin_comment
comment|/*-  * Copyright (c) 1998, 1999 Semen Ustimenko (semenu@FreeBSD.org)  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/namei.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/vnode.h>
end_include

begin_include
include|#
directive|include
file|<sys/mount.h>
end_include

begin_include
include|#
directive|include
file|<sys/buf.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
end_if

begin_include
include|#
directive|include
file|<machine/clock.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<miscfs/specfs/specdev.h>
end_include

begin_comment
comment|/* #define NTFS_DEBUG 1 */
end_comment

begin_include
include|#
directive|include
file|<ntfs/ntfs.h>
end_include

begin_include
include|#
directive|include
file|<ntfs/ntfsmount.h>
end_include

begin_include
include|#
directive|include
file|<ntfs/ntfs_inode.h>
end_include

begin_include
include|#
directive|include
file|<ntfs/ntfs_vfsops.h>
end_include

begin_include
include|#
directive|include
file|<ntfs/ntfs_extern.h>
end_include

begin_include
include|#
directive|include
file|<ntfs/ntfs_subr.h>
end_include

begin_include
include|#
directive|include
file|<ntfs/ntfs_compr.h>
end_include

begin_include
include|#
directive|include
file|<ntfs/ntfs_ihash.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
end_if

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_NTFSNTVATTR
argument_list|,
literal|"NTFS vattr"
argument_list|,
literal|"NTFS file attribute information"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_NTFSRDATA
argument_list|,
literal|"NTFS res data"
argument_list|,
literal|"NTFS resident data"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_NTFSRUN
argument_list|,
literal|"NTFS vrun"
argument_list|,
literal|"NTFS vrun storage"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_NTFSDECOMP
argument_list|,
literal|"NTFS decomp"
argument_list|,
literal|"NTFS decompression temporary"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  *   */
end_comment

begin_function
name|int
name|ntfs_ntvattrrele
parameter_list|(
name|struct
name|ntvattr
modifier|*
name|vap
parameter_list|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntvattrrele: ino: %d, type: 0x%x\n"
operator|,
name|vap
operator|->
name|va_ip
operator|->
name|i_number
operator|,
name|vap
operator|->
name|va_type
operator|)
argument_list|)
expr_stmt|;
name|ntfs_ntrele
argument_list|(
name|vap
operator|->
name|va_ip
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Search attribute specifed in ntnode (load ntnode if nessecary).  * If not found but ATTR_A_ATTRLIST present, read it in and search throught.  * VOP_VGET node needed, and lookup througth it's ntnode (load if nessesary).  *  * ntnode should be locked  */
end_comment

begin_function
name|int
name|ntfs_ntvattrget
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|struct
name|ntnode
modifier|*
name|ip
parameter_list|,
name|u_int32_t
name|type
parameter_list|,
name|char
modifier|*
name|name
parameter_list|,
name|cn_t
name|vcn
parameter_list|,
name|struct
name|ntvattr
modifier|*
modifier|*
name|vapp
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|struct
name|ntvattr
modifier|*
name|vap
decl_stmt|;
name|struct
name|ntvattr
modifier|*
name|lvap
init|=
name|NULL
decl_stmt|;
name|struct
name|attr_attrlist
modifier|*
name|aalp
decl_stmt|;
name|struct
name|attr_attrlist
modifier|*
name|nextaalp
decl_stmt|;
name|caddr_t
name|alpool
decl_stmt|;
name|int
name|len
decl_stmt|,
name|namelen
decl_stmt|;
operator|*
name|vapp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|name
condition|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntvattrget: "
expr|\
literal|"ino: %d, type: 0x%x, name: %s, vcn: %d\n"
operator|,
expr|\
name|ip
operator|->
name|i_number
operator|,
name|type
operator|,
name|name
operator|,
operator|(
name|u_int32_t
operator|)
name|vcn
operator|)
argument_list|)
expr_stmt|;
name|namelen
operator|=
name|strlen
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntvattrget: "
expr|\
literal|"ino: %d, type: 0x%x, vcn: %d\n"
operator|,
expr|\
name|ip
operator|->
name|i_number
operator|,
name|type
operator|,
operator|(
name|u_int32_t
operator|)
name|vcn
operator|)
argument_list|)
expr_stmt|;
name|name
operator|=
literal|""
expr_stmt|;
name|namelen
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ip
operator|->
name|i_flag
operator|&
name|IN_LOADED
operator|)
operator|==
literal|0
condition|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntvattrget: node not loaded, ino: %d\n"
operator|,
name|ip
operator|->
name|i_number
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ntfs_loadntnode
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_ntvattrget: FAILED TO LOAD INO: %d\n"
argument_list|,
name|ip
operator|->
name|i_number
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
for|for
control|(
name|vap
operator|=
name|ip
operator|->
name|i_valist
operator|.
name|lh_first
init|;
name|vap
condition|;
name|vap
operator|=
name|vap
operator|->
name|va_list
operator|.
name|le_next
control|)
block|{
name|ddprintf
argument_list|(
operator|(
literal|"type: 0x%x, vcn: %d - %d\n"
operator|,
expr|\
name|vap
operator|->
name|va_type
operator|,
operator|(
name|u_int32_t
operator|)
name|vap
operator|->
name|va_vcnstart
operator|,
expr|\
operator|(
name|u_int32_t
operator|)
name|vap
operator|->
name|va_vcnend
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|vap
operator|->
name|va_type
operator|==
name|type
operator|)
operator|&&
operator|(
name|vap
operator|->
name|va_vcnstart
operator|<=
name|vcn
operator|)
operator|&&
operator|(
name|vap
operator|->
name|va_vcnend
operator|>=
name|vcn
operator|)
operator|&&
operator|(
name|vap
operator|->
name|va_namelen
operator|==
name|namelen
operator|)
operator|&&
operator|(
operator|!
name|strncmp
argument_list|(
name|name
argument_list|,
name|vap
operator|->
name|va_name
argument_list|,
name|namelen
argument_list|)
operator|)
condition|)
block|{
operator|*
name|vapp
operator|=
name|vap
expr_stmt|;
name|ntfs_ntref
argument_list|(
name|vap
operator|->
name|va_ip
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|vap
operator|->
name|va_type
operator|==
name|NTFS_A_ATTRLIST
condition|)
name|lvap
operator|=
name|vap
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|lvap
condition|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntvattrget: UNEXISTED ATTRIBUTE: "
expr|\
literal|"ino: %d, type: 0x%x, name: %s, vcn: %d\n"
operator|,
expr|\
name|ip
operator|->
name|i_number
operator|,
name|type
operator|,
name|name
operator|,
operator|(
name|u_int32_t
operator|)
name|vcn
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
comment|/* Scan $ATTRIBUTE_LIST for requested attribute */
name|len
operator|=
name|lvap
operator|->
name|va_datalen
expr_stmt|;
name|MALLOC
argument_list|(
name|alpool
argument_list|,
name|caddr_t
argument_list|,
name|len
argument_list|,
name|M_TEMP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|error
operator|=
name|ntfs_readntvattr_plain
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|lvap
argument_list|,
literal|0
argument_list|,
name|len
argument_list|,
name|alpool
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|out
goto|;
name|aalp
operator|=
operator|(
expr|struct
name|attr_attrlist
operator|*
operator|)
name|alpool
expr_stmt|;
name|nextaalp
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|len
operator|>
literal|0
condition|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntvattrget: "
expr|\
literal|"attrlist: ino: %d, attr: 0x%x, vcn: %d\n"
operator|,
expr|\
name|aalp
operator|->
name|al_inumber
operator|,
name|aalp
operator|->
name|al_type
operator|,
expr|\
operator|(
name|u_int32_t
operator|)
name|aalp
operator|->
name|al_vcnstart
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|aalp
operator|->
name|reclen
condition|)
block|{
name|nextaalp
operator|=
name|NTFS_NEXTREC
argument_list|(
name|aalp
argument_list|,
expr|struct
name|attr_attrlist
operator|*
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nextaalp
operator|=
name|NULL
expr_stmt|;
block|}
name|len
operator|-=
name|aalp
operator|->
name|reclen
expr_stmt|;
define|#
directive|define
name|AALPCMP
parameter_list|(
name|aalp
parameter_list|,
name|type
parameter_list|,
name|name
parameter_list|,
name|namelen
parameter_list|)
value|(				\   (aalp->al_type == type)&& (aalp->al_namelen == namelen)&&		\   !uastrcmp(aalp->al_name,aalp->al_namelen,name,namelen) )
if|if
condition|(
name|AALPCMP
argument_list|(
name|aalp
argument_list|,
name|type
argument_list|,
name|name
argument_list|,
name|namelen
argument_list|)
operator|&&
operator|(
operator|!
name|nextaalp
operator|||
operator|(
name|nextaalp
operator|->
name|al_vcnstart
operator|>
name|vcn
operator|)
operator|||
operator|!
name|AALPCMP
argument_list|(
name|nextaalp
argument_list|,
name|type
argument_list|,
name|name
argument_list|,
name|namelen
argument_list|)
operator|)
condition|)
block|{
name|struct
name|vnode
modifier|*
name|newvp
decl_stmt|;
name|struct
name|ntnode
modifier|*
name|newip
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntvattrget: attrbute in ino: %d\n"
operator|,
name|aalp
operator|->
name|al_inumber
operator|)
argument_list|)
expr_stmt|;
comment|/* 			error = VFS_VGET(ntmp->ntm_mountp, aalp->al_inumber,&newvp); */
name|error
operator|=
name|ntfs_vgetex
argument_list|(
name|ntmp
operator|->
name|ntm_mountp
argument_list|,
name|aalp
operator|->
name|al_inumber
argument_list|,
name|NTFS_A_DATA
argument_list|,
name|NULL
argument_list|,
name|LK_EXCLUSIVE
argument_list|,
name|VG_EXT
argument_list|,
name|curproc
argument_list|,
operator|&
name|newvp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_ntvattrget: CAN'T VGET INO: %d\n"
argument_list|,
name|aalp
operator|->
name|al_inumber
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|newip
operator|=
name|VTONT
argument_list|(
name|newvp
argument_list|)
expr_stmt|;
comment|/* XXX have to lock ntnode */
if|if
condition|(
operator|~
name|newip
operator|->
name|i_flag
operator|&
name|IN_LOADED
condition|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntvattrget: node not loaded,"
expr|\
literal|" ino: %d\n"
operator|,
name|newip
operator|->
name|i_number
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ntfs_loadntnode
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_ntvattrget: CAN'T LOAD "
expr|\
literal|"INO: %d\n"
argument_list|,
name|newip
operator|->
name|i_number
argument_list|)
expr_stmt|;
name|vput
argument_list|(
name|newvp
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
for|for
control|(
name|vap
operator|=
name|newip
operator|->
name|i_valist
operator|.
name|lh_first
init|;
name|vap
condition|;
name|vap
operator|=
name|vap
operator|->
name|va_list
operator|.
name|le_next
control|)
block|{
if|if
condition|(
operator|(
name|vap
operator|->
name|va_type
operator|==
name|type
operator|)
operator|&&
operator|(
name|vap
operator|->
name|va_vcnstart
operator|<=
name|vcn
operator|)
operator|&&
operator|(
name|vap
operator|->
name|va_vcnend
operator|>=
name|vcn
operator|)
operator|&&
operator|(
name|vap
operator|->
name|va_namelen
operator|==
name|namelen
operator|)
operator|&&
operator|(
operator|!
name|strncmp
argument_list|(
name|name
argument_list|,
name|vap
operator|->
name|va_name
argument_list|,
name|namelen
argument_list|)
operator|)
condition|)
block|{
operator|*
name|vapp
operator|=
name|vap
expr_stmt|;
name|ntfs_ntref
argument_list|(
name|vap
operator|->
name|va_ip
argument_list|)
expr_stmt|;
name|vput
argument_list|(
name|newvp
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|vap
operator|->
name|va_type
operator|==
name|NTFS_A_ATTRLIST
condition|)
name|lvap
operator|=
name|vap
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"ntfs_ntvattrget: ATTRLIST ERROR.\n"
argument_list|)
expr_stmt|;
name|vput
argument_list|(
name|newvp
argument_list|)
expr_stmt|;
break|break;
block|}
undef|#
directive|undef
name|AALPCMP
name|aalp
operator|=
name|nextaalp
expr_stmt|;
block|}
name|error
operator|=
name|ENOENT
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntvattrget: UNEXISTED ATTRIBUTE: "
expr|\
literal|"ino: %d, type: 0x%x, name: %s, vcn: %d\n"
operator|,
expr|\
name|ip
operator|->
name|i_number
operator|,
name|type
operator|,
name|name
operator|,
operator|(
name|u_int32_t
operator|)
name|vcn
operator|)
argument_list|)
expr_stmt|;
name|out
label|:
name|FREE
argument_list|(
name|alpool
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Read ntnode from disk, make ntvattr list.  *  * ntnode should be locked  */
end_comment

begin_function
name|int
name|ntfs_loadntnode
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|struct
name|ntnode
modifier|*
name|ip
parameter_list|)
block|{
name|struct
name|filerec
modifier|*
name|mfrp
decl_stmt|;
name|daddr_t
name|bn
decl_stmt|;
name|int
name|error
decl_stmt|,
name|off
decl_stmt|;
name|struct
name|attr
modifier|*
name|ap
decl_stmt|;
name|struct
name|ntvattr
modifier|*
name|nvap
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_loadnode: loading ino: %d\n"
operator|,
name|ip
operator|->
name|i_number
operator|)
argument_list|)
expr_stmt|;
name|MALLOC
argument_list|(
name|mfrp
argument_list|,
expr|struct
name|filerec
operator|*
argument_list|,
name|ntfs_bntob
argument_list|(
name|ntmp
operator|->
name|ntm_bpmftrec
argument_list|)
argument_list|,
name|M_TEMP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|i_number
operator|<
name|NTFS_SYSNODESNUM
condition|)
block|{
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_loadnode: read system node\n"
operator|)
argument_list|)
expr_stmt|;
name|bn
operator|=
name|ntfs_cntobn
argument_list|(
name|ntmp
operator|->
name|ntm_mftcn
argument_list|)
operator|+
name|ntmp
operator|->
name|ntm_bpmftrec
operator|*
name|ip
operator|->
name|i_number
expr_stmt|;
name|error
operator|=
name|bread
argument_list|(
name|ntmp
operator|->
name|ntm_devvp
argument_list|,
name|bn
argument_list|,
name|ntfs_bntob
argument_list|(
name|ntmp
operator|->
name|ntm_bpmftrec
argument_list|)
argument_list|,
name|NOCRED
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_loadnode: BREAD FAILED\n"
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|memcpy
argument_list|(
name|mfrp
argument_list|,
name|bp
operator|->
name|b_data
argument_list|,
name|ntfs_bntob
argument_list|(
name|ntmp
operator|->
name|ntm_bpmftrec
argument_list|)
argument_list|)
expr_stmt|;
name|bqrelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|vnode
modifier|*
name|vp
decl_stmt|;
name|vp
operator|=
name|ntmp
operator|->
name|ntm_sysvn
index|[
name|NTFS_MFTINO
index|]
expr_stmt|;
name|error
operator|=
name|ntfs_readattr
argument_list|(
name|ntmp
argument_list|,
name|VTONT
argument_list|(
name|vp
argument_list|)
argument_list|,
name|NTFS_A_DATA
argument_list|,
name|NULL
argument_list|,
name|ip
operator|->
name|i_number
operator|*
name|ntfs_bntob
argument_list|(
name|ntmp
operator|->
name|ntm_bpmftrec
argument_list|)
argument_list|,
name|ntfs_bntob
argument_list|(
name|ntmp
operator|->
name|ntm_bpmftrec
argument_list|)
argument_list|,
name|mfrp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_loadnode: ntfs_readattr failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
comment|/* Check if magic and fixups are correct */
name|error
operator|=
name|ntfs_procfixups
argument_list|(
name|ntmp
argument_list|,
name|NTFS_FILEMAGIC
argument_list|,
operator|(
name|caddr_t
operator|)
name|mfrp
argument_list|,
name|ntfs_bntob
argument_list|(
name|ntmp
operator|->
name|ntm_bpmftrec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_loadnode: BAD MFT RECORD %d\n"
argument_list|,
operator|(
name|u_int32_t
operator|)
name|ip
operator|->
name|i_number
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|dprintf
argument_list|(
operator|(
literal|"ntfs_loadnode: load attrs for ino: %d\n"
operator|,
name|ip
operator|->
name|i_number
operator|)
argument_list|)
expr_stmt|;
name|off
operator|=
name|mfrp
operator|->
name|fr_attroff
expr_stmt|;
name|ap
operator|=
operator|(
expr|struct
name|attr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|mfrp
operator|+
name|off
operator|)
expr_stmt|;
name|LIST_INIT
argument_list|(
operator|&
name|ip
operator|->
name|i_valist
argument_list|)
expr_stmt|;
while|while
condition|(
name|ap
operator|->
name|a_hdr
operator|.
name|a_type
operator|!=
operator|-
literal|1
condition|)
block|{
name|error
operator|=
name|ntfs_attrtontvattr
argument_list|(
name|ntmp
argument_list|,
operator|&
name|nvap
argument_list|,
name|ap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|nvap
operator|->
name|va_ip
operator|=
name|ip
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|ip
operator|->
name|i_valist
argument_list|,
name|nvap
argument_list|,
name|va_list
argument_list|)
expr_stmt|;
name|off
operator|+=
name|ap
operator|->
name|a_hdr
operator|.
name|reclen
expr_stmt|;
name|ap
operator|=
operator|(
expr|struct
name|attr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|mfrp
operator|+
name|off
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_loadnode: failed to load attr ino: %d\n"
argument_list|,
name|ip
operator|->
name|i_number
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ip
operator|->
name|i_mainrec
operator|=
name|mfrp
operator|->
name|fr_mainrec
expr_stmt|;
name|ip
operator|->
name|i_nlink
operator|=
name|mfrp
operator|->
name|fr_nlink
expr_stmt|;
name|ip
operator|->
name|i_frflag
operator|=
name|mfrp
operator|->
name|fr_flags
expr_stmt|;
name|ip
operator|->
name|i_flag
operator||=
name|IN_LOADED
expr_stmt|;
name|out
label|:
name|FREE
argument_list|(
name|mfrp
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Routine locks ntnode and increase usecount, just opposite of  * ntfs_ntput.  */
end_comment

begin_function
name|int
name|ntfs_ntget
parameter_list|(
name|struct
name|ntnode
modifier|*
name|ip
parameter_list|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntget: get ntnode %d: %p, usecount: %d\n"
operator|,
name|ip
operator|->
name|i_number
operator|,
name|ip
operator|,
name|ip
operator|->
name|i_usecount
operator|)
argument_list|)
expr_stmt|;
name|ip
operator|->
name|i_usecount
operator|++
expr_stmt|;
name|restart
label|:
if|if
condition|(
name|ip
operator|->
name|i_lock
condition|)
block|{
while|while
condition|(
name|ip
operator|->
name|i_lock
condition|)
block|{
name|ip
operator|->
name|i_lock
operator|=
operator|-
literal|1
expr_stmt|;
name|tsleep
argument_list|(
operator|&
name|ip
operator|->
name|i_lock
argument_list|,
name|PVM
argument_list|,
literal|"ntnode"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
goto|goto
name|restart
goto|;
block|}
name|ip
operator|->
name|i_lock
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Routine search ntnode in hash, if found: lock, inc usecount and return.  * If not in hash allocate structure for ntnode, prefill it, lock,  * inc count and return.  *  * ntnode returned locked  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|ntfs_ntnode_hash_lock
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|ntfs_ntlookup
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|ino_t
name|ino
parameter_list|,
name|struct
name|ntnode
modifier|*
modifier|*
name|ipp
parameter_list|)
block|{
name|struct
name|ntnode
modifier|*
name|ip
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntlookup: for ntnode %d\n"
operator|,
name|ino
operator|)
argument_list|)
expr_stmt|;
operator|*
name|ipp
operator|=
name|NULL
expr_stmt|;
name|restart
label|:
name|ip
operator|=
name|ntfs_nthashlookup
argument_list|(
name|ntmp
operator|->
name|ntm_dev
argument_list|,
name|ino
argument_list|)
expr_stmt|;
comment|/* XXX */
if|if
condition|(
name|ip
condition|)
block|{
name|ntfs_ntget
argument_list|(
name|ip
argument_list|)
expr_stmt|;
operator|*
name|ipp
operator|=
name|ip
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntlookup: ntnode %d: %p, usecount: %d\n"
operator|,
name|ino
operator|,
name|ip
operator|,
name|ip
operator|->
name|i_usecount
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|ntfs_ntnode_hash_lock
condition|)
block|{
while|while
condition|(
name|ntfs_ntnode_hash_lock
condition|)
block|{
name|ntfs_ntnode_hash_lock
operator|=
operator|-
literal|1
expr_stmt|;
name|tsleep
argument_list|(
operator|&
name|ntfs_ntnode_hash_lock
argument_list|,
name|PVM
argument_list|,
literal|"ntfsntgt"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
goto|goto
name|restart
goto|;
block|}
name|ntfs_ntnode_hash_lock
operator|=
literal|1
expr_stmt|;
name|MALLOC
argument_list|(
name|ip
argument_list|,
expr|struct
name|ntnode
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ntnode
argument_list|)
argument_list|,
name|M_NTFSNTNODE
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|"ntfs_ntlookup: allocating ntnode: %d: %p\n"
operator|,
name|ino
operator|,
name|ip
operator|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|caddr_t
operator|)
name|ip
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ntnode
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Generic initialization */
name|ip
operator|->
name|i_number
operator|=
name|ino
expr_stmt|;
name|ip
operator|->
name|i_mp
operator|=
name|ntmp
expr_stmt|;
name|ip
operator|->
name|i_dev
operator|=
name|ntmp
operator|->
name|ntm_dev
expr_stmt|;
name|ip
operator|->
name|i_uid
operator|=
name|ntmp
operator|->
name|ntm_uid
expr_stmt|;
name|ip
operator|->
name|i_gid
operator|=
name|ntmp
operator|->
name|ntm_gid
expr_stmt|;
name|ip
operator|->
name|i_mode
operator|=
name|ntmp
operator|->
name|ntm_mode
expr_stmt|;
name|ip
operator|->
name|i_usecount
operator|++
expr_stmt|;
name|ip
operator|->
name|i_lock
operator|=
literal|1
expr_stmt|;
name|LIST_INIT
argument_list|(
operator|&
name|ip
operator|->
name|i_fnlist
argument_list|)
expr_stmt|;
name|ntfs_nthashins
argument_list|(
name|ip
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntfs_ntnode_hash_lock
operator|<
literal|0
condition|)
name|wakeup
argument_list|(
operator|&
name|ntfs_ntnode_hash_lock
argument_list|)
expr_stmt|;
name|ntfs_ntnode_hash_lock
operator|=
literal|0
expr_stmt|;
operator|*
name|ipp
operator|=
name|ip
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntlookup: ntnode %d: %p, usecount: %d\n"
operator|,
name|ino
operator|,
name|ip
operator|,
name|ip
operator|->
name|i_usecount
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Decrement usecount of ntnode and unlock it, if usecount reach zero,  * deallocate ntnode.  *  * ntnode should be locked on entry, and unlocked on return.  */
end_comment

begin_function
name|void
name|ntfs_ntput
parameter_list|(
name|struct
name|ntnode
modifier|*
name|ip
parameter_list|)
block|{
name|struct
name|ntvattr
modifier|*
name|vap
decl_stmt|;
if|if
condition|(
operator|!
name|ip
operator|->
name|i_lock
condition|)
name|printf
argument_list|(
literal|"ntfs_ntput: NOT LOCKED"
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntput: rele ntnode %d: %p, usecount: %d\n"
operator|,
name|ip
operator|->
name|i_number
operator|,
name|ip
operator|,
name|ip
operator|->
name|i_usecount
operator|)
argument_list|)
expr_stmt|;
name|ip
operator|->
name|i_usecount
operator|--
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|i_usecount
operator|<
literal|0
condition|)
block|{
name|panic
argument_list|(
literal|"ntfs_ntput: ino: %d usecount: %d \n"
argument_list|,
name|ip
operator|->
name|i_number
argument_list|,
name|ip
operator|->
name|i_usecount
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ip
operator|->
name|i_usecount
operator|==
literal|0
condition|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntput: deallocating ntnode: %d\n"
operator|,
name|ip
operator|->
name|i_number
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|i_fnlist
operator|.
name|lh_first
condition|)
name|panic
argument_list|(
literal|"ntfs_ntput: ntnode has fnodes\n"
argument_list|)
expr_stmt|;
name|ntfs_nthashrem
argument_list|(
name|ip
argument_list|)
expr_stmt|;
while|while
condition|(
name|ip
operator|->
name|i_valist
operator|.
name|lh_first
operator|!=
name|NULL
condition|)
block|{
name|vap
operator|=
name|ip
operator|->
name|i_valist
operator|.
name|lh_first
expr_stmt|;
name|LIST_REMOVE
argument_list|(
name|vap
argument_list|,
name|va_list
argument_list|)
expr_stmt|;
name|ntfs_freentvattr
argument_list|(
name|vap
argument_list|)
expr_stmt|;
block|}
name|FREE
argument_list|(
name|ip
argument_list|,
name|M_NTFSNTNODE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ip
operator|->
name|i_lock
operator|<
literal|0
condition|)
name|wakeup
argument_list|(
operator|&
name|ip
operator|->
name|i_lock
argument_list|)
expr_stmt|;
name|ip
operator|->
name|i_lock
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Decrement usecount of ntnode.  */
end_comment

begin_function
name|void
name|ntfs_ntrele
parameter_list|(
name|struct
name|ntnode
modifier|*
name|ip
parameter_list|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntrele: rele ntnode %d: %p, usecount: %d\n"
operator|,
name|ip
operator|->
name|i_number
operator|,
name|ip
operator|,
name|ip
operator|->
name|i_usecount
operator|)
argument_list|)
expr_stmt|;
name|ip
operator|->
name|i_usecount
operator|--
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|i_usecount
operator|<
literal|0
condition|)
name|panic
argument_list|(
literal|"ntfs_ntrele: ino: %d usecount: %d \n"
argument_list|,
name|ip
operator|->
name|i_number
argument_list|,
name|ip
operator|->
name|i_usecount
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Deallocate all memory allocated for ntvattr by call to  * ntfs_attrtontvattr and some other functions.  */
end_comment

begin_function
name|void
name|ntfs_freentvattr
parameter_list|(
name|struct
name|ntvattr
modifier|*
name|vap
parameter_list|)
block|{
if|if
condition|(
name|vap
operator|->
name|va_flag
operator|&
name|NTFS_AF_INRUN
condition|)
block|{
if|if
condition|(
name|vap
operator|->
name|va_vruncn
condition|)
name|FREE
argument_list|(
name|vap
operator|->
name|va_vruncn
argument_list|,
name|M_NTFSRUN
argument_list|)
expr_stmt|;
if|if
condition|(
name|vap
operator|->
name|va_vruncl
condition|)
name|FREE
argument_list|(
name|vap
operator|->
name|va_vruncl
argument_list|,
name|M_NTFSRUN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|vap
operator|->
name|va_datap
condition|)
name|FREE
argument_list|(
name|vap
operator|->
name|va_datap
argument_list|,
name|M_NTFSRDATA
argument_list|)
expr_stmt|;
block|}
name|FREE
argument_list|(
name|vap
argument_list|,
name|M_NTFSNTVATTR
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Convert disk image of attribute into ntvattr structure,  * runs are expanded also.  */
end_comment

begin_function
name|int
name|ntfs_attrtontvattr
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|struct
name|ntvattr
modifier|*
modifier|*
name|rvapp
parameter_list|,
name|struct
name|attr
modifier|*
name|rap
parameter_list|)
block|{
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
name|struct
name|ntvattr
modifier|*
name|vap
decl_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
operator|*
name|rvapp
operator|=
name|NULL
expr_stmt|;
name|MALLOC
argument_list|(
name|vap
argument_list|,
expr|struct
name|ntvattr
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ntvattr
argument_list|)
argument_list|,
name|M_NTFSNTVATTR
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|vap
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ntvattr
argument_list|)
argument_list|)
expr_stmt|;
name|vap
operator|->
name|va_ip
operator|=
name|NULL
expr_stmt|;
name|vap
operator|->
name|va_flag
operator|=
name|rap
operator|->
name|a_hdr
operator|.
name|a_flag
expr_stmt|;
name|vap
operator|->
name|va_type
operator|=
name|rap
operator|->
name|a_hdr
operator|.
name|a_type
expr_stmt|;
name|vap
operator|->
name|va_compression
operator|=
name|rap
operator|->
name|a_hdr
operator|.
name|a_compression
expr_stmt|;
name|vap
operator|->
name|va_index
operator|=
name|rap
operator|->
name|a_hdr
operator|.
name|a_index
expr_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|"type: 0x%x, index: %d"
operator|,
name|vap
operator|->
name|va_type
operator|,
name|vap
operator|->
name|va_index
operator|)
argument_list|)
expr_stmt|;
name|vap
operator|->
name|va_namelen
operator|=
name|rap
operator|->
name|a_hdr
operator|.
name|a_namelen
expr_stmt|;
if|if
condition|(
name|rap
operator|->
name|a_hdr
operator|.
name|a_namelen
condition|)
block|{
name|wchar
modifier|*
name|unp
init|=
operator|(
name|wchar
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|rap
operator|+
name|rap
operator|->
name|a_hdr
operator|.
name|a_nameoff
operator|)
decl_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|", name:["
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vap
operator|->
name|va_namelen
condition|;
name|i
operator|++
control|)
block|{
name|vap
operator|->
name|va_name
index|[
name|i
index|]
operator|=
name|unp
index|[
name|i
index|]
expr_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|"%c"
operator|,
name|vap
operator|->
name|va_name
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
name|ddprintf
argument_list|(
operator|(
literal|"]"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|vap
operator|->
name|va_flag
operator|&
name|NTFS_AF_INRUN
condition|)
block|{
name|ddprintf
argument_list|(
operator|(
literal|", nonres."
operator|)
argument_list|)
expr_stmt|;
name|vap
operator|->
name|va_datalen
operator|=
name|rap
operator|->
name|a_nr
operator|.
name|a_datalen
expr_stmt|;
name|vap
operator|->
name|va_allocated
operator|=
name|rap
operator|->
name|a_nr
operator|.
name|a_allocated
expr_stmt|;
name|vap
operator|->
name|va_vcnstart
operator|=
name|rap
operator|->
name|a_nr
operator|.
name|a_vcnstart
expr_stmt|;
name|vap
operator|->
name|va_vcnend
operator|=
name|rap
operator|->
name|a_nr
operator|.
name|a_vcnend
expr_stmt|;
name|vap
operator|->
name|va_compressalg
operator|=
name|rap
operator|->
name|a_nr
operator|.
name|a_compressalg
expr_stmt|;
name|error
operator|=
name|ntfs_runtovrun
argument_list|(
operator|&
operator|(
name|vap
operator|->
name|va_vruncn
operator|)
argument_list|,
operator|&
operator|(
name|vap
operator|->
name|va_vruncl
operator|)
argument_list|,
operator|&
operator|(
name|vap
operator|->
name|va_vruncnt
operator|)
argument_list|,
operator|(
name|caddr_t
operator|)
name|rap
operator|+
name|rap
operator|->
name|a_nr
operator|.
name|a_dataoff
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|vap
operator|->
name|va_compressalg
operator|=
literal|0
expr_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|", res."
operator|)
argument_list|)
expr_stmt|;
name|vap
operator|->
name|va_datalen
operator|=
name|rap
operator|->
name|a_r
operator|.
name|a_datalen
expr_stmt|;
name|vap
operator|->
name|va_allocated
operator|=
name|rap
operator|->
name|a_r
operator|.
name|a_datalen
expr_stmt|;
name|vap
operator|->
name|va_vcnstart
operator|=
literal|0
expr_stmt|;
name|vap
operator|->
name|va_vcnend
operator|=
name|ntfs_btocn
argument_list|(
name|vap
operator|->
name|va_allocated
argument_list|)
expr_stmt|;
name|MALLOC
argument_list|(
name|vap
operator|->
name|va_datap
argument_list|,
name|caddr_t
argument_list|,
name|vap
operator|->
name|va_datalen
argument_list|,
name|M_NTFSRDATA
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|vap
operator|->
name|va_datap
argument_list|,
operator|(
name|caddr_t
operator|)
name|rap
operator|+
name|rap
operator|->
name|a_r
operator|.
name|a_dataoff
argument_list|,
name|rap
operator|->
name|a_r
operator|.
name|a_datalen
argument_list|)
expr_stmt|;
block|}
name|ddprintf
argument_list|(
operator|(
literal|", len: %d"
operator|,
name|vap
operator|->
name|va_datalen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|FREE
argument_list|(
name|vap
argument_list|,
name|M_NTFSNTVATTR
argument_list|)
expr_stmt|;
else|else
operator|*
name|rvapp
operator|=
name|vap
expr_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|"\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Expand run into more utilizable and more memory eating format.  */
end_comment

begin_function
name|int
name|ntfs_runtovrun
parameter_list|(
name|cn_t
modifier|*
modifier|*
name|rcnp
parameter_list|,
name|cn_t
modifier|*
modifier|*
name|rclp
parameter_list|,
name|u_long
modifier|*
name|rcntp
parameter_list|,
name|u_int8_t
modifier|*
name|run
parameter_list|)
block|{
name|u_int32_t
name|off
decl_stmt|;
name|u_int32_t
name|sz
decl_stmt|,
name|i
decl_stmt|;
name|cn_t
modifier|*
name|cn
decl_stmt|;
name|cn_t
modifier|*
name|cl
decl_stmt|;
name|u_long
name|cnt
decl_stmt|;
name|cn_t
name|prev
decl_stmt|;
name|cn_t
name|tmp
decl_stmt|;
name|off
operator|=
literal|0
expr_stmt|;
name|cnt
operator|=
literal|0
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|run
index|[
name|off
index|]
condition|)
block|{
name|off
operator|+=
operator|(
name|run
index|[
name|off
index|]
operator|&
literal|0xF
operator|)
operator|+
operator|(
operator|(
name|run
index|[
name|off
index|]
operator|>>
literal|4
operator|)
operator|&
literal|0xF
operator|)
operator|+
literal|1
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
block|}
name|MALLOC
argument_list|(
name|cn
argument_list|,
name|cn_t
operator|*
argument_list|,
name|cnt
operator|*
sizeof|sizeof
argument_list|(
name|cn_t
argument_list|)
argument_list|,
name|M_NTFSRUN
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|MALLOC
argument_list|(
name|cl
argument_list|,
name|cn_t
operator|*
argument_list|,
name|cnt
operator|*
sizeof|sizeof
argument_list|(
name|cn_t
argument_list|)
argument_list|,
name|M_NTFSRUN
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|off
operator|=
literal|0
expr_stmt|;
name|cnt
operator|=
literal|0
expr_stmt|;
name|prev
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|run
index|[
name|off
index|]
condition|)
block|{
name|sz
operator|=
name|run
index|[
name|off
operator|++
index|]
expr_stmt|;
name|cl
index|[
name|cnt
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|sz
operator|&
literal|0xF
operator|)
condition|;
name|i
operator|++
control|)
name|cl
index|[
name|cnt
index|]
operator|+=
operator|(
name|u_int32_t
operator|)
name|run
index|[
name|off
operator|++
index|]
operator|<<
operator|(
name|i
operator|<<
literal|3
operator|)
expr_stmt|;
name|sz
operator|>>=
literal|4
expr_stmt|;
if|if
condition|(
name|run
index|[
name|off
operator|+
name|sz
operator|-
literal|1
index|]
operator|&
literal|0x80
condition|)
block|{
name|tmp
operator|=
operator|(
operator|(
name|u_int64_t
operator|)
operator|-
literal|1
operator|)
operator|<<
operator|(
name|sz
operator|<<
literal|3
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sz
condition|;
name|i
operator|++
control|)
name|tmp
operator||=
operator|(
name|u_int64_t
operator|)
name|run
index|[
name|off
operator|++
index|]
operator|<<
operator|(
name|i
operator|<<
literal|3
operator|)
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sz
condition|;
name|i
operator|++
control|)
name|tmp
operator||=
operator|(
name|u_int64_t
operator|)
name|run
index|[
name|off
operator|++
index|]
operator|<<
operator|(
name|i
operator|<<
literal|3
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|tmp
condition|)
name|prev
operator|=
name|cn
index|[
name|cnt
index|]
operator|=
name|prev
operator|+
name|tmp
expr_stmt|;
else|else
name|cn
index|[
name|cnt
index|]
operator|=
name|tmp
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
block|}
operator|*
name|rcnp
operator|=
name|cn
expr_stmt|;
operator|*
name|rclp
operator|=
name|cl
expr_stmt|;
operator|*
name|rcntp
operator|=
name|cnt
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Convert wchar to uppercase wchar, should be macros?  */
end_comment

begin_function
name|wchar
name|ntfs_toupper
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|wchar
name|wc
parameter_list|)
block|{
return|return
operator|(
name|ntmp
operator|->
name|ntm_upcase
index|[
name|wc
operator|&
literal|0xFF
index|]
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Compare to unicode strings case insensible.  */
end_comment

begin_function
name|int
name|ntfs_uustricmp
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|wchar
modifier|*
name|str1
parameter_list|,
name|int
name|str1len
parameter_list|,
name|wchar
modifier|*
name|str2
parameter_list|,
name|int
name|str2len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|res
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|str1len
operator|&&
name|i
operator|<
name|str2len
condition|;
name|i
operator|++
control|)
block|{
name|res
operator|=
operator|(
name|int
operator|)
name|ntfs_toupper
argument_list|(
name|ntmp
argument_list|,
name|str1
index|[
name|i
index|]
argument_list|)
operator|-
operator|(
name|int
operator|)
name|ntfs_toupper
argument_list|(
name|ntmp
argument_list|,
name|str2
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
return|return
name|res
return|;
block|}
return|return
operator|(
name|str1len
operator|-
name|str2len
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Compare unicode and ascii string case insens.  */
end_comment

begin_function
name|int
name|ntfs_uastricmp
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
specifier|const
name|wchar
modifier|*
name|str1
parameter_list|,
name|int
name|str1len
parameter_list|,
specifier|const
name|char
modifier|*
name|str2
parameter_list|,
name|int
name|str2len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|res
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|str1len
operator|&&
name|i
operator|<
name|str2len
condition|;
name|i
operator|++
control|)
block|{
name|res
operator|=
operator|(
name|int
operator|)
name|ntfs_toupper
argument_list|(
name|ntmp
argument_list|,
name|str1
index|[
name|i
index|]
argument_list|)
operator|-
operator|(
name|int
operator|)
name|ntfs_toupper
argument_list|(
name|ntmp
argument_list|,
operator|(
name|wchar
operator|)
name|str2
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
return|return
name|res
return|;
block|}
return|return
operator|(
name|str1len
operator|-
name|str2len
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Compare unicode and ascii string case sens.  */
end_comment

begin_function
name|int
name|ntfs_uastrcmp
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
specifier|const
name|wchar
modifier|*
name|str1
parameter_list|,
name|int
name|str1len
parameter_list|,
specifier|const
name|char
modifier|*
name|str2
parameter_list|,
name|int
name|str2len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|res
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|i
operator|<
name|str1len
operator|)
operator|&&
operator|(
name|i
operator|<
name|str2len
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|res
operator|=
operator|(
operator|(
name|int
operator|)
name|str1
index|[
name|i
index|]
operator|)
operator|-
operator|(
operator|(
name|int
operator|)
name|str2
index|[
name|i
index|]
operator|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
return|return
name|res
return|;
block|}
return|return
operator|(
name|str1len
operator|-
name|str2len
operator|)
return|;
block|}
end_function

begin_comment
comment|/*   * Search fnode in ntnode, if not found allocate and preinitialize.  *  * ntnode should be locked on entry.  */
end_comment

begin_function
name|int
name|ntfs_fget
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|struct
name|ntnode
modifier|*
name|ip
parameter_list|,
name|int
name|attrtype
parameter_list|,
name|char
modifier|*
name|attrname
parameter_list|,
name|struct
name|fnode
modifier|*
modifier|*
name|fpp
parameter_list|)
block|{
name|struct
name|fnode
modifier|*
name|fp
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_fget: ino: %d, attrtype: 0x%x, attrname: %s\n"
operator|,
name|ip
operator|->
name|i_number
operator|,
name|attrtype
operator|,
name|attrname
condition|?
name|attrname
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
operator|*
name|fpp
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|fp
operator|=
name|ip
operator|->
name|i_fnlist
operator|.
name|lh_first
init|;
name|fp
operator|!=
name|NULL
condition|;
name|fp
operator|=
name|fp
operator|->
name|f_fnlist
operator|.
name|le_next
control|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_fget: fnode: attrtype: %d, attrname: %s\n"
operator|,
name|fp
operator|->
name|f_attrtype
operator|,
name|fp
operator|->
name|f_attrname
condition|?
name|fp
operator|->
name|f_attrname
else|:
literal|""
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|attrtype
operator|==
name|fp
operator|->
name|f_attrtype
operator|)
operator|&&
operator|(
operator|(
operator|!
name|attrname
operator|&&
operator|!
name|fp
operator|->
name|f_attrname
operator|)
operator|||
operator|(
name|attrname
operator|&&
name|fp
operator|->
name|f_attrname
operator|&&
operator|!
name|strcmp
argument_list|(
name|attrname
argument_list|,
name|fp
operator|->
name|f_attrname
argument_list|)
operator|)
operator|)
condition|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_fget: found existed: %p\n"
operator|,
name|fp
operator|)
argument_list|)
expr_stmt|;
operator|*
name|fpp
operator|=
name|fp
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|*
name|fpp
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|MALLOC
argument_list|(
name|fp
argument_list|,
expr|struct
name|fnode
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|fnode
argument_list|)
argument_list|,
name|M_NTFSFNODE
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|fp
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|fnode
argument_list|)
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_fget: allocating fnode: %p\n"
operator|,
name|fp
operator|)
argument_list|)
expr_stmt|;
name|fp
operator|->
name|f_devvp
operator|=
name|ntmp
operator|->
name|ntm_devvp
expr_stmt|;
name|fp
operator|->
name|f_dev
operator|=
name|ntmp
operator|->
name|ntm_dev
expr_stmt|;
name|fp
operator|->
name|f_mp
operator|=
name|ntmp
expr_stmt|;
name|fp
operator|->
name|f_ip
operator|=
name|ip
expr_stmt|;
name|fp
operator|->
name|f_attrname
operator|=
name|attrname
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|f_attrname
condition|)
name|fp
operator|->
name|f_flag
operator||=
name|FN_AATTRNAME
expr_stmt|;
name|fp
operator|->
name|f_attrtype
operator|=
name|attrtype
expr_stmt|;
name|ntfs_ntref
argument_list|(
name|ip
argument_list|)
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|ip
operator|->
name|i_fnlist
argument_list|,
name|fp
argument_list|,
name|f_fnlist
argument_list|)
expr_stmt|;
operator|*
name|fpp
operator|=
name|fp
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Deallocate fnode, remove it from ntnode's fnode list.  *  * ntnode should be locked.  */
end_comment

begin_function
name|void
name|ntfs_frele
parameter_list|(
name|struct
name|fnode
modifier|*
name|fp
parameter_list|)
block|{
name|struct
name|ntnode
modifier|*
name|ip
init|=
name|FTONT
argument_list|(
name|fp
argument_list|)
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_frele: fnode: %p for %d: %p\n"
operator|,
name|fp
operator|,
name|ip
operator|->
name|i_number
operator|,
name|ip
operator|)
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_frele: deallocating fnode\n"
operator|)
argument_list|)
expr_stmt|;
name|LIST_REMOVE
argument_list|(
name|fp
argument_list|,
name|f_fnlist
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|f_flag
operator|&
name|FN_AATTRNAME
condition|)
name|FREE
argument_list|(
name|fp
operator|->
name|f_attrname
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|f_dirblbuf
condition|)
name|FREE
argument_list|(
name|fp
operator|->
name|f_dirblbuf
argument_list|,
name|M_NTFSDIR
argument_list|)
expr_stmt|;
name|FREE
argument_list|(
name|fp
argument_list|,
name|M_NTFSFNODE
argument_list|)
expr_stmt|;
name|ntfs_ntrele
argument_list|(
name|ip
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Lookup attribute name in format: [[:$ATTR_TYPE]:$ATTR_NAME],   * $ATTR_TYPE is searched in attrdefs read from $AttrDefs.  * If $ATTR_TYPE nott specifed, ATTR_A_DATA assumed.  */
end_comment

begin_function
name|int
name|ntfs_ntlookupattr
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|namelen
parameter_list|,
name|int
modifier|*
name|attrtype
parameter_list|,
name|char
modifier|*
modifier|*
name|attrname
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|sys
decl_stmt|;
name|size_t
name|syslen
decl_stmt|,
name|i
decl_stmt|;
name|struct
name|ntvattrdef
modifier|*
name|adp
decl_stmt|;
if|if
condition|(
name|namelen
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|name
index|[
literal|0
index|]
operator|==
literal|'$'
condition|)
block|{
name|sys
operator|=
name|name
expr_stmt|;
for|for
control|(
name|syslen
operator|=
literal|0
init|;
name|syslen
operator|<
name|namelen
condition|;
name|syslen
operator|++
control|)
block|{
if|if
condition|(
name|sys
index|[
name|syslen
index|]
operator|==
literal|':'
condition|)
block|{
name|name
operator|++
expr_stmt|;
name|namelen
operator|--
expr_stmt|;
break|break;
block|}
block|}
name|name
operator|+=
name|syslen
expr_stmt|;
name|namelen
operator|-=
name|syslen
expr_stmt|;
name|adp
operator|=
name|ntmp
operator|->
name|ntm_ad
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ntmp
operator|->
name|ntm_adnum
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|syslen
operator|==
name|adp
operator|->
name|ad_namelen
operator|)
operator|&&
operator|(
operator|!
name|strncmp
argument_list|(
name|sys
argument_list|,
name|adp
operator|->
name|ad_name
argument_list|,
name|syslen
argument_list|)
operator|)
condition|)
block|{
operator|*
name|attrtype
operator|=
name|adp
operator|->
name|ad_type
expr_stmt|;
if|if
condition|(
name|namelen
condition|)
block|{
name|MALLOC
argument_list|(
operator|(
operator|*
name|attrname
operator|)
argument_list|,
name|char
operator|*
argument_list|,
name|namelen
argument_list|,
name|M_TEMP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
operator|*
name|attrname
operator|)
argument_list|,
name|name
argument_list|,
name|namelen
argument_list|)
expr_stmt|;
operator|(
operator|*
name|attrname
operator|)
index|[
name|namelen
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|adp
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
if|if
condition|(
name|namelen
condition|)
block|{
name|MALLOC
argument_list|(
operator|(
operator|*
name|attrname
operator|)
argument_list|,
name|char
operator|*
argument_list|,
name|namelen
argument_list|,
name|M_TEMP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
operator|*
name|attrname
operator|)
argument_list|,
name|name
argument_list|,
name|namelen
argument_list|)
expr_stmt|;
operator|(
operator|*
name|attrname
operator|)
index|[
name|namelen
index|]
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|attrtype
operator|=
name|NTFS_A_DATA
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Lookup specifed node for filename, matching cnp,  * return fnode filled.  */
end_comment

begin_function
name|int
name|ntfs_ntlookupfile
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|componentname
modifier|*
name|cnp
parameter_list|,
name|struct
name|vnode
modifier|*
modifier|*
name|vpp
parameter_list|)
block|{
name|struct
name|fnode
modifier|*
name|fp
init|=
name|VTOF
argument_list|(
name|vp
argument_list|)
decl_stmt|;
name|struct
name|ntnode
modifier|*
name|ip
init|=
name|FTONT
argument_list|(
name|fp
argument_list|)
decl_stmt|;
name|struct
name|ntvattr
modifier|*
name|vap
decl_stmt|;
comment|/* Root attribute */
name|cn_t
name|cn
decl_stmt|;
comment|/* VCN in current attribute */
name|caddr_t
name|rdbuf
decl_stmt|;
comment|/* Buffer to read directory's blocks  */
name|u_int32_t
name|blsize
decl_stmt|;
name|u_int32_t
name|rdsize
decl_stmt|;
comment|/* Length of data to read from current block */
name|struct
name|attr_indexentry
modifier|*
name|iep
decl_stmt|;
name|int
name|error
decl_stmt|,
name|res
decl_stmt|,
name|anamelen
decl_stmt|,
name|fnamelen
decl_stmt|;
specifier|const
name|char
modifier|*
name|fname
decl_stmt|,
modifier|*
name|aname
decl_stmt|;
name|u_int32_t
name|aoff
decl_stmt|;
name|error
operator|=
name|ntfs_ntget
argument_list|(
name|ip
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|ntfs_ntvattrget
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|NTFS_A_INDXROOT
argument_list|,
literal|"$I30"
argument_list|,
literal|0
argument_list|,
operator|&
name|vap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
operator|(
name|vap
operator|->
name|va_flag
operator|&
name|NTFS_AF_INRUN
operator|)
condition|)
return|return
operator|(
name|ENOTDIR
operator|)
return|;
name|blsize
operator|=
name|vap
operator|->
name|va_a_iroot
operator|->
name|ir_size
expr_stmt|;
name|rdsize
operator|=
name|vap
operator|->
name|va_datalen
expr_stmt|;
comment|/* 	 * Divide file name into: foofilefoofilefoofile[:attrspec] 	 * Store like this:       fname:fnamelen       [aname:anamelen] 	 */
name|fname
operator|=
name|cnp
operator|->
name|cn_nameptr
expr_stmt|;
name|aname
operator|=
name|NULL
expr_stmt|;
name|anamelen
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|fnamelen
operator|=
literal|0
init|;
name|fnamelen
operator|<
name|cnp
operator|->
name|cn_namelen
condition|;
name|fnamelen
operator|++
control|)
if|if
condition|(
name|fname
index|[
name|fnamelen
index|]
operator|==
literal|':'
condition|)
block|{
name|aname
operator|=
name|fname
operator|+
name|fnamelen
operator|+
literal|1
expr_stmt|;
name|anamelen
operator|=
name|cnp
operator|->
name|cn_namelen
operator|-
name|fnamelen
operator|-
literal|1
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntlookupfile: %s (%d), attr: %s (%d)\n"
operator|,
name|fname
operator|,
name|fnamelen
operator|,
name|aname
operator|,
name|anamelen
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntlookupfile: blksz: %d, rdsz: %d\n"
operator|,
name|blsize
operator|,
name|rdsize
operator|)
argument_list|)
expr_stmt|;
name|MALLOC
argument_list|(
name|rdbuf
argument_list|,
name|caddr_t
argument_list|,
name|blsize
argument_list|,
name|M_TEMP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|error
operator|=
name|ntfs_readattr
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|NTFS_A_INDXROOT
argument_list|,
literal|"$I30"
argument_list|,
literal|0
argument_list|,
name|rdsize
argument_list|,
name|rdbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|aoff
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|attr_indexroot
argument_list|)
expr_stmt|;
do|do
block|{
name|iep
operator|=
operator|(
expr|struct
name|attr_indexentry
operator|*
operator|)
operator|(
name|rdbuf
operator|+
name|aoff
operator|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|iep
operator|->
name|ie_flag
operator|&
name|NTFS_IEFLAG_LAST
operator|)
operator|&&
operator|(
name|rdsize
operator|>
name|aoff
operator|)
condition|)
block|{
name|ddprintf
argument_list|(
operator|(
literal|"scan: %d, %d\n"
operator|,
operator|(
name|u_int32_t
operator|)
name|iep
operator|->
name|ie_number
operator|,
operator|(
name|u_int32_t
operator|)
name|iep
operator|->
name|ie_fnametype
operator|)
argument_list|)
expr_stmt|;
name|res
operator|=
name|ntfs_uastricmp
argument_list|(
name|ntmp
argument_list|,
name|iep
operator|->
name|ie_fname
argument_list|,
name|iep
operator|->
name|ie_fnamelen
argument_list|,
name|fname
argument_list|,
name|fnamelen
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
block|{
comment|/* Matched something (case ins.) */
if|if
condition|(
name|iep
operator|->
name|ie_fnametype
operator|==
literal|0
operator|||
operator|!
operator|(
name|ntmp
operator|->
name|ntm_flag
operator|&
name|NTFS_MFLAG_CASEINS
operator|)
condition|)
name|res
operator|=
name|ntfs_uastrcmp
argument_list|(
name|ntmp
argument_list|,
name|iep
operator|->
name|ie_fname
argument_list|,
name|iep
operator|->
name|ie_fnamelen
argument_list|,
name|fname
argument_list|,
name|fnamelen
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
block|{
name|int
name|attrtype
init|=
name|NTFS_A_DATA
decl_stmt|;
name|char
modifier|*
name|attrname
init|=
name|NULL
decl_stmt|;
name|struct
name|fnode
modifier|*
name|nfp
decl_stmt|;
name|struct
name|vnode
modifier|*
name|nvp
decl_stmt|;
if|if
condition|(
name|aname
condition|)
block|{
name|error
operator|=
name|ntfs_ntlookupattr
argument_list|(
name|ntmp
argument_list|,
name|aname
argument_list|,
name|anamelen
argument_list|,
operator|&
name|attrtype
argument_list|,
operator|&
name|attrname
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
block|}
comment|/* Check if we've found ourself */
if|if
condition|(
operator|(
name|iep
operator|->
name|ie_number
operator|==
name|ip
operator|->
name|i_number
operator|)
operator|&&
operator|(
name|attrtype
operator|==
name|fp
operator|->
name|f_attrtype
operator|)
operator|&&
operator|(
operator|(
operator|!
name|attrname
operator|&&
operator|!
name|fp
operator|->
name|f_attrname
operator|)
operator|||
operator|(
name|attrname
operator|&&
name|fp
operator|->
name|f_attrname
operator|&&
operator|!
name|strcmp
argument_list|(
name|attrname
argument_list|,
name|fp
operator|->
name|f_attrname
argument_list|)
operator|)
operator|)
condition|)
block|{
name|VREF
argument_list|(
name|vp
argument_list|)
expr_stmt|;
operator|*
name|vpp
operator|=
name|vp
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* vget node, but don't load it */
name|error
operator|=
name|ntfs_vgetex
argument_list|(
name|ntmp
operator|->
name|ntm_mountp
argument_list|,
name|iep
operator|->
name|ie_number
argument_list|,
name|attrtype
argument_list|,
name|attrname
argument_list|,
name|LK_EXCLUSIVE
argument_list|,
name|VG_DONTLOADIN
operator||
name|VG_DONTVALIDFN
argument_list|,
name|curproc
argument_list|,
operator|&
name|nvp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|nfp
operator|=
name|VTOF
argument_list|(
name|nvp
argument_list|)
expr_stmt|;
if|if
condition|(
name|nfp
operator|->
name|f_flag
operator|&
name|FN_VALID
condition|)
block|{
operator|*
name|vpp
operator|=
name|nvp
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|nfp
operator|->
name|f_fflag
operator|=
name|iep
operator|->
name|ie_fflag
expr_stmt|;
name|nfp
operator|->
name|f_pnumber
operator|=
name|iep
operator|->
name|ie_fpnumber
expr_stmt|;
name|nfp
operator|->
name|f_times
operator|=
name|iep
operator|->
name|ie_ftimes
expr_stmt|;
if|if
condition|(
operator|(
name|nfp
operator|->
name|f_fflag
operator|&
name|NTFS_FFLAG_DIR
operator|)
operator|&&
operator|(
name|nfp
operator|->
name|f_attrtype
operator|==
name|NTFS_A_DATA
operator|)
operator|&&
operator|(
name|nfp
operator|->
name|f_attrname
operator|==
name|NULL
operator|)
condition|)
name|nfp
operator|->
name|f_type
operator|=
name|VDIR
expr_stmt|;
else|else
name|nfp
operator|->
name|f_type
operator|=
name|VREG
expr_stmt|;
name|nvp
operator|->
name|v_type
operator|=
name|nfp
operator|->
name|f_type
expr_stmt|;
if|if
condition|(
operator|(
name|nfp
operator|->
name|f_attrtype
operator|==
name|NTFS_A_DATA
operator|)
operator|&&
operator|(
name|nfp
operator|->
name|f_attrname
operator|==
name|NULL
operator|)
condition|)
block|{
comment|/* Opening default attribute */
name|nfp
operator|->
name|f_size
operator|=
name|iep
operator|->
name|ie_fsize
expr_stmt|;
name|nfp
operator|->
name|f_allocated
operator|=
name|iep
operator|->
name|ie_fallocated
expr_stmt|;
name|nfp
operator|->
name|f_flag
operator||=
name|FN_PRELOADED
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|ntfs_filesize
argument_list|(
name|ntmp
argument_list|,
name|nfp
argument_list|,
operator|&
name|nfp
operator|->
name|f_size
argument_list|,
operator|&
name|nfp
operator|->
name|f_allocated
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|vput
argument_list|(
name|nvp
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
name|nfp
operator|->
name|f_flag
operator|&=
operator|~
name|FN_VALID
expr_stmt|;
operator|*
name|vpp
operator|=
name|nvp
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|res
operator|>
literal|0
condition|)
break|break;
name|aoff
operator|+=
name|iep
operator|->
name|reclen
expr_stmt|;
name|iep
operator|=
operator|(
expr|struct
name|attr_indexentry
operator|*
operator|)
operator|(
name|rdbuf
operator|+
name|aoff
operator|)
expr_stmt|;
block|}
comment|/* Dive if possible */
if|if
condition|(
name|iep
operator|->
name|ie_flag
operator|&
name|NTFS_IEFLAG_SUBNODE
condition|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntlookupfile: diving\n"
operator|)
argument_list|)
expr_stmt|;
name|cn
operator|=
operator|*
operator|(
name|cn_t
operator|*
operator|)
operator|(
name|rdbuf
operator|+
name|aoff
operator|+
name|iep
operator|->
name|reclen
operator|-
sizeof|sizeof
argument_list|(
name|cn_t
argument_list|)
operator|)
expr_stmt|;
name|rdsize
operator|=
name|blsize
expr_stmt|;
name|error
operator|=
name|ntfs_readattr
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|NTFS_A_INDX
argument_list|,
literal|"$I30"
argument_list|,
name|ntfs_cntob
argument_list|(
name|cn
argument_list|)
argument_list|,
name|rdsize
argument_list|,
name|rdbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|ntfs_procfixups
argument_list|(
name|ntmp
argument_list|,
name|NTFS_INDXMAGIC
argument_list|,
name|rdbuf
argument_list|,
name|rdsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|aoff
operator|=
operator|(
operator|(
operator|(
expr|struct
name|attr_indexalloc
operator|*
operator|)
name|rdbuf
operator|)
operator|->
name|ia_hdrsize
operator|+
literal|0x18
operator|)
expr_stmt|;
block|}
else|else
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntlookupfile: nowhere to dive :-(\n"
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOENT
expr_stmt|;
break|break;
block|}
block|}
do|while
condition|(
literal|1
condition|)
do|;
name|dprintf
argument_list|(
operator|(
literal|"finish\n"
operator|)
argument_list|)
expr_stmt|;
name|fail
label|:
name|ntfs_ntvattrrele
argument_list|(
name|vap
argument_list|)
expr_stmt|;
name|ntfs_ntput
argument_list|(
name|ip
argument_list|)
expr_stmt|;
name|FREE
argument_list|(
name|rdbuf
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Check if name type is permitted to show.  */
end_comment

begin_function
name|int
name|ntfs_isnamepermitted
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|struct
name|attr_indexentry
modifier|*
name|iep
parameter_list|)
block|{
if|if
condition|(
name|ntmp
operator|->
name|ntm_flag
operator|&
name|NTFS_MFLAG_ALLNAMES
condition|)
return|return
literal|1
return|;
switch|switch
condition|(
name|iep
operator|->
name|ie_fnametype
condition|)
block|{
case|case
literal|2
case|:
name|ddprintf
argument_list|(
operator|(
literal|"ntfs_isnamepermitted: skiped DOS name\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
literal|0
case|:
case|case
literal|1
case|:
case|case
literal|3
case|:
return|return
literal|1
return|;
default|default:
name|printf
argument_list|(
literal|"ntfs_isnamepermitted: "
expr|\
literal|"WARNING! Unknown file name type: %d\n"
argument_list|,
name|iep
operator|->
name|ie_fnametype
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Read ntfs dir like stream of attr_indexentry, not like btree of them.  * This is done by scaning $BITMAP:$I30 for busy clusters and reading them.  * Ofcouse $INDEX_ROOT:$I30 is read before. Last read values are stored in  * fnode, so we can skip toward record number num almost immediatly.  * Anyway this is rather slow routine. The problem is that we don't know  * how many records are there in $INDEX_ALLOCATION:$I30 block.  */
end_comment

begin_function
name|int
name|ntfs_ntreaddir
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|struct
name|fnode
modifier|*
name|fp
parameter_list|,
name|u_int32_t
name|num
parameter_list|,
name|struct
name|attr_indexentry
modifier|*
modifier|*
name|riepp
parameter_list|)
block|{
name|struct
name|ntnode
modifier|*
name|ip
init|=
name|FTONT
argument_list|(
name|fp
argument_list|)
decl_stmt|;
name|struct
name|ntvattr
modifier|*
name|vap
init|=
name|NULL
decl_stmt|;
comment|/* IndexRoot attribute */
name|struct
name|ntvattr
modifier|*
name|bmvap
init|=
name|NULL
decl_stmt|;
comment|/* BitMap attribute */
name|struct
name|ntvattr
modifier|*
name|iavap
init|=
name|NULL
decl_stmt|;
comment|/* IndexAllocation attribute */
name|caddr_t
name|rdbuf
decl_stmt|;
comment|/* Buffer to read directory's blocks  */
name|u_char
modifier|*
name|bmp
init|=
name|NULL
decl_stmt|;
comment|/* Bitmap */
name|u_int32_t
name|blsize
decl_stmt|;
comment|/* Index allocation size (2048) */
name|u_int32_t
name|rdsize
decl_stmt|;
comment|/* Length of data to read */
name|u_int32_t
name|attrnum
decl_stmt|;
comment|/* Current attribute type */
name|u_int32_t
name|cpbl
init|=
literal|1
decl_stmt|;
comment|/* Clusters per directory block */
name|u_int32_t
name|blnum
decl_stmt|;
name|struct
name|attr_indexentry
modifier|*
name|iep
decl_stmt|;
name|int
name|error
init|=
name|ENOENT
decl_stmt|;
name|u_int32_t
name|aoff
decl_stmt|,
name|cnum
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntreaddir: read ino: %d, num: %d\n"
operator|,
name|ip
operator|->
name|i_number
operator|,
name|num
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ntfs_ntget
argument_list|(
name|ip
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|ntfs_ntvattrget
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|NTFS_A_INDXROOT
argument_list|,
literal|"$I30"
argument_list|,
literal|0
argument_list|,
operator|&
name|vap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|ENOTDIR
operator|)
return|;
if|if
condition|(
name|fp
operator|->
name|f_dirblbuf
operator|==
name|NULL
condition|)
block|{
name|fp
operator|->
name|f_dirblsz
operator|=
name|vap
operator|->
name|va_a_iroot
operator|->
name|ir_size
expr_stmt|;
name|MALLOC
argument_list|(
name|fp
operator|->
name|f_dirblbuf
argument_list|,
name|caddr_t
argument_list|,
name|max
argument_list|(
name|vap
operator|->
name|va_datalen
argument_list|,
name|fp
operator|->
name|f_dirblsz
argument_list|)
argument_list|,
name|M_NTFSDIR
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
block|}
name|blsize
operator|=
name|fp
operator|->
name|f_dirblsz
expr_stmt|;
name|rdbuf
operator|=
name|fp
operator|->
name|f_dirblbuf
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntreaddir: rdbuf: 0x%p, blsize: %d\n"
operator|,
name|rdbuf
operator|,
name|blsize
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vap
operator|->
name|va_a_iroot
operator|->
name|ir_flag
operator|&
name|NTFS_IRFLAG_INDXALLOC
condition|)
block|{
name|error
operator|=
name|ntfs_ntvattrget
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|NTFS_A_INDXBITMAP
argument_list|,
literal|"$I30"
argument_list|,
literal|0
argument_list|,
operator|&
name|bmvap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|error
operator|=
name|ENOTDIR
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|MALLOC
argument_list|(
name|bmp
argument_list|,
name|u_char
operator|*
argument_list|,
name|bmvap
operator|->
name|va_datalen
argument_list|,
name|M_TEMP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|error
operator|=
name|ntfs_readattr
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|NTFS_A_INDXBITMAP
argument_list|,
literal|"$I30"
argument_list|,
literal|0
argument_list|,
name|bmvap
operator|->
name|va_datalen
argument_list|,
name|bmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|ntfs_ntvattrget
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|NTFS_A_INDX
argument_list|,
literal|"$I30"
argument_list|,
literal|0
argument_list|,
operator|&
name|iavap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|error
operator|=
name|ENOTDIR
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|cpbl
operator|=
name|ntfs_btocn
argument_list|(
name|blsize
operator|+
name|ntfs_cntob
argument_list|(
literal|1
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntreaddir: indexalloc: %d, cpbl: %d\n"
operator|,
name|iavap
operator|->
name|va_datalen
operator|,
name|cpbl
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntreadidir: w/o BitMap and IndexAllocation\n"
operator|)
argument_list|)
expr_stmt|;
name|iavap
operator|=
name|bmvap
operator|=
name|NULL
expr_stmt|;
name|bmp
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* Try use previous values */
if|if
condition|(
operator|(
name|fp
operator|->
name|f_lastdnum
operator|<
name|num
operator|)
operator|&&
operator|(
name|fp
operator|->
name|f_lastdnum
operator|!=
literal|0
operator|)
condition|)
block|{
name|attrnum
operator|=
name|fp
operator|->
name|f_lastdattr
expr_stmt|;
name|aoff
operator|=
name|fp
operator|->
name|f_lastdoff
expr_stmt|;
name|blnum
operator|=
name|fp
operator|->
name|f_lastdblnum
expr_stmt|;
name|cnum
operator|=
name|fp
operator|->
name|f_lastdnum
expr_stmt|;
block|}
else|else
block|{
name|attrnum
operator|=
name|NTFS_A_INDXROOT
expr_stmt|;
name|aoff
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|attr_indexroot
argument_list|)
expr_stmt|;
name|blnum
operator|=
literal|0
expr_stmt|;
name|cnum
operator|=
literal|0
expr_stmt|;
block|}
do|do
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntreaddir: scan: 0x%x, %d, %d, %d, %d\n"
operator|,
name|attrnum
operator|,
operator|(
name|u_int32_t
operator|)
name|blnum
operator|,
name|cnum
operator|,
name|num
operator|,
name|aoff
operator|)
argument_list|)
expr_stmt|;
name|rdsize
operator|=
operator|(
name|attrnum
operator|==
name|NTFS_A_INDXROOT
operator|)
condition|?
name|vap
operator|->
name|va_datalen
else|:
name|blsize
expr_stmt|;
name|error
operator|=
name|ntfs_readattr
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|attrnum
argument_list|,
literal|"$I30"
argument_list|,
name|ntfs_cntob
argument_list|(
name|blnum
operator|*
name|cpbl
argument_list|)
argument_list|,
name|rdsize
argument_list|,
name|rdbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|attrnum
operator|==
name|NTFS_A_INDX
condition|)
block|{
name|error
operator|=
name|ntfs_procfixups
argument_list|(
name|ntmp
argument_list|,
name|NTFS_INDXMAGIC
argument_list|,
name|rdbuf
argument_list|,
name|rdsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|aoff
operator|==
literal|0
condition|)
name|aoff
operator|=
operator|(
name|attrnum
operator|==
name|NTFS_A_INDX
operator|)
condition|?
operator|(
literal|0x18
operator|+
operator|(
operator|(
expr|struct
name|attr_indexalloc
operator|*
operator|)
name|rdbuf
operator|)
operator|->
name|ia_hdrsize
operator|)
else|:
sizeof|sizeof
argument_list|(
expr|struct
name|attr_indexroot
argument_list|)
expr_stmt|;
name|iep
operator|=
operator|(
expr|struct
name|attr_indexentry
operator|*
operator|)
operator|(
name|rdbuf
operator|+
name|aoff
operator|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|iep
operator|->
name|ie_flag
operator|&
name|NTFS_IEFLAG_LAST
operator|)
operator|&&
operator|(
name|rdsize
operator|>
name|aoff
operator|)
condition|)
block|{
if|if
condition|(
name|ntfs_isnamepermitted
argument_list|(
name|ntmp
argument_list|,
name|iep
argument_list|)
condition|)
block|{
if|if
condition|(
name|cnum
operator|>=
name|num
condition|)
block|{
name|fp
operator|->
name|f_lastdnum
operator|=
name|cnum
expr_stmt|;
name|fp
operator|->
name|f_lastdoff
operator|=
name|aoff
expr_stmt|;
name|fp
operator|->
name|f_lastdblnum
operator|=
name|blnum
expr_stmt|;
name|fp
operator|->
name|f_lastdattr
operator|=
name|attrnum
expr_stmt|;
operator|*
name|riepp
operator|=
name|iep
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|cnum
operator|++
expr_stmt|;
block|}
name|aoff
operator|+=
name|iep
operator|->
name|reclen
expr_stmt|;
name|iep
operator|=
operator|(
expr|struct
name|attr_indexentry
operator|*
operator|)
operator|(
name|rdbuf
operator|+
name|aoff
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|iavap
condition|)
block|{
if|if
condition|(
name|attrnum
operator|==
name|NTFS_A_INDXROOT
condition|)
name|blnum
operator|=
literal|0
expr_stmt|;
else|else
name|blnum
operator|++
expr_stmt|;
while|while
condition|(
name|ntfs_cntob
argument_list|(
name|blnum
operator|*
name|cpbl
argument_list|)
operator|<
name|iavap
operator|->
name|va_datalen
condition|)
block|{
if|if
condition|(
name|bmp
index|[
name|blnum
operator|>>
literal|3
index|]
operator|&
operator|(
literal|1
operator|<<
operator|(
name|blnum
operator|&
literal|3
operator|)
operator|)
condition|)
break|break;
name|blnum
operator|++
expr_stmt|;
block|}
name|attrnum
operator|=
name|NTFS_A_INDX
expr_stmt|;
name|aoff
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ntfs_cntob
argument_list|(
name|blnum
operator|*
name|cpbl
argument_list|)
operator|>=
name|iavap
operator|->
name|va_datalen
condition|)
break|break;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntreaddir: blnum: %d\n"
operator|,
operator|(
name|u_int32_t
operator|)
name|blnum
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
do|while
condition|(
name|iavap
condition|)
do|;
operator|*
name|riepp
operator|=
name|NULL
expr_stmt|;
name|fp
operator|->
name|f_lastdnum
operator|=
literal|0
expr_stmt|;
name|fail
label|:
if|if
condition|(
name|vap
condition|)
name|ntfs_ntvattrrele
argument_list|(
name|vap
argument_list|)
expr_stmt|;
if|if
condition|(
name|bmvap
condition|)
name|ntfs_ntvattrrele
argument_list|(
name|bmvap
argument_list|)
expr_stmt|;
if|if
condition|(
name|iavap
condition|)
name|ntfs_ntvattrrele
argument_list|(
name|iavap
argument_list|)
expr_stmt|;
if|if
condition|(
name|bmp
condition|)
name|FREE
argument_list|(
name|bmp
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
name|ntfs_ntput
argument_list|(
name|ip
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Convert NTFS times that are in 100 ns units and begins from  * 1601 Jan 1 into unix times.  */
end_comment

begin_function
name|struct
name|timespec
name|ntfs_nttimetounix
parameter_list|(
name|u_int64_t
name|nt
parameter_list|)
block|{
name|struct
name|timespec
name|t
decl_stmt|;
comment|/* WindowNT times are in 100 ns and from 1601 Jan 1 */
name|t
operator|.
name|tv_nsec
operator|=
operator|(
name|nt
operator|%
operator|(
literal|1000
operator|*
literal|1000
operator|*
literal|10
operator|)
operator|)
operator|*
literal|100
expr_stmt|;
name|t
operator|.
name|tv_sec
operator|=
name|nt
operator|/
operator|(
literal|1000
operator|*
literal|1000
operator|*
literal|10
operator|)
operator|-
literal|369LL
operator|*
literal|365LL
operator|*
literal|24LL
operator|*
literal|60LL
operator|*
literal|60LL
operator|-
literal|89LL
operator|*
literal|1LL
operator|*
literal|24LL
operator|*
literal|60LL
operator|*
literal|60LL
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Get file times from NTFS_A_NAME attribute.  */
end_comment

begin_function
name|int
name|ntfs_times
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|struct
name|ntnode
modifier|*
name|ip
parameter_list|,
name|ntfs_times_t
modifier|*
name|tm
parameter_list|)
block|{
name|struct
name|ntvattr
modifier|*
name|vap
decl_stmt|;
name|int
name|error
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_times: ino: %d...\n"
operator|,
name|ip
operator|->
name|i_number
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ntfs_ntget
argument_list|(
name|ip
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|ntfs_ntvattrget
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|NTFS_A_NAME
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|&
name|vap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|ntfs_ntput
argument_list|(
name|ip
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
operator|*
name|tm
operator|=
name|vap
operator|->
name|va_a_name
operator|->
name|n_times
expr_stmt|;
name|ntfs_ntvattrrele
argument_list|(
name|vap
argument_list|)
expr_stmt|;
name|ntfs_ntput
argument_list|(
name|ip
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Get file sizes from corresponding attribute.   *   * ntnode under fnode should be locked.  */
end_comment

begin_function
name|int
name|ntfs_filesize
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|struct
name|fnode
modifier|*
name|fp
parameter_list|,
name|u_int64_t
modifier|*
name|size
parameter_list|,
name|u_int64_t
modifier|*
name|bytes
parameter_list|)
block|{
name|struct
name|ntvattr
modifier|*
name|vap
decl_stmt|;
name|struct
name|ntnode
modifier|*
name|ip
init|=
name|FTONT
argument_list|(
name|fp
argument_list|)
decl_stmt|;
name|u_int64_t
name|sz
decl_stmt|,
name|bn
decl_stmt|;
name|int
name|error
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_filesize: ino: %d\n"
operator|,
name|ip
operator|->
name|i_number
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ntfs_ntvattrget
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|fp
operator|->
name|f_attrtype
argument_list|,
name|fp
operator|->
name|f_attrname
argument_list|,
literal|0
argument_list|,
operator|&
name|vap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|bn
operator|=
name|vap
operator|->
name|va_allocated
expr_stmt|;
name|sz
operator|=
name|vap
operator|->
name|va_datalen
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_filesize: %d bytes (%d bytes allocated)\n"
operator|,
operator|(
name|u_int32_t
operator|)
name|sz
operator|,
operator|(
name|u_int32_t
operator|)
name|bn
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
condition|)
operator|*
name|size
operator|=
name|sz
expr_stmt|;
if|if
condition|(
name|bytes
condition|)
operator|*
name|bytes
operator|=
name|bn
expr_stmt|;
name|ntfs_ntvattrrele
argument_list|(
name|vap
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * This is one of write routine.  *  * ntnode should be locked.  */
end_comment

begin_function
name|int
name|ntfs_writeattr_plain
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|struct
name|ntnode
modifier|*
name|ip
parameter_list|,
name|u_int32_t
name|attrnum
parameter_list|,
name|char
modifier|*
name|attrname
parameter_list|,
name|off_t
name|roff
parameter_list|,
name|size_t
name|rsize
parameter_list|,
name|void
modifier|*
name|rdata
parameter_list|,
name|size_t
modifier|*
name|initp
parameter_list|)
block|{
name|size_t
name|init
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|off_t
name|off
init|=
name|roff
decl_stmt|,
name|left
init|=
name|rsize
decl_stmt|,
name|towrite
decl_stmt|;
name|caddr_t
name|data
init|=
name|rdata
decl_stmt|;
name|struct
name|ntvattr
modifier|*
name|vap
decl_stmt|;
operator|*
name|initp
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|left
condition|)
block|{
name|error
operator|=
name|ntfs_ntvattrget
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|attrnum
argument_list|,
name|attrname
argument_list|,
name|ntfs_btocn
argument_list|(
name|off
argument_list|)
argument_list|,
operator|&
name|vap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|towrite
operator|=
name|min
argument_list|(
name|left
argument_list|,
name|ntfs_cntob
argument_list|(
name|vap
operator|->
name|va_vcnend
operator|+
literal|1
argument_list|)
operator|-
name|off
argument_list|)
expr_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|"ntfs_writeattr_plain: o: %d, s: %d (%d - %d)\n"
operator|,
operator|(
name|u_int32_t
operator|)
name|off
operator|,
operator|(
name|u_int32_t
operator|)
name|towrite
operator|,
operator|(
name|u_int32_t
operator|)
name|vap
operator|->
name|va_vcnstart
operator|,
operator|(
name|u_int32_t
operator|)
name|vap
operator|->
name|va_vcnend
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ntfs_writentvattr_plain
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|vap
argument_list|,
name|off
operator|-
name|ntfs_cntob
argument_list|(
name|vap
operator|->
name|va_vcnstart
argument_list|)
argument_list|,
name|towrite
argument_list|,
name|data
argument_list|,
operator|&
name|init
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_writeattr_plain: "
expr|\
literal|"ntfs_writentvattr_plain failed: o: %d, s: %d\n"
argument_list|,
operator|(
name|u_int32_t
operator|)
name|off
argument_list|,
operator|(
name|u_int32_t
operator|)
name|towrite
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ntfs_writeattr_plain: attrib: %d - %d\n"
argument_list|,
operator|(
name|u_int32_t
operator|)
name|vap
operator|->
name|va_vcnstart
argument_list|,
operator|(
name|u_int32_t
operator|)
name|vap
operator|->
name|va_vcnend
argument_list|)
expr_stmt|;
name|ntfs_ntvattrrele
argument_list|(
name|vap
argument_list|)
expr_stmt|;
break|break;
block|}
name|ntfs_ntvattrrele
argument_list|(
name|vap
argument_list|)
expr_stmt|;
name|left
operator|-=
name|towrite
expr_stmt|;
name|off
operator|+=
name|towrite
expr_stmt|;
name|data
operator|=
name|data
operator|+
name|towrite
expr_stmt|;
operator|*
name|initp
operator|+=
name|init
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * This is one of write routine.  *  * ntnode should be locked.  */
end_comment

begin_function
name|int
name|ntfs_writentvattr_plain
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|struct
name|ntnode
modifier|*
name|ip
parameter_list|,
name|struct
name|ntvattr
modifier|*
name|vap
parameter_list|,
name|off_t
name|roff
parameter_list|,
name|size_t
name|rsize
parameter_list|,
name|void
modifier|*
name|rdata
parameter_list|,
name|size_t
modifier|*
name|initp
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
name|int
name|off
decl_stmt|;
operator|*
name|initp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|vap
operator|->
name|va_flag
operator|&
name|NTFS_AF_INRUN
condition|)
block|{
name|int
name|cnt
decl_stmt|;
name|cn_t
name|ccn
decl_stmt|,
name|ccl
decl_stmt|,
name|cn
decl_stmt|,
name|left
decl_stmt|,
name|cl
decl_stmt|;
name|caddr_t
name|data
init|=
name|rdata
decl_stmt|;
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|size_t
name|tocopy
decl_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|"ntfs_writentvattr_plain: data in run: %d chains\n"
operator|,
name|vap
operator|->
name|va_vruncnt
operator|)
argument_list|)
expr_stmt|;
name|off
operator|=
name|roff
expr_stmt|;
name|left
operator|=
name|rsize
expr_stmt|;
name|ccl
operator|=
literal|0
expr_stmt|;
name|ccn
operator|=
literal|0
expr_stmt|;
name|cnt
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|left
operator|&&
operator|(
name|cnt
operator|<
name|vap
operator|->
name|va_vruncnt
operator|)
condition|)
block|{
name|ccn
operator|=
name|vap
operator|->
name|va_vruncn
index|[
name|cnt
index|]
expr_stmt|;
name|ccl
operator|=
name|vap
operator|->
name|va_vruncl
index|[
name|cnt
index|]
expr_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|"ntfs_writentvattr_plain: "
expr|\
literal|"left %d, cn: 0x%x, cl: %d, off: %d\n"
operator|,
expr|\
operator|(
name|u_int32_t
operator|)
name|left
operator|,
operator|(
name|u_int32_t
operator|)
name|ccn
operator|,
expr|\
operator|(
name|u_int32_t
operator|)
name|ccl
operator|,
operator|(
name|u_int32_t
operator|)
name|off
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntfs_cntob
argument_list|(
name|ccl
argument_list|)
operator|<
name|off
condition|)
block|{
name|off
operator|-=
name|ntfs_cntob
argument_list|(
name|ccl
argument_list|)
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|ccn
operator|||
name|ip
operator|->
name|i_number
operator|==
name|NTFS_BOOTINO
condition|)
block|{
comment|/* XXX */
name|ccl
operator|-=
name|ntfs_btocn
argument_list|(
name|off
argument_list|)
expr_stmt|;
name|cn
operator|=
name|ccn
operator|+
name|ntfs_btocn
argument_list|(
name|off
argument_list|)
expr_stmt|;
name|off
operator|=
name|ntfs_btocnoff
argument_list|(
name|off
argument_list|)
expr_stmt|;
while|while
condition|(
name|left
operator|&&
name|ccl
condition|)
block|{
name|tocopy
operator|=
name|min
argument_list|(
name|left
argument_list|,
name|min
argument_list|(
name|ntfs_cntob
argument_list|(
name|ccl
argument_list|)
operator|-
name|off
argument_list|,
name|MAXBSIZE
operator|-
name|off
argument_list|)
argument_list|)
expr_stmt|;
name|cl
operator|=
name|ntfs_btocl
argument_list|(
name|tocopy
operator|+
name|off
argument_list|)
expr_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|"ntfs_writentvattr_plain: "
expr|\
literal|"write: cn: 0x%x cl: %d, "
expr|\
literal|"off: %d len: %d, left: %d\n"
operator|,
operator|(
name|u_int32_t
operator|)
name|cn
operator|,
operator|(
name|u_int32_t
operator|)
name|cl
operator|,
operator|(
name|u_int32_t
operator|)
name|off
operator|,
operator|(
name|u_int32_t
operator|)
name|tocopy
operator|,
operator|(
name|u_int32_t
operator|)
name|left
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|off
operator|==
literal|0
operator|)
operator|&&
operator|(
name|tocopy
operator|==
name|ntfs_cntob
argument_list|(
name|cl
argument_list|)
operator|)
condition|)
block|{
name|bp
operator|=
name|getblk
argument_list|(
name|ntmp
operator|->
name|ntm_devvp
argument_list|,
name|ntfs_cntobn
argument_list|(
name|cn
argument_list|)
argument_list|,
name|ntfs_cntob
argument_list|(
name|cl
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|clrbuf
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|bread
argument_list|(
name|ntmp
operator|->
name|ntm_devvp
argument_list|,
name|ntfs_cntobn
argument_list|(
name|cn
argument_list|)
argument_list|,
name|ntfs_cntob
argument_list|(
name|cl
argument_list|)
argument_list|,
name|NOCRED
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
name|memcpy
argument_list|(
name|bp
operator|->
name|b_data
operator|+
name|off
argument_list|,
name|data
argument_list|,
name|tocopy
argument_list|)
expr_stmt|;
name|bawrite
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|data
operator|=
name|data
operator|+
name|tocopy
expr_stmt|;
operator|*
name|initp
operator|+=
name|tocopy
expr_stmt|;
name|off
operator|=
literal|0
expr_stmt|;
name|left
operator|-=
name|tocopy
expr_stmt|;
name|cn
operator|+=
name|cl
expr_stmt|;
name|ccl
operator|-=
name|cl
expr_stmt|;
block|}
block|}
name|cnt
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|left
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_writentvattr_plain: POSSIBLE RUN ERROR\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"ntfs_writevattr_plain: CAN'T WRITE RES. ATTRIBUTE\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOTTY
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * This is one of read routines.  *  * ntnode should be locked.  */
end_comment

begin_function
name|int
name|ntfs_readntvattr_plain
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|struct
name|ntnode
modifier|*
name|ip
parameter_list|,
name|struct
name|ntvattr
modifier|*
name|vap
parameter_list|,
name|off_t
name|roff
parameter_list|,
name|size_t
name|rsize
parameter_list|,
name|void
modifier|*
name|rdata
parameter_list|,
name|size_t
modifier|*
name|initp
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
name|int
name|off
decl_stmt|;
operator|*
name|initp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|vap
operator|->
name|va_flag
operator|&
name|NTFS_AF_INRUN
condition|)
block|{
name|int
name|cnt
decl_stmt|;
name|cn_t
name|ccn
decl_stmt|,
name|ccl
decl_stmt|,
name|cn
decl_stmt|,
name|left
decl_stmt|,
name|cl
decl_stmt|;
name|caddr_t
name|data
init|=
name|rdata
decl_stmt|;
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|size_t
name|tocopy
decl_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|"ntfs_readntvattr_plain: data in run: %d chains\n"
operator|,
name|vap
operator|->
name|va_vruncnt
operator|)
argument_list|)
expr_stmt|;
name|off
operator|=
name|roff
expr_stmt|;
name|left
operator|=
name|rsize
expr_stmt|;
name|ccl
operator|=
literal|0
expr_stmt|;
name|ccn
operator|=
literal|0
expr_stmt|;
name|cnt
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|left
operator|&&
operator|(
name|cnt
operator|<
name|vap
operator|->
name|va_vruncnt
operator|)
condition|)
block|{
name|ccn
operator|=
name|vap
operator|->
name|va_vruncn
index|[
name|cnt
index|]
expr_stmt|;
name|ccl
operator|=
name|vap
operator|->
name|va_vruncl
index|[
name|cnt
index|]
expr_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|"ntfs_readntvattr_plain: "
expr|\
literal|"left %d, cn: 0x%x, cl: %d, off: %d\n"
operator|,
expr|\
operator|(
name|u_int32_t
operator|)
name|left
operator|,
operator|(
name|u_int32_t
operator|)
name|ccn
operator|,
expr|\
operator|(
name|u_int32_t
operator|)
name|ccl
operator|,
operator|(
name|u_int32_t
operator|)
name|off
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntfs_cntob
argument_list|(
name|ccl
argument_list|)
operator|<
name|off
condition|)
block|{
name|off
operator|-=
name|ntfs_cntob
argument_list|(
name|ccl
argument_list|)
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|ccn
operator|||
name|ip
operator|->
name|i_number
operator|==
name|NTFS_BOOTINO
condition|)
block|{
name|ccl
operator|-=
name|ntfs_btocn
argument_list|(
name|off
argument_list|)
expr_stmt|;
name|cn
operator|=
name|ccn
operator|+
name|ntfs_btocn
argument_list|(
name|off
argument_list|)
expr_stmt|;
name|off
operator|=
name|ntfs_btocnoff
argument_list|(
name|off
argument_list|)
expr_stmt|;
while|while
condition|(
name|left
operator|&&
name|ccl
condition|)
block|{
name|tocopy
operator|=
name|min
argument_list|(
name|left
argument_list|,
name|min
argument_list|(
name|ntfs_cntob
argument_list|(
name|ccl
argument_list|)
operator|-
name|off
argument_list|,
name|MAXBSIZE
operator|-
name|off
argument_list|)
argument_list|)
expr_stmt|;
name|cl
operator|=
name|ntfs_btocl
argument_list|(
name|tocopy
operator|+
name|off
argument_list|)
expr_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|"ntfs_readntvattr_plain: "
expr|\
literal|"read: cn: 0x%x cl: %d, "
expr|\
literal|"off: %d len: %d, left: %d\n"
operator|,
operator|(
name|u_int32_t
operator|)
name|cn
operator|,
operator|(
name|u_int32_t
operator|)
name|cl
operator|,
operator|(
name|u_int32_t
operator|)
name|off
operator|,
operator|(
name|u_int32_t
operator|)
name|tocopy
operator|,
operator|(
name|u_int32_t
operator|)
name|left
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|bread
argument_list|(
name|ntmp
operator|->
name|ntm_devvp
argument_list|,
name|ntfs_cntobn
argument_list|(
name|cn
argument_list|)
argument_list|,
name|ntfs_cntob
argument_list|(
name|cl
argument_list|)
argument_list|,
name|NOCRED
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|memcpy
argument_list|(
name|data
argument_list|,
name|bp
operator|->
name|b_data
operator|+
name|off
argument_list|,
name|tocopy
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|data
operator|=
name|data
operator|+
name|tocopy
expr_stmt|;
operator|*
name|initp
operator|+=
name|tocopy
expr_stmt|;
name|off
operator|=
literal|0
expr_stmt|;
name|left
operator|-=
name|tocopy
expr_stmt|;
name|cn
operator|+=
name|cl
expr_stmt|;
name|ccl
operator|-=
name|cl
expr_stmt|;
block|}
block|}
else|else
block|{
name|tocopy
operator|=
name|min
argument_list|(
name|left
argument_list|,
name|ntfs_cntob
argument_list|(
name|ccl
argument_list|)
operator|-
name|off
argument_list|)
expr_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|"ntfs_readntvattr_plain: "
literal|"sparce: ccn: 0x%x ccl: %d, off: %d, "
expr|\
literal|" len: %d, left: %d\n"
operator|,
operator|(
name|u_int32_t
operator|)
name|ccn
operator|,
operator|(
name|u_int32_t
operator|)
name|ccl
operator|,
operator|(
name|u_int32_t
operator|)
name|off
operator|,
operator|(
name|u_int32_t
operator|)
name|tocopy
operator|,
operator|(
name|u_int32_t
operator|)
name|left
operator|)
argument_list|)
expr_stmt|;
name|left
operator|-=
name|tocopy
expr_stmt|;
name|off
operator|=
literal|0
expr_stmt|;
name|bzero
argument_list|(
name|data
argument_list|,
name|tocopy
argument_list|)
expr_stmt|;
name|data
operator|=
name|data
operator|+
name|tocopy
expr_stmt|;
block|}
name|cnt
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|left
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_readntvattr_plain: POSSIBLE RUN ERROR\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|E2BIG
expr_stmt|;
block|}
block|}
else|else
block|{
name|ddprintf
argument_list|(
operator|(
literal|"ntfs_readnvattr_plain: data is in mft record\n"
operator|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|rdata
argument_list|,
name|vap
operator|->
name|va_datap
operator|+
name|roff
argument_list|,
name|rsize
argument_list|)
expr_stmt|;
operator|*
name|initp
operator|+=
name|rsize
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * This is one of read routines.  *  * ntnode should be locked.  */
end_comment

begin_function
name|int
name|ntfs_readattr_plain
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|struct
name|ntnode
modifier|*
name|ip
parameter_list|,
name|u_int32_t
name|attrnum
parameter_list|,
name|char
modifier|*
name|attrname
parameter_list|,
name|off_t
name|roff
parameter_list|,
name|size_t
name|rsize
parameter_list|,
name|void
modifier|*
name|rdata
parameter_list|,
name|size_t
modifier|*
name|initp
parameter_list|)
block|{
name|size_t
name|init
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|off_t
name|off
init|=
name|roff
decl_stmt|,
name|left
init|=
name|rsize
decl_stmt|,
name|toread
decl_stmt|;
name|caddr_t
name|data
init|=
name|rdata
decl_stmt|;
name|struct
name|ntvattr
modifier|*
name|vap
decl_stmt|;
operator|*
name|initp
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|left
condition|)
block|{
name|error
operator|=
name|ntfs_ntvattrget
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|attrnum
argument_list|,
name|attrname
argument_list|,
name|ntfs_btocn
argument_list|(
name|off
argument_list|)
argument_list|,
operator|&
name|vap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|toread
operator|=
name|min
argument_list|(
name|left
argument_list|,
name|ntfs_cntob
argument_list|(
name|vap
operator|->
name|va_vcnend
operator|+
literal|1
argument_list|)
operator|-
name|off
argument_list|)
expr_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|"ntfs_readattr_plain: o: %d, s: %d (%d - %d)\n"
operator|,
operator|(
name|u_int32_t
operator|)
name|off
operator|,
operator|(
name|u_int32_t
operator|)
name|toread
operator|,
operator|(
name|u_int32_t
operator|)
name|vap
operator|->
name|va_vcnstart
operator|,
operator|(
name|u_int32_t
operator|)
name|vap
operator|->
name|va_vcnend
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ntfs_readntvattr_plain
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|vap
argument_list|,
name|off
operator|-
name|ntfs_cntob
argument_list|(
name|vap
operator|->
name|va_vcnstart
argument_list|)
argument_list|,
name|toread
argument_list|,
name|data
argument_list|,
operator|&
name|init
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_readattr_plain: "
expr|\
literal|"ntfs_readntvattr_plain failed: o: %d, s: %d\n"
argument_list|,
operator|(
name|u_int32_t
operator|)
name|off
argument_list|,
operator|(
name|u_int32_t
operator|)
name|toread
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ntfs_readattr_plain: attrib: %d - %d\n"
argument_list|,
operator|(
name|u_int32_t
operator|)
name|vap
operator|->
name|va_vcnstart
argument_list|,
operator|(
name|u_int32_t
operator|)
name|vap
operator|->
name|va_vcnend
argument_list|)
expr_stmt|;
name|ntfs_ntvattrrele
argument_list|(
name|vap
argument_list|)
expr_stmt|;
break|break;
block|}
name|ntfs_ntvattrrele
argument_list|(
name|vap
argument_list|)
expr_stmt|;
name|left
operator|-=
name|toread
expr_stmt|;
name|off
operator|+=
name|toread
expr_stmt|;
name|data
operator|=
name|data
operator|+
name|toread
expr_stmt|;
operator|*
name|initp
operator|+=
name|init
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * This is one of read routines.  *  * ntnode should be locked.  */
end_comment

begin_function
name|int
name|ntfs_readattr
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|struct
name|ntnode
modifier|*
name|ip
parameter_list|,
name|u_int32_t
name|attrnum
parameter_list|,
name|char
modifier|*
name|attrname
parameter_list|,
name|off_t
name|roff
parameter_list|,
name|size_t
name|rsize
parameter_list|,
name|void
modifier|*
name|rdata
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
name|struct
name|ntvattr
modifier|*
name|vap
decl_stmt|;
name|size_t
name|init
decl_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|"ntfs_readattr: reading %d: 0x%x, from %d size %d bytes\n"
operator|,
name|ip
operator|->
name|i_number
operator|,
name|attrnum
operator|,
operator|(
name|u_int32_t
operator|)
name|roff
operator|,
operator|(
name|u_int32_t
operator|)
name|rsize
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ntfs_ntvattrget
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|attrnum
argument_list|,
name|attrname
argument_list|,
literal|0
argument_list|,
operator|&
name|vap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
operator|(
name|roff
operator|>
name|vap
operator|->
name|va_datalen
operator|)
operator|||
operator|(
name|roff
operator|+
name|rsize
operator|>
name|vap
operator|->
name|va_datalen
operator|)
condition|)
block|{
name|ddprintf
argument_list|(
operator|(
literal|"ntfs_readattr: offset too big\n"
operator|)
argument_list|)
expr_stmt|;
name|ntfs_ntvattrrele
argument_list|(
name|vap
argument_list|)
expr_stmt|;
return|return
operator|(
name|E2BIG
operator|)
return|;
block|}
if|if
condition|(
name|vap
operator|->
name|va_compression
operator|&&
name|vap
operator|->
name|va_compressalg
condition|)
block|{
name|u_int8_t
modifier|*
name|cup
decl_stmt|;
name|u_int8_t
modifier|*
name|uup
decl_stmt|;
name|off_t
name|off
init|=
name|roff
decl_stmt|,
name|left
init|=
name|rsize
decl_stmt|,
name|tocopy
decl_stmt|;
name|caddr_t
name|data
init|=
name|rdata
decl_stmt|;
name|cn_t
name|cn
decl_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|"ntfs_ntreadattr: compression: %d\n"
operator|,
name|vap
operator|->
name|va_compressalg
operator|)
argument_list|)
expr_stmt|;
name|MALLOC
argument_list|(
name|cup
argument_list|,
name|u_int8_t
operator|*
argument_list|,
name|ntfs_cntob
argument_list|(
name|NTFS_COMPUNIT_CL
argument_list|)
argument_list|,
name|M_NTFSDECOMP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|MALLOC
argument_list|(
name|uup
argument_list|,
name|u_int8_t
operator|*
argument_list|,
name|ntfs_cntob
argument_list|(
name|NTFS_COMPUNIT_CL
argument_list|)
argument_list|,
name|M_NTFSDECOMP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|cn
operator|=
operator|(
name|ntfs_btocn
argument_list|(
name|roff
argument_list|)
operator|)
operator|&
operator|(
operator|~
operator|(
name|NTFS_COMPUNIT_CL
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
name|off
operator|=
name|roff
operator|-
name|ntfs_cntob
argument_list|(
name|cn
argument_list|)
expr_stmt|;
while|while
condition|(
name|left
condition|)
block|{
name|error
operator|=
name|ntfs_readattr_plain
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|attrnum
argument_list|,
name|attrname
argument_list|,
name|ntfs_cntob
argument_list|(
name|cn
argument_list|)
argument_list|,
name|ntfs_cntob
argument_list|(
name|NTFS_COMPUNIT_CL
argument_list|)
argument_list|,
name|cup
argument_list|,
operator|&
name|init
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|tocopy
operator|=
name|min
argument_list|(
name|left
argument_list|,
name|ntfs_cntob
argument_list|(
name|NTFS_COMPUNIT_CL
argument_list|)
operator|-
name|off
argument_list|)
expr_stmt|;
if|if
condition|(
name|init
operator|==
name|ntfs_cntob
argument_list|(
name|NTFS_COMPUNIT_CL
argument_list|)
condition|)
block|{
name|memcpy
argument_list|(
name|data
argument_list|,
name|cup
operator|+
name|off
argument_list|,
name|tocopy
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|init
operator|==
literal|0
condition|)
block|{
name|bzero
argument_list|(
name|data
argument_list|,
name|tocopy
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|ntfs_uncompunit
argument_list|(
name|ntmp
argument_list|,
name|uup
argument_list|,
name|cup
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|memcpy
argument_list|(
name|data
argument_list|,
name|uup
operator|+
name|off
argument_list|,
name|tocopy
argument_list|)
expr_stmt|;
block|}
name|left
operator|-=
name|tocopy
expr_stmt|;
name|data
operator|=
name|data
operator|+
name|tocopy
expr_stmt|;
name|off
operator|+=
name|tocopy
operator|-
name|ntfs_cntob
argument_list|(
name|NTFS_COMPUNIT_CL
argument_list|)
expr_stmt|;
name|cn
operator|+=
name|NTFS_COMPUNIT_CL
expr_stmt|;
block|}
name|FREE
argument_list|(
name|uup
argument_list|,
name|M_NTFSDECOMP
argument_list|)
expr_stmt|;
name|FREE
argument_list|(
name|cup
argument_list|,
name|M_NTFSDECOMP
argument_list|)
expr_stmt|;
block|}
else|else
name|error
operator|=
name|ntfs_readattr_plain
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|attrnum
argument_list|,
name|attrname
argument_list|,
name|roff
argument_list|,
name|rsize
argument_list|,
name|rdata
argument_list|,
operator|&
name|init
argument_list|)
expr_stmt|;
name|ntfs_ntvattrrele
argument_list|(
name|vap
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
name|UNUSED_CODE
end_if

begin_function
name|int
name|ntfs_parserun
parameter_list|(
name|cn_t
modifier|*
name|cn
parameter_list|,
name|cn_t
modifier|*
name|cl
parameter_list|,
name|u_int8_t
modifier|*
name|run
parameter_list|,
name|u_long
name|len
parameter_list|,
name|u_long
modifier|*
name|off
parameter_list|)
block|{
name|u_int8_t
name|sz
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|NULL
operator|==
name|run
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_parsetun: run == NULL\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|sz
operator|=
name|run
index|[
operator|(
operator|*
name|off
operator|)
operator|++
index|]
expr_stmt|;
if|if
condition|(
literal|0
operator|==
name|sz
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_parserun: trying to go out of run\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|E2BIG
operator|)
return|;
block|}
operator|*
name|cl
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|sz
operator|&
literal|0xF
operator|)
operator|>
literal|8
operator|||
operator|(
operator|*
name|off
operator|)
operator|+
operator|(
name|sz
operator|&
literal|0xF
operator|)
operator|>
name|len
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_parserun: "
expr|\
literal|"bad run: length too big: sz: 0x%02x (%ld< %ld + sz)\n"
argument_list|,
name|sz
argument_list|,
name|len
argument_list|,
operator|*
name|off
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|sz
operator|&
literal|0xF
operator|)
condition|;
name|i
operator|++
control|)
operator|*
name|cl
operator|+=
operator|(
name|u_int32_t
operator|)
name|run
index|[
operator|(
operator|*
name|off
operator|)
operator|++
index|]
operator|<<
operator|(
name|i
operator|<<
literal|3
operator|)
expr_stmt|;
name|sz
operator|>>=
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|sz
operator|&
literal|0xF
operator|)
operator|>
literal|8
operator|||
operator|(
operator|*
name|off
operator|)
operator|+
operator|(
name|sz
operator|&
literal|0xF
operator|)
operator|>
name|len
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_parserun: "
expr|\
literal|"bad run: length too big: sz: 0x%02x (%ld< %ld + sz)\n"
argument_list|,
name|sz
argument_list|,
name|len
argument_list|,
operator|*
name|off
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|sz
operator|&
literal|0xF
operator|)
condition|;
name|i
operator|++
control|)
operator|*
name|cn
operator|+=
operator|(
name|u_int32_t
operator|)
name|run
index|[
operator|(
operator|*
name|off
operator|)
operator|++
index|]
operator|<<
operator|(
name|i
operator|<<
literal|3
operator|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Process fixup routine on given buffer.  */
end_comment

begin_function
name|int
name|ntfs_procfixups
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|u_int32_t
name|magic
parameter_list|,
name|caddr_t
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|fixuphdr
modifier|*
name|fhp
init|=
operator|(
expr|struct
name|fixuphdr
operator|*
operator|)
name|buf
decl_stmt|;
name|int
name|i
decl_stmt|;
name|u_int16_t
name|fixup
decl_stmt|;
name|u_int16_t
modifier|*
name|fxp
decl_stmt|;
name|u_int16_t
modifier|*
name|cfxp
decl_stmt|;
if|if
condition|(
name|fhp
operator|->
name|fh_magic
operator|!=
name|magic
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_procfixups: magic doesn't match: %08x != %08x\n"
argument_list|,
name|fhp
operator|->
name|fh_magic
argument_list|,
name|magic
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|fhp
operator|->
name|fh_fnum
operator|-
literal|1
operator|)
operator|*
name|ntmp
operator|->
name|ntm_bps
operator|!=
name|len
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_procfixups: "
expr|\
literal|"bad fixups number: %d for %d bytes block\n"
argument_list|,
name|fhp
operator|->
name|fh_fnum
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|fhp
operator|->
name|fh_foff
operator|>=
name|ntmp
operator|->
name|ntm_spc
operator|*
name|ntmp
operator|->
name|ntm_mftrecsz
operator|*
name|ntmp
operator|->
name|ntm_bps
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_procfixups: invalid offset: %x"
argument_list|,
name|fhp
operator|->
name|fh_foff
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|fxp
operator|=
operator|(
name|u_int16_t
operator|*
operator|)
operator|(
name|buf
operator|+
name|fhp
operator|->
name|fh_foff
operator|)
expr_stmt|;
name|cfxp
operator|=
operator|(
name|u_int16_t
operator|*
operator|)
operator|(
name|buf
operator|+
name|ntmp
operator|->
name|ntm_bps
operator|-
literal|2
operator|)
expr_stmt|;
name|fixup
operator|=
operator|*
name|fxp
operator|++
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|fhp
operator|->
name|fh_fnum
condition|;
name|i
operator|++
operator|,
name|fxp
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|cfxp
operator|!=
name|fixup
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_procfixups: fixup %d doesn't match\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
operator|*
name|cfxp
operator|=
operator|*
name|fxp
expr_stmt|;
operator|(
operator|(
name|caddr_t
operator|)
name|cfxp
operator|)
operator|+=
name|ntmp
operator|->
name|ntm_bps
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
name|UNUSED_CODE
end_if

begin_function
name|int
name|ntfs_runtocn
parameter_list|(
name|cn_t
modifier|*
name|cn
parameter_list|,
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|u_int8_t
modifier|*
name|run
parameter_list|,
name|u_long
name|len
parameter_list|,
name|cn_t
name|vcn
parameter_list|)
block|{
name|cn_t
name|ccn
init|=
literal|0
decl_stmt|;
name|cn_t
name|ccl
init|=
literal|0
decl_stmt|;
name|u_long
name|off
init|=
literal|0
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
if|#
directive|if
name|NTFS_DEBUG
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"ntfs_runtocn: run: 0x%p, %ld bytes, vcn:%ld\n"
argument_list|,
name|run
argument_list|,
name|len
argument_list|,
operator|(
name|u_long
operator|)
name|vcn
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ntfs_runtocn: run: "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"0x%02x "
argument_list|,
name|run
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|NULL
operator|==
name|run
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_runtocn: run == NULL\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
do|do
block|{
if|if
condition|(
name|run
index|[
name|off
index|]
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_runtocn: vcn too big\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|E2BIG
operator|)
return|;
block|}
name|vcn
operator|-=
name|ccl
expr_stmt|;
name|error
operator|=
name|ntfs_parserun
argument_list|(
operator|&
name|ccn
argument_list|,
operator|&
name|ccl
argument_list|,
name|run
argument_list|,
name|len
argument_list|,
operator|&
name|off
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_runtocn: ntfs_parserun failed\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
do|while
condition|(
name|ccl
operator|<=
name|vcn
condition|)
do|;
operator|*
name|cn
operator|=
name|ccn
operator|+
name|vcn
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1998, 1999 Semen Ustimenko  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  *	$Id: ntfs_subr.c,v 1.9 1999/02/02 01:54:54 semen Exp $  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/namei.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/vnode.h>
end_include

begin_include
include|#
directive|include
file|<sys/mount.h>
end_include

begin_include
include|#
directive|include
file|<sys/buf.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<machine/clock.h>
end_include

begin_include
include|#
directive|include
file|<miscfs/specfs/specdev.h>
end_include

begin_comment
comment|/* #define NTFS_DEBUG 1 */
end_comment

begin_include
include|#
directive|include
file|<ntfs/ntfs.h>
end_include

begin_include
include|#
directive|include
file|<ntfs/ntfsmount.h>
end_include

begin_include
include|#
directive|include
file|<ntfs/ntfs_inode.h>
end_include

begin_include
include|#
directive|include
file|<ntfs/ntfs_subr.h>
end_include

begin_include
include|#
directive|include
file|<ntfs/ntfs_compr.h>
end_include

begin_if
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|300000
end_if

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_NTFSNTVATTR
argument_list|,
literal|"NTFS vattr"
argument_list|,
literal|"NTFS file attribute information"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_NTFSRDATA
argument_list|,
literal|"NTFS res data"
argument_list|,
literal|"NTFS resident data"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_NTFSRUN
argument_list|,
literal|"NTFS vrun"
argument_list|,
literal|"NTFS vrun storage"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_NTFSDECOMP
argument_list|,
literal|"NTFS decomp"
argument_list|,
literal|"NTFS decompression temporary"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|int
name|ntfs_ntvattrrele
parameter_list|(
name|struct
name|ntvattr
modifier|*
name|vap
parameter_list|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntvattrrele: ino: %d, type: 0x%x\n"
operator|,
name|vap
operator|->
name|va_ip
operator|->
name|i_number
operator|,
name|vap
operator|->
name|va_type
operator|)
argument_list|)
expr_stmt|;
name|vrele
argument_list|(
name|NTTOV
argument_list|(
name|vap
operator|->
name|va_ip
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ntfs_ntvattrget
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|struct
name|ntnode
modifier|*
name|ip
parameter_list|,
name|u_int32_t
name|type
parameter_list|,
name|char
modifier|*
name|name
parameter_list|,
name|cn_t
name|vcn
parameter_list|,
name|struct
name|ntvattr
modifier|*
modifier|*
name|vapp
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|struct
name|ntvattr
modifier|*
name|vap
decl_stmt|;
name|struct
name|ntvattr
modifier|*
name|lvap
init|=
name|NULL
decl_stmt|;
name|struct
name|attr_attrlist
modifier|*
name|aalp
decl_stmt|;
name|struct
name|attr_attrlist
modifier|*
name|nextaalp
decl_stmt|;
name|caddr_t
name|alpool
decl_stmt|;
name|int
name|len
decl_stmt|,
name|namelen
decl_stmt|;
operator|*
name|vapp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|name
condition|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntvattrget: "
expr|\
literal|"ino: %d, type: 0x%x, name: %s, vcn: %d\n"
operator|,
expr|\
name|ip
operator|->
name|i_number
operator|,
name|type
operator|,
name|name
operator|,
operator|(
name|u_int32_t
operator|)
name|vcn
operator|)
argument_list|)
expr_stmt|;
name|namelen
operator|=
name|strlen
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntvattrget: "
expr|\
literal|"ino: %d, type: 0x%x, vcn: %d\n"
operator|,
expr|\
name|ip
operator|->
name|i_number
operator|,
name|type
operator|,
operator|(
name|u_int32_t
operator|)
name|vcn
operator|)
argument_list|)
expr_stmt|;
name|name
operator|=
literal|""
expr_stmt|;
name|namelen
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ip
operator|->
name|i_flag
operator|&
name|IN_LOADED
operator|)
operator|==
literal|0
condition|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntvattrget: node not loaded, ino: %d\n"
operator|,
name|ip
operator|->
name|i_number
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ntfs_loadnode
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_ntvattrget: FAILED TO LOAD INO: %d\n"
argument_list|,
name|ip
operator|->
name|i_number
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
for|for
control|(
name|vap
operator|=
name|ip
operator|->
name|i_vattrp
init|;
name|vap
condition|;
name|vap
operator|=
name|vap
operator|->
name|va_nextp
control|)
block|{
name|ddprintf
argument_list|(
operator|(
literal|"type: 0x%x, vcn: %d - %d\n"
operator|,
expr|\
name|vap
operator|->
name|va_type
operator|,
operator|(
name|u_int32_t
operator|)
name|vap
operator|->
name|va_vcnstart
operator|,
expr|\
operator|(
name|u_int32_t
operator|)
name|vap
operator|->
name|va_vcnend
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|vap
operator|->
name|va_type
operator|==
name|type
operator|)
operator|&&
operator|(
name|vap
operator|->
name|va_vcnstart
operator|<=
name|vcn
operator|)
operator|&&
operator|(
name|vap
operator|->
name|va_vcnend
operator|>=
name|vcn
operator|)
operator|&&
operator|(
name|vap
operator|->
name|va_namelen
operator|==
name|namelen
operator|)
operator|&&
operator|(
operator|!
name|strncmp
argument_list|(
name|name
argument_list|,
name|vap
operator|->
name|va_name
argument_list|,
name|namelen
argument_list|)
operator|)
condition|)
block|{
operator|*
name|vapp
operator|=
name|vap
expr_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|300000
name|VREF
argument_list|(
name|NTTOV
argument_list|(
name|vap
operator|->
name|va_ip
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* 			 * In RELENG_2_2 vref can call vfs_object_create(...) 			 * who calls vgetattr, who calls ntfs_getattr, who 			 * calls ntfs_ntvattrget, who calls vref... :-( This 			 * hack is to avoid it.   XXX 			 */
name|NTTOV
argument_list|(
name|vap
operator|->
name|va_ip
argument_list|)
operator|->
name|v_usecount
operator|++
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|vap
operator|->
name|va_type
operator|==
name|NTFS_A_ATTRLIST
condition|)
name|lvap
operator|=
name|vap
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|lvap
condition|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntvattrget: UNEXISTED ATTRIBUTE: "
expr|\
literal|"ino: %d, type: 0x%x, name: %s, vcn: %d\n"
operator|,
expr|\
name|ip
operator|->
name|i_number
operator|,
name|type
operator|,
name|name
operator|,
operator|(
name|u_int32_t
operator|)
name|vcn
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
comment|/* Scan $ATTRIBUTE_LIST for requested attribute */
name|len
operator|=
name|lvap
operator|->
name|va_datalen
expr_stmt|;
name|MALLOC
argument_list|(
name|alpool
argument_list|,
name|caddr_t
argument_list|,
name|len
argument_list|,
name|M_TEMP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|error
operator|=
name|ntfs_breadntvattr_plain
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|lvap
argument_list|,
literal|0
argument_list|,
name|len
argument_list|,
name|alpool
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|out
goto|;
name|aalp
operator|=
operator|(
expr|struct
name|attr_attrlist
operator|*
operator|)
name|alpool
expr_stmt|;
name|nextaalp
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|len
operator|>
literal|0
condition|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntvattrget: "
expr|\
literal|"attrlist: ino: %d, attr: 0x%x, vcn: %d\n"
operator|,
expr|\
name|aalp
operator|->
name|al_inumber
operator|,
name|aalp
operator|->
name|al_type
operator|,
expr|\
operator|(
name|u_int32_t
operator|)
name|aalp
operator|->
name|al_vcnstart
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|aalp
operator|->
name|reclen
condition|)
block|{
name|nextaalp
operator|=
name|NTFS_NEXTREC
argument_list|(
name|aalp
argument_list|,
expr|struct
name|attr_attrlist
operator|*
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nextaalp
operator|=
name|NULL
expr_stmt|;
block|}
name|len
operator|-=
name|aalp
operator|->
name|reclen
expr_stmt|;
define|#
directive|define
name|AALPCMP
parameter_list|(
name|aalp
parameter_list|,
name|type
parameter_list|,
name|name
parameter_list|,
name|namelen
parameter_list|)
value|(				\   (aalp->al_type == type)&& (aalp->al_namelen == namelen)&&		\   !uastrcmp(aalp->al_name,aalp->al_namelen,name,namelen) )
if|if
condition|(
name|AALPCMP
argument_list|(
name|aalp
argument_list|,
name|type
argument_list|,
name|name
argument_list|,
name|namelen
argument_list|)
operator|&&
operator|(
operator|!
name|nextaalp
operator|||
operator|(
name|nextaalp
operator|->
name|al_vcnstart
operator|>
name|vcn
operator|)
operator|||
operator|!
name|AALPCMP
argument_list|(
name|nextaalp
argument_list|,
name|type
argument_list|,
name|name
argument_list|,
name|namelen
argument_list|)
operator|)
condition|)
block|{
name|struct
name|vnode
modifier|*
name|newvp
decl_stmt|;
name|struct
name|ntnode
modifier|*
name|newip
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntvattrget: attrbute in ino: %d\n"
operator|,
name|aalp
operator|->
name|al_inumber
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|VFS_VGET
argument_list|(
name|ntmp
operator|->
name|ntm_mountp
argument_list|,
name|aalp
operator|->
name|al_inumber
argument_list|,
operator|&
name|newvp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_ntvattrget: CAN'T VGET INO: %d\n"
argument_list|,
name|aalp
operator|->
name|al_inumber
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|newip
operator|=
name|VTONT
argument_list|(
name|newvp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|~
name|newip
operator|->
name|i_flag
operator|&
name|IN_LOADED
condition|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntvattrget: node not loaded,"
expr|\
literal|" ino: %d\n"
operator|,
name|newip
operator|->
name|i_number
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ntfs_loadnode
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_ntvattrget: CAN'T LOAD "
expr|\
literal|"INO: %d\n"
argument_list|,
name|newip
operator|->
name|i_number
argument_list|)
expr_stmt|;
name|vput
argument_list|(
name|newvp
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
for|for
control|(
name|vap
operator|=
name|newip
operator|->
name|i_vattrp
init|;
name|vap
condition|;
name|vap
operator|=
name|vap
operator|->
name|va_nextp
control|)
block|{
if|if
condition|(
operator|(
name|vap
operator|->
name|va_type
operator|==
name|type
operator|)
operator|&&
operator|(
name|vap
operator|->
name|va_vcnstart
operator|<=
name|vcn
operator|)
operator|&&
operator|(
name|vap
operator|->
name|va_vcnend
operator|>=
name|vcn
operator|)
operator|&&
operator|(
name|vap
operator|->
name|va_namelen
operator|==
name|namelen
operator|)
operator|&&
operator|(
operator|!
name|strncmp
argument_list|(
name|name
argument_list|,
name|vap
operator|->
name|va_name
argument_list|,
name|namelen
argument_list|)
operator|)
condition|)
block|{
operator|*
name|vapp
operator|=
name|vap
expr_stmt|;
if|#
directive|if
name|__FreeBSD_version
operator|>=
literal|300000
name|VREF
argument_list|(
name|NTTOV
argument_list|(
name|vap
operator|->
name|va_ip
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* See comment above */
name|NTTOV
argument_list|(
name|vap
operator|->
name|va_ip
argument_list|)
operator|->
name|v_usecount
operator|++
expr_stmt|;
endif|#
directive|endif
name|vput
argument_list|(
name|newvp
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|vap
operator|->
name|va_type
operator|==
name|NTFS_A_ATTRLIST
condition|)
name|lvap
operator|=
name|vap
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"ntfs_ntvattrget: ATTRLIST ERROR.\n"
argument_list|)
expr_stmt|;
name|vput
argument_list|(
name|newvp
argument_list|)
expr_stmt|;
break|break;
block|}
undef|#
directive|undef
name|AALPCMP
name|aalp
operator|=
name|nextaalp
expr_stmt|;
block|}
name|error
operator|=
name|ENOENT
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntvattrget: UNEXISTED ATTRIBUTE: "
expr|\
literal|"ino: %d, type: 0x%x, name: %s, vcn: %d\n"
operator|,
expr|\
name|ip
operator|->
name|i_number
operator|,
name|type
operator|,
name|name
operator|,
operator|(
name|u_int32_t
operator|)
name|vcn
operator|)
argument_list|)
expr_stmt|;
name|out
label|:
name|FREE
argument_list|(
name|alpool
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ntfs_loadnode
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|struct
name|ntnode
modifier|*
name|ip
parameter_list|)
block|{
name|struct
name|filerec
modifier|*
name|mfrp
decl_stmt|;
name|daddr_t
name|bn
decl_stmt|;
name|int
name|error
decl_stmt|,
name|off
decl_stmt|;
name|struct
name|attr
modifier|*
name|ap
decl_stmt|;
name|struct
name|ntvattr
modifier|*
modifier|*
name|vapp
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_loadnode: loading ino: %d\n"
operator|,
name|ip
operator|->
name|i_number
operator|)
argument_list|)
expr_stmt|;
name|MALLOC
argument_list|(
name|mfrp
argument_list|,
expr|struct
name|filerec
operator|*
argument_list|,
name|ntfs_bntob
argument_list|(
name|ntmp
operator|->
name|ntm_bpmftrec
argument_list|)
argument_list|,
name|M_TEMP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|i_number
operator|<
name|NTFS_SYSNODESNUM
condition|)
block|{
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_loadnode: read system node\n"
operator|)
argument_list|)
expr_stmt|;
name|bn
operator|=
name|ntfs_cntobn
argument_list|(
name|ntmp
operator|->
name|ntm_mftcn
argument_list|)
operator|+
name|ntmp
operator|->
name|ntm_bpmftrec
operator|*
name|ip
operator|->
name|i_number
expr_stmt|;
name|error
operator|=
name|bread
argument_list|(
name|ntmp
operator|->
name|ntm_devvp
argument_list|,
name|bn
argument_list|,
name|ntfs_bntob
argument_list|(
name|ntmp
operator|->
name|ntm_bpmftrec
argument_list|)
argument_list|,
name|NOCRED
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_loadnode: BREAD FAILED\n"
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|memcpy
argument_list|(
name|mfrp
argument_list|,
name|bp
operator|->
name|b_data
argument_list|,
name|ntfs_bntob
argument_list|(
name|ntmp
operator|->
name|ntm_bpmftrec
argument_list|)
argument_list|)
expr_stmt|;
name|bqrelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|vnode
modifier|*
name|vp
decl_stmt|;
name|vp
operator|=
name|ntmp
operator|->
name|ntm_sysvn
index|[
name|NTFS_MFTINO
index|]
expr_stmt|;
name|error
operator|=
name|ntfs_breadattr
argument_list|(
name|ntmp
argument_list|,
name|VTONT
argument_list|(
name|vp
argument_list|)
argument_list|,
name|NTFS_A_DATA
argument_list|,
name|NULL
argument_list|,
name|ip
operator|->
name|i_number
operator|*
name|ntfs_bntob
argument_list|(
name|ntmp
operator|->
name|ntm_bpmftrec
argument_list|)
argument_list|,
name|ntfs_bntob
argument_list|(
name|ntmp
operator|->
name|ntm_bpmftrec
argument_list|)
argument_list|,
name|mfrp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_loadnode: ntfs_breadattr failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
comment|/* Check if magic and fixups are correct */
name|error
operator|=
name|ntfs_procfixups
argument_list|(
name|ntmp
argument_list|,
name|NTFS_FILEMAGIC
argument_list|,
operator|(
name|caddr_t
operator|)
name|mfrp
argument_list|,
name|ntfs_bntob
argument_list|(
name|ntmp
operator|->
name|ntm_bpmftrec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_loadnode: BAD MFT RECORD %d\n"
argument_list|,
operator|(
name|u_int32_t
operator|)
name|ip
operator|->
name|i_number
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|dprintf
argument_list|(
operator|(
literal|"ntfs_loadnode: load attrs for ino: %d\n"
operator|,
name|ip
operator|->
name|i_number
operator|)
argument_list|)
expr_stmt|;
name|off
operator|=
name|mfrp
operator|->
name|fr_attroff
expr_stmt|;
name|ap
operator|=
operator|(
expr|struct
name|attr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|mfrp
operator|+
name|off
operator|)
expr_stmt|;
name|vapp
operator|=
operator|&
name|ip
operator|->
name|i_vattrp
expr_stmt|;
while|while
condition|(
name|ap
operator|->
name|a_hdr
operator|.
name|a_type
operator|!=
operator|-
literal|1
condition|)
block|{
name|error
operator|=
name|ntfs_attrtontvattr
argument_list|(
name|ntmp
argument_list|,
name|vapp
argument_list|,
name|ap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
operator|(
operator|*
name|vapp
operator|)
operator|->
name|va_ip
operator|=
name|ip
expr_stmt|;
name|vapp
operator|=
operator|&
operator|(
operator|(
operator|*
name|vapp
operator|)
operator|->
name|va_nextp
operator|)
expr_stmt|;
name|off
operator|+=
name|ap
operator|->
name|a_hdr
operator|.
name|reclen
expr_stmt|;
name|ap
operator|=
operator|(
expr|struct
name|attr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|mfrp
operator|+
name|off
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_loadnode: failed to load attr ino: %d\n"
argument_list|,
name|ip
operator|->
name|i_number
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ip
operator|->
name|i_mainrec
operator|=
name|mfrp
operator|->
name|fr_mainrec
expr_stmt|;
name|ip
operator|->
name|i_nlink
operator|=
name|mfrp
operator|->
name|fr_nlink
expr_stmt|;
name|ip
operator|->
name|i_frflag
operator|=
name|mfrp
operator|->
name|fr_flags
expr_stmt|;
name|ip
operator|->
name|i_flag
operator||=
name|IN_LOADED
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|i_mainrec
operator|==
literal|0
condition|)
block|{
name|struct
name|ntvattr
modifier|*
name|vap
decl_stmt|;
if|if
condition|(
name|ntfs_ntvattrget
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|NTFS_A_NAME
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|&
name|vap
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ip
operator|->
name|i_times
operator|=
name|vap
operator|->
name|va_a_name
operator|->
name|n_times
expr_stmt|;
name|ip
operator|->
name|i_pnumber
operator|=
name|vap
operator|->
name|va_a_name
operator|->
name|n_pnumber
expr_stmt|;
name|ip
operator|->
name|i_fflag
operator|=
name|vap
operator|->
name|va_a_name
operator|->
name|n_flag
expr_stmt|;
name|ntfs_ntvattrrele
argument_list|(
name|vap
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ip
operator|->
name|i_fflag
operator|&
name|NTFS_FFLAG_DIR
operator|)
operator|&&
operator|(
name|ip
operator|->
name|i_defattr
operator|==
literal|0
operator|)
condition|)
block|{
name|struct
name|ntvattr
modifier|*
name|irvap
decl_stmt|;
name|ip
operator|->
name|i_type
operator|=
name|VDIR
expr_stmt|;
name|ip
operator|->
name|i_defattr
operator|=
name|NTFS_A_INDXROOT
expr_stmt|;
name|ip
operator|->
name|i_defattrname
operator|=
literal|"$I30"
expr_stmt|;
name|error
operator|=
name|ntfs_ntvattrget
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|NTFS_A_INDXROOT
argument_list|,
literal|"$I30"
argument_list|,
literal|0
argument_list|,
operator|&
name|irvap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|ip
operator|->
name|i_dirblsz
operator|=
name|irvap
operator|->
name|va_a_iroot
operator|->
name|ir_size
expr_stmt|;
name|MALLOC
argument_list|(
name|ip
operator|->
name|i_dirblbuf
argument_list|,
name|caddr_t
argument_list|,
name|max
argument_list|(
name|irvap
operator|->
name|va_datalen
argument_list|,
name|ip
operator|->
name|i_dirblsz
argument_list|)
argument_list|,
name|M_NTFSDIR
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|ntfs_ntvattrrele
argument_list|(
name|irvap
argument_list|)
expr_stmt|;
block|}
name|ip
operator|->
name|i_size
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|i_allocated
operator|=
literal|0
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|ip
operator|->
name|i_type
operator|=
name|VREG
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|i_defattr
operator|==
literal|0
condition|)
block|{
name|ip
operator|->
name|i_defattr
operator|=
name|NTFS_A_DATA
expr_stmt|;
name|ip
operator|->
name|i_defattrname
operator|=
name|NULL
expr_stmt|;
block|}
name|ntfs_filesize
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
operator|&
name|ip
operator|->
name|i_size
argument_list|,
operator|&
name|ip
operator|->
name|i_allocated
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|NTTOV
argument_list|(
name|ip
argument_list|)
condition|)
block|{
if|if
condition|(
name|ip
operator|->
name|i_number
operator|==
name|NTFS_ROOTINO
condition|)
name|NTTOV
argument_list|(
name|ip
argument_list|)
operator|->
name|v_flag
operator||=
name|VROOT
expr_stmt|;
if|if
condition|(
name|ip
operator|->
name|i_number
operator|<
name|NTFS_SYSNODESNUM
condition|)
name|NTTOV
argument_list|(
name|ip
argument_list|)
operator|->
name|v_flag
operator||=
name|VSYSTEM
expr_stmt|;
name|NTTOV
argument_list|(
name|ip
argument_list|)
operator|->
name|v_type
operator|=
name|ip
operator|->
name|i_type
expr_stmt|;
block|}
name|out
label|:
name|FREE
argument_list|(
name|mfrp
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ntfs_ntget
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|ino_t
name|ino
parameter_list|,
name|struct
name|ntnode
modifier|*
modifier|*
name|ipp
parameter_list|)
block|{
name|struct
name|ntnode
modifier|*
name|ip
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntget: allocate ntnode %d\n"
operator|,
name|ino
operator|)
argument_list|)
expr_stmt|;
operator|*
name|ipp
operator|=
name|NULL
expr_stmt|;
name|MALLOC
argument_list|(
name|ip
argument_list|,
expr|struct
name|ntnode
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ntnode
argument_list|)
argument_list|,
name|M_NTFSNODE
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|caddr_t
operator|)
name|ip
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ntnode
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Generic initialization */
name|ip
operator|->
name|i_mp
operator|=
name|ntmp
expr_stmt|;
name|ip
operator|->
name|i_number
operator|=
name|ino
expr_stmt|;
name|ip
operator|->
name|i_dev
operator|=
name|ntmp
operator|->
name|ntm_dev
expr_stmt|;
name|ip
operator|->
name|i_uid
operator|=
name|ntmp
operator|->
name|ntm_uid
expr_stmt|;
name|ip
operator|->
name|i_gid
operator|=
name|ntmp
operator|->
name|ntm_gid
expr_stmt|;
name|ip
operator|->
name|i_mode
operator|=
name|ntmp
operator|->
name|ntm_mode
expr_stmt|;
comment|/* Setup internal pointers */
name|ip
operator|->
name|i_vattrp
operator|=
name|NULL
expr_stmt|;
name|ip
operator|->
name|i_devvp
operator|=
name|ntmp
operator|->
name|ntm_devvp
expr_stmt|;
operator|*
name|ipp
operator|=
name|ip
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntget: allocated ntnode %d ok\n"
operator|,
name|ino
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ntfs_ntrele
parameter_list|(
name|struct
name|ntnode
modifier|*
name|ip
parameter_list|)
block|{
name|struct
name|ntvattr
modifier|*
name|vap
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntrele: rele ntnode %d\n"
operator|,
name|ip
operator|->
name|i_number
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|ip
operator|->
name|i_vattrp
condition|)
block|{
name|vap
operator|=
name|ip
operator|->
name|i_vattrp
expr_stmt|;
name|ip
operator|->
name|i_vattrp
operator|=
name|vap
operator|->
name|va_nextp
expr_stmt|;
name|ntfs_freentvattr
argument_list|(
name|vap
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ip
operator|->
name|i_flag
operator|&
name|IN_AATTRNAME
condition|)
name|FREE
argument_list|(
name|ip
operator|->
name|i_defattrname
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntrele: rele ntnode %d ok\n"
operator|,
name|ip
operator|->
name|i_number
operator|)
argument_list|)
expr_stmt|;
name|FREE
argument_list|(
name|ip
argument_list|,
name|M_NTFSNODE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ntfs_freentvattr
parameter_list|(
name|struct
name|ntvattr
modifier|*
name|vap
parameter_list|)
block|{
if|if
condition|(
name|vap
operator|->
name|va_flag
operator|&
name|NTFS_AF_INRUN
condition|)
block|{
if|if
condition|(
name|vap
operator|->
name|va_vruncn
condition|)
name|FREE
argument_list|(
name|vap
operator|->
name|va_vruncn
argument_list|,
name|M_NTFSRUN
argument_list|)
expr_stmt|;
if|if
condition|(
name|vap
operator|->
name|va_vruncl
condition|)
name|FREE
argument_list|(
name|vap
operator|->
name|va_vruncl
argument_list|,
name|M_NTFSRUN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|vap
operator|->
name|va_datap
condition|)
name|FREE
argument_list|(
name|vap
operator|->
name|va_datap
argument_list|,
name|M_NTFSRDATA
argument_list|)
expr_stmt|;
block|}
name|FREE
argument_list|(
name|vap
argument_list|,
name|M_NTFSNTVATTR
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ntfs_attrtontvattr
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|struct
name|ntvattr
modifier|*
modifier|*
name|rvapp
parameter_list|,
name|struct
name|attr
modifier|*
name|rap
parameter_list|)
block|{
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
name|struct
name|ntvattr
modifier|*
name|vap
decl_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
operator|*
name|rvapp
operator|=
name|NULL
expr_stmt|;
name|MALLOC
argument_list|(
name|vap
argument_list|,
expr|struct
name|ntvattr
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|vap
argument_list|)
argument_list|,
name|M_NTFSNTVATTR
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|vap
operator|->
name|va_ip
operator|=
name|NULL
expr_stmt|;
name|vap
operator|->
name|va_flag
operator|=
name|rap
operator|->
name|a_hdr
operator|.
name|a_flag
expr_stmt|;
name|vap
operator|->
name|va_type
operator|=
name|rap
operator|->
name|a_hdr
operator|.
name|a_type
expr_stmt|;
name|vap
operator|->
name|va_compression
operator|=
name|rap
operator|->
name|a_hdr
operator|.
name|a_compression
expr_stmt|;
name|vap
operator|->
name|va_nextp
operator|=
name|NULL
expr_stmt|;
name|vap
operator|->
name|va_index
operator|=
name|rap
operator|->
name|a_hdr
operator|.
name|a_index
expr_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|"type: 0x%x, index: %d"
operator|,
name|vap
operator|->
name|va_type
operator|,
name|vap
operator|->
name|va_index
operator|)
argument_list|)
expr_stmt|;
name|vap
operator|->
name|va_namelen
operator|=
name|rap
operator|->
name|a_hdr
operator|.
name|a_namelen
expr_stmt|;
if|if
condition|(
name|rap
operator|->
name|a_hdr
operator|.
name|a_namelen
condition|)
block|{
name|wchar
modifier|*
name|unp
init|=
operator|(
name|wchar
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|rap
operator|+
name|rap
operator|->
name|a_hdr
operator|.
name|a_nameoff
operator|)
decl_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|", name:["
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|vap
operator|->
name|va_namelen
condition|;
name|i
operator|++
control|)
block|{
name|vap
operator|->
name|va_name
index|[
name|i
index|]
operator|=
name|unp
index|[
name|i
index|]
expr_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|"%c"
operator|,
name|vap
operator|->
name|va_name
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
name|ddprintf
argument_list|(
operator|(
literal|"]"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|vap
operator|->
name|va_flag
operator|&
name|NTFS_AF_INRUN
condition|)
block|{
name|ddprintf
argument_list|(
operator|(
literal|", nonres."
operator|)
argument_list|)
expr_stmt|;
name|vap
operator|->
name|va_datalen
operator|=
name|rap
operator|->
name|a_nr
operator|.
name|a_datalen
expr_stmt|;
name|vap
operator|->
name|va_allocated
operator|=
name|rap
operator|->
name|a_nr
operator|.
name|a_allocated
expr_stmt|;
name|vap
operator|->
name|va_vcnstart
operator|=
name|rap
operator|->
name|a_nr
operator|.
name|a_vcnstart
expr_stmt|;
name|vap
operator|->
name|va_vcnend
operator|=
name|rap
operator|->
name|a_nr
operator|.
name|a_vcnend
expr_stmt|;
name|vap
operator|->
name|va_compressalg
operator|=
name|rap
operator|->
name|a_nr
operator|.
name|a_compressalg
expr_stmt|;
name|error
operator|=
name|ntfs_runtovrun
argument_list|(
operator|&
operator|(
name|vap
operator|->
name|va_vruncn
operator|)
argument_list|,
operator|&
operator|(
name|vap
operator|->
name|va_vruncl
operator|)
argument_list|,
operator|&
operator|(
name|vap
operator|->
name|va_vruncnt
operator|)
argument_list|,
operator|(
name|caddr_t
operator|)
name|rap
operator|+
name|rap
operator|->
name|a_nr
operator|.
name|a_dataoff
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|vap
operator|->
name|va_compressalg
operator|=
literal|0
expr_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|", res."
operator|)
argument_list|)
expr_stmt|;
name|vap
operator|->
name|va_datalen
operator|=
name|rap
operator|->
name|a_r
operator|.
name|a_datalen
expr_stmt|;
name|vap
operator|->
name|va_allocated
operator|=
name|rap
operator|->
name|a_r
operator|.
name|a_datalen
expr_stmt|;
name|vap
operator|->
name|va_vcnstart
operator|=
literal|0
expr_stmt|;
name|vap
operator|->
name|va_vcnend
operator|=
name|ntfs_btocn
argument_list|(
name|vap
operator|->
name|va_allocated
argument_list|)
expr_stmt|;
name|MALLOC
argument_list|(
name|vap
operator|->
name|va_datap
argument_list|,
name|caddr_t
argument_list|,
name|vap
operator|->
name|va_datalen
argument_list|,
name|M_NTFSRDATA
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|vap
operator|->
name|va_datap
argument_list|,
operator|(
name|caddr_t
operator|)
name|rap
operator|+
name|rap
operator|->
name|a_r
operator|.
name|a_dataoff
argument_list|,
name|rap
operator|->
name|a_r
operator|.
name|a_datalen
argument_list|)
expr_stmt|;
block|}
name|ddprintf
argument_list|(
operator|(
literal|", len: %d"
operator|,
name|vap
operator|->
name|va_datalen
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|FREE
argument_list|(
name|vap
argument_list|,
name|M_NTFSNTVATTR
argument_list|)
expr_stmt|;
else|else
operator|*
name|rvapp
operator|=
name|vap
expr_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|"\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ntfs_runtovrun
parameter_list|(
name|cn_t
modifier|*
modifier|*
name|rcnp
parameter_list|,
name|cn_t
modifier|*
modifier|*
name|rclp
parameter_list|,
name|u_int32_t
modifier|*
name|rcntp
parameter_list|,
name|u_int8_t
modifier|*
name|run
parameter_list|)
block|{
name|u_int32_t
name|off
decl_stmt|;
name|u_int32_t
name|sz
decl_stmt|,
name|i
decl_stmt|;
name|cn_t
modifier|*
name|cn
decl_stmt|;
name|cn_t
modifier|*
name|cl
decl_stmt|;
name|u_int32_t
name|cnt
decl_stmt|;
name|u_int64_t
name|prev
decl_stmt|;
name|off
operator|=
literal|0
expr_stmt|;
name|cnt
operator|=
literal|0
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|run
index|[
name|off
index|]
condition|)
block|{
name|off
operator|+=
operator|(
name|run
index|[
name|off
index|]
operator|&
literal|0xF
operator|)
operator|+
operator|(
operator|(
name|run
index|[
name|off
index|]
operator|>>
literal|4
operator|)
operator|&
literal|0xF
operator|)
operator|+
literal|1
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
block|}
name|MALLOC
argument_list|(
name|cn
argument_list|,
name|cn_t
operator|*
argument_list|,
name|cnt
operator|*
sizeof|sizeof
argument_list|(
name|cn_t
argument_list|)
argument_list|,
name|M_NTFSRUN
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|MALLOC
argument_list|(
name|cl
argument_list|,
name|cn_t
operator|*
argument_list|,
name|cnt
operator|*
sizeof|sizeof
argument_list|(
name|cn_t
argument_list|)
argument_list|,
name|M_NTFSRUN
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|off
operator|=
literal|0
expr_stmt|;
name|cnt
operator|=
literal|0
expr_stmt|;
name|prev
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|run
index|[
name|off
index|]
condition|)
block|{
name|u_int64_t
name|tmp
decl_stmt|;
name|sz
operator|=
name|run
index|[
name|off
operator|++
index|]
expr_stmt|;
name|cl
index|[
name|cnt
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|sz
operator|&
literal|0xF
operator|)
condition|;
name|i
operator|++
control|)
name|cl
index|[
name|cnt
index|]
operator|+=
operator|(
name|u_int32_t
operator|)
name|run
index|[
name|off
operator|++
index|]
operator|<<
operator|(
name|i
operator|<<
literal|3
operator|)
expr_stmt|;
name|sz
operator|>>=
literal|4
expr_stmt|;
if|if
condition|(
name|run
index|[
name|off
operator|+
name|sz
operator|-
literal|1
index|]
operator|&
literal|0x80
condition|)
block|{
name|tmp
operator|=
operator|(
operator|(
name|u_int64_t
operator|)
operator|-
literal|1
operator|)
operator|<<
operator|(
name|sz
operator|<<
literal|3
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sz
condition|;
name|i
operator|++
control|)
name|tmp
operator||=
operator|(
name|u_int64_t
operator|)
name|run
index|[
name|off
operator|++
index|]
operator|<<
operator|(
name|i
operator|<<
literal|3
operator|)
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sz
condition|;
name|i
operator|++
control|)
name|tmp
operator||=
operator|(
name|u_int64_t
operator|)
name|run
index|[
name|off
operator|++
index|]
operator|<<
operator|(
name|i
operator|<<
literal|3
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|tmp
condition|)
name|prev
operator|=
name|cn
index|[
name|cnt
index|]
operator|=
name|prev
operator|+
name|tmp
expr_stmt|;
else|else
name|cn
index|[
name|cnt
index|]
operator|=
name|tmp
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
block|}
operator|*
name|rcnp
operator|=
name|cn
expr_stmt|;
operator|*
name|rclp
operator|=
name|cl
expr_stmt|;
operator|*
name|rcntp
operator|=
name|cnt
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|wchar
name|ntfs_toupper
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|wchar
name|wc
parameter_list|)
block|{
return|return
operator|(
name|ntmp
operator|->
name|ntm_upcase
index|[
name|wc
operator|&
literal|0xFF
index|]
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ntfs_uustricmp
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|wchar
modifier|*
name|str1
parameter_list|,
name|int
name|str1len
parameter_list|,
name|wchar
modifier|*
name|str2
parameter_list|,
name|int
name|str2len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|res
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|str1len
operator|&&
name|i
operator|<
name|str2len
condition|;
name|i
operator|++
control|)
block|{
name|res
operator|=
operator|(
name|int
operator|)
name|ntfs_toupper
argument_list|(
name|ntmp
argument_list|,
name|str1
index|[
name|i
index|]
argument_list|)
operator|-
operator|(
name|int
operator|)
name|ntfs_toupper
argument_list|(
name|ntmp
argument_list|,
name|str2
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
return|return
name|res
return|;
block|}
return|return
operator|(
name|str1len
operator|-
name|str2len
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ntfs_uastricmp
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|wchar
modifier|*
name|str1
parameter_list|,
name|int
name|str1len
parameter_list|,
name|char
modifier|*
name|str2
parameter_list|,
name|int
name|str2len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|res
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|str1len
operator|&&
name|i
operator|<
name|str2len
condition|;
name|i
operator|++
control|)
block|{
name|res
operator|=
operator|(
name|int
operator|)
name|ntfs_toupper
argument_list|(
name|ntmp
argument_list|,
name|str1
index|[
name|i
index|]
argument_list|)
operator|-
operator|(
name|int
operator|)
name|ntfs_toupper
argument_list|(
name|ntmp
argument_list|,
operator|(
name|wchar
operator|)
name|str2
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
return|return
name|res
return|;
block|}
return|return
operator|(
name|str1len
operator|-
name|str2len
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ntfs_uastrcmp
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|wchar
modifier|*
name|str1
parameter_list|,
name|int
name|str1len
parameter_list|,
name|char
modifier|*
name|str2
parameter_list|,
name|int
name|str2len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|res
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|i
operator|<
name|str1len
operator|)
operator|&&
operator|(
name|i
operator|<
name|str2len
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|res
operator|=
operator|(
operator|(
name|int
operator|)
name|str1
index|[
name|i
index|]
operator|)
operator|-
operator|(
operator|(
name|int
operator|)
name|str2
index|[
name|i
index|]
operator|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
return|return
name|res
return|;
block|}
return|return
operator|(
name|str1len
operator|-
name|str2len
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ntfs_ntlookupattr
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|char
modifier|*
name|name
parameter_list|,
name|int
name|namelen
parameter_list|,
name|int
modifier|*
name|type
parameter_list|,
name|char
modifier|*
modifier|*
name|attrname
parameter_list|)
block|{
name|char
modifier|*
name|sys
decl_stmt|;
name|int
name|syslen
decl_stmt|,
name|i
decl_stmt|;
name|struct
name|ntvattrdef
modifier|*
name|adp
decl_stmt|;
if|if
condition|(
name|namelen
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|name
index|[
literal|0
index|]
operator|==
literal|'$'
condition|)
block|{
name|sys
operator|=
name|name
expr_stmt|;
for|for
control|(
name|syslen
operator|=
literal|0
init|;
name|syslen
operator|<
name|namelen
condition|;
name|syslen
operator|++
control|)
block|{
if|if
condition|(
name|sys
index|[
name|syslen
index|]
operator|==
literal|':'
condition|)
block|{
name|name
operator|++
expr_stmt|;
name|namelen
operator|--
expr_stmt|;
break|break;
block|}
block|}
name|name
operator|+=
name|syslen
expr_stmt|;
name|namelen
operator|-=
name|syslen
expr_stmt|;
name|adp
operator|=
name|ntmp
operator|->
name|ntm_ad
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ntmp
operator|->
name|ntm_adnum
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|syslen
operator|==
name|adp
operator|->
name|ad_namelen
operator|)
operator|&&
operator|(
operator|!
name|strncmp
argument_list|(
name|sys
argument_list|,
name|adp
operator|->
name|ad_name
argument_list|,
name|syslen
argument_list|)
operator|)
condition|)
block|{
operator|*
name|type
operator|=
name|adp
operator|->
name|ad_type
expr_stmt|;
if|if
condition|(
name|namelen
condition|)
block|{
name|MALLOC
argument_list|(
operator|(
operator|*
name|attrname
operator|)
argument_list|,
name|char
operator|*
argument_list|,
name|namelen
argument_list|,
name|M_TEMP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
operator|*
name|attrname
operator|)
argument_list|,
name|name
argument_list|,
name|namelen
argument_list|)
expr_stmt|;
operator|(
operator|*
name|attrname
operator|)
index|[
name|namelen
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
comment|/* else  					(*attrname) = NULL;*/
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|adp
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
if|if
condition|(
name|namelen
condition|)
block|{
name|MALLOC
argument_list|(
operator|(
operator|*
name|attrname
operator|)
argument_list|,
name|char
operator|*
argument_list|,
name|namelen
argument_list|,
name|M_TEMP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
operator|*
name|attrname
operator|)
argument_list|,
name|name
argument_list|,
name|namelen
argument_list|)
expr_stmt|;
operator|(
operator|*
name|attrname
operator|)
index|[
name|namelen
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Lookup specifed node for filename, matching cnp, return filled ntnode.  */
end_comment

begin_function
name|int
name|ntfs_ntlookup
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|struct
name|ntnode
modifier|*
name|ip
parameter_list|,
name|struct
name|componentname
modifier|*
name|cnp
parameter_list|,
name|struct
name|ntnode
modifier|*
modifier|*
name|ipp
parameter_list|)
block|{
name|struct
name|ntvattr
modifier|*
name|vap
decl_stmt|;
comment|/* Root attribute */
name|cn_t
name|cn
decl_stmt|;
comment|/* VCN in current attribute */
name|caddr_t
name|rdbuf
decl_stmt|;
comment|/* Buffer to read directory's blocks  */
name|u_int32_t
name|blsize
decl_stmt|;
name|u_int32_t
name|rdsize
decl_stmt|;
comment|/* Length of data to read from current block */
name|struct
name|attr_indexentry
modifier|*
name|iep
decl_stmt|;
name|int
name|error
decl_stmt|,
name|res
decl_stmt|,
name|anamelen
decl_stmt|,
name|fnamelen
decl_stmt|;
name|char
modifier|*
name|fname
decl_stmt|,
modifier|*
name|aname
decl_stmt|;
name|u_int32_t
name|aoff
decl_stmt|;
name|struct
name|ntnode
modifier|*
name|nip
decl_stmt|;
name|error
operator|=
name|ntfs_ntvattrget
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|NTFS_A_INDXROOT
argument_list|,
literal|"$I30"
argument_list|,
literal|0
argument_list|,
operator|&
name|vap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
operator|(
name|vap
operator|->
name|va_flag
operator|&
name|NTFS_AF_INRUN
operator|)
condition|)
return|return
operator|(
name|ENOTDIR
operator|)
return|;
name|blsize
operator|=
name|vap
operator|->
name|va_a_iroot
operator|->
name|ir_size
expr_stmt|;
name|rdsize
operator|=
name|vap
operator|->
name|va_datalen
expr_stmt|;
name|fname
operator|=
name|cnp
operator|->
name|cn_nameptr
expr_stmt|;
name|aname
operator|=
name|NULL
expr_stmt|;
name|anamelen
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|fnamelen
operator|=
literal|0
init|;
name|fnamelen
operator|<
name|cnp
operator|->
name|cn_namelen
condition|;
name|fnamelen
operator|++
control|)
if|if
condition|(
name|fname
index|[
name|fnamelen
index|]
operator|==
literal|':'
condition|)
block|{
name|aname
operator|=
name|fname
operator|+
name|fnamelen
operator|+
literal|1
expr_stmt|;
name|anamelen
operator|=
name|cnp
operator|->
name|cn_namelen
operator|-
name|fnamelen
operator|-
literal|1
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntlookup: file %s (%d), attr: %s (%d)\n"
operator|,
name|fname
operator|,
name|fnamelen
operator|,
name|aname
operator|,
name|anamelen
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntlookup: blocksize: %d, rdsize: %d\n"
operator|,
name|blsize
operator|,
name|rdsize
operator|)
argument_list|)
expr_stmt|;
name|MALLOC
argument_list|(
name|rdbuf
argument_list|,
name|caddr_t
argument_list|,
name|blsize
argument_list|,
name|M_TEMP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|error
operator|=
name|ntfs_breadattr
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|NTFS_A_INDXROOT
argument_list|,
literal|"$I30"
argument_list|,
literal|0
argument_list|,
name|rdsize
argument_list|,
name|rdbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|aoff
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|attr_indexroot
argument_list|)
expr_stmt|;
do|do
block|{
name|iep
operator|=
operator|(
expr|struct
name|attr_indexentry
operator|*
operator|)
operator|(
name|rdbuf
operator|+
name|aoff
operator|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|iep
operator|->
name|ie_flag
operator|&
name|NTFS_IEFLAG_LAST
operator|)
operator|&&
operator|(
name|rdsize
operator|>
name|aoff
operator|)
condition|)
block|{
name|ddprintf
argument_list|(
operator|(
literal|"scan: %d, %d\n"
operator|,
operator|(
name|u_int32_t
operator|)
name|iep
operator|->
name|ie_number
operator|,
operator|(
name|u_int32_t
operator|)
name|iep
operator|->
name|ie_fnametype
operator|)
argument_list|)
expr_stmt|;
name|res
operator|=
name|ntfs_uastricmp
argument_list|(
name|ntmp
argument_list|,
name|iep
operator|->
name|ie_fname
argument_list|,
name|iep
operator|->
name|ie_fnamelen
argument_list|,
name|fname
argument_list|,
name|fnamelen
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
block|{
comment|/* Matched something (case ins.) */
if|if
condition|(
name|iep
operator|->
name|ie_fnametype
operator|==
literal|0
operator|||
operator|!
operator|(
name|ntmp
operator|->
name|ntm_flag
operator|&
name|NTFS_MFLAG_CASEINS
operator|)
condition|)
name|res
operator|=
name|ntfs_uastrcmp
argument_list|(
name|ntmp
argument_list|,
name|iep
operator|->
name|ie_fname
argument_list|,
name|iep
operator|->
name|ie_fnamelen
argument_list|,
name|fname
argument_list|,
name|fnamelen
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
block|{
name|error
operator|=
name|ntfs_ntget
argument_list|(
name|ntmp
argument_list|,
name|iep
operator|->
name|ie_number
argument_list|,
operator|&
name|nip
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|nip
operator|->
name|i_fflag
operator|=
name|iep
operator|->
name|ie_fflag
expr_stmt|;
name|nip
operator|->
name|i_pnumber
operator|=
name|iep
operator|->
name|ie_fpnumber
expr_stmt|;
name|nip
operator|->
name|i_times
operator|=
name|iep
operator|->
name|ie_ftimes
expr_stmt|;
if|if
condition|(
name|nip
operator|->
name|i_fflag
operator|&
name|NTFS_FFLAG_DIR
condition|)
block|{
name|nip
operator|->
name|i_type
operator|=
name|VDIR
expr_stmt|;
name|nip
operator|->
name|i_defattr
operator|=
literal|0
expr_stmt|;
name|nip
operator|->
name|i_defattrname
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|nip
operator|->
name|i_type
operator|=
name|VREG
expr_stmt|;
name|nip
operator|->
name|i_defattr
operator|=
name|NTFS_A_DATA
expr_stmt|;
name|nip
operator|->
name|i_defattrname
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|aname
condition|)
block|{
name|error
operator|=
name|ntfs_ntlookupattr
argument_list|(
name|ntmp
argument_list|,
name|aname
argument_list|,
name|anamelen
argument_list|,
operator|&
name|nip
operator|->
name|i_defattr
argument_list|,
operator|&
name|nip
operator|->
name|i_defattrname
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|ntfs_ntrele
argument_list|(
name|nip
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|nip
operator|->
name|i_type
operator|=
name|VREG
expr_stmt|;
if|if
condition|(
name|nip
operator|->
name|i_defattrname
condition|)
name|nip
operator|->
name|i_flag
operator||=
name|IN_AATTRNAME
expr_stmt|;
block|}
else|else
block|{
comment|/* Opening default attribute */
name|nip
operator|->
name|i_size
operator|=
name|iep
operator|->
name|ie_fsize
expr_stmt|;
name|nip
operator|->
name|i_allocated
operator|=
name|iep
operator|->
name|ie_fallocated
expr_stmt|;
name|nip
operator|->
name|i_flag
operator||=
name|IN_PRELOADED
expr_stmt|;
block|}
operator|*
name|ipp
operator|=
name|nip
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|res
operator|>
literal|0
condition|)
break|break;
name|aoff
operator|+=
name|iep
operator|->
name|reclen
expr_stmt|;
name|iep
operator|=
operator|(
expr|struct
name|attr_indexentry
operator|*
operator|)
operator|(
name|rdbuf
operator|+
name|aoff
operator|)
expr_stmt|;
block|}
comment|/* Dive if possible */
if|if
condition|(
name|iep
operator|->
name|ie_flag
operator|&
name|NTFS_IEFLAG_SUBNODE
condition|)
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntlookup: diving\n"
operator|)
argument_list|)
expr_stmt|;
name|cn
operator|=
operator|*
operator|(
name|cn_t
operator|*
operator|)
operator|(
name|rdbuf
operator|+
name|aoff
operator|+
name|iep
operator|->
name|reclen
operator|-
sizeof|sizeof
argument_list|(
name|cn_t
argument_list|)
operator|)
expr_stmt|;
name|rdsize
operator|=
name|blsize
expr_stmt|;
name|error
operator|=
name|ntfs_breadattr
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|NTFS_A_INDX
argument_list|,
literal|"$I30"
argument_list|,
name|ntfs_cntob
argument_list|(
name|cn
argument_list|)
argument_list|,
name|rdsize
argument_list|,
name|rdbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|ntfs_procfixups
argument_list|(
name|ntmp
argument_list|,
name|NTFS_INDXMAGIC
argument_list|,
name|rdbuf
argument_list|,
name|rdsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|aoff
operator|=
operator|(
operator|(
operator|(
expr|struct
name|attr_indexalloc
operator|*
operator|)
name|rdbuf
operator|)
operator|->
name|ia_hdrsize
operator|+
literal|0x18
operator|)
expr_stmt|;
block|}
else|else
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntlookup: nowhere to dive :-(\n"
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOENT
expr_stmt|;
break|break;
block|}
block|}
do|while
condition|(
literal|1
condition|)
do|;
name|dprintf
argument_list|(
operator|(
literal|"finish\n"
operator|)
argument_list|)
expr_stmt|;
name|fail
label|:
name|ntfs_ntvattrrele
argument_list|(
name|vap
argument_list|)
expr_stmt|;
name|FREE
argument_list|(
name|rdbuf
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ntfs_isnamepermitted
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|struct
name|attr_indexentry
modifier|*
name|iep
parameter_list|)
block|{
if|if
condition|(
name|ntmp
operator|->
name|ntm_flag
operator|&
name|NTFS_MFLAG_ALLNAMES
condition|)
return|return
literal|1
return|;
switch|switch
condition|(
name|iep
operator|->
name|ie_fnametype
condition|)
block|{
case|case
literal|2
case|:
name|ddprintf
argument_list|(
operator|(
literal|"ntfs_isnamepermitted: skiped DOS name\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
literal|0
case|:
case|case
literal|1
case|:
case|case
literal|3
case|:
return|return
literal|1
return|;
default|default:
name|printf
argument_list|(
literal|"ntfs_isnamepermitted: "
expr|\
literal|"WARNING! Unknown file name type: %d\n"
argument_list|,
name|iep
operator|->
name|ie_fnametype
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * #undef dprintf #define dprintf(a) printf a  */
end_comment

begin_function
name|int
name|ntfs_ntreaddir
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|struct
name|ntnode
modifier|*
name|ip
parameter_list|,
name|u_int32_t
name|num
parameter_list|,
name|struct
name|attr_indexentry
modifier|*
modifier|*
name|riepp
parameter_list|)
block|{
name|struct
name|ntvattr
modifier|*
name|vap
init|=
name|NULL
decl_stmt|;
comment|/* IndexRoot attribute */
name|struct
name|ntvattr
modifier|*
name|bmvap
init|=
name|NULL
decl_stmt|;
comment|/* BitMap attribute */
name|struct
name|ntvattr
modifier|*
name|iavap
init|=
name|NULL
decl_stmt|;
comment|/* IndexAllocation attribute */
name|caddr_t
name|rdbuf
decl_stmt|;
comment|/* Buffer to read directory's blocks  */
name|u_char
modifier|*
name|bmp
init|=
name|NULL
decl_stmt|;
comment|/* Bitmap */
name|u_int32_t
name|blsize
decl_stmt|;
comment|/* Index allocation size (2048) */
name|u_int32_t
name|rdsize
decl_stmt|;
comment|/* Length of data to read */
name|u_int32_t
name|attrnum
decl_stmt|;
comment|/* Current attribute type */
name|u_int32_t
name|cpbl
init|=
literal|1
decl_stmt|;
comment|/* Clusters per directory block */
name|u_int32_t
name|blnum
decl_stmt|;
name|struct
name|attr_indexentry
modifier|*
name|iep
decl_stmt|;
name|int
name|error
init|=
name|ENOENT
decl_stmt|;
name|u_int32_t
name|aoff
decl_stmt|,
name|cnum
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntreaddir: read ino: %d, num: %d\n"
operator|,
name|ip
operator|->
name|i_number
operator|,
name|num
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ntfs_ntvattrget
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|NTFS_A_INDXROOT
argument_list|,
literal|"$I30"
argument_list|,
literal|0
argument_list|,
operator|&
name|vap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|ENOTDIR
operator|)
return|;
name|blsize
operator|=
name|ip
operator|->
name|i_dirblsz
expr_stmt|;
name|rdbuf
operator|=
name|ip
operator|->
name|i_dirblbuf
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntreaddir: rdbuf: 0x%p, blsize: %d\n"
operator|,
name|rdbuf
operator|,
name|blsize
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vap
operator|->
name|va_a_iroot
operator|->
name|ir_flag
operator|&
name|NTFS_IRFLAG_INDXALLOC
condition|)
block|{
name|error
operator|=
name|ntfs_ntvattrget
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|NTFS_A_INDXBITMAP
argument_list|,
literal|"$I30"
argument_list|,
literal|0
argument_list|,
operator|&
name|bmvap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|error
operator|=
name|ENOTDIR
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|MALLOC
argument_list|(
name|bmp
argument_list|,
name|u_char
operator|*
argument_list|,
name|bmvap
operator|->
name|va_datalen
argument_list|,
name|M_TEMP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|error
operator|=
name|ntfs_breadattr
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|NTFS_A_INDXBITMAP
argument_list|,
literal|"$I30"
argument_list|,
literal|0
argument_list|,
name|bmvap
operator|->
name|va_datalen
argument_list|,
name|bmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|ntfs_ntvattrget
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|NTFS_A_INDX
argument_list|,
literal|"$I30"
argument_list|,
literal|0
argument_list|,
operator|&
name|iavap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|error
operator|=
name|ENOTDIR
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|cpbl
operator|=
name|ntfs_btocn
argument_list|(
name|blsize
operator|+
name|ntfs_cntob
argument_list|(
literal|1
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntreaddir: indexalloc: %d, cpbl: %d\n"
operator|,
name|iavap
operator|->
name|va_datalen
operator|,
name|cpbl
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntreadidir: w/o BitMap and IndexAllocation\n"
operator|)
argument_list|)
expr_stmt|;
name|iavap
operator|=
name|bmvap
operator|=
name|NULL
expr_stmt|;
name|bmp
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* Try use previous values */
if|if
condition|(
operator|(
name|ip
operator|->
name|i_lastdnum
operator|<
name|num
operator|)
operator|&&
operator|(
name|ip
operator|->
name|i_lastdnum
operator|!=
literal|0
operator|)
condition|)
block|{
name|attrnum
operator|=
name|ip
operator|->
name|i_lastdattr
expr_stmt|;
name|aoff
operator|=
name|ip
operator|->
name|i_lastdoff
expr_stmt|;
name|blnum
operator|=
name|ip
operator|->
name|i_lastdblnum
expr_stmt|;
name|cnum
operator|=
name|ip
operator|->
name|i_lastdnum
expr_stmt|;
block|}
else|else
block|{
name|attrnum
operator|=
name|NTFS_A_INDXROOT
expr_stmt|;
name|aoff
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|attr_indexroot
argument_list|)
expr_stmt|;
name|blnum
operator|=
literal|0
expr_stmt|;
name|cnum
operator|=
literal|0
expr_stmt|;
block|}
do|do
block|{
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntreaddir: scan: 0x%x, %d, %d, %d, %d\n"
operator|,
name|attrnum
operator|,
operator|(
name|u_int32_t
operator|)
name|blnum
operator|,
name|cnum
operator|,
name|num
operator|,
name|aoff
operator|)
argument_list|)
expr_stmt|;
name|rdsize
operator|=
operator|(
name|attrnum
operator|==
name|NTFS_A_INDXROOT
operator|)
condition|?
name|vap
operator|->
name|va_datalen
else|:
name|blsize
expr_stmt|;
name|error
operator|=
name|ntfs_breadattr
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|attrnum
argument_list|,
literal|"$I30"
argument_list|,
name|ntfs_cntob
argument_list|(
name|blnum
operator|*
name|cpbl
argument_list|)
argument_list|,
name|rdsize
argument_list|,
name|rdbuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|attrnum
operator|==
name|NTFS_A_INDX
condition|)
block|{
name|error
operator|=
name|ntfs_procfixups
argument_list|(
name|ntmp
argument_list|,
name|NTFS_INDXMAGIC
argument_list|,
name|rdbuf
argument_list|,
name|rdsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|aoff
operator|==
literal|0
condition|)
name|aoff
operator|=
operator|(
name|attrnum
operator|==
name|NTFS_A_INDX
operator|)
condition|?
operator|(
literal|0x18
operator|+
operator|(
operator|(
expr|struct
name|attr_indexalloc
operator|*
operator|)
name|rdbuf
operator|)
operator|->
name|ia_hdrsize
operator|)
else|:
sizeof|sizeof
argument_list|(
expr|struct
name|attr_indexroot
argument_list|)
expr_stmt|;
name|iep
operator|=
operator|(
expr|struct
name|attr_indexentry
operator|*
operator|)
operator|(
name|rdbuf
operator|+
name|aoff
operator|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|iep
operator|->
name|ie_flag
operator|&
name|NTFS_IEFLAG_LAST
operator|)
operator|&&
operator|(
name|rdsize
operator|>
name|aoff
operator|)
condition|)
block|{
if|if
condition|(
name|ntfs_isnamepermitted
argument_list|(
name|ntmp
argument_list|,
name|iep
argument_list|)
condition|)
block|{
if|if
condition|(
name|cnum
operator|>=
name|num
condition|)
block|{
name|ip
operator|->
name|i_lastdnum
operator|=
name|cnum
expr_stmt|;
name|ip
operator|->
name|i_lastdoff
operator|=
name|aoff
expr_stmt|;
name|ip
operator|->
name|i_lastdblnum
operator|=
name|blnum
expr_stmt|;
name|ip
operator|->
name|i_lastdattr
operator|=
name|attrnum
expr_stmt|;
operator|*
name|riepp
operator|=
name|iep
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|cnum
operator|++
expr_stmt|;
block|}
name|aoff
operator|+=
name|iep
operator|->
name|reclen
expr_stmt|;
name|iep
operator|=
operator|(
expr|struct
name|attr_indexentry
operator|*
operator|)
operator|(
name|rdbuf
operator|+
name|aoff
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|iavap
condition|)
block|{
if|if
condition|(
name|attrnum
operator|==
name|NTFS_A_INDXROOT
condition|)
name|blnum
operator|=
literal|0
expr_stmt|;
else|else
name|blnum
operator|++
expr_stmt|;
while|while
condition|(
name|ntfs_cntob
argument_list|(
name|blnum
operator|*
name|cpbl
argument_list|)
operator|<
name|iavap
operator|->
name|va_datalen
condition|)
block|{
if|if
condition|(
name|bmp
index|[
name|blnum
operator|>>
literal|3
index|]
operator|&
operator|(
literal|1
operator|<<
operator|(
name|blnum
operator|&
literal|3
operator|)
operator|)
condition|)
break|break;
name|blnum
operator|++
expr_stmt|;
block|}
name|attrnum
operator|=
name|NTFS_A_INDX
expr_stmt|;
name|aoff
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ntfs_cntob
argument_list|(
name|blnum
operator|*
name|cpbl
argument_list|)
operator|>=
name|iavap
operator|->
name|va_datalen
condition|)
break|break;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_ntreaddir: blnum: %d\n"
operator|,
operator|(
name|u_int32_t
operator|)
name|blnum
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
do|while
condition|(
name|iavap
condition|)
do|;
operator|*
name|riepp
operator|=
name|NULL
expr_stmt|;
name|ip
operator|->
name|i_lastdnum
operator|=
literal|0
expr_stmt|;
name|fail
label|:
if|if
condition|(
name|vap
condition|)
name|ntfs_ntvattrrele
argument_list|(
name|vap
argument_list|)
expr_stmt|;
if|if
condition|(
name|bmvap
condition|)
name|ntfs_ntvattrrele
argument_list|(
name|bmvap
argument_list|)
expr_stmt|;
if|if
condition|(
name|iavap
condition|)
name|ntfs_ntvattrrele
argument_list|(
name|iavap
argument_list|)
expr_stmt|;
if|if
condition|(
name|bmp
condition|)
name|FREE
argument_list|(
name|bmp
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * #undef dprintf #define dprintf(a)  */
end_comment

begin_function
name|struct
name|timespec
name|ntfs_nttimetounix
parameter_list|(
name|u_int64_t
name|nt
parameter_list|)
block|{
name|struct
name|timespec
name|t
decl_stmt|;
comment|/* WindowNT times are in 100 ns and from 1601 Jan 1 */
name|t
operator|.
name|tv_nsec
operator|=
operator|(
name|nt
operator|%
operator|(
literal|1000
operator|*
literal|1000
operator|*
literal|10
operator|)
operator|)
operator|*
literal|100
expr_stmt|;
name|t
operator|.
name|tv_sec
operator|=
name|nt
operator|/
operator|(
literal|1000
operator|*
literal|1000
operator|*
literal|10
operator|)
operator|-
literal|369LL
operator|*
literal|365LL
operator|*
literal|24LL
operator|*
literal|60LL
operator|*
literal|60LL
operator|-
literal|89LL
operator|*
literal|1LL
operator|*
literal|24LL
operator|*
literal|60LL
operator|*
literal|60LL
expr_stmt|;
return|return
operator|(
name|t
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ntfs_times
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|struct
name|ntnode
modifier|*
name|ip
parameter_list|,
name|ntfs_times_t
modifier|*
name|tm
parameter_list|)
block|{
name|struct
name|ntvattr
modifier|*
name|vap
decl_stmt|;
name|int
name|error
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_times: ino: %d...\n"
operator|,
name|ip
operator|->
name|i_number
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ntfs_ntvattrget
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|NTFS_A_NAME
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
operator|&
name|vap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
operator|*
name|tm
operator|=
name|vap
operator|->
name|va_a_name
operator|->
name|n_times
expr_stmt|;
name|ntfs_ntvattrrele
argument_list|(
name|vap
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ntfs_filesize
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|struct
name|ntnode
modifier|*
name|ip
parameter_list|,
name|u_int64_t
modifier|*
name|size
parameter_list|,
name|u_int64_t
modifier|*
name|bytes
parameter_list|)
block|{
name|struct
name|ntvattr
modifier|*
name|vap
decl_stmt|;
name|u_int64_t
name|sz
decl_stmt|,
name|bn
decl_stmt|;
name|int
name|error
decl_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_filesize: ino: %d\n"
operator|,
name|ip
operator|->
name|i_number
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ntfs_ntvattrget
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|ip
operator|->
name|i_defattr
argument_list|,
name|ip
operator|->
name|i_defattrname
argument_list|,
literal|0
argument_list|,
operator|&
name|vap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|bn
operator|=
name|vap
operator|->
name|va_allocated
expr_stmt|;
name|sz
operator|=
name|vap
operator|->
name|va_datalen
expr_stmt|;
name|dprintf
argument_list|(
operator|(
literal|"ntfs_filesize: %d bytes (%d bytes allocated)\n"
operator|,
operator|(
name|u_int32_t
operator|)
name|sz
operator|,
operator|(
name|u_int32_t
operator|)
name|bn
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
condition|)
operator|*
name|size
operator|=
name|sz
expr_stmt|;
if|if
condition|(
name|bytes
condition|)
operator|*
name|bytes
operator|=
name|bn
expr_stmt|;
name|ntfs_ntvattrrele
argument_list|(
name|vap
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ntfs_breadntvattr_plain
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|struct
name|ntnode
modifier|*
name|ip
parameter_list|,
name|struct
name|ntvattr
modifier|*
name|vap
parameter_list|,
name|off_t
name|roff
parameter_list|,
name|size_t
name|rsize
parameter_list|,
name|void
modifier|*
name|rdata
parameter_list|,
name|size_t
modifier|*
name|initp
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
name|int
name|off
decl_stmt|;
operator|*
name|initp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|vap
operator|->
name|va_flag
operator|&
name|NTFS_AF_INRUN
condition|)
block|{
name|int
name|cnt
decl_stmt|;
name|cn_t
name|ccn
decl_stmt|,
name|ccl
decl_stmt|,
name|cn
decl_stmt|,
name|left
decl_stmt|,
name|cl
decl_stmt|;
name|caddr_t
name|data
init|=
name|rdata
decl_stmt|;
name|struct
name|buf
modifier|*
name|bp
decl_stmt|;
name|size_t
name|tocopy
decl_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|"ntfs_breadntvattr_plain: data in run: %d chains\n"
operator|,
name|vap
operator|->
name|va_vruncnt
operator|)
argument_list|)
expr_stmt|;
name|off
operator|=
name|roff
expr_stmt|;
name|left
operator|=
name|rsize
expr_stmt|;
name|ccl
operator|=
literal|0
expr_stmt|;
name|ccn
operator|=
literal|0
expr_stmt|;
name|cnt
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|left
operator|&&
operator|(
name|cnt
operator|<
name|vap
operator|->
name|va_vruncnt
operator|)
condition|)
block|{
name|ccn
operator|=
name|vap
operator|->
name|va_vruncn
index|[
name|cnt
index|]
expr_stmt|;
name|ccl
operator|=
name|vap
operator|->
name|va_vruncl
index|[
name|cnt
index|]
expr_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|"ntfs_breadntvattr_plain: "
expr|\
literal|"left %d, cn: 0x%x, cl: %d, off: %d\n"
operator|,
expr|\
operator|(
name|u_int32_t
operator|)
name|left
operator|,
operator|(
name|u_int32_t
operator|)
name|ccn
operator|,
expr|\
operator|(
name|u_int32_t
operator|)
name|ccl
operator|,
operator|(
name|u_int32_t
operator|)
name|off
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ntfs_cntob
argument_list|(
name|ccl
argument_list|)
operator|<
name|off
condition|)
block|{
name|off
operator|-=
name|ntfs_cntob
argument_list|(
name|ccl
argument_list|)
expr_stmt|;
name|cnt
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|ccn
operator|||
name|ip
operator|->
name|i_number
operator|==
name|NTFS_BOOTINO
condition|)
block|{
comment|/* XXX */
name|ccl
operator|-=
name|ntfs_btocn
argument_list|(
name|off
argument_list|)
expr_stmt|;
name|cn
operator|=
name|ccn
operator|+
name|ntfs_btocn
argument_list|(
name|off
argument_list|)
expr_stmt|;
name|off
operator|=
name|ntfs_btocnoff
argument_list|(
name|off
argument_list|)
expr_stmt|;
while|while
condition|(
name|left
operator|&&
name|ccl
condition|)
block|{
name|tocopy
operator|=
name|min
argument_list|(
name|left
argument_list|,
name|min
argument_list|(
name|ntfs_cntob
argument_list|(
name|ccl
argument_list|)
operator|-
name|off
argument_list|,
name|MAXBSIZE
operator|-
name|off
argument_list|)
argument_list|)
expr_stmt|;
name|cl
operator|=
name|ntfs_btocl
argument_list|(
name|tocopy
operator|+
name|off
argument_list|)
expr_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|"ntfs_breadntvattr_plain: "
expr|\
literal|"read: cn: 0x%x cl: %d, "
expr|\
literal|"off: %d len: %d, left: %d\n"
operator|,
operator|(
name|u_int32_t
operator|)
name|cn
operator|,
operator|(
name|u_int32_t
operator|)
name|cl
operator|,
operator|(
name|u_int32_t
operator|)
name|off
operator|,
operator|(
name|u_int32_t
operator|)
name|tocopy
operator|,
operator|(
name|u_int32_t
operator|)
name|left
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|bread
argument_list|(
name|ntmp
operator|->
name|ntm_devvp
argument_list|,
name|ntfs_cntobn
argument_list|(
name|cn
argument_list|)
argument_list|,
name|ntfs_cntob
argument_list|(
name|cl
argument_list|)
argument_list|,
name|NOCRED
argument_list|,
operator|&
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|memcpy
argument_list|(
name|data
argument_list|,
name|bp
operator|->
name|b_data
operator|+
name|off
argument_list|,
name|tocopy
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bp
argument_list|)
expr_stmt|;
name|data
operator|=
name|data
operator|+
name|tocopy
expr_stmt|;
operator|*
name|initp
operator|+=
name|tocopy
expr_stmt|;
name|off
operator|=
literal|0
expr_stmt|;
name|left
operator|-=
name|tocopy
expr_stmt|;
name|cn
operator|+=
name|cl
expr_stmt|;
name|ccl
operator|-=
name|cl
expr_stmt|;
block|}
block|}
else|else
block|{
name|tocopy
operator|=
name|min
argument_list|(
name|left
argument_list|,
name|ntfs_cntob
argument_list|(
name|ccl
argument_list|)
operator|-
name|off
argument_list|)
expr_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|"ntfs_breadntvattr_plain: "
literal|"sparce: ccn: 0x%x ccl: %d, off: %d, "
expr|\
literal|" len: %d, left: %d\n"
operator|,
operator|(
name|u_int32_t
operator|)
name|ccn
operator|,
operator|(
name|u_int32_t
operator|)
name|ccl
operator|,
operator|(
name|u_int32_t
operator|)
name|off
operator|,
operator|(
name|u_int32_t
operator|)
name|tocopy
operator|,
operator|(
name|u_int32_t
operator|)
name|left
operator|)
argument_list|)
expr_stmt|;
name|left
operator|-=
name|tocopy
expr_stmt|;
name|off
operator|=
literal|0
expr_stmt|;
name|bzero
argument_list|(
name|data
argument_list|,
name|tocopy
argument_list|)
expr_stmt|;
name|data
operator|=
name|data
operator|+
name|tocopy
expr_stmt|;
block|}
name|cnt
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|left
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_breadntvattr_plain: POSSIBLE RUN ERROR\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|E2BIG
expr_stmt|;
block|}
block|}
else|else
block|{
name|ddprintf
argument_list|(
operator|(
literal|"ntfs_breadnvattr_plain: data is in mft record\n"
operator|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|rdata
argument_list|,
name|vap
operator|->
name|va_datap
operator|+
name|roff
argument_list|,
name|rsize
argument_list|)
expr_stmt|;
operator|*
name|initp
operator|+=
name|rsize
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ntfs_breadattr_plain
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|struct
name|ntnode
modifier|*
name|ip
parameter_list|,
name|u_int32_t
name|attrnum
parameter_list|,
name|char
modifier|*
name|attrname
parameter_list|,
name|off_t
name|roff
parameter_list|,
name|size_t
name|rsize
parameter_list|,
name|void
modifier|*
name|rdata
parameter_list|,
name|size_t
modifier|*
name|initp
parameter_list|)
block|{
name|size_t
name|init
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|off_t
name|off
init|=
name|roff
decl_stmt|,
name|left
init|=
name|rsize
decl_stmt|,
name|toread
decl_stmt|;
name|caddr_t
name|data
init|=
name|rdata
decl_stmt|;
name|struct
name|ntvattr
modifier|*
name|vap
decl_stmt|;
operator|*
name|initp
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|left
condition|)
block|{
name|error
operator|=
name|ntfs_ntvattrget
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|attrnum
argument_list|,
name|attrname
argument_list|,
name|ntfs_btocn
argument_list|(
name|off
argument_list|)
argument_list|,
operator|&
name|vap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|toread
operator|=
name|min
argument_list|(
name|left
argument_list|,
name|ntfs_cntob
argument_list|(
name|vap
operator|->
name|va_vcnend
operator|+
literal|1
argument_list|)
operator|-
name|off
argument_list|)
expr_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|"ntfs_breadattr_plain: o: %d, s: %d (%d - %d)\n"
operator|,
operator|(
name|u_int32_t
operator|)
name|off
operator|,
operator|(
name|u_int32_t
operator|)
name|toread
operator|,
operator|(
name|u_int32_t
operator|)
name|vap
operator|->
name|va_vcnstart
operator|,
operator|(
name|u_int32_t
operator|)
name|vap
operator|->
name|va_vcnend
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ntfs_breadntvattr_plain
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|vap
argument_list|,
name|off
operator|-
name|ntfs_cntob
argument_list|(
name|vap
operator|->
name|va_vcnstart
argument_list|)
argument_list|,
name|toread
argument_list|,
name|data
argument_list|,
operator|&
name|init
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_breadattr_plain: "
expr|\
literal|"ntfs_breadntvattr_plain failed: o: %d, s: %d\n"
argument_list|,
operator|(
name|u_int32_t
operator|)
name|off
argument_list|,
operator|(
name|u_int32_t
operator|)
name|toread
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ntfs_breadattr_plain: attrib: %d - %d\n"
argument_list|,
operator|(
name|u_int32_t
operator|)
name|vap
operator|->
name|va_vcnstart
argument_list|,
operator|(
name|u_int32_t
operator|)
name|vap
operator|->
name|va_vcnend
argument_list|)
expr_stmt|;
name|ntfs_ntvattrrele
argument_list|(
name|vap
argument_list|)
expr_stmt|;
break|break;
block|}
name|ntfs_ntvattrrele
argument_list|(
name|vap
argument_list|)
expr_stmt|;
name|left
operator|-=
name|toread
expr_stmt|;
name|off
operator|+=
name|toread
expr_stmt|;
name|data
operator|=
name|data
operator|+
name|toread
expr_stmt|;
operator|*
name|initp
operator|+=
name|init
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ntfs_breadattr
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|struct
name|ntnode
modifier|*
name|ip
parameter_list|,
name|u_int32_t
name|attrnum
parameter_list|,
name|char
modifier|*
name|attrname
parameter_list|,
name|off_t
name|roff
parameter_list|,
name|size_t
name|rsize
parameter_list|,
name|void
modifier|*
name|rdata
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
name|struct
name|ntvattr
modifier|*
name|vap
decl_stmt|;
name|size_t
name|init
decl_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|"ntfs_breadattr: reading %d: 0x%x, from %d size %d bytes\n"
operator|,
name|ip
operator|->
name|i_number
operator|,
name|attrnum
operator|,
operator|(
name|u_int32_t
operator|)
name|roff
operator|,
operator|(
name|u_int32_t
operator|)
name|rsize
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ntfs_ntvattrget
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|attrnum
argument_list|,
name|attrname
argument_list|,
literal|0
argument_list|,
operator|&
name|vap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
operator|(
name|roff
operator|>
name|vap
operator|->
name|va_datalen
operator|)
operator|||
operator|(
name|roff
operator|+
name|rsize
operator|>
name|vap
operator|->
name|va_datalen
operator|)
condition|)
block|{
name|ddprintf
argument_list|(
operator|(
literal|"ntfs_breadattr: offset too big\n"
operator|)
argument_list|)
expr_stmt|;
name|ntfs_ntvattrrele
argument_list|(
name|vap
argument_list|)
expr_stmt|;
return|return
operator|(
name|E2BIG
operator|)
return|;
block|}
if|if
condition|(
name|vap
operator|->
name|va_compression
operator|&&
name|vap
operator|->
name|va_compressalg
condition|)
block|{
name|u_int8_t
modifier|*
name|cup
decl_stmt|;
name|u_int8_t
modifier|*
name|uup
decl_stmt|;
name|off_t
name|off
init|=
name|roff
decl_stmt|,
name|left
init|=
name|rsize
decl_stmt|,
name|tocopy
decl_stmt|;
name|caddr_t
name|data
init|=
name|rdata
decl_stmt|;
name|cn_t
name|cn
decl_stmt|;
name|ddprintf
argument_list|(
operator|(
literal|"ntfs_ntreadattr: compression: %d\n"
operator|,
name|vap
operator|->
name|va_compressalg
operator|)
argument_list|)
expr_stmt|;
name|MALLOC
argument_list|(
name|cup
argument_list|,
name|u_int8_t
operator|*
argument_list|,
name|ntfs_cntob
argument_list|(
name|NTFS_COMPUNIT_CL
argument_list|)
argument_list|,
name|M_NTFSDECOMP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|MALLOC
argument_list|(
name|uup
argument_list|,
name|u_int8_t
operator|*
argument_list|,
name|ntfs_cntob
argument_list|(
name|NTFS_COMPUNIT_CL
argument_list|)
argument_list|,
name|M_NTFSDECOMP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|cn
operator|=
operator|(
name|ntfs_btocn
argument_list|(
name|roff
argument_list|)
operator|)
operator|&
operator|(
operator|~
operator|(
name|NTFS_COMPUNIT_CL
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
name|off
operator|=
name|roff
operator|-
name|ntfs_cntob
argument_list|(
name|cn
argument_list|)
expr_stmt|;
while|while
condition|(
name|left
condition|)
block|{
name|error
operator|=
name|ntfs_breadattr_plain
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|attrnum
argument_list|,
name|attrname
argument_list|,
name|ntfs_cntob
argument_list|(
name|cn
argument_list|)
argument_list|,
name|ntfs_cntob
argument_list|(
name|NTFS_COMPUNIT_CL
argument_list|)
argument_list|,
name|cup
argument_list|,
operator|&
name|init
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|tocopy
operator|=
name|min
argument_list|(
name|left
argument_list|,
name|ntfs_cntob
argument_list|(
name|NTFS_COMPUNIT_CL
argument_list|)
operator|-
name|off
argument_list|)
expr_stmt|;
if|if
condition|(
name|init
operator|==
name|ntfs_cntob
argument_list|(
name|NTFS_COMPUNIT_CL
argument_list|)
condition|)
block|{
name|memcpy
argument_list|(
name|data
argument_list|,
name|cup
operator|+
name|off
argument_list|,
name|tocopy
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|init
operator|==
literal|0
condition|)
block|{
name|bzero
argument_list|(
name|data
argument_list|,
name|tocopy
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|ntfs_uncompunit
argument_list|(
name|ntmp
argument_list|,
name|uup
argument_list|,
name|cup
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|memcpy
argument_list|(
name|data
argument_list|,
name|uup
operator|+
name|off
argument_list|,
name|tocopy
argument_list|)
expr_stmt|;
block|}
name|left
operator|-=
name|tocopy
expr_stmt|;
name|data
operator|=
name|data
operator|+
name|tocopy
expr_stmt|;
name|off
operator|+=
name|tocopy
operator|-
name|ntfs_cntob
argument_list|(
name|NTFS_COMPUNIT_CL
argument_list|)
expr_stmt|;
name|cn
operator|+=
name|NTFS_COMPUNIT_CL
expr_stmt|;
block|}
name|FREE
argument_list|(
name|uup
argument_list|,
name|M_NTFSDECOMP
argument_list|)
expr_stmt|;
name|FREE
argument_list|(
name|cup
argument_list|,
name|M_NTFSDECOMP
argument_list|)
expr_stmt|;
block|}
else|else
name|error
operator|=
name|ntfs_breadattr_plain
argument_list|(
name|ntmp
argument_list|,
name|ip
argument_list|,
name|attrnum
argument_list|,
name|attrname
argument_list|,
name|roff
argument_list|,
name|rsize
argument_list|,
name|rdata
argument_list|,
operator|&
name|init
argument_list|)
expr_stmt|;
name|ntfs_ntvattrrele
argument_list|(
name|vap
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ntfs_parserun
parameter_list|(
name|cn_t
modifier|*
name|cn
parameter_list|,
name|cn_t
modifier|*
name|cl
parameter_list|,
name|u_int8_t
modifier|*
name|run
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
modifier|*
name|off
parameter_list|)
block|{
name|u_int8_t
name|sz
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|NULL
operator|==
name|run
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_runtocn: run == NULL\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|sz
operator|=
name|run
index|[
operator|(
operator|*
name|off
operator|)
operator|++
index|]
expr_stmt|;
if|if
condition|(
literal|0
operator|==
name|sz
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_parserun: trying to go out of run\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|E2BIG
operator|)
return|;
block|}
operator|*
name|cl
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|sz
operator|&
literal|0xF
operator|)
operator|>
literal|8
operator|||
operator|(
operator|*
name|off
operator|)
operator|+
operator|(
name|sz
operator|&
literal|0xF
operator|)
operator|>
name|len
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_parserun: "
expr|\
literal|"bad run: length too big: %02x (%x< %x + sz)\n"
argument_list|,
name|sz
argument_list|,
name|len
argument_list|,
operator|*
name|off
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|sz
operator|&
literal|0xF
operator|)
condition|;
name|i
operator|++
control|)
operator|*
name|cl
operator|+=
operator|(
name|u_int32_t
operator|)
name|run
index|[
operator|(
operator|*
name|off
operator|)
operator|++
index|]
operator|<<
operator|(
name|i
operator|<<
literal|3
operator|)
expr_stmt|;
name|sz
operator|>>=
literal|4
expr_stmt|;
if|if
condition|(
operator|(
name|sz
operator|&
literal|0xF
operator|)
operator|>
literal|8
operator|||
operator|(
operator|*
name|off
operator|)
operator|+
operator|(
name|sz
operator|&
literal|0xF
operator|)
operator|>
name|len
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_parserun: "
expr|\
literal|"bad run: offset too big: %02x (%x< %x + sz)\n"
argument_list|,
name|sz
argument_list|,
name|len
argument_list|,
operator|*
name|off
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|sz
operator|&
literal|0xF
operator|)
condition|;
name|i
operator|++
control|)
operator|*
name|cn
operator|+=
operator|(
name|u_int32_t
operator|)
name|run
index|[
operator|(
operator|*
name|off
operator|)
operator|++
index|]
operator|<<
operator|(
name|i
operator|<<
literal|3
operator|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ntfs_procfixups
parameter_list|(
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|u_int32_t
name|magic
parameter_list|,
name|caddr_t
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|fixuphdr
modifier|*
name|fhp
init|=
operator|(
expr|struct
name|fixuphdr
operator|*
operator|)
name|buf
decl_stmt|;
name|int
name|i
decl_stmt|;
name|u_int16_t
name|fixup
decl_stmt|;
name|u_int16_t
modifier|*
name|fxp
decl_stmt|;
name|u_int16_t
modifier|*
name|cfxp
decl_stmt|;
if|if
condition|(
name|fhp
operator|->
name|fh_magic
operator|!=
name|magic
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_procfixups: magic doesn't match: %08x != %08x\n"
argument_list|,
name|fhp
operator|->
name|fh_magic
argument_list|,
name|magic
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|fhp
operator|->
name|fh_fnum
operator|-
literal|1
operator|)
operator|*
name|ntmp
operator|->
name|ntm_bps
operator|!=
name|len
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_procfixups: "
expr|\
literal|"bad fixups number: %d for %d bytes block\n"
argument_list|,
name|fhp
operator|->
name|fh_fnum
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|fhp
operator|->
name|fh_foff
operator|>=
name|ntmp
operator|->
name|ntm_spc
operator|*
name|ntmp
operator|->
name|ntm_mftrecsz
operator|*
name|ntmp
operator|->
name|ntm_bps
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_procfixups: invalid offset: %x"
argument_list|,
name|fhp
operator|->
name|fh_foff
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|fxp
operator|=
operator|(
name|u_int16_t
operator|*
operator|)
operator|(
name|buf
operator|+
name|fhp
operator|->
name|fh_foff
operator|)
expr_stmt|;
name|cfxp
operator|=
operator|(
name|u_int16_t
operator|*
operator|)
operator|(
name|buf
operator|+
name|ntmp
operator|->
name|ntm_bps
operator|-
literal|2
operator|)
expr_stmt|;
name|fixup
operator|=
operator|*
name|fxp
operator|++
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|fhp
operator|->
name|fh_fnum
condition|;
name|i
operator|++
operator|,
name|fxp
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|cfxp
operator|!=
name|fixup
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_procfixups: fixup %d doesn't match\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
operator|*
name|cfxp
operator|=
operator|*
name|fxp
expr_stmt|;
operator|(
operator|(
name|caddr_t
operator|)
name|cfxp
operator|)
operator|+=
name|ntmp
operator|->
name|ntm_bps
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|ntfs_runtocn
parameter_list|(
name|cn_t
modifier|*
name|cn
parameter_list|,
name|struct
name|ntfsmount
modifier|*
name|ntmp
parameter_list|,
name|u_int8_t
modifier|*
name|run
parameter_list|,
name|size_t
name|len
parameter_list|,
name|cn_t
name|vcn
parameter_list|)
block|{
name|cn_t
name|ccn
init|=
literal|0
decl_stmt|;
name|cn_t
name|ccl
init|=
literal|0
decl_stmt|;
name|int
name|off
init|=
literal|0
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
if|#
directive|if
name|NTFS_DEBUG
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"ntfs_runtocn: "
expr|\
literal|"run: 0x%p, %d bytes, vcn:%d\n"
argument_list|,
name|run
argument_list|,
name|len
argument_list|,
operator|(
name|u_int32_t
operator|)
name|vcn
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ntfs_runtocn: run: "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"0x%02x "
argument_list|,
name|run
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|NULL
operator|==
name|run
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_runtocn: run == NULL\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
do|do
block|{
if|if
condition|(
name|run
index|[
name|off
index|]
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_runtocn: vcn too big\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|E2BIG
operator|)
return|;
block|}
name|vcn
operator|-=
name|ccl
expr_stmt|;
name|error
operator|=
name|ntfs_parserun
argument_list|(
operator|&
name|ccn
argument_list|,
operator|&
name|ccl
argument_list|,
name|run
argument_list|,
name|len
argument_list|,
operator|&
name|off
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"ntfs_runtocn: ntfs_parserun failed\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
do|while
condition|(
name|ccl
operator|<=
name|vcn
condition|)
do|;
operator|*
name|cn
operator|=
name|ccn
operator|+
name|vcn
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


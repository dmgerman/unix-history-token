begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * SPDX-License-Identifier: BSD-3-Clause  *  * Copyright (c) 2008 Apple Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1.  Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  * 2.  Redistributions in binary form must reproduce the above copyright  *     notice, this list of conditions and the following disclaimer in the  *     documentation and/or other materials provided with the distribution.  * 3.  Neither the name of Apple Inc. ("Apple") nor the names of  *     its contributors may be used to endorse or promote products derived  *     from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS "AS IS" AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR  * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,  * STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING  * IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.   */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<security/audit/audit.h>
end_include

begin_include
include|#
directive|include
file|<bsm/audit_domain.h>
end_include

begin_include
include|#
directive|include
file|<bsm/audit_record.h>
end_include

begin_struct
struct|struct
name|bsm_domain
block|{
name|u_short
name|bd_bsm_domain
decl_stmt|;
name|int
name|bd_local_domain
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|PF_NO_LOCAL_MAPPING
value|-600
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|bsm_domain
name|bsm_domains
index|[]
init|=
block|{
block|{
name|BSM_PF_UNSPEC
block|,
name|PF_UNSPEC
block|}
block|,
block|{
name|BSM_PF_LOCAL
block|,
name|PF_LOCAL
block|}
block|,
block|{
name|BSM_PF_INET
block|,
name|PF_INET
block|}
block|,
block|{
name|BSM_PF_IMPLINK
block|,
ifdef|#
directive|ifdef
name|PF_IMPLINK
name|PF_IMPLINK
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_PUP
block|,
ifdef|#
directive|ifdef
name|PF_PUP
name|PF_PUP
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_CHAOS
block|,
ifdef|#
directive|ifdef
name|PF_CHAOS
name|PF_CHAOS
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_NS
block|,
ifdef|#
directive|ifdef
name|PF_NS
name|PF_NS
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_NBS
block|,
ifdef|#
directive|ifdef
name|PF_NBS
name|PF_NBS
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_ECMA
block|,
ifdef|#
directive|ifdef
name|PF_ECMA
name|PF_ECMA
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_DATAKIT
block|,
ifdef|#
directive|ifdef
name|PF_DATAKIT
name|PF_DATAKIT
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_CCITT
block|,
ifdef|#
directive|ifdef
name|PF_CCITT
name|PF_CCITT
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_SNA
block|,
name|PF_SNA
block|}
block|,
block|{
name|BSM_PF_DECnet
block|,
name|PF_DECnet
block|}
block|,
block|{
name|BSM_PF_DLI
block|,
ifdef|#
directive|ifdef
name|PF_DLI
name|PF_DLI
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_LAT
block|,
ifdef|#
directive|ifdef
name|PF_LAT
name|PF_LAT
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_HYLINK
block|,
ifdef|#
directive|ifdef
name|PF_HYLINK
name|PF_HYLINK
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_APPLETALK
block|,
name|PF_APPLETALK
block|}
block|,
block|{
name|BSM_PF_NIT
block|,
ifdef|#
directive|ifdef
name|PF_NIT
name|PF_NIT
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_802
block|,
ifdef|#
directive|ifdef
name|PF_802
name|PF_802
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_OSI
block|,
ifdef|#
directive|ifdef
name|PF_OSI
name|PF_OSI
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_X25
block|,
ifdef|#
directive|ifdef
name|PF_X25
name|PF_X25
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_OSINET
block|,
ifdef|#
directive|ifdef
name|PF_OSINET
name|PF_OSINET
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_GOSIP
block|,
ifdef|#
directive|ifdef
name|PF_GOSIP
name|PF_GOSIP
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_IPX
block|,
name|PF_IPX
block|}
block|,
block|{
name|BSM_PF_ROUTE
block|,
name|PF_ROUTE
block|}
block|,
block|{
name|BSM_PF_LINK
block|,
ifdef|#
directive|ifdef
name|PF_LINK
name|PF_LINK
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_INET6
block|,
name|PF_INET6
block|}
block|,
block|{
name|BSM_PF_KEY
block|,
name|PF_KEY
block|}
block|,
block|{
name|BSM_PF_NCA
block|,
ifdef|#
directive|ifdef
name|PF_NCA
name|PF_NCA
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_POLICY
block|,
ifdef|#
directive|ifdef
name|PF_POLICY
name|PF_POLICY
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_INET_OFFLOAD
block|,
ifdef|#
directive|ifdef
name|PF_INET_OFFLOAD
name|PF_INET_OFFLOAD
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_NETBIOS
block|,
ifdef|#
directive|ifdef
name|PF_NETBIOS
name|PF_NETBIOS
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_ISO
block|,
ifdef|#
directive|ifdef
name|PF_ISO
name|PF_ISO
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_XTP
block|,
ifdef|#
directive|ifdef
name|PF_XTP
name|PF_XTP
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_COIP
block|,
ifdef|#
directive|ifdef
name|PF_COIP
name|PF_COIP
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_CNT
block|,
ifdef|#
directive|ifdef
name|PF_CNT
name|PF_CNT
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_RTIP
block|,
ifdef|#
directive|ifdef
name|PF_RTIP
name|PF_RTIP
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_SIP
block|,
ifdef|#
directive|ifdef
name|PF_SIP
name|PF_SIP
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_PIP
block|,
ifdef|#
directive|ifdef
name|PF_PIP
name|PF_PIP
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_ISDN
block|,
ifdef|#
directive|ifdef
name|PF_ISDN
name|PF_ISDN
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_E164
block|,
ifdef|#
directive|ifdef
name|PF_E164
name|PF_E164
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_NATM
block|,
ifdef|#
directive|ifdef
name|PF_NATM
name|PF_NATM
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_ATM
block|,
ifdef|#
directive|ifdef
name|PF_ATM
name|PF_ATM
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_NETGRAPH
block|,
ifdef|#
directive|ifdef
name|PF_NETGRAPH
name|PF_NETGRAPH
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_SLOW
block|,
ifdef|#
directive|ifdef
name|PF_SLOW
name|PF_SLOW
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_SCLUSTER
block|,
ifdef|#
directive|ifdef
name|PF_SCLUSTER
name|PF_SCLUSTER
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_ARP
block|,
ifdef|#
directive|ifdef
name|PF_ARP
name|PF_ARP
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_BLUETOOTH
block|,
ifdef|#
directive|ifdef
name|PF_BLUETOOTH
name|PF_BLUETOOTH
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_AX25
block|,
ifdef|#
directive|ifdef
name|PF_AX25
name|PF_AX25
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_ROSE
block|,
ifdef|#
directive|ifdef
name|PF_ROSE
name|PF_ROSE
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_NETBEUI
block|,
ifdef|#
directive|ifdef
name|PF_NETBEUI
name|PF_NETBEUI
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_SECURITY
block|,
ifdef|#
directive|ifdef
name|PF_SECURITY
name|PF_SECURITY
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_PACKET
block|,
ifdef|#
directive|ifdef
name|PF_PACKET
name|PF_PACKET
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_ASH
block|,
ifdef|#
directive|ifdef
name|PF_ASH
name|PF_ASH
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_ECONET
block|,
ifdef|#
directive|ifdef
name|PF_ECONET
name|PF_ECONET
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_ATMSVC
block|,
ifdef|#
directive|ifdef
name|PF_ATMSVC
name|PF_ATMSVC
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_IRDA
block|,
ifdef|#
directive|ifdef
name|PF_IRDA
name|PF_IRDA
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_PPPOX
block|,
ifdef|#
directive|ifdef
name|PF_PPPOX
name|PF_PPPOX
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_WANPIPE
block|,
ifdef|#
directive|ifdef
name|PF_WANPIPE
name|PF_WANPIPE
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_LLC
block|,
ifdef|#
directive|ifdef
name|PF_LLC
name|PF_LLC
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_CAN
block|,
ifdef|#
directive|ifdef
name|PF_CAN
name|PF_CAN
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_TIPC
block|,
ifdef|#
directive|ifdef
name|PF_TIPC
name|PF_TIPC
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_IUCV
block|,
ifdef|#
directive|ifdef
name|PF_IUCV
name|PF_IUCV
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_RXRPC
block|,
ifdef|#
directive|ifdef
name|PF_RXRPC
name|PF_RXRPC
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|,
block|{
name|BSM_PF_PHONET
block|,
ifdef|#
directive|ifdef
name|PF_PHONET
name|PF_PHONET
else|#
directive|else
name|PF_NO_LOCAL_MAPPING
endif|#
directive|endif
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|int
name|bsm_domains_count
init|=
sizeof|sizeof
argument_list|(
name|bsm_domains
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|bsm_domains
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
specifier|const
name|struct
name|bsm_domain
modifier|*
name|bsm_lookup_local_domain
parameter_list|(
name|int
name|local_domain
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|bsm_domains_count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|bsm_domains
index|[
name|i
index|]
operator|.
name|bd_local_domain
operator|==
name|local_domain
condition|)
return|return
operator|(
operator|&
name|bsm_domains
index|[
name|i
index|]
operator|)
return|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
name|u_short
name|au_domain_to_bsm
parameter_list|(
name|int
name|local_domain
parameter_list|)
block|{
specifier|const
name|struct
name|bsm_domain
modifier|*
name|bstp
decl_stmt|;
name|bstp
operator|=
name|bsm_lookup_local_domain
argument_list|(
name|local_domain
argument_list|)
expr_stmt|;
if|if
condition|(
name|bstp
operator|==
name|NULL
condition|)
return|return
operator|(
name|BSM_PF_UNKNOWN
operator|)
return|;
return|return
operator|(
name|bstp
operator|->
name|bd_bsm_domain
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|struct
name|bsm_domain
modifier|*
name|bsm_lookup_bsm_domain
parameter_list|(
name|u_short
name|bsm_domain
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|bsm_domains_count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|bsm_domains
index|[
name|i
index|]
operator|.
name|bd_bsm_domain
operator|==
name|bsm_domain
condition|)
return|return
operator|(
operator|&
name|bsm_domains
index|[
name|i
index|]
operator|)
return|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
name|int
name|au_bsm_to_domain
parameter_list|(
name|u_short
name|bsm_domain
parameter_list|,
name|int
modifier|*
name|local_domainp
parameter_list|)
block|{
specifier|const
name|struct
name|bsm_domain
modifier|*
name|bstp
decl_stmt|;
name|bstp
operator|=
name|bsm_lookup_bsm_domain
argument_list|(
name|bsm_domain
argument_list|)
expr_stmt|;
if|if
condition|(
name|bstp
operator|==
name|NULL
operator|||
name|bstp
operator|->
name|bd_local_domain
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
operator|*
name|local_domainp
operator|=
name|bstp
operator|->
name|bd_local_domain
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1999-2002, 2007-2008 Robert N. M. Watson  * Copyright (c) 2001-2005 Networks Associates Technology, Inc.  * Copyright (c) 2006 SPARTA, Inc.  * All rights reserved.  *  * This software was developed by Robert Watson for the TrustedBSD Project.  *  * This software was developed for the FreeBSD Project in part by NAI Labs,  * the Security Research Division of Network Associates, Inc. under  * DARPA/SPAWAR contract N66001-01-C-8035 ("CBOSS"), as part of the DARPA  * CHATS research program.  *  * This software was enhanced by SPARTA ISSO under SPAWAR contract  * N66001-04-C-6019 ("SEFOS").  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_comment
comment|/*  * Developed by the TrustedBSD Project.  *  * Low-watermark floating label mandatory integrity policy.  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/acl.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/extattr.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/mman.h>
end_include

begin_include
include|#
directive|include
file|<sys/mount.h>
end_include

begin_include
include|#
directive|include
file|<sys/priv.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/sbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysproto.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysent.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/vnode.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/socketvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/sx.h>
end_include

begin_include
include|#
directive|include
file|<sys/pipe.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/syslog.h>
end_include

begin_include
include|#
directive|include
file|<fs/devfs/devfs.h>
end_include

begin_include
include|#
directive|include
file|<net/bpfdesc.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_pcb.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip_var.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<security/mac/mac_policy.h>
end_include

begin_include
include|#
directive|include
file|<security/mac/mac_framework.h>
end_include

begin_include
include|#
directive|include
file|<security/mac_lomac/mac_lomac.h>
end_include

begin_struct
struct|struct
name|mac_lomac_proc
block|{
name|struct
name|mac_lomac
name|mac_lomac
decl_stmt|;
name|struct
name|mtx
name|mtx
decl_stmt|;
block|}
struct|;
end_struct

begin_expr_stmt
name|SYSCTL_DECL
argument_list|(
name|_security_mac
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_NODE
argument_list|(
name|_security_mac
argument_list|,
name|OID_AUTO
argument_list|,
name|lomac
argument_list|,
name|CTLFLAG_RW
argument_list|,
literal|0
argument_list|,
literal|"TrustedBSD mac_lomac policy controls"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|lomac_label_size
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|mac_lomac
argument_list|)
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_security_mac_lomac
argument_list|,
name|OID_AUTO
argument_list|,
name|label_size
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|lomac_label_size
argument_list|,
literal|0
argument_list|,
literal|"Size of struct mac_lomac"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|lomac_enabled
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_security_mac_lomac
argument_list|,
name|OID_AUTO
argument_list|,
name|enabled
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|lomac_enabled
argument_list|,
literal|0
argument_list|,
literal|"Enforce MAC/LOMAC policy"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"security.mac.lomac.enabled"
argument_list|,
operator|&
name|lomac_enabled
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|destroyed_not_inited
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_security_mac_lomac
argument_list|,
name|OID_AUTO
argument_list|,
name|destroyed_not_inited
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|destroyed_not_inited
argument_list|,
literal|0
argument_list|,
literal|"Count of labels destroyed but not inited"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|trust_all_interfaces
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_security_mac_lomac
argument_list|,
name|OID_AUTO
argument_list|,
name|trust_all_interfaces
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|trust_all_interfaces
argument_list|,
literal|0
argument_list|,
literal|"Consider all interfaces 'trusted' by MAC/LOMAC"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"security.mac.lomac.trust_all_interfaces"
argument_list|,
operator|&
name|trust_all_interfaces
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|char
name|trusted_interfaces
index|[
literal|128
index|]
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_STRING
argument_list|(
name|_security_mac_lomac
argument_list|,
name|OID_AUTO
argument_list|,
name|trusted_interfaces
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|trusted_interfaces
argument_list|,
literal|0
argument_list|,
literal|"Interfaces considered 'trusted' by MAC/LOMAC"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_STR
argument_list|(
literal|"security.mac.lomac.trusted_interfaces"
argument_list|,
name|trusted_interfaces
argument_list|,
sizeof|sizeof
argument_list|(
name|trusted_interfaces
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|ptys_equal
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_security_mac_lomac
argument_list|,
name|OID_AUTO
argument_list|,
name|ptys_equal
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|ptys_equal
argument_list|,
literal|0
argument_list|,
literal|"Label pty devices as lomac/equal on create"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"security.mac.lomac.ptys_equal"
argument_list|,
operator|&
name|ptys_equal
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|revocation_enabled
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_security_mac_lomac
argument_list|,
name|OID_AUTO
argument_list|,
name|revocation_enabled
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|revocation_enabled
argument_list|,
literal|0
argument_list|,
literal|"Revoke access to objects on relabel"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"security.mac.lomac.revocation_enabled"
argument_list|,
operator|&
name|revocation_enabled
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|lomac_slot
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|SLOT
parameter_list|(
name|l
parameter_list|)
value|((struct mac_lomac *)mac_label_get((l), lomac_slot))
end_define

begin_define
define|#
directive|define
name|SLOT_SET
parameter_list|(
name|l
parameter_list|,
name|val
parameter_list|)
value|mac_label_set((l), lomac_slot, (uintptr_t)(val))
end_define

begin_define
define|#
directive|define
name|PSLOT
parameter_list|(
name|l
parameter_list|)
value|((struct mac_lomac_proc *)				\     mac_label_get((l), lomac_slot))
end_define

begin_define
define|#
directive|define
name|PSLOT_SET
parameter_list|(
name|l
parameter_list|,
name|val
parameter_list|)
value|mac_label_set((l), lomac_slot, (uintptr_t)(val))
end_define

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_LOMAC
argument_list|,
literal|"mac_lomac_label"
argument_list|,
literal|"MAC/LOMAC labels"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|struct
name|mac_lomac
modifier|*
name|lomac_alloc
parameter_list|(
name|int
name|flag
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|ml
decl_stmt|;
name|ml
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ml
argument_list|)
argument_list|,
name|M_LOMAC
argument_list|,
name|M_ZERO
operator||
name|flag
argument_list|)
expr_stmt|;
return|return
operator|(
name|ml
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_free
parameter_list|(
name|struct
name|mac_lomac
modifier|*
name|ml
parameter_list|)
block|{
if|if
condition|(
name|ml
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|ml
argument_list|,
name|M_LOMAC
argument_list|)
expr_stmt|;
else|else
name|atomic_add_int
argument_list|(
operator|&
name|destroyed_not_inited
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_atmostflags
parameter_list|(
name|struct
name|mac_lomac
modifier|*
name|ml
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
if|if
condition|(
operator|(
name|ml
operator|->
name|ml_flags
operator|&
name|flags
operator|)
operator|!=
name|ml
operator|->
name|ml_flags
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_dominate_element
parameter_list|(
name|struct
name|mac_lomac_element
modifier|*
name|a
parameter_list|,
name|struct
name|mac_lomac_element
modifier|*
name|b
parameter_list|)
block|{
switch|switch
condition|(
name|a
operator|->
name|mle_type
condition|)
block|{
case|case
name|MAC_LOMAC_TYPE_EQUAL
case|:
case|case
name|MAC_LOMAC_TYPE_HIGH
case|:
return|return
operator|(
literal|1
operator|)
return|;
case|case
name|MAC_LOMAC_TYPE_LOW
case|:
switch|switch
condition|(
name|b
operator|->
name|mle_type
condition|)
block|{
case|case
name|MAC_LOMAC_TYPE_GRADE
case|:
case|case
name|MAC_LOMAC_TYPE_HIGH
case|:
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|MAC_LOMAC_TYPE_EQUAL
case|:
case|case
name|MAC_LOMAC_TYPE_LOW
case|:
return|return
operator|(
literal|1
operator|)
return|;
default|default:
name|panic
argument_list|(
literal|"lomac_dominate_element: b->mle_type invalid"
argument_list|)
expr_stmt|;
block|}
case|case
name|MAC_LOMAC_TYPE_GRADE
case|:
switch|switch
condition|(
name|b
operator|->
name|mle_type
condition|)
block|{
case|case
name|MAC_LOMAC_TYPE_EQUAL
case|:
case|case
name|MAC_LOMAC_TYPE_LOW
case|:
return|return
operator|(
literal|1
operator|)
return|;
case|case
name|MAC_LOMAC_TYPE_HIGH
case|:
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|MAC_LOMAC_TYPE_GRADE
case|:
return|return
operator|(
name|a
operator|->
name|mle_grade
operator|>=
name|b
operator|->
name|mle_grade
operator|)
return|;
default|default:
name|panic
argument_list|(
literal|"lomac_dominate_element: b->mle_type invalid"
argument_list|)
expr_stmt|;
block|}
default|default:
name|panic
argument_list|(
literal|"lomac_dominate_element: a->mle_type invalid"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_range_in_range
parameter_list|(
name|struct
name|mac_lomac
modifier|*
name|rangea
parameter_list|,
name|struct
name|mac_lomac
modifier|*
name|rangeb
parameter_list|)
block|{
return|return
operator|(
name|lomac_dominate_element
argument_list|(
operator|&
name|rangeb
operator|->
name|ml_rangehigh
argument_list|,
operator|&
name|rangea
operator|->
name|ml_rangehigh
argument_list|)
operator|&&
name|lomac_dominate_element
argument_list|(
operator|&
name|rangea
operator|->
name|ml_rangelow
argument_list|,
operator|&
name|rangeb
operator|->
name|ml_rangelow
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_single_in_range
parameter_list|(
name|struct
name|mac_lomac
modifier|*
name|single
parameter_list|,
name|struct
name|mac_lomac
modifier|*
name|range
parameter_list|)
block|{
name|KASSERT
argument_list|(
operator|(
name|single
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_SINGLE
operator|)
operator|!=
literal|0
argument_list|,
operator|(
literal|"lomac_single_in_range: a not single"
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|range
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_RANGE
operator|)
operator|!=
literal|0
argument_list|,
operator|(
literal|"lomac_single_in_range: b not range"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|lomac_dominate_element
argument_list|(
operator|&
name|range
operator|->
name|ml_rangehigh
argument_list|,
operator|&
name|single
operator|->
name|ml_single
argument_list|)
operator|&&
name|lomac_dominate_element
argument_list|(
operator|&
name|single
operator|->
name|ml_single
argument_list|,
operator|&
name|range
operator|->
name|ml_rangelow
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_auxsingle_in_range
parameter_list|(
name|struct
name|mac_lomac
modifier|*
name|single
parameter_list|,
name|struct
name|mac_lomac
modifier|*
name|range
parameter_list|)
block|{
name|KASSERT
argument_list|(
operator|(
name|single
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_AUX
operator|)
operator|!=
literal|0
argument_list|,
operator|(
literal|"lomac_single_in_range: a not auxsingle"
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|range
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_RANGE
operator|)
operator|!=
literal|0
argument_list|,
operator|(
literal|"lomac_single_in_range: b not range"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|lomac_dominate_element
argument_list|(
operator|&
name|range
operator|->
name|ml_rangehigh
argument_list|,
operator|&
name|single
operator|->
name|ml_auxsingle
argument_list|)
operator|&&
name|lomac_dominate_element
argument_list|(
operator|&
name|single
operator|->
name|ml_auxsingle
argument_list|,
operator|&
name|range
operator|->
name|ml_rangelow
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_dominate_single
parameter_list|(
name|struct
name|mac_lomac
modifier|*
name|a
parameter_list|,
name|struct
name|mac_lomac
modifier|*
name|b
parameter_list|)
block|{
name|KASSERT
argument_list|(
operator|(
name|a
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_SINGLE
operator|)
operator|!=
literal|0
argument_list|,
operator|(
literal|"lomac_dominate_single: a not single"
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|b
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_SINGLE
operator|)
operator|!=
literal|0
argument_list|,
operator|(
literal|"lomac_dominate_single: b not single"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|lomac_dominate_element
argument_list|(
operator|&
name|a
operator|->
name|ml_single
argument_list|,
operator|&
name|b
operator|->
name|ml_single
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_subject_dominate
parameter_list|(
name|struct
name|mac_lomac
modifier|*
name|a
parameter_list|,
name|struct
name|mac_lomac
modifier|*
name|b
parameter_list|)
block|{
name|KASSERT
argument_list|(
operator|(
operator|~
name|a
operator|->
name|ml_flags
operator|&
operator|(
name|MAC_LOMAC_FLAG_SINGLE
operator||
name|MAC_LOMAC_FLAG_RANGE
operator|)
operator|)
operator|==
literal|0
argument_list|,
operator|(
literal|"lomac_dominate_single: a not subject"
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|b
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_SINGLE
operator|)
operator|!=
literal|0
argument_list|,
operator|(
literal|"lomac_dominate_single: b not single"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|lomac_dominate_element
argument_list|(
operator|&
name|a
operator|->
name|ml_rangehigh
argument_list|,
operator|&
name|b
operator|->
name|ml_single
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_equal_element
parameter_list|(
name|struct
name|mac_lomac_element
modifier|*
name|a
parameter_list|,
name|struct
name|mac_lomac_element
modifier|*
name|b
parameter_list|)
block|{
if|if
condition|(
name|a
operator|->
name|mle_type
operator|==
name|MAC_LOMAC_TYPE_EQUAL
operator|||
name|b
operator|->
name|mle_type
operator|==
name|MAC_LOMAC_TYPE_EQUAL
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
name|a
operator|->
name|mle_type
operator|==
name|b
operator|->
name|mle_type
operator|&&
name|a
operator|->
name|mle_grade
operator|==
name|b
operator|->
name|mle_grade
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_equal_single
parameter_list|(
name|struct
name|mac_lomac
modifier|*
name|a
parameter_list|,
name|struct
name|mac_lomac
modifier|*
name|b
parameter_list|)
block|{
name|KASSERT
argument_list|(
operator|(
name|a
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_SINGLE
operator|)
operator|!=
literal|0
argument_list|,
operator|(
literal|"lomac_equal_single: a not single"
operator|)
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|b
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_SINGLE
operator|)
operator|!=
literal|0
argument_list|,
operator|(
literal|"lomac_equal_single: b not single"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|lomac_equal_element
argument_list|(
operator|&
name|a
operator|->
name|ml_single
argument_list|,
operator|&
name|b
operator|->
name|ml_single
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_contains_equal
parameter_list|(
name|struct
name|mac_lomac
modifier|*
name|ml
parameter_list|)
block|{
if|if
condition|(
name|ml
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_SINGLE
condition|)
if|if
condition|(
name|ml
operator|->
name|ml_single
operator|.
name|mle_type
operator|==
name|MAC_LOMAC_TYPE_EQUAL
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|ml
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_AUX
condition|)
if|if
condition|(
name|ml
operator|->
name|ml_auxsingle
operator|.
name|mle_type
operator|==
name|MAC_LOMAC_TYPE_EQUAL
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|ml
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_RANGE
condition|)
block|{
if|if
condition|(
name|ml
operator|->
name|ml_rangelow
operator|.
name|mle_type
operator|==
name|MAC_LOMAC_TYPE_EQUAL
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|ml
operator|->
name|ml_rangehigh
operator|.
name|mle_type
operator|==
name|MAC_LOMAC_TYPE_EQUAL
condition|)
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_subject_privileged
parameter_list|(
name|struct
name|mac_lomac
modifier|*
name|ml
parameter_list|)
block|{
name|KASSERT
argument_list|(
operator|(
name|ml
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAGS_BOTH
operator|)
operator|==
name|MAC_LOMAC_FLAGS_BOTH
argument_list|,
operator|(
literal|"lomac_subject_privileged: subject doesn't have both labels"
operator|)
argument_list|)
expr_stmt|;
comment|/* If the single is EQUAL, it's ok. */
if|if
condition|(
name|ml
operator|->
name|ml_single
operator|.
name|mle_type
operator|==
name|MAC_LOMAC_TYPE_EQUAL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* If either range endpoint is EQUAL, it's ok. */
if|if
condition|(
name|ml
operator|->
name|ml_rangelow
operator|.
name|mle_type
operator|==
name|MAC_LOMAC_TYPE_EQUAL
operator|||
name|ml
operator|->
name|ml_rangehigh
operator|.
name|mle_type
operator|==
name|MAC_LOMAC_TYPE_EQUAL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* If the range is low-high, it's ok. */
if|if
condition|(
name|ml
operator|->
name|ml_rangelow
operator|.
name|mle_type
operator|==
name|MAC_LOMAC_TYPE_LOW
operator|&&
name|ml
operator|->
name|ml_rangehigh
operator|.
name|mle_type
operator|==
name|MAC_LOMAC_TYPE_HIGH
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* It's not ok. */
return|return
operator|(
name|EPERM
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_high_single
parameter_list|(
name|struct
name|mac_lomac
modifier|*
name|ml
parameter_list|)
block|{
name|KASSERT
argument_list|(
operator|(
name|ml
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_SINGLE
operator|)
operator|!=
literal|0
argument_list|,
operator|(
literal|"lomac_high_single: mac_lomac not single"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|ml
operator|->
name|ml_single
operator|.
name|mle_type
operator|==
name|MAC_LOMAC_TYPE_HIGH
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_valid
parameter_list|(
name|struct
name|mac_lomac
modifier|*
name|ml
parameter_list|)
block|{
if|if
condition|(
name|ml
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_SINGLE
condition|)
block|{
switch|switch
condition|(
name|ml
operator|->
name|ml_single
operator|.
name|mle_type
condition|)
block|{
case|case
name|MAC_LOMAC_TYPE_GRADE
case|:
case|case
name|MAC_LOMAC_TYPE_EQUAL
case|:
case|case
name|MAC_LOMAC_TYPE_HIGH
case|:
case|case
name|MAC_LOMAC_TYPE_LOW
case|:
break|break;
default|default:
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|ml
operator|->
name|ml_single
operator|.
name|mle_type
operator|!=
name|MAC_LOMAC_TYPE_UNDEF
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|ml
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_AUX
condition|)
block|{
switch|switch
condition|(
name|ml
operator|->
name|ml_auxsingle
operator|.
name|mle_type
condition|)
block|{
case|case
name|MAC_LOMAC_TYPE_GRADE
case|:
case|case
name|MAC_LOMAC_TYPE_EQUAL
case|:
case|case
name|MAC_LOMAC_TYPE_HIGH
case|:
case|case
name|MAC_LOMAC_TYPE_LOW
case|:
break|break;
default|default:
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|ml
operator|->
name|ml_auxsingle
operator|.
name|mle_type
operator|!=
name|MAC_LOMAC_TYPE_UNDEF
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|ml
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_RANGE
condition|)
block|{
switch|switch
condition|(
name|ml
operator|->
name|ml_rangelow
operator|.
name|mle_type
condition|)
block|{
case|case
name|MAC_LOMAC_TYPE_GRADE
case|:
case|case
name|MAC_LOMAC_TYPE_EQUAL
case|:
case|case
name|MAC_LOMAC_TYPE_HIGH
case|:
case|case
name|MAC_LOMAC_TYPE_LOW
case|:
break|break;
default|default:
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
switch|switch
condition|(
name|ml
operator|->
name|ml_rangehigh
operator|.
name|mle_type
condition|)
block|{
case|case
name|MAC_LOMAC_TYPE_GRADE
case|:
case|case
name|MAC_LOMAC_TYPE_EQUAL
case|:
case|case
name|MAC_LOMAC_TYPE_HIGH
case|:
case|case
name|MAC_LOMAC_TYPE_LOW
case|:
break|break;
default|default:
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|lomac_dominate_element
argument_list|(
operator|&
name|ml
operator|->
name|ml_rangehigh
argument_list|,
operator|&
name|ml
operator|->
name|ml_rangelow
argument_list|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|ml
operator|->
name|ml_rangelow
operator|.
name|mle_type
operator|!=
name|MAC_LOMAC_TYPE_UNDEF
operator|||
name|ml
operator|->
name|ml_rangehigh
operator|.
name|mle_type
operator|!=
name|MAC_LOMAC_TYPE_UNDEF
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_set_range
parameter_list|(
name|struct
name|mac_lomac
modifier|*
name|ml
parameter_list|,
name|u_short
name|typelow
parameter_list|,
name|u_short
name|gradelow
parameter_list|,
name|u_short
name|typehigh
parameter_list|,
name|u_short
name|gradehigh
parameter_list|)
block|{
name|ml
operator|->
name|ml_rangelow
operator|.
name|mle_type
operator|=
name|typelow
expr_stmt|;
name|ml
operator|->
name|ml_rangelow
operator|.
name|mle_grade
operator|=
name|gradelow
expr_stmt|;
name|ml
operator|->
name|ml_rangehigh
operator|.
name|mle_type
operator|=
name|typehigh
expr_stmt|;
name|ml
operator|->
name|ml_rangehigh
operator|.
name|mle_grade
operator|=
name|gradehigh
expr_stmt|;
name|ml
operator|->
name|ml_flags
operator||=
name|MAC_LOMAC_FLAG_RANGE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_set_single
parameter_list|(
name|struct
name|mac_lomac
modifier|*
name|ml
parameter_list|,
name|u_short
name|type
parameter_list|,
name|u_short
name|grade
parameter_list|)
block|{
name|ml
operator|->
name|ml_single
operator|.
name|mle_type
operator|=
name|type
expr_stmt|;
name|ml
operator|->
name|ml_single
operator|.
name|mle_grade
operator|=
name|grade
expr_stmt|;
name|ml
operator|->
name|ml_flags
operator||=
name|MAC_LOMAC_FLAG_SINGLE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_copy_range
parameter_list|(
name|struct
name|mac_lomac
modifier|*
name|labelfrom
parameter_list|,
name|struct
name|mac_lomac
modifier|*
name|labelto
parameter_list|)
block|{
name|KASSERT
argument_list|(
operator|(
name|labelfrom
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_RANGE
operator|)
operator|!=
literal|0
argument_list|,
operator|(
literal|"lomac_copy_range: labelfrom not range"
operator|)
argument_list|)
expr_stmt|;
name|labelto
operator|->
name|ml_rangelow
operator|=
name|labelfrom
operator|->
name|ml_rangelow
expr_stmt|;
name|labelto
operator|->
name|ml_rangehigh
operator|=
name|labelfrom
operator|->
name|ml_rangehigh
expr_stmt|;
name|labelto
operator|->
name|ml_flags
operator||=
name|MAC_LOMAC_FLAG_RANGE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_copy_single
parameter_list|(
name|struct
name|mac_lomac
modifier|*
name|labelfrom
parameter_list|,
name|struct
name|mac_lomac
modifier|*
name|labelto
parameter_list|)
block|{
name|KASSERT
argument_list|(
operator|(
name|labelfrom
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_SINGLE
operator|)
operator|!=
literal|0
argument_list|,
operator|(
literal|"lomac_copy_single: labelfrom not single"
operator|)
argument_list|)
expr_stmt|;
name|labelto
operator|->
name|ml_single
operator|=
name|labelfrom
operator|->
name|ml_single
expr_stmt|;
name|labelto
operator|->
name|ml_flags
operator||=
name|MAC_LOMAC_FLAG_SINGLE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_copy_auxsingle
parameter_list|(
name|struct
name|mac_lomac
modifier|*
name|labelfrom
parameter_list|,
name|struct
name|mac_lomac
modifier|*
name|labelto
parameter_list|)
block|{
name|KASSERT
argument_list|(
operator|(
name|labelfrom
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_AUX
operator|)
operator|!=
literal|0
argument_list|,
operator|(
literal|"lomac_copy_auxsingle: labelfrom not auxsingle"
operator|)
argument_list|)
expr_stmt|;
name|labelto
operator|->
name|ml_auxsingle
operator|=
name|labelfrom
operator|->
name|ml_auxsingle
expr_stmt|;
name|labelto
operator|->
name|ml_flags
operator||=
name|MAC_LOMAC_FLAG_AUX
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_copy
parameter_list|(
name|struct
name|mac_lomac
modifier|*
name|source
parameter_list|,
name|struct
name|mac_lomac
modifier|*
name|dest
parameter_list|)
block|{
if|if
condition|(
name|source
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_SINGLE
condition|)
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
if|if
condition|(
name|source
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_AUX
condition|)
name|lomac_copy_auxsingle
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
if|if
condition|(
name|source
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_RANGE
condition|)
name|lomac_copy_range
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function_decl
specifier|static
name|int
name|lomac_to_string
parameter_list|(
name|struct
name|sbuf
modifier|*
name|sb
parameter_list|,
name|struct
name|mac_lomac
modifier|*
name|ml
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|maybe_demote
parameter_list|(
name|struct
name|mac_lomac
modifier|*
name|subjlabel
parameter_list|,
name|struct
name|mac_lomac
modifier|*
name|objlabel
parameter_list|,
specifier|const
name|char
modifier|*
name|actionname
parameter_list|,
specifier|const
name|char
modifier|*
name|objname
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|)
block|{
name|struct
name|sbuf
name|subjlabel_sb
decl_stmt|,
name|subjtext_sb
decl_stmt|,
name|objlabel_sb
decl_stmt|;
name|char
modifier|*
name|subjlabeltext
decl_stmt|,
modifier|*
name|objlabeltext
decl_stmt|,
modifier|*
name|subjtext
decl_stmt|;
name|struct
name|mac_lomac
name|cached_subjlabel
decl_stmt|;
name|struct
name|mac_lomac_proc
modifier|*
name|subj
decl_stmt|;
name|struct
name|vattr
name|va
decl_stmt|;
name|struct
name|proc
modifier|*
name|p
decl_stmt|;
name|pid_t
name|pgid
decl_stmt|;
name|subj
operator|=
name|PSLOT
argument_list|(
name|curthread
operator|->
name|td_proc
operator|->
name|p_label
argument_list|)
expr_stmt|;
name|p
operator|=
name|curthread
operator|->
name|td_proc
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|subj
operator|->
name|mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|subj
operator|->
name|mac_lomac
operator|.
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_UPDATE
condition|)
block|{
comment|/* 		 * Check to see if the pending demotion would be more or less 		 * severe than this one, and keep the more severe.  This can 		 * only happen for a multi-threaded application. 		 */
if|if
condition|(
name|lomac_dominate_single
argument_list|(
name|objlabel
argument_list|,
operator|&
name|subj
operator|->
name|mac_lomac
argument_list|)
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|subj
operator|->
name|mtx
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
name|bzero
argument_list|(
operator|&
name|subj
operator|->
name|mac_lomac
argument_list|,
sizeof|sizeof
argument_list|(
name|subj
operator|->
name|mac_lomac
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * Always demote the single label. 	 */
name|lomac_copy_single
argument_list|(
name|objlabel
argument_list|,
operator|&
name|subj
operator|->
name|mac_lomac
argument_list|)
expr_stmt|;
comment|/* 	 * Start with the original range, then minimize each side of the 	 * range to the point of not dominating the object.  The high side 	 * will always be demoted, of course. 	 */
name|lomac_copy_range
argument_list|(
name|subjlabel
argument_list|,
operator|&
name|subj
operator|->
name|mac_lomac
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lomac_dominate_element
argument_list|(
operator|&
name|objlabel
operator|->
name|ml_single
argument_list|,
operator|&
name|subj
operator|->
name|mac_lomac
operator|.
name|ml_rangelow
argument_list|)
condition|)
name|subj
operator|->
name|mac_lomac
operator|.
name|ml_rangelow
operator|=
name|objlabel
operator|->
name|ml_single
expr_stmt|;
name|subj
operator|->
name|mac_lomac
operator|.
name|ml_rangehigh
operator|=
name|objlabel
operator|->
name|ml_single
expr_stmt|;
name|subj
operator|->
name|mac_lomac
operator|.
name|ml_flags
operator||=
name|MAC_LOMAC_FLAG_UPDATE
expr_stmt|;
name|thread_lock
argument_list|(
name|curthread
argument_list|)
expr_stmt|;
name|curthread
operator|->
name|td_flags
operator||=
name|TDF_ASTPENDING
operator||
name|TDF_MACPEND
expr_stmt|;
name|thread_unlock
argument_list|(
name|curthread
argument_list|)
expr_stmt|;
comment|/* 	 * Avoid memory allocation while holding a mutex; cache the label. 	 */
name|lomac_copy_single
argument_list|(
operator|&
name|subj
operator|->
name|mac_lomac
argument_list|,
operator|&
name|cached_subjlabel
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|subj
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|sbuf_new
argument_list|(
operator|&
name|subjlabel_sb
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|SBUF_AUTOEXTEND
argument_list|)
expr_stmt|;
name|lomac_to_string
argument_list|(
operator|&
name|subjlabel_sb
argument_list|,
name|subjlabel
argument_list|)
expr_stmt|;
name|sbuf_finish
argument_list|(
operator|&
name|subjlabel_sb
argument_list|)
expr_stmt|;
name|subjlabeltext
operator|=
name|sbuf_data
argument_list|(
operator|&
name|subjlabel_sb
argument_list|)
expr_stmt|;
name|sbuf_new
argument_list|(
operator|&
name|subjtext_sb
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|SBUF_AUTOEXTEND
argument_list|)
expr_stmt|;
name|lomac_to_string
argument_list|(
operator|&
name|subjtext_sb
argument_list|,
operator|&
name|subj
operator|->
name|mac_lomac
argument_list|)
expr_stmt|;
name|sbuf_finish
argument_list|(
operator|&
name|subjtext_sb
argument_list|)
expr_stmt|;
name|subjtext
operator|=
name|sbuf_data
argument_list|(
operator|&
name|subjtext_sb
argument_list|)
expr_stmt|;
name|sbuf_new
argument_list|(
operator|&
name|objlabel_sb
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|SBUF_AUTOEXTEND
argument_list|)
expr_stmt|;
name|lomac_to_string
argument_list|(
operator|&
name|objlabel_sb
argument_list|,
name|objlabel
argument_list|)
expr_stmt|;
name|sbuf_finish
argument_list|(
operator|&
name|objlabel_sb
argument_list|)
expr_stmt|;
name|objlabeltext
operator|=
name|sbuf_data
argument_list|(
operator|&
name|objlabel_sb
argument_list|)
expr_stmt|;
name|pgid
operator|=
name|p
operator|->
name|p_pgrp
operator|->
name|pg_id
expr_stmt|;
comment|/* XXX could be stale? */
if|if
condition|(
name|vp
operator|!=
name|NULL
operator|&&
name|VOP_GETATTR
argument_list|(
name|vp
argument_list|,
operator|&
name|va
argument_list|,
name|curthread
operator|->
name|td_ucred
argument_list|)
operator|==
literal|0
condition|)
block|{
name|log
argument_list|(
name|LOG_INFO
argument_list|,
literal|"LOMAC: level-%s subject p%dg%du%d:%s demoted to"
literal|" level %s after %s a level-%s %s (inode=%ld, "
literal|"mountpount=%s)\n"
argument_list|,
name|subjlabeltext
argument_list|,
name|p
operator|->
name|p_pid
argument_list|,
name|pgid
argument_list|,
name|curthread
operator|->
name|td_ucred
operator|->
name|cr_uid
argument_list|,
name|p
operator|->
name|p_comm
argument_list|,
name|subjtext
argument_list|,
name|actionname
argument_list|,
name|objlabeltext
argument_list|,
name|objname
argument_list|,
name|va
operator|.
name|va_fileid
argument_list|,
name|vp
operator|->
name|v_mount
operator|->
name|mnt_stat
operator|.
name|f_mntonname
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|log
argument_list|(
name|LOG_INFO
argument_list|,
literal|"LOMAC: level-%s subject p%dg%du%d:%s demoted to"
literal|" level %s after %s a level-%s %s\n"
argument_list|,
name|subjlabeltext
argument_list|,
name|p
operator|->
name|p_pid
argument_list|,
name|pgid
argument_list|,
name|curthread
operator|->
name|td_ucred
operator|->
name|cr_uid
argument_list|,
name|p
operator|->
name|p_comm
argument_list|,
name|subjtext
argument_list|,
name|actionname
argument_list|,
name|objlabeltext
argument_list|,
name|objname
argument_list|)
expr_stmt|;
block|}
name|sbuf_delete
argument_list|(
operator|&
name|subjlabel_sb
argument_list|)
expr_stmt|;
name|sbuf_delete
argument_list|(
operator|&
name|subjtext_sb
argument_list|)
expr_stmt|;
name|sbuf_delete
argument_list|(
operator|&
name|objlabel_sb
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Relabel "to" to "from" only if "from" is a valid label (contains at least  * a single), as for a relabel operation which may or may not involve a  * relevant label.  */
end_comment

begin_function
specifier|static
name|void
name|try_relabel
parameter_list|(
name|struct
name|mac_lomac
modifier|*
name|from
parameter_list|,
name|struct
name|mac_lomac
modifier|*
name|to
parameter_list|)
block|{
if|if
condition|(
name|from
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_SINGLE
condition|)
block|{
name|bzero
argument_list|(
name|to
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|to
argument_list|)
argument_list|)
expr_stmt|;
name|lomac_copy
argument_list|(
name|from
argument_list|,
name|to
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Policy module operations.  */
end_comment

begin_function
specifier|static
name|void
name|lomac_init
parameter_list|(
name|struct
name|mac_policy_conf
modifier|*
name|conf
parameter_list|)
block|{  }
end_function

begin_comment
comment|/*  * Label operations.  */
end_comment

begin_function
specifier|static
name|void
name|lomac_init_label
parameter_list|(
name|struct
name|label
modifier|*
name|label
parameter_list|)
block|{
name|SLOT_SET
argument_list|(
name|label
argument_list|,
name|lomac_alloc
argument_list|(
name|M_WAITOK
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_init_label_waitcheck
parameter_list|(
name|struct
name|label
modifier|*
name|label
parameter_list|,
name|int
name|flag
parameter_list|)
block|{
name|SLOT_SET
argument_list|(
name|label
argument_list|,
name|lomac_alloc
argument_list|(
name|flag
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|SLOT
argument_list|(
name|label
argument_list|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_destroy_label
parameter_list|(
name|struct
name|label
modifier|*
name|label
parameter_list|)
block|{
name|lomac_free
argument_list|(
name|SLOT
argument_list|(
name|label
argument_list|)
argument_list|)
expr_stmt|;
name|SLOT_SET
argument_list|(
name|label
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_element_to_string
parameter_list|(
name|struct
name|sbuf
modifier|*
name|sb
parameter_list|,
name|struct
name|mac_lomac_element
modifier|*
name|element
parameter_list|)
block|{
switch|switch
condition|(
name|element
operator|->
name|mle_type
condition|)
block|{
case|case
name|MAC_LOMAC_TYPE_HIGH
case|:
return|return
operator|(
name|sbuf_printf
argument_list|(
name|sb
argument_list|,
literal|"high"
argument_list|)
operator|)
return|;
case|case
name|MAC_LOMAC_TYPE_LOW
case|:
return|return
operator|(
name|sbuf_printf
argument_list|(
name|sb
argument_list|,
literal|"low"
argument_list|)
operator|)
return|;
case|case
name|MAC_LOMAC_TYPE_EQUAL
case|:
return|return
operator|(
name|sbuf_printf
argument_list|(
name|sb
argument_list|,
literal|"equal"
argument_list|)
operator|)
return|;
case|case
name|MAC_LOMAC_TYPE_GRADE
case|:
return|return
operator|(
name|sbuf_printf
argument_list|(
name|sb
argument_list|,
literal|"%d"
argument_list|,
name|element
operator|->
name|mle_grade
argument_list|)
operator|)
return|;
default|default:
name|panic
argument_list|(
literal|"lomac_element_to_string: invalid type (%d)"
argument_list|,
name|element
operator|->
name|mle_type
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_to_string
parameter_list|(
name|struct
name|sbuf
modifier|*
name|sb
parameter_list|,
name|struct
name|mac_lomac
modifier|*
name|ml
parameter_list|)
block|{
if|if
condition|(
name|ml
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_SINGLE
condition|)
block|{
if|if
condition|(
name|lomac_element_to_string
argument_list|(
name|sb
argument_list|,
operator|&
name|ml
operator|->
name|ml_single
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|ml
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_AUX
condition|)
block|{
if|if
condition|(
name|sbuf_putc
argument_list|(
name|sb
argument_list|,
literal|'['
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|lomac_element_to_string
argument_list|(
name|sb
argument_list|,
operator|&
name|ml
operator|->
name|ml_auxsingle
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|sbuf_putc
argument_list|(
name|sb
argument_list|,
literal|']'
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|ml
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_RANGE
condition|)
block|{
if|if
condition|(
name|sbuf_putc
argument_list|(
name|sb
argument_list|,
literal|'('
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|lomac_element_to_string
argument_list|(
name|sb
argument_list|,
operator|&
name|ml
operator|->
name|ml_rangelow
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|sbuf_putc
argument_list|(
name|sb
argument_list|,
literal|'-'
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|lomac_element_to_string
argument_list|(
name|sb
argument_list|,
operator|&
name|ml
operator|->
name|ml_rangehigh
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|sbuf_putc
argument_list|(
name|sb
argument_list|,
literal|')'
argument_list|)
operator|==
operator|-
literal|1
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_externalize_label
parameter_list|(
name|struct
name|label
modifier|*
name|label
parameter_list|,
name|char
modifier|*
name|element_name
parameter_list|,
name|struct
name|sbuf
modifier|*
name|sb
parameter_list|,
name|int
modifier|*
name|claimed
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|ml
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|MAC_LOMAC_LABEL_NAME
argument_list|,
name|element_name
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
operator|(
operator|*
name|claimed
operator|)
operator|++
expr_stmt|;
name|ml
operator|=
name|SLOT
argument_list|(
name|label
argument_list|)
expr_stmt|;
return|return
operator|(
name|lomac_to_string
argument_list|(
name|sb
argument_list|,
name|ml
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_parse_element
parameter_list|(
name|struct
name|mac_lomac_element
modifier|*
name|element
parameter_list|,
name|char
modifier|*
name|string
parameter_list|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|string
argument_list|,
literal|"high"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|string
argument_list|,
literal|"hi"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|element
operator|->
name|mle_type
operator|=
name|MAC_LOMAC_TYPE_HIGH
expr_stmt|;
name|element
operator|->
name|mle_grade
operator|=
name|MAC_LOMAC_TYPE_UNDEF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|string
argument_list|,
literal|"low"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|string
argument_list|,
literal|"lo"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|element
operator|->
name|mle_type
operator|=
name|MAC_LOMAC_TYPE_LOW
expr_stmt|;
name|element
operator|->
name|mle_grade
operator|=
name|MAC_LOMAC_TYPE_UNDEF
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|string
argument_list|,
literal|"equal"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|string
argument_list|,
literal|"eq"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|element
operator|->
name|mle_type
operator|=
name|MAC_LOMAC_TYPE_EQUAL
expr_stmt|;
name|element
operator|->
name|mle_grade
operator|=
name|MAC_LOMAC_TYPE_UNDEF
expr_stmt|;
block|}
else|else
block|{
name|char
modifier|*
name|p0
decl_stmt|,
modifier|*
name|p1
decl_stmt|;
name|int
name|d
decl_stmt|;
name|p0
operator|=
name|string
expr_stmt|;
name|d
operator|=
name|strtol
argument_list|(
name|p0
argument_list|,
operator|&
name|p1
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|<
literal|0
operator|||
name|d
operator|>
literal|65535
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|element
operator|->
name|mle_type
operator|=
name|MAC_LOMAC_TYPE_GRADE
expr_stmt|;
name|element
operator|->
name|mle_grade
operator|=
name|d
expr_stmt|;
if|if
condition|(
name|p1
operator|==
name|p0
operator|||
operator|*
name|p1
operator|!=
literal|'\0'
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Note: destructively consumes the string, make a local copy before calling  * if that's a problem.  */
end_comment

begin_function
specifier|static
name|int
name|lomac_parse
parameter_list|(
name|struct
name|mac_lomac
modifier|*
name|ml
parameter_list|,
name|char
modifier|*
name|string
parameter_list|)
block|{
name|char
modifier|*
name|range
decl_stmt|,
modifier|*
name|rangeend
decl_stmt|,
modifier|*
name|rangehigh
decl_stmt|,
modifier|*
name|rangelow
decl_stmt|,
modifier|*
name|single
decl_stmt|,
modifier|*
name|auxsingle
decl_stmt|,
modifier|*
name|auxsingleend
decl_stmt|;
name|int
name|error
decl_stmt|;
comment|/* Do we have a range? */
name|single
operator|=
name|string
expr_stmt|;
name|range
operator|=
name|index
argument_list|(
name|string
argument_list|,
literal|'('
argument_list|)
expr_stmt|;
if|if
condition|(
name|range
operator|==
name|single
condition|)
name|single
operator|=
name|NULL
expr_stmt|;
name|auxsingle
operator|=
name|index
argument_list|(
name|string
argument_list|,
literal|'['
argument_list|)
expr_stmt|;
if|if
condition|(
name|auxsingle
operator|==
name|single
condition|)
name|single
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|range
operator|!=
name|NULL
operator|&&
name|auxsingle
operator|!=
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|rangelow
operator|=
name|rangehigh
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|range
operator|!=
name|NULL
condition|)
block|{
comment|/* Nul terminate the end of the single string. */
operator|*
name|range
operator|=
literal|'\0'
expr_stmt|;
name|range
operator|++
expr_stmt|;
name|rangelow
operator|=
name|range
expr_stmt|;
name|rangehigh
operator|=
name|index
argument_list|(
name|rangelow
argument_list|,
literal|'-'
argument_list|)
expr_stmt|;
if|if
condition|(
name|rangehigh
operator|==
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|rangehigh
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|rangelow
operator|==
literal|'\0'
operator|||
operator|*
name|rangehigh
operator|==
literal|'\0'
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|rangeend
operator|=
name|index
argument_list|(
name|rangehigh
argument_list|,
literal|')'
argument_list|)
expr_stmt|;
if|if
condition|(
name|rangeend
operator|==
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|*
operator|(
name|rangeend
operator|+
literal|1
operator|)
operator|!=
literal|'\0'
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
comment|/* Nul terminate the ends of the ranges. */
operator|*
operator|(
name|rangehigh
operator|-
literal|1
operator|)
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|rangeend
operator|=
literal|'\0'
expr_stmt|;
block|}
name|KASSERT
argument_list|(
operator|(
name|rangelow
operator|!=
name|NULL
operator|&&
name|rangehigh
operator|!=
name|NULL
operator|)
operator|||
operator|(
name|rangelow
operator|==
name|NULL
operator|&&
name|rangehigh
operator|==
name|NULL
operator|)
argument_list|,
operator|(
literal|"lomac_internalize_label: range mismatch"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|auxsingle
operator|!=
name|NULL
condition|)
block|{
comment|/* Nul terminate the end of the single string. */
operator|*
name|auxsingle
operator|=
literal|'\0'
expr_stmt|;
name|auxsingle
operator|++
expr_stmt|;
name|auxsingleend
operator|=
name|index
argument_list|(
name|auxsingle
argument_list|,
literal|']'
argument_list|)
expr_stmt|;
if|if
condition|(
name|auxsingleend
operator|==
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|*
operator|(
name|auxsingleend
operator|+
literal|1
operator|)
operator|!=
literal|'\0'
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
comment|/* Nul terminate the end of the auxsingle. */
operator|*
name|auxsingleend
operator|=
literal|'\0'
expr_stmt|;
block|}
name|bzero
argument_list|(
name|ml
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ml
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|single
operator|!=
name|NULL
condition|)
block|{
name|error
operator|=
name|lomac_parse_element
argument_list|(
operator|&
name|ml
operator|->
name|ml_single
argument_list|,
name|single
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|ml
operator|->
name|ml_flags
operator||=
name|MAC_LOMAC_FLAG_SINGLE
expr_stmt|;
block|}
if|if
condition|(
name|auxsingle
operator|!=
name|NULL
condition|)
block|{
name|error
operator|=
name|lomac_parse_element
argument_list|(
operator|&
name|ml
operator|->
name|ml_auxsingle
argument_list|,
name|auxsingle
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|ml
operator|->
name|ml_flags
operator||=
name|MAC_LOMAC_FLAG_AUX
expr_stmt|;
block|}
if|if
condition|(
name|rangelow
operator|!=
name|NULL
condition|)
block|{
name|error
operator|=
name|lomac_parse_element
argument_list|(
operator|&
name|ml
operator|->
name|ml_rangelow
argument_list|,
name|rangelow
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|lomac_parse_element
argument_list|(
operator|&
name|ml
operator|->
name|ml_rangehigh
argument_list|,
name|rangehigh
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|ml
operator|->
name|ml_flags
operator||=
name|MAC_LOMAC_FLAG_RANGE
expr_stmt|;
block|}
name|error
operator|=
name|lomac_valid
argument_list|(
name|ml
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_internalize_label
parameter_list|(
name|struct
name|label
modifier|*
name|label
parameter_list|,
name|char
modifier|*
name|element_name
parameter_list|,
name|char
modifier|*
name|element_data
parameter_list|,
name|int
modifier|*
name|claimed
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|ml
decl_stmt|,
name|ml_temp
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|MAC_LOMAC_LABEL_NAME
argument_list|,
name|element_name
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
operator|(
operator|*
name|claimed
operator|)
operator|++
expr_stmt|;
name|error
operator|=
name|lomac_parse
argument_list|(
operator|&
name|ml_temp
argument_list|,
name|element_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|ml
operator|=
name|SLOT
argument_list|(
name|label
argument_list|)
expr_stmt|;
operator|*
name|ml
operator|=
name|ml_temp
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_copy_label
parameter_list|(
name|struct
name|label
modifier|*
name|src
parameter_list|,
name|struct
name|label
modifier|*
name|dest
parameter_list|)
block|{
operator|*
name|SLOT
argument_list|(
name|dest
argument_list|)
operator|=
operator|*
name|SLOT
argument_list|(
name|src
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Object-specific entry point implementations are sorted alphabetically by  * object type name and then by operation.  */
end_comment

begin_function
specifier|static
name|int
name|lomac_bpfdesc_check_receive
parameter_list|(
name|struct
name|bpf_d
modifier|*
name|d
parameter_list|,
name|struct
name|label
modifier|*
name|dlabel
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|label
modifier|*
name|ifplabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|a
decl_stmt|,
modifier|*
name|b
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|a
operator|=
name|SLOT
argument_list|(
name|dlabel
argument_list|)
expr_stmt|;
name|b
operator|=
name|SLOT
argument_list|(
name|ifplabel
argument_list|)
expr_stmt|;
if|if
condition|(
name|lomac_equal_single
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
name|EACCES
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_bpfdesc_create
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|bpf_d
modifier|*
name|d
parameter_list|,
name|struct
name|label
modifier|*
name|dlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|dlabel
argument_list|)
expr_stmt|;
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_bpfdesc_create_mbuf
parameter_list|(
name|struct
name|bpf_d
modifier|*
name|d
parameter_list|,
name|struct
name|label
modifier|*
name|dlabel
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|label
modifier|*
name|mlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|dlabel
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|mlabel
argument_list|)
expr_stmt|;
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_cred_check_relabel
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|label
modifier|*
name|newlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|new
decl_stmt|;
name|int
name|error
decl_stmt|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|new
operator|=
name|SLOT
argument_list|(
name|newlabel
argument_list|)
expr_stmt|;
comment|/* 	 * If there is a LOMAC label update for the credential, it may be an 	 * update of the single, range, or both. 	 */
name|error
operator|=
name|lomac_atmostflags
argument_list|(
name|new
argument_list|,
name|MAC_LOMAC_FLAGS_BOTH
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* 	 * If the LOMAC label is to be changed, authorize as appropriate. 	 */
if|if
condition|(
name|new
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAGS_BOTH
condition|)
block|{
comment|/* 		 * Fill in the missing parts from the previous label. 		 */
if|if
condition|(
operator|(
name|new
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_SINGLE
operator|)
operator|==
literal|0
condition|)
name|lomac_copy_single
argument_list|(
name|subj
argument_list|,
name|new
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|new
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_RANGE
operator|)
operator|==
literal|0
condition|)
name|lomac_copy_range
argument_list|(
name|subj
argument_list|,
name|new
argument_list|)
expr_stmt|;
comment|/* 		 * To change the LOMAC range on a credential, the new range 		 * label must be in the current range. 		 */
if|if
condition|(
operator|!
name|lomac_range_in_range
argument_list|(
name|new
argument_list|,
name|subj
argument_list|)
condition|)
return|return
operator|(
name|EPERM
operator|)
return|;
comment|/* 		 * To change the LOMAC single label on a credential, the new 		 * single label must be in the new range.  Implicitly from 		 * the previous check, the new single is in the old range. 		 */
if|if
condition|(
operator|!
name|lomac_single_in_range
argument_list|(
name|new
argument_list|,
name|new
argument_list|)
condition|)
return|return
operator|(
name|EPERM
operator|)
return|;
comment|/* 		 * To have EQUAL in any component of the new credential LOMAC 		 * label, the subject must already have EQUAL in their label. 		 */
if|if
condition|(
name|lomac_contains_equal
argument_list|(
name|new
argument_list|)
condition|)
block|{
name|error
operator|=
name|lomac_subject_privileged
argument_list|(
name|subj
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* 		 * XXXMAC: Additional consistency tests regarding the single 		 * and range of the new label might be performed here. 		 */
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_cred_check_visible
parameter_list|(
name|struct
name|ucred
modifier|*
name|cr1
parameter_list|,
name|struct
name|ucred
modifier|*
name|cr2
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cr1
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|cr2
operator|->
name|cr_label
argument_list|)
expr_stmt|;
comment|/* XXX: range */
if|if
condition|(
operator|!
name|lomac_dominate_single
argument_list|(
name|obj
argument_list|,
name|subj
argument_list|)
condition|)
return|return
operator|(
name|ESRCH
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_cred_create_init
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|dest
decl_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|lomac_set_single
argument_list|(
name|dest
argument_list|,
name|MAC_LOMAC_TYPE_HIGH
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|lomac_set_range
argument_list|(
name|dest
argument_list|,
name|MAC_LOMAC_TYPE_LOW
argument_list|,
literal|0
argument_list|,
name|MAC_LOMAC_TYPE_HIGH
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_cred_create_swapper
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|dest
decl_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|lomac_set_single
argument_list|(
name|dest
argument_list|,
name|MAC_LOMAC_TYPE_EQUAL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|lomac_set_range
argument_list|(
name|dest
argument_list|,
name|MAC_LOMAC_TYPE_LOW
argument_list|,
literal|0
argument_list|,
name|MAC_LOMAC_TYPE_HIGH
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_cred_relabel
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|label
modifier|*
name|newlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|newlabel
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|try_relabel
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_devfs_create_device
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|mount
modifier|*
name|mp
parameter_list|,
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|struct
name|devfs_dirent
modifier|*
name|de
parameter_list|,
name|struct
name|label
modifier|*
name|delabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|ml
decl_stmt|;
name|int
name|lomac_type
decl_stmt|;
name|ml
operator|=
name|SLOT
argument_list|(
name|delabel
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|dev
operator|->
name|si_name
argument_list|,
literal|"null"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|dev
operator|->
name|si_name
argument_list|,
literal|"zero"
argument_list|)
operator|==
literal|0
operator|||
name|strcmp
argument_list|(
name|dev
operator|->
name|si_name
argument_list|,
literal|"random"
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
name|dev
operator|->
name|si_name
argument_list|,
literal|"fd/"
argument_list|,
name|strlen
argument_list|(
literal|"fd/"
argument_list|)
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
name|dev
operator|->
name|si_name
argument_list|,
literal|"ttyv"
argument_list|,
name|strlen
argument_list|(
literal|"ttyv"
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
name|lomac_type
operator|=
name|MAC_LOMAC_TYPE_EQUAL
expr_stmt|;
elseif|else
if|if
condition|(
name|ptys_equal
operator|&&
operator|(
name|strncmp
argument_list|(
name|dev
operator|->
name|si_name
argument_list|,
literal|"ttyp"
argument_list|,
name|strlen
argument_list|(
literal|"ttyp"
argument_list|)
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
name|dev
operator|->
name|si_name
argument_list|,
literal|"ptyp"
argument_list|,
name|strlen
argument_list|(
literal|"ptyp"
argument_list|)
argument_list|)
operator|==
literal|0
operator|)
condition|)
name|lomac_type
operator|=
name|MAC_LOMAC_TYPE_EQUAL
expr_stmt|;
else|else
name|lomac_type
operator|=
name|MAC_LOMAC_TYPE_HIGH
expr_stmt|;
name|lomac_set_single
argument_list|(
name|ml
argument_list|,
name|lomac_type
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_devfs_create_directory
parameter_list|(
name|struct
name|mount
modifier|*
name|mp
parameter_list|,
name|char
modifier|*
name|dirname
parameter_list|,
name|int
name|dirnamelen
parameter_list|,
name|struct
name|devfs_dirent
modifier|*
name|de
parameter_list|,
name|struct
name|label
modifier|*
name|delabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|ml
decl_stmt|;
name|ml
operator|=
name|SLOT
argument_list|(
name|delabel
argument_list|)
expr_stmt|;
name|lomac_set_single
argument_list|(
name|ml
argument_list|,
name|MAC_LOMAC_TYPE_HIGH
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_devfs_create_symlink
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|mount
modifier|*
name|mp
parameter_list|,
name|struct
name|devfs_dirent
modifier|*
name|dd
parameter_list|,
name|struct
name|label
modifier|*
name|ddlabel
parameter_list|,
name|struct
name|devfs_dirent
modifier|*
name|de
parameter_list|,
name|struct
name|label
modifier|*
name|delabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|delabel
argument_list|)
expr_stmt|;
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_devfs_update
parameter_list|(
name|struct
name|mount
modifier|*
name|mp
parameter_list|,
name|struct
name|devfs_dirent
modifier|*
name|de
parameter_list|,
name|struct
name|label
modifier|*
name|delabel
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|delabel
argument_list|)
expr_stmt|;
name|lomac_copy
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_devfs_vnode_associate
parameter_list|(
name|struct
name|mount
modifier|*
name|mp
parameter_list|,
name|struct
name|label
modifier|*
name|mplabel
parameter_list|,
name|struct
name|devfs_dirent
modifier|*
name|de
parameter_list|,
name|struct
name|label
modifier|*
name|delabel
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|delabel
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_ifnet_check_relabel
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|label
modifier|*
name|ifplabel
parameter_list|,
name|struct
name|label
modifier|*
name|newlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|new
decl_stmt|;
name|int
name|error
decl_stmt|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|new
operator|=
name|SLOT
argument_list|(
name|newlabel
argument_list|)
expr_stmt|;
comment|/* 	 * If there is a LOMAC label update for the interface, it may be an 	 * update of the single, range, or both. 	 */
name|error
operator|=
name|lomac_atmostflags
argument_list|(
name|new
argument_list|,
name|MAC_LOMAC_FLAGS_BOTH
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* 	 * Relabling network interfaces requires LOMAC privilege. 	 */
name|error
operator|=
name|lomac_subject_privileged
argument_list|(
name|subj
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* 	 * If the LOMAC label is to be changed, authorize as appropriate. 	 */
if|if
condition|(
name|new
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAGS_BOTH
condition|)
block|{
comment|/* 		 * Fill in the missing parts from the previous label. 		 */
if|if
condition|(
operator|(
name|new
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_SINGLE
operator|)
operator|==
literal|0
condition|)
name|lomac_copy_single
argument_list|(
name|subj
argument_list|,
name|new
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|new
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_RANGE
operator|)
operator|==
literal|0
condition|)
name|lomac_copy_range
argument_list|(
name|subj
argument_list|,
name|new
argument_list|)
expr_stmt|;
comment|/* 		 * Rely on the traditional superuser status for the LOMAC 		 * interface relabel requirements.  XXXMAC: This will go 		 * away. 		 * 		 * XXXRW: This is also redundant to a higher layer check. 		 */
name|error
operator|=
name|priv_check_cred
argument_list|(
name|cred
argument_list|,
name|PRIV_NET_SETIFMAC
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|EPERM
operator|)
return|;
comment|/* 		 * XXXMAC: Additional consistency tests regarding the single 		 * and the range of the new label might be performed here. 		 */
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_ifnet_check_transmit
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|label
modifier|*
name|ifplabel
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|label
modifier|*
name|mlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|p
decl_stmt|,
modifier|*
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|p
operator|=
name|SLOT
argument_list|(
name|mlabel
argument_list|)
expr_stmt|;
name|i
operator|=
name|SLOT
argument_list|(
name|ifplabel
argument_list|)
expr_stmt|;
return|return
operator|(
name|lomac_single_in_range
argument_list|(
name|p
argument_list|,
name|i
argument_list|)
condition|?
literal|0
else|:
name|EACCES
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_ifnet_create
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|label
modifier|*
name|ifplabel
parameter_list|)
block|{
name|char
name|tifname
index|[
name|IFNAMSIZ
index|]
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|q
decl_stmt|;
name|char
name|tiflist
index|[
sizeof|sizeof
argument_list|(
name|trusted_interfaces
argument_list|)
index|]
decl_stmt|;
name|struct
name|mac_lomac
modifier|*
name|dest
decl_stmt|;
name|int
name|len
decl_stmt|,
name|grade
decl_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|ifplabel
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_type
operator|==
name|IFT_LOOP
condition|)
block|{
name|grade
operator|=
name|MAC_LOMAC_TYPE_EQUAL
expr_stmt|;
goto|goto
name|set
goto|;
block|}
if|if
condition|(
name|trust_all_interfaces
condition|)
block|{
name|grade
operator|=
name|MAC_LOMAC_TYPE_HIGH
expr_stmt|;
goto|goto
name|set
goto|;
block|}
name|grade
operator|=
name|MAC_LOMAC_TYPE_LOW
expr_stmt|;
if|if
condition|(
name|trusted_interfaces
index|[
literal|0
index|]
operator|==
literal|'\0'
operator|||
operator|!
name|strvalid
argument_list|(
name|trusted_interfaces
argument_list|,
sizeof|sizeof
argument_list|(
name|trusted_interfaces
argument_list|)
argument_list|)
condition|)
goto|goto
name|set
goto|;
name|bzero
argument_list|(
name|tiflist
argument_list|,
sizeof|sizeof
argument_list|(
name|tiflist
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|p
operator|=
name|trusted_interfaces
operator|,
name|q
operator|=
name|tiflist
init|;
operator|*
name|p
operator|!=
literal|'\0'
condition|;
name|p
operator|++
operator|,
name|q
operator|++
control|)
if|if
condition|(
operator|*
name|p
operator|!=
literal|' '
operator|&&
operator|*
name|p
operator|!=
literal|'\t'
condition|)
operator|*
name|q
operator|=
operator|*
name|p
expr_stmt|;
for|for
control|(
name|p
operator|=
name|q
operator|=
name|tiflist
init|;
condition|;
name|p
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|p
operator|==
literal|','
operator|||
operator|*
name|p
operator|==
literal|'\0'
condition|)
block|{
name|len
operator|=
name|p
operator|-
name|q
expr_stmt|;
if|if
condition|(
name|len
operator|<
name|IFNAMSIZ
condition|)
block|{
name|bzero
argument_list|(
name|tifname
argument_list|,
sizeof|sizeof
argument_list|(
name|tifname
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|q
argument_list|,
name|tifname
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|tifname
argument_list|,
name|ifp
operator|->
name|if_xname
argument_list|)
operator|==
literal|0
condition|)
block|{
name|grade
operator|=
name|MAC_LOMAC_TYPE_HIGH
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
name|printf
argument_list|(
literal|"MAC/LOMAC warning: interface name "
literal|"\"%s\" is too long (must be< %d)\n"
argument_list|,
name|q
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|p
operator|==
literal|'\0'
condition|)
break|break;
name|q
operator|=
name|p
operator|+
literal|1
expr_stmt|;
block|}
block|}
name|set
label|:
name|lomac_set_single
argument_list|(
name|dest
argument_list|,
name|grade
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|lomac_set_range
argument_list|(
name|dest
argument_list|,
name|grade
argument_list|,
literal|0
argument_list|,
name|grade
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_ifnet_create_mbuf
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|label
modifier|*
name|ifplabel
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|label
modifier|*
name|mlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|ifplabel
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|mlabel
argument_list|)
expr_stmt|;
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_ifnet_relabel
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|label
modifier|*
name|ifplabel
parameter_list|,
name|struct
name|label
modifier|*
name|newlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|newlabel
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|ifplabel
argument_list|)
expr_stmt|;
name|try_relabel
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_inpcb_check_deliver
parameter_list|(
name|struct
name|inpcb
modifier|*
name|inp
parameter_list|,
name|struct
name|label
modifier|*
name|inplabel
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|label
modifier|*
name|mlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|p
decl_stmt|,
modifier|*
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|p
operator|=
name|SLOT
argument_list|(
name|mlabel
argument_list|)
expr_stmt|;
name|i
operator|=
name|SLOT
argument_list|(
name|inplabel
argument_list|)
expr_stmt|;
return|return
operator|(
name|lomac_equal_single
argument_list|(
name|p
argument_list|,
name|i
argument_list|)
condition|?
literal|0
else|:
name|EACCES
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_inpcb_check_visible
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|inpcb
modifier|*
name|inp
parameter_list|,
name|struct
name|label
modifier|*
name|inplabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|inplabel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lomac_dominate_single
argument_list|(
name|obj
argument_list|,
name|subj
argument_list|)
condition|)
return|return
operator|(
name|ENOENT
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_inpcb_create
parameter_list|(
name|struct
name|socket
modifier|*
name|so
parameter_list|,
name|struct
name|label
modifier|*
name|solabel
parameter_list|,
name|struct
name|inpcb
modifier|*
name|inp
parameter_list|,
name|struct
name|label
modifier|*
name|inplabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|solabel
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|inplabel
argument_list|)
expr_stmt|;
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_inpcb_create_mbuf
parameter_list|(
name|struct
name|inpcb
modifier|*
name|inp
parameter_list|,
name|struct
name|label
modifier|*
name|inplabel
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|label
modifier|*
name|mlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|inplabel
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|mlabel
argument_list|)
expr_stmt|;
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_inpcb_sosetlabel
parameter_list|(
name|struct
name|socket
modifier|*
name|so
parameter_list|,
name|struct
name|label
modifier|*
name|solabel
parameter_list|,
name|struct
name|inpcb
modifier|*
name|inp
parameter_list|,
name|struct
name|label
modifier|*
name|inplabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|solabel
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|inplabel
argument_list|)
expr_stmt|;
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_ip6q_create
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|label
modifier|*
name|mlabel
parameter_list|,
name|struct
name|ip6q
modifier|*
name|q6
parameter_list|,
name|struct
name|label
modifier|*
name|q6label
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|mlabel
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|q6label
argument_list|)
expr_stmt|;
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_ip6q_match
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|label
modifier|*
name|mlabel
parameter_list|,
name|struct
name|ip6q
modifier|*
name|q6
parameter_list|,
name|struct
name|label
modifier|*
name|q6label
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|a
decl_stmt|,
modifier|*
name|b
decl_stmt|;
name|a
operator|=
name|SLOT
argument_list|(
name|q6label
argument_list|)
expr_stmt|;
name|b
operator|=
name|SLOT
argument_list|(
name|mlabel
argument_list|)
expr_stmt|;
return|return
operator|(
name|lomac_equal_single
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_ip6q_reassemble
parameter_list|(
name|struct
name|ip6q
modifier|*
name|q6
parameter_list|,
name|struct
name|label
modifier|*
name|q6label
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|label
modifier|*
name|mlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|q6label
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|mlabel
argument_list|)
expr_stmt|;
comment|/* Just use the head, since we require them all to match. */
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_ip6q_update
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|label
modifier|*
name|mlabel
parameter_list|,
name|struct
name|ip6q
modifier|*
name|q6
parameter_list|,
name|struct
name|label
modifier|*
name|q6label
parameter_list|)
block|{
comment|/* NOOP: we only accept matching labels, so no need to update */
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_ipq_create
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|label
modifier|*
name|mlabel
parameter_list|,
name|struct
name|ipq
modifier|*
name|q
parameter_list|,
name|struct
name|label
modifier|*
name|qlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|mlabel
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|qlabel
argument_list|)
expr_stmt|;
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_ipq_match
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|label
modifier|*
name|mlabel
parameter_list|,
name|struct
name|ipq
modifier|*
name|q
parameter_list|,
name|struct
name|label
modifier|*
name|qlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|a
decl_stmt|,
modifier|*
name|b
decl_stmt|;
name|a
operator|=
name|SLOT
argument_list|(
name|qlabel
argument_list|)
expr_stmt|;
name|b
operator|=
name|SLOT
argument_list|(
name|mlabel
argument_list|)
expr_stmt|;
return|return
operator|(
name|lomac_equal_single
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_ipq_reassemble
parameter_list|(
name|struct
name|ipq
modifier|*
name|q
parameter_list|,
name|struct
name|label
modifier|*
name|qlabel
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|label
modifier|*
name|mlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|qlabel
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|mlabel
argument_list|)
expr_stmt|;
comment|/* Just use the head, since we require them all to match. */
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_ipq_update
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|label
modifier|*
name|mlabel
parameter_list|,
name|struct
name|ipq
modifier|*
name|q
parameter_list|,
name|struct
name|label
modifier|*
name|qlabel
parameter_list|)
block|{
comment|/* NOOP: we only accept matching labels, so no need to update */
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_kld_check_load
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
if|if
condition|(
name|lomac_subject_privileged
argument_list|(
name|subj
argument_list|)
condition|)
return|return
operator|(
name|EPERM
operator|)
return|;
if|if
condition|(
operator|!
name|lomac_high_single
argument_list|(
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_mount_create
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|mount
modifier|*
name|mp
parameter_list|,
name|struct
name|label
modifier|*
name|mplabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|mplabel
argument_list|)
expr_stmt|;
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_netatalk_aarp_send
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|label
modifier|*
name|ifplabel
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|label
modifier|*
name|mlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|dest
decl_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|mlabel
argument_list|)
expr_stmt|;
name|lomac_set_single
argument_list|(
name|dest
argument_list|,
name|MAC_LOMAC_TYPE_EQUAL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_netinet_arp_send
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|label
modifier|*
name|ifplabel
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|label
modifier|*
name|mlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|dest
decl_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|mlabel
argument_list|)
expr_stmt|;
name|lomac_set_single
argument_list|(
name|dest
argument_list|,
name|MAC_LOMAC_TYPE_EQUAL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_netinet_firewall_reply
parameter_list|(
name|struct
name|mbuf
modifier|*
name|mrecv
parameter_list|,
name|struct
name|label
modifier|*
name|mrecvlabel
parameter_list|,
name|struct
name|mbuf
modifier|*
name|msend
parameter_list|,
name|struct
name|label
modifier|*
name|msendlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|mrecvlabel
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|msendlabel
argument_list|)
expr_stmt|;
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_netinet_firewall_send
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|label
modifier|*
name|mlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|dest
decl_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|mlabel
argument_list|)
expr_stmt|;
comment|/* XXX: where is the label for the firewall really comming from? */
name|lomac_set_single
argument_list|(
name|dest
argument_list|,
name|MAC_LOMAC_TYPE_EQUAL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_netinet_fragment
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|label
modifier|*
name|mlabel
parameter_list|,
name|struct
name|mbuf
modifier|*
name|frag
parameter_list|,
name|struct
name|label
modifier|*
name|fraglabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|mlabel
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|fraglabel
argument_list|)
expr_stmt|;
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_netinet_icmp_reply
parameter_list|(
name|struct
name|mbuf
modifier|*
name|mrecv
parameter_list|,
name|struct
name|label
modifier|*
name|mrecvlabel
parameter_list|,
name|struct
name|mbuf
modifier|*
name|msend
parameter_list|,
name|struct
name|label
modifier|*
name|msendlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|mrecvlabel
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|msendlabel
argument_list|)
expr_stmt|;
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_netinet_igmp_send
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|label
modifier|*
name|ifplabel
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|label
modifier|*
name|mlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|dest
decl_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|mlabel
argument_list|)
expr_stmt|;
name|lomac_set_single
argument_list|(
name|dest
argument_list|,
name|MAC_LOMAC_TYPE_EQUAL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_netinet6_nd6_send
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|label
modifier|*
name|ifplabel
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|label
modifier|*
name|mlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|dest
decl_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|mlabel
argument_list|)
expr_stmt|;
name|lomac_set_single
argument_list|(
name|dest
argument_list|,
name|MAC_LOMAC_TYPE_EQUAL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_pipe_check_ioctl
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|pipepair
modifier|*
name|pp
parameter_list|,
name|struct
name|label
modifier|*
name|pplabel
parameter_list|,
name|unsigned
name|long
name|cmd
parameter_list|,
name|void
comment|/* caddr_t */
modifier|*
name|data
parameter_list|)
block|{
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* XXX: This will be implemented soon... */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_pipe_check_read
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|pipepair
modifier|*
name|pp
parameter_list|,
name|struct
name|label
modifier|*
name|pplabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|pplabel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lomac_dominate_single
argument_list|(
name|obj
argument_list|,
name|subj
argument_list|)
condition|)
return|return
operator|(
name|maybe_demote
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|,
literal|"reading"
argument_list|,
literal|"pipe"
argument_list|,
name|NULL
argument_list|)
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_pipe_check_relabel
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|pipepair
modifier|*
name|pp
parameter_list|,
name|struct
name|label
modifier|*
name|pplabel
parameter_list|,
name|struct
name|label
modifier|*
name|newlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|,
modifier|*
name|new
decl_stmt|;
name|int
name|error
decl_stmt|;
name|new
operator|=
name|SLOT
argument_list|(
name|newlabel
argument_list|)
expr_stmt|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|pplabel
argument_list|)
expr_stmt|;
comment|/* 	 * If there is a LOMAC label update for a pipe, it must be a single 	 * update. 	 */
name|error
operator|=
name|lomac_atmostflags
argument_list|(
name|new
argument_list|,
name|MAC_LOMAC_FLAG_SINGLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* 	 * To perform a relabel of a pipe (LOMAC label or not), LOMAC must 	 * authorize the relabel. 	 */
if|if
condition|(
operator|!
name|lomac_single_in_range
argument_list|(
name|obj
argument_list|,
name|subj
argument_list|)
condition|)
return|return
operator|(
name|EPERM
operator|)
return|;
comment|/* 	 * If the LOMAC label is to be changed, authorize as appropriate. 	 */
if|if
condition|(
name|new
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_SINGLE
condition|)
block|{
comment|/* 		 * To change the LOMAC label on a pipe, the new pipe label 		 * must be in the subject range. 		 */
if|if
condition|(
operator|!
name|lomac_single_in_range
argument_list|(
name|new
argument_list|,
name|subj
argument_list|)
condition|)
return|return
operator|(
name|EPERM
operator|)
return|;
comment|/* 		 * To change the LOMAC label on a pipe to be EQUAL, the 		 * subject must have appropriate privilege. 		 */
if|if
condition|(
name|lomac_contains_equal
argument_list|(
name|new
argument_list|)
condition|)
block|{
name|error
operator|=
name|lomac_subject_privileged
argument_list|(
name|subj
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_pipe_check_write
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|pipepair
modifier|*
name|pp
parameter_list|,
name|struct
name|label
modifier|*
name|pplabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|pplabel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lomac_subject_dominate
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_pipe_create
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|pipepair
modifier|*
name|pp
parameter_list|,
name|struct
name|label
modifier|*
name|pplabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|pplabel
argument_list|)
expr_stmt|;
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_pipe_relabel
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|pipepair
modifier|*
name|pp
parameter_list|,
name|struct
name|label
modifier|*
name|pplabel
parameter_list|,
name|struct
name|label
modifier|*
name|newlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|newlabel
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|pplabel
argument_list|)
expr_stmt|;
name|try_relabel
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Some system privileges are allowed regardless of integrity grade; others  * are allowed only when running with privilege with respect to the LOMAC   * policy as they might otherwise allow bypassing of the integrity policy.  */
end_comment

begin_function
specifier|static
name|int
name|lomac_priv_check
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|int
name|priv
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* 	 * Exempt only specific privileges from the LOMAC integrity policy. 	 */
switch|switch
condition|(
name|priv
condition|)
block|{
case|case
name|PRIV_KTRACE
case|:
case|case
name|PRIV_MSGBUF
case|:
comment|/* 	 * Allow processes to manipulate basic process audit properties, and 	 * to submit audit records. 	 */
case|case
name|PRIV_AUDIT_GETAUDIT
case|:
case|case
name|PRIV_AUDIT_SETAUDIT
case|:
case|case
name|PRIV_AUDIT_SUBMIT
case|:
comment|/* 	 * Allow processes to manipulate their regular UNIX credentials. 	 */
case|case
name|PRIV_CRED_SETUID
case|:
case|case
name|PRIV_CRED_SETEUID
case|:
case|case
name|PRIV_CRED_SETGID
case|:
case|case
name|PRIV_CRED_SETEGID
case|:
case|case
name|PRIV_CRED_SETGROUPS
case|:
case|case
name|PRIV_CRED_SETREUID
case|:
case|case
name|PRIV_CRED_SETREGID
case|:
case|case
name|PRIV_CRED_SETRESUID
case|:
case|case
name|PRIV_CRED_SETRESGID
case|:
comment|/* 	 * Allow processes to perform system monitoring. 	 */
case|case
name|PRIV_SEEOTHERGIDS
case|:
case|case
name|PRIV_SEEOTHERUIDS
case|:
break|break;
comment|/* 	 * Allow access to general process debugging facilities.  We 	 * separately control debugging based on MAC label. 	 */
case|case
name|PRIV_DEBUG_DIFFCRED
case|:
case|case
name|PRIV_DEBUG_SUGID
case|:
case|case
name|PRIV_DEBUG_UNPRIV
case|:
comment|/* 	 * Allow manipulating jails. 	 */
case|case
name|PRIV_JAIL_ATTACH
case|:
comment|/* 	 * Allow privilege with respect to the Partition policy, but not the 	 * Privs policy. 	 */
case|case
name|PRIV_MAC_PARTITION
case|:
comment|/* 	 * Allow privilege with respect to process resource limits and login 	 * context. 	 */
case|case
name|PRIV_PROC_LIMIT
case|:
case|case
name|PRIV_PROC_SETLOGIN
case|:
case|case
name|PRIV_PROC_SETRLIMIT
case|:
comment|/* 	 * Allow System V and POSIX IPC privileges. 	 */
case|case
name|PRIV_IPC_READ
case|:
case|case
name|PRIV_IPC_WRITE
case|:
case|case
name|PRIV_IPC_ADMIN
case|:
case|case
name|PRIV_IPC_MSGSIZE
case|:
case|case
name|PRIV_MQ_ADMIN
case|:
comment|/* 	 * Allow certain scheduler manipulations -- possibly this should be 	 * controlled by more fine-grained policy, as potentially low 	 * integrity processes can deny CPU to higher integrity ones. 	 */
case|case
name|PRIV_SCHED_DIFFCRED
case|:
case|case
name|PRIV_SCHED_SETPRIORITY
case|:
case|case
name|PRIV_SCHED_RTPRIO
case|:
case|case
name|PRIV_SCHED_SETPOLICY
case|:
case|case
name|PRIV_SCHED_SET
case|:
case|case
name|PRIV_SCHED_SETPARAM
case|:
comment|/* 	 * More IPC privileges. 	 */
case|case
name|PRIV_SEM_WRITE
case|:
comment|/* 	 * Allow signaling privileges subject to integrity policy. 	 */
case|case
name|PRIV_SIGNAL_DIFFCRED
case|:
case|case
name|PRIV_SIGNAL_SUGID
case|:
comment|/* 	 * Allow access to only limited sysctls from lower integrity levels; 	 * piggy-back on the Jail definition. 	 */
case|case
name|PRIV_SYSCTL_WRITEJAIL
case|:
comment|/* 	 * Allow TTY-based privileges, subject to general device access using 	 * labels on TTY device nodes, but not console privilege. 	 */
case|case
name|PRIV_TTY_DRAINWAIT
case|:
case|case
name|PRIV_TTY_DTRWAIT
case|:
case|case
name|PRIV_TTY_EXCLUSIVE
case|:
case|case
name|PRIV_TTY_PRISON
case|:
case|case
name|PRIV_TTY_STI
case|:
case|case
name|PRIV_TTY_SETA
case|:
comment|/* 	 * Grant most VFS privileges, as almost all are in practice bounded 	 * by more specific checks using labels. 	 */
case|case
name|PRIV_VFS_READ
case|:
case|case
name|PRIV_VFS_WRITE
case|:
case|case
name|PRIV_VFS_ADMIN
case|:
case|case
name|PRIV_VFS_EXEC
case|:
case|case
name|PRIV_VFS_LOOKUP
case|:
case|case
name|PRIV_VFS_CHFLAGS_DEV
case|:
case|case
name|PRIV_VFS_CHOWN
case|:
case|case
name|PRIV_VFS_CHROOT
case|:
case|case
name|PRIV_VFS_RETAINSUGID
case|:
case|case
name|PRIV_VFS_EXCEEDQUOTA
case|:
case|case
name|PRIV_VFS_FCHROOT
case|:
case|case
name|PRIV_VFS_FHOPEN
case|:
case|case
name|PRIV_VFS_FHSTATFS
case|:
case|case
name|PRIV_VFS_GENERATION
case|:
case|case
name|PRIV_VFS_GETFH
case|:
case|case
name|PRIV_VFS_GETQUOTA
case|:
case|case
name|PRIV_VFS_LINK
case|:
case|case
name|PRIV_VFS_MOUNT
case|:
case|case
name|PRIV_VFS_MOUNT_OWNER
case|:
case|case
name|PRIV_VFS_MOUNT_PERM
case|:
case|case
name|PRIV_VFS_MOUNT_SUIDDIR
case|:
case|case
name|PRIV_VFS_MOUNT_NONUSER
case|:
case|case
name|PRIV_VFS_SETGID
case|:
case|case
name|PRIV_VFS_STICKYFILE
case|:
case|case
name|PRIV_VFS_SYSFLAGS
case|:
case|case
name|PRIV_VFS_UNMOUNT
case|:
comment|/* 	 * Allow VM privileges; it would be nice if these were subject to 	 * resource limits. 	 */
case|case
name|PRIV_VM_MADV_PROTECT
case|:
case|case
name|PRIV_VM_MLOCK
case|:
case|case
name|PRIV_VM_MUNLOCK
case|:
comment|/* 	 * Allow some but not all network privileges.  In general, dont allow 	 * reconfiguring the network stack, just normal use. 	 */
case|case
name|PRIV_NETATALK_RESERVEDPORT
case|:
case|case
name|PRIV_NETINET_RESERVEDPORT
case|:
case|case
name|PRIV_NETINET_RAW
case|:
case|case
name|PRIV_NETINET_REUSEPORT
case|:
case|case
name|PRIV_NETIPX_RESERVEDPORT
case|:
case|case
name|PRIV_NETIPX_RAW
case|:
break|break;
comment|/* 	 * All remaining system privileges are allow only if the process 	 * holds privilege with respect to the LOMAC policy. 	 */
default|default:
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|error
operator|=
name|lomac_subject_privileged
argument_list|(
name|subj
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_proc_check_debug
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|p
operator|->
name|p_ucred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
comment|/* XXX: range checks */
if|if
condition|(
operator|!
name|lomac_dominate_single
argument_list|(
name|obj
argument_list|,
name|subj
argument_list|)
condition|)
return|return
operator|(
name|ESRCH
operator|)
return|;
if|if
condition|(
operator|!
name|lomac_subject_dominate
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_proc_check_sched
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|p
operator|->
name|p_ucred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
comment|/* XXX: range checks */
if|if
condition|(
operator|!
name|lomac_dominate_single
argument_list|(
name|obj
argument_list|,
name|subj
argument_list|)
condition|)
return|return
operator|(
name|ESRCH
operator|)
return|;
if|if
condition|(
operator|!
name|lomac_subject_dominate
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_proc_check_signal
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|proc
modifier|*
name|p
parameter_list|,
name|int
name|signum
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|p
operator|->
name|p_ucred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
comment|/* XXX: range checks */
if|if
condition|(
operator|!
name|lomac_dominate_single
argument_list|(
name|obj
argument_list|,
name|subj
argument_list|)
condition|)
return|return
operator|(
name|ESRCH
operator|)
return|;
if|if
condition|(
operator|!
name|lomac_subject_dominate
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_proc_destroy_label
parameter_list|(
name|struct
name|label
modifier|*
name|label
parameter_list|)
block|{
name|mtx_destroy
argument_list|(
operator|&
name|PSLOT
argument_list|(
name|label
argument_list|)
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|PSLOT
argument_list|(
name|label
argument_list|)
argument_list|,
name|M_LOMAC
argument_list|)
expr_stmt|;
name|PSLOT_SET
argument_list|(
name|label
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_proc_init_label
parameter_list|(
name|struct
name|label
modifier|*
name|label
parameter_list|)
block|{
name|PSLOT_SET
argument_list|(
name|label
argument_list|,
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|mac_lomac_proc
argument_list|)
argument_list|,
name|M_LOMAC
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
argument_list|)
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|PSLOT
argument_list|(
name|label
argument_list|)
operator|->
name|mtx
argument_list|,
literal|"MAC/Lomac proc lock"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_socket_check_deliver
parameter_list|(
name|struct
name|socket
modifier|*
name|so
parameter_list|,
name|struct
name|label
modifier|*
name|solabel
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|label
modifier|*
name|mlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|p
decl_stmt|,
modifier|*
name|s
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|p
operator|=
name|SLOT
argument_list|(
name|mlabel
argument_list|)
expr_stmt|;
name|s
operator|=
name|SLOT
argument_list|(
name|solabel
argument_list|)
expr_stmt|;
return|return
operator|(
name|lomac_equal_single
argument_list|(
name|p
argument_list|,
name|s
argument_list|)
condition|?
literal|0
else|:
name|EACCES
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_socket_check_relabel
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|socket
modifier|*
name|so
parameter_list|,
name|struct
name|label
modifier|*
name|solabel
parameter_list|,
name|struct
name|label
modifier|*
name|newlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|,
modifier|*
name|new
decl_stmt|;
name|int
name|error
decl_stmt|;
name|new
operator|=
name|SLOT
argument_list|(
name|newlabel
argument_list|)
expr_stmt|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|solabel
argument_list|)
expr_stmt|;
comment|/* 	 * If there is a LOMAC label update for the socket, it may be an 	 * update of single. 	 */
name|error
operator|=
name|lomac_atmostflags
argument_list|(
name|new
argument_list|,
name|MAC_LOMAC_FLAG_SINGLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* 	 * To relabel a socket, the old socket single must be in the subject 	 * range. 	 */
if|if
condition|(
operator|!
name|lomac_single_in_range
argument_list|(
name|obj
argument_list|,
name|subj
argument_list|)
condition|)
return|return
operator|(
name|EPERM
operator|)
return|;
comment|/* 	 * If the LOMAC label is to be changed, authorize as appropriate. 	 */
if|if
condition|(
name|new
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_SINGLE
condition|)
block|{
comment|/* 		 * To relabel a socket, the new socket single must be in the 		 * subject range. 		 */
if|if
condition|(
operator|!
name|lomac_single_in_range
argument_list|(
name|new
argument_list|,
name|subj
argument_list|)
condition|)
return|return
operator|(
name|EPERM
operator|)
return|;
comment|/* 		 * To change the LOMAC label on the socket to contain EQUAL, 		 * the subject must have appropriate privilege. 		 */
if|if
condition|(
name|lomac_contains_equal
argument_list|(
name|new
argument_list|)
condition|)
block|{
name|error
operator|=
name|lomac_subject_privileged
argument_list|(
name|subj
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_socket_check_visible
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|socket
modifier|*
name|so
parameter_list|,
name|struct
name|label
modifier|*
name|solabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|solabel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lomac_dominate_single
argument_list|(
name|obj
argument_list|,
name|subj
argument_list|)
condition|)
return|return
operator|(
name|ENOENT
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_socket_create
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|socket
modifier|*
name|so
parameter_list|,
name|struct
name|label
modifier|*
name|solabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|solabel
argument_list|)
expr_stmt|;
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_socket_create_mbuf
parameter_list|(
name|struct
name|socket
modifier|*
name|so
parameter_list|,
name|struct
name|label
modifier|*
name|solabel
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|label
modifier|*
name|mlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|solabel
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|mlabel
argument_list|)
expr_stmt|;
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_socket_newconn
parameter_list|(
name|struct
name|socket
modifier|*
name|oldso
parameter_list|,
name|struct
name|label
modifier|*
name|oldsolabel
parameter_list|,
name|struct
name|socket
modifier|*
name|newso
parameter_list|,
name|struct
name|label
modifier|*
name|newsolabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|oldsolabel
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|newsolabel
argument_list|)
expr_stmt|;
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_socket_relabel
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|socket
modifier|*
name|so
parameter_list|,
name|struct
name|label
modifier|*
name|solabel
parameter_list|,
name|struct
name|label
modifier|*
name|newlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|newlabel
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|solabel
argument_list|)
expr_stmt|;
name|try_relabel
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_socketpeer_set_from_mbuf
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|label
modifier|*
name|mlabel
parameter_list|,
name|struct
name|socket
modifier|*
name|so
parameter_list|,
name|struct
name|label
modifier|*
name|sopeerlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|mlabel
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|sopeerlabel
argument_list|)
expr_stmt|;
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_socketpeer_set_from_socket
parameter_list|(
name|struct
name|socket
modifier|*
name|oldso
parameter_list|,
name|struct
name|label
modifier|*
name|oldsolabel
parameter_list|,
name|struct
name|socket
modifier|*
name|newso
parameter_list|,
name|struct
name|label
modifier|*
name|newsopeerlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|oldsolabel
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|newsopeerlabel
argument_list|)
expr_stmt|;
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_syncache_create
parameter_list|(
name|struct
name|label
modifier|*
name|label
parameter_list|,
name|struct
name|inpcb
modifier|*
name|inp
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|inp
operator|->
name|inp_label
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|lomac_copy
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_syncache_create_mbuf
parameter_list|(
name|struct
name|label
modifier|*
name|sc_label
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|label
modifier|*
name|mlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|sc_label
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|mlabel
argument_list|)
expr_stmt|;
name|lomac_copy
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_system_check_acct
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
if|if
condition|(
name|lomac_subject_privileged
argument_list|(
name|subj
argument_list|)
condition|)
return|return
operator|(
name|EPERM
operator|)
return|;
if|if
condition|(
operator|!
name|lomac_high_single
argument_list|(
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_system_check_auditctl
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
if|if
condition|(
name|lomac_subject_privileged
argument_list|(
name|subj
argument_list|)
condition|)
return|return
operator|(
name|EPERM
operator|)
return|;
if|if
condition|(
operator|!
name|lomac_high_single
argument_list|(
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_system_check_swapoff
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
if|if
condition|(
name|lomac_subject_privileged
argument_list|(
name|subj
argument_list|)
condition|)
return|return
operator|(
name|EPERM
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_system_check_swapon
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
if|if
condition|(
name|lomac_subject_privileged
argument_list|(
name|subj
argument_list|)
condition|)
return|return
operator|(
name|EPERM
operator|)
return|;
if|if
condition|(
operator|!
name|lomac_high_single
argument_list|(
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_system_check_sysctl
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|sysctl_oid
modifier|*
name|oidp
parameter_list|,
name|void
modifier|*
name|arg1
parameter_list|,
name|int
name|arg2
parameter_list|,
name|struct
name|sysctl_req
modifier|*
name|req
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
comment|/* 	 * Treat sysctl variables without CTLFLAG_ANYBODY flag as lomac/high, 	 * but also require privilege to change them. 	 */
if|if
condition|(
name|req
operator|->
name|newptr
operator|!=
name|NULL
operator|&&
operator|(
name|oidp
operator|->
name|oid_kind
operator|&
name|CTLFLAG_ANYBODY
operator|)
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|notdef
if|if
condition|(
operator|!
name|lomac_subject_dominate_high
argument_list|(
name|subj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
endif|#
directive|endif
if|if
condition|(
name|lomac_subject_privileged
argument_list|(
name|subj
argument_list|)
condition|)
return|return
operator|(
name|EPERM
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_thread_userret
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
name|struct
name|proc
modifier|*
name|p
init|=
name|td
operator|->
name|td_proc
decl_stmt|;
name|struct
name|mac_lomac_proc
modifier|*
name|subj
init|=
name|PSLOT
argument_list|(
name|p
operator|->
name|p_label
argument_list|)
decl_stmt|;
name|struct
name|ucred
modifier|*
name|newcred
decl_stmt|,
modifier|*
name|oldcred
decl_stmt|;
name|int
name|dodrop
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|subj
operator|->
name|mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|subj
operator|->
name|mac_lomac
operator|.
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_UPDATE
condition|)
block|{
name|dodrop
operator|=
literal|0
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|subj
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|newcred
operator|=
name|crget
argument_list|()
expr_stmt|;
comment|/* 		 * Prevent a lock order reversal in mac_proc_vm_revoke; 		 * ideally, the other user of subj->mtx wouldn't be holding 		 * Giant. 		 */
name|mtx_lock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
name|PROC_LOCK
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|subj
operator|->
name|mtx
argument_list|)
expr_stmt|;
comment|/* 		 * Check if we lost the race while allocating the cred. 		 */
if|if
condition|(
operator|(
name|subj
operator|->
name|mac_lomac
operator|.
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_UPDATE
operator|)
operator|==
literal|0
condition|)
block|{
name|crfree
argument_list|(
name|newcred
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|oldcred
operator|=
name|p
operator|->
name|p_ucred
expr_stmt|;
name|crcopy
argument_list|(
name|newcred
argument_list|,
name|oldcred
argument_list|)
expr_stmt|;
name|crhold
argument_list|(
name|newcred
argument_list|)
expr_stmt|;
name|lomac_copy
argument_list|(
operator|&
name|subj
operator|->
name|mac_lomac
argument_list|,
name|SLOT
argument_list|(
name|newcred
operator|->
name|cr_label
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|->
name|p_ucred
operator|=
name|newcred
expr_stmt|;
name|crfree
argument_list|(
name|oldcred
argument_list|)
expr_stmt|;
name|dodrop
operator|=
literal|1
expr_stmt|;
name|out
label|:
name|mtx_unlock
argument_list|(
operator|&
name|subj
operator|->
name|mtx
argument_list|)
expr_stmt|;
name|PROC_UNLOCK
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|dodrop
condition|)
name|mac_proc_vm_revoke
argument_list|(
name|curthread
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mtx_unlock
argument_list|(
operator|&
name|subj
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_vnode_associate_extattr
parameter_list|(
name|struct
name|mount
modifier|*
name|mp
parameter_list|,
name|struct
name|label
modifier|*
name|mplabel
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|)
block|{
name|struct
name|mac_lomac
name|ml_temp
decl_stmt|,
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|int
name|buflen
decl_stmt|,
name|error
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|mplabel
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
name|buflen
operator|=
sizeof|sizeof
argument_list|(
name|ml_temp
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|ml_temp
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
name|error
operator|=
name|vn_extattr_get
argument_list|(
name|vp
argument_list|,
name|IO_NODELOCKED
argument_list|,
name|MAC_LOMAC_EXTATTR_NAMESPACE
argument_list|,
name|MAC_LOMAC_EXTATTR_NAME
argument_list|,
operator|&
name|buflen
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ml_temp
argument_list|,
name|curthread
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
name|ENOATTR
operator|||
name|error
operator|==
name|EOPNOTSUPP
condition|)
block|{
comment|/* Fall back to the mntlabel. */
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|buflen
operator|!=
sizeof|sizeof
argument_list|(
name|ml_temp
argument_list|)
condition|)
block|{
if|if
condition|(
name|buflen
operator|!=
sizeof|sizeof
argument_list|(
name|ml_temp
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
name|ml_temp
operator|.
name|ml_auxsingle
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"lomac_vnode_associate_extattr: bad size %d\n"
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
return|return
operator|(
name|EPERM
operator|)
return|;
block|}
name|bzero
argument_list|(
operator|&
name|ml_temp
operator|.
name|ml_auxsingle
argument_list|,
sizeof|sizeof
argument_list|(
name|ml_temp
operator|.
name|ml_auxsingle
argument_list|)
argument_list|)
expr_stmt|;
name|buflen
operator|=
sizeof|sizeof
argument_list|(
name|ml_temp
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|vn_extattr_set
argument_list|(
name|vp
argument_list|,
name|IO_NODELOCKED
argument_list|,
name|MAC_LOMAC_EXTATTR_NAMESPACE
argument_list|,
name|MAC_LOMAC_EXTATTR_NAME
argument_list|,
name|buflen
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ml_temp
argument_list|,
name|curthread
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|lomac_valid
argument_list|(
operator|&
name|ml_temp
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"lomac_vnode_associate_extattr: invalid\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EPERM
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|ml_temp
operator|.
name|ml_flags
operator|&
name|MAC_LOMAC_FLAGS_BOTH
operator|)
operator|!=
name|MAC_LOMAC_FLAG_SINGLE
condition|)
block|{
name|printf
argument_list|(
literal|"lomac_vnode_associate_extattr: not single\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EPERM
operator|)
return|;
block|}
name|lomac_copy_single
argument_list|(
operator|&
name|ml_temp
argument_list|,
name|dest
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_vnode_associate_singlelabel
parameter_list|(
name|struct
name|mount
modifier|*
name|mp
parameter_list|,
name|struct
name|label
modifier|*
name|mplabel
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|mplabel
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_vnode_check_create
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|vnode
modifier|*
name|dvp
parameter_list|,
name|struct
name|label
modifier|*
name|dvplabel
parameter_list|,
name|struct
name|componentname
modifier|*
name|cnp
parameter_list|,
name|struct
name|vattr
modifier|*
name|vap
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|dvplabel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lomac_subject_dominate
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
if|if
condition|(
name|obj
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_AUX
operator|&&
operator|!
name|lomac_dominate_element
argument_list|(
operator|&
name|subj
operator|->
name|ml_single
argument_list|,
operator|&
name|obj
operator|->
name|ml_auxsingle
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_vnode_check_deleteacl
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|,
name|acl_type_t
name|type
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lomac_subject_dominate
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_vnode_check_link
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|vnode
modifier|*
name|dvp
parameter_list|,
name|struct
name|label
modifier|*
name|dvplabel
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|,
name|struct
name|componentname
modifier|*
name|cnp
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|dvplabel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lomac_subject_dominate
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
name|obj
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lomac_subject_dominate
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_vnode_check_mmap
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|,
name|int
name|prot
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
comment|/* 	 * Rely on the use of open()-time protections to handle 	 * non-revocation cases. 	 */
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|prot
operator|&
name|VM_PROT_WRITE
operator|)
operator|!=
literal|0
operator|)
operator|&&
operator|(
operator|(
name|flags
operator|&
name|MAP_SHARED
operator|)
operator|!=
literal|0
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|lomac_subject_dominate
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
block|}
if|if
condition|(
name|prot
operator|&
operator|(
name|VM_PROT_READ
operator||
name|VM_PROT_EXECUTE
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|lomac_dominate_single
argument_list|(
name|obj
argument_list|,
name|subj
argument_list|)
condition|)
return|return
operator|(
name|maybe_demote
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|,
literal|"mapping"
argument_list|,
literal|"file"
argument_list|,
name|vp
argument_list|)
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_vnode_check_mmap_downgrade
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|,
comment|/* XXX vm_prot_t */
name|int
modifier|*
name|prot
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
comment|/* 	 * Rely on the use of open()-time protections to handle 	 * non-revocation cases. 	 */
if|if
condition|(
operator|!
name|lomac_enabled
operator|||
operator|!
name|revocation_enabled
condition|)
return|return;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lomac_subject_dominate
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|)
condition|)
operator|*
name|prot
operator|&=
operator|~
name|VM_PROT_WRITE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_vnode_check_open
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|,
name|accmode_t
name|accmode
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
comment|/* XXX privilege override for admin? */
if|if
condition|(
name|accmode
operator|&
operator|(
name|VWRITE
operator||
name|VAPPEND
operator||
name|VADMIN
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|lomac_subject_dominate
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_vnode_check_read
parameter_list|(
name|struct
name|ucred
modifier|*
name|active_cred
parameter_list|,
name|struct
name|ucred
modifier|*
name|file_cred
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
operator|||
operator|!
name|revocation_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|active_cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lomac_dominate_single
argument_list|(
name|obj
argument_list|,
name|subj
argument_list|)
condition|)
return|return
operator|(
name|maybe_demote
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|,
literal|"reading"
argument_list|,
literal|"file"
argument_list|,
name|vp
argument_list|)
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_vnode_check_relabel
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|,
name|struct
name|label
modifier|*
name|newlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|old
decl_stmt|,
modifier|*
name|new
decl_stmt|,
modifier|*
name|subj
decl_stmt|;
name|int
name|error
decl_stmt|;
name|old
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
name|new
operator|=
name|SLOT
argument_list|(
name|newlabel
argument_list|)
expr_stmt|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
comment|/* 	 * If there is a LOMAC label update for the vnode, it must be a 	 * single label, with an optional explicit auxiliary single. 	 */
name|error
operator|=
name|lomac_atmostflags
argument_list|(
name|new
argument_list|,
name|MAC_LOMAC_FLAG_SINGLE
operator||
name|MAC_LOMAC_FLAG_AUX
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* 	 * To perform a relabel of the vnode (LOMAC label or not), LOMAC must 	 * authorize the relabel. 	 */
if|if
condition|(
operator|!
name|lomac_single_in_range
argument_list|(
name|old
argument_list|,
name|subj
argument_list|)
condition|)
return|return
operator|(
name|EPERM
operator|)
return|;
comment|/* 	 * If the LOMAC label is to be changed, authorize as appropriate. 	 */
if|if
condition|(
name|new
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_SINGLE
condition|)
block|{
comment|/* 		 * To change the LOMAC label on a vnode, the new vnode label 		 * must be in the subject range. 		 */
if|if
condition|(
operator|!
name|lomac_single_in_range
argument_list|(
name|new
argument_list|,
name|subj
argument_list|)
condition|)
return|return
operator|(
name|EPERM
operator|)
return|;
comment|/* 		 * To change the LOMAC label on the vnode to be EQUAL, the 		 * subject must have appropriate privilege. 		 */
if|if
condition|(
name|lomac_contains_equal
argument_list|(
name|new
argument_list|)
condition|)
block|{
name|error
operator|=
name|lomac_subject_privileged
argument_list|(
name|subj
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
if|if
condition|(
name|new
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_AUX
condition|)
block|{
comment|/* 		 * Fill in the missing parts from the previous label. 		 */
if|if
condition|(
operator|(
name|new
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_SINGLE
operator|)
operator|==
literal|0
condition|)
name|lomac_copy_single
argument_list|(
name|subj
argument_list|,
name|new
argument_list|)
expr_stmt|;
comment|/* 		 * To change the auxiliary LOMAC label on a vnode, the new 		 * vnode label must be in the subject range. 		 */
if|if
condition|(
operator|!
name|lomac_auxsingle_in_range
argument_list|(
name|new
argument_list|,
name|subj
argument_list|)
condition|)
return|return
operator|(
name|EPERM
operator|)
return|;
comment|/* 		 * To change the auxiliary LOMAC label on the vnode to be 		 * EQUAL, the subject must have appropriate privilege. 		 */
if|if
condition|(
name|lomac_contains_equal
argument_list|(
name|new
argument_list|)
condition|)
block|{
name|error
operator|=
name|lomac_subject_privileged
argument_list|(
name|subj
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_vnode_check_rename_from
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|vnode
modifier|*
name|dvp
parameter_list|,
name|struct
name|label
modifier|*
name|dvplabel
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|,
name|struct
name|componentname
modifier|*
name|cnp
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|dvplabel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lomac_subject_dominate
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
name|obj
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lomac_subject_dominate
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_vnode_check_rename_to
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|vnode
modifier|*
name|dvp
parameter_list|,
name|struct
name|label
modifier|*
name|dvplabel
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|,
name|int
name|samedir
parameter_list|,
name|struct
name|componentname
modifier|*
name|cnp
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|dvplabel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lomac_subject_dominate
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
if|if
condition|(
name|vp
operator|!=
name|NULL
condition|)
block|{
name|obj
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lomac_subject_dominate
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_vnode_check_revoke
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lomac_subject_dominate
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_vnode_check_setacl
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|,
name|acl_type_t
name|type
parameter_list|,
name|struct
name|acl
modifier|*
name|acl
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lomac_subject_dominate
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_vnode_check_setextattr
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|,
name|int
name|attrnamespace
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|struct
name|uio
modifier|*
name|uio
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lomac_subject_dominate
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
comment|/* XXX: protect the MAC EA in a special way? */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_vnode_check_setflags
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|,
name|u_long
name|flags
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lomac_subject_dominate
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_vnode_check_setmode
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|,
name|mode_t
name|mode
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lomac_subject_dominate
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_vnode_check_setowner
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|,
name|uid_t
name|uid
parameter_list|,
name|gid_t
name|gid
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lomac_subject_dominate
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_vnode_check_setutimes
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|,
name|struct
name|timespec
name|atime
parameter_list|,
name|struct
name|timespec
name|mtime
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lomac_subject_dominate
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_vnode_check_unlink
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|vnode
modifier|*
name|dvp
parameter_list|,
name|struct
name|label
modifier|*
name|dvplabel
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|,
name|struct
name|componentname
modifier|*
name|cnp
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|dvplabel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lomac_subject_dominate
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
name|obj
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lomac_subject_dominate
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_vnode_check_write
parameter_list|(
name|struct
name|ucred
modifier|*
name|active_cred
parameter_list|,
name|struct
name|ucred
modifier|*
name|file_cred
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
operator|||
operator|!
name|revocation_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|active_cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lomac_subject_dominate
argument_list|(
name|subj
argument_list|,
name|obj
argument_list|)
condition|)
return|return
operator|(
name|EACCES
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_vnode_create_extattr
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|mount
modifier|*
name|mp
parameter_list|,
name|struct
name|label
modifier|*
name|mplabel
parameter_list|,
name|struct
name|vnode
modifier|*
name|dvp
parameter_list|,
name|struct
name|label
modifier|*
name|dvplabel
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|,
name|struct
name|componentname
modifier|*
name|cnp
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|,
modifier|*
name|dir
decl_stmt|,
name|temp
decl_stmt|;
name|size_t
name|buflen
decl_stmt|;
name|int
name|error
decl_stmt|;
name|buflen
operator|=
sizeof|sizeof
argument_list|(
name|temp
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|temp
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|cred
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
name|dir
operator|=
name|SLOT
argument_list|(
name|dvplabel
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_AUX
condition|)
block|{
name|lomac_copy_auxsingle
argument_list|(
name|dir
argument_list|,
operator|&
name|temp
argument_list|)
expr_stmt|;
name|lomac_set_single
argument_list|(
operator|&
name|temp
argument_list|,
name|dir
operator|->
name|ml_auxsingle
operator|.
name|mle_type
argument_list|,
name|dir
operator|->
name|ml_auxsingle
operator|.
name|mle_grade
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
operator|&
name|temp
argument_list|)
expr_stmt|;
block|}
name|error
operator|=
name|vn_extattr_set
argument_list|(
name|vp
argument_list|,
name|IO_NODELOCKED
argument_list|,
name|MAC_LOMAC_EXTATTR_NAMESPACE
argument_list|,
name|MAC_LOMAC_EXTATTR_NAME
argument_list|,
name|buflen
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|temp
argument_list|,
name|curthread
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|lomac_copy
argument_list|(
operator|&
name|temp
argument_list|,
name|dest
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_vnode_execve_transition
parameter_list|(
name|struct
name|ucred
modifier|*
name|old
parameter_list|,
name|struct
name|ucred
modifier|*
name|new
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|,
name|struct
name|label
modifier|*
name|interpvplabel
parameter_list|,
name|struct
name|image_params
modifier|*
name|imgp
parameter_list|,
name|struct
name|label
modifier|*
name|execlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|,
modifier|*
name|obj
decl_stmt|,
modifier|*
name|robj
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|old
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|new
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
name|robj
operator|=
name|interpvplabel
operator|!=
name|NULL
condition|?
name|SLOT
argument_list|(
name|interpvplabel
argument_list|)
else|:
name|obj
expr_stmt|;
name|lomac_copy
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
comment|/* 	 * If there's an auxiliary label on the real object, respect it and 	 * assume that this level should be assumed immediately if a higher 	 * level is currently in place. 	 */
if|if
condition|(
name|robj
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_AUX
operator|&&
operator|!
name|lomac_dominate_element
argument_list|(
operator|&
name|robj
operator|->
name|ml_auxsingle
argument_list|,
operator|&
name|dest
operator|->
name|ml_single
argument_list|)
operator|&&
name|lomac_auxsingle_in_range
argument_list|(
name|robj
argument_list|,
name|dest
argument_list|)
condition|)
name|lomac_set_single
argument_list|(
name|dest
argument_list|,
name|robj
operator|->
name|ml_auxsingle
operator|.
name|mle_type
argument_list|,
name|robj
operator|->
name|ml_auxsingle
operator|.
name|mle_grade
argument_list|)
expr_stmt|;
comment|/* 	 * Restructuring to use the execve transitioning mechanism instead of 	 * the normal demotion mechanism here would be difficult, so just 	 * copy the label over and perform standard demotion.  This is also 	 * non-optimal because it will result in the intermediate label "new" 	 * being created and immediately recycled. 	 */
if|if
condition|(
name|lomac_enabled
operator|&&
name|revocation_enabled
operator|&&
operator|!
name|lomac_dominate_single
argument_list|(
name|obj
argument_list|,
name|source
argument_list|)
condition|)
operator|(
name|void
operator|)
name|maybe_demote
argument_list|(
name|source
argument_list|,
name|obj
argument_list|,
literal|"executing"
argument_list|,
literal|"file"
argument_list|,
name|vp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_vnode_execve_will_transition
parameter_list|(
name|struct
name|ucred
modifier|*
name|old
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|,
name|struct
name|label
modifier|*
name|interpvplabel
parameter_list|,
name|struct
name|image_params
modifier|*
name|imgp
parameter_list|,
name|struct
name|label
modifier|*
name|execlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|subj
decl_stmt|,
modifier|*
name|obj
decl_stmt|,
modifier|*
name|robj
decl_stmt|;
if|if
condition|(
operator|!
name|lomac_enabled
operator|||
operator|!
name|revocation_enabled
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|subj
operator|=
name|SLOT
argument_list|(
name|old
operator|->
name|cr_label
argument_list|)
expr_stmt|;
name|obj
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
name|robj
operator|=
name|interpvplabel
operator|!=
name|NULL
condition|?
name|SLOT
argument_list|(
name|interpvplabel
argument_list|)
else|:
name|obj
expr_stmt|;
return|return
operator|(
operator|(
name|robj
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_AUX
operator|&&
operator|!
name|lomac_dominate_element
argument_list|(
operator|&
name|robj
operator|->
name|ml_auxsingle
argument_list|,
operator|&
name|subj
operator|->
name|ml_single
argument_list|)
operator|&&
name|lomac_auxsingle_in_range
argument_list|(
name|robj
argument_list|,
name|subj
argument_list|)
operator|)
operator|||
operator|!
name|lomac_dominate_single
argument_list|(
name|obj
argument_list|,
name|subj
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lomac_vnode_relabel
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|,
name|struct
name|label
modifier|*
name|newlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
modifier|*
name|dest
decl_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|newlabel
argument_list|)
expr_stmt|;
name|dest
operator|=
name|SLOT
argument_list|(
name|vplabel
argument_list|)
expr_stmt|;
name|try_relabel
argument_list|(
name|source
argument_list|,
name|dest
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|lomac_vnode_setlabel_extattr
parameter_list|(
name|struct
name|ucred
modifier|*
name|cred
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|label
modifier|*
name|vplabel
parameter_list|,
name|struct
name|label
modifier|*
name|intlabel
parameter_list|)
block|{
name|struct
name|mac_lomac
modifier|*
name|source
decl_stmt|,
name|temp
decl_stmt|;
name|size_t
name|buflen
decl_stmt|;
name|int
name|error
decl_stmt|;
name|buflen
operator|=
sizeof|sizeof
argument_list|(
name|temp
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|temp
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
name|source
operator|=
name|SLOT
argument_list|(
name|intlabel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|source
operator|->
name|ml_flags
operator|&
name|MAC_LOMAC_FLAG_SINGLE
operator|)
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|lomac_copy_single
argument_list|(
name|source
argument_list|,
operator|&
name|temp
argument_list|)
expr_stmt|;
name|error
operator|=
name|vn_extattr_set
argument_list|(
name|vp
argument_list|,
name|IO_NODELOCKED
argument_list|,
name|MAC_LOMAC_EXTATTR_NAMESPACE
argument_list|,
name|MAC_LOMAC_EXTATTR_NAME
argument_list|,
name|buflen
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|temp
argument_list|,
name|curthread
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|mac_policy_ops
name|lomac_ops
init|=
block|{
operator|.
name|mpo_init
operator|=
name|lomac_init
block|,
operator|.
name|mpo_bpfdesc_check_receive
operator|=
name|lomac_bpfdesc_check_receive
block|,
operator|.
name|mpo_bpfdesc_create
operator|=
name|lomac_bpfdesc_create
block|,
operator|.
name|mpo_bpfdesc_create_mbuf
operator|=
name|lomac_bpfdesc_create_mbuf
block|,
operator|.
name|mpo_bpfdesc_destroy_label
operator|=
name|lomac_destroy_label
block|,
operator|.
name|mpo_bpfdesc_init_label
operator|=
name|lomac_init_label
block|,
operator|.
name|mpo_cred_check_relabel
operator|=
name|lomac_cred_check_relabel
block|,
operator|.
name|mpo_cred_check_visible
operator|=
name|lomac_cred_check_visible
block|,
operator|.
name|mpo_cred_copy_label
operator|=
name|lomac_copy_label
block|,
operator|.
name|mpo_cred_create_swapper
operator|=
name|lomac_cred_create_swapper
block|,
operator|.
name|mpo_cred_create_init
operator|=
name|lomac_cred_create_init
block|,
operator|.
name|mpo_cred_destroy_label
operator|=
name|lomac_destroy_label
block|,
operator|.
name|mpo_cred_externalize_label
operator|=
name|lomac_externalize_label
block|,
operator|.
name|mpo_cred_init_label
operator|=
name|lomac_init_label
block|,
operator|.
name|mpo_cred_internalize_label
operator|=
name|lomac_internalize_label
block|,
operator|.
name|mpo_cred_relabel
operator|=
name|lomac_cred_relabel
block|,
operator|.
name|mpo_devfs_create_device
operator|=
name|lomac_devfs_create_device
block|,
operator|.
name|mpo_devfs_create_directory
operator|=
name|lomac_devfs_create_directory
block|,
operator|.
name|mpo_devfs_create_symlink
operator|=
name|lomac_devfs_create_symlink
block|,
operator|.
name|mpo_devfs_destroy_label
operator|=
name|lomac_destroy_label
block|,
operator|.
name|mpo_devfs_init_label
operator|=
name|lomac_init_label
block|,
operator|.
name|mpo_devfs_update
operator|=
name|lomac_devfs_update
block|,
operator|.
name|mpo_devfs_vnode_associate
operator|=
name|lomac_devfs_vnode_associate
block|,
operator|.
name|mpo_ifnet_check_relabel
operator|=
name|lomac_ifnet_check_relabel
block|,
operator|.
name|mpo_ifnet_check_transmit
operator|=
name|lomac_ifnet_check_transmit
block|,
operator|.
name|mpo_ifnet_copy_label
operator|=
name|lomac_copy_label
block|,
operator|.
name|mpo_ifnet_create
operator|=
name|lomac_ifnet_create
block|,
operator|.
name|mpo_ifnet_create_mbuf
operator|=
name|lomac_ifnet_create_mbuf
block|,
operator|.
name|mpo_ifnet_destroy_label
operator|=
name|lomac_destroy_label
block|,
operator|.
name|mpo_ifnet_externalize_label
operator|=
name|lomac_externalize_label
block|,
operator|.
name|mpo_ifnet_init_label
operator|=
name|lomac_init_label
block|,
operator|.
name|mpo_ifnet_internalize_label
operator|=
name|lomac_internalize_label
block|,
operator|.
name|mpo_ifnet_relabel
operator|=
name|lomac_ifnet_relabel
block|,
operator|.
name|mpo_syncache_create
operator|=
name|lomac_syncache_create
block|,
operator|.
name|mpo_syncache_destroy_label
operator|=
name|lomac_destroy_label
block|,
operator|.
name|mpo_syncache_init_label
operator|=
name|lomac_init_label_waitcheck
block|,
operator|.
name|mpo_inpcb_check_deliver
operator|=
name|lomac_inpcb_check_deliver
block|,
operator|.
name|mpo_inpcb_check_visible
operator|=
name|lomac_inpcb_check_visible
block|,
operator|.
name|mpo_inpcb_create
operator|=
name|lomac_inpcb_create
block|,
operator|.
name|mpo_inpcb_create_mbuf
operator|=
name|lomac_inpcb_create_mbuf
block|,
operator|.
name|mpo_inpcb_destroy_label
operator|=
name|lomac_destroy_label
block|,
operator|.
name|mpo_inpcb_init_label
operator|=
name|lomac_init_label_waitcheck
block|,
operator|.
name|mpo_inpcb_sosetlabel
operator|=
name|lomac_inpcb_sosetlabel
block|,
operator|.
name|mpo_ip6q_create
operator|=
name|lomac_ip6q_create
block|,
operator|.
name|mpo_ip6q_destroy_label
operator|=
name|lomac_destroy_label
block|,
operator|.
name|mpo_ip6q_init_label
operator|=
name|lomac_init_label_waitcheck
block|,
operator|.
name|mpo_ip6q_match
operator|=
name|lomac_ip6q_match
block|,
operator|.
name|mpo_ip6q_reassemble
operator|=
name|lomac_ip6q_reassemble
block|,
operator|.
name|mpo_ip6q_update
operator|=
name|lomac_ip6q_update
block|,
operator|.
name|mpo_ipq_create
operator|=
name|lomac_ipq_create
block|,
operator|.
name|mpo_ipq_destroy_label
operator|=
name|lomac_destroy_label
block|,
operator|.
name|mpo_ipq_init_label
operator|=
name|lomac_init_label_waitcheck
block|,
operator|.
name|mpo_ipq_match
operator|=
name|lomac_ipq_match
block|,
operator|.
name|mpo_ipq_reassemble
operator|=
name|lomac_ipq_reassemble
block|,
operator|.
name|mpo_ipq_update
operator|=
name|lomac_ipq_update
block|,
operator|.
name|mpo_kld_check_load
operator|=
name|lomac_kld_check_load
block|,
operator|.
name|mpo_mbuf_copy_label
operator|=
name|lomac_copy_label
block|,
operator|.
name|mpo_mbuf_destroy_label
operator|=
name|lomac_destroy_label
block|,
operator|.
name|mpo_mbuf_init_label
operator|=
name|lomac_init_label_waitcheck
block|,
operator|.
name|mpo_mount_create
operator|=
name|lomac_mount_create
block|,
operator|.
name|mpo_mount_destroy_label
operator|=
name|lomac_destroy_label
block|,
operator|.
name|mpo_mount_init_label
operator|=
name|lomac_init_label
block|,
operator|.
name|mpo_netatalk_aarp_send
operator|=
name|lomac_netatalk_aarp_send
block|,
operator|.
name|mpo_netinet_arp_send
operator|=
name|lomac_netinet_arp_send
block|,
operator|.
name|mpo_netinet_firewall_reply
operator|=
name|lomac_netinet_firewall_reply
block|,
operator|.
name|mpo_netinet_firewall_send
operator|=
name|lomac_netinet_firewall_send
block|,
operator|.
name|mpo_netinet_fragment
operator|=
name|lomac_netinet_fragment
block|,
operator|.
name|mpo_netinet_icmp_reply
operator|=
name|lomac_netinet_icmp_reply
block|,
operator|.
name|mpo_netinet_igmp_send
operator|=
name|lomac_netinet_igmp_send
block|,
operator|.
name|mpo_netinet6_nd6_send
operator|=
name|lomac_netinet6_nd6_send
block|,
operator|.
name|mpo_pipe_check_ioctl
operator|=
name|lomac_pipe_check_ioctl
block|,
operator|.
name|mpo_pipe_check_read
operator|=
name|lomac_pipe_check_read
block|,
operator|.
name|mpo_pipe_check_relabel
operator|=
name|lomac_pipe_check_relabel
block|,
operator|.
name|mpo_pipe_check_write
operator|=
name|lomac_pipe_check_write
block|,
operator|.
name|mpo_pipe_copy_label
operator|=
name|lomac_copy_label
block|,
operator|.
name|mpo_pipe_create
operator|=
name|lomac_pipe_create
block|,
operator|.
name|mpo_pipe_destroy_label
operator|=
name|lomac_destroy_label
block|,
operator|.
name|mpo_pipe_externalize_label
operator|=
name|lomac_externalize_label
block|,
operator|.
name|mpo_pipe_init_label
operator|=
name|lomac_init_label
block|,
operator|.
name|mpo_pipe_internalize_label
operator|=
name|lomac_internalize_label
block|,
operator|.
name|mpo_pipe_relabel
operator|=
name|lomac_pipe_relabel
block|,
operator|.
name|mpo_priv_check
operator|=
name|lomac_priv_check
block|,
operator|.
name|mpo_proc_check_debug
operator|=
name|lomac_proc_check_debug
block|,
operator|.
name|mpo_proc_check_sched
operator|=
name|lomac_proc_check_sched
block|,
operator|.
name|mpo_proc_check_signal
operator|=
name|lomac_proc_check_signal
block|,
operator|.
name|mpo_proc_destroy_label
operator|=
name|lomac_proc_destroy_label
block|,
operator|.
name|mpo_proc_init_label
operator|=
name|lomac_proc_init_label
block|,
operator|.
name|mpo_socket_check_deliver
operator|=
name|lomac_socket_check_deliver
block|,
operator|.
name|mpo_socket_check_relabel
operator|=
name|lomac_socket_check_relabel
block|,
operator|.
name|mpo_socket_check_visible
operator|=
name|lomac_socket_check_visible
block|,
operator|.
name|mpo_socket_copy_label
operator|=
name|lomac_copy_label
block|,
operator|.
name|mpo_socket_create
operator|=
name|lomac_socket_create
block|,
operator|.
name|mpo_socket_create_mbuf
operator|=
name|lomac_socket_create_mbuf
block|,
operator|.
name|mpo_socket_destroy_label
operator|=
name|lomac_destroy_label
block|,
operator|.
name|mpo_socket_externalize_label
operator|=
name|lomac_externalize_label
block|,
operator|.
name|mpo_socket_init_label
operator|=
name|lomac_init_label_waitcheck
block|,
operator|.
name|mpo_socket_internalize_label
operator|=
name|lomac_internalize_label
block|,
operator|.
name|mpo_socket_newconn
operator|=
name|lomac_socket_newconn
block|,
operator|.
name|mpo_socket_relabel
operator|=
name|lomac_socket_relabel
block|,
operator|.
name|mpo_socketpeer_destroy_label
operator|=
name|lomac_destroy_label
block|,
operator|.
name|mpo_socketpeer_externalize_label
operator|=
name|lomac_externalize_label
block|,
operator|.
name|mpo_socketpeer_init_label
operator|=
name|lomac_init_label_waitcheck
block|,
operator|.
name|mpo_socketpeer_set_from_mbuf
operator|=
name|lomac_socketpeer_set_from_mbuf
block|,
operator|.
name|mpo_socketpeer_set_from_socket
operator|=
name|lomac_socketpeer_set_from_socket
block|,
operator|.
name|mpo_syncache_create_mbuf
operator|=
name|lomac_syncache_create_mbuf
block|,
operator|.
name|mpo_system_check_acct
operator|=
name|lomac_system_check_acct
block|,
operator|.
name|mpo_system_check_auditctl
operator|=
name|lomac_system_check_auditctl
block|,
operator|.
name|mpo_system_check_swapoff
operator|=
name|lomac_system_check_swapoff
block|,
operator|.
name|mpo_system_check_swapon
operator|=
name|lomac_system_check_swapon
block|,
operator|.
name|mpo_system_check_sysctl
operator|=
name|lomac_system_check_sysctl
block|,
operator|.
name|mpo_thread_userret
operator|=
name|lomac_thread_userret
block|,
operator|.
name|mpo_vnode_associate_extattr
operator|=
name|lomac_vnode_associate_extattr
block|,
operator|.
name|mpo_vnode_associate_singlelabel
operator|=
name|lomac_vnode_associate_singlelabel
block|,
operator|.
name|mpo_vnode_check_access
operator|=
name|lomac_vnode_check_open
block|,
operator|.
name|mpo_vnode_check_create
operator|=
name|lomac_vnode_check_create
block|,
operator|.
name|mpo_vnode_check_deleteacl
operator|=
name|lomac_vnode_check_deleteacl
block|,
operator|.
name|mpo_vnode_check_link
operator|=
name|lomac_vnode_check_link
block|,
operator|.
name|mpo_vnode_check_mmap
operator|=
name|lomac_vnode_check_mmap
block|,
operator|.
name|mpo_vnode_check_mmap_downgrade
operator|=
name|lomac_vnode_check_mmap_downgrade
block|,
operator|.
name|mpo_vnode_check_open
operator|=
name|lomac_vnode_check_open
block|,
operator|.
name|mpo_vnode_check_read
operator|=
name|lomac_vnode_check_read
block|,
operator|.
name|mpo_vnode_check_relabel
operator|=
name|lomac_vnode_check_relabel
block|,
operator|.
name|mpo_vnode_check_rename_from
operator|=
name|lomac_vnode_check_rename_from
block|,
operator|.
name|mpo_vnode_check_rename_to
operator|=
name|lomac_vnode_check_rename_to
block|,
operator|.
name|mpo_vnode_check_revoke
operator|=
name|lomac_vnode_check_revoke
block|,
operator|.
name|mpo_vnode_check_setacl
operator|=
name|lomac_vnode_check_setacl
block|,
operator|.
name|mpo_vnode_check_setextattr
operator|=
name|lomac_vnode_check_setextattr
block|,
operator|.
name|mpo_vnode_check_setflags
operator|=
name|lomac_vnode_check_setflags
block|,
operator|.
name|mpo_vnode_check_setmode
operator|=
name|lomac_vnode_check_setmode
block|,
operator|.
name|mpo_vnode_check_setowner
operator|=
name|lomac_vnode_check_setowner
block|,
operator|.
name|mpo_vnode_check_setutimes
operator|=
name|lomac_vnode_check_setutimes
block|,
operator|.
name|mpo_vnode_check_unlink
operator|=
name|lomac_vnode_check_unlink
block|,
operator|.
name|mpo_vnode_check_write
operator|=
name|lomac_vnode_check_write
block|,
operator|.
name|mpo_vnode_copy_label
operator|=
name|lomac_copy_label
block|,
operator|.
name|mpo_vnode_create_extattr
operator|=
name|lomac_vnode_create_extattr
block|,
operator|.
name|mpo_vnode_destroy_label
operator|=
name|lomac_destroy_label
block|,
operator|.
name|mpo_vnode_execve_transition
operator|=
name|lomac_vnode_execve_transition
block|,
operator|.
name|mpo_vnode_execve_will_transition
operator|=
name|lomac_vnode_execve_will_transition
block|,
operator|.
name|mpo_vnode_externalize_label
operator|=
name|lomac_externalize_label
block|,
operator|.
name|mpo_vnode_init_label
operator|=
name|lomac_init_label
block|,
operator|.
name|mpo_vnode_internalize_label
operator|=
name|lomac_internalize_label
block|,
operator|.
name|mpo_vnode_relabel
operator|=
name|lomac_vnode_relabel
block|,
operator|.
name|mpo_vnode_setlabel_extattr
operator|=
name|lomac_vnode_setlabel_extattr
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|LOMAC_OBJECTS
value|(MPC_OBJECT_CRED |				\
comment|/* MPC_OBJECT_PROC | */
value|\ 			 MPC_OBJECT_VNODE |				\ 			 MPC_OBJECT_INPCB |				\ 			 MPC_OBJECT_SOCKET |				\ 			 MPC_OBJECT_DEVFS |				\ 			 MPC_OBJECT_MBUF |				\ 			 MPC_OBJECT_IPQ |				\ 			 MPC_OBJECT_IP6Q |				\ 			 MPC_OBJECT_IFNET |				\ 			 MPC_OBJECT_BPFDESC |				\ 			 MPC_OBJECT_PIPE |				\ 			 MPC_OBJECT_MOUNT |				\
comment|/* MPC_OBJECT_POSIXSEM | */
value|\
comment|/* MPC_OBJECT_POSIXSHM | */
value|\
comment|/* MPC_OBJECT_SYSVMSG | */
value|\
comment|/* MPC_OBJECT_SYSVMSQ | */
value|\
comment|/* MPC_OBJECT_SYSVSEM | */
value|\
comment|/* MPC_OBJECT_SYSVSHM | */
value|\ 			 MPC_OBJECT_SYNCACHE)
end_define

begin_expr_stmt
name|MAC_POLICY_SET
argument_list|(
operator|&
name|lomac_ops
argument_list|,
name|mac_lomac
argument_list|,
literal|"TrustedBSD MAC/LOMAC"
argument_list|,
name|MPC_LOADTIME_FLAG_NOTLATE
argument_list|,
operator|&
name|lomac_slot
argument_list|,
name|LOMAC_OBJECTS
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2013 Thomas Skibo  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_comment
comment|/*   * Zynq-7000 Devcfg driver.  This allows programming the PL (FPGA) section  * of Zynq.  *  * Reference: Zynq-7000 All Programmable SoC Technical Reference Manual.  * (v1.4) November 16, 2012.  Xilinx doc UG585.  PL Configuration is  * covered in section 6.4.5.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<machine/stdarg.h>
end_include

begin_include
include|#
directive|include
file|<dev/fdt/fdt_common.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus_subr.h>
end_include

begin_include
include|#
directive|include
file|<arm/xilinx/zy7_slcr.h>
end_include

begin_struct
struct|struct
name|zy7_devcfg_softc
block|{
name|device_t
name|dev
decl_stmt|;
name|struct
name|mtx
name|sc_mtx
decl_stmt|;
name|struct
name|resource
modifier|*
name|mem_res
decl_stmt|;
name|struct
name|resource
modifier|*
name|irq_res
decl_stmt|;
name|struct
name|cdev
modifier|*
name|sc_ctl_dev
decl_stmt|;
name|void
modifier|*
name|intrhandle
decl_stmt|;
name|bus_dma_tag_t
name|dma_tag
decl_stmt|;
name|bus_dmamap_t
name|dma_map
decl_stmt|;
name|int
name|is_open
decl_stmt|;
name|struct
name|sysctl_ctx_list
name|sysctl_tree
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|sysctl_tree_top
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|zy7_devcfg_softc
modifier|*
name|zy7_devcfg_softc_p
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|FCLK_NUM
value|4
end_define

begin_struct
struct|struct
name|zy7_fclk_config
block|{
name|int
name|source
decl_stmt|;
name|int
name|frequency
decl_stmt|;
name|int
name|actual_frequency
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|zy7_fclk_config
name|fclk_configs
index|[
name|FCLK_NUM
index|]
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|DEVCFG_SC_LOCK
parameter_list|(
name|sc
parameter_list|)
value|mtx_lock(&(sc)->sc_mtx)
end_define

begin_define
define|#
directive|define
name|DEVCFG_SC_UNLOCK
parameter_list|(
name|sc
parameter_list|)
value|mtx_unlock(&(sc)->sc_mtx)
end_define

begin_define
define|#
directive|define
name|DEVCFG_SC_LOCK_INIT
parameter_list|(
name|sc
parameter_list|)
define|\
value|mtx_init(&(sc)->sc_mtx, device_get_nameunit((sc)->dev),	\ 	    "zy7_devcfg", MTX_DEF)
end_define

begin_define
define|#
directive|define
name|DEVCFG_SC_LOCK_DESTROY
parameter_list|(
name|sc
parameter_list|)
value|mtx_destroy(&(sc)->sc_mtx);
end_define

begin_define
define|#
directive|define
name|DEVCFG_SC_ASSERT_LOCKED
parameter_list|(
name|sc
parameter_list|)
value|mtx_assert(&(sc)->sc_mtx, MA_OWNED);
end_define

begin_define
define|#
directive|define
name|RD4
parameter_list|(
name|sc
parameter_list|,
name|off
parameter_list|)
value|(bus_read_4((sc)->mem_res, (off)))
end_define

begin_define
define|#
directive|define
name|WR4
parameter_list|(
name|sc
parameter_list|,
name|off
parameter_list|,
name|val
parameter_list|)
value|(bus_write_4((sc)->mem_res, (off), (val)))
end_define

begin_expr_stmt
name|SYSCTL_NODE
argument_list|(
name|_hw
argument_list|,
name|OID_AUTO
argument_list|,
name|fpga
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,	\
literal|"Xilinx Zynq-7000 PL (FPGA) section"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function_decl
specifier|static
name|int
name|zy7_devcfg_sysctl_pl_done
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_expr_stmt
name|SYSCTL_PROC
argument_list|(
name|_hw_fpga
argument_list|,
name|OID_AUTO
argument_list|,
name|pl_done
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|zy7_devcfg_sysctl_pl_done
argument_list|,
literal|"I"
argument_list|,
literal|"PL section config DONE signal"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|zy7_en_level_shifters
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw_fpga
argument_list|,
name|OID_AUTO
argument_list|,
name|en_level_shifters
argument_list|,
name|CTLFLAG_RW
argument_list|,
operator|&
name|zy7_en_level_shifters
argument_list|,
literal|0
argument_list|,
literal|"Enable PS-PL level shifters after device config"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|zy7_ps_vers
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_hw
argument_list|,
name|OID_AUTO
argument_list|,
name|ps_vers
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|zy7_ps_vers
argument_list|,
literal|0
argument_list|,
literal|"Zynq-7000 PS version"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function_decl
specifier|static
name|int
name|zy7_devcfg_fclk_sysctl_level_shifters
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_expr_stmt
name|SYSCTL_PROC
argument_list|(
name|_hw_fpga
argument_list|,
name|OID_AUTO
argument_list|,
name|level_shifters
argument_list|,
name|CTLFLAG_RW
operator||
name|CTLTYPE_INT
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|zy7_devcfg_fclk_sysctl_level_shifters
argument_list|,
literal|"I"
argument_list|,
literal|"Enable/disable level shifters"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* cdev entry points. */
end_comment

begin_function_decl
specifier|static
name|int
name|zy7_devcfg_open
parameter_list|(
name|struct
name|cdev
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|struct
name|thread
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|zy7_devcfg_write
parameter_list|(
name|struct
name|cdev
modifier|*
parameter_list|,
name|struct
name|uio
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|zy7_devcfg_close
parameter_list|(
name|struct
name|cdev
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|struct
name|thread
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|struct
name|cdevsw
name|zy7_devcfg_cdevsw
init|=
block|{
operator|.
name|d_version
operator|=
name|D_VERSION
block|,
operator|.
name|d_open
operator|=
name|zy7_devcfg_open
block|,
operator|.
name|d_write
operator|=
name|zy7_devcfg_write
block|,
operator|.
name|d_close
operator|=
name|zy7_devcfg_close
block|,
operator|.
name|d_name
operator|=
literal|"devcfg"
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Devcfg block registers. */
end_comment

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CTRL
value|0x0000
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CTRL_FORCE_RST
value|(1<<31)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CTRL_PCFG_PROG_B
value|(1<<30)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CTRL_PCFG_POR_CNT_4K
value|(1<<29)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CTRL_PCAP_PR
value|(1<<27)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CTRL_PCAP_MODE
value|(1<<26)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CTRL_QTR_PCAP_RATE_EN
value|(1<<25)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CTRL_MULTIBOOT_EN
value|(1<<24)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CTRL_JTAG_CHAIN_DIS
value|(1<<23)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CTRL_USER_MODE
value|(1<<15)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CTRL_RESVD_WR11
value|(3<<13)
end_define

begin_comment
comment|/* always write 11 */
end_comment

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CTRL_PCFG_AES_FUSE
value|(1<<12)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CTRL_PCFG_AES_EN_MASK
value|(7<<9)
end_define

begin_comment
comment|/* all 1's or 0's */
end_comment

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CTRL_SEU_EN
value|(1<<8)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CTRL_SEC_EN
value|(1<<7)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CTRL_SPNIDEN
value|(1<<6)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CTRL_SPIDEN
value|(1<<5)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CTRL_NIDEN
value|(1<<4)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CTRL_DBGEN
value|(1<<3)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CTRL_DAP_EN_MASK
value|(7<<0)
end_define

begin_comment
comment|/* all 1's to enable */
end_comment

begin_define
define|#
directive|define
name|ZY7_DEVCFG_LOCK
value|0x004
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_LOCK_AES_FUSE_LOCK
value|(1<<4)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_LOCK_AES_EN
value|(1<<3)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_LOCK_SEU_LOCK
value|(1<<2)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_LOCK_SEC_LOCK
value|(1<<1)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_LOCK_DBG_LOCK
value|(1<<0)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CFG
value|0x008
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CFG_RFIFO_TH_MASK
value|(3<<10)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CFG_WFIFO_TH_MASK
value|(3<<8)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CFG_RCLK_EDGE
value|(1<<7)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CFG_WCLK_EDGE
value|(1<<6)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CFG_DIS_SRC_INC
value|(1<<5)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_CFG_DIS_DST_INC
value|(1<<4)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_STATUS
value|0x00C
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_MASK
value|0x010
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_PSS_GTS_USR_B
value|(1<<31)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_PSS_FST_CFG_B
value|(1<<30)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_PSS_GPWRDWN_B
value|(1<<29)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_PSS_GTS_CFG_B
value|(1<<28)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_CFG_RESET_B
value|(1<<27)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_AXI_WTO
value|(1<<23)
end_define

begin_comment
comment|/* axi write timeout */
end_comment

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_AXI_WERR
value|(1<<22)
end_define

begin_comment
comment|/* axi write err */
end_comment

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_AXI_RTO
value|(1<<21)
end_define

begin_comment
comment|/* axi read timeout */
end_comment

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_AXI_RERR
value|(1<<20)
end_define

begin_comment
comment|/* axi read err */
end_comment

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_RX_FIFO_OV
value|(1<<18)
end_define

begin_comment
comment|/* rx fifo overflow */
end_comment

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_WR_FIFO_LVL
value|(1<<17)
end_define

begin_comment
comment|/* wr fifo< level */
end_comment

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_RD_FIFO_LVL
value|(1<<16)
end_define

begin_comment
comment|/* rd fifo>= level */
end_comment

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_DMA_CMD_ERR
value|(1<<15)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_DMA_Q_OV
value|(1<<14)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_DMA_DONE
value|(1<<13)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_DMA_PCAP_DONE
value|(1<<12)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_P2D_LEN_ERR
value|(1<<11)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_PCFG_HMAC_ERR
value|(1<<6)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_PCFG_SEU_ERR
value|(1<<5)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_PCFG_POR_B
value|(1<<4)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_PCFG_CFG_RST
value|(1<<3)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_PCFG_DONE
value|(1<<2)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_PCFG_INIT_PE
value|(1<<1)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_PCFG_INIT_NE
value|(1<<0)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_ERRORS
value|0x00f0f860
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_INT_ALL
value|0xf8f7f87f
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_STATUS
value|0x014
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_STATUS_DMA_CMD_Q_F
value|(1<<31)
end_define

begin_comment
comment|/* cmd queue full */
end_comment

begin_define
define|#
directive|define
name|ZY7_DEVCFG_STATUS_DMA_CMD_Q_E
value|(1<<30)
end_define

begin_comment
comment|/* cmd queue empty */
end_comment

begin_define
define|#
directive|define
name|ZY7_DEVCFG_STATUS_DONE_COUNT_MASK
value|(3<<28)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_STATUS_DONE_COUNT_SHIFT
value|28
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_STATUS_RX_FIFO_LVL_MASK
value|(0x1f<<20)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_STATUS_RX_FIFO_LVL_SHIFT
value|20
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_STATUS_TX_FIFO_LVL_MASK
value|(0x7f<<12)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_STATUS_TX_FIFO_LVL_SHIFT
value|12
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_STATUS_PSS_GTS_USR_B
value|(1<<11)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_STATUS_PSS_FST_CFG_B
value|(1<<10)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_STATUS_PSS_GPWRDWN_B
value|(1<<9)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_STATUS_PSS_GTS_CFG_B
value|(1<<8)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_STATUS_ILL_APB_ACCE
value|(1<<6)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_STATUS_PSS_CFG_RESET_B
value|(1<<5)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_STATUS_PCFG_INIT
value|(1<<4)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_STATUS_EFUSE_BBRAM_KEY_DIS
value|(1<<3)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_STATUS_EFUSE_SEC_EN
value|(1<<2)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_STATUS_EFUSE_JTAG_DIS
value|(1<<1)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_DMA_SRC_ADDR
value|0x018
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_DMA_DST_ADDR
value|0x01c
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_DMA_ADDR_WAIT_PCAP
value|1
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_DMA_ADDR_ILLEGAL
value|0xffffffff
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_DMA_SRC_LEN
value|0x020
end_define

begin_comment
comment|/* in 4-byte words. */
end_comment

begin_define
define|#
directive|define
name|ZY7_DEVCFG_DMA_SRC_LEN_MAX
value|0x7ffffff
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_DMA_DST_LEN
value|0x024
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_ROM_SHADOW
value|0x028
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_MULTIBOOT_ADDR
value|0x02c
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_SW_ID
value|0x030
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_UNLOCK
value|0x034
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_UNLOCK_MAGIC
value|0x757bdf0d
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_MCTRL
value|0x080
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_MCTRL_PS_VERS_MASK
value|(0xf<<28)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_MCTRL_PS_VERS_SHIFT
value|28
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_MCTRL_PCFG_POR_B
value|(1<<8)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_MCTRL_INT_PCAP_LPBK
value|(1<<4)
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_XADCIF_CFG
value|0x100
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_XADCIF_INT_STAT
value|0x104
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_XADCIF_INT_MASK
value|0x108
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_XADCIF_MSTS
value|0x10c
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_XADCIF_CMD_FIFO
value|0x110
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_XADCIF_RD_FIFO
value|0x114
end_define

begin_define
define|#
directive|define
name|ZY7_DEVCFG_XADCIF_MCTL
value|0x118
end_define

begin_function
specifier|static
name|int
name|zy7_devcfg_fclk_sysctl_source
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|char
name|buf
index|[
literal|4
index|]
decl_stmt|;
name|struct
name|zy7_fclk_config
modifier|*
name|cfg
decl_stmt|;
name|int
name|unit
decl_stmt|;
name|int
name|error
decl_stmt|;
name|cfg
operator|=
name|arg1
expr_stmt|;
name|unit
operator|=
name|arg2
expr_stmt|;
switch|switch
condition|(
name|cfg
operator|->
name|source
condition|)
block|{
case|case
name|ZY7_PL_FCLK_SRC_IO
case|:
case|case
name|ZY7_PL_FCLK_SRC_IO_ALT
case|:
name|strncpy
argument_list|(
name|buf
argument_list|,
literal|"IO"
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|ZY7_PL_FCLK_SRC_DDR
case|:
name|strncpy
argument_list|(
name|buf
argument_list|,
literal|"DDR"
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|ZY7_PL_FCLK_SRC_ARM
case|:
name|strncpy
argument_list|(
name|buf
argument_list|,
literal|"ARM"
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|strncpy
argument_list|(
name|buf
argument_list|,
literal|"???"
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|error
operator|=
name|sysctl_handle_string
argument_list|(
name|oidp
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
operator|||
name|req
operator|->
name|newptr
operator|==
name|NULL
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|buf
argument_list|,
literal|"io"
argument_list|)
operator|==
literal|0
condition|)
name|cfg
operator|->
name|source
operator|=
name|ZY7_PL_FCLK_SRC_IO
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|buf
argument_list|,
literal|"ddr"
argument_list|)
operator|==
literal|0
condition|)
name|cfg
operator|->
name|source
operator|=
name|ZY7_PL_FCLK_SRC_DDR
expr_stmt|;
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|buf
argument_list|,
literal|"arm"
argument_list|)
operator|==
literal|0
condition|)
name|cfg
operator|->
name|source
operator|=
name|ZY7_PL_FCLK_SRC_ARM
expr_stmt|;
else|else
return|return
operator|(
name|EINVAL
operator|)
return|;
name|zy7_pl_fclk_set_source
argument_list|(
name|unit
argument_list|,
name|cfg
operator|->
name|source
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|frequency
operator|>
literal|0
condition|)
name|cfg
operator|->
name|actual_frequency
operator|=
name|zy7_pl_fclk_get_freq
argument_list|(
name|unit
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|zy7_devcfg_fclk_sysctl_freq
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|zy7_fclk_config
modifier|*
name|cfg
decl_stmt|;
name|int
name|unit
decl_stmt|;
name|int
name|error
decl_stmt|;
name|int
name|freq
decl_stmt|;
name|int
name|new_actual_freq
decl_stmt|;
name|cfg
operator|=
name|arg1
expr_stmt|;
name|unit
operator|=
name|arg2
expr_stmt|;
name|freq
operator|=
name|cfg
operator|->
name|frequency
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|freq
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
operator|||
name|req
operator|->
name|newptr
operator|==
name|NULL
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|freq
operator|>
literal|0
condition|)
block|{
name|new_actual_freq
operator|=
name|zy7_pl_fclk_set_freq
argument_list|(
name|unit
argument_list|,
name|freq
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_actual_freq
operator|<
literal|0
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
operator|!
name|zy7_pl_fclk_enabled
argument_list|(
name|unit
argument_list|)
condition|)
name|zy7_pl_fclk_enable
argument_list|(
name|unit
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|zy7_pl_fclk_disable
argument_list|(
name|unit
argument_list|)
expr_stmt|;
name|new_actual_freq
operator|=
literal|0
expr_stmt|;
block|}
name|cfg
operator|->
name|frequency
operator|=
name|freq
expr_stmt|;
name|cfg
operator|->
name|actual_frequency
operator|=
name|new_actual_freq
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|zy7_devcfg_fclk_sysctl_level_shifters
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|int
name|error
decl_stmt|,
name|enabled
decl_stmt|;
name|enabled
operator|=
name|zy7_pl_level_shifters_enabled
argument_list|()
expr_stmt|;
name|error
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|enabled
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
operator|||
name|req
operator|->
name|newptr
operator|==
name|NULL
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|enabled
condition|)
name|zy7_pl_level_shifters_enable
argument_list|()
expr_stmt|;
else|else
name|zy7_pl_level_shifters_disable
argument_list|()
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|zy7_devcfg_init_fclk_sysctl
parameter_list|(
name|struct
name|zy7_devcfg_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|sysctl_oid
modifier|*
name|fclk_node
decl_stmt|;
name|char
name|fclk_num
index|[
literal|4
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sysctl_ctx_init
argument_list|(
operator|&
name|sc
operator|->
name|sysctl_tree
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sysctl_tree_top
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
operator|&
name|sc
operator|->
name|sysctl_tree
argument_list|,
name|SYSCTL_STATIC_CHILDREN
argument_list|(
name|_hw_fpga
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"fclk"
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sysctl_tree_top
operator|==
name|NULL
condition|)
block|{
name|sysctl_ctx_free
argument_list|(
operator|&
name|sc
operator|->
name|sysctl_tree
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|FCLK_NUM
condition|;
name|i
operator|++
control|)
block|{
name|snprintf
argument_list|(
name|fclk_num
argument_list|,
sizeof|sizeof
argument_list|(
name|fclk_num
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|fclk_node
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
operator|&
name|sc
operator|->
name|sysctl_tree
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|sysctl_tree_top
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
name|fclk_num
argument_list|,
name|CTLFLAG_RD
argument_list|,
literal|0
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_INT
argument_list|(
operator|&
name|sc
operator|->
name|sysctl_tree
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|fclk_node
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"actual_freq"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|fclk_configs
index|[
name|i
index|]
operator|.
name|actual_frequency
argument_list|,
name|i
argument_list|,
literal|"Actual frequency"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|sc
operator|->
name|sysctl_tree
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|fclk_node
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"freq"
argument_list|,
name|CTLFLAG_RW
operator||
name|CTLTYPE_INT
argument_list|,
operator|&
name|fclk_configs
index|[
name|i
index|]
argument_list|,
name|i
argument_list|,
name|zy7_devcfg_fclk_sysctl_freq
argument_list|,
literal|"I"
argument_list|,
literal|"Configured frequency"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|sc
operator|->
name|sysctl_tree
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|fclk_node
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"source"
argument_list|,
name|CTLFLAG_RW
operator||
name|CTLTYPE_STRING
argument_list|,
operator|&
name|fclk_configs
index|[
name|i
index|]
argument_list|,
name|i
argument_list|,
name|zy7_devcfg_fclk_sysctl_source
argument_list|,
literal|"A"
argument_list|,
literal|"Clock source"
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Enable programming the PL through PCAP. */
end_comment

begin_function
specifier|static
name|void
name|zy7_devcfg_init_hw
parameter_list|(
name|struct
name|zy7_devcfg_softc
modifier|*
name|sc
parameter_list|)
block|{
name|DEVCFG_SC_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Set devcfg control register. */
name|WR4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_CTRL
argument_list|,
name|ZY7_DEVCFG_CTRL_PCFG_PROG_B
operator||
name|ZY7_DEVCFG_CTRL_PCAP_PR
operator||
name|ZY7_DEVCFG_CTRL_PCAP_MODE
operator||
name|ZY7_DEVCFG_CTRL_USER_MODE
operator||
name|ZY7_DEVCFG_CTRL_RESVD_WR11
operator||
name|ZY7_DEVCFG_CTRL_SPNIDEN
operator||
name|ZY7_DEVCFG_CTRL_SPIDEN
operator||
name|ZY7_DEVCFG_CTRL_NIDEN
operator||
name|ZY7_DEVCFG_CTRL_DBGEN
operator||
name|ZY7_DEVCFG_CTRL_DAP_EN_MASK
argument_list|)
expr_stmt|;
comment|/* Turn off internal PCAP loopback. */
name|WR4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_MCTRL
argument_list|,
name|RD4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_MCTRL
argument_list|)
operator|&
operator|~
name|ZY7_DEVCFG_MCTRL_INT_PCAP_LPBK
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Clear previous configuration of the PL by asserting PROG_B. */
end_comment

begin_function
specifier|static
name|int
name|zy7_devcfg_reset_pl
parameter_list|(
name|struct
name|zy7_devcfg_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|devcfg_ctl
decl_stmt|;
name|int
name|tries
decl_stmt|,
name|err
decl_stmt|;
name|DEVCFG_SC_ASSERT_LOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|devcfg_ctl
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_CTRL
argument_list|)
expr_stmt|;
comment|/* Clear sticky bits and set up INIT signal positive edge interrupt. */
name|WR4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_INT_STATUS
argument_list|,
name|ZY7_DEVCFG_INT_ALL
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_INT_MASK
argument_list|,
operator|~
name|ZY7_DEVCFG_INT_PCFG_INIT_PE
argument_list|)
expr_stmt|;
comment|/* Deassert PROG_B (active low). */
name|devcfg_ctl
operator||=
name|ZY7_DEVCFG_CTRL_PCFG_PROG_B
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_CTRL
argument_list|,
name|devcfg_ctl
argument_list|)
expr_stmt|;
comment|/* 	 * Wait for INIT to assert.  If it is already asserted, we may not get 	 * an edge interrupt so cancel it and continue. 	 */
if|if
condition|(
operator|(
name|RD4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_STATUS
argument_list|)
operator|&
name|ZY7_DEVCFG_STATUS_PCFG_INIT
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* Already asserted.  Cancel interrupt. */
name|WR4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_INT_MASK
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Wait for positive edge interrupt. */
name|err
operator|=
name|mtx_sleep
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|PCATCH
argument_list|,
literal|"zy7i1"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
return|return
operator|(
name|err
operator|)
return|;
block|}
comment|/* Reassert PROG_B (active low). */
name|devcfg_ctl
operator|&=
operator|~
name|ZY7_DEVCFG_CTRL_PCFG_PROG_B
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_CTRL
argument_list|,
name|devcfg_ctl
argument_list|)
expr_stmt|;
comment|/* Wait for INIT deasserted.  This happens almost instantly. */
name|tries
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|RD4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_STATUS
argument_list|)
operator|&
name|ZY7_DEVCFG_STATUS_PCFG_INIT
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|++
name|tries
operator|>=
literal|100
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
comment|/* Clear sticky bits and set up INIT positive edge interrupt. */
name|WR4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_INT_STATUS
argument_list|,
name|ZY7_DEVCFG_INT_ALL
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_INT_MASK
argument_list|,
operator|~
name|ZY7_DEVCFG_INT_PCFG_INIT_PE
argument_list|)
expr_stmt|;
comment|/* Deassert PROG_B again. */
name|devcfg_ctl
operator||=
name|ZY7_DEVCFG_CTRL_PCFG_PROG_B
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_CTRL
argument_list|,
name|devcfg_ctl
argument_list|)
expr_stmt|;
comment|/* 	 * Wait for INIT asserted indicating FPGA internal initialization 	 * is complete. 	 */
name|err
operator|=
name|mtx_sleep
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|PCATCH
argument_list|,
literal|"zy7i2"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
return|return
operator|(
name|err
operator|)
return|;
comment|/* Clear sticky DONE bit in interrupt status. */
name|WR4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_INT_STATUS
argument_list|,
name|ZY7_DEVCFG_INT_ALL
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Callback function for bus_dmamap_load(). */
end_comment

begin_function
specifier|static
name|void
name|zy7_dma_cb2
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|seg
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
block|{
if|if
condition|(
operator|!
name|error
operator|&&
name|nsegs
operator|==
literal|1
condition|)
operator|*
operator|(
name|bus_addr_t
operator|*
operator|)
name|arg
operator|=
name|seg
index|[
literal|0
index|]
operator|.
name|ds_addr
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|zy7_devcfg_open
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|int
name|oflags
parameter_list|,
name|int
name|devtype
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
name|struct
name|zy7_devcfg_softc
modifier|*
name|sc
init|=
name|dev
operator|->
name|si_drv1
decl_stmt|;
name|int
name|err
decl_stmt|;
name|DEVCFG_SC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|is_open
condition|)
block|{
name|DEVCFG_SC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|EBUSY
operator|)
return|;
block|}
name|sc
operator|->
name|dma_map
operator|=
name|NULL
expr_stmt|;
name|err
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|PAGE_SIZE
argument_list|,
literal|1
argument_list|,
name|PAGE_SIZE
argument_list|,
literal|0
argument_list|,
name|busdma_lock_mutex
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
operator|&
name|sc
operator|->
name|dma_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|DEVCFG_SC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|sc
operator|->
name|is_open
operator|=
literal|1
expr_stmt|;
name|DEVCFG_SC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|zy7_devcfg_write
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|struct
name|uio
modifier|*
name|uio
parameter_list|,
name|int
name|ioflag
parameter_list|)
block|{
name|struct
name|zy7_devcfg_softc
modifier|*
name|sc
init|=
name|dev
operator|->
name|si_drv1
decl_stmt|;
name|void
modifier|*
name|dma_mem
decl_stmt|;
name|bus_addr_t
name|dma_physaddr
decl_stmt|;
name|int
name|segsz
decl_stmt|,
name|err
decl_stmt|;
name|DEVCFG_SC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* First write?  Reset PL. */
if|if
condition|(
name|uio
operator|->
name|uio_offset
operator|==
literal|0
operator|&&
name|uio
operator|->
name|uio_resid
operator|>
literal|0
condition|)
block|{
name|zy7_devcfg_init_hw
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|zy7_slcr_preload_pl
argument_list|()
expr_stmt|;
name|err
operator|=
name|zy7_devcfg_reset_pl
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|DEVCFG_SC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
block|}
comment|/* Allocate dma memory and load. */
name|err
operator|=
name|bus_dmamem_alloc
argument_list|(
name|sc
operator|->
name|dma_tag
argument_list|,
operator|&
name|dma_mem
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|,
operator|&
name|sc
operator|->
name|dma_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|DEVCFG_SC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|err
operator|=
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|dma_tag
argument_list|,
name|sc
operator|->
name|dma_map
argument_list|,
name|dma_mem
argument_list|,
name|PAGE_SIZE
argument_list|,
name|zy7_dma_cb2
argument_list|,
operator|&
name|dma_physaddr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|bus_dmamem_free
argument_list|(
name|sc
operator|->
name|dma_tag
argument_list|,
name|dma_mem
argument_list|,
name|sc
operator|->
name|dma_map
argument_list|)
expr_stmt|;
name|DEVCFG_SC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
while|while
condition|(
name|uio
operator|->
name|uio_resid
operator|>
literal|0
condition|)
block|{
comment|/* If DONE signal has been set, we shouldn't write anymore. */
if|if
condition|(
operator|(
name|RD4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_INT_STATUS
argument_list|)
operator|&
name|ZY7_DEVCFG_INT_PCFG_DONE
operator|)
operator|!=
literal|0
condition|)
block|{
name|err
operator|=
name|EIO
expr_stmt|;
break|break;
block|}
comment|/* uiomove the data from user buffer to our dma map. */
name|segsz
operator|=
name|MIN
argument_list|(
name|PAGE_SIZE
argument_list|,
name|uio
operator|->
name|uio_resid
argument_list|)
expr_stmt|;
name|DEVCFG_SC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|err
operator|=
name|uiomove
argument_list|(
name|dma_mem
argument_list|,
name|segsz
argument_list|,
name|uio
argument_list|)
expr_stmt|;
name|DEVCFG_SC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
break|break;
comment|/* Flush the cache to memory. */
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|dma_tag
argument_list|,
name|sc
operator|->
name|dma_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
comment|/* Program devcfg's DMA engine.  The ordering of these 		 * register writes is critical. 		 */
if|if
condition|(
name|uio
operator|->
name|uio_resid
operator|>
name|segsz
condition|)
name|WR4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_DMA_SRC_ADDR
argument_list|,
operator|(
name|uint32_t
operator|)
name|dma_physaddr
argument_list|)
expr_stmt|;
else|else
name|WR4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_DMA_SRC_ADDR
argument_list|,
operator|(
name|uint32_t
operator|)
name|dma_physaddr
operator||
name|ZY7_DEVCFG_DMA_ADDR_WAIT_PCAP
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_DMA_DST_ADDR
argument_list|,
name|ZY7_DEVCFG_DMA_ADDR_ILLEGAL
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_DMA_SRC_LEN
argument_list|,
operator|(
name|segsz
operator|+
literal|3
operator|)
operator|/
literal|4
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_DMA_DST_LEN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Now clear done bit and set up DMA done interrupt. */
name|WR4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_INT_STATUS
argument_list|,
name|ZY7_DEVCFG_INT_ALL
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_INT_MASK
argument_list|,
operator|~
name|ZY7_DEVCFG_INT_DMA_DONE
argument_list|)
expr_stmt|;
comment|/* Wait for DMA done interrupt. */
name|err
operator|=
name|mtx_sleep
argument_list|(
name|sc
operator|->
name|dma_map
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
name|PCATCH
argument_list|,
literal|"zy7dma"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
break|break;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|dma_tag
argument_list|,
name|sc
operator|->
name|dma_map
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
comment|/* Check DONE signal. */
if|if
condition|(
operator|(
name|RD4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_INT_STATUS
argument_list|)
operator|&
name|ZY7_DEVCFG_INT_PCFG_DONE
operator|)
operator|!=
literal|0
condition|)
name|zy7_slcr_postload_pl
argument_list|(
name|zy7_en_level_shifters
argument_list|)
expr_stmt|;
block|}
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|dma_tag
argument_list|,
name|sc
operator|->
name|dma_map
argument_list|)
expr_stmt|;
name|bus_dmamem_free
argument_list|(
name|sc
operator|->
name|dma_tag
argument_list|,
name|dma_mem
argument_list|,
name|sc
operator|->
name|dma_map
argument_list|)
expr_stmt|;
name|DEVCFG_SC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|zy7_devcfg_close
parameter_list|(
name|struct
name|cdev
modifier|*
name|dev
parameter_list|,
name|int
name|fflag
parameter_list|,
name|int
name|devtype
parameter_list|,
name|struct
name|thread
modifier|*
name|td
parameter_list|)
block|{
name|struct
name|zy7_devcfg_softc
modifier|*
name|sc
init|=
name|dev
operator|->
name|si_drv1
decl_stmt|;
name|DEVCFG_SC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|is_open
operator|=
literal|0
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|dma_tag
argument_list|)
expr_stmt|;
name|DEVCFG_SC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|zy7_slcr_postload_pl
argument_list|(
name|zy7_en_level_shifters
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|zy7_devcfg_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|zy7_devcfg_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|zy7_devcfg_softc
operator|*
operator|)
name|arg
decl_stmt|;
name|uint32_t
name|istatus
decl_stmt|,
name|imask
decl_stmt|;
name|DEVCFG_SC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|istatus
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_INT_STATUS
argument_list|)
expr_stmt|;
name|imask
operator|=
operator|~
name|RD4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_INT_MASK
argument_list|)
expr_stmt|;
comment|/* Turn interrupt off. */
name|WR4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_INT_MASK
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|istatus
operator|&
name|imask
operator|)
operator|==
literal|0
condition|)
block|{
name|DEVCFG_SC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* DMA done? */
if|if
condition|(
operator|(
name|istatus
operator|&
name|ZY7_DEVCFG_INT_DMA_DONE
operator|)
operator|!=
literal|0
condition|)
name|wakeup
argument_list|(
name|sc
operator|->
name|dma_map
argument_list|)
expr_stmt|;
comment|/* INIT_B positive edge? */
if|if
condition|(
operator|(
name|istatus
operator|&
name|ZY7_DEVCFG_INT_PCFG_INIT_PE
operator|)
operator|!=
literal|0
condition|)
name|wakeup
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|DEVCFG_SC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* zy7_devcfg_sysctl_pl_done() returns status of the PL_DONE signal.  */
end_comment

begin_function
specifier|static
name|int
name|zy7_devcfg_sysctl_pl_done
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|zy7_devcfg_softc
modifier|*
name|sc
init|=
name|zy7_devcfg_softc_p
decl_stmt|;
name|int
name|pl_done
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|sc
condition|)
block|{
name|DEVCFG_SC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* PCFG_DONE bit is sticky.  Clear it before checking it. */
name|WR4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_INT_STATUS
argument_list|,
name|ZY7_DEVCFG_INT_PCFG_DONE
argument_list|)
expr_stmt|;
name|pl_done
operator|=
operator|(
operator|(
name|RD4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_INT_STATUS
argument_list|)
operator|&
name|ZY7_DEVCFG_INT_PCFG_DONE
operator|)
operator|!=
literal|0
operator|)
expr_stmt|;
name|DEVCFG_SC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|pl_done
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|zy7_devcfg_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
operator|!
name|ofw_bus_status_okay
argument_list|(
name|dev
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
operator|!
name|ofw_bus_is_compatible
argument_list|(
name|dev
argument_list|,
literal|"xlnx,zy7_devcfg"
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Zynq devcfg block"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function_decl
specifier|static
name|int
name|zy7_devcfg_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|zy7_devcfg_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|zy7_devcfg_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|rid
decl_stmt|,
name|err
decl_stmt|;
comment|/* Allow only one attach. */
if|if
condition|(
name|zy7_devcfg_softc_p
operator|!=
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|DEVCFG_SC_LOCK_INIT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Get memory resource. */
name|rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|mem_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mem_res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not allocate memory resources.\n"
argument_list|)
expr_stmt|;
name|zy7_devcfg_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
comment|/* Allocate IRQ. */
name|rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|irq_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|irq_res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot allocate IRQ\n"
argument_list|)
expr_stmt|;
name|zy7_devcfg_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
comment|/* Activate the interrupt. */
name|err
operator|=
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|,
name|INTR_TYPE_MISC
operator||
name|INTR_MPSAFE
argument_list|,
name|NULL
argument_list|,
name|zy7_devcfg_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|intrhandle
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot setup IRQ\n"
argument_list|)
expr_stmt|;
name|zy7_devcfg_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
comment|/* Create /dev/devcfg */
name|sc
operator|->
name|sc_ctl_dev
operator|=
name|make_dev
argument_list|(
operator|&
name|zy7_devcfg_cdevsw
argument_list|,
literal|0
argument_list|,
name|UID_ROOT
argument_list|,
name|GID_WHEEL
argument_list|,
literal|0600
argument_list|,
literal|"devcfg"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_ctl_dev
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"failed to create /dev/devcfg"
argument_list|)
expr_stmt|;
name|zy7_devcfg_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|sc
operator|->
name|sc_ctl_dev
operator|->
name|si_drv1
operator|=
name|sc
expr_stmt|;
name|zy7_devcfg_softc_p
operator|=
name|sc
expr_stmt|;
comment|/* Unlock devcfg registers. */
name|WR4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_UNLOCK
argument_list|,
name|ZY7_DEVCFG_UNLOCK_MAGIC
argument_list|)
expr_stmt|;
comment|/* Make sure interrupts are completely disabled. */
name|WR4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_INT_STATUS
argument_list|,
name|ZY7_DEVCFG_INT_ALL
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_INT_MASK
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
comment|/* Get PS_VERS for SYSCTL. */
name|zy7_ps_vers
operator|=
operator|(
name|RD4
argument_list|(
name|sc
argument_list|,
name|ZY7_DEVCFG_MCTRL
argument_list|)
operator|&
name|ZY7_DEVCFG_MCTRL_PS_VERS_MASK
operator|)
operator|>>
name|ZY7_DEVCFG_MCTRL_PS_VERS_SHIFT
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|FCLK_NUM
condition|;
name|i
operator|++
control|)
block|{
name|fclk_configs
index|[
name|i
index|]
operator|.
name|source
operator|=
name|zy7_pl_fclk_get_source
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|fclk_configs
index|[
name|i
index|]
operator|.
name|actual_frequency
operator|=
name|zy7_pl_fclk_enabled
argument_list|(
name|i
argument_list|)
condition|?
name|zy7_pl_fclk_get_freq
argument_list|(
name|i
argument_list|)
else|:
literal|0
expr_stmt|;
comment|/* Initially assume actual frequency is the configure one */
name|fclk_configs
index|[
name|i
index|]
operator|.
name|frequency
operator|=
name|fclk_configs
index|[
name|i
index|]
operator|.
name|actual_frequency
expr_stmt|;
block|}
if|if
condition|(
name|zy7_devcfg_init_fclk_sysctl
argument_list|(
name|sc
argument_list|)
operator|<
literal|0
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"failed to initialized sysctl tree\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|zy7_devcfg_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|zy7_devcfg_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|sysctl_tree_top
operator|!=
name|NULL
condition|)
block|{
name|sysctl_ctx_free
argument_list|(
operator|&
name|sc
operator|->
name|sysctl_tree
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sysctl_tree_top
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|device_is_attached
argument_list|(
name|dev
argument_list|)
condition|)
name|bus_generic_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Get rid of /dev/devcfg0. */
if|if
condition|(
name|sc
operator|->
name|sc_ctl_dev
operator|!=
name|NULL
condition|)
name|destroy_dev
argument_list|(
name|sc
operator|->
name|sc_ctl_dev
argument_list|)
expr_stmt|;
comment|/* Teardown and release interrupt. */
if|if
condition|(
name|sc
operator|->
name|irq_res
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|intrhandle
condition|)
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|,
name|sc
operator|->
name|intrhandle
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|rman_get_rid
argument_list|(
name|sc
operator|->
name|irq_res
argument_list|)
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|)
expr_stmt|;
block|}
comment|/* Release memory resource. */
if|if
condition|(
name|sc
operator|->
name|mem_res
operator|!=
name|NULL
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|rman_get_rid
argument_list|(
name|sc
operator|->
name|mem_res
argument_list|)
argument_list|,
name|sc
operator|->
name|mem_res
argument_list|)
expr_stmt|;
name|zy7_devcfg_softc_p
operator|=
name|NULL
expr_stmt|;
name|DEVCFG_SC_LOCK_DESTROY
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|zy7_devcfg_methods
index|[]
init|=
block|{
comment|/* device_if */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|zy7_devcfg_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|zy7_devcfg_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|zy7_devcfg_detach
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|zy7_devcfg_driver
init|=
block|{
literal|"zy7_devcfg"
block|,
name|zy7_devcfg_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|zy7_devcfg_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|zy7_devcfg_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|zy7_devcfg
argument_list|,
name|simplebus
argument_list|,
name|zy7_devcfg_driver
argument_list|,
name|zy7_devcfg_devclass
argument_list|, \
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|zy7_devcfg
argument_list|,
name|zy7_slcr
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


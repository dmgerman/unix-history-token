begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2010 Yohanes Nugroho<yohanes@gmail.com>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"opt_platform.h"
end_include

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/if_vlan_var.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|INET
end_ifdef

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<net/bpfdesc.h>
end_include

begin_include
include|#
directive|include
file|<dev/mii/mii.h>
end_include

begin_include
include|#
directive|include
file|<dev/mii/miivar.h>
end_include

begin_include
include|#
directive|include
file|<arm/at91/at91_pmcvar.h>
end_include

begin_include
include|#
directive|include
file|<arm/at91/if_macbreg.h>
end_include

begin_include
include|#
directive|include
file|<arm/at91/if_macbvar.h>
end_include

begin_include
include|#
directive|include
file|<arm/at91/at91_piovar.h>
end_include

begin_include
include|#
directive|include
file|<arm/at91/at91sam9g20reg.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/intr.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|FDT
end_ifdef

begin_include
include|#
directive|include
file|<dev/fdt/fdt_common.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus_subr.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* "device miibus" required.  See GENERIC if you get errors here. */
end_comment

begin_include
include|#
directive|include
file|"miibus_if.h"
end_include

begin_define
define|#
directive|define
name|MACB_LOCK
parameter_list|(
name|_sc
parameter_list|)
value|mtx_lock(&(_sc)->sc_mtx)
end_define

begin_define
define|#
directive|define
name|MACB_UNLOCK
parameter_list|(
name|_sc
parameter_list|)
value|mtx_unlock(&(_sc)->sc_mtx)
end_define

begin_define
define|#
directive|define
name|MACB_LOCK_INIT
parameter_list|(
name|_sc
parameter_list|)
define|\
value|mtx_init(&_sc->sc_mtx, device_get_nameunit(_sc->dev),	\ 	    MTX_NETWORK_LOCK, MTX_DEF)
end_define

begin_define
define|#
directive|define
name|MACB_LOCK_DESTROY
parameter_list|(
name|_sc
parameter_list|)
value|mtx_destroy(&_sc->sc_mtx);
end_define

begin_define
define|#
directive|define
name|MACB_LOCK_ASSERT
parameter_list|(
name|_sc
parameter_list|)
value|mtx_assert(&_sc->sc_mtx, MA_OWNED);
end_define

begin_define
define|#
directive|define
name|MACB_ASSERT_UNLOCKED
parameter_list|(
name|_sc
parameter_list|)
value|mtx_assert(&_sc->sc_mtx, MA_NOTOWNED);
end_define

begin_function
specifier|static
specifier|inline
name|uint32_t
name|read_4
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|,
name|bus_size_t
name|off
parameter_list|)
block|{
return|return
operator|(
name|bus_read_4
argument_list|(
name|sc
operator|->
name|mem_res
argument_list|,
name|off
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|write_4
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|,
name|bus_size_t
name|off
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|bus_write_4
argument_list|(
name|sc
operator|->
name|mem_res
argument_list|,
name|off
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|devclass_t
name|macb_devclass
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ifnet entry points */
end_comment

begin_function_decl
specifier|static
name|void
name|macbinit_locked
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|macbstart_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|macbinit
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|macbstart
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|macbstop
parameter_list|(
name|struct
name|macb_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|macbioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
parameter_list|,
name|caddr_t
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* bus entry points */
end_comment

begin_function_decl
specifier|static
name|int
name|macb_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|macb_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|macb_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* helper functions */
end_comment

begin_function_decl
specifier|static
name|int
name|macb_new_rxbuf
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|,
name|int
name|index
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|macb_free_desc_dma_tx
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|macb_free_desc_dma_rx
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|macb_init_desc_dma_tx
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|macb_watchdog
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|macb_intr_rx_locked
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|,
name|int
name|count
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|macb_intr_task
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|pending
name|__unused
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|macb_intr
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|macb_tx_cleanup
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|int
name|phy_write
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|,
name|int
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|macb_reset
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|macb_deactivate
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|macb_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|macb_free_desc_dma_tx
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|macb_free_desc_dma_rx
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|macb_getaddr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|bus_addr_t
modifier|*
name|paddr
decl_stmt|;
name|KASSERT
argument_list|(
name|nsegs
operator|==
literal|1
argument_list|,
operator|(
literal|"wrong number of segments, should be 1"
operator|)
argument_list|)
expr_stmt|;
name|paddr
operator|=
name|arg
expr_stmt|;
operator|*
name|paddr
operator|=
name|segs
operator|->
name|ds_addr
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|macb_alloc_desc_dma_tx
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
comment|/* Allocate a busdma tag and DMA safe memory for TX/RX descriptors. */
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|sc
operator|->
name|sc_parent_tag
argument_list|,
comment|/* parent */
literal|16
argument_list|,
literal|0
argument_list|,
comment|/* alignment, boundary */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filtfunc, filtfuncarg */
sizeof|sizeof
argument_list|(
expr|struct
name|eth_tx_desc
argument_list|)
operator|*
name|MACB_MAX_TX_BUFFERS
argument_list|,
comment|/* max size */
literal|1
argument_list|,
comment|/* nsegments */
sizeof|sizeof
argument_list|(
expr|struct
name|eth_tx_desc
argument_list|)
operator|*
name|MACB_MAX_TX_BUFFERS
argument_list|,
literal|0
argument_list|,
comment|/* flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockfuncarg */
operator|&
name|sc
operator|->
name|dmatag_data_tx
argument_list|)
expr_stmt|;
comment|/* dmat */
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Couldn't create TX descriptor dma tag\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Allocate memory for TX ring. */
name|error
operator|=
name|bus_dmamem_alloc
argument_list|(
name|sc
operator|->
name|dmatag_data_tx
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
operator|(
name|sc
operator|->
name|desc_tx
operator|)
argument_list|,
name|BUS_DMA_NOWAIT
operator||
name|BUS_DMA_ZERO
operator||
name|BUS_DMA_COHERENT
argument_list|,
operator|&
name|sc
operator|->
name|dmamap_ring_tx
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"failed to allocate TX dma memory\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Load Ring DMA. */
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|dmatag_data_tx
argument_list|,
name|sc
operator|->
name|dmamap_ring_tx
argument_list|,
name|sc
operator|->
name|desc_tx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|eth_tx_desc
argument_list|)
operator|*
name|MACB_MAX_TX_BUFFERS
argument_list|,
name|macb_getaddr
argument_list|,
operator|&
name|sc
operator|->
name|ring_paddr_tx
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"can't load TX descriptor dma map\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Allocate a busdma tag for mbufs. No alignment restriction applys. */
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|sc
operator|->
name|sc_parent_tag
argument_list|,
comment|/* parent */
literal|1
argument_list|,
literal|0
argument_list|,
comment|/* alignment, boundary */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filtfunc, filtfuncarg */
name|MCLBYTES
operator|*
name|MAX_FRAGMENT
argument_list|,
comment|/* maxsize */
name|MAX_FRAGMENT
argument_list|,
comment|/* nsegments */
name|MCLBYTES
argument_list|,
literal|0
argument_list|,
comment|/* maxsegsz, flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockfuncarg */
operator|&
name|sc
operator|->
name|dmatag_ring_tx
argument_list|)
expr_stmt|;
comment|/* dmat */
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"failed to create TX mbuf dma tag\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MACB_MAX_TX_BUFFERS
condition|;
name|i
operator|++
control|)
block|{
comment|/* Create dma map for each descriptor. */
name|error
operator|=
name|bus_dmamap_create
argument_list|(
name|sc
operator|->
name|dmatag_ring_tx
argument_list|,
literal|0
argument_list|,
operator|&
name|sc
operator|->
name|tx_desc
index|[
name|i
index|]
operator|.
name|dmamap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"failed to create TX mbuf dma map\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|macb_free_desc_dma_tx
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|tx_desc_info
modifier|*
name|td
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* TX buffers. */
if|if
condition|(
name|sc
operator|->
name|dmatag_ring_tx
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MACB_MAX_TX_BUFFERS
condition|;
name|i
operator|++
control|)
block|{
name|td
operator|=
operator|&
name|sc
operator|->
name|tx_desc
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|td
operator|->
name|dmamap
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_destroy
argument_list|(
name|sc
operator|->
name|dmatag_ring_tx
argument_list|,
name|td
operator|->
name|dmamap
argument_list|)
expr_stmt|;
name|td
operator|->
name|dmamap
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|dmatag_ring_tx
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dmatag_ring_tx
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* TX descriptor ring. */
if|if
condition|(
name|sc
operator|->
name|dmatag_data_tx
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|ring_paddr_tx
operator|!=
literal|0
condition|)
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|dmatag_data_tx
argument_list|,
name|sc
operator|->
name|dmamap_ring_tx
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|desc_tx
operator|!=
name|NULL
condition|)
name|bus_dmamem_free
argument_list|(
name|sc
operator|->
name|dmatag_data_tx
argument_list|,
name|sc
operator|->
name|desc_tx
argument_list|,
name|sc
operator|->
name|dmamap_ring_tx
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ring_paddr_tx
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|desc_tx
operator|=
name|NULL
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|dmatag_data_tx
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dmatag_data_tx
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|macb_init_desc_dma_tx
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|eth_tx_desc
modifier|*
name|desc
decl_stmt|;
name|int
name|i
decl_stmt|;
name|MACB_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tx_prod
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|tx_cons
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|tx_cnt
operator|=
literal|0
expr_stmt|;
name|desc
operator|=
operator|&
name|sc
operator|->
name|desc_tx
index|[
literal|0
index|]
expr_stmt|;
name|bzero
argument_list|(
name|desc
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|eth_tx_desc
argument_list|)
operator|*
name|MACB_MAX_TX_BUFFERS
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MACB_MAX_TX_BUFFERS
condition|;
name|i
operator|++
control|)
block|{
name|desc
operator|=
operator|&
name|sc
operator|->
name|desc_tx
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|MACB_MAX_TX_BUFFERS
operator|-
literal|1
condition|)
name|desc
operator|->
name|flags
operator|=
name|TD_OWN
operator||
name|TD_WRAP_MASK
expr_stmt|;
else|else
name|desc
operator|->
name|flags
operator|=
name|TD_OWN
expr_stmt|;
block|}
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|dmatag_data_tx
argument_list|,
name|sc
operator|->
name|dmamap_ring_tx
argument_list|,
name|BUS_DMASYNC_PREREAD
operator||
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|macb_alloc_desc_dma_rx
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
comment|/* Allocate a busdma tag and DMA safe memory for RX descriptors. */
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|sc
operator|->
name|sc_parent_tag
argument_list|,
comment|/* parent */
literal|16
argument_list|,
literal|0
argument_list|,
comment|/* alignment, boundary */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filtfunc, filtfuncarg */
comment|/* maxsize, nsegments */
sizeof|sizeof
argument_list|(
expr|struct
name|eth_rx_desc
argument_list|)
operator|*
name|MACB_MAX_RX_BUFFERS
argument_list|,
literal|1
argument_list|,
comment|/* maxsegsz, flags */
sizeof|sizeof
argument_list|(
expr|struct
name|eth_rx_desc
argument_list|)
operator|*
name|MACB_MAX_RX_BUFFERS
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockfuncarg */
operator|&
name|sc
operator|->
name|dmatag_data_rx
argument_list|)
expr_stmt|;
comment|/* dmat */
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Couldn't create RX descriptor dma tag\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Allocate RX ring. */
name|error
operator|=
name|bus_dmamem_alloc
argument_list|(
name|sc
operator|->
name|dmatag_data_rx
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
operator|(
name|sc
operator|->
name|desc_rx
operator|)
argument_list|,
name|BUS_DMA_NOWAIT
operator||
name|BUS_DMA_ZERO
operator||
name|BUS_DMA_COHERENT
argument_list|,
operator|&
name|sc
operator|->
name|dmamap_ring_rx
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"failed to allocate RX descriptor dma memory\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Load dmamap. */
name|error
operator|=
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|dmatag_data_rx
argument_list|,
name|sc
operator|->
name|dmamap_ring_rx
argument_list|,
name|sc
operator|->
name|desc_rx
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|eth_rx_desc
argument_list|)
operator|*
name|MACB_MAX_RX_BUFFERS
argument_list|,
name|macb_getaddr
argument_list|,
operator|&
name|sc
operator|->
name|ring_paddr_rx
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"can't load RX descriptor dma map\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Allocate a busdma tag for mbufs. */
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|sc
operator|->
name|sc_parent_tag
argument_list|,
comment|/* parent */
literal|16
argument_list|,
literal|0
argument_list|,
comment|/* alignment, boundary */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filtfunc, filtfuncarg */
name|MCLBYTES
argument_list|,
literal|1
argument_list|,
comment|/* maxsize, nsegments */
name|MCLBYTES
argument_list|,
literal|0
argument_list|,
comment|/* maxsegsz, flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockfuncarg */
operator|&
name|sc
operator|->
name|dmatag_ring_rx
argument_list|)
expr_stmt|;
comment|/* dmat */
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"failed to create RX mbuf dma tag\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MACB_MAX_RX_BUFFERS
condition|;
name|i
operator|++
control|)
block|{
name|error
operator|=
name|bus_dmamap_create
argument_list|(
name|sc
operator|->
name|dmatag_ring_rx
argument_list|,
literal|0
argument_list|,
operator|&
name|sc
operator|->
name|rx_desc
index|[
name|i
index|]
operator|.
name|dmamap
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"failed to create RX mbuf dmamap\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|macb_free_desc_dma_rx
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|rx_desc_info
modifier|*
name|rd
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* RX buffers. */
if|if
condition|(
name|sc
operator|->
name|dmatag_ring_rx
operator|!=
name|NULL
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MACB_MAX_RX_BUFFERS
condition|;
name|i
operator|++
control|)
block|{
name|rd
operator|=
operator|&
name|sc
operator|->
name|rx_desc
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|rd
operator|->
name|dmamap
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_destroy
argument_list|(
name|sc
operator|->
name|dmatag_ring_rx
argument_list|,
name|rd
operator|->
name|dmamap
argument_list|)
expr_stmt|;
name|rd
operator|->
name|dmamap
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|dmatag_ring_rx
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dmatag_ring_rx
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* RX descriptor ring. */
if|if
condition|(
name|sc
operator|->
name|dmatag_data_rx
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|ring_paddr_rx
operator|!=
literal|0
condition|)
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|dmatag_data_rx
argument_list|,
name|sc
operator|->
name|dmamap_ring_rx
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|desc_rx
operator|!=
name|NULL
condition|)
name|bus_dmamem_free
argument_list|(
name|sc
operator|->
name|dmatag_data_rx
argument_list|,
name|sc
operator|->
name|desc_rx
argument_list|,
name|sc
operator|->
name|dmamap_ring_rx
argument_list|)
expr_stmt|;
name|sc
operator|->
name|ring_paddr_rx
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|desc_rx
operator|=
name|NULL
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|dmatag_data_rx
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dmatag_data_rx
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|macb_init_desc_dma_rx
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|eth_rx_desc
modifier|*
name|desc
decl_stmt|;
name|struct
name|rx_desc_info
modifier|*
name|rd
decl_stmt|;
name|int
name|i
decl_stmt|;
name|MACB_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rx_cons
operator|=
literal|0
expr_stmt|;
name|desc
operator|=
operator|&
name|sc
operator|->
name|desc_rx
index|[
literal|0
index|]
expr_stmt|;
name|bzero
argument_list|(
name|desc
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|eth_rx_desc
argument_list|)
operator|*
name|MACB_MAX_RX_BUFFERS
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MACB_MAX_RX_BUFFERS
condition|;
name|i
operator|++
control|)
block|{
name|rd
operator|=
operator|&
name|sc
operator|->
name|rx_desc
index|[
name|i
index|]
expr_stmt|;
name|rd
operator|->
name|buff
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|macb_new_rxbuf
argument_list|(
name|sc
argument_list|,
name|i
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|dmatag_ring_rx
argument_list|,
name|sc
operator|->
name|dmamap_ring_rx
argument_list|,
name|BUS_DMASYNC_PREREAD
operator||
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macb_new_rxbuf
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|,
name|int
name|index
parameter_list|)
block|{
name|struct
name|rx_desc_info
modifier|*
name|rd
decl_stmt|;
name|struct
name|eth_rx_desc
modifier|*
name|desc
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|bus_dma_segment_t
name|seg
index|[
literal|1
index|]
decl_stmt|;
name|int
name|error
decl_stmt|,
name|nsegs
decl_stmt|;
name|m
operator|=
name|m_getcl
argument_list|(
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOBUFS
operator|)
return|;
name|m
operator|->
name|m_len
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|MCLBYTES
operator|-
name|ETHER_ALIGN
expr_stmt|;
name|rd
operator|=
operator|&
name|sc
operator|->
name|rx_desc
index|[
name|index
index|]
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|dmatag_ring_rx
argument_list|,
name|rd
operator|->
name|dmamap
argument_list|)
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|sc
operator|->
name|dmatag_ring_rx
argument_list|,
name|rd
operator|->
name|dmamap
argument_list|,
name|m
argument_list|,
name|seg
argument_list|,
operator|&
name|nsegs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|nsegs
operator|==
literal|1
argument_list|,
operator|(
literal|"Too many segments returned!"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|m_free
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|dmatag_ring_rx
argument_list|,
name|rd
operator|->
name|dmamap
argument_list|,
name|BUS_DMASYNC_PREREAD
argument_list|)
expr_stmt|;
name|rd
operator|->
name|buff
operator|=
name|m
expr_stmt|;
name|desc
operator|=
operator|&
name|sc
operator|->
name|desc_rx
index|[
name|index
index|]
expr_stmt|;
name|desc
operator|->
name|addr
operator|=
name|seg
index|[
literal|0
index|]
operator|.
name|ds_addr
expr_stmt|;
name|desc
operator|->
name|flags
operator|=
name|DATA_SIZE
expr_stmt|;
if|if
condition|(
name|index
operator|==
name|MACB_MAX_RX_BUFFERS
operator|-
literal|1
condition|)
name|desc
operator|->
name|addr
operator||=
name|RD_WRAP_MASK
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macb_allocate_dma
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
comment|/* Create parent tag for tx and rx */
name|error
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|,
comment|/* parent */
literal|1
argument_list|,
literal|0
argument_list|,
comment|/* alignment, boundary */
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|BUS_SPACE_MAXSIZE_32BIT
argument_list|,
literal|0
argument_list|,
comment|/* maxsize, nsegments */
name|BUS_SPACE_MAXSIZE_32BIT
argument_list|,
comment|/* maxsegsize */
literal|0
argument_list|,
comment|/* flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockarg */
operator|&
name|sc
operator|->
name|sc_parent_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Couldn't create parent DMA tag\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|error
operator|=
name|macb_alloc_desc_dma_tx
argument_list|(
name|sc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
operator|(
name|error
operator|=
name|macb_alloc_desc_dma_rx
argument_list|(
name|sc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|macb_tick
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
block|{
name|struct
name|macb_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|sc
operator|=
name|xsc
expr_stmt|;
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|miibus
argument_list|)
expr_stmt|;
name|mii_tick
argument_list|(
name|mii
argument_list|)
expr_stmt|;
name|macb_watchdog
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* 	 * Schedule another timeout one second from now. 	 */
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|tick_ch
argument_list|,
name|hz
argument_list|,
name|macb_tick
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|macb_watchdog
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|MACB_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|macb_watchdog_timer
operator|==
literal|0
operator|||
operator|--
name|sc
operator|->
name|macb_watchdog_timer
condition|)
return|return;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|flags
operator|&
name|MACB_FLAG_LINK
operator|)
operator|==
literal|0
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"watchdog timeout (missed link)\n"
argument_list|)
expr_stmt|;
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"watchdog timeout\n"
argument_list|)
expr_stmt|;
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_RUNNING
expr_stmt|;
name|macbinit_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IFQ_DRV_IS_EMPTY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
condition|)
name|macbstart_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|macbinit_locked
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
block|{
name|struct
name|macb_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|int
name|err
decl_stmt|;
name|uint32_t
name|config
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|sc
operator|=
name|xsc
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
name|MACB_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|!=
literal|0
condition|)
return|return;
if|if
condition|(
operator|(
name|err
operator|=
name|macb_init_desc_dma_rx
argument_list|(
name|sc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"no memory for RX buffers\n"
argument_list|)
expr_stmt|;
comment|//ecestop(sc);
return|return;
block|}
name|macb_init_desc_dma_tx
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|config
operator|=
name|read_4
argument_list|(
name|sc
argument_list|,
name|EMAC_NCFGR
argument_list|)
operator||
operator|(
name|sc
operator|->
name|clock
operator|<<
literal|10
operator|)
expr_stmt|;
comment|/*set clock*/
name|config
operator||=
name|CFG_PAE
expr_stmt|;
comment|/* PAuse Enable */
name|config
operator||=
name|CFG_DRFCS
expr_stmt|;
comment|/* Discard Rx FCS */
name|config
operator||=
name|CFG_SPD
expr_stmt|;
comment|/* 100 mbps*/
comment|//config |= CFG_CAF;
name|config
operator||=
name|CFG_FD
expr_stmt|;
name|config
operator||=
name|CFG_RBOF_2
expr_stmt|;
comment|/*offset +2*/
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_NCFGR
argument_list|,
name|config
argument_list|)
expr_stmt|;
comment|/* Initialize TX and RX buffers */
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_RBQP
argument_list|,
name|sc
operator|->
name|ring_paddr_rx
argument_list|)
expr_stmt|;
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_TBQP
argument_list|,
name|sc
operator|->
name|ring_paddr_tx
argument_list|)
expr_stmt|;
comment|/* Enable TX and RX */
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_NCR
argument_list|,
name|RX_ENABLE
operator||
name|TX_ENABLE
operator||
name|MPE_ENABLE
argument_list|)
expr_stmt|;
comment|/* Enable interrupts */
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_IER
argument_list|,
operator|(
name|RCOMP_INTERRUPT
operator||
name|RXUBR_INTERRUPT
operator||
name|TUND_INTERRUPT
operator||
name|RLE_INTERRUPT
operator||
name|TXERR_INTERRUPT
operator||
name|ROVR_INTERRUPT
operator||
name|HRESP_INTERRUPT
operator||
name|TCOMP_INTERRUPT
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * Set 'running' flag, and clear output active flag 	 * and attempt to start the output 	 */
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|miibus
argument_list|)
expr_stmt|;
name|sc
operator|->
name|flags
operator||=
name|MACB_FLAG_LINK
expr_stmt|;
name|mii_mediachg
argument_list|(
name|mii
argument_list|)
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|tick_ch
argument_list|,
name|hz
argument_list|,
name|macb_tick
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|macb_tx_cleanup
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|eth_tx_desc
modifier|*
name|desc
decl_stmt|;
name|struct
name|tx_desc_info
modifier|*
name|td
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|int
name|status
decl_stmt|;
name|int
name|i
decl_stmt|;
name|MACB_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|status
operator|=
name|read_4
argument_list|(
name|sc
argument_list|,
name|EMAC_TSR
argument_list|)
expr_stmt|;
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_TSR
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/*buffer underrun*/
if|if
condition|(
operator|(
name|status
operator|&
name|TSR_UND
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/*reset buffers*/
name|printf
argument_list|(
literal|"underrun\n"
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|dmatag_data_tx
argument_list|,
name|sc
operator|->
name|dmamap_ring_tx
argument_list|,
name|BUS_DMASYNC_POSTREAD
operator||
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tx_cons
operator|=
name|sc
operator|->
name|tx_prod
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MACB_MAX_TX_BUFFERS
condition|;
name|i
operator|++
control|)
block|{
name|desc
operator|=
operator|&
name|sc
operator|->
name|desc_tx
index|[
name|i
index|]
expr_stmt|;
name|desc
operator|->
name|flags
operator|=
name|TD_OWN
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MACB_MAX_TX_BUFFERS
condition|;
name|i
operator|++
control|)
block|{
name|td
operator|=
operator|&
name|sc
operator|->
name|tx_desc
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|td
operator|->
name|buff
operator|!=
name|NULL
condition|)
block|{
comment|/* We are finished with this descriptor. */
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|dmatag_ring_tx
argument_list|,
name|td
operator|->
name|dmamap
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
comment|/* ... and unload, so we can reuse. */
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|dmatag_data_tx
argument_list|,
name|td
operator|->
name|dmamap
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|td
operator|->
name|buff
argument_list|)
expr_stmt|;
name|td
operator|->
name|buff
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
operator|(
name|status
operator|&
name|TSR_COMP
operator|)
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|sc
operator|->
name|tx_cons
operator|==
name|sc
operator|->
name|tx_prod
condition|)
return|return;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
comment|/* Prepare to read the ring (owner bit). */
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|dmatag_data_tx
argument_list|,
name|sc
operator|->
name|dmamap_ring_tx
argument_list|,
name|BUS_DMASYNC_POSTREAD
operator||
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
while|while
condition|(
name|sc
operator|->
name|tx_cons
operator|!=
name|sc
operator|->
name|tx_prod
condition|)
block|{
name|desc
operator|=
operator|&
name|sc
operator|->
name|desc_tx
index|[
name|sc
operator|->
name|tx_cons
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|desc
operator|->
name|flags
operator|&
name|TD_OWN
operator|)
operator|==
literal|0
condition|)
break|break;
name|td
operator|=
operator|&
name|sc
operator|->
name|tx_desc
index|[
name|sc
operator|->
name|tx_cons
index|]
expr_stmt|;
if|if
condition|(
name|td
operator|->
name|buff
operator|!=
name|NULL
condition|)
block|{
comment|/* We are finished with this descriptor. */
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|dmatag_ring_tx
argument_list|,
name|td
operator|->
name|dmamap
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
comment|/* ... and unload, so we can reuse. */
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|dmatag_data_tx
argument_list|,
name|td
operator|->
name|dmamap
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|td
operator|->
name|buff
argument_list|)
expr_stmt|;
name|td
operator|->
name|buff
operator|=
name|NULL
expr_stmt|;
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OPACKETS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
do|do
block|{
name|sc
operator|->
name|tx_cnt
operator|--
expr_stmt|;
name|MACB_DESC_INC
argument_list|(
name|sc
operator|->
name|tx_cons
argument_list|,
name|MACB_MAX_TX_BUFFERS
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|flags
operator|=
name|desc
operator|->
name|flags
expr_stmt|;
name|desc
operator|->
name|flags
operator|=
name|TD_OWN
expr_stmt|;
name|desc
operator|=
operator|&
name|sc
operator|->
name|desc_tx
index|[
name|sc
operator|->
name|tx_cons
index|]
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|TD_LAST
condition|)
block|{
break|break;
block|}
block|}
do|while
condition|(
name|sc
operator|->
name|tx_cons
operator|!=
name|sc
operator|->
name|tx_prod
condition|)
do|;
block|}
comment|/* Unarm watchog timer when there is no pending descriptors in queue. */
if|if
condition|(
name|sc
operator|->
name|tx_cnt
operator|==
literal|0
condition|)
name|sc
operator|->
name|macb_watchdog_timer
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|macb_rx
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|eth_rx_desc
modifier|*
name|rxdesc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|int
name|rxbytes
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|int
name|nsegs
decl_stmt|;
name|int
name|first
decl_stmt|;
name|rxdesc
operator|=
operator|&
operator|(
name|sc
operator|->
name|desc_rx
index|[
name|sc
operator|->
name|rx_cons
index|]
operator|)
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|dmatag_ring_rx
argument_list|,
name|sc
operator|->
name|dmamap_ring_rx
argument_list|,
name|BUS_DMASYNC_POSTREAD
operator||
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|nsegs
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|rxdesc
operator|->
name|addr
operator|&
name|RD_OWN
condition|)
block|{
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
break|break;
name|flags
operator|=
name|rxdesc
operator|->
name|flags
expr_stmt|;
name|rxbytes
operator|=
name|flags
operator|&
name|RD_LEN_MASK
expr_stmt|;
name|m
operator|=
name|sc
operator|->
name|rx_desc
index|[
name|sc
operator|->
name|rx_cons
index|]
operator|.
name|buff
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|dmatag_ring_rx
argument_list|,
name|sc
operator|->
name|rx_desc
index|[
name|sc
operator|->
name|rx_cons
index|]
operator|.
name|dmamap
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
if|if
condition|(
name|macb_new_rxbuf
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|rx_cons
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_IQDROPS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|first
operator|=
name|sc
operator|->
name|rx_cons
expr_stmt|;
do|do
block|{
name|rxdesc
operator|->
name|flags
operator|=
name|DATA_SIZE
expr_stmt|;
name|MACB_DESC_INC
argument_list|(
name|sc
operator|->
name|rx_cons
argument_list|,
name|MACB_MAX_RX_BUFFERS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rxdesc
operator|->
name|flags
operator|&
name|RD_EOF
operator|)
operator|!=
literal|0
condition|)
break|break;
name|rxdesc
operator|=
operator|&
operator|(
name|sc
operator|->
name|desc_rx
index|[
name|sc
operator|->
name|rx_cons
index|]
operator|)
expr_stmt|;
block|}
do|while
condition|(
name|sc
operator|->
name|rx_cons
operator|!=
name|first
condition|)
do|;
if|if
condition|(
name|sc
operator|->
name|macb_cdata
operator|.
name|rxhead
operator|!=
name|NULL
condition|)
block|{
name|m_freem
argument_list|(
name|sc
operator|->
name|macb_cdata
operator|.
name|rxhead
argument_list|)
expr_stmt|;
name|sc
operator|->
name|macb_cdata
operator|.
name|rxhead
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|macb_cdata
operator|.
name|rxtail
operator|=
name|NULL
expr_stmt|;
block|}
break|break;
block|}
name|nsegs
operator|++
expr_stmt|;
comment|/* Chain received mbufs. */
if|if
condition|(
name|sc
operator|->
name|macb_cdata
operator|.
name|rxhead
operator|==
name|NULL
condition|)
block|{
name|m
operator|->
name|m_data
operator|+=
literal|2
expr_stmt|;
name|sc
operator|->
name|macb_cdata
operator|.
name|rxhead
operator|=
name|m
expr_stmt|;
name|sc
operator|->
name|macb_cdata
operator|.
name|rxtail
operator|=
name|m
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|RD_EOF
condition|)
name|m
operator|->
name|m_len
operator|=
name|rxbytes
expr_stmt|;
else|else
name|m
operator|->
name|m_len
operator|=
name|DATA_SIZE
operator|-
literal|2
expr_stmt|;
block|}
else|else
block|{
name|m
operator|->
name|m_flags
operator|&=
operator|~
name|M_PKTHDR
expr_stmt|;
name|m
operator|->
name|m_len
operator|=
name|DATA_SIZE
expr_stmt|;
name|sc
operator|->
name|macb_cdata
operator|.
name|rxtail
operator|->
name|m_next
operator|=
name|m
expr_stmt|;
name|sc
operator|->
name|macb_cdata
operator|.
name|rxtail
operator|=
name|m
expr_stmt|;
block|}
if|if
condition|(
name|flags
operator|&
name|RD_EOF
condition|)
block|{
if|if
condition|(
name|nsegs
operator|>
literal|1
condition|)
block|{
name|sc
operator|->
name|macb_cdata
operator|.
name|rxtail
operator|->
name|m_len
operator|=
operator|(
name|rxbytes
operator|-
operator|(
operator|(
name|nsegs
operator|-
literal|1
operator|)
operator|*
name|DATA_SIZE
operator|)
operator|)
operator|+
literal|2
expr_stmt|;
block|}
name|m
operator|=
name|sc
operator|->
name|macb_cdata
operator|.
name|rxhead
expr_stmt|;
name|m
operator|->
name|m_flags
operator||=
name|M_PKTHDR
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|rxbytes
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|ifp
expr_stmt|;
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_IPACKETS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|nsegs
operator|=
literal|0
expr_stmt|;
name|MACB_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
call|(
modifier|*
name|ifp
operator|->
name|if_input
call|)
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|MACB_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|macb_cdata
operator|.
name|rxhead
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|macb_cdata
operator|.
name|rxtail
operator|=
name|NULL
expr_stmt|;
block|}
name|rxdesc
operator|->
name|addr
operator|&=
operator|~
name|RD_OWN
expr_stmt|;
name|MACB_DESC_INC
argument_list|(
name|sc
operator|->
name|rx_cons
argument_list|,
name|MACB_MAX_RX_BUFFERS
argument_list|)
expr_stmt|;
name|rxdesc
operator|=
operator|&
operator|(
name|sc
operator|->
name|desc_rx
index|[
name|sc
operator|->
name|rx_cons
index|]
operator|)
expr_stmt|;
block|}
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_IER
argument_list|,
operator|(
name|RCOMP_INTERRUPT
operator||
name|RXUBR_INTERRUPT
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|macb_intr_rx_locked
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|macb_rx
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|macb_intr_task
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|int
name|pending
name|__unused
parameter_list|)
block|{
name|struct
name|macb_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|arg
expr_stmt|;
name|MACB_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|macb_intr_rx_locked
argument_list|(
name|sc
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|MACB_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|macb_intr
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
block|{
name|struct
name|macb_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|uint32_t
name|status
decl_stmt|;
name|sc
operator|=
name|xsc
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"not running\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|MACB_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|status
operator|=
name|read_4
argument_list|(
name|sc
argument_list|,
name|EMAC_ISR
argument_list|)
expr_stmt|;
while|while
condition|(
name|status
condition|)
block|{
if|if
condition|(
name|status
operator|&
name|RCOMP_INTERRUPT
condition|)
block|{
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_IDR
argument_list|,
operator|(
name|RCOMP_INTERRUPT
operator||
name|RXUBR_INTERRUPT
operator|)
argument_list|)
expr_stmt|;
name|taskqueue_enqueue
argument_list|(
name|sc
operator|->
name|sc_tq
argument_list|,
operator|&
name|sc
operator|->
name|sc_intr_task
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|&
name|TCOMP_INTERRUPT
condition|)
block|{
name|macb_tx_cleanup
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
name|status
operator|=
name|read_4
argument_list|(
name|sc
argument_list|,
name|EMAC_ISR
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|IFQ_DRV_IS_EMPTY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
condition|)
name|macbstart_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|MACB_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|macb_encap
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|m_head
parameter_list|)
block|{
name|struct
name|eth_tx_desc
modifier|*
name|desc
decl_stmt|;
name|struct
name|tx_desc_info
modifier|*
name|txd
decl_stmt|,
modifier|*
name|txd_last
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|bus_dma_segment_t
name|segs
index|[
name|MAX_FRAGMENT
index|]
decl_stmt|;
name|bus_dmamap_t
name|map
decl_stmt|;
name|uint32_t
name|csum_flags
decl_stmt|;
name|int
name|error
decl_stmt|,
name|i
decl_stmt|,
name|nsegs
decl_stmt|,
name|prod
decl_stmt|,
name|si
decl_stmt|;
name|M_ASSERTPKTHDR
argument_list|(
operator|(
operator|*
name|m_head
operator|)
argument_list|)
expr_stmt|;
name|prod
operator|=
name|sc
operator|->
name|tx_prod
expr_stmt|;
name|m
operator|=
operator|*
name|m_head
expr_stmt|;
name|txd
operator|=
name|txd_last
operator|=
operator|&
name|sc
operator|->
name|tx_desc
index|[
name|prod
index|]
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|sc
operator|->
name|dmatag_ring_tx
argument_list|,
name|txd
operator|->
name|dmamap
argument_list|,
operator|*
name|m_head
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
name|EFBIG
condition|)
block|{
name|m
operator|=
name|m_collapse
argument_list|(
operator|*
name|m_head
argument_list|,
name|M_NOWAIT
argument_list|,
name|MAX_FRAGMENT
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|m_freem
argument_list|(
operator|*
name|m_head
argument_list|)
expr_stmt|;
operator|*
name|m_head
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
operator|*
name|m_head
operator|=
name|m
expr_stmt|;
name|error
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|sc
operator|->
name|dmatag_ring_tx
argument_list|,
name|txd
operator|->
name|dmamap
argument_list|,
operator|*
name|m_head
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|m_freem
argument_list|(
operator|*
name|m_head
argument_list|)
expr_stmt|;
operator|*
name|m_head
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Check for TX descriptor overruns. */
if|if
condition|(
name|sc
operator|->
name|tx_cnt
operator|+
name|nsegs
operator|>
name|MACB_MAX_TX_BUFFERS
operator|-
literal|1
condition|)
block|{
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|dmatag_ring_tx
argument_list|,
name|txd
operator|->
name|dmamap
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|dmatag_ring_tx
argument_list|,
name|txd
operator|->
name|dmamap
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|m
operator|=
operator|*
name|m_head
expr_stmt|;
comment|/* TODO: VLAN hardware tag insertion. */
name|csum_flags
operator|=
literal|0
expr_stmt|;
name|si
operator|=
name|prod
expr_stmt|;
name|desc
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nsegs
condition|;
name|i
operator|++
control|)
block|{
name|desc
operator|=
operator|&
name|sc
operator|->
name|desc_tx
index|[
name|prod
index|]
expr_stmt|;
name|desc
operator|->
name|addr
operator|=
name|segs
index|[
name|i
index|]
operator|.
name|ds_addr
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|desc
operator|->
name|flags
operator|=
name|segs
index|[
name|i
index|]
operator|.
name|ds_len
operator||
name|TD_OWN
expr_stmt|;
block|}
else|else
block|{
name|desc
operator|->
name|flags
operator|=
name|segs
index|[
name|i
index|]
operator|.
name|ds_len
expr_stmt|;
block|}
if|if
condition|(
name|prod
operator|==
name|MACB_MAX_TX_BUFFERS
operator|-
literal|1
condition|)
name|desc
operator|->
name|flags
operator||=
name|TD_WRAP_MASK
expr_stmt|;
name|sc
operator|->
name|tx_cnt
operator|++
expr_stmt|;
name|MACB_DESC_INC
argument_list|(
name|prod
argument_list|,
name|MACB_MAX_TX_BUFFERS
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Set EOP on the last fragment. 	 */
name|desc
operator|->
name|flags
operator||=
name|TD_LAST
expr_stmt|;
name|desc
operator|=
operator|&
name|sc
operator|->
name|desc_tx
index|[
name|si
index|]
expr_stmt|;
name|desc
operator|->
name|flags
operator|&=
operator|~
name|TD_OWN
expr_stmt|;
name|sc
operator|->
name|tx_prod
operator|=
name|prod
expr_stmt|;
comment|/* Swap the first dma map and the last. */
name|map
operator|=
name|txd_last
operator|->
name|dmamap
expr_stmt|;
name|txd_last
operator|->
name|dmamap
operator|=
name|txd
operator|->
name|dmamap
expr_stmt|;
name|txd
operator|->
name|dmamap
operator|=
name|map
expr_stmt|;
name|txd
operator|->
name|buff
operator|=
name|m
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|macbstart_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|macb_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m0
decl_stmt|;
if|#
directive|if
literal|0
block|struct mbuf *m_new;
endif|#
directive|endif
name|int
name|queued
init|=
literal|0
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
operator|)
operator|!=
name|IFF_DRV_RUNNING
operator|||
operator|(
name|sc
operator|->
name|flags
operator|&
name|MACB_FLAG_LINK
operator|)
operator|==
literal|0
condition|)
block|{
return|return;
block|}
while|while
condition|(
operator|!
name|IFQ_DRV_IS_EMPTY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
condition|)
block|{
comment|/* Get packet from the queue */
name|IF_DEQUEUE
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m0
argument_list|)
expr_stmt|;
if|if
condition|(
name|m0
operator|==
name|NULL
condition|)
break|break;
if|#
directive|if
literal|0
block|if (m0->m_next != NULL) {
comment|/* Fragmented mbuf chain, collapse it. */
block|m_new = m_defrag(m0, M_NOWAIT); 			if (m_new != NULL) {
comment|/* Original frame freed. */
block|m0 = m_new; 			} else {
comment|/* Defragmentation failed, just use the chain. */
block|} 		}
endif|#
directive|endif
if|if
condition|(
name|macb_encap
argument_list|(
name|sc
argument_list|,
operator|&
name|m0
argument_list|)
condition|)
block|{
if|if
condition|(
name|m0
operator|==
name|NULL
condition|)
break|break;
name|IF_PREPEND
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m0
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_OACTIVE
expr_stmt|;
break|break;
block|}
name|queued
operator|++
expr_stmt|;
name|BPF_MTAP
argument_list|(
name|ifp
argument_list|,
name|m0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|IFQ_DRV_IS_EMPTY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
condition|)
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
if|if
condition|(
name|queued
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|dmatag_data_tx
argument_list|,
name|sc
operator|->
name|dmamap_ring_tx
argument_list|,
name|BUS_DMASYNC_PREREAD
operator||
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_NCR
argument_list|,
name|read_4
argument_list|(
name|sc
argument_list|,
name|EMAC_NCR
argument_list|)
operator||
name|TRANSMIT_START
argument_list|)
expr_stmt|;
name|sc
operator|->
name|macb_watchdog_timer
operator|=
name|MACB_TIMEOUT
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|macbinit
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
block|{
name|struct
name|macb_softc
modifier|*
name|sc
init|=
name|xsc
decl_stmt|;
name|MACB_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|macbinit_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|MACB_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|macbstart
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|macb_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|MACB_ASSERT_UNLOCKED
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|MACB_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|macbstart_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|MACB_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|macbstop
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|ifp
decl_stmt|;
name|struct
name|rx_desc_info
modifier|*
name|rd
decl_stmt|;
name|struct
name|tx_desc_info
modifier|*
name|td
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
operator|(
name|IFF_DRV_RUNNING
operator||
name|IFF_DRV_OACTIVE
operator|)
expr_stmt|;
name|macb_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|flags
operator|&=
operator|~
name|MACB_FLAG_LINK
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|tick_ch
argument_list|)
expr_stmt|;
name|sc
operator|->
name|macb_watchdog_timer
operator|=
literal|0
expr_stmt|;
comment|/* Free TX/RX mbufs still in the queues. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MACB_MAX_TX_BUFFERS
condition|;
name|i
operator|++
control|)
block|{
name|td
operator|=
operator|&
name|sc
operator|->
name|tx_desc
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|td
operator|->
name|buff
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|dmatag_ring_tx
argument_list|,
name|td
operator|->
name|dmamap
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|dmatag_data_tx
argument_list|,
name|td
operator|->
name|dmamap
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|td
operator|->
name|buff
argument_list|)
expr_stmt|;
name|td
operator|->
name|buff
operator|=
name|NULL
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MACB_MAX_RX_BUFFERS
condition|;
name|i
operator|++
control|)
block|{
name|rd
operator|=
operator|&
name|sc
operator|->
name|rx_desc
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|rd
operator|->
name|buff
operator|!=
name|NULL
condition|)
block|{
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|dmatag_ring_rx
argument_list|,
name|rd
operator|->
name|dmamap
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|dmatag_data_rx
argument_list|,
name|rd
operator|->
name|dmamap
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|rd
operator|->
name|buff
argument_list|)
expr_stmt|;
name|rd
operator|->
name|buff
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|get_hash_index
parameter_list|(
name|uint8_t
modifier|*
name|mac
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|;
name|int
name|result
decl_stmt|;
name|int
name|bit
decl_stmt|;
name|result
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
block|{
name|bit
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|8
condition|;
name|j
operator|++
control|)
block|{
name|k
operator|=
name|j
operator|*
literal|6
operator|+
name|i
expr_stmt|;
name|bit
operator|^=
operator|(
name|mac
index|[
name|k
operator|/
literal|8
index|]
operator|&
operator|(
literal|1
operator|<<
operator|(
name|k
operator|%
literal|8
operator|)
operator|)
operator|)
operator|!=
literal|0
expr_stmt|;
block|}
name|result
operator||=
name|bit
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_mac_filter
parameter_list|(
name|uint32_t
modifier|*
name|filter
parameter_list|,
name|uint8_t
modifier|*
name|mac
parameter_list|)
block|{
name|int
name|bits
decl_stmt|;
name|bits
operator|=
name|get_hash_index
argument_list|(
name|mac
argument_list|)
expr_stmt|;
name|filter
index|[
name|bits
operator|>>
literal|5
index|]
operator||=
literal|1
operator|<<
operator|(
name|bits
operator|&
literal|31
operator|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_filter
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|ifmultiaddr
modifier|*
name|ifma
decl_stmt|;
name|int
name|config
decl_stmt|;
name|int
name|count
decl_stmt|;
name|uint32_t
name|multicast_filter
index|[
literal|2
index|]
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|ifp
expr_stmt|;
name|config
operator|=
name|read_4
argument_list|(
name|sc
argument_list|,
name|EMAC_NCFGR
argument_list|)
expr_stmt|;
name|config
operator|&=
operator|~
operator|(
name|CFG_CAF
operator||
name|CFG_MTI
operator|)
expr_stmt|;
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_HRB
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_HRT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|&
operator|(
name|IFF_ALLMULTI
operator||
name|IFF_PROMISC
operator|)
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_ALLMULTI
operator|)
operator|!=
literal|0
condition|)
block|{
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_HRB
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_HRT
argument_list|,
operator|~
literal|0
argument_list|)
expr_stmt|;
name|config
operator||=
name|CFG_MTI
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_PROMISC
operator|)
operator|!=
literal|0
condition|)
block|{
name|config
operator||=
name|CFG_CAF
expr_stmt|;
block|}
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_NCFGR
argument_list|,
name|config
argument_list|)
expr_stmt|;
return|return;
block|}
name|if_maddr_rlock
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
name|multicast_filter
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|multicast_filter
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|ifma
argument_list|,
argument|&ifp->if_multiaddrs
argument_list|,
argument|ifma_link
argument_list|)
block|{
if|if
condition|(
name|ifma
operator|->
name|ifma_addr
operator|->
name|sa_family
operator|!=
name|AF_LINK
condition|)
continue|continue;
name|count
operator|++
expr_stmt|;
name|set_mac_filter
argument_list|(
name|multicast_filter
argument_list|,
name|LLADDR
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|ifma
operator|->
name|ifma_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|count
condition|)
block|{
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_HRB
argument_list|,
name|multicast_filter
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_HRT
argument_list|,
name|multicast_filter
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_NCFGR
argument_list|,
name|config
operator||
name|CFG_MTI
argument_list|)
expr_stmt|;
block|}
name|if_maddr_runlock
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|macbioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|struct
name|macb_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SIOCSIFFLAGS
case|:
name|MACB_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|ifp
operator|->
name|if_flags
operator|^
name|sc
operator|->
name|if_flags
operator|)
operator|&
operator|(
name|IFF_PROMISC
operator||
name|IFF_ALLMULTI
operator|)
operator|)
operator|!=
literal|0
condition|)
name|set_filter
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|macbinit_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|!=
literal|0
condition|)
block|{
name|macbstop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|if_flags
operator|=
name|ifp
operator|->
name|if_flags
expr_stmt|;
name|MACB_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCADDMULTI
case|:
case|case
name|SIOCDELMULTI
case|:
name|MACB_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|!=
literal|0
condition|)
name|set_filter
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|MACB_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSIFMEDIA
case|:
case|case
name|SIOCGIFMEDIA
case|:
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|miibus
argument_list|)
expr_stmt|;
name|error
operator|=
name|ifmedia_ioctl
argument_list|(
name|ifp
argument_list|,
name|ifr
argument_list|,
operator|&
name|mii
operator|->
name|mii_media
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/* bus entry points */
end_comment

begin_function
specifier|static
name|int
name|macb_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|FDT
if|if
condition|(
operator|!
name|ofw_bus_is_compatible
argument_list|(
name|dev
argument_list|,
literal|"cdns,at32ap7000-macb"
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
endif|#
directive|endif
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"macb"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Change media according to request.  */
end_comment

begin_function
specifier|static
name|int
name|macb_ifmedia_upd
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|macb_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|miibus
argument_list|)
expr_stmt|;
name|MACB_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mii_mediachg
argument_list|(
name|mii
argument_list|)
expr_stmt|;
name|MACB_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Notify the world which media we're using.  */
end_comment

begin_function
specifier|static
name|void
name|macb_ifmedia_sts
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|ifmr
parameter_list|)
block|{
name|struct
name|macb_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|miibus
argument_list|)
expr_stmt|;
name|MACB_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Don't report link state if driver is not running. */
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
operator|)
operator|==
literal|0
condition|)
block|{
name|MACB_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
name|mii_pollstat
argument_list|(
name|mii
argument_list|)
expr_stmt|;
name|ifmr
operator|->
name|ifm_active
operator|=
name|mii
operator|->
name|mii_media_active
expr_stmt|;
name|ifmr
operator|->
name|ifm_status
operator|=
name|mii
operator|->
name|mii_media_status
expr_stmt|;
name|MACB_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|macb_reset
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* 	 * Disable RX and TX 	 */
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_NCR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_NCR
argument_list|,
name|CLEAR_STAT
argument_list|)
expr_stmt|;
comment|/* Clear all status flags */
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_TSR
argument_list|,
operator|~
literal|0UL
argument_list|)
expr_stmt|;
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_RSR
argument_list|,
operator|~
literal|0UL
argument_list|)
expr_stmt|;
comment|/* Disable all interrupts */
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_IDR
argument_list|,
operator|~
literal|0UL
argument_list|)
expr_stmt|;
name|read_4
argument_list|(
name|sc
argument_list|,
name|EMAC_ISR
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|macb_get_mac
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|,
name|u_char
modifier|*
name|eaddr
parameter_list|)
block|{
name|uint32_t
name|bottom
decl_stmt|;
name|uint16_t
name|top
decl_stmt|;
name|bottom
operator|=
name|read_4
argument_list|(
name|sc
argument_list|,
name|EMAC_SA1B
argument_list|)
expr_stmt|;
name|top
operator|=
name|read_4
argument_list|(
name|sc
argument_list|,
name|EMAC_SA1T
argument_list|)
expr_stmt|;
name|eaddr
index|[
literal|0
index|]
operator|=
name|bottom
operator|&
literal|0xff
expr_stmt|;
name|eaddr
index|[
literal|1
index|]
operator|=
operator|(
name|bottom
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|eaddr
index|[
literal|2
index|]
operator|=
operator|(
name|bottom
operator|>>
literal|16
operator|)
operator|&
literal|0xff
expr_stmt|;
name|eaddr
index|[
literal|3
index|]
operator|=
operator|(
name|bottom
operator|>>
literal|24
operator|)
operator|&
literal|0xff
expr_stmt|;
name|eaddr
index|[
literal|4
index|]
operator|=
name|top
operator|&
literal|0xff
expr_stmt|;
name|eaddr
index|[
literal|5
index|]
operator|=
operator|(
name|top
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macb_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|macb_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|NULL
decl_stmt|;
name|struct
name|sysctl_ctx_list
modifier|*
name|sctx
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|soid
decl_stmt|;
name|int
name|pclk_hz
decl_stmt|;
name|u_char
name|eaddr
index|[
name|ETHER_ADDR_LEN
index|]
decl_stmt|;
name|int
name|rid
decl_stmt|;
name|int
name|err
decl_stmt|;
name|struct
name|at91_pmc_clock
modifier|*
name|master
decl_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|MACB_LOCK_INIT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|callout_init_mtx
argument_list|(
operator|&
name|sc
operator|->
name|tick_ch
argument_list|,
operator|&
name|sc
operator|->
name|sc_mtx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * Allocate resources. 	 */
name|rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|mem_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mem_res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not allocate memory resources.\n"
argument_list|)
expr_stmt|;
name|err
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|irq_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|irq_res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not allocate interrupt resources.\n"
argument_list|)
expr_stmt|;
name|err
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/*setup clock*/
name|sc
operator|->
name|clk
operator|=
name|at91_pmc_clock_ref
argument_list|(
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|at91_pmc_clock_enable
argument_list|(
name|sc
operator|->
name|clk
argument_list|)
expr_stmt|;
name|macb_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|macb_get_mac
argument_list|(
name|sc
argument_list|,
name|eaddr
argument_list|)
expr_stmt|;
name|master
operator|=
name|at91_pmc_clock_ref
argument_list|(
literal|"mck"
argument_list|)
expr_stmt|;
name|pclk_hz
operator|=
name|master
operator|->
name|hz
expr_stmt|;
name|sc
operator|->
name|clock
operator|=
name|CFG_CLK_8
expr_stmt|;
if|if
condition|(
name|pclk_hz
operator|<=
literal|20000000
condition|)
name|sc
operator|->
name|clock
operator|=
name|CFG_CLK_8
expr_stmt|;
elseif|else
if|if
condition|(
name|pclk_hz
operator|<=
literal|40000000
condition|)
name|sc
operator|->
name|clock
operator|=
name|CFG_CLK_16
expr_stmt|;
elseif|else
if|if
condition|(
name|pclk_hz
operator|<=
literal|80000000
condition|)
name|sc
operator|->
name|clock
operator|=
name|CFG_CLK_32
expr_stmt|;
else|else
name|sc
operator|->
name|clock
operator|=
name|CFG_CLK_64
expr_stmt|;
name|sc
operator|->
name|clock
operator|=
name|sc
operator|->
name|clock
operator|<<
literal|10
expr_stmt|;
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_NCFGR
argument_list|,
name|sc
operator|->
name|clock
argument_list|)
expr_stmt|;
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_USRIO
argument_list|,
name|USRIO_CLOCK
argument_list|)
expr_stmt|;
comment|//enable clock
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_NCR
argument_list|,
name|MPE_ENABLE
argument_list|)
expr_stmt|;
comment|//enable MPE
name|sc
operator|->
name|ifp
operator|=
name|ifp
operator|=
name|if_alloc
argument_list|(
name|IFT_ETHER
argument_list|)
expr_stmt|;
name|err
operator|=
name|mii_attach
argument_list|(
name|dev
argument_list|,
operator|&
name|sc
operator|->
name|miibus
argument_list|,
name|ifp
argument_list|,
name|macb_ifmedia_upd
argument_list|,
name|macb_ifmedia_sts
argument_list|,
name|BMSR_DEFCAPMASK
argument_list|,
name|MII_PHY_ANY
argument_list|,
name|MII_OFFSET_ANY
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"attaching PHYs failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|macb_allocate_dma
argument_list|(
name|sc
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|out
goto|;
comment|/* Sysctls */
name|sctx
operator|=
name|device_get_sysctl_ctx
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|soid
operator|=
name|device_get_sysctl_tree
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_softc
operator|=
name|sc
expr_stmt|;
name|if_initname
argument_list|(
name|ifp
argument_list|,
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_SIMPLEX
operator||
name|IFF_MULTICAST
expr_stmt|;
name|ifp
operator|->
name|if_capabilities
operator||=
name|IFCAP_VLAN_MTU
expr_stmt|;
name|ifp
operator|->
name|if_capenable
operator||=
name|IFCAP_VLAN_MTU
expr_stmt|;
comment|/* The hw bits already set. */
name|ifp
operator|->
name|if_start
operator|=
name|macbstart
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|macbioctl
expr_stmt|;
name|ifp
operator|->
name|if_init
operator|=
name|macbinit
expr_stmt|;
name|IFQ_SET_MAXLEN
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|IFQ_MAXLEN
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_drv_maxlen
operator|=
name|IFQ_MAXLEN
expr_stmt|;
name|IFQ_SET_READY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
expr_stmt|;
name|sc
operator|->
name|if_flags
operator|=
name|ifp
operator|->
name|if_flags
expr_stmt|;
name|TASK_INIT
argument_list|(
operator|&
name|sc
operator|->
name|sc_intr_task
argument_list|,
literal|0
argument_list|,
name|macb_intr_task
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_tq
operator|=
name|taskqueue_create_fast
argument_list|(
literal|"macb_taskq"
argument_list|,
name|M_WAITOK
argument_list|,
name|taskqueue_thread_enqueue
argument_list|,
operator|&
name|sc
operator|->
name|sc_tq
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_tq
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"could not create taskqueue\n"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ether_ifattach
argument_list|(
name|ifp
argument_list|,
name|eaddr
argument_list|)
expr_stmt|;
comment|/* 	 * Activate the interrupt. 	 */
name|err
operator|=
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|,
name|INTR_TYPE_NET
operator||
name|INTR_MPSAFE
argument_list|,
name|NULL
argument_list|,
name|macb_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|intrhand
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not establish interrupt handler.\n"
argument_list|)
expr_stmt|;
name|ether_ifdetach
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|taskqueue_start_threads
argument_list|(
operator|&
name|sc
operator|->
name|sc_tq
argument_list|,
literal|1
argument_list|,
name|PI_NET
argument_list|,
literal|"%s taskq"
argument_list|,
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|macb_cdata
operator|.
name|rxhead
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|macb_cdata
operator|.
name|rxtail
operator|=
literal|0
expr_stmt|;
name|phy_write
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0x3300
argument_list|)
expr_stmt|;
comment|//force autoneg
return|return
operator|(
literal|0
operator|)
return|;
name|out
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macb_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|macb_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ether_ifdetach
argument_list|(
name|sc
operator|->
name|ifp
argument_list|)
expr_stmt|;
name|MACB_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|macbstop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|MACB_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|callout_drain
argument_list|(
operator|&
name|sc
operator|->
name|tick_ch
argument_list|)
expr_stmt|;
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|,
name|sc
operator|->
name|intrhand
argument_list|)
expr_stmt|;
name|taskqueue_drain
argument_list|(
name|sc
operator|->
name|sc_tq
argument_list|,
operator|&
name|sc
operator|->
name|sc_intr_task
argument_list|)
expr_stmt|;
name|taskqueue_free
argument_list|(
name|sc
operator|->
name|sc_tq
argument_list|)
expr_stmt|;
name|macb_deactivate
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|mem_res
argument_list|)
expr_stmt|;
name|MACB_LOCK_DESTROY
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*PHY related functions*/
end_comment

begin_function
specifier|static
specifier|inline
name|int
name|phy_read
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|)
block|{
name|int
name|val
decl_stmt|;
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_MAN
argument_list|,
name|EMAC_MAN_REG_RD
argument_list|(
name|phy
argument_list|,
name|reg
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|read_4
argument_list|(
name|sc
argument_list|,
name|EMAC_SR
argument_list|)
operator|&
name|EMAC_SR_IDLE
operator|)
operator|==
literal|0
condition|)
continue|continue;
name|val
operator|=
name|read_4
argument_list|(
name|sc
argument_list|,
name|EMAC_MAN
argument_list|)
operator|&
name|EMAC_MAN_VALUE_MASK
expr_stmt|;
return|return
operator|(
name|val
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|phy_write
parameter_list|(
name|struct
name|macb_softc
modifier|*
name|sc
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|,
name|int
name|data
parameter_list|)
block|{
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_MAN
argument_list|,
name|EMAC_MAN_REG_WR
argument_list|(
name|phy
argument_list|,
name|reg
argument_list|,
name|data
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|read_4
argument_list|(
name|sc
argument_list|,
name|EMAC_SR
argument_list|)
operator|&
name|EMAC_SR_IDLE
operator|)
operator|==
literal|0
condition|)
continue|continue;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * MII bus support routines.  */
end_comment

begin_function
specifier|static
name|int
name|macb_miibus_readreg
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|)
block|{
name|struct
name|macb_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|phy_read
argument_list|(
name|sc
argument_list|,
name|phy
argument_list|,
name|reg
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macb_miibus_writereg
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|,
name|int
name|data
parameter_list|)
block|{
name|struct
name|macb_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|phy_write
argument_list|(
name|sc
argument_list|,
name|phy
argument_list|,
name|reg
argument_list|,
name|data
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|macb_child_detached
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|)
block|{
name|struct
name|macb_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|macb_miibus_statchg
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|macb_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
decl_stmt|;
name|int
name|config
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mii
operator|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|miibus
argument_list|)
expr_stmt|;
name|sc
operator|->
name|flags
operator|&=
operator|~
name|MACB_FLAG_LINK
expr_stmt|;
name|config
operator|=
name|read_4
argument_list|(
name|sc
argument_list|,
name|EMAC_NCFGR
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|mii
operator|->
name|mii_media_status
operator|&
name|IFM_AVALID
operator|)
operator|!=
literal|0
condition|)
block|{
switch|switch
condition|(
name|IFM_SUBTYPE
argument_list|(
name|mii
operator|->
name|mii_media_active
argument_list|)
condition|)
block|{
case|case
name|IFM_10_T
case|:
name|config
operator|&=
operator|~
operator|(
name|CFG_SPD
operator|)
expr_stmt|;
name|sc
operator|->
name|flags
operator||=
name|MACB_FLAG_LINK
expr_stmt|;
break|break;
case|case
name|IFM_100_TX
case|:
name|config
operator||=
name|CFG_SPD
expr_stmt|;
name|sc
operator|->
name|flags
operator||=
name|MACB_FLAG_LINK
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
name|config
operator||=
name|CFG_FD
expr_stmt|;
name|write_4
argument_list|(
name|sc
argument_list|,
name|EMAC_NCFGR
argument_list|,
name|config
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|macb_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|macb_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|macb_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|macb_detach
argument_list|)
block|,
comment|/* Bus interface */
name|DEVMETHOD
argument_list|(
name|bus_child_detached
argument_list|,
name|macb_child_detached
argument_list|)
block|,
comment|/* MII interface */
name|DEVMETHOD
argument_list|(
name|miibus_readreg
argument_list|,
name|macb_miibus_readreg
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|miibus_writereg
argument_list|,
name|macb_miibus_writereg
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|miibus_statchg
argument_list|,
name|macb_miibus_statchg
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|macb_driver
init|=
block|{
literal|"macb"
block|,
name|macb_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|macb_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|FDT
end_ifdef

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|macb
argument_list|,
name|simplebus
argument_list|,
name|macb_driver
argument_list|,
name|macb_devclass
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
end_expr_stmt

begin_else
else|#
directive|else
end_else

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|macb
argument_list|,
name|atmelarm
argument_list|,
name|macb_driver
argument_list|,
name|macb_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|miibus
argument_list|,
name|macb
argument_list|,
name|miibus_driver
argument_list|,
name|miibus_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|macb
argument_list|,
name|miibus
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|macb
argument_list|,
name|ether
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright 2013-2014 John Wehle<john@feith.com>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * Amlogic aml8726 frame buffer driver.  *  * The current implementation has limited flexibility.  * For example only progressive scan is supported when  * using HDMI and the resolution / frame rate is not  * negotiated.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/fbio.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpu.h>
end_include

begin_include
include|#
directive|include
file|<machine/fdt.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus_subr.h>
end_include

begin_include
include|#
directive|include
file|<dev/fb/fbreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/vt/vt.h>
end_include

begin_include
include|#
directive|include
file|<arm/amlogic/aml8726/aml8726_fb.h>
end_include

begin_include
include|#
directive|include
file|"fb_if.h"
end_include

begin_enum
enum|enum
name|aml8726_fb_output
block|{
name|aml8726_unknown_fb_output
block|,
name|aml8726_cvbs_fb_output
block|,
name|aml8726_hdmi_fb_output
block|,
name|aml8726_lcd_fb_output
block|}
enum|;
end_enum

begin_struct
struct|struct
name|aml8726_fb_clk
block|{
name|uint32_t
name|freq
decl_stmt|;
name|uint32_t
name|video_pre
decl_stmt|;
name|uint32_t
name|video_post
decl_stmt|;
name|uint32_t
name|video_x
decl_stmt|;
name|uint32_t
name|hdmi_tx
decl_stmt|;
name|uint32_t
name|encp
decl_stmt|;
name|uint32_t
name|enci
decl_stmt|;
name|uint32_t
name|enct
decl_stmt|;
name|uint32_t
name|encl
decl_stmt|;
name|uint32_t
name|vdac0
decl_stmt|;
name|uint32_t
name|vdac1
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|aml8726_fb_softc
block|{
name|device_t
name|dev
decl_stmt|;
name|struct
name|resource
modifier|*
name|res
index|[
literal|4
index|]
decl_stmt|;
name|struct
name|mtx
name|mtx
decl_stmt|;
name|void
modifier|*
name|ih_cookie
decl_stmt|;
name|struct
name|fb_info
name|info
decl_stmt|;
name|enum
name|aml8726_fb_output
name|output
decl_stmt|;
name|struct
name|aml8726_fb_clk
name|clk
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|resource_spec
name|aml8726_fb_spec
index|[]
init|=
block|{
block|{
name|SYS_RES_MEMORY
block|,
literal|0
block|,
name|RF_ACTIVE
block|}
block|,
comment|/* CANVAS */
block|{
name|SYS_RES_MEMORY
block|,
literal|1
block|,
name|RF_ACTIVE
block|}
block|,
comment|/* VIU */
block|{
name|SYS_RES_MEMORY
block|,
literal|2
block|,
name|RF_ACTIVE
block|}
block|,
comment|/* VPP */
block|{
name|SYS_RES_IRQ
block|,
literal|1
block|,
name|RF_ACTIVE
block|}
block|,
comment|/* INT_VIU_VSYNC */
block|{
operator|-
literal|1
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|AML_FB_LOCK
parameter_list|(
name|sc
parameter_list|)
value|mtx_lock(&(sc)->mtx)
end_define

begin_define
define|#
directive|define
name|AML_FB_UNLOCK
parameter_list|(
name|sc
parameter_list|)
value|mtx_unlock(&(sc)->mtx)
end_define

begin_define
define|#
directive|define
name|AML_FB_LOCK_INIT
parameter_list|(
name|sc
parameter_list|)
define|\
value|mtx_init(&(sc)->mtx, device_get_nameunit((sc)->dev),	\     "fb", MTX_DEF)
end_define

begin_define
define|#
directive|define
name|AML_FB_LOCK_DESTROY
parameter_list|(
name|sc
parameter_list|)
value|mtx_destroy(&(sc)->mtx);
end_define

begin_define
define|#
directive|define
name|CAV_WRITE_4
parameter_list|(
name|sc
parameter_list|,
name|reg
parameter_list|,
name|val
parameter_list|)
value|bus_write_4((sc)->res[0], reg, (val))
end_define

begin_define
define|#
directive|define
name|CAV_READ_4
parameter_list|(
name|sc
parameter_list|,
name|reg
parameter_list|)
value|bus_read_4((sc)->res[0], reg)
end_define

begin_define
define|#
directive|define
name|CAV_BARRIER
parameter_list|(
name|sc
parameter_list|,
name|reg
parameter_list|)
value|bus_barrier((sc)->res[0], reg, 4, \     (BUS_SPACE_BARRIER_READ | BUS_SPACE_BARRIER_WRITE))
end_define

begin_define
define|#
directive|define
name|VIU_WRITE_4
parameter_list|(
name|sc
parameter_list|,
name|reg
parameter_list|,
name|val
parameter_list|)
value|bus_write_4((sc)->res[1], reg, (val))
end_define

begin_define
define|#
directive|define
name|VIU_READ_4
parameter_list|(
name|sc
parameter_list|,
name|reg
parameter_list|)
value|bus_read_4((sc)->res[1], reg)
end_define

begin_define
define|#
directive|define
name|VPP_WRITE_4
parameter_list|(
name|sc
parameter_list|,
name|reg
parameter_list|,
name|val
parameter_list|)
value|bus_write_4((sc)->res[2], reg, (val))
end_define

begin_define
define|#
directive|define
name|VPP_READ_4
parameter_list|(
name|sc
parameter_list|,
name|reg
parameter_list|)
value|bus_read_4((sc)->res[2], reg)
end_define

begin_define
define|#
directive|define
name|CLK_WRITE_4
parameter_list|(
name|sc
parameter_list|,
name|reg
parameter_list|,
name|val
parameter_list|)
value|bus_write_4((sc)->res[X], reg, (val))
end_define

begin_define
define|#
directive|define
name|CLK_READ_4
parameter_list|(
name|sc
parameter_list|,
name|reg
parameter_list|)
value|bus_read_4((sc)->res[X], reg)
end_define

begin_define
define|#
directive|define
name|AML_FB_CLK_FREQ_SD
value|1080
end_define

begin_define
define|#
directive|define
name|AML_FB_CLK_FREQ_HD
value|1488
end_define

begin_function
specifier|static
name|void
name|aml8726_fb_cfg_output
parameter_list|(
name|struct
name|aml8726_fb_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* XXX */
block|}
end_function

begin_function
specifier|static
name|void
name|aml8726_fb_cfg_video
parameter_list|(
name|struct
name|aml8726_fb_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|value
decl_stmt|;
comment|/* 	 * basic initialization 	 * 	 * The fifo depth is in units of 8 so programming 32 	 * sets the depth to 256. 	 */
name|value
operator|=
operator|(
literal|32
operator|<<
name|AML_VIU_OSD_FIFO_CTRL_DEPTH_SHIFT
operator|)
expr_stmt|;
name|value
operator||=
name|AML_VIU_OSD_FIFO_CTRL_BURST_LEN_64
expr_stmt|;
name|value
operator||=
operator|(
literal|4
operator|<<
name|AML_VIU_OSD_FIFO_CTRL_HOLD_LINES_SHIFT
operator|)
expr_stmt|;
name|VIU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|AML_VIU_OSD1_FIFO_CTRL_REG
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|VIU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|AML_VIU_OSD2_FIFO_CTRL_REG
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|value
operator|=
name|VPP_READ_4
argument_list|(
name|sc
argument_list|,
name|AML_VPP_MISC_REG
argument_list|)
expr_stmt|;
name|value
operator|&=
operator|~
name|AML_VPP_MISC_PREBLEND_EN
expr_stmt|;
name|value
operator||=
name|AML_VPP_MISC_POSTBLEND_EN
expr_stmt|;
name|value
operator|&=
operator|~
operator|(
name|AML_VPP_MISC_OSD1_POSTBLEND
operator||
name|AML_VPP_MISC_OSD2_POSTBLEND
operator||
name|AML_VPP_MISC_VD1_POSTBLEND
operator||
name|AML_VPP_MISC_VD2_POSTBLEND
operator|)
expr_stmt|;
name|VPP_WRITE_4
argument_list|(
name|sc
argument_list|,
name|AML_VPP_MISC_REG
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|value
operator|=
name|AML_VIU_OSD_CTRL_OSD_EN
expr_stmt|;
name|value
operator||=
operator|(
literal|0xff
operator|<<
name|AML_VIU_OSD_CTRL_GLOBAL_ALPHA_SHIFT
operator|)
expr_stmt|;
name|VIU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|AML_VIU_OSD1_CTRL_REG
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|VIU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|AML_VIU_OSD2_CTRL_REG
argument_list|,
name|value
argument_list|)
expr_stmt|;
comment|/* color mode for OSD1 block 0 */
name|value
operator|=
operator|(
name|AML_CAV_OSD1_INDEX
operator|<<
name|AML_VIU_OSD_BLK_CFG_W0_INDEX_SHIFT
operator|)
operator||
name|AML_VIU_OSD_BLK_CFG_W0_LITTLE_ENDIAN
operator||
name|AML_VIU_OSD_BLK_CFG_W0_BLKMODE_24
operator||
name|AML_VIU_OSD_BLK_CFG_W0_RGB_EN
operator||
name|AML_VIU_OSD_BLK_CFG_W0_CMATRIX_RGB
expr_stmt|;
name|VIU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|AML_VIU_OSD1_BLK0_CFG_W0_REG
argument_list|,
name|value
argument_list|)
expr_stmt|;
comment|/* geometry / scaling for OSD1 block 0 */
name|value
operator|=
operator|(
operator|(
name|sc
operator|->
name|info
operator|.
name|fb_width
operator|-
literal|1
operator|)
operator|<<
name|AML_VIU_OSD_BLK_CFG_W1_X_END_SHIFT
operator|)
operator|&
name|AML_VIU_OSD_BLK_CFG_W1_X_END_MASK
expr_stmt|;
name|value
operator||=
operator|(
literal|0
operator|<<
name|AML_VIU_OSD_BLK_CFG_W1_X_START_SHIFT
operator|)
operator|&
name|AML_VIU_OSD_BLK_CFG_W1_X_START_MASK
expr_stmt|;
name|VIU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|AML_VIU_OSD1_BLK0_CFG_W1_REG
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|value
operator|=
operator|(
operator|(
name|sc
operator|->
name|info
operator|.
name|fb_height
operator|-
literal|1
operator|)
operator|<<
name|AML_VIU_OSD_BLK_CFG_W2_Y_END_SHIFT
operator|)
operator|&
name|AML_VIU_OSD_BLK_CFG_W2_Y_END_MASK
expr_stmt|;
name|value
operator||=
operator|(
literal|0
operator|<<
name|AML_VIU_OSD_BLK_CFG_W2_Y_START_SHIFT
operator|)
operator|&
name|AML_VIU_OSD_BLK_CFG_W2_Y_START_MASK
expr_stmt|;
name|VIU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|AML_VIU_OSD1_BLK0_CFG_W2_REG
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|value
operator|=
operator|(
operator|(
name|sc
operator|->
name|info
operator|.
name|fb_width
operator|-
literal|1
operator|)
operator|<<
name|AML_VIU_OSD_BLK_CFG_W3_H_END_SHIFT
operator|)
operator|&
name|AML_VIU_OSD_BLK_CFG_W3_H_END_MASK
expr_stmt|;
name|value
operator||=
operator|(
literal|0
operator|<<
name|AML_VIU_OSD_BLK_CFG_W3_H_START_SHIFT
operator|)
operator|&
name|AML_VIU_OSD_BLK_CFG_W3_H_START_MASK
expr_stmt|;
name|VIU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|AML_VIU_OSD1_BLK0_CFG_W3_REG
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|value
operator|=
operator|(
operator|(
name|sc
operator|->
name|info
operator|.
name|fb_height
operator|-
literal|1
operator|)
operator|<<
name|AML_VIU_OSD_BLK_CFG_W4_V_END_SHIFT
operator|)
operator|&
name|AML_VIU_OSD_BLK_CFG_W4_V_END_MASK
expr_stmt|;
name|value
operator||=
operator|(
literal|0
operator|<<
name|AML_VIU_OSD_BLK_CFG_W4_V_START_SHIFT
operator|)
operator|&
name|AML_VIU_OSD_BLK_CFG_W4_V_START_MASK
expr_stmt|;
name|VIU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|AML_VIU_OSD1_BLK0_CFG_W4_REG
argument_list|,
name|value
argument_list|)
expr_stmt|;
comment|/* Enable the OSD block now that it's fully configured */
name|value
operator|=
name|VIU_READ_4
argument_list|(
name|sc
argument_list|,
name|AML_VIU_OSD1_CTRL_REG
argument_list|)
expr_stmt|;
name|value
operator|&=
operator|~
name|AML_VIU_OSD_CTRL_OSD_BLK_EN_MASK
expr_stmt|;
name|value
operator||=
literal|1
operator|<<
name|AML_VIU_OSD_CTRL_OSD_BLK_EN_SHIFT
expr_stmt|;
name|VIU_WRITE_4
argument_list|(
name|sc
argument_list|,
name|AML_VIU_OSD1_CTRL_REG
argument_list|,
name|value
argument_list|)
expr_stmt|;
comment|/* enable video processing of OSD1 */
name|value
operator|=
name|VPP_READ_4
argument_list|(
name|sc
argument_list|,
name|AML_VPP_MISC_REG
argument_list|)
expr_stmt|;
name|value
operator||=
name|AML_VPP_MISC_OSD1_POSTBLEND
expr_stmt|;
name|VPP_WRITE_4
argument_list|(
name|sc
argument_list|,
name|AML_VPP_MISC_REG
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|aml8726_fb_cfg_canvas
parameter_list|(
name|struct
name|aml8726_fb_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|value
decl_stmt|;
name|uint32_t
name|width
decl_stmt|;
comment|/* 	 * The frame buffer address and width are programmed in units of 8 	 * (meaning they need to be aligned and the actual values divided 	 * by 8 prior to programming the hardware). 	 */
name|width
operator|=
operator|(
name|uint32_t
operator|)
name|sc
operator|->
name|info
operator|.
name|fb_stride
operator|/
literal|8
expr_stmt|;
comment|/* lower bits of the width */
name|value
operator|=
operator|(
name|width
operator|<<
name|AML_CAV_LUT_DATAL_WIDTH_SHIFT
operator|)
operator|&
name|AML_CAV_LUT_DATAL_WIDTH_MASK
expr_stmt|;
comment|/* physical address */
name|value
operator||=
operator|(
name|uint32_t
operator|)
name|sc
operator|->
name|info
operator|.
name|fb_pbase
operator|/
literal|8
expr_stmt|;
name|CAV_WRITE_4
argument_list|(
name|sc
argument_list|,
name|AML_CAV_LUT_DATAL_REG
argument_list|,
name|value
argument_list|)
expr_stmt|;
comment|/* upper bits of the width */
name|value
operator|=
operator|(
operator|(
name|width
operator|>>
name|AML_CAV_LUT_DATAL_WIDTH_WIDTH
operator|)
operator|<<
name|AML_CAV_LUT_DATAH_WIDTH_SHIFT
operator|)
operator|&
name|AML_CAV_LUT_DATAH_WIDTH_MASK
expr_stmt|;
comment|/* height */
name|value
operator||=
operator|(
operator|(
name|uint32_t
operator|)
name|sc
operator|->
name|info
operator|.
name|fb_height
operator|<<
name|AML_CAV_LUT_DATAH_HEIGHT_SHIFT
operator|)
operator|&
name|AML_CAV_LUT_DATAH_HEIGHT_MASK
expr_stmt|;
comment|/* mode */
name|value
operator||=
name|AML_CAV_LUT_DATAH_BLKMODE_LINEAR
expr_stmt|;
name|CAV_WRITE_4
argument_list|(
name|sc
argument_list|,
name|AML_CAV_LUT_DATAH_REG
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|CAV_WRITE_4
argument_list|(
name|sc
argument_list|,
name|AML_CAV_LUT_ADDR_REG
argument_list|,
operator|(
name|AML_CAV_LUT_ADDR_WR_EN
operator||
operator|(
name|AML_CAV_OSD1_INDEX
operator|<<
name|AML_CAV_LUT_ADDR_INDEX_SHIFT
operator|)
operator|)
argument_list|)
expr_stmt|;
name|CAV_BARRIER
argument_list|(
name|sc
argument_list|,
name|AML_CAV_LUT_ADDR_REG
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|aml8726_fb_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|aml8726_fb_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|aml8726_fb_softc
operator|*
operator|)
name|arg
decl_stmt|;
name|AML_FB_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|AML_FB_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|aml8726_fb_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
operator|!
name|ofw_bus_status_okay
argument_list|(
name|dev
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
operator|!
name|ofw_bus_is_compatible
argument_list|(
name|dev
argument_list|,
literal|"amlogic,aml8726-fb"
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Amlogic aml8726 FB"
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aml8726_fb_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|aml8726_fb_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
name|device_t
name|child
decl_stmt|;
name|pcell_t
name|prop
decl_stmt|;
name|phandle_t
name|node
decl_stmt|;
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|info
operator|.
name|fb_name
operator|=
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
name|node
operator|=
name|ofw_bus_get_node
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|OF_getencprop
argument_list|(
name|node
argument_list|,
literal|"width"
argument_list|,
operator|&
name|prop
argument_list|,
sizeof|sizeof
argument_list|(
name|prop
argument_list|)
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"missing width attribute in FDT\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|prop
operator|%
literal|8
operator|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"width attribute in FDT must be a multiple of 8\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|sc
operator|->
name|info
operator|.
name|fb_width
operator|=
name|prop
expr_stmt|;
if|if
condition|(
name|OF_getencprop
argument_list|(
name|node
argument_list|,
literal|"height"
argument_list|,
operator|&
name|prop
argument_list|,
sizeof|sizeof
argument_list|(
name|prop
argument_list|)
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"missing height attribute in FDT\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|sc
operator|->
name|info
operator|.
name|fb_height
operator|=
name|prop
expr_stmt|;
if|if
condition|(
name|OF_getencprop
argument_list|(
name|node
argument_list|,
literal|"depth"
argument_list|,
operator|&
name|prop
argument_list|,
sizeof|sizeof
argument_list|(
name|prop
argument_list|)
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"missing depth attribute in FDT\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
name|prop
operator|!=
literal|24
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"depth attribute in FDT is an unsupported value\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|sc
operator|->
name|info
operator|.
name|fb_depth
operator|=
name|prop
expr_stmt|;
name|sc
operator|->
name|info
operator|.
name|fb_bpp
operator|=
name|prop
expr_stmt|;
if|if
condition|(
name|OF_getencprop
argument_list|(
name|node
argument_list|,
literal|"linebytes"
argument_list|,
operator|&
name|prop
argument_list|,
sizeof|sizeof
argument_list|(
name|prop
argument_list|)
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"missing linebytes attribute in FDT\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|prop
operator|%
literal|8
operator|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"linebytes attribute in FDT must be a multiple of 8\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
name|prop
operator|<
operator|(
name|sc
operator|->
name|info
operator|.
name|fb_width
operator|*
literal|3
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"linebytes attribute in FDT is too small\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|sc
operator|->
name|info
operator|.
name|fb_stride
operator|=
name|prop
expr_stmt|;
if|if
condition|(
name|OF_getencprop
argument_list|(
name|node
argument_list|,
literal|"address"
argument_list|,
operator|&
name|prop
argument_list|,
sizeof|sizeof
argument_list|(
name|prop
argument_list|)
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"missing address attribute in FDT\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|prop
operator|%
literal|8
operator|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"address attribute in FDT must be a multiple of 8\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|sc
operator|->
name|info
operator|.
name|fb_pbase
operator|=
name|prop
expr_stmt|;
name|sc
operator|->
name|info
operator|.
name|fb_size
operator|=
name|sc
operator|->
name|info
operator|.
name|fb_height
operator|*
name|sc
operator|->
name|info
operator|.
name|fb_stride
expr_stmt|;
name|sc
operator|->
name|info
operator|.
name|fb_vbase
operator|=
operator|(
name|intptr_t
operator|)
name|pmap_mapdev
argument_list|(
name|sc
operator|->
name|info
operator|.
name|fb_pbase
argument_list|,
name|sc
operator|->
name|info
operator|.
name|fb_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|bus_alloc_resources
argument_list|(
name|dev
argument_list|,
name|aml8726_fb_spec
argument_list|,
name|sc
operator|->
name|res
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not allocate resources for device\n"
argument_list|)
expr_stmt|;
name|pmap_unmapdev
argument_list|(
name|sc
operator|->
name|info
operator|.
name|fb_vbase
argument_list|,
name|sc
operator|->
name|info
operator|.
name|fb_size
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|aml8726_fb_cfg_output
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|aml8726_fb_cfg_video
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|aml8726_fb_cfg_canvas
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|AML_FB_LOCK_INIT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|res
index|[
literal|3
index|]
argument_list|,
name|INTR_TYPE_MISC
operator||
name|INTR_MPSAFE
argument_list|,
name|NULL
argument_list|,
name|aml8726_fb_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|ih_cookie
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not setup interrupt handler\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|child
operator|=
name|device_add_child
argument_list|(
name|dev
argument_list|,
literal|"fbd"
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|child
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not add fbd\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|error
operator|=
name|device_probe_and_attach
argument_list|(
name|child
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not attach fbd\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
if|if
condition|(
name|sc
operator|->
name|ih_cookie
condition|)
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|res
index|[
literal|3
index|]
argument_list|,
name|sc
operator|->
name|ih_cookie
argument_list|)
expr_stmt|;
name|AML_FB_LOCK_DESTROY
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|bus_release_resources
argument_list|(
name|dev
argument_list|,
name|aml8726_fb_spec
argument_list|,
name|sc
operator|->
name|res
argument_list|)
expr_stmt|;
name|pmap_unmapdev
argument_list|(
name|sc
operator|->
name|info
operator|.
name|fb_vbase
argument_list|,
name|sc
operator|->
name|info
operator|.
name|fb_size
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aml8726_fb_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|aml8726_fb_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|bus_generic_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|res
index|[
literal|3
index|]
argument_list|,
name|sc
operator|->
name|ih_cookie
argument_list|)
expr_stmt|;
name|AML_FB_LOCK_DESTROY
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|bus_release_resources
argument_list|(
name|dev
argument_list|,
name|aml8726_fb_spec
argument_list|,
name|sc
operator|->
name|res
argument_list|)
expr_stmt|;
name|pmap_unmapdev
argument_list|(
name|sc
operator|->
name|info
operator|.
name|fb_vbase
argument_list|,
name|sc
operator|->
name|info
operator|.
name|fb_size
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|fb_info
modifier|*
name|aml8726_fb_getinfo
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|aml8726_fb_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
return|return
operator|(
operator|&
name|sc
operator|->
name|info
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|aml8726_fb_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|aml8726_fb_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|aml8726_fb_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|aml8726_fb_detach
argument_list|)
block|,
comment|/* FB interface */
name|DEVMETHOD
argument_list|(
name|fb_getinfo
argument_list|,
name|aml8726_fb_getinfo
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|aml8726_fb_driver
init|=
block|{
literal|"fb"
block|,
name|aml8726_fb_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|aml8726_fb_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|aml8726_fb_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|fb
argument_list|,
name|simplebus
argument_list|,
name|aml8726_fb_driver
argument_list|,
name|aml8726_fb_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


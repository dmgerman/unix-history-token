begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2015 Michal Meloun  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/gpio.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/extres/clk/clk.h>
end_include

begin_include
include|#
directive|include
file|<dev/extres/hwreset/hwreset.h>
end_include

begin_include
include|#
directive|include
file|<dev/extres/regulator/regulator.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drmP.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm_crtc.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm_crtc_helper.h>
end_include

begin_include
include|#
directive|include
file|<dev/drm2/drm_fb_helper.h>
end_include

begin_include
include|#
directive|include
file|<dev/gpio/gpiobusvar.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus_subr.h>
end_include

begin_include
include|#
directive|include
file|<arm/nvidia/drm2/tegra_drm.h>
end_include

begin_include
include|#
directive|include
file|<arm/nvidia/drm2/tegra_hdmi_reg.h>
end_include

begin_include
include|#
directive|include
file|<arm/nvidia/drm2/tegra_dc_reg.h>
end_include

begin_include
include|#
directive|include
file|<arm/nvidia/drm2/hdmi.h>
end_include

begin_include
include|#
directive|include
file|"tegra_dc_if.h"
end_include

begin_include
include|#
directive|include
file|"tegra_drm_if.h"
end_include

begin_define
define|#
directive|define
name|WR4
parameter_list|(
name|_sc
parameter_list|,
name|_r
parameter_list|,
name|_v
parameter_list|)
value|bus_write_4((_sc)->mem_res, 4 * (_r), (_v))
end_define

begin_define
define|#
directive|define
name|RD4
parameter_list|(
name|_sc
parameter_list|,
name|_r
parameter_list|)
value|bus_read_4((_sc)->mem_res, 4 * (_r))
end_define

begin_comment
comment|/* HDA stream format verb. */
end_comment

begin_define
define|#
directive|define
name|AC_FMT_CHAN_GET
parameter_list|(
name|x
parameter_list|)
value|(((x)>>  0)& 0xf)
end_define

begin_define
define|#
directive|define
name|AC_FMT_CHAN_BITS_GET
parameter_list|(
name|x
parameter_list|)
value|(((x)>>  4)& 0x7)
end_define

begin_define
define|#
directive|define
name|AC_FMT_DIV_GET
parameter_list|(
name|x
parameter_list|)
value|(((x)>>  8)& 0x7)
end_define

begin_define
define|#
directive|define
name|AC_FMT_MUL_GET
parameter_list|(
name|x
parameter_list|)
value|(((x)>> 11)& 0x7)
end_define

begin_define
define|#
directive|define
name|AC_FMT_BASE_44K
value|(1<< 14)
end_define

begin_define
define|#
directive|define
name|AC_FMT_TYPE_NON_PCM
value|(1<< 15)
end_define

begin_define
define|#
directive|define
name|HDMI_REKEY_DEFAULT
value|56
end_define

begin_define
define|#
directive|define
name|HDMI_ELD_BUFFER_SIZE
value|96
end_define

begin_define
define|#
directive|define
name|HDMI_DC_CLOCK_MULTIPIER
value|2
end_define

begin_struct
struct|struct
name|audio_reg
block|{
name|uint32_t
name|audio_clk
decl_stmt|;
name|bus_size_t
name|acr_reg
decl_stmt|;
name|bus_size_t
name|nval_reg
decl_stmt|;
name|bus_size_t
name|aval_reg
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|audio_reg
name|audio_regs
index|[]
init|=
block|{
block|{
operator|.
name|audio_clk
operator|=
literal|32000
block|,
operator|.
name|acr_reg
operator|=
name|HDMI_NV_PDISP_HDMI_ACR_0320_SUBPACK_LOW
block|,
operator|.
name|nval_reg
operator|=
name|HDMI_NV_PDISP_SOR_AUDIO_NVAL_0320
block|,
operator|.
name|aval_reg
operator|=
name|HDMI_NV_PDISP_SOR_AUDIO_AVAL_0320
block|, 	}
block|,
block|{
operator|.
name|audio_clk
operator|=
literal|44100
block|,
operator|.
name|acr_reg
operator|=
name|HDMI_NV_PDISP_HDMI_ACR_0441_SUBPACK_LOW
block|,
operator|.
name|nval_reg
operator|=
name|HDMI_NV_PDISP_SOR_AUDIO_NVAL_0441
block|,
operator|.
name|aval_reg
operator|=
name|HDMI_NV_PDISP_SOR_AUDIO_AVAL_0441
block|, 	}
block|,
block|{
operator|.
name|audio_clk
operator|=
literal|88200
block|,
operator|.
name|acr_reg
operator|=
name|HDMI_NV_PDISP_HDMI_ACR_0882_SUBPACK_LOW
block|,
operator|.
name|nval_reg
operator|=
name|HDMI_NV_PDISP_SOR_AUDIO_NVAL_0882
block|,
operator|.
name|aval_reg
operator|=
name|HDMI_NV_PDISP_SOR_AUDIO_AVAL_0882
block|, 	}
block|,
block|{
operator|.
name|audio_clk
operator|=
literal|176400
block|,
operator|.
name|acr_reg
operator|=
name|HDMI_NV_PDISP_HDMI_ACR_1764_SUBPACK_LOW
block|,
operator|.
name|nval_reg
operator|=
name|HDMI_NV_PDISP_SOR_AUDIO_NVAL_1764
block|,
operator|.
name|aval_reg
operator|=
name|HDMI_NV_PDISP_SOR_AUDIO_AVAL_1764
block|, 	}
block|,
block|{
operator|.
name|audio_clk
operator|=
literal|48000
block|,
operator|.
name|acr_reg
operator|=
name|HDMI_NV_PDISP_HDMI_ACR_0480_SUBPACK_LOW
block|,
operator|.
name|nval_reg
operator|=
name|HDMI_NV_PDISP_SOR_AUDIO_NVAL_0480
block|,
operator|.
name|aval_reg
operator|=
name|HDMI_NV_PDISP_SOR_AUDIO_AVAL_0480
block|, 	}
block|,
block|{
operator|.
name|audio_clk
operator|=
literal|96000
block|,
operator|.
name|acr_reg
operator|=
name|HDMI_NV_PDISP_HDMI_ACR_0960_SUBPACK_LOW
block|,
operator|.
name|nval_reg
operator|=
name|HDMI_NV_PDISP_SOR_AUDIO_NVAL_0960
block|,
operator|.
name|aval_reg
operator|=
name|HDMI_NV_PDISP_SOR_AUDIO_AVAL_0960
block|, 	}
block|,
block|{
operator|.
name|audio_clk
operator|=
literal|192000
block|,
operator|.
name|acr_reg
operator|=
name|HDMI_NV_PDISP_HDMI_ACR_1920_SUBPACK_LOW
block|,
operator|.
name|nval_reg
operator|=
name|HDMI_NV_PDISP_SOR_AUDIO_NVAL_1920
block|,
operator|.
name|aval_reg
operator|=
name|HDMI_NV_PDISP_SOR_AUDIO_AVAL_1920
block|, 	}
block|, }
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|tmds_config
block|{
name|uint32_t
name|pclk
decl_stmt|;
name|uint32_t
name|pll0
decl_stmt|;
name|uint32_t
name|pll1
decl_stmt|;
name|uint32_t
name|drive_c
decl_stmt|;
name|uint32_t
name|pe_c
decl_stmt|;
name|uint32_t
name|peak_c
decl_stmt|;
name|uint32_t
name|pad_ctls
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|tmds_config
name|tegra124_tmds_config
index|[]
init|=
block|{
block|{
comment|/* 480p/576p / 25.2MHz/27MHz */
operator|.
name|pclk
operator|=
literal|27000000
block|,
operator|.
name|pll0
operator|=
literal|0x01003010
block|,
operator|.
name|pll1
operator|=
literal|0x00301B00
block|,
operator|.
name|drive_c
operator|=
literal|0x1F1F1F1F
block|,
operator|.
name|pe_c
operator|=
literal|0x00000000
block|,
operator|.
name|peak_c
operator|=
literal|0x03030303
block|,
operator|.
name|pad_ctls
operator|=
literal|0x800034BB
block|, 	}
block|,
block|{
comment|/* 720p/1080i / 74.25MHz  */
operator|.
name|pclk
operator|=
literal|74250000
block|,
operator|.
name|pll0
operator|=
literal|0x01003110
block|,
operator|.
name|pll1
operator|=
literal|0x00301500
block|,
operator|.
name|drive_c
operator|=
literal|0x2C2C2C2C
block|,
operator|.
name|pe_c
operator|=
literal|0x00000000
block|,
operator|.
name|peak_c
operator|=
literal|0x07070707
block|,
operator|.
name|pad_ctls
operator|=
literal|0x800034BB
block|, 	}
block|,
block|{
comment|/* 1080p / 148.5MHz */
operator|.
name|pclk
operator|=
literal|148500000
block|,
operator|.
name|pll0
operator|=
literal|0x01003310
block|,
operator|.
name|pll1
operator|=
literal|0x00301500
block|,
operator|.
name|drive_c
operator|=
literal|0x33333333
block|,
operator|.
name|pe_c
operator|=
literal|0x00000000
block|,
operator|.
name|peak_c
operator|=
literal|0x0C0C0C0C
block|,
operator|.
name|pad_ctls
operator|=
literal|0x800034BB
block|, 	}
block|,
block|{
comment|/* 2216p / 297MHz  */
operator|.
name|pclk
operator|=
name|UINT_MAX
block|,
operator|.
name|pll0
operator|=
literal|0x01003F10
block|,
operator|.
name|pll1
operator|=
literal|0x00300F00
block|,
operator|.
name|drive_c
operator|=
literal|0x37373737
block|,
operator|.
name|pe_c
operator|=
literal|0x00000000
block|,
operator|.
name|peak_c
operator|=
literal|0x17171717
block|,
operator|.
name|pad_ctls
operator|=
literal|0x800036BB
block|, 	}
block|, }
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|hdmi_softc
block|{
name|device_t
name|dev
decl_stmt|;
name|struct
name|resource
modifier|*
name|mem_res
decl_stmt|;
name|struct
name|resource
modifier|*
name|irq_res
decl_stmt|;
name|void
modifier|*
name|irq_ih
decl_stmt|;
name|clk_t
name|clk_parent
decl_stmt|;
name|clk_t
name|clk_hdmi
decl_stmt|;
name|hwreset_t
name|hwreset_hdmi
decl_stmt|;
name|regulator_t
name|supply_hdmi
decl_stmt|;
name|regulator_t
name|supply_pll
decl_stmt|;
name|regulator_t
name|supply_vdd
decl_stmt|;
name|uint64_t
name|pclk
decl_stmt|;
name|boolean_t
name|hdmi_mode
decl_stmt|;
name|int
name|audio_src_type
decl_stmt|;
name|int
name|audio_freq
decl_stmt|;
name|int
name|audio_chans
decl_stmt|;
name|struct
name|tegra_drm
modifier|*
name|drm
decl_stmt|;
name|struct
name|tegra_drm_encoder
name|output
decl_stmt|;
specifier|const
name|struct
name|tmds_config
modifier|*
name|tmds_config
decl_stmt|;
name|int
name|n_tmds_configs
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|ofw_compat_data
name|compat_data
index|[]
init|=
block|{
block|{
literal|"nvidia,tegra124-hdmi"
block|,
literal|1
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* These functions have been copied from newer version of drm_edid.c */
end_comment

begin_comment
comment|/* ELD Header Block */
end_comment

begin_define
define|#
directive|define
name|DRM_ELD_HEADER_BLOCK_SIZE
value|4
end_define

begin_define
define|#
directive|define
name|DRM_ELD_BASELINE_ELD_LEN
value|2
end_define

begin_comment
comment|/* in dwords! */
end_comment

begin_function
specifier|static
name|int
name|drm_eld_size
parameter_list|(
specifier|const
name|uint8_t
modifier|*
name|eld
parameter_list|)
block|{
return|return
name|DRM_ELD_HEADER_BLOCK_SIZE
operator|+
name|eld
index|[
name|DRM_ELD_BASELINE_ELD_LEN
index|]
operator|*
literal|4
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|drm_hdmi_avi_infoframe_from_display_mode
parameter_list|(
name|struct
name|hdmi_avi_infoframe
modifier|*
name|frame
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|)
block|{
name|int
name|rv
decl_stmt|;
if|if
condition|(
operator|!
name|frame
operator|||
operator|!
name|mode
condition|)
return|return
operator|-
name|EINVAL
return|;
name|rv
operator|=
name|hdmi_avi_infoframe_init
argument_list|(
name|frame
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<
literal|0
condition|)
return|return
name|rv
return|;
if|if
condition|(
name|mode
operator|->
name|flags
operator|&
name|DRM_MODE_FLAG_DBLCLK
condition|)
name|frame
operator|->
name|pixel_repeat
operator|=
literal|1
expr_stmt|;
name|frame
operator|->
name|video_code
operator|=
name|drm_match_cea_mode
argument_list|(
name|mode
argument_list|)
expr_stmt|;
name|frame
operator|->
name|picture_aspect
operator|=
name|HDMI_PICTURE_ASPECT_NONE
expr_stmt|;
ifdef|#
directive|ifdef
name|FREEBSD_NOTYET
comment|/* 	 * Populate picture aspect ratio from either 	 * user input (if specified) or from the CEA mode list. 	*/
if|if
condition|(
name|mode
operator|->
name|picture_aspect_ratio
operator|==
name|HDMI_PICTURE_ASPECT_4_3
operator|||
name|mode
operator|->
name|picture_aspect_ratio
operator|==
name|HDMI_PICTURE_ASPECT_16_9
condition|)
name|frame
operator|->
name|picture_aspect
operator|=
name|mode
operator|->
name|picture_aspect_ratio
expr_stmt|;
elseif|else
if|if
condition|(
name|frame
operator|->
name|video_code
operator|>
literal|0
condition|)
name|frame
operator|->
name|picture_aspect
operator|=
name|drm_get_cea_aspect_ratio
argument_list|(
name|frame
operator|->
name|video_code
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|frame
operator|->
name|active_aspect
operator|=
name|HDMI_ACTIVE_ASPECT_PICTURE
expr_stmt|;
name|frame
operator|->
name|scan_mode
operator|=
name|HDMI_SCAN_MODE_UNDERSCAN
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* --------------------------------------------------------------------- */
end_comment

begin_function
specifier|static
name|int
name|hdmi_setup_clock
parameter_list|(
name|struct
name|tegra_drm_encoder
modifier|*
name|output
parameter_list|,
name|clk_t
name|clk
parameter_list|,
name|uint64_t
name|pclk
parameter_list|)
block|{
name|struct
name|hdmi_softc
modifier|*
name|sc
decl_stmt|;
name|uint64_t
name|freq
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|output
operator|->
name|dev
argument_list|)
expr_stmt|;
comment|/* Disable consumers clock for while. */
name|rv
operator|=
name|clk_disable
argument_list|(
name|sc
operator|->
name|clk_hdmi
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot disable 'hdmi' clock\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
name|rv
operator|=
name|clk_disable
argument_list|(
name|clk
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot disable display clock\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
comment|/* Set frequency  for Display Controller PLL. */
name|freq
operator|=
name|HDMI_DC_CLOCK_MULTIPIER
operator|*
name|pclk
expr_stmt|;
name|rv
operator|=
name|clk_set_freq
argument_list|(
name|sc
operator|->
name|clk_parent
argument_list|,
name|freq
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|output
operator|->
name|dev
argument_list|,
literal|"Cannot set display pixel frequency\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
comment|/* Reparent display controller */
name|rv
operator|=
name|clk_set_parent_by_clk
argument_list|(
name|clk
argument_list|,
name|sc
operator|->
name|clk_parent
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|output
operator|->
name|dev
argument_list|,
literal|"Cannot set parent clock\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
name|rv
operator|=
name|clk_set_freq
argument_list|(
name|clk
argument_list|,
name|freq
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|output
operator|->
name|dev
argument_list|,
literal|"Cannot set display controller frequency\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
name|rv
operator|=
name|clk_set_freq
argument_list|(
name|sc
operator|->
name|clk_hdmi
argument_list|,
name|pclk
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|output
operator|->
name|dev
argument_list|,
literal|"Cannot set display controller frequency\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
comment|/* And reenable consumers clock. */
name|rv
operator|=
name|clk_enable
argument_list|(
name|clk
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot enable display clock\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
name|rv
operator|=
name|clk_enable
argument_list|(
name|sc
operator|->
name|clk_hdmi
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot enable 'hdmi' clock\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
name|rv
operator|=
name|clk_get_freq
argument_list|(
name|clk
argument_list|,
operator|&
name|freq
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|output
operator|->
name|dev
argument_list|,
literal|"Cannot get display controller frequency\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
name|DRM_DEBUG_KMS
argument_list|(
literal|"DC frequency: %llu\n"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------  *  *	Infoframes.  *  */
end_comment

begin_function
specifier|static
name|void
name|avi_setup_infoframe
parameter_list|(
name|struct
name|hdmi_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|)
block|{
name|struct
name|hdmi_avi_infoframe
name|frame
decl_stmt|;
name|uint8_t
name|buf
index|[
literal|17
index|]
decl_stmt|,
modifier|*
name|hdr
decl_stmt|,
modifier|*
name|pb
decl_stmt|;
empty_stmt|;
name|ssize_t
name|rv
decl_stmt|;
name|rv
operator|=
name|drm_hdmi_avi_infoframe_from_display_mode
argument_list|(
operator|&
name|frame
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot setup AVI infoframe: %zd\n"
argument_list|,
name|rv
argument_list|)
expr_stmt|;
return|return;
block|}
name|rv
operator|=
name|hdmi_avi_infoframe_pack
argument_list|(
operator|&
name|frame
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot pack AVI infoframe: %zd\n"
argument_list|,
name|rv
argument_list|)
expr_stmt|;
return|return;
block|}
name|hdr
operator|=
name|buf
operator|+
literal|0
expr_stmt|;
name|pb
operator|=
name|buf
operator|+
literal|3
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_HEADER
argument_list|,
operator|(
name|hdr
index|[
literal|2
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|hdr
index|[
literal|1
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|hdr
index|[
literal|0
index|]
operator|<<
literal|0
operator|)
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_SUBPACK0_LOW
argument_list|,
operator|(
name|pb
index|[
literal|3
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|pb
index|[
literal|2
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|pb
index|[
literal|1
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|pb
index|[
literal|0
index|]
operator|<<
literal|0
operator|)
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_SUBPACK0_HIGH
argument_list|,
operator|(
name|pb
index|[
literal|6
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|pb
index|[
literal|5
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|pb
index|[
literal|4
index|]
operator|<<
literal|0
operator|)
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_SUBPACK1_LOW
argument_list|,
operator|(
name|pb
index|[
literal|10
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|pb
index|[
literal|9
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|pb
index|[
literal|8
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|pb
index|[
literal|7
index|]
operator|<<
literal|0
operator|)
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_SUBPACK1_HIGH
argument_list|,
operator|(
name|pb
index|[
literal|13
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|pb
index|[
literal|12
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|pb
index|[
literal|11
index|]
operator|<<
literal|0
operator|)
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_CTRL
argument_list|,
name|AVI_INFOFRAME_CTRL_ENABLE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|audio_setup_infoframe
parameter_list|(
name|struct
name|hdmi_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|hdmi_audio_infoframe
name|frame
decl_stmt|;
name|uint8_t
name|buf
index|[
literal|14
index|]
decl_stmt|,
modifier|*
name|hdr
decl_stmt|,
modifier|*
name|pb
decl_stmt|;
name|ssize_t
name|rv
decl_stmt|;
name|rv
operator|=
name|hdmi_audio_infoframe_init
argument_list|(
operator|&
name|frame
argument_list|)
expr_stmt|;
name|frame
operator|.
name|channels
operator|=
name|sc
operator|->
name|audio_chans
expr_stmt|;
name|rv
operator|=
name|hdmi_audio_infoframe_pack
argument_list|(
operator|&
name|frame
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot pack audio infoframe\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|hdr
operator|=
name|buf
operator|+
literal|0
expr_stmt|;
name|pb
operator|=
name|buf
operator|+
literal|3
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_HDMI_AUDIO_INFOFRAME_HEADER
argument_list|,
operator|(
name|hdr
index|[
literal|2
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|hdr
index|[
literal|1
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|hdr
index|[
literal|0
index|]
operator|<<
literal|0
operator|)
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_HDMI_AUDIO_INFOFRAME_SUBPACK0_LOW
argument_list|,
operator|(
name|pb
index|[
literal|3
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|pb
index|[
literal|2
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|pb
index|[
literal|1
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|pb
index|[
literal|0
index|]
operator|<<
literal|0
operator|)
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_HDMI_AUDIO_INFOFRAME_SUBPACK0_HIGH
argument_list|,
operator|(
name|pb
index|[
literal|5
index|]
operator|<<
literal|8
operator|)
operator||
operator|(
name|pb
index|[
literal|4
index|]
operator|<<
literal|0
operator|)
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_HDMI_AUDIO_INFOFRAME_CTRL
argument_list|,
name|AUDIO_INFOFRAME_CTRL_ENABLE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------  *  *	Audio  *  */
end_comment

begin_function
specifier|static
name|void
name|init_hda_eld
parameter_list|(
name|struct
name|hdmi_softc
modifier|*
name|sc
parameter_list|)
block|{
name|size_t
name|size
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|size
operator|=
name|drm_eld_size
argument_list|(
name|sc
operator|->
name|output
operator|.
name|connector
operator|.
name|eld
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|HDMI_ELD_BUFFER_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|val
operator|=
name|i
operator|<<
literal|8
expr_stmt|;
if|if
condition|(
name|i
operator|<
name|size
condition|)
name|val
operator||=
name|sc
operator|->
name|output
operator|.
name|connector
operator|.
name|eld
index|[
name|i
index|]
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_AUDIO_HDA_ELD_BUFWR
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_AUDIO_HDA_PRESENSE
argument_list|,
name|SOR_AUDIO_HDA_PRESENSE_VALID
operator||
name|SOR_AUDIO_HDA_PRESENSE_PRESENT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_audio_regs
parameter_list|(
name|int
name|freq
parameter_list|,
name|bus_size_t
modifier|*
name|acr_reg
parameter_list|,
name|bus_size_t
modifier|*
name|nval_reg
parameter_list|,
name|bus_size_t
modifier|*
name|aval_reg
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
specifier|const
name|struct
name|audio_reg
modifier|*
name|reg
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|audio_regs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|reg
operator|=
name|audio_regs
operator|+
name|i
expr_stmt|;
if|if
condition|(
name|reg
operator|->
name|audio_clk
operator|==
name|freq
condition|)
block|{
if|if
condition|(
name|acr_reg
operator|!=
name|NULL
condition|)
operator|*
name|acr_reg
operator|=
name|reg
operator|->
name|acr_reg
expr_stmt|;
if|if
condition|(
name|nval_reg
operator|!=
name|NULL
condition|)
operator|*
name|nval_reg
operator|=
name|reg
operator|->
name|nval_reg
expr_stmt|;
if|if
condition|(
name|aval_reg
operator|!=
name|NULL
condition|)
operator|*
name|aval_reg
operator|=
name|reg
operator|->
name|aval_reg
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
return|return
operator|(
name|ERANGE
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|FR_BITS
value|16
end_define

begin_define
define|#
directive|define
name|TO_FFP
parameter_list|(
name|x
parameter_list|)
value|(((int64_t)(x))<< FR_BITS)
end_define

begin_define
define|#
directive|define
name|TO_INT
parameter_list|(
name|x
parameter_list|)
value|((int)((x)>> FR_BITS))
end_define

begin_function
specifier|static
name|int
name|get_hda_cts_n
parameter_list|(
name|uint32_t
name|audio_freq_hz
parameter_list|,
name|uint32_t
name|pixclk_freq_hz
parameter_list|,
name|uint32_t
modifier|*
name|best_cts
parameter_list|,
name|uint32_t
modifier|*
name|best_n
parameter_list|,
name|uint32_t
modifier|*
name|best_a
parameter_list|)
block|{
name|int
name|min_n
decl_stmt|;
name|int
name|max_n
decl_stmt|;
name|int
name|ideal_n
decl_stmt|;
name|int
name|n
decl_stmt|;
name|int
name|cts
decl_stmt|;
name|int
name|aval
decl_stmt|;
name|int64_t
name|err_f
decl_stmt|;
name|int64_t
name|min_err_f
decl_stmt|;
name|int64_t
name|cts_f
decl_stmt|;
name|int64_t
name|aval_f
decl_stmt|;
name|int64_t
name|half_f
decl_stmt|;
comment|/* constant 0.5 */
name|bool
name|better_n
decl_stmt|;
comment|/* 	 * All floats are in fixed I48.16 format. 	 * 	 * Ideal ACR interval is 1000 hz (1 ms); 	 * acceptable is 300 hz .. 1500 hz 	 */
name|min_n
operator|=
literal|128
operator|*
name|audio_freq_hz
operator|/
literal|1500
expr_stmt|;
name|max_n
operator|=
literal|128
operator|*
name|audio_freq_hz
operator|/
literal|300
expr_stmt|;
name|ideal_n
operator|=
literal|128
operator|*
name|audio_freq_hz
operator|/
literal|1000
expr_stmt|;
name|min_err_f
operator|=
name|TO_FFP
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|half_f
operator|=
name|TO_FFP
argument_list|(
literal|1
argument_list|)
operator|/
literal|2
expr_stmt|;
operator|*
name|best_n
operator|=
literal|0
expr_stmt|;
operator|*
name|best_cts
operator|=
literal|0
expr_stmt|;
operator|*
name|best_a
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|n
operator|=
name|min_n
init|;
name|n
operator|<=
name|max_n
condition|;
name|n
operator|++
control|)
block|{
name|cts_f
operator|=
name|TO_FFP
argument_list|(
name|pixclk_freq_hz
argument_list|)
expr_stmt|;
name|cts_f
operator|*=
name|n
expr_stmt|;
name|cts_f
operator|/=
literal|128
operator|*
name|audio_freq_hz
expr_stmt|;
name|cts
operator|=
name|TO_INT
argument_list|(
name|cts_f
operator|+
name|half_f
argument_list|)
expr_stmt|;
comment|/* round */
name|err_f
operator|=
name|cts_f
operator|-
name|TO_FFP
argument_list|(
name|cts
argument_list|)
expr_stmt|;
if|if
condition|(
name|err_f
operator|<
literal|0
condition|)
name|err_f
operator|=
operator|-
name|err_f
expr_stmt|;
name|aval_f
operator|=
name|TO_FFP
argument_list|(
literal|24000000
argument_list|)
expr_stmt|;
name|aval_f
operator|*=
name|n
expr_stmt|;
name|aval_f
operator|/=
literal|128
operator|*
name|audio_freq_hz
expr_stmt|;
name|aval
operator|=
name|TO_INT
argument_list|(
name|aval_f
argument_list|)
expr_stmt|;
comment|/* truncate */
name|better_n
operator|=
name|abs
argument_list|(
name|n
operator|-
name|ideal_n
argument_list|)
operator|<
name|abs
argument_list|(
call|(
name|int
call|)
argument_list|(
operator|*
name|best_n
argument_list|)
operator|-
name|ideal_n
argument_list|)
expr_stmt|;
if|if
condition|(
name|TO_FFP
argument_list|(
name|aval
argument_list|)
operator|==
name|aval_f
operator|&&
operator|(
name|err_f
operator|<
name|min_err_f
operator|||
operator|(
name|err_f
operator|==
name|min_err_f
operator|&&
name|better_n
operator|)
operator|)
condition|)
block|{
name|min_err_f
operator|=
name|err_f
expr_stmt|;
operator|*
name|best_n
operator|=
operator|(
name|uint32_t
operator|)
name|n
expr_stmt|;
operator|*
name|best_cts
operator|=
operator|(
name|uint32_t
operator|)
name|cts
expr_stmt|;
operator|*
name|best_a
operator|=
operator|(
name|uint32_t
operator|)
name|aval
expr_stmt|;
if|if
condition|(
name|err_f
operator|==
literal|0
operator|&&
name|n
operator|==
name|ideal_n
condition|)
break|break;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_undef
undef|#
directive|undef
name|FR_BITS
end_undef

begin_undef
undef|#
directive|undef
name|TO_FFP
end_undef

begin_undef
undef|#
directive|undef
name|TO_INT
end_undef

begin_function
specifier|static
name|int
name|audio_setup
parameter_list|(
name|struct
name|hdmi_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|uint32_t
name|audio_n
decl_stmt|;
name|uint32_t
name|audio_cts
decl_stmt|;
name|uint32_t
name|audio_aval
decl_stmt|;
name|uint64_t
name|hdmi_freq
decl_stmt|;
name|bus_size_t
name|aval_reg
decl_stmt|;
name|int
name|rv
decl_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|hdmi_mode
condition|)
return|return
operator|(
name|ENOTSUP
operator|)
return|;
name|rv
operator|=
name|get_audio_regs
argument_list|(
name|sc
operator|->
name|audio_freq
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|aval_reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Unsupported audio frequency.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
name|rv
operator|=
name|clk_get_freq
argument_list|(
name|sc
operator|->
name|clk_hdmi
argument_list|,
operator|&
name|hdmi_freq
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot get hdmi frequency: %d\n"
argument_list|,
name|rv
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
name|rv
operator|=
name|get_hda_cts_n
argument_list|(
name|sc
operator|->
name|audio_freq
argument_list|,
name|hdmi_freq
argument_list|,
operator|&
name|audio_cts
argument_list|,
operator|&
name|audio_n
argument_list|,
operator|&
name|audio_aval
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot compute audio coefs: %d\n"
argument_list|,
name|rv
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
comment|/* Audio infoframe. */
name|audio_setup_infoframe
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Setup audio source */
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_AUDIO_CNTRL0
argument_list|,
name|SOR_AUDIO_CNTRL0_SOURCE_SELECT
argument_list|(
name|sc
operator|->
name|audio_src_type
argument_list|)
operator||
name|SOR_AUDIO_CNTRL0_INJECT_NULLSMPL
argument_list|)
expr_stmt|;
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_AUDIO_SPARE0
argument_list|)
expr_stmt|;
name|val
operator||=
name|SOR_AUDIO_SPARE0_HBR_ENABLE
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_AUDIO_SPARE0
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_HDMI_ACR_CTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_AUDIO_N
argument_list|,
name|AUDIO_N_RESETF
operator||
name|AUDIO_N_GENERATE_ALTERNATE
operator||
name|AUDIO_N_VALUE
argument_list|(
name|audio_n
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_HDMI_ACR_0441_SUBPACK_HIGH
argument_list|,
name|ACR_SUBPACK_N
argument_list|(
name|audio_n
argument_list|)
operator||
name|ACR_ENABLE
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_HDMI_ACR_0441_SUBPACK_LOW
argument_list|,
name|ACR_SUBPACK_CTS
argument_list|(
name|audio_cts
argument_list|)
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_HDMI_SPARE
argument_list|,
name|SPARE_HW_CTS
operator||
name|SPARE_FORCE_SW_CTS
operator||
name|SPARE_CTS_RESET_VAL
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_AUDIO_N
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|AUDIO_N_RESETF
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_AUDIO_N
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|aval_reg
argument_list|,
name|audio_aval
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|audio_disable
parameter_list|(
name|struct
name|hdmi_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
comment|/* Disable audio */
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_HDMI_GENERIC_CTRL
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|GENERIC_CTRL_AUDIO
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_HDMI_GENERIC_CTRL
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* Disable audio infoframes */
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_HDMI_AUDIO_INFOFRAME_CTRL
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|AUDIO_INFOFRAME_CTRL_ENABLE
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_HDMI_AUDIO_INFOFRAME_CTRL
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|audio_enable
parameter_list|(
name|struct
name|hdmi_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|hdmi_mode
condition|)
name|audio_disable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Enable audio infoframes */
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_HDMI_AUDIO_INFOFRAME_CTRL
argument_list|)
expr_stmt|;
name|val
operator||=
name|AUDIO_INFOFRAME_CTRL_ENABLE
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_HDMI_AUDIO_INFOFRAME_CTRL
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* Enable audio */
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_HDMI_GENERIC_CTRL
argument_list|)
expr_stmt|;
name|val
operator||=
name|GENERIC_CTRL_AUDIO
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_HDMI_GENERIC_CTRL
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------  *  *    HDMI.  *  */
end_comment

begin_comment
comment|/* Process format change notification from HDA */
end_comment

begin_function
specifier|static
name|void
name|hda_intr
parameter_list|(
name|struct
name|hdmi_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|int
name|rv
decl_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|hdmi_mode
condition|)
return|return;
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_AUDIO_HDA_CODEC_SCRATCH0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|&
operator|(
literal|1
operator|<<
literal|30
operator|)
operator|)
operator|==
literal|0
condition|)
block|{
name|audio_disable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* XXX Move this to any header */
comment|/* Keep in sync with HDA */
name|sc
operator|->
name|audio_freq
operator|=
name|val
operator|&
literal|0x00FFFFFF
expr_stmt|;
name|sc
operator|->
name|audio_chans
operator|=
operator|(
name|val
operator|>>
literal|24
operator|)
operator|&
literal|0x0f
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"%d channel(s) at %dHz\n"
argument_list|,
name|sc
operator|->
name|audio_chans
argument_list|,
name|sc
operator|->
name|audio_freq
argument_list|)
expr_stmt|;
name|rv
operator|=
name|audio_setup
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|audio_disable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
name|audio_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|tmds_init
parameter_list|(
name|struct
name|hdmi_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|struct
name|tmds_config
modifier|*
name|tmds
parameter_list|)
block|{
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_PLL0
argument_list|,
name|tmds
operator|->
name|pll0
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_PLL1
argument_list|,
name|tmds
operator|->
name|pll1
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_PE_CURRENT
argument_list|,
name|tmds
operator|->
name|pe_c
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_LANE_DRIVE_CURRENT
argument_list|,
name|tmds
operator|->
name|drive_c
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_IO_PEAK_CURRENT
argument_list|,
name|tmds
operator|->
name|peak_c
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_PAD_CTLS0
argument_list|,
name|tmds
operator|->
name|pad_ctls
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|hdmi_sor_start
parameter_list|(
name|struct
name|hdmi_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
comment|/* Enable TMDS macro */
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_PLL0
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|SOR_PLL0_PWR
expr_stmt|;
name|val
operator|&=
operator|~
name|SOR_PLL0_VCOPD
expr_stmt|;
name|val
operator|&=
operator|~
name|SOR_PLL0_PULLDOWN
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_PLL0
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_PLL0
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|SOR_PLL0_PDBG
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_PLL0
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_PWR
argument_list|,
name|SOR_PWR_SETTING_NEW
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_PWR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Wait until SOR is ready */
for|for
control|(
name|i
operator|=
literal|1000
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_PWR
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|val
operator|&
name|SOR_PWR_SETTING_NEW
operator|)
operator|==
literal|0
condition|)
break|break;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|<=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Timeouted while enabling SOR power.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
name|val
operator|=
name|SOR_STATE2_ASY_OWNER
argument_list|(
name|ASY_OWNER_HEAD0
argument_list|)
operator||
name|SOR_STATE2_ASY_SUBOWNER
argument_list|(
name|SUBOWNER_BOTH
argument_list|)
operator||
name|SOR_STATE2_ASY_CRCMODE
argument_list|(
name|ASY_CRCMODE_COMPLETE
argument_list|)
operator||
name|SOR_STATE2_ASY_PROTOCOL
argument_list|(
name|ASY_PROTOCOL_SINGLE_TMDS_A
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|->
name|flags
operator|&
name|DRM_MODE_FLAG_NHSYNC
condition|)
name|val
operator||=
name|SOR_STATE2_ASY_HSYNCPOL_NEG
expr_stmt|;
if|if
condition|(
name|mode
operator|->
name|flags
operator|&
name|DRM_MODE_FLAG_NVSYNC
condition|)
name|val
operator||=
name|SOR_STATE2_ASY_VSYNCPOL_NEG
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_STATE2
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_STATE1
argument_list|,
name|SOR_STATE1_ASY_ORMODE_NORMAL
operator||
name|SOR_STATE1_ASY_HEAD_OPMODE
argument_list|(
name|ASY_HEAD_OPMODE_AWAKE
argument_list|)
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_STATE0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_STATE0
argument_list|,
name|SOR_STATE0_UPDATE
argument_list|)
expr_stmt|;
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_STATE1
argument_list|)
expr_stmt|;
name|val
operator||=
name|SOR_STATE1_ATTACHED
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_STATE1
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_STATE0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hdmi_disable
parameter_list|(
name|struct
name|hdmi_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|tegra_crtc
modifier|*
name|crtc
decl_stmt|;
name|device_t
name|dc
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|dc
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|output
operator|.
name|encoder
operator|.
name|crtc
operator|!=
name|NULL
condition|)
block|{
name|crtc
operator|=
name|container_of
argument_list|(
name|sc
operator|->
name|output
operator|.
name|encoder
operator|.
name|crtc
argument_list|,
expr|struct
name|tegra_crtc
argument_list|,
name|drm_crtc
argument_list|)
expr_stmt|;
name|dc
operator|=
name|crtc
operator|->
name|dev
expr_stmt|;
block|}
if|if
condition|(
name|dc
operator|!=
name|NULL
condition|)
block|{
name|TEGRA_DC_HDMI_ENABLE
argument_list|(
name|dc
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|TEGRA_DC_DISPLAY_ENABLE
argument_list|(
name|dc
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
name|audio_disable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_CTRL
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|AVI_INFOFRAME_CTRL_ENABLE
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_HDMI_AVI_INFOFRAME_CTRL
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* Disable interrupts */
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_INT_ENABLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_INT_MASK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hdmi_enable
parameter_list|(
name|struct
name|hdmi_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint64_t
name|freq
decl_stmt|;
name|struct
name|drm_display_mode
modifier|*
name|mode
decl_stmt|;
name|struct
name|tegra_crtc
modifier|*
name|crtc
decl_stmt|;
name|uint32_t
name|val
decl_stmt|,
name|h_sync_width
decl_stmt|,
name|h_back_porch
decl_stmt|,
name|h_front_porch
decl_stmt|,
name|h_pulse_start
decl_stmt|;
name|uint32_t
name|h_max_ac_packet
decl_stmt|,
name|div8_2
decl_stmt|;
name|device_t
name|dc
decl_stmt|;
name|int
name|i
decl_stmt|,
name|rv
decl_stmt|;
name|mode
operator|=
operator|&
name|sc
operator|->
name|output
operator|.
name|encoder
operator|.
name|crtc
operator|->
name|mode
expr_stmt|;
name|crtc
operator|=
name|container_of
argument_list|(
name|sc
operator|->
name|output
operator|.
name|encoder
operator|.
name|crtc
argument_list|,
expr|struct
name|tegra_crtc
argument_list|,
name|drm_crtc
argument_list|)
expr_stmt|;
name|dc
operator|=
name|crtc
operator|->
name|dev
expr_stmt|;
comment|/* Compute all timings first. */
name|sc
operator|->
name|pclk
operator|=
name|mode
operator|->
name|clock
operator|*
literal|1000
expr_stmt|;
name|h_sync_width
operator|=
name|mode
operator|->
name|hsync_end
operator|-
name|mode
operator|->
name|hsync_start
expr_stmt|;
name|h_back_porch
operator|=
name|mode
operator|->
name|htotal
operator|-
name|mode
operator|->
name|hsync_end
expr_stmt|;
name|h_front_porch
operator|=
name|mode
operator|->
name|hsync_start
operator|-
name|mode
operator|->
name|hdisplay
expr_stmt|;
name|h_pulse_start
operator|=
literal|1
operator|+
name|h_sync_width
operator|+
name|h_back_porch
operator|-
literal|10
expr_stmt|;
name|h_max_ac_packet
operator|=
operator|(
name|h_sync_width
operator|+
name|h_back_porch
operator|+
name|h_front_porch
operator|-
name|HDMI_REKEY_DEFAULT
operator|-
literal|18
operator|)
operator|/
literal|32
expr_stmt|;
comment|/* Check if HDMI device is connected and detected. */
if|if
condition|(
name|sc
operator|->
name|output
operator|.
name|connector
operator|.
name|edid_blob_ptr
operator|==
name|NULL
condition|)
block|{
name|sc
operator|->
name|hdmi_mode
operator|=
name|false
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|hdmi_mode
operator|=
name|drm_detect_hdmi_monitor
argument_list|(
operator|(
expr|struct
name|edid
operator|*
operator|)
name|sc
operator|->
name|output
operator|.
name|connector
operator|.
name|edid_blob_ptr
operator|->
name|data
argument_list|)
expr_stmt|;
block|}
comment|/* Get exact HDMI pixel frequency. */
name|rv
operator|=
name|clk_get_freq
argument_list|(
name|sc
operator|->
name|clk_hdmi
argument_list|,
operator|&
name|freq
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot get 'hdmi' clock frequency\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
name|DRM_DEBUG_KMS
argument_list|(
literal|"HDMI frequency: %llu Hz\n"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
comment|/* Wakeup SOR power */
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_PLL0
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|SOR_PLL0_PDBG
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_PLL0
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_PLL0
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|SOR_PLL0_PWR
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_PLL0
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* Setup timings */
name|TEGRA_DC_SETUP_TIMING
argument_list|(
name|dc
argument_list|,
name|h_pulse_start
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_HDMI_VSYNC_WINDOW
argument_list|,
name|VSYNC_WINDOW_START
argument_list|(
literal|0x200
argument_list|)
operator||
name|VSYNC_WINDOW_END
argument_list|(
literal|0x210
argument_list|)
operator||
name|VSYNC_WINDOW_ENABLE
argument_list|)
expr_stmt|;
comment|/* Setup video source and adjust video range */
name|val
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|crtc
operator|->
name|nvidia_head
operator|!=
literal|0
condition|)
name|HDMI_SRC_DISPLAYB
expr_stmt|;
if|if
condition|(
operator|(
name|mode
operator|->
name|hdisplay
operator|!=
literal|640
operator|)
operator|||
operator|(
name|mode
operator|->
name|vdisplay
operator|!=
literal|480
operator|)
condition|)
name|val
operator||=
name|ARM_VIDEO_RANGE_LIMITED
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_INPUT_CONTROL
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* Program SOR reference clock - it uses 8.2 fractional divisor */
name|div8_2
operator|=
operator|(
name|freq
operator|*
literal|4
operator|)
operator|/
literal|1000000
expr_stmt|;
name|val
operator|=
name|SOR_REFCLK_DIV_INT
argument_list|(
name|div8_2
operator|>>
literal|2
argument_list|)
operator||
name|SOR_REFCLK_DIV_FRAC
argument_list|(
name|div8_2
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_REFCLK
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* Setup audio */
if|if
condition|(
name|sc
operator|->
name|hdmi_mode
condition|)
block|{
name|rv
operator|=
name|audio_setup
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
name|sc
operator|->
name|hdmi_mode
operator|=
name|false
expr_stmt|;
block|}
comment|/* Init HDA ELD */
name|init_hda_eld
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|val
operator|=
name|HDMI_CTRL_REKEY
argument_list|(
name|HDMI_REKEY_DEFAULT
argument_list|)
expr_stmt|;
name|val
operator||=
name|HDMI_CTRL_MAX_AC_PACKET
argument_list|(
name|h_max_ac_packet
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|hdmi_mode
condition|)
name|val
operator||=
name|HDMI_CTRL_ENABLE
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_HDMI_CTRL
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* Setup TMDS */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|n_tmds_configs
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|pclk
operator|<=
name|sc
operator|->
name|tmds_config
index|[
name|i
index|]
operator|.
name|pclk
condition|)
block|{
name|tmds_init
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|tmds_config
operator|+
name|i
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* Program sequencer. */
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_SEQ_CTL
argument_list|,
name|SOR_SEQ_PU_PC
argument_list|(
literal|0
argument_list|)
operator||
name|SOR_SEQ_PU_PC_ALT
argument_list|(
literal|0
argument_list|)
operator||
name|SOR_SEQ_PD_PC
argument_list|(
literal|8
argument_list|)
operator||
name|SOR_SEQ_PD_PC_ALT
argument_list|(
literal|8
argument_list|)
argument_list|)
expr_stmt|;
name|val
operator|=
name|SOR_SEQ_INST_WAIT_TIME
argument_list|(
literal|1
argument_list|)
operator||
name|SOR_SEQ_INST_WAIT_UNITS
argument_list|(
name|WAIT_UNITS_VSYNC
argument_list|)
operator||
name|SOR_SEQ_INST_HALT
operator||
name|SOR_SEQ_INST_DRIVE_PWM_OUT_LO
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_SEQ_INST
argument_list|(
literal|0
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_SEQ_INST
argument_list|(
literal|8
argument_list|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_CSTM
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|SOR_CSTM_LVDS_ENABLE
expr_stmt|;
name|val
operator|&=
operator|~
name|SOR_CSTM_ROTCLK
argument_list|(
operator|~
literal|0
argument_list|)
expr_stmt|;
name|val
operator||=
name|SOR_CSTM_ROTCLK
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|SOR_CSTM_MODE
argument_list|(
operator|~
literal|0
argument_list|)
expr_stmt|;
name|val
operator||=
name|SOR_CSTM_MODE
argument_list|(
name|CSTM_MODE_TMDS
argument_list|)
expr_stmt|;
name|val
operator||=
name|SOR_CSTM_PLLDIV
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_SOR_CSTM
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|TEGRA_DC_DISPLAY_ENABLE
argument_list|(
name|dc
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|rv
operator|=
name|hdmi_sor_start
argument_list|(
name|sc
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
return|return
operator|(
name|rv
operator|)
return|;
name|TEGRA_DC_HDMI_ENABLE
argument_list|(
name|dc
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|TEGRA_DC_DISPLAY_ENABLE
argument_list|(
name|dc
argument_list|,
name|true
argument_list|)
expr_stmt|;
comment|/* Enable HDA codec interrupt */
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_INT_MASK
argument_list|,
name|INT_CODEC_SCRATCH0
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_INT_ENABLE
argument_list|,
name|INT_CODEC_SCRATCH0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|hdmi_mode
condition|)
block|{
name|avi_setup_infoframe
argument_list|(
name|sc
argument_list|,
name|mode
argument_list|)
expr_stmt|;
name|audio_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* -------------------------------------------------------------------  *  *	DRM Interface.  *  */
end_comment

begin_function
specifier|static
name|enum
name|drm_mode_status
name|hdmi_connector_mode_valid
parameter_list|(
name|struct
name|drm_connector
modifier|*
name|connector
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|)
block|{
name|struct
name|tegra_drm_encoder
modifier|*
name|output
decl_stmt|;
name|struct
name|hdmi_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|uint64_t
name|freq
decl_stmt|;
name|output
operator|=
name|container_of
argument_list|(
name|connector
argument_list|,
expr|struct
name|tegra_drm_encoder
argument_list|,
name|connector
argument_list|)
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|output
operator|->
name|dev
argument_list|)
expr_stmt|;
name|freq
operator|=
name|HDMI_DC_CLOCK_MULTIPIER
operator|*
name|mode
operator|->
name|clock
operator|*
literal|1000
expr_stmt|;
name|rv
operator|=
name|clk_test_freq
argument_list|(
name|sc
operator|->
name|clk_parent
argument_list|,
name|freq
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DRM_DEBUG_KMS
argument_list|(
literal|"Test HDMI frequency: %u kHz, rv: %d\n"
argument_list|,
name|mode
operator|->
name|clock
argument_list|,
name|rv
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
return|return
operator|(
name|MODE_NOCLOCK
operator|)
return|;
return|return
operator|(
name|MODE_OK
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|drm_connector_helper_funcs
name|hdmi_connector_helper_funcs
init|=
block|{
operator|.
name|get_modes
operator|=
name|tegra_drm_connector_get_modes
block|,
operator|.
name|mode_valid
operator|=
name|hdmi_connector_mode_valid
block|,
operator|.
name|best_encoder
operator|=
name|tegra_drm_connector_best_encoder
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|drm_connector_funcs
name|hdmi_connector_funcs
init|=
block|{
operator|.
name|dpms
operator|=
name|drm_helper_connector_dpms
block|,
operator|.
name|detect
operator|=
name|tegra_drm_connector_detect
block|,
operator|.
name|fill_modes
operator|=
name|drm_helper_probe_single_connector_modes
block|,
operator|.
name|destroy
operator|=
name|drm_connector_cleanup
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|drm_encoder_funcs
name|hdmi_encoder_funcs
init|=
block|{
operator|.
name|destroy
operator|=
name|drm_encoder_cleanup
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|hdmi_encoder_dpms
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
comment|/* Empty function. */
block|}
end_function

begin_function
specifier|static
name|bool
name|hdmi_encoder_mode_fixup
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
specifier|const
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|adjusted
parameter_list|)
block|{
return|return
operator|(
name|true
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hdmi_encoder_prepare
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|)
block|{
comment|/* Empty function. */
block|}
end_function

begin_function
specifier|static
name|void
name|hdmi_encoder_commit
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|)
block|{
comment|/* Empty function. */
block|}
end_function

begin_function
specifier|static
name|void
name|hdmi_encoder_mode_set
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|mode
parameter_list|,
name|struct
name|drm_display_mode
modifier|*
name|adjusted
parameter_list|)
block|{
name|struct
name|tegra_drm_encoder
modifier|*
name|output
decl_stmt|;
name|struct
name|hdmi_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|output
operator|=
name|container_of
argument_list|(
name|encoder
argument_list|,
expr|struct
name|tegra_drm_encoder
argument_list|,
name|encoder
argument_list|)
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|output
operator|->
name|dev
argument_list|)
expr_stmt|;
name|rv
operator|=
name|hdmi_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot enable HDMI port\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hdmi_encoder_disable
parameter_list|(
name|struct
name|drm_encoder
modifier|*
name|encoder
parameter_list|)
block|{
name|struct
name|tegra_drm_encoder
modifier|*
name|output
decl_stmt|;
name|struct
name|hdmi_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|output
operator|=
name|container_of
argument_list|(
name|encoder
argument_list|,
expr|struct
name|tegra_drm_encoder
argument_list|,
name|encoder
argument_list|)
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|output
operator|->
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
return|return;
name|rv
operator|=
name|hdmi_disable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot disable HDMI port\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|drm_encoder_helper_funcs
name|hdmi_encoder_helper_funcs
init|=
block|{
operator|.
name|dpms
operator|=
name|hdmi_encoder_dpms
block|,
operator|.
name|mode_fixup
operator|=
name|hdmi_encoder_mode_fixup
block|,
operator|.
name|prepare
operator|=
name|hdmi_encoder_prepare
block|,
operator|.
name|commit
operator|=
name|hdmi_encoder_commit
block|,
operator|.
name|mode_set
operator|=
name|hdmi_encoder_mode_set
block|,
operator|.
name|disable
operator|=
name|hdmi_encoder_disable
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* -------------------------------------------------------------------  *  *	Bus and infrastructure.  *  */
end_comment

begin_function
specifier|static
name|int
name|hdmi_init_client
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|host1x
parameter_list|,
name|struct
name|tegra_drm
modifier|*
name|drm
parameter_list|)
block|{
name|struct
name|hdmi_softc
modifier|*
name|sc
decl_stmt|;
name|phandle_t
name|node
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|node
operator|=
name|ofw_bus_get_node
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|drm
operator|=
name|drm
expr_stmt|;
name|sc
operator|->
name|output
operator|.
name|setup_clock
operator|=
operator|&
name|hdmi_setup_clock
expr_stmt|;
name|rv
operator|=
name|tegra_drm_encoder_attach
argument_list|(
operator|&
name|sc
operator|->
name|output
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Cannot attach output connector\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
comment|/* Connect this encoder + connector  to DRM. */
name|drm_connector_init
argument_list|(
operator|&
name|drm
operator|->
name|drm_dev
argument_list|,
operator|&
name|sc
operator|->
name|output
operator|.
name|connector
argument_list|,
operator|&
name|hdmi_connector_funcs
argument_list|,
name|DRM_MODE_CONNECTOR_HDMIA
argument_list|)
expr_stmt|;
name|drm_connector_helper_add
argument_list|(
operator|&
name|sc
operator|->
name|output
operator|.
name|connector
argument_list|,
operator|&
name|hdmi_connector_helper_funcs
argument_list|)
expr_stmt|;
name|sc
operator|->
name|output
operator|.
name|connector
operator|.
name|dpms
operator|=
name|DRM_MODE_DPMS_OFF
expr_stmt|;
name|drm_encoder_init
argument_list|(
operator|&
name|drm
operator|->
name|drm_dev
argument_list|,
operator|&
name|sc
operator|->
name|output
operator|.
name|encoder
argument_list|,
operator|&
name|hdmi_encoder_funcs
argument_list|,
name|DRM_MODE_ENCODER_TMDS
argument_list|)
expr_stmt|;
name|drm_encoder_helper_add
argument_list|(
operator|&
name|sc
operator|->
name|output
operator|.
name|encoder
argument_list|,
operator|&
name|hdmi_encoder_helper_funcs
argument_list|)
expr_stmt|;
name|drm_mode_connector_attach_encoder
argument_list|(
operator|&
name|sc
operator|->
name|output
operator|.
name|connector
argument_list|,
operator|&
name|sc
operator|->
name|output
operator|.
name|encoder
argument_list|)
expr_stmt|;
name|rv
operator|=
name|tegra_drm_encoder_init
argument_list|(
operator|&
name|sc
operator|->
name|output
argument_list|,
name|drm
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Unable to init HDMI output\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
name|sc
operator|->
name|output
operator|.
name|encoder
operator|.
name|possible_crtcs
operator|=
literal|0x3
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hdmi_exit_client
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|host1x
parameter_list|,
name|struct
name|tegra_drm
modifier|*
name|drm
parameter_list|)
block|{
name|struct
name|hdmi_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|tegra_drm_encoder_exit
argument_list|(
operator|&
name|sc
operator|->
name|output
argument_list|,
name|drm
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_fdt_resources
parameter_list|(
name|struct
name|hdmi_softc
modifier|*
name|sc
parameter_list|,
name|phandle_t
name|node
parameter_list|)
block|{
name|int
name|rv
decl_stmt|;
name|rv
operator|=
name|regulator_get_by_ofw_property
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|0
argument_list|,
literal|"hdmi-supply"
argument_list|,
operator|&
name|sc
operator|->
name|supply_hdmi
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot get 'hdmi' regulator\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rv
operator|=
name|regulator_get_by_ofw_property
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|0
argument_list|,
literal|"pll-supply"
argument_list|,
operator|&
name|sc
operator|->
name|supply_pll
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot get 'pll' regulator\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rv
operator|=
name|regulator_get_by_ofw_property
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|0
argument_list|,
literal|"vdd-supply"
argument_list|,
operator|&
name|sc
operator|->
name|supply_vdd
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot get 'vdd' regulator\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rv
operator|=
name|hwreset_get_by_ofw_name
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|0
argument_list|,
literal|"hdmi"
argument_list|,
operator|&
name|sc
operator|->
name|hwreset_hdmi
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot get 'hdmi' reset\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rv
operator|=
name|clk_get_by_ofw_name
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|0
argument_list|,
literal|"parent"
argument_list|,
operator|&
name|sc
operator|->
name|clk_parent
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot get 'parent' clock\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rv
operator|=
name|clk_get_by_ofw_name
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|0
argument_list|,
literal|"hdmi"
argument_list|,
operator|&
name|sc
operator|->
name|clk_hdmi
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot get 'hdmi' clock\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|enable_fdt_resources
parameter_list|(
name|struct
name|hdmi_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|rv
decl_stmt|;
name|rv
operator|=
name|clk_set_parent_by_clk
argument_list|(
name|sc
operator|->
name|clk_hdmi
argument_list|,
name|sc
operator|->
name|clk_parent
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot set parent for 'hdmi' clock\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
comment|/* 594 MHz is arbitrarily selected value */
name|rv
operator|=
name|clk_set_freq
argument_list|(
name|sc
operator|->
name|clk_parent
argument_list|,
literal|594000000
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot set frequency for 'hdmi' parent clock\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
name|rv
operator|=
name|clk_set_freq
argument_list|(
name|sc
operator|->
name|clk_hdmi
argument_list|,
literal|594000000
operator|/
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot set frequency for 'hdmi' parent clock\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
name|rv
operator|=
name|regulator_enable
argument_list|(
name|sc
operator|->
name|supply_hdmi
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot enable  'hdmi' regulator\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
name|rv
operator|=
name|regulator_enable
argument_list|(
name|sc
operator|->
name|supply_pll
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot enable  'pll' regulator\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
name|rv
operator|=
name|regulator_enable
argument_list|(
name|sc
operator|->
name|supply_vdd
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot enable  'vdd' regulator\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
name|rv
operator|=
name|clk_enable
argument_list|(
name|sc
operator|->
name|clk_hdmi
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot enable 'hdmi' clock\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
name|rv
operator|=
name|hwreset_deassert
argument_list|(
name|sc
operator|->
name|hwreset_hdmi
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot unreset  'hdmi' reset\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hdmi_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|hdmi_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|status
decl_stmt|;
name|sc
operator|=
name|arg
expr_stmt|;
comment|/* Confirm interrupt */
name|status
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_INT_STATUS
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|HDMI_NV_PDISP_INT_STATUS
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/* process audio verb from HDA */
if|if
condition|(
name|status
operator|&
name|INT_CODEC_SCRATCH0
condition|)
name|hda_intr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|hdmi_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
operator|!
name|ofw_bus_status_okay
argument_list|(
name|dev
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|ofw_bus_search_compatible
argument_list|(
name|dev
argument_list|,
name|compat_data
argument_list|)
operator|->
name|ocd_data
operator|==
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Tegra HDMI"
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hdmi_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|hdmi_softc
modifier|*
name|sc
decl_stmt|;
name|phandle_t
name|node
decl_stmt|;
name|int
name|rid
decl_stmt|,
name|rv
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|output
operator|.
name|dev
operator|=
name|sc
operator|->
name|dev
expr_stmt|;
name|node
operator|=
name|ofw_bus_get_node
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|audio_src_type
operator|=
name|SOURCE_SELECT_AUTO
expr_stmt|;
name|sc
operator|->
name|audio_freq
operator|=
literal|44100
expr_stmt|;
name|sc
operator|->
name|audio_chans
operator|=
literal|2
expr_stmt|;
name|sc
operator|->
name|hdmi_mode
operator|=
name|false
expr_stmt|;
name|sc
operator|->
name|tmds_config
operator|=
name|tegra124_tmds_config
expr_stmt|;
name|sc
operator|->
name|n_tmds_configs
operator|=
name|nitems
argument_list|(
name|tegra124_tmds_config
argument_list|)
expr_stmt|;
name|rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|mem_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mem_res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Cannot allocate memory resources\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|irq_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|irq_res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Cannot allocate IRQ resources\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|rv
operator|=
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|,
name|INTR_TYPE_MISC
operator||
name|INTR_MPSAFE
argument_list|,
name|NULL
argument_list|,
name|hdmi_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|irq_ih
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"WARNING: unable to register interrupt handler\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|rv
operator|=
name|get_fdt_resources
argument_list|(
name|sc
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Cannot parse FDT resources\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|rv
operator|=
name|enable_fdt_resources
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Cannot enable FDT resources\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|rv
operator|=
name|TEGRA_DRM_REGISTER_CLIENT
argument_list|(
name|device_get_parent
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|,
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Cannot register DRM device\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
return|return
operator|(
name|bus_generic_attach
argument_list|(
name|dev
argument_list|)
operator|)
return|;
name|fail
label|:
name|TEGRA_DRM_DEREGISTER_CLIENT
argument_list|(
name|device_get_parent
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|,
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|irq_ih
operator|!=
name|NULL
condition|)
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|,
name|sc
operator|->
name|irq_ih
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|clk_parent
operator|!=
name|NULL
condition|)
name|clk_release
argument_list|(
name|sc
operator|->
name|clk_parent
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|clk_hdmi
operator|!=
name|NULL
condition|)
name|clk_release
argument_list|(
name|sc
operator|->
name|clk_hdmi
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|hwreset_hdmi
operator|!=
name|NULL
condition|)
name|hwreset_release
argument_list|(
name|sc
operator|->
name|hwreset_hdmi
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|supply_hdmi
operator|!=
name|NULL
condition|)
name|regulator_release
argument_list|(
name|sc
operator|->
name|supply_hdmi
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|supply_pll
operator|!=
name|NULL
condition|)
name|regulator_release
argument_list|(
name|sc
operator|->
name|supply_pll
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|supply_vdd
operator|!=
name|NULL
condition|)
name|regulator_release
argument_list|(
name|sc
operator|->
name|supply_vdd
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|irq_res
operator|!=
name|NULL
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mem_res
operator|!=
name|NULL
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|mem_res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hdmi_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|hdmi_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|TEGRA_DRM_DEREGISTER_CLIENT
argument_list|(
name|device_get_parent
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|,
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|irq_ih
operator|!=
name|NULL
condition|)
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|,
name|sc
operator|->
name|irq_ih
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|clk_parent
operator|!=
name|NULL
condition|)
name|clk_release
argument_list|(
name|sc
operator|->
name|clk_parent
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|clk_hdmi
operator|!=
name|NULL
condition|)
name|clk_release
argument_list|(
name|sc
operator|->
name|clk_hdmi
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|hwreset_hdmi
operator|!=
name|NULL
condition|)
name|hwreset_release
argument_list|(
name|sc
operator|->
name|hwreset_hdmi
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|supply_hdmi
operator|!=
name|NULL
condition|)
name|regulator_release
argument_list|(
name|sc
operator|->
name|supply_hdmi
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|supply_pll
operator|!=
name|NULL
condition|)
name|regulator_release
argument_list|(
name|sc
operator|->
name|supply_pll
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|supply_vdd
operator|!=
name|NULL
condition|)
name|regulator_release
argument_list|(
name|sc
operator|->
name|supply_vdd
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|irq_res
operator|!=
name|NULL
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mem_res
operator|!=
name|NULL
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|mem_res
argument_list|)
expr_stmt|;
return|return
operator|(
name|bus_generic_detach
argument_list|(
name|dev
argument_list|)
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|tegra_hdmi_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|hdmi_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|hdmi_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|hdmi_detach
argument_list|)
block|,
comment|/* tegra drm interface */
name|DEVMETHOD
argument_list|(
name|tegra_drm_init_client
argument_list|,
name|hdmi_init_client
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|tegra_drm_exit_client
argument_list|,
name|hdmi_exit_client
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|tegra_hdmi_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DEFINE_CLASS_0
argument_list|(
name|tegra_hdmi
argument_list|,
name|tegra_hdmi_driver
argument_list|,
name|tegra_hdmi_methods
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|hdmi_softc
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|tegra_hdmi
argument_list|,
name|host1x
argument_list|,
name|tegra_hdmi_driver
argument_list|,
name|tegra_hdmi_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


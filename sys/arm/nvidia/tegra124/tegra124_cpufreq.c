begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2016 Michal Meloun<mmel@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/cpu.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpu.h>
end_include

begin_include
include|#
directive|include
file|<dev/extres/clk/clk.h>
end_include

begin_include
include|#
directive|include
file|<dev/extres/regulator/regulator.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus_subr.h>
end_include

begin_include
include|#
directive|include
file|<arm/nvidia/tegra_efuse.h>
end_include

begin_include
include|#
directive|include
file|"cpufreq_if.h"
end_include

begin_define
define|#
directive|define
name|XXX
end_define

begin_comment
comment|/* CPU voltage table entry */
end_comment

begin_struct
struct|struct
name|speedo_entry
block|{
name|uint64_t
name|freq
decl_stmt|;
comment|/* Frequency point */
name|int
name|c0
decl_stmt|;
comment|/* Coeeficient values for */
name|int
name|c1
decl_stmt|;
comment|/* quadratic equation: */
name|int
name|c2
decl_stmt|;
comment|/* c2 * speedo^2 + c1 * speedo + c0 */
block|}
struct|;
end_struct

begin_struct
struct|struct
name|cpu_volt_def
block|{
name|int
name|min_uvolt
decl_stmt|;
comment|/* Min allowed CPU voltage */
name|int
name|max_uvolt
decl_stmt|;
comment|/* Max allowed CPU voltage */
name|int
name|step_uvolt
decl_stmt|;
comment|/* Step of CPU voltage */
name|int
name|speedo_scale
decl_stmt|;
comment|/* Scaling factor for cvt */
name|int
name|speedo_nitems
decl_stmt|;
comment|/* Size of speedo table */
name|struct
name|speedo_entry
modifier|*
name|speedo_tbl
decl_stmt|;
comment|/* CPU voltage table */
block|}
struct|;
end_struct

begin_struct
struct|struct
name|cpu_speed_point
block|{
name|uint64_t
name|freq
decl_stmt|;
comment|/* Frequecy */
name|int
name|uvolt
decl_stmt|;
comment|/* Requested voltage */
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|speedo_entry
name|tegra124_speedo_dpll_tbl
index|[]
init|=
block|{
block|{
literal|204000000ULL
block|,
literal|1112619
block|,
operator|-
literal|29295
block|,
literal|402
block|}
block|,
block|{
literal|306000000ULL
block|,
literal|1150460
block|,
operator|-
literal|30585
block|,
literal|402
block|}
block|,
block|{
literal|408000000ULL
block|,
literal|1190122
block|,
operator|-
literal|31865
block|,
literal|402
block|}
block|,
block|{
literal|510000000ULL
block|,
literal|1231606
block|,
operator|-
literal|33155
block|,
literal|402
block|}
block|,
block|{
literal|612000000ULL
block|,
literal|1274912
block|,
operator|-
literal|34435
block|,
literal|402
block|}
block|,
block|{
literal|714000000ULL
block|,
literal|1320040
block|,
operator|-
literal|35725
block|,
literal|402
block|}
block|,
block|{
literal|816000000ULL
block|,
literal|1366990
block|,
operator|-
literal|37005
block|,
literal|402
block|}
block|,
block|{
literal|918000000ULL
block|,
literal|1415762
block|,
operator|-
literal|38295
block|,
literal|402
block|}
block|,
block|{
literal|1020000000ULL
block|,
literal|1466355
block|,
operator|-
literal|39575
block|,
literal|402
block|}
block|,
block|{
literal|1122000000ULL
block|,
literal|1518771
block|,
operator|-
literal|40865
block|,
literal|402
block|}
block|,
block|{
literal|1224000000ULL
block|,
literal|1573009
block|,
operator|-
literal|42145
block|,
literal|402
block|}
block|,
block|{
literal|1326000000ULL
block|,
literal|1629068
block|,
operator|-
literal|43435
block|,
literal|402
block|}
block|,
block|{
literal|1428000000ULL
block|,
literal|1686950
block|,
operator|-
literal|44715
block|,
literal|402
block|}
block|,
block|{
literal|1530000000ULL
block|,
literal|1746653
block|,
operator|-
literal|46005
block|,
literal|402
block|}
block|,
block|{
literal|1632000000ULL
block|,
literal|1808179
block|,
operator|-
literal|47285
block|,
literal|402
block|}
block|,
block|{
literal|1734000000ULL
block|,
literal|1871526
block|,
operator|-
literal|48575
block|,
literal|402
block|}
block|,
block|{
literal|1836000000ULL
block|,
literal|1936696
block|,
operator|-
literal|49855
block|,
literal|402
block|}
block|,
block|{
literal|1938000000ULL
block|,
literal|2003687
block|,
operator|-
literal|51145
block|,
literal|402
block|}
block|,
block|{
literal|2014500000ULL
block|,
literal|2054787
block|,
operator|-
literal|52095
block|,
literal|402
block|}
block|,
block|{
literal|2116500000ULL
block|,
literal|2124957
block|,
operator|-
literal|53385
block|,
literal|402
block|}
block|,
block|{
literal|2218500000ULL
block|,
literal|2196950
block|,
operator|-
literal|54665
block|,
literal|402
block|}
block|,
block|{
literal|2320500000ULL
block|,
literal|2270765
block|,
operator|-
literal|55955
block|,
literal|402
block|}
block|,
block|{
literal|2320500000ULL
block|,
literal|2270765
block|,
operator|-
literal|55955
block|,
literal|402
block|}
block|,
block|{
literal|2422500000ULL
block|,
literal|2346401
block|,
operator|-
literal|57235
block|,
literal|402
block|}
block|,
block|{
literal|2524500000ULL
block|,
literal|2437299
block|,
operator|-
literal|58535
block|,
literal|402
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|cpu_volt_def
name|tegra124_cpu_volt_dpll_def
init|=
block|{
operator|.
name|min_uvolt
operator|=
literal|900000
block|,
comment|/* 0.9 V */
operator|.
name|max_uvolt
operator|=
literal|1260000
block|,
comment|/* 1.26 */
operator|.
name|step_uvolt
operator|=
literal|10000
block|,
comment|/* 10 mV */
operator|.
name|speedo_scale
operator|=
literal|100
block|,
operator|.
name|speedo_nitems
operator|=
name|nitems
argument_list|(
name|tegra124_speedo_dpll_tbl
argument_list|)
block|,
operator|.
name|speedo_tbl
operator|=
name|tegra124_speedo_dpll_tbl
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|speedo_entry
name|tegra124_speedo_pllx_tbl
index|[]
init|=
block|{
block|{
literal|204000000ULL
block|,
literal|800000
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|306000000ULL
block|,
literal|800000
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|408000000ULL
block|,
literal|800000
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|510000000ULL
block|,
literal|800000
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|612000000ULL
block|,
literal|800000
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|714000000ULL
block|,
literal|800000
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|816000000ULL
block|,
literal|820000
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|918000000ULL
block|,
literal|840000
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|1020000000ULL
block|,
literal|880000
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|1122000000ULL
block|,
literal|900000
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|1224000000ULL
block|,
literal|930000
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|1326000000ULL
block|,
literal|960000
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|1428000000ULL
block|,
literal|990000
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|1530000000ULL
block|,
literal|1020000
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|1632000000ULL
block|,
literal|1070000
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|1734000000ULL
block|,
literal|1100000
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|1836000000ULL
block|,
literal|1140000
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|1938000000ULL
block|,
literal|1180000
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|2014500000ULL
block|,
literal|1220000
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|2116500000ULL
block|,
literal|1260000
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|2218500000ULL
block|,
literal|1310000
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|2320500000ULL
block|,
literal|1360000
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|2397000000ULL
block|,
literal|1400000
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|2499000000ULL
block|,
literal|1400000
block|,
literal|0
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|cpu_volt_def
name|tegra124_cpu_volt_pllx_def
init|=
block|{
operator|.
name|min_uvolt
operator|=
literal|900000
block|,
comment|/* 0.9 V */
operator|.
name|max_uvolt
operator|=
literal|1260000
block|,
comment|/* 1.26 */
operator|.
name|step_uvolt
operator|=
literal|10000
block|,
comment|/* 10 mV */
operator|.
name|speedo_scale
operator|=
literal|100
block|,
operator|.
name|speedo_nitems
operator|=
name|nitems
argument_list|(
name|tegra124_speedo_pllx_tbl
argument_list|)
block|,
operator|.
name|speedo_tbl
operator|=
name|tegra124_speedo_pllx_tbl
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint64_t
name|cpu_freq_tbl
index|[]
init|=
block|{
literal|204000000ULL
block|,
literal|306000000ULL
block|,
literal|408000000ULL
block|,
literal|510000000ULL
block|,
literal|612000000ULL
block|,
literal|714000000ULL
block|,
literal|816000000ULL
block|,
literal|918000000ULL
block|,
literal|1020000000ULL
block|,
literal|1122000000ULL
block|,
literal|1224000000ULL
block|,
literal|1326000000ULL
block|,
literal|1428000000ULL
block|,
literal|1530000000ULL
block|,
literal|1632000000ULL
block|,
literal|1734000000ULL
block|,
literal|1836000000ULL
block|,
literal|1938000000ULL
block|,
literal|2014000000ULL
block|,
literal|2116000000ULL
block|,
literal|2218000000ULL
block|,
literal|2320000000ULL
block|,
literal|2320000000ULL
block|,
literal|2422000000ULL
block|,
literal|2524000000ULL
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|uint64_t
name|cpu_max_freq
index|[]
init|=
block|{
literal|2014500000ULL
block|,
literal|2320500000ULL
block|,
literal|2116500000ULL
block|,
literal|2524500000ULL
block|, }
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|tegra124_cpufreq_softc
block|{
name|device_t
name|dev
decl_stmt|;
name|phandle_t
name|node
decl_stmt|;
name|regulator_t
name|supply_vdd_cpu
decl_stmt|;
name|clk_t
name|clk_cpu_g
decl_stmt|;
name|clk_t
name|clk_cpu_lp
decl_stmt|;
name|clk_t
name|clk_pll_x
decl_stmt|;
name|clk_t
name|clk_pll_p
decl_stmt|;
name|clk_t
name|clk_dfll
decl_stmt|;
name|int
name|process_id
decl_stmt|;
name|int
name|speedo_id
decl_stmt|;
name|int
name|speedo_value
decl_stmt|;
name|uint64_t
name|cpu_max_freq
decl_stmt|;
name|struct
name|cpu_volt_def
modifier|*
name|cpu_def
decl_stmt|;
name|struct
name|cpu_speed_point
modifier|*
name|speed_points
decl_stmt|;
name|int
name|nspeed_points
decl_stmt|;
name|struct
name|cpu_speed_point
modifier|*
name|act_speed_point
decl_stmt|;
name|int
name|latency
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|int
name|cpufreq_lowest_freq
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.tegra124.cpufreq.lowest_freq"
argument_list|,
operator|&
name|cpufreq_lowest_freq
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|DIV_ROUND_CLOSEST
parameter_list|(
name|val
parameter_list|,
name|div
parameter_list|)
value|(((val) + ((div) / 2)) / (div))
end_define

begin_define
define|#
directive|define
name|ROUND_UP
parameter_list|(
name|val
parameter_list|,
name|div
parameter_list|)
value|((((val) + ((div) - 1)) / (div)) * (div))
end_define

begin_define
define|#
directive|define
name|ROUND_DOWN
parameter_list|(
name|val
parameter_list|,
name|div
parameter_list|)
value|(((val) / (div)) * (div))
end_define

begin_comment
comment|/*  * Compute requesetd voltage for given frequency and SoC process variations,  * - compute base voltage from speedo value using speedo table  * - round up voltage to next regulator step  * - clamp it to regulator limits  */
end_comment

begin_function
specifier|static
name|int
name|freq_to_voltage
parameter_list|(
name|struct
name|tegra124_cpufreq_softc
modifier|*
name|sc
parameter_list|,
name|uint64_t
name|freq
parameter_list|)
block|{
name|int
name|uv
decl_stmt|,
name|scale
decl_stmt|,
name|min_uvolt
decl_stmt|,
name|max_uvolt
decl_stmt|,
name|step_uvolt
decl_stmt|;
name|struct
name|speedo_entry
modifier|*
name|ent
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Get speedo entry with higher frequency */
name|ent
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|cpu_def
operator|->
name|speedo_nitems
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|cpu_def
operator|->
name|speedo_tbl
index|[
name|i
index|]
operator|.
name|freq
operator|>=
name|freq
condition|)
block|{
name|ent
operator|=
operator|&
name|sc
operator|->
name|cpu_def
operator|->
name|speedo_tbl
index|[
name|i
index|]
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|ent
operator|==
name|NULL
condition|)
name|ent
operator|=
operator|&
name|sc
operator|->
name|cpu_def
operator|->
name|speedo_tbl
index|[
name|sc
operator|->
name|cpu_def
operator|->
name|speedo_nitems
operator|-
literal|1
index|]
expr_stmt|;
name|scale
operator|=
name|sc
operator|->
name|cpu_def
operator|->
name|speedo_scale
expr_stmt|;
comment|/* uV = (c2 * speedo / scale + c1) * speedo / scale + c0) */
name|uv
operator|=
name|DIV_ROUND_CLOSEST
argument_list|(
name|ent
operator|->
name|c2
operator|*
name|sc
operator|->
name|speedo_value
argument_list|,
name|scale
argument_list|)
expr_stmt|;
name|uv
operator|=
name|DIV_ROUND_CLOSEST
argument_list|(
operator|(
name|uv
operator|+
name|ent
operator|->
name|c1
operator|)
operator|*
name|sc
operator|->
name|speedo_value
argument_list|,
name|scale
argument_list|)
operator|+
name|ent
operator|->
name|c0
expr_stmt|;
name|step_uvolt
operator|=
name|sc
operator|->
name|cpu_def
operator|->
name|step_uvolt
expr_stmt|;
comment|/* Round up it to next regulator step */
name|uv
operator|=
name|ROUND_UP
argument_list|(
name|uv
argument_list|,
name|step_uvolt
argument_list|)
expr_stmt|;
comment|/* Clamp result */
name|min_uvolt
operator|=
name|ROUND_UP
argument_list|(
name|sc
operator|->
name|cpu_def
operator|->
name|min_uvolt
argument_list|,
name|step_uvolt
argument_list|)
expr_stmt|;
name|max_uvolt
operator|=
name|ROUND_DOWN
argument_list|(
name|sc
operator|->
name|cpu_def
operator|->
name|max_uvolt
argument_list|,
name|step_uvolt
argument_list|)
expr_stmt|;
if|if
condition|(
name|uv
operator|<
name|min_uvolt
condition|)
name|uv
operator|=
name|min_uvolt
expr_stmt|;
if|if
condition|(
name|uv
operator|>
name|max_uvolt
condition|)
name|uv
operator|=
name|max_uvolt
expr_stmt|;
return|return
operator|(
name|uv
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|build_speed_points
parameter_list|(
name|struct
name|tegra124_cpufreq_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|sc
operator|->
name|nspeed_points
operator|=
name|nitems
argument_list|(
name|cpu_freq_tbl
argument_list|)
expr_stmt|;
name|sc
operator|->
name|speed_points
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|cpu_speed_point
argument_list|)
operator|*
name|sc
operator|->
name|nspeed_points
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nspeed_points
condition|;
name|i
operator|++
control|)
block|{
name|sc
operator|->
name|speed_points
index|[
name|i
index|]
operator|.
name|freq
operator|=
name|cpu_freq_tbl
index|[
name|i
index|]
expr_stmt|;
name|sc
operator|->
name|speed_points
index|[
name|i
index|]
operator|.
name|uvolt
operator|=
name|freq_to_voltage
argument_list|(
name|sc
argument_list|,
name|cpu_freq_tbl
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|cpu_speed_point
modifier|*
name|get_speed_point
parameter_list|(
name|struct
name|tegra124_cpufreq_softc
modifier|*
name|sc
parameter_list|,
name|uint64_t
name|freq
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sc
operator|->
name|speed_points
index|[
literal|0
index|]
operator|.
name|freq
operator|>=
name|freq
condition|)
return|return
operator|(
name|sc
operator|->
name|speed_points
operator|+
literal|0
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nspeed_points
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|speed_points
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|freq
operator|>
name|freq
condition|)
return|return
operator|(
name|sc
operator|->
name|speed_points
operator|+
name|i
operator|)
return|;
block|}
return|return
operator|(
name|sc
operator|->
name|speed_points
operator|+
name|sc
operator|->
name|nspeed_points
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tegra124_cpufreq_settings
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|cf_setting
modifier|*
name|sets
parameter_list|,
name|int
modifier|*
name|count
parameter_list|)
block|{
name|struct
name|tegra124_cpufreq_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|max_cnt
decl_stmt|;
if|if
condition|(
name|sets
operator|==
name|NULL
operator|||
name|count
operator|==
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|sets
argument_list|,
name|CPUFREQ_VAL_UNKNOWN
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sets
argument_list|)
operator|*
operator|(
operator|*
name|count
operator|)
argument_list|)
expr_stmt|;
name|max_cnt
operator|=
name|min
argument_list|(
name|sc
operator|->
name|nspeed_points
argument_list|,
operator|*
name|count
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
name|sc
operator|->
name|nspeed_points
operator|-
literal|1
init|;
name|j
operator|>=
literal|0
condition|;
name|j
operator|--
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|cpu_max_freq
operator|<
name|sc
operator|->
name|speed_points
index|[
name|j
index|]
operator|.
name|freq
condition|)
continue|continue;
name|sets
index|[
name|i
index|]
operator|.
name|freq
operator|=
name|sc
operator|->
name|speed_points
index|[
name|j
index|]
operator|.
name|freq
operator|/
literal|1000000
expr_stmt|;
name|sets
index|[
name|i
index|]
operator|.
name|volts
operator|=
name|sc
operator|->
name|speed_points
index|[
name|j
index|]
operator|.
name|uvolt
operator|/
literal|1000
expr_stmt|;
name|sets
index|[
name|i
index|]
operator|.
name|lat
operator|=
name|sc
operator|->
name|latency
expr_stmt|;
name|sets
index|[
name|i
index|]
operator|.
name|dev
operator|=
name|dev
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
operator|*
name|count
operator|=
name|i
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_cpu_freq
parameter_list|(
name|struct
name|tegra124_cpufreq_softc
modifier|*
name|sc
parameter_list|,
name|uint64_t
name|freq
parameter_list|)
block|{
name|struct
name|cpu_speed_point
modifier|*
name|point
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|point
operator|=
name|get_speed_point
argument_list|(
name|sc
argument_list|,
name|freq
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|act_speed_point
operator|->
name|uvolt
operator|<
name|point
operator|->
name|uvolt
condition|)
block|{
comment|/* set cpu voltage */
name|rv
operator|=
name|regulator_set_voltage
argument_list|(
name|sc
operator|->
name|supply_vdd_cpu
argument_list|,
name|point
operator|->
name|uvolt
argument_list|,
name|point
operator|->
name|uvolt
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
return|return
operator|(
name|rv
operator|)
return|;
block|}
comment|/* Switch supermux to PLLP first */
name|rv
operator|=
name|clk_set_parent_by_clk
argument_list|(
name|sc
operator|->
name|clk_cpu_g
argument_list|,
name|sc
operator|->
name|clk_pll_p
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Can't set parent to PLLP\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
comment|/* Set PLLX frequency */
name|rv
operator|=
name|clk_set_freq
argument_list|(
name|sc
operator|->
name|clk_pll_x
argument_list|,
name|point
operator|->
name|freq
argument_list|,
name|CLK_SET_ROUND_DOWN
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Can't set CPU clock frequency\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
name|rv
operator|=
name|clk_set_parent_by_clk
argument_list|(
name|sc
operator|->
name|clk_cpu_g
argument_list|,
name|sc
operator|->
name|clk_pll_x
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Can't set parent to PLLX\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
if|if
condition|(
name|sc
operator|->
name|act_speed_point
operator|->
name|uvolt
operator|>
name|point
operator|->
name|uvolt
condition|)
block|{
comment|/* set cpu voltage */
name|rv
operator|=
name|regulator_set_voltage
argument_list|(
name|sc
operator|->
name|supply_vdd_cpu
argument_list|,
name|point
operator|->
name|uvolt
argument_list|,
name|point
operator|->
name|uvolt
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
return|return
operator|(
name|rv
operator|)
return|;
block|}
name|sc
operator|->
name|act_speed_point
operator|=
name|point
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tegra124_cpufreq_set
parameter_list|(
name|device_t
name|dev
parameter_list|,
specifier|const
name|struct
name|cf_setting
modifier|*
name|cf
parameter_list|)
block|{
name|struct
name|tegra124_cpufreq_softc
modifier|*
name|sc
decl_stmt|;
name|uint64_t
name|freq
decl_stmt|;
name|int
name|rv
decl_stmt|;
if|if
condition|(
name|cf
operator|==
name|NULL
operator|||
name|cf
operator|->
name|freq
operator|<
literal|0
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|freq
operator|=
name|cf
operator|->
name|freq
expr_stmt|;
if|if
condition|(
name|freq
operator|<
name|cpufreq_lowest_freq
condition|)
name|freq
operator|=
name|cpufreq_lowest_freq
expr_stmt|;
name|freq
operator|*=
literal|1000000
expr_stmt|;
if|if
condition|(
name|freq
operator|>=
name|sc
operator|->
name|cpu_max_freq
condition|)
name|freq
operator|=
name|sc
operator|->
name|cpu_max_freq
expr_stmt|;
name|rv
operator|=
name|set_cpu_freq
argument_list|(
name|sc
argument_list|,
name|freq
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tegra124_cpufreq_get
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|cf_setting
modifier|*
name|cf
parameter_list|)
block|{
name|struct
name|tegra124_cpufreq_softc
modifier|*
name|sc
decl_stmt|;
if|if
condition|(
name|cf
operator|==
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|cf
argument_list|,
name|CPUFREQ_VAL_UNKNOWN
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cf
argument_list|)
argument_list|)
expr_stmt|;
name|cf
operator|->
name|dev
operator|=
name|NULL
expr_stmt|;
name|cf
operator|->
name|freq
operator|=
name|sc
operator|->
name|act_speed_point
operator|->
name|freq
operator|/
literal|1000000
expr_stmt|;
name|cf
operator|->
name|volts
operator|=
name|sc
operator|->
name|act_speed_point
operator|->
name|uvolt
operator|/
literal|1000
expr_stmt|;
comment|/* Transition latency in us. */
name|cf
operator|->
name|lat
operator|=
name|sc
operator|->
name|latency
expr_stmt|;
comment|/* Driver providing this setting. */
name|cf
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tegra124_cpufreq_type
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
modifier|*
name|type
parameter_list|)
block|{
if|if
condition|(
name|type
operator|==
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
operator|*
name|type
operator|=
name|CPUFREQ_TYPE_ABSOLUTE
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_fdt_resources
parameter_list|(
name|struct
name|tegra124_cpufreq_softc
modifier|*
name|sc
parameter_list|,
name|phandle_t
name|node
parameter_list|)
block|{
name|int
name|rv
decl_stmt|;
name|device_t
name|parent_dev
decl_stmt|;
name|parent_dev
operator|=
name|device_get_parent
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
name|rv
operator|=
name|regulator_get_by_ofw_property
argument_list|(
name|parent_dev
argument_list|,
literal|"vdd-cpu-supply"
argument_list|,
operator|&
name|sc
operator|->
name|supply_vdd_cpu
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot get 'vdd-cpu' regulator\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
name|rv
operator|=
name|clk_get_by_ofw_name
argument_list|(
name|parent_dev
argument_list|,
literal|"cpu_g"
argument_list|,
operator|&
name|sc
operator|->
name|clk_cpu_g
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot get 'cpu_g' clock: %d\n"
argument_list|,
name|rv
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rv
operator|=
name|clk_get_by_ofw_name
argument_list|(
name|parent_dev
argument_list|,
literal|"cpu_lp"
argument_list|,
operator|&
name|sc
operator|->
name|clk_cpu_lp
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot get 'cpu_lp' clock\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rv
operator|=
name|clk_get_by_ofw_name
argument_list|(
name|parent_dev
argument_list|,
literal|"pll_x"
argument_list|,
operator|&
name|sc
operator|->
name|clk_pll_x
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot get 'pll_x' clock\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rv
operator|=
name|clk_get_by_ofw_name
argument_list|(
name|parent_dev
argument_list|,
literal|"pll_p"
argument_list|,
operator|&
name|sc
operator|->
name|clk_pll_p
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|parent_dev
argument_list|,
literal|"Cannot get 'pll_p' clock\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rv
operator|=
name|clk_get_by_ofw_name
argument_list|(
name|parent_dev
argument_list|,
literal|"dfll"
argument_list|,
operator|&
name|sc
operator|->
name|clk_dfll
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
comment|/* XXX DPLL is not implemented yet */
comment|/* 		device_printf(sc->dev, "Cannot get 'dfll' clock\n"); 		return (ENXIO); */
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|tegra124_cpufreq_identify
parameter_list|(
name|driver_t
modifier|*
name|driver
parameter_list|,
name|device_t
name|parent
parameter_list|)
block|{
if|if
condition|(
name|device_find_child
argument_list|(
name|parent
argument_list|,
literal|"tegra124_cpufreq"
argument_list|,
operator|-
literal|1
argument_list|)
operator|!=
name|NULL
condition|)
return|return;
if|if
condition|(
name|BUS_ADD_CHILD
argument_list|(
name|parent
argument_list|,
literal|0
argument_list|,
literal|"tegra124_cpufreq"
argument_list|,
operator|-
literal|1
argument_list|)
operator|==
name|NULL
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"add child failed\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|tegra124_cpufreq_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
name|device_get_unit
argument_list|(
name|dev
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"CPU Frequency Control"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tegra124_cpufreq_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|tegra124_cpufreq_softc
modifier|*
name|sc
decl_stmt|;
name|uint64_t
name|freq
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|node
operator|=
name|ofw_bus_get_node
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|process_id
operator|=
name|tegra_sku_info
operator|.
name|cpu_process_id
expr_stmt|;
name|sc
operator|->
name|speedo_id
operator|=
name|tegra_sku_info
operator|.
name|cpu_speedo_id
expr_stmt|;
name|sc
operator|->
name|speedo_value
operator|=
name|tegra_sku_info
operator|.
name|cpu_speedo_value
expr_stmt|;
comment|/* Tegra 124 */
comment|/* XXX DPLL is not implemented yet */
if|if
condition|(
literal|1
condition|)
name|sc
operator|->
name|cpu_def
operator|=
operator|&
name|tegra124_cpu_volt_pllx_def
expr_stmt|;
else|else
name|sc
operator|->
name|cpu_def
operator|=
operator|&
name|tegra124_cpu_volt_dpll_def
expr_stmt|;
name|rv
operator|=
name|get_fdt_resources
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
return|return
operator|(
name|rv
operator|)
return|;
block|}
name|build_speed_points
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rv
operator|=
name|clk_get_freq
argument_list|(
name|sc
operator|->
name|clk_cpu_g
argument_list|,
operator|&
name|freq
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Can't get CPU clock frequency\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
if|if
condition|(
name|sc
operator|->
name|speedo_id
operator|<
name|nitems
argument_list|(
name|cpu_max_freq
argument_list|)
condition|)
name|sc
operator|->
name|cpu_max_freq
operator|=
name|cpu_max_freq
index|[
name|sc
operator|->
name|speedo_id
index|]
expr_stmt|;
else|else
name|sc
operator|->
name|cpu_max_freq
operator|=
name|cpu_max_freq
index|[
literal|0
index|]
expr_stmt|;
name|sc
operator|->
name|act_speed_point
operator|=
name|get_speed_point
argument_list|(
name|sc
argument_list|,
name|freq
argument_list|)
expr_stmt|;
comment|/* Set safe startup CPU frequency. */
name|rv
operator|=
name|set_cpu_freq
argument_list|(
name|sc
argument_list|,
literal|1632000000
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Can't set initial CPU clock frequency\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
comment|/* This device is controlled by cpufreq(4). */
name|cpufreq_register
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tegra124_cpufreq_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|tegra124_cpufreq_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|cpufreq_unregister
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|supply_vdd_cpu
operator|!=
name|NULL
condition|)
name|regulator_release
argument_list|(
name|sc
operator|->
name|supply_vdd_cpu
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|clk_cpu_g
operator|!=
name|NULL
condition|)
name|clk_release
argument_list|(
name|sc
operator|->
name|clk_cpu_g
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|clk_cpu_lp
operator|!=
name|NULL
condition|)
name|clk_release
argument_list|(
name|sc
operator|->
name|clk_cpu_lp
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|clk_pll_x
operator|!=
name|NULL
condition|)
name|clk_release
argument_list|(
name|sc
operator|->
name|clk_pll_x
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|clk_pll_p
operator|!=
name|NULL
condition|)
name|clk_release
argument_list|(
name|sc
operator|->
name|clk_pll_p
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|clk_dfll
operator|!=
name|NULL
condition|)
name|clk_release
argument_list|(
name|sc
operator|->
name|clk_dfll
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|tegra124_cpufreq_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_identify
argument_list|,
name|tegra124_cpufreq_identify
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|tegra124_cpufreq_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|tegra124_cpufreq_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|tegra124_cpufreq_detach
argument_list|)
block|,
comment|/* cpufreq interface */
name|DEVMETHOD
argument_list|(
name|cpufreq_drv_set
argument_list|,
name|tegra124_cpufreq_set
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|cpufreq_drv_get
argument_list|,
name|tegra124_cpufreq_get
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|cpufreq_drv_settings
argument_list|,
name|tegra124_cpufreq_settings
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|cpufreq_drv_type
argument_list|,
name|tegra124_cpufreq_type
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|tegra124_cpufreq_devclass
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|tegra124_cpufreq_driver
init|=
block|{
literal|"tegra124_cpufreq"
block|,
name|tegra124_cpufreq_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|tegra124_cpufreq_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|tegra124_cpufreq
argument_list|,
name|cpu
argument_list|,
name|tegra124_cpufreq_driver
argument_list|,
name|tegra124_cpufreq_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


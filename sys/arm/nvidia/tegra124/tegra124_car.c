begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2016 Michal Meloun<mmel@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/kobj.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpu.h>
end_include

begin_include
include|#
directive|include
file|<dev/extres/clk/clk_div.h>
end_include

begin_include
include|#
directive|include
file|<dev/extres/clk/clk_fixed.h>
end_include

begin_include
include|#
directive|include
file|<dev/extres/clk/clk_gate.h>
end_include

begin_include
include|#
directive|include
file|<dev/extres/clk/clk_mux.h>
end_include

begin_include
include|#
directive|include
file|<dev/extres/hwreset/hwreset.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/openfirm.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus_subr.h>
end_include

begin_include
include|#
directive|include
file|<gnu/dts/include/dt-bindings/clock/tegra124-car.h>
end_include

begin_include
include|#
directive|include
file|"clkdev_if.h"
end_include

begin_include
include|#
directive|include
file|"hwreset_if.h"
end_include

begin_include
include|#
directive|include
file|"tegra124_car.h"
end_include

begin_decl_stmt
specifier|static
name|struct
name|ofw_compat_data
name|compat_data
index|[]
init|=
block|{
block|{
literal|"nvidia,tegra124-car"
block|,
literal|1
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PLIST
parameter_list|(
name|x
parameter_list|)
value|static const char *x[]
end_define

begin_comment
comment|/* Pure multiplexer. */
end_comment

begin_define
define|#
directive|define
name|MUX
parameter_list|(
name|_id
parameter_list|,
name|cname
parameter_list|,
name|plists
parameter_list|,
name|o
parameter_list|,
name|s
parameter_list|,
name|w
parameter_list|)
define|\
value|{									\ 	.clkdef.id = _id,						\ 	.clkdef.name = cname,						\ 	.clkdef.parent_names = plists,					\ 	.clkdef.parent_cnt = nitems(plists),				\ 	.clkdef.flags = CLK_NODE_STATIC_STRINGS,			\ 	.offset = o,							\ 	.shift  = s,							\ 	.width = w,							\ }
end_define

begin_comment
comment|/* Fractional divider (7.1). */
end_comment

begin_define
define|#
directive|define
name|DIV7_1
parameter_list|(
name|_id
parameter_list|,
name|cname
parameter_list|,
name|plist
parameter_list|,
name|o
parameter_list|,
name|s
parameter_list|)
define|\
value|{									\ 	.clkdef.id = _id,						\ 	.clkdef.name = cname,						\ 	.clkdef.parent_names = (const char *[]){plist},			\ 	.clkdef.parent_cnt = 1,						\ 	.clkdef.flags =  CLK_NODE_STATIC_STRINGS,			\ 	.offset = o,							\ 	.i_shift = (s) + 1,						\ 	.i_width = 7,							\ 	.f_shift = s,							\ 	.f_width = 1,							\ }
end_define

begin_comment
comment|/* Integer divider. */
end_comment

begin_define
define|#
directive|define
name|DIV
parameter_list|(
name|_id
parameter_list|,
name|cname
parameter_list|,
name|plist
parameter_list|,
name|o
parameter_list|,
name|s
parameter_list|,
name|w
parameter_list|,
name|f
parameter_list|)
define|\
value|{									\ 	.clkdef.id = _id,						\ 	.clkdef.name = cname,						\ 	.clkdef.parent_names = (const char *[]){plist},			\ 	.clkdef.parent_cnt = 1,						\ 	.clkdef.flags =  CLK_NODE_STATIC_STRINGS,			\ 	.offset = o,							\ 	.i_shift = s,							\ 	.i_width = w,							\ 	.div_flags = f,							\ }
end_define

begin_comment
comment|/* Gate in PLL block. */
end_comment

begin_define
define|#
directive|define
name|GATE_PLL
parameter_list|(
name|_id
parameter_list|,
name|cname
parameter_list|,
name|plist
parameter_list|,
name|o
parameter_list|,
name|s
parameter_list|)
define|\
value|{									\ 	.clkdef.id = _id,						\ 	.clkdef.name = cname,						\ 	.clkdef.parent_names = (const char *[]){plist},			\ 	.clkdef.parent_cnt = 1,						\ 	.clkdef.flags = CLK_NODE_STATIC_STRINGS,			\ 	.offset = o,							\ 	.shift = s,							\ 	.mask = 3,							\ 	.on_value = 3,							\ 	.off_value = 0,							\ }
end_define

begin_comment
comment|/* Standard gate. */
end_comment

begin_define
define|#
directive|define
name|GATE
parameter_list|(
name|_id
parameter_list|,
name|cname
parameter_list|,
name|plist
parameter_list|,
name|o
parameter_list|,
name|s
parameter_list|)
define|\
value|{									\ 	.clkdef.id = _id,						\ 	.clkdef.name = cname,						\ 	.clkdef.parent_names = (const char *[]){plist},			\ 	.clkdef.parent_cnt = 1,						\ 	.clkdef.flags = CLK_NODE_STATIC_STRINGS,			\ 	.offset = o,							\ 	.shift = s,							\ 	.mask = 1,							\ 	.on_value = 1,							\ 	.off_value = 0,							\ }
end_define

begin_comment
comment|/* Inverted gate. */
end_comment

begin_define
define|#
directive|define
name|GATE_INV
parameter_list|(
name|_id
parameter_list|,
name|cname
parameter_list|,
name|plist
parameter_list|,
name|o
parameter_list|,
name|s
parameter_list|)
define|\
value|{									\ 	.clkdef.id = _id,						\ 	.clkdef.name = cname,						\ 	.clkdef.parent_names = (const char *[]){plist},			\ 	.clkdef.parent_cnt = 1,						\ 	.clkdef.flags = CLK_NODE_STATIC_STRINGS,			\ 	.offset = o,							\ 	.shift = s,							\ 	.mask = 1,							\ 	.on_value = 0,							\ 	.off_value = 1,							\ }
end_define

begin_comment
comment|/* Fixed rate clock. */
end_comment

begin_define
define|#
directive|define
name|FRATE
parameter_list|(
name|_id
parameter_list|,
name|cname
parameter_list|,
name|_freq
parameter_list|)
define|\
value|{									\ 	.clkdef.id = _id,						\ 	.clkdef.name = cname,						\ 	.clkdef.parent_names = NULL,					\ 	.clkdef.parent_cnt = 0,						\ 	.clkdef.flags = CLK_NODE_STATIC_STRINGS,			\ 	.freq = _freq,							\ }
end_define

begin_comment
comment|/* Fixed rate multipier/divider. */
end_comment

begin_define
define|#
directive|define
name|FACT
parameter_list|(
name|_id
parameter_list|,
name|cname
parameter_list|,
name|pname
parameter_list|,
name|_mult
parameter_list|,
name|_div
parameter_list|)
define|\
value|{									\ 	.clkdef.id = _id,						\ 	.clkdef.name = cname,						\ 	.clkdef.parent_names = (const char *[]){pname},			\ 	.clkdef.parent_cnt = 1,						\ 	.clkdef.flags = CLK_NODE_STATIC_STRINGS,			\ 	.mult = _mult,							\ 	.div = _div,							\ }
end_define

begin_decl_stmt
specifier|static
name|uint32_t
name|osc_freqs
index|[
literal|16
index|]
init|=
block|{
index|[
literal|0
index|]
operator|=
literal|13000000
block|,
index|[
literal|1
index|]
operator|=
literal|16800000
block|,
index|[
literal|4
index|]
operator|=
literal|19200000
block|,
index|[
literal|5
index|]
operator|=
literal|38400000
block|,
index|[
literal|8
index|]
operator|=
literal|12000000
block|,
index|[
literal|9
index|]
operator|=
literal|48000000
block|,
index|[
literal|12
index|]
operator|=
literal|260000000
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Parent lists. */
end_comment

begin_expr_stmt
name|PLIST
argument_list|(
name|mux_pll_srcs
argument_list|)
operator|=
block|{
literal|"osc_div_clk"
block|,
name|NULL
block|,
literal|"pllP_out0"
block|,
name|NULL
block|}
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* FIXME */
end_comment

begin_expr_stmt
name|PLIST
argument_list|(
name|mux_plle_src1
argument_list|)
operator|=
block|{
literal|"osc_div_clk"
block|,
literal|"pllP_out0"
block|}
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PLIST
argument_list|(
name|mux_plle_src
argument_list|)
operator|=
block|{
literal|"pllE_src1"
block|,
literal|"pllREFE_out"
block|}
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PLIST
argument_list|(
name|mux_plld_out0_plld2_out0
argument_list|)
operator|=
block|{
literal|"pllD_out0"
block|,
literal|"pllD2_out0"
block|}
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PLIST
argument_list|(
name|mux_pllmcp_clkm
argument_list|)
operator|=
block|{
literal|"pllM_out0"
block|,
literal|"pllC_out0"
block|,
literal|"pllP_out0"
block|,
literal|"clk_m"
block|,
literal|"pllM_UD"
block|,
literal|"pllC2_out0"
block|,
literal|"pllC3_out0"
block|,
literal|"pllC_UD"
block|}
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PLIST
argument_list|(
name|mux_xusb_hs
argument_list|)
operator|=
block|{
literal|"xusb_ss_div2"
block|,
literal|"pllU_60"
block|}
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|PLIST
argument_list|(
name|mux_xusb_ss
argument_list|)
operator|=
block|{
literal|"pc_xusb_ss"
block|,
literal|"osc_div_clk"
block|}
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* Clocks ajusted online. */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|clk_fixed_def
name|fixed_clk_m
init|=
name|FRATE
argument_list|(
name|TEGRA124_CLK_CLK_M
argument_list|,
literal|"clk_m"
argument_list|,
literal|12000000
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|clk_fixed_def
name|fixed_osc_div_clk
init|=
name|FACT
argument_list|(
literal|0
argument_list|,
literal|"osc_div_clk"
argument_list|,
literal|"clk_m"
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|clk_fixed_def
name|tegra124_fixed_clks
index|[]
init|=
block|{
comment|/* Core clocks. */
name|FRATE
argument_list|(
literal|0
argument_list|,
literal|"clk_s"
argument_list|,
literal|32768
argument_list|)
block|,
name|FACT
argument_list|(
literal|0
argument_list|,
literal|"clk_m_div2"
argument_list|,
literal|"clk_m"
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|)
block|,
name|FACT
argument_list|(
literal|0
argument_list|,
literal|"clk_m_div4"
argument_list|,
literal|"clk_m"
argument_list|,
literal|1
argument_list|,
literal|3
argument_list|)
block|,
name|FACT
argument_list|(
literal|0
argument_list|,
literal|"pllU_60"
argument_list|,
literal|"pllU_out"
argument_list|,
literal|1
argument_list|,
literal|8
argument_list|)
block|,
name|FACT
argument_list|(
literal|0
argument_list|,
literal|"pllU_48"
argument_list|,
literal|"pllU_out"
argument_list|,
literal|1
argument_list|,
literal|10
argument_list|)
block|,
name|FACT
argument_list|(
literal|0
argument_list|,
literal|"pllU_12"
argument_list|,
literal|"pllU_out"
argument_list|,
literal|1
argument_list|,
literal|40
argument_list|)
block|,
name|FACT
argument_list|(
name|TEGRA124_CLK_PLL_D_OUT0
argument_list|,
literal|"pllD_out0"
argument_list|,
literal|"pllD_out"
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|)
block|,
name|FACT
argument_list|(
name|TEGRA124_CLK_PLL_D2_OUT0
argument_list|,
literal|"pllD2_out0"
argument_list|,
literal|"pllD2_out"
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
block|,
name|FACT
argument_list|(
literal|0
argument_list|,
literal|"pllX_out0"
argument_list|,
literal|"pllX_out"
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|)
block|,
name|FACT
argument_list|(
literal|0
argument_list|,
literal|"pllC_UD"
argument_list|,
literal|"pllC_out0"
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
block|,
name|FACT
argument_list|(
literal|0
argument_list|,
literal|"pllM_UD"
argument_list|,
literal|"pllM_out0"
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
block|,
comment|/* Audio clocks. */
name|FRATE
argument_list|(
literal|0
argument_list|,
literal|"audio0"
argument_list|,
literal|10000000
argument_list|)
block|,
name|FRATE
argument_list|(
literal|0
argument_list|,
literal|"audio1"
argument_list|,
literal|10000000
argument_list|)
block|,
name|FRATE
argument_list|(
literal|0
argument_list|,
literal|"audio2"
argument_list|,
literal|10000000
argument_list|)
block|,
name|FRATE
argument_list|(
literal|0
argument_list|,
literal|"audio3"
argument_list|,
literal|10000000
argument_list|)
block|,
name|FRATE
argument_list|(
literal|0
argument_list|,
literal|"audio4"
argument_list|,
literal|10000000
argument_list|)
block|,
name|FRATE
argument_list|(
literal|0
argument_list|,
literal|"ext_vimclk"
argument_list|,
literal|10000000
argument_list|)
block|,
comment|/* XUSB */
name|FACT
argument_list|(
name|TEGRA124_CLK_XUSB_SS_DIV2
argument_list|,
literal|"xusb_ss_div2"
argument_list|,
literal|"xusb_ss"
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|)
block|,  }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|clk_mux_def
name|tegra124_mux_clks
index|[]
init|=
block|{
comment|/* Core clocks. */
name|MUX
argument_list|(
literal|0
argument_list|,
literal|"pllD2_src"
argument_list|,
name|mux_pll_srcs
argument_list|,
name|PLLD2_BASE
argument_list|,
literal|25
argument_list|,
literal|2
argument_list|)
block|,
name|MUX
argument_list|(
literal|0
argument_list|,
literal|"pllDP_src"
argument_list|,
name|mux_pll_srcs
argument_list|,
name|PLLDP_BASE
argument_list|,
literal|25
argument_list|,
literal|2
argument_list|)
block|,
name|MUX
argument_list|(
literal|0
argument_list|,
literal|"pllC4_src"
argument_list|,
name|mux_pll_srcs
argument_list|,
name|PLLC4_BASE
argument_list|,
literal|25
argument_list|,
literal|2
argument_list|)
block|,
name|MUX
argument_list|(
literal|0
argument_list|,
literal|"pllE_src1"
argument_list|,
name|mux_plle_src1
argument_list|,
name|PLLE_AUX
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|)
block|,
name|MUX
argument_list|(
literal|0
argument_list|,
literal|"pllE_src"
argument_list|,
name|mux_plle_src
argument_list|,
name|PLLE_AUX
argument_list|,
literal|28
argument_list|,
literal|1
argument_list|)
block|,
comment|/* Base peripheral clocks. */
name|MUX
argument_list|(
literal|0
argument_list|,
literal|"dsia_mux"
argument_list|,
name|mux_plld_out0_plld2_out0
argument_list|,
name|PLLD_BASE
argument_list|,
literal|25
argument_list|,
literal|1
argument_list|)
block|,
name|MUX
argument_list|(
literal|0
argument_list|,
literal|"dsib_mux"
argument_list|,
name|mux_plld_out0_plld2_out0
argument_list|,
name|PLLD2_BASE
argument_list|,
literal|25
argument_list|,
literal|1
argument_list|)
block|,
name|MUX
argument_list|(
literal|0
argument_list|,
literal|"emc_mux"
argument_list|,
name|mux_pllmcp_clkm
argument_list|,
name|CLK_SOURCE_EMC
argument_list|,
literal|29
argument_list|,
literal|3
argument_list|)
block|,
comment|/* USB. */
name|MUX
argument_list|(
name|TEGRA124_CLK_XUSB_HS_SRC
argument_list|,
literal|"xusb_hs"
argument_list|,
name|mux_xusb_hs
argument_list|,
name|CLK_SOURCE_XUSB_SS
argument_list|,
literal|25
argument_list|,
literal|1
argument_list|)
block|,
name|MUX
argument_list|(
literal|0
argument_list|,
literal|"xusb_ss_mux"
argument_list|,
name|mux_xusb_ss
argument_list|,
name|CLK_SOURCE_XUSB_SS
argument_list|,
literal|24
argument_list|,
literal|1
argument_list|)
block|,  }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|clk_gate_def
name|tegra124_gate_clks
index|[]
init|=
block|{
comment|/* Core clocks. */
name|GATE_PLL
argument_list|(
literal|0
argument_list|,
literal|"pllC_out1"
argument_list|,
literal|"pllC_out1_div"
argument_list|,
name|PLLC_OUT
argument_list|,
literal|0
argument_list|)
block|,
name|GATE_PLL
argument_list|(
literal|0
argument_list|,
literal|"pllM_out1"
argument_list|,
literal|"pllM_out1_div"
argument_list|,
name|PLLM_OUT
argument_list|,
literal|0
argument_list|)
block|,
name|GATE_PLL
argument_list|(
name|TEGRA124_CLK_PLL_U_480M
argument_list|,
literal|"pllU_480"
argument_list|,
literal|"pllU_out"
argument_list|,
name|PLLU_BASE
argument_list|,
literal|22
argument_list|)
block|,
name|GATE_PLL
argument_list|(
literal|0
argument_list|,
literal|"pllP_outX0"
argument_list|,
literal|"pllP_outX0_div"
argument_list|,
name|PLLP_RESHIFT
argument_list|,
literal|0
argument_list|)
block|,
name|GATE_PLL
argument_list|(
literal|0
argument_list|,
literal|"pllP_out1"
argument_list|,
literal|"pllP_out1_div"
argument_list|,
name|PLLP_OUTA
argument_list|,
literal|0
argument_list|)
block|,
name|GATE_PLL
argument_list|(
literal|0
argument_list|,
literal|"pllP_out2"
argument_list|,
literal|"pllP_out2_div"
argument_list|,
name|PLLP_OUTA
argument_list|,
literal|16
argument_list|)
block|,
name|GATE_PLL
argument_list|(
literal|0
argument_list|,
literal|"pllP_out3"
argument_list|,
literal|"pllP_out3_div"
argument_list|,
name|PLLP_OUTB
argument_list|,
literal|0
argument_list|)
block|,
name|GATE_PLL
argument_list|(
literal|0
argument_list|,
literal|"pllP_out4"
argument_list|,
literal|"pllP_out4_div"
argument_list|,
name|PLLP_OUTB
argument_list|,
literal|16
argument_list|)
block|,
name|GATE_PLL
argument_list|(
literal|0
argument_list|,
literal|"pllP_out5"
argument_list|,
literal|"pllP_out5_div"
argument_list|,
name|PLLP_OUTC
argument_list|,
literal|16
argument_list|)
block|,
name|GATE_PLL
argument_list|(
literal|0
argument_list|,
literal|"pllA_out0"
argument_list|,
literal|"pllA_out1_div"
argument_list|,
name|PLLA_OUT
argument_list|,
literal|0
argument_list|)
block|,
comment|/* Base peripheral clocks. */
name|GATE
argument_list|(
name|TEGRA124_CLK_CML0
argument_list|,
literal|"cml0"
argument_list|,
literal|"pllE_out0"
argument_list|,
name|PLLE_AUX
argument_list|,
literal|0
argument_list|)
block|,
name|GATE
argument_list|(
name|TEGRA124_CLK_CML1
argument_list|,
literal|"cml1"
argument_list|,
literal|"pllE_out0"
argument_list|,
name|PLLE_AUX
argument_list|,
literal|1
argument_list|)
block|,
name|GATE_INV
argument_list|(
name|TEGRA124_CLK_HCLK
argument_list|,
literal|"hclk"
argument_list|,
literal|"hclk_div"
argument_list|,
name|CLK_SYSTEM_RATE
argument_list|,
literal|7
argument_list|)
block|,
name|GATE_INV
argument_list|(
name|TEGRA124_CLK_PCLK
argument_list|,
literal|"pclk"
argument_list|,
literal|"pclk_div"
argument_list|,
name|CLK_SYSTEM_RATE
argument_list|,
literal|3
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|clk_div_def
name|tegra124_div_clks
index|[]
init|=
block|{
comment|/* Core clocks. */
name|DIV7_1
argument_list|(
literal|0
argument_list|,
literal|"pllC_out1_div"
argument_list|,
literal|"pllC_out0"
argument_list|,
name|PLLC_OUT
argument_list|,
literal|2
argument_list|)
block|,
name|DIV7_1
argument_list|(
literal|0
argument_list|,
literal|"pllM_out1_div"
argument_list|,
literal|"pllM_out0"
argument_list|,
name|PLLM_OUT
argument_list|,
literal|8
argument_list|)
block|,
name|DIV7_1
argument_list|(
literal|0
argument_list|,
literal|"pllP_outX0_div"
argument_list|,
literal|"pllP_out0"
argument_list|,
name|PLLP_RESHIFT
argument_list|,
literal|2
argument_list|)
block|,
name|DIV7_1
argument_list|(
literal|0
argument_list|,
literal|"pllP_out1_div"
argument_list|,
literal|"pllP_out0"
argument_list|,
name|PLLP_OUTA
argument_list|,
literal|8
argument_list|)
block|,
name|DIV7_1
argument_list|(
literal|0
argument_list|,
literal|"pllP_out2_div"
argument_list|,
literal|"pllP_out0"
argument_list|,
name|PLLP_OUTA
argument_list|,
literal|24
argument_list|)
block|,
name|DIV7_1
argument_list|(
literal|0
argument_list|,
literal|"pllP_out3_div"
argument_list|,
literal|"pllP_out0"
argument_list|,
name|PLLP_OUTB
argument_list|,
literal|8
argument_list|)
block|,
name|DIV7_1
argument_list|(
literal|0
argument_list|,
literal|"pllP_out4_div"
argument_list|,
literal|"pllP_out0"
argument_list|,
name|PLLP_OUTB
argument_list|,
literal|24
argument_list|)
block|,
name|DIV7_1
argument_list|(
literal|0
argument_list|,
literal|"pllP_out5_div"
argument_list|,
literal|"pllP_out0"
argument_list|,
name|PLLP_OUTC
argument_list|,
literal|24
argument_list|)
block|,
name|DIV7_1
argument_list|(
literal|0
argument_list|,
literal|"pllA_out1_div"
argument_list|,
literal|"pllA_out"
argument_list|,
name|PLLA_OUT
argument_list|,
literal|8
argument_list|)
block|,
comment|/* Base peripheral clocks. */
name|DIV
argument_list|(
literal|0
argument_list|,
literal|"hclk_div"
argument_list|,
literal|"sclk"
argument_list|,
name|CLK_SYSTEM_RATE
argument_list|,
literal|4
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
block|,
name|DIV
argument_list|(
literal|0
argument_list|,
literal|"pclk_div"
argument_list|,
literal|"hclk"
argument_list|,
name|CLK_SYSTEM_RATE
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Initial setup table. */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|tegra124_init_item
name|clk_init_table
index|[]
init|=
block|{
comment|/* clock, partent, frequency, enable */
block|{
literal|"uarta"
block|,
literal|"pllP_out0"
block|,
literal|408000000
block|,
literal|0
block|}
block|,
block|{
literal|"uartb"
block|,
literal|"pllP_out0"
block|,
literal|408000000
block|,
literal|0
block|}
block|,
block|{
literal|"uartc"
block|,
literal|"pllP_out0"
block|,
literal|408000000
block|,
literal|0
block|}
block|,
block|{
literal|"uartd"
block|,
literal|"pllP_out0"
block|,
literal|408000000
block|,
literal|0
block|}
block|,
block|{
literal|"pllA_out"
block|,
name|NULL
block|,
literal|282240000
block|,
literal|1
block|}
block|,
block|{
literal|"pllA_out0"
block|,
name|NULL
block|,
literal|11289600
block|,
literal|1
block|}
block|,
block|{
literal|"extperiph1"
block|,
literal|"pllA_out0"
block|,
literal|0
block|,
literal|1
block|}
block|,
block|{
literal|"i2s0"
block|,
literal|"pllA_out0"
block|,
literal|11289600
block|,
literal|0
block|}
block|,
block|{
literal|"i2s1"
block|,
literal|"pllA_out0"
block|,
literal|11289600
block|,
literal|0
block|}
block|,
block|{
literal|"i2s2"
block|,
literal|"pllA_out0"
block|,
literal|11289600
block|,
literal|0
block|}
block|,
block|{
literal|"i2s3"
block|,
literal|"pllA_out0"
block|,
literal|11289600
block|,
literal|0
block|}
block|,
block|{
literal|"i2s4"
block|,
literal|"pllA_out0"
block|,
literal|11289600
block|,
literal|0
block|}
block|,
block|{
literal|"vde"
block|,
literal|"pllP_out0"
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"host1x"
block|,
literal|"pllP_out0"
block|,
literal|136000000
block|,
literal|1
block|}
block|,
block|{
literal|"sclk"
block|,
literal|"pllP_out2"
block|,
literal|102000000
block|,
literal|1
block|}
block|,
block|{
literal|"dvfs_soc"
block|,
literal|"pllP_out0"
block|,
literal|51000000
block|,
literal|1
block|}
block|,
block|{
literal|"dvfs_ref"
block|,
literal|"pllP_out0"
block|,
literal|51000000
block|,
literal|1
block|}
block|,
block|{
literal|"pllC_out0"
block|,
name|NULL
block|,
literal|600000000
block|,
literal|0
block|}
block|,
block|{
literal|"pllC_out1"
block|,
name|NULL
block|,
literal|100000000
block|,
literal|0
block|}
block|,
block|{
literal|"spi4"
block|,
literal|"pllP_out0"
block|,
literal|12000000
block|,
literal|1
block|}
block|,
block|{
literal|"tsec"
block|,
literal|"pllC3_out0"
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"msenc"
block|,
literal|"pllC3_out0"
block|,
literal|0
block|,
literal|0
block|}
block|,
block|{
literal|"pllREFE_out"
block|,
name|NULL
block|,
literal|672000000
block|,
literal|0
block|}
block|,
block|{
literal|"pc_xusb_ss"
block|,
literal|"pllU_480"
block|,
literal|120000000
block|,
literal|0
block|}
block|,
block|{
literal|"xusb_ss"
block|,
literal|"pc_xusb_ss"
block|,
literal|120000000
block|,
literal|0
block|}
block|,
block|{
literal|"pc_xusb_fs"
block|,
literal|"pllU_48"
block|,
literal|48000000
block|,
literal|0
block|}
block|,
block|{
literal|"xusb_hs"
block|,
literal|"pllU_60"
block|,
literal|60000000
block|,
literal|0
block|}
block|,
block|{
literal|"pc_xusb_falcon"
block|,
literal|"pllREFE_out"
block|,
literal|224000000
block|,
literal|0
block|}
block|,
block|{
literal|"xusb_core_host"
block|,
literal|"pllREFE_out"
block|,
literal|112000000
block|,
literal|0
block|}
block|,
block|{
literal|"sata"
block|,
literal|"pllP_out0"
block|,
literal|102000000
block|,
literal|0
block|}
block|,
block|{
literal|"sata_oob"
block|,
literal|"pllP_out0"
block|,
literal|204000000
block|,
literal|0
block|}
block|,
block|{
literal|"sata_cold"
block|,
name|NULL
block|,
literal|0
block|,
literal|1
block|}
block|,
block|{
literal|"emc"
block|,
name|NULL
block|,
literal|0
block|,
literal|1
block|}
block|,
block|{
literal|"mselect"
block|,
name|NULL
block|,
literal|0
block|,
literal|1
block|}
block|,
block|{
literal|"csite"
block|,
name|NULL
block|,
literal|0
block|,
literal|1
block|}
block|,
block|{
literal|"tsensor"
block|,
literal|"clk_m"
block|,
literal|400000
block|,
literal|0
block|}
block|,
comment|/* tegra124 only*/
block|{
literal|"soc_therm"
block|,
literal|"pllP_out0"
block|,
literal|51000000
block|,
literal|0
block|}
block|,
block|{
literal|"cclk_g"
block|,
name|NULL
block|,
literal|0
block|,
literal|1
block|}
block|,
block|{
literal|"hda"
block|,
literal|"pllP_out0"
block|,
literal|102000000
block|,
literal|0
block|}
block|,
block|{
literal|"hda2codec_2x"
block|,
literal|"pllP_out0"
block|,
literal|48000000
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|init_divs
parameter_list|(
name|struct
name|tegra124_car_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|clk_div_def
modifier|*
name|clks
parameter_list|,
name|int
name|nclks
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|rv
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nclks
condition|;
name|i
operator|++
control|)
block|{
name|rv
operator|=
name|clknode_div_register
argument_list|(
name|sc
operator|->
name|clkdom
argument_list|,
name|clks
operator|+
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
name|panic
argument_list|(
literal|"clk_div_register failed"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|init_gates
parameter_list|(
name|struct
name|tegra124_car_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|clk_gate_def
modifier|*
name|clks
parameter_list|,
name|int
name|nclks
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|rv
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nclks
condition|;
name|i
operator|++
control|)
block|{
name|rv
operator|=
name|clknode_gate_register
argument_list|(
name|sc
operator|->
name|clkdom
argument_list|,
name|clks
operator|+
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
name|panic
argument_list|(
literal|"clk_gate_register failed"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|init_muxes
parameter_list|(
name|struct
name|tegra124_car_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|clk_mux_def
modifier|*
name|clks
parameter_list|,
name|int
name|nclks
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|rv
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nclks
condition|;
name|i
operator|++
control|)
block|{
name|rv
operator|=
name|clknode_mux_register
argument_list|(
name|sc
operator|->
name|clkdom
argument_list|,
name|clks
operator|+
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
name|panic
argument_list|(
literal|"clk_mux_register failed"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|init_fixeds
parameter_list|(
name|struct
name|tegra124_car_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|clk_fixed_def
modifier|*
name|clks
parameter_list|,
name|int
name|nclks
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|rv
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|int
name|osc_idx
decl_stmt|;
name|CLKDEV_READ_4
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|OSC_CTRL
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|osc_idx
operator|=
name|val
operator|>>
name|OSC_CTRL_OSC_FREQ_SHIFT
expr_stmt|;
name|fixed_clk_m
operator|.
name|freq
operator|=
name|osc_freqs
index|[
name|osc_idx
index|]
expr_stmt|;
if|if
condition|(
name|fixed_clk_m
operator|.
name|freq
operator|==
literal|0
condition|)
name|panic
argument_list|(
literal|"Undefined input frequency"
argument_list|)
expr_stmt|;
name|rv
operator|=
name|clknode_fixed_register
argument_list|(
name|sc
operator|->
name|clkdom
argument_list|,
operator|&
name|fixed_clk_m
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
name|panic
argument_list|(
literal|"clk_fixed_register failed"
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
name|val
operator|>>
name|OSC_CTRL_PLL_REF_DIV_SHIFT
operator|)
operator|&
literal|3
expr_stmt|;
name|fixed_osc_div_clk
operator|.
name|div
operator|=
literal|1
operator|<<
name|val
expr_stmt|;
name|rv
operator|=
name|clknode_fixed_register
argument_list|(
name|sc
operator|->
name|clkdom
argument_list|,
operator|&
name|fixed_osc_div_clk
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
name|panic
argument_list|(
literal|"clk_fixed_register failed"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nclks
condition|;
name|i
operator|++
control|)
block|{
name|rv
operator|=
name|clknode_fixed_register
argument_list|(
name|sc
operator|->
name|clkdom
argument_list|,
name|clks
operator|+
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
name|panic
argument_list|(
literal|"clk_fixed_register failed"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|postinit_clock
parameter_list|(
name|struct
name|tegra124_car_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|tegra124_init_item
modifier|*
name|tbl
decl_stmt|;
name|struct
name|clknode
modifier|*
name|clknode
decl_stmt|;
name|int
name|rv
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|clk_init_table
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|tbl
operator|=
operator|&
name|clk_init_table
index|[
name|i
index|]
expr_stmt|;
name|clknode
operator|=
name|clknode_find_by_name
argument_list|(
name|tbl
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|clknode
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot find clock %s\n"
argument_list|,
name|tbl
operator|->
name|name
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|tbl
operator|->
name|parent
operator|!=
name|NULL
condition|)
block|{
name|rv
operator|=
name|clknode_set_parent_by_name
argument_list|(
name|clknode
argument_list|,
name|tbl
operator|->
name|parent
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot set parent for %s (to %s): %d\n"
argument_list|,
name|tbl
operator|->
name|name
argument_list|,
name|tbl
operator|->
name|parent
argument_list|,
name|rv
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
if|if
condition|(
name|tbl
operator|->
name|frequency
operator|!=
literal|0
condition|)
block|{
name|rv
operator|=
name|clknode_set_freq
argument_list|(
name|clknode
argument_list|,
name|tbl
operator|->
name|frequency
argument_list|,
literal|0
argument_list|,
literal|9999
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot set frequency for %s: %d\n"
argument_list|,
name|tbl
operator|->
name|name
argument_list|,
name|rv
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
if|if
condition|(
name|tbl
operator|->
name|enable
operator|!=
literal|0
condition|)
block|{
name|rv
operator|=
name|clknode_enable
argument_list|(
name|clknode
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot enable %s: %d\n"
argument_list|,
name|tbl
operator|->
name|name
argument_list|,
name|rv
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|register_clocks
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|tegra124_car_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|clkdom
operator|=
name|clkdom_create
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|clkdom
operator|==
name|NULL
condition|)
name|panic
argument_list|(
literal|"clkdom == NULL"
argument_list|)
expr_stmt|;
name|tegra124_init_plls
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|init_fixeds
argument_list|(
name|sc
argument_list|,
name|tegra124_fixed_clks
argument_list|,
name|nitems
argument_list|(
name|tegra124_fixed_clks
argument_list|)
argument_list|)
expr_stmt|;
name|init_muxes
argument_list|(
name|sc
argument_list|,
name|tegra124_mux_clks
argument_list|,
name|nitems
argument_list|(
name|tegra124_mux_clks
argument_list|)
argument_list|)
expr_stmt|;
name|init_divs
argument_list|(
name|sc
argument_list|,
name|tegra124_div_clks
argument_list|,
name|nitems
argument_list|(
name|tegra124_div_clks
argument_list|)
argument_list|)
expr_stmt|;
name|init_gates
argument_list|(
name|sc
argument_list|,
name|tegra124_gate_clks
argument_list|,
name|nitems
argument_list|(
name|tegra124_gate_clks
argument_list|)
argument_list|)
expr_stmt|;
name|tegra124_periph_clock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|tegra124_super_mux_clock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|clkdom_finit
argument_list|(
name|sc
operator|->
name|clkdom
argument_list|)
expr_stmt|;
name|clkdom_xlock
argument_list|(
name|sc
operator|->
name|clkdom
argument_list|)
expr_stmt|;
name|postinit_clock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|clkdom_unlock
argument_list|(
name|sc
operator|->
name|clkdom
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|clkdom_dump
argument_list|(
name|sc
operator|->
name|clkdom
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|tegra124_car_clkdev_read_4
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|bus_addr_t
name|addr
parameter_list|,
name|uint32_t
modifier|*
name|val
parameter_list|)
block|{
name|struct
name|tegra124_car_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
operator|*
name|val
operator|=
name|bus_read_4
argument_list|(
name|sc
operator|->
name|mem_res
argument_list|,
name|addr
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tegra124_car_clkdev_write_4
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|bus_addr_t
name|addr
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|struct
name|tegra124_car_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|bus_write_4
argument_list|(
name|sc
operator|->
name|mem_res
argument_list|,
name|addr
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tegra124_car_clkdev_modify_4
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|bus_addr_t
name|addr
parameter_list|,
name|uint32_t
name|clear_mask
parameter_list|,
name|uint32_t
name|set_mask
parameter_list|)
block|{
name|struct
name|tegra124_car_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|reg
operator|=
name|bus_read_4
argument_list|(
name|sc
operator|->
name|mem_res
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|clear_mask
expr_stmt|;
name|reg
operator||=
name|set_mask
expr_stmt|;
name|bus_write_4
argument_list|(
name|sc
operator|->
name|mem_res
argument_list|,
name|addr
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|tegra124_car_clkdev_device_lock
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|tegra124_car_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|tegra124_car_clkdev_device_unlock
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|tegra124_car_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|tegra124_car_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Error: Clock driver cannot be detached\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EBUSY
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tegra124_car_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
operator|!
name|ofw_bus_status_okay
argument_list|(
name|dev
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|ofw_bus_search_compatible
argument_list|(
name|dev
argument_list|,
name|compat_data
argument_list|)
operator|->
name|ocd_data
operator|!=
literal|0
condition|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Tegra Clock Driver"
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tegra124_car_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|tegra124_car_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|rid
decl_stmt|,
name|rv
decl_stmt|;
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|sc
operator|->
name|mtx
argument_list|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|sc
operator|->
name|type
operator|=
name|ofw_bus_search_compatible
argument_list|(
name|dev
argument_list|,
name|compat_data
argument_list|)
operator|->
name|ocd_data
expr_stmt|;
comment|/* Resource setup. */
name|rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|mem_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|mem_res
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot allocate memory resource\n"
argument_list|)
expr_stmt|;
name|rv
operator|=
name|ENXIO
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|register_clocks
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|hwreset_register_ofw_provider
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
if|if
condition|(
name|sc
operator|->
name|mem_res
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|mem_res
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tegra124_car_hwreset_assert
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|intptr_t
name|id
parameter_list|,
name|bool
name|value
parameter_list|)
block|{
name|struct
name|tegra124_car_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
return|return
operator|(
name|tegra124_hwreset_by_idx
argument_list|(
name|sc
argument_list|,
name|id
argument_list|,
name|value
argument_list|)
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|tegra124_car_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|tegra124_car_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|tegra124_car_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|tegra124_car_detach
argument_list|)
block|,
comment|/* Clkdev  interface*/
name|DEVMETHOD
argument_list|(
name|clkdev_read_4
argument_list|,
name|tegra124_car_clkdev_read_4
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|clkdev_write_4
argument_list|,
name|tegra124_car_clkdev_write_4
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|clkdev_modify_4
argument_list|,
name|tegra124_car_clkdev_modify_4
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|clkdev_device_lock
argument_list|,
name|tegra124_car_clkdev_device_lock
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|clkdev_device_unlock
argument_list|,
name|tegra124_car_clkdev_device_unlock
argument_list|)
block|,
comment|/* Reset interface */
name|DEVMETHOD
argument_list|(
name|hwreset_assert
argument_list|,
name|tegra124_car_hwreset_assert
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|tegra124_car_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
specifier|static
name|DEFINE_CLASS_0
argument_list|(
name|car
argument_list|,
name|tegra124_car_driver
argument_list|,
name|tegra124_car_methods
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|tegra124_car_softc
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|EARLY_DRIVER_MODULE
argument_list|(
name|tegra124_car
argument_list|,
name|simplebus
argument_list|,
name|tegra124_car_driver
argument_list|,
name|tegra124_car_devclass
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|BUS_PASS_TIMER
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


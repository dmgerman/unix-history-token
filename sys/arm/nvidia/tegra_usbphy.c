begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2016 Michal Meloun<mmel@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * USB phy driver for Tegra SoCs.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/fdt.h>
end_include

begin_include
include|#
directive|include
file|<dev/extres/clk/clk.h>
end_include

begin_include
include|#
directive|include
file|<dev/extres/hwreset/hwreset.h>
end_include

begin_include
include|#
directive|include
file|<dev/extres/phy/phy.h>
end_include

begin_include
include|#
directive|include
file|<dev/extres/regulator/regulator.h>
end_include

begin_include
include|#
directive|include
file|<dev/fdt/fdt_common.h>
end_include

begin_include
include|#
directive|include
file|<dev/fdt/fdt_pinctrl.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/openfirm.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus_subr.h>
end_include

begin_include
include|#
directive|include
file|"phy_if.h"
end_include

begin_define
define|#
directive|define
name|CTRL_ICUSB_CTRL
value|0x15c
end_define

begin_define
define|#
directive|define
name|ICUSB_CTR_IC_ENB1
value|(1<< 3)
end_define

begin_define
define|#
directive|define
name|CTRL_USB_USBMODE
value|0x1f8
end_define

begin_define
define|#
directive|define
name|USB_USBMODE_MASK
value|(3<< 0)
end_define

begin_define
define|#
directive|define
name|USB_USBMODE_HOST
value|(3<< 0)
end_define

begin_define
define|#
directive|define
name|USB_USBMODE_DEVICE
value|(2<< 0)
end_define

begin_define
define|#
directive|define
name|CTRL_USB_HOSTPC1_DEVLC
value|0x1b4
end_define

begin_define
define|#
directive|define
name|USB_HOSTPC1_DEVLC_PTS
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x7)<< 29)
end_define

begin_define
define|#
directive|define
name|USB_HOSTPC1_DEVLC_STS
value|(1<< 28)
end_define

begin_define
define|#
directive|define
name|USB_HOSTPC1_DEVLC_PHCD
value|(1<< 22)
end_define

begin_define
define|#
directive|define
name|IF_USB_SUSP_CTRL
value|0x400
end_define

begin_define
define|#
directive|define
name|FAST_WAKEUP_RESP
value|(1<< 26)
end_define

begin_define
define|#
directive|define
name|UTMIP_SUSPL1_SET
value|(1<< 25)
end_define

begin_define
define|#
directive|define
name|USB_WAKEUP_DEBOUNCE_COUNT
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x7)<< 16)
end_define

begin_define
define|#
directive|define
name|USB_SUSP_SET
value|(1<< 14)
end_define

begin_define
define|#
directive|define
name|UTMIP_PHY_ENB
value|(1<< 12)
end_define

begin_define
define|#
directive|define
name|UTMIP_RESET
value|(1<< 11)
end_define

begin_define
define|#
directive|define
name|USB_SUSP_POL
value|(1<< 10)
end_define

begin_define
define|#
directive|define
name|USB_PHY_CLK_VALID_INT_ENB
value|(1<< 9)
end_define

begin_define
define|#
directive|define
name|USB_PHY_CLK_VALID_INT_STS
value|(1<< 8)
end_define

begin_define
define|#
directive|define
name|USB_PHY_CLK_VALID
value|(1<< 7)
end_define

begin_define
define|#
directive|define
name|USB_CLKEN
value|(1<< 6)
end_define

begin_define
define|#
directive|define
name|USB_SUSP_CLR
value|(1<< 5)
end_define

begin_define
define|#
directive|define
name|USB_WAKE_ON_DISCON_EN_DEV
value|(1<< 4)
end_define

begin_define
define|#
directive|define
name|USB_WAKE_ON_CNNT_EN_DEV
value|(1<< 3)
end_define

begin_define
define|#
directive|define
name|USB_WAKE_ON_RESUME_EN
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|USB_WAKEUP_INT_ENB
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|USB_WAKEUP_INT_STS
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|IF_USB_PHY_VBUS_SENSORS
value|0x404
end_define

begin_define
define|#
directive|define
name|B_SESS_END_SW_VALUE
value|(1<< 4)
end_define

begin_define
define|#
directive|define
name|B_SESS_END_SW_EN
value|(1<< 3)
end_define

begin_define
define|#
directive|define
name|UTMIP_XCVR_CFG0
value|0x808
end_define

begin_define
define|#
directive|define
name|UTMIP_XCVR_HSSLEW_MSB
parameter_list|(
name|x
parameter_list|)
value|((((x)& 0x1fc)>> 2)<< 25)
end_define

begin_define
define|#
directive|define
name|UTMIP_XCVR_SETUP_MSB
parameter_list|(
name|x
parameter_list|)
value|((((x)& 0x70)>> 4)<< 22)
end_define

begin_define
define|#
directive|define
name|UTMIP_XCVR_LSBIAS_SEL
value|(1<< 21)
end_define

begin_define
define|#
directive|define
name|UTMIP_XCVR_DISCON_METHOD
value|(1<< 20)
end_define

begin_define
define|#
directive|define
name|UTMIP_FORCE_PDZI_POWERUP
value|(1<< 19)
end_define

begin_define
define|#
directive|define
name|UTMIP_FORCE_PDZI_POWERDOWN
value|(1<< 18)
end_define

begin_define
define|#
directive|define
name|UTMIP_FORCE_PD2_POWERUP
value|(1<< 17)
end_define

begin_define
define|#
directive|define
name|UTMIP_FORCE_PD2_POWERDOWN
value|(1<< 16)
end_define

begin_define
define|#
directive|define
name|UTMIP_FORCE_PD_POWERUP
value|(1<< 15)
end_define

begin_define
define|#
directive|define
name|UTMIP_FORCE_PD_POWERDOWN
value|(1<< 14)
end_define

begin_define
define|#
directive|define
name|UTMIP_XCVR_TERMEN
value|(1<< 13)
end_define

begin_define
define|#
directive|define
name|UTMIP_XCVR_HSLOOPBACK
value|(1<< 12)
end_define

begin_define
define|#
directive|define
name|UTMIP_XCVR_LSFSLEW
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x3)<< 10)
end_define

begin_define
define|#
directive|define
name|UTMIP_XCVR_LSRSLEW
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x3)<< 8)
end_define

begin_define
define|#
directive|define
name|UTMIP_XCVR_FSSLEW
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x3)<< 6)
end_define

begin_define
define|#
directive|define
name|UTMIP_XCVR_HSSLEW
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x3)<< 4)
end_define

begin_define
define|#
directive|define
name|UTMIP_XCVR_SETUP
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0xf)<< 0)
end_define

begin_define
define|#
directive|define
name|UTMIP_BIAS_CFG0
value|0x80C
end_define

begin_define
define|#
directive|define
name|UTMIP_IDDIG_C_VAL
value|(1<< 30)
end_define

begin_define
define|#
directive|define
name|UTMIP_IDDIG_C_SEL
value|(1<< 29)
end_define

begin_define
define|#
directive|define
name|UTMIP_IDDIG_B_VAL
value|(1<< 28)
end_define

begin_define
define|#
directive|define
name|UTMIP_IDDIG_B_SEL
value|(1<< 27)
end_define

begin_define
define|#
directive|define
name|UTMIP_IDDIG_A_VAL
value|(1<< 26)
end_define

begin_define
define|#
directive|define
name|UTMIP_IDDIG_A_SEL
value|(1<< 25)
end_define

begin_define
define|#
directive|define
name|UTMIP_HSDISCON_LEVEL_MSB
parameter_list|(
name|x
parameter_list|)
value|((((x)& 0x4)>> 2)<< 24)
end_define

begin_define
define|#
directive|define
name|UTMIP_IDPD_VAL
value|(1<< 23)
end_define

begin_define
define|#
directive|define
name|UTMIP_IDPD_SEL
value|(1<< 22)
end_define

begin_define
define|#
directive|define
name|UTMIP_IDDIG_VAL
value|(1<< 21)
end_define

begin_define
define|#
directive|define
name|UTMIP_IDDIG_SEL
value|(1<< 20)
end_define

begin_define
define|#
directive|define
name|UTMIP_GPI_VAL
value|(1<< 19)
end_define

begin_define
define|#
directive|define
name|UTMIP_GPI_SEL
value|(1<< 18)
end_define

begin_define
define|#
directive|define
name|UTMIP_ACTIVE_TERM_OFFSET
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x7)<< 15)
end_define

begin_define
define|#
directive|define
name|UTMIP_ACTIVE_PULLUP_OFFSET
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x7)<< 12)
end_define

begin_define
define|#
directive|define
name|UTMIP_OTGPD
value|(1<< 11)
end_define

begin_define
define|#
directive|define
name|UTMIP_BIASPD
value|(1<< 10)
end_define

begin_define
define|#
directive|define
name|UTMIP_VBUS_LEVEL_LEVEL
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x3)<< 8)
end_define

begin_define
define|#
directive|define
name|UTMIP_SESS_LEVEL_LEVEL
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x3)<< 6)
end_define

begin_define
define|#
directive|define
name|UTMIP_HSCHIRP_LEVEL
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x3)<< 4)
end_define

begin_define
define|#
directive|define
name|UTMIP_HSDISCON_LEVEL
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x3)<< 2)
end_define

begin_define
define|#
directive|define
name|UTMIP_HSSQUELCH_LEVEL
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x3)<< 0)
end_define

begin_define
define|#
directive|define
name|UTMIP_HSRX_CFG0
value|0x810
end_define

begin_define
define|#
directive|define
name|UTMIP_KEEP_PATT_ON_ACTIVE
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x3)<< 30)
end_define

begin_define
define|#
directive|define
name|UTMIP_ALLOW_CONSEC_UPDN
value|(1<< 29)
end_define

begin_define
define|#
directive|define
name|UTMIP_REALIGN_ON_NEW_PKT
value|(1<< 28)
end_define

begin_define
define|#
directive|define
name|UTMIP_PCOUNT_UPDN_DIV
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0xf)<< 24)
end_define

begin_define
define|#
directive|define
name|UTMIP_SQUELCH_EOP_DLY
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x7)<< 21)
end_define

begin_define
define|#
directive|define
name|UTMIP_NO_STRIPPING
value|(1<< 20)
end_define

begin_define
define|#
directive|define
name|UTMIP_IDLE_WAIT
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x1f)<< 15)
end_define

begin_define
define|#
directive|define
name|UTMIP_ELASTIC_LIMIT
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x1f)<< 10)
end_define

begin_define
define|#
directive|define
name|UTMIP_ELASTIC_OVERRUN_DISABLE
value|(1<< 9)
end_define

begin_define
define|#
directive|define
name|UTMIP_ELASTIC_UNDERRUN_DISABLE
value|(1<< 8)
end_define

begin_define
define|#
directive|define
name|UTMIP_PASS_CHIRP
value|(1<< 7)
end_define

begin_define
define|#
directive|define
name|UTMIP_PASS_FEEDBACK
value|(1<< 6)
end_define

begin_define
define|#
directive|define
name|UTMIP_PCOUNT_INERTIA
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x3)<< 4)
end_define

begin_define
define|#
directive|define
name|UTMIP_PHASE_ADJUST
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x3)<< 2)
end_define

begin_define
define|#
directive|define
name|UTMIP_THREE_SYNCBITS
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|UTMIP_USE4SYNC_TRAN
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|UTMIP_HSRX_CFG1
value|0x814
end_define

begin_define
define|#
directive|define
name|UTMIP_HS_SYNC_START_DLY
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x1F)<< 1)
end_define

begin_define
define|#
directive|define
name|UTMIP_HS_ALLOW_KEEP_ALIVE
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|UTMIP_TX_CFG0
value|0x820
end_define

begin_define
define|#
directive|define
name|UTMIP_FS_PREAMBLE_J
value|(1<< 19)
end_define

begin_define
define|#
directive|define
name|UTMIP_FS_POSTAMBLE_OUTPUT_ENABLE
value|(1<< 18)
end_define

begin_define
define|#
directive|define
name|UTMIP_FS_PREAMBLE_OUTPUT_ENABLE
value|(1<< 17)
end_define

begin_define
define|#
directive|define
name|UTMIP_FSLS_ALLOW_SOP_TX_STUFF_ERR
value|(1<< 16)
end_define

begin_define
define|#
directive|define
name|UTMIP_HS_READY_WAIT_FOR_VALID
value|(1<< 15)
end_define

begin_define
define|#
directive|define
name|UTMIP_HS_TX_IPG_DLY
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x1f)<< 10)
end_define

begin_define
define|#
directive|define
name|UTMIP_HS_DISCON_EOP_ONLY
value|(1<< 9)
end_define

begin_define
define|#
directive|define
name|UTMIP_HS_DISCON_DISABLE
value|(1<< 8)
end_define

begin_define
define|#
directive|define
name|UTMIP_HS_POSTAMBLE_OUTPUT_ENABLE
value|(1<< 7)
end_define

begin_define
define|#
directive|define
name|UTMIP_HS_PREAMBLE_OUTPUT_ENABLE
value|(1<< 6)
end_define

begin_define
define|#
directive|define
name|UTMIP_SIE_RESUME_ON_LINESTATE
value|(1<< 5)
end_define

begin_define
define|#
directive|define
name|UTMIP_SOF_ON_NO_STUFF
value|(1<< 4)
end_define

begin_define
define|#
directive|define
name|UTMIP_SOF_ON_NO_ENCODE
value|(1<< 3)
end_define

begin_define
define|#
directive|define
name|UTMIP_NO_STUFFING
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|UTMIP_NO_ENCODING
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|UTMIP_NO_SYNC_NO_EOP
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|UTMIP_MISC_CFG0
value|0x824
end_define

begin_define
define|#
directive|define
name|UTMIP_DPDM_OBSERVE_SEL
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0xf)<< 27)
end_define

begin_define
define|#
directive|define
name|UTMIP_DPDM_OBSERVE
value|(1<< 26)
end_define

begin_define
define|#
directive|define
name|UTMIP_KEEP_XCVR_PD_ON_SOFT_DISCON
value|(1<< 25)
end_define

begin_define
define|#
directive|define
name|UTMIP_ALLOW_LS_ON_SOFT_DISCON
value|(1<< 24)
end_define

begin_define
define|#
directive|define
name|UTMIP_FORCE_FS_DISABLE_ON_DEV_CHIRP
value|(1<< 23)
end_define

begin_define
define|#
directive|define
name|UTMIP_SUSPEND_EXIT_ON_EDGE
value|(1<< 22)
end_define

begin_define
define|#
directive|define
name|UTMIP_LS_TO_FS_SKIP_4MS
value|(1<< 21)
end_define

begin_define
define|#
directive|define
name|UTMIP_INJECT_ERROR_TYPE
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x3)<< 19)
end_define

begin_define
define|#
directive|define
name|UTMIP_FORCE_HS_CLOCK_ON
value|(1<< 18)
end_define

begin_define
define|#
directive|define
name|UTMIP_DISABLE_HS_TERM
value|(1<< 17)
end_define

begin_define
define|#
directive|define
name|UTMIP_FORCE_HS_TERM
value|(1<< 16)
end_define

begin_define
define|#
directive|define
name|UTMIP_DISABLE_PULLUP_DP
value|(1<< 15)
end_define

begin_define
define|#
directive|define
name|UTMIP_DISABLE_PULLUP_DM
value|(1<< 14)
end_define

begin_define
define|#
directive|define
name|UTMIP_DISABLE_PULLDN_DP
value|(1<< 13)
end_define

begin_define
define|#
directive|define
name|UTMIP_DISABLE_PULLDN_DM
value|(1<< 12)
end_define

begin_define
define|#
directive|define
name|UTMIP_FORCE_PULLUP_DP
value|(1<< 11)
end_define

begin_define
define|#
directive|define
name|UTMIP_FORCE_PULLUP_DM
value|(1<< 10)
end_define

begin_define
define|#
directive|define
name|UTMIP_FORCE_PULLDN_DP
value|(1<< 9)
end_define

begin_define
define|#
directive|define
name|UTMIP_FORCE_PULLDN_DM
value|(1<< 8)
end_define

begin_define
define|#
directive|define
name|UTMIP_STABLE_COUNT
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x7)<< 5)
end_define

begin_define
define|#
directive|define
name|UTMIP_STABLE_ALL
value|(1<< 4)
end_define

begin_define
define|#
directive|define
name|UTMIP_NO_FREE_ON_SUSPEND
value|(1<< 3)
end_define

begin_define
define|#
directive|define
name|UTMIP_NEVER_FREE_RUNNING_TERMS
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|UTMIP_ALWAYS_FREE_RUNNING_TERMS
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|UTMIP_COMB_TERMS
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|UTMIP_MISC_CFG1
value|0x828
end_define

begin_define
define|#
directive|define
name|UTMIP_PHY_XTAL_CLOCKEN
value|(1<< 30)
end_define

begin_define
define|#
directive|define
name|UTMIP_DEBOUNCE_CFG0
value|0x82C
end_define

begin_define
define|#
directive|define
name|UTMIP_BIAS_DEBOUNCE_B
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0xffff)<< 16)
end_define

begin_define
define|#
directive|define
name|UTMIP_BIAS_DEBOUNCE_A
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0xffff)<< 0)
end_define

begin_define
define|#
directive|define
name|UTMIP_BAT_CHRG_CFG0
value|0x830
end_define

begin_define
define|#
directive|define
name|UTMIP_CHRG_DEBOUNCE_TIMESCALE
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x1f)<< 8)
end_define

begin_define
define|#
directive|define
name|UTMIP_OP_I_SRC_ENG
value|(1<< 5)
end_define

begin_define
define|#
directive|define
name|UTMIP_ON_SRC_ENG
value|(1<< 4)
end_define

begin_define
define|#
directive|define
name|UTMIP_OP_SRC_ENG
value|(1<< 3)
end_define

begin_define
define|#
directive|define
name|UTMIP_ON_SINK_ENG
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|UTMIP_OP_SINK_ENG
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|UTMIP_PD_CHRG
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|UTMIP_SPARE_CFG0
value|0x834
end_define

begin_define
define|#
directive|define
name|FUSE_HS_IREF_CAP_CFG
value|(1<< 7)
end_define

begin_define
define|#
directive|define
name|FUSE_HS_SQUELCH_LEVEL
value|(1<< 6)
end_define

begin_define
define|#
directive|define
name|FUSE_SPARE
value|(1<< 5)
end_define

begin_define
define|#
directive|define
name|FUSE_TERM_RANGE_ADJ_SEL
value|(1<< 4)
end_define

begin_define
define|#
directive|define
name|FUSE_SETUP_SEL
value|(1<< 3)
end_define

begin_define
define|#
directive|define
name|HS_RX_LATE_SQUELCH
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|HS_RX_FLUSH_ALAP
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|HS_RX_IPG_ERROR_ENABLE
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|UTMIP_XCVR_CFG1
value|0x838
end_define

begin_define
define|#
directive|define
name|UTMIP_XCVR_RPU_RANGE_ADJ
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x3)<< 26)
end_define

begin_define
define|#
directive|define
name|UTMIP_XCVR_HS_IREF_CAP
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x3)<< 24)
end_define

begin_define
define|#
directive|define
name|UTMIP_XCVR_SPARE
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x3)<< 22)
end_define

begin_define
define|#
directive|define
name|UTMIP_XCVR_TERM_RANGE_ADJ
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0xf)<< 18)
end_define

begin_define
define|#
directive|define
name|UTMIP_RCTRL_SW_SET
value|(1<< 17)
end_define

begin_define
define|#
directive|define
name|UTMIP_RCTRL_SW_VAL
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x1f)<< 12)
end_define

begin_define
define|#
directive|define
name|UTMIP_TCTRL_SW_SET
value|(1<< 11)
end_define

begin_define
define|#
directive|define
name|UTMIP_TCTRL_SW_VAL
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x1f)<< 6)
end_define

begin_define
define|#
directive|define
name|UTMIP_FORCE_PDDR_POWERUP
value|(1<< 5)
end_define

begin_define
define|#
directive|define
name|UTMIP_FORCE_PDDR_POWERDOWN
value|(1<< 4)
end_define

begin_define
define|#
directive|define
name|UTMIP_FORCE_PDCHRP_POWERUP
value|(1<< 3)
end_define

begin_define
define|#
directive|define
name|UTMIP_FORCE_PDCHRP_POWERDOWN
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|UTMIP_FORCE_PDDISC_POWERUP
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|UTMIP_FORCE_PDDISC_POWERDOWN
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|UTMIP_BIAS_CFG1
value|0x83c
end_define

begin_define
define|#
directive|define
name|UTMIP_BIAS_DEBOUNCE_TIMESCALE
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x3f)<< 8)
end_define

begin_define
define|#
directive|define
name|UTMIP_BIAS_PDTRK_COUNT
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x1f)<< 3)
end_define

begin_define
define|#
directive|define
name|UTMIP_VBUS_WAKEUP_POWERDOWN
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|UTMIP_FORCE_PDTRK_POWERUP
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|UTMIP_FORCE_PDTRK_POWERDOWN
value|(1<< 0)
end_define

begin_decl_stmt
specifier|static
name|int
name|usbpby_enable_cnt
decl_stmt|;
end_decl_stmt

begin_enum
enum|enum
name|usb_ifc_type
block|{
name|USB_IFC_TYPE_UNKNOWN
init|=
literal|0
block|,
name|USB_IFC_TYPE_UTMI
block|,
name|USB_IFC_TYPE_ULPI
block|}
enum|;
end_enum

begin_enum
enum|enum
name|usb_dr_mode
block|{
name|USB_DR_MODE_UNKNOWN
init|=
literal|0
block|,
name|USB_DR_MODE_DEVICE
block|,
name|USB_DR_MODE_HOST
block|,
name|USB_DR_MODE_OTG
block|}
enum|;
end_enum

begin_struct
struct|struct
name|usbphy_softc
block|{
name|device_t
name|dev
decl_stmt|;
name|struct
name|resource
modifier|*
name|mem_res
decl_stmt|;
name|struct
name|resource
modifier|*
name|pads_res
decl_stmt|;
name|clk_t
name|clk_reg
decl_stmt|;
name|clk_t
name|clk_pads
decl_stmt|;
name|clk_t
name|clk_pllu
decl_stmt|;
name|regulator_t
name|supply_vbus
decl_stmt|;
name|hwreset_t
name|reset_usb
decl_stmt|;
name|hwreset_t
name|reset_pads
decl_stmt|;
name|enum
name|usb_ifc_type
name|ifc_type
decl_stmt|;
name|enum
name|usb_dr_mode
name|dr_mode
decl_stmt|;
name|bool
name|have_utmi_regs
decl_stmt|;
comment|/* UTMI params */
name|int
name|hssync_start_delay
decl_stmt|;
name|int
name|elastic_limit
decl_stmt|;
name|int
name|idle_wait_delay
decl_stmt|;
name|int
name|term_range_adj
decl_stmt|;
name|int
name|xcvr_lsfslew
decl_stmt|;
name|int
name|xcvr_lsrslew
decl_stmt|;
name|int
name|xcvr_hsslew
decl_stmt|;
name|int
name|hssquelch_level
decl_stmt|;
name|int
name|hsdiscon_level
decl_stmt|;
name|int
name|xcvr_setup
decl_stmt|;
name|int
name|xcvr_setup_use_fuses
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|ofw_compat_data
name|compat_data
index|[]
init|=
block|{
block|{
literal|"nvidia,tegra30-usb-phy"
block|,
literal|1
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|RD4
parameter_list|(
name|sc
parameter_list|,
name|offs
parameter_list|)
define|\
value|bus_read_4(sc->mem_res, offs)
end_define

begin_define
define|#
directive|define
name|WR4
parameter_list|(
name|sc
parameter_list|,
name|offs
parameter_list|,
name|val
parameter_list|)
define|\
value|bus_write_4(sc->mem_res, offs, val)
end_define

begin_function
specifier|static
name|int
name|reg_wait
parameter_list|(
name|struct
name|usbphy_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint32_t
name|mask
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|1000
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|RD4
argument_list|(
name|sc
argument_list|,
name|reg
argument_list|)
operator|&
name|mask
operator|)
operator|==
name|val
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|usbphy_utmi_phy_clk
parameter_list|(
name|struct
name|usbphy_softc
modifier|*
name|sc
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|CTRL_USB_HOSTPC1_DEVLC
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
condition|)
name|val
operator|&=
operator|~
name|USB_HOSTPC1_DEVLC_PHCD
expr_stmt|;
else|else
name|val
operator||=
name|USB_HOSTPC1_DEVLC_PHCD
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|CTRL_USB_HOSTPC1_DEVLC
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|rv
operator|=
name|reg_wait
argument_list|(
name|sc
argument_list|,
name|IF_USB_SUSP_CTRL
argument_list|,
name|USB_PHY_CLK_VALID
argument_list|,
name|enable
condition|?
name|USB_PHY_CLK_VALID
else|:
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"USB phy clock timeout.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|usbphy_utmi_enable
parameter_list|(
name|struct
name|usbphy_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|rv
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
comment|/* Reset phy */
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|IF_USB_SUSP_CTRL
argument_list|)
expr_stmt|;
name|val
operator||=
name|UTMIP_RESET
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|IF_USB_SUSP_CTRL
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|UTMIP_TX_CFG0
argument_list|)
expr_stmt|;
name|val
operator||=
name|UTMIP_FS_PREAMBLE_J
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|UTMIP_TX_CFG0
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|UTMIP_HSRX_CFG0
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|UTMIP_IDLE_WAIT
argument_list|(
operator|~
literal|0
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|UTMIP_ELASTIC_LIMIT
argument_list|(
operator|~
literal|0
argument_list|)
expr_stmt|;
name|val
operator||=
name|UTMIP_IDLE_WAIT
argument_list|(
name|sc
operator|->
name|idle_wait_delay
argument_list|)
expr_stmt|;
name|val
operator||=
name|UTMIP_ELASTIC_LIMIT
argument_list|(
name|sc
operator|->
name|elastic_limit
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|UTMIP_HSRX_CFG0
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|UTMIP_HSRX_CFG1
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|UTMIP_HS_SYNC_START_DLY
argument_list|(
operator|~
literal|0
argument_list|)
expr_stmt|;
name|val
operator||=
name|UTMIP_HS_SYNC_START_DLY
argument_list|(
name|sc
operator|->
name|hssync_start_delay
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|UTMIP_HSRX_CFG1
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|UTMIP_DEBOUNCE_CFG0
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|UTMIP_BIAS_DEBOUNCE_A
argument_list|(
operator|~
literal|0
argument_list|)
expr_stmt|;
name|val
operator||=
name|UTMIP_BIAS_DEBOUNCE_A
argument_list|(
literal|0x7530
argument_list|)
expr_stmt|;
comment|/* For 12MHz */
name|WR4
argument_list|(
name|sc
argument_list|,
name|UTMIP_DEBOUNCE_CFG0
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|UTMIP_MISC_CFG0
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|UTMIP_SUSPEND_EXIT_ON_EDGE
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|UTMIP_MISC_CFG0
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|dr_mode
operator|==
name|USB_DR_MODE_DEVICE
condition|)
block|{
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|IF_USB_SUSP_CTRL
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|USB_WAKE_ON_CNNT_EN_DEV
expr_stmt|;
name|val
operator|&=
operator|~
name|USB_WAKE_ON_DISCON_EN_DEV
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|IF_USB_SUSP_CTRL
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|UTMIP_BAT_CHRG_CFG0
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|UTMIP_PD_CHRG
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|UTMIP_BAT_CHRG_CFG0
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|UTMIP_BAT_CHRG_CFG0
argument_list|)
expr_stmt|;
name|val
operator||=
name|UTMIP_PD_CHRG
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|UTMIP_BAT_CHRG_CFG0
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
name|usbpby_enable_cnt
operator|++
expr_stmt|;
if|if
condition|(
name|usbpby_enable_cnt
operator|==
literal|1
condition|)
block|{
name|rv
operator|=
name|hwreset_deassert
argument_list|(
name|sc
operator|->
name|reset_pads
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot unreset 'utmi-pads' reset\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
name|rv
operator|=
name|clk_enable
argument_list|(
name|sc
operator|->
name|clk_pads
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot enable 'utmi-pads' clock\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
name|val
operator|=
name|bus_read_4
argument_list|(
name|sc
operator|->
name|pads_res
argument_list|,
name|UTMIP_BIAS_CFG0
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|UTMIP_OTGPD
expr_stmt|;
name|val
operator|&=
operator|~
name|UTMIP_BIASPD
expr_stmt|;
name|val
operator|&=
operator|~
name|UTMIP_HSSQUELCH_LEVEL
argument_list|(
operator|~
literal|0
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|UTMIP_HSDISCON_LEVEL
argument_list|(
operator|~
literal|0
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|UTMIP_HSDISCON_LEVEL_MSB
argument_list|(
operator|~
literal|0
argument_list|)
expr_stmt|;
name|val
operator||=
name|UTMIP_HSSQUELCH_LEVEL
argument_list|(
name|sc
operator|->
name|hssquelch_level
argument_list|)
expr_stmt|;
name|val
operator||=
name|UTMIP_HSDISCON_LEVEL
argument_list|(
name|sc
operator|->
name|hsdiscon_level
argument_list|)
expr_stmt|;
name|val
operator||=
name|UTMIP_HSDISCON_LEVEL_MSB
argument_list|(
name|sc
operator|->
name|hsdiscon_level
argument_list|)
expr_stmt|;
name|bus_write_4
argument_list|(
name|sc
operator|->
name|pads_res
argument_list|,
name|UTMIP_BIAS_CFG0
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|rv
operator|=
name|clk_disable
argument_list|(
name|sc
operator|->
name|clk_pads
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot disable 'utmi-pads' clock\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
block|}
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|UTMIP_XCVR_CFG0
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|UTMIP_FORCE_PD_POWERDOWN
expr_stmt|;
name|val
operator|&=
operator|~
name|UTMIP_FORCE_PD2_POWERDOWN
expr_stmt|;
name|val
operator|&=
operator|~
name|UTMIP_FORCE_PDZI_POWERDOWN
expr_stmt|;
name|val
operator|&=
operator|~
name|UTMIP_XCVR_LSBIAS_SEL
expr_stmt|;
name|val
operator|&=
operator|~
name|UTMIP_XCVR_LSFSLEW
argument_list|(
operator|~
literal|0
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|UTMIP_XCVR_LSRSLEW
argument_list|(
operator|~
literal|0
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|UTMIP_XCVR_HSSLEW
argument_list|(
operator|~
literal|0
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|UTMIP_XCVR_HSSLEW_MSB
argument_list|(
operator|~
literal|0
argument_list|)
expr_stmt|;
name|val
operator||=
name|UTMIP_XCVR_LSFSLEW
argument_list|(
name|sc
operator|->
name|xcvr_lsfslew
argument_list|)
expr_stmt|;
name|val
operator||=
name|UTMIP_XCVR_LSRSLEW
argument_list|(
name|sc
operator|->
name|xcvr_lsrslew
argument_list|)
expr_stmt|;
name|val
operator||=
name|UTMIP_XCVR_HSSLEW
argument_list|(
name|sc
operator|->
name|xcvr_hsslew
argument_list|)
expr_stmt|;
name|val
operator||=
name|UTMIP_XCVR_HSSLEW_MSB
argument_list|(
name|sc
operator|->
name|xcvr_hsslew
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|xcvr_setup_use_fuses
condition|)
block|{
name|val
operator|&=
operator|~
name|UTMIP_XCVR_SETUP
argument_list|(
operator|~
literal|0
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|UTMIP_XCVR_SETUP_MSB
argument_list|(
operator|~
literal|0
argument_list|)
expr_stmt|;
name|val
operator||=
name|UTMIP_XCVR_SETUP
argument_list|(
name|sc
operator|->
name|xcvr_setup
argument_list|)
expr_stmt|;
name|val
operator||=
name|UTMIP_XCVR_SETUP_MSB
argument_list|(
name|sc
operator|->
name|xcvr_setup
argument_list|)
expr_stmt|;
block|}
name|WR4
argument_list|(
name|sc
argument_list|,
name|UTMIP_XCVR_CFG0
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|UTMIP_XCVR_CFG1
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|UTMIP_FORCE_PDDISC_POWERDOWN
expr_stmt|;
name|val
operator|&=
operator|~
name|UTMIP_FORCE_PDCHRP_POWERDOWN
expr_stmt|;
name|val
operator|&=
operator|~
name|UTMIP_FORCE_PDDR_POWERDOWN
expr_stmt|;
name|val
operator|&=
operator|~
name|UTMIP_XCVR_TERM_RANGE_ADJ
argument_list|(
operator|~
literal|0
argument_list|)
expr_stmt|;
name|val
operator||=
name|UTMIP_XCVR_TERM_RANGE_ADJ
argument_list|(
name|sc
operator|->
name|term_range_adj
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|UTMIP_XCVR_CFG1
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|UTMIP_BIAS_CFG1
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|UTMIP_BIAS_PDTRK_COUNT
argument_list|(
operator|~
literal|0
argument_list|)
expr_stmt|;
name|val
operator||=
name|UTMIP_BIAS_PDTRK_COUNT
argument_list|(
literal|0x5
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|UTMIP_BIAS_CFG1
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|UTMIP_SPARE_CFG0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|xcvr_setup_use_fuses
condition|)
name|val
operator||=
name|FUSE_SETUP_SEL
expr_stmt|;
else|else
name|val
operator|&=
operator|~
name|FUSE_SETUP_SEL
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|UTMIP_SPARE_CFG0
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|IF_USB_SUSP_CTRL
argument_list|)
expr_stmt|;
name|val
operator||=
name|UTMIP_PHY_ENB
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|IF_USB_SUSP_CTRL
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|IF_USB_SUSP_CTRL
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|UTMIP_RESET
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|IF_USB_SUSP_CTRL
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|usbphy_utmi_phy_clk
argument_list|(
name|sc
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|CTRL_USB_USBMODE
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|USB_USBMODE_MASK
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|dr_mode
operator|==
name|USB_DR_MODE_HOST
condition|)
name|val
operator||=
name|USB_USBMODE_HOST
expr_stmt|;
else|else
name|val
operator||=
name|USB_USBMODE_DEVICE
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|CTRL_USB_USBMODE
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|CTRL_USB_HOSTPC1_DEVLC
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|USB_HOSTPC1_DEVLC_PTS
argument_list|(
operator|~
literal|0
argument_list|)
expr_stmt|;
name|val
operator||=
name|USB_HOSTPC1_DEVLC_PTS
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|CTRL_USB_HOSTPC1_DEVLC
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|usbphy_utmi_disable
parameter_list|(
name|struct
name|usbphy_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|rv
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|usbphy_utmi_phy_clk
argument_list|(
name|sc
argument_list|,
name|false
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|dr_mode
operator|==
name|USB_DR_MODE_DEVICE
condition|)
block|{
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|IF_USB_SUSP_CTRL
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|USB_WAKEUP_DEBOUNCE_COUNT
argument_list|(
operator|~
literal|0
argument_list|)
expr_stmt|;
name|val
operator||=
name|USB_WAKE_ON_CNNT_EN_DEV
expr_stmt|;
name|val
operator||=
name|USB_WAKEUP_DEBOUNCE_COUNT
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|IF_USB_SUSP_CTRL
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|IF_USB_SUSP_CTRL
argument_list|)
expr_stmt|;
name|val
operator||=
name|UTMIP_RESET
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|IF_USB_SUSP_CTRL
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|UTMIP_BAT_CHRG_CFG0
argument_list|)
expr_stmt|;
name|val
operator||=
name|UTMIP_PD_CHRG
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|UTMIP_BAT_CHRG_CFG0
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|UTMIP_XCVR_CFG0
argument_list|)
expr_stmt|;
name|val
operator||=
name|UTMIP_FORCE_PD_POWERDOWN
expr_stmt|;
name|val
operator||=
name|UTMIP_FORCE_PD2_POWERDOWN
expr_stmt|;
name|val
operator||=
name|UTMIP_FORCE_PDZI_POWERDOWN
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|UTMIP_XCVR_CFG0
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|RD4
argument_list|(
name|sc
argument_list|,
name|UTMIP_XCVR_CFG1
argument_list|)
expr_stmt|;
name|val
operator||=
name|UTMIP_FORCE_PDDISC_POWERDOWN
expr_stmt|;
name|val
operator||=
name|UTMIP_FORCE_PDCHRP_POWERDOWN
expr_stmt|;
name|val
operator||=
name|UTMIP_FORCE_PDDR_POWERDOWN
expr_stmt|;
name|WR4
argument_list|(
name|sc
argument_list|,
name|UTMIP_XCVR_CFG1
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|usbpby_enable_cnt
operator|--
expr_stmt|;
if|if
condition|(
name|usbpby_enable_cnt
operator|<=
literal|0
condition|)
block|{
name|rv
operator|=
name|clk_enable
argument_list|(
name|sc
operator|->
name|clk_pads
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot enable 'utmi-pads' clock\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
name|val
operator|=
name|bus_read_4
argument_list|(
name|sc
operator|->
name|pads_res
argument_list|,
name|UTMIP_BIAS_CFG0
argument_list|)
expr_stmt|;
name|val
operator||=
name|UTMIP_OTGPD
expr_stmt|;
name|val
operator||=
name|UTMIP_BIASPD
expr_stmt|;
name|bus_write_4
argument_list|(
name|sc
operator|->
name|pads_res
argument_list|,
name|UTMIP_BIAS_CFG0
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|rv
operator|=
name|clk_disable
argument_list|(
name|sc
operator|->
name|clk_pads
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot disable 'utmi-pads' clock\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|usbphy_phy_enable
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|id
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|struct
name|usbphy_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|rv
init|=
literal|0
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|ifc_type
operator|!=
name|USB_IFC_TYPE_UTMI
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Only UTMI interface is supported.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
name|enable
condition|)
name|rv
operator|=
name|usbphy_utmi_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
else|else
name|rv
operator|=
name|usbphy_utmi_disable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|usb_ifc_type
name|usb_get_ifc_mode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|phandle_t
name|node
parameter_list|,
name|char
modifier|*
name|name
parameter_list|)
block|{
name|char
modifier|*
name|tmpstr
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|enum
name|usb_ifc_type
name|ret
decl_stmt|;
name|rv
operator|=
name|OF_getprop_alloc
argument_list|(
name|node
argument_list|,
name|name
argument_list|,
literal|1
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|tmpstr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<=
literal|0
condition|)
return|return
operator|(
name|USB_IFC_TYPE_UNKNOWN
operator|)
return|;
name|ret
operator|=
name|USB_IFC_TYPE_UNKNOWN
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|tmpstr
argument_list|,
literal|"utmi"
argument_list|)
operator|==
literal|0
condition|)
name|ret
operator|=
name|USB_IFC_TYPE_UTMI
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|tmpstr
argument_list|,
literal|"ulpi"
argument_list|)
operator|==
literal|0
condition|)
name|ret
operator|=
name|USB_IFC_TYPE_ULPI
expr_stmt|;
else|else
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Unsupported phy type: %s\n"
argument_list|,
name|tmpstr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tmpstr
argument_list|,
name|M_OFWPROP
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|usb_dr_mode
name|usb_get_dr_mode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|phandle_t
name|node
parameter_list|,
name|char
modifier|*
name|name
parameter_list|)
block|{
name|char
modifier|*
name|tmpstr
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|enum
name|usb_dr_mode
name|ret
decl_stmt|;
name|rv
operator|=
name|OF_getprop_alloc
argument_list|(
name|node
argument_list|,
name|name
argument_list|,
literal|1
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|tmpstr
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<=
literal|0
condition|)
return|return
operator|(
name|USB_DR_MODE_UNKNOWN
operator|)
return|;
name|ret
operator|=
name|USB_DR_MODE_UNKNOWN
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|tmpstr
argument_list|,
literal|"device"
argument_list|)
operator|==
literal|0
condition|)
name|ret
operator|=
name|USB_DR_MODE_DEVICE
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|tmpstr
argument_list|,
literal|"host"
argument_list|)
operator|==
literal|0
condition|)
name|ret
operator|=
name|USB_DR_MODE_HOST
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|tmpstr
argument_list|,
literal|"otg"
argument_list|)
operator|==
literal|0
condition|)
name|ret
operator|=
name|USB_DR_MODE_OTG
expr_stmt|;
else|else
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Unknown dr mode: %s\n"
argument_list|,
name|tmpstr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tmpstr
argument_list|,
name|M_OFWPROP
argument_list|)
expr_stmt|;
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|usbphy_utmi_read_params
parameter_list|(
name|struct
name|usbphy_softc
modifier|*
name|sc
parameter_list|,
name|phandle_t
name|node
parameter_list|)
block|{
name|int
name|rv
decl_stmt|;
name|rv
operator|=
name|OF_getencprop
argument_list|(
name|node
argument_list|,
literal|"nvidia,hssync-start-delay"
argument_list|,
operator|&
name|sc
operator|->
name|hssync_start_delay
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|hssync_start_delay
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<=
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|rv
operator|=
name|OF_getencprop
argument_list|(
name|node
argument_list|,
literal|"nvidia,elastic-limit"
argument_list|,
operator|&
name|sc
operator|->
name|elastic_limit
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|elastic_limit
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<=
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|rv
operator|=
name|OF_getencprop
argument_list|(
name|node
argument_list|,
literal|"nvidia,idle-wait-delay"
argument_list|,
operator|&
name|sc
operator|->
name|idle_wait_delay
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|idle_wait_delay
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<=
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|rv
operator|=
name|OF_getencprop
argument_list|(
name|node
argument_list|,
literal|"nvidia,term-range-adj"
argument_list|,
operator|&
name|sc
operator|->
name|term_range_adj
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|term_range_adj
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<=
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|rv
operator|=
name|OF_getencprop
argument_list|(
name|node
argument_list|,
literal|"nvidia,xcvr-lsfslew"
argument_list|,
operator|&
name|sc
operator|->
name|xcvr_lsfslew
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|xcvr_lsfslew
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<=
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|rv
operator|=
name|OF_getencprop
argument_list|(
name|node
argument_list|,
literal|"nvidia,xcvr-lsrslew"
argument_list|,
operator|&
name|sc
operator|->
name|xcvr_lsrslew
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|xcvr_lsrslew
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<=
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|rv
operator|=
name|OF_getencprop
argument_list|(
name|node
argument_list|,
literal|"nvidia,xcvr-hsslew"
argument_list|,
operator|&
name|sc
operator|->
name|xcvr_hsslew
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|xcvr_hsslew
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<=
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|rv
operator|=
name|OF_getencprop
argument_list|(
name|node
argument_list|,
literal|"nvidia,hssquelch-level"
argument_list|,
operator|&
name|sc
operator|->
name|hssquelch_level
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|hssquelch_level
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<=
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|rv
operator|=
name|OF_getencprop
argument_list|(
name|node
argument_list|,
literal|"nvidia,hsdiscon-level"
argument_list|,
operator|&
name|sc
operator|->
name|hsdiscon_level
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|hsdiscon_level
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<=
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|rv
operator|=
name|OF_getproplen
argument_list|(
name|node
argument_list|,
literal|"nvidia,xcvr-setup-use-fuses"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|>=
literal|1
condition|)
block|{
name|sc
operator|->
name|xcvr_setup_use_fuses
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|rv
operator|=
name|OF_getencprop
argument_list|(
name|node
argument_list|,
literal|"nvidia,xcvr-setup"
argument_list|,
operator|&
name|sc
operator|->
name|xcvr_setup
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|xcvr_setup
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<=
literal|0
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|usbphy_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
operator|!
name|ofw_bus_status_okay
argument_list|(
name|dev
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
operator|!
name|ofw_bus_search_compatible
argument_list|(
name|dev
argument_list|,
name|compat_data
argument_list|)
operator|->
name|ocd_data
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Tegra USB phy"
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|usbphy_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|usbphy_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|rid
decl_stmt|,
name|rv
decl_stmt|;
name|phandle_t
name|node
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|mem_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mem_res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Cannot allocate memory resources\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rid
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|pads_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
operator||
name|RF_SHAREABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mem_res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Cannot allocate memory resources\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|node
operator|=
name|ofw_bus_get_node
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|rv
operator|=
name|hwreset_get_by_ofw_name
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"usb"
argument_list|,
operator|&
name|sc
operator|->
name|reset_usb
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Cannot get 'usb' reset\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rv
operator|=
name|hwreset_get_by_ofw_name
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"utmi-pads"
argument_list|,
operator|&
name|sc
operator|->
name|reset_pads
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Cannot get 'utmi-pads' reset\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rv
operator|=
name|clk_get_by_ofw_name
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"reg"
argument_list|,
operator|&
name|sc
operator|->
name|clk_reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot get 'reg' clock\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rv
operator|=
name|clk_get_by_ofw_name
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"pll_u"
argument_list|,
operator|&
name|sc
operator|->
name|clk_pllu
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot get 'pll_u' clock\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rv
operator|=
name|clk_get_by_ofw_name
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"utmi-pads"
argument_list|,
operator|&
name|sc
operator|->
name|clk_pads
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot get 'utmi-pads' clock\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rv
operator|=
name|hwreset_deassert
argument_list|(
name|sc
operator|->
name|reset_usb
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Cannot unreset 'usb' reset\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rv
operator|=
name|clk_enable
argument_list|(
name|sc
operator|->
name|clk_pllu
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot enable 'pllu' clock\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rv
operator|=
name|clk_enable
argument_list|(
name|sc
operator|->
name|clk_reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot enable 'reg' clock\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
if|if
condition|(
name|OF_hasprop
argument_list|(
name|node
argument_list|,
literal|"nvidia,has-utmi-pad-registers"
argument_list|)
condition|)
name|sc
operator|->
name|have_utmi_regs
operator|=
name|true
expr_stmt|;
name|sc
operator|->
name|dr_mode
operator|=
name|usb_get_dr_mode
argument_list|(
name|dev
argument_list|,
name|node
argument_list|,
literal|"dr_mode"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|dr_mode
operator|==
name|USB_DR_MODE_UNKNOWN
condition|)
name|sc
operator|->
name|dr_mode
operator|=
name|USB_DR_MODE_HOST
expr_stmt|;
name|sc
operator|->
name|ifc_type
operator|=
name|usb_get_ifc_mode
argument_list|(
name|dev
argument_list|,
name|node
argument_list|,
literal|"phy_type"
argument_list|)
expr_stmt|;
comment|/* We supports only utmi phy mode for now .... */
if|if
condition|(
name|sc
operator|->
name|ifc_type
operator|!=
name|USB_IFC_TYPE_UTMI
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Unsupported phy type\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rv
operator|=
name|usbphy_utmi_read_params
argument_list|(
name|sc
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<
literal|0
condition|)
return|return
name|rv
return|;
if|if
condition|(
name|OF_hasprop
argument_list|(
name|node
argument_list|,
literal|"vbus-supply"
argument_list|)
condition|)
block|{
name|rv
operator|=
name|regulator_get_by_ofw_property
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"vbus-supply"
argument_list|,
operator|&
name|sc
operator|->
name|supply_vbus
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot get \"vbus\" regulator\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|rv
operator|=
name|regulator_enable
argument_list|(
name|sc
operator|->
name|supply_vbus
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot enable  \"vbus\" regulator\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
block|}
name|phy_register_provider
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|usbphy_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
comment|/* This device is always present. */
return|return
operator|(
name|EBUSY
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|tegra_usbphy_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|usbphy_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|usbphy_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|usbphy_detach
argument_list|)
block|,
comment|/* phy interface */
name|DEVMETHOD
argument_list|(
name|phy_enable
argument_list|,
name|usbphy_phy_enable
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|tegra_usbphy_driver
init|=
block|{
literal|"tegra_usbphy"
block|,
name|tegra_usbphy_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|usbphy_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|tegra_usbphy_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|EARLY_DRIVER_MODULE
argument_list|(
name|tegra_usbphy
argument_list|,
name|simplebus
argument_list|,
name|tegra_usbphy_driver
argument_list|,
name|tegra_usbphy_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|79
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


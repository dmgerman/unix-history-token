begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright 2016 Michal Meloun<mmel@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/gpio.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/sx.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/extres/regulator/regulator.h>
end_include

begin_include
include|#
directive|include
file|<dev/gpio/gpiobusvar.h>
end_include

begin_include
include|#
directive|include
file|<gnu/dts/include/dt-bindings/mfd/as3722.h>
end_include

begin_include
include|#
directive|include
file|"as3722.h"
end_include

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_AS3722_REG
argument_list|,
literal|"AS3722 regulator"
argument_list|,
literal|"AS3722 power regulator"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|DIV_ROUND_UP
parameter_list|(
name|n
parameter_list|,
name|d
parameter_list|)
value|howmany(n, d)
end_define

begin_enum
enum|enum
name|as3722_reg_id
block|{
name|AS3722_REG_ID_SD0
block|,
name|AS3722_REG_ID_SD1
block|,
name|AS3722_REG_ID_SD2
block|,
name|AS3722_REG_ID_SD3
block|,
name|AS3722_REG_ID_SD4
block|,
name|AS3722_REG_ID_SD5
block|,
name|AS3722_REG_ID_SD6
block|,
name|AS3722_REG_ID_LDO0
block|,
name|AS3722_REG_ID_LDO1
block|,
name|AS3722_REG_ID_LDO2
block|,
name|AS3722_REG_ID_LDO3
block|,
name|AS3722_REG_ID_LDO4
block|,
name|AS3722_REG_ID_LDO5
block|,
name|AS3722_REG_ID_LDO6
block|,
name|AS3722_REG_ID_LDO7
block|,
name|AS3722_REG_ID_LDO9
block|,
name|AS3722_REG_ID_LDO10
block|,
name|AS3722_REG_ID_LDO11
block|, }
enum|;
end_enum

begin_struct
struct|struct
name|regulator_range
block|{
name|u_int
name|min_uvolt
decl_stmt|;
name|u_int
name|step_uvolt
decl_stmt|;
name|u_int
name|min_sel
decl_stmt|;
name|u_int
name|max_sel
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Regulator HW definition. */
end_comment

begin_struct
struct|struct
name|reg_def
block|{
name|intptr_t
name|id
decl_stmt|;
comment|/* ID */
name|char
modifier|*
name|name
decl_stmt|;
comment|/* Regulator name */
name|char
modifier|*
name|supply_name
decl_stmt|;
comment|/* Source property name */
name|uint8_t
name|volt_reg
decl_stmt|;
name|uint8_t
name|volt_vsel_mask
decl_stmt|;
name|uint8_t
name|enable_reg
decl_stmt|;
name|uint8_t
name|enable_mask
decl_stmt|;
name|uint8_t
name|ext_enable_reg
decl_stmt|;
name|uint8_t
name|ext_enable_mask
decl_stmt|;
name|struct
name|regulator_range
modifier|*
name|ranges
decl_stmt|;
name|int
name|nranges
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|as3722_reg_sc
block|{
name|struct
name|regnode
modifier|*
name|regnode
decl_stmt|;
name|struct
name|as3722_softc
modifier|*
name|base_sc
decl_stmt|;
name|struct
name|reg_def
modifier|*
name|def
decl_stmt|;
name|phandle_t
name|xref
decl_stmt|;
name|struct
name|regnode_std_param
modifier|*
name|param
decl_stmt|;
name|int
name|ext_control
decl_stmt|;
name|int
name|enable_tracking
decl_stmt|;
name|int
name|enable_usec
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|RANGE_INIT
parameter_list|(
name|_min_sel
parameter_list|,
name|_max_sel
parameter_list|,
name|_min_uvolt
parameter_list|,
name|_step_uvolt
parameter_list|)
define|\
value|{									\ 	.min_sel	= _min_sel,					\ 	.max_sel	= _max_sel,					\ 	.min_uvolt	= _min_uvolt,					\ 	.step_uvolt	= _step_uvolt,					\ }
end_define

begin_decl_stmt
specifier|static
name|struct
name|regulator_range
name|as3722_sd016_ranges
index|[]
init|=
block|{
name|RANGE_INIT
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
block|,
name|RANGE_INIT
argument_list|(
literal|0x01
argument_list|,
literal|0x5A
argument_list|,
literal|610000
argument_list|,
literal|10000
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|regulator_range
name|as3722_sd0_lv_ranges
index|[]
init|=
block|{
name|RANGE_INIT
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
block|,
name|RANGE_INIT
argument_list|(
literal|0x01
argument_list|,
literal|0x6E
argument_list|,
literal|410000
argument_list|,
literal|10000
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|regulator_range
name|as3722_sd_ranges
index|[]
init|=
block|{
name|RANGE_INIT
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
block|,
name|RANGE_INIT
argument_list|(
literal|0x01
argument_list|,
literal|0x40
argument_list|,
literal|612500
argument_list|,
literal|12500
argument_list|)
block|,
name|RANGE_INIT
argument_list|(
literal|0x41
argument_list|,
literal|0x70
argument_list|,
literal|1425000
argument_list|,
literal|25000
argument_list|)
block|,
name|RANGE_INIT
argument_list|(
literal|0x71
argument_list|,
literal|0x7F
argument_list|,
literal|2650000
argument_list|,
literal|50000
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|regulator_range
name|as3722_ldo3_ranges
index|[]
init|=
block|{
name|RANGE_INIT
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
block|,
name|RANGE_INIT
argument_list|(
literal|0x01
argument_list|,
literal|0x2D
argument_list|,
literal|620000
argument_list|,
literal|20000
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|regulator_range
name|as3722_ldo_ranges
index|[]
init|=
block|{
name|RANGE_INIT
argument_list|(
literal|0x00
argument_list|,
literal|0x00
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
block|,
name|RANGE_INIT
argument_list|(
literal|0x01
argument_list|,
literal|0x24
argument_list|,
literal|825000
argument_list|,
literal|25000
argument_list|)
block|,
name|RANGE_INIT
argument_list|(
literal|0x40
argument_list|,
literal|0x7F
argument_list|,
literal|1725000
argument_list|,
literal|25000
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|reg_def
name|as3722s_def
index|[]
init|=
block|{
block|{
operator|.
name|id
operator|=
name|AS3722_REG_ID_SD0
block|,
operator|.
name|name
operator|=
literal|"sd0"
block|,
operator|.
name|volt_reg
operator|=
name|AS3722_SD0_VOLTAGE
block|,
operator|.
name|volt_vsel_mask
operator|=
name|AS3722_SD_VSEL_MASK
block|,
operator|.
name|enable_reg
operator|=
name|AS3722_SD_CONTROL
block|,
operator|.
name|enable_mask
operator|=
name|AS3722_SDN_CTRL
argument_list|(
literal|0
argument_list|)
block|,
operator|.
name|ext_enable_reg
operator|=
name|AS3722_ENABLE_CTRL1
block|,
operator|.
name|ext_enable_mask
operator|=
name|AS3722_SD0_EXT_ENABLE_MASK
block|,
operator|.
name|ranges
operator|=
name|as3722_sd016_ranges
block|,
operator|.
name|nranges
operator|=
name|nitems
argument_list|(
name|as3722_sd016_ranges
argument_list|)
block|, 	}
block|,
block|{
operator|.
name|id
operator|=
name|AS3722_REG_ID_SD1
block|,
operator|.
name|name
operator|=
literal|"sd1"
block|,
operator|.
name|volt_reg
operator|=
name|AS3722_SD1_VOLTAGE
block|,
operator|.
name|volt_vsel_mask
operator|=
name|AS3722_SD_VSEL_MASK
block|,
operator|.
name|enable_reg
operator|=
name|AS3722_SD_CONTROL
block|,
operator|.
name|enable_mask
operator|=
name|AS3722_SDN_CTRL
argument_list|(
literal|1
argument_list|)
block|,
operator|.
name|ext_enable_reg
operator|=
name|AS3722_ENABLE_CTRL1
block|,
operator|.
name|ext_enable_mask
operator|=
name|AS3722_SD1_EXT_ENABLE_MASK
block|,
operator|.
name|ranges
operator|=
name|as3722_sd_ranges
block|,
operator|.
name|nranges
operator|=
name|nitems
argument_list|(
name|as3722_sd_ranges
argument_list|)
block|, 	}
block|,
block|{
operator|.
name|id
operator|=
name|AS3722_REG_ID_SD2
block|,
operator|.
name|name
operator|=
literal|"sd2"
block|,
operator|.
name|supply_name
operator|=
literal|"vsup-sd2"
block|,
operator|.
name|volt_reg
operator|=
name|AS3722_SD2_VOLTAGE
block|,
operator|.
name|volt_vsel_mask
operator|=
name|AS3722_SD_VSEL_MASK
block|,
operator|.
name|enable_reg
operator|=
name|AS3722_SD_CONTROL
block|,
operator|.
name|enable_mask
operator|=
name|AS3722_SDN_CTRL
argument_list|(
literal|2
argument_list|)
block|,
operator|.
name|ext_enable_reg
operator|=
name|AS3722_ENABLE_CTRL1
block|,
operator|.
name|ext_enable_mask
operator|=
name|AS3722_SD2_EXT_ENABLE_MASK
block|,
operator|.
name|ranges
operator|=
name|as3722_sd_ranges
block|,
operator|.
name|nranges
operator|=
name|nitems
argument_list|(
name|as3722_sd_ranges
argument_list|)
block|, 	}
block|,
block|{
operator|.
name|id
operator|=
name|AS3722_REG_ID_SD3
block|,
operator|.
name|name
operator|=
literal|"sd3"
block|,
operator|.
name|supply_name
operator|=
literal|"vsup-sd3"
block|,
operator|.
name|volt_reg
operator|=
name|AS3722_SD3_VOLTAGE
block|,
operator|.
name|volt_vsel_mask
operator|=
name|AS3722_SD_VSEL_MASK
block|,
operator|.
name|enable_reg
operator|=
name|AS3722_SD_CONTROL
block|,
operator|.
name|enable_mask
operator|=
name|AS3722_SDN_CTRL
argument_list|(
literal|3
argument_list|)
block|,
operator|.
name|ext_enable_reg
operator|=
name|AS3722_ENABLE_CTRL1
block|,
operator|.
name|ext_enable_mask
operator|=
name|AS3722_SD3_EXT_ENABLE_MASK
block|,
operator|.
name|ranges
operator|=
name|as3722_sd_ranges
block|,
operator|.
name|nranges
operator|=
name|nitems
argument_list|(
name|as3722_sd_ranges
argument_list|)
block|, 	}
block|,
block|{
operator|.
name|id
operator|=
name|AS3722_REG_ID_SD4
block|,
operator|.
name|name
operator|=
literal|"sd4"
block|,
operator|.
name|supply_name
operator|=
literal|"vsup-sd4"
block|,
operator|.
name|volt_reg
operator|=
name|AS3722_SD4_VOLTAGE
block|,
operator|.
name|volt_vsel_mask
operator|=
name|AS3722_SD_VSEL_MASK
block|,
operator|.
name|enable_reg
operator|=
name|AS3722_SD_CONTROL
block|,
operator|.
name|enable_mask
operator|=
name|AS3722_SDN_CTRL
argument_list|(
literal|4
argument_list|)
block|,
operator|.
name|ext_enable_reg
operator|=
name|AS3722_ENABLE_CTRL2
block|,
operator|.
name|ext_enable_mask
operator|=
name|AS3722_SD4_EXT_ENABLE_MASK
block|,
operator|.
name|ranges
operator|=
name|as3722_sd_ranges
block|,
operator|.
name|nranges
operator|=
name|nitems
argument_list|(
name|as3722_sd_ranges
argument_list|)
block|, 	}
block|,
block|{
operator|.
name|id
operator|=
name|AS3722_REG_ID_SD5
block|,
operator|.
name|name
operator|=
literal|"sd5"
block|,
operator|.
name|supply_name
operator|=
literal|"vsup-sd5"
block|,
operator|.
name|volt_reg
operator|=
name|AS3722_SD5_VOLTAGE
block|,
operator|.
name|volt_vsel_mask
operator|=
name|AS3722_SD_VSEL_MASK
block|,
operator|.
name|enable_reg
operator|=
name|AS3722_SD_CONTROL
block|,
operator|.
name|enable_mask
operator|=
name|AS3722_SDN_CTRL
argument_list|(
literal|5
argument_list|)
block|,
operator|.
name|ext_enable_reg
operator|=
name|AS3722_ENABLE_CTRL2
block|,
operator|.
name|ext_enable_mask
operator|=
name|AS3722_SD5_EXT_ENABLE_MASK
block|,
operator|.
name|ranges
operator|=
name|as3722_sd_ranges
block|,
operator|.
name|nranges
operator|=
name|nitems
argument_list|(
name|as3722_sd_ranges
argument_list|)
block|, 	}
block|,
block|{
operator|.
name|id
operator|=
name|AS3722_REG_ID_SD6
block|,
operator|.
name|name
operator|=
literal|"sd6"
block|,
operator|.
name|volt_reg
operator|=
name|AS3722_SD6_VOLTAGE
block|,
operator|.
name|volt_vsel_mask
operator|=
name|AS3722_SD_VSEL_MASK
block|,
operator|.
name|enable_reg
operator|=
name|AS3722_SD_CONTROL
block|,
operator|.
name|enable_mask
operator|=
name|AS3722_SDN_CTRL
argument_list|(
literal|6
argument_list|)
block|,
operator|.
name|ext_enable_reg
operator|=
name|AS3722_ENABLE_CTRL2
block|,
operator|.
name|ext_enable_mask
operator|=
name|AS3722_SD6_EXT_ENABLE_MASK
block|,
operator|.
name|ranges
operator|=
name|as3722_sd016_ranges
block|,
operator|.
name|nranges
operator|=
name|nitems
argument_list|(
name|as3722_sd016_ranges
argument_list|)
block|, 	}
block|,
block|{
operator|.
name|id
operator|=
name|AS3722_REG_ID_LDO0
block|,
operator|.
name|name
operator|=
literal|"ldo0"
block|,
operator|.
name|supply_name
operator|=
literal|"vin-ldo0"
block|,
operator|.
name|volt_reg
operator|=
name|AS3722_LDO0_VOLTAGE
block|,
operator|.
name|volt_vsel_mask
operator|=
name|AS3722_LDO0_VSEL_MASK
block|,
operator|.
name|enable_reg
operator|=
name|AS3722_LDO_CONTROL0
block|,
operator|.
name|enable_mask
operator|=
name|AS3722_LDO0_CTRL
block|,
operator|.
name|ext_enable_reg
operator|=
name|AS3722_ENABLE_CTRL3
block|,
operator|.
name|ext_enable_mask
operator|=
name|AS3722_LDO0_EXT_ENABLE_MASK
block|,
operator|.
name|ranges
operator|=
name|as3722_ldo_ranges
block|,
operator|.
name|nranges
operator|=
name|nitems
argument_list|(
name|as3722_ldo_ranges
argument_list|)
block|, 	}
block|,
block|{
operator|.
name|id
operator|=
name|AS3722_REG_ID_LDO1
block|,
operator|.
name|name
operator|=
literal|"ldo1"
block|,
operator|.
name|supply_name
operator|=
literal|"vin-ldo1-6"
block|,
operator|.
name|volt_reg
operator|=
name|AS3722_LDO1_VOLTAGE
block|,
operator|.
name|volt_vsel_mask
operator|=
name|AS3722_LDO_VSEL_MASK
block|,
operator|.
name|enable_reg
operator|=
name|AS3722_LDO_CONTROL0
block|,
operator|.
name|enable_mask
operator|=
name|AS3722_LDO1_CTRL
block|,
operator|.
name|ext_enable_reg
operator|=
name|AS3722_ENABLE_CTRL3
block|,
operator|.
name|ext_enable_mask
operator|=
name|AS3722_LDO1_EXT_ENABLE_MASK
block|,
operator|.
name|ranges
operator|=
name|as3722_ldo_ranges
block|,
operator|.
name|nranges
operator|=
name|nitems
argument_list|(
name|as3722_ldo_ranges
argument_list|)
block|, 	}
block|,
block|{
operator|.
name|id
operator|=
name|AS3722_REG_ID_LDO2
block|,
operator|.
name|name
operator|=
literal|"ldo2"
block|,
operator|.
name|supply_name
operator|=
literal|"vin-ldo2-5-7"
block|,
operator|.
name|volt_reg
operator|=
name|AS3722_LDO2_VOLTAGE
block|,
operator|.
name|volt_vsel_mask
operator|=
name|AS3722_LDO_VSEL_MASK
block|,
operator|.
name|enable_reg
operator|=
name|AS3722_LDO_CONTROL0
block|,
operator|.
name|enable_mask
operator|=
name|AS3722_LDO2_CTRL
block|,
operator|.
name|ext_enable_reg
operator|=
name|AS3722_ENABLE_CTRL3
block|,
operator|.
name|ext_enable_mask
operator|=
name|AS3722_LDO2_EXT_ENABLE_MASK
block|,
operator|.
name|ranges
operator|=
name|as3722_ldo_ranges
block|,
operator|.
name|nranges
operator|=
name|nitems
argument_list|(
name|as3722_ldo_ranges
argument_list|)
block|, 	}
block|,
block|{
operator|.
name|id
operator|=
name|AS3722_REG_ID_LDO3
block|,
operator|.
name|name
operator|=
literal|"ldo3"
block|,
operator|.
name|supply_name
operator|=
literal|"vin-ldo3-4"
block|,
operator|.
name|volt_reg
operator|=
name|AS3722_LDO3_VOLTAGE
block|,
operator|.
name|volt_vsel_mask
operator|=
name|AS3722_LDO3_VSEL_MASK
block|,
operator|.
name|enable_reg
operator|=
name|AS3722_LDO_CONTROL0
block|,
operator|.
name|enable_mask
operator|=
name|AS3722_LDO3_CTRL
block|,
operator|.
name|ext_enable_reg
operator|=
name|AS3722_ENABLE_CTRL3
block|,
operator|.
name|ext_enable_mask
operator|=
name|AS3722_LDO3_EXT_ENABLE_MASK
block|,
operator|.
name|ranges
operator|=
name|as3722_ldo3_ranges
block|,
operator|.
name|nranges
operator|=
name|nitems
argument_list|(
name|as3722_ldo3_ranges
argument_list|)
block|, 	}
block|,
block|{
operator|.
name|id
operator|=
name|AS3722_REG_ID_LDO4
block|,
operator|.
name|name
operator|=
literal|"ldo4"
block|,
operator|.
name|supply_name
operator|=
literal|"vin-ldo3-4"
block|,
operator|.
name|volt_reg
operator|=
name|AS3722_LDO4_VOLTAGE
block|,
operator|.
name|volt_vsel_mask
operator|=
name|AS3722_LDO_VSEL_MASK
block|,
operator|.
name|enable_reg
operator|=
name|AS3722_LDO_CONTROL0
block|,
operator|.
name|enable_mask
operator|=
name|AS3722_LDO4_CTRL
block|,
operator|.
name|ext_enable_reg
operator|=
name|AS3722_ENABLE_CTRL4
block|,
operator|.
name|ext_enable_mask
operator|=
name|AS3722_LDO4_EXT_ENABLE_MASK
block|,
operator|.
name|ranges
operator|=
name|as3722_ldo_ranges
block|,
operator|.
name|nranges
operator|=
name|nitems
argument_list|(
name|as3722_ldo_ranges
argument_list|)
block|, 	}
block|,
block|{
operator|.
name|id
operator|=
name|AS3722_REG_ID_LDO5
block|,
operator|.
name|name
operator|=
literal|"ldo5"
block|,
operator|.
name|supply_name
operator|=
literal|"vin-ldo2-5-7"
block|,
operator|.
name|volt_reg
operator|=
name|AS3722_LDO5_VOLTAGE
block|,
operator|.
name|volt_vsel_mask
operator|=
name|AS3722_LDO_VSEL_MASK
block|,
operator|.
name|enable_reg
operator|=
name|AS3722_LDO_CONTROL0
block|,
operator|.
name|enable_mask
operator|=
name|AS3722_LDO5_CTRL
block|,
operator|.
name|ext_enable_reg
operator|=
name|AS3722_ENABLE_CTRL4
block|,
operator|.
name|ext_enable_mask
operator|=
name|AS3722_LDO5_EXT_ENABLE_MASK
block|,
operator|.
name|ranges
operator|=
name|as3722_ldo_ranges
block|,
operator|.
name|nranges
operator|=
name|nitems
argument_list|(
name|as3722_ldo_ranges
argument_list|)
block|, 	}
block|,
block|{
operator|.
name|id
operator|=
name|AS3722_REG_ID_LDO6
block|,
operator|.
name|name
operator|=
literal|"ldo6"
block|,
operator|.
name|supply_name
operator|=
literal|"vin-ldo1-6"
block|,
operator|.
name|volt_reg
operator|=
name|AS3722_LDO6_VOLTAGE
block|,
operator|.
name|volt_vsel_mask
operator|=
name|AS3722_LDO_VSEL_MASK
block|,
operator|.
name|enable_reg
operator|=
name|AS3722_LDO_CONTROL0
block|,
operator|.
name|enable_mask
operator|=
name|AS3722_LDO6_CTRL
block|,
operator|.
name|ext_enable_reg
operator|=
name|AS3722_ENABLE_CTRL4
block|,
operator|.
name|ext_enable_mask
operator|=
name|AS3722_LDO6_EXT_ENABLE_MASK
block|,
operator|.
name|ranges
operator|=
name|as3722_ldo_ranges
block|,
operator|.
name|nranges
operator|=
name|nitems
argument_list|(
name|as3722_ldo_ranges
argument_list|)
block|, 	}
block|,
block|{
operator|.
name|id
operator|=
name|AS3722_REG_ID_LDO7
block|,
operator|.
name|name
operator|=
literal|"ldo7"
block|,
operator|.
name|supply_name
operator|=
literal|"vin-ldo2-5-7"
block|,
operator|.
name|volt_reg
operator|=
name|AS3722_LDO7_VOLTAGE
block|,
operator|.
name|volt_vsel_mask
operator|=
name|AS3722_LDO_VSEL_MASK
block|,
operator|.
name|enable_reg
operator|=
name|AS3722_LDO_CONTROL0
block|,
operator|.
name|enable_mask
operator|=
name|AS3722_LDO7_CTRL
block|,
operator|.
name|ext_enable_reg
operator|=
name|AS3722_ENABLE_CTRL4
block|,
operator|.
name|ext_enable_mask
operator|=
name|AS3722_LDO7_EXT_ENABLE_MASK
block|,
operator|.
name|ranges
operator|=
name|as3722_ldo_ranges
block|,
operator|.
name|nranges
operator|=
name|nitems
argument_list|(
name|as3722_ldo_ranges
argument_list|)
block|, 	}
block|,
block|{
operator|.
name|id
operator|=
name|AS3722_REG_ID_LDO9
block|,
operator|.
name|name
operator|=
literal|"ldo9"
block|,
operator|.
name|supply_name
operator|=
literal|"vin-ldo9-10"
block|,
operator|.
name|volt_reg
operator|=
name|AS3722_LDO9_VOLTAGE
block|,
operator|.
name|volt_vsel_mask
operator|=
name|AS3722_LDO_VSEL_MASK
block|,
operator|.
name|enable_reg
operator|=
name|AS3722_LDO_CONTROL1
block|,
operator|.
name|enable_mask
operator|=
name|AS3722_LDO9_CTRL
block|,
operator|.
name|ext_enable_reg
operator|=
name|AS3722_ENABLE_CTRL5
block|,
operator|.
name|ext_enable_mask
operator|=
name|AS3722_LDO9_EXT_ENABLE_MASK
block|,
operator|.
name|ranges
operator|=
name|as3722_ldo_ranges
block|,
operator|.
name|nranges
operator|=
name|nitems
argument_list|(
name|as3722_ldo_ranges
argument_list|)
block|, 	}
block|,
block|{
operator|.
name|id
operator|=
name|AS3722_REG_ID_LDO10
block|,
operator|.
name|name
operator|=
literal|"ldo10"
block|,
operator|.
name|supply_name
operator|=
literal|"vin-ldo9-10"
block|,
operator|.
name|volt_reg
operator|=
name|AS3722_LDO10_VOLTAGE
block|,
operator|.
name|volt_vsel_mask
operator|=
name|AS3722_LDO_VSEL_MASK
block|,
operator|.
name|enable_reg
operator|=
name|AS3722_LDO_CONTROL1
block|,
operator|.
name|enable_mask
operator|=
name|AS3722_LDO10_CTRL
block|,
operator|.
name|ext_enable_reg
operator|=
name|AS3722_ENABLE_CTRL5
block|,
operator|.
name|ext_enable_mask
operator|=
name|AS3722_LDO10_EXT_ENABLE_MASK
block|,
operator|.
name|ranges
operator|=
name|as3722_ldo_ranges
block|,
operator|.
name|nranges
operator|=
name|nitems
argument_list|(
name|as3722_ldo_ranges
argument_list|)
block|, 	}
block|,
block|{
operator|.
name|id
operator|=
name|AS3722_REG_ID_LDO11
block|,
operator|.
name|name
operator|=
literal|"ldo11"
block|,
operator|.
name|supply_name
operator|=
literal|"vin-ldo11"
block|,
operator|.
name|volt_reg
operator|=
name|AS3722_LDO11_VOLTAGE
block|,
operator|.
name|volt_vsel_mask
operator|=
name|AS3722_LDO_VSEL_MASK
block|,
operator|.
name|enable_reg
operator|=
name|AS3722_LDO_CONTROL1
block|,
operator|.
name|enable_mask
operator|=
name|AS3722_LDO11_CTRL
block|,
operator|.
name|ext_enable_reg
operator|=
name|AS3722_ENABLE_CTRL5
block|,
operator|.
name|ext_enable_mask
operator|=
name|AS3722_LDO11_EXT_ENABLE_MASK
block|,
operator|.
name|ranges
operator|=
name|as3722_ldo_ranges
block|,
operator|.
name|nranges
operator|=
name|nitems
argument_list|(
name|as3722_ldo_ranges
argument_list|)
block|, 	}
block|, }
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|as3722_regnode_init_def
block|{
name|struct
name|regnode_init_def
name|reg_init_def
decl_stmt|;
name|int
name|ext_control
decl_stmt|;
name|int
name|enable_tracking
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|int
name|as3722_regnode_init
parameter_list|(
name|struct
name|regnode
modifier|*
name|regnode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|as3722_regnode_enable
parameter_list|(
name|struct
name|regnode
modifier|*
name|regnode
parameter_list|,
name|bool
name|enable
parameter_list|,
name|int
modifier|*
name|udelay
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|as3722_regnode_set_volt
parameter_list|(
name|struct
name|regnode
modifier|*
name|regnode
parameter_list|,
name|int
name|min_uvolt
parameter_list|,
name|int
name|max_uvolt
parameter_list|,
name|int
modifier|*
name|udelay
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|as3722_regnode_get_volt
parameter_list|(
name|struct
name|regnode
modifier|*
name|regnode
parameter_list|,
name|int
modifier|*
name|uvolt
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|regnode_method_t
name|as3722_regnode_methods
index|[]
init|=
block|{
comment|/* Regulator interface */
name|REGNODEMETHOD
argument_list|(
name|regnode_init
argument_list|,
name|as3722_regnode_init
argument_list|)
block|,
name|REGNODEMETHOD
argument_list|(
name|regnode_enable
argument_list|,
name|as3722_regnode_enable
argument_list|)
block|,
name|REGNODEMETHOD
argument_list|(
name|regnode_set_voltage
argument_list|,
name|as3722_regnode_set_volt
argument_list|)
block|,
name|REGNODEMETHOD
argument_list|(
name|regnode_get_voltage
argument_list|,
name|as3722_regnode_get_volt
argument_list|)
block|,
name|REGNODEMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DEFINE_CLASS_1
argument_list|(
name|as3722_regnode
argument_list|,
name|as3722_regnode_class
argument_list|,
name|as3722_regnode_methods
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|as3722_reg_sc
argument_list|)
argument_list|,
name|regnode_class
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|regulator_range_sel_to_volt
parameter_list|(
name|struct
name|as3722_reg_sc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|sel
parameter_list|,
name|int
modifier|*
name|volt
parameter_list|)
block|{
name|struct
name|regulator_range
modifier|*
name|range
decl_stmt|;
name|struct
name|reg_def
modifier|*
name|def
decl_stmt|;
name|int
name|i
decl_stmt|;
name|def
operator|=
name|sc
operator|->
name|def
expr_stmt|;
if|if
condition|(
name|def
operator|->
name|nranges
operator|==
literal|0
condition|)
name|panic
argument_list|(
literal|"Voltage regulator have zero ranges\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|def
operator|->
name|nranges
condition|;
name|i
operator|++
control|)
block|{
name|range
operator|=
name|def
operator|->
name|ranges
operator|+
name|i
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sel
operator|>=
name|range
operator|->
name|min_sel
operator|&&
name|sel
operator|<=
name|range
operator|->
name|max_sel
operator|)
condition|)
continue|continue;
name|sel
operator|-=
name|range
operator|->
name|min_sel
expr_stmt|;
operator|*
name|volt
operator|=
name|range
operator|->
name|min_uvolt
operator|+
name|sel
operator|*
name|range
operator|->
name|step_uvolt
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
name|ERANGE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|regulator_range_volt_to_sel
parameter_list|(
name|struct
name|as3722_reg_sc
modifier|*
name|sc
parameter_list|,
name|int
name|min_uvolt
parameter_list|,
name|int
name|max_uvolt
parameter_list|,
name|uint8_t
modifier|*
name|out_sel
parameter_list|)
block|{
name|struct
name|regulator_range
modifier|*
name|range
decl_stmt|;
name|struct
name|reg_def
modifier|*
name|def
decl_stmt|;
name|uint8_t
name|sel
decl_stmt|;
name|int
name|uvolt
decl_stmt|;
name|int
name|rv
decl_stmt|,
name|i
decl_stmt|;
name|def
operator|=
name|sc
operator|->
name|def
expr_stmt|;
if|if
condition|(
name|def
operator|->
name|nranges
operator|==
literal|0
condition|)
name|panic
argument_list|(
literal|"Voltage regulator have zero ranges\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|def
operator|->
name|nranges
condition|;
name|i
operator|++
control|)
block|{
name|range
operator|=
name|def
operator|->
name|ranges
operator|+
name|i
expr_stmt|;
name|uvolt
operator|=
name|range
operator|->
name|min_uvolt
operator|+
operator|(
name|range
operator|->
name|max_sel
operator|-
name|range
operator|->
name|min_sel
operator|)
operator|*
name|range
operator|->
name|step_uvolt
expr_stmt|;
if|if
condition|(
operator|(
name|min_uvolt
operator|>
name|uvolt
operator|)
operator|||
operator|(
name|max_uvolt
operator|<
name|range
operator|->
name|min_uvolt
operator|)
condition|)
continue|continue;
if|if
condition|(
name|min_uvolt
operator|<=
name|range
operator|->
name|min_uvolt
condition|)
name|min_uvolt
operator|=
name|range
operator|->
name|min_uvolt
expr_stmt|;
comment|/* If step is zero then range is fixed voltage range. */
if|if
condition|(
name|range
operator|->
name|step_uvolt
operator|==
literal|0
condition|)
name|sel
operator|=
literal|0
expr_stmt|;
else|else
name|sel
operator|=
name|DIV_ROUND_UP
argument_list|(
name|min_uvolt
operator|-
name|range
operator|->
name|min_uvolt
argument_list|,
name|range
operator|->
name|step_uvolt
argument_list|)
expr_stmt|;
name|sel
operator|+=
name|range
operator|->
name|min_sel
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|i
operator|>=
name|def
operator|->
name|nranges
condition|)
return|return
operator|(
name|ERANGE
operator|)
return|;
comment|/* Verify new settings. */
name|rv
operator|=
name|regulator_range_sel_to_volt
argument_list|(
name|sc
argument_list|,
name|sel
argument_list|,
operator|&
name|uvolt
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
return|return
operator|(
name|rv
operator|)
return|;
if|if
condition|(
operator|(
name|uvolt
operator|<
name|min_uvolt
operator|)
operator|||
operator|(
name|uvolt
operator|>
name|max_uvolt
operator|)
condition|)
return|return
operator|(
name|ERANGE
operator|)
return|;
operator|*
name|out_sel
operator|=
name|sel
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|as3722_read_sel
parameter_list|(
name|struct
name|as3722_reg_sc
modifier|*
name|sc
parameter_list|,
name|uint8_t
modifier|*
name|sel
parameter_list|)
block|{
name|int
name|rv
decl_stmt|;
name|rv
operator|=
name|RD1
argument_list|(
name|sc
operator|->
name|base_sc
argument_list|,
name|sc
operator|->
name|def
operator|->
name|volt_reg
argument_list|,
name|sel
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
return|return
operator|(
name|rv
operator|)
return|;
operator|*
name|sel
operator|&=
name|sc
operator|->
name|def
operator|->
name|volt_vsel_mask
expr_stmt|;
operator|*
name|sel
operator|>>=
name|ffs
argument_list|(
name|sc
operator|->
name|def
operator|->
name|volt_vsel_mask
argument_list|)
operator|-
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|as3722_write_sel
parameter_list|(
name|struct
name|as3722_reg_sc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|sel
parameter_list|)
block|{
name|int
name|rv
decl_stmt|;
name|sel
operator|<<=
name|ffs
argument_list|(
name|sc
operator|->
name|def
operator|->
name|volt_vsel_mask
argument_list|)
operator|-
literal|1
expr_stmt|;
name|sel
operator|&=
name|sc
operator|->
name|def
operator|->
name|volt_vsel_mask
expr_stmt|;
name|rv
operator|=
name|RM1
argument_list|(
name|sc
operator|->
name|base_sc
argument_list|,
name|sc
operator|->
name|def
operator|->
name|volt_reg
argument_list|,
name|sc
operator|->
name|def
operator|->
name|volt_vsel_mask
argument_list|,
name|sel
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
return|return
operator|(
name|rv
operator|)
return|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|as3722_sd0_is_low_voltage
parameter_list|(
name|struct
name|as3722_reg_sc
modifier|*
name|sc
parameter_list|)
block|{
name|uint8_t
name|val
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|rv
operator|=
name|RD1
argument_list|(
name|sc
operator|->
name|base_sc
argument_list|,
name|AS3722_FUSE7
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
return|return
operator|(
name|rv
operator|)
return|;
return|return
operator|(
name|val
operator|&
name|AS3722_FUSE7_SD0_LOW_VOLTAGE
condition|?
name|true
else|:
name|false
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|as3722_reg_extreg_setup
parameter_list|(
name|struct
name|as3722_reg_sc
modifier|*
name|sc
parameter_list|,
name|int
name|ext_pwr_ctrl
parameter_list|)
block|{
name|uint8_t
name|val
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|val
operator|=
name|ext_pwr_ctrl
operator|<<
operator|(
name|ffs
argument_list|(
name|sc
operator|->
name|def
operator|->
name|ext_enable_mask
argument_list|)
operator|-
literal|1
operator|)
expr_stmt|;
name|rv
operator|=
name|RM1
argument_list|(
name|sc
operator|->
name|base_sc
argument_list|,
name|sc
operator|->
name|def
operator|->
name|ext_enable_reg
argument_list|,
name|sc
operator|->
name|def
operator|->
name|ext_enable_mask
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|as3722_reg_enable
parameter_list|(
name|struct
name|as3722_reg_sc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|rv
decl_stmt|;
name|rv
operator|=
name|RM1
argument_list|(
name|sc
operator|->
name|base_sc
argument_list|,
name|sc
operator|->
name|def
operator|->
name|enable_reg
argument_list|,
name|sc
operator|->
name|def
operator|->
name|enable_mask
argument_list|,
name|sc
operator|->
name|def
operator|->
name|enable_mask
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|as3722_reg_disable
parameter_list|(
name|struct
name|as3722_reg_sc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|rv
decl_stmt|;
name|rv
operator|=
name|RM1
argument_list|(
name|sc
operator|->
name|base_sc
argument_list|,
name|sc
operator|->
name|def
operator|->
name|enable_reg
argument_list|,
name|sc
operator|->
name|def
operator|->
name|enable_mask
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|as3722_regnode_init
parameter_list|(
name|struct
name|regnode
modifier|*
name|regnode
parameter_list|)
block|{
name|struct
name|as3722_reg_sc
modifier|*
name|sc
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|sc
operator|=
name|regnode_get_softc
argument_list|(
name|regnode
argument_list|)
expr_stmt|;
name|sc
operator|->
name|enable_usec
operator|=
literal|500
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|def
operator|->
name|id
operator|==
name|AS3722_REG_ID_SD0
condition|)
block|{
if|if
condition|(
name|as3722_sd0_is_low_voltage
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|sc
operator|->
name|def
operator|->
name|ranges
operator|=
name|as3722_sd0_lv_ranges
expr_stmt|;
name|sc
operator|->
name|def
operator|->
name|nranges
operator|=
name|nitems
argument_list|(
name|as3722_sd0_lv_ranges
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|enable_usec
operator|=
literal|600
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sc
operator|->
name|def
operator|->
name|id
operator|==
name|AS3722_REG_ID_LDO3
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|enable_tracking
condition|)
block|{
name|rv
operator|=
name|RM1
argument_list|(
name|sc
operator|->
name|base_sc
argument_list|,
name|sc
operator|->
name|def
operator|->
name|volt_reg
argument_list|,
name|AS3722_LDO3_MODE_MASK
argument_list|,
name|AS3722_LDO3_MODE_PMOS_TRACKING
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|base_sc
operator|->
name|dev
argument_list|,
literal|"LDO3 tracking failed: %d\n"
argument_list|,
name|rv
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
block|}
block|}
if|if
condition|(
name|sc
operator|->
name|ext_control
condition|)
block|{
name|rv
operator|=
name|as3722_reg_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|base_sc
operator|->
name|dev
argument_list|,
literal|"Failed to enable %s regulator: %d\n"
argument_list|,
name|sc
operator|->
name|def
operator|->
name|name
argument_list|,
name|rv
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
name|rv
operator|=
name|as3722_reg_extreg_setup
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|ext_control
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|base_sc
operator|->
name|dev
argument_list|,
literal|"%s ext control failed: %d"
argument_list|,
name|sc
operator|->
name|def
operator|->
name|name
argument_list|,
name|rv
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|as3722_fdt_parse
parameter_list|(
name|struct
name|as3722_softc
modifier|*
name|sc
parameter_list|,
name|phandle_t
name|node
parameter_list|,
name|struct
name|reg_def
modifier|*
name|def
parameter_list|,
name|struct
name|as3722_regnode_init_def
modifier|*
name|init_def
parameter_list|)
block|{
name|int
name|rv
decl_stmt|;
name|phandle_t
name|parent
decl_stmt|,
name|supply_node
decl_stmt|;
name|char
name|prop_name
index|[
literal|64
index|]
decl_stmt|;
comment|/* Maximum OFW property name length. */
name|rv
operator|=
name|regulator_parse_ofw_stdparam
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|node
argument_list|,
operator|&
name|init_def
operator|->
name|reg_init_def
argument_list|)
expr_stmt|;
name|rv
operator|=
name|OF_getencprop
argument_list|(
name|node
argument_list|,
literal|"ams,ext-control"
argument_list|,
operator|&
name|init_def
operator|->
name|ext_control
argument_list|,
sizeof|sizeof
argument_list|(
name|init_def
operator|->
name|ext_control
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<=
literal|0
condition|)
name|init_def
operator|->
name|ext_control
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|init_def
operator|->
name|ext_control
operator|>
literal|3
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Invalid value for ams,ext-control property: %d\n"
argument_list|,
name|init_def
operator|->
name|ext_control
argument_list|)
expr_stmt|;
name|init_def
operator|->
name|ext_control
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|OF_hasprop
argument_list|(
name|node
argument_list|,
literal|"ams,enable-tracking"
argument_list|)
condition|)
name|init_def
operator|->
name|enable_tracking
operator|=
literal|1
expr_stmt|;
comment|/* Get parent supply. */
if|if
condition|(
name|def
operator|->
name|supply_name
operator|==
name|NULL
condition|)
return|return;
name|parent
operator|=
name|OF_parent
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|prop_name
argument_list|,
sizeof|sizeof
argument_list|(
name|prop_name
argument_list|)
argument_list|,
literal|"%s-supply"
argument_list|,
name|def
operator|->
name|supply_name
argument_list|)
expr_stmt|;
name|rv
operator|=
name|OF_getencprop
argument_list|(
name|parent
argument_list|,
name|prop_name
argument_list|,
operator|&
name|supply_node
argument_list|,
sizeof|sizeof
argument_list|(
name|supply_node
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<=
literal|0
condition|)
return|return;
name|supply_node
operator|=
name|OF_node_from_xref
argument_list|(
name|supply_node
argument_list|)
expr_stmt|;
name|rv
operator|=
name|OF_getprop_alloc
argument_list|(
name|supply_node
argument_list|,
literal|"regulator-name"
argument_list|,
literal|1
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|init_def
operator|->
name|reg_init_def
operator|.
name|parent_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<=
literal|0
condition|)
name|init_def
operator|->
name|reg_init_def
operator|.
name|parent_name
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|as3722_reg_sc
modifier|*
name|as3722_attach
parameter_list|(
name|struct
name|as3722_softc
modifier|*
name|sc
parameter_list|,
name|phandle_t
name|node
parameter_list|,
name|struct
name|reg_def
modifier|*
name|def
parameter_list|)
block|{
name|struct
name|as3722_reg_sc
modifier|*
name|reg_sc
decl_stmt|;
name|struct
name|as3722_regnode_init_def
name|init_def
decl_stmt|;
name|struct
name|regnode
modifier|*
name|regnode
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|init_def
argument_list|,
sizeof|sizeof
argument_list|(
name|init_def
argument_list|)
argument_list|)
expr_stmt|;
name|as3722_fdt_parse
argument_list|(
name|sc
argument_list|,
name|node
argument_list|,
name|def
argument_list|,
operator|&
name|init_def
argument_list|)
expr_stmt|;
name|init_def
operator|.
name|reg_init_def
operator|.
name|id
operator|=
name|def
operator|->
name|id
expr_stmt|;
name|init_def
operator|.
name|reg_init_def
operator|.
name|ofw_node
operator|=
name|node
expr_stmt|;
name|regnode
operator|=
name|regnode_create
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
operator|&
name|as3722_regnode_class
argument_list|,
operator|&
name|init_def
operator|.
name|reg_init_def
argument_list|)
expr_stmt|;
if|if
condition|(
name|regnode
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot create regulator.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|reg_sc
operator|=
name|regnode_get_softc
argument_list|(
name|regnode
argument_list|)
expr_stmt|;
comment|/* Init regulator softc. */
name|reg_sc
operator|->
name|regnode
operator|=
name|regnode
expr_stmt|;
name|reg_sc
operator|->
name|base_sc
operator|=
name|sc
expr_stmt|;
name|reg_sc
operator|->
name|def
operator|=
name|def
expr_stmt|;
name|reg_sc
operator|->
name|xref
operator|=
name|OF_xref_from_node
argument_list|(
name|node
argument_list|)
expr_stmt|;
name|reg_sc
operator|->
name|param
operator|=
name|regnode_get_stdparam
argument_list|(
name|regnode
argument_list|)
expr_stmt|;
name|reg_sc
operator|->
name|ext_control
operator|=
name|init_def
operator|.
name|ext_control
expr_stmt|;
name|reg_sc
operator|->
name|enable_tracking
operator|=
name|init_def
operator|.
name|enable_tracking
expr_stmt|;
name|regnode_register
argument_list|(
name|regnode
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
block|{
name|int
name|volt
decl_stmt|,
name|rv
decl_stmt|;
name|regnode_topo_slock
argument_list|()
expr_stmt|;
name|rv
operator|=
name|regnode_get_voltage
argument_list|(
name|regnode
argument_list|,
operator|&
name|volt
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|==
name|ENODEV
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|" Regulator %s: parent doesn't exist yet.\n"
argument_list|,
name|regnode_get_name
argument_list|(
name|regnode
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|" Regulator %s: voltage: INVALID!!!\n"
argument_list|,
name|regnode_get_name
argument_list|(
name|regnode
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|" Regulator %s: voltage: %d uV\n"
argument_list|,
name|regnode_get_name
argument_list|(
name|regnode
argument_list|)
argument_list|,
name|volt
argument_list|)
expr_stmt|;
block|}
name|regnode_topo_unlock
argument_list|()
expr_stmt|;
block|}
return|return
operator|(
name|reg_sc
operator|)
return|;
block|}
end_function

begin_function
name|int
name|as3722_regulator_attach
parameter_list|(
name|struct
name|as3722_softc
modifier|*
name|sc
parameter_list|,
name|phandle_t
name|node
parameter_list|)
block|{
name|struct
name|as3722_reg_sc
modifier|*
name|reg
decl_stmt|;
name|phandle_t
name|child
decl_stmt|,
name|rnode
decl_stmt|;
name|int
name|i
decl_stmt|;
name|rnode
operator|=
name|ofw_bus_find_child
argument_list|(
name|node
argument_list|,
literal|"regulators"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rnode
operator|<=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|" Cannot find regulators subnode\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|sc
operator|->
name|nregs
operator|=
name|nitems
argument_list|(
name|as3722s_def
argument_list|)
expr_stmt|;
name|sc
operator|->
name|regs
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|as3722_reg_sc
operator|*
argument_list|)
operator|*
name|sc
operator|->
name|nregs
argument_list|,
name|M_AS3722_REG
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
comment|/* Attach all known regulators if exist in DT. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nregs
condition|;
name|i
operator|++
control|)
block|{
name|child
operator|=
name|ofw_bus_find_child
argument_list|(
name|rnode
argument_list|,
name|as3722s_def
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Regulator %s missing in DT\n"
argument_list|,
name|as3722s_def
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|reg
operator|=
name|as3722_attach
argument_list|(
name|sc
argument_list|,
name|child
argument_list|,
name|as3722s_def
operator|+
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot attach regulator: %s\n"
argument_list|,
name|as3722s_def
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|sc
operator|->
name|regs
index|[
name|i
index|]
operator|=
name|reg
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|as3722_regulator_map
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|phandle_t
name|xref
parameter_list|,
name|int
name|ncells
parameter_list|,
name|pcell_t
modifier|*
name|cells
parameter_list|,
name|int
modifier|*
name|num
parameter_list|)
block|{
name|struct
name|as3722_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|nregs
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sc
operator|->
name|regs
index|[
name|i
index|]
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|sc
operator|->
name|regs
index|[
name|i
index|]
operator|->
name|xref
operator|==
name|xref
condition|)
block|{
operator|*
name|num
operator|=
name|sc
operator|->
name|regs
index|[
name|i
index|]
operator|->
name|def
operator|->
name|id
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|as3722_regnode_enable
parameter_list|(
name|struct
name|regnode
modifier|*
name|regnode
parameter_list|,
name|bool
name|val
parameter_list|,
name|int
modifier|*
name|udelay
parameter_list|)
block|{
name|struct
name|as3722_reg_sc
modifier|*
name|sc
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|sc
operator|=
name|regnode_get_softc
argument_list|(
name|regnode
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
condition|)
name|rv
operator|=
name|as3722_reg_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
else|else
name|rv
operator|=
name|as3722_reg_disable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
operator|*
name|udelay
operator|=
name|sc
operator|->
name|enable_usec
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|as3722_regnode_set_volt
parameter_list|(
name|struct
name|regnode
modifier|*
name|regnode
parameter_list|,
name|int
name|min_uvolt
parameter_list|,
name|int
name|max_uvolt
parameter_list|,
name|int
modifier|*
name|udelay
parameter_list|)
block|{
name|struct
name|as3722_reg_sc
modifier|*
name|sc
decl_stmt|;
name|uint8_t
name|sel
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|sc
operator|=
name|regnode_get_softc
argument_list|(
name|regnode
argument_list|)
expr_stmt|;
operator|*
name|udelay
operator|=
literal|0
expr_stmt|;
name|rv
operator|=
name|regulator_range_volt_to_sel
argument_list|(
name|sc
argument_list|,
name|min_uvolt
argument_list|,
name|max_uvolt
argument_list|,
operator|&
name|sel
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
return|return
operator|(
name|rv
operator|)
return|;
name|rv
operator|=
name|as3722_write_sel
argument_list|(
name|sc
argument_list|,
name|sel
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|as3722_regnode_get_volt
parameter_list|(
name|struct
name|regnode
modifier|*
name|regnode
parameter_list|,
name|int
modifier|*
name|uvolt
parameter_list|)
block|{
name|struct
name|as3722_reg_sc
modifier|*
name|sc
decl_stmt|;
name|uint8_t
name|sel
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|sc
operator|=
name|regnode_get_softc
argument_list|(
name|regnode
argument_list|)
expr_stmt|;
name|rv
operator|=
name|as3722_read_sel
argument_list|(
name|sc
argument_list|,
operator|&
name|sel
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
return|return
operator|(
name|rv
operator|)
return|;
comment|/* LDO6 have bypass. */
if|if
condition|(
name|sc
operator|->
name|def
operator|->
name|id
operator|==
name|AS3722_REG_ID_LDO6
operator|&&
name|sel
operator|==
name|AS3722_LDO6_SEL_BYPASS
condition|)
return|return
operator|(
name|ENOENT
operator|)
return|;
name|rv
operator|=
name|regulator_range_sel_to_volt
argument_list|(
name|sc
argument_list|,
name|sel
argument_list|,
name|uvolt
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2016 Michal Meloun<mmel@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/gpio.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/sx.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/fdt/fdt_common.h>
end_include

begin_include
include|#
directive|include
file|<dev/gpio/gpiobusvar.h>
end_include

begin_include
include|#
directive|include
file|"as3722.h"
end_include

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_AS3722_GPIO
argument_list|,
literal|"AS3722 gpio"
argument_list|,
literal|"AS3722 GPIO"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* AS3722_GPIOx_CONTROL	 MODE and IOSF definition. */
end_comment

begin_define
define|#
directive|define
name|AS3722_IOSF_GPIO
value|0x00
end_define

begin_define
define|#
directive|define
name|AS3722_IOSF_INTERRUPT_OUT
value|0x01
end_define

begin_define
define|#
directive|define
name|AS3722_IOSF_VSUP_VBAT_LOW_UNDEBOUNCE_OUT
value|0x02
end_define

begin_define
define|#
directive|define
name|AS3722_IOSF_GPIO_IN_INTERRUPT
value|0x03
end_define

begin_define
define|#
directive|define
name|AS3722_IOSF_PWM_IN
value|0x04
end_define

begin_define
define|#
directive|define
name|AS3722_IOSF_VOLTAGE_IN_STANDBY
value|0x05
end_define

begin_define
define|#
directive|define
name|AS3722_IOSF_OC_PG_SD0
value|0x06
end_define

begin_define
define|#
directive|define
name|AS3722_IOSF_POWERGOOD_OUT
value|0x07
end_define

begin_define
define|#
directive|define
name|AS3722_IOSF_CLK32K_OUT
value|0x08
end_define

begin_define
define|#
directive|define
name|AS3722_IOSF_WATCHDOG_IN
value|0x09
end_define

begin_define
define|#
directive|define
name|AS3722_IOSF_SOFT_RESET_IN
value|0x0b
end_define

begin_define
define|#
directive|define
name|AS3722_IOSF_PWM_OUT
value|0x0c
end_define

begin_define
define|#
directive|define
name|AS3722_IOSF_VSUP_VBAT_LOW_DEBOUNCE_OUT
value|0x0d
end_define

begin_define
define|#
directive|define
name|AS3722_IOSF_OC_PG_SD6
value|0x0e
end_define

begin_define
define|#
directive|define
name|AS3722_MODE_INPUT
value|0
end_define

begin_define
define|#
directive|define
name|AS3722_MODE_PUSH_PULL
value|1
end_define

begin_define
define|#
directive|define
name|AS3722_MODE_OPEN_DRAIN
value|2
end_define

begin_define
define|#
directive|define
name|AS3722_MODE_TRISTATE
value|3
end_define

begin_define
define|#
directive|define
name|AS3722_MODE_INPUT_PULL_UP_LV
value|4
end_define

begin_define
define|#
directive|define
name|AS3722_MODE_INPUT_PULL_DOWN
value|5
end_define

begin_define
define|#
directive|define
name|AS3722_MODE_OPEN_DRAIN_LV
value|6
end_define

begin_define
define|#
directive|define
name|AS3722_MODE_PUSH_PULL_LV
value|7
end_define

begin_define
define|#
directive|define
name|NGPIO
value|8
end_define

begin_define
define|#
directive|define
name|GPIO_LOCK
parameter_list|(
name|_sc
parameter_list|)
value|sx_slock(&(_sc)->gpio_lock)
end_define

begin_define
define|#
directive|define
name|GPIO_UNLOCK
parameter_list|(
name|_sc
parameter_list|)
value|sx_unlock(&(_sc)->gpio_lock)
end_define

begin_define
define|#
directive|define
name|GPIO_ASSERT
parameter_list|(
name|_sc
parameter_list|)
value|sx_assert(&(_sc)->gpio_lock, SA_LOCKED)
end_define

begin_define
define|#
directive|define
name|AS3722_CFG_BIAS_DISABLE
value|0x0001
end_define

begin_define
define|#
directive|define
name|AS3722_CFG_BIAS_PULL_UP
value|0x0002
end_define

begin_define
define|#
directive|define
name|AS3722_CFG_BIAS_PULL_DOWN
value|0x0004
end_define

begin_define
define|#
directive|define
name|AS3722_CFG_BIAS_HIGH_IMPEDANCE
value|0x0008
end_define

begin_define
define|#
directive|define
name|AS3722_CFG_OPEN_DRAIN
value|0x0010
end_define

begin_struct
specifier|static
specifier|const
struct|struct
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|config
decl_stmt|;
comment|/* AS3722_CFG_  */
block|}
name|as3722_cfg_names
index|[]
init|=
block|{
block|{
literal|"bias-disable"
block|,
name|AS3722_CFG_BIAS_DISABLE
block|}
block|,
block|{
literal|"bias-pull-up"
block|,
name|AS3722_CFG_BIAS_PULL_UP
block|}
block|,
block|{
literal|"bias-pull-down"
block|,
name|AS3722_CFG_BIAS_PULL_DOWN
block|}
block|,
block|{
literal|"bias-high-impedance"
block|,
name|AS3722_CFG_BIAS_HIGH_IMPEDANCE
block|}
block|,
block|{
literal|"drive-open-drain"
block|,
name|AS3722_CFG_OPEN_DRAIN
block|}
block|, }
struct|;
end_struct

begin_struct
specifier|static
struct|struct
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|fnc_val
decl_stmt|;
block|}
name|as3722_fnc_table
index|[]
init|=
block|{
block|{
literal|"gpio"
block|,
name|AS3722_IOSF_GPIO
block|}
block|,
block|{
literal|"interrupt-out"
block|,
name|AS3722_IOSF_INTERRUPT_OUT
block|}
block|,
block|{
literal|"vsup-vbat-low-undebounce-out"
block|,
name|AS3722_IOSF_VSUP_VBAT_LOW_UNDEBOUNCE_OUT
block|}
block|,
block|{
literal|"gpio-in-interrupt"
block|,
name|AS3722_IOSF_GPIO_IN_INTERRUPT
block|}
block|,
block|{
literal|"pwm-in"
block|,
name|AS3722_IOSF_PWM_IN
block|}
block|,
block|{
literal|"voltage-in-standby"
block|,
name|AS3722_IOSF_VOLTAGE_IN_STANDBY
block|}
block|,
block|{
literal|"oc-pg-sd0"
block|,
name|AS3722_IOSF_OC_PG_SD0
block|}
block|,
block|{
literal|"powergood-out"
block|,
name|AS3722_IOSF_POWERGOOD_OUT
block|}
block|,
block|{
literal|"clk32k-out"
block|,
name|AS3722_IOSF_CLK32K_OUT
block|}
block|,
block|{
literal|"watchdog-in"
block|,
name|AS3722_IOSF_WATCHDOG_IN
block|}
block|,
block|{
literal|"soft-reset-in"
block|,
name|AS3722_IOSF_SOFT_RESET_IN
block|}
block|,
block|{
literal|"pwm-out"
block|,
name|AS3722_IOSF_PWM_OUT
block|}
block|,
block|{
literal|"vsup-vbat-low-debounce-out"
block|,
name|AS3722_IOSF_VSUP_VBAT_LOW_DEBOUNCE_OUT
block|}
block|,
block|{
literal|"oc-pg-sd6"
block|,
name|AS3722_IOSF_OC_PG_SD6
block|}
block|, }
struct|;
end_struct

begin_struct
struct|struct
name|as3722_pincfg
block|{
name|char
modifier|*
name|function
decl_stmt|;
name|int
name|flags
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|as3722_gpio_pin
block|{
name|int
name|pin_caps
decl_stmt|;
name|uint8_t
name|pin_ctrl_reg
decl_stmt|;
name|char
name|pin_name
index|[
name|GPIOMAXNAME
index|]
decl_stmt|;
name|int
name|pin_cfg_flags
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* --------------------------------------------------------------------------  *  *  Pinmux functions.  */
end_comment

begin_function
specifier|static
name|int
name|as3722_pinmux_get_function
parameter_list|(
name|struct
name|as3722_softc
modifier|*
name|sc
parameter_list|,
name|char
modifier|*
name|name
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|as3722_fnc_table
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|as3722_fnc_table
index|[
name|i
index|]
operator|.
name|name
argument_list|,
name|name
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|as3722_fnc_table
index|[
name|i
index|]
operator|.
name|fnc_val
operator|)
return|;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|as3722_pinmux_config_node
parameter_list|(
name|struct
name|as3722_softc
modifier|*
name|sc
parameter_list|,
name|char
modifier|*
name|pin_name
parameter_list|,
name|struct
name|as3722_pincfg
modifier|*
name|cfg
parameter_list|)
block|{
name|uint8_t
name|ctrl
decl_stmt|;
name|int
name|rv
decl_stmt|,
name|fnc
decl_stmt|,
name|pin
decl_stmt|;
for|for
control|(
name|pin
operator|=
literal|0
init|;
name|pin
operator|<
name|sc
operator|->
name|gpio_npins
condition|;
name|pin
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|sc
operator|->
name|gpio_pins
index|[
name|pin
index|]
operator|->
name|pin_name
argument_list|,
name|pin_name
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|pin
operator|>=
name|sc
operator|->
name|gpio_npins
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Unknown pin: %s\n"
argument_list|,
name|pin_name
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|ctrl
operator|=
name|sc
operator|->
name|gpio_pins
index|[
name|pin
index|]
operator|->
name|pin_ctrl_reg
expr_stmt|;
name|sc
operator|->
name|gpio_pins
index|[
name|pin
index|]
operator|->
name|pin_cfg_flags
operator|=
name|cfg
operator|->
name|flags
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|function
operator|!=
name|NULL
condition|)
block|{
name|fnc
operator|=
name|as3722_pinmux_get_function
argument_list|(
name|sc
argument_list|,
name|cfg
operator|->
name|function
argument_list|)
expr_stmt|;
if|if
condition|(
name|fnc
operator|==
operator|-
literal|1
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Unknown function %s for pin %s\n"
argument_list|,
name|cfg
operator|->
name|function
argument_list|,
name|sc
operator|->
name|gpio_pins
index|[
name|pin
index|]
operator|->
name|pin_name
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
switch|switch
condition|(
name|fnc
condition|)
block|{
case|case
name|AS3722_IOSF_INTERRUPT_OUT
case|:
case|case
name|AS3722_IOSF_VSUP_VBAT_LOW_UNDEBOUNCE_OUT
case|:
case|case
name|AS3722_IOSF_OC_PG_SD0
case|:
case|case
name|AS3722_IOSF_POWERGOOD_OUT
case|:
case|case
name|AS3722_IOSF_CLK32K_OUT
case|:
case|case
name|AS3722_IOSF_PWM_OUT
case|:
case|case
name|AS3722_IOSF_OC_PG_SD6
case|:
name|ctrl
operator|&=
operator|~
operator|(
name|AS3722_GPIO_MODE_MASK
operator|<<
name|AS3722_GPIO_MODE_SHIFT
operator|)
expr_stmt|;
name|ctrl
operator||=
name|AS3722_MODE_PUSH_PULL
operator|<<
name|AS3722_GPIO_MODE_SHIFT
expr_stmt|;
comment|/* XXX Handle flags (OC + pullup) */
break|break;
case|case
name|AS3722_IOSF_GPIO_IN_INTERRUPT
case|:
case|case
name|AS3722_IOSF_PWM_IN
case|:
case|case
name|AS3722_IOSF_VOLTAGE_IN_STANDBY
case|:
case|case
name|AS3722_IOSF_WATCHDOG_IN
case|:
case|case
name|AS3722_IOSF_SOFT_RESET_IN
case|:
name|ctrl
operator|&=
operator|~
operator|(
name|AS3722_GPIO_MODE_MASK
operator|<<
name|AS3722_GPIO_MODE_SHIFT
operator|)
expr_stmt|;
name|ctrl
operator||=
name|AS3722_MODE_INPUT
operator|<<
name|AS3722_GPIO_MODE_SHIFT
expr_stmt|;
comment|/* XXX Handle flags (pulldown + pullup) */
default|default:
break|break;
block|}
name|ctrl
operator|&=
operator|~
operator|(
name|AS3722_GPIO_IOSF_MASK
operator|<<
name|AS3722_GPIO_IOSF_SHIFT
operator|)
expr_stmt|;
name|ctrl
operator||=
name|fnc
operator|<<
name|AS3722_GPIO_IOSF_SHIFT
expr_stmt|;
block|}
name|rv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ctrl
operator|!=
name|sc
operator|->
name|gpio_pins
index|[
name|pin
index|]
operator|->
name|pin_ctrl_reg
condition|)
block|{
name|rv
operator|=
name|WR1
argument_list|(
name|sc
argument_list|,
name|AS3722_GPIO0_CONTROL
operator|+
name|pin
argument_list|,
name|ctrl
argument_list|)
expr_stmt|;
name|sc
operator|->
name|gpio_pins
index|[
name|pin
index|]
operator|->
name|pin_ctrl_reg
operator|=
name|ctrl
expr_stmt|;
block|}
return|return
operator|(
name|rv
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|as3722_pinmux_read_node
parameter_list|(
name|struct
name|as3722_softc
modifier|*
name|sc
parameter_list|,
name|phandle_t
name|node
parameter_list|,
name|struct
name|as3722_pincfg
modifier|*
name|cfg
parameter_list|,
name|char
modifier|*
modifier|*
name|pins
parameter_list|,
name|int
modifier|*
name|lpins
parameter_list|)
block|{
name|int
name|rv
decl_stmt|,
name|i
decl_stmt|;
operator|*
name|lpins
operator|=
name|OF_getprop_alloc
argument_list|(
name|node
argument_list|,
literal|"pins"
argument_list|,
literal|1
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
name|pins
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|lpins
operator|<=
literal|0
condition|)
return|return
operator|(
name|ENOENT
operator|)
return|;
comment|/* Read function (mux) settings. */
name|rv
operator|=
name|OF_getprop_alloc
argument_list|(
name|node
argument_list|,
literal|"function"
argument_list|,
literal|1
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|cfg
operator|->
name|function
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|<=
literal|0
condition|)
name|cfg
operator|->
name|function
operator|=
name|NULL
expr_stmt|;
comment|/* Read boolean properties. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nitems
argument_list|(
name|as3722_cfg_names
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|OF_hasprop
argument_list|(
name|node
argument_list|,
name|as3722_cfg_names
index|[
name|i
index|]
operator|.
name|name
argument_list|)
condition|)
name|cfg
operator|->
name|flags
operator||=
name|as3722_cfg_names
index|[
name|i
index|]
operator|.
name|config
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|as3722_pinmux_process_node
parameter_list|(
name|struct
name|as3722_softc
modifier|*
name|sc
parameter_list|,
name|phandle_t
name|node
parameter_list|)
block|{
name|struct
name|as3722_pincfg
name|cfg
decl_stmt|;
name|char
modifier|*
name|pins
decl_stmt|,
modifier|*
name|pname
decl_stmt|;
name|int
name|i
decl_stmt|,
name|len
decl_stmt|,
name|lpins
decl_stmt|,
name|rv
decl_stmt|;
name|rv
operator|=
name|as3722_pinmux_read_node
argument_list|(
name|sc
argument_list|,
name|node
argument_list|,
operator|&
name|cfg
argument_list|,
operator|&
name|pins
argument_list|,
operator|&
name|lpins
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
return|return
operator|(
name|rv
operator|)
return|;
name|len
operator|=
literal|0
expr_stmt|;
name|pname
operator|=
name|pins
expr_stmt|;
do|do
block|{
name|i
operator|=
name|strlen
argument_list|(
name|pname
argument_list|)
operator|+
literal|1
expr_stmt|;
name|rv
operator|=
name|as3722_pinmux_config_node
argument_list|(
name|sc
argument_list|,
name|pname
argument_list|,
operator|&
name|cfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot configure pin: %s: %d\n"
argument_list|,
name|pname
argument_list|,
name|rv
argument_list|)
expr_stmt|;
block|}
name|len
operator|+=
name|i
expr_stmt|;
name|pname
operator|+=
name|i
expr_stmt|;
block|}
do|while
condition|(
name|len
operator|<
name|lpins
condition|)
do|;
if|if
condition|(
name|pins
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|pins
argument_list|,
name|M_OFWPROP
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg
operator|.
name|function
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|cfg
operator|.
name|function
argument_list|,
name|M_OFWPROP
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
end_function

begin_function
name|int
name|as3722_pinmux_configure
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|phandle_t
name|cfgxref
parameter_list|)
block|{
name|struct
name|as3722_softc
modifier|*
name|sc
decl_stmt|;
name|phandle_t
name|node
decl_stmt|,
name|cfgnode
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|cfgnode
operator|=
name|OF_node_from_xref
argument_list|(
name|cfgxref
argument_list|)
expr_stmt|;
for|for
control|(
name|node
operator|=
name|OF_child
argument_list|(
name|cfgnode
argument_list|)
init|;
name|node
operator|!=
literal|0
condition|;
name|node
operator|=
name|OF_peer
argument_list|(
name|node
argument_list|)
control|)
block|{
if|if
condition|(
operator|!
name|fdt_is_enabled
argument_list|(
name|node
argument_list|)
condition|)
continue|continue;
name|rv
operator|=
name|as3722_pinmux_process_node
argument_list|(
name|sc
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Failed to process pinmux"
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* --------------------------------------------------------------------------  *  *  GPIO  */
end_comment

begin_function
name|device_t
name|as3722_gpio_get_bus
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|as3722_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|sc
operator|->
name|gpio_busdev
operator|)
return|;
block|}
end_function

begin_function
name|int
name|as3722_gpio_pin_max
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
modifier|*
name|maxpin
parameter_list|)
block|{
operator|*
name|maxpin
operator|=
name|NGPIO
operator|-
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|as3722_gpio_pin_getcaps
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|uint32_t
name|pin
parameter_list|,
name|uint32_t
modifier|*
name|caps
parameter_list|)
block|{
name|struct
name|as3722_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|pin
operator|>=
name|sc
operator|->
name|gpio_npins
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|GPIO_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
operator|*
name|caps
operator|=
name|sc
operator|->
name|gpio_pins
index|[
name|pin
index|]
operator|->
name|pin_caps
expr_stmt|;
name|GPIO_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|as3722_gpio_pin_getname
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|uint32_t
name|pin
parameter_list|,
name|char
modifier|*
name|name
parameter_list|)
block|{
name|struct
name|as3722_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|pin
operator|>=
name|sc
operator|->
name|gpio_npins
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|GPIO_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|name
argument_list|,
name|sc
operator|->
name|gpio_pins
index|[
name|pin
index|]
operator|->
name|pin_name
argument_list|,
name|GPIOMAXNAME
argument_list|)
expr_stmt|;
name|GPIO_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|as3722_gpio_pin_getflags
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|uint32_t
name|pin
parameter_list|,
name|uint32_t
modifier|*
name|out_flags
parameter_list|)
block|{
name|struct
name|as3722_softc
modifier|*
name|sc
decl_stmt|;
name|uint8_t
name|tmp
decl_stmt|,
name|mode
decl_stmt|,
name|iosf
decl_stmt|;
name|uint32_t
name|flags
decl_stmt|;
name|bool
name|inverted
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|pin
operator|>=
name|sc
operator|->
name|gpio_npins
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|GPIO_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|sc
operator|->
name|gpio_pins
index|[
name|pin
index|]
operator|->
name|pin_ctrl_reg
expr_stmt|;
name|GPIO_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|iosf
operator|=
operator|(
name|tmp
operator|>>
name|AS3722_GPIO_IOSF_SHIFT
operator|)
operator|&
name|AS3722_GPIO_IOSF_MASK
expr_stmt|;
name|mode
operator|=
operator|(
name|tmp
operator|>>
name|AS3722_GPIO_MODE_SHIFT
operator|)
operator|&
name|AS3722_GPIO_MODE_MASK
expr_stmt|;
name|inverted
operator|=
operator|(
name|tmp
operator|&
name|AS3722_GPIO_INVERT
operator|)
operator|!=
literal|0
expr_stmt|;
comment|/* Is pin in GPIO mode ? */
if|if
condition|(
name|iosf
operator|!=
name|AS3722_IOSF_GPIO
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|flags
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|AS3722_MODE_INPUT
case|:
name|flags
operator|=
name|GPIO_PIN_INPUT
expr_stmt|;
break|break;
case|case
name|AS3722_MODE_PUSH_PULL
case|:
case|case
name|AS3722_MODE_PUSH_PULL_LV
case|:
name|flags
operator|=
name|GPIO_PIN_OUTPUT
expr_stmt|;
break|break;
case|case
name|AS3722_MODE_OPEN_DRAIN
case|:
case|case
name|AS3722_MODE_OPEN_DRAIN_LV
case|:
name|flags
operator|=
name|GPIO_PIN_INPUT
operator||
name|GPIO_PIN_OUTPUT
operator||
name|GPIO_PIN_OPENDRAIN
expr_stmt|;
break|break;
case|case
name|AS3722_MODE_TRISTATE
case|:
name|flags
operator|=
name|GPIO_PIN_TRISTATE
expr_stmt|;
break|break;
case|case
name|AS3722_MODE_INPUT_PULL_UP_LV
case|:
name|flags
operator|=
name|GPIO_PIN_INPUT
operator||
name|GPIO_PIN_PULLUP
expr_stmt|;
break|break;
case|case
name|AS3722_MODE_INPUT_PULL_DOWN
case|:
name|flags
operator|=
name|GPIO_PIN_OUTPUT
operator||
name|GPIO_PIN_PULLDOWN
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|inverted
condition|)
name|flags
operator||=
name|GPIO_PIN_INVIN
operator||
name|GPIO_PIN_INVOUT
expr_stmt|;
operator|*
name|out_flags
operator|=
name|flags
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|as3722_gpio_get_mode
parameter_list|(
name|struct
name|as3722_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|pin
parameter_list|,
name|uint32_t
name|gpio_flags
parameter_list|)
block|{
name|uint8_t
name|ctrl
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|ctrl
operator|=
name|sc
operator|->
name|gpio_pins
index|[
name|pin
index|]
operator|->
name|pin_ctrl_reg
expr_stmt|;
name|flags
operator|=
name|sc
operator|->
name|gpio_pins
index|[
name|pin
index|]
operator|->
name|pin_cfg_flags
expr_stmt|;
comment|/* Tristate mode. */
if|if
condition|(
name|flags
operator|&
name|AS3722_CFG_BIAS_HIGH_IMPEDANCE
operator|||
name|gpio_flags
operator|&
name|GPIO_PIN_TRISTATE
condition|)
return|return
operator|(
name|AS3722_MODE_TRISTATE
operator|)
return|;
comment|/* Open drain modes. */
if|if
condition|(
name|flags
operator|&
name|AS3722_CFG_OPEN_DRAIN
operator|||
name|gpio_flags
operator|&
name|GPIO_PIN_OPENDRAIN
condition|)
block|{
comment|/* Only pull up have effect */
if|if
condition|(
name|flags
operator|&
name|AS3722_CFG_BIAS_PULL_UP
operator|||
name|gpio_flags
operator|&
name|GPIO_PIN_PULLUP
condition|)
return|return
operator|(
name|AS3722_MODE_OPEN_DRAIN_LV
operator|)
return|;
return|return
operator|(
name|AS3722_MODE_OPEN_DRAIN
operator|)
return|;
block|}
comment|/* Input modes. */
if|if
condition|(
name|gpio_flags
operator|&
name|GPIO_PIN_INPUT
condition|)
block|{
comment|/* Accept pull up or pull down. */
if|if
condition|(
name|flags
operator|&
name|AS3722_CFG_BIAS_PULL_UP
operator|||
name|gpio_flags
operator|&
name|GPIO_PIN_PULLUP
condition|)
return|return
operator|(
name|AS3722_MODE_INPUT_PULL_UP_LV
operator|)
return|;
if|if
condition|(
name|flags
operator|&
name|AS3722_CFG_BIAS_PULL_DOWN
operator|||
name|gpio_flags
operator|&
name|GPIO_PIN_PULLDOWN
condition|)
return|return
operator|(
name|AS3722_MODE_INPUT_PULL_DOWN
operator|)
return|;
return|return
operator|(
name|AS3722_MODE_INPUT
operator|)
return|;
block|}
comment|/* 	 * Output modes. 	 * Pull down is used as indicator of low voltage output. 	 */
if|if
condition|(
name|flags
operator|&
name|AS3722_CFG_BIAS_PULL_DOWN
operator|||
name|gpio_flags
operator|&
name|GPIO_PIN_PULLDOWN
condition|)
return|return
operator|(
name|AS3722_MODE_PUSH_PULL_LV
operator|)
return|;
return|return
operator|(
name|AS3722_MODE_PUSH_PULL
operator|)
return|;
block|}
end_function

begin_function
name|int
name|as3722_gpio_pin_setflags
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|uint32_t
name|pin
parameter_list|,
name|uint32_t
name|flags
parameter_list|)
block|{
name|struct
name|as3722_softc
modifier|*
name|sc
decl_stmt|;
name|uint8_t
name|ctrl
decl_stmt|,
name|mode
decl_stmt|,
name|iosf
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|pin
operator|>=
name|sc
operator|->
name|gpio_npins
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|GPIO_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ctrl
operator|=
name|sc
operator|->
name|gpio_pins
index|[
name|pin
index|]
operator|->
name|pin_ctrl_reg
expr_stmt|;
name|iosf
operator|=
operator|(
name|ctrl
operator|>>
name|AS3722_GPIO_IOSF_SHIFT
operator|)
operator|&
name|AS3722_GPIO_IOSF_MASK
expr_stmt|;
comment|/* Is pin in GPIO mode ? */
if|if
condition|(
name|iosf
operator|!=
name|AS3722_IOSF_GPIO
condition|)
block|{
name|GPIO_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|mode
operator|=
name|as3722_gpio_get_mode
argument_list|(
name|sc
argument_list|,
name|pin
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|ctrl
operator|&=
operator|~
operator|(
name|AS3722_GPIO_MODE_MASK
operator|<<
name|AS3722_GPIO_MODE_SHIFT
operator|)
expr_stmt|;
name|ctrl
operator||=
name|AS3722_MODE_PUSH_PULL
operator|<<
name|AS3722_GPIO_MODE_SHIFT
expr_stmt|;
name|rv
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ctrl
operator|!=
name|sc
operator|->
name|gpio_pins
index|[
name|pin
index|]
operator|->
name|pin_ctrl_reg
condition|)
block|{
name|rv
operator|=
name|WR1
argument_list|(
name|sc
argument_list|,
name|AS3722_GPIO0_CONTROL
operator|+
name|pin
argument_list|,
name|ctrl
argument_list|)
expr_stmt|;
name|sc
operator|->
name|gpio_pins
index|[
name|pin
index|]
operator|->
name|pin_ctrl_reg
operator|=
name|ctrl
expr_stmt|;
block|}
name|GPIO_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
end_function

begin_function
name|int
name|as3722_gpio_pin_set
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|uint32_t
name|pin
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|struct
name|as3722_softc
modifier|*
name|sc
decl_stmt|;
name|uint8_t
name|tmp
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|pin
operator|>=
name|sc
operator|->
name|gpio_npins
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|tmp
operator|=
operator|(
name|val
operator|!=
literal|0
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|gpio_pins
index|[
name|pin
index|]
operator|->
name|pin_ctrl_reg
operator|&
name|AS3722_GPIO_INVERT
condition|)
name|tmp
operator|^=
literal|1
expr_stmt|;
name|GPIO_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rv
operator|=
name|RM1
argument_list|(
name|sc
argument_list|,
name|AS3722_GPIO_SIGNAL_OUT
argument_list|,
operator|(
literal|1
operator|<<
name|pin
operator|)
argument_list|,
operator|(
name|tmp
operator|<<
name|pin
operator|)
argument_list|)
expr_stmt|;
name|GPIO_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
end_function

begin_function
name|int
name|as3722_gpio_pin_get
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|uint32_t
name|pin
parameter_list|,
name|uint32_t
modifier|*
name|val
parameter_list|)
block|{
name|struct
name|as3722_softc
modifier|*
name|sc
decl_stmt|;
name|uint8_t
name|tmp
decl_stmt|,
name|mode
decl_stmt|,
name|ctrl
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|pin
operator|>=
name|sc
operator|->
name|gpio_npins
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|GPIO_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ctrl
operator|=
name|sc
operator|->
name|gpio_pins
index|[
name|pin
index|]
operator|->
name|pin_ctrl_reg
expr_stmt|;
name|mode
operator|=
operator|(
name|ctrl
operator|>>
name|AS3722_GPIO_MODE_SHIFT
operator|)
operator|&
name|AS3722_GPIO_MODE_MASK
expr_stmt|;
if|if
condition|(
operator|(
name|mode
operator|==
name|AS3722_MODE_PUSH_PULL
operator|)
operator|||
operator|(
name|mode
operator|==
name|AS3722_MODE_PUSH_PULL_LV
operator|)
condition|)
name|rv
operator|=
name|RD1
argument_list|(
name|sc
argument_list|,
name|AS3722_GPIO_SIGNAL_OUT
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
else|else
name|rv
operator|=
name|RD1
argument_list|(
name|sc
argument_list|,
name|AS3722_GPIO_SIGNAL_IN
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|GPIO_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
return|return
operator|(
name|rv
operator|)
return|;
operator|*
name|val
operator|=
name|tmp
operator|&
operator|(
literal|1
operator|<<
name|pin
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|ctrl
operator|&
name|AS3722_GPIO_INVERT
condition|)
operator|*
name|val
operator|^=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|as3722_gpio_pin_toggle
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|uint32_t
name|pin
parameter_list|)
block|{
name|struct
name|as3722_softc
modifier|*
name|sc
decl_stmt|;
name|uint8_t
name|tmp
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|pin
operator|>=
name|sc
operator|->
name|gpio_npins
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|GPIO_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rv
operator|=
name|RD1
argument_list|(
name|sc
argument_list|,
name|AS3722_GPIO_SIGNAL_OUT
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|GPIO_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|rv
operator|)
return|;
block|}
name|tmp
operator|^=
operator|(
literal|1
operator|<<
name|pin
operator|)
expr_stmt|;
name|rv
operator|=
name|RM1
argument_list|(
name|sc
argument_list|,
name|AS3722_GPIO_SIGNAL_OUT
argument_list|,
operator|(
literal|1
operator|<<
name|pin
operator|)
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|GPIO_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|as3722_gpio_map_gpios
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|phandle_t
name|pdev
parameter_list|,
name|phandle_t
name|gparent
parameter_list|,
name|int
name|gcells
parameter_list|,
name|pcell_t
modifier|*
name|gpios
parameter_list|,
name|uint32_t
modifier|*
name|pin
parameter_list|,
name|uint32_t
modifier|*
name|flags
parameter_list|)
block|{
if|if
condition|(
name|gcells
operator|!=
literal|2
condition|)
return|return
operator|(
name|ERANGE
operator|)
return|;
operator|*
name|pin
operator|=
name|gpios
index|[
literal|0
index|]
expr_stmt|;
operator|*
name|flags
operator|=
name|gpios
index|[
literal|1
index|]
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|as3722_gpio_attach
parameter_list|(
name|struct
name|as3722_softc
modifier|*
name|sc
parameter_list|,
name|phandle_t
name|node
parameter_list|)
block|{
name|struct
name|as3722_gpio_pin
modifier|*
name|pin
decl_stmt|;
name|int
name|i
decl_stmt|,
name|rv
decl_stmt|;
name|sx_init
argument_list|(
operator|&
name|sc
operator|->
name|gpio_lock
argument_list|,
literal|"AS3722 GPIO lock"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|gpio_npins
operator|=
name|NGPIO
expr_stmt|;
name|sc
operator|->
name|gpio_pins
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|as3722_gpio_pin
operator|*
argument_list|)
operator|*
name|sc
operator|->
name|gpio_npins
argument_list|,
name|M_AS3722_GPIO
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|sc
operator|->
name|gpio_busdev
operator|=
name|gpiobus_attach_bus
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|gpio_busdev
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sc
operator|->
name|gpio_npins
condition|;
name|i
operator|++
control|)
block|{
name|sc
operator|->
name|gpio_pins
index|[
name|i
index|]
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|as3722_gpio_pin
argument_list|)
argument_list|,
name|M_AS3722_GPIO
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|pin
operator|=
name|sc
operator|->
name|gpio_pins
index|[
name|i
index|]
expr_stmt|;
name|sprintf
argument_list|(
name|pin
operator|->
name|pin_name
argument_list|,
literal|"gpio%d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|pin
operator|->
name|pin_caps
operator|=
name|GPIO_PIN_INPUT
operator||
name|GPIO_PIN_OUTPUT
operator||
name|GPIO_PIN_OPENDRAIN
operator||
name|GPIO_PIN_PUSHPULL
operator||
name|GPIO_PIN_TRISTATE
operator||
name|GPIO_PIN_PULLUP
operator||
name|GPIO_PIN_PULLDOWN
operator||
name|GPIO_PIN_INVIN
operator||
name|GPIO_PIN_INVOUT
expr_stmt|;
name|rv
operator|=
name|RD1
argument_list|(
name|sc
argument_list|,
name|AS3722_GPIO0_CONTROL
operator|+
name|i
argument_list|,
operator|&
name|pin
operator|->
name|pin_ctrl_reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Cannot read configuration for pin %s\n"
argument_list|,
name|sc
operator|->
name|gpio_pins
index|[
name|i
index|]
operator|->
name|pin_name
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


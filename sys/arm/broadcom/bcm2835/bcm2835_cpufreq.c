begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (C) 2013-2014 Daisuke Aoyama<aoyama@peach.ne.jp>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/cpu.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/sema.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpu.h>
end_include

begin_include
include|#
directive|include
file|<machine/intr.h>
end_include

begin_include
include|#
directive|include
file|<arm/broadcom/bcm2835/bcm2835_mbox.h>
end_include

begin_include
include|#
directive|include
file|<arm/broadcom/bcm2835/bcm2835_mbox_prop.h>
end_include

begin_include
include|#
directive|include
file|<arm/broadcom/bcm2835/bcm2835_vcbus.h>
end_include

begin_include
include|#
directive|include
file|"cpufreq_if.h"
end_include

begin_include
include|#
directive|include
file|"mbox_if.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|fmt
parameter_list|,
modifier|...
parameter_list|)
value|do {			\ 	printf("%s:%u: ", __func__, __LINE__);	\ 	printf(fmt, ##__VA_ARGS__);		\ } while (0)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|DPRINTF
parameter_list|(
name|fmt
parameter_list|,
modifier|...
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|HZ2MHZ
parameter_list|(
name|freq
parameter_list|)
value|((freq) / (1000 * 1000))
end_define

begin_define
define|#
directive|define
name|MHZ2HZ
parameter_list|(
name|freq
parameter_list|)
value|((freq) * (1000 * 1000))
end_define

begin_define
define|#
directive|define
name|OFFSET2MVOLT
parameter_list|(
name|val
parameter_list|)
value|(1200 + ((val) * 25))
end_define

begin_define
define|#
directive|define
name|MVOLT2OFFSET
parameter_list|(
name|val
parameter_list|)
value|(((val) - 1200) / 25)
end_define

begin_define
define|#
directive|define
name|DEFAULT_ARM_FREQUENCY
value|700
end_define

begin_define
define|#
directive|define
name|DEFAULT_CORE_FREQUENCY
value|250
end_define

begin_define
define|#
directive|define
name|DEFAULT_SDRAM_FREQUENCY
value|400
end_define

begin_define
define|#
directive|define
name|DEFAULT_LOWEST_FREQ
value|300
end_define

begin_define
define|#
directive|define
name|TRANSITION_LATENCY
value|1000
end_define

begin_define
define|#
directive|define
name|MIN_OVER_VOLTAGE
value|-16
end_define

begin_define
define|#
directive|define
name|MAX_OVER_VOLTAGE
value|6
end_define

begin_define
define|#
directive|define
name|MSG_ERROR
value|-999999999
end_define

begin_define
define|#
directive|define
name|MHZSTEP
value|100
end_define

begin_define
define|#
directive|define
name|HZSTEP
value|(MHZ2HZ(MHZSTEP))
end_define

begin_define
define|#
directive|define
name|TZ_ZEROC
value|2732
end_define

begin_define
define|#
directive|define
name|VC_LOCK
parameter_list|(
name|sc
parameter_list|)
value|do {			\ 		sema_wait(&vc_sema);		\ 	} while (0)
end_define

begin_define
define|#
directive|define
name|VC_UNLOCK
parameter_list|(
name|sc
parameter_list|)
value|do {			\ 		sema_post(&vc_sema);		\ 	} while (0)
end_define

begin_comment
comment|/* ARM->VC mailbox property semaphore */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|sema
name|vc_sema
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|sysctl_ctx_list
name|bcm2835_sysctl_ctx
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|bcm2835_cpufreq_softc
block|{
name|device_t
name|dev
decl_stmt|;
name|int
name|arm_max_freq
decl_stmt|;
name|int
name|arm_min_freq
decl_stmt|;
name|int
name|core_max_freq
decl_stmt|;
name|int
name|core_min_freq
decl_stmt|;
name|int
name|sdram_max_freq
decl_stmt|;
name|int
name|sdram_min_freq
decl_stmt|;
name|int
name|max_voltage_core
decl_stmt|;
name|int
name|min_voltage_core
decl_stmt|;
comment|/* the values written in mbox */
name|int
name|voltage_core
decl_stmt|;
name|int
name|voltage_sdram
decl_stmt|;
name|int
name|voltage_sdram_c
decl_stmt|;
name|int
name|voltage_sdram_i
decl_stmt|;
name|int
name|voltage_sdram_p
decl_stmt|;
name|int
name|turbo_mode
decl_stmt|;
comment|/* mbox buffer (physical address) */
name|bus_dma_tag_t
name|dma_tag
decl_stmt|;
name|bus_dmamap_t
name|dma_map
decl_stmt|;
name|bus_size_t
name|dma_size
decl_stmt|;
name|void
modifier|*
name|dma_buf
decl_stmt|;
name|bus_addr_t
name|dma_phys
decl_stmt|;
comment|/* initial hook for waiting mbox intr */
name|struct
name|intr_config_hook
name|init_hook
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|int
name|cpufreq_verbose
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.bcm2835.cpufreq.verbose"
argument_list|,
operator|&
name|cpufreq_verbose
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|cpufreq_lowest_freq
init|=
name|DEFAULT_LOWEST_FREQ
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"hw.bcm2835.cpufreq.lowest_freq"
argument_list|,
operator|&
name|cpufreq_lowest_freq
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|PROP_DEBUG
end_ifdef

begin_function
specifier|static
name|void
name|bcm2835_dump
parameter_list|(
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|int
name|len
parameter_list|)
block|{
specifier|const
name|uint8_t
modifier|*
name|p
init|=
operator|(
specifier|const
name|uint8_t
operator|*
operator|)
name|data
decl_stmt|;
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"dump @ %p:\n"
argument_list|,
name|data
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"%2.2x "
argument_list|,
name|p
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|%
literal|4
operator|)
operator|==
literal|3
condition|)
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|%
literal|16
operator|)
operator|==
literal|15
condition|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|bcm2835_mbox_call_prop
parameter_list|(
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|bcm2835_mbox_hdr
modifier|*
name|msg
init|=
operator|(
expr|struct
name|bcm2835_mbox_hdr
operator|*
operator|)
name|sc
operator|->
name|dma_buf
decl_stmt|;
name|struct
name|bcm2835_mbox_tag_hdr
modifier|*
name|tag
decl_stmt|,
modifier|*
name|last
decl_stmt|;
name|uint8_t
modifier|*
name|up
decl_stmt|;
name|device_t
name|mbox
decl_stmt|;
name|size_t
name|hdr_size
decl_stmt|;
name|int
name|idx
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* 	 * For multiple calls, locking is not here. The caller must have 	 * VC semaphore. 	 */
comment|/* get mbox device */
name|mbox
operator|=
name|devclass_get_device
argument_list|(
name|devclass_find
argument_list|(
literal|"mbox"
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbox
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"can't find mbox\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* go mailbox property */
ifdef|#
directive|ifdef
name|PROP_DEBUG
name|bcm2835_dump
argument_list|(
name|msg
argument_list|,
literal|64
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|dma_tag
argument_list|,
name|sc
operator|->
name|dma_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
operator||
name|BUS_DMASYNC_PREREAD
argument_list|)
expr_stmt|;
name|MBOX_WRITE
argument_list|(
name|mbox
argument_list|,
name|BCM2835_MBOX_CHAN_PROP
argument_list|,
operator|(
name|uint32_t
operator|)
name|sc
operator|->
name|dma_phys
argument_list|)
expr_stmt|;
name|MBOX_READ
argument_list|(
name|mbox
argument_list|,
name|BCM2835_MBOX_CHAN_PROP
argument_list|,
operator|&
name|err
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|dma_tag
argument_list|,
name|sc
operator|->
name|dma_map
argument_list|,
name|BUS_DMASYNC_POSTREAD
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|PROP_DEBUG
name|bcm2835_dump
argument_list|(
name|msg
argument_list|,
literal|64
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* check response code */
if|if
condition|(
name|msg
operator|->
name|code
operator|!=
name|BCM2835_MBOX_CODE_RESP_SUCCESS
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"mbox response error\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* tag = first tag */
name|up
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|msg
expr_stmt|;
name|hdr_size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|bcm2835_mbox_hdr
argument_list|)
expr_stmt|;
name|tag
operator|=
operator|(
expr|struct
name|bcm2835_mbox_tag_hdr
operator|*
operator|)
operator|(
name|up
operator|+
name|hdr_size
operator|)
expr_stmt|;
comment|/* last = end of buffer specified by header */
name|last
operator|=
operator|(
expr|struct
name|bcm2835_mbox_tag_hdr
operator|*
operator|)
operator|(
name|up
operator|+
name|msg
operator|->
name|buf_size
operator|)
expr_stmt|;
comment|/* loop unitl end tag (=0x0) */
name|hdr_size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|bcm2835_mbox_tag_hdr
argument_list|)
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|tag
operator|->
name|tag
operator|!=
literal|0
condition|;
name|idx
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|tag
operator|->
name|val_len
operator|&
name|BCM2835_MBOX_TAG_VAL_LEN_RESPONSE
operator|)
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"tag%d response error\n"
argument_list|,
name|idx
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* clear response bit */
name|tag
operator|->
name|val_len
operator|&=
operator|~
name|BCM2835_MBOX_TAG_VAL_LEN_RESPONSE
expr_stmt|;
comment|/* get next tag */
name|up
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|tag
expr_stmt|;
name|tag
operator|=
operator|(
expr|struct
name|bcm2835_mbox_tag_hdr
operator|*
operator|)
operator|(
name|up
operator|+
name|hdr_size
operator|+
name|tag
operator|->
name|val_buf_size
operator|)
expr_stmt|;
comment|/* check buffer size of header */
if|if
condition|(
name|tag
operator|>
name|last
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"mbox buffer size error\n"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm2835_cpufreq_get_clock_rate
parameter_list|(
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|clock_id
parameter_list|)
block|{
name|struct
name|msg_get_clock_rate
modifier|*
name|msg
decl_stmt|;
name|int
name|rate
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* 	 * Get clock rate 	 *   Tag: 0x00030002 	 *   Request: 	 *     Length: 4 	 *     Value: 	 *       u32: clock id 	 *   Response: 	 *     Length: 8 	 *     Value: 	 *       u32: clock id 	 *       u32: rate (in Hz) 	 */
comment|/* using DMA buffer for VC */
name|msg
operator|=
operator|(
expr|struct
name|msg_get_clock_rate
operator|*
operator|)
name|sc
operator|->
name|dma_buf
expr_stmt|;
if|if
condition|(
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
operator|>
name|sc
operator|->
name|dma_size
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"DMA size overflow (%zu>%lu)\n"
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|,
name|sc
operator|->
name|dma_size
argument_list|)
expr_stmt|;
return|return
operator|(
name|MSG_ERROR
operator|)
return|;
block|}
comment|/* setup single tag buffer */
name|memset
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|hdr
operator|.
name|buf_size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|->
name|hdr
operator|.
name|code
operator|=
name|BCM2835_MBOX_CODE_REQ
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|tag
operator|=
name|BCM2835_MBOX_TAG_GET_CLOCK_RATE
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|val_buf_size
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|body
argument_list|)
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|val_len
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|body
operator|.
name|req
argument_list|)
expr_stmt|;
name|msg
operator|->
name|body
operator|.
name|req
operator|.
name|clock_id
operator|=
name|clock_id
expr_stmt|;
name|msg
operator|->
name|end_tag
operator|=
literal|0
expr_stmt|;
comment|/* call mailbox property */
name|err
operator|=
name|bcm2835_mbox_call_prop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"can't get clock rate (id=%u)\n"
argument_list|,
name|clock_id
argument_list|)
expr_stmt|;
return|return
operator|(
name|MSG_ERROR
operator|)
return|;
block|}
comment|/* result (Hz) */
name|rate
operator|=
operator|(
name|int
operator|)
name|msg
operator|->
name|body
operator|.
name|resp
operator|.
name|rate_hz
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"clock = %d(Hz)\n"
argument_list|,
name|rate
argument_list|)
expr_stmt|;
return|return
operator|(
name|rate
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm2835_cpufreq_get_max_clock_rate
parameter_list|(
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|clock_id
parameter_list|)
block|{
name|struct
name|msg_get_max_clock_rate
modifier|*
name|msg
decl_stmt|;
name|int
name|rate
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* 	 * Get max clock rate 	 *   Tag: 0x00030004 	 *   Request: 	 *     Length: 4 	 *     Value: 	 *       u32: clock id 	 *   Response: 	 *     Length: 8 	 *     Value: 	 *       u32: clock id 	 *       u32: rate (in Hz) 	 */
comment|/* using DMA buffer for VC */
name|msg
operator|=
operator|(
expr|struct
name|msg_get_max_clock_rate
operator|*
operator|)
name|sc
operator|->
name|dma_buf
expr_stmt|;
if|if
condition|(
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
operator|>
name|sc
operator|->
name|dma_size
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"DMA size overflow (%zu>%lu)\n"
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|,
name|sc
operator|->
name|dma_size
argument_list|)
expr_stmt|;
return|return
operator|(
name|MSG_ERROR
operator|)
return|;
block|}
comment|/* setup single tag buffer */
name|memset
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|hdr
operator|.
name|buf_size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|->
name|hdr
operator|.
name|code
operator|=
name|BCM2835_MBOX_CODE_REQ
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|tag
operator|=
name|BCM2835_MBOX_TAG_GET_MAX_CLOCK_RATE
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|val_buf_size
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|body
argument_list|)
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|val_len
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|body
operator|.
name|req
argument_list|)
expr_stmt|;
name|msg
operator|->
name|body
operator|.
name|req
operator|.
name|clock_id
operator|=
name|clock_id
expr_stmt|;
name|msg
operator|->
name|end_tag
operator|=
literal|0
expr_stmt|;
comment|/* call mailbox property */
name|err
operator|=
name|bcm2835_mbox_call_prop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"can't get max clock rate (id=%u)\n"
argument_list|,
name|clock_id
argument_list|)
expr_stmt|;
return|return
operator|(
name|MSG_ERROR
operator|)
return|;
block|}
comment|/* result (Hz) */
name|rate
operator|=
operator|(
name|int
operator|)
name|msg
operator|->
name|body
operator|.
name|resp
operator|.
name|rate_hz
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"clock = %d(Hz)\n"
argument_list|,
name|rate
argument_list|)
expr_stmt|;
return|return
operator|(
name|rate
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm2835_cpufreq_get_min_clock_rate
parameter_list|(
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|clock_id
parameter_list|)
block|{
name|struct
name|msg_get_min_clock_rate
modifier|*
name|msg
decl_stmt|;
name|int
name|rate
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* 	 * Get min clock rate 	 *   Tag: 0x00030007 	 *   Request: 	 *     Length: 4 	 *     Value: 	 *       u32: clock id 	 *   Response: 	 *     Length: 8 	 *     Value: 	 *       u32: clock id 	 *       u32: rate (in Hz) 	 */
comment|/* using DMA buffer for VC */
name|msg
operator|=
operator|(
expr|struct
name|msg_get_min_clock_rate
operator|*
operator|)
name|sc
operator|->
name|dma_buf
expr_stmt|;
if|if
condition|(
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
operator|>
name|sc
operator|->
name|dma_size
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"DMA size overflow (%zu>%lu)\n"
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|,
name|sc
operator|->
name|dma_size
argument_list|)
expr_stmt|;
return|return
operator|(
name|MSG_ERROR
operator|)
return|;
block|}
comment|/* setup single tag buffer */
name|memset
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|hdr
operator|.
name|buf_size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|->
name|hdr
operator|.
name|code
operator|=
name|BCM2835_MBOX_CODE_REQ
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|tag
operator|=
name|BCM2835_MBOX_TAG_GET_MIN_CLOCK_RATE
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|val_buf_size
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|body
argument_list|)
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|val_len
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|body
operator|.
name|req
argument_list|)
expr_stmt|;
name|msg
operator|->
name|body
operator|.
name|req
operator|.
name|clock_id
operator|=
name|clock_id
expr_stmt|;
name|msg
operator|->
name|end_tag
operator|=
literal|0
expr_stmt|;
comment|/* call mailbox property */
name|err
operator|=
name|bcm2835_mbox_call_prop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"can't get min clock rate (id=%u)\n"
argument_list|,
name|clock_id
argument_list|)
expr_stmt|;
return|return
operator|(
name|MSG_ERROR
operator|)
return|;
block|}
comment|/* result (Hz) */
name|rate
operator|=
operator|(
name|int
operator|)
name|msg
operator|->
name|body
operator|.
name|resp
operator|.
name|rate_hz
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"clock = %d(Hz)\n"
argument_list|,
name|rate
argument_list|)
expr_stmt|;
return|return
operator|(
name|rate
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm2835_cpufreq_set_clock_rate
parameter_list|(
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|clock_id
parameter_list|,
name|uint32_t
name|rate_hz
parameter_list|)
block|{
name|struct
name|msg_set_clock_rate
modifier|*
name|msg
decl_stmt|;
name|int
name|rate
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* 	 * Set clock rate 	 *   Tag: 0x00038002 	 *   Request: 	 *     Length: 8 	 *     Value: 	 *       u32: clock id 	 *       u32: rate (in Hz) 	 *   Response: 	 *     Length: 8 	 *     Value: 	 *       u32: clock id 	 *       u32: rate (in Hz) 	 */
comment|/* using DMA buffer for VC */
name|msg
operator|=
operator|(
expr|struct
name|msg_set_clock_rate
operator|*
operator|)
name|sc
operator|->
name|dma_buf
expr_stmt|;
if|if
condition|(
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
operator|>
name|sc
operator|->
name|dma_size
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"DMA size overflow (%zu>%lu)\n"
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|,
name|sc
operator|->
name|dma_size
argument_list|)
expr_stmt|;
return|return
operator|(
name|MSG_ERROR
operator|)
return|;
block|}
comment|/* setup single tag buffer */
name|memset
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|hdr
operator|.
name|buf_size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|->
name|hdr
operator|.
name|code
operator|=
name|BCM2835_MBOX_CODE_REQ
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|tag
operator|=
name|BCM2835_MBOX_TAG_SET_CLOCK_RATE
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|val_buf_size
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|body
argument_list|)
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|val_len
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|body
operator|.
name|req
argument_list|)
expr_stmt|;
name|msg
operator|->
name|body
operator|.
name|req
operator|.
name|clock_id
operator|=
name|clock_id
expr_stmt|;
name|msg
operator|->
name|body
operator|.
name|req
operator|.
name|rate_hz
operator|=
name|rate_hz
expr_stmt|;
name|msg
operator|->
name|end_tag
operator|=
literal|0
expr_stmt|;
comment|/* call mailbox property */
name|err
operator|=
name|bcm2835_mbox_call_prop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"can't set clock rate (id=%u)\n"
argument_list|,
name|clock_id
argument_list|)
expr_stmt|;
return|return
operator|(
name|MSG_ERROR
operator|)
return|;
block|}
comment|/* workaround for core clock */
if|if
condition|(
name|clock_id
operator|==
name|BCM2835_MBOX_CLOCK_ID_CORE
condition|)
block|{
comment|/* for safety (may change voltage without changing clock) */
name|DELAY
argument_list|(
name|TRANSITION_LATENCY
argument_list|)
expr_stmt|;
comment|/* 		 * XXX: the core clock is unable to change at once, 		 * to change certainly, write it twice now. 		 */
comment|/* setup single tag buffer */
name|memset
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|hdr
operator|.
name|buf_size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|->
name|hdr
operator|.
name|code
operator|=
name|BCM2835_MBOX_CODE_REQ
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|tag
operator|=
name|BCM2835_MBOX_TAG_SET_CLOCK_RATE
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|val_buf_size
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|body
argument_list|)
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|val_len
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|body
operator|.
name|req
argument_list|)
expr_stmt|;
name|msg
operator|->
name|body
operator|.
name|req
operator|.
name|clock_id
operator|=
name|clock_id
expr_stmt|;
name|msg
operator|->
name|body
operator|.
name|req
operator|.
name|rate_hz
operator|=
name|rate_hz
expr_stmt|;
name|msg
operator|->
name|end_tag
operator|=
literal|0
expr_stmt|;
comment|/* call mailbox property */
name|err
operator|=
name|bcm2835_mbox_call_prop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"can't set clock rate (id=%u)\n"
argument_list|,
name|clock_id
argument_list|)
expr_stmt|;
return|return
operator|(
name|MSG_ERROR
operator|)
return|;
block|}
block|}
comment|/* result (Hz) */
name|rate
operator|=
operator|(
name|int
operator|)
name|msg
operator|->
name|body
operator|.
name|resp
operator|.
name|rate_hz
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"clock = %d(Hz)\n"
argument_list|,
name|rate
argument_list|)
expr_stmt|;
return|return
operator|(
name|rate
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm2835_cpufreq_get_turbo
parameter_list|(
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|msg_get_turbo
modifier|*
name|msg
decl_stmt|;
name|int
name|level
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* 	 * Get turbo 	 *   Tag: 0x00030009 	 *   Request: 	 *     Length: 4 	 *     Value: 	 *       u32: id 	 *   Response: 	 *     Length: 8 	 *     Value: 	 *       u32: id 	 *       u32: level 	 */
comment|/* using DMA buffer for VC */
name|msg
operator|=
operator|(
expr|struct
name|msg_get_turbo
operator|*
operator|)
name|sc
operator|->
name|dma_buf
expr_stmt|;
if|if
condition|(
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
operator|>
name|sc
operator|->
name|dma_size
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"DMA size overflow (%zu>%lu)\n"
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|,
name|sc
operator|->
name|dma_size
argument_list|)
expr_stmt|;
return|return
operator|(
name|MSG_ERROR
operator|)
return|;
block|}
comment|/* setup single tag buffer */
name|memset
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|hdr
operator|.
name|buf_size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|->
name|hdr
operator|.
name|code
operator|=
name|BCM2835_MBOX_CODE_REQ
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|tag
operator|=
name|BCM2835_MBOX_TAG_GET_TURBO
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|val_buf_size
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|body
argument_list|)
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|val_len
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|body
operator|.
name|req
argument_list|)
expr_stmt|;
name|msg
operator|->
name|body
operator|.
name|req
operator|.
name|id
operator|=
literal|0
expr_stmt|;
name|msg
operator|->
name|end_tag
operator|=
literal|0
expr_stmt|;
comment|/* call mailbox property */
name|err
operator|=
name|bcm2835_mbox_call_prop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"can't get turbo\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|MSG_ERROR
operator|)
return|;
block|}
comment|/* result 0=non-turbo, 1=turbo */
name|level
operator|=
operator|(
name|int
operator|)
name|msg
operator|->
name|body
operator|.
name|resp
operator|.
name|level
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"level = %d\n"
argument_list|,
name|level
argument_list|)
expr_stmt|;
return|return
operator|(
name|level
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm2835_cpufreq_set_turbo
parameter_list|(
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|level
parameter_list|)
block|{
name|struct
name|msg_set_turbo
modifier|*
name|msg
decl_stmt|;
name|int
name|value
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* 	 * Set turbo 	 *   Tag: 0x00038009 	 *   Request: 	 *     Length: 8 	 *     Value: 	 *       u32: id 	 *       u32: level 	 *   Response: 	 *     Length: 8 	 *     Value: 	 *       u32: id 	 *       u32: level 	 */
comment|/* using DMA buffer for VC */
name|msg
operator|=
operator|(
expr|struct
name|msg_set_turbo
operator|*
operator|)
name|sc
operator|->
name|dma_buf
expr_stmt|;
if|if
condition|(
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
operator|>
name|sc
operator|->
name|dma_size
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"DMA size overflow (%zu>%lu)\n"
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|,
name|sc
operator|->
name|dma_size
argument_list|)
expr_stmt|;
return|return
operator|(
name|MSG_ERROR
operator|)
return|;
block|}
comment|/* replace unknown value to OFF */
if|if
condition|(
name|level
operator|!=
name|BCM2835_MBOX_TURBO_ON
operator|&&
name|level
operator|!=
name|BCM2835_MBOX_TURBO_OFF
condition|)
name|level
operator|=
name|BCM2835_MBOX_TURBO_OFF
expr_stmt|;
comment|/* setup single tag buffer */
name|memset
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|hdr
operator|.
name|buf_size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|->
name|hdr
operator|.
name|code
operator|=
name|BCM2835_MBOX_CODE_REQ
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|tag
operator|=
name|BCM2835_MBOX_TAG_SET_TURBO
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|val_buf_size
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|body
argument_list|)
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|val_len
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|body
operator|.
name|req
argument_list|)
expr_stmt|;
name|msg
operator|->
name|body
operator|.
name|req
operator|.
name|id
operator|=
literal|0
expr_stmt|;
name|msg
operator|->
name|body
operator|.
name|req
operator|.
name|level
operator|=
name|level
expr_stmt|;
name|msg
operator|->
name|end_tag
operator|=
literal|0
expr_stmt|;
comment|/* call mailbox property */
name|err
operator|=
name|bcm2835_mbox_call_prop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"can't set turbo\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|MSG_ERROR
operator|)
return|;
block|}
comment|/* result 0=non-turbo, 1=turbo */
name|value
operator|=
operator|(
name|int
operator|)
name|msg
operator|->
name|body
operator|.
name|resp
operator|.
name|level
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"level = %d\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
operator|(
name|value
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm2835_cpufreq_get_voltage
parameter_list|(
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|voltage_id
parameter_list|)
block|{
name|struct
name|msg_get_voltage
modifier|*
name|msg
decl_stmt|;
name|int
name|value
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* 	 * Get voltage 	 *   Tag: 0x00030003 	 *   Request: 	 *     Length: 4 	 *     Value: 	 *       u32: voltage id 	 *   Response: 	 *     Length: 8 	 *     Value: 	 *       u32: voltage id 	 *       u32: value (offset from 1.2V in units of 0.025V) 	 */
comment|/* using DMA buffer for VC */
name|msg
operator|=
operator|(
expr|struct
name|msg_get_voltage
operator|*
operator|)
name|sc
operator|->
name|dma_buf
expr_stmt|;
if|if
condition|(
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
operator|>
name|sc
operator|->
name|dma_size
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"DMA size overflow (%zu>%lu)\n"
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|,
name|sc
operator|->
name|dma_size
argument_list|)
expr_stmt|;
return|return
operator|(
name|MSG_ERROR
operator|)
return|;
block|}
comment|/* setup single tag buffer */
name|memset
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|hdr
operator|.
name|buf_size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|->
name|hdr
operator|.
name|code
operator|=
name|BCM2835_MBOX_CODE_REQ
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|tag
operator|=
name|BCM2835_MBOX_TAG_GET_VOLTAGE
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|val_buf_size
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|body
argument_list|)
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|val_len
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|body
operator|.
name|req
argument_list|)
expr_stmt|;
name|msg
operator|->
name|body
operator|.
name|req
operator|.
name|voltage_id
operator|=
name|voltage_id
expr_stmt|;
name|msg
operator|->
name|end_tag
operator|=
literal|0
expr_stmt|;
comment|/* call mailbox property */
name|err
operator|=
name|bcm2835_mbox_call_prop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"can't get voltage\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|MSG_ERROR
operator|)
return|;
block|}
comment|/* result (offset from 1.2V) */
name|value
operator|=
operator|(
name|int
operator|)
name|msg
operator|->
name|body
operator|.
name|resp
operator|.
name|value
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"value = %d\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
operator|(
name|value
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm2835_cpufreq_get_max_voltage
parameter_list|(
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|voltage_id
parameter_list|)
block|{
name|struct
name|msg_get_max_voltage
modifier|*
name|msg
decl_stmt|;
name|int
name|value
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* 	 * Get voltage 	 *   Tag: 0x00030005 	 *   Request: 	 *     Length: 4 	 *     Value: 	 *       u32: voltage id 	 *   Response: 	 *     Length: 8 	 *     Value: 	 *       u32: voltage id 	 *       u32: value (offset from 1.2V in units of 0.025V) 	 */
comment|/* using DMA buffer for VC */
name|msg
operator|=
operator|(
expr|struct
name|msg_get_max_voltage
operator|*
operator|)
name|sc
operator|->
name|dma_buf
expr_stmt|;
if|if
condition|(
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
operator|>
name|sc
operator|->
name|dma_size
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"DMA size overflow (%zu>%lu)\n"
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|,
name|sc
operator|->
name|dma_size
argument_list|)
expr_stmt|;
return|return
operator|(
name|MSG_ERROR
operator|)
return|;
block|}
comment|/* setup single tag buffer */
name|memset
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|hdr
operator|.
name|buf_size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|->
name|hdr
operator|.
name|code
operator|=
name|BCM2835_MBOX_CODE_REQ
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|tag
operator|=
name|BCM2835_MBOX_TAG_GET_MAX_VOLTAGE
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|val_buf_size
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|body
argument_list|)
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|val_len
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|body
operator|.
name|req
argument_list|)
expr_stmt|;
name|msg
operator|->
name|body
operator|.
name|req
operator|.
name|voltage_id
operator|=
name|voltage_id
expr_stmt|;
name|msg
operator|->
name|end_tag
operator|=
literal|0
expr_stmt|;
comment|/* call mailbox property */
name|err
operator|=
name|bcm2835_mbox_call_prop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"can't get max voltage\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|MSG_ERROR
operator|)
return|;
block|}
comment|/* result (offset from 1.2V) */
name|value
operator|=
operator|(
name|int
operator|)
name|msg
operator|->
name|body
operator|.
name|resp
operator|.
name|value
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"value = %d\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
operator|(
name|value
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm2835_cpufreq_get_min_voltage
parameter_list|(
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|voltage_id
parameter_list|)
block|{
name|struct
name|msg_get_min_voltage
modifier|*
name|msg
decl_stmt|;
name|int
name|value
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* 	 * Get voltage 	 *   Tag: 0x00030008 	 *   Request: 	 *     Length: 4 	 *     Value: 	 *       u32: voltage id 	 *   Response: 	 *     Length: 8 	 *     Value: 	 *       u32: voltage id 	 *       u32: value (offset from 1.2V in units of 0.025V) 	 */
comment|/* using DMA buffer for VC */
name|msg
operator|=
operator|(
expr|struct
name|msg_get_min_voltage
operator|*
operator|)
name|sc
operator|->
name|dma_buf
expr_stmt|;
if|if
condition|(
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
operator|>
name|sc
operator|->
name|dma_size
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"DMA size overflow (%zu>%lu)\n"
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|,
name|sc
operator|->
name|dma_size
argument_list|)
expr_stmt|;
return|return
operator|(
name|MSG_ERROR
operator|)
return|;
block|}
comment|/* setup single tag buffer */
name|memset
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|hdr
operator|.
name|buf_size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|->
name|hdr
operator|.
name|code
operator|=
name|BCM2835_MBOX_CODE_REQ
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|tag
operator|=
name|BCM2835_MBOX_TAG_GET_MIN_VOLTAGE
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|val_buf_size
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|body
argument_list|)
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|val_len
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|body
operator|.
name|req
argument_list|)
expr_stmt|;
name|msg
operator|->
name|body
operator|.
name|req
operator|.
name|voltage_id
operator|=
name|voltage_id
expr_stmt|;
name|msg
operator|->
name|end_tag
operator|=
literal|0
expr_stmt|;
comment|/* call mailbox property */
name|err
operator|=
name|bcm2835_mbox_call_prop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"can't get min voltage\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|MSG_ERROR
operator|)
return|;
block|}
comment|/* result (offset from 1.2V) */
name|value
operator|=
operator|(
name|int
operator|)
name|msg
operator|->
name|body
operator|.
name|resp
operator|.
name|value
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"value = %d\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
operator|(
name|value
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm2835_cpufreq_set_voltage
parameter_list|(
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|voltage_id
parameter_list|,
name|int32_t
name|value
parameter_list|)
block|{
name|struct
name|msg_set_voltage
modifier|*
name|msg
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* 	 * Set voltage 	 *   Tag: 0x00038003 	 *   Request: 	 *     Length: 4 	 *     Value: 	 *       u32: voltage id 	 *       u32: value (offset from 1.2V in units of 0.025V) 	 *   Response: 	 *     Length: 8 	 *     Value: 	 *       u32: voltage id 	 *       u32: value (offset from 1.2V in units of 0.025V) 	 */
comment|/* 	 * over_voltage: 	 * 0 (1.2 V). Values above 6 are only allowed when force_turbo or 	 * current_limit_override are specified (which set the warranty bit). 	 */
if|if
condition|(
name|value
operator|>
name|MAX_OVER_VOLTAGE
operator|||
name|value
operator|<
name|MIN_OVER_VOLTAGE
condition|)
block|{
comment|/* currently not supported */
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"not supported voltage: %d\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
operator|(
name|MSG_ERROR
operator|)
return|;
block|}
comment|/* using DMA buffer for VC */
name|msg
operator|=
operator|(
expr|struct
name|msg_set_voltage
operator|*
operator|)
name|sc
operator|->
name|dma_buf
expr_stmt|;
if|if
condition|(
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
operator|>
name|sc
operator|->
name|dma_size
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"DMA size overflow (%zu>%lu)\n"
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|,
name|sc
operator|->
name|dma_size
argument_list|)
expr_stmt|;
return|return
operator|(
name|MSG_ERROR
operator|)
return|;
block|}
comment|/* setup single tag buffer */
name|memset
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|hdr
operator|.
name|buf_size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|->
name|hdr
operator|.
name|code
operator|=
name|BCM2835_MBOX_CODE_REQ
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|tag
operator|=
name|BCM2835_MBOX_TAG_SET_VOLTAGE
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|val_buf_size
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|body
argument_list|)
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|val_len
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|body
operator|.
name|req
argument_list|)
expr_stmt|;
name|msg
operator|->
name|body
operator|.
name|req
operator|.
name|voltage_id
operator|=
name|voltage_id
expr_stmt|;
name|msg
operator|->
name|body
operator|.
name|req
operator|.
name|value
operator|=
operator|(
name|uint32_t
operator|)
name|value
expr_stmt|;
name|msg
operator|->
name|end_tag
operator|=
literal|0
expr_stmt|;
comment|/* call mailbox property */
name|err
operator|=
name|bcm2835_mbox_call_prop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"can't set voltage\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|MSG_ERROR
operator|)
return|;
block|}
comment|/* result (offset from 1.2V) */
name|value
operator|=
operator|(
name|int
operator|)
name|msg
operator|->
name|body
operator|.
name|resp
operator|.
name|value
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"value = %d\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
operator|(
name|value
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm2835_cpufreq_get_temperature
parameter_list|(
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|msg_get_temperature
modifier|*
name|msg
decl_stmt|;
name|int
name|value
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* 	 * Get temperature 	 *   Tag: 0x00030006 	 *   Request: 	 *     Length: 4 	 *     Value: 	 *       u32: temperature id 	 *   Response: 	 *     Length: 8 	 *     Value: 	 *       u32: temperature id 	 *       u32: value 	 */
comment|/* using DMA buffer for VC */
name|msg
operator|=
operator|(
expr|struct
name|msg_get_temperature
operator|*
operator|)
name|sc
operator|->
name|dma_buf
expr_stmt|;
if|if
condition|(
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
operator|>
name|sc
operator|->
name|dma_size
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"DMA size overflow (%zu>%lu)\n"
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|,
name|sc
operator|->
name|dma_size
argument_list|)
expr_stmt|;
return|return
operator|(
name|MSG_ERROR
operator|)
return|;
block|}
comment|/* setup single tag buffer */
name|memset
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|->
name|hdr
operator|.
name|buf_size
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|->
name|hdr
operator|.
name|code
operator|=
name|BCM2835_MBOX_CODE_REQ
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|tag
operator|=
name|BCM2835_MBOX_TAG_GET_TEMPERATURE
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|val_buf_size
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|body
argument_list|)
expr_stmt|;
name|msg
operator|->
name|tag_hdr
operator|.
name|val_len
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|body
operator|.
name|req
argument_list|)
expr_stmt|;
name|msg
operator|->
name|body
operator|.
name|req
operator|.
name|temperature_id
operator|=
literal|0
expr_stmt|;
name|msg
operator|->
name|end_tag
operator|=
literal|0
expr_stmt|;
comment|/* call mailbox property */
name|err
operator|=
name|bcm2835_mbox_call_prop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"can't get temperature\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|MSG_ERROR
operator|)
return|;
block|}
comment|/* result (temperature of degree C) */
name|value
operator|=
operator|(
name|int
operator|)
name|msg
operator|->
name|body
operator|.
name|resp
operator|.
name|value
expr_stmt|;
name|DPRINTF
argument_list|(
literal|"value = %d\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
operator|(
name|value
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sysctl_bcm2835_cpufreq_arm_freq
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
init|=
name|arg1
decl_stmt|;
name|int
name|val
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* get realtime value */
name|VC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|val
operator|=
name|bcm2835_cpufreq_get_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_ARM
argument_list|)
expr_stmt|;
name|VC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|MSG_ERROR
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|err
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|val
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
comment|/* error || read request */
return|return
operator|(
name|err
operator|)
return|;
comment|/* write request */
name|VC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|err
operator|=
name|bcm2835_cpufreq_set_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_ARM
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|VC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|MSG_ERROR
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"set clock arm_freq error\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|DELAY
argument_list|(
name|TRANSITION_LATENCY
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sysctl_bcm2835_cpufreq_core_freq
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
init|=
name|arg1
decl_stmt|;
name|int
name|val
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* get realtime value */
name|VC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|val
operator|=
name|bcm2835_cpufreq_get_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_CORE
argument_list|)
expr_stmt|;
name|VC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|MSG_ERROR
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|err
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|val
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
comment|/* error || read request */
return|return
operator|(
name|err
operator|)
return|;
comment|/* write request */
name|VC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|err
operator|=
name|bcm2835_cpufreq_set_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_CORE
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|MSG_ERROR
condition|)
block|{
name|VC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"set clock core_freq error\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|VC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|TRANSITION_LATENCY
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sysctl_bcm2835_cpufreq_sdram_freq
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
init|=
name|arg1
decl_stmt|;
name|int
name|val
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* get realtime value */
name|VC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|val
operator|=
name|bcm2835_cpufreq_get_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_SDRAM
argument_list|)
expr_stmt|;
name|VC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|MSG_ERROR
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|err
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|val
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
comment|/* error || read request */
return|return
operator|(
name|err
operator|)
return|;
comment|/* write request */
name|VC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|err
operator|=
name|bcm2835_cpufreq_set_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_SDRAM
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|VC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|MSG_ERROR
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"set clock sdram_freq error\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|DELAY
argument_list|(
name|TRANSITION_LATENCY
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sysctl_bcm2835_cpufreq_turbo
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
init|=
name|arg1
decl_stmt|;
name|int
name|val
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* get realtime value */
name|VC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|val
operator|=
name|bcm2835_cpufreq_get_turbo
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|VC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|MSG_ERROR
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|err
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|val
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
comment|/* error || read request */
return|return
operator|(
name|err
operator|)
return|;
comment|/* write request */
if|if
condition|(
name|val
operator|>
literal|0
condition|)
name|sc
operator|->
name|turbo_mode
operator|=
name|BCM2835_MBOX_TURBO_ON
expr_stmt|;
else|else
name|sc
operator|->
name|turbo_mode
operator|=
name|BCM2835_MBOX_TURBO_OFF
expr_stmt|;
name|VC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|err
operator|=
name|bcm2835_cpufreq_set_turbo
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|turbo_mode
argument_list|)
expr_stmt|;
name|VC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|MSG_ERROR
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"set turbo error\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|DELAY
argument_list|(
name|TRANSITION_LATENCY
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sysctl_bcm2835_cpufreq_voltage_core
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
init|=
name|arg1
decl_stmt|;
name|int
name|val
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* get realtime value */
name|VC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|val
operator|=
name|bcm2835_cpufreq_get_voltage
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_VOLTAGE_ID_CORE
argument_list|)
expr_stmt|;
name|VC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|MSG_ERROR
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|err
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|val
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
comment|/* error || read request */
return|return
operator|(
name|err
operator|)
return|;
comment|/* write request */
if|if
condition|(
name|val
operator|>
name|MAX_OVER_VOLTAGE
operator|||
name|val
operator|<
name|MIN_OVER_VOLTAGE
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|sc
operator|->
name|voltage_core
operator|=
name|val
expr_stmt|;
name|VC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|err
operator|=
name|bcm2835_cpufreq_set_voltage
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_VOLTAGE_ID_CORE
argument_list|,
name|sc
operator|->
name|voltage_core
argument_list|)
expr_stmt|;
name|VC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|MSG_ERROR
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"set voltage core error\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|DELAY
argument_list|(
name|TRANSITION_LATENCY
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sysctl_bcm2835_cpufreq_voltage_sdram_c
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
init|=
name|arg1
decl_stmt|;
name|int
name|val
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* get realtime value */
name|VC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|val
operator|=
name|bcm2835_cpufreq_get_voltage
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_VOLTAGE_ID_SDRAM_C
argument_list|)
expr_stmt|;
name|VC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|MSG_ERROR
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|err
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|val
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
comment|/* error || read request */
return|return
operator|(
name|err
operator|)
return|;
comment|/* write request */
if|if
condition|(
name|val
operator|>
name|MAX_OVER_VOLTAGE
operator|||
name|val
operator|<
name|MIN_OVER_VOLTAGE
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|sc
operator|->
name|voltage_sdram_c
operator|=
name|val
expr_stmt|;
name|VC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|err
operator|=
name|bcm2835_cpufreq_set_voltage
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_VOLTAGE_ID_SDRAM_C
argument_list|,
name|sc
operator|->
name|voltage_sdram_c
argument_list|)
expr_stmt|;
name|VC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|MSG_ERROR
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"set voltage sdram_c error\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|DELAY
argument_list|(
name|TRANSITION_LATENCY
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sysctl_bcm2835_cpufreq_voltage_sdram_i
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
init|=
name|arg1
decl_stmt|;
name|int
name|val
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* get realtime value */
name|VC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|val
operator|=
name|bcm2835_cpufreq_get_voltage
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_VOLTAGE_ID_SDRAM_I
argument_list|)
expr_stmt|;
name|VC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|MSG_ERROR
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|err
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|val
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
comment|/* error || read request */
return|return
operator|(
name|err
operator|)
return|;
comment|/* write request */
if|if
condition|(
name|val
operator|>
name|MAX_OVER_VOLTAGE
operator|||
name|val
operator|<
name|MIN_OVER_VOLTAGE
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|sc
operator|->
name|voltage_sdram_i
operator|=
name|val
expr_stmt|;
name|VC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|err
operator|=
name|bcm2835_cpufreq_set_voltage
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_VOLTAGE_ID_SDRAM_I
argument_list|,
name|sc
operator|->
name|voltage_sdram_i
argument_list|)
expr_stmt|;
name|VC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|MSG_ERROR
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"set voltage sdram_i error\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|DELAY
argument_list|(
name|TRANSITION_LATENCY
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sysctl_bcm2835_cpufreq_voltage_sdram_p
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
init|=
name|arg1
decl_stmt|;
name|int
name|val
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* get realtime value */
name|VC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|val
operator|=
name|bcm2835_cpufreq_get_voltage
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_VOLTAGE_ID_SDRAM_P
argument_list|)
expr_stmt|;
name|VC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|MSG_ERROR
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|err
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|val
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
comment|/* error || read request */
return|return
operator|(
name|err
operator|)
return|;
comment|/* write request */
if|if
condition|(
name|val
operator|>
name|MAX_OVER_VOLTAGE
operator|||
name|val
operator|<
name|MIN_OVER_VOLTAGE
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|sc
operator|->
name|voltage_sdram_p
operator|=
name|val
expr_stmt|;
name|VC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|err
operator|=
name|bcm2835_cpufreq_set_voltage
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_VOLTAGE_ID_SDRAM_P
argument_list|,
name|sc
operator|->
name|voltage_sdram_p
argument_list|)
expr_stmt|;
name|VC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|MSG_ERROR
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"set voltage sdram_p error\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|DELAY
argument_list|(
name|TRANSITION_LATENCY
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sysctl_bcm2835_cpufreq_voltage_sdram
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
init|=
name|arg1
decl_stmt|;
name|int
name|val
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* multiple write only */
if|if
condition|(
operator|!
name|req
operator|->
name|newptr
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|val
operator|=
literal|0
expr_stmt|;
name|err
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|val
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
comment|/* write request */
if|if
condition|(
name|val
operator|>
name|MAX_OVER_VOLTAGE
operator|||
name|val
operator|<
name|MIN_OVER_VOLTAGE
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|sc
operator|->
name|voltage_sdram
operator|=
name|val
expr_stmt|;
name|VC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|err
operator|=
name|bcm2835_cpufreq_set_voltage
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_VOLTAGE_ID_SDRAM_C
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|MSG_ERROR
condition|)
block|{
name|VC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"set voltage sdram_c error\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|err
operator|=
name|bcm2835_cpufreq_set_voltage
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_VOLTAGE_ID_SDRAM_I
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|MSG_ERROR
condition|)
block|{
name|VC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"set voltage sdram_i error\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|err
operator|=
name|bcm2835_cpufreq_set_voltage
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_VOLTAGE_ID_SDRAM_P
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
name|MSG_ERROR
condition|)
block|{
name|VC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"set voltage sdram_p error\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|VC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|TRANSITION_LATENCY
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sysctl_bcm2835_cpufreq_temperature
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
init|=
name|arg1
decl_stmt|;
name|int
name|val
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* get realtime value */
name|VC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|val
operator|=
name|bcm2835_cpufreq_get_temperature
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|VC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|MSG_ERROR
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
name|err
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|val
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
comment|/* error || read request */
return|return
operator|(
name|err
operator|)
return|;
comment|/* write request */
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sysctl_bcm2835_devcpu_temperature
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
init|=
name|arg1
decl_stmt|;
name|int
name|val
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* get realtime value */
name|VC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|val
operator|=
name|bcm2835_cpufreq_get_temperature
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|VC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|MSG_ERROR
condition|)
return|return
operator|(
name|EIO
operator|)
return|;
comment|/* 1/1000 celsius (raw) to 1/10 kelvin */
name|val
operator|=
name|val
operator|/
literal|100
operator|+
name|TZ_ZEROC
expr_stmt|;
name|err
operator|=
name|sysctl_handle_int
argument_list|(
name|oidp
argument_list|,
operator|&
name|val
argument_list|,
literal|0
argument_list|,
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
comment|/* error || read request */
return|return
operator|(
name|err
operator|)
return|;
comment|/* write request */
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bcm2835_cpufreq_init
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
decl_stmt|;
name|device_t
name|cpu
decl_stmt|;
name|int
name|arm_freq
decl_stmt|,
name|core_freq
decl_stmt|,
name|sdram_freq
decl_stmt|;
name|int
name|arm_max_freq
decl_stmt|,
name|arm_min_freq
decl_stmt|,
name|core_max_freq
decl_stmt|,
name|core_min_freq
decl_stmt|;
name|int
name|sdram_max_freq
decl_stmt|,
name|sdram_min_freq
decl_stmt|;
name|int
name|voltage_core
decl_stmt|,
name|voltage_sdram_c
decl_stmt|,
name|voltage_sdram_i
decl_stmt|,
name|voltage_sdram_p
decl_stmt|;
name|int
name|max_voltage_core
decl_stmt|,
name|min_voltage_core
decl_stmt|;
name|int
name|max_voltage_sdram_c
decl_stmt|,
name|min_voltage_sdram_c
decl_stmt|;
name|int
name|max_voltage_sdram_i
decl_stmt|,
name|min_voltage_sdram_i
decl_stmt|;
name|int
name|max_voltage_sdram_p
decl_stmt|,
name|min_voltage_sdram_p
decl_stmt|;
name|int
name|turbo
decl_stmt|,
name|temperature
decl_stmt|;
name|VC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* current clock */
name|arm_freq
operator|=
name|bcm2835_cpufreq_get_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_ARM
argument_list|)
expr_stmt|;
name|core_freq
operator|=
name|bcm2835_cpufreq_get_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_CORE
argument_list|)
expr_stmt|;
name|sdram_freq
operator|=
name|bcm2835_cpufreq_get_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_SDRAM
argument_list|)
expr_stmt|;
comment|/* max/min clock */
name|arm_max_freq
operator|=
name|bcm2835_cpufreq_get_max_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_ARM
argument_list|)
expr_stmt|;
name|arm_min_freq
operator|=
name|bcm2835_cpufreq_get_min_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_ARM
argument_list|)
expr_stmt|;
name|core_max_freq
operator|=
name|bcm2835_cpufreq_get_max_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_CORE
argument_list|)
expr_stmt|;
name|core_min_freq
operator|=
name|bcm2835_cpufreq_get_min_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_CORE
argument_list|)
expr_stmt|;
name|sdram_max_freq
operator|=
name|bcm2835_cpufreq_get_max_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_SDRAM
argument_list|)
expr_stmt|;
name|sdram_min_freq
operator|=
name|bcm2835_cpufreq_get_min_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_SDRAM
argument_list|)
expr_stmt|;
comment|/* turbo mode */
name|turbo
operator|=
name|bcm2835_cpufreq_get_turbo
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|turbo
operator|>
literal|0
condition|)
name|sc
operator|->
name|turbo_mode
operator|=
name|BCM2835_MBOX_TURBO_ON
expr_stmt|;
else|else
name|sc
operator|->
name|turbo_mode
operator|=
name|BCM2835_MBOX_TURBO_OFF
expr_stmt|;
comment|/* voltage */
name|voltage_core
operator|=
name|bcm2835_cpufreq_get_voltage
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_VOLTAGE_ID_CORE
argument_list|)
expr_stmt|;
name|voltage_sdram_c
operator|=
name|bcm2835_cpufreq_get_voltage
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_VOLTAGE_ID_SDRAM_C
argument_list|)
expr_stmt|;
name|voltage_sdram_i
operator|=
name|bcm2835_cpufreq_get_voltage
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_VOLTAGE_ID_SDRAM_I
argument_list|)
expr_stmt|;
name|voltage_sdram_p
operator|=
name|bcm2835_cpufreq_get_voltage
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_VOLTAGE_ID_SDRAM_P
argument_list|)
expr_stmt|;
comment|/* current values (offset from 1.2V) */
name|sc
operator|->
name|voltage_core
operator|=
name|voltage_core
expr_stmt|;
name|sc
operator|->
name|voltage_sdram
operator|=
name|voltage_sdram_c
expr_stmt|;
name|sc
operator|->
name|voltage_sdram_c
operator|=
name|voltage_sdram_c
expr_stmt|;
name|sc
operator|->
name|voltage_sdram_i
operator|=
name|voltage_sdram_i
expr_stmt|;
name|sc
operator|->
name|voltage_sdram_p
operator|=
name|voltage_sdram_p
expr_stmt|;
comment|/* max/min voltage */
name|max_voltage_core
operator|=
name|bcm2835_cpufreq_get_max_voltage
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_VOLTAGE_ID_CORE
argument_list|)
expr_stmt|;
name|min_voltage_core
operator|=
name|bcm2835_cpufreq_get_min_voltage
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_VOLTAGE_ID_CORE
argument_list|)
expr_stmt|;
name|max_voltage_sdram_c
operator|=
name|bcm2835_cpufreq_get_max_voltage
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_VOLTAGE_ID_SDRAM_C
argument_list|)
expr_stmt|;
name|max_voltage_sdram_i
operator|=
name|bcm2835_cpufreq_get_max_voltage
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_VOLTAGE_ID_SDRAM_I
argument_list|)
expr_stmt|;
name|max_voltage_sdram_p
operator|=
name|bcm2835_cpufreq_get_max_voltage
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_VOLTAGE_ID_SDRAM_P
argument_list|)
expr_stmt|;
name|min_voltage_sdram_c
operator|=
name|bcm2835_cpufreq_get_min_voltage
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_VOLTAGE_ID_SDRAM_C
argument_list|)
expr_stmt|;
name|min_voltage_sdram_i
operator|=
name|bcm2835_cpufreq_get_min_voltage
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_VOLTAGE_ID_SDRAM_I
argument_list|)
expr_stmt|;
name|min_voltage_sdram_p
operator|=
name|bcm2835_cpufreq_get_min_voltage
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_VOLTAGE_ID_SDRAM_P
argument_list|)
expr_stmt|;
comment|/* temperature */
name|temperature
operator|=
name|bcm2835_cpufreq_get_temperature
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* show result */
if|if
condition|(
name|cpufreq_verbose
operator|||
name|bootverbose
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Boot settings:\n"
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"current ARM %dMHz, Core %dMHz, SDRAM %dMHz, Turbo %s\n"
argument_list|,
name|HZ2MHZ
argument_list|(
name|arm_freq
argument_list|)
argument_list|,
name|HZ2MHZ
argument_list|(
name|core_freq
argument_list|)
argument_list|,
name|HZ2MHZ
argument_list|(
name|sdram_freq
argument_list|)
argument_list|,
operator|(
name|sc
operator|->
name|turbo_mode
operator|==
name|BCM2835_MBOX_TURBO_ON
operator|)
condition|?
literal|"ON"
else|:
literal|"OFF"
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"max/min ARM %d/%dMHz, Core %d/%dMHz, SDRAM %d/%dMHz\n"
argument_list|,
name|HZ2MHZ
argument_list|(
name|arm_max_freq
argument_list|)
argument_list|,
name|HZ2MHZ
argument_list|(
name|arm_min_freq
argument_list|)
argument_list|,
name|HZ2MHZ
argument_list|(
name|core_max_freq
argument_list|)
argument_list|,
name|HZ2MHZ
argument_list|(
name|core_min_freq
argument_list|)
argument_list|,
name|HZ2MHZ
argument_list|(
name|sdram_max_freq
argument_list|)
argument_list|,
name|HZ2MHZ
argument_list|(
name|sdram_min_freq
argument_list|)
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"current Core %dmV, SDRAM_C %dmV, SDRAM_I %dmV, "
literal|"SDRAM_P %dmV\n"
argument_list|,
name|OFFSET2MVOLT
argument_list|(
name|voltage_core
argument_list|)
argument_list|,
name|OFFSET2MVOLT
argument_list|(
name|voltage_sdram_c
argument_list|)
argument_list|,
name|OFFSET2MVOLT
argument_list|(
name|voltage_sdram_i
argument_list|)
argument_list|,
name|OFFSET2MVOLT
argument_list|(
name|voltage_sdram_p
argument_list|)
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"max/min Core %d/%dmV, SDRAM_C %d/%dmV, SDRAM_I %d/%dmV, "
literal|"SDRAM_P %d/%dmV\n"
argument_list|,
name|OFFSET2MVOLT
argument_list|(
name|max_voltage_core
argument_list|)
argument_list|,
name|OFFSET2MVOLT
argument_list|(
name|min_voltage_core
argument_list|)
argument_list|,
name|OFFSET2MVOLT
argument_list|(
name|max_voltage_sdram_c
argument_list|)
argument_list|,
name|OFFSET2MVOLT
argument_list|(
name|min_voltage_sdram_c
argument_list|)
argument_list|,
name|OFFSET2MVOLT
argument_list|(
name|max_voltage_sdram_i
argument_list|)
argument_list|,
name|OFFSET2MVOLT
argument_list|(
name|min_voltage_sdram_i
argument_list|)
argument_list|,
name|OFFSET2MVOLT
argument_list|(
name|max_voltage_sdram_p
argument_list|)
argument_list|,
name|OFFSET2MVOLT
argument_list|(
name|min_voltage_sdram_p
argument_list|)
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Temperature %d.%dC\n"
argument_list|,
operator|(
name|temperature
operator|/
literal|1000
operator|)
argument_list|,
operator|(
name|temperature
operator|%
literal|1000
operator|)
operator|/
literal|100
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* !cpufreq_verbose&& !bootverbose */
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"ARM %dMHz, Core %dMHz, SDRAM %dMHz, Turbo %s\n"
argument_list|,
name|HZ2MHZ
argument_list|(
name|arm_freq
argument_list|)
argument_list|,
name|HZ2MHZ
argument_list|(
name|core_freq
argument_list|)
argument_list|,
name|HZ2MHZ
argument_list|(
name|sdram_freq
argument_list|)
argument_list|,
operator|(
name|sc
operator|->
name|turbo_mode
operator|==
name|BCM2835_MBOX_TURBO_ON
operator|)
condition|?
literal|"ON"
else|:
literal|"OFF"
argument_list|)
expr_stmt|;
block|}
comment|/* keep in softc (MHz/mV) */
name|sc
operator|->
name|arm_max_freq
operator|=
name|HZ2MHZ
argument_list|(
name|arm_max_freq
argument_list|)
expr_stmt|;
name|sc
operator|->
name|arm_min_freq
operator|=
name|HZ2MHZ
argument_list|(
name|arm_min_freq
argument_list|)
expr_stmt|;
name|sc
operator|->
name|core_max_freq
operator|=
name|HZ2MHZ
argument_list|(
name|core_max_freq
argument_list|)
expr_stmt|;
name|sc
operator|->
name|core_min_freq
operator|=
name|HZ2MHZ
argument_list|(
name|core_min_freq
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sdram_max_freq
operator|=
name|HZ2MHZ
argument_list|(
name|sdram_max_freq
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sdram_min_freq
operator|=
name|HZ2MHZ
argument_list|(
name|sdram_min_freq
argument_list|)
expr_stmt|;
name|sc
operator|->
name|max_voltage_core
operator|=
name|OFFSET2MVOLT
argument_list|(
name|max_voltage_core
argument_list|)
expr_stmt|;
name|sc
operator|->
name|min_voltage_core
operator|=
name|OFFSET2MVOLT
argument_list|(
name|min_voltage_core
argument_list|)
expr_stmt|;
comment|/* if turbo is on, set to max values */
if|if
condition|(
name|sc
operator|->
name|turbo_mode
operator|==
name|BCM2835_MBOX_TURBO_ON
condition|)
block|{
name|bcm2835_cpufreq_set_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_ARM
argument_list|,
name|arm_max_freq
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|TRANSITION_LATENCY
argument_list|)
expr_stmt|;
name|bcm2835_cpufreq_set_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_CORE
argument_list|,
name|core_max_freq
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|TRANSITION_LATENCY
argument_list|)
expr_stmt|;
name|bcm2835_cpufreq_set_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_SDRAM
argument_list|,
name|sdram_max_freq
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|TRANSITION_LATENCY
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bcm2835_cpufreq_set_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_ARM
argument_list|,
name|arm_min_freq
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|TRANSITION_LATENCY
argument_list|)
expr_stmt|;
name|bcm2835_cpufreq_set_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_CORE
argument_list|,
name|core_min_freq
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|TRANSITION_LATENCY
argument_list|)
expr_stmt|;
name|bcm2835_cpufreq_set_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_SDRAM
argument_list|,
name|sdram_min_freq
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|TRANSITION_LATENCY
argument_list|)
expr_stmt|;
block|}
name|VC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* add human readable temperature to dev.cpu node */
name|cpu
operator|=
name|device_get_parent
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|cpu
operator|!=
name|NULL
condition|)
block|{
name|ctx
operator|=
name|device_get_sysctl_ctx
argument_list|(
name|cpu
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|device_get_sysctl_tree
argument_list|(
name|cpu
argument_list|)
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"temperature"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|sysctl_bcm2835_devcpu_temperature
argument_list|,
literal|"IK"
argument_list|,
literal|"Current SoC temperature"
argument_list|)
expr_stmt|;
block|}
comment|/* release this hook (continue boot) */
name|config_intrhook_disestablish
argument_list|(
operator|&
name|sc
operator|->
name|init_hook
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bcm2835_cpufreq_identify
parameter_list|(
name|driver_t
modifier|*
name|driver
parameter_list|,
name|device_t
name|parent
parameter_list|)
block|{
name|DPRINTF
argument_list|(
literal|"driver=%p, parent=%p\n"
argument_list|,
name|driver
argument_list|,
name|parent
argument_list|)
expr_stmt|;
if|if
condition|(
name|device_find_child
argument_list|(
name|parent
argument_list|,
literal|"bcm2835_cpufreq"
argument_list|,
operator|-
literal|1
argument_list|)
operator|!=
name|NULL
condition|)
return|return;
if|if
condition|(
name|BUS_ADD_CHILD
argument_list|(
name|parent
argument_list|,
literal|0
argument_list|,
literal|"bcm2835_cpufreq"
argument_list|,
operator|-
literal|1
argument_list|)
operator|==
name|NULL
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"add child failed\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm2835_cpufreq_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"CPU Frequency Control"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bcm2835_cpufreq_cb
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|err
parameter_list|)
block|{
name|bus_addr_t
modifier|*
name|addr
decl_stmt|;
if|if
condition|(
name|err
condition|)
return|return;
name|addr
operator|=
operator|(
name|bus_addr_t
operator|*
operator|)
name|arg
expr_stmt|;
operator|*
name|addr
operator|=
name|PHYS_TO_VCBUS
argument_list|(
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm2835_cpufreq_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|oid
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* set self dev */
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
comment|/* initial values */
name|sc
operator|->
name|arm_max_freq
operator|=
operator|-
literal|1
expr_stmt|;
name|sc
operator|->
name|arm_min_freq
operator|=
operator|-
literal|1
expr_stmt|;
name|sc
operator|->
name|core_max_freq
operator|=
operator|-
literal|1
expr_stmt|;
name|sc
operator|->
name|core_min_freq
operator|=
operator|-
literal|1
expr_stmt|;
name|sc
operator|->
name|sdram_max_freq
operator|=
operator|-
literal|1
expr_stmt|;
name|sc
operator|->
name|sdram_min_freq
operator|=
operator|-
literal|1
expr_stmt|;
name|sc
operator|->
name|max_voltage_core
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|min_voltage_core
operator|=
literal|0
expr_stmt|;
comment|/* create VC mbox buffer */
name|sc
operator|->
name|dma_size
operator|=
name|PAGE_SIZE
expr_stmt|;
name|err
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|,
name|PAGE_SIZE
argument_list|,
literal|0
argument_list|,
comment|/* alignment, boundary */
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|sc
operator|->
name|dma_size
argument_list|,
literal|1
argument_list|,
comment|/* maxsize, nsegments */
name|sc
operator|->
name|dma_size
argument_list|,
literal|0
argument_list|,
comment|/* maxsegsize, flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockarg */
operator|&
name|sc
operator|->
name|dma_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"can't create DMA tag\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|err
operator|=
name|bus_dmamem_alloc
argument_list|(
name|sc
operator|->
name|dma_tag
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|sc
operator|->
name|dma_buf
argument_list|,
literal|0
argument_list|,
operator|&
name|sc
operator|->
name|dma_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|dma_tag
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"can't allocate dmamem\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|err
operator|=
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|dma_tag
argument_list|,
name|sc
operator|->
name|dma_map
argument_list|,
name|sc
operator|->
name|dma_buf
argument_list|,
name|sc
operator|->
name|dma_size
argument_list|,
name|bcm2835_cpufreq_cb
argument_list|,
operator|&
name|sc
operator|->
name|dma_phys
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|bus_dmamem_free
argument_list|(
name|sc
operator|->
name|dma_tag
argument_list|,
name|sc
operator|->
name|dma_buf
argument_list|,
name|sc
operator|->
name|dma_map
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|dma_tag
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"can't load DMA map\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
comment|/* OK, ready to use VC buffer */
comment|/* setup sysctl at first device */
if|if
condition|(
name|device_get_unit
argument_list|(
name|dev
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sysctl_ctx_init
argument_list|(
operator|&
name|bcm2835_sysctl_ctx
argument_list|)
expr_stmt|;
comment|/* create node for hw.cpufreq */
name|oid
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
operator|&
name|bcm2835_sysctl_ctx
argument_list|,
name|SYSCTL_STATIC_CHILDREN
argument_list|(
name|_hw
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"cpufreq"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|""
argument_list|)
expr_stmt|;
comment|/* Frequency (Hz) */
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|bcm2835_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|oid
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"arm_freq"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|sysctl_bcm2835_cpufreq_arm_freq
argument_list|,
literal|"IU"
argument_list|,
literal|"ARM frequency (Hz)"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|bcm2835_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|oid
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"core_freq"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|sysctl_bcm2835_cpufreq_core_freq
argument_list|,
literal|"IU"
argument_list|,
literal|"Core frequency (Hz)"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|bcm2835_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|oid
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"sdram_freq"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|sysctl_bcm2835_cpufreq_sdram_freq
argument_list|,
literal|"IU"
argument_list|,
literal|"SDRAM frequency (Hz)"
argument_list|)
expr_stmt|;
comment|/* Turbo state */
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|bcm2835_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|oid
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"turbo"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|sysctl_bcm2835_cpufreq_turbo
argument_list|,
literal|"IU"
argument_list|,
literal|"Disables dynamic clocking"
argument_list|)
expr_stmt|;
comment|/* Voltage (offset from 1.2V in units of 0.025V) */
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|bcm2835_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|oid
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"voltage_core"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|sysctl_bcm2835_cpufreq_voltage_core
argument_list|,
literal|"I"
argument_list|,
literal|"ARM/GPU core voltage"
literal|"(offset from 1.2V in units of 0.025V)"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|bcm2835_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|oid
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"voltage_sdram"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_WR
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|sysctl_bcm2835_cpufreq_voltage_sdram
argument_list|,
literal|"I"
argument_list|,
literal|"SDRAM voltage (offset from 1.2V in units of 0.025V)"
argument_list|)
expr_stmt|;
comment|/* Voltage individual SDRAM */
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|bcm2835_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|oid
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"voltage_sdram_c"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|sysctl_bcm2835_cpufreq_voltage_sdram_c
argument_list|,
literal|"I"
argument_list|,
literal|"SDRAM controller voltage"
literal|"(offset from 1.2V in units of 0.025V)"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|bcm2835_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|oid
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"voltage_sdram_i"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|sysctl_bcm2835_cpufreq_voltage_sdram_i
argument_list|,
literal|"I"
argument_list|,
literal|"SDRAM I/O voltage (offset from 1.2V in units of 0.025V)"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|bcm2835_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|oid
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"voltage_sdram_p"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RW
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|sysctl_bcm2835_cpufreq_voltage_sdram_p
argument_list|,
literal|"I"
argument_list|,
literal|"SDRAM phy voltage (offset from 1.2V in units of 0.025V)"
argument_list|)
expr_stmt|;
comment|/* Temperature */
name|SYSCTL_ADD_PROC
argument_list|(
operator|&
name|bcm2835_sysctl_ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|oid
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"temperature"
argument_list|,
name|CTLTYPE_INT
operator||
name|CTLFLAG_RD
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|sysctl_bcm2835_cpufreq_temperature
argument_list|,
literal|"I"
argument_list|,
literal|"SoC temperature (thousandths of a degree C)"
argument_list|)
expr_stmt|;
block|}
comment|/* ARM->VC lock */
name|sema_init
argument_list|(
operator|&
name|vc_sema
argument_list|,
literal|1
argument_list|,
literal|"vcsema"
argument_list|)
expr_stmt|;
comment|/* register callback for using mbox when interrupts are enabled */
name|sc
operator|->
name|init_hook
operator|.
name|ich_func
operator|=
name|bcm2835_cpufreq_init
expr_stmt|;
name|sc
operator|->
name|init_hook
operator|.
name|ich_arg
operator|=
name|sc
expr_stmt|;
if|if
condition|(
name|config_intrhook_establish
argument_list|(
operator|&
name|sc
operator|->
name|init_hook
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|dma_tag
argument_list|,
name|sc
operator|->
name|dma_map
argument_list|)
expr_stmt|;
name|bus_dmamem_free
argument_list|(
name|sc
operator|->
name|dma_tag
argument_list|,
name|sc
operator|->
name|dma_buf
argument_list|,
name|sc
operator|->
name|dma_map
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|dma_tag
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"config_intrhook_establish failed\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
comment|/* this device is controlled by cpufreq(4) */
name|cpufreq_register
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm2835_cpufreq_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sema_destroy
argument_list|(
operator|&
name|vc_sema
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|dma_phys
operator|!=
literal|0
condition|)
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|dma_tag
argument_list|,
name|sc
operator|->
name|dma_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|dma_buf
operator|!=
name|NULL
condition|)
name|bus_dmamem_free
argument_list|(
name|sc
operator|->
name|dma_tag
argument_list|,
name|sc
operator|->
name|dma_buf
argument_list|,
name|sc
operator|->
name|dma_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|dma_tag
operator|!=
name|NULL
condition|)
name|bus_dma_tag_destroy
argument_list|(
name|sc
operator|->
name|dma_tag
argument_list|)
expr_stmt|;
return|return
operator|(
name|cpufreq_unregister
argument_list|(
name|dev
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm2835_cpufreq_set
parameter_list|(
name|device_t
name|dev
parameter_list|,
specifier|const
name|struct
name|cf_setting
modifier|*
name|cf
parameter_list|)
block|{
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|rate_hz
decl_stmt|,
name|rem
decl_stmt|;
name|int
name|cur_freq
decl_stmt|,
name|resp_freq
decl_stmt|,
name|arm_freq
decl_stmt|,
name|min_freq
decl_stmt|,
name|core_freq
decl_stmt|;
if|if
condition|(
name|cf
operator|==
name|NULL
operator|||
name|cf
operator|->
name|freq
operator|<
literal|0
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* setting clock (Hz) */
name|rate_hz
operator|=
operator|(
name|uint32_t
operator|)
name|MHZ2HZ
argument_list|(
name|cf
operator|->
name|freq
argument_list|)
expr_stmt|;
name|rem
operator|=
name|rate_hz
operator|%
name|HZSTEP
expr_stmt|;
name|rate_hz
operator|-=
name|rem
expr_stmt|;
if|if
condition|(
name|rate_hz
operator|==
literal|0
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
comment|/* adjust min freq */
name|min_freq
operator|=
name|sc
operator|->
name|arm_min_freq
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|turbo_mode
operator|!=
name|BCM2835_MBOX_TURBO_ON
condition|)
if|if
condition|(
name|min_freq
operator|>
name|cpufreq_lowest_freq
condition|)
name|min_freq
operator|=
name|cpufreq_lowest_freq
expr_stmt|;
if|if
condition|(
name|rate_hz
operator|<
name|MHZ2HZ
argument_list|(
name|min_freq
argument_list|)
operator|||
name|rate_hz
operator|>
name|MHZ2HZ
argument_list|(
name|sc
operator|->
name|arm_max_freq
argument_list|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
comment|/* set new value and verify it */
name|VC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|cur_freq
operator|=
name|bcm2835_cpufreq_get_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_ARM
argument_list|)
expr_stmt|;
name|resp_freq
operator|=
name|bcm2835_cpufreq_set_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_ARM
argument_list|,
name|rate_hz
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|TRANSITION_LATENCY
argument_list|)
expr_stmt|;
name|arm_freq
operator|=
name|bcm2835_cpufreq_get_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_ARM
argument_list|)
expr_stmt|;
comment|/* 	 * if non-turbo and lower than or equal min_freq, 	 * clock down core and sdram to default first. 	 */
if|if
condition|(
name|sc
operator|->
name|turbo_mode
operator|!=
name|BCM2835_MBOX_TURBO_ON
condition|)
block|{
name|core_freq
operator|=
name|bcm2835_cpufreq_get_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_CORE
argument_list|)
expr_stmt|;
if|if
condition|(
name|rate_hz
operator|>
name|MHZ2HZ
argument_list|(
name|sc
operator|->
name|arm_min_freq
argument_list|)
condition|)
block|{
name|bcm2835_cpufreq_set_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_CORE
argument_list|,
name|MHZ2HZ
argument_list|(
name|sc
operator|->
name|core_max_freq
argument_list|)
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|TRANSITION_LATENCY
argument_list|)
expr_stmt|;
name|bcm2835_cpufreq_set_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_SDRAM
argument_list|,
name|MHZ2HZ
argument_list|(
name|sc
operator|->
name|sdram_max_freq
argument_list|)
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|TRANSITION_LATENCY
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|sc
operator|->
name|core_min_freq
operator|<
name|DEFAULT_CORE_FREQUENCY
operator|&&
name|core_freq
operator|>
name|DEFAULT_CORE_FREQUENCY
condition|)
block|{
comment|/* first, down to 250, then down to min */
name|DELAY
argument_list|(
name|TRANSITION_LATENCY
argument_list|)
expr_stmt|;
name|bcm2835_cpufreq_set_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_CORE
argument_list|,
name|MHZ2HZ
argument_list|(
name|DEFAULT_CORE_FREQUENCY
argument_list|)
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|TRANSITION_LATENCY
argument_list|)
expr_stmt|;
comment|/* reset core voltage */
name|bcm2835_cpufreq_set_voltage
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_VOLTAGE_ID_CORE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|TRANSITION_LATENCY
argument_list|)
expr_stmt|;
block|}
name|bcm2835_cpufreq_set_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_CORE
argument_list|,
name|MHZ2HZ
argument_list|(
name|sc
operator|->
name|core_min_freq
argument_list|)
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|TRANSITION_LATENCY
argument_list|)
expr_stmt|;
name|bcm2835_cpufreq_set_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_SDRAM
argument_list|,
name|MHZ2HZ
argument_list|(
name|sc
operator|->
name|sdram_min_freq
argument_list|)
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|TRANSITION_LATENCY
argument_list|)
expr_stmt|;
block|}
block|}
name|VC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp_freq
operator|<
literal|0
operator|||
name|arm_freq
operator|<
literal|0
operator|||
name|resp_freq
operator|!=
name|arm_freq
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"wrong freq\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|DPRINTF
argument_list|(
literal|"cpufreq: %d -> %d\n"
argument_list|,
name|cur_freq
argument_list|,
name|arm_freq
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm2835_cpufreq_get
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|cf_setting
modifier|*
name|cf
parameter_list|)
block|{
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|arm_freq
decl_stmt|;
if|if
condition|(
name|cf
operator|==
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|cf
argument_list|,
name|CPUFREQ_VAL_UNKNOWN
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cf
argument_list|)
argument_list|)
expr_stmt|;
name|cf
operator|->
name|dev
operator|=
name|NULL
expr_stmt|;
comment|/* get cuurent value */
name|VC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|arm_freq
operator|=
name|bcm2835_cpufreq_get_clock_rate
argument_list|(
name|sc
argument_list|,
name|BCM2835_MBOX_CLOCK_ID_ARM
argument_list|)
expr_stmt|;
name|VC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|arm_freq
operator|<
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"can't get clock\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
comment|/* CPU clock in MHz or 100ths of a percent. */
name|cf
operator|->
name|freq
operator|=
name|HZ2MHZ
argument_list|(
name|arm_freq
argument_list|)
expr_stmt|;
comment|/* Voltage in mV. */
name|cf
operator|->
name|volts
operator|=
name|CPUFREQ_VAL_UNKNOWN
expr_stmt|;
comment|/* Power consumed in mW. */
name|cf
operator|->
name|power
operator|=
name|CPUFREQ_VAL_UNKNOWN
expr_stmt|;
comment|/* Transition latency in us. */
name|cf
operator|->
name|lat
operator|=
name|TRANSITION_LATENCY
expr_stmt|;
comment|/* Driver providing this setting. */
name|cf
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm2835_cpufreq_make_freq_list
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|cf_setting
modifier|*
name|sets
parameter_list|,
name|int
modifier|*
name|count
parameter_list|)
block|{
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|freq
decl_stmt|,
name|min_freq
decl_stmt|,
name|volts
decl_stmt|,
name|rem
decl_stmt|;
name|int
name|idx
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|freq
operator|=
name|sc
operator|->
name|arm_max_freq
expr_stmt|;
name|min_freq
operator|=
name|sc
operator|->
name|arm_min_freq
expr_stmt|;
comment|/* adjust head freq to STEP */
name|rem
operator|=
name|freq
operator|%
name|MHZSTEP
expr_stmt|;
name|freq
operator|-=
name|rem
expr_stmt|;
if|if
condition|(
name|freq
operator|<
name|min_freq
condition|)
name|freq
operator|=
name|min_freq
expr_stmt|;
comment|/* if non-turbo, add extra low freq */
if|if
condition|(
name|sc
operator|->
name|turbo_mode
operator|!=
name|BCM2835_MBOX_TURBO_ON
condition|)
if|if
condition|(
name|min_freq
operator|>
name|cpufreq_lowest_freq
condition|)
name|min_freq
operator|=
name|cpufreq_lowest_freq
expr_stmt|;
comment|/* from freq to min_freq */
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
operator|*
name|count
operator|&&
name|freq
operator|>=
name|min_freq
condition|;
name|idx
operator|++
control|)
block|{
if|if
condition|(
name|freq
operator|>
name|sc
operator|->
name|arm_min_freq
condition|)
name|volts
operator|=
name|sc
operator|->
name|max_voltage_core
expr_stmt|;
else|else
name|volts
operator|=
name|sc
operator|->
name|min_voltage_core
expr_stmt|;
name|sets
index|[
name|idx
index|]
operator|.
name|freq
operator|=
name|freq
expr_stmt|;
name|sets
index|[
name|idx
index|]
operator|.
name|volts
operator|=
name|volts
expr_stmt|;
name|sets
index|[
name|idx
index|]
operator|.
name|lat
operator|=
name|TRANSITION_LATENCY
expr_stmt|;
name|sets
index|[
name|idx
index|]
operator|.
name|dev
operator|=
name|dev
expr_stmt|;
name|freq
operator|-=
name|MHZSTEP
expr_stmt|;
block|}
operator|*
name|count
operator|=
operator|++
name|idx
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm2835_cpufreq_settings
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|cf_setting
modifier|*
name|sets
parameter_list|,
name|int
modifier|*
name|count
parameter_list|)
block|{
name|struct
name|bcm2835_cpufreq_softc
modifier|*
name|sc
decl_stmt|;
if|if
condition|(
name|sets
operator|==
name|NULL
operator|||
name|count
operator|==
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|arm_min_freq
operator|<
literal|0
operator|||
name|sc
operator|->
name|arm_max_freq
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"device is not configured\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
comment|/* fill data with unknown value */
name|memset
argument_list|(
name|sets
argument_list|,
name|CPUFREQ_VAL_UNKNOWN
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sets
argument_list|)
operator|*
operator|(
operator|*
name|count
operator|)
argument_list|)
expr_stmt|;
comment|/* create new array up to count */
name|bcm2835_cpufreq_make_freq_list
argument_list|(
name|dev
argument_list|,
name|sets
argument_list|,
name|count
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm2835_cpufreq_type
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
modifier|*
name|type
parameter_list|)
block|{
if|if
condition|(
name|type
operator|==
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
operator|*
name|type
operator|=
name|CPUFREQ_TYPE_ABSOLUTE
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|bcm2835_cpufreq_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_identify
argument_list|,
name|bcm2835_cpufreq_identify
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|bcm2835_cpufreq_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|bcm2835_cpufreq_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|bcm2835_cpufreq_detach
argument_list|)
block|,
comment|/* cpufreq interface */
name|DEVMETHOD
argument_list|(
name|cpufreq_drv_set
argument_list|,
name|bcm2835_cpufreq_set
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|cpufreq_drv_get
argument_list|,
name|bcm2835_cpufreq_get
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|cpufreq_drv_settings
argument_list|,
name|bcm2835_cpufreq_settings
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|cpufreq_drv_type
argument_list|,
name|bcm2835_cpufreq_type
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|bcm2835_cpufreq_devclass
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|bcm2835_cpufreq_driver
init|=
block|{
literal|"bcm2835_cpufreq"
block|,
name|bcm2835_cpufreq_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|bcm2835_cpufreq_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|bcm2835_cpufreq
argument_list|,
name|cpu
argument_list|,
name|bcm2835_cpufreq_driver
argument_list|,
name|bcm2835_cpufreq_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


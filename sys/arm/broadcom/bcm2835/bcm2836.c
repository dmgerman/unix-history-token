begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2015 Andrew Turner.  * Copyright 2016 Svatopluk Kraus  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are  * met:  *  *  1. Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *  2. Redistributions in binary form must reproduce the above copyright  *     notice, this list of conditions and the following disclaimer in the  *     documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR  * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF  * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_platform.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/cpuset.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|SMP
end_ifdef

begin_include
include|#
directive|include
file|<sys/smp.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/intr.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|SMP
end_ifdef

begin_include
include|#
directive|include
file|<machine/smp.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus_subr.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|INTRNG
end_ifdef

begin_include
include|#
directive|include
file|"pic_if.h"
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<arm/broadcom/bcm2835/bcm2836.h>
end_include

begin_define
define|#
directive|define
name|ARM_LOCAL_BASE
value|0x40000000
end_define

begin_define
define|#
directive|define
name|ARM_LOCAL_SIZE
value|0x00001000
end_define

begin_define
define|#
directive|define
name|ARM_LOCAL_CONTROL
value|0x00
end_define

begin_define
define|#
directive|define
name|ARM_LOCAL_PRESCALER
value|0x08
end_define

begin_define
define|#
directive|define
name|PRESCALER_19_2
value|0x80000000
end_define

begin_comment
comment|/* 19.2 MHz */
end_comment

begin_define
define|#
directive|define
name|ARM_LOCAL_INT_TIMER
parameter_list|(
name|n
parameter_list|)
value|(0x40 + (n) * 4)
end_define

begin_define
define|#
directive|define
name|ARM_LOCAL_INT_MAILBOX
parameter_list|(
name|n
parameter_list|)
value|(0x50 + (n) * 4)
end_define

begin_define
define|#
directive|define
name|ARM_LOCAL_INT_PENDING
parameter_list|(
name|n
parameter_list|)
value|(0x60 + (n) * 4)
end_define

begin_define
define|#
directive|define
name|INT_PENDING_MASK
value|0x011f
end_define

begin_define
define|#
directive|define
name|MAILBOX0_IRQ
value|4
end_define

begin_define
define|#
directive|define
name|MAILBOX0_IRQEN
value|(1<< 0)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|INTRNG
end_ifdef

begin_define
define|#
directive|define
name|BCM_LINTC_CONTROL_REG
value|0x00
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_PRESCALER_REG
value|0x08
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_GPU_ROUTING_REG
value|0x0c
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_PMU_ROUTING_SET_REG
value|0x10
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_PMU_ROUTING_CLR_REG
value|0x14
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_TIMER_CFG_REG
parameter_list|(
name|n
parameter_list|)
value|(0x40 + (n) * 4)
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_MBOX_CFG_REG
parameter_list|(
name|n
parameter_list|)
value|(0x50 + (n) * 4)
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_PENDING_REG
parameter_list|(
name|n
parameter_list|)
value|(0x60 + (n) * 4)
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_MBOX0_SET_REG
parameter_list|(
name|n
parameter_list|)
value|(0x80 + (n) * 16)
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_MBOX1_SET_REG
parameter_list|(
name|n
parameter_list|)
value|(0x84 + (n) * 16)
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_MBOX2_SET_REG
parameter_list|(
name|n
parameter_list|)
value|(0x88 + (n) * 16)
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_MBOX3_SET_REG
parameter_list|(
name|n
parameter_list|)
value|(0x8C + (n) * 16)
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_MBOX0_CLR_REG
parameter_list|(
name|n
parameter_list|)
value|(0xC0 + (n) * 16)
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_MBOX1_CLR_REG
parameter_list|(
name|n
parameter_list|)
value|(0xC4 + (n) * 16)
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_MBOX2_CLR_REG
parameter_list|(
name|n
parameter_list|)
value|(0xC8 + (n) * 16)
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_MBOX3_CLR_REG
parameter_list|(
name|n
parameter_list|)
value|(0xCC + (n) * 16)
end_define

begin_comment
comment|/* Prescaler Register */
end_comment

begin_define
define|#
directive|define
name|BCM_LINTC_PSR_19_2
value|0x80000000
end_define

begin_comment
comment|/* 19.2 MHz */
end_comment

begin_comment
comment|/* GPU Interrupt Routing Register */
end_comment

begin_define
define|#
directive|define
name|BCM_LINTC_GIRR_IRQ_CORE
parameter_list|(
name|n
parameter_list|)
value|(n)
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_GIRR_FIQ_CORE
parameter_list|(
name|n
parameter_list|)
value|((n)<< 2)
end_define

begin_comment
comment|/* PMU Interrupt Routing Register */
end_comment

begin_define
define|#
directive|define
name|BCM_LINTC_PIRR_IRQ_EN_CORE
parameter_list|(
name|n
parameter_list|)
value|(1<< (n))
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_PIRR_FIQ_EN_CORE
parameter_list|(
name|n
parameter_list|)
value|(1<< ((n) + 4))
end_define

begin_comment
comment|/* Timer Config Register */
end_comment

begin_define
define|#
directive|define
name|BCM_LINTC_TCR_IRQ_EN_TIMER
parameter_list|(
name|n
parameter_list|)
value|(1<< (n))
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_TCR_FIQ_EN_TIMER
parameter_list|(
name|n
parameter_list|)
value|(1<< ((n) + 4))
end_define

begin_comment
comment|/* MBOX Config Register */
end_comment

begin_define
define|#
directive|define
name|BCM_LINTC_MCR_IRQ_EN_MBOX
parameter_list|(
name|n
parameter_list|)
value|(1<< (n))
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_MCR_FIQ_EN_MBOX
parameter_list|(
name|n
parameter_list|)
value|(1<< ((n) + 4))
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_CNTPSIRQ_IRQ
value|0
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_CNTPNSIRQ_IRQ
value|1
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_CNTHPIRQ_IRQ
value|2
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_CNTVIRQ_IRQ
value|3
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_MBOX0_IRQ
value|4
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_MBOX1_IRQ
value|5
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_MBOX2_IRQ
value|6
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_MBOX3_IRQ
value|7
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_GPU_IRQ
value|8
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_PMU_IRQ
value|9
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_AXI_IRQ
value|10
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_LTIMER_IRQ
value|11
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_NIRQS
value|12
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_TIMER0_IRQ
value|BCM_LINTC_CNTPSIRQ_IRQ
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_TIMER1_IRQ
value|BCM_LINTC_CNTPNSIRQ_IRQ
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_TIMER2_IRQ
value|BCM_LINTC_CNTHPIRQ_IRQ
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_TIMER3_IRQ
value|BCM_LINTC_CNTVIRQ_IRQ
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_TIMER0_IRQ_MASK
value|(1<< BCM_LINTC_TIMER0_IRQ)
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_TIMER1_IRQ_MASK
value|(1<< BCM_LINTC_TIMER1_IRQ)
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_TIMER2_IRQ_MASK
value|(1<< BCM_LINTC_TIMER2_IRQ)
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_TIMER3_IRQ_MASK
value|(1<< BCM_LINTC_TIMER3_IRQ)
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_MBOX0_IRQ_MASK
value|(1<< BCM_LINTC_MBOX0_IRQ)
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_GPU_IRQ_MASK
value|(1<< BCM_LINTC_GPU_IRQ)
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_PMU_IRQ_MASK
value|(1<< BCM_LINTC_PMU_IRQ)
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_UP_PENDING_MASK
define|\
value|(BCM_LINTC_TIMER0_IRQ_MASK |	\      BCM_LINTC_TIMER1_IRQ_MASK |	\      BCM_LINTC_TIMER2_IRQ_MASK |	\      BCM_LINTC_TIMER3_IRQ_MASK |	\      BCM_LINTC_GPU_IRQ_MASK |		\      BCM_LINTC_PMU_IRQ_MASK)
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_SMP_PENDING_MASK
define|\
value|(BCM_LINTC_UP_PENDING_MASK |	\      BCM_LINTC_MBOX0_IRQ_MASK)
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|SMP
end_ifdef

begin_define
define|#
directive|define
name|BCM_LINTC_PENDING_MASK
value|BCM_LINTC_SMP_PENDING_MASK
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|BCM_LINTC_PENDING_MASK
value|BCM_LINTC_UP_PENDING_MASK
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_struct
struct|struct
name|bcm_lintc_irqsrc
block|{
name|struct
name|intr_irqsrc
name|bli_isrc
decl_stmt|;
name|u_int
name|bli_irq
decl_stmt|;
union|union
block|{
name|u_int
name|bli_mask
decl_stmt|;
comment|/* for timers */
name|u_int
name|bli_value
decl_stmt|;
comment|/* for GPU */
block|}
union|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|bcm_lintc_softc
block|{
name|device_t
name|bls_dev
decl_stmt|;
name|struct
name|mtx
name|bls_mtx
decl_stmt|;
name|struct
name|resource
modifier|*
name|bls_mem
decl_stmt|;
name|bus_space_tag_t
name|bls_bst
decl_stmt|;
name|bus_space_handle_t
name|bls_bsh
decl_stmt|;
name|struct
name|bcm_lintc_irqsrc
name|bls_isrcs
index|[
name|BCM_LINTC_NIRQS
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|bcm_lintc_softc
modifier|*
name|bcm_lintc_sc
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|SMP
end_ifdef

begin_define
define|#
directive|define
name|BCM_LINTC_NIPIS
value|32
end_define

begin_comment
comment|/* only mailbox 0 is used for IPI */
end_comment

begin_expr_stmt
name|CTASSERT
argument_list|(
name|INTR_IPI_COUNT
operator|<=
name|BCM_LINTC_NIPIS
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|BCM_LINTC_LOCK
parameter_list|(
name|sc
parameter_list|)
value|mtx_lock_spin(&(sc)->bls_mtx)
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_UNLOCK
parameter_list|(
name|sc
parameter_list|)
value|mtx_unlock_spin(&(sc)->bls_mtx)
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_LOCK_INIT
parameter_list|(
name|sc
parameter_list|)
value|mtx_init(&(sc)->bls_mtx,	\     device_get_nameunit((sc)->bls_dev), "bmc_local_intc", MTX_SPIN)
end_define

begin_define
define|#
directive|define
name|BCM_LINTC_LOCK_DESTROY
parameter_list|(
name|sc
parameter_list|)
value|mtx_destroy(&(sc)->bls_mtx)
end_define

begin_define
define|#
directive|define
name|bcm_lintc_read_4
parameter_list|(
name|sc
parameter_list|,
name|reg
parameter_list|)
define|\
value|bus_space_read_4((sc)->bls_bst, (sc)->bls_bsh, (reg))
end_define

begin_define
define|#
directive|define
name|bcm_lintc_write_4
parameter_list|(
name|sc
parameter_list|,
name|reg
parameter_list|,
name|val
parameter_list|)
define|\
value|bus_space_write_4((sc)->bls_bst, (sc)->bls_bsh, (reg), (val))
end_define

begin_function
specifier|static
specifier|inline
name|void
name|bcm_lintc_rwreg_clr
parameter_list|(
name|struct
name|bcm_lintc_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint32_t
name|mask
parameter_list|)
block|{
name|bcm_lintc_write_4
argument_list|(
name|sc
argument_list|,
name|reg
argument_list|,
name|bcm_lintc_read_4
argument_list|(
name|sc
argument_list|,
name|reg
argument_list|)
operator|&
operator|~
name|mask
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|bcm_lintc_rwreg_set
parameter_list|(
name|struct
name|bcm_lintc_softc
modifier|*
name|sc
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint32_t
name|mask
parameter_list|)
block|{
name|bcm_lintc_write_4
argument_list|(
name|sc
argument_list|,
name|reg
argument_list|,
name|bcm_lintc_read_4
argument_list|(
name|sc
argument_list|,
name|reg
argument_list|)
operator||
name|mask
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bcm_lintc_timer_mask
parameter_list|(
name|struct
name|bcm_lintc_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|bcm_lintc_irqsrc
modifier|*
name|bli
parameter_list|)
block|{
name|cpuset_t
modifier|*
name|cpus
decl_stmt|;
name|uint32_t
name|cpu
decl_stmt|;
name|cpus
operator|=
operator|&
name|bli
operator|->
name|bli_isrc
operator|.
name|isrc_cpu
expr_stmt|;
name|BCM_LINTC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
for|for
control|(
name|cpu
operator|=
literal|0
init|;
name|cpu
operator|<
literal|4
condition|;
name|cpu
operator|++
control|)
if|if
condition|(
name|CPU_ISSET
argument_list|(
name|cpu
argument_list|,
name|cpus
argument_list|)
condition|)
name|bcm_lintc_rwreg_clr
argument_list|(
name|sc
argument_list|,
name|BCM_LINTC_TIMER_CFG_REG
argument_list|(
name|cpu
argument_list|)
argument_list|,
name|bli
operator|->
name|bli_mask
argument_list|)
expr_stmt|;
name|BCM_LINTC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bcm_lintc_timer_unmask
parameter_list|(
name|struct
name|bcm_lintc_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|bcm_lintc_irqsrc
modifier|*
name|bli
parameter_list|)
block|{
name|cpuset_t
modifier|*
name|cpus
decl_stmt|;
name|uint32_t
name|cpu
decl_stmt|;
name|cpus
operator|=
operator|&
name|bli
operator|->
name|bli_isrc
operator|.
name|isrc_cpu
expr_stmt|;
name|BCM_LINTC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
for|for
control|(
name|cpu
operator|=
literal|0
init|;
name|cpu
operator|<
literal|4
condition|;
name|cpu
operator|++
control|)
if|if
condition|(
name|CPU_ISSET
argument_list|(
name|cpu
argument_list|,
name|cpus
argument_list|)
condition|)
name|bcm_lintc_rwreg_set
argument_list|(
name|sc
argument_list|,
name|BCM_LINTC_TIMER_CFG_REG
argument_list|(
name|cpu
argument_list|)
argument_list|,
name|bli
operator|->
name|bli_mask
argument_list|)
expr_stmt|;
name|BCM_LINTC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|bcm_lintc_gpu_mask
parameter_list|(
name|struct
name|bcm_lintc_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|bcm_lintc_irqsrc
modifier|*
name|bli
parameter_list|)
block|{
comment|/* It's accessed just and only by one core. */
name|bcm_lintc_write_4
argument_list|(
name|sc
argument_list|,
name|BCM_LINTC_GPU_ROUTING_REG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|bcm_lintc_gpu_unmask
parameter_list|(
name|struct
name|bcm_lintc_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|bcm_lintc_irqsrc
modifier|*
name|bli
parameter_list|)
block|{
comment|/* It's accessed just and only by one core. */
name|bcm_lintc_write_4
argument_list|(
name|sc
argument_list|,
name|BCM_LINTC_GPU_ROUTING_REG
argument_list|,
name|bli
operator|->
name|bli_value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|bcm_lintc_pmu_mask
parameter_list|(
name|struct
name|bcm_lintc_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|bcm_lintc_irqsrc
modifier|*
name|bli
parameter_list|)
block|{
name|cpuset_t
modifier|*
name|cpus
decl_stmt|;
name|uint32_t
name|cpu
decl_stmt|,
name|mask
decl_stmt|;
name|mask
operator|=
literal|0
expr_stmt|;
name|cpus
operator|=
operator|&
name|bli
operator|->
name|bli_isrc
operator|.
name|isrc_cpu
expr_stmt|;
name|BCM_LINTC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
for|for
control|(
name|cpu
operator|=
literal|0
init|;
name|cpu
operator|<
literal|4
condition|;
name|cpu
operator|++
control|)
if|if
condition|(
name|CPU_ISSET
argument_list|(
name|cpu
argument_list|,
name|cpus
argument_list|)
condition|)
name|mask
operator||=
name|BCM_LINTC_PIRR_IRQ_EN_CORE
argument_list|(
name|cpu
argument_list|)
expr_stmt|;
comment|/* Write-clear register. */
name|bcm_lintc_write_4
argument_list|(
name|sc
argument_list|,
name|BCM_LINTC_PMU_ROUTING_CLR_REG
argument_list|,
name|mask
argument_list|)
expr_stmt|;
name|BCM_LINTC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|bcm_lintc_pmu_unmask
parameter_list|(
name|struct
name|bcm_lintc_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|bcm_lintc_irqsrc
modifier|*
name|bli
parameter_list|)
block|{
name|cpuset_t
modifier|*
name|cpus
decl_stmt|;
name|uint32_t
name|cpu
decl_stmt|,
name|mask
decl_stmt|;
name|mask
operator|=
literal|0
expr_stmt|;
name|cpus
operator|=
operator|&
name|bli
operator|->
name|bli_isrc
operator|.
name|isrc_cpu
expr_stmt|;
name|BCM_LINTC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
for|for
control|(
name|cpu
operator|=
literal|0
init|;
name|cpu
operator|<
literal|4
condition|;
name|cpu
operator|++
control|)
if|if
condition|(
name|CPU_ISSET
argument_list|(
name|cpu
argument_list|,
name|cpus
argument_list|)
condition|)
name|mask
operator||=
name|BCM_LINTC_PIRR_IRQ_EN_CORE
argument_list|(
name|cpu
argument_list|)
expr_stmt|;
comment|/* Write-set register. */
name|bcm_lintc_write_4
argument_list|(
name|sc
argument_list|,
name|BCM_LINTC_PMU_ROUTING_SET_REG
argument_list|,
name|mask
argument_list|)
expr_stmt|;
name|BCM_LINTC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bcm_lintc_mask
parameter_list|(
name|struct
name|bcm_lintc_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|bcm_lintc_irqsrc
modifier|*
name|bli
parameter_list|)
block|{
switch|switch
condition|(
name|bli
operator|->
name|bli_irq
condition|)
block|{
case|case
name|BCM_LINTC_TIMER0_IRQ
case|:
case|case
name|BCM_LINTC_TIMER1_IRQ
case|:
case|case
name|BCM_LINTC_TIMER2_IRQ
case|:
case|case
name|BCM_LINTC_TIMER3_IRQ
case|:
name|bcm_lintc_timer_mask
argument_list|(
name|sc
argument_list|,
name|bli
argument_list|)
expr_stmt|;
return|return;
case|case
name|BCM_LINTC_MBOX0_IRQ
case|:
case|case
name|BCM_LINTC_MBOX1_IRQ
case|:
case|case
name|BCM_LINTC_MBOX2_IRQ
case|:
case|case
name|BCM_LINTC_MBOX3_IRQ
case|:
return|return;
case|case
name|BCM_LINTC_GPU_IRQ
case|:
name|bcm_lintc_gpu_mask
argument_list|(
name|sc
argument_list|,
name|bli
argument_list|)
expr_stmt|;
return|return;
case|case
name|BCM_LINTC_PMU_IRQ
case|:
name|bcm_lintc_pmu_mask
argument_list|(
name|sc
argument_list|,
name|bli
argument_list|)
expr_stmt|;
return|return;
default|default:
name|panic
argument_list|(
literal|"%s: not implemented for irq %u"
argument_list|,
name|__func__
argument_list|,
name|bli
operator|->
name|bli_irq
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bcm_lintc_unmask
parameter_list|(
name|struct
name|bcm_lintc_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|bcm_lintc_irqsrc
modifier|*
name|bli
parameter_list|)
block|{
switch|switch
condition|(
name|bli
operator|->
name|bli_irq
condition|)
block|{
case|case
name|BCM_LINTC_TIMER0_IRQ
case|:
case|case
name|BCM_LINTC_TIMER1_IRQ
case|:
case|case
name|BCM_LINTC_TIMER2_IRQ
case|:
case|case
name|BCM_LINTC_TIMER3_IRQ
case|:
name|bcm_lintc_timer_unmask
argument_list|(
name|sc
argument_list|,
name|bli
argument_list|)
expr_stmt|;
return|return;
case|case
name|BCM_LINTC_MBOX0_IRQ
case|:
case|case
name|BCM_LINTC_MBOX1_IRQ
case|:
case|case
name|BCM_LINTC_MBOX2_IRQ
case|:
case|case
name|BCM_LINTC_MBOX3_IRQ
case|:
return|return;
case|case
name|BCM_LINTC_GPU_IRQ
case|:
name|bcm_lintc_gpu_unmask
argument_list|(
name|sc
argument_list|,
name|bli
argument_list|)
expr_stmt|;
return|return;
case|case
name|BCM_LINTC_PMU_IRQ
case|:
name|bcm_lintc_pmu_unmask
argument_list|(
name|sc
argument_list|,
name|bli
argument_list|)
expr_stmt|;
return|return;
default|default:
name|panic
argument_list|(
literal|"%s: not implemented for irq %u"
argument_list|,
name|__func__
argument_list|,
name|bli
operator|->
name|bli_irq
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SMP
end_ifdef

begin_function
specifier|static
specifier|inline
name|void
name|bcm_lintc_ipi_write
parameter_list|(
name|struct
name|bcm_lintc_softc
modifier|*
name|sc
parameter_list|,
name|cpuset_t
name|cpus
parameter_list|,
name|u_int
name|ipi
parameter_list|)
block|{
name|u_int
name|cpu
decl_stmt|;
name|uint32_t
name|mask
decl_stmt|;
name|mask
operator|=
literal|1
operator|<<
name|ipi
expr_stmt|;
for|for
control|(
name|cpu
operator|=
literal|0
init|;
name|cpu
operator|<
name|mp_ncpus
condition|;
name|cpu
operator|++
control|)
if|if
condition|(
name|CPU_ISSET
argument_list|(
name|cpu
argument_list|,
operator|&
name|cpus
argument_list|)
condition|)
name|bcm_lintc_write_4
argument_list|(
name|sc
argument_list|,
name|BCM_LINTC_MBOX0_SET_REG
argument_list|(
name|cpu
argument_list|)
argument_list|,
name|mask
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|bcm_lintc_ipi_dispatch
parameter_list|(
name|struct
name|bcm_lintc_softc
modifier|*
name|sc
parameter_list|,
name|u_int
name|cpu
parameter_list|,
name|struct
name|trapframe
modifier|*
name|tf
parameter_list|)
block|{
name|u_int
name|ipi
decl_stmt|;
name|uint32_t
name|mask
decl_stmt|;
name|mask
operator|=
name|bcm_lintc_read_4
argument_list|(
name|sc
argument_list|,
name|BCM_LINTC_MBOX0_CLR_REG
argument_list|(
name|cpu
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|bls_dev
argument_list|,
literal|"Spurious ipi detected\n"
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|ipi
operator|=
literal|0
init|;
name|mask
operator|!=
literal|0
condition|;
name|mask
operator|>>=
literal|1
operator|,
name|ipi
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|mask
operator|&
literal|0x01
operator|)
operator|==
literal|0
condition|)
continue|continue;
comment|/* 		 * Clear an IPI before dispatching to not miss anyone 		 * and make sure that it's observed by everybody. 		 */
name|bcm_lintc_write_4
argument_list|(
name|sc
argument_list|,
name|BCM_LINTC_MBOX0_CLR_REG
argument_list|(
name|cpu
argument_list|)
argument_list|,
literal|1
operator|<<
name|ipi
argument_list|)
expr_stmt|;
name|dsb
argument_list|()
expr_stmt|;
name|intr_ipi_dispatch
argument_list|(
name|ipi
argument_list|,
name|tf
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
specifier|inline
name|void
name|bcm_lintc_irq_dispatch
parameter_list|(
name|struct
name|bcm_lintc_softc
modifier|*
name|sc
parameter_list|,
name|u_int
name|irq
parameter_list|,
name|struct
name|trapframe
modifier|*
name|tf
parameter_list|)
block|{
name|struct
name|bcm_lintc_irqsrc
modifier|*
name|bli
decl_stmt|;
name|bli
operator|=
operator|&
name|sc
operator|->
name|bls_isrcs
index|[
name|irq
index|]
expr_stmt|;
if|if
condition|(
name|intr_isrc_dispatch
argument_list|(
operator|&
name|bli
operator|->
name|bli_isrc
argument_list|,
name|tf
argument_list|)
operator|!=
literal|0
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|bls_dev
argument_list|,
literal|"Stray irq %u detected\n"
argument_list|,
name|irq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm_lintc_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|bcm_lintc_softc
modifier|*
name|sc
decl_stmt|;
name|u_int
name|cpu
decl_stmt|;
name|uint32_t
name|num
decl_stmt|,
name|reg
decl_stmt|;
name|struct
name|trapframe
modifier|*
name|tf
decl_stmt|;
name|sc
operator|=
name|arg
expr_stmt|;
name|cpu
operator|=
name|PCPU_GET
argument_list|(
name|cpuid
argument_list|)
expr_stmt|;
name|tf
operator|=
name|curthread
operator|->
name|td_intr_frame
expr_stmt|;
for|for
control|(
name|num
operator|=
literal|0
init|;
condition|;
name|num
operator|++
control|)
block|{
name|reg
operator|=
name|bcm_lintc_read_4
argument_list|(
name|sc
argument_list|,
name|BCM_LINTC_PENDING_REG
argument_list|(
name|cpu
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|reg
operator|&
name|BCM_LINTC_PENDING_MASK
operator|)
operator|==
literal|0
condition|)
break|break;
ifdef|#
directive|ifdef
name|SMP
if|if
condition|(
name|reg
operator|&
name|BCM_LINTC_MBOX0_IRQ_MASK
condition|)
name|bcm_lintc_ipi_dispatch
argument_list|(
name|sc
argument_list|,
name|cpu
argument_list|,
name|tf
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|reg
operator|&
name|BCM_LINTC_TIMER0_IRQ_MASK
condition|)
name|bcm_lintc_irq_dispatch
argument_list|(
name|sc
argument_list|,
name|BCM_LINTC_TIMER0_IRQ
argument_list|,
name|tf
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|BCM_LINTC_TIMER1_IRQ_MASK
condition|)
name|bcm_lintc_irq_dispatch
argument_list|(
name|sc
argument_list|,
name|BCM_LINTC_TIMER1_IRQ
argument_list|,
name|tf
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|BCM_LINTC_TIMER2_IRQ_MASK
condition|)
name|bcm_lintc_irq_dispatch
argument_list|(
name|sc
argument_list|,
name|BCM_LINTC_TIMER2_IRQ
argument_list|,
name|tf
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|BCM_LINTC_TIMER3_IRQ_MASK
condition|)
name|bcm_lintc_irq_dispatch
argument_list|(
name|sc
argument_list|,
name|BCM_LINTC_TIMER3_IRQ
argument_list|,
name|tf
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|BCM_LINTC_GPU_IRQ_MASK
condition|)
name|bcm_lintc_irq_dispatch
argument_list|(
name|sc
argument_list|,
name|BCM_LINTC_GPU_IRQ
argument_list|,
name|tf
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|BCM_LINTC_PMU_IRQ_MASK
condition|)
name|bcm_lintc_irq_dispatch
argument_list|(
name|sc
argument_list|,
name|BCM_LINTC_PMU_IRQ
argument_list|,
name|tf
argument_list|)
expr_stmt|;
name|arm_irq_memory_barrier
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* XXX */
block|}
name|reg
operator|&=
operator|~
name|BCM_LINTC_PENDING_MASK
expr_stmt|;
if|if
condition|(
name|reg
operator|!=
literal|0
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|bls_dev
argument_list|,
literal|"Unknown interrupt(s) %x\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|num
operator|==
literal|0
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|bls_dev
argument_list|,
literal|"Spurious interrupt detected\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|FILTER_HANDLED
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bcm_lintc_disable_intr
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|intr_irqsrc
modifier|*
name|isrc
parameter_list|)
block|{
name|bcm_lintc_mask
argument_list|(
name|device_get_softc
argument_list|(
name|dev
argument_list|)
argument_list|,
operator|(
expr|struct
name|bcm_lintc_irqsrc
operator|*
operator|)
name|isrc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bcm_lintc_enable_intr
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|intr_irqsrc
modifier|*
name|isrc
parameter_list|)
block|{
name|struct
name|bcm_lintc_irqsrc
modifier|*
name|bli
init|=
operator|(
expr|struct
name|bcm_lintc_irqsrc
operator|*
operator|)
name|isrc
decl_stmt|;
name|arm_irq_memory_barrier
argument_list|(
name|bli
operator|->
name|bli_irq
argument_list|)
expr_stmt|;
name|bcm_lintc_unmask
argument_list|(
name|device_get_softc
argument_list|(
name|dev
argument_list|)
argument_list|,
name|bli
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm_lintc_map_intr
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|intr_map_data
modifier|*
name|data
parameter_list|,
name|struct
name|intr_irqsrc
modifier|*
modifier|*
name|isrcp
parameter_list|)
block|{
name|struct
name|bcm_lintc_softc
modifier|*
name|sc
decl_stmt|;
if|if
condition|(
name|data
operator|->
name|type
operator|!=
name|INTR_MAP_DATA_FDT
condition|)
return|return
operator|(
name|ENOTSUP
operator|)
return|;
if|if
condition|(
name|data
operator|->
name|fdt
operator|.
name|ncells
operator|!=
literal|1
operator|||
name|data
operator|->
name|fdt
operator|.
name|cells
index|[
literal|0
index|]
operator|>=
name|BCM_LINTC_NIRQS
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
operator|*
name|isrcp
operator|=
operator|&
name|sc
operator|->
name|bls_isrcs
index|[
name|data
operator|->
name|fdt
operator|.
name|cells
index|[
literal|0
index|]
index|]
operator|.
name|bli_isrc
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bcm_lintc_pre_ithread
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|intr_irqsrc
modifier|*
name|isrc
parameter_list|)
block|{
name|struct
name|bcm_lintc_irqsrc
modifier|*
name|bli
init|=
operator|(
expr|struct
name|bcm_lintc_irqsrc
operator|*
operator|)
name|isrc
decl_stmt|;
if|if
condition|(
name|bli
operator|->
name|bli_irq
operator|==
name|BCM_LINTC_GPU_IRQ
condition|)
name|bcm_lintc_gpu_mask
argument_list|(
name|device_get_softc
argument_list|(
name|dev
argument_list|)
argument_list|,
name|bli
argument_list|)
expr_stmt|;
else|else
block|{
comment|/* 		 * Handler for PPI interrupt does not make sense much unless 		 * there is one bound ithread for each core for it. Thus the 		 * interrupt can be masked on current core only while ithread 		 * bounded to this core ensures unmasking on the same core. 		 */
name|panic
argument_list|(
literal|"%s: handlers are not supported"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bcm_lintc_post_ithread
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|intr_irqsrc
modifier|*
name|isrc
parameter_list|)
block|{
name|struct
name|bcm_lintc_irqsrc
modifier|*
name|bli
init|=
operator|(
expr|struct
name|bcm_lintc_irqsrc
operator|*
operator|)
name|isrc
decl_stmt|;
if|if
condition|(
name|bli
operator|->
name|bli_irq
operator|==
name|BCM_LINTC_GPU_IRQ
condition|)
name|bcm_lintc_gpu_unmask
argument_list|(
name|device_get_softc
argument_list|(
name|dev
argument_list|)
argument_list|,
name|bli
argument_list|)
expr_stmt|;
else|else
block|{
comment|/* See comment in bcm_lintc_pre_ithread(). */
name|panic
argument_list|(
literal|"%s: handlers are not supported"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bcm_lintc_post_filter
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|intr_irqsrc
modifier|*
name|isrc
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|int
name|bcm_lintc_setup_intr
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|intr_irqsrc
modifier|*
name|isrc
parameter_list|,
name|struct
name|resource
modifier|*
name|res
parameter_list|,
name|struct
name|intr_map_data
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|bcm_lintc_softc
modifier|*
name|sc
decl_stmt|;
if|if
condition|(
name|isrc
operator|->
name|isrc_handlers
operator|==
literal|0
operator|&&
name|isrc
operator|->
name|isrc_flags
operator|&
name|INTR_ISRCF_PPI
condition|)
block|{
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|BCM_LINTC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|CPU_SET
argument_list|(
name|PCPU_GET
argument_list|(
name|cpuid
argument_list|)
argument_list|,
operator|&
name|isrc
operator|->
name|isrc_cpu
argument_list|)
expr_stmt|;
name|BCM_LINTC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|SMP
end_ifdef

begin_function
specifier|static
name|void
name|bcm_lintc_init_rwreg_on_ap
parameter_list|(
name|struct
name|bcm_lintc_softc
modifier|*
name|sc
parameter_list|,
name|u_int
name|cpu
parameter_list|,
name|u_int
name|irq
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint32_t
name|mask
parameter_list|)
block|{
if|if
condition|(
name|intr_isrc_init_on_cpu
argument_list|(
operator|&
name|sc
operator|->
name|bls_isrcs
index|[
name|irq
index|]
operator|.
name|bli_isrc
argument_list|,
name|cpu
argument_list|)
condition|)
name|bcm_lintc_rwreg_set
argument_list|(
name|sc
argument_list|,
name|reg
argument_list|,
name|mask
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bcm_lintc_init_pmu_on_ap
parameter_list|(
name|struct
name|bcm_lintc_softc
modifier|*
name|sc
parameter_list|,
name|u_int
name|cpu
parameter_list|)
block|{
name|struct
name|intr_irqsrc
modifier|*
name|isrc
init|=
operator|&
name|sc
operator|->
name|bls_isrcs
index|[
name|BCM_LINTC_PMU_IRQ
index|]
operator|.
name|bli_isrc
decl_stmt|;
if|if
condition|(
name|intr_isrc_init_on_cpu
argument_list|(
name|isrc
argument_list|,
name|cpu
argument_list|)
condition|)
block|{
comment|/* Write-set register. */
name|bcm_lintc_write_4
argument_list|(
name|sc
argument_list|,
name|BCM_LINTC_PMU_ROUTING_SET_REG
argument_list|,
name|BCM_LINTC_PIRR_IRQ_EN_CORE
argument_list|(
name|cpu
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|bcm_lintc_init_secondary
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|u_int
name|cpu
decl_stmt|;
name|struct
name|bcm_lintc_softc
modifier|*
name|sc
decl_stmt|;
name|cpu
operator|=
name|PCPU_GET
argument_list|(
name|cpuid
argument_list|)
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|BCM_LINTC_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|bcm_lintc_init_rwreg_on_ap
argument_list|(
name|sc
argument_list|,
name|cpu
argument_list|,
name|BCM_LINTC_TIMER0_IRQ
argument_list|,
name|BCM_LINTC_TIMER_CFG_REG
argument_list|(
name|cpu
argument_list|)
argument_list|,
name|BCM_LINTC_TCR_IRQ_EN_TIMER
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|bcm_lintc_init_rwreg_on_ap
argument_list|(
name|sc
argument_list|,
name|cpu
argument_list|,
name|BCM_LINTC_TIMER1_IRQ
argument_list|,
name|BCM_LINTC_TIMER_CFG_REG
argument_list|(
name|cpu
argument_list|)
argument_list|,
name|BCM_LINTC_TCR_IRQ_EN_TIMER
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|bcm_lintc_init_rwreg_on_ap
argument_list|(
name|sc
argument_list|,
name|cpu
argument_list|,
name|BCM_LINTC_TIMER2_IRQ
argument_list|,
name|BCM_LINTC_TIMER_CFG_REG
argument_list|(
name|cpu
argument_list|)
argument_list|,
name|BCM_LINTC_TCR_IRQ_EN_TIMER
argument_list|(
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|bcm_lintc_init_rwreg_on_ap
argument_list|(
name|sc
argument_list|,
name|cpu
argument_list|,
name|BCM_LINTC_TIMER3_IRQ
argument_list|,
name|BCM_LINTC_TIMER_CFG_REG
argument_list|(
name|cpu
argument_list|)
argument_list|,
name|BCM_LINTC_TCR_IRQ_EN_TIMER
argument_list|(
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|bcm_lintc_init_pmu_on_ap
argument_list|(
name|sc
argument_list|,
name|cpu
argument_list|)
expr_stmt|;
name|BCM_LINTC_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bcm_lintc_ipi_send
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|struct
name|intr_irqsrc
modifier|*
name|isrc
parameter_list|,
name|cpuset_t
name|cpus
parameter_list|,
name|u_int
name|ipi
parameter_list|)
block|{
name|struct
name|bcm_lintc_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|KASSERT
argument_list|(
name|isrc
operator|==
operator|&
name|sc
operator|->
name|bls_isrcs
index|[
name|BCM_LINTC_MBOX0_IRQ
index|]
operator|.
name|bli_isrc
argument_list|,
operator|(
literal|"%s: bad ISRC %p argument"
operator|,
name|__func__
operator|,
name|isrc
operator|)
argument_list|)
expr_stmt|;
name|bcm_lintc_ipi_write
argument_list|(
name|sc
argument_list|,
name|cpus
argument_list|,
name|ipi
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm_lintc_ipi_setup
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|u_int
name|ipi
parameter_list|,
name|struct
name|intr_irqsrc
modifier|*
modifier|*
name|isrcp
parameter_list|)
block|{
name|struct
name|bcm_lintc_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|KASSERT
argument_list|(
name|ipi
operator|<
name|BCM_LINTC_NIPIS
argument_list|,
operator|(
literal|"%s: too high ipi %u"
operator|,
name|__func__
operator|,
name|ipi
operator|)
argument_list|)
expr_stmt|;
operator|*
name|isrcp
operator|=
operator|&
name|sc
operator|->
name|bls_isrcs
index|[
name|BCM_LINTC_MBOX0_IRQ
index|]
operator|.
name|bli_isrc
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|bcm_lintc_pic_attach
parameter_list|(
name|struct
name|bcm_lintc_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|bcm_lintc_irqsrc
modifier|*
name|bisrcs
decl_stmt|;
name|int
name|error
decl_stmt|;
name|u_int
name|flags
decl_stmt|;
name|uint32_t
name|irq
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|intptr_t
name|xref
decl_stmt|;
name|bisrcs
operator|=
name|sc
operator|->
name|bls_isrcs
expr_stmt|;
name|name
operator|=
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|bls_dev
argument_list|)
expr_stmt|;
for|for
control|(
name|irq
operator|=
literal|0
init|;
name|irq
operator|<
name|BCM_LINTC_NIRQS
condition|;
name|irq
operator|++
control|)
block|{
name|bisrcs
index|[
name|irq
index|]
operator|.
name|bli_irq
operator|=
name|irq
expr_stmt|;
switch|switch
condition|(
name|irq
condition|)
block|{
case|case
name|BCM_LINTC_TIMER0_IRQ
case|:
name|bisrcs
index|[
name|irq
index|]
operator|.
name|bli_mask
operator|=
name|BCM_LINTC_TCR_IRQ_EN_TIMER
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|flags
operator|=
name|INTR_ISRCF_PPI
expr_stmt|;
break|break;
case|case
name|BCM_LINTC_TIMER1_IRQ
case|:
name|bisrcs
index|[
name|irq
index|]
operator|.
name|bli_mask
operator|=
name|BCM_LINTC_TCR_IRQ_EN_TIMER
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|flags
operator|=
name|INTR_ISRCF_PPI
expr_stmt|;
break|break;
case|case
name|BCM_LINTC_TIMER2_IRQ
case|:
name|bisrcs
index|[
name|irq
index|]
operator|.
name|bli_mask
operator|=
name|BCM_LINTC_TCR_IRQ_EN_TIMER
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|flags
operator|=
name|INTR_ISRCF_PPI
expr_stmt|;
break|break;
case|case
name|BCM_LINTC_TIMER3_IRQ
case|:
name|bisrcs
index|[
name|irq
index|]
operator|.
name|bli_mask
operator|=
name|BCM_LINTC_TCR_IRQ_EN_TIMER
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|flags
operator|=
name|INTR_ISRCF_PPI
expr_stmt|;
break|break;
case|case
name|BCM_LINTC_MBOX0_IRQ
case|:
case|case
name|BCM_LINTC_MBOX1_IRQ
case|:
case|case
name|BCM_LINTC_MBOX2_IRQ
case|:
case|case
name|BCM_LINTC_MBOX3_IRQ
case|:
name|bisrcs
index|[
name|irq
index|]
operator|.
name|bli_value
operator|=
literal|0
expr_stmt|;
comment|/* not used */
name|flags
operator|=
name|INTR_ISRCF_IPI
expr_stmt|;
break|break;
case|case
name|BCM_LINTC_GPU_IRQ
case|:
name|bisrcs
index|[
name|irq
index|]
operator|.
name|bli_value
operator|=
name|BCM_LINTC_GIRR_IRQ_CORE
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|flags
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|BCM_LINTC_PMU_IRQ
case|:
name|bisrcs
index|[
name|irq
index|]
operator|.
name|bli_value
operator|=
literal|0
expr_stmt|;
comment|/* not used */
name|flags
operator|=
name|INTR_ISRCF_PPI
expr_stmt|;
break|break;
default|default:
name|bisrcs
index|[
name|irq
index|]
operator|.
name|bli_value
operator|=
literal|0
expr_stmt|;
comment|/* not used */
name|flags
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|error
operator|=
name|intr_isrc_register
argument_list|(
operator|&
name|bisrcs
index|[
name|irq
index|]
operator|.
name|bli_isrc
argument_list|,
name|sc
operator|->
name|bls_dev
argument_list|,
name|flags
argument_list|,
literal|"%s,%u"
argument_list|,
name|name
argument_list|,
name|irq
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
name|xref
operator|=
name|OF_xref_from_node
argument_list|(
name|ofw_bus_get_node
argument_list|(
name|sc
operator|->
name|bls_dev
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|intr_pic_register
argument_list|(
name|sc
operator|->
name|bls_dev
argument_list|,
name|xref
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
return|return
operator|(
name|intr_pic_claim_root
argument_list|(
name|sc
operator|->
name|bls_dev
argument_list|,
name|xref
argument_list|,
name|bcm_lintc_intr
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm_lintc_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
operator|!
name|ofw_bus_status_okay
argument_list|(
name|dev
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
operator|!
name|ofw_bus_is_compatible
argument_list|(
name|dev
argument_list|,
literal|"brcm,bcm2836-l1-intc"
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"BCM2836 Interrupt Controller"
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm_lintc_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|bcm_lintc_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|cpu
decl_stmt|,
name|rid
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bls_dev
operator|=
name|dev
expr_stmt|;
if|if
condition|(
name|bcm_lintc_sc
operator|!=
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|bls_mem
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|bls_mem
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not allocate memory resource\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|sc
operator|->
name|bls_bst
operator|=
name|rman_get_bustag
argument_list|(
name|sc
operator|->
name|bls_mem
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bls_bsh
operator|=
name|rman_get_bushandle
argument_list|(
name|sc
operator|->
name|bls_mem
argument_list|)
expr_stmt|;
name|bcm_lintc_write_4
argument_list|(
name|sc
argument_list|,
name|BCM_LINTC_CONTROL_REG
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bcm_lintc_write_4
argument_list|(
name|sc
argument_list|,
name|BCM_LINTC_PRESCALER_REG
argument_list|,
name|BCM_LINTC_PSR_19_2
argument_list|)
expr_stmt|;
comment|/* Disable all timers on all cores. */
for|for
control|(
name|cpu
operator|=
literal|0
init|;
name|cpu
operator|<
literal|4
condition|;
name|cpu
operator|++
control|)
name|bcm_lintc_write_4
argument_list|(
name|sc
argument_list|,
name|BCM_LINTC_TIMER_CFG_REG
argument_list|(
name|cpu
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SMP
comment|/* Enable mailbox 0 on all cores used for IPI. */
for|for
control|(
name|cpu
operator|=
literal|0
init|;
name|cpu
operator|<
literal|4
condition|;
name|cpu
operator|++
control|)
name|bcm_lintc_write_4
argument_list|(
name|sc
argument_list|,
name|BCM_LINTC_MBOX_CFG_REG
argument_list|(
name|cpu
argument_list|)
argument_list|,
name|BCM_LINTC_MCR_IRQ_EN_MBOX
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|bcm_lintc_pic_attach
argument_list|(
name|sc
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not attach PIC\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|BCM_LINTC_LOCK_INIT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|bcm_lintc_sc
operator|=
name|sc
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|bcm_lintc_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|bcm_lintc_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|bcm_lintc_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|pic_disable_intr
argument_list|,
name|bcm_lintc_disable_intr
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|pic_enable_intr
argument_list|,
name|bcm_lintc_enable_intr
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|pic_map_intr
argument_list|,
name|bcm_lintc_map_intr
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|pic_post_filter
argument_list|,
name|bcm_lintc_post_filter
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|pic_post_ithread
argument_list|,
name|bcm_lintc_post_ithread
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|pic_pre_ithread
argument_list|,
name|bcm_lintc_pre_ithread
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|pic_setup_intr
argument_list|,
name|bcm_lintc_setup_intr
argument_list|)
block|,
ifdef|#
directive|ifdef
name|SMP
name|DEVMETHOD
argument_list|(
name|pic_init_secondary
argument_list|,
name|bcm_lintc_init_secondary
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|pic_ipi_send
argument_list|,
name|bcm_lintc_ipi_send
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|pic_ipi_setup
argument_list|,
name|bcm_lintc_ipi_setup
argument_list|)
block|,
endif|#
directive|endif
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|bcm_lintc_driver
init|=
block|{
literal|"local_intc"
block|,
name|bcm_lintc_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|bcm_lintc_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|bcm_lintc_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|EARLY_DRIVER_MODULE
argument_list|(
name|local_intc
argument_list|,
name|simplebus
argument_list|,
name|bcm_lintc_driver
argument_list|,
name|bcm_lintc_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|BUS_PASS_INTERRUPT
operator|+
name|BUS_PASS_ORDER_MIDDLE
argument_list|)
expr_stmt|;
end_expr_stmt

begin_else
else|#
directive|else
end_else

begin_comment
comment|/*  * A driver for features of the bcm2836.  */
end_comment

begin_struct
struct|struct
name|bcm2836_softc
block|{
name|device_t
name|sc_dev
decl_stmt|;
name|struct
name|resource
modifier|*
name|sc_mem
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|device_identify_t
name|bcm2836_identify
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_probe_t
name|bcm2836_probe
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|device_attach_t
name|bcm2836_attach
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|bcm2836_softc
modifier|*
name|softc
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|bcm2836_identify
parameter_list|(
name|driver_t
modifier|*
name|driver
parameter_list|,
name|device_t
name|parent
parameter_list|)
block|{
if|if
condition|(
name|BUS_ADD_CHILD
argument_list|(
name|parent
argument_list|,
literal|0
argument_list|,
literal|"bcm2836"
argument_list|,
operator|-
literal|1
argument_list|)
operator|==
name|NULL
condition|)
name|device_printf
argument_list|(
name|parent
argument_list|,
literal|"add child failed\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm2836_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
name|softc
operator|!=
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Broadcom bcm2836"
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm2836_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|rid
decl_stmt|;
name|softc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|softc
operator|->
name|sc_dev
operator|=
name|dev
expr_stmt|;
name|rid
operator|=
literal|0
expr_stmt|;
name|softc
operator|->
name|sc_mem
operator|=
name|bus_alloc_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
name|ARM_LOCAL_BASE
argument_list|,
name|ARM_LOCAL_BASE
operator|+
name|ARM_LOCAL_SIZE
argument_list|,
name|ARM_LOCAL_SIZE
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|softc
operator|->
name|sc_mem
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not allocate memory resource\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|bus_write_4
argument_list|(
name|softc
operator|->
name|sc_mem
argument_list|,
name|ARM_LOCAL_CONTROL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bus_write_4
argument_list|(
name|softc
operator|->
name|sc_mem
argument_list|,
name|ARM_LOCAL_PRESCALER
argument_list|,
name|PRESCALER_19_2
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|bus_write_4
argument_list|(
name|softc
operator|->
name|sc_mem
argument_list|,
name|ARM_LOCAL_INT_TIMER
argument_list|(
name|i
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|bus_write_4
argument_list|(
name|softc
operator|->
name|sc_mem
argument_list|,
name|ARM_LOCAL_INT_MAILBOX
argument_list|(
name|i
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bcm2836_get_next_irq
parameter_list|(
name|int
name|last_irq
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|int
name|cpu
decl_stmt|;
name|int
name|irq
decl_stmt|;
name|cpu
operator|=
name|PCPU_GET
argument_list|(
name|cpuid
argument_list|)
expr_stmt|;
name|reg
operator|=
name|bus_read_4
argument_list|(
name|softc
operator|->
name|sc_mem
argument_list|,
name|ARM_LOCAL_INT_PENDING
argument_list|(
name|cpu
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator|&=
name|INT_PENDING_MASK
expr_stmt|;
if|if
condition|(
name|reg
operator|==
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|irq
operator|=
name|ffs
argument_list|(
name|reg
argument_list|)
operator|-
literal|1
expr_stmt|;
return|return
operator|(
name|irq
operator|)
return|;
block|}
end_function

begin_function
name|void
name|bcm2836_mask_irq
parameter_list|(
name|uintptr_t
name|irq
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
ifdef|#
directive|ifdef
name|SMP
name|int
name|cpu
decl_stmt|;
endif|#
directive|endif
name|int
name|i
decl_stmt|;
if|if
condition|(
name|irq
operator|<
name|MAILBOX0_IRQ
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|reg
operator|=
name|bus_read_4
argument_list|(
name|softc
operator|->
name|sc_mem
argument_list|,
name|ARM_LOCAL_INT_TIMER
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|irq
operator|)
expr_stmt|;
name|bus_write_4
argument_list|(
name|softc
operator|->
name|sc_mem
argument_list|,
name|ARM_LOCAL_INT_TIMER
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|SMP
block|}
elseif|else
if|if
condition|(
name|irq
operator|==
name|MAILBOX0_IRQ
condition|)
block|{
comment|/* Mailbox 0 for IPI */
name|cpu
operator|=
name|PCPU_GET
argument_list|(
name|cpuid
argument_list|)
expr_stmt|;
name|reg
operator|=
name|bus_read_4
argument_list|(
name|softc
operator|->
name|sc_mem
argument_list|,
name|ARM_LOCAL_INT_MAILBOX
argument_list|(
name|cpu
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|MAILBOX0_IRQEN
expr_stmt|;
name|bus_write_4
argument_list|(
name|softc
operator|->
name|sc_mem
argument_list|,
name|ARM_LOCAL_INT_MAILBOX
argument_list|(
name|cpu
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
block|}
end_function

begin_function
name|void
name|bcm2836_unmask_irq
parameter_list|(
name|uintptr_t
name|irq
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
ifdef|#
directive|ifdef
name|SMP
name|int
name|cpu
decl_stmt|;
endif|#
directive|endif
name|int
name|i
decl_stmt|;
if|if
condition|(
name|irq
operator|<
name|MAILBOX0_IRQ
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|reg
operator|=
name|bus_read_4
argument_list|(
name|softc
operator|->
name|sc_mem
argument_list|,
name|ARM_LOCAL_INT_TIMER
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator||=
operator|(
literal|1
operator|<<
name|irq
operator|)
expr_stmt|;
name|bus_write_4
argument_list|(
name|softc
operator|->
name|sc_mem
argument_list|,
name|ARM_LOCAL_INT_TIMER
argument_list|(
name|i
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|SMP
block|}
elseif|else
if|if
condition|(
name|irq
operator|==
name|MAILBOX0_IRQ
condition|)
block|{
comment|/* Mailbox 0 for IPI */
name|cpu
operator|=
name|PCPU_GET
argument_list|(
name|cpuid
argument_list|)
expr_stmt|;
name|reg
operator|=
name|bus_read_4
argument_list|(
name|softc
operator|->
name|sc_mem
argument_list|,
name|ARM_LOCAL_INT_MAILBOX
argument_list|(
name|cpu
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator||=
name|MAILBOX0_IRQEN
expr_stmt|;
name|bus_write_4
argument_list|(
name|softc
operator|->
name|sc_mem
argument_list|,
name|ARM_LOCAL_INT_MAILBOX
argument_list|(
name|cpu
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|bcm2836_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_identify
argument_list|,
name|bcm2836_identify
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|bcm2836_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|bcm2836_attach
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|bcm2836_devclass
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|bcm2836_driver
init|=
block|{
literal|"bcm2836"
block|,
name|bcm2836_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|bcm2836_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|EARLY_DRIVER_MODULE
argument_list|(
name|bcm2836
argument_list|,
name|nexus
argument_list|,
name|bcm2836_driver
argument_list|,
name|bcm2836_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|BUS_PASS_INTERRUPT
operator|+
name|BUS_PASS_ORDER_MIDDLE
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

end_unit


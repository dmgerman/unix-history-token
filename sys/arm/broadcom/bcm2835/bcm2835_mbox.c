begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2012 Oleksandr Tymoshenko<gonzo@freebsd.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/sx.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus_subr.h>
end_include

begin_include
include|#
directive|include
file|<arm/broadcom/bcm2835/bcm2835_mbox.h>
end_include

begin_include
include|#
directive|include
file|<arm/broadcom/bcm2835/bcm2835_mbox_prop.h>
end_include

begin_include
include|#
directive|include
file|<arm/broadcom/bcm2835/bcm2835_vcbus.h>
end_include

begin_include
include|#
directive|include
file|"mbox_if.h"
end_include

begin_define
define|#
directive|define
name|REG_READ
value|0x00
end_define

begin_define
define|#
directive|define
name|REG_POL
value|0x10
end_define

begin_define
define|#
directive|define
name|REG_SENDER
value|0x14
end_define

begin_define
define|#
directive|define
name|REG_STATUS
value|0x18
end_define

begin_define
define|#
directive|define
name|STATUS_FULL
value|0x80000000
end_define

begin_define
define|#
directive|define
name|STATUS_EMPTY
value|0x40000000
end_define

begin_define
define|#
directive|define
name|REG_CONFIG
value|0x1C
end_define

begin_define
define|#
directive|define
name|CONFIG_DATA_IRQ
value|0x00000001
end_define

begin_define
define|#
directive|define
name|REG_WRITE
value|0x20
end_define

begin_comment
comment|/* This is Mailbox 1 address */
end_comment

begin_define
define|#
directive|define
name|MBOX_MSG
parameter_list|(
name|chan
parameter_list|,
name|data
parameter_list|)
value|(((data)& ~0xf) | ((chan)& 0xf))
end_define

begin_define
define|#
directive|define
name|MBOX_CHAN
parameter_list|(
name|msg
parameter_list|)
value|((msg)& 0xf)
end_define

begin_define
define|#
directive|define
name|MBOX_DATA
parameter_list|(
name|msg
parameter_list|)
value|((msg)& ~0xf)
end_define

begin_define
define|#
directive|define
name|MBOX_LOCK
parameter_list|(
name|sc
parameter_list|)
value|do {	\ 	mtx_lock(&(sc)->lock);	\ } while(0)
end_define

begin_define
define|#
directive|define
name|MBOX_UNLOCK
parameter_list|(
name|sc
parameter_list|)
value|do {		\ 	mtx_unlock(&(sc)->lock);	\ } while(0)
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_define
define|#
directive|define
name|dprintf
parameter_list|(
name|fmt
parameter_list|,
name|args
modifier|...
parameter_list|)
value|printf(fmt, ##args)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|dprintf
parameter_list|(
name|fmt
parameter_list|,
name|args
modifier|...
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_struct
struct|struct
name|bcm_mbox_softc
block|{
name|struct
name|mtx
name|lock
decl_stmt|;
name|struct
name|resource
modifier|*
name|mem_res
decl_stmt|;
name|struct
name|resource
modifier|*
name|irq_res
decl_stmt|;
name|void
modifier|*
name|intr_hl
decl_stmt|;
name|bus_space_tag_t
name|bst
decl_stmt|;
name|bus_space_handle_t
name|bsh
decl_stmt|;
name|int
name|msg
index|[
name|BCM2835_MBOX_CHANS
index|]
decl_stmt|;
name|int
name|have_message
index|[
name|BCM2835_MBOX_CHANS
index|]
decl_stmt|;
name|struct
name|sx
name|property_chan_lock
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|mbox_read_4
parameter_list|(
name|sc
parameter_list|,
name|reg
parameter_list|)
define|\
value|bus_space_read_4((sc)->bst, (sc)->bsh, reg)
end_define

begin_define
define|#
directive|define
name|mbox_write_4
parameter_list|(
name|sc
parameter_list|,
name|reg
parameter_list|,
name|val
parameter_list|)
define|\
value|bus_space_write_4((sc)->bst, (sc)->bsh, reg, val)
end_define

begin_function
specifier|static
name|int
name|bcm_mbox_read_msg
parameter_list|(
name|struct
name|bcm_mbox_softc
modifier|*
name|sc
parameter_list|,
name|int
modifier|*
name|ochan
parameter_list|)
block|{
name|uint32_t
name|data
decl_stmt|;
name|uint32_t
name|msg
decl_stmt|;
name|int
name|chan
decl_stmt|;
name|msg
operator|=
name|mbox_read_4
argument_list|(
name|sc
argument_list|,
name|REG_READ
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
literal|"bcm_mbox_intr: raw data %08x\n"
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|chan
operator|=
name|MBOX_CHAN
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|data
operator|=
name|MBOX_DATA
argument_list|(
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|msg
index|[
name|chan
index|]
condition|)
block|{
name|printf
argument_list|(
literal|"bcm_mbox_intr: channel %d oveflow\n"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|dprintf
argument_list|(
literal|"bcm_mbox_intr: chan %d, data %08x\n"
argument_list|,
name|chan
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|sc
operator|->
name|msg
index|[
name|chan
index|]
operator|=
name|msg
expr_stmt|;
if|if
condition|(
name|ochan
operator|!=
name|NULL
condition|)
operator|*
name|ochan
operator|=
name|chan
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bcm_mbox_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|bcm_mbox_softc
modifier|*
name|sc
init|=
name|arg
decl_stmt|;
name|int
name|chan
decl_stmt|;
name|MBOX_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|mbox_read_4
argument_list|(
name|sc
argument_list|,
name|REG_STATUS
argument_list|)
operator|&
name|STATUS_EMPTY
operator|)
condition|)
if|if
condition|(
name|bcm_mbox_read_msg
argument_list|(
name|sc
argument_list|,
operator|&
name|chan
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|have_message
index|[
name|chan
index|]
operator|=
literal|1
expr_stmt|;
name|wakeup
argument_list|(
operator|&
name|sc
operator|->
name|have_message
index|[
name|chan
index|]
argument_list|)
expr_stmt|;
block|}
name|MBOX_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm_mbox_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
operator|!
name|ofw_bus_status_okay
argument_list|(
name|dev
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
name|ofw_bus_is_compatible
argument_list|(
name|dev
argument_list|,
literal|"broadcom,bcm2835-mbox"
argument_list|)
condition|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"BCM2835 VideoCore Mailbox"
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm_mbox_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|bcm_mbox_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|rid
init|=
literal|0
decl_stmt|;
name|sc
operator|->
name|mem_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|mem_res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not allocate memory resource\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|sc
operator|->
name|bst
operator|=
name|rman_get_bustag
argument_list|(
name|sc
operator|->
name|mem_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bsh
operator|=
name|rman_get_bushandle
argument_list|(
name|sc
operator|->
name|mem_res
argument_list|)
expr_stmt|;
name|rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|irq_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|irq_res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not allocate interrupt resource\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
comment|/* Setup and enable the timer */
if|if
condition|(
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|,
name|INTR_MPSAFE
operator||
name|INTR_TYPE_MISC
argument_list|,
name|NULL
argument_list|,
name|bcm_mbox_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|intr_hl
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|rid
argument_list|,
name|sc
operator|->
name|irq_res
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Unable to setup the clock irq handler.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|mtx_init
argument_list|(
operator|&
name|sc
operator|->
name|lock
argument_list|,
literal|"vcio mbox"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|BCM2835_MBOX_CHANS
condition|;
name|i
operator|++
control|)
block|{
name|sc
operator|->
name|msg
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|have_message
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|sx_init
argument_list|(
operator|&
name|sc
operator|->
name|property_chan_lock
argument_list|,
literal|"mboxprop"
argument_list|)
expr_stmt|;
comment|/* Read all pending messages */
while|while
condition|(
operator|(
name|mbox_read_4
argument_list|(
name|sc
argument_list|,
name|REG_STATUS
argument_list|)
operator|&
name|STATUS_EMPTY
operator|)
operator|==
literal|0
condition|)
operator|(
name|void
operator|)
name|mbox_read_4
argument_list|(
name|sc
argument_list|,
name|REG_READ
argument_list|)
expr_stmt|;
name|mbox_write_4
argument_list|(
name|sc
argument_list|,
name|REG_CONFIG
argument_list|,
name|CONFIG_DATA_IRQ
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*   * Mailbox API  */
end_comment

begin_function
specifier|static
name|int
name|bcm_mbox_write
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|chan
parameter_list|,
name|uint32_t
name|data
parameter_list|)
block|{
name|int
name|limit
init|=
literal|1000
decl_stmt|;
name|struct
name|bcm_mbox_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|dprintf
argument_list|(
literal|"bcm_mbox_write: chan %d, data %08x\n"
argument_list|,
name|chan
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|MBOX_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|have_message
index|[
name|chan
index|]
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|mbox_read_4
argument_list|(
name|sc
argument_list|,
name|REG_STATUS
argument_list|)
operator|&
name|STATUS_FULL
operator|)
operator|&&
operator|--
name|limit
condition|)
name|DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
name|limit
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"bcm_mbox_write: STATUS_FULL stuck"
argument_list|)
expr_stmt|;
name|MBOX_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|EAGAIN
operator|)
return|;
block|}
name|mbox_write_4
argument_list|(
name|sc
argument_list|,
name|REG_WRITE
argument_list|,
name|MBOX_MSG
argument_list|(
name|chan
argument_list|,
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|MBOX_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm_mbox_read
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|chan
parameter_list|,
name|uint32_t
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|bcm_mbox_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|int
name|err
decl_stmt|,
name|read_chan
decl_stmt|;
name|dprintf
argument_list|(
literal|"bcm_mbox_read: chan %d\n"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
name|MBOX_LOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cold
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|have_message
index|[
name|chan
index|]
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|mtx_sleep
argument_list|(
operator|&
name|sc
operator|->
name|have_message
index|[
name|chan
index|]
argument_list|,
operator|&
name|sc
operator|->
name|lock
argument_list|,
literal|0
argument_list|,
literal|"mbox"
argument_list|,
literal|10
operator|*
name|hz
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"timeout waiting for message on chan %d\n"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|err
operator|=
name|ETIMEDOUT
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
do|do
block|{
comment|/* Wait for a message */
while|while
condition|(
operator|(
name|mbox_read_4
argument_list|(
name|sc
argument_list|,
name|REG_STATUS
argument_list|)
operator|&
name|STATUS_EMPTY
operator|)
condition|)
empty_stmt|;
comment|/* Read the message */
if|if
condition|(
name|bcm_mbox_read_msg
argument_list|(
name|sc
argument_list|,
operator|&
name|read_chan
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|err
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
do|while
condition|(
name|read_chan
operator|!=
name|chan
condition|)
do|;
block|}
comment|/* 	 *  get data from intr handler, the same channel is never coming 	 *  because of holding sc lock. 	 */
operator|*
name|data
operator|=
name|MBOX_DATA
argument_list|(
name|sc
operator|->
name|msg
index|[
name|chan
index|]
argument_list|)
expr_stmt|;
name|sc
operator|->
name|msg
index|[
name|chan
index|]
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|have_message
index|[
name|chan
index|]
operator|=
literal|0
expr_stmt|;
name|out
label|:
name|MBOX_UNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|dprintf
argument_list|(
literal|"bcm_mbox_read: chan %d, data %08x\n"
argument_list|,
name|chan
argument_list|,
operator|*
name|data
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|bcm_mbox_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|bcm_mbox_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|bcm_mbox_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|mbox_read
argument_list|,
name|bcm_mbox_read
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|mbox_write
argument_list|,
name|bcm_mbox_write
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|bcm_mbox_driver
init|=
block|{
literal|"mbox"
block|,
name|bcm_mbox_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|bcm_mbox_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|bcm_mbox_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|mbox
argument_list|,
name|simplebus
argument_list|,
name|bcm_mbox_driver
argument_list|,
name|bcm_mbox_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|void
name|bcm2835_mbox_dma_cb
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|err
parameter_list|)
block|{
name|bus_addr_t
modifier|*
name|addr
decl_stmt|;
if|if
condition|(
name|err
condition|)
return|return;
name|addr
operator|=
operator|(
name|bus_addr_t
operator|*
operator|)
name|arg
expr_stmt|;
operator|*
name|addr
operator|=
name|PHYS_TO_VCBUS
argument_list|(
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|bcm2835_mbox_init_dma
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|size_t
name|len
parameter_list|,
name|bus_dma_tag_t
modifier|*
name|tag
parameter_list|,
name|bus_dmamap_t
modifier|*
name|map
parameter_list|,
name|bus_addr_t
modifier|*
name|phys
parameter_list|)
block|{
name|void
modifier|*
name|buf
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|dev
argument_list|)
argument_list|,
literal|16
argument_list|,
literal|0
argument_list|,
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
name|BUS_SPACE_MAXADDR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|len
argument_list|,
literal|1
argument_list|,
name|len
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"can't create DMA tag\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|err
operator|=
name|bus_dmamem_alloc
argument_list|(
operator|*
name|tag
argument_list|,
operator|&
name|buf
argument_list|,
literal|0
argument_list|,
name|map
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|bus_dma_tag_destroy
argument_list|(
operator|*
name|tag
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"can't allocate dmamem\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|err
operator|=
name|bus_dmamap_load
argument_list|(
operator|*
name|tag
argument_list|,
operator|*
name|map
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|bcm2835_mbox_dma_cb
argument_list|,
name|phys
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|bus_dmamem_free
argument_list|(
operator|*
name|tag
argument_list|,
name|buf
argument_list|,
operator|*
name|map
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
operator|*
name|tag
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"can't load DMA map\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
return|return
operator|(
name|buf
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bcm2835_mbox_err
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|bus_addr_t
name|msg_phys
parameter_list|,
name|uint32_t
name|resp_phys
parameter_list|,
name|struct
name|bcm2835_mbox_hdr
modifier|*
name|msg
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|int
name|idx
decl_stmt|;
name|struct
name|bcm2835_mbox_tag_hdr
modifier|*
name|tag
decl_stmt|;
name|uint8_t
modifier|*
name|last
decl_stmt|;
if|if
condition|(
operator|(
name|uint32_t
operator|)
name|msg_phys
operator|!=
name|resp_phys
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"response channel mismatch\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
if|if
condition|(
name|msg
operator|->
name|code
operator|!=
name|BCM2835_MBOX_CODE_RESP_SUCCESS
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"mbox response error\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
comment|/* Loop until the end tag. */
name|tag
operator|=
operator|(
expr|struct
name|bcm2835_mbox_tag_hdr
operator|*
operator|)
operator|(
name|msg
operator|+
literal|1
operator|)
expr_stmt|;
name|last
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|msg
operator|+
name|len
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|tag
operator|->
name|tag
operator|!=
literal|0
condition|;
name|idx
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|tag
operator|->
name|val_len
operator|&
name|BCM2835_MBOX_TAG_VAL_LEN_RESPONSE
operator|)
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"tag %d response error\n"
argument_list|,
name|idx
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
comment|/* Clear the response bit. */
name|tag
operator|->
name|val_len
operator|&=
operator|~
name|BCM2835_MBOX_TAG_VAL_LEN_RESPONSE
expr_stmt|;
comment|/* Next tag. */
name|tag
operator|=
operator|(
expr|struct
name|bcm2835_mbox_tag_hdr
operator|*
operator|)
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|tag
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|tag
argument_list|)
operator|+
name|tag
operator|->
name|val_buf_size
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|uint8_t
operator|*
operator|)
name|tag
operator|>
name|last
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"mbox buffer size error\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bcm2835_mbox_property
parameter_list|(
name|void
modifier|*
name|msg
parameter_list|,
name|size_t
name|msg_size
parameter_list|)
block|{
name|struct
name|bcm_mbox_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|msg_set_power_state
modifier|*
name|buf
decl_stmt|;
name|bus_dma_tag_t
name|msg_tag
decl_stmt|;
name|bus_dmamap_t
name|msg_map
decl_stmt|;
name|bus_addr_t
name|msg_phys
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|device_t
name|mbox
decl_stmt|;
name|int
name|err
decl_stmt|;
comment|/* get mbox device */
name|mbox
operator|=
name|devclass_get_device
argument_list|(
name|devclass_find
argument_list|(
literal|"mbox"
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|mbox
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|mbox
argument_list|)
expr_stmt|;
name|sx_xlock
argument_list|(
operator|&
name|sc
operator|->
name|property_chan_lock
argument_list|)
expr_stmt|;
comment|/* Allocate memory for the message */
name|buf
operator|=
name|bcm2835_mbox_init_dma
argument_list|(
name|mbox
argument_list|,
name|msg_size
argument_list|,
operator|&
name|msg_tag
argument_list|,
operator|&
name|msg_map
argument_list|,
operator|&
name|msg_phys
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|err
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|memcpy
argument_list|(
name|buf
argument_list|,
name|msg
argument_list|,
name|msg_size
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|msg_tag
argument_list|,
name|msg_map
argument_list|,
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|MBOX_WRITE
argument_list|(
name|mbox
argument_list|,
name|BCM2835_MBOX_CHAN_PROP
argument_list|,
operator|(
name|uint32_t
operator|)
name|msg_phys
argument_list|)
expr_stmt|;
name|MBOX_READ
argument_list|(
name|mbox
argument_list|,
name|BCM2835_MBOX_CHAN_PROP
argument_list|,
operator|&
name|reg
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|msg_tag
argument_list|,
name|msg_map
argument_list|,
name|BUS_DMASYNC_PREREAD
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|msg
argument_list|,
name|buf
argument_list|,
name|msg_size
argument_list|)
expr_stmt|;
name|err
operator|=
name|bcm2835_mbox_err
argument_list|(
name|mbox
argument_list|,
name|msg_phys
argument_list|,
name|reg
argument_list|,
operator|(
expr|struct
name|bcm2835_mbox_hdr
operator|*
operator|)
name|msg
argument_list|,
name|msg_size
argument_list|)
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|msg_tag
argument_list|,
name|msg_map
argument_list|)
expr_stmt|;
name|bus_dmamem_free
argument_list|(
name|msg_tag
argument_list|,
name|buf
argument_list|,
name|msg_map
argument_list|)
expr_stmt|;
name|bus_dma_tag_destroy
argument_list|(
name|msg_tag
argument_list|)
expr_stmt|;
name|out
label|:
name|sx_xunlock
argument_list|(
operator|&
name|sc
operator|->
name|property_chan_lock
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bcm2835_mbox_set_power_state
parameter_list|(
name|uint32_t
name|device_id
parameter_list|,
name|boolean_t
name|on
parameter_list|)
block|{
name|struct
name|msg_set_power_state
name|msg
decl_stmt|;
name|int
name|err
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|hdr
operator|.
name|buf_size
operator|=
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|.
name|hdr
operator|.
name|code
operator|=
name|BCM2835_MBOX_CODE_REQ
expr_stmt|;
name|msg
operator|.
name|tag_hdr
operator|.
name|tag
operator|=
name|BCM2835_MBOX_TAG_SET_POWER_STATE
expr_stmt|;
name|msg
operator|.
name|tag_hdr
operator|.
name|val_buf_size
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|body
argument_list|)
expr_stmt|;
name|msg
operator|.
name|tag_hdr
operator|.
name|val_len
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|body
operator|.
name|req
argument_list|)
expr_stmt|;
name|msg
operator|.
name|body
operator|.
name|req
operator|.
name|device_id
operator|=
name|device_id
expr_stmt|;
name|msg
operator|.
name|body
operator|.
name|req
operator|.
name|state
operator|=
operator|(
name|on
condition|?
name|BCM2835_MBOX_POWER_ON
else|:
literal|0
operator|)
operator||
name|BCM2835_MBOX_POWER_WAIT
expr_stmt|;
name|msg
operator|.
name|end_tag
operator|=
literal|0
expr_stmt|;
name|err
operator|=
name|bcm2835_mbox_property
argument_list|(
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bcm2835_mbox_get_clock_rate
parameter_list|(
name|uint32_t
name|clock_id
parameter_list|,
name|uint32_t
modifier|*
name|hz
parameter_list|)
block|{
name|struct
name|msg_get_clock_rate
name|msg
decl_stmt|;
name|int
name|err
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|hdr
operator|.
name|buf_size
operator|=
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|.
name|hdr
operator|.
name|code
operator|=
name|BCM2835_MBOX_CODE_REQ
expr_stmt|;
name|msg
operator|.
name|tag_hdr
operator|.
name|tag
operator|=
name|BCM2835_MBOX_TAG_GET_CLOCK_RATE
expr_stmt|;
name|msg
operator|.
name|tag_hdr
operator|.
name|val_buf_size
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|body
argument_list|)
expr_stmt|;
name|msg
operator|.
name|tag_hdr
operator|.
name|val_len
operator|=
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|body
operator|.
name|req
argument_list|)
expr_stmt|;
name|msg
operator|.
name|body
operator|.
name|req
operator|.
name|clock_id
operator|=
name|clock_id
expr_stmt|;
name|msg
operator|.
name|end_tag
operator|=
literal|0
expr_stmt|;
name|err
operator|=
name|bcm2835_mbox_property
argument_list|(
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|hz
operator|=
name|msg
operator|.
name|body
operator|.
name|resp
operator|.
name|rate_hz
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bcm2835_mbox_fb_get_w_h
parameter_list|(
name|struct
name|bcm2835_fb_config
modifier|*
name|fb
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|struct
name|msg_fb_get_w_h
name|msg
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|hdr
operator|.
name|buf_size
operator|=
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|.
name|hdr
operator|.
name|code
operator|=
name|BCM2835_MBOX_CODE_REQ
expr_stmt|;
name|BCM2835_MBOX_INIT_TAG
argument_list|(
operator|&
name|msg
operator|.
name|physical_w_h
argument_list|,
name|GET_PHYSICAL_W_H
argument_list|)
expr_stmt|;
name|msg
operator|.
name|physical_w_h
operator|.
name|tag_hdr
operator|.
name|val_len
operator|=
literal|0
expr_stmt|;
name|msg
operator|.
name|end_tag
operator|=
literal|0
expr_stmt|;
name|err
operator|=
name|bcm2835_mbox_property
argument_list|(
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
literal|0
condition|)
block|{
name|fb
operator|->
name|xres
operator|=
name|msg
operator|.
name|physical_w_h
operator|.
name|body
operator|.
name|resp
operator|.
name|width
expr_stmt|;
name|fb
operator|->
name|yres
operator|=
name|msg
operator|.
name|physical_w_h
operator|.
name|body
operator|.
name|resp
operator|.
name|height
expr_stmt|;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
name|int
name|bcm2835_mbox_fb_init
parameter_list|(
name|struct
name|bcm2835_fb_config
modifier|*
name|fb
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|struct
name|msg_fb_setup
name|msg
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|hdr
operator|.
name|buf_size
operator|=
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|.
name|hdr
operator|.
name|code
operator|=
name|BCM2835_MBOX_CODE_REQ
expr_stmt|;
name|BCM2835_MBOX_INIT_TAG
argument_list|(
operator|&
name|msg
operator|.
name|physical_w_h
argument_list|,
name|SET_PHYSICAL_W_H
argument_list|)
expr_stmt|;
name|msg
operator|.
name|physical_w_h
operator|.
name|body
operator|.
name|req
operator|.
name|width
operator|=
name|fb
operator|->
name|xres
expr_stmt|;
name|msg
operator|.
name|physical_w_h
operator|.
name|body
operator|.
name|req
operator|.
name|height
operator|=
name|fb
operator|->
name|yres
expr_stmt|;
name|BCM2835_MBOX_INIT_TAG
argument_list|(
operator|&
name|msg
operator|.
name|virtual_w_h
argument_list|,
name|SET_VIRTUAL_W_H
argument_list|)
expr_stmt|;
name|msg
operator|.
name|virtual_w_h
operator|.
name|body
operator|.
name|req
operator|.
name|width
operator|=
name|fb
operator|->
name|vxres
expr_stmt|;
name|msg
operator|.
name|virtual_w_h
operator|.
name|body
operator|.
name|req
operator|.
name|height
operator|=
name|fb
operator|->
name|vyres
expr_stmt|;
name|BCM2835_MBOX_INIT_TAG
argument_list|(
operator|&
name|msg
operator|.
name|offset
argument_list|,
name|SET_VIRTUAL_OFFSET
argument_list|)
expr_stmt|;
name|msg
operator|.
name|offset
operator|.
name|body
operator|.
name|req
operator|.
name|x
operator|=
name|fb
operator|->
name|xoffset
expr_stmt|;
name|msg
operator|.
name|offset
operator|.
name|body
operator|.
name|req
operator|.
name|y
operator|=
name|fb
operator|->
name|yoffset
expr_stmt|;
name|BCM2835_MBOX_INIT_TAG
argument_list|(
operator|&
name|msg
operator|.
name|depth
argument_list|,
name|SET_DEPTH
argument_list|)
expr_stmt|;
name|msg
operator|.
name|depth
operator|.
name|body
operator|.
name|req
operator|.
name|bpp
operator|=
name|fb
operator|->
name|bpp
expr_stmt|;
name|BCM2835_MBOX_INIT_TAG
argument_list|(
operator|&
name|msg
operator|.
name|alpha
argument_list|,
name|SET_ALPHA_MODE
argument_list|)
expr_stmt|;
name|msg
operator|.
name|alpha
operator|.
name|body
operator|.
name|req
operator|.
name|alpha
operator|=
name|BCM2835_MBOX_ALPHA_MODE_IGNORED
expr_stmt|;
name|BCM2835_MBOX_INIT_TAG
argument_list|(
operator|&
name|msg
operator|.
name|buffer
argument_list|,
name|ALLOCATE_BUFFER
argument_list|)
expr_stmt|;
name|msg
operator|.
name|buffer
operator|.
name|body
operator|.
name|req
operator|.
name|alignment
operator|=
name|PAGE_SIZE
expr_stmt|;
name|BCM2835_MBOX_INIT_TAG
argument_list|(
operator|&
name|msg
operator|.
name|pitch
argument_list|,
name|GET_PITCH
argument_list|)
expr_stmt|;
name|msg
operator|.
name|end_tag
operator|=
literal|0
expr_stmt|;
name|err
operator|=
name|bcm2835_mbox_property
argument_list|(
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
literal|0
condition|)
block|{
name|fb
operator|->
name|xres
operator|=
name|msg
operator|.
name|physical_w_h
operator|.
name|body
operator|.
name|resp
operator|.
name|width
expr_stmt|;
name|fb
operator|->
name|yres
operator|=
name|msg
operator|.
name|physical_w_h
operator|.
name|body
operator|.
name|resp
operator|.
name|height
expr_stmt|;
name|fb
operator|->
name|vxres
operator|=
name|msg
operator|.
name|virtual_w_h
operator|.
name|body
operator|.
name|resp
operator|.
name|width
expr_stmt|;
name|fb
operator|->
name|vyres
operator|=
name|msg
operator|.
name|virtual_w_h
operator|.
name|body
operator|.
name|resp
operator|.
name|height
expr_stmt|;
name|fb
operator|->
name|xoffset
operator|=
name|msg
operator|.
name|offset
operator|.
name|body
operator|.
name|resp
operator|.
name|x
expr_stmt|;
name|fb
operator|->
name|yoffset
operator|=
name|msg
operator|.
name|offset
operator|.
name|body
operator|.
name|resp
operator|.
name|y
expr_stmt|;
name|fb
operator|->
name|pitch
operator|=
name|msg
operator|.
name|pitch
operator|.
name|body
operator|.
name|resp
operator|.
name|pitch
expr_stmt|;
name|fb
operator|->
name|base
operator|=
name|VCBUS_TO_PHYS
argument_list|(
name|msg
operator|.
name|buffer
operator|.
name|body
operator|.
name|resp
operator|.
name|fb_address
argument_list|)
expr_stmt|;
name|fb
operator|->
name|size
operator|=
name|msg
operator|.
name|buffer
operator|.
name|body
operator|.
name|resp
operator|.
name|fb_size
expr_stmt|;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

end_unit


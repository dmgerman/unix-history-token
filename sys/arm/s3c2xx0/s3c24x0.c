begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$NetBSD: s3c2410.c,v 1.4 2003/08/27 03:46:05 bsh Exp $ */
end_comment

begin_comment
comment|/*  * Copyright (c) 2003  Genetec corporation.  All rights reserved.  * Written by Hiroyuki Bessho for Genetec corporation.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. The name of Genetec corporation may not be used to endorse  *    or promote products derived from this software without specific prior  *    written permission.  *  * THIS SOFTWARE IS PROVIDED BY GENETEC CORP. ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED  * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL GENETEC CORP.  * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS  * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN  * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/reboot.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<machine/armreg.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpu.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpufunc.h>
end_include

begin_include
include|#
directive|include
file|<machine/intr.h>
end_include

begin_include
include|#
directive|include
file|<arm/s3c2xx0/s3c2410reg.h>
end_include

begin_include
include|#
directive|include
file|<arm/s3c2xx0/s3c2440reg.h>
end_include

begin_include
include|#
directive|include
file|<arm/s3c2xx0/s3c24x0var.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_define
define|#
directive|define
name|S3C2XX0_XTAL_CLK
value|12000000
end_define

begin_define
define|#
directive|define
name|IPL_LEVELS
value|13
end_define

begin_decl_stmt
name|u_int
name|irqmasks
index|[
name|IPL_LEVELS
index|]
decl_stmt|;
end_decl_stmt

begin_struct
specifier|static
struct|struct
block|{
name|uint32_t
name|idcode
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|s3c2xx0_cpu
name|cpu
decl_stmt|;
block|}
name|s3c2x0_cpu_id
index|[]
init|=
block|{
block|{
name|CHIPID_S3C2410A
block|,
literal|"S3C2410A"
block|,
name|CPU_S3C2410
block|}
block|,
block|{
name|CHIPID_S3C2440A
block|,
literal|"S3C2440A"
block|,
name|CPU_S3C2440
block|}
block|,
block|{
name|CHIPID_S3C2442B
block|,
literal|"S3C2442B"
block|,
name|CPU_S3C2440
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
struct|;
end_struct

begin_struct
specifier|static
struct|struct
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|prio
decl_stmt|;
name|int
name|unit
decl_stmt|;
struct|struct
block|{
name|int
name|type
decl_stmt|;
name|u_long
name|start
decl_stmt|;
name|u_long
name|count
decl_stmt|;
block|}
name|res
index|[
literal|2
index|]
struct|;
block|}
name|s3c24x0_children
index|[]
init|=
block|{
block|{
literal|"rtc"
block|,
literal|0
block|,
operator|-
literal|1
block|,
block|{
block|{
name|SYS_RES_IOPORT
block|,
name|S3C24X0_RTC_PA_BASE
block|,
name|S3C24X0_RTC_SIZE
block|}
block|,
block|{
literal|0
block|}
block|, 	}
block|}
block|,
block|{
literal|"timer"
block|,
literal|0
block|,
operator|-
literal|1
block|,
block|{
block|{
literal|0
block|}
block|, }
block|}
block|,
block|{
literal|"uart"
block|,
literal|1
block|,
literal|0
block|,
block|{
block|{
name|SYS_RES_IRQ
block|,
name|S3C24X0_INT_UART0
block|,
literal|1
block|}
block|,
block|{
name|SYS_RES_IOPORT
block|,
name|S3C24X0_UART_PA_BASE
argument_list|(
literal|0
argument_list|)
block|,
name|S3C24X0_UART_BASE
argument_list|(
literal|1
argument_list|)
operator|-
name|S3C24X0_UART_BASE
argument_list|(
literal|0
argument_list|)
block|}
block|, 	}
block|}
block|,
block|{
literal|"uart"
block|,
literal|1
block|,
literal|1
block|,
block|{
block|{
name|SYS_RES_IRQ
block|,
name|S3C24X0_INT_UART1
block|,
literal|1
block|}
block|,
block|{
name|SYS_RES_IOPORT
block|,
name|S3C24X0_UART_PA_BASE
argument_list|(
literal|1
argument_list|)
block|,
name|S3C24X0_UART_BASE
argument_list|(
literal|2
argument_list|)
operator|-
name|S3C24X0_UART_BASE
argument_list|(
literal|1
argument_list|)
block|}
block|, 	}
block|}
block|,
block|{
literal|"uart"
block|,
literal|1
block|,
literal|2
block|,
block|{
block|{
name|SYS_RES_IRQ
block|,
name|S3C24X0_INT_UART2
block|,
literal|1
block|}
block|,
block|{
name|SYS_RES_IOPORT
block|,
name|S3C24X0_UART_PA_BASE
argument_list|(
literal|2
argument_list|)
block|,
name|S3C24X0_UART_BASE
argument_list|(
literal|3
argument_list|)
operator|-
name|S3C24X0_UART_BASE
argument_list|(
literal|2
argument_list|)
block|}
block|, 	}
block|}
block|,
block|{
literal|"ohci"
block|,
literal|0
block|,
operator|-
literal|1
block|,
block|{
block|{
name|SYS_RES_IRQ
block|,
name|S3C24X0_INT_USBH
block|,
literal|0
block|}
block|,
block|{
name|SYS_RES_IOPORT
block|,
name|S3C24X0_USBHC_PA_BASE
block|,
name|S3C24X0_USBHC_SIZE
block|}
block|, 	}
block|}
block|,
block|{
name|NULL
block|}
block|, }
struct|;
end_struct

begin_comment
comment|/* prototypes */
end_comment

begin_function_decl
specifier|static
name|device_t
name|s3c24x0_add_child
parameter_list|(
name|device_t
parameter_list|,
name|int
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|s3c24x0_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|s3c24x0_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|s3c24x0_identify
parameter_list|(
name|driver_t
modifier|*
parameter_list|,
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|s3c24x0_setup_intr
parameter_list|(
name|device_t
parameter_list|,
name|device_t
parameter_list|,
name|struct
name|resource
modifier|*
parameter_list|,
name|int
parameter_list|,
name|driver_filter_t
modifier|*
parameter_list|,
name|driver_intr_t
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|,
name|void
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|s3c24x0_teardown_intr
parameter_list|(
name|device_t
parameter_list|,
name|device_t
parameter_list|,
name|struct
name|resource
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|s3c24x0_config_intr
parameter_list|(
name|device_t
parameter_list|,
name|int
parameter_list|,
name|enum
name|intr_trigger
parameter_list|,
name|enum
name|intr_polarity
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|resource
modifier|*
name|s3c24x0_alloc_resource
parameter_list|(
name|device_t
parameter_list|,
name|device_t
parameter_list|,
name|int
parameter_list|,
name|int
modifier|*
parameter_list|,
name|u_long
parameter_list|,
name|u_long
parameter_list|,
name|u_long
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|s3c24x0_activate_resource
parameter_list|(
name|device_t
parameter_list|,
name|device_t
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|struct
name|resource
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|s3c24x0_release_resource
parameter_list|(
name|device_t
parameter_list|,
name|device_t
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|struct
name|resource
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|resource_list
modifier|*
name|s3c24x0_get_resource_list
parameter_list|(
name|device_t
parameter_list|,
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|s3c24x0_identify_cpu
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|device_method_t
name|s3c24x0_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|s3c24x0_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|s3c24x0_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_identify
argument_list|,
name|s3c24x0_identify
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_setup_intr
argument_list|,
name|s3c24x0_setup_intr
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_teardown_intr
argument_list|,
name|s3c24x0_teardown_intr
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_config_intr
argument_list|,
name|s3c24x0_config_intr
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_alloc_resource
argument_list|,
name|s3c24x0_alloc_resource
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_activate_resource
argument_list|,
name|s3c24x0_activate_resource
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_release_resource
argument_list|,
name|s3c24x0_release_resource
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_get_resource_list
argument_list|,
name|s3c24x0_get_resource_list
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_set_resource
argument_list|,
name|bus_generic_rl_set_resource
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_get_resource
argument_list|,
name|bus_generic_rl_get_resource
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|s3c24x0_driver
init|=
block|{
literal|"s3c24x0"
block|,
name|s3c24x0_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|s3c24x0_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|s3c24x0_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|s3c24x0
argument_list|,
name|nexus
argument_list|,
name|s3c24x0_driver
argument_list|,
name|s3c24x0_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|struct
name|s3c2xx0_softc
modifier|*
name|s3c2xx0_softc
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|device_t
name|s3c24x0_add_child
parameter_list|(
name|device_t
name|bus
parameter_list|,
name|int
name|prio
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|int
name|unit
parameter_list|)
block|{
name|device_t
name|child
decl_stmt|;
name|struct
name|s3c2xx0_ivar
modifier|*
name|ivar
decl_stmt|;
name|child
operator|=
name|device_add_child_ordered
argument_list|(
name|bus
argument_list|,
name|prio
argument_list|,
name|name
argument_list|,
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|ivar
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ivar
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
if|if
condition|(
name|ivar
operator|==
name|NULL
condition|)
block|{
name|device_delete_child
argument_list|(
name|bus
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Can't add alloc ivar\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|device_set_ivars
argument_list|(
name|child
argument_list|,
name|ivar
argument_list|)
expr_stmt|;
name|resource_list_init
argument_list|(
operator|&
name|ivar
operator|->
name|resources
argument_list|)
expr_stmt|;
return|return
operator|(
name|child
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|s3c24x0_enable_ext_intr
parameter_list|(
name|unsigned
name|int
name|irq
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|,
name|value
decl_stmt|;
name|int
name|offset
decl_stmt|;
if|if
condition|(
name|irq
operator|<=
literal|7
condition|)
block|{
name|reg
operator|=
name|GPIO_PFCON
expr_stmt|;
name|offset
operator|=
name|irq
operator|*
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|irq
operator|<=
literal|23
condition|)
block|{
name|reg
operator|=
name|GPIO_PGCON
expr_stmt|;
name|offset
operator|=
operator|(
name|irq
operator|-
literal|8
operator|)
operator|*
literal|2
expr_stmt|;
block|}
else|else
return|return;
comment|/* Make the pin an interrupt source */
name|value
operator|=
name|bus_space_read_4
argument_list|(
name|s3c2xx0_softc
operator|->
name|sc_iot
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_gpio_ioh
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|value
operator|&=
operator|~
operator|(
literal|3
operator|<<
name|offset
operator|)
expr_stmt|;
name|value
operator||=
literal|2
operator|<<
name|offset
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|s3c2xx0_softc
operator|->
name|sc_iot
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_gpio_ioh
argument_list|,
name|reg
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|s3c24x0_setup_intr
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|,
name|struct
name|resource
modifier|*
name|ires
parameter_list|,
name|int
name|flags
parameter_list|,
name|driver_filter_t
modifier|*
name|filt
parameter_list|,
name|driver_intr_t
modifier|*
name|intr
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|void
modifier|*
modifier|*
name|cookiep
parameter_list|)
block|{
name|int
name|error
decl_stmt|,
name|irq
decl_stmt|;
name|error
operator|=
name|BUS_SETUP_INTR
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|child
argument_list|,
name|ires
argument_list|,
name|flags
argument_list|,
name|filt
argument_list|,
name|intr
argument_list|,
name|arg
argument_list|,
name|cookiep
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
for|for
control|(
name|irq
operator|=
name|rman_get_start
argument_list|(
name|ires
argument_list|)
init|;
name|irq
operator|<=
name|rman_get_end
argument_list|(
name|ires
argument_list|)
condition|;
name|irq
operator|++
control|)
block|{
if|if
condition|(
name|irq
operator|>=
name|S3C24X0_EXTIRQ_MIN
operator|&&
name|irq
operator|<=
name|S3C24X0_EXTIRQ_MAX
condition|)
block|{
comment|/* Enable the external interrupt pin */
name|s3c24x0_enable_ext_intr
argument_list|(
name|irq
operator|-
name|S3C24X0_EXTIRQ_MIN
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|s3c24x0_teardown_intr
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|,
name|struct
name|resource
modifier|*
name|res
parameter_list|,
name|void
modifier|*
name|cookie
parameter_list|)
block|{
return|return
operator|(
name|BUS_TEARDOWN_INTR
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|,
name|child
argument_list|,
name|res
argument_list|,
name|cookie
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|s3c24x0_config_intr
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|irq
parameter_list|,
name|enum
name|intr_trigger
name|trig
parameter_list|,
name|enum
name|intr_polarity
name|pol
parameter_list|)
block|{
name|uint32_t
name|mask
decl_stmt|,
name|reg
decl_stmt|,
name|value
decl_stmt|;
name|int
name|offset
decl_stmt|;
comment|/* Only external interrupts can be configured */
if|if
condition|(
name|irq
operator|<
name|S3C24X0_EXTIRQ_MIN
operator|||
name|irq
operator|>
name|S3C24X0_EXTIRQ_MAX
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
comment|/* There is no standard trigger or polarity for the bus */
if|if
condition|(
name|trig
operator|==
name|INTR_TRIGGER_CONFORM
operator|||
name|pol
operator|==
name|INTR_POLARITY_CONFORM
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|irq
operator|-=
name|S3C24X0_EXTIRQ_MIN
expr_stmt|;
comment|/* Get the bits to set */
name|mask
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pol
operator|==
name|INTR_POLARITY_LOW
condition|)
block|{
name|mask
operator|=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pol
operator|==
name|INTR_POLARITY_HIGH
condition|)
block|{
name|mask
operator|=
literal|4
expr_stmt|;
block|}
if|if
condition|(
name|trig
operator|==
name|INTR_TRIGGER_LEVEL
condition|)
block|{
name|mask
operator|>>=
literal|2
expr_stmt|;
block|}
comment|/* Get the register to set */
if|if
condition|(
name|irq
operator|<=
literal|7
condition|)
block|{
name|reg
operator|=
name|GPIO_EXTINT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|offset
operator|=
name|irq
operator|*
literal|4
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|irq
operator|<=
literal|15
condition|)
block|{
name|reg
operator|=
name|GPIO_EXTINT
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|offset
operator|=
operator|(
name|irq
operator|-
literal|8
operator|)
operator|*
literal|4
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|irq
operator|<=
literal|23
condition|)
block|{
name|reg
operator|=
name|GPIO_EXTINT
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|offset
operator|=
operator|(
name|irq
operator|-
literal|16
operator|)
operator|*
literal|4
expr_stmt|;
block|}
else|else
block|{
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
comment|/* Set the new signaling method */
name|value
operator|=
name|bus_space_read_4
argument_list|(
name|s3c2xx0_softc
operator|->
name|sc_iot
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_gpio_ioh
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|value
operator|&=
operator|~
operator|(
literal|7
operator|<<
name|offset
operator|)
expr_stmt|;
name|value
operator||=
name|mask
operator|<<
name|offset
expr_stmt|;
name|bus_space_write_4
argument_list|(
name|s3c2xx0_softc
operator|->
name|sc_iot
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_gpio_ioh
argument_list|,
name|reg
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|resource
modifier|*
name|s3c24x0_alloc_resource
parameter_list|(
name|device_t
name|bus
parameter_list|,
name|device_t
name|child
parameter_list|,
name|int
name|type
parameter_list|,
name|int
modifier|*
name|rid
parameter_list|,
name|u_long
name|start
parameter_list|,
name|u_long
name|end
parameter_list|,
name|u_long
name|count
parameter_list|,
name|u_int
name|flags
parameter_list|)
block|{
name|struct
name|resource_list_entry
modifier|*
name|rle
decl_stmt|;
name|struct
name|s3c2xx0_ivar
modifier|*
name|ivar
init|=
name|device_get_ivars
argument_list|(
name|child
argument_list|)
decl_stmt|;
name|struct
name|resource_list
modifier|*
name|rl
init|=
operator|&
name|ivar
operator|->
name|resources
decl_stmt|;
name|struct
name|resource
modifier|*
name|res
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|device_get_parent
argument_list|(
name|child
argument_list|)
operator|!=
name|bus
condition|)
return|return
operator|(
name|BUS_ALLOC_RESOURCE
argument_list|(
name|device_get_parent
argument_list|(
name|bus
argument_list|)
argument_list|,
name|child
argument_list|,
name|type
argument_list|,
name|rid
argument_list|,
name|start
argument_list|,
name|end
argument_list|,
name|count
argument_list|,
name|flags
argument_list|)
operator|)
return|;
name|rle
operator|=
name|resource_list_find
argument_list|(
name|rl
argument_list|,
name|type
argument_list|,
operator|*
name|rid
argument_list|)
expr_stmt|;
if|if
condition|(
name|rle
operator|!=
name|NULL
condition|)
block|{
comment|/* There is a resource list. Use it */
if|if
condition|(
name|rle
operator|->
name|res
condition|)
name|panic
argument_list|(
literal|"Resource rid %d type %d already in use"
argument_list|,
operator|*
name|rid
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|start
operator|==
literal|0UL
operator|&&
name|end
operator|==
operator|~
literal|0UL
condition|)
block|{
name|start
operator|=
name|rle
operator|->
name|start
expr_stmt|;
name|count
operator|=
name|ulmax
argument_list|(
name|count
argument_list|,
name|rle
operator|->
name|count
argument_list|)
expr_stmt|;
name|end
operator|=
name|ulmax
argument_list|(
name|rle
operator|->
name|end
argument_list|,
name|start
operator|+
name|count
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * When allocating an irq with children irq's really 		 * allocate the children as it is those we are interested 		 * in receiving, not the parent. 		 */
if|if
condition|(
name|type
operator|==
name|SYS_RES_IRQ
operator|&&
name|start
operator|==
name|end
condition|)
block|{
switch|switch
condition|(
name|start
condition|)
block|{
case|case
name|S3C24X0_INT_ADCTC
case|:
name|start
operator|=
name|S3C24X0_INT_TC
expr_stmt|;
name|end
operator|=
name|S3C24X0_INT_ADC
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|S3C2440_INT_CAM
case|case
name|S3C2440_INT_CAM
case|:
name|start
operator|=
name|S3C2440_INT_CAM_C
expr_stmt|;
name|end
operator|=
name|S3C2440_INT_CAM_P
expr_stmt|;
break|break;
endif|#
directive|endif
default|default:
break|break;
block|}
name|count
operator|=
name|end
operator|-
name|start
operator|+
literal|1
expr_stmt|;
block|}
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|SYS_RES_IRQ
case|:
name|res
operator|=
name|rman_reserve_resource
argument_list|(
operator|&
name|s3c2xx0_softc
operator|->
name|s3c2xx0_irq_rman
argument_list|,
name|start
argument_list|,
name|end
argument_list|,
name|count
argument_list|,
name|flags
argument_list|,
name|child
argument_list|)
expr_stmt|;
break|break;
case|case
name|SYS_RES_IOPORT
case|:
case|case
name|SYS_RES_MEMORY
case|:
name|res
operator|=
name|rman_reserve_resource
argument_list|(
operator|&
name|s3c2xx0_softc
operator|->
name|s3c2xx0_mem_rman
argument_list|,
name|start
argument_list|,
name|end
argument_list|,
name|count
argument_list|,
name|flags
argument_list|,
name|child
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|NULL
condition|)
name|panic
argument_list|(
literal|"Unable to map address space %#lX-%#lX"
argument_list|,
name|start
argument_list|,
name|end
argument_list|)
expr_stmt|;
name|rman_set_bustag
argument_list|(
name|res
argument_list|,
operator|&
name|s3c2xx0_bs_tag
argument_list|)
expr_stmt|;
name|rman_set_bushandle
argument_list|(
name|res
argument_list|,
name|start
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|RF_ACTIVE
condition|)
block|{
if|if
condition|(
name|bus_activate_resource
argument_list|(
name|child
argument_list|,
name|type
argument_list|,
operator|*
name|rid
argument_list|,
name|res
argument_list|)
condition|)
block|{
name|rman_release_resource
argument_list|(
name|res
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
block|}
break|break;
block|}
if|if
condition|(
name|res
operator|!=
name|NULL
condition|)
block|{
name|rman_set_rid
argument_list|(
name|res
argument_list|,
operator|*
name|rid
argument_list|)
expr_stmt|;
if|if
condition|(
name|rle
operator|!=
name|NULL
condition|)
block|{
name|rle
operator|->
name|res
operator|=
name|res
expr_stmt|;
name|rle
operator|->
name|start
operator|=
name|rman_get_start
argument_list|(
name|res
argument_list|)
expr_stmt|;
name|rle
operator|->
name|end
operator|=
name|rman_get_end
argument_list|(
name|res
argument_list|)
expr_stmt|;
name|rle
operator|->
name|count
operator|=
name|count
expr_stmt|;
block|}
block|}
return|return
operator|(
name|res
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|s3c24x0_activate_resource
parameter_list|(
name|device_t
name|bus
parameter_list|,
name|device_t
name|child
parameter_list|,
name|int
name|type
parameter_list|,
name|int
name|rid
parameter_list|,
name|struct
name|resource
modifier|*
name|r
parameter_list|)
block|{
name|bus_space_handle_t
name|p
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
name|type
operator|==
name|SYS_RES_MEMORY
operator|||
name|type
operator|==
name|SYS_RES_IOPORT
condition|)
block|{
name|error
operator|=
name|bus_space_map
argument_list|(
name|rman_get_bustag
argument_list|(
name|r
argument_list|)
argument_list|,
name|rman_get_bushandle
argument_list|(
name|r
argument_list|)
argument_list|,
name|rman_get_size
argument_list|(
name|r
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|rman_set_bushandle
argument_list|(
name|r
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|rman_activate_resource
argument_list|(
name|r
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|s3c24x0_release_resource
parameter_list|(
name|device_t
name|bus
parameter_list|,
name|device_t
name|child
parameter_list|,
name|int
name|type
parameter_list|,
name|int
name|rid
parameter_list|,
name|struct
name|resource
modifier|*
name|r
parameter_list|)
block|{
name|struct
name|s3c2xx0_ivar
modifier|*
name|ivar
init|=
name|device_get_ivars
argument_list|(
name|child
argument_list|)
decl_stmt|;
name|struct
name|resource_list
modifier|*
name|rl
init|=
operator|&
name|ivar
operator|->
name|resources
decl_stmt|;
name|struct
name|resource_list_entry
modifier|*
name|rle
decl_stmt|;
if|if
condition|(
name|rl
operator|==
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|rle
operator|=
name|resource_list_find
argument_list|(
name|rl
argument_list|,
name|type
argument_list|,
name|rid
argument_list|)
expr_stmt|;
if|if
condition|(
name|rle
operator|==
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|rman_release_resource
argument_list|(
name|r
argument_list|)
expr_stmt|;
name|rle
operator|->
name|res
operator|=
name|NULL
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|resource_list
modifier|*
name|s3c24x0_get_resource_list
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|)
block|{
name|struct
name|s3c2xx0_ivar
modifier|*
name|ivar
decl_stmt|;
name|ivar
operator|=
name|device_get_ivars
argument_list|(
name|child
argument_list|)
expr_stmt|;
return|return
operator|(
operator|&
operator|(
name|ivar
operator|->
name|resources
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|s3c24x0_identify
parameter_list|(
name|driver_t
modifier|*
name|driver
parameter_list|,
name|device_t
name|parent
parameter_list|)
block|{
name|BUS_ADD_CHILD
argument_list|(
name|parent
argument_list|,
literal|0
argument_list|,
literal|"s3c24x0"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|s3c24x0_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
return|return
operator|(
name|BUS_PROBE_NOWILDCARD
operator|)
return|;
block|}
end_function

begin_function
name|int
name|s3c24x0_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|s3c24x0_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|bus_space_tag_t
name|iot
decl_stmt|;
name|device_t
name|child
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|u_long
name|irqmax
decl_stmt|;
name|s3c2xx0_softc
operator|=
operator|&
operator|(
name|sc
operator|->
name|sc_sx
operator|)
expr_stmt|;
name|sc
operator|->
name|sc_sx
operator|.
name|sc_iot
operator|=
name|iot
operator|=
operator|&
name|s3c2xx0_bs_tag
expr_stmt|;
name|s3c2xx0_softc
operator|->
name|s3c2xx0_irq_rman
operator|.
name|rm_type
operator|=
name|RMAN_ARRAY
expr_stmt|;
name|s3c2xx0_softc
operator|->
name|s3c2xx0_irq_rman
operator|.
name|rm_descr
operator|=
literal|"S3C24X0 IRQs"
expr_stmt|;
name|s3c2xx0_softc
operator|->
name|s3c2xx0_mem_rman
operator|.
name|rm_type
operator|=
name|RMAN_ARRAY
expr_stmt|;
name|s3c2xx0_softc
operator|->
name|s3c2xx0_mem_rman
operator|.
name|rm_descr
operator|=
literal|"S3C24X0 Device Registers"
expr_stmt|;
comment|/* Manage the registor memory space */
if|if
condition|(
operator|(
name|rman_init
argument_list|(
operator|&
name|s3c2xx0_softc
operator|->
name|s3c2xx0_mem_rman
argument_list|)
operator|!=
literal|0
operator|)
operator|||
operator|(
name|rman_manage_region
argument_list|(
operator|&
name|s3c2xx0_softc
operator|->
name|s3c2xx0_mem_rman
argument_list|,
name|S3C24X0_DEV_VA_OFFSET
argument_list|,
name|S3C24X0_DEV_VA_OFFSET
operator|+
name|S3C24X0_DEV_VA_SIZE
argument_list|)
operator|!=
literal|0
operator|)
operator|||
operator|(
name|rman_manage_region
argument_list|(
operator|&
name|s3c2xx0_softc
operator|->
name|s3c2xx0_mem_rman
argument_list|,
name|S3C24X0_DEV_START
argument_list|,
name|S3C24X0_DEV_STOP
argument_list|)
operator|!=
literal|0
operator|)
condition|)
name|panic
argument_list|(
literal|"s3c24x0_attach: failed to set up register rman"
argument_list|)
expr_stmt|;
comment|/* These are needed for things without a proper device to attach to */
name|sc
operator|->
name|sc_sx
operator|.
name|sc_intctl_ioh
operator|=
name|S3C24X0_INTCTL_BASE
expr_stmt|;
name|sc
operator|->
name|sc_sx
operator|.
name|sc_gpio_ioh
operator|=
name|S3C24X0_GPIO_BASE
expr_stmt|;
name|sc
operator|->
name|sc_sx
operator|.
name|sc_clkman_ioh
operator|=
name|S3C24X0_CLKMAN_BASE
expr_stmt|;
name|sc
operator|->
name|sc_sx
operator|.
name|sc_wdt_ioh
operator|=
name|S3C24X0_WDT_BASE
expr_stmt|;
name|sc
operator|->
name|sc_timer_ioh
operator|=
name|S3C24X0_TIMER_BASE
expr_stmt|;
comment|/* 	 * Identify the CPU 	 */
name|s3c24x0_identify_cpu
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* 	 * Manage the interrupt space. 	 * We need to put this after s3c24x0_identify_cpu as the avaliable 	 * interrupts change depending on which CPU we have. 	 */
if|if
condition|(
name|sc
operator|->
name|sc_sx
operator|.
name|sc_cpu
operator|==
name|CPU_S3C2410
condition|)
name|irqmax
operator|=
name|S3C2410_SUBIRQ_MAX
expr_stmt|;
else|else
name|irqmax
operator|=
name|S3C2440_SUBIRQ_MAX
expr_stmt|;
if|if
condition|(
name|rman_init
argument_list|(
operator|&
name|s3c2xx0_softc
operator|->
name|s3c2xx0_irq_rman
argument_list|)
operator|!=
literal|0
operator|||
name|rman_manage_region
argument_list|(
operator|&
name|s3c2xx0_softc
operator|->
name|s3c2xx0_irq_rman
argument_list|,
literal|0
argument_list|,
name|irqmax
argument_list|)
operator|!=
literal|0
operator|||
name|rman_manage_region
argument_list|(
operator|&
name|s3c2xx0_softc
operator|->
name|s3c2xx0_irq_rman
argument_list|,
name|S3C24X0_EXTIRQ_MIN
argument_list|,
name|S3C24X0_EXTIRQ_MAX
argument_list|)
condition|)
name|panic
argument_list|(
literal|"s3c24x0_attach: failed to set up IRQ rman"
argument_list|)
expr_stmt|;
comment|/* calculate current clock frequency */
name|s3c24x0_clock_freq
argument_list|(
operator|&
name|sc
operator|->
name|sc_sx
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"fclk %d MHz hclk %d MHz pclk %d MHz\n"
argument_list|,
name|sc
operator|->
name|sc_sx
operator|.
name|sc_fclk
operator|/
literal|1000000
argument_list|,
name|sc
operator|->
name|sc_sx
operator|.
name|sc_hclk
operator|/
literal|1000000
argument_list|,
name|sc
operator|->
name|sc_sx
operator|.
name|sc_pclk
operator|/
literal|1000000
argument_list|)
expr_stmt|;
comment|/* 	 * Attach children devices 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|s3c24x0_children
index|[
name|i
index|]
operator|.
name|name
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
name|child
operator|=
name|s3c24x0_add_child
argument_list|(
name|dev
argument_list|,
name|s3c24x0_children
index|[
name|i
index|]
operator|.
name|prio
argument_list|,
name|s3c24x0_children
index|[
name|i
index|]
operator|.
name|name
argument_list|,
name|s3c24x0_children
index|[
name|i
index|]
operator|.
name|unit
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
sizeof|sizeof
argument_list|(
name|s3c24x0_children
index|[
name|i
index|]
operator|.
name|res
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|s3c24x0_children
index|[
name|i
index|]
operator|.
name|res
index|[
literal|0
index|]
argument_list|)
operator|&&
name|s3c24x0_children
index|[
name|i
index|]
operator|.
name|res
index|[
name|j
index|]
operator|.
name|type
operator|!=
literal|0
condition|;
name|j
operator|++
control|)
block|{
name|bus_set_resource
argument_list|(
name|child
argument_list|,
name|s3c24x0_children
index|[
name|i
index|]
operator|.
name|res
index|[
name|j
index|]
operator|.
name|type
argument_list|,
literal|0
argument_list|,
name|s3c24x0_children
index|[
name|i
index|]
operator|.
name|res
index|[
name|j
index|]
operator|.
name|start
argument_list|,
name|s3c24x0_children
index|[
name|i
index|]
operator|.
name|res
index|[
name|j
index|]
operator|.
name|count
argument_list|)
expr_stmt|;
block|}
block|}
name|bus_generic_probe
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|bus_generic_attach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|s3c24x0_identify_cpu
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|s3c24x0_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|uint32_t
name|idcode
decl_stmt|;
name|int
name|i
decl_stmt|;
name|idcode
operator|=
name|bus_space_read_4
argument_list|(
name|sc
operator|->
name|sc_sx
operator|.
name|sc_iot
argument_list|,
name|sc
operator|->
name|sc_sx
operator|.
name|sc_gpio_ioh
argument_list|,
name|GPIO_GSTATUS1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|s3c2x0_cpu_id
index|[
name|i
index|]
operator|.
name|name
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|s3c2x0_cpu_id
index|[
name|i
index|]
operator|.
name|idcode
operator|==
name|idcode
condition|)
break|break;
block|}
if|if
condition|(
name|s3c2x0_cpu_id
index|[
name|i
index|]
operator|.
name|name
operator|==
name|NULL
condition|)
name|panic
argument_list|(
literal|"Unknown CPU detected ((Chip ID: %#X)"
argument_list|,
name|idcode
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Found %s CPU (Chip ID: %#X)\n"
argument_list|,
name|s3c2x0_cpu_id
index|[
name|i
index|]
operator|.
name|name
argument_list|,
name|idcode
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_sx
operator|.
name|sc_cpu
operator|=
name|s3c2x0_cpu_id
index|[
name|i
index|]
operator|.
name|cpu
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * fill sc_pclk, sc_hclk, sc_fclk from values of clock controller register.  *  * s3c24{1,4}0_clock_freq2() is meant to be called from kernel startup routines.  * s3c24x0_clock_freq() is for after kernel initialization is done.  *  * Because they can be called before bus_space is available we need to use  * volatile pointers rather than bus_space_read.  */
end_comment

begin_function
name|void
name|s3c2410_clock_freq2
parameter_list|(
name|vm_offset_t
name|clkman_base
parameter_list|,
name|int
modifier|*
name|fclk
parameter_list|,
name|int
modifier|*
name|hclk
parameter_list|,
name|int
modifier|*
name|pclk
parameter_list|)
block|{
name|uint32_t
name|pllcon
decl_stmt|,
name|divn
decl_stmt|;
name|unsigned
name|int
name|mdiv
decl_stmt|,
name|pdiv
decl_stmt|,
name|sdiv
decl_stmt|;
name|unsigned
name|int
name|f
decl_stmt|,
name|h
decl_stmt|,
name|p
decl_stmt|;
name|pllcon
operator|=
operator|*
operator|(
specifier|volatile
name|uint32_t
operator|*
operator|)
operator|(
name|clkman_base
operator|+
name|CLKMAN_MPLLCON
operator|)
expr_stmt|;
name|divn
operator|=
operator|*
operator|(
specifier|volatile
name|uint32_t
operator|*
operator|)
operator|(
name|clkman_base
operator|+
name|CLKMAN_CLKDIVN
operator|)
expr_stmt|;
name|mdiv
operator|=
operator|(
name|pllcon
operator|&
name|PLLCON_MDIV_MASK
operator|)
operator|>>
name|PLLCON_MDIV_SHIFT
expr_stmt|;
name|pdiv
operator|=
operator|(
name|pllcon
operator|&
name|PLLCON_PDIV_MASK
operator|)
operator|>>
name|PLLCON_PDIV_SHIFT
expr_stmt|;
name|sdiv
operator|=
operator|(
name|pllcon
operator|&
name|PLLCON_SDIV_MASK
operator|)
operator|>>
name|PLLCON_SDIV_SHIFT
expr_stmt|;
name|f
operator|=
operator|(
operator|(
name|mdiv
operator|+
literal|8
operator|)
operator|*
name|S3C2XX0_XTAL_CLK
operator|)
operator|/
operator|(
operator|(
name|pdiv
operator|+
literal|2
operator|)
operator|*
operator|(
literal|1
operator|<<
name|sdiv
operator|)
operator|)
expr_stmt|;
name|h
operator|=
name|f
expr_stmt|;
if|if
condition|(
name|divn
operator|&
name|S3C2410_CLKDIVN_HDIVN
condition|)
name|h
operator|/=
literal|2
expr_stmt|;
name|p
operator|=
name|h
expr_stmt|;
if|if
condition|(
name|divn
operator|&
name|CLKDIVN_PDIVN
condition|)
name|p
operator|/=
literal|2
expr_stmt|;
if|if
condition|(
name|fclk
condition|)
operator|*
name|fclk
operator|=
name|f
expr_stmt|;
if|if
condition|(
name|hclk
condition|)
operator|*
name|hclk
operator|=
name|h
expr_stmt|;
if|if
condition|(
name|pclk
condition|)
operator|*
name|pclk
operator|=
name|p
expr_stmt|;
block|}
end_function

begin_function
name|void
name|s3c2440_clock_freq2
parameter_list|(
name|vm_offset_t
name|clkman_base
parameter_list|,
name|int
modifier|*
name|fclk
parameter_list|,
name|int
modifier|*
name|hclk
parameter_list|,
name|int
modifier|*
name|pclk
parameter_list|)
block|{
name|uint32_t
name|pllcon
decl_stmt|,
name|divn
decl_stmt|,
name|camdivn
decl_stmt|;
name|unsigned
name|int
name|mdiv
decl_stmt|,
name|pdiv
decl_stmt|,
name|sdiv
decl_stmt|;
name|unsigned
name|int
name|f
decl_stmt|,
name|h
decl_stmt|,
name|p
decl_stmt|;
name|pllcon
operator|=
operator|*
operator|(
specifier|volatile
name|uint32_t
operator|*
operator|)
operator|(
name|clkman_base
operator|+
name|CLKMAN_MPLLCON
operator|)
expr_stmt|;
name|divn
operator|=
operator|*
operator|(
specifier|volatile
name|uint32_t
operator|*
operator|)
operator|(
name|clkman_base
operator|+
name|CLKMAN_CLKDIVN
operator|)
expr_stmt|;
name|camdivn
operator|=
operator|*
operator|(
specifier|volatile
name|uint32_t
operator|*
operator|)
operator|(
name|clkman_base
operator|+
name|S3C2440_CLKMAN_CAMDIVN
operator|)
expr_stmt|;
name|mdiv
operator|=
operator|(
name|pllcon
operator|&
name|PLLCON_MDIV_MASK
operator|)
operator|>>
name|PLLCON_MDIV_SHIFT
expr_stmt|;
name|pdiv
operator|=
operator|(
name|pllcon
operator|&
name|PLLCON_PDIV_MASK
operator|)
operator|>>
name|PLLCON_PDIV_SHIFT
expr_stmt|;
name|sdiv
operator|=
operator|(
name|pllcon
operator|&
name|PLLCON_SDIV_MASK
operator|)
operator|>>
name|PLLCON_SDIV_SHIFT
expr_stmt|;
name|f
operator|=
operator|(
literal|2
operator|*
operator|(
name|mdiv
operator|+
literal|8
operator|)
operator|*
name|S3C2XX0_XTAL_CLK
operator|)
operator|/
operator|(
operator|(
name|pdiv
operator|+
literal|2
operator|)
operator|*
operator|(
literal|1
operator|<<
name|sdiv
operator|)
operator|)
expr_stmt|;
name|h
operator|=
name|f
expr_stmt|;
switch|switch
condition|(
operator|(
name|divn
operator|>>
literal|1
operator|)
operator|&
literal|3
condition|)
block|{
case|case
literal|0
case|:
break|break;
case|case
literal|1
case|:
name|h
operator|/=
literal|2
expr_stmt|;
break|break;
case|case
literal|2
case|:
if|if
condition|(
operator|(
name|camdivn
operator|&
name|S3C2440_CAMDIVN_HCLK4_HALF
operator|)
operator|==
name|S3C2440_CAMDIVN_HCLK4_HALF
condition|)
name|h
operator|/=
literal|8
expr_stmt|;
else|else
name|h
operator|/=
literal|4
expr_stmt|;
break|break;
case|case
literal|3
case|:
if|if
condition|(
operator|(
name|camdivn
operator|&
name|S3C2440_CAMDIVN_HCLK3_HALF
operator|)
operator|==
name|S3C2440_CAMDIVN_HCLK3_HALF
condition|)
name|h
operator|/=
literal|6
expr_stmt|;
else|else
name|h
operator|/=
literal|3
expr_stmt|;
break|break;
block|}
name|p
operator|=
name|h
expr_stmt|;
if|if
condition|(
name|divn
operator|&
name|CLKDIVN_PDIVN
condition|)
name|p
operator|/=
literal|2
expr_stmt|;
if|if
condition|(
name|fclk
condition|)
operator|*
name|fclk
operator|=
name|f
expr_stmt|;
if|if
condition|(
name|hclk
condition|)
operator|*
name|hclk
operator|=
name|h
expr_stmt|;
if|if
condition|(
name|pclk
condition|)
operator|*
name|pclk
operator|=
name|p
expr_stmt|;
block|}
end_function

begin_function
name|void
name|s3c24x0_clock_freq
parameter_list|(
name|struct
name|s3c2xx0_softc
modifier|*
name|sc
parameter_list|)
block|{
name|vm_offset_t
name|va
decl_stmt|;
name|va
operator|=
name|sc
operator|->
name|sc_clkman_ioh
expr_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|sc_cpu
condition|)
block|{
case|case
name|CPU_S3C2410
case|:
name|s3c2410_clock_freq2
argument_list|(
name|va
argument_list|,
operator|&
name|sc
operator|->
name|sc_fclk
argument_list|,
operator|&
name|sc
operator|->
name|sc_hclk
argument_list|,
operator|&
name|sc
operator|->
name|sc_pclk
argument_list|)
expr_stmt|;
break|break;
case|case
name|CPU_S3C2440
case|:
name|s3c2440_clock_freq2
argument_list|(
name|va
argument_list|,
operator|&
name|sc
operator|->
name|sc_fclk
argument_list|,
operator|&
name|sc
operator|->
name|sc_hclk
argument_list|,
operator|&
name|sc
operator|->
name|sc_pclk
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|cpu_reset
parameter_list|(
name|void
parameter_list|)
block|{
operator|(
name|void
operator|)
name|disable_interrupts
argument_list|(
name|PSR_I
operator||
name|PSR_F
argument_list|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
operator|&
name|s3c2xx0_bs_tag
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_wdt_ioh
argument_list|,
name|WDT_WTCON
argument_list|,
name|WTCON_ENABLE
operator||
name|WTCON_CLKSEL_16
operator||
name|WTCON_ENRST
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
empty_stmt|;
block|}
end_function

begin_function
name|void
name|s3c24x0_sleep
parameter_list|(
name|int
name|mode
name|__unused
parameter_list|)
block|{
name|int
name|reg
decl_stmt|;
name|reg
operator|=
name|bus_space_read_4
argument_list|(
operator|&
name|s3c2xx0_bs_tag
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_clkman_ioh
argument_list|,
name|CLKMAN_CLKCON
argument_list|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
operator|&
name|s3c2xx0_bs_tag
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_clkman_ioh
argument_list|,
name|CLKMAN_CLKCON
argument_list|,
name|reg
operator||
name|CLKCON_IDLE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|arm_get_next_irq
parameter_list|(
name|int
name|last
name|__unused
parameter_list|)
block|{
name|uint32_t
name|intpnd
decl_stmt|;
name|int
name|irq
decl_stmt|,
name|subirq
decl_stmt|;
if|if
condition|(
operator|(
name|irq
operator|=
name|bus_space_read_4
argument_list|(
operator|&
name|s3c2xx0_bs_tag
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_intctl_ioh
argument_list|,
name|INTCTL_INTOFFSET
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* Clear the pending bit */
name|intpnd
operator|=
name|bus_space_read_4
argument_list|(
operator|&
name|s3c2xx0_bs_tag
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_intctl_ioh
argument_list|,
name|INTCTL_INTPND
argument_list|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
operator|&
name|s3c2xx0_bs_tag
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_intctl_ioh
argument_list|,
name|INTCTL_SRCPND
argument_list|,
name|intpnd
argument_list|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
operator|&
name|s3c2xx0_bs_tag
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_intctl_ioh
argument_list|,
name|INTCTL_INTPND
argument_list|,
name|intpnd
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|irq
condition|)
block|{
case|case
name|S3C24X0_INT_ADCTC
case|:
case|case
name|S3C24X0_INT_UART0
case|:
case|case
name|S3C24X0_INT_UART1
case|:
case|case
name|S3C24X0_INT_UART2
case|:
comment|/* Find the sub IRQ */
name|subirq
operator|=
literal|0x7ff
expr_stmt|;
name|subirq
operator|&=
name|bus_space_read_4
argument_list|(
operator|&
name|s3c2xx0_bs_tag
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_intctl_ioh
argument_list|,
name|INTCTL_SUBSRCPND
argument_list|)
expr_stmt|;
name|subirq
operator|&=
operator|~
operator|(
name|bus_space_read_4
argument_list|(
operator|&
name|s3c2xx0_bs_tag
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_intctl_ioh
argument_list|,
name|INTCTL_INTSUBMSK
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|subirq
operator|==
literal|0
condition|)
return|return
operator|(
name|irq
operator|)
return|;
name|subirq
operator|=
name|ffs
argument_list|(
name|subirq
argument_list|)
operator|-
literal|1
expr_stmt|;
comment|/* Clear the sub irq pending bit */
name|bus_space_write_4
argument_list|(
operator|&
name|s3c2xx0_bs_tag
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_intctl_ioh
argument_list|,
name|INTCTL_SUBSRCPND
argument_list|,
operator|(
literal|1
operator|<<
name|subirq
operator|)
argument_list|)
expr_stmt|;
comment|/* 			 * Return the parent IRQ for UART 			 * as it is all we ever need 			 */
if|if
condition|(
name|subirq
operator|<=
literal|8
condition|)
return|return
operator|(
name|irq
operator|)
return|;
return|return
operator|(
name|S3C24X0_SUBIRQ_MIN
operator|+
name|subirq
operator|)
return|;
case|case
name|S3C24X0_INT_0
case|:
case|case
name|S3C24X0_INT_1
case|:
case|case
name|S3C24X0_INT_2
case|:
case|case
name|S3C24X0_INT_3
case|:
comment|/* There is a 1:1 mapping to the IRQ we are handling */
return|return
name|S3C24X0_INT_EXT
argument_list|(
name|irq
argument_list|)
return|;
case|case
name|S3C24X0_INT_4_7
case|:
case|case
name|S3C24X0_INT_8_23
case|:
comment|/* Find the external interrupt being called */
name|subirq
operator|=
literal|0x7fffff
expr_stmt|;
name|subirq
operator|&=
name|bus_space_read_4
argument_list|(
operator|&
name|s3c2xx0_bs_tag
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_gpio_ioh
argument_list|,
name|GPIO_EINTPEND
argument_list|)
expr_stmt|;
name|subirq
operator|&=
operator|~
name|bus_space_read_4
argument_list|(
operator|&
name|s3c2xx0_bs_tag
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_gpio_ioh
argument_list|,
name|GPIO_EINTMASK
argument_list|)
expr_stmt|;
if|if
condition|(
name|subirq
operator|==
literal|0
condition|)
return|return
operator|(
name|irq
operator|)
return|;
name|subirq
operator|=
name|ffs
argument_list|(
name|subirq
argument_list|)
operator|-
literal|1
expr_stmt|;
comment|/* Clear the external irq pending bit */
name|bus_space_write_4
argument_list|(
operator|&
name|s3c2xx0_bs_tag
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_gpio_ioh
argument_list|,
name|GPIO_EINTPEND
argument_list|,
operator|(
literal|1
operator|<<
name|subirq
operator|)
argument_list|)
expr_stmt|;
return|return
name|S3C24X0_INT_EXT
argument_list|(
name|subirq
argument_list|)
return|;
block|}
return|return
operator|(
name|irq
operator|)
return|;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|void
name|arm_mask_irq
parameter_list|(
name|uintptr_t
name|irq
parameter_list|)
block|{
name|u_int32_t
name|mask
decl_stmt|;
if|if
condition|(
name|irq
operator|>=
name|S3C24X0_INT_EXT
argument_list|(
literal|0
argument_list|)
operator|&&
name|irq
operator|<=
name|S3C24X0_INT_EXT
argument_list|(
literal|3
argument_list|)
condition|)
block|{
comment|/* External interrupt 0..3 are directly mapped to irq 0..3 */
name|irq
operator|-=
name|S3C24X0_EXTIRQ_MIN
expr_stmt|;
block|}
if|if
condition|(
name|irq
operator|<
name|S3C24X0_SUBIRQ_MIN
condition|)
block|{
name|mask
operator|=
name|bus_space_read_4
argument_list|(
operator|&
name|s3c2xx0_bs_tag
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_intctl_ioh
argument_list|,
name|INTCTL_INTMSK
argument_list|)
expr_stmt|;
name|mask
operator||=
operator|(
literal|1
operator|<<
name|irq
operator|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
operator|&
name|s3c2xx0_bs_tag
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_intctl_ioh
argument_list|,
name|INTCTL_INTMSK
argument_list|,
name|mask
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|irq
operator|<
name|S3C24X0_EXTIRQ_MIN
condition|)
block|{
name|mask
operator|=
name|bus_space_read_4
argument_list|(
operator|&
name|s3c2xx0_bs_tag
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_intctl_ioh
argument_list|,
name|INTCTL_INTSUBMSK
argument_list|)
expr_stmt|;
name|mask
operator||=
operator|(
literal|1
operator|<<
operator|(
name|irq
operator|-
name|S3C24X0_SUBIRQ_MIN
operator|)
operator|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
operator|&
name|s3c2xx0_bs_tag
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_intctl_ioh
argument_list|,
name|INTCTL_INTSUBMSK
argument_list|,
name|mask
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mask
operator|=
name|bus_space_read_4
argument_list|(
operator|&
name|s3c2xx0_bs_tag
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_gpio_ioh
argument_list|,
name|GPIO_EINTMASK
argument_list|)
expr_stmt|;
name|mask
operator||=
operator|(
literal|1
operator|<<
operator|(
name|irq
operator|-
name|S3C24X0_EXTIRQ_MIN
operator|)
operator|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
operator|&
name|s3c2xx0_bs_tag
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_intctl_ioh
argument_list|,
name|GPIO_EINTMASK
argument_list|,
name|mask
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|arm_unmask_irq
parameter_list|(
name|uintptr_t
name|irq
parameter_list|)
block|{
name|u_int32_t
name|mask
decl_stmt|;
if|if
condition|(
name|irq
operator|>=
name|S3C24X0_INT_EXT
argument_list|(
literal|0
argument_list|)
operator|&&
name|irq
operator|<=
name|S3C24X0_INT_EXT
argument_list|(
literal|3
argument_list|)
condition|)
block|{
comment|/* External interrupt 0..3 are directly mapped to irq 0..3 */
name|irq
operator|-=
name|S3C24X0_EXTIRQ_MIN
expr_stmt|;
block|}
if|if
condition|(
name|irq
operator|<
name|S3C24X0_SUBIRQ_MIN
condition|)
block|{
name|mask
operator|=
name|bus_space_read_4
argument_list|(
operator|&
name|s3c2xx0_bs_tag
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_intctl_ioh
argument_list|,
name|INTCTL_INTMSK
argument_list|)
expr_stmt|;
name|mask
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|irq
operator|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
operator|&
name|s3c2xx0_bs_tag
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_intctl_ioh
argument_list|,
name|INTCTL_INTMSK
argument_list|,
name|mask
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|irq
operator|<
name|S3C24X0_EXTIRQ_MIN
condition|)
block|{
name|mask
operator|=
name|bus_space_read_4
argument_list|(
operator|&
name|s3c2xx0_bs_tag
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_intctl_ioh
argument_list|,
name|INTCTL_INTSUBMSK
argument_list|)
expr_stmt|;
name|mask
operator|&=
operator|~
operator|(
literal|1
operator|<<
operator|(
name|irq
operator|-
name|S3C24X0_SUBIRQ_MIN
operator|)
operator|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
operator|&
name|s3c2xx0_bs_tag
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_intctl_ioh
argument_list|,
name|INTCTL_INTSUBMSK
argument_list|,
name|mask
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mask
operator|=
name|bus_space_read_4
argument_list|(
operator|&
name|s3c2xx0_bs_tag
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_gpio_ioh
argument_list|,
name|GPIO_EINTMASK
argument_list|)
expr_stmt|;
name|mask
operator|&=
operator|~
operator|(
literal|1
operator|<<
operator|(
name|irq
operator|-
name|S3C24X0_EXTIRQ_MIN
operator|)
operator|)
expr_stmt|;
name|bus_space_write_4
argument_list|(
operator|&
name|s3c2xx0_bs_tag
argument_list|,
name|s3c2xx0_softc
operator|->
name|sc_intctl_ioh
argument_list|,
name|GPIO_EINTMASK
argument_list|,
name|mask
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


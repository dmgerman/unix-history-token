begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright 2015 Oleksandr Tymoshenko<gonzo@freebsd.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/clock.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/fbio.h>
end_include

begin_include
include|#
directive|include
file|<sys/consio.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/openfirm.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus_subr.h>
end_include

begin_include
include|#
directive|include
file|<dev/fb/fbreg.h>
end_include

begin_include
include|#
directive|include
file|<dev/vt/vt.h>
end_include

begin_include
include|#
directive|include
file|<dev/videomode/videomode.h>
end_include

begin_include
include|#
directive|include
file|<dev/videomode/edidvar.h>
end_include

begin_include
include|#
directive|include
file|<arm/freescale/imx/imx6_src.h>
end_include

begin_include
include|#
directive|include
file|<arm/freescale/imx/imx_ccmvar.h>
end_include

begin_include
include|#
directive|include
file|"fb_if.h"
end_include

begin_include
include|#
directive|include
file|"hdmi_if.h"
end_include

begin_define
define|#
directive|define
name|EDID_DEBUG_not
end_define

begin_decl_stmt
specifier|static
name|int
name|have_ipu
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|LDB_CLOCK_RATE
value|280000000
end_define

begin_define
define|#
directive|define
name|MODE_HBP
parameter_list|(
name|mode
parameter_list|)
value|((mode)->htotal - (mode)->hsync_end)
end_define

begin_define
define|#
directive|define
name|MODE_HFP
parameter_list|(
name|mode
parameter_list|)
value|((mode)->hsync_start - (mode)->hdisplay)
end_define

begin_define
define|#
directive|define
name|MODE_HSW
parameter_list|(
name|mode
parameter_list|)
value|((mode)->hsync_end - (mode)->hsync_start)
end_define

begin_define
define|#
directive|define
name|MODE_VBP
parameter_list|(
name|mode
parameter_list|)
value|((mode)->vtotal - (mode)->vsync_end)
end_define

begin_define
define|#
directive|define
name|MODE_VFP
parameter_list|(
name|mode
parameter_list|)
value|((mode)->vsync_start - (mode)->vdisplay)
end_define

begin_define
define|#
directive|define
name|MODE_VSW
parameter_list|(
name|mode
parameter_list|)
value|((mode)->vsync_end - (mode)->vsync_start)
end_define

begin_define
define|#
directive|define
name|MODE_BPP
value|16
end_define

begin_define
define|#
directive|define
name|MODE_PIXEL_CLOCK_INVERT
value|1
end_define

begin_define
define|#
directive|define
name|M
parameter_list|(
name|nm
parameter_list|,
name|hr
parameter_list|,
name|vr
parameter_list|,
name|clk
parameter_list|,
name|hs
parameter_list|,
name|he
parameter_list|,
name|ht
parameter_list|,
name|vs
parameter_list|,
name|ve
parameter_list|,
name|vt
parameter_list|,
name|f
parameter_list|)
define|\
value|{ clk, hr, hs, he, ht, vr, vs, ve, vt, f, nm }
end_define

begin_decl_stmt
specifier|static
name|struct
name|videomode
name|mode1024x768
init|=
name|M
argument_list|(
literal|"1024x768x60"
argument_list|,
literal|1024
argument_list|,
literal|768
argument_list|,
literal|65000
argument_list|,
literal|1048
argument_list|,
literal|1184
argument_list|,
literal|1344
argument_list|,
literal|771
argument_list|,
literal|777
argument_list|,
literal|806
argument_list|,
name|VID_NHSYNC
operator||
name|VID_PHSYNC
argument_list|)
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|DMA_CHANNEL
value|23
end_define

begin_define
define|#
directive|define
name|DC_CHAN5
value|5
end_define

begin_define
define|#
directive|define
name|DI_PORT
value|0
end_define

begin_define
define|#
directive|define
name|IPU_LOCK
parameter_list|(
name|_sc
parameter_list|)
value|mtx_lock(&(_sc)->sc_mtx)
end_define

begin_define
define|#
directive|define
name|IPU_UNLOCK
parameter_list|(
name|_sc
parameter_list|)
value|mtx_unlock(&(_sc)->sc_mtx)
end_define

begin_define
define|#
directive|define
name|IPU_LOCK_INIT
parameter_list|(
name|_sc
parameter_list|)
value|mtx_init(&(_sc)->sc_mtx, \     device_get_nameunit(_sc->sc_dev), "ipu", MTX_DEF)
end_define

begin_define
define|#
directive|define
name|IPU_LOCK_DESTROY
parameter_list|(
name|_sc
parameter_list|)
value|mtx_destroy(&(_sc)->sc_mtx)
end_define

begin_define
define|#
directive|define
name|IPU_READ4
parameter_list|(
name|_sc
parameter_list|,
name|reg
parameter_list|)
value|bus_read_4((_sc)->sc_mem_res, (reg))
end_define

begin_define
define|#
directive|define
name|IPU_WRITE4
parameter_list|(
name|_sc
parameter_list|,
name|reg
parameter_list|,
name|value
parameter_list|)
define|\
value|bus_write_4((_sc)->sc_mem_res, (reg), (value))
end_define

begin_define
define|#
directive|define
name|CPMEM_BASE
value|0x300000
end_define

begin_define
define|#
directive|define
name|DC_TEMPL_BASE
value|0x380000
end_define

begin_comment
comment|/* Microcode */
end_comment

begin_comment
comment|/* Word 1 */
end_comment

begin_define
define|#
directive|define
name|TEMPLATE_SYNC
parameter_list|(
name|v
parameter_list|)
value|((v)<< 0)
end_define

begin_define
define|#
directive|define
name|TEMPLATE_GLUELOGIC
parameter_list|(
name|v
parameter_list|)
value|((v)<< 4)
end_define

begin_define
define|#
directive|define
name|TEMPLATE_MAPPING
parameter_list|(
name|v
parameter_list|)
value|((v)<< 15)
end_define

begin_define
define|#
directive|define
name|TEMPLATE_WAVEFORM
parameter_list|(
name|v
parameter_list|)
value|((v)<< 11)
end_define

begin_define
define|#
directive|define
name|GLUELOGIC_KEEP_ASSERTED
value|(1<< 3)
end_define

begin_define
define|#
directive|define
name|GLUELOGIC_KEEP_NEGATED
value|(1<< 2)
end_define

begin_comment
comment|/* Word 2 */
end_comment

begin_define
define|#
directive|define
name|TEMPLATE_OPCODE
parameter_list|(
name|v
parameter_list|)
value|((v)<< 4)
end_define

begin_define
define|#
directive|define
name|OPCODE_WROD
value|0x18
end_define

begin_define
define|#
directive|define
name|TEMPLATE_STOP
value|(1<< 9)
end_define

begin_define
define|#
directive|define
name|IPU_CONF
value|0x200000
end_define

begin_define
define|#
directive|define
name|IPU_CONF_DMFC_EN
value|(1<< 10)
end_define

begin_define
define|#
directive|define
name|IPU_CONF_DC_EN
value|(1<< 9)
end_define

begin_define
define|#
directive|define
name|IPU_CONF_DI1_EN
value|(1<< 7)
end_define

begin_define
define|#
directive|define
name|IPU_CONF_DI0_EN
value|(1<< 6)
end_define

begin_define
define|#
directive|define
name|IPU_CONF_DP_EN
value|(1<< 5)
end_define

begin_define
define|#
directive|define
name|IPU_DISP_GEN
value|0x2000C4
end_define

begin_define
define|#
directive|define
name|DISP_GEN_DI1_CNTR_RELEASE
value|(1<< 25)
end_define

begin_define
define|#
directive|define
name|DISP_GEN_DI0_CNTR_RELEASE
value|(1<< 24)
end_define

begin_define
define|#
directive|define
name|DISP_GEN_MCU_MAX_BURST_STOP
value|(1<< 22)
end_define

begin_define
define|#
directive|define
name|DISP_GEN_MCU_T_SHIFT
value|18
end_define

begin_define
define|#
directive|define
name|IPU_MEM_RST
value|0x2000DC
end_define

begin_define
define|#
directive|define
name|IPU_MEM_RST_START
value|(1<< 31)
end_define

begin_define
define|#
directive|define
name|IPU_MEM_RST_ALL
value|0x807FFFFF
end_define

begin_define
define|#
directive|define
name|IPU_CH_DB_MODE_SEL_0
value|0x200150
end_define

begin_define
define|#
directive|define
name|IPU_CH_DB_MODE_SEL_1
value|0x200154
end_define

begin_define
define|#
directive|define
name|IPU_CUR_BUF_0
value|0x20023C
end_define

begin_define
define|#
directive|define
name|IPU_CUR_BUF_1
value|0x200240
end_define

begin_define
define|#
directive|define
name|IPU_IDMAC_CH_EN_1
value|0x208004
end_define

begin_define
define|#
directive|define
name|IPU_IDMAC_CH_EN_2
value|0x208008
end_define

begin_define
define|#
directive|define
name|IPU_IDMAC_CH_PRI_1
value|0x208014
end_define

begin_define
define|#
directive|define
name|IPU_IDMAC_CH_PRI_2
value|0x208018
end_define

begin_define
define|#
directive|define
name|IPU_DI0_GENERAL
value|0x240000
end_define

begin_define
define|#
directive|define
name|DI_CLOCK_EXTERNAL
value|(1<< 20)
end_define

begin_define
define|#
directive|define
name|DI_GENERAL_POL_CLK
value|(1<< 17)
end_define

begin_define
define|#
directive|define
name|DI_GENERAL_POLARITY_3
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|DI_GENERAL_POLARITY_2
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|IPU_DI0_BS_CLKGEN0
value|0x240004
end_define

begin_define
define|#
directive|define
name|DI_BS_CLKGEN0
parameter_list|(
name|_int
parameter_list|,
name|_frac
parameter_list|)
value|(((_int)<< 4) | (_frac))
end_define

begin_define
define|#
directive|define
name|IPU_DI0_BS_CLKGEN1
value|0x240008
end_define

begin_define
define|#
directive|define
name|DI_BS_CLKGEN1_DOWN
parameter_list|(
name|_int
parameter_list|,
name|_frac
parameter_list|)
value|((((_int)<< 1) | (_frac))<< 16)
end_define

begin_define
define|#
directive|define
name|IPU_DI0_SW_GEN0_1
value|0x24000C
end_define

begin_define
define|#
directive|define
name|DI_RUN_VALUE_M1
parameter_list|(
name|v
parameter_list|)
value|((v)<< 19)
end_define

begin_define
define|#
directive|define
name|DI_RUN_RESOLUTION
parameter_list|(
name|v
parameter_list|)
value|((v)<< 16)
end_define

begin_define
define|#
directive|define
name|DI_OFFSET_VALUE
parameter_list|(
name|v
parameter_list|)
value|((v)<< 3)
end_define

begin_define
define|#
directive|define
name|IPU_DI0_SW_GEN1_1
value|0x240030
end_define

begin_define
define|#
directive|define
name|DI_CNT_POLARITY_GEN_EN
parameter_list|(
name|v
parameter_list|)
value|((v)<< 29)
end_define

begin_define
define|#
directive|define
name|DI_CNT_AUTO_RELOAD
value|(1<< 28)
end_define

begin_define
define|#
directive|define
name|DI_CNT_CLR_SEL
parameter_list|(
name|v
parameter_list|)
value|((v)<< 25)
end_define

begin_define
define|#
directive|define
name|DI_CNT_DOWN
parameter_list|(
name|v
parameter_list|)
value|((v)<< 16)
end_define

begin_define
define|#
directive|define
name|DI_CNT_POLARITY_TRIGGER_SEL
parameter_list|(
name|v
parameter_list|)
value|((v)<< 12)
end_define

begin_define
define|#
directive|define
name|DI_CNT_POLARITY_CLR_SEL
parameter_list|(
name|v
parameter_list|)
value|((v)<< 9)
end_define

begin_define
define|#
directive|define
name|IPU_DI0_SYNC_AS_GEN
value|0x240054
end_define

begin_define
define|#
directive|define
name|SYNC_AS_GEN_VSYNC_SEL
parameter_list|(
name|v
parameter_list|)
value|((v)<< 13)
end_define

begin_define
define|#
directive|define
name|SYNC_AS_GEN_SYNC_START
parameter_list|(
name|v
parameter_list|)
value|((v)<< 0)
end_define

begin_define
define|#
directive|define
name|IPU_DI0_DW_GEN_0
value|0x240058
end_define

begin_define
define|#
directive|define
name|DW_GEN_DI_ACCESS_SIZE
parameter_list|(
name|v
parameter_list|)
value|((v)<< 24)
end_define

begin_define
define|#
directive|define
name|DW_GEN_DI_COMPONENT_SIZE
parameter_list|(
name|v
parameter_list|)
value|((v)<< 16)
end_define

begin_define
define|#
directive|define
name|DW_GEN_DI_SET_MASK
value|3
end_define

begin_define
define|#
directive|define
name|DW_GEN_DI_PIN_15_SET
parameter_list|(
name|v
parameter_list|)
value|((v)<< 8)
end_define

begin_define
define|#
directive|define
name|IPU_DI0_DW_SET3_0
value|0x240118
end_define

begin_define
define|#
directive|define
name|DW_SET_DATA_CNT_DOWN
parameter_list|(
name|v
parameter_list|)
value|((v)<< 16)
end_define

begin_define
define|#
directive|define
name|DW_SET_DATA_CNT_UP
parameter_list|(
name|v
parameter_list|)
value|((v)<< 0)
end_define

begin_define
define|#
directive|define
name|IPU_DI0_STP_REP
value|0x240148
end_define

begin_define
define|#
directive|define
name|IPU_DI0_POL
value|0x240164
end_define

begin_define
define|#
directive|define
name|DI_POL_DRDY_POLARITY_15
value|(1<< 4)
end_define

begin_define
define|#
directive|define
name|IPU_DI0_SCR_CONF
value|0x240170
end_define

begin_define
define|#
directive|define
name|IPU_DI1_GENERAL
value|0x248000
end_define

begin_define
define|#
directive|define
name|IPU_DI1_BS_CLKGEN0
value|0x248004
end_define

begin_define
define|#
directive|define
name|IPU_DI1_BS_CLKGEN1
value|0x248008
end_define

begin_define
define|#
directive|define
name|IPU_DI1_SW_GEN0_1
value|0x24800C
end_define

begin_define
define|#
directive|define
name|IPU_DI1_SW_GEN1_1
value|0x248030
end_define

begin_define
define|#
directive|define
name|IPU_DI1_SYNC_AS_GEN
value|0x248054
end_define

begin_define
define|#
directive|define
name|IPU_DI1_DW_GEN_0
value|0x248058
end_define

begin_define
define|#
directive|define
name|IPU_DI1_POL
value|0x248164
end_define

begin_define
define|#
directive|define
name|IPU_DI1_DW_SET3_0
value|0x248118
end_define

begin_define
define|#
directive|define
name|IPU_DI1_STP_REP
value|0x248148
end_define

begin_define
define|#
directive|define
name|IPU_DI1_SCR_CONF
value|0x248170
end_define

begin_define
define|#
directive|define
name|DMFC_RD_CHAN
value|0x260000
end_define

begin_define
define|#
directive|define
name|DMFC_WR_CHAN
value|0x260004
end_define

begin_define
define|#
directive|define
name|DMFC_WR_CHAN_BURST_SIZE_32
value|(0<< 6)
end_define

begin_define
define|#
directive|define
name|DMFC_WR_CHAN_BURST_SIZE_16
value|(1<< 6)
end_define

begin_define
define|#
directive|define
name|DMFC_WR_CHAN_BURST_SIZE_8
value|(2<< 6)
end_define

begin_define
define|#
directive|define
name|DMFC_WR_CHAN_BURST_SIZE_4
value|(3<< 6)
end_define

begin_define
define|#
directive|define
name|DMFC_WR_CHAN_BURST_SIZE_4
value|(3<< 6)
end_define

begin_define
define|#
directive|define
name|DMFC_WR_CHAN_FIFO_SIZE_128
value|(2<< 3)
end_define

begin_define
define|#
directive|define
name|DMFC_WR_CHAN_DEF
value|0x260008
end_define

begin_define
define|#
directive|define
name|DMFC_WR_CHAN_DEF_WM_CLR_2C
parameter_list|(
name|v
parameter_list|)
value|((v)<< 29)
end_define

begin_define
define|#
directive|define
name|DMFC_WR_CHAN_DEF_WM_CLR_1C
parameter_list|(
name|v
parameter_list|)
value|((v)<< 21)
end_define

begin_define
define|#
directive|define
name|DMFC_WR_CHAN_DEF_WM_CLR_2
parameter_list|(
name|v
parameter_list|)
value|((v)<< 13)
end_define

begin_define
define|#
directive|define
name|DMFC_WR_CHAN_DEF_WM_CLR_1
parameter_list|(
name|v
parameter_list|)
value|((v)<< 5)
end_define

begin_define
define|#
directive|define
name|DMFC_WR_CHAN_DEF_WM_SET_1
parameter_list|(
name|v
parameter_list|)
value|((v)<< 2)
end_define

begin_define
define|#
directive|define
name|DMFC_WR_CHAN_DEF_WM_EN_1
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|DMFC_DP_CHAN
value|0x26000C
end_define

begin_define
define|#
directive|define
name|DMFC_DP_CHAN_BURST_SIZE_8
value|2
end_define

begin_define
define|#
directive|define
name|DMFC_DP_CHAN_FIFO_SIZE_256
value|1
end_define

begin_define
define|#
directive|define
name|DMFC_DP_CHAN_FIFO_SIZE_128
value|2
end_define

begin_define
define|#
directive|define
name|DMFC_DP_CHAN_BURST_SIZE_5F
parameter_list|(
name|v
parameter_list|)
value|((v)<< 14)
end_define

begin_define
define|#
directive|define
name|DMFC_DP_CHAN_FIFO_SIZE_5F
parameter_list|(
name|v
parameter_list|)
value|((v)<< 11)
end_define

begin_define
define|#
directive|define
name|DMFC_DP_CHAN_ST_ADDR_SIZE_5F
parameter_list|(
name|v
parameter_list|)
value|((v)<< 8)
end_define

begin_define
define|#
directive|define
name|DMFC_DP_CHAN_BURST_SIZE_5B
parameter_list|(
name|v
parameter_list|)
value|((v)<< 6)
end_define

begin_define
define|#
directive|define
name|DMFC_DP_CHAN_FIFO_SIZE_5B
parameter_list|(
name|v
parameter_list|)
value|((v)<< 3)
end_define

begin_define
define|#
directive|define
name|DMFC_DP_CHAN_ST_ADDR_SIZE_5B
parameter_list|(
name|v
parameter_list|)
value|((v)<< 0)
end_define

begin_define
define|#
directive|define
name|DMFC_DP_CHAN_DEF
value|0x260010
end_define

begin_define
define|#
directive|define
name|DMFC_DP_CHAN_DEF_WM_CLR_6F
parameter_list|(
name|v
parameter_list|)
value|((v)<< 29)
end_define

begin_define
define|#
directive|define
name|DMFC_DP_CHAN_DEF_WM_CLR_6B
parameter_list|(
name|v
parameter_list|)
value|((v)<< 21)
end_define

begin_define
define|#
directive|define
name|DMFC_DP_CHAN_DEF_WM_CLR_5F
parameter_list|(
name|v
parameter_list|)
value|((v)<< 13)
end_define

begin_define
define|#
directive|define
name|DMFC_DP_CHAN_DEF_WM_SET_5F
parameter_list|(
name|v
parameter_list|)
value|((v)<< 10)
end_define

begin_define
define|#
directive|define
name|DMFC_DP_CHAN_DEF_WM_EN_5F
value|(1<< 9)
end_define

begin_define
define|#
directive|define
name|DMFC_DP_CHAN_DEF_WM_CLR_5B
parameter_list|(
name|v
parameter_list|)
value|((v)<< 5)
end_define

begin_define
define|#
directive|define
name|DMFC_DP_CHAN_DEF_WM_SET_5B
parameter_list|(
name|v
parameter_list|)
value|((v)<< 2)
end_define

begin_define
define|#
directive|define
name|DMFC_DP_CHAN_DEF_WM_EN_5B
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|DMFC_GENERAL_1
value|0x260014
end_define

begin_define
define|#
directive|define
name|DMFC_GENERAL_1_WAIT4EOT_5B
value|(1<< 20)
end_define

begin_define
define|#
directive|define
name|DMFC_IC_CTRL
value|0x26001C
end_define

begin_define
define|#
directive|define
name|DMFC_IC_CTRL_DISABLED
value|0x2
end_define

begin_define
define|#
directive|define
name|DC_WRITE_CH_CONF_1
value|0x0025801C
end_define

begin_define
define|#
directive|define
name|WRITE_CH_CONF_PROG_CHAN_TYP_MASK
value|(7<< 5)
end_define

begin_define
define|#
directive|define
name|WRITE_CH_CONF_PROG_CHAN_NORMAL
value|(4<< 5)
end_define

begin_define
define|#
directive|define
name|DC_WRITE_CH_ADDR_1
value|0x00258020
end_define

begin_define
define|#
directive|define
name|DC_WRITE_CH_CONF_5
value|0x0025805C
end_define

begin_define
define|#
directive|define
name|WRITE_CH_CONF_PROG_DISP_ID
parameter_list|(
name|v
parameter_list|)
value|((v)<< 3)
end_define

begin_define
define|#
directive|define
name|WRITE_CH_CONF_PROG_DI_ID
parameter_list|(
name|v
parameter_list|)
value|((v)<< 2)
end_define

begin_define
define|#
directive|define
name|WRITE_CH_CONF_PROG_W_SIZE
parameter_list|(
name|v
parameter_list|)
value|(v)
end_define

begin_define
define|#
directive|define
name|DC_WRITE_CH_ADDR_5
value|0x00258060
end_define

begin_define
define|#
directive|define
name|DC_RL0_CH_5
value|0x00258064
end_define

begin_define
define|#
directive|define
name|DC_GEN
value|0x002580D4
end_define

begin_define
define|#
directive|define
name|DC_GEN_SYNC_PRIORITY
value|(1<< 7)
end_define

begin_define
define|#
directive|define
name|DC_GEN_ASYNC
value|(0<< 1)
end_define

begin_define
define|#
directive|define
name|DC_GEN_SYNC
value|(2<< 1)
end_define

begin_define
define|#
directive|define
name|DC_DISP_CONF2
parameter_list|(
name|di
parameter_list|)
value|(0x002580E8 + (di) * 4)
end_define

begin_define
define|#
directive|define
name|DC_MAP_CONF_0
value|0x00258108
end_define

begin_define
define|#
directive|define
name|DC_MAP_CONF_15
value|0x00258144
end_define

begin_define
define|#
directive|define
name|DC_MAP_CONF_VAL
parameter_list|(
name|map
parameter_list|)
value|(DC_MAP_CONF_15 + ((map) / 2) * sizeof(uint32_t))
end_define

begin_define
define|#
directive|define
name|MAP_CONF_VAL_MASK
value|0xffff
end_define

begin_define
define|#
directive|define
name|DC_MAP_CONF_PTR
parameter_list|(
name|ptr
parameter_list|)
value|(DC_MAP_CONF_0 + ((ptr) / 2) * sizeof(uint32_t))
end_define

begin_define
define|#
directive|define
name|MAP_CONF_PTR_MASK
value|0x1f
end_define

begin_define
define|#
directive|define
name|DI_COUNTER_INT_HSYNC
value|1
end_define

begin_define
define|#
directive|define
name|DI_COUNTER_HSYNC
value|2
end_define

begin_define
define|#
directive|define
name|DI_COUNTER_VSYNC
value|3
end_define

begin_define
define|#
directive|define
name|DI_COUNTER_AD_0
value|4
end_define

begin_define
define|#
directive|define
name|DI_COUNTER_AD_1
value|5
end_define

begin_define
define|#
directive|define
name|DI_SYNC_NONE
value|0
end_define

begin_define
define|#
directive|define
name|DI_SYNC_CLK
value|1
end_define

begin_define
define|#
directive|define
name|DI_SYNC_COUNTER
parameter_list|(
name|c
parameter_list|)
value|((c) + 1)
end_define

begin_struct
struct|struct
name|ipu_cpmem_word
block|{
name|uint32_t
name|data
index|[
literal|5
index|]
decl_stmt|;
name|uint32_t
name|padding
index|[
literal|3
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|ipu_cpmem_ch_param
block|{
name|struct
name|ipu_cpmem_word
name|word
index|[
literal|2
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|CH_PARAM_RESET
parameter_list|(
name|param
parameter_list|)
value|memset(param, 0, sizeof(*param))
end_define

begin_define
define|#
directive|define
name|IPU_READ_CH_PARAM
parameter_list|(
name|_sc
parameter_list|,
name|ch
parameter_list|,
name|param
parameter_list|)
value|bus_read_region_4( \ 	(_sc)->sc_mem_res, CPMEM_BASE + ch * (sizeof(*param)),\ 	(uint32_t*)param, sizeof(*param) / 4)
end_define

begin_define
define|#
directive|define
name|IPU_WRITE_CH_PARAM
parameter_list|(
name|_sc
parameter_list|,
name|ch
parameter_list|,
name|param
parameter_list|)
value|bus_write_region_4( \ 	(_sc)->sc_mem_res, CPMEM_BASE + ch * (sizeof(*param)),\ 	(uint32_t*)param, sizeof(*param) / 4)
end_define

begin_define
define|#
directive|define
name|CH_PARAM_SET_FW
parameter_list|(
name|param
parameter_list|,
name|v
parameter_list|)
value|ipu_ch_param_set_value((param), \ 	0, 125, 13, (v))
end_define

begin_define
define|#
directive|define
name|CH_PARAM_SET_FH
parameter_list|(
name|param
parameter_list|,
name|v
parameter_list|)
value|ipu_ch_param_set_value((param), \ 	0, 138, 12, (v))
end_define

begin_define
define|#
directive|define
name|CH_PARAM_SET_SLY
parameter_list|(
name|param
parameter_list|,
name|v
parameter_list|)
value|ipu_ch_param_set_value((param), \ 	1, 102, 14, (v))
end_define

begin_define
define|#
directive|define
name|CH_PARAM_SET_EBA0
parameter_list|(
name|param
parameter_list|,
name|v
parameter_list|)
value|ipu_ch_param_set_value((param), \ 	1, 0, 29, (v))
end_define

begin_define
define|#
directive|define
name|CH_PARAM_SET_EBA1
parameter_list|(
name|param
parameter_list|,
name|v
parameter_list|)
value|ipu_ch_param_set_value((param), \ 	1, 29, 29, (v))
end_define

begin_define
define|#
directive|define
name|CH_PARAM_SET_BPP
parameter_list|(
name|param
parameter_list|,
name|v
parameter_list|)
value|ipu_ch_param_set_value((param), \ 	0, 107, 3, (v))
end_define

begin_define
define|#
directive|define
name|CH_PARAM_SET_PFS
parameter_list|(
name|param
parameter_list|,
name|v
parameter_list|)
value|ipu_ch_param_set_value((param), \ 	1, 85, 4, (v))
end_define

begin_define
define|#
directive|define
name|CH_PARAM_SET_NPB
parameter_list|(
name|param
parameter_list|,
name|v
parameter_list|)
value|ipu_ch_param_set_value((param), \ 	1, 78, 7, (v))
end_define

begin_define
define|#
directive|define
name|CH_PARAM_SET_UBO
parameter_list|(
name|param
parameter_list|,
name|v
parameter_list|)
value|ipu_ch_param_set_value((param), \ 	0, 46, 22, (v))
end_define

begin_define
define|#
directive|define
name|CH_PARAM_SET_VBO
parameter_list|(
name|param
parameter_list|,
name|v
parameter_list|)
value|ipu_ch_param_set_value((param), \ 	0, 68, 22, (v))
end_define

begin_define
define|#
directive|define
name|CH_PARAM_SET_RED_WIDTH
parameter_list|(
name|param
parameter_list|,
name|v
parameter_list|)
value|ipu_ch_param_set_value((param), \ 	1, 116, 3, (v))
end_define

begin_define
define|#
directive|define
name|CH_PARAM_SET_RED_OFFSET
parameter_list|(
name|param
parameter_list|,
name|v
parameter_list|)
value|ipu_ch_param_set_value((param), \ 	1, 128, 5, (v))
end_define

begin_define
define|#
directive|define
name|CH_PARAM_SET_GREEN_WIDTH
parameter_list|(
name|param
parameter_list|,
name|v
parameter_list|)
value|ipu_ch_param_set_value((param), \ 	1, 119, 3, (v))
end_define

begin_define
define|#
directive|define
name|CH_PARAM_SET_GREEN_OFFSET
parameter_list|(
name|param
parameter_list|,
name|v
parameter_list|)
value|ipu_ch_param_set_value((param), \ 	1, 133, 5, (v))
end_define

begin_define
define|#
directive|define
name|CH_PARAM_SET_BLUE_WIDTH
parameter_list|(
name|param
parameter_list|,
name|v
parameter_list|)
value|ipu_ch_param_set_value((param), \ 	1, 122, 3, (v))
end_define

begin_define
define|#
directive|define
name|CH_PARAM_SET_BLUE_OFFSET
parameter_list|(
name|param
parameter_list|,
name|v
parameter_list|)
value|ipu_ch_param_set_value((param), \ 	1, 138, 5, (v))
end_define

begin_define
define|#
directive|define
name|CH_PARAM_SET_ALPHA_WIDTH
parameter_list|(
name|param
parameter_list|,
name|v
parameter_list|)
value|ipu_ch_param_set_value((param), \ 	1, 125, 3, (v))
end_define

begin_define
define|#
directive|define
name|CH_PARAM_SET_ALPHA_OFFSET
parameter_list|(
name|param
parameter_list|,
name|v
parameter_list|)
value|ipu_ch_param_set_value((param), \ 	1, 143, 5, (v))
end_define

begin_define
define|#
directive|define
name|CH_PARAM_GET_FW
parameter_list|(
name|param
parameter_list|)
value|ipu_ch_param_get_value((param), \ 	0, 125, 13)
end_define

begin_define
define|#
directive|define
name|CH_PARAM_GET_FH
parameter_list|(
name|param
parameter_list|)
value|ipu_ch_param_get_value((param), \ 	0, 138, 12)
end_define

begin_define
define|#
directive|define
name|CH_PARAM_GET_SLY
parameter_list|(
name|param
parameter_list|)
value|ipu_ch_param_get_value((param), \ 	1, 102, 14)
end_define

begin_define
define|#
directive|define
name|CH_PARAM_GET_EBA0
parameter_list|(
name|param
parameter_list|)
value|ipu_ch_param_get_value((param), \ 	1, 0, 29)
end_define

begin_define
define|#
directive|define
name|CH_PARAM_GET_EBA1
parameter_list|(
name|param
parameter_list|)
value|ipu_ch_param_get_value((param), \ 	1, 29, 29)
end_define

begin_define
define|#
directive|define
name|CH_PARAM_GET_BPP
parameter_list|(
name|param
parameter_list|)
value|ipu_ch_param_get_value((param), \ 	0, 107, 3)
end_define

begin_define
define|#
directive|define
name|CH_PARAM_GET_PFS
parameter_list|(
name|param
parameter_list|)
value|ipu_ch_param_get_value((param), \ 	1, 85, 4)
end_define

begin_define
define|#
directive|define
name|CH_PARAM_GET_NPB
parameter_list|(
name|param
parameter_list|)
value|ipu_ch_param_get_value((param), \ 	1, 78, 7)
end_define

begin_define
define|#
directive|define
name|CH_PARAM_GET_UBO
parameter_list|(
name|param
parameter_list|)
value|ipu_ch_param_get_value((param), \ 	0, 46, 22)
end_define

begin_define
define|#
directive|define
name|CH_PARAM_GET_VBO
parameter_list|(
name|param
parameter_list|)
value|ipu_ch_param_get_value((param), \ 	0, 68, 22)
end_define

begin_define
define|#
directive|define
name|CH_PARAM_GET_RED_WIDTH
parameter_list|(
name|param
parameter_list|)
value|ipu_ch_param_get_value((param), \ 	1, 116, 3)
end_define

begin_define
define|#
directive|define
name|CH_PARAM_GET_RED_OFFSET
parameter_list|(
name|param
parameter_list|)
value|ipu_ch_param_get_value((param), \ 	1, 128, 5)
end_define

begin_define
define|#
directive|define
name|CH_PARAM_GET_GREEN_WIDTH
parameter_list|(
name|param
parameter_list|)
value|ipu_ch_param_get_value((param), \ 	1, 119, 3)
end_define

begin_define
define|#
directive|define
name|CH_PARAM_GET_GREEN_OFFSET
parameter_list|(
name|param
parameter_list|)
value|ipu_ch_param_get_value((param), \ 	1, 133, 5)
end_define

begin_define
define|#
directive|define
name|CH_PARAM_GET_BLUE_WIDTH
parameter_list|(
name|param
parameter_list|)
value|ipu_ch_param_get_value((param), \ 	1, 122, 3)
end_define

begin_define
define|#
directive|define
name|CH_PARAM_GET_BLUE_OFFSET
parameter_list|(
name|param
parameter_list|)
value|ipu_ch_param_get_value((param), \ 	1, 138, 5)
end_define

begin_define
define|#
directive|define
name|CH_PARAM_GET_ALPHA_WIDTH
parameter_list|(
name|param
parameter_list|)
value|ipu_ch_param_get_value((param), \ 	1, 125, 3)
end_define

begin_define
define|#
directive|define
name|CH_PARAM_GET_ALPHA_OFFSET
parameter_list|(
name|param
parameter_list|)
value|ipu_ch_param_get_value((param), \ 	1, 143, 5)
end_define

begin_define
define|#
directive|define
name|IPU_PIX_FORMAT_BPP_32
value|0
end_define

begin_define
define|#
directive|define
name|IPU_PIX_FORMAT_BPP_24
value|1
end_define

begin_define
define|#
directive|define
name|IPU_PIX_FORMAT_BPP_18
value|2
end_define

begin_define
define|#
directive|define
name|IPU_PIX_FORMAT_BPP_16
value|3
end_define

begin_define
define|#
directive|define
name|IPU_PIX_FORMAT_BPP_12
value|4
end_define

begin_define
define|#
directive|define
name|IPU_PIX_FORMAT_BPP_8
value|5
end_define

begin_define
define|#
directive|define
name|IPU_PIX_FORMAT_BPP_
end_define

begin_define
define|#
directive|define
name|IPU_PIX_FORMAT_RGB
value|7
end_define

begin_enum
enum|enum
name|dc_event_t
block|{
name|DC_EVENT_NF
init|=
literal|0
block|,
name|DC_EVENT_NL
block|,
name|DC_EVENT_EOF
block|,
name|DC_EVENT_NFIELD
block|,
name|DC_EVENT_EOL
block|,
name|DC_EVENT_EOFIELD
block|,
name|DC_EVENT_NEW_ADDR
block|,
name|DC_EVENT_NEW_CHAN
block|,
name|DC_EVENT_NEW_DATA
block|}
enum|;
end_enum

begin_struct
struct|struct
name|ipu_softc
block|{
name|device_t
name|sc_dev
decl_stmt|;
name|struct
name|resource
modifier|*
name|sc_mem_res
decl_stmt|;
name|int
name|sc_mem_rid
decl_stmt|;
name|struct
name|resource
modifier|*
name|sc_irq_res
decl_stmt|;
name|int
name|sc_irq_rid
decl_stmt|;
name|void
modifier|*
name|sc_intr_hl
decl_stmt|;
name|struct
name|mtx
name|sc_mtx
decl_stmt|;
name|struct
name|fb_info
name|sc_fb_info
decl_stmt|;
name|struct
name|videomode
modifier|*
name|sc_mode
decl_stmt|;
comment|/* Framebuffer */
name|bus_dma_tag_t
name|sc_dma_tag
decl_stmt|;
name|bus_dmamap_t
name|sc_dma_map
decl_stmt|;
name|size_t
name|sc_fb_size
decl_stmt|;
name|bus_addr_t
name|sc_fb_phys
decl_stmt|;
name|uint8_t
modifier|*
name|sc_fb_base
decl_stmt|;
comment|/* HDMI */
name|eventhandler_tag
name|sc_hdmi_evh
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|ipu_dmamap_cb
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|err
parameter_list|)
block|{
name|bus_addr_t
modifier|*
name|addr
decl_stmt|;
if|if
condition|(
name|err
condition|)
return|return;
name|addr
operator|=
operator|(
name|bus_addr_t
operator|*
operator|)
name|arg
expr_stmt|;
operator|*
name|addr
operator|=
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipu_ch_param_set_value
parameter_list|(
name|struct
name|ipu_cpmem_ch_param
modifier|*
name|param
parameter_list|,
name|int
name|word
parameter_list|,
name|unsigned
name|int
name|offset
parameter_list|,
name|int
name|len
parameter_list|,
name|uint32_t
name|value
parameter_list|)
block|{
name|uint32_t
name|datapos
decl_stmt|,
name|bitpos
decl_stmt|,
name|mask
decl_stmt|;
name|uint32_t
name|data
decl_stmt|,
name|data2
decl_stmt|;
name|KASSERT
argument_list|(
operator|(
name|len
operator|<=
literal|32
operator|)
argument_list|,
operator|(
literal|"%s: field len is more than 32"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|datapos
operator|=
name|offset
operator|/
literal|32
expr_stmt|;
name|bitpos
operator|=
name|offset
operator|%
literal|32
expr_stmt|;
name|mask
operator|=
operator|(
literal|1
operator|<<
name|len
operator|)
operator|-
literal|1
expr_stmt|;
name|data
operator|=
name|param
operator|->
name|word
index|[
name|word
index|]
operator|.
name|data
index|[
name|datapos
index|]
expr_stmt|;
name|data
operator|&=
operator|~
operator|(
name|mask
operator|<<
name|bitpos
operator|)
expr_stmt|;
name|data
operator||=
operator|(
name|value
operator|<<
name|bitpos
operator|)
expr_stmt|;
name|param
operator|->
name|word
index|[
name|word
index|]
operator|.
name|data
index|[
name|datapos
index|]
operator|=
name|data
expr_stmt|;
if|if
condition|(
operator|(
name|bitpos
operator|+
name|len
operator|)
operator|>
literal|32
condition|)
block|{
name|len
operator|=
name|bitpos
operator|+
name|len
operator|-
literal|32
expr_stmt|;
name|mask
operator|=
operator|(
literal|1UL
operator|<<
name|len
operator|)
operator|-
literal|1
expr_stmt|;
name|data2
operator|=
name|param
operator|->
name|word
index|[
name|word
index|]
operator|.
name|data
index|[
name|datapos
operator|+
literal|1
index|]
expr_stmt|;
name|data2
operator|&=
name|mask
expr_stmt|;
name|data2
operator||=
operator|(
name|value
operator|>>
operator|(
literal|32
operator|-
name|bitpos
operator|)
operator|)
expr_stmt|;
name|param
operator|->
name|word
index|[
name|word
index|]
operator|.
name|data
index|[
name|datapos
operator|+
literal|1
index|]
operator|=
name|data2
expr_stmt|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_function
specifier|static
name|uint32_t
name|ipu_ch_param_get_value
parameter_list|(
name|struct
name|ipu_cpmem_ch_param
modifier|*
name|param
parameter_list|,
name|int
name|word
parameter_list|,
name|unsigned
name|int
name|offset
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|uint32_t
name|datapos
decl_stmt|,
name|bitpos
decl_stmt|,
name|mask
decl_stmt|;
name|uint32_t
name|data
decl_stmt|,
name|data2
decl_stmt|;
name|KASSERT
argument_list|(
operator|(
name|len
operator|<=
literal|32
operator|)
argument_list|,
operator|(
literal|"%s: field len is more than 32"
operator|,
name|__func__
operator|)
argument_list|)
expr_stmt|;
name|datapos
operator|=
name|offset
operator|/
literal|32
expr_stmt|;
name|bitpos
operator|=
name|offset
operator|%
literal|32
expr_stmt|;
name|mask
operator|=
operator|(
literal|1UL
operator|<<
name|len
operator|)
operator|-
literal|1
expr_stmt|;
name|data
operator|=
name|param
operator|->
name|word
index|[
name|word
index|]
operator|.
name|data
index|[
name|datapos
index|]
expr_stmt|;
name|data
operator|=
name|data
operator|>>
name|bitpos
expr_stmt|;
name|data
operator|&=
name|mask
expr_stmt|;
if|if
condition|(
operator|(
name|bitpos
operator|+
name|len
operator|)
operator|>
literal|32
condition|)
block|{
name|len
operator|=
name|bitpos
operator|+
name|len
operator|-
literal|32
expr_stmt|;
name|mask
operator|=
operator|(
literal|1UL
operator|<<
name|len
operator|)
operator|-
literal|1
expr_stmt|;
name|data2
operator|=
name|param
operator|->
name|word
index|[
name|word
index|]
operator|.
name|data
index|[
name|datapos
operator|+
literal|1
index|]
expr_stmt|;
name|data2
operator|&=
name|mask
expr_stmt|;
name|data
operator||=
operator|(
name|data2
operator|<<
operator|(
literal|32
operator|-
name|bitpos
operator|)
operator|)
expr_stmt|;
block|}
return|return
operator|(
name|data
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipu_print_channel
parameter_list|(
name|struct
name|ipu_cpmem_ch_param
modifier|*
name|param
parameter_list|)
block|{
name|int
name|offset0
index|[]
init|=
block|{
literal|0
block|,
literal|10
block|,
literal|19
block|,
literal|32
block|,
literal|44
block|,
literal|45
block|,
literal|46
block|,
literal|68
block|,
literal|90
block|,
literal|94
block|,
literal|95
block|,
literal|113
block|,
literal|114
block|,
literal|117
block|,
literal|119
block|,
literal|120
block|,
literal|121
block|,
literal|122
block|,
literal|123
block|,
literal|124
block|,
literal|125
block|,
literal|138
block|,
literal|150
block|,
literal|151
block|,
operator|-
literal|1
block|}
decl_stmt|;
name|int
name|offset1
index|[]
init|=
block|{
literal|0
block|,
literal|29
block|,
literal|58
block|,
literal|78
block|,
literal|85
block|,
literal|89
block|,
literal|90
block|,
literal|93
block|,
literal|95
block|,
literal|102
block|,
literal|116
block|,
literal|119
block|,
literal|122
block|,
literal|125
block|,
literal|128
block|,
literal|133
block|,
literal|138
block|,
literal|143
block|,
literal|148
block|,
literal|149
block|,
literal|150
block|,
operator|-
literal|1
block|}
decl_stmt|;
name|printf
argument_list|(
literal|"WORD0: %08x %08x %08x %08x %08x\n"
argument_list|,
name|param
operator|->
name|word
index|[
literal|0
index|]
operator|.
name|data
index|[
literal|0
index|]
argument_list|,
name|param
operator|->
name|word
index|[
literal|0
index|]
operator|.
name|data
index|[
literal|1
index|]
argument_list|,
name|param
operator|->
name|word
index|[
literal|0
index|]
operator|.
name|data
index|[
literal|2
index|]
argument_list|,
name|param
operator|->
name|word
index|[
literal|0
index|]
operator|.
name|data
index|[
literal|3
index|]
argument_list|,
name|param
operator|->
name|word
index|[
literal|0
index|]
operator|.
name|data
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"WORD1: %08x %08x %08x %08x %08x\n"
argument_list|,
name|param
operator|->
name|word
index|[
literal|1
index|]
operator|.
name|data
index|[
literal|0
index|]
argument_list|,
name|param
operator|->
name|word
index|[
literal|1
index|]
operator|.
name|data
index|[
literal|1
index|]
argument_list|,
name|param
operator|->
name|word
index|[
literal|1
index|]
operator|.
name|data
index|[
literal|2
index|]
argument_list|,
name|param
operator|->
name|word
index|[
literal|1
index|]
operator|.
name|data
index|[
literal|3
index|]
argument_list|,
name|param
operator|->
name|word
index|[
literal|1
index|]
operator|.
name|data
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|offset0
index|[
name|i
operator|+
literal|1
index|]
operator|!=
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
name|int
name|len
init|=
name|offset0
index|[
name|i
operator|+
literal|1
index|]
operator|-
name|offset0
index|[
name|i
index|]
decl_stmt|;
name|printf
argument_list|(
literal|"W0[%d:%d] = %d\n"
argument_list|,
name|offset0
index|[
name|i
index|]
argument_list|,
name|offset0
index|[
name|i
index|]
operator|+
name|len
operator|-
literal|1
argument_list|,
name|ipu_ch_param_get_value
argument_list|(
name|param
argument_list|,
literal|0
argument_list|,
name|offset0
index|[
name|i
index|]
argument_list|,
name|len
argument_list|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|offset1
index|[
name|i
operator|+
literal|1
index|]
operator|!=
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
name|int
name|len
init|=
name|offset1
index|[
name|i
operator|+
literal|1
index|]
operator|-
name|offset1
index|[
name|i
index|]
decl_stmt|;
name|printf
argument_list|(
literal|"W1[%d:%d] = %d\n"
argument_list|,
name|offset1
index|[
name|i
index|]
argument_list|,
name|offset1
index|[
name|i
index|]
operator|+
name|len
operator|-
literal|1
argument_list|,
name|ipu_ch_param_get_value
argument_list|(
name|param
argument_list|,
literal|1
argument_list|,
name|offset1
index|[
name|i
index|]
argument_list|,
name|len
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"FW:   %d\n"
argument_list|,
name|CH_PARAM_GET_FW
argument_list|(
name|param
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"FH:   %d\n"
argument_list|,
name|CH_PARAM_GET_FH
argument_list|(
name|param
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"SLY:  %d\n"
argument_list|,
name|CH_PARAM_GET_SLY
argument_list|(
name|param
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"EBA0: 0x%08x\n"
argument_list|,
name|CH_PARAM_GET_EBA0
argument_list|(
name|param
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"EBA1: 0x%08x\n"
argument_list|,
name|CH_PARAM_GET_EBA1
argument_list|(
name|param
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"BPP:  %d\n"
argument_list|,
name|CH_PARAM_GET_BPP
argument_list|(
name|param
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"PFS:  %d\n"
argument_list|,
name|CH_PARAM_GET_PFS
argument_list|(
name|param
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"NPB:  %d\n"
argument_list|,
name|CH_PARAM_GET_NPB
argument_list|(
name|param
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"UBO:  %d\n"
argument_list|,
name|CH_PARAM_GET_UBO
argument_list|(
name|param
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"VBO:  %d\n"
argument_list|,
name|CH_PARAM_GET_VBO
argument_list|(
name|param
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"RED:  %d bits @%d\n"
argument_list|,
name|CH_PARAM_GET_RED_WIDTH
argument_list|(
name|param
argument_list|)
operator|+
literal|1
argument_list|,
name|CH_PARAM_GET_RED_OFFSET
argument_list|(
name|param
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"GREEN:  %d bits @%d\n"
argument_list|,
name|CH_PARAM_GET_GREEN_WIDTH
argument_list|(
name|param
argument_list|)
operator|+
literal|1
argument_list|,
name|CH_PARAM_GET_GREEN_OFFSET
argument_list|(
name|param
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"BLUE:  %d bits @%d\n"
argument_list|,
name|CH_PARAM_GET_BLUE_WIDTH
argument_list|(
name|param
argument_list|)
operator|+
literal|1
argument_list|,
name|CH_PARAM_GET_BLUE_OFFSET
argument_list|(
name|param
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"ALPHA:  %d bits @%d\n"
argument_list|,
name|CH_PARAM_GET_ALPHA_WIDTH
argument_list|(
name|param
argument_list|)
operator|+
literal|1
argument_list|,
name|CH_PARAM_GET_ALPHA_OFFSET
argument_list|(
name|param
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|ipu_di_enable
parameter_list|(
name|struct
name|ipu_softc
modifier|*
name|sc
parameter_list|,
name|int
name|di
parameter_list|)
block|{
name|uint32_t
name|flag
decl_stmt|,
name|reg
decl_stmt|;
name|flag
operator|=
name|di
condition|?
name|DISP_GEN_DI1_CNTR_RELEASE
else|:
name|DISP_GEN_DI0_CNTR_RELEASE
expr_stmt|;
name|reg
operator|=
name|IPU_READ4
argument_list|(
name|sc
argument_list|,
name|IPU_DISP_GEN
argument_list|)
expr_stmt|;
name|reg
operator||=
name|flag
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|IPU_DISP_GEN
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipu_config_wave_gen_0
parameter_list|(
name|struct
name|ipu_softc
modifier|*
name|sc
parameter_list|,
name|int
name|di
parameter_list|,
name|int
name|wave_gen
parameter_list|,
name|int
name|run_value
parameter_list|,
name|int
name|run_res
parameter_list|,
name|int
name|offset_value
parameter_list|,
name|int
name|offset_res
parameter_list|)
block|{
name|uint32_t
name|addr
decl_stmt|,
name|reg
decl_stmt|;
name|addr
operator|=
operator|(
name|di
condition|?
name|IPU_DI1_SW_GEN0_1
else|:
name|IPU_DI0_SW_GEN0_1
operator|)
operator|+
operator|(
name|wave_gen
operator|-
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|reg
operator|=
name|DI_RUN_VALUE_M1
argument_list|(
name|run_value
argument_list|)
operator||
name|DI_RUN_RESOLUTION
argument_list|(
name|run_res
argument_list|)
operator||
name|DI_OFFSET_VALUE
argument_list|(
name|offset_value
argument_list|)
operator||
name|offset_res
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipu_config_wave_gen_1
parameter_list|(
name|struct
name|ipu_softc
modifier|*
name|sc
parameter_list|,
name|int
name|di
parameter_list|,
name|int
name|wave_gen
parameter_list|,
name|int
name|repeat_count
parameter_list|,
name|int
name|cnt_clr_src
parameter_list|,
name|int
name|cnt_polarity_gen_en
parameter_list|,
name|int
name|cnt_polarity_clr_src
parameter_list|,
name|int
name|cnt_polarity_trigger_src
parameter_list|,
name|int
name|cnt_up
parameter_list|,
name|int
name|cnt_down
parameter_list|)
block|{
name|uint32_t
name|addr
decl_stmt|,
name|reg
decl_stmt|;
name|addr
operator|=
operator|(
name|di
condition|?
name|IPU_DI1_SW_GEN1_1
else|:
name|IPU_DI0_SW_GEN1_1
operator|)
operator|+
operator|(
name|wave_gen
operator|-
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|reg
operator|=
name|DI_CNT_POLARITY_GEN_EN
argument_list|(
name|cnt_polarity_gen_en
argument_list|)
operator||
name|DI_CNT_CLR_SEL
argument_list|(
name|cnt_clr_src
argument_list|)
operator||
name|DI_CNT_POLARITY_TRIGGER_SEL
argument_list|(
name|cnt_polarity_trigger_src
argument_list|)
operator||
name|DI_CNT_POLARITY_CLR_SEL
argument_list|(
name|cnt_polarity_clr_src
argument_list|)
expr_stmt|;
name|reg
operator||=
name|DI_CNT_DOWN
argument_list|(
name|cnt_down
argument_list|)
operator||
name|cnt_up
expr_stmt|;
if|if
condition|(
name|repeat_count
operator|==
literal|0
condition|)
name|reg
operator||=
name|DI_CNT_AUTO_RELOAD
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|addr
operator|=
operator|(
name|di
condition|?
name|IPU_DI1_STP_REP
else|:
name|IPU_DI0_STP_REP
operator|)
operator|+
operator|(
name|wave_gen
operator|-
literal|1
operator|)
operator|/
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|reg
operator|=
name|IPU_READ4
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|wave_gen
operator|%
literal|2
condition|)
block|{
name|reg
operator|&=
operator|~
operator|(
literal|0xffff
operator|)
expr_stmt|;
name|reg
operator||=
name|repeat_count
expr_stmt|;
block|}
else|else
block|{
name|reg
operator|&=
operator|~
operator|(
literal|0xffff
operator|<<
literal|16
operator|)
expr_stmt|;
name|reg
operator||=
operator|(
name|repeat_count
operator|<<
literal|16
operator|)
expr_stmt|;
block|}
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipu_reset_wave_gen
parameter_list|(
name|struct
name|ipu_softc
modifier|*
name|sc
parameter_list|,
name|int
name|di
parameter_list|,
name|int
name|wave_gen
parameter_list|)
block|{
name|uint32_t
name|addr
decl_stmt|,
name|reg
decl_stmt|;
name|addr
operator|=
operator|(
name|di
condition|?
name|IPU_DI1_SW_GEN0_1
else|:
name|IPU_DI0_SW_GEN0_1
operator|)
operator|+
operator|(
name|wave_gen
operator|-
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|addr
operator|=
operator|(
name|di
condition|?
name|IPU_DI1_SW_GEN1_1
else|:
name|IPU_DI0_SW_GEN1_1
operator|)
operator|+
operator|(
name|wave_gen
operator|-
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|addr
operator|=
operator|(
name|di
condition|?
name|IPU_DI1_STP_REP
else|:
name|IPU_DI0_STP_REP
operator|)
operator|+
operator|(
name|wave_gen
operator|-
literal|1
operator|)
operator|/
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|reg
operator|=
name|IPU_READ4
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|wave_gen
operator|%
literal|2
condition|)
name|reg
operator|&=
operator|~
operator|(
literal|0xffff
operator|)
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
operator|(
literal|0xffff
operator|<<
literal|16
operator|)
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipu_init_microcode_template
parameter_list|(
name|struct
name|ipu_softc
modifier|*
name|sc
parameter_list|,
name|int
name|di
parameter_list|,
name|int
name|map
parameter_list|)
block|{
name|uint32_t
name|addr
decl_stmt|;
name|uint32_t
name|w1
decl_stmt|,
name|w2
decl_stmt|;
name|int
name|i
decl_stmt|,
name|word
decl_stmt|;
name|int
name|glue
decl_stmt|;
name|word
operator|=
name|di
condition|?
literal|2
else|:
literal|5
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|==
literal|0
condition|)
name|glue
operator|=
name|GLUELOGIC_KEEP_ASSERTED
expr_stmt|;
elseif|else
if|if
condition|(
name|i
operator|==
literal|1
condition|)
name|glue
operator|=
name|GLUELOGIC_KEEP_NEGATED
expr_stmt|;
elseif|else
if|if
condition|(
name|i
operator|==
literal|2
condition|)
name|glue
operator|=
literal|0
expr_stmt|;
name|w1
operator|=
name|TEMPLATE_SYNC
argument_list|(
literal|5
argument_list|)
operator||
name|TEMPLATE_GLUELOGIC
argument_list|(
name|glue
argument_list|)
operator||
name|TEMPLATE_WAVEFORM
argument_list|(
literal|1
argument_list|)
operator||
comment|/* wave unit 0 */
name|TEMPLATE_MAPPING
argument_list|(
name|map
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* operand is zero */
comment|/* Write data to DI and Hold data in register */
name|w2
operator|=
name|TEMPLATE_OPCODE
argument_list|(
name|OPCODE_WROD
argument_list|)
operator||
name|TEMPLATE_STOP
expr_stmt|;
name|addr
operator|=
name|DC_TEMPL_BASE
operator|+
operator|(
name|word
operator|+
name|i
operator|)
operator|*
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
name|w1
argument_list|)
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|addr
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|,
name|w2
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ipu_config_timing
parameter_list|(
name|struct
name|ipu_softc
modifier|*
name|sc
parameter_list|,
name|int
name|di
parameter_list|)
block|{
name|int
name|div
decl_stmt|;
name|uint32_t
name|di_scr_conf
decl_stmt|;
name|uint32_t
name|gen_offset
decl_stmt|,
name|gen
decl_stmt|;
name|uint32_t
name|as_gen_offset
decl_stmt|,
name|as_gen
decl_stmt|;
name|uint32_t
name|dw_gen_offset
decl_stmt|,
name|dw_gen
decl_stmt|;
name|uint32_t
name|dw_set_offset
decl_stmt|,
name|dw_set
decl_stmt|;
name|uint32_t
name|bs_clkgen_offset
decl_stmt|;
name|int
name|map
decl_stmt|;
comment|/* TODO: check mode restrictions / fixup */
comment|/* TODO: enable timers, get divisors */
name|div
operator|=
literal|1
expr_stmt|;
name|map
operator|=
literal|0
expr_stmt|;
name|bs_clkgen_offset
operator|=
name|di
condition|?
name|IPU_DI1_BS_CLKGEN0
else|:
name|IPU_DI0_BS_CLKGEN0
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|bs_clkgen_offset
argument_list|,
name|DI_BS_CLKGEN0
argument_list|(
name|div
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/* half of the divider */
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|bs_clkgen_offset
operator|+
literal|4
argument_list|,
name|DI_BS_CLKGEN1_DOWN
argument_list|(
name|div
operator|/
literal|2
argument_list|,
name|div
operator|%
literal|2
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * TODO: Configure LLDB clock by changing following fields 	 * in CCM fields: 	 * 	CS2CDR_LDB_DI0_CLK_SEL 	 * 	CSCMR2_LDB_DI0_IPU_DIV 	 * 	CBCDR_MMDC_CH1_AXI_PODF 	 */
comment|/* Setup wave generator */
name|dw_gen_offset
operator|=
name|di
condition|?
name|IPU_DI1_DW_GEN_0
else|:
name|IPU_DI0_DW_GEN_0
expr_stmt|;
name|dw_gen
operator|=
name|DW_GEN_DI_ACCESS_SIZE
argument_list|(
name|div
operator|-
literal|1
argument_list|)
operator||
name|DW_GEN_DI_COMPONENT_SIZE
argument_list|(
name|div
operator|-
literal|1
argument_list|)
expr_stmt|;
name|dw_gen
operator|&=
operator|~
name|DW_GEN_DI_PIN_15_SET
argument_list|(
name|DW_GEN_DI_SET_MASK
argument_list|)
expr_stmt|;
name|dw_gen
operator||=
name|DW_GEN_DI_PIN_15_SET
argument_list|(
literal|3
argument_list|)
expr_stmt|;
comment|/* set 3*/
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|dw_gen_offset
argument_list|,
name|dw_gen
argument_list|)
expr_stmt|;
name|dw_set_offset
operator|=
name|di
condition|?
name|IPU_DI1_DW_SET3_0
else|:
name|IPU_DI0_DW_SET3_0
expr_stmt|;
name|dw_set
operator|=
name|DW_SET_DATA_CNT_DOWN
argument_list|(
name|div
operator|*
literal|2
argument_list|)
operator||
name|DW_SET_DATA_CNT_UP
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|dw_set_offset
argument_list|,
name|dw_set
argument_list|)
expr_stmt|;
comment|/* DI_COUNTER_INT_HSYNC */
name|ipu_config_wave_gen_0
argument_list|(
name|sc
argument_list|,
name|di
argument_list|,
name|DI_COUNTER_INT_HSYNC
argument_list|,
name|sc
operator|->
name|sc_mode
operator|->
name|htotal
operator|-
literal|1
argument_list|,
name|DI_SYNC_CLK
argument_list|,
literal|0
argument_list|,
name|DI_SYNC_NONE
argument_list|)
expr_stmt|;
name|ipu_config_wave_gen_1
argument_list|(
name|sc
argument_list|,
name|di
argument_list|,
name|DI_COUNTER_INT_HSYNC
argument_list|,
literal|0
argument_list|,
name|DI_SYNC_NONE
argument_list|,
literal|0
argument_list|,
name|DI_SYNC_NONE
argument_list|,
name|DI_SYNC_NONE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* DI_COUNTER_HSYNC */
name|ipu_config_wave_gen_0
argument_list|(
name|sc
argument_list|,
name|di
argument_list|,
name|DI_COUNTER_HSYNC
argument_list|,
name|sc
operator|->
name|sc_mode
operator|->
name|htotal
operator|-
literal|1
argument_list|,
name|DI_SYNC_CLK
argument_list|,
literal|0
argument_list|,
name|DI_SYNC_CLK
argument_list|)
expr_stmt|;
name|ipu_config_wave_gen_1
argument_list|(
name|sc
argument_list|,
name|di
argument_list|,
name|DI_COUNTER_HSYNC
argument_list|,
literal|0
argument_list|,
name|DI_SYNC_NONE
argument_list|,
literal|1
argument_list|,
name|DI_SYNC_NONE
argument_list|,
name|DI_SYNC_CLK
argument_list|,
literal|0
argument_list|,
name|MODE_HSW
argument_list|(
name|sc
operator|->
name|sc_mode
argument_list|)
operator|*
literal|2
argument_list|)
expr_stmt|;
comment|/* DI_COUNTER_VSYNC */
name|ipu_config_wave_gen_0
argument_list|(
name|sc
argument_list|,
name|di
argument_list|,
name|DI_COUNTER_VSYNC
argument_list|,
name|sc
operator|->
name|sc_mode
operator|->
name|vtotal
operator|-
literal|1
argument_list|,
name|DI_SYNC_COUNTER
argument_list|(
name|DI_COUNTER_INT_HSYNC
argument_list|)
argument_list|,
literal|0
argument_list|,
name|DI_SYNC_NONE
argument_list|)
expr_stmt|;
name|ipu_config_wave_gen_1
argument_list|(
name|sc
argument_list|,
name|di
argument_list|,
name|DI_COUNTER_VSYNC
argument_list|,
literal|0
argument_list|,
name|DI_SYNC_NONE
argument_list|,
literal|1
argument_list|,
name|DI_SYNC_NONE
argument_list|,
name|DI_SYNC_COUNTER
argument_list|(
name|DI_COUNTER_INT_HSYNC
argument_list|)
argument_list|,
literal|0
argument_list|,
name|MODE_VSW
argument_list|(
name|sc
operator|->
name|sc_mode
argument_list|)
operator|*
literal|2
argument_list|)
expr_stmt|;
name|di_scr_conf
operator|=
name|di
condition|?
name|IPU_DI1_SCR_CONF
else|:
name|IPU_DI0_SCR_CONF
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|di_scr_conf
argument_list|,
name|sc
operator|->
name|sc_mode
operator|->
name|vtotal
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* TODO: update DI_SCR_CONF */
comment|/* Active Data 0 */
name|ipu_config_wave_gen_0
argument_list|(
name|sc
argument_list|,
name|di
argument_list|,
name|DI_COUNTER_AD_0
argument_list|,
literal|0
argument_list|,
name|DI_SYNC_COUNTER
argument_list|(
name|DI_COUNTER_HSYNC
argument_list|)
argument_list|,
name|MODE_VSW
argument_list|(
name|sc
operator|->
name|sc_mode
argument_list|)
operator|+
name|MODE_VFP
argument_list|(
name|sc
operator|->
name|sc_mode
argument_list|)
argument_list|,
name|DI_SYNC_COUNTER
argument_list|(
name|DI_COUNTER_HSYNC
argument_list|)
argument_list|)
expr_stmt|;
name|ipu_config_wave_gen_1
argument_list|(
name|sc
argument_list|,
name|di
argument_list|,
name|DI_COUNTER_AD_0
argument_list|,
name|sc
operator|->
name|sc_mode
operator|->
name|vdisplay
argument_list|,
name|DI_SYNC_COUNTER
argument_list|(
name|DI_COUNTER_VSYNC
argument_list|)
argument_list|,
literal|0
argument_list|,
name|DI_SYNC_NONE
argument_list|,
name|DI_SYNC_NONE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ipu_config_wave_gen_0
argument_list|(
name|sc
argument_list|,
name|di
argument_list|,
name|DI_COUNTER_AD_1
argument_list|,
literal|0
argument_list|,
name|DI_SYNC_CLK
argument_list|,
name|MODE_HSW
argument_list|(
name|sc
operator|->
name|sc_mode
argument_list|)
operator|+
name|MODE_HFP
argument_list|(
name|sc
operator|->
name|sc_mode
argument_list|)
argument_list|,
name|DI_SYNC_CLK
argument_list|)
expr_stmt|;
name|ipu_config_wave_gen_1
argument_list|(
name|sc
argument_list|,
name|di
argument_list|,
name|DI_COUNTER_AD_1
argument_list|,
name|sc
operator|->
name|sc_mode
operator|->
name|hdisplay
argument_list|,
name|DI_SYNC_COUNTER
argument_list|(
name|DI_COUNTER_AD_0
argument_list|)
argument_list|,
literal|0
argument_list|,
name|DI_SYNC_NONE
argument_list|,
name|DI_SYNC_NONE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ipu_reset_wave_gen
argument_list|(
name|sc
argument_list|,
name|di
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|ipu_reset_wave_gen
argument_list|(
name|sc
argument_list|,
name|di
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|ipu_reset_wave_gen
argument_list|(
name|sc
argument_list|,
name|di
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|ipu_reset_wave_gen
argument_list|(
name|sc
argument_list|,
name|di
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|ipu_init_microcode_template
argument_list|(
name|sc
argument_list|,
name|di
argument_list|,
name|map
argument_list|)
expr_stmt|;
name|gen_offset
operator|=
name|di
condition|?
name|IPU_DI1_GENERAL
else|:
name|IPU_DI0_GENERAL
expr_stmt|;
name|gen
operator|=
name|IPU_READ4
argument_list|(
name|sc
argument_list|,
name|gen_offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_mode
operator|->
name|flags
operator|&
name|VID_NHSYNC
condition|)
name|gen
operator|&=
operator|~
name|DI_GENERAL_POLARITY_2
expr_stmt|;
else|else
comment|/* active high */
name|gen
operator||=
name|DI_GENERAL_POLARITY_2
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_mode
operator|->
name|flags
operator|&
name|VID_NVSYNC
condition|)
name|gen
operator|&=
operator|~
name|DI_GENERAL_POLARITY_3
expr_stmt|;
else|else
comment|/* active high */
name|gen
operator||=
name|DI_GENERAL_POLARITY_3
expr_stmt|;
if|if
condition|(
name|MODE_PIXEL_CLOCK_INVERT
condition|)
name|gen
operator|&=
operator|~
name|DI_GENERAL_POL_CLK
expr_stmt|;
else|else
name|gen
operator||=
name|DI_GENERAL_POL_CLK
expr_stmt|;
comment|/* Use LDB clock to drive pixel clock */
name|gen
operator||=
name|DI_CLOCK_EXTERNAL
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|gen_offset
argument_list|,
name|gen
argument_list|)
expr_stmt|;
name|as_gen_offset
operator|=
name|di
condition|?
name|IPU_DI1_SYNC_AS_GEN
else|:
name|IPU_DI0_SYNC_AS_GEN
expr_stmt|;
name|as_gen
operator|=
name|SYNC_AS_GEN_VSYNC_SEL
argument_list|(
name|DI_COUNTER_VSYNC
operator|-
literal|1
argument_list|)
operator||
name|SYNC_AS_GEN_SYNC_START
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|as_gen_offset
argument_list|,
name|as_gen
argument_list|)
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
operator|(
name|di
condition|?
name|IPU_DI1_POL
else|:
name|IPU_DI0_POL
operator|)
argument_list|,
name|DI_POL_DRDY_POLARITY_15
argument_list|)
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|DC_DISP_CONF2
argument_list|(
name|di
argument_list|)
argument_list|,
name|sc
operator|->
name|sc_mode
operator|->
name|hdisplay
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipu_dc_enable
parameter_list|(
name|struct
name|ipu_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|conf
decl_stmt|;
comment|/* channel 1 uses DI1 */
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|DC_WRITE_CH_CONF_1
argument_list|,
name|WRITE_CH_CONF_PROG_DI_ID
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|conf
operator|=
name|IPU_READ4
argument_list|(
name|sc
argument_list|,
name|DC_WRITE_CH_CONF_5
argument_list|)
expr_stmt|;
name|conf
operator|&=
operator|~
name|WRITE_CH_CONF_PROG_CHAN_TYP_MASK
expr_stmt|;
name|conf
operator||=
name|WRITE_CH_CONF_PROG_CHAN_NORMAL
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|DC_WRITE_CH_CONF_5
argument_list|,
name|conf
argument_list|)
expr_stmt|;
comment|/* TODO: enable clock */
block|}
end_function

begin_function
specifier|static
name|void
name|ipu_dc_link_event
parameter_list|(
name|struct
name|ipu_softc
modifier|*
name|sc
parameter_list|,
name|int
name|event
parameter_list|,
name|int
name|addr
parameter_list|,
name|int
name|priority
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|int
name|offset
decl_stmt|;
name|int
name|shift
decl_stmt|;
if|if
condition|(
name|event
operator|%
literal|2
condition|)
name|shift
operator|=
literal|16
expr_stmt|;
else|else
name|shift
operator|=
literal|0
expr_stmt|;
name|offset
operator|=
name|DC_RL0_CH_5
operator|+
operator|(
name|event
operator|/
literal|2
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|reg
operator|=
name|IPU_READ4
argument_list|(
name|sc
argument_list|,
name|offset
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
operator|(
literal|0xFFFF
operator|<<
name|shift
operator|)
expr_stmt|;
name|reg
operator||=
operator|(
operator|(
name|addr
operator|<<
literal|8
operator|)
operator||
name|priority
operator|)
operator|<<
name|shift
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|offset
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipu_dc_setup_map
parameter_list|(
name|struct
name|ipu_softc
modifier|*
name|sc
parameter_list|,
name|int
name|map
parameter_list|,
name|int
name|byte
parameter_list|,
name|int
name|offset
parameter_list|,
name|int
name|mask
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|,
name|shift
decl_stmt|,
name|ptr
decl_stmt|;
name|ptr
operator|=
name|map
operator|*
literal|3
operator|+
name|byte
expr_stmt|;
name|reg
operator|=
name|IPU_READ4
argument_list|(
name|sc
argument_list|,
name|DC_MAP_CONF_VAL
argument_list|(
name|ptr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|&
literal|1
condition|)
name|shift
operator|=
literal|16
expr_stmt|;
else|else
name|shift
operator|=
literal|0
expr_stmt|;
name|reg
operator|&=
operator|~
operator|(
literal|0xffff
operator|<<
name|shift
operator|)
expr_stmt|;
name|reg
operator||=
operator|(
operator|(
name|offset
operator|<<
literal|8
operator|)
operator||
name|mask
operator|)
operator|<<
name|shift
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|DC_MAP_CONF_VAL
argument_list|(
name|ptr
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|IPU_READ4
argument_list|(
name|sc
argument_list|,
name|DC_MAP_CONF_PTR
argument_list|(
name|map
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|map
operator|&
literal|1
condition|)
name|shift
operator|=
literal|16
operator|+
literal|5
operator|*
name|byte
expr_stmt|;
else|else
name|shift
operator|=
literal|5
operator|*
name|byte
expr_stmt|;
name|reg
operator|&=
operator|~
operator|(
name|MAP_CONF_PTR_MASK
operator|<<
name|shift
operator|)
expr_stmt|;
name|reg
operator||=
operator|(
name|ptr
operator|)
operator|<<
name|shift
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|DC_MAP_CONF_PTR
argument_list|(
name|map
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipu_dc_reset_map
parameter_list|(
name|struct
name|ipu_softc
modifier|*
name|sc
parameter_list|,
name|int
name|map
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|,
name|shift
decl_stmt|;
name|reg
operator|=
name|IPU_READ4
argument_list|(
name|sc
argument_list|,
name|DC_MAP_CONF_VAL
argument_list|(
name|map
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|map
operator|&
literal|1
condition|)
name|shift
operator|=
literal|16
expr_stmt|;
else|else
name|shift
operator|=
literal|0
expr_stmt|;
name|reg
operator|&=
operator|~
operator|(
name|MAP_CONF_VAL_MASK
operator|<<
name|shift
operator|)
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|DC_MAP_CONF_VAL
argument_list|(
name|map
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipu_dc_init
parameter_list|(
name|struct
name|ipu_softc
modifier|*
name|sc
parameter_list|,
name|int
name|di_port
parameter_list|)
block|{
name|int
name|addr
decl_stmt|;
name|uint32_t
name|conf
decl_stmt|;
if|if
condition|(
name|di_port
condition|)
name|addr
operator|=
literal|2
expr_stmt|;
else|else
name|addr
operator|=
literal|5
expr_stmt|;
name|ipu_dc_link_event
argument_list|(
name|sc
argument_list|,
name|DC_EVENT_NL
argument_list|,
name|addr
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|ipu_dc_link_event
argument_list|(
name|sc
argument_list|,
name|DC_EVENT_EOL
argument_list|,
name|addr
operator|+
literal|1
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ipu_dc_link_event
argument_list|(
name|sc
argument_list|,
name|DC_EVENT_NEW_DATA
argument_list|,
name|addr
operator|+
literal|2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ipu_dc_link_event
argument_list|(
name|sc
argument_list|,
name|DC_EVENT_NF
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ipu_dc_link_event
argument_list|(
name|sc
argument_list|,
name|DC_EVENT_NFIELD
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ipu_dc_link_event
argument_list|(
name|sc
argument_list|,
name|DC_EVENT_EOF
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ipu_dc_link_event
argument_list|(
name|sc
argument_list|,
name|DC_EVENT_EOFIELD
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ipu_dc_link_event
argument_list|(
name|sc
argument_list|,
name|DC_EVENT_NEW_CHAN
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ipu_dc_link_event
argument_list|(
name|sc
argument_list|,
name|DC_EVENT_NEW_ADDR
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|conf
operator|=
name|WRITE_CH_CONF_PROG_W_SIZE
argument_list|(
literal|0x02
argument_list|)
operator||
name|WRITE_CH_CONF_PROG_DISP_ID
argument_list|(
name|DI_PORT
argument_list|)
operator||
name|WRITE_CH_CONF_PROG_DI_ID
argument_list|(
name|DI_PORT
argument_list|)
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|DC_WRITE_CH_CONF_5
argument_list|,
name|conf
argument_list|)
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|DC_WRITE_CH_ADDR_5
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|DC_GEN
argument_list|,
name|DC_GEN_SYNC_PRIORITY
operator||
name|DC_GEN_SYNC
argument_list|)
expr_stmt|;
comment|/* High priority, sync */
block|}
end_function

begin_function
specifier|static
name|void
name|ipu_init_buffer
parameter_list|(
name|struct
name|ipu_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ipu_cpmem_ch_param
name|param
decl_stmt|;
name|uint32_t
name|stride
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|,
name|db_mode_sel
decl_stmt|,
name|cur_buf
decl_stmt|;
name|stride
operator|=
name|sc
operator|->
name|sc_mode
operator|->
name|hdisplay
operator|*
name|MODE_BPP
operator|/
literal|8
expr_stmt|;
comment|/* init channel parameters */
name|CH_PARAM_RESET
argument_list|(
operator|&
name|param
argument_list|)
expr_stmt|;
comment|/* XXX: interlaced modes are not supported yet */
name|CH_PARAM_SET_FW
argument_list|(
operator|&
name|param
argument_list|,
name|sc
operator|->
name|sc_mode
operator|->
name|hdisplay
operator|-
literal|1
argument_list|)
expr_stmt|;
name|CH_PARAM_SET_FH
argument_list|(
operator|&
name|param
argument_list|,
name|sc
operator|->
name|sc_mode
operator|->
name|vdisplay
operator|-
literal|1
argument_list|)
expr_stmt|;
name|CH_PARAM_SET_SLY
argument_list|(
operator|&
name|param
argument_list|,
name|stride
operator|-
literal|1
argument_list|)
expr_stmt|;
name|CH_PARAM_SET_EBA0
argument_list|(
operator|&
name|param
argument_list|,
operator|(
name|sc
operator|->
name|sc_fb_phys
operator|>>
literal|3
operator|)
argument_list|)
expr_stmt|;
name|CH_PARAM_SET_EBA1
argument_list|(
operator|&
name|param
argument_list|,
operator|(
name|sc
operator|->
name|sc_fb_phys
operator|>>
literal|3
operator|)
argument_list|)
expr_stmt|;
name|CH_PARAM_SET_BPP
argument_list|(
operator|&
name|param
argument_list|,
name|IPU_PIX_FORMAT_BPP_16
argument_list|)
expr_stmt|;
name|CH_PARAM_SET_PFS
argument_list|(
operator|&
name|param
argument_list|,
name|IPU_PIX_FORMAT_RGB
argument_list|)
expr_stmt|;
comment|/* 16 pixels per burst access */
name|CH_PARAM_SET_NPB
argument_list|(
operator|&
name|param
argument_list|,
literal|16
operator|-
literal|1
argument_list|)
expr_stmt|;
name|CH_PARAM_SET_RED_OFFSET
argument_list|(
operator|&
name|param
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CH_PARAM_SET_RED_WIDTH
argument_list|(
operator|&
name|param
argument_list|,
literal|5
operator|-
literal|1
argument_list|)
expr_stmt|;
name|CH_PARAM_SET_GREEN_OFFSET
argument_list|(
operator|&
name|param
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|CH_PARAM_SET_GREEN_WIDTH
argument_list|(
operator|&
name|param
argument_list|,
literal|6
operator|-
literal|1
argument_list|)
expr_stmt|;
name|CH_PARAM_SET_BLUE_OFFSET
argument_list|(
operator|&
name|param
argument_list|,
literal|11
argument_list|)
expr_stmt|;
name|CH_PARAM_SET_BLUE_WIDTH
argument_list|(
operator|&
name|param
argument_list|,
literal|5
operator|-
literal|1
argument_list|)
expr_stmt|;
name|CH_PARAM_SET_ALPHA_OFFSET
argument_list|(
operator|&
name|param
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|CH_PARAM_SET_ALPHA_WIDTH
argument_list|(
operator|&
name|param
argument_list|,
literal|8
operator|-
literal|1
argument_list|)
expr_stmt|;
name|CH_PARAM_SET_UBO
argument_list|(
operator|&
name|param
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CH_PARAM_SET_VBO
argument_list|(
operator|&
name|param
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|IPU_WRITE_CH_PARAM
argument_list|(
name|sc
argument_list|,
name|DMA_CHANNEL
argument_list|,
operator|&
name|param
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|ipu_print_channel
argument_list|(
operator|&
name|param
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* init DMFC */
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|DMFC_IC_CTRL
argument_list|,
name|DMFC_IC_CTRL_DISABLED
argument_list|)
expr_stmt|;
comment|/* High resolution DP */
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|DMFC_WR_CHAN
argument_list|,
name|DMFC_WR_CHAN_BURST_SIZE_8
operator||
name|DMFC_WR_CHAN_FIFO_SIZE_128
argument_list|)
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|DMFC_WR_CHAN_DEF
argument_list|,
name|DMFC_WR_CHAN_DEF_WM_CLR_2C
argument_list|(
literal|1
argument_list|)
operator||
name|DMFC_WR_CHAN_DEF_WM_CLR_1C
argument_list|(
literal|1
argument_list|)
operator||
name|DMFC_WR_CHAN_DEF_WM_CLR_2
argument_list|(
literal|1
argument_list|)
operator||
name|DMFC_WR_CHAN_DEF_WM_CLR_1
argument_list|(
literal|7
argument_list|)
operator||
name|DMFC_WR_CHAN_DEF_WM_SET_1
argument_list|(
literal|5
argument_list|)
operator||
name|DMFC_WR_CHAN_DEF_WM_EN_1
argument_list|)
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|DMFC_DP_CHAN
argument_list|,
name|DMFC_DP_CHAN_BURST_SIZE_5F
argument_list|(
name|DMFC_DP_CHAN_BURST_SIZE_8
argument_list|)
operator||
name|DMFC_DP_CHAN_FIFO_SIZE_5F
argument_list|(
name|DMFC_DP_CHAN_FIFO_SIZE_128
argument_list|)
operator||
name|DMFC_DP_CHAN_ST_ADDR_SIZE_5F
argument_list|(
literal|6
argument_list|)
comment|/* segment 6 */
operator||
name|DMFC_DP_CHAN_BURST_SIZE_5B
argument_list|(
name|DMFC_DP_CHAN_BURST_SIZE_8
argument_list|)
operator||
name|DMFC_DP_CHAN_FIFO_SIZE_5B
argument_list|(
name|DMFC_DP_CHAN_FIFO_SIZE_256
argument_list|)
operator||
name|DMFC_DP_CHAN_ST_ADDR_SIZE_5B
argument_list|(
literal|2
argument_list|)
comment|/* segment 2 */
argument_list|)
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|DMFC_DP_CHAN_DEF
argument_list|,
name|DMFC_DP_CHAN_DEF_WM_CLR_6F
argument_list|(
literal|1
argument_list|)
operator||
name|DMFC_DP_CHAN_DEF_WM_CLR_6B
argument_list|(
literal|1
argument_list|)
operator||
name|DMFC_DP_CHAN_DEF_WM_CLR_5F
argument_list|(
literal|7
argument_list|)
operator||
name|DMFC_DP_CHAN_DEF_WM_SET_5F
argument_list|(
literal|5
argument_list|)
operator||
name|DMFC_DP_CHAN_DEF_WM_EN_5F
operator||
name|DMFC_DP_CHAN_DEF_WM_CLR_5B
argument_list|(
literal|7
argument_list|)
operator||
name|DMFC_DP_CHAN_DEF_WM_SET_5B
argument_list|(
literal|5
argument_list|)
operator||
name|DMFC_DP_CHAN_DEF_WM_EN_5B
argument_list|)
expr_stmt|;
name|reg
operator|=
name|IPU_READ4
argument_list|(
name|sc
argument_list|,
name|DMFC_GENERAL_1
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
operator|(
name|DMFC_GENERAL_1_WAIT4EOT_5B
operator|)
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|DMFC_GENERAL_1
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* XXX: set priority? */
comment|/* Set single buffer mode */
if|if
condition|(
name|DMA_CHANNEL
operator|<
literal|32
condition|)
block|{
name|db_mode_sel
operator|=
name|IPU_CH_DB_MODE_SEL_0
expr_stmt|;
name|cur_buf
operator|=
name|IPU_CUR_BUF_0
expr_stmt|;
block|}
else|else
block|{
name|db_mode_sel
operator|=
name|IPU_CH_DB_MODE_SEL_1
expr_stmt|;
name|cur_buf
operator|=
name|IPU_CUR_BUF_1
expr_stmt|;
block|}
name|reg
operator|=
name|IPU_READ4
argument_list|(
name|sc
argument_list|,
name|db_mode_sel
argument_list|)
expr_stmt|;
name|reg
operator||=
operator|(
literal|1UL
operator|<<
operator|(
name|DMA_CHANNEL
operator|&
literal|0x1f
operator|)
operator|)
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|db_mode_sel
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|cur_buf
argument_list|,
operator|(
literal|1UL
operator|<<
operator|(
name|DMA_CHANNEL
operator|&
literal|0x1f
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ipu_init
parameter_list|(
name|struct
name|ipu_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|,
name|off
decl_stmt|;
name|int
name|i
decl_stmt|,
name|err
decl_stmt|;
name|size_t
name|dma_size
decl_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|IPU_CONF
argument_list|,
name|DI_PORT
condition|?
name|IPU_CONF_DI1_EN
else|:
name|IPU_CONF_DI0_EN
argument_list|)
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|IPU_MEM_RST
argument_list|,
name|IPU_MEM_RST_ALL
argument_list|)
expr_stmt|;
name|i
operator|=
literal|1000
expr_stmt|;
while|while
condition|(
name|i
operator|--
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|IPU_READ4
argument_list|(
name|sc
argument_list|,
name|IPU_MEM_RST
argument_list|)
operator|&
name|IPU_MEM_RST_START
operator|)
condition|)
break|break;
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|<=
literal|0
condition|)
block|{
name|err
operator|=
name|ETIMEDOUT
expr_stmt|;
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"timeout while resetting memory\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|ipu_dc_reset_map
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ipu_dc_setup_map
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|7
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|ipu_dc_setup_map
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|15
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|ipu_dc_setup_map
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
literal|23
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
name|dma_size
operator|=
name|round_page
argument_list|(
name|sc
operator|->
name|sc_mode
operator|->
name|hdisplay
operator|*
name|sc
operator|->
name|sc_mode
operator|->
name|vdisplay
operator|*
operator|(
name|MODE_BPP
operator|/
literal|8
operator|)
argument_list|)
expr_stmt|;
comment|/* 	 * Now allocate framebuffer memory 	 */
name|err
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|,
comment|/* alignment, boundary */
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|dma_size
argument_list|,
literal|1
argument_list|,
comment|/* maxsize, nsegments */
name|dma_size
argument_list|,
literal|0
argument_list|,
comment|/* maxsegsize, flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockarg */
operator|&
name|sc
operator|->
name|sc_dma_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|fail
goto|;
name|err
operator|=
name|bus_dmamem_alloc
argument_list|(
name|sc
operator|->
name|sc_dma_tag
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|sc
operator|->
name|sc_fb_base
argument_list|,
name|BUS_DMA_COHERENT
operator||
name|BUS_DMA_ZERO
argument_list|,
operator|&
name|sc
operator|->
name|sc_dma_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"cannot allocate framebuffer\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|err
operator|=
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|sc_dma_tag
argument_list|,
name|sc
operator|->
name|sc_dma_map
argument_list|,
name|sc
operator|->
name|sc_fb_base
argument_list|,
name|dma_size
argument_list|,
name|ipu_dmamap_cb
argument_list|,
operator|&
name|sc
operator|->
name|sc_fb_phys
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"cannot load DMA map\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* Calculate actual FB Size */
name|sc
operator|->
name|sc_fb_size
operator|=
name|sc
operator|->
name|sc_mode
operator|->
name|hdisplay
operator|*
name|sc
operator|->
name|sc_mode
operator|->
name|vdisplay
operator|*
name|MODE_BPP
operator|/
literal|8
expr_stmt|;
name|ipu_dc_init
argument_list|(
name|sc
argument_list|,
name|DI_PORT
argument_list|)
expr_stmt|;
name|reg
operator|=
name|IPU_READ4
argument_list|(
name|sc
argument_list|,
name|IPU_CONF
argument_list|)
expr_stmt|;
name|reg
operator||=
name|IPU_CONF_DMFC_EN
operator||
name|IPU_CONF_DC_EN
operator||
name|IPU_CONF_DP_EN
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|IPU_CONF
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|ipu_config_timing
argument_list|(
name|sc
argument_list|,
name|DI_PORT
argument_list|)
expr_stmt|;
name|ipu_init_buffer
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ipu_di_enable
argument_list|(
name|sc
argument_list|,
name|DI_PORT
argument_list|)
expr_stmt|;
comment|/* Enable DMA channel */
name|off
operator|=
operator|(
name|DMA_CHANNEL
operator|>
literal|31
operator|)
condition|?
name|IPU_IDMAC_CH_EN_2
else|:
name|IPU_IDMAC_CH_EN_1
expr_stmt|;
name|reg
operator|=
name|IPU_READ4
argument_list|(
name|sc
argument_list|,
name|off
argument_list|)
expr_stmt|;
name|reg
operator||=
operator|(
literal|1
operator|<<
operator|(
name|DMA_CHANNEL
operator|&
literal|0x1f
operator|)
operator|)
expr_stmt|;
name|IPU_WRITE4
argument_list|(
name|sc
argument_list|,
name|off
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|ipu_dc_enable
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_fb_info
operator|.
name|fb_name
operator|=
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_fb_info
operator|.
name|fb_vbase
operator|=
operator|(
name|intptr_t
operator|)
name|sc
operator|->
name|sc_fb_base
expr_stmt|;
name|sc
operator|->
name|sc_fb_info
operator|.
name|fb_pbase
operator|=
name|sc
operator|->
name|sc_fb_phys
expr_stmt|;
name|sc
operator|->
name|sc_fb_info
operator|.
name|fb_size
operator|=
name|sc
operator|->
name|sc_fb_size
expr_stmt|;
name|sc
operator|->
name|sc_fb_info
operator|.
name|fb_bpp
operator|=
name|sc
operator|->
name|sc_fb_info
operator|.
name|fb_depth
operator|=
name|MODE_BPP
expr_stmt|;
name|sc
operator|->
name|sc_fb_info
operator|.
name|fb_stride
operator|=
name|sc
operator|->
name|sc_mode
operator|->
name|hdisplay
operator|*
name|MODE_BPP
operator|/
literal|8
expr_stmt|;
name|sc
operator|->
name|sc_fb_info
operator|.
name|fb_width
operator|=
name|sc
operator|->
name|sc_mode
operator|->
name|hdisplay
expr_stmt|;
name|sc
operator|->
name|sc_fb_info
operator|.
name|fb_height
operator|=
name|sc
operator|->
name|sc_mode
operator|->
name|vdisplay
expr_stmt|;
name|device_t
name|fbd
init|=
name|device_add_child
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"fbd"
argument_list|,
name|device_get_unit
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|fbd
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"Failed to add fbd child\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|device_probe_and_attach
argument_list|(
name|fbd
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"Failed to attach fbd device\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ipu_hdmi_event
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|device_t
name|hdmi_dev
parameter_list|)
block|{
name|struct
name|ipu_softc
modifier|*
name|sc
decl_stmt|;
name|uint8_t
modifier|*
name|edid
decl_stmt|;
name|uint32_t
name|edid_len
decl_stmt|;
ifdef|#
directive|ifdef
name|EDID_DEBUG
name|struct
name|edid_info
name|ei
decl_stmt|;
endif|#
directive|endif
specifier|const
name|struct
name|videomode
modifier|*
name|videomode
decl_stmt|;
name|sc
operator|=
name|arg
expr_stmt|;
name|edid
operator|=
name|NULL
expr_stmt|;
name|edid_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|HDMI_GET_EDID
argument_list|(
name|hdmi_dev
argument_list|,
operator|&
name|edid
argument_list|,
operator|&
name|edid_len
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"failed to get EDID info from HDMI framer\n"
argument_list|)
expr_stmt|;
block|}
name|videomode
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|EDID_DEBUG
if|if
condition|(
name|edid
operator|&&
operator|(
name|edid_parse
argument_list|(
name|edid
argument_list|,
operator|&
name|ei
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|edid_print
argument_list|(
operator|&
name|ei
argument_list|)
expr_stmt|;
block|}
else|else
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"failed to parse EDID\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sc
operator|->
name|sc_mode
operator|=
operator|&
name|mode1024x768
expr_stmt|;
name|ipu_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|HDMI_SET_VIDEOMODE
argument_list|(
name|hdmi_dev
argument_list|,
name|sc
operator|->
name|sc_mode
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ipu_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
name|have_ipu
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
operator|!
name|ofw_bus_status_okay
argument_list|(
name|dev
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
operator|!
name|ofw_bus_is_compatible
argument_list|(
name|dev
argument_list|,
literal|"fsl,imx6q-ipu"
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Freescale IPU"
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ipu_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ipu_softc
modifier|*
name|sc
decl_stmt|;
if|if
condition|(
name|have_ipu
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_dev
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|sc_mem_rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_mem_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|sc
operator|->
name|sc_mem_rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|sc_mem_res
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot allocate memory window\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|sc
operator|->
name|sc_irq_rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|sc_irq_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|sc
operator|->
name|sc_irq_rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|sc_irq_res
condition|)
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|sc
operator|->
name|sc_mem_rid
argument_list|,
name|sc
operator|->
name|sc_mem_res
argument_list|)
expr_stmt|;
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot allocate interrupt\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
comment|/* Enable IPU1 */
name|imx_ccm_ipu_enable
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|src_reset_ipu
argument_list|()
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"failed to reset IPU\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|IPU_LOCK_INIT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_hdmi_evh
operator|=
name|EVENTHANDLER_REGISTER
argument_list|(
name|hdmi_event
argument_list|,
name|ipu_hdmi_event
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|have_ipu
operator|=
literal|1
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ipu_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
comment|/* Do not let unload driver */
return|return
operator|(
name|EBUSY
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|fb_info
modifier|*
name|ipu_fb_getinfo
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|ipu_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
operator|&
name|sc
operator|->
name|sc_fb_info
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|ipu_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|ipu_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|ipu_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|ipu_detach
argument_list|)
block|,
comment|/* Framebuffer service methods */
name|DEVMETHOD
argument_list|(
name|fb_getinfo
argument_list|,
name|ipu_fb_getinfo
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|ipu_driver
init|=
block|{
literal|"fb"
block|,
name|ipu_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|ipu_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|ipu_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|ipu
argument_list|,
name|simplebus
argument_list|,
name|ipu_driver
argument_list|,
name|ipu_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|ipu
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|ipu
argument_list|,
name|simplebus
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2014 Ruslan Bukin<br@bsdpad.com>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * Samsung Exynos 5 Interrupt Combiner  * Chapter 7, Exynos 5 Dual User's Manual Public Rev 1.00  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/timeet.h>
end_include

begin_include
include|#
directive|include
file|<sys/timetc.h>
end_include

begin_include
include|#
directive|include
file|<sys/watchdog.h>
end_include

begin_include
include|#
directive|include
file|<dev/fdt/fdt_common.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/openfirm.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus_subr.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/fdt.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpu.h>
end_include

begin_include
include|#
directive|include
file|<machine/intr.h>
end_include

begin_include
include|#
directive|include
file|<arm/samsung/exynos/exynos5_common.h>
end_include

begin_include
include|#
directive|include
file|<arm/samsung/exynos/exynos5_combiner.h>
end_include

begin_define
define|#
directive|define
name|NGRP
value|32
end_define

begin_define
define|#
directive|define
name|IESR
parameter_list|(
name|n
parameter_list|)
value|(0x10 * n + 0x0)
end_define

begin_comment
comment|/* Interrupt enable set */
end_comment

begin_define
define|#
directive|define
name|IECR
parameter_list|(
name|n
parameter_list|)
value|(0x10 * n + 0x4)
end_define

begin_comment
comment|/* Interrupt enable clear */
end_comment

begin_define
define|#
directive|define
name|ISTR
parameter_list|(
name|n
parameter_list|)
value|(0x10 * n + 0x8)
end_define

begin_comment
comment|/* Interrupt status */
end_comment

begin_define
define|#
directive|define
name|IMSR
parameter_list|(
name|n
parameter_list|)
value|(0x10 * n + 0xC)
end_define

begin_comment
comment|/* Interrupt masked status */
end_comment

begin_define
define|#
directive|define
name|CIPSR
value|0x100
end_define

begin_comment
comment|/* Combined interrupt pending */
end_comment

begin_struct
struct|struct
name|combiner_softc
block|{
name|struct
name|resource
modifier|*
name|res
index|[
literal|1
operator|+
name|NGRP
index|]
decl_stmt|;
name|bus_space_tag_t
name|bst
decl_stmt|;
name|bus_space_handle_t
name|bsh
decl_stmt|;
name|void
modifier|*
name|ih
index|[
name|NGRP
index|]
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
name|struct
name|combiner_softc
modifier|*
name|combiner_sc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|resource_spec
name|combiner_spec
index|[]
init|=
block|{
block|{
name|SYS_RES_MEMORY
block|,
literal|0
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|0
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|1
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|2
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|3
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|4
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|5
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|6
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|7
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|8
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|9
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|10
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|11
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|12
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|13
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|14
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|15
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|16
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|17
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|18
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|19
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|20
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|21
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|22
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|23
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|24
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|25
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|26
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|27
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|28
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|29
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|30
block|,
name|RF_ACTIVE
block|}
block|,
block|{
name|SYS_RES_IRQ
block|,
literal|31
block|,
name|RF_ACTIVE
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|combiner_entry
block|{
name|int
name|combiner_id
decl_stmt|;
name|int
name|bit
decl_stmt|;
name|char
modifier|*
name|source_name
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|combiner_entry
name|interrupt_table
index|[]
init|=
block|{
block|{
literal|63
block|,
literal|1
block|,
literal|"EINT[15]"
block|}
block|,
block|{
literal|63
block|,
literal|0
block|,
literal|"EINT[14]"
block|}
block|,
block|{
literal|62
block|,
literal|1
block|,
literal|"EINT[13]"
block|}
block|,
block|{
literal|62
block|,
literal|0
block|,
literal|"EINT[12]"
block|}
block|,
block|{
literal|61
block|,
literal|1
block|,
literal|"EINT[11]"
block|}
block|,
block|{
literal|61
block|,
literal|0
block|,
literal|"EINT[10]"
block|}
block|,
block|{
literal|60
block|,
literal|1
block|,
literal|"EINT[9]"
block|}
block|,
block|{
literal|60
block|,
literal|0
block|,
literal|"EINT[8]"
block|}
block|,
block|{
literal|59
block|,
literal|1
block|,
literal|"EINT[7]"
block|}
block|,
block|{
literal|59
block|,
literal|0
block|,
literal|"EINT[6]"
block|}
block|,
block|{
literal|58
block|,
literal|1
block|,
literal|"EINT[5]"
block|}
block|,
block|{
literal|58
block|,
literal|0
block|,
literal|"EINT[4]"
block|}
block|,
block|{
literal|57
block|,
literal|3
block|,
literal|"MCT_G3"
block|}
block|,
block|{
literal|57
block|,
literal|2
block|,
literal|"MCT_G2"
block|}
block|,
block|{
literal|57
block|,
literal|1
block|,
literal|"EINT[3]"
block|}
block|,
block|{
literal|57
block|,
literal|0
block|,
literal|"EINT[2]"
block|}
block|,
block|{
literal|56
block|,
literal|6
block|,
literal|"SYSMMU_G2D[1]"
block|}
block|,
block|{
literal|56
block|,
literal|5
block|,
literal|"SYSMMU_G2D[0]"
block|}
block|,
block|{
literal|56
block|,
literal|2
block|,
literal|"SYSMMU_FIMC_LITE1[1]"
block|}
block|,
block|{
literal|56
block|,
literal|1
block|,
literal|"SYSMMU_FIMC_LITE1[0]"
block|}
block|,
block|{
literal|56
block|,
literal|0
block|,
literal|"EINT[1]"
block|}
block|,
block|{
literal|55
block|,
literal|4
block|,
literal|"MCT_G1"
block|}
block|,
block|{
literal|55
block|,
literal|3
block|,
literal|"MCT_G0"
block|}
block|,
block|{
literal|55
block|,
literal|0
block|,
literal|"EINT[0]"
block|}
block|,
block|{
literal|54
block|,
literal|7
block|,
literal|"CPU_nCNTVIRQ[1]"
block|}
block|,
block|{
literal|54
block|,
literal|6
block|,
literal|"CPU_nCTIIRQ[1]"
block|}
block|,
block|{
literal|54
block|,
literal|5
block|,
literal|"CPU_nCNTPSIRQ[1]"
block|}
block|,
block|{
literal|54
block|,
literal|4
block|,
literal|"CPU_nPMUIRQ[1]"
block|}
block|,
block|{
literal|54
block|,
literal|3
block|,
literal|"CPU_nCNTPNSIRQ[1]"
block|}
block|,
block|{
literal|54
block|,
literal|2
block|,
literal|"CPU_PARITYFAILSCU[1]"
block|}
block|,
block|{
literal|54
block|,
literal|1
block|,
literal|"CPU_nCNTHPIRQ[1]"
block|}
block|,
block|{
literal|54
block|,
literal|0
block|,
literal|"PARITYFAIL[1]"
block|}
block|,
block|{
literal|53
block|,
literal|1
block|,
literal|"CPU_nIRQ[1]"
block|}
block|,
block|{
literal|52
block|,
literal|0
block|,
literal|"CPU_nIRQ[0]"
block|}
block|,
block|{
literal|51
block|,
literal|7
block|,
literal|"CPU_nRAMERRIRQ"
block|}
block|,
block|{
literal|51
block|,
literal|6
block|,
literal|"CPU_nAXIERRIRQ"
block|}
block|,
block|{
literal|51
block|,
literal|4
block|,
literal|"INT_COMB_ISP_GIC"
block|}
block|,
block|{
literal|51
block|,
literal|3
block|,
literal|"INT_COMB_IOP_GIC"
block|}
block|,
block|{
literal|51
block|,
literal|2
block|,
literal|"CCI_nERRORIRQ"
block|}
block|,
block|{
literal|51
block|,
literal|1
block|,
literal|"INT_COMB_ARMISP_GIC"
block|}
block|,
block|{
literal|51
block|,
literal|0
block|,
literal|"INT_COMB_ARMIOP_GIC"
block|}
block|,
block|{
literal|50
block|,
literal|7
block|,
literal|"DISP1[3]"
block|}
block|,
block|{
literal|50
block|,
literal|6
block|,
literal|"DISP1[2]"
block|}
block|,
block|{
literal|50
block|,
literal|5
block|,
literal|"DISP1[1]"
block|}
block|,
block|{
literal|50
block|,
literal|4
block|,
literal|"DISP1[0]"
block|}
block|,
block|{
literal|49
block|,
literal|3
block|,
literal|"SSCM_PULSE_IRQ_C2CIF[1]"
block|}
block|,
block|{
literal|49
block|,
literal|2
block|,
literal|"SSCM_PULSE_IRQ_C2CIF[0]"
block|}
block|,
block|{
literal|49
block|,
literal|1
block|,
literal|"SSCM_IRQ_C2CIF[1]"
block|}
block|,
block|{
literal|49
block|,
literal|0
block|,
literal|"SSCM_IRQ_C2CIF[0]"
block|}
block|,
block|{
literal|48
block|,
literal|3
block|,
literal|"PEREV_M1_CDREX"
block|}
block|,
block|{
literal|48
block|,
literal|2
block|,
literal|"PEREV_M0_CDREX"
block|}
block|,
block|{
literal|48
block|,
literal|1
block|,
literal|"PEREV_A1_CDREX"
block|}
block|,
block|{
literal|48
block|,
literal|0
block|,
literal|"PEREV_A0_CDREX"
block|}
block|,
block|{
literal|47
block|,
literal|3
block|,
literal|"MDMA0_ABORT"
block|}
block|,
comment|/* 46 is fully reserved */
block|{
literal|45
block|,
literal|1
block|,
literal|"MDMA1_ABORT"
block|}
block|,
comment|/* 44 is fully reserved */
block|{
literal|43
block|,
literal|7
block|,
literal|"SYSMMU_DRCISP[1]"
block|}
block|,
block|{
literal|43
block|,
literal|6
block|,
literal|"SYSMMU_DRCISP[0]"
block|}
block|,
block|{
literal|43
block|,
literal|1
block|,
literal|"SYSMMU_ODC[1]"
block|}
block|,
block|{
literal|43
block|,
literal|0
block|,
literal|"SYSMMU_ODC[0]"
block|}
block|,
block|{
literal|42
block|,
literal|7
block|,
literal|"SYSMMU_ISP[1]"
block|}
block|,
block|{
literal|42
block|,
literal|6
block|,
literal|"SYSMMU_ISP[0]"
block|}
block|,
block|{
literal|42
block|,
literal|5
block|,
literal|"SYSMMU_DIS0[1]"
block|}
block|,
block|{
literal|42
block|,
literal|4
block|,
literal|"SYSMMU_DIS0[0]"
block|}
block|,
block|{
literal|42
block|,
literal|3
block|,
literal|"DP1"
block|}
block|,
block|{
literal|41
block|,
literal|5
block|,
literal|"SYSMMU_DIS1[1]"
block|}
block|,
block|{
literal|41
block|,
literal|4
block|,
literal|"SYSMMU_DIS1[0]"
block|}
block|,
block|{
literal|40
block|,
literal|6
block|,
literal|"SYSMMU_MFCL[1]"
block|}
block|,
block|{
literal|40
block|,
literal|5
block|,
literal|"SYSMMU_MFCL[0]"
block|}
block|,
block|{
literal|39
block|,
literal|5
block|,
literal|"SYSMMU_TV_M0[1]"
block|}
block|,
block|{
literal|39
block|,
literal|4
block|,
literal|"SYSMMU_TV_M0[0]"
block|}
block|,
block|{
literal|39
block|,
literal|3
block|,
literal|"SYSMMU_MDMA1[1]"
block|}
block|,
block|{
literal|39
block|,
literal|2
block|,
literal|"SYSMMU_MDMA1[0]"
block|}
block|,
block|{
literal|39
block|,
literal|1
block|,
literal|"SYSMMU_MDMA0[1]"
block|}
block|,
block|{
literal|39
block|,
literal|0
block|,
literal|"SYSMMU_MDMA0[0]"
block|}
block|,
block|{
literal|38
block|,
literal|7
block|,
literal|"SYSMMU_SSS[1]"
block|}
block|,
block|{
literal|38
block|,
literal|6
block|,
literal|"SYSMMU_SSS[0]"
block|}
block|,
block|{
literal|38
block|,
literal|5
block|,
literal|"SYSMMU_RTIC[1]"
block|}
block|,
block|{
literal|38
block|,
literal|4
block|,
literal|"SYSMMU_RTIC[0]"
block|}
block|,
block|{
literal|38
block|,
literal|3
block|,
literal|"SYSMMU_MFCR[1]"
block|}
block|,
block|{
literal|38
block|,
literal|2
block|,
literal|"SYSMMU_MFCR[0]"
block|}
block|,
block|{
literal|38
block|,
literal|1
block|,
literal|"SYSMMU_ARM[1]"
block|}
block|,
block|{
literal|38
block|,
literal|0
block|,
literal|"SYSMMU_ARM[0]"
block|}
block|,
block|{
literal|37
block|,
literal|7
block|,
literal|"SYSMMU_3DNR[1]"
block|}
block|,
block|{
literal|37
block|,
literal|6
block|,
literal|"SYSMMU_3DNR[0]"
block|}
block|,
block|{
literal|37
block|,
literal|5
block|,
literal|"SYSMMU_MCUISP[1]"
block|}
block|,
block|{
literal|37
block|,
literal|4
block|,
literal|"SYSMMU_MCUISP[0]"
block|}
block|,
block|{
literal|37
block|,
literal|3
block|,
literal|"SYSMMU_SCALERCISP[1]"
block|}
block|,
block|{
literal|37
block|,
literal|2
block|,
literal|"SYSMMU_SCALERCISP[0]"
block|}
block|,
block|{
literal|37
block|,
literal|1
block|,
literal|"SYSMMU_FDISP[1]"
block|}
block|,
block|{
literal|37
block|,
literal|0
block|,
literal|"SYSMMU_FDISP[0]"
block|}
block|,
block|{
literal|36
block|,
literal|7
block|,
literal|"MCUIOP_CTIIRQ"
block|}
block|,
block|{
literal|36
block|,
literal|6
block|,
literal|"MCUIOP_PMUIRQ"
block|}
block|,
block|{
literal|36
block|,
literal|5
block|,
literal|"MCUISP_CTIIRQ"
block|}
block|,
block|{
literal|36
block|,
literal|4
block|,
literal|"MCUISP_PMUIRQ"
block|}
block|,
block|{
literal|36
block|,
literal|3
block|,
literal|"SYSMMU_JPEGX[1]"
block|}
block|,
block|{
literal|36
block|,
literal|2
block|,
literal|"SYSMMU_JPEGX[0]"
block|}
block|,
block|{
literal|36
block|,
literal|1
block|,
literal|"SYSMMU_ROTATOR[1]"
block|}
block|,
block|{
literal|36
block|,
literal|0
block|,
literal|"SYSMMU_ROTATOR[0]"
block|}
block|,
block|{
literal|35
block|,
literal|7
block|,
literal|"SYSMMU_SCALERPISP[1]"
block|}
block|,
block|{
literal|35
block|,
literal|6
block|,
literal|"SYSMMU_SCALERPISP[0]"
block|}
block|,
block|{
literal|35
block|,
literal|5
block|,
literal|"SYSMMU_FIMC_LITE0[1]"
block|}
block|,
block|{
literal|35
block|,
literal|4
block|,
literal|"SYSMMU_FIMC_LITE0[0]"
block|}
block|,
block|{
literal|35
block|,
literal|3
block|,
literal|"SYSMMU_DISP1_M0[1]"
block|}
block|,
block|{
literal|35
block|,
literal|2
block|,
literal|"SYSMMU_DISP1_M0[0]"
block|}
block|,
block|{
literal|35
block|,
literal|1
block|,
literal|"SYSMMU_FIMC_LITE2[1]"
block|}
block|,
block|{
literal|35
block|,
literal|0
block|,
literal|"SYSMMU_FIMC_LITE2[0]"
block|}
block|,
block|{
literal|34
block|,
literal|7
block|,
literal|"SYSMMU_GSCL3[1]"
block|}
block|,
block|{
literal|34
block|,
literal|6
block|,
literal|"SYSMMU_GSCL3[0]"
block|}
block|,
block|{
literal|34
block|,
literal|5
block|,
literal|"SYSMMU_GSCL2[1]"
block|}
block|,
block|{
literal|34
block|,
literal|4
block|,
literal|"SYSMMU_GSCL2[0]"
block|}
block|,
block|{
literal|34
block|,
literal|3
block|,
literal|"SYSMMU_GSCL1[1]"
block|}
block|,
block|{
literal|34
block|,
literal|2
block|,
literal|"SYSMMU_GSCL1[0]"
block|}
block|,
block|{
literal|34
block|,
literal|1
block|,
literal|"SYSMMU_GSCL0[1]"
block|}
block|,
block|{
literal|34
block|,
literal|0
block|,
literal|"SYSMMU_GSCL0[0]"
block|}
block|,
block|{
literal|33
block|,
literal|7
block|,
literal|"CPU_nCNTVIRQ[0]"
block|}
block|,
block|{
literal|33
block|,
literal|6
block|,
literal|"CPU_nCNTPSIRQ[0]"
block|}
block|,
block|{
literal|33
block|,
literal|5
block|,
literal|"CPU_nCNTPSNIRQ[0]"
block|}
block|,
block|{
literal|33
block|,
literal|4
block|,
literal|"CPU_nCNTHPIRQ[0]"
block|}
block|,
block|{
literal|33
block|,
literal|3
block|,
literal|"CPU_nCTIIRQ[0]"
block|}
block|,
block|{
literal|33
block|,
literal|2
block|,
literal|"CPU_nPMUIRQ[0]"
block|}
block|,
block|{
literal|33
block|,
literal|1
block|,
literal|"CPU_PARITYFAILSCU[0]"
block|}
block|,
block|{
literal|33
block|,
literal|0
block|,
literal|"CPU_PARITYFAIL0"
block|}
block|,
block|{
literal|32
block|,
literal|7
block|,
literal|"TZASC_XR1BXW"
block|}
block|,
block|{
literal|32
block|,
literal|6
block|,
literal|"TZASC_XR1BXR"
block|}
block|,
block|{
literal|32
block|,
literal|5
block|,
literal|"TZASC_XLBXW"
block|}
block|,
block|{
literal|32
block|,
literal|4
block|,
literal|"TZASC_XLBXR"
block|}
block|,
block|{
literal|32
block|,
literal|3
block|,
literal|"TZASC_DRBXW"
block|}
block|,
block|{
literal|32
block|,
literal|2
block|,
literal|"TZASC_DRBXR"
block|}
block|,
block|{
literal|32
block|,
literal|1
block|,
literal|"TZASC_CBXW"
block|}
block|,
block|{
literal|32
block|,
literal|0
block|,
literal|"TZASC_CBXR"
block|}
block|,
block|{
operator|-
literal|1
block|,
operator|-
literal|1
block|,
name|NULL
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|combined_intr
block|{
name|uint32_t
name|enabled
decl_stmt|;
name|void
function_decl|(
modifier|*
name|ih
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
name|void
modifier|*
name|ih_user
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|combined_intr
name|intr_map
index|[
literal|32
index|]
index|[
literal|8
index|]
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|combiner_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|combiner_softc
modifier|*
name|sc
decl_stmt|;
name|void
function_decl|(
modifier|*
name|ih
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
name|void
modifier|*
name|ih_user
decl_stmt|;
name|int
name|enabled
decl_stmt|;
name|int
name|intrs
decl_stmt|;
name|int
name|shift
decl_stmt|;
name|int
name|cirq
decl_stmt|;
name|int
name|grp
decl_stmt|;
name|int
name|i
decl_stmt|,
name|n
decl_stmt|;
name|sc
operator|=
name|arg
expr_stmt|;
name|intrs
operator|=
name|READ4
argument_list|(
name|sc
argument_list|,
name|CIPSR
argument_list|)
expr_stmt|;
for|for
control|(
name|grp
operator|=
literal|0
init|;
name|grp
operator|<
literal|32
condition|;
name|grp
operator|++
control|)
block|{
if|if
condition|(
name|intrs
operator|&
operator|(
literal|1
operator|<<
name|grp
operator|)
condition|)
block|{
name|n
operator|=
operator|(
name|grp
operator|/
literal|4
operator|)
expr_stmt|;
name|shift
operator|=
operator|(
name|grp
operator|%
literal|4
operator|)
operator|*
literal|8
expr_stmt|;
name|cirq
operator|=
name|READ4
argument_list|(
name|sc
argument_list|,
name|ISTR
argument_list|(
name|n
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|cirq
operator|&
operator|(
literal|1
operator|<<
operator|(
name|i
operator|+
name|shift
operator|)
operator|)
condition|)
block|{
name|ih
operator|=
name|intr_map
index|[
name|grp
index|]
index|[
name|i
index|]
operator|.
name|ih
expr_stmt|;
name|ih_user
operator|=
name|intr_map
index|[
name|grp
index|]
index|[
name|i
index|]
operator|.
name|ih_user
expr_stmt|;
name|enabled
operator|=
name|intr_map
index|[
name|grp
index|]
index|[
name|i
index|]
operator|.
name|enabled
expr_stmt|;
if|if
condition|(
name|enabled
operator|&&
operator|(
name|ih
operator|!=
name|NULL
operator|)
condition|)
block|{
name|ih
argument_list|(
name|ih_user
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
block|}
end_function

begin_function
name|void
name|combiner_setup_intr
parameter_list|(
name|char
modifier|*
name|source_name
parameter_list|,
name|void
function_decl|(
modifier|*
name|ih
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|ih_user
parameter_list|)
block|{
name|struct
name|combiner_entry
modifier|*
name|entry
decl_stmt|;
name|struct
name|combined_intr
modifier|*
name|cirq
decl_stmt|;
name|struct
name|combiner_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|shift
decl_stmt|;
name|int
name|reg
decl_stmt|;
name|int
name|grp
decl_stmt|;
name|int
name|n
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sc
operator|=
name|combiner_sc
expr_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Error: combiner is not attached\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|entry
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NGRP
operator|&&
name|interrupt_table
index|[
name|i
index|]
operator|.
name|bit
operator|!=
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|interrupt_table
index|[
name|i
index|]
operator|.
name|source_name
argument_list|,
name|source_name
argument_list|)
operator|==
literal|0
condition|)
block|{
name|entry
operator|=
operator|&
name|interrupt_table
index|[
name|i
index|]
expr_stmt|;
block|}
block|}
if|if
condition|(
name|entry
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"Can't find interrupt name %s\n"
argument_list|,
name|source_name
argument_list|)
expr_stmt|;
return|return;
block|}
if|#
directive|if
literal|0
block|device_printf(sc->dev, "Setting up interrupt %s\n", source_name);
endif|#
directive|endif
name|grp
operator|=
name|entry
operator|->
name|combiner_id
operator|-
literal|32
expr_stmt|;
name|cirq
operator|=
operator|&
name|intr_map
index|[
name|grp
index|]
index|[
name|entry
operator|->
name|bit
index|]
expr_stmt|;
name|cirq
operator|->
name|enabled
operator|=
literal|1
expr_stmt|;
name|cirq
operator|->
name|ih
operator|=
name|ih
expr_stmt|;
name|cirq
operator|->
name|ih_user
operator|=
name|ih_user
expr_stmt|;
name|n
operator|=
name|grp
operator|/
literal|4
expr_stmt|;
name|shift
operator|=
operator|(
name|grp
operator|%
literal|4
operator|)
operator|*
literal|8
operator|+
name|entry
operator|->
name|bit
expr_stmt|;
name|reg
operator|=
operator|(
literal|1
operator|<<
name|shift
operator|)
expr_stmt|;
name|WRITE4
argument_list|(
name|sc
argument_list|,
name|IESR
argument_list|(
name|n
argument_list|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|combiner_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
operator|!
name|ofw_bus_status_okay
argument_list|(
name|dev
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
operator|!
name|ofw_bus_is_compatible
argument_list|(
name|dev
argument_list|,
literal|"exynos,combiner"
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Samsung Exynos 5 Interrupt Combiner"
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|combiner_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|combiner_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|i
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
if|if
condition|(
name|bus_alloc_resources
argument_list|(
name|dev
argument_list|,
name|combiner_spec
argument_list|,
name|sc
operator|->
name|res
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not allocate resources\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
comment|/* Memory interface */
name|sc
operator|->
name|bst
operator|=
name|rman_get_bustag
argument_list|(
name|sc
operator|->
name|res
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|sc
operator|->
name|bsh
operator|=
name|rman_get_bushandle
argument_list|(
name|sc
operator|->
name|res
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|combiner_sc
operator|=
name|sc
expr_stmt|;
comment|/* Setup interrupt handler */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NGRP
condition|;
name|i
operator|++
control|)
block|{
name|err
operator|=
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|res
index|[
literal|1
operator|+
name|i
index|]
argument_list|,
name|INTR_TYPE_BIO
operator||
expr|\
name|INTR_MPSAFE
argument_list|,
name|NULL
argument_list|,
name|combiner_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|ih
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Unable to alloc int resource.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|combiner_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|combiner_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|combiner_attach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|combiner_driver
init|=
block|{
literal|"combiner"
block|,
name|combiner_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|combiner_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|combiner_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|combiner
argument_list|,
name|simplebus
argument_list|,
name|combiner_driver
argument_list|,
name|combiner_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2011 Jakub Wojciech Klama<jceel@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/intr.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus_subr.h>
end_include

begin_include
include|#
directive|include
file|<dev/mii/mii.h>
end_include

begin_include
include|#
directive|include
file|<dev/mii/miivar.h>
end_include

begin_include
include|#
directive|include
file|<arm/lpc/lpcreg.h>
end_include

begin_include
include|#
directive|include
file|<arm/lpc/lpcvar.h>
end_include

begin_include
include|#
directive|include
file|<arm/lpc/if_lpereg.h>
end_include

begin_include
include|#
directive|include
file|"miibus_if.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_define
define|#
directive|define
name|debugf
parameter_list|(
name|fmt
parameter_list|,
name|args
modifier|...
parameter_list|)
value|do { printf("%s(): ", __func__);   \     printf(fmt,##args); } while (0)
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|debugf
parameter_list|(
name|fmt
parameter_list|,
name|args
modifier|...
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_struct
struct|struct
name|lpe_dmamap_arg
block|{
name|bus_addr_t
name|lpe_dma_busaddr
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|lpe_rxdesc
block|{
name|struct
name|mbuf
modifier|*
name|lpe_rxdesc_mbuf
decl_stmt|;
name|bus_dmamap_t
name|lpe_rxdesc_dmamap
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|lpe_txdesc
block|{
name|int
name|lpe_txdesc_first
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|lpe_txdesc_mbuf
decl_stmt|;
name|bus_dmamap_t
name|lpe_txdesc_dmamap
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|lpe_chain_data
block|{
name|bus_dma_tag_t
name|lpe_parent_tag
decl_stmt|;
name|bus_dma_tag_t
name|lpe_tx_ring_tag
decl_stmt|;
name|bus_dmamap_t
name|lpe_tx_ring_map
decl_stmt|;
name|bus_dma_tag_t
name|lpe_tx_status_tag
decl_stmt|;
name|bus_dmamap_t
name|lpe_tx_status_map
decl_stmt|;
name|bus_dma_tag_t
name|lpe_tx_buf_tag
decl_stmt|;
name|bus_dma_tag_t
name|lpe_rx_ring_tag
decl_stmt|;
name|bus_dmamap_t
name|lpe_rx_ring_map
decl_stmt|;
name|bus_dma_tag_t
name|lpe_rx_status_tag
decl_stmt|;
name|bus_dmamap_t
name|lpe_rx_status_map
decl_stmt|;
name|bus_dma_tag_t
name|lpe_rx_buf_tag
decl_stmt|;
name|struct
name|lpe_rxdesc
name|lpe_rx_desc
index|[
name|LPE_RXDESC_NUM
index|]
decl_stmt|;
name|struct
name|lpe_txdesc
name|lpe_tx_desc
index|[
name|LPE_TXDESC_NUM
index|]
decl_stmt|;
name|int
name|lpe_tx_prod
decl_stmt|;
name|int
name|lpe_tx_last
decl_stmt|;
name|int
name|lpe_tx_used
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|lpe_ring_data
block|{
name|struct
name|lpe_hwdesc
modifier|*
name|lpe_rx_ring
decl_stmt|;
name|struct
name|lpe_hwstatus
modifier|*
name|lpe_rx_status
decl_stmt|;
name|bus_addr_t
name|lpe_rx_ring_phys
decl_stmt|;
name|bus_addr_t
name|lpe_rx_status_phys
decl_stmt|;
name|struct
name|lpe_hwdesc
modifier|*
name|lpe_tx_ring
decl_stmt|;
name|struct
name|lpe_hwstatus
modifier|*
name|lpe_tx_status
decl_stmt|;
name|bus_addr_t
name|lpe_tx_ring_phys
decl_stmt|;
name|bus_addr_t
name|lpe_tx_status_phys
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|lpe_softc
block|{
name|struct
name|ifnet
modifier|*
name|lpe_ifp
decl_stmt|;
name|struct
name|mtx
name|lpe_mtx
decl_stmt|;
name|phandle_t
name|lpe_ofw
decl_stmt|;
name|device_t
name|lpe_dev
decl_stmt|;
name|device_t
name|lpe_miibus
decl_stmt|;
name|uint8_t
name|lpe_enaddr
index|[
literal|6
index|]
decl_stmt|;
name|struct
name|resource
modifier|*
name|lpe_mem_res
decl_stmt|;
name|struct
name|resource
modifier|*
name|lpe_irq_res
decl_stmt|;
name|void
modifier|*
name|lpe_intrhand
decl_stmt|;
name|bus_space_tag_t
name|lpe_bst
decl_stmt|;
name|bus_space_handle_t
name|lpe_bsh
decl_stmt|;
define|#
directive|define
name|LPE_FLAG_LINK
value|(1<< 0)
name|uint32_t
name|lpe_flags
decl_stmt|;
name|int
name|lpe_watchdog_timer
decl_stmt|;
name|struct
name|callout
name|lpe_tick
decl_stmt|;
name|struct
name|lpe_chain_data
name|lpe_cdata
decl_stmt|;
name|struct
name|lpe_ring_data
name|lpe_rdata
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|int
name|lpe_probe
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|lpe_attach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|lpe_detach
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|lpe_miibus_readreg
parameter_list|(
name|device_t
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|lpe_miibus_writereg
parameter_list|(
name|device_t
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lpe_miibus_statchg
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lpe_reset
parameter_list|(
name|struct
name|lpe_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lpe_init
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lpe_init_locked
parameter_list|(
name|struct
name|lpe_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lpe_start
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lpe_start_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lpe_stop
parameter_list|(
name|struct
name|lpe_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lpe_stop_locked
parameter_list|(
name|struct
name|lpe_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|lpe_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|u_long
parameter_list|,
name|caddr_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lpe_set_rxmode
parameter_list|(
name|struct
name|lpe_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lpe_set_rxfilter
parameter_list|(
name|struct
name|lpe_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lpe_intr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lpe_rxintr
parameter_list|(
name|struct
name|lpe_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lpe_txintr
parameter_list|(
name|struct
name|lpe_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lpe_tick
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lpe_watchdog
parameter_list|(
name|struct
name|lpe_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|lpe_encap
parameter_list|(
name|struct
name|lpe_softc
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|lpe_dma_alloc
parameter_list|(
name|struct
name|lpe_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|lpe_dma_alloc_rx
parameter_list|(
name|struct
name|lpe_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|lpe_dma_alloc_tx
parameter_list|(
name|struct
name|lpe_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|lpe_init_rx
parameter_list|(
name|struct
name|lpe_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|lpe_init_rxbuf
parameter_list|(
name|struct
name|lpe_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lpe_discard_rxbuf
parameter_list|(
name|struct
name|lpe_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lpe_dmamap_cb
parameter_list|(
name|void
modifier|*
parameter_list|,
name|bus_dma_segment_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|lpe_ifmedia_upd
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|lpe_ifmedia_sts
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|struct
name|ifmediareq
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|lpe_lock
parameter_list|(
name|_sc
parameter_list|)
value|mtx_lock(&(_sc)->lpe_mtx)
end_define

begin_define
define|#
directive|define
name|lpe_unlock
parameter_list|(
name|_sc
parameter_list|)
value|mtx_unlock(&(_sc)->lpe_mtx)
end_define

begin_define
define|#
directive|define
name|lpe_lock_assert
parameter_list|(
name|sc
parameter_list|)
value|mtx_assert(&(_sc)->lpe_mtx, MA_OWNED)
end_define

begin_define
define|#
directive|define
name|lpe_read_4
parameter_list|(
name|_sc
parameter_list|,
name|_reg
parameter_list|)
define|\
value|bus_space_read_4((_sc)->lpe_bst, (_sc)->lpe_bsh, (_reg))
end_define

begin_define
define|#
directive|define
name|lpe_write_4
parameter_list|(
name|_sc
parameter_list|,
name|_reg
parameter_list|,
name|_val
parameter_list|)
define|\
value|bus_space_write_4((_sc)->lpe_bst, (_sc)->lpe_bsh, (_reg), (_val))
end_define

begin_define
define|#
directive|define
name|LPE_HWDESC_RXERRS
value|(LPE_HWDESC_CRCERROR | LPE_HWDESC_SYMBOLERROR | \     LPE_HWDESC_LENGTHERROR | LPE_HWDESC_ALIGNERROR | LPE_HWDESC_OVERRUN | \     LPE_HWDESC_RXNODESCR)
end_define

begin_define
define|#
directive|define
name|LPE_HWDESC_TXERRS
value|(LPE_HWDESC_EXCDEFER | LPE_HWDESC_EXCCOLL | \     LPE_HWDESC_LATECOLL | LPE_HWDESC_UNDERRUN | LPE_HWDESC_TXNODESCR)
end_define

begin_function
specifier|static
name|int
name|lpe_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
operator|!
name|ofw_bus_status_okay
argument_list|(
name|dev
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
operator|!
name|ofw_bus_is_compatible
argument_list|(
name|dev
argument_list|,
literal|"lpc,ethernet"
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"LPC32x0 10/100 Ethernet"
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lpe_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|lpe_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|int
name|rid
decl_stmt|,
name|i
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|sc
operator|->
name|lpe_dev
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|lpe_ofw
operator|=
name|ofw_bus_get_node
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|i
operator|=
name|OF_getprop
argument_list|(
name|sc
operator|->
name|lpe_ofw
argument_list|,
literal|"local-mac-address"
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|sc
operator|->
name|lpe_enaddr
argument_list|,
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|!=
literal|6
condition|)
block|{
name|sc
operator|->
name|lpe_enaddr
index|[
literal|0
index|]
operator|=
literal|0x00
expr_stmt|;
name|sc
operator|->
name|lpe_enaddr
index|[
literal|1
index|]
operator|=
literal|0x11
expr_stmt|;
name|sc
operator|->
name|lpe_enaddr
index|[
literal|2
index|]
operator|=
literal|0x22
expr_stmt|;
name|sc
operator|->
name|lpe_enaddr
index|[
literal|3
index|]
operator|=
literal|0x33
expr_stmt|;
name|sc
operator|->
name|lpe_enaddr
index|[
literal|4
index|]
operator|=
literal|0x44
expr_stmt|;
name|sc
operator|->
name|lpe_enaddr
index|[
literal|5
index|]
operator|=
literal|0x55
expr_stmt|;
block|}
name|mtx_init
argument_list|(
operator|&
name|sc
operator|->
name|lpe_mtx
argument_list|,
name|device_get_nameunit
argument_list|(
name|dev
argument_list|)
argument_list|,
name|MTX_NETWORK_LOCK
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|callout_init_mtx
argument_list|(
operator|&
name|sc
operator|->
name|lpe_tick
argument_list|,
operator|&
name|sc
operator|->
name|lpe_mtx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|lpe_mem_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|lpe_mem_res
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot allocate memory window\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|sc
operator|->
name|lpe_bst
operator|=
name|rman_get_bustag
argument_list|(
name|sc
operator|->
name|lpe_mem_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lpe_bsh
operator|=
name|rman_get_bushandle
argument_list|(
name|sc
operator|->
name|lpe_mem_res
argument_list|)
expr_stmt|;
name|rid
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|lpe_irq_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|rid
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|lpe_irq_res
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot allocate interrupt\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|sc
operator|->
name|lpe_ifp
operator|=
name|if_alloc
argument_list|(
name|IFT_ETHER
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sc
operator|->
name|lpe_ifp
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot allocated ifnet\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|ifp
operator|=
name|sc
operator|->
name|lpe_ifp
expr_stmt|;
name|if_initname
argument_list|(
name|ifp
argument_list|,
name|device_get_name
argument_list|(
name|dev
argument_list|)
argument_list|,
name|device_get_unit
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_softc
operator|=
name|sc
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_SIMPLEX
operator||
name|IFF_MULTICAST
expr_stmt|;
name|ifp
operator|->
name|if_start
operator|=
name|lpe_start
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|lpe_ioctl
expr_stmt|;
name|ifp
operator|->
name|if_init
operator|=
name|lpe_init
expr_stmt|;
name|IFQ_SET_MAXLEN
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|IFQ_MAXLEN
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_drv_maxlen
operator|=
name|IFQ_MAXLEN
expr_stmt|;
name|IFQ_SET_READY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
expr_stmt|;
name|ether_ifattach
argument_list|(
name|ifp
argument_list|,
name|sc
operator|->
name|lpe_enaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|lpe_irq_res
argument_list|,
name|INTR_TYPE_NET
argument_list|,
name|NULL
argument_list|,
name|lpe_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|lpe_intrhand
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot establish interrupt handler\n"
argument_list|)
expr_stmt|;
name|ether_ifdetach
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* Enable Ethernet clock */
name|lpc_pwr_write
argument_list|(
name|dev
argument_list|,
name|LPC_CLKPWR_MACCLK_CTRL
argument_list|,
name|LPC_CLKPWR_MACCLK_CTRL_REG
operator||
name|LPC_CLKPWR_MACCLK_CTRL_SLAVE
operator||
name|LPC_CLKPWR_MACCLK_CTRL_MASTER
operator||
name|LPC_CLKPWR_MACCLK_CTRL_HDWINF
argument_list|(
literal|3
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Reset chip */
name|lpe_reset
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Initialize MII */
name|val
operator|=
name|lpe_read_4
argument_list|(
name|sc
argument_list|,
name|LPE_COMMAND
argument_list|)
expr_stmt|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_COMMAND
argument_list|,
name|val
operator||
name|LPE_COMMAND_RMII
argument_list|)
expr_stmt|;
if|if
condition|(
name|mii_attach
argument_list|(
name|dev
argument_list|,
operator|&
name|sc
operator|->
name|lpe_miibus
argument_list|,
name|ifp
argument_list|,
name|lpe_ifmedia_upd
argument_list|,
name|lpe_ifmedia_sts
argument_list|,
name|BMSR_DEFCAPMASK
argument_list|,
literal|0x01
argument_list|,
name|MII_OFFSET_ANY
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot find PHY\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|lpe_dma_alloc
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
if|if
condition|(
name|sc
operator|->
name|lpe_ifp
condition|)
name|if_free
argument_list|(
name|sc
operator|->
name|lpe_ifp
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|lpe_intrhand
condition|)
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|lpe_irq_res
argument_list|,
name|sc
operator|->
name|lpe_intrhand
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|lpe_irq_res
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|lpe_irq_res
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|lpe_mem_res
condition|)
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|lpe_mem_res
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lpe_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|lpe_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|lpe_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|if_free
argument_list|(
name|sc
operator|->
name|lpe_ifp
argument_list|)
expr_stmt|;
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|lpe_irq_res
argument_list|,
name|sc
operator|->
name|lpe_intrhand
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|lpe_irq_res
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|lpe_mem_res
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lpe_miibus_readreg
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|)
block|{
name|struct
name|lpe_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|int
name|result
decl_stmt|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_MCMD
argument_list|,
name|LPE_MCMD_READ
argument_list|)
expr_stmt|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_MADR
argument_list|,
operator|(
name|reg
operator|&
name|LPE_MADR_REGMASK
operator|)
operator|<<
name|LPE_MADR_REGSHIFT
operator||
operator|(
name|phy
operator|&
name|LPE_MADR_PHYMASK
operator|)
operator|<<
name|LPE_MADR_PHYSHIFT
argument_list|)
expr_stmt|;
name|val
operator|=
name|lpe_read_4
argument_list|(
name|sc
argument_list|,
name|LPE_MIND
argument_list|)
expr_stmt|;
comment|/* Wait until request is completed */
while|while
condition|(
name|val
operator|&
name|LPE_MIND_BUSY
condition|)
block|{
name|val
operator|=
name|lpe_read_4
argument_list|(
name|sc
argument_list|,
name|LPE_MIND
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|val
operator|&
name|LPE_MIND_INVALID
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_MCMD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|result
operator|=
operator|(
name|lpe_read_4
argument_list|(
name|sc
argument_list|,
name|LPE_MRDD
argument_list|)
operator|&
name|LPE_MRDD_DATAMASK
operator|)
expr_stmt|;
name|debugf
argument_list|(
literal|"phy=%d reg=%d result=0x%04x\n"
argument_list|,
name|phy
argument_list|,
name|reg
argument_list|,
name|result
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lpe_miibus_writereg
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|phy
parameter_list|,
name|int
name|reg
parameter_list|,
name|int
name|data
parameter_list|)
block|{
name|struct
name|lpe_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|debugf
argument_list|(
literal|"phy=%d reg=%d data=0x%04x\n"
argument_list|,
name|phy
argument_list|,
name|reg
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_MCMD
argument_list|,
name|LPE_MCMD_WRITE
argument_list|)
expr_stmt|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_MADR
argument_list|,
operator|(
name|reg
operator|&
name|LPE_MADR_REGMASK
operator|)
operator|<<
name|LPE_MADR_REGSHIFT
operator||
operator|(
name|phy
operator|&
name|LPE_MADR_PHYMASK
operator|)
operator|<<
name|LPE_MADR_PHYSHIFT
argument_list|)
expr_stmt|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_MWTD
argument_list|,
operator|(
name|data
operator|&
name|LPE_MWTD_DATAMASK
operator|)
argument_list|)
expr_stmt|;
name|val
operator|=
name|lpe_read_4
argument_list|(
name|sc
argument_list|,
name|LPE_MIND
argument_list|)
expr_stmt|;
comment|/* Wait until request is completed */
while|while
condition|(
name|val
operator|&
name|LPE_MIND_BUSY
condition|)
block|{
name|val
operator|=
name|lpe_read_4
argument_list|(
name|sc
argument_list|,
name|LPE_MIND
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lpe_miibus_statchg
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|lpe_softc
modifier|*
name|sc
init|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
init|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|lpe_miibus
argument_list|)
decl_stmt|;
name|lpe_lock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|mii
operator|->
name|mii_media_status
operator|&
name|IFM_ACTIVE
operator|)
operator|&&
operator|(
name|mii
operator|->
name|mii_media_status
operator|&
name|IFM_AVALID
operator|)
condition|)
name|sc
operator|->
name|lpe_flags
operator||=
name|LPE_FLAG_LINK
expr_stmt|;
else|else
name|sc
operator|->
name|lpe_flags
operator|&=
operator|~
name|LPE_FLAG_LINK
expr_stmt|;
name|lpe_unlock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lpe_reset
parameter_list|(
name|struct
name|lpe_softc
modifier|*
name|sc
parameter_list|)
block|{
name|uint32_t
name|mac1
decl_stmt|;
comment|/* Enter soft reset mode */
name|mac1
operator|=
name|lpe_read_4
argument_list|(
name|sc
argument_list|,
name|LPE_MAC1
argument_list|)
expr_stmt|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_MAC1
argument_list|,
name|mac1
operator||
name|LPE_MAC1_SOFTRESET
operator||
name|LPE_MAC1_RESETTX
operator||
name|LPE_MAC1_RESETMCSTX
operator||
name|LPE_MAC1_RESETRX
operator||
name|LPE_MAC1_RESETMCSRX
argument_list|)
expr_stmt|;
comment|/* Reset registers, Tx path and Rx path */
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_COMMAND
argument_list|,
name|LPE_COMMAND_REGRESET
operator||
name|LPE_COMMAND_TXRESET
operator||
name|LPE_COMMAND_RXRESET
argument_list|)
expr_stmt|;
comment|/* Set station address */
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_SA2
argument_list|,
name|sc
operator|->
name|lpe_enaddr
index|[
literal|1
index|]
operator|<<
literal|8
operator||
name|sc
operator|->
name|lpe_enaddr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_SA1
argument_list|,
name|sc
operator|->
name|lpe_enaddr
index|[
literal|3
index|]
operator|<<
literal|8
operator||
name|sc
operator|->
name|lpe_enaddr
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_SA0
argument_list|,
name|sc
operator|->
name|lpe_enaddr
index|[
literal|5
index|]
operator|<<
literal|8
operator||
name|sc
operator|->
name|lpe_enaddr
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
comment|/* Leave soft reset mode */
name|mac1
operator|=
name|lpe_read_4
argument_list|(
name|sc
argument_list|,
name|LPE_MAC1
argument_list|)
expr_stmt|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_MAC1
argument_list|,
name|mac1
operator|&
operator|~
operator|(
name|LPE_MAC1_SOFTRESET
operator||
name|LPE_MAC1_RESETTX
operator||
name|LPE_MAC1_RESETMCSTX
operator||
name|LPE_MAC1_RESETRX
operator||
name|LPE_MAC1_RESETMCSRX
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lpe_init
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|lpe_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|lpe_softc
operator|*
operator|)
name|arg
decl_stmt|;
name|lpe_lock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|lpe_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|lpe_unlock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lpe_init_locked
parameter_list|(
name|struct
name|lpe_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|lpe_ifp
decl_stmt|;
name|uint32_t
name|cmd
decl_stmt|,
name|mac1
decl_stmt|;
name|lpe_lock_assert
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
return|return;
comment|/* Enable Tx and Rx */
name|cmd
operator|=
name|lpe_read_4
argument_list|(
name|sc
argument_list|,
name|LPE_COMMAND
argument_list|)
expr_stmt|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_COMMAND
argument_list|,
name|cmd
operator||
name|LPE_COMMAND_RXENABLE
operator||
name|LPE_COMMAND_TXENABLE
operator||
name|LPE_COMMAND_PASSRUNTFRAME
argument_list|)
expr_stmt|;
comment|/* Enable receive */
name|mac1
operator|=
name|lpe_read_4
argument_list|(
name|sc
argument_list|,
name|LPE_MAC1
argument_list|)
expr_stmt|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_MAC1
argument_list|,
comment|/*mac1 |*/
name|LPE_MAC1_RXENABLE
operator||
name|LPE_MAC1_PASSALL
argument_list|)
expr_stmt|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_MAC2
argument_list|,
name|LPE_MAC2_CRCENABLE
operator||
name|LPE_MAC2_PADCRCENABLE
operator||
name|LPE_MAC2_FULLDUPLEX
argument_list|)
expr_stmt|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_MCFG
argument_list|,
name|LPE_MCFG_CLKSEL
argument_list|(
literal|7
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Set up Rx filter */
name|lpe_set_rxmode
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Enable interrupts */
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_INTENABLE
argument_list|,
name|LPE_INT_RXOVERRUN
operator||
name|LPE_INT_RXERROR
operator||
name|LPE_INT_RXFINISH
operator||
name|LPE_INT_RXDONE
operator||
name|LPE_INT_TXUNDERRUN
operator||
name|LPE_INT_TXERROR
operator||
name|LPE_INT_TXFINISH
operator||
name|LPE_INT_TXDONE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_prod
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_last
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_used
operator|=
literal|0
expr_stmt|;
name|lpe_init_rx
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Initialize Rx packet and status descriptor heads */
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_RXDESC
argument_list|,
name|sc
operator|->
name|lpe_rdata
operator|.
name|lpe_rx_ring_phys
argument_list|)
expr_stmt|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_RXSTATUS
argument_list|,
name|sc
operator|->
name|lpe_rdata
operator|.
name|lpe_rx_status_phys
argument_list|)
expr_stmt|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_RXDESC_NUMBER
argument_list|,
name|LPE_RXDESC_NUM
operator|-
literal|1
argument_list|)
expr_stmt|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_RXDESC_CONS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Initialize Tx packet and status descriptor heads */
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_TXDESC
argument_list|,
name|sc
operator|->
name|lpe_rdata
operator|.
name|lpe_tx_ring_phys
argument_list|)
expr_stmt|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_TXSTATUS
argument_list|,
name|sc
operator|->
name|lpe_rdata
operator|.
name|lpe_tx_status_phys
argument_list|)
expr_stmt|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_TXDESC_NUMBER
argument_list|,
name|LPE_TXDESC_NUM
operator|-
literal|1
argument_list|)
expr_stmt|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_TXDESC_PROD
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|lpe_tick
argument_list|,
name|hz
argument_list|,
name|lpe_tick
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lpe_start
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|lpe_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|lpe_softc
operator|*
operator|)
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|lpe_lock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|lpe_start_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|lpe_unlock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lpe_start_locked
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|lpe_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|lpe_softc
operator|*
operator|)
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m_head
decl_stmt|;
name|int
name|encap
init|=
literal|0
decl_stmt|;
name|lpe_lock_assert
argument_list|(
name|sc
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|IFQ_DRV_IS_EMPTY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
condition|)
block|{
if|if
condition|(
name|lpe_read_4
argument_list|(
name|sc
argument_list|,
name|LPE_TXDESC_PROD
argument_list|)
operator|==
name|lpe_read_4
argument_list|(
name|sc
argument_list|,
name|LPE_TXDESC_CONS
argument_list|)
operator|-
literal|5
condition|)
break|break;
comment|/* Dequeue first packet */
name|IFQ_DRV_DEQUEUE
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m_head
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|m_head
condition|)
break|break;
name|lpe_encap
argument_list|(
name|sc
argument_list|,
operator|&
name|m_head
argument_list|)
expr_stmt|;
name|encap
operator|++
expr_stmt|;
block|}
comment|/* Submit new descriptor list */
if|if
condition|(
name|encap
condition|)
block|{
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_TXDESC_PROD
argument_list|,
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_prod
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lpe_watchdog_timer
operator|=
literal|5
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|lpe_encap
parameter_list|(
name|struct
name|lpe_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|m_head
parameter_list|)
block|{
name|struct
name|lpe_txdesc
modifier|*
name|txd
decl_stmt|;
name|struct
name|lpe_hwdesc
modifier|*
name|hwd
decl_stmt|;
name|bus_dma_segment_t
name|segs
index|[
name|LPE_MAXFRAGS
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|err
decl_stmt|,
name|nsegs
decl_stmt|,
name|prod
decl_stmt|;
name|lpe_lock_assert
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|M_ASSERTPKTHDR
argument_list|(
operator|(
operator|*
name|m_head
operator|)
argument_list|)
expr_stmt|;
name|prod
operator|=
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_prod
expr_stmt|;
name|txd
operator|=
operator|&
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_desc
index|[
name|prod
index|]
expr_stmt|;
name|debugf
argument_list|(
literal|"starting with prod=%d\n"
argument_list|,
name|prod
argument_list|)
expr_stmt|;
name|err
operator|=
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_buf_tag
argument_list|,
name|txd
operator|->
name|lpe_txdesc_dmamap
argument_list|,
operator|*
name|m_head
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
name|BUS_DMA_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
if|if
condition|(
name|nsegs
operator|==
literal|0
condition|)
block|{
name|m_freem
argument_list|(
operator|*
name|m_head
argument_list|)
expr_stmt|;
operator|*
name|m_head
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_buf_tag
argument_list|,
name|txd
operator|->
name|lpe_txdesc_dmamap
argument_list|,
name|BUS_DMASYNC_PREREAD
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_ring_tag
argument_list|,
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_ring_map
argument_list|,
name|BUS_DMASYNC_POSTREAD
operator||
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|txd
operator|->
name|lpe_txdesc_first
operator|=
literal|1
expr_stmt|;
name|txd
operator|->
name|lpe_txdesc_mbuf
operator|=
operator|*
name|m_head
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nsegs
condition|;
name|i
operator|++
control|)
block|{
name|hwd
operator|=
operator|&
name|sc
operator|->
name|lpe_rdata
operator|.
name|lpe_tx_ring
index|[
name|prod
index|]
expr_stmt|;
name|hwd
operator|->
name|lhr_data
operator|=
name|segs
index|[
name|i
index|]
operator|.
name|ds_addr
expr_stmt|;
name|hwd
operator|->
name|lhr_control
operator|=
name|segs
index|[
name|i
index|]
operator|.
name|ds_len
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|i
operator|==
name|nsegs
operator|-
literal|1
condition|)
block|{
name|hwd
operator|->
name|lhr_control
operator||=
name|LPE_HWDESC_LASTFLAG
expr_stmt|;
name|hwd
operator|->
name|lhr_control
operator||=
name|LPE_HWDESC_INTERRUPT
expr_stmt|;
name|hwd
operator|->
name|lhr_control
operator||=
name|LPE_HWDESC_CRC
expr_stmt|;
name|hwd
operator|->
name|lhr_control
operator||=
name|LPE_HWDESC_PAD
expr_stmt|;
block|}
name|LPE_INC
argument_list|(
name|prod
argument_list|,
name|LPE_TXDESC_NUM
argument_list|)
expr_stmt|;
block|}
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_ring_tag
argument_list|,
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_ring_map
argument_list|,
name|BUS_DMASYNC_PREREAD
operator||
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_used
operator|+=
name|nsegs
expr_stmt|;
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_prod
operator|=
name|prod
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lpe_stop
parameter_list|(
name|struct
name|lpe_softc
modifier|*
name|sc
parameter_list|)
block|{
name|lpe_lock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|lpe_stop_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|lpe_unlock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lpe_stop_locked
parameter_list|(
name|struct
name|lpe_softc
modifier|*
name|sc
parameter_list|)
block|{
name|lpe_lock_assert
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|lpe_tick
argument_list|)
expr_stmt|;
comment|/* Disable interrupts */
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_INTCLEAR
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
comment|/* Stop EMAC */
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_MAC1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_MAC2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_COMMAND
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lpe_ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_OACTIVE
expr_stmt|;
name|sc
operator|->
name|lpe_ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_RUNNING
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|lpe_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|struct
name|lpe_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
init|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|lpe_miibus
argument_list|)
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SIOCSIFFLAGS
case|:
name|lpe_lock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
name|lpe_set_rxmode
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|lpe_set_rxfilter
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
name|lpe_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
name|lpe_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|lpe_unlock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCADDMULTI
case|:
case|case
name|SIOCDELMULTI
case|:
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
name|lpe_lock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|lpe_set_rxfilter
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|lpe_unlock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SIOCGIFMEDIA
case|:
case|case
name|SIOCSIFMEDIA
case|:
name|err
operator|=
name|ifmedia_ioctl
argument_list|(
name|ifp
argument_list|,
name|ifr
argument_list|,
operator|&
name|mii
operator|->
name|mii_media
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
break|break;
default|default:
name|err
operator|=
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lpe_set_rxmode
parameter_list|(
name|struct
name|lpe_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|lpe_ifp
decl_stmt|;
name|uint32_t
name|rxfilt
decl_stmt|;
name|rxfilt
operator|=
name|LPE_RXFILTER_UNIHASH
operator||
name|LPE_RXFILTER_MULTIHASH
operator||
name|LPE_RXFILTER_PERFECT
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_BROADCAST
condition|)
name|rxfilt
operator||=
name|LPE_RXFILTER_BROADCAST
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_PROMISC
condition|)
name|rxfilt
operator||=
name|LPE_RXFILTER_UNICAST
operator||
name|LPE_RXFILTER_MULTICAST
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_ALLMULTI
condition|)
name|rxfilt
operator||=
name|LPE_RXFILTER_MULTICAST
expr_stmt|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_RXFILTER_CTRL
argument_list|,
name|rxfilt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lpe_set_rxfilter
parameter_list|(
name|struct
name|lpe_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|lpe_ifp
decl_stmt|;
name|struct
name|ifmultiaddr
modifier|*
name|ifma
decl_stmt|;
name|int
name|index
decl_stmt|;
name|uint32_t
name|hashl
decl_stmt|,
name|hashh
decl_stmt|;
name|hashl
operator|=
literal|0
expr_stmt|;
name|hashh
operator|=
literal|0
expr_stmt|;
name|if_maddr_rlock
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|ifma
argument_list|,
argument|&ifp->if_multiaddrs
argument_list|,
argument|ifma_link
argument_list|)
block|{
if|if
condition|(
name|ifma
operator|->
name|ifma_addr
operator|->
name|sa_family
operator|!=
name|AF_LINK
condition|)
continue|continue;
name|index
operator|=
name|ether_crc32_be
argument_list|(
name|LLADDR
argument_list|(
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|ifma
operator|->
name|ifma_addr
argument_list|)
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
operator|>>
literal|23
operator|&
literal|0x3f
expr_stmt|;
if|if
condition|(
name|index
operator|>
literal|31
condition|)
name|hashh
operator||=
operator|(
literal|1
operator|<<
operator|(
name|index
operator|-
literal|32
operator|)
operator|)
expr_stmt|;
else|else
name|hashl
operator||=
operator|(
literal|1
operator|<<
name|index
operator|)
expr_stmt|;
block|}
name|if_maddr_runlock
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
comment|/* Program new hash filter */
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_HASHFILTER_L
argument_list|,
name|hashl
argument_list|)
expr_stmt|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_HASHFILTER_H
argument_list|,
name|hashh
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lpe_intr
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|lpe_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|lpe_softc
operator|*
operator|)
name|arg
decl_stmt|;
name|uint32_t
name|intstatus
decl_stmt|;
name|debugf
argument_list|(
literal|"status=0x%08x\n"
argument_list|,
name|lpe_read_4
argument_list|(
name|sc
argument_list|,
name|LPE_INTSTATUS
argument_list|)
argument_list|)
expr_stmt|;
name|lpe_lock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|intstatus
operator|=
name|lpe_read_4
argument_list|(
name|sc
argument_list|,
name|LPE_INTSTATUS
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|intstatus
operator|&
name|LPE_INT_RXDONE
condition|)
name|lpe_rxintr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|intstatus
operator|&
name|LPE_INT_TXDONE
condition|)
name|lpe_txintr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_INTCLEAR
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
block|}
name|lpe_unlock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lpe_rxintr
parameter_list|(
name|struct
name|lpe_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|lpe_ifp
decl_stmt|;
name|struct
name|lpe_hwdesc
modifier|*
name|hwd
decl_stmt|;
name|struct
name|lpe_hwstatus
modifier|*
name|hws
decl_stmt|;
name|struct
name|lpe_rxdesc
modifier|*
name|rxd
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|int
name|prod
decl_stmt|,
name|cons
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|prod
operator|=
name|lpe_read_4
argument_list|(
name|sc
argument_list|,
name|LPE_RXDESC_PROD
argument_list|)
expr_stmt|;
name|cons
operator|=
name|lpe_read_4
argument_list|(
name|sc
argument_list|,
name|LPE_RXDESC_CONS
argument_list|)
expr_stmt|;
if|if
condition|(
name|prod
operator|==
name|cons
condition|)
break|break;
name|rxd
operator|=
operator|&
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_rx_desc
index|[
name|cons
index|]
expr_stmt|;
name|hwd
operator|=
operator|&
name|sc
operator|->
name|lpe_rdata
operator|.
name|lpe_rx_ring
index|[
name|cons
index|]
expr_stmt|;
name|hws
operator|=
operator|&
name|sc
operator|->
name|lpe_rdata
operator|.
name|lpe_rx_status
index|[
name|cons
index|]
expr_stmt|;
comment|/* Check received frame for errors */
if|if
condition|(
name|hws
operator|->
name|lhs_info
operator|&
name|LPE_HWDESC_RXERRS
condition|)
block|{
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_IERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|lpe_discard_rxbuf
argument_list|(
name|sc
argument_list|,
name|cons
argument_list|)
expr_stmt|;
name|lpe_init_rxbuf
argument_list|(
name|sc
argument_list|,
name|cons
argument_list|)
expr_stmt|;
goto|goto
name|skip
goto|;
block|}
name|m
operator|=
name|rxd
operator|->
name|lpe_rxdesc_mbuf
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|ifp
expr_stmt|;
name|m
operator|->
name|m_data
operator|+=
literal|2
expr_stmt|;
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_IPACKETS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|lpe_unlock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
call|(
modifier|*
name|ifp
operator|->
name|if_input
call|)
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|lpe_lock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|lpe_init_rxbuf
argument_list|(
name|sc
argument_list|,
name|cons
argument_list|)
expr_stmt|;
name|skip
label|:
name|LPE_INC
argument_list|(
name|cons
argument_list|,
name|LPE_RXDESC_NUM
argument_list|)
expr_stmt|;
name|lpe_write_4
argument_list|(
name|sc
argument_list|,
name|LPE_RXDESC_CONS
argument_list|,
name|cons
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|lpe_txintr
parameter_list|(
name|struct
name|lpe_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|lpe_ifp
decl_stmt|;
name|struct
name|lpe_hwdesc
modifier|*
name|hwd
decl_stmt|;
name|struct
name|lpe_hwstatus
modifier|*
name|hws
decl_stmt|;
name|struct
name|lpe_txdesc
modifier|*
name|txd
decl_stmt|;
name|int
name|cons
decl_stmt|,
name|last
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|cons
operator|=
name|lpe_read_4
argument_list|(
name|sc
argument_list|,
name|LPE_TXDESC_CONS
argument_list|)
expr_stmt|;
name|last
operator|=
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_last
expr_stmt|;
if|if
condition|(
name|cons
operator|==
name|last
condition|)
break|break;
name|txd
operator|=
operator|&
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_desc
index|[
name|last
index|]
expr_stmt|;
name|hwd
operator|=
operator|&
name|sc
operator|->
name|lpe_rdata
operator|.
name|lpe_tx_ring
index|[
name|last
index|]
expr_stmt|;
name|hws
operator|=
operator|&
name|sc
operator|->
name|lpe_rdata
operator|.
name|lpe_tx_status
index|[
name|last
index|]
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_buf_tag
argument_list|,
name|txd
operator|->
name|lpe_txdesc_dmamap
argument_list|,
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_COLLISIONS
argument_list|,
name|LPE_HWDESC_COLLISIONS
argument_list|(
name|hws
operator|->
name|lhs_info
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hws
operator|->
name|lhs_info
operator|&
name|LPE_HWDESC_TXERRS
condition|)
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OPACKETS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|txd
operator|->
name|lpe_txdesc_first
condition|)
block|{
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_buf_tag
argument_list|,
name|txd
operator|->
name|lpe_txdesc_dmamap
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|txd
operator|->
name|lpe_txdesc_mbuf
argument_list|)
expr_stmt|;
name|txd
operator|->
name|lpe_txdesc_mbuf
operator|=
name|NULL
expr_stmt|;
name|txd
operator|->
name|lpe_txdesc_first
operator|=
literal|0
expr_stmt|;
block|}
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_used
operator|--
expr_stmt|;
name|LPE_INC
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_last
argument_list|,
name|LPE_TXDESC_NUM
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_used
condition|)
name|sc
operator|->
name|lpe_watchdog_timer
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lpe_tick
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|lpe_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|lpe_softc
operator|*
operator|)
name|arg
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
init|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|lpe_miibus
argument_list|)
decl_stmt|;
name|lpe_lock_assert
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mii_tick
argument_list|(
name|mii
argument_list|)
expr_stmt|;
name|lpe_watchdog
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|lpe_tick
argument_list|,
name|hz
argument_list|,
name|lpe_tick
argument_list|,
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|lpe_watchdog
parameter_list|(
name|struct
name|lpe_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|sc
operator|->
name|lpe_ifp
decl_stmt|;
name|lpe_lock_assert
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|lpe_watchdog_timer
operator|==
literal|0
operator|||
name|sc
operator|->
name|lpe_watchdog_timer
operator|--
condition|)
return|return;
comment|/* Chip has stopped responding */
name|device_printf
argument_list|(
name|sc
operator|->
name|lpe_dev
argument_list|,
literal|"WARNING: chip hangup, restarting...\n"
argument_list|)
expr_stmt|;
name|lpe_stop_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|lpe_init_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
comment|/* Try to resend packets */
if|if
condition|(
operator|!
name|IFQ_DRV_IS_EMPTY
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|)
condition|)
name|lpe_start_locked
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|lpe_dma_alloc
parameter_list|(
name|struct
name|lpe_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
comment|/* Create parent DMA tag */
name|err
operator|=
name|bus_dma_tag_create
argument_list|(
name|bus_get_dma_tag
argument_list|(
name|sc
operator|->
name|lpe_dev
argument_list|)
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
comment|/* alignment, boundary */
name|BUS_SPACE_MAXADDR_32BIT
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|BUS_SPACE_MAXSIZE_32BIT
argument_list|,
literal|0
argument_list|,
comment|/* maxsize, nsegments */
name|BUS_SPACE_MAXSIZE_32BIT
argument_list|,
literal|0
argument_list|,
comment|/* maxsegsize, flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockarg */
operator|&
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_parent_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|lpe_dev
argument_list|,
literal|"cannot create parent DMA tag\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
name|err
operator|=
name|lpe_dma_alloc_rx
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
name|err
operator|=
name|lpe_dma_alloc_tx
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lpe_dma_alloc_rx
parameter_list|(
name|struct
name|lpe_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|lpe_rxdesc
modifier|*
name|rxd
decl_stmt|;
name|struct
name|lpe_dmamap_arg
name|ctx
decl_stmt|;
name|int
name|err
decl_stmt|,
name|i
decl_stmt|;
comment|/* Create tag for Rx ring */
name|err
operator|=
name|bus_dma_tag_create
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_parent_tag
argument_list|,
name|LPE_DESC_ALIGN
argument_list|,
literal|0
argument_list|,
comment|/* alignment, boundary */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|LPE_RXDESC_SIZE
argument_list|,
literal|1
argument_list|,
comment|/* maxsize, nsegments */
name|LPE_RXDESC_SIZE
argument_list|,
literal|0
argument_list|,
comment|/* maxsegsize, flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockarg */
operator|&
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_rx_ring_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|lpe_dev
argument_list|,
literal|"cannot create Rx ring DMA tag\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* Create tag for Rx status ring */
name|err
operator|=
name|bus_dma_tag_create
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_parent_tag
argument_list|,
name|LPE_DESC_ALIGN
argument_list|,
literal|0
argument_list|,
comment|/* alignment, boundary */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|LPE_RXSTATUS_SIZE
argument_list|,
literal|1
argument_list|,
comment|/* maxsize, nsegments */
name|LPE_RXSTATUS_SIZE
argument_list|,
literal|0
argument_list|,
comment|/* maxsegsize, flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockarg */
operator|&
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_rx_status_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|lpe_dev
argument_list|,
literal|"cannot create Rx status ring DMA tag\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* Create tag for Rx buffers */
name|err
operator|=
name|bus_dma_tag_create
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_parent_tag
argument_list|,
name|LPE_DESC_ALIGN
argument_list|,
literal|0
argument_list|,
comment|/* alignment, boundary */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|MCLBYTES
operator|*
name|LPE_RXDESC_NUM
argument_list|,
comment|/* maxsize */
name|LPE_RXDESC_NUM
argument_list|,
comment|/* segments */
name|MCLBYTES
argument_list|,
literal|0
argument_list|,
comment|/* maxsegsize, flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockarg */
operator|&
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_rx_buf_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|lpe_dev
argument_list|,
literal|"cannot create Rx buffers DMA tag\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* Allocate Rx DMA ring */
name|err
operator|=
name|bus_dmamem_alloc
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_rx_ring_tag
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|sc
operator|->
name|lpe_rdata
operator|.
name|lpe_rx_ring
argument_list|,
name|BUS_DMA_WAITOK
operator||
name|BUS_DMA_COHERENT
operator||
name|BUS_DMA_ZERO
argument_list|,
operator|&
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_rx_ring_map
argument_list|)
expr_stmt|;
name|err
operator|=
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_rx_ring_tag
argument_list|,
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_rx_ring_map
argument_list|,
name|sc
operator|->
name|lpe_rdata
operator|.
name|lpe_rx_ring
argument_list|,
name|LPE_RXDESC_SIZE
argument_list|,
name|lpe_dmamap_cb
argument_list|,
operator|&
name|ctx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lpe_rdata
operator|.
name|lpe_rx_ring_phys
operator|=
name|ctx
operator|.
name|lpe_dma_busaddr
expr_stmt|;
comment|/* Allocate Rx status ring */
name|err
operator|=
name|bus_dmamem_alloc
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_rx_status_tag
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|sc
operator|->
name|lpe_rdata
operator|.
name|lpe_rx_status
argument_list|,
name|BUS_DMA_WAITOK
operator||
name|BUS_DMA_COHERENT
operator||
name|BUS_DMA_ZERO
argument_list|,
operator|&
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_rx_status_map
argument_list|)
expr_stmt|;
name|err
operator|=
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_rx_status_tag
argument_list|,
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_rx_status_map
argument_list|,
name|sc
operator|->
name|lpe_rdata
operator|.
name|lpe_rx_status
argument_list|,
name|LPE_RXDESC_SIZE
argument_list|,
name|lpe_dmamap_cb
argument_list|,
operator|&
name|ctx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lpe_rdata
operator|.
name|lpe_rx_status_phys
operator|=
name|ctx
operator|.
name|lpe_dma_busaddr
expr_stmt|;
comment|/* Create Rx buffers DMA map */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|LPE_RXDESC_NUM
condition|;
name|i
operator|++
control|)
block|{
name|rxd
operator|=
operator|&
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_rx_desc
index|[
name|i
index|]
expr_stmt|;
name|rxd
operator|->
name|lpe_rxdesc_mbuf
operator|=
name|NULL
expr_stmt|;
name|rxd
operator|->
name|lpe_rxdesc_dmamap
operator|=
name|NULL
expr_stmt|;
name|err
operator|=
name|bus_dmamap_create
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_rx_buf_tag
argument_list|,
literal|0
argument_list|,
operator|&
name|rxd
operator|->
name|lpe_rxdesc_dmamap
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|lpe_dev
argument_list|,
literal|"cannot create Rx DMA map\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lpe_dma_alloc_tx
parameter_list|(
name|struct
name|lpe_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|lpe_txdesc
modifier|*
name|txd
decl_stmt|;
name|struct
name|lpe_dmamap_arg
name|ctx
decl_stmt|;
name|int
name|err
decl_stmt|,
name|i
decl_stmt|;
comment|/* Create tag for Tx ring */
name|err
operator|=
name|bus_dma_tag_create
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_parent_tag
argument_list|,
name|LPE_DESC_ALIGN
argument_list|,
literal|0
argument_list|,
comment|/* alignment, boundary */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|LPE_TXDESC_SIZE
argument_list|,
literal|1
argument_list|,
comment|/* maxsize, nsegments */
name|LPE_TXDESC_SIZE
argument_list|,
literal|0
argument_list|,
comment|/* maxsegsize, flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockarg */
operator|&
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_ring_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|lpe_dev
argument_list|,
literal|"cannot create Tx ring DMA tag\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* Create tag for Tx status ring */
name|err
operator|=
name|bus_dma_tag_create
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_parent_tag
argument_list|,
name|LPE_DESC_ALIGN
argument_list|,
literal|0
argument_list|,
comment|/* alignment, boundary */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|LPE_TXSTATUS_SIZE
argument_list|,
literal|1
argument_list|,
comment|/* maxsize, nsegments */
name|LPE_TXSTATUS_SIZE
argument_list|,
literal|0
argument_list|,
comment|/* maxsegsize, flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockarg */
operator|&
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_status_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|lpe_dev
argument_list|,
literal|"cannot create Tx status ring DMA tag\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* Create tag for Tx buffers */
name|err
operator|=
name|bus_dma_tag_create
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_parent_tag
argument_list|,
name|LPE_DESC_ALIGN
argument_list|,
literal|0
argument_list|,
comment|/* alignment, boundary */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* lowaddr */
name|BUS_SPACE_MAXADDR
argument_list|,
comment|/* highaddr */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* filter, filterarg */
name|MCLBYTES
operator|*
name|LPE_TXDESC_NUM
argument_list|,
comment|/* maxsize */
name|LPE_TXDESC_NUM
argument_list|,
comment|/* segments */
name|MCLBYTES
argument_list|,
literal|0
argument_list|,
comment|/* maxsegsize, flags */
name|NULL
argument_list|,
name|NULL
argument_list|,
comment|/* lockfunc, lockarg */
operator|&
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_buf_tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|lpe_dev
argument_list|,
literal|"cannot create Tx buffers DMA tag\n"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* Allocate Tx DMA ring */
name|err
operator|=
name|bus_dmamem_alloc
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_ring_tag
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|sc
operator|->
name|lpe_rdata
operator|.
name|lpe_tx_ring
argument_list|,
name|BUS_DMA_WAITOK
operator||
name|BUS_DMA_COHERENT
operator||
name|BUS_DMA_ZERO
argument_list|,
operator|&
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_ring_map
argument_list|)
expr_stmt|;
name|err
operator|=
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_ring_tag
argument_list|,
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_ring_map
argument_list|,
name|sc
operator|->
name|lpe_rdata
operator|.
name|lpe_tx_ring
argument_list|,
name|LPE_RXDESC_SIZE
argument_list|,
name|lpe_dmamap_cb
argument_list|,
operator|&
name|ctx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lpe_rdata
operator|.
name|lpe_tx_ring_phys
operator|=
name|ctx
operator|.
name|lpe_dma_busaddr
expr_stmt|;
comment|/* Allocate Tx status ring */
name|err
operator|=
name|bus_dmamem_alloc
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_status_tag
argument_list|,
operator|(
name|void
operator|*
operator|*
operator|)
operator|&
name|sc
operator|->
name|lpe_rdata
operator|.
name|lpe_tx_status
argument_list|,
name|BUS_DMA_WAITOK
operator||
name|BUS_DMA_COHERENT
operator||
name|BUS_DMA_ZERO
argument_list|,
operator|&
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_status_map
argument_list|)
expr_stmt|;
name|err
operator|=
name|bus_dmamap_load
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_status_tag
argument_list|,
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_status_map
argument_list|,
name|sc
operator|->
name|lpe_rdata
operator|.
name|lpe_tx_status
argument_list|,
name|LPE_RXDESC_SIZE
argument_list|,
name|lpe_dmamap_cb
argument_list|,
operator|&
name|ctx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|lpe_rdata
operator|.
name|lpe_tx_status_phys
operator|=
name|ctx
operator|.
name|lpe_dma_busaddr
expr_stmt|;
comment|/* Create Tx buffers DMA map */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|LPE_TXDESC_NUM
condition|;
name|i
operator|++
control|)
block|{
name|txd
operator|=
operator|&
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_desc
index|[
name|i
index|]
expr_stmt|;
name|txd
operator|->
name|lpe_txdesc_mbuf
operator|=
name|NULL
expr_stmt|;
name|txd
operator|->
name|lpe_txdesc_dmamap
operator|=
name|NULL
expr_stmt|;
name|txd
operator|->
name|lpe_txdesc_first
operator|=
literal|0
expr_stmt|;
name|err
operator|=
name|bus_dmamap_create
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_tx_buf_tag
argument_list|,
literal|0
argument_list|,
operator|&
name|txd
operator|->
name|lpe_txdesc_dmamap
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|lpe_dev
argument_list|,
literal|"cannot create Tx DMA map\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lpe_init_rx
parameter_list|(
name|struct
name|lpe_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|err
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|LPE_RXDESC_NUM
condition|;
name|i
operator|++
control|)
block|{
name|err
operator|=
name|lpe_init_rxbuf
argument_list|(
name|sc
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|lpe_init_rxbuf
parameter_list|(
name|struct
name|lpe_softc
modifier|*
name|sc
parameter_list|,
name|int
name|n
parameter_list|)
block|{
name|struct
name|lpe_rxdesc
modifier|*
name|rxd
decl_stmt|;
name|struct
name|lpe_hwdesc
modifier|*
name|hwd
decl_stmt|;
name|struct
name|lpe_hwstatus
modifier|*
name|hws
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|bus_dma_segment_t
name|segs
index|[
literal|1
index|]
decl_stmt|;
name|int
name|nsegs
decl_stmt|;
name|rxd
operator|=
operator|&
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_rx_desc
index|[
name|n
index|]
expr_stmt|;
name|hwd
operator|=
operator|&
name|sc
operator|->
name|lpe_rdata
operator|.
name|lpe_rx_ring
index|[
name|n
index|]
expr_stmt|;
name|hws
operator|=
operator|&
name|sc
operator|->
name|lpe_rdata
operator|.
name|lpe_rx_status
index|[
name|n
index|]
expr_stmt|;
name|m
operator|=
name|m_getcl
argument_list|(
name|M_NOWAIT
argument_list|,
name|MT_DATA
argument_list|,
name|M_PKTHDR
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|m
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|lpe_dev
argument_list|,
literal|"WARNING: mbufs exhausted!\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
name|m
operator|->
name|m_len
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|MCLBYTES
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_rx_buf_tag
argument_list|,
name|rxd
operator|->
name|lpe_rxdesc_dmamap
argument_list|)
expr_stmt|;
if|if
condition|(
name|bus_dmamap_load_mbuf_sg
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_rx_buf_tag
argument_list|,
name|rxd
operator|->
name|lpe_rxdesc_dmamap
argument_list|,
name|m
argument_list|,
name|segs
argument_list|,
operator|&
name|nsegs
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
name|bus_dmamap_sync
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_rx_buf_tag
argument_list|,
name|rxd
operator|->
name|lpe_rxdesc_dmamap
argument_list|,
name|BUS_DMASYNC_PREREAD
argument_list|)
expr_stmt|;
name|rxd
operator|->
name|lpe_rxdesc_mbuf
operator|=
name|m
expr_stmt|;
name|hwd
operator|->
name|lhr_data
operator|=
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
operator|+
literal|2
expr_stmt|;
name|hwd
operator|->
name|lhr_control
operator|=
operator|(
name|segs
index|[
literal|0
index|]
operator|.
name|ds_len
operator|-
literal|1
operator|)
operator||
name|LPE_HWDESC_INTERRUPT
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lpe_discard_rxbuf
parameter_list|(
name|struct
name|lpe_softc
modifier|*
name|sc
parameter_list|,
name|int
name|n
parameter_list|)
block|{
name|struct
name|lpe_rxdesc
modifier|*
name|rxd
decl_stmt|;
name|struct
name|lpe_hwdesc
modifier|*
name|hwd
decl_stmt|;
name|rxd
operator|=
operator|&
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_rx_desc
index|[
name|n
index|]
expr_stmt|;
name|hwd
operator|=
operator|&
name|sc
operator|->
name|lpe_rdata
operator|.
name|lpe_rx_ring
index|[
name|n
index|]
expr_stmt|;
name|bus_dmamap_unload
argument_list|(
name|sc
operator|->
name|lpe_cdata
operator|.
name|lpe_rx_buf_tag
argument_list|,
name|rxd
operator|->
name|lpe_rxdesc_dmamap
argument_list|)
expr_stmt|;
name|hwd
operator|->
name|lhr_data
operator|=
literal|0
expr_stmt|;
name|hwd
operator|->
name|lhr_control
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rxd
operator|->
name|lpe_rxdesc_mbuf
condition|)
block|{
name|m_freem
argument_list|(
name|rxd
operator|->
name|lpe_rxdesc_mbuf
argument_list|)
expr_stmt|;
name|rxd
operator|->
name|lpe_rxdesc_mbuf
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|lpe_dmamap_cb
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nseg
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|struct
name|lpe_dmamap_arg
modifier|*
name|ctx
decl_stmt|;
if|if
condition|(
name|error
condition|)
return|return;
name|ctx
operator|=
operator|(
expr|struct
name|lpe_dmamap_arg
operator|*
operator|)
name|arg
expr_stmt|;
name|ctx
operator|->
name|lpe_dma_busaddr
operator|=
name|segs
index|[
literal|0
index|]
operator|.
name|ds_addr
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|lpe_ifmedia_upd
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|lpe_ifmedia_sts
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|ifmediareq
modifier|*
name|ifmr
parameter_list|)
block|{
name|struct
name|lpe_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|mii_data
modifier|*
name|mii
init|=
name|device_get_softc
argument_list|(
name|sc
operator|->
name|lpe_miibus
argument_list|)
decl_stmt|;
name|lpe_lock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|mii_pollstat
argument_list|(
name|mii
argument_list|)
expr_stmt|;
name|ifmr
operator|->
name|ifm_active
operator|=
name|mii
operator|->
name|mii_media_active
expr_stmt|;
name|ifmr
operator|->
name|ifm_status
operator|=
name|mii
operator|->
name|mii_media_status
expr_stmt|;
name|lpe_unlock
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|lpe_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|lpe_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|lpe_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|lpe_detach
argument_list|)
block|,
comment|/* Bus interface */
name|DEVMETHOD
argument_list|(
name|bus_print_child
argument_list|,
name|bus_generic_print_child
argument_list|)
block|,
comment|/* MII interface */
name|DEVMETHOD
argument_list|(
name|miibus_readreg
argument_list|,
name|lpe_miibus_readreg
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|miibus_writereg
argument_list|,
name|lpe_miibus_writereg
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|miibus_statchg
argument_list|,
name|lpe_miibus_statchg
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|lpe_driver
init|=
block|{
literal|"lpe"
block|,
name|lpe_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|lpe_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|lpe_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|lpe
argument_list|,
name|simplebus
argument_list|,
name|lpe_driver
argument_list|,
name|lpe_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|miibus
argument_list|,
name|lpe
argument_list|,
name|miibus_driver
argument_list|,
name|miibus_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|lpe
argument_list|,
name|obio
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|lpe
argument_list|,
name|miibus
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|lpe
argument_list|,
name|ether
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2015 Oleksandr Tymoshenko<gonzo@freebsd.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* * NXP TDA19988 HDMI encoder  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/clock.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<dev/iicbus/iicbus.h>
end_include

begin_include
include|#
directive|include
file|<dev/iicbus/iiconf.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/openfirm.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus_subr.h>
end_include

begin_include
include|#
directive|include
file|<dev/videomode/videomode.h>
end_include

begin_include
include|#
directive|include
file|<dev/videomode/edidvar.h>
end_include

begin_include
include|#
directive|include
file|<arm/ti/am335x/hdmi.h>
end_include

begin_include
include|#
directive|include
file|"iicbus_if.h"
end_include

begin_include
include|#
directive|include
file|"hdmi_if.h"
end_include

begin_define
define|#
directive|define
name|MKREG
parameter_list|(
name|page
parameter_list|,
name|addr
parameter_list|)
value|(((page)<< 8) | (addr))
end_define

begin_define
define|#
directive|define
name|REGPAGE
parameter_list|(
name|reg
parameter_list|)
value|(((reg)>> 8)& 0xff)
end_define

begin_define
define|#
directive|define
name|REGADDR
parameter_list|(
name|reg
parameter_list|)
value|((reg)& 0xff)
end_define

begin_define
define|#
directive|define
name|TDA_VERSION
value|MKREG(0x00, 0x00)
end_define

begin_define
define|#
directive|define
name|TDA_MAIN_CNTRL0
value|MKREG(0x00, 0x01)
end_define

begin_define
define|#
directive|define
name|MAIN_CNTRL0_SR
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|TDA_VERSION_MSB
value|MKREG(0x00, 0x02)
end_define

begin_define
define|#
directive|define
name|TDA_SOFTRESET
value|MKREG(0x00, 0x0a)
end_define

begin_define
define|#
directive|define
name|SOFTRESET_I2C
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|SOFTRESET_AUDIO
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|TDA_DDC_CTRL
value|MKREG(0x00, 0x0b)
end_define

begin_define
define|#
directive|define
name|DDC_ENABLE
value|0
end_define

begin_define
define|#
directive|define
name|TDA_CCLK
value|MKREG(0x00, 0x0c)
end_define

begin_define
define|#
directive|define
name|CCLK_ENABLE
value|1
end_define

begin_define
define|#
directive|define
name|TDA_INT_FLAGS_2
value|MKREG(0x00, 0x11)
end_define

begin_define
define|#
directive|define
name|INT_FLAGS_2_EDID_BLK_RD
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|TDA_VIP_CNTRL_0
value|MKREG(0x00, 0x20)
end_define

begin_define
define|#
directive|define
name|TDA_VIP_CNTRL_1
value|MKREG(0x00, 0x21)
end_define

begin_define
define|#
directive|define
name|TDA_VIP_CNTRL_2
value|MKREG(0x00, 0x22)
end_define

begin_define
define|#
directive|define
name|TDA_VIP_CNTRL_3
value|MKREG(0x00, 0x23)
end_define

begin_define
define|#
directive|define
name|VIP_CNTRL_3_SYNC_HS
value|(2<< 4)
end_define

begin_define
define|#
directive|define
name|VIP_CNTRL_3_V_TGL
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|VIP_CNTRL_3_H_TGL
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|TDA_VIP_CNTRL_4
value|MKREG(0x00, 0x24)
end_define

begin_define
define|#
directive|define
name|VIP_CNTRL_4_BLANKIT_NDE
value|(0<< 2)
end_define

begin_define
define|#
directive|define
name|VIP_CNTRL_4_BLANKIT_HS_VS
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|VIP_CNTRL_4_BLANKIT_NHS_VS
value|(2<< 2)
end_define

begin_define
define|#
directive|define
name|VIP_CNTRL_4_BLANKIT_HE_VE
value|(3<< 2)
end_define

begin_define
define|#
directive|define
name|VIP_CNTRL_4_BLC_NONE
value|(0<< 0)
end_define

begin_define
define|#
directive|define
name|VIP_CNTRL_4_BLC_RGB444
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|VIP_CNTRL_4_BLC_YUV444
value|(2<< 0)
end_define

begin_define
define|#
directive|define
name|VIP_CNTRL_4_BLC_YUV422
value|(3<< 0)
end_define

begin_define
define|#
directive|define
name|TDA_VIP_CNTRL_5
value|MKREG(0x00, 0x25)
end_define

begin_define
define|#
directive|define
name|VIP_CNTRL_5_SP_CNT
parameter_list|(
name|n
parameter_list|)
value|(((n)& 3)<< 1)
end_define

begin_define
define|#
directive|define
name|TDA_MUX_VP_VIP_OUT
value|MKREG(0x00, 0x27)
end_define

begin_define
define|#
directive|define
name|TDA_MAT_CONTRL
value|MKREG(0x00, 0x80)
end_define

begin_define
define|#
directive|define
name|MAT_CONTRL_MAT_BP
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|TDA_VIDFORMAT
value|MKREG(0x00, 0xa0)
end_define

begin_define
define|#
directive|define
name|TDA_REFPIX_MSB
value|MKREG(0x00, 0xa1)
end_define

begin_define
define|#
directive|define
name|TDA_REFPIX_LSB
value|MKREG(0x00, 0xa2)
end_define

begin_define
define|#
directive|define
name|TDA_REFLINE_MSB
value|MKREG(0x00, 0xa3)
end_define

begin_define
define|#
directive|define
name|TDA_REFLINE_LSB
value|MKREG(0x00, 0xa4)
end_define

begin_define
define|#
directive|define
name|TDA_NPIX_MSB
value|MKREG(0x00, 0xa5)
end_define

begin_define
define|#
directive|define
name|TDA_NPIX_LSB
value|MKREG(0x00, 0xa6)
end_define

begin_define
define|#
directive|define
name|TDA_NLINE_MSB
value|MKREG(0x00, 0xa7)
end_define

begin_define
define|#
directive|define
name|TDA_NLINE_LSB
value|MKREG(0x00, 0xa8)
end_define

begin_define
define|#
directive|define
name|TDA_VS_LINE_STRT_1_MSB
value|MKREG(0x00, 0xa9)
end_define

begin_define
define|#
directive|define
name|TDA_VS_LINE_STRT_1_LSB
value|MKREG(0x00, 0xaa)
end_define

begin_define
define|#
directive|define
name|TDA_VS_PIX_STRT_1_MSB
value|MKREG(0x00, 0xab)
end_define

begin_define
define|#
directive|define
name|TDA_VS_PIX_STRT_1_LSB
value|MKREG(0x00, 0xac)
end_define

begin_define
define|#
directive|define
name|TDA_VS_LINE_END_1_MSB
value|MKREG(0x00, 0xad)
end_define

begin_define
define|#
directive|define
name|TDA_VS_LINE_END_1_LSB
value|MKREG(0x00, 0xae)
end_define

begin_define
define|#
directive|define
name|TDA_VS_PIX_END_1_MSB
value|MKREG(0x00, 0xaf)
end_define

begin_define
define|#
directive|define
name|TDA_VS_PIX_END_1_LSB
value|MKREG(0x00, 0xb0)
end_define

begin_define
define|#
directive|define
name|TDA_VS_LINE_STRT_2_MSB
value|MKREG(0x00, 0xb1)
end_define

begin_define
define|#
directive|define
name|TDA_VS_LINE_STRT_2_LSB
value|MKREG(0x00, 0xb2)
end_define

begin_define
define|#
directive|define
name|TDA_VS_PIX_STRT_2_MSB
value|MKREG(0x00, 0xb3)
end_define

begin_define
define|#
directive|define
name|TDA_VS_PIX_STRT_2_LSB
value|MKREG(0x00, 0xb4)
end_define

begin_define
define|#
directive|define
name|TDA_VS_LINE_END_2_MSB
value|MKREG(0x00, 0xb5)
end_define

begin_define
define|#
directive|define
name|TDA_VS_LINE_END_2_LSB
value|MKREG(0x00, 0xb6)
end_define

begin_define
define|#
directive|define
name|TDA_VS_PIX_END_2_MSB
value|MKREG(0x00, 0xb7)
end_define

begin_define
define|#
directive|define
name|TDA_VS_PIX_END_2_LSB
value|MKREG(0x00, 0xb8)
end_define

begin_define
define|#
directive|define
name|TDA_HS_PIX_START_MSB
value|MKREG(0x00, 0xb9)
end_define

begin_define
define|#
directive|define
name|TDA_HS_PIX_START_LSB
value|MKREG(0x00, 0xba)
end_define

begin_define
define|#
directive|define
name|TDA_HS_PIX_STOP_MSB
value|MKREG(0x00, 0xbb)
end_define

begin_define
define|#
directive|define
name|TDA_HS_PIX_STOP_LSB
value|MKREG(0x00, 0xbc)
end_define

begin_define
define|#
directive|define
name|TDA_VWIN_START_1_MSB
value|MKREG(0x00, 0xbd)
end_define

begin_define
define|#
directive|define
name|TDA_VWIN_START_1_LSB
value|MKREG(0x00, 0xbe)
end_define

begin_define
define|#
directive|define
name|TDA_VWIN_END_1_MSB
value|MKREG(0x00, 0xbf)
end_define

begin_define
define|#
directive|define
name|TDA_VWIN_END_1_LSB
value|MKREG(0x00, 0xc0)
end_define

begin_define
define|#
directive|define
name|TDA_VWIN_START_2_MSB
value|MKREG(0x00, 0xc1)
end_define

begin_define
define|#
directive|define
name|TDA_VWIN_START_2_LSB
value|MKREG(0x00, 0xc2)
end_define

begin_define
define|#
directive|define
name|TDA_VWIN_END_2_MSB
value|MKREG(0x00, 0xc3)
end_define

begin_define
define|#
directive|define
name|TDA_VWIN_END_2_LSB
value|MKREG(0x00, 0xc4)
end_define

begin_define
define|#
directive|define
name|TDA_DE_START_MSB
value|MKREG(0x00, 0xc5)
end_define

begin_define
define|#
directive|define
name|TDA_DE_START_LSB
value|MKREG(0x00, 0xc6)
end_define

begin_define
define|#
directive|define
name|TDA_DE_STOP_MSB
value|MKREG(0x00, 0xc7)
end_define

begin_define
define|#
directive|define
name|TDA_DE_STOP_LSB
value|MKREG(0x00, 0xc8)
end_define

begin_define
define|#
directive|define
name|TDA_TBG_CNTRL_0
value|MKREG(0x00, 0xca)
end_define

begin_define
define|#
directive|define
name|TBG_CNTRL_0_SYNC_ONCE
value|(1<< 7)
end_define

begin_define
define|#
directive|define
name|TBG_CNTRL_0_SYNC_MTHD
value|(1<< 6)
end_define

begin_define
define|#
directive|define
name|TDA_TBG_CNTRL_1
value|MKREG(0x00, 0xcb)
end_define

begin_define
define|#
directive|define
name|TBG_CNTRL_1_DWIN_DIS
value|(1<< 6)
end_define

begin_define
define|#
directive|define
name|TBG_CNTRL_1_TGL_EN
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|TBG_CNTRL_1_V_TGL
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|TBG_CNTRL_1_H_TGL
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|TDA_HVF_CNTRL_0
value|MKREG(0x00, 0xe4)
end_define

begin_define
define|#
directive|define
name|HVF_CNTRL_0_PREFIL_NONE
value|(0<< 2)
end_define

begin_define
define|#
directive|define
name|HVF_CNTRL_0_INTPOL_BYPASS
value|(0<< 0)
end_define

begin_define
define|#
directive|define
name|TDA_HVF_CNTRL_1
value|MKREG(0x00, 0xe5)
end_define

begin_define
define|#
directive|define
name|HVF_CNTRL_1_VQR
parameter_list|(
name|x
parameter_list|)
value|(((x)& 3)<< 2)
end_define

begin_define
define|#
directive|define
name|HVF_CNTRL_1_VQR_FULL
value|HVF_CNTRL_1_VQR(0)
end_define

begin_define
define|#
directive|define
name|TDA_ENABLE_SPACE
value|MKREG(0x00, 0xd6)
end_define

begin_define
define|#
directive|define
name|TDA_RPT_CNTRL
value|MKREG(0x00, 0xf0)
end_define

begin_define
define|#
directive|define
name|TDA_PLL_SERIAL_1
value|MKREG(0x02, 0x00)
end_define

begin_define
define|#
directive|define
name|PLL_SERIAL_1_SRL_MAN_IP
value|(1<< 6)
end_define

begin_define
define|#
directive|define
name|TDA_PLL_SERIAL_2
value|MKREG(0x02, 0x01)
end_define

begin_define
define|#
directive|define
name|PLL_SERIAL_2_SRL_PR
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0xf)<< 4)
end_define

begin_define
define|#
directive|define
name|PLL_SERIAL_2_SRL_NOSC
parameter_list|(
name|x
parameter_list|)
value|(((x)& 0x3)<< 0)
end_define

begin_define
define|#
directive|define
name|TDA_PLL_SERIAL_3
value|MKREG(0x02, 0x02)
end_define

begin_define
define|#
directive|define
name|PLL_SERIAL_3_SRL_PXIN_SEL
value|(1<< 4)
end_define

begin_define
define|#
directive|define
name|PLL_SERIAL_3_SRL_DE
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|PLL_SERIAL_3_SRL_CCIR
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|TDA_SERIALIZER
value|MKREG(0x02, 0x03)
end_define

begin_define
define|#
directive|define
name|TDA_BUFFER_OUT
value|MKREG(0x02, 0x04)
end_define

begin_define
define|#
directive|define
name|TDA_PLL_SCG1
value|MKREG(0x02, 0x05)
end_define

begin_define
define|#
directive|define
name|TDA_PLL_SCG2
value|MKREG(0x02, 0x06)
end_define

begin_define
define|#
directive|define
name|TDA_PLL_SCGN1
value|MKREG(0x02, 0x07)
end_define

begin_define
define|#
directive|define
name|TDA_PLL_SCGN2
value|MKREG(0x02, 0x08)
end_define

begin_define
define|#
directive|define
name|TDA_PLL_SCGR1
value|MKREG(0x02, 0x09)
end_define

begin_define
define|#
directive|define
name|TDA_PLL_SCGR2
value|MKREG(0x02, 0x0a)
end_define

begin_define
define|#
directive|define
name|TDA_SEL_CLK
value|MKREG(0x02, 0x11)
end_define

begin_define
define|#
directive|define
name|SEL_CLK_ENA_SC_CLK
value|(1<< 3)
end_define

begin_define
define|#
directive|define
name|SEL_CLK_SEL_VRF_CLK
parameter_list|(
name|x
parameter_list|)
value|(((x)& 3)<< 1)
end_define

begin_define
define|#
directive|define
name|SEL_CLK_SEL_CLK1
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|TDA_ANA_GENERAL
value|MKREG(0x02, 0x12)
end_define

begin_define
define|#
directive|define
name|TDA_EDID_DATA0
value|MKREG(0x09, 0x00)
end_define

begin_define
define|#
directive|define
name|TDA_EDID_CTRL
value|MKREG(0x09, 0xfa)
end_define

begin_define
define|#
directive|define
name|TDA_DDC_ADDR
value|MKREG(0x09, 0xfb)
end_define

begin_define
define|#
directive|define
name|TDA_DDC_OFFS
value|MKREG(0x09, 0xfc)
end_define

begin_define
define|#
directive|define
name|TDA_DDC_SEGM_ADDR
value|MKREG(0x09, 0xfd)
end_define

begin_define
define|#
directive|define
name|TDA_DDC_SEGM
value|MKREG(0x09, 0xfe)
end_define

begin_define
define|#
directive|define
name|TDA_IF_VSP
value|MKREG(0x10, 0x20)
end_define

begin_define
define|#
directive|define
name|TDA_IF_AVI
value|MKREG(0x10, 0x40)
end_define

begin_define
define|#
directive|define
name|TDA_IF_SPD
value|MKREG(0x10, 0x60)
end_define

begin_define
define|#
directive|define
name|TDA_IF_AUD
value|MKREG(0x10, 0x80)
end_define

begin_define
define|#
directive|define
name|TDA_IF_MPS
value|MKREG(0x10, 0xa0)
end_define

begin_define
define|#
directive|define
name|TDA_ENC_CNTRL
value|MKREG(0x11, 0x0d)
end_define

begin_define
define|#
directive|define
name|ENC_CNTRL_DVI_MODE
value|(0<< 2)
end_define

begin_define
define|#
directive|define
name|ENC_CNTRL_HDMI_MODE
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|TDA_DIP_IF_FLAGS
value|MKREG(0x11, 0x0f)
end_define

begin_define
define|#
directive|define
name|DIP_IF_FLAGS_IF5
value|(1<< 5)
end_define

begin_define
define|#
directive|define
name|DIP_IF_FLAGS_IF4
value|(1<< 4)
end_define

begin_define
define|#
directive|define
name|DIP_IF_FLAGS_IF3
value|(1<< 3)
end_define

begin_define
define|#
directive|define
name|DIP_IF_FLAGS_IF2
value|(1<< 2)
end_define

begin_comment
comment|/* AVI IF on page 10h */
end_comment

begin_define
define|#
directive|define
name|DIP_IF_FLAGS_IF1
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|TDA_TX3
value|MKREG(0x12, 0x9a)
end_define

begin_define
define|#
directive|define
name|TDA_TX4
value|MKREG(0x12, 0x9b)
end_define

begin_define
define|#
directive|define
name|TX4_PD_RAM
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|TDA_HDCP_TX33
value|MKREG(0x12, 0xb8)
end_define

begin_define
define|#
directive|define
name|HDCP_TX33_HDMI
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|TDA_CURPAGE_ADDR
value|0xff
end_define

begin_define
define|#
directive|define
name|TDA_CEC_ENAMODS
value|0xff
end_define

begin_define
define|#
directive|define
name|ENAMODS_RXSENS
value|(1<< 2)
end_define

begin_define
define|#
directive|define
name|ENAMODS_HDMI
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|TDA_CEC_FRO_IM_CLK_CTRL
value|0xfb
end_define

begin_define
define|#
directive|define
name|CEC_FRO_IM_CLK_CTRL_GHOST_DIS
value|(1<< 7)
end_define

begin_define
define|#
directive|define
name|CEC_FRO_IM_CLK_CTRL_IMCLK_SEL
value|(1<< 1)
end_define

begin_comment
comment|/* EDID reading */
end_comment

begin_define
define|#
directive|define
name|EDID_LENGTH
value|0x80
end_define

begin_define
define|#
directive|define
name|MAX_READ_ATTEMPTS
value|100
end_define

begin_comment
comment|/* EDID fields */
end_comment

begin_define
define|#
directive|define
name|EDID_MODES0
value|35
end_define

begin_define
define|#
directive|define
name|EDID_MODES1
value|36
end_define

begin_define
define|#
directive|define
name|EDID_TIMING_START
value|38
end_define

begin_define
define|#
directive|define
name|EDID_TIMING_END
value|54
end_define

begin_define
define|#
directive|define
name|EDID_TIMING_X
parameter_list|(
name|v
parameter_list|)
value|(((v) + 31) * 8)
end_define

begin_define
define|#
directive|define
name|EDID_FREQ
parameter_list|(
name|v
parameter_list|)
value|(((v)& 0x3f) + 60)
end_define

begin_define
define|#
directive|define
name|EDID_RATIO
parameter_list|(
name|v
parameter_list|)
value|(((v)>> 6)& 0x3)
end_define

begin_define
define|#
directive|define
name|EDID_RATIO_10x16
value|0
end_define

begin_define
define|#
directive|define
name|EDID_RATIO_3x4
value|1
end_define

begin_define
define|#
directive|define
name|EDID_RATIO_4x5
value|2
end_define

begin_define
define|#
directive|define
name|EDID_RATIO_9x16
value|3
end_define

begin_define
define|#
directive|define
name|TDA19988
value|0x0301
end_define

begin_struct
struct|struct
name|tda19988_softc
block|{
name|device_t
name|sc_dev
decl_stmt|;
name|uint32_t
name|sc_addr
decl_stmt|;
name|uint32_t
name|sc_cec_addr
decl_stmt|;
name|uint16_t
name|sc_version
decl_stmt|;
name|struct
name|intr_config_hook
name|enum_hook
decl_stmt|;
name|int
name|sc_current_page
decl_stmt|;
name|uint8_t
modifier|*
name|sc_edid
decl_stmt|;
name|uint32_t
name|sc_edid_len
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|tda19988_set_page
parameter_list|(
name|struct
name|tda19988_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|page
parameter_list|)
block|{
name|uint8_t
name|addr
init|=
name|TDA_CURPAGE_ADDR
decl_stmt|;
name|uint8_t
name|cmd
index|[
literal|2
index|]
decl_stmt|;
name|int
name|result
decl_stmt|;
name|struct
name|iic_msg
name|msg
index|[]
init|=
block|{
block|{
name|sc
operator|->
name|sc_addr
block|,
name|IIC_M_WR
block|,
literal|2
block|,
name|cmd
block|}
block|, 	}
decl_stmt|;
name|cmd
index|[
literal|0
index|]
operator|=
name|addr
expr_stmt|;
name|cmd
index|[
literal|1
index|]
operator|=
name|page
expr_stmt|;
name|result
operator|=
operator|(
name|iicbus_transfer
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|msg
argument_list|,
literal|1
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|result
condition|)
name|printf
argument_list|(
literal|"tda19988_set_page failed: %d\n"
argument_list|,
name|result
argument_list|)
expr_stmt|;
else|else
name|sc
operator|->
name|sc_current_page
operator|=
name|page
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tda19988_cec_read
parameter_list|(
name|struct
name|tda19988_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|addr
parameter_list|,
name|uint8_t
modifier|*
name|data
parameter_list|)
block|{
name|int
name|result
decl_stmt|;
name|struct
name|iic_msg
name|msg
index|[]
init|=
block|{
block|{
name|sc
operator|->
name|sc_cec_addr
block|,
name|IIC_M_WR
block|,
literal|1
block|,
operator|&
name|addr
block|}
block|,
block|{
name|sc
operator|->
name|sc_cec_addr
block|,
name|IIC_M_RD
block|,
literal|1
block|,
name|data
block|}
block|, 	}
decl_stmt|;
name|result
operator|=
name|iicbus_transfer
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|msg
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
condition|)
name|printf
argument_list|(
literal|"tda19988_cec_read failed: %d\n"
argument_list|,
name|result
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tda19988_cec_write
parameter_list|(
name|struct
name|tda19988_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
name|address
parameter_list|,
name|uint8_t
name|data
parameter_list|)
block|{
name|uint8_t
name|cmd
index|[
literal|2
index|]
decl_stmt|;
name|int
name|result
decl_stmt|;
name|struct
name|iic_msg
name|msg
index|[]
init|=
block|{
block|{
name|sc
operator|->
name|sc_cec_addr
block|,
name|IIC_M_WR
block|,
literal|2
block|,
name|cmd
block|}
block|, 	}
decl_stmt|;
name|cmd
index|[
literal|0
index|]
operator|=
name|address
expr_stmt|;
name|cmd
index|[
literal|1
index|]
operator|=
name|data
expr_stmt|;
name|result
operator|=
name|iicbus_transfer
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
condition|)
name|printf
argument_list|(
literal|"tda19988_cec_write failed: %d\n"
argument_list|,
name|result
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tda19988_block_read
parameter_list|(
name|struct
name|tda19988_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|,
name|uint8_t
modifier|*
name|data
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|uint8_t
name|reg
decl_stmt|;
name|int
name|result
decl_stmt|;
name|struct
name|iic_msg
name|msg
index|[]
init|=
block|{
block|{
name|sc
operator|->
name|sc_addr
block|,
name|IIC_M_WR
block|,
literal|1
block|,
operator|&
name|reg
block|}
block|,
block|{
name|sc
operator|->
name|sc_addr
block|,
name|IIC_M_RD
block|,
name|len
block|,
name|data
block|}
block|, 	}
decl_stmt|;
name|reg
operator|=
name|REGADDR
argument_list|(
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_current_page
operator|!=
name|REGPAGE
argument_list|(
name|addr
argument_list|)
condition|)
name|tda19988_set_page
argument_list|(
name|sc
argument_list|,
name|REGPAGE
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
operator|(
name|iicbus_transfer
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|msg
argument_list|,
literal|2
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|result
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"tda19988_block_read failed: %d\n"
argument_list|,
name|result
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tda19988_reg_read
parameter_list|(
name|struct
name|tda19988_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|,
name|uint8_t
modifier|*
name|data
parameter_list|)
block|{
name|uint8_t
name|reg
decl_stmt|;
name|int
name|result
decl_stmt|;
name|struct
name|iic_msg
name|msg
index|[]
init|=
block|{
block|{
name|sc
operator|->
name|sc_addr
block|,
name|IIC_M_WR
block|,
literal|1
block|,
operator|&
name|reg
block|}
block|,
block|{
name|sc
operator|->
name|sc_addr
block|,
name|IIC_M_RD
block|,
literal|1
block|,
name|data
block|}
block|, 	}
decl_stmt|;
name|reg
operator|=
name|REGADDR
argument_list|(
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_current_page
operator|!=
name|REGPAGE
argument_list|(
name|addr
argument_list|)
condition|)
name|tda19988_set_page
argument_list|(
name|sc
argument_list|,
name|REGPAGE
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
operator|(
name|iicbus_transfer
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|msg
argument_list|,
literal|2
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
name|result
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"tda19988_reg_read failed: %d\n"
argument_list|,
name|result
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tda19988_reg_write
parameter_list|(
name|struct
name|tda19988_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|address
parameter_list|,
name|uint8_t
name|data
parameter_list|)
block|{
name|uint8_t
name|cmd
index|[
literal|2
index|]
decl_stmt|;
name|int
name|result
decl_stmt|;
name|struct
name|iic_msg
name|msg
index|[]
init|=
block|{
block|{
name|sc
operator|->
name|sc_addr
block|,
name|IIC_M_WR
block|,
literal|2
block|,
name|cmd
block|}
block|, 	}
decl_stmt|;
name|cmd
index|[
literal|0
index|]
operator|=
name|REGADDR
argument_list|(
name|address
argument_list|)
expr_stmt|;
name|cmd
index|[
literal|1
index|]
operator|=
name|data
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_current_page
operator|!=
name|REGPAGE
argument_list|(
name|address
argument_list|)
condition|)
name|tda19988_set_page
argument_list|(
name|sc
argument_list|,
name|REGPAGE
argument_list|(
name|address
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|iicbus_transfer
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"tda19988_reg_write failed: %d\n"
argument_list|,
name|result
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tda19988_reg_write2
parameter_list|(
name|struct
name|tda19988_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|address
parameter_list|,
name|uint16_t
name|data
parameter_list|)
block|{
name|uint8_t
name|cmd
index|[
literal|3
index|]
decl_stmt|;
name|int
name|result
decl_stmt|;
name|struct
name|iic_msg
name|msg
index|[]
init|=
block|{
block|{
name|sc
operator|->
name|sc_addr
block|,
name|IIC_M_WR
block|,
literal|3
block|,
name|cmd
block|}
block|, 	}
decl_stmt|;
name|cmd
index|[
literal|0
index|]
operator|=
name|REGADDR
argument_list|(
name|address
argument_list|)
expr_stmt|;
name|cmd
index|[
literal|1
index|]
operator|=
operator|(
name|data
operator|>>
literal|8
operator|)
expr_stmt|;
name|cmd
index|[
literal|2
index|]
operator|=
operator|(
name|data
operator|&
literal|0xff
operator|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_current_page
operator|!=
name|REGPAGE
argument_list|(
name|address
argument_list|)
condition|)
name|tda19988_set_page
argument_list|(
name|sc
argument_list|,
name|REGPAGE
argument_list|(
name|address
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|=
name|iicbus_transfer
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|sc_dev
argument_list|,
literal|"tda19988_reg_write2 failed: %d\n"
argument_list|,
name|result
argument_list|)
expr_stmt|;
return|return
operator|(
name|result
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|tda19988_reg_set
parameter_list|(
name|struct
name|tda19988_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|,
name|uint8_t
name|flags
parameter_list|)
block|{
name|uint8_t
name|data
decl_stmt|;
name|tda19988_reg_read
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|data
operator||=
name|flags
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|tda19988_reg_clear
parameter_list|(
name|struct
name|tda19988_softc
modifier|*
name|sc
parameter_list|,
name|uint16_t
name|addr
parameter_list|,
name|uint8_t
name|flags
parameter_list|)
block|{
name|uint8_t
name|data
decl_stmt|;
name|tda19988_reg_read
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|data
operator|&=
operator|~
name|flags
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|addr
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|tda19988_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
operator|!
name|ofw_bus_is_compatible
argument_list|(
name|dev
argument_list|,
literal|"nxp,tda998x"
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|tda19988_init_encoder
parameter_list|(
name|struct
name|tda19988_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|struct
name|videomode
modifier|*
name|mode
parameter_list|)
block|{
name|uint16_t
name|ref_pix
decl_stmt|,
name|ref_line
decl_stmt|,
name|n_pix
decl_stmt|,
name|n_line
decl_stmt|;
name|uint16_t
name|hs_pix_start
decl_stmt|,
name|hs_pix_stop
decl_stmt|;
name|uint16_t
name|vs1_pix_start
decl_stmt|,
name|vs1_pix_stop
decl_stmt|;
name|uint16_t
name|vs1_line_start
decl_stmt|,
name|vs1_line_end
decl_stmt|;
name|uint16_t
name|vs2_pix_start
decl_stmt|,
name|vs2_pix_stop
decl_stmt|;
name|uint16_t
name|vs2_line_start
decl_stmt|,
name|vs2_line_end
decl_stmt|;
name|uint16_t
name|vwin1_line_start
decl_stmt|,
name|vwin1_line_end
decl_stmt|;
name|uint16_t
name|vwin2_line_start
decl_stmt|,
name|vwin2_line_end
decl_stmt|;
name|uint16_t
name|de_start
decl_stmt|,
name|de_stop
decl_stmt|;
name|uint8_t
name|reg
decl_stmt|,
name|div
decl_stmt|;
name|n_pix
operator|=
name|mode
operator|->
name|htotal
expr_stmt|;
name|n_line
operator|=
name|mode
operator|->
name|vtotal
expr_stmt|;
name|hs_pix_stop
operator|=
name|mode
operator|->
name|hsync_end
operator|-
name|mode
operator|->
name|hdisplay
expr_stmt|;
name|hs_pix_start
operator|=
name|mode
operator|->
name|hsync_start
operator|-
name|mode
operator|->
name|hdisplay
expr_stmt|;
name|de_stop
operator|=
name|mode
operator|->
name|htotal
expr_stmt|;
name|de_start
operator|=
name|mode
operator|->
name|htotal
operator|-
name|mode
operator|->
name|hdisplay
expr_stmt|;
name|ref_pix
operator|=
name|hs_pix_start
operator|+
literal|3
expr_stmt|;
if|if
condition|(
name|mode
operator|->
name|flags
operator|&
name|VID_HSKEW
condition|)
name|ref_pix
operator|+=
name|mode
operator|->
name|hskew
expr_stmt|;
if|if
condition|(
operator|(
name|mode
operator|->
name|flags
operator|&
name|VID_INTERLACE
operator|)
operator|==
literal|0
condition|)
block|{
name|ref_line
operator|=
literal|1
operator|+
name|mode
operator|->
name|vsync_start
operator|-
name|mode
operator|->
name|vdisplay
expr_stmt|;
name|vwin1_line_start
operator|=
name|mode
operator|->
name|vtotal
operator|-
name|mode
operator|->
name|vdisplay
operator|-
literal|1
expr_stmt|;
name|vwin1_line_end
operator|=
name|vwin1_line_start
operator|+
name|mode
operator|->
name|vdisplay
expr_stmt|;
name|vs1_pix_start
operator|=
name|vs1_pix_stop
operator|=
name|hs_pix_start
expr_stmt|;
name|vs1_line_start
operator|=
name|mode
operator|->
name|vsync_start
operator|-
name|mode
operator|->
name|vdisplay
expr_stmt|;
name|vs1_line_end
operator|=
name|vs1_line_start
operator|+
name|mode
operator|->
name|vsync_end
operator|-
name|mode
operator|->
name|vsync_start
expr_stmt|;
name|vwin2_line_start
operator|=
name|vwin2_line_end
operator|=
literal|0
expr_stmt|;
name|vs2_pix_start
operator|=
name|vs2_pix_stop
operator|=
literal|0
expr_stmt|;
name|vs2_line_start
operator|=
name|vs2_line_end
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|ref_line
operator|=
literal|1
operator|+
operator|(
name|mode
operator|->
name|vsync_start
operator|-
name|mode
operator|->
name|vdisplay
operator|)
operator|/
literal|2
expr_stmt|;
name|vwin1_line_start
operator|=
operator|(
name|mode
operator|->
name|vtotal
operator|-
name|mode
operator|->
name|vdisplay
operator|)
operator|/
literal|2
expr_stmt|;
name|vwin1_line_end
operator|=
name|vwin1_line_start
operator|+
name|mode
operator|->
name|vdisplay
operator|/
literal|2
expr_stmt|;
name|vs1_pix_start
operator|=
name|vs1_pix_stop
operator|=
name|hs_pix_start
expr_stmt|;
name|vs1_line_start
operator|=
operator|(
name|mode
operator|->
name|vsync_start
operator|-
name|mode
operator|->
name|vdisplay
operator|)
operator|/
literal|2
expr_stmt|;
name|vs1_line_end
operator|=
name|vs1_line_start
operator|+
operator|(
name|mode
operator|->
name|vsync_end
operator|-
name|mode
operator|->
name|vsync_start
operator|)
operator|/
literal|2
expr_stmt|;
name|vwin2_line_start
operator|=
name|vwin1_line_start
operator|+
name|mode
operator|->
name|vtotal
operator|/
literal|2
expr_stmt|;
name|vwin2_line_end
operator|=
name|vwin2_line_start
operator|+
name|mode
operator|->
name|vdisplay
operator|/
literal|2
expr_stmt|;
name|vs2_pix_start
operator|=
name|vs2_pix_stop
operator|=
name|hs_pix_start
operator|+
name|mode
operator|->
name|htotal
operator|/
literal|2
expr_stmt|;
name|vs2_line_start
operator|=
name|vs1_line_start
operator|+
name|mode
operator|->
name|vtotal
operator|/
literal|2
expr_stmt|;
name|vs2_line_end
operator|=
name|vs2_line_start
operator|+
operator|(
name|mode
operator|->
name|vsync_end
operator|-
name|mode
operator|->
name|vsync_start
operator|)
operator|/
literal|2
expr_stmt|;
block|}
name|div
operator|=
literal|148500
operator|/
name|mode
operator|->
name|dot_clock
expr_stmt|;
if|if
condition|(
name|div
operator|!=
literal|0
condition|)
block|{
name|div
operator|--
expr_stmt|;
if|if
condition|(
name|div
operator|>
literal|3
condition|)
name|div
operator|=
literal|3
expr_stmt|;
block|}
comment|/* set HDMI HDCP mode off */
name|tda19988_reg_set
argument_list|(
name|sc
argument_list|,
name|TDA_TBG_CNTRL_1
argument_list|,
name|TBG_CNTRL_1_DWIN_DIS
argument_list|)
expr_stmt|;
name|tda19988_reg_clear
argument_list|(
name|sc
argument_list|,
name|TDA_HDCP_TX33
argument_list|,
name|HDCP_TX33_HDMI
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_ENC_CNTRL
argument_list|,
name|ENC_CNTRL_DVI_MODE
argument_list|)
expr_stmt|;
comment|/* no pre-filter or interpolator */
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_HVF_CNTRL_0
argument_list|,
name|HVF_CNTRL_0_INTPOL_BYPASS
operator||
name|HVF_CNTRL_0_PREFIL_NONE
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_VIP_CNTRL_5
argument_list|,
name|VIP_CNTRL_5_SP_CNT
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_VIP_CNTRL_4
argument_list|,
name|VIP_CNTRL_4_BLANKIT_NDE
operator||
name|VIP_CNTRL_4_BLC_NONE
argument_list|)
expr_stmt|;
name|tda19988_reg_clear
argument_list|(
name|sc
argument_list|,
name|TDA_PLL_SERIAL_3
argument_list|,
name|PLL_SERIAL_3_SRL_CCIR
argument_list|)
expr_stmt|;
name|tda19988_reg_clear
argument_list|(
name|sc
argument_list|,
name|TDA_PLL_SERIAL_1
argument_list|,
name|PLL_SERIAL_1_SRL_MAN_IP
argument_list|)
expr_stmt|;
name|tda19988_reg_clear
argument_list|(
name|sc
argument_list|,
name|TDA_PLL_SERIAL_3
argument_list|,
name|PLL_SERIAL_3_SRL_DE
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_SERIALIZER
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_HVF_CNTRL_1
argument_list|,
name|HVF_CNTRL_1_VQR_FULL
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_RPT_CNTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_SEL_CLK
argument_list|,
name|SEL_CLK_SEL_VRF_CLK
argument_list|(
literal|0
argument_list|)
operator||
name|SEL_CLK_SEL_CLK1
operator||
name|SEL_CLK_ENA_SC_CLK
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_PLL_SERIAL_2
argument_list|,
name|PLL_SERIAL_2_SRL_NOSC
argument_list|(
name|div
argument_list|)
operator||
name|PLL_SERIAL_2_SRL_PR
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|tda19988_reg_set
argument_list|(
name|sc
argument_list|,
name|TDA_MAT_CONTRL
argument_list|,
name|MAT_CONTRL_MAT_BP
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_ANA_GENERAL
argument_list|,
literal|0x09
argument_list|)
expr_stmt|;
name|tda19988_reg_clear
argument_list|(
name|sc
argument_list|,
name|TDA_TBG_CNTRL_0
argument_list|,
name|TBG_CNTRL_0_SYNC_MTHD
argument_list|)
expr_stmt|;
comment|/* 	 * Sync on rising HSYNC/VSYNC 	 */
name|reg
operator|=
name|VIP_CNTRL_3_SYNC_HS
expr_stmt|;
if|if
condition|(
name|mode
operator|->
name|flags
operator|&
name|VID_NHSYNC
condition|)
name|reg
operator||=
name|VIP_CNTRL_3_H_TGL
expr_stmt|;
if|if
condition|(
name|mode
operator|->
name|flags
operator|&
name|VID_NVSYNC
condition|)
name|reg
operator||=
name|VIP_CNTRL_3_V_TGL
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_VIP_CNTRL_3
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|TBG_CNTRL_1_TGL_EN
expr_stmt|;
if|if
condition|(
name|mode
operator|->
name|flags
operator|&
name|VID_NHSYNC
condition|)
name|reg
operator||=
name|TBG_CNTRL_1_H_TGL
expr_stmt|;
if|if
condition|(
name|mode
operator|->
name|flags
operator|&
name|VID_NVSYNC
condition|)
name|reg
operator||=
name|TBG_CNTRL_1_V_TGL
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_TBG_CNTRL_1
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Program timing */
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_VIDFORMAT
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|tda19988_reg_write2
argument_list|(
name|sc
argument_list|,
name|TDA_REFPIX_MSB
argument_list|,
name|ref_pix
argument_list|)
expr_stmt|;
name|tda19988_reg_write2
argument_list|(
name|sc
argument_list|,
name|TDA_REFLINE_MSB
argument_list|,
name|ref_line
argument_list|)
expr_stmt|;
name|tda19988_reg_write2
argument_list|(
name|sc
argument_list|,
name|TDA_NPIX_MSB
argument_list|,
name|n_pix
argument_list|)
expr_stmt|;
name|tda19988_reg_write2
argument_list|(
name|sc
argument_list|,
name|TDA_NLINE_MSB
argument_list|,
name|n_line
argument_list|)
expr_stmt|;
name|tda19988_reg_write2
argument_list|(
name|sc
argument_list|,
name|TDA_VS_LINE_STRT_1_MSB
argument_list|,
name|vs1_line_start
argument_list|)
expr_stmt|;
name|tda19988_reg_write2
argument_list|(
name|sc
argument_list|,
name|TDA_VS_PIX_STRT_1_MSB
argument_list|,
name|vs1_pix_start
argument_list|)
expr_stmt|;
name|tda19988_reg_write2
argument_list|(
name|sc
argument_list|,
name|TDA_VS_LINE_END_1_MSB
argument_list|,
name|vs1_line_end
argument_list|)
expr_stmt|;
name|tda19988_reg_write2
argument_list|(
name|sc
argument_list|,
name|TDA_VS_PIX_END_1_MSB
argument_list|,
name|vs1_pix_stop
argument_list|)
expr_stmt|;
name|tda19988_reg_write2
argument_list|(
name|sc
argument_list|,
name|TDA_VS_LINE_STRT_2_MSB
argument_list|,
name|vs2_line_start
argument_list|)
expr_stmt|;
name|tda19988_reg_write2
argument_list|(
name|sc
argument_list|,
name|TDA_VS_PIX_STRT_2_MSB
argument_list|,
name|vs2_pix_start
argument_list|)
expr_stmt|;
name|tda19988_reg_write2
argument_list|(
name|sc
argument_list|,
name|TDA_VS_LINE_END_2_MSB
argument_list|,
name|vs2_line_end
argument_list|)
expr_stmt|;
name|tda19988_reg_write2
argument_list|(
name|sc
argument_list|,
name|TDA_VS_PIX_END_2_MSB
argument_list|,
name|vs2_pix_stop
argument_list|)
expr_stmt|;
name|tda19988_reg_write2
argument_list|(
name|sc
argument_list|,
name|TDA_HS_PIX_START_MSB
argument_list|,
name|hs_pix_start
argument_list|)
expr_stmt|;
name|tda19988_reg_write2
argument_list|(
name|sc
argument_list|,
name|TDA_HS_PIX_STOP_MSB
argument_list|,
name|hs_pix_stop
argument_list|)
expr_stmt|;
name|tda19988_reg_write2
argument_list|(
name|sc
argument_list|,
name|TDA_VWIN_START_1_MSB
argument_list|,
name|vwin1_line_start
argument_list|)
expr_stmt|;
name|tda19988_reg_write2
argument_list|(
name|sc
argument_list|,
name|TDA_VWIN_END_1_MSB
argument_list|,
name|vwin1_line_end
argument_list|)
expr_stmt|;
name|tda19988_reg_write2
argument_list|(
name|sc
argument_list|,
name|TDA_VWIN_START_2_MSB
argument_list|,
name|vwin2_line_start
argument_list|)
expr_stmt|;
name|tda19988_reg_write2
argument_list|(
name|sc
argument_list|,
name|TDA_VWIN_END_2_MSB
argument_list|,
name|vwin2_line_end
argument_list|)
expr_stmt|;
name|tda19988_reg_write2
argument_list|(
name|sc
argument_list|,
name|TDA_DE_START_MSB
argument_list|,
name|de_start
argument_list|)
expr_stmt|;
name|tda19988_reg_write2
argument_list|(
name|sc
argument_list|,
name|TDA_DE_STOP_MSB
argument_list|,
name|de_stop
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_version
operator|==
name|TDA19988
condition|)
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_ENABLE_SPACE
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|/* must be last register set */
name|tda19988_reg_clear
argument_list|(
name|sc
argument_list|,
name|TDA_TBG_CNTRL_0
argument_list|,
name|TBG_CNTRL_0_SYNC_ONCE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|tda19988_read_edid_block
parameter_list|(
name|struct
name|tda19988_softc
modifier|*
name|sc
parameter_list|,
name|uint8_t
modifier|*
name|buf
parameter_list|,
name|int
name|block
parameter_list|)
block|{
name|int
name|attempt
decl_stmt|,
name|err
decl_stmt|;
name|uint8_t
name|data
decl_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
name|tda19988_reg_set
argument_list|(
name|sc
argument_list|,
name|TDA_INT_FLAGS_2
argument_list|,
name|INT_FLAGS_2_EDID_BLK_RD
argument_list|)
expr_stmt|;
comment|/* Block 0 */
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_DDC_ADDR
argument_list|,
literal|0xa0
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_DDC_OFFS
argument_list|,
operator|(
name|block
operator|%
literal|2
operator|)
condition|?
literal|128
else|:
literal|0
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_DDC_SEGM_ADDR
argument_list|,
literal|0x60
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_DDC_SEGM
argument_list|,
name|block
operator|/
literal|2
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_EDID_CTRL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_EDID_CTRL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|data
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|attempt
operator|=
literal|0
init|;
name|attempt
operator|<
name|MAX_READ_ATTEMPTS
condition|;
name|attempt
operator|++
control|)
block|{
name|tda19988_reg_read
argument_list|(
name|sc
argument_list|,
name|TDA_INT_FLAGS_2
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|&
name|INT_FLAGS_2_EDID_BLK_RD
condition|)
break|break;
name|pause
argument_list|(
literal|"EDID"
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|attempt
operator|==
name|MAX_READ_ATTEMPTS
condition|)
block|{
name|err
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|tda19988_block_read
argument_list|(
name|sc
argument_list|,
name|TDA_EDID_DATA0
argument_list|,
name|buf
argument_list|,
name|EDID_LENGTH
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|err
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|done
label|:
name|tda19988_reg_clear
argument_list|(
name|sc
argument_list|,
name|TDA_INT_FLAGS_2
argument_list|,
name|INT_FLAGS_2_EDID_BLK_RD
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tda19988_read_edid
parameter_list|(
name|struct
name|tda19988_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|int
name|blocks
decl_stmt|,
name|i
decl_stmt|;
name|uint8_t
modifier|*
name|buf
decl_stmt|;
name|err
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_version
operator|==
name|TDA19988
condition|)
name|tda19988_reg_clear
argument_list|(
name|sc
argument_list|,
name|TDA_TX4
argument_list|,
name|TX4_PD_RAM
argument_list|)
expr_stmt|;
name|err
operator|=
name|tda19988_read_edid_block
argument_list|(
name|sc
argument_list|,
name|sc
operator|->
name|sc_edid
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|done
goto|;
name|blocks
operator|=
name|sc
operator|->
name|sc_edid
index|[
literal|0x7e
index|]
expr_stmt|;
if|if
condition|(
name|blocks
operator|>
literal|0
condition|)
block|{
name|sc
operator|->
name|sc_edid
operator|=
name|realloc
argument_list|(
name|sc
operator|->
name|sc_edid
argument_list|,
name|EDID_LENGTH
operator|*
operator|(
name|blocks
operator|+
literal|1
operator|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_edid_len
operator|=
name|EDID_LENGTH
operator|*
operator|(
name|blocks
operator|+
literal|1
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|blocks
condition|;
name|i
operator|++
control|)
block|{
comment|/* TODO: check validity */
name|buf
operator|=
name|sc
operator|->
name|sc_edid
operator|+
name|EDID_LENGTH
operator|*
operator|(
name|i
operator|+
literal|1
operator|)
expr_stmt|;
name|err
operator|=
name|tda19988_read_edid_block
argument_list|(
name|sc
argument_list|,
name|buf
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|done
goto|;
block|}
block|}
name|EVENTHANDLER_INVOKE
argument_list|(
name|hdmi_event
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|done
label|:
if|if
condition|(
name|sc
operator|->
name|sc_version
operator|==
name|TDA19988
condition|)
name|tda19988_reg_set
argument_list|(
name|sc
argument_list|,
name|TDA_TX4
argument_list|,
name|TX4_PD_RAM
argument_list|)
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|tda19988_start
parameter_list|(
name|void
modifier|*
name|xdev
parameter_list|)
block|{
name|struct
name|tda19988_softc
modifier|*
name|sc
decl_stmt|;
name|device_t
name|dev
init|=
operator|(
name|device_t
operator|)
name|xdev
decl_stmt|;
name|uint8_t
name|data
decl_stmt|;
name|uint16_t
name|version
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|tda19988_cec_write
argument_list|(
name|sc
argument_list|,
name|TDA_CEC_ENAMODS
argument_list|,
name|ENAMODS_RXSENS
operator||
name|ENAMODS_HDMI
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|tda19988_cec_read
argument_list|(
name|sc
argument_list|,
literal|0xfe
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
comment|/* Reset core */
name|tda19988_reg_set
argument_list|(
name|sc
argument_list|,
name|TDA_SOFTRESET
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|tda19988_reg_clear
argument_list|(
name|sc
argument_list|,
name|TDA_SOFTRESET
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
comment|/* reset transmitter: */
name|tda19988_reg_set
argument_list|(
name|sc
argument_list|,
name|TDA_MAIN_CNTRL0
argument_list|,
name|MAIN_CNTRL0_SR
argument_list|)
expr_stmt|;
name|tda19988_reg_clear
argument_list|(
name|sc
argument_list|,
name|TDA_MAIN_CNTRL0
argument_list|,
name|MAIN_CNTRL0_SR
argument_list|)
expr_stmt|;
comment|/* PLL registers common configuration */
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_PLL_SERIAL_1
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_PLL_SERIAL_2
argument_list|,
name|PLL_SERIAL_2_SRL_NOSC
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_PLL_SERIAL_3
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_SERIALIZER
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_BUFFER_OUT
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_PLL_SCG1
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_SEL_CLK
argument_list|,
name|SEL_CLK_SEL_CLK1
operator||
name|SEL_CLK_ENA_SC_CLK
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_PLL_SCGN1
argument_list|,
literal|0xfa
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_PLL_SCGN2
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_PLL_SCGR1
argument_list|,
literal|0x5b
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_PLL_SCGR2
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_PLL_SCG2
argument_list|,
literal|0x10
argument_list|)
expr_stmt|;
comment|/* Write the default value MUX register */
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_MUX_VP_VIP_OUT
argument_list|,
literal|0x24
argument_list|)
expr_stmt|;
name|version
operator|=
literal|0
expr_stmt|;
name|tda19988_reg_read
argument_list|(
name|sc
argument_list|,
name|TDA_VERSION
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|version
operator||=
name|data
expr_stmt|;
name|tda19988_reg_read
argument_list|(
name|sc
argument_list|,
name|TDA_VERSION_MSB
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|version
operator||=
operator|(
name|data
operator|<<
literal|8
operator|)
expr_stmt|;
comment|/* Clear feature bits */
name|sc
operator|->
name|sc_version
operator|=
name|version
operator|&
operator|~
literal|0x30
expr_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|sc_version
condition|)
block|{
case|case
name|TDA19988
case|:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"TDA19988\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"Unknown device: %04x\n"
argument_list|,
name|sc
operator|->
name|sc_version
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_DDC_CTRL
argument_list|,
name|DDC_ENABLE
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_TX3
argument_list|,
literal|39
argument_list|)
expr_stmt|;
name|tda19988_cec_write
argument_list|(
name|sc
argument_list|,
name|TDA_CEC_FRO_IM_CLK_CTRL
argument_list|,
name|CEC_FRO_IM_CLK_CTRL_GHOST_DIS
operator||
name|CEC_FRO_IM_CLK_CTRL_IMCLK_SEL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tda19988_read_edid
argument_list|(
name|sc
argument_list|)
operator|<
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"failed to read EDID\n"
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* Default values for RGB 4:4:4 mapping */
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_VIP_CNTRL_0
argument_list|,
literal|0x23
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_VIP_CNTRL_1
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
name|tda19988_reg_write
argument_list|(
name|sc
argument_list|,
name|TDA_VIP_CNTRL_2
argument_list|,
literal|0x45
argument_list|)
expr_stmt|;
name|done
label|:
name|config_intrhook_disestablish
argument_list|(
operator|&
name|sc
operator|->
name|enum_hook
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|tda19988_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|tda19988_softc
modifier|*
name|sc
decl_stmt|;
name|phandle_t
name|node
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_dev
operator|=
name|dev
expr_stmt|;
name|sc
operator|->
name|sc_addr
operator|=
name|iicbus_get_addr
argument_list|(
name|dev
argument_list|)
operator|<<
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_cec_addr
operator|=
operator|(
literal|0x34
operator|<<
literal|1
operator|)
expr_stmt|;
comment|/* hardcoded */
name|sc
operator|->
name|sc_edid
operator|=
name|malloc
argument_list|(
name|EDID_LENGTH
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_edid_len
operator|=
name|EDID_LENGTH
expr_stmt|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"NXP TDA19988 HDMI transmitter"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|enum_hook
operator|.
name|ich_func
operator|=
name|tda19988_start
expr_stmt|;
name|sc
operator|->
name|enum_hook
operator|.
name|ich_arg
operator|=
name|dev
expr_stmt|;
if|if
condition|(
name|config_intrhook_establish
argument_list|(
operator|&
name|sc
operator|->
name|enum_hook
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|node
operator|=
name|ofw_bus_get_node
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|OF_device_register_xref
argument_list|(
name|OF_xref_from_node
argument_list|(
name|node
argument_list|)
argument_list|,
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tda19988_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
comment|/* XXX: Do not let unload drive */
return|return
operator|(
name|EBUSY
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tda19988_get_edid
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|uint8_t
modifier|*
modifier|*
name|edid
parameter_list|,
name|uint32_t
modifier|*
name|edid_len
parameter_list|)
block|{
name|struct
name|tda19988_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_edid
condition|)
block|{
operator|*
name|edid
operator|=
name|sc
operator|->
name|sc_edid
expr_stmt|;
operator|*
name|edid_len
operator|=
name|sc
operator|->
name|sc_edid_len
expr_stmt|;
block|}
else|else
return|return
operator|(
name|ENXIO
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tda19988_set_videomode
parameter_list|(
name|device_t
name|dev
parameter_list|,
specifier|const
name|struct
name|videomode
modifier|*
name|mode
parameter_list|)
block|{
name|struct
name|tda19988_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|tda19988_init_encoder
argument_list|(
name|sc
argument_list|,
name|mode
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|tda_methods
index|[]
init|=
block|{
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|tda19988_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|tda19988_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|tda19988_detach
argument_list|)
block|,
comment|/* HDMI methods */
name|DEVMETHOD
argument_list|(
name|hdmi_get_edid
argument_list|,
name|tda19988_get_edid
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|hdmi_set_videomode
argument_list|,
name|tda19988_set_videomode
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|tda_driver
init|=
block|{
literal|"tda"
block|,
name|tda_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|tda19988_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|tda_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|tda
argument_list|,
name|iicbus
argument_list|,
name|tda_driver
argument_list|,
name|tda_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|tda
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|tda
argument_list|,
name|iicbus
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


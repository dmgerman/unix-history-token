begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (C) 2008-2009 Semihalf  * All rights reserved.  *  * Initial version developed by Ilya Bakulin. Full functionality and bringup  * by Piotr Ziecik.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/sema.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<vm/uma.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/ata.h>
end_include

begin_include
include|#
directive|include
file|<dev/ata/ata-all.h>
end_include

begin_include
include|#
directive|include
file|"ata_if.h"
end_include

begin_include
include|#
directive|include
file|"mvreg.h"
end_include

begin_include
include|#
directive|include
file|"mvvar.h"
end_include

begin_comment
comment|/* Useful macros */
end_comment

begin_define
define|#
directive|define
name|EDMA_TIMEOUT
value|100000
end_define

begin_comment
comment|/* 100 ms */
end_comment

begin_define
define|#
directive|define
name|SATA_INL
parameter_list|(
name|sc
parameter_list|,
name|reg
parameter_list|)
value|ATA_INL((sc)->sc_mem_res, reg)
end_define

begin_define
define|#
directive|define
name|SATA_OUTL
parameter_list|(
name|sc
parameter_list|,
name|reg
parameter_list|,
name|val
parameter_list|)
value|ATA_OUTL((sc)->sc_mem_res, reg, val)
end_define

begin_comment
comment|/* HW-related data structures */
end_comment

begin_struct
struct|struct
name|sata_prdentry
block|{
name|uint32_t
name|prd_addrlo
decl_stmt|;
name|uint32_t
name|prd_count
decl_stmt|;
name|uint32_t
name|prd_addrhi
decl_stmt|;
name|uint32_t
name|prd_reserved
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|sata_crqb
block|{
name|uint32_t
name|crqb_prdlo
decl_stmt|;
name|uint32_t
name|crqb_prdhi
decl_stmt|;
name|uint32_t
name|crqb_flags
decl_stmt|;
name|uint16_t
name|crqb_count
decl_stmt|;
name|uint16_t
name|crqb_reserved1
index|[
literal|2
index|]
decl_stmt|;
name|uint8_t
name|crqb_ata_command
decl_stmt|;
name|uint8_t
name|crqb_ata_feature
decl_stmt|;
name|uint8_t
name|crqb_ata_lba_low
decl_stmt|;
name|uint8_t
name|crqb_ata_lba_mid
decl_stmt|;
name|uint8_t
name|crqb_ata_lba_high
decl_stmt|;
name|uint8_t
name|crqb_ata_device
decl_stmt|;
name|uint8_t
name|crqb_ata_lba_low_p
decl_stmt|;
name|uint8_t
name|crqb_ata_lba_mid_p
decl_stmt|;
name|uint8_t
name|crqb_ata_lba_high_p
decl_stmt|;
name|uint8_t
name|crqb_ata_feature_p
decl_stmt|;
name|uint8_t
name|crqb_ata_count
decl_stmt|;
name|uint8_t
name|crqb_ata_count_p
decl_stmt|;
name|uint16_t
name|crqb_reserved2
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|sata_crpb
block|{
name|uint8_t
name|crpb_tag
decl_stmt|;
name|uint8_t
name|crpb_reserved
decl_stmt|;
name|uint8_t
name|crpb_edma_status
decl_stmt|;
name|uint8_t
name|crpb_dev_status
decl_stmt|;
name|uint32_t
name|crpb_timestamp
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Identification section. */
end_comment

begin_struct
struct|struct
name|sata_softc
block|{
name|device_t
name|sc_dev
decl_stmt|;
name|unsigned
name|int
name|sc_version
decl_stmt|;
name|unsigned
name|int
name|sc_edma_qlen
decl_stmt|;
name|uint32_t
name|sc_edma_reqis_mask
decl_stmt|;
name|uint32_t
name|sc_edma_resos_mask
decl_stmt|;
name|struct
name|resource
modifier|*
name|sc_mem_res
decl_stmt|;
name|bus_space_tag_t
name|sc_mem_res_bustag
decl_stmt|;
name|bus_space_handle_t
name|sc_mem_res_bushdl
decl_stmt|;
name|struct
name|resource
modifier|*
name|sc_irq_res
decl_stmt|;
name|void
modifier|*
name|sc_irq_cookiep
decl_stmt|;
struct|struct
block|{
name|void
function_decl|(
modifier|*
name|function
function_decl|)
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
name|void
modifier|*
name|argument
decl_stmt|;
block|}
name|sc_interrupt
index|[
name|SATA_CHAN_NUM
index|]
struct|;
block|}
struct|;
end_struct

begin_comment
comment|/* Controller functions */
end_comment

begin_function_decl
specifier|static
name|int
name|sata_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|sata_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|sata_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sata_intr
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|resource
modifier|*
name|sata_alloc_resource
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|,
name|int
name|type
parameter_list|,
name|int
modifier|*
name|rid
parameter_list|,
name|u_long
name|start
parameter_list|,
name|u_long
name|end
parameter_list|,
name|u_long
name|count
parameter_list|,
name|u_int
name|flags
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|sata_release_resource
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|,
name|int
name|type
parameter_list|,
name|int
name|rid
parameter_list|,
name|struct
name|resource
modifier|*
name|r
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|sata_setup_intr
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|,
name|struct
name|resource
modifier|*
name|irq
parameter_list|,
name|int
name|flags
parameter_list|,
name|driver_filter_t
modifier|*
name|filt
parameter_list|,
name|driver_intr_t
modifier|*
name|function
parameter_list|,
name|void
modifier|*
name|argument
parameter_list|,
name|void
modifier|*
modifier|*
name|cookiep
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|sata_teardown_intr
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|,
name|struct
name|resource
modifier|*
name|irq
parameter_list|,
name|void
modifier|*
name|cookie
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Channel functions */
end_comment

begin_function_decl
specifier|static
name|int
name|sata_channel_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|sata_channel_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|sata_channel_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|sata_channel_begin_transaction
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|sata_channel_end_transaction
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|sata_channel_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|sata_channel_setmode
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|target
parameter_list|,
name|int
name|mode
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|sata_channel_getrev
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|target
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sata_channel_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sata_channel_dmasetprd
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* EDMA functions */
end_comment

begin_function_decl
specifier|static
name|int
name|sata_edma_ctrl
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|on
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|sata_edma_is_running
parameter_list|(
name|device_t
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|device_method_t
name|sata_methods
index|[]
init|=
block|{
comment|/* Device method */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|sata_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|sata_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|sata_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_shutdown
argument_list|,
name|bus_generic_shutdown
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_suspend
argument_list|,
name|bus_generic_suspend
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|bus_generic_resume
argument_list|)
block|,
comment|/* ATA bus methods. */
name|DEVMETHOD
argument_list|(
name|bus_alloc_resource
argument_list|,
name|sata_alloc_resource
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_release_resource
argument_list|,
name|sata_release_resource
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_activate_resource
argument_list|,
name|bus_generic_activate_resource
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_deactivate_resource
argument_list|,
name|bus_generic_deactivate_resource
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_setup_intr
argument_list|,
name|sata_setup_intr
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|bus_teardown_intr
argument_list|,
name|sata_teardown_intr
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|sata_driver
init|=
block|{
literal|"sata"
block|,
name|sata_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|sata_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|devclass_t
name|sata_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|sata
argument_list|,
name|mbus
argument_list|,
name|sata_driver
argument_list|,
name|sata_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|sata
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|sata
argument_list|,
name|ata
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|sata_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|sata_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|d
decl_stmt|,
name|r
decl_stmt|;
name|soc_id
argument_list|(
operator|&
name|d
argument_list|,
operator|&
name|r
argument_list|)
expr_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* No SATA controller on the 88F5281 SoC */
if|if
condition|(
name|d
operator|==
name|MV_DEV_88F5281
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
switch|switch
condition|(
name|d
condition|)
block|{
case|case
name|MV_DEV_88F5182
case|:
name|sc
operator|->
name|sc_version
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|sc_edma_qlen
operator|=
literal|128
expr_stmt|;
break|break;
case|case
name|MV_DEV_88F6281
case|:
case|case
name|MV_DEV_MV78100
case|:
case|case
name|MV_DEV_MV78100_Z0
case|:
name|sc
operator|->
name|sc_version
operator|=
literal|2
expr_stmt|;
name|sc
operator|->
name|sc_edma_qlen
operator|=
literal|32
expr_stmt|;
break|break;
default|default:
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"unsupported SoC (ID: 0x%08X)!\n"
argument_list|,
name|d
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|sc
operator|->
name|sc_edma_reqis_mask
operator|=
operator|(
name|sc
operator|->
name|sc_edma_qlen
operator|-
literal|1
operator|)
operator|<<
name|SATA_EDMA_REQIS_OFS
expr_stmt|;
name|sc
operator|->
name|sc_edma_resos_mask
operator|=
operator|(
name|sc
operator|->
name|sc_edma_qlen
operator|-
literal|1
operator|)
operator|<<
name|SATA_EDMA_RESOS_OFS
expr_stmt|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Marvell Integrated SATA Controller"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sata_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|sata_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|mem_id
decl_stmt|,
name|irq_id
decl_stmt|,
name|error
decl_stmt|,
name|i
decl_stmt|;
name|device_t
name|ata_chan
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_dev
operator|=
name|dev
expr_stmt|;
name|mem_id
operator|=
literal|0
expr_stmt|;
name|irq_id
operator|=
literal|0
expr_stmt|;
comment|/* Allocate resources */
name|sc
operator|->
name|sc_mem_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
operator|&
name|mem_id
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_mem_res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not allocate memory.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|sc
operator|->
name|sc_mem_res_bustag
operator|=
name|rman_get_bustag
argument_list|(
name|sc
operator|->
name|sc_mem_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_mem_res_bushdl
operator|=
name|rman_get_bushandle
argument_list|(
name|sc
operator|->
name|sc_mem_res
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|sc
operator|->
name|sc_mem_res_bustag
operator|&&
name|sc
operator|->
name|sc_mem_res_bushdl
argument_list|,
operator|(
literal|"cannot get bus handle or tag."
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_irq_res
operator|=
name|bus_alloc_resource_any
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
operator|&
name|irq_id
argument_list|,
name|RF_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_irq_res
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not allocate IRQ.\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|error
operator|=
name|bus_setup_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|sc_irq_res
argument_list|,
name|INTR_TYPE_BIO
operator||
name|INTR_MPSAFE
operator||
name|INTR_ENTROPY
argument_list|,
name|NULL
argument_list|,
name|sata_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|sc_irq_cookiep
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"could not setup interrupt.\n"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/* Attach channels */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SATA_CHAN_NUM
condition|;
name|i
operator|++
control|)
block|{
name|ata_chan
operator|=
name|device_add_child
argument_list|(
name|dev
argument_list|,
literal|"ata"
argument_list|,
name|devclass_find_free_unit
argument_list|(
name|ata_devclass
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ata_chan
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot add channel %d.\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
comment|/* Disable interrupt coalescing */
name|reg
operator|=
name|SATA_INL
argument_list|(
name|sc
argument_list|,
name|SATA_CR
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SATA_CHAN_NUM
condition|;
name|i
operator|++
control|)
name|reg
operator||=
name|SATA_CR_COALDIS
argument_list|(
name|i
argument_list|)
expr_stmt|;
comment|/* Disable DMA byte swapping */
if|if
condition|(
name|sc
operator|->
name|sc_version
operator|==
literal|2
condition|)
name|reg
operator||=
name|SATA_CR_NODMABS
operator||
name|SATA_CR_NOEDMABS
operator||
name|SATA_CR_NOPRDPBS
expr_stmt|;
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_CR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Clear and mask all interrupts */
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_ICR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_MIMR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|bus_generic_attach
argument_list|(
name|dev
argument_list|)
operator|)
return|;
name|err
label|:
name|sata_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sata_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|sata_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|device_is_attached
argument_list|(
name|dev
argument_list|)
condition|)
name|bus_generic_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|sc_mem_res
operator|!=
name|NULL
condition|)
block|{
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
name|rman_get_rid
argument_list|(
name|sc
operator|->
name|sc_mem_res
argument_list|)
argument_list|,
name|sc
operator|->
name|sc_mem_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_mem_res
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|sc_irq_res
operator|!=
name|NULL
condition|)
block|{
name|bus_teardown_intr
argument_list|(
name|dev
argument_list|,
name|sc
operator|->
name|sc_irq_res
argument_list|,
name|sc
operator|->
name|sc_irq_cookiep
argument_list|)
expr_stmt|;
name|bus_release_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_IRQ
argument_list|,
name|rman_get_rid
argument_list|(
name|sc
operator|->
name|sc_irq_res
argument_list|)
argument_list|,
name|sc
operator|->
name|sc_irq_res
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_irq_res
operator|=
name|NULL
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|resource
modifier|*
name|sata_alloc_resource
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|,
name|int
name|type
parameter_list|,
name|int
modifier|*
name|rid
parameter_list|,
name|u_long
name|start
parameter_list|,
name|u_long
name|end
parameter_list|,
name|u_long
name|count
parameter_list|,
name|u_int
name|flags
parameter_list|)
block|{
name|struct
name|sata_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|type
operator|==
name|SYS_RES_IRQ
operator|&&
operator|*
name|rid
operator|==
name|ATA_IRQ_RID
argument_list|,
operator|(
literal|"illegal resource request (type %u, rid %u)."
operator|,
name|type
operator|,
operator|*
name|rid
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|sc
operator|->
name|sc_irq_res
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sata_release_resource
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|,
name|int
name|type
parameter_list|,
name|int
name|rid
parameter_list|,
name|struct
name|resource
modifier|*
name|r
parameter_list|)
block|{
name|KASSERT
argument_list|(
name|type
operator|==
name|SYS_RES_IRQ
operator|&&
name|rid
operator|==
name|ATA_IRQ_RID
argument_list|,
operator|(
literal|"strange type %u and/or rid %u while releasing resource."
operator|,
name|type
operator|,
name|rid
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sata_setup_intr
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|,
name|struct
name|resource
modifier|*
name|irq
parameter_list|,
name|int
name|flags
parameter_list|,
name|driver_filter_t
modifier|*
name|filt
parameter_list|,
name|driver_intr_t
modifier|*
name|function
parameter_list|,
name|void
modifier|*
name|argument
parameter_list|,
name|void
modifier|*
modifier|*
name|cookiep
parameter_list|)
block|{
name|struct
name|sata_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ch
operator|=
name|device_get_softc
argument_list|(
name|child
argument_list|)
expr_stmt|;
if|if
condition|(
name|filt
operator|!=
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"filter interrupts are not supported.\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|sc
operator|->
name|sc_interrupt
index|[
name|ch
operator|->
name|unit
index|]
operator|.
name|function
operator|=
name|function
expr_stmt|;
name|sc
operator|->
name|sc_interrupt
index|[
name|ch
operator|->
name|unit
index|]
operator|.
name|argument
operator|=
name|argument
expr_stmt|;
operator|*
name|cookiep
operator|=
name|sc
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sata_teardown_intr
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|device_t
name|child
parameter_list|,
name|struct
name|resource
modifier|*
name|irq
parameter_list|,
name|void
modifier|*
name|cookie
parameter_list|)
block|{
name|struct
name|sata_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ch
operator|=
name|device_get_softc
argument_list|(
name|child
argument_list|)
expr_stmt|;
name|sc
operator|->
name|sc_interrupt
index|[
name|ch
operator|->
name|unit
index|]
operator|.
name|function
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|sc_interrupt
index|[
name|ch
operator|->
name|unit
index|]
operator|.
name|argument
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sata_intr
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
block|{
name|struct
name|sata_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|unit
decl_stmt|;
name|sc
operator|=
name|xsc
expr_stmt|;
comment|/* 	 * Behave like ata_generic_intr() for PCI controllers. 	 * Simply invoke ISRs on all channels. 	 */
for|for
control|(
name|unit
operator|=
literal|0
init|;
name|unit
operator|<
name|SATA_CHAN_NUM
condition|;
name|unit
operator|++
control|)
if|if
condition|(
name|sc
operator|->
name|sc_interrupt
index|[
name|unit
index|]
operator|.
name|function
operator|!=
name|NULL
condition|)
name|sc
operator|->
name|sc_interrupt
index|[
name|unit
index|]
operator|.
name|function
argument_list|(
name|sc
operator|->
name|sc_interrupt
index|[
name|unit
index|]
operator|.
name|argument
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|sata_channel_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Marvell Integrated SATA Channel"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ata_probe
argument_list|(
name|dev
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sata_channel_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|sata_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
decl_stmt|;
name|uint64_t
name|work
decl_stmt|;
name|int
name|error
decl_stmt|,
name|i
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|ch
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|attached
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|ch
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
name|ch
operator|->
name|unit
operator|=
name|device_get_unit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ch
operator|->
name|flags
operator||=
name|ATA_USE_16BIT
operator||
name|ATA_NO_SLAVE
operator||
name|ATA_SATA
expr_stmt|;
comment|/* Set legacy ATA resources. */
for|for
control|(
name|i
operator|=
name|ATA_DATA
init|;
name|i
operator|<=
name|ATA_COMMAND
condition|;
name|i
operator|++
control|)
block|{
name|ch
operator|->
name|r_io
index|[
name|i
index|]
operator|.
name|res
operator|=
name|sc
operator|->
name|sc_mem_res
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|i
index|]
operator|.
name|offset
operator|=
name|SATA_SHADOWR_BASE
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
operator|+
operator|(
name|i
operator|<<
literal|2
operator|)
expr_stmt|;
block|}
name|ch
operator|->
name|r_io
index|[
name|ATA_CONTROL
index|]
operator|.
name|res
operator|=
name|sc
operator|->
name|sc_mem_res
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_CONTROL
index|]
operator|.
name|offset
operator|=
name|SATA_SHADOWR_CONTROL
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_IDX_ADDR
index|]
operator|.
name|res
operator|=
name|sc
operator|->
name|sc_mem_res
expr_stmt|;
name|ata_default_registers
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Set SATA resources. */
name|ch
operator|->
name|r_io
index|[
name|ATA_SSTATUS
index|]
operator|.
name|res
operator|=
name|sc
operator|->
name|sc_mem_res
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SSTATUS
index|]
operator|.
name|offset
operator|=
name|SATA_SATA_SSTATUS
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SERROR
index|]
operator|.
name|res
operator|=
name|sc
operator|->
name|sc_mem_res
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SERROR
index|]
operator|.
name|offset
operator|=
name|SATA_SATA_SERROR
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SCONTROL
index|]
operator|.
name|res
operator|=
name|sc
operator|->
name|sc_mem_res
expr_stmt|;
name|ch
operator|->
name|r_io
index|[
name|ATA_SCONTROL
index|]
operator|.
name|offset
operator|=
name|SATA_SATA_SCONTROL
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
expr_stmt|;
name|ata_generic_hw
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ch
operator|->
name|hw
operator|.
name|begin_transaction
operator|=
name|sata_channel_begin_transaction
expr_stmt|;
name|ch
operator|->
name|hw
operator|.
name|end_transaction
operator|=
name|sata_channel_end_transaction
expr_stmt|;
name|ch
operator|->
name|hw
operator|.
name|status
operator|=
name|sata_channel_status
expr_stmt|;
comment|/* Set DMA resources */
name|ata_dmainit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ch
operator|->
name|dma
operator|.
name|setprd
operator|=
name|sata_channel_dmasetprd
expr_stmt|;
comment|/* Clear work area */
name|KASSERT
argument_list|(
name|sc
operator|->
name|sc_edma_qlen
operator|*
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|sata_crqb
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sata_crpb
argument_list|)
operator|)
operator|<=
name|ch
operator|->
name|dma
operator|.
name|max_iosize
argument_list|,
operator|(
literal|"insufficient DMA memory for request/response queues.\n"
operator|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|ch
operator|->
name|dma
operator|.
name|work
argument_list|,
name|sc
operator|->
name|sc_edma_qlen
operator|*
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|sata_crqb
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|sata_crpb
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ch
operator|->
name|dma
operator|.
name|work_tag
argument_list|,
name|ch
operator|->
name|dma
operator|.
name|work_map
argument_list|,
name|BUS_DMASYNC_PREREAD
operator||
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
comment|/* Turn off EDMA engine */
name|error
operator|=
name|sata_edma_ctrl
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|ata_dmafini
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* 	 * Initialize EDMA engine: 	 *	- Native Command Queuing off, 	 *	- Non-Queued operation, 	 *	- Host Queue Cache enabled. 	 */
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_EDMA_CFG
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|,
name|SATA_EDMA_CFG_HQCACHE
operator||
operator|(
name|sc
operator|->
name|sc_version
operator|==
literal|1
operator|)
condition|?
name|SATA_EDMA_CFG_QL128
else|:
literal|0
argument_list|)
expr_stmt|;
comment|/* Set request queue pointers */
name|work
operator|=
name|ch
operator|->
name|dma
operator|.
name|work_bus
expr_stmt|;
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_EDMA_REQBAHR
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|,
name|work
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_EDMA_REQIPR
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|,
name|work
operator|&
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_EDMA_REQOPR
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|,
name|work
operator|&
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
comment|/* Set response queue pointers */
name|work
operator|+=
name|sc
operator|->
name|sc_edma_qlen
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|sata_crqb
argument_list|)
expr_stmt|;
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_EDMA_RESBAHR
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|,
name|work
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_EDMA_RESIPR
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|,
name|work
operator|&
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_EDMA_RESOPR
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|,
name|work
operator|&
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
comment|/* Clear any outstanding interrupts */
name|ATA_IDX_OUTL
argument_list|(
name|ch
argument_list|,
name|ATA_SERROR
argument_list|,
name|ATA_IDX_INL
argument_list|(
name|ch
argument_list|,
name|ATA_SERROR
argument_list|)
argument_list|)
expr_stmt|;
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_SATA_FISICR
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_EDMA_IECR
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_ICR
argument_list|,
operator|~
operator|(
name|SATA_ICR_DEV
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
operator||
name|SATA_ICR_DMADONE
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* Umask channel interrupts */
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_EDMA_IEMR
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|,
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_MIMR
argument_list|,
name|SATA_INL
argument_list|(
name|sc
argument_list|,
name|SATA_MIMR
argument_list|)
operator||
name|SATA_MICR_DONE
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
operator||
name|SATA_MICR_DMADONE
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
operator||
name|SATA_MICR_ERR
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|)
expr_stmt|;
name|ch
operator|->
name|attached
operator|=
literal|1
expr_stmt|;
return|return
operator|(
name|ata_attach
argument_list|(
name|dev
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sata_channel_detach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|sata_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|ch
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ch
operator|->
name|attached
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* Turn off EDMA engine */
name|sata_edma_ctrl
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Mask chanel interrupts */
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_EDMA_IEMR
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_MIMR
argument_list|,
name|SATA_INL
argument_list|(
name|sc
argument_list|,
name|SATA_MIMR
argument_list|)
operator|&
operator|~
operator|(
name|SATA_MICR_DONE
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
operator||
name|SATA_MICR_DMADONE
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
operator||
name|SATA_MICR_ERR
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|ata_detach
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ata_dmafini
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|ch
operator|->
name|attached
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sata_channel_begin_transaction
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
block|{
name|struct
name|sata_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
decl_stmt|;
name|struct
name|sata_crqb
modifier|*
name|crqb
decl_stmt|;
name|uint32_t
name|req_in
decl_stmt|;
name|int
name|error
decl_stmt|,
name|slot
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|request
operator|->
name|parent
argument_list|)
argument_list|)
expr_stmt|;
name|ch
operator|=
name|device_get_softc
argument_list|(
name|request
operator|->
name|parent
argument_list|)
expr_stmt|;
name|mtx_assert
argument_list|(
operator|&
name|ch
operator|->
name|state_mtx
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
comment|/* Only DMA R/W goes through the EDMA machine. */
if|if
condition|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
operator|!=
name|ATA_READ_DMA
operator|&&
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
operator|!=
name|ATA_WRITE_DMA
operator|&&
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
operator|!=
name|ATA_READ_DMA48
operator|&&
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
operator|!=
name|ATA_WRITE_DMA48
condition|)
block|{
comment|/* Disable EDMA before accessing legacy registers */
if|if
condition|(
name|sata_edma_is_running
argument_list|(
name|request
operator|->
name|parent
argument_list|)
condition|)
block|{
name|error
operator|=
name|sata_edma_ctrl
argument_list|(
name|request
operator|->
name|parent
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|request
operator|->
name|result
operator|=
name|error
expr_stmt|;
return|return
operator|(
name|ATA_OP_FINISHED
operator|)
return|;
block|}
block|}
return|return
operator|(
name|ata_begin_transaction
argument_list|(
name|request
argument_list|)
operator|)
return|;
block|}
comment|/* Prepare data for DMA */
if|if
condition|(
operator|(
name|error
operator|=
name|ch
operator|->
name|dma
operator|.
name|load
argument_list|(
name|request
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
condition|)
block|{
name|device_printf
argument_list|(
name|request
operator|->
name|parent
argument_list|,
literal|"setting up DMA failed!\n"
argument_list|)
expr_stmt|;
name|request
operator|->
name|result
operator|=
name|error
expr_stmt|;
return|return
name|ATA_OP_FINISHED
return|;
block|}
comment|/* Get next free queue slot */
name|req_in
operator|=
name|SATA_INL
argument_list|(
name|sc
argument_list|,
name|SATA_EDMA_REQIPR
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|)
expr_stmt|;
name|slot
operator|=
operator|(
name|req_in
operator|&
name|sc
operator|->
name|sc_edma_reqis_mask
operator|)
operator|>>
name|SATA_EDMA_REQIS_OFS
expr_stmt|;
name|crqb
operator|=
operator|(
expr|struct
name|sata_crqb
operator|*
operator|)
operator|(
name|ch
operator|->
name|dma
operator|.
name|work
operator|+
operator|(
name|slot
operator|<<
name|SATA_EDMA_REQIS_OFS
operator|)
operator|)
expr_stmt|;
comment|/* Fill in request */
name|bus_dmamap_sync
argument_list|(
name|ch
operator|->
name|dma
operator|.
name|work_tag
argument_list|,
name|ch
operator|->
name|dma
operator|.
name|work_map
argument_list|,
name|BUS_DMASYNC_POSTREAD
operator||
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|crqb
operator|->
name|crqb_prdlo
operator|=
name|htole32
argument_list|(
operator|(
name|uint64_t
operator|)
name|request
operator|->
name|dma
operator|->
name|sg_bus
operator|&
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|crqb
operator|->
name|crqb_prdhi
operator|=
name|htole32
argument_list|(
operator|(
name|uint64_t
operator|)
name|request
operator|->
name|dma
operator|->
name|sg_bus
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|crqb
operator|->
name|crqb_flags
operator|=
name|htole32
argument_list|(
operator|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_READ
condition|?
literal|0x01
else|:
literal|0x00
operator|)
operator||
operator|(
name|request
operator|->
name|tag
operator|<<
literal|1
operator|)
argument_list|)
expr_stmt|;
name|crqb
operator|->
name|crqb_ata_command
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|command
expr_stmt|;
name|crqb
operator|->
name|crqb_ata_feature
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|feature
expr_stmt|;
name|crqb
operator|->
name|crqb_ata_lba_low
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
expr_stmt|;
name|crqb
operator|->
name|crqb_ata_lba_mid
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|8
expr_stmt|;
name|crqb
operator|->
name|crqb_ata_lba_high
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|16
expr_stmt|;
name|crqb
operator|->
name|crqb_ata_device
operator|=
operator|(
operator|(
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|lba
operator|>>
literal|24
operator|)
operator|&
literal|0x0F
operator|)
operator||
operator|(
literal|1
operator|<<
literal|6
operator|)
expr_stmt|;
name|crqb
operator|->
name|crqb_ata_count
operator|=
name|request
operator|->
name|u
operator|.
name|ata
operator|.
name|count
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ch
operator|->
name|dma
operator|.
name|work_tag
argument_list|,
name|ch
operator|->
name|dma
operator|.
name|work_map
argument_list|,
name|BUS_DMASYNC_PREREAD
operator||
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
comment|/* Enable EDMA if disabled */
if|if
condition|(
operator|!
name|sata_edma_is_running
argument_list|(
name|request
operator|->
name|parent
argument_list|)
condition|)
block|{
name|error
operator|=
name|sata_edma_ctrl
argument_list|(
name|request
operator|->
name|parent
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|ch
operator|->
name|dma
operator|.
name|unload
argument_list|(
name|request
argument_list|)
expr_stmt|;
name|request
operator|->
name|result
operator|=
name|error
expr_stmt|;
return|return
operator|(
name|ATA_OP_FINISHED
operator|)
return|;
block|}
block|}
comment|/* Tell EDMA about new request */
name|req_in
operator|=
operator|(
name|req_in
operator|&
operator|~
name|sc
operator|->
name|sc_edma_reqis_mask
operator|)
operator||
operator|(
operator|(
operator|(
name|slot
operator|+
literal|1
operator|)
operator|<<
name|SATA_EDMA_REQIS_OFS
operator|)
operator|&
name|sc
operator|->
name|sc_edma_reqis_mask
operator|)
expr_stmt|;
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_EDMA_REQIPR
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|,
name|req_in
argument_list|)
expr_stmt|;
return|return
operator|(
name|ATA_OP_CONTINUES
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sata_channel_end_transaction
parameter_list|(
name|struct
name|ata_request
modifier|*
name|request
parameter_list|)
block|{
name|struct
name|sata_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
decl_stmt|;
name|struct
name|sata_crpb
modifier|*
name|crpb
decl_stmt|;
name|uint32_t
name|res_in
decl_stmt|,
name|res_out
decl_stmt|,
name|icr
decl_stmt|;
name|int
name|slot
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|request
operator|->
name|parent
argument_list|)
argument_list|)
expr_stmt|;
name|ch
operator|=
name|device_get_softc
argument_list|(
name|request
operator|->
name|parent
argument_list|)
expr_stmt|;
name|mtx_assert
argument_list|(
operator|&
name|ch
operator|->
name|state_mtx
argument_list|,
name|MA_OWNED
argument_list|)
expr_stmt|;
name|icr
operator|=
name|SATA_INL
argument_list|(
name|sc
argument_list|,
name|SATA_ICR
argument_list|)
expr_stmt|;
if|if
condition|(
name|icr
operator|&
name|SATA_ICR_DMADONE
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
condition|)
block|{
comment|/* Get current response slot */
name|res_out
operator|=
name|SATA_INL
argument_list|(
name|sc
argument_list|,
name|SATA_EDMA_RESOPR
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|)
expr_stmt|;
name|slot
operator|=
operator|(
name|res_out
operator|&
name|sc
operator|->
name|sc_edma_resos_mask
operator|)
operator|>>
name|SATA_EDMA_RESOS_OFS
expr_stmt|;
name|crpb
operator|=
operator|(
expr|struct
name|sata_crpb
operator|*
operator|)
operator|(
name|ch
operator|->
name|dma
operator|.
name|work
operator|+
operator|(
name|sc
operator|->
name|sc_edma_qlen
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|sata_crqb
argument_list|)
operator|)
operator|+
operator|(
name|slot
operator|<<
name|SATA_EDMA_RESOS_OFS
operator|)
operator|)
expr_stmt|;
comment|/* Record this request status */
name|bus_dmamap_sync
argument_list|(
name|ch
operator|->
name|dma
operator|.
name|work_tag
argument_list|,
name|ch
operator|->
name|dma
operator|.
name|work_map
argument_list|,
name|BUS_DMASYNC_POSTREAD
operator||
name|BUS_DMASYNC_POSTWRITE
argument_list|)
expr_stmt|;
name|request
operator|->
name|status
operator|=
name|crpb
operator|->
name|crpb_dev_status
expr_stmt|;
name|request
operator|->
name|error
operator|=
literal|0
expr_stmt|;
name|bus_dmamap_sync
argument_list|(
name|ch
operator|->
name|dma
operator|.
name|work_tag
argument_list|,
name|ch
operator|->
name|dma
operator|.
name|work_map
argument_list|,
name|BUS_DMASYNC_PREREAD
operator||
name|BUS_DMASYNC_PREWRITE
argument_list|)
expr_stmt|;
comment|/* Update response queue pointer */
name|res_out
operator|=
operator|(
name|res_out
operator|&
operator|~
name|sc
operator|->
name|sc_edma_resos_mask
operator|)
operator||
operator|(
operator|(
operator|(
name|slot
operator|+
literal|1
operator|)
operator|<<
name|SATA_EDMA_RESOS_OFS
operator|)
operator|&
name|sc
operator|->
name|sc_edma_resos_mask
operator|)
expr_stmt|;
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_EDMA_RESOPR
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|,
name|res_out
argument_list|)
expr_stmt|;
comment|/* Ack DMA interrupt if there is nothing more to do */
name|res_in
operator|=
name|SATA_INL
argument_list|(
name|sc
argument_list|,
name|SATA_EDMA_RESIPR
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|)
expr_stmt|;
name|res_in
operator|&=
name|sc
operator|->
name|sc_edma_resos_mask
expr_stmt|;
name|res_out
operator|&=
name|sc
operator|->
name|sc_edma_resos_mask
expr_stmt|;
if|if
condition|(
name|res_in
operator|==
name|res_out
condition|)
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_ICR
argument_list|,
operator|~
name|SATA_ICR_DMADONE
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Update progress */
if|if
condition|(
operator|!
operator|(
name|request
operator|->
name|status
operator|&
name|ATA_S_ERROR
operator|)
operator|&&
operator|!
operator|(
name|request
operator|->
name|flags
operator|&
name|ATA_R_TIMEOUT
operator|)
condition|)
name|request
operator|->
name|donecount
operator|=
name|request
operator|->
name|bytecount
expr_stmt|;
comment|/* Unload DMA data */
name|ch
operator|->
name|dma
operator|.
name|unload
argument_list|(
name|request
argument_list|)
expr_stmt|;
return|return
operator|(
name|ATA_OP_FINISHED
operator|)
return|;
block|}
comment|/* Legacy ATA interrupt */
return|return
operator|(
name|ata_end_transaction
argument_list|(
name|request
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sata_channel_status
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|sata_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
decl_stmt|;
name|uint32_t
name|icr
decl_stmt|,
name|iecr
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|ch
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|icr
operator|=
name|SATA_INL
argument_list|(
name|sc
argument_list|,
name|SATA_ICR
argument_list|)
expr_stmt|;
name|iecr
operator|=
name|SATA_INL
argument_list|(
name|sc
argument_list|,
name|SATA_EDMA_IECR
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|icr
operator|&
name|SATA_ICR_DEV
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
operator|)
operator|||
name|iecr
condition|)
block|{
comment|/* Disable EDMA before accessing SATA registers */
name|sata_edma_ctrl
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ata_sata_phy_check_events
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Ack device and error interrupt */
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_ICR
argument_list|,
operator|~
name|SATA_ICR_DEV
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|)
expr_stmt|;
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_EDMA_IECR
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|icr
operator|&=
name|SATA_ICR_DEV
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
operator||
name|SATA_ICR_DMADONE
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
expr_stmt|;
return|return
operator|(
name|icr
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sata_channel_reset
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|sata_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|ch
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
comment|/* Disable EDMA before using legacy registers */
name|sata_edma_ctrl
argument_list|(
name|dev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Mask all EDMA interrups */
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_EDMA_IEMR
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Reset EDMA */
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_EDMA_CMD
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|,
name|SATA_EDMA_CMD_RESET
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
literal|25
argument_list|)
expr_stmt|;
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_EDMA_CMD
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Reset PHY and device */
if|if
condition|(
name|ata_sata_phy_reset
argument_list|(
name|dev
argument_list|,
operator|-
literal|1
argument_list|,
literal|1
argument_list|)
condition|)
name|ata_generic_reset
argument_list|(
name|dev
argument_list|)
expr_stmt|;
else|else
name|ch
operator|->
name|devices
operator|=
literal|0
expr_stmt|;
comment|/* Clear EDMA errors */
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_SATA_FISICR
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_EDMA_IECR
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Unmask all EDMA interrups */
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_EDMA_IEMR
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|,
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|sata_channel_setmode
parameter_list|(
name|device_t
name|parent
parameter_list|,
name|int
name|target
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
comment|/* Disable EDMA before using legacy registers */
name|sata_edma_ctrl
argument_list|(
name|parent
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|ata_sata_setmode
argument_list|(
name|parent
argument_list|,
name|target
argument_list|,
name|mode
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sata_channel_getrev
parameter_list|(
name|device_t
name|parent
parameter_list|,
name|int
name|target
parameter_list|)
block|{
comment|/* Disable EDMA before using legacy registers */
name|sata_edma_ctrl
argument_list|(
name|parent
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|ata_sata_getrev
argument_list|(
name|parent
argument_list|,
name|target
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sata_channel_dmasetprd
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|,
name|bus_dma_segment_t
modifier|*
name|segs
parameter_list|,
name|int
name|nsegs
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|struct
name|ata_dmasetprd_args
modifier|*
name|args
decl_stmt|;
name|struct
name|sata_prdentry
modifier|*
name|prd
decl_stmt|;
name|int
name|i
decl_stmt|;
name|args
operator|=
name|xsc
expr_stmt|;
name|prd
operator|=
name|args
operator|->
name|dmatab
expr_stmt|;
if|if
condition|(
operator|(
name|args
operator|->
name|error
operator|=
name|error
operator|)
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nsegs
condition|;
name|i
operator|++
control|)
block|{
name|prd
index|[
name|i
index|]
operator|.
name|prd_addrlo
operator|=
name|htole32
argument_list|(
name|segs
index|[
name|i
index|]
operator|.
name|ds_addr
argument_list|)
expr_stmt|;
name|prd
index|[
name|i
index|]
operator|.
name|prd_addrhi
operator|=
name|htole32
argument_list|(
operator|(
name|uint64_t
operator|)
name|segs
index|[
name|i
index|]
operator|.
name|ds_addr
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|prd
index|[
name|i
index|]
operator|.
name|prd_count
operator|=
name|htole32
argument_list|(
name|segs
index|[
name|i
index|]
operator|.
name|ds_len
argument_list|)
expr_stmt|;
block|}
name|prd
index|[
name|i
operator|-
literal|1
index|]
operator|.
name|prd_count
operator||=
name|htole32
argument_list|(
name|ATA_DMA_EOT
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|nsegs
operator|<=
name|ATA_DMA_ENTRIES
argument_list|,
operator|(
literal|"too many DMA segment entries.\n"
operator|)
argument_list|)
expr_stmt|;
name|args
operator|->
name|nsegs
operator|=
name|nsegs
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|sata_edma_ctrl
parameter_list|(
name|device_t
name|dev
parameter_list|,
name|int
name|on
parameter_list|)
block|{
name|struct
name|sata_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
decl_stmt|;
name|int
name|bit
decl_stmt|,
name|timeout
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|ch
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|bit
operator|=
name|on
condition|?
name|SATA_EDMA_CMD_ENABLE
else|:
name|SATA_EDMA_CMD_DISABLE
expr_stmt|;
name|timeout
operator|=
name|EDMA_TIMEOUT
expr_stmt|;
name|SATA_OUTL
argument_list|(
name|sc
argument_list|,
name|SATA_EDMA_CMD
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|,
name|bit
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|reg
operator|=
name|SATA_INL
argument_list|(
name|sc
argument_list|,
name|SATA_EDMA_CMD
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Enable bit will be 1 after disable command completion */
if|if
condition|(
name|on
operator|&&
operator|(
name|reg
operator|&
name|SATA_EDMA_CMD_ENABLE
operator|)
condition|)
break|break;
comment|/* Disable bit will be 0 after disable command completion */
if|if
condition|(
operator|!
name|on
operator|&&
operator|!
operator|(
name|reg
operator|&
name|SATA_EDMA_CMD_DISABLE
operator|)
condition|)
break|break;
if|if
condition|(
name|timeout
operator|--
operator|<=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"EDMA command timeout!\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ETIMEDOUT
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sata_edma_is_running
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|sata_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ata_channel
modifier|*
name|ch
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|device_get_parent
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|ch
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
name|SATA_INL
argument_list|(
name|sc
argument_list|,
name|SATA_EDMA_CMD
argument_list|(
name|ch
operator|->
name|unit
argument_list|)
argument_list|)
operator|&
name|SATA_EDMA_CMD_ENABLE
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|sata_channel_methods
index|[]
init|=
block|{
comment|/* Device interface. */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|sata_channel_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|sata_channel_attach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_detach
argument_list|,
name|sata_channel_detach
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_shutdown
argument_list|,
name|bus_generic_shutdown
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_suspend
argument_list|,
name|ata_suspend
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_resume
argument_list|,
name|ata_resume
argument_list|)
block|,
comment|/* ATA channel interface */
name|DEVMETHOD
argument_list|(
name|ata_reset
argument_list|,
name|sata_channel_reset
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|ata_setmode
argument_list|,
name|sata_channel_setmode
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|ata_getrev
argument_list|,
name|sata_channel_getrev
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|driver_t
name|sata_channel_driver
init|=
block|{
literal|"ata"
block|,
name|sata_channel_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|ata_channel
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|ata
argument_list|,
name|sata
argument_list|,
name|sata_channel_driver
argument_list|,
name|ata_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


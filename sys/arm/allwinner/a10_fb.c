begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2016 Jared McNeill<jmcneill@invisible.ca>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,  * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED  * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_comment
comment|/*  * Allwinner A10/A20 Framebuffer  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_include
include|#
directive|include
file|<sys/rman.h>
end_include

begin_include
include|#
directive|include
file|<sys/condvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/fbio.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_extern.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_kern.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<machine/bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus.h>
end_include

begin_include
include|#
directive|include
file|<dev/ofw/ofw_bus_subr.h>
end_include

begin_include
include|#
directive|include
file|<dev/videomode/videomode.h>
end_include

begin_include
include|#
directive|include
file|<dev/videomode/edidvar.h>
end_include

begin_include
include|#
directive|include
file|<dev/extres/clk/clk.h>
end_include

begin_include
include|#
directive|include
file|<dev/extres/hwreset/hwreset.h>
end_include

begin_include
include|#
directive|include
file|"fb_if.h"
end_include

begin_include
include|#
directive|include
file|"hdmi_if.h"
end_include

begin_define
define|#
directive|define
name|FB_DEFAULT_W
value|800
end_define

begin_define
define|#
directive|define
name|FB_DEFAULT_H
value|600
end_define

begin_define
define|#
directive|define
name|FB_DEFAULT_REF
value|60
end_define

begin_define
define|#
directive|define
name|FB_BPP
value|32
end_define

begin_define
define|#
directive|define
name|FB_ALIGN
value|0x1000
end_define

begin_define
define|#
directive|define
name|HDMI_ENABLE_DELAY
value|20000
end_define

begin_define
define|#
directive|define
name|DEBE_FREQ
value|300000000
end_define

begin_define
define|#
directive|define
name|DOT_CLOCK_TO_HZ
parameter_list|(
name|c
parameter_list|)
value|((c) * 1000)
end_define

begin_comment
comment|/* Display backend */
end_comment

begin_define
define|#
directive|define
name|DEBE_REG_START
value|0x800
end_define

begin_define
define|#
directive|define
name|DEBE_REG_END
value|0x1000
end_define

begin_define
define|#
directive|define
name|DEBE_REG_WIDTH
value|4
end_define

begin_define
define|#
directive|define
name|DEBE_MODCTL
value|0x800
end_define

begin_define
define|#
directive|define
name|MODCTL_ITLMOD_EN
value|(1<< 28)
end_define

begin_define
define|#
directive|define
name|MODCTL_OUT_SEL_MASK
value|(0x7<< 20)
end_define

begin_define
define|#
directive|define
name|MODCTL_OUT_SEL
parameter_list|(
name|sel
parameter_list|)
value|((sel)<< 20)
end_define

begin_define
define|#
directive|define
name|OUT_SEL_LCD
value|0
end_define

begin_define
define|#
directive|define
name|MODCTL_LAY0_EN
value|(1<< 8)
end_define

begin_define
define|#
directive|define
name|MODCTL_START_CTL
value|(1<< 1)
end_define

begin_define
define|#
directive|define
name|MODCTL_EN
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|DEBE_DISSIZE
value|0x808
end_define

begin_define
define|#
directive|define
name|DIS_HEIGHT
parameter_list|(
name|h
parameter_list|)
value|(((h) - 1)<< 16)
end_define

begin_define
define|#
directive|define
name|DIS_WIDTH
parameter_list|(
name|w
parameter_list|)
value|(((w) - 1)<< 0)
end_define

begin_define
define|#
directive|define
name|DEBE_LAYSIZE0
value|0x810
end_define

begin_define
define|#
directive|define
name|LAY_HEIGHT
parameter_list|(
name|h
parameter_list|)
value|(((h) - 1)<< 16)
end_define

begin_define
define|#
directive|define
name|LAY_WIDTH
parameter_list|(
name|w
parameter_list|)
value|(((w) - 1)<< 0)
end_define

begin_define
define|#
directive|define
name|DEBE_LAYCOOR0
value|0x820
end_define

begin_define
define|#
directive|define
name|LAY_XCOOR
parameter_list|(
name|x
parameter_list|)
value|((x)<< 16)
end_define

begin_define
define|#
directive|define
name|LAY_YCOOR
parameter_list|(
name|y
parameter_list|)
value|((y)<< 0)
end_define

begin_define
define|#
directive|define
name|DEBE_LAYLINEWIDTH0
value|0x840
end_define

begin_define
define|#
directive|define
name|DEBE_LAYFB_L32ADD0
value|0x850
end_define

begin_define
define|#
directive|define
name|LAYFB_L32ADD
parameter_list|(
name|pa
parameter_list|)
value|((pa)<< 3)
end_define

begin_define
define|#
directive|define
name|DEBE_LAYFB_H4ADD
value|0x860
end_define

begin_define
define|#
directive|define
name|LAY0FB_H4ADD
parameter_list|(
name|pa
parameter_list|)
value|((pa)>> 29)
end_define

begin_define
define|#
directive|define
name|DEBE_REGBUFFCTL
value|0x870
end_define

begin_define
define|#
directive|define
name|REGBUFFCTL_LOAD
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|DEBE_ATTCTL1
value|0x8a0
end_define

begin_define
define|#
directive|define
name|ATTCTL1_FBFMT
parameter_list|(
name|fmt
parameter_list|)
value|((fmt)<< 8)
end_define

begin_define
define|#
directive|define
name|FBFMT_XRGB8888
value|9
end_define

begin_define
define|#
directive|define
name|ATTCTL1_FBPS
parameter_list|(
name|ps
parameter_list|)
value|((ps)<< 0)
end_define

begin_define
define|#
directive|define
name|FBPS_32BPP_ARGB
value|0
end_define

begin_comment
comment|/* Timing controller */
end_comment

begin_define
define|#
directive|define
name|TCON_GCTL
value|0x000
end_define

begin_define
define|#
directive|define
name|GCTL_TCON_EN
value|(1<< 31)
end_define

begin_define
define|#
directive|define
name|GCTL_IO_MAP_SEL_TCON1
value|(1<< 0)
end_define

begin_define
define|#
directive|define
name|TCON_GINT1
value|0x008
end_define

begin_define
define|#
directive|define
name|GINT1_TCON1_LINENO
parameter_list|(
name|n
parameter_list|)
value|(((n) + 2)<< 0)
end_define

begin_define
define|#
directive|define
name|TCON0_DCLK
value|0x044
end_define

begin_define
define|#
directive|define
name|DCLK_EN
value|0xf0000000
end_define

begin_define
define|#
directive|define
name|TCON1_CTL
value|0x090
end_define

begin_define
define|#
directive|define
name|TCON1_EN
value|(1<< 31)
end_define

begin_define
define|#
directive|define
name|INTERLACE_EN
value|(1<< 20)
end_define

begin_define
define|#
directive|define
name|TCON1_SRC_SEL
parameter_list|(
name|src
parameter_list|)
value|((src)<< 0)
end_define

begin_define
define|#
directive|define
name|TCON1_SRC_CH1
value|0
end_define

begin_define
define|#
directive|define
name|TCON1_SRC_CH2
value|1
end_define

begin_define
define|#
directive|define
name|TCON1_SRC_BLUE
value|2
end_define

begin_define
define|#
directive|define
name|TCON1_START_DELAY
parameter_list|(
name|sd
parameter_list|)
value|((sd)<< 4)
end_define

begin_define
define|#
directive|define
name|TCON1_BASIC0
value|0x094
end_define

begin_define
define|#
directive|define
name|TCON1_BASIC1
value|0x098
end_define

begin_define
define|#
directive|define
name|TCON1_BASIC2
value|0x09c
end_define

begin_define
define|#
directive|define
name|TCON1_BASIC3
value|0x0a0
end_define

begin_define
define|#
directive|define
name|TCON1_BASIC4
value|0x0a4
end_define

begin_define
define|#
directive|define
name|TCON1_BASIC5
value|0x0a8
end_define

begin_define
define|#
directive|define
name|BASIC_X
parameter_list|(
name|x
parameter_list|)
value|(((x) - 1)<< 16)
end_define

begin_define
define|#
directive|define
name|BASIC_Y
parameter_list|(
name|y
parameter_list|)
value|(((y) - 1)<< 0)
end_define

begin_define
define|#
directive|define
name|BASIC3_HT
parameter_list|(
name|ht
parameter_list|)
value|(((ht) - 1)<< 16)
end_define

begin_define
define|#
directive|define
name|BASIC3_HBP
parameter_list|(
name|hbp
parameter_list|)
value|(((hbp) - 1)<< 0)
end_define

begin_define
define|#
directive|define
name|BASIC4_VT
parameter_list|(
name|vt
parameter_list|)
value|((vt)<< 16)
end_define

begin_define
define|#
directive|define
name|BASIC4_VBP
parameter_list|(
name|vbp
parameter_list|)
value|(((vbp) - 1)<< 0)
end_define

begin_define
define|#
directive|define
name|BASIC5_HSPW
parameter_list|(
name|hspw
parameter_list|)
value|(((hspw) - 1)<< 16)
end_define

begin_define
define|#
directive|define
name|BASIC5_VSPW
parameter_list|(
name|vspw
parameter_list|)
value|(((vspw) - 1)<< 0)
end_define

begin_define
define|#
directive|define
name|TCON1_IO_POL
value|0x0f0
end_define

begin_define
define|#
directive|define
name|IO_POL_IO2_INV
value|(1<< 26)
end_define

begin_define
define|#
directive|define
name|IO_POL_PHSYNC
value|(1<< 25)
end_define

begin_define
define|#
directive|define
name|IO_POL_PVSYNC
value|(1<< 24)
end_define

begin_define
define|#
directive|define
name|TCON1_IO_TRI
value|0x0f4
end_define

begin_define
define|#
directive|define
name|IO0_OUTPUT_TRI_EN
value|(1<< 24)
end_define

begin_define
define|#
directive|define
name|IO1_OUTPUT_TRI_EN
value|(1<< 25)
end_define

begin_define
define|#
directive|define
name|IO_TRI_MASK
value|0xffffffff
end_define

begin_define
define|#
directive|define
name|START_DELAY
parameter_list|(
name|vbl
parameter_list|)
value|(MIN(32, (vbl)) - 2)
end_define

begin_define
define|#
directive|define
name|VBLANK_LEN
parameter_list|(
name|vt
parameter_list|,
name|vd
parameter_list|,
name|i
parameter_list|)
value|((((vt)<< (i))>> 1) - (vd) - 2)
end_define

begin_define
define|#
directive|define
name|VTOTAL
parameter_list|(
name|vt
parameter_list|)
value|((vt) * 2)
end_define

begin_define
define|#
directive|define
name|DIVIDE
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
value|(((x) + ((y) / 2)) / (y))
end_define

begin_struct
struct|struct
name|a10fb_softc
block|{
name|device_t
name|dev
decl_stmt|;
name|device_t
name|fbdev
decl_stmt|;
name|struct
name|resource
modifier|*
name|res
index|[
literal|2
index|]
decl_stmt|;
comment|/* Framebuffer */
name|struct
name|fb_info
name|info
decl_stmt|;
name|size_t
name|fbsize
decl_stmt|;
name|bus_addr_t
name|paddr
decl_stmt|;
name|vm_offset_t
name|vaddr
decl_stmt|;
comment|/* HDMI */
name|eventhandler_tag
name|hdmi_evh
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|resource_spec
name|a10fb_spec
index|[]
init|=
block|{
block|{
name|SYS_RES_MEMORY
block|,
literal|0
block|,
name|RF_ACTIVE
block|}
block|,
comment|/* DEBE */
block|{
name|SYS_RES_MEMORY
block|,
literal|1
block|,
name|RF_ACTIVE
block|}
block|,
comment|/* TCON */
block|{
operator|-
literal|1
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|DEBE_READ
parameter_list|(
name|sc
parameter_list|,
name|reg
parameter_list|)
value|bus_read_4((sc)->res[0], (reg))
end_define

begin_define
define|#
directive|define
name|DEBE_WRITE
parameter_list|(
name|sc
parameter_list|,
name|reg
parameter_list|,
name|val
parameter_list|)
value|bus_write_4((sc)->res[0], (reg), (val))
end_define

begin_define
define|#
directive|define
name|TCON_READ
parameter_list|(
name|sc
parameter_list|,
name|reg
parameter_list|)
value|bus_read_4((sc)->res[1], (reg))
end_define

begin_define
define|#
directive|define
name|TCON_WRITE
parameter_list|(
name|sc
parameter_list|,
name|reg
parameter_list|,
name|val
parameter_list|)
value|bus_write_4((sc)->res[1], (reg), (val))
end_define

begin_function
specifier|static
name|int
name|a10fb_allocfb
parameter_list|(
name|struct
name|a10fb_softc
modifier|*
name|sc
parameter_list|)
block|{
name|sc
operator|->
name|vaddr
operator|=
name|kmem_alloc_contig
argument_list|(
name|kernel_arena
argument_list|,
name|sc
operator|->
name|fbsize
argument_list|,
name|M_NOWAIT
operator||
name|M_ZERO
argument_list|,
literal|0
argument_list|,
operator|~
literal|0
argument_list|,
name|FB_ALIGN
argument_list|,
literal|0
argument_list|,
name|VM_MEMATTR_WRITE_COMBINING
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vaddr
operator|==
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"failed to allocate FB memory\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|sc
operator|->
name|paddr
operator|=
name|pmap_kextract
argument_list|(
name|sc
operator|->
name|vaddr
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|a10fb_freefb
parameter_list|(
name|struct
name|a10fb_softc
modifier|*
name|sc
parameter_list|)
block|{
name|kmem_free
argument_list|(
name|kernel_arena
argument_list|,
name|sc
operator|->
name|vaddr
argument_list|,
name|sc
operator|->
name|fbsize
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|a10fb_setup_debe
parameter_list|(
name|struct
name|a10fb_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|struct
name|videomode
modifier|*
name|mode
parameter_list|)
block|{
name|int
name|width
decl_stmt|,
name|height
decl_stmt|,
name|interlace
decl_stmt|,
name|reg
decl_stmt|;
name|clk_t
name|clk_ahb
decl_stmt|,
name|clk_dram
decl_stmt|,
name|clk_debe
decl_stmt|;
name|hwreset_t
name|rst
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|int
name|error
decl_stmt|;
name|interlace
operator|=
operator|!
operator|!
operator|(
name|mode
operator|->
name|flags
operator|&
name|VID_INTERLACE
operator|)
expr_stmt|;
name|width
operator|=
name|mode
operator|->
name|hdisplay
expr_stmt|;
name|height
operator|=
name|mode
operator|->
name|vdisplay
operator|<<
name|interlace
expr_stmt|;
comment|/* Leave reset */
name|error
operator|=
name|hwreset_get_by_ofw_name
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"de_be"
argument_list|,
operator|&
name|rst
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"cannot find reset 'de_be'\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|error
operator|=
name|hwreset_deassert
argument_list|(
name|rst
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"couldn't de-assert reset 'de_be'\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Gating AHB clock for BE */
name|error
operator|=
name|clk_get_by_ofw_name
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"ahb_de_be"
argument_list|,
operator|&
name|clk_ahb
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"cannot find clk 'ahb_de_be'\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|error
operator|=
name|clk_enable
argument_list|(
name|clk_ahb
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"cannot enable clk 'ahb_de_be'\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Enable DRAM clock to BE */
name|error
operator|=
name|clk_get_by_ofw_name
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"dram_de_be"
argument_list|,
operator|&
name|clk_dram
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"cannot find clk 'dram_de_be'\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|error
operator|=
name|clk_enable
argument_list|(
name|clk_dram
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"cannot enable clk 'dram_de_be'\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Set BE clock to 300MHz and enable */
name|error
operator|=
name|clk_get_by_ofw_name
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"de_be"
argument_list|,
operator|&
name|clk_debe
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"cannot find clk 'de_be'\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|error
operator|=
name|clk_set_freq
argument_list|(
name|clk_debe
argument_list|,
name|DEBE_FREQ
argument_list|,
name|CLK_SET_ROUND_DOWN
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"cannot set 'de_be' frequency\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|error
operator|=
name|clk_enable
argument_list|(
name|clk_debe
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"cannot enable clk 'de_be'\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Initialize all registers to 0 */
for|for
control|(
name|reg
operator|=
name|DEBE_REG_START
init|;
name|reg
operator|<
name|DEBE_REG_END
condition|;
name|reg
operator|+=
name|DEBE_REG_WIDTH
control|)
name|DEBE_WRITE
argument_list|(
name|sc
argument_list|,
name|reg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Enable display backend */
name|DEBE_WRITE
argument_list|(
name|sc
argument_list|,
name|DEBE_MODCTL
argument_list|,
name|MODCTL_EN
argument_list|)
expr_stmt|;
comment|/* Set display size */
name|DEBE_WRITE
argument_list|(
name|sc
argument_list|,
name|DEBE_DISSIZE
argument_list|,
name|DIS_HEIGHT
argument_list|(
name|height
argument_list|)
operator||
name|DIS_WIDTH
argument_list|(
name|width
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Set layer 0 size, position, and stride */
name|DEBE_WRITE
argument_list|(
name|sc
argument_list|,
name|DEBE_LAYSIZE0
argument_list|,
name|LAY_HEIGHT
argument_list|(
name|height
argument_list|)
operator||
name|LAY_WIDTH
argument_list|(
name|width
argument_list|)
argument_list|)
expr_stmt|;
name|DEBE_WRITE
argument_list|(
name|sc
argument_list|,
name|DEBE_LAYCOOR0
argument_list|,
name|LAY_XCOOR
argument_list|(
literal|0
argument_list|)
operator||
name|LAY_YCOOR
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|DEBE_WRITE
argument_list|(
name|sc
argument_list|,
name|DEBE_LAYLINEWIDTH0
argument_list|,
name|width
operator|*
name|FB_BPP
argument_list|)
expr_stmt|;
comment|/* Point layer 0 to FB memory */
name|DEBE_WRITE
argument_list|(
name|sc
argument_list|,
name|DEBE_LAYFB_L32ADD0
argument_list|,
name|LAYFB_L32ADD
argument_list|(
name|sc
operator|->
name|paddr
argument_list|)
argument_list|)
expr_stmt|;
name|DEBE_WRITE
argument_list|(
name|sc
argument_list|,
name|DEBE_LAYFB_H4ADD
argument_list|,
name|LAY0FB_H4ADD
argument_list|(
name|sc
operator|->
name|paddr
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Set backend format and pixel sequence */
name|DEBE_WRITE
argument_list|(
name|sc
argument_list|,
name|DEBE_ATTCTL1
argument_list|,
name|ATTCTL1_FBFMT
argument_list|(
name|FBFMT_XRGB8888
argument_list|)
operator||
name|ATTCTL1_FBPS
argument_list|(
name|FBPS_32BPP_ARGB
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Enable layer 0, output to LCD, setup interlace */
name|val
operator|=
name|DEBE_READ
argument_list|(
name|sc
argument_list|,
name|DEBE_MODCTL
argument_list|)
expr_stmt|;
name|val
operator||=
name|MODCTL_LAY0_EN
expr_stmt|;
name|val
operator|&=
operator|~
name|MODCTL_OUT_SEL_MASK
expr_stmt|;
name|val
operator||=
name|MODCTL_OUT_SEL
argument_list|(
name|OUT_SEL_LCD
argument_list|)
expr_stmt|;
if|if
condition|(
name|interlace
condition|)
name|val
operator||=
name|MODCTL_ITLMOD_EN
expr_stmt|;
else|else
name|val
operator|&=
operator|~
name|MODCTL_ITLMOD_EN
expr_stmt|;
name|DEBE_WRITE
argument_list|(
name|sc
argument_list|,
name|DEBE_MODCTL
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* Commit settings */
name|DEBE_WRITE
argument_list|(
name|sc
argument_list|,
name|DEBE_REGBUFFCTL
argument_list|,
name|REGBUFFCTL_LOAD
argument_list|)
expr_stmt|;
comment|/* Start DEBE */
name|val
operator|=
name|DEBE_READ
argument_list|(
name|sc
argument_list|,
name|DEBE_MODCTL
argument_list|)
expr_stmt|;
name|val
operator||=
name|MODCTL_START_CTL
expr_stmt|;
name|DEBE_WRITE
argument_list|(
name|sc
argument_list|,
name|DEBE_MODCTL
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|a10fb_setup_pll
parameter_list|(
name|struct
name|a10fb_softc
modifier|*
name|sc
parameter_list|,
name|uint64_t
name|freq
parameter_list|)
block|{
name|clk_t
name|clk_sclk1
decl_stmt|,
name|clk_sclk2
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|clk_get_by_ofw_name
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"lcd_ch1_sclk1"
argument_list|,
operator|&
name|clk_sclk1
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"cannot find clk 'lcd_ch1_sclk1'\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|error
operator|=
name|clk_get_by_ofw_name
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"lcd_ch1_sclk2"
argument_list|,
operator|&
name|clk_sclk2
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"cannot find clk 'lcd_ch1_sclk2'\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|error
operator|=
name|clk_set_freq
argument_list|(
name|clk_sclk2
argument_list|,
name|freq
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"cannot set lcd ch1 frequency\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|error
operator|=
name|clk_enable
argument_list|(
name|clk_sclk2
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"cannot enable lcd ch1 sclk2\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|error
operator|=
name|clk_enable
argument_list|(
name|clk_sclk1
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"cannot enable lcd ch1 sclk1\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|a10fb_setup_tcon
parameter_list|(
name|struct
name|a10fb_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|struct
name|videomode
modifier|*
name|mode
parameter_list|)
block|{
name|u_int
name|interlace
decl_stmt|,
name|hspw
decl_stmt|,
name|hbp
decl_stmt|,
name|vspw
decl_stmt|,
name|vbp
decl_stmt|,
name|vbl
decl_stmt|,
name|width
decl_stmt|,
name|height
decl_stmt|,
name|start_delay
decl_stmt|;
name|u_int
name|vtotal
decl_stmt|,
name|framerate
decl_stmt|,
name|clk
decl_stmt|;
name|clk_t
name|clk_ahb
decl_stmt|;
name|hwreset_t
name|rst
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|int
name|error
decl_stmt|;
name|interlace
operator|=
operator|!
operator|!
operator|(
name|mode
operator|->
name|flags
operator|&
name|VID_INTERLACE
operator|)
expr_stmt|;
name|width
operator|=
name|mode
operator|->
name|hdisplay
expr_stmt|;
name|height
operator|=
name|mode
operator|->
name|vdisplay
expr_stmt|;
name|hspw
operator|=
name|mode
operator|->
name|hsync_end
operator|-
name|mode
operator|->
name|hsync_start
expr_stmt|;
name|hbp
operator|=
name|mode
operator|->
name|htotal
operator|-
name|mode
operator|->
name|hsync_start
expr_stmt|;
name|vspw
operator|=
name|mode
operator|->
name|vsync_end
operator|-
name|mode
operator|->
name|vsync_start
expr_stmt|;
name|vbp
operator|=
name|mode
operator|->
name|vtotal
operator|-
name|mode
operator|->
name|vsync_start
expr_stmt|;
name|vbl
operator|=
name|VBLANK_LEN
argument_list|(
name|mode
operator|->
name|vtotal
argument_list|,
name|mode
operator|->
name|vdisplay
argument_list|,
name|interlace
argument_list|)
expr_stmt|;
name|start_delay
operator|=
name|START_DELAY
argument_list|(
name|vbl
argument_list|)
expr_stmt|;
comment|/* Leave reset */
name|error
operator|=
name|hwreset_get_by_ofw_name
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"lcd"
argument_list|,
operator|&
name|rst
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"cannot find reset 'lcd'\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|error
operator|=
name|hwreset_deassert
argument_list|(
name|rst
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"couldn't de-assert reset 'lcd'\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Gating AHB clock for LCD */
name|error
operator|=
name|clk_get_by_ofw_name
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"ahb_lcd"
argument_list|,
operator|&
name|clk_ahb
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"cannot find clk 'ahb_lcd'\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|error
operator|=
name|clk_enable
argument_list|(
name|clk_ahb
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"cannot enable clk 'ahb_lcd'\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* Disable TCON and TCON1 */
name|TCON_WRITE
argument_list|(
name|sc
argument_list|,
name|TCON_GCTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|TCON_WRITE
argument_list|(
name|sc
argument_list|,
name|TCON1_CTL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Enable clocks */
name|TCON_WRITE
argument_list|(
name|sc
argument_list|,
name|TCON0_DCLK
argument_list|,
name|DCLK_EN
argument_list|)
expr_stmt|;
comment|/* Disable IO and data output ports */
name|TCON_WRITE
argument_list|(
name|sc
argument_list|,
name|TCON1_IO_TRI
argument_list|,
name|IO_TRI_MASK
argument_list|)
expr_stmt|;
comment|/* Disable TCON and select TCON1 */
name|TCON_WRITE
argument_list|(
name|sc
argument_list|,
name|TCON_GCTL
argument_list|,
name|GCTL_IO_MAP_SEL_TCON1
argument_list|)
expr_stmt|;
comment|/* Source width and height */
name|TCON_WRITE
argument_list|(
name|sc
argument_list|,
name|TCON1_BASIC0
argument_list|,
name|BASIC_X
argument_list|(
name|width
argument_list|)
operator||
name|BASIC_Y
argument_list|(
name|height
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Scaler width and height */
name|TCON_WRITE
argument_list|(
name|sc
argument_list|,
name|TCON1_BASIC1
argument_list|,
name|BASIC_X
argument_list|(
name|width
argument_list|)
operator||
name|BASIC_Y
argument_list|(
name|height
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Output width and height */
name|TCON_WRITE
argument_list|(
name|sc
argument_list|,
name|TCON1_BASIC2
argument_list|,
name|BASIC_X
argument_list|(
name|width
argument_list|)
operator||
name|BASIC_Y
argument_list|(
name|height
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Horizontal total and back porch */
name|TCON_WRITE
argument_list|(
name|sc
argument_list|,
name|TCON1_BASIC3
argument_list|,
name|BASIC3_HT
argument_list|(
name|mode
operator|->
name|htotal
argument_list|)
operator||
name|BASIC3_HBP
argument_list|(
name|hbp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Vertical total and back porch */
name|vtotal
operator|=
name|VTOTAL
argument_list|(
name|mode
operator|->
name|vtotal
argument_list|)
expr_stmt|;
if|if
condition|(
name|interlace
condition|)
block|{
name|framerate
operator|=
name|DIVIDE
argument_list|(
name|DIVIDE
argument_list|(
name|DOT_CLOCK_TO_HZ
argument_list|(
name|mode
operator|->
name|dot_clock
argument_list|)
argument_list|,
name|mode
operator|->
name|htotal
argument_list|)
argument_list|,
name|mode
operator|->
name|vtotal
argument_list|)
expr_stmt|;
name|clk
operator|=
name|mode
operator|->
name|htotal
operator|*
operator|(
name|VTOTAL
argument_list|(
name|mode
operator|->
name|vtotal
argument_list|)
operator|+
literal|1
operator|)
operator|*
name|framerate
expr_stmt|;
if|if
condition|(
operator|(
name|clk
operator|/
literal|2
operator|)
operator|==
name|DOT_CLOCK_TO_HZ
argument_list|(
name|mode
operator|->
name|dot_clock
argument_list|)
condition|)
name|vtotal
operator|+=
literal|1
expr_stmt|;
block|}
name|TCON_WRITE
argument_list|(
name|sc
argument_list|,
name|TCON1_BASIC4
argument_list|,
name|BASIC4_VT
argument_list|(
name|vtotal
argument_list|)
operator||
name|BASIC4_VBP
argument_list|(
name|vbp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Horizontal and vertical sync */
name|TCON_WRITE
argument_list|(
name|sc
argument_list|,
name|TCON1_BASIC5
argument_list|,
name|BASIC5_HSPW
argument_list|(
name|hspw
argument_list|)
operator||
name|BASIC5_VSPW
argument_list|(
name|vspw
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Polarity */
name|val
operator|=
name|IO_POL_IO2_INV
expr_stmt|;
if|if
condition|(
name|mode
operator|->
name|flags
operator|&
name|VID_PHSYNC
condition|)
name|val
operator||=
name|IO_POL_PHSYNC
expr_stmt|;
if|if
condition|(
name|mode
operator|->
name|flags
operator|&
name|VID_PVSYNC
condition|)
name|val
operator||=
name|IO_POL_PVSYNC
expr_stmt|;
name|TCON_WRITE
argument_list|(
name|sc
argument_list|,
name|TCON1_IO_POL
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* Set scan line for TCON1 line trigger */
name|TCON_WRITE
argument_list|(
name|sc
argument_list|,
name|TCON_GINT1
argument_list|,
name|GINT1_TCON1_LINENO
argument_list|(
name|start_delay
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Enable TCON1 */
name|val
operator|=
name|TCON1_EN
expr_stmt|;
if|if
condition|(
name|interlace
condition|)
name|val
operator||=
name|INTERLACE_EN
expr_stmt|;
name|val
operator||=
name|TCON1_START_DELAY
argument_list|(
name|start_delay
argument_list|)
expr_stmt|;
name|val
operator||=
name|TCON1_SRC_SEL
argument_list|(
name|TCON1_SRC_CH1
argument_list|)
expr_stmt|;
name|TCON_WRITE
argument_list|(
name|sc
argument_list|,
name|TCON1_CTL
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* Setup PLL */
return|return
operator|(
name|a10fb_setup_pll
argument_list|(
name|sc
argument_list|,
name|DOT_CLOCK_TO_HZ
argument_list|(
name|mode
operator|->
name|dot_clock
argument_list|)
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|a10fb_enable_tcon
parameter_list|(
name|struct
name|a10fb_softc
modifier|*
name|sc
parameter_list|,
name|int
name|onoff
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
comment|/* Enable TCON */
name|val
operator|=
name|TCON_READ
argument_list|(
name|sc
argument_list|,
name|TCON_GCTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|onoff
condition|)
name|val
operator||=
name|GCTL_TCON_EN
expr_stmt|;
else|else
name|val
operator|&=
operator|~
name|GCTL_TCON_EN
expr_stmt|;
name|TCON_WRITE
argument_list|(
name|sc
argument_list|,
name|TCON_GCTL
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* Enable TCON1 IO0/IO1 outputs */
name|val
operator|=
name|TCON_READ
argument_list|(
name|sc
argument_list|,
name|TCON1_IO_TRI
argument_list|)
expr_stmt|;
if|if
condition|(
name|onoff
condition|)
name|val
operator|&=
operator|~
operator|(
name|IO0_OUTPUT_TRI_EN
operator||
name|IO1_OUTPUT_TRI_EN
operator|)
expr_stmt|;
else|else
name|val
operator||=
operator|(
name|IO0_OUTPUT_TRI_EN
operator||
name|IO1_OUTPUT_TRI_EN
operator|)
expr_stmt|;
name|TCON_WRITE
argument_list|(
name|sc
argument_list|,
name|TCON1_IO_TRI
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|a10fb_configure
parameter_list|(
name|struct
name|a10fb_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|struct
name|videomode
modifier|*
name|mode
parameter_list|)
block|{
name|size_t
name|fbsize
decl_stmt|;
name|int
name|error
decl_stmt|;
name|fbsize
operator|=
name|round_page
argument_list|(
name|mode
operator|->
name|hdisplay
operator|*
name|mode
operator|->
name|vdisplay
operator|*
operator|(
name|FB_BPP
operator|/
name|NBBY
operator|)
argument_list|)
expr_stmt|;
comment|/* Detach the old FB device */
if|if
condition|(
name|sc
operator|->
name|fbdev
operator|!=
name|NULL
condition|)
block|{
name|device_delete_child
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
name|sc
operator|->
name|fbdev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|fbdev
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* If the FB size has changed, free the old FB memory */
if|if
condition|(
name|sc
operator|->
name|fbsize
operator|>
literal|0
operator|&&
name|sc
operator|->
name|fbsize
operator|!=
name|fbsize
condition|)
block|{
name|a10fb_freefb
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vaddr
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Allocate the FB if necessary */
name|sc
operator|->
name|fbsize
operator|=
name|fbsize
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vaddr
operator|==
literal|0
condition|)
block|{
name|error
operator|=
name|a10fb_allocfb
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"failed to allocate FB memory\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
block|}
comment|/* Setup display backend */
name|error
operator|=
name|a10fb_setup_debe
argument_list|(
name|sc
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* Setup display timing controller */
name|error
operator|=
name|a10fb_setup_tcon
argument_list|(
name|sc
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* Attach framebuffer device */
name|sc
operator|->
name|info
operator|.
name|fb_name
operator|=
name|device_get_nameunit
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|info
operator|.
name|fb_vbase
operator|=
operator|(
name|intptr_t
operator|)
name|sc
operator|->
name|vaddr
expr_stmt|;
name|sc
operator|->
name|info
operator|.
name|fb_pbase
operator|=
name|sc
operator|->
name|paddr
expr_stmt|;
name|sc
operator|->
name|info
operator|.
name|fb_size
operator|=
name|sc
operator|->
name|fbsize
expr_stmt|;
name|sc
operator|->
name|info
operator|.
name|fb_bpp
operator|=
name|sc
operator|->
name|info
operator|.
name|fb_depth
operator|=
name|FB_BPP
expr_stmt|;
name|sc
operator|->
name|info
operator|.
name|fb_stride
operator|=
name|mode
operator|->
name|hdisplay
operator|*
operator|(
name|FB_BPP
operator|/
name|NBBY
operator|)
expr_stmt|;
name|sc
operator|->
name|info
operator|.
name|fb_width
operator|=
name|mode
operator|->
name|hdisplay
expr_stmt|;
name|sc
operator|->
name|info
operator|.
name|fb_height
operator|=
name|mode
operator|->
name|vdisplay
expr_stmt|;
name|sc
operator|->
name|fbdev
operator|=
name|device_add_child
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"fbd"
argument_list|,
name|device_get_unit
argument_list|(
name|sc
operator|->
name|dev
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|fbdev
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"failed to add fbd child\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
name|error
operator|=
name|device_probe_and_attach
argument_list|(
name|sc
operator|->
name|fbdev
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"failed to attach fbd device\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|a10fb_hdmi_event
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|device_t
name|hdmi_dev
parameter_list|)
block|{
specifier|const
name|struct
name|videomode
modifier|*
name|mode
decl_stmt|;
name|struct
name|videomode
name|hdmi_mode
decl_stmt|;
name|struct
name|a10fb_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|edid_info
name|ei
decl_stmt|;
name|uint8_t
modifier|*
name|edid
decl_stmt|;
name|uint32_t
name|edid_len
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
name|arg
expr_stmt|;
name|edid
operator|=
name|NULL
expr_stmt|;
name|edid_len
operator|=
literal|0
expr_stmt|;
name|mode
operator|=
name|NULL
expr_stmt|;
name|error
operator|=
name|HDMI_GET_EDID
argument_list|(
name|hdmi_dev
argument_list|,
operator|&
name|edid
argument_list|,
operator|&
name|edid_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"failed to get EDID: %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|error
operator|=
name|edid_parse
argument_list|(
name|edid
argument_list|,
operator|&
name|ei
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"failed to parse EDID: %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|bootverbose
condition|)
name|edid_print
argument_list|(
operator|&
name|ei
argument_list|)
expr_stmt|;
name|mode
operator|=
name|ei
operator|.
name|edid_preferred_mode
expr_stmt|;
block|}
block|}
comment|/* If the preferred mode could not be determined, use the default */
if|if
condition|(
name|mode
operator|==
name|NULL
condition|)
name|mode
operator|=
name|pick_mode_by_ref
argument_list|(
name|FB_DEFAULT_W
argument_list|,
name|FB_DEFAULT_H
argument_list|,
name|FB_DEFAULT_REF
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|==
name|NULL
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"failed to find usable video mode\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|bootverbose
condition|)
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"using %dx%d\n"
argument_list|,
name|mode
operator|->
name|hdisplay
argument_list|,
name|mode
operator|->
name|vdisplay
argument_list|)
expr_stmt|;
comment|/* Disable HDMI */
name|HDMI_ENABLE
argument_list|(
name|hdmi_dev
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Disable timing controller */
name|a10fb_enable_tcon
argument_list|(
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Configure DEBE and TCON */
name|error
operator|=
name|a10fb_configure
argument_list|(
name|sc
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|device_printf
argument_list|(
name|sc
operator|->
name|dev
argument_list|,
literal|"failed to configure FB: %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return;
block|}
name|hdmi_mode
operator|=
operator|*
name|mode
expr_stmt|;
name|hdmi_mode
operator|.
name|hskew
operator|=
name|mode
operator|->
name|hsync_end
operator|-
name|mode
operator|->
name|hsync_start
expr_stmt|;
name|hdmi_mode
operator|.
name|flags
operator||=
name|VID_HSKEW
expr_stmt|;
name|HDMI_SET_VIDEOMODE
argument_list|(
name|hdmi_dev
argument_list|,
operator|&
name|hdmi_mode
argument_list|)
expr_stmt|;
comment|/* Enable timing controller */
name|a10fb_enable_tcon
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|DELAY
argument_list|(
name|HDMI_ENABLE_DELAY
argument_list|)
expr_stmt|;
comment|/* Enable HDMI */
name|HDMI_ENABLE
argument_list|(
name|hdmi_dev
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|a10fb_probe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
if|if
condition|(
operator|!
name|ofw_bus_status_okay
argument_list|(
name|dev
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
if|if
condition|(
operator|!
name|ofw_bus_is_compatible
argument_list|(
name|dev
argument_list|,
literal|"allwinner,sun7i-a20-fb"
argument_list|)
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|device_set_desc
argument_list|(
name|dev
argument_list|,
literal|"Allwinner Framebuffer"
argument_list|)
expr_stmt|;
return|return
operator|(
name|BUS_PROBE_DEFAULT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|a10fb_attach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|a10fb_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|->
name|dev
operator|=
name|dev
expr_stmt|;
if|if
condition|(
name|bus_alloc_resources
argument_list|(
name|dev
argument_list|,
name|a10fb_spec
argument_list|,
name|sc
operator|->
name|res
argument_list|)
condition|)
block|{
name|device_printf
argument_list|(
name|dev
argument_list|,
literal|"cannot allocate resources for device\n"
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENXIO
operator|)
return|;
block|}
name|sc
operator|->
name|hdmi_evh
operator|=
name|EVENTHANDLER_REGISTER
argument_list|(
name|hdmi_event
argument_list|,
name|a10fb_hdmi_event
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|fb_info
modifier|*
name|a10fb_fb_getinfo
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|struct
name|a10fb_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|device_get_softc
argument_list|(
name|dev
argument_list|)
expr_stmt|;
return|return
operator|(
operator|&
name|sc
operator|->
name|info
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|a10fb_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|a10fb_probe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|a10fb_attach
argument_list|)
block|,
comment|/* FB interface */
name|DEVMETHOD
argument_list|(
name|fb_getinfo
argument_list|,
name|a10fb_fb_getinfo
argument_list|)
block|,
name|DEVMETHOD_END
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|a10fb_driver
init|=
block|{
literal|"fb"
block|,
name|a10fb_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|a10fb_softc
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|a10fb_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|fb
argument_list|,
name|simplebus
argument_list|,
name|a10fb_driver
argument_list|,
name|a10fb_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


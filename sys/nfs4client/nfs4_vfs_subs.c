begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_comment
comment|/* $Id: nfs4_vfs_subs.c,v 1.5 2003/11/05 14:59:00 rees Exp $ */
end_comment

begin_comment
comment|/*  * copyright (c) 2003  * the regents of the university of michigan  * all rights reserved  *   * permission is granted to use, copy, create derivative works and redistribute  * this software and such derivative works for any purpose, so long as the name  * of the university of michigan is not used in any advertising or publicity  * pertaining to the use or distribution of this software without specific,  * written prior authorization.  if the above copyright notice or any other  * identification of the university of michigan is included in any copy of any  * portion of this software, then the disclaimer below must also be included.  *   * this software is provided as is, without representation from the university  * of michigan as to its fitness for any purpose, and without warranty by the  * university of michigan of any kind, either express or implied, including  * without limitation the implied warranties of merchantability and fitness for  * a particular purpose. the regents of the university of michigan shall not be  * liable for any damages, including special, indirect, incidental, or  * consequential damages, with respect to any claim arising out of or in  * connection with the use of the software, even if it has been or is hereafter  * advised of the possibility of such damages.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/limits.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/mount.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/socketvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/vnode.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_extern.h>
end_include

begin_include
include|#
directive|include
file|<vm/uma.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/route.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<rpc/rpcclnt.h>
end_include

begin_include
include|#
directive|include
file|<nfs/rpcv2.h>
end_include

begin_include
include|#
directive|include
file|<nfs/nfsproto.h>
end_include

begin_include
include|#
directive|include
file|<nfsclient/nfs.h>
end_include

begin_include
include|#
directive|include
file|<nfsclient/nfsmount.h>
end_include

begin_include
include|#
directive|include
file|<nfs/xdr_subs.h>
end_include

begin_include
include|#
directive|include
file|<nfsclient/nfsm_subs.h>
end_include

begin_include
include|#
directive|include
file|<nfsclient/nfsdiskless.h>
end_include

begin_comment
comment|/* NFSv4 */
end_comment

begin_include
include|#
directive|include
file|<nfs4client/nfs4.h>
end_include

begin_include
include|#
directive|include
file|<nfs4client/nfs4m_subs.h>
end_include

begin_include
include|#
directive|include
file|<nfs4client/nfs4_vfs.h>
end_include

begin_include
include|#
directive|include
file|<nfsclient/nfsnode.h>
end_include

begin_function_decl
specifier|static
name|int
name|nfs_iosize
parameter_list|(
name|struct
name|nfsmount
modifier|*
name|nmp
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|nfs_iosize
parameter_list|(
name|struct
name|nfsmount
modifier|*
name|nmp
parameter_list|)
block|{
name|int
name|iosize
decl_stmt|;
comment|/* 	 * Calculate the size used for io buffers.  Use the larger 	 * of the two sizes to minimise nfs requests but make sure 	 * that it is at least one VM page to avoid wasting buffer 	 * space. 	 */
name|iosize
operator|=
name|max
argument_list|(
name|nmp
operator|->
name|nm_rsize
argument_list|,
name|nmp
operator|->
name|nm_wsize
argument_list|)
expr_stmt|;
if|if
condition|(
name|iosize
operator|<
name|PAGE_SIZE
condition|)
name|iosize
operator|=
name|PAGE_SIZE
expr_stmt|;
return|return
name|iosize
return|;
block|}
end_function

begin_function
name|void
name|nfs4_vfsop_fsinfo
parameter_list|(
name|struct
name|nfsv4_fattr
modifier|*
name|fap
parameter_list|,
name|struct
name|nfsmount
modifier|*
name|nmp
parameter_list|)
block|{
name|uint32_t
name|max
decl_stmt|;
if|if
condition|(
name|fap
operator|->
name|fa4_valid
operator|&
name|FA4V_FSID
condition|)
block|{
name|nmp
operator|->
name|nm_fsid
operator|.
name|val
index|[
literal|0
index|]
operator|=
name|fap
operator|->
name|fa4_fsid_major
expr_stmt|;
name|nmp
operator|->
name|nm_fsid
operator|.
name|val
index|[
literal|1
index|]
operator|=
name|fap
operator|->
name|fa4_fsid_minor
expr_stmt|;
block|}
if|if
condition|(
name|fap
operator|->
name|fa4_valid
operator|&
name|FA4V_MAXREAD
condition|)
block|{
name|max
operator|=
name|fap
operator|->
name|fa4_maxread
expr_stmt|;
if|if
condition|(
name|max
operator|<
name|nmp
operator|->
name|nm_rsize
condition|)
block|{
name|nmp
operator|->
name|nm_rsize
operator|=
name|max
operator|&
operator|~
operator|(
name|NFS_FABLKSIZE
operator|-
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|nmp
operator|->
name|nm_rsize
operator|==
literal|0
condition|)
name|nmp
operator|->
name|nm_rsize
operator|=
name|max
expr_stmt|;
block|}
if|if
condition|(
name|max
operator|<
name|nmp
operator|->
name|nm_readdirsize
condition|)
block|{
name|nmp
operator|->
name|nm_readdirsize
operator|=
name|max
operator|&
operator|~
operator|(
name|NFS_DIRBLKSIZ
operator|-
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|nmp
operator|->
name|nm_readdirsize
operator|==
literal|0
condition|)
name|nmp
operator|->
name|nm_readdirsize
operator|=
name|max
expr_stmt|;
block|}
block|}
if|if
condition|(
name|fap
operator|->
name|fa4_valid
operator|&
name|FA4V_MAXWRITE
condition|)
block|{
name|max
operator|=
name|fap
operator|->
name|fa4_maxwrite
expr_stmt|;
if|if
condition|(
name|max
operator|<
name|nmp
operator|->
name|nm_wsize
condition|)
block|{
name|nmp
operator|->
name|nm_wsize
operator|=
name|max
operator|&
operator|~
operator|(
name|NFS_FABLKSIZE
operator|-
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|nmp
operator|->
name|nm_wsize
operator|==
literal|0
condition|)
name|nmp
operator|->
name|nm_wsize
operator|=
name|max
expr_stmt|;
block|}
block|}
if|if
condition|(
name|fap
operator|->
name|fa4_valid
operator|&
name|FA4V_LEASE_TIME
condition|)
name|nmp
operator|->
name|nm_lease_time
operator|=
name|fap
operator|->
name|fa4_lease_time
expr_stmt|;
comment|/* nmp->nm_flag |= NFSMNT_GOTFSINFO; */
block|}
end_function

begin_function
name|void
name|nfs4_vfsop_statfs
parameter_list|(
name|struct
name|nfsv4_fattr
modifier|*
name|fap
parameter_list|,
name|struct
name|statfs
modifier|*
name|sbp
parameter_list|,
name|struct
name|mount
modifier|*
name|mp
parameter_list|)
block|{
name|struct
name|nfsmount
modifier|*
name|nmp
init|=
name|VFSTONFS
argument_list|(
name|mp
argument_list|)
decl_stmt|;
name|sbp
operator|->
name|f_iosize
operator|=
name|nfs_iosize
argument_list|(
name|nmp
argument_list|)
expr_stmt|;
name|sbp
operator|->
name|f_bsize
operator|=
name|NFS_FABLKSIZE
expr_stmt|;
if|if
condition|(
name|fap
operator|->
name|fa4_valid
operator|&
name|FA4V_FSID
condition|)
block|{
name|sbp
operator|->
name|f_fsid
operator|.
name|val
index|[
literal|0
index|]
operator|=
name|fap
operator|->
name|fa4_fsid_major
expr_stmt|;
name|sbp
operator|->
name|f_fsid
operator|.
name|val
index|[
literal|1
index|]
operator|=
name|fap
operator|->
name|fa4_fsid_minor
expr_stmt|;
block|}
name|sbp
operator|->
name|f_ffree
operator|=
name|fap
operator|->
name|fa4_valid
operator|&
name|FA4V_FFREE
condition|?
name|fap
operator|->
name|fa4_ffree
else|:
literal|0
expr_stmt|;
comment|/* sbp->f_ftotal = fa->fa4_valid& FA4_FTOTAL ? fa->fa4_ftotal : 0; */
name|sbp
operator|->
name|f_bavail
operator|=
name|fap
operator|->
name|fa4_valid
operator|&
name|FA4V_SAVAIL
condition|?
name|fap
operator|->
name|fa4_savail
operator|/
name|NFS_FABLKSIZE
else|:
literal|500000
expr_stmt|;
name|sbp
operator|->
name|f_bfree
operator|=
name|fap
operator|->
name|fa4_valid
operator|&
name|FA4V_SFREE
condition|?
name|fap
operator|->
name|fa4_sfree
operator|/
name|NFS_FABLKSIZE
else|:
literal|500000
expr_stmt|;
name|sbp
operator|->
name|f_blocks
operator|=
name|fap
operator|->
name|fa4_valid
operator|&
name|FA4V_STOTAL
condition|?
name|fap
operator|->
name|fa4_stotal
operator|/
name|NFS_FABLKSIZE
else|:
literal|1000000
expr_stmt|;
block|}
end_function

end_unit


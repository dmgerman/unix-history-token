begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_comment
comment|/* $Id: nfs4_idmap.c,v 1.4 2003/11/05 14:58:59 rees Exp $ */
end_comment

begin_comment
comment|/*-  * copyright (c) 2003  * the regents of the university of michigan  * all rights reserved  *  * permission is granted to use, copy, create derivative works and redistribute  * this software and such derivative works for any purpose, so long as the name  * of the university of michigan is not used in any advertising or publicity  * pertaining to the use or distribution of this software without specific,  * written prior authorization.  if the above copyright notice or any other  * identification of the university of michigan is included in any copy of any  * portion of this software, then the disclaimer below must also be included.  *  * this software is provided as is, without representation from the university  * of michigan as to its fitness for any purpose, and without warranty by the  * university of michigan of any kind, either express or implied, including  * without limitation the implied warranties of merchantability and fitness for  * a particular purpose. the regents of the university of michigan shall not be  * liable for any damages, including special, indirect, incidental, or  * consequential damages, with respect to any claim arising out of or in  * connection with the use of the software, even if it has been or is hereafter  * advised of the possibility of such damages.  */
end_comment

begin_comment
comment|/* TODO:  *  o validate ascii  * */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/lockmgr.h>
end_include

begin_include
include|#
directive|include
file|<sys/fnv_hash.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/syscall.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysent.h>
end_include

begin_include
include|#
directive|include
file|<sys/libkern.h>
end_include

begin_include
include|#
directive|include
file|<rpc/rpcclnt.h>
end_include

begin_include
include|#
directive|include
file|<nfs4client/nfs4_dev.h>
end_include

begin_include
include|#
directive|include
file|<nfs4client/nfs4_idmap.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|IDMAPVERBOSE
end_ifdef

begin_define
define|#
directive|define
name|IDMAP_DEBUG
parameter_list|(
modifier|...
parameter_list|)
value|printf(__VA_ARGS__);
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|IDMAP_DEBUG
parameter_list|(
modifier|...
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|IDMAP_HASH_SIZE
value|37
end_define

begin_expr_stmt
name|MALLOC_DEFINE
argument_list|(
name|M_IDMAP
argument_list|,
literal|"idmap"
argument_list|,
literal|"idmap"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|idmap_entry_get
parameter_list|(
name|ID
parameter_list|)
value|MALLOC((ID), struct idmap_entry, sizeof(struct idmap_entry), M_IDMAP, M_WAITOK | M_ZERO)
end_define

begin_define
define|#
directive|define
name|idmap_entry_put
parameter_list|(
name|ID
parameter_list|)
value|FREE((ID), M_IDMAP)
end_define

begin_struct
struct|struct
name|idmap_entry
block|{
name|struct
name|idmap_msg
name|id_info
decl_stmt|;
name|TAILQ_ENTRY
argument_list|(
argument|idmap_entry
argument_list|)
name|id_entry_id
expr_stmt|;
name|TAILQ_ENTRY
argument_list|(
argument|idmap_entry
argument_list|)
name|id_entry_name
expr_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|idmap_hash
block|{
name|TAILQ_HEAD
argument_list|(
argument_list|,
argument|idmap_entry
argument_list|)
name|hash_name
index|[
name|IDMAP_HASH_SIZE
index|]
expr_stmt|;
name|TAILQ_HEAD
argument_list|(
argument_list|,
argument|idmap_entry
argument_list|)
name|hash_id
index|[
name|IDMAP_HASH_SIZE
index|]
expr_stmt|;
name|struct
name|lock
name|hash_lock
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|IDMAP_RLOCK
parameter_list|(
name|lock
parameter_list|)
value|lockmgr(lock, LK_SHARED, NULL, curthread)
end_define

begin_define
define|#
directive|define
name|IDMAP_WLOCK
parameter_list|(
name|lock
parameter_list|)
value|lockmgr(lock, LK_EXCLUSIVE, NULL, curthread)
end_define

begin_define
define|#
directive|define
name|IDMAP_UNLOCK
parameter_list|(
name|lock
parameter_list|)
value|lockmgr(lock, LK_RELEASE, NULL, curthread)
end_define

begin_decl_stmt
specifier|static
name|struct
name|idmap_hash
name|idmap_uid_hash
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|idmap_hash
name|idmap_gid_hash
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|struct
name|idmap_entry
modifier|*
name|idmap_name_lookup
parameter_list|(
name|uint32_t
parameter_list|,
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|idmap_entry
modifier|*
name|idmap_id_lookup
parameter_list|(
name|uint32_t
parameter_list|,
name|ident_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|idmap_upcall_name
parameter_list|(
name|uint32_t
parameter_list|,
name|char
modifier|*
parameter_list|,
name|struct
name|idmap_entry
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|idmap_upcall_id
parameter_list|(
name|uint32_t
parameter_list|,
name|ident_t
parameter_list|,
name|struct
name|idmap_entry
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|idmap_add
parameter_list|(
name|struct
name|idmap_entry
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|idmap_upcall_name
parameter_list|(
name|uint32_t
name|type
parameter_list|,
name|char
modifier|*
name|name
parameter_list|,
name|struct
name|idmap_entry
modifier|*
modifier|*
name|found
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|struct
name|idmap_entry
modifier|*
name|e
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|siz
decl_stmt|;
if|if
condition|(
name|type
operator|>
name|IDMAP_MAX_TYPE
operator|||
name|type
operator|==
literal|0
condition|)
block|{
name|IDMAP_DEBUG
argument_list|(
literal|"bad type %d\n"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
comment|/* XXX */
block|}
if|if
condition|(
name|name
operator|==
name|NULL
operator|||
operator|(
name|len
operator|=
name|strlen
argument_list|(
name|name
argument_list|)
operator|)
operator|==
literal|0
operator|||
name|len
operator|>
name|IDMAP_MAXNAMELEN
condition|)
block|{
name|IDMAP_DEBUG
argument_list|(
literal|"idmap_upcall_name: bad name\n"
argument_list|)
expr_stmt|;
return|return
name|EFAULT
return|;
comment|/* XXX */
block|}
name|MALLOC
argument_list|(
name|e
argument_list|,
expr|struct
name|idmap_entry
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|idmap_entry
argument_list|)
argument_list|,
name|M_IDMAP
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|e
operator|->
name|id_info
operator|.
name|id_type
operator|=
name|type
expr_stmt|;
name|bcopy
argument_list|(
name|name
argument_list|,
name|e
operator|->
name|id_info
operator|.
name|id_name
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|e
operator|->
name|id_info
operator|.
name|id_namelen
operator|=
name|len
expr_stmt|;
name|siz
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|idmap_msg
argument_list|)
expr_stmt|;
name|error
operator|=
name|nfs4dev_call
argument_list|(
name|NFS4DEV_TYPE_IDMAP
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|e
operator|->
name|id_info
argument_list|,
name|siz
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|e
operator|->
name|id_info
argument_list|,
operator|&
name|siz
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|IDMAP_DEBUG
argument_list|(
literal|"error %d in nfs4dev_upcall()\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
operator|*
name|found
operator|=
name|NULL
expr_stmt|;
return|return
name|error
return|;
block|}
if|if
condition|(
name|siz
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|idmap_msg
argument_list|)
condition|)
block|{
name|IDMAP_DEBUG
argument_list|(
literal|"bad size of returned message\n"
argument_list|)
expr_stmt|;
operator|*
name|found
operator|=
name|NULL
expr_stmt|;
return|return
name|EFAULT
return|;
block|}
operator|*
name|found
operator|=
name|e
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|idmap_upcall_id
parameter_list|(
name|uint32_t
name|type
parameter_list|,
name|ident_t
name|id
parameter_list|,
name|struct
name|idmap_entry
modifier|*
modifier|*
name|found
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|struct
name|idmap_entry
modifier|*
name|e
decl_stmt|;
name|size_t
name|siz
decl_stmt|;
if|if
condition|(
name|type
operator|>
name|IDMAP_MAX_TYPE
condition|)
name|panic
argument_list|(
literal|"bad type"
argument_list|)
expr_stmt|;
comment|/* XXX */
name|MALLOC
argument_list|(
name|e
argument_list|,
expr|struct
name|idmap_entry
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|idmap_entry
argument_list|)
argument_list|,
name|M_IDMAP
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|e
operator|->
name|id_info
operator|.
name|id_type
operator|=
name|type
expr_stmt|;
name|e
operator|->
name|id_info
operator|.
name|id_namelen
operator|=
literal|0
expr_stmt|;
comment|/* should already */
name|e
operator|->
name|id_info
operator|.
name|id_id
operator|=
name|id
expr_stmt|;
name|siz
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|idmap_msg
argument_list|)
expr_stmt|;
name|error
operator|=
name|nfs4dev_call
argument_list|(
name|NFS4DEV_TYPE_IDMAP
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|e
operator|->
name|id_info
argument_list|,
name|siz
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|e
operator|->
name|id_info
argument_list|,
operator|&
name|siz
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|IDMAP_DEBUG
argument_list|(
literal|"error %d in nfs4dev_upcall()\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
operator|*
name|found
operator|=
name|NULL
expr_stmt|;
return|return
name|error
return|;
block|}
if|if
condition|(
name|siz
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|idmap_msg
argument_list|)
condition|)
block|{
name|IDMAP_DEBUG
argument_list|(
literal|"bad size of returned message\n"
argument_list|)
expr_stmt|;
operator|*
name|found
operator|=
name|NULL
expr_stmt|;
return|return
name|EFAULT
return|;
block|}
operator|*
name|found
operator|=
name|e
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|idmap_hashf
parameter_list|(
name|struct
name|idmap_entry
modifier|*
name|e
parameter_list|,
name|uint32_t
modifier|*
name|hval_id
parameter_list|,
name|uint32_t
modifier|*
name|hval_name
parameter_list|)
block|{
switch|switch
condition|(
name|e
operator|->
name|id_info
operator|.
name|id_type
condition|)
block|{
case|case
name|IDMAP_TYPE_UID
case|:
operator|*
name|hval_id
operator|=
name|e
operator|->
name|id_info
operator|.
name|id_id
operator|.
name|uid
operator|%
name|IDMAP_HASH_SIZE
expr_stmt|;
break|break;
case|case
name|IDMAP_TYPE_GID
case|:
operator|*
name|hval_id
operator|=
name|e
operator|->
name|id_info
operator|.
name|id_id
operator|.
name|gid
operator|%
name|IDMAP_HASH_SIZE
expr_stmt|;
break|break;
default|default:
comment|/* XXX yikes! */
name|panic
argument_list|(
literal|"hashf: bad type!"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|e
operator|->
name|id_info
operator|.
name|id_namelen
operator|==
literal|0
condition|)
comment|/* XXX */
name|panic
argument_list|(
literal|"hashf: bad name"
argument_list|)
expr_stmt|;
operator|*
name|hval_name
operator|=
name|fnv_32_str
argument_list|(
name|e
operator|->
name|id_info
operator|.
name|id_name
argument_list|,
name|FNV1_32_INIT
argument_list|)
operator|%
name|IDMAP_HASH_SIZE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|idmap_add
parameter_list|(
name|struct
name|idmap_entry
modifier|*
name|e
parameter_list|)
block|{
name|struct
name|idmap_hash
modifier|*
name|hash
decl_stmt|;
name|uint32_t
name|hval_id
decl_stmt|,
name|hval_name
decl_stmt|;
if|if
condition|(
name|e
operator|->
name|id_info
operator|.
name|id_namelen
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"idmap_add: name of len 0\n"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
switch|switch
condition|(
name|e
operator|->
name|id_info
operator|.
name|id_type
condition|)
block|{
case|case
name|IDMAP_TYPE_UID
case|:
name|hash
operator|=
operator|&
name|idmap_uid_hash
expr_stmt|;
break|break;
case|case
name|IDMAP_TYPE_GID
case|:
name|hash
operator|=
operator|&
name|idmap_gid_hash
expr_stmt|;
break|break;
default|default:
comment|/* XXX yikes */
name|panic
argument_list|(
literal|"idmap add: bad type!"
argument_list|)
expr_stmt|;
break|break;
block|}
name|idmap_hashf
argument_list|(
name|e
argument_list|,
operator|&
name|hval_id
argument_list|,
operator|&
name|hval_name
argument_list|)
expr_stmt|;
name|IDMAP_WLOCK
argument_list|(
operator|&
name|hash
operator|->
name|hash_lock
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|hash
operator|->
name|hash_id
index|[
name|hval_id
index|]
argument_list|,
name|e
argument_list|,
name|id_entry_id
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|hash
operator|->
name|hash_name
index|[
name|hval_name
index|]
argument_list|,
name|e
argument_list|,
name|id_entry_name
argument_list|)
expr_stmt|;
name|IDMAP_UNLOCK
argument_list|(
operator|&
name|hash
operator|->
name|hash_lock
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|idmap_entry
modifier|*
name|idmap_id_lookup
parameter_list|(
name|uint32_t
name|type
parameter_list|,
name|ident_t
name|id
parameter_list|)
block|{
name|struct
name|idmap_hash
modifier|*
name|hash
decl_stmt|;
name|uint32_t
name|hval
decl_stmt|;
name|struct
name|idmap_entry
modifier|*
name|e
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|IDMAP_TYPE_UID
case|:
name|hash
operator|=
operator|&
name|idmap_uid_hash
expr_stmt|;
name|hval
operator|=
name|id
operator|.
name|uid
operator|%
name|IDMAP_HASH_SIZE
expr_stmt|;
break|break;
case|case
name|IDMAP_TYPE_GID
case|:
name|hash
operator|=
operator|&
name|idmap_gid_hash
expr_stmt|;
name|hval
operator|=
name|id
operator|.
name|gid
operator|%
name|IDMAP_HASH_SIZE
expr_stmt|;
break|break;
default|default:
comment|/* XXX yikes */
name|panic
argument_list|(
literal|"lookup: bad type!"
argument_list|)
expr_stmt|;
break|break;
block|}
name|IDMAP_RLOCK
argument_list|(
operator|&
name|hash
operator|->
name|hash_lock
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|e
argument_list|,
argument|&hash->hash_id[hval]
argument_list|,
argument|id_entry_name
argument_list|)
block|{
if|if
condition|(
operator|(
name|type
operator|==
name|IDMAP_TYPE_UID
operator|&&
name|e
operator|->
name|id_info
operator|.
name|id_id
operator|.
name|uid
operator|==
name|id
operator|.
name|uid
operator|)
operator|||
operator|(
name|type
operator|==
name|IDMAP_TYPE_GID
operator|&&
name|e
operator|->
name|id_info
operator|.
name|id_id
operator|.
name|gid
operator|==
name|id
operator|.
name|gid
operator|)
condition|)
block|{
name|IDMAP_UNLOCK
argument_list|(
operator|&
name|hash
operator|->
name|hash_lock
argument_list|)
expr_stmt|;
return|return
name|e
return|;
block|}
block|}
name|IDMAP_UNLOCK
argument_list|(
operator|&
name|hash
operator|->
name|hash_lock
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|idmap_entry
modifier|*
name|idmap_name_lookup
parameter_list|(
name|uint32_t
name|type
parameter_list|,
name|char
modifier|*
name|name
parameter_list|)
block|{
name|struct
name|idmap_hash
modifier|*
name|hash
decl_stmt|;
name|uint32_t
name|hval
decl_stmt|;
name|struct
name|idmap_entry
modifier|*
name|e
decl_stmt|;
name|size_t
name|len
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|IDMAP_TYPE_UID
case|:
name|hash
operator|=
operator|&
name|idmap_uid_hash
expr_stmt|;
break|break;
case|case
name|IDMAP_TYPE_GID
case|:
name|hash
operator|=
operator|&
name|idmap_gid_hash
expr_stmt|;
break|break;
default|default:
comment|/* XXX yikes */
name|panic
argument_list|(
literal|"lookup: bad type!"
argument_list|)
expr_stmt|;
break|break;
block|}
name|len
operator|=
name|strlen
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
operator|||
name|len
operator|>
name|IDMAP_MAXNAMELEN
condition|)
block|{
name|IDMAP_DEBUG
argument_list|(
literal|"bad name length %d\n"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|hval
operator|=
name|fnv_32_str
argument_list|(
name|name
argument_list|,
name|FNV1_32_INIT
argument_list|)
operator|%
name|IDMAP_HASH_SIZE
expr_stmt|;
name|IDMAP_RLOCK
argument_list|(
operator|&
name|hash
operator|->
name|hash_lock
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|e
argument_list|,
argument|&hash->hash_name[hval]
argument_list|,
argument|id_entry_name
argument_list|)
block|{
if|if
condition|(
operator|(
name|strlen
argument_list|(
name|e
operator|->
name|id_info
operator|.
name|id_name
argument_list|)
operator|==
name|strlen
argument_list|(
name|name
argument_list|)
operator|)
operator|&&
name|strncmp
argument_list|(
name|e
operator|->
name|id_info
operator|.
name|id_name
argument_list|,
name|name
argument_list|,
name|strlen
argument_list|(
name|name
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|IDMAP_UNLOCK
argument_list|(
operator|&
name|hash
operator|->
name|hash_lock
argument_list|)
expr_stmt|;
return|return
name|e
return|;
block|}
block|}
name|IDMAP_UNLOCK
argument_list|(
operator|&
name|hash
operator|->
name|hash_lock
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|void
name|idmap_init
parameter_list|(
name|void
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IDMAP_HASH_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|TAILQ_INIT
argument_list|(
operator|&
name|idmap_uid_hash
operator|.
name|hash_name
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|idmap_uid_hash
operator|.
name|hash_id
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|idmap_gid_hash
operator|.
name|hash_name
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|idmap_gid_hash
operator|.
name|hash_id
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|lockinit
argument_list|(
operator|&
name|idmap_uid_hash
operator|.
name|hash_lock
argument_list|,
name|PLOCK
argument_list|,
literal|"idmap uid hash table"
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|lockinit
argument_list|(
operator|&
name|idmap_gid_hash
operator|.
name|hash_lock
argument_list|,
name|PLOCK
argument_list|,
literal|"idmap gid hash table"
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|idmap_uninit
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|idmap_entry
modifier|*
name|e
decl_stmt|;
name|int
name|i
decl_stmt|;
name|lockdestroy
argument_list|(
operator|&
name|idmap_uid_hash
operator|.
name|hash_lock
argument_list|)
expr_stmt|;
name|lockdestroy
argument_list|(
operator|&
name|idmap_gid_hash
operator|.
name|hash_lock
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|IDMAP_HASH_SIZE
condition|;
name|i
operator|++
control|)
block|{
while|while
condition|(
operator|!
name|TAILQ_EMPTY
argument_list|(
operator|&
name|idmap_uid_hash
operator|.
name|hash_name
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|e
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|idmap_uid_hash
operator|.
name|hash_name
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|idmap_uid_hash
operator|.
name|hash_name
index|[
name|i
index|]
argument_list|,
name|e
argument_list|,
name|id_entry_name
argument_list|)
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|idmap_uid_hash
operator|.
name|hash_id
index|[
name|i
index|]
argument_list|,
name|e
argument_list|,
name|id_entry_id
argument_list|)
expr_stmt|;
name|FREE
argument_list|(
name|e
argument_list|,
name|M_IDMAP
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
operator|!
name|TAILQ_EMPTY
argument_list|(
operator|&
name|idmap_gid_hash
operator|.
name|hash_name
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|e
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|idmap_gid_hash
operator|.
name|hash_name
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|idmap_gid_hash
operator|.
name|hash_name
index|[
name|i
index|]
argument_list|,
name|e
argument_list|,
name|id_entry_name
argument_list|)
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|idmap_gid_hash
operator|.
name|hash_id
index|[
name|i
index|]
argument_list|,
name|e
argument_list|,
name|id_entry_id
argument_list|)
expr_stmt|;
name|FREE
argument_list|(
name|e
argument_list|,
name|M_IDMAP
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|int
name|idmap_uid_to_name
parameter_list|(
name|uid_t
name|uid
parameter_list|,
name|char
modifier|*
modifier|*
name|name
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|struct
name|idmap_entry
modifier|*
name|e
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|ident_t
name|id
decl_stmt|;
name|id
operator|.
name|uid
operator|=
name|uid
expr_stmt|;
if|if
condition|(
operator|(
name|e
operator|=
name|idmap_id_lookup
argument_list|(
name|IDMAP_TYPE_UID
argument_list|,
name|id
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|idmap_upcall_id
argument_list|(
name|IDMAP_TYPE_UID
argument_list|,
name|id
argument_list|,
operator|&
name|e
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|IDMAP_DEBUG
argument_list|(
literal|"error in upcall\n"
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
block|{
name|IDMAP_DEBUG
argument_list|(
literal|"no error from upcall, but no data returned\n"
argument_list|)
expr_stmt|;
return|return
name|EFAULT
return|;
block|}
if|if
condition|(
name|idmap_add
argument_list|(
name|e
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|IDMAP_DEBUG
argument_list|(
literal|"idmap_add failed\n"
argument_list|)
expr_stmt|;
name|FREE
argument_list|(
name|e
argument_list|,
name|M_IDMAP
argument_list|)
expr_stmt|;
return|return
name|EFAULT
return|;
block|}
block|}
operator|*
name|name
operator|=
name|e
operator|->
name|id_info
operator|.
name|id_name
expr_stmt|;
operator|*
name|len
operator|=
name|e
operator|->
name|id_info
operator|.
name|id_namelen
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|idmap_gid_to_name
parameter_list|(
name|gid_t
name|gid
parameter_list|,
name|char
modifier|*
modifier|*
name|name
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|struct
name|idmap_entry
modifier|*
name|e
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|ident_t
name|id
decl_stmt|;
name|id
operator|.
name|gid
operator|=
name|gid
expr_stmt|;
if|if
condition|(
operator|(
name|e
operator|=
name|idmap_id_lookup
argument_list|(
name|IDMAP_TYPE_GID
argument_list|,
name|id
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|idmap_upcall_id
argument_list|(
name|IDMAP_TYPE_GID
argument_list|,
name|id
argument_list|,
operator|&
name|e
argument_list|)
operator|)
condition|)
block|{
name|IDMAP_DEBUG
argument_list|(
literal|"error in upcall\n"
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
block|{
name|IDMAP_DEBUG
argument_list|(
literal|"no error from upcall, but no data returned\n"
argument_list|)
expr_stmt|;
return|return
name|EFAULT
return|;
block|}
if|if
condition|(
name|idmap_add
argument_list|(
name|e
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|IDMAP_DEBUG
argument_list|(
literal|"idmap_add failed\n"
argument_list|)
expr_stmt|;
name|FREE
argument_list|(
name|e
argument_list|,
name|M_IDMAP
argument_list|)
expr_stmt|;
block|}
block|}
operator|*
name|name
operator|=
name|e
operator|->
name|id_info
operator|.
name|id_name
expr_stmt|;
operator|*
name|len
operator|=
name|e
operator|->
name|id_info
operator|.
name|id_namelen
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|idmap_name_to_uid
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
name|size_t
name|len
parameter_list|,
name|uid_t
modifier|*
name|id
parameter_list|)
block|{
name|struct
name|idmap_entry
modifier|*
name|e
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|namestr
decl_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
return|return
name|EFAULT
return|;
if|if
condition|(
name|len
operator|==
literal|0
operator|||
name|len
operator|>
name|IDMAP_MAXNAMELEN
condition|)
block|{
name|IDMAP_DEBUG
argument_list|(
literal|"idmap_name_to_uid: bad len\n"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
comment|/* XXX hack */
name|MALLOC
argument_list|(
name|namestr
argument_list|,
name|char
operator|*
argument_list|,
name|len
operator|+
literal|1
argument_list|,
name|M_TEMP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|name
argument_list|,
name|namestr
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|namestr
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|(
name|e
operator|=
name|idmap_name_lookup
argument_list|(
name|IDMAP_TYPE_UID
argument_list|,
name|namestr
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|idmap_upcall_name
argument_list|(
name|IDMAP_TYPE_UID
argument_list|,
name|namestr
argument_list|,
operator|&
name|e
argument_list|)
operator|)
condition|)
block|{
name|FREE
argument_list|(
name|namestr
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
block|{
name|IDMAP_DEBUG
argument_list|(
literal|"no error from upcall, but no data returned\n"
argument_list|)
expr_stmt|;
name|FREE
argument_list|(
name|namestr
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
name|EFAULT
return|;
block|}
if|if
condition|(
name|idmap_add
argument_list|(
name|e
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|IDMAP_DEBUG
argument_list|(
literal|"idmap_add failed\n"
argument_list|)
expr_stmt|;
name|FREE
argument_list|(
name|e
argument_list|,
name|M_IDMAP
argument_list|)
expr_stmt|;
block|}
block|}
operator|*
name|id
operator|=
name|e
operator|->
name|id_info
operator|.
name|id_id
operator|.
name|uid
expr_stmt|;
name|FREE
argument_list|(
name|namestr
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|idmap_name_to_gid
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
name|size_t
name|len
parameter_list|,
name|gid_t
modifier|*
name|id
parameter_list|)
block|{
name|struct
name|idmap_entry
modifier|*
name|e
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|namestr
decl_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
return|return
name|EFAULT
return|;
if|if
condition|(
name|len
operator|==
literal|0
operator|||
name|len
operator|>
name|IDMAP_MAXNAMELEN
condition|)
block|{
name|IDMAP_DEBUG
argument_list|(
literal|"idmap_name_to_uid: bad len\n"
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
comment|/* XXX hack */
name|MALLOC
argument_list|(
name|namestr
argument_list|,
name|char
operator|*
argument_list|,
name|len
operator|+
literal|1
argument_list|,
name|M_TEMP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|name
argument_list|,
name|namestr
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|namestr
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|(
name|e
operator|=
name|idmap_name_lookup
argument_list|(
name|IDMAP_TYPE_GID
argument_list|,
name|namestr
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|idmap_upcall_name
argument_list|(
name|IDMAP_TYPE_GID
argument_list|,
name|namestr
argument_list|,
operator|&
name|e
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|IDMAP_DEBUG
argument_list|(
literal|"error in upcall\n"
argument_list|)
expr_stmt|;
name|FREE
argument_list|(
name|namestr
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
block|{
name|IDMAP_DEBUG
argument_list|(
literal|"no error from upcall, but no data returned\n"
argument_list|)
expr_stmt|;
name|FREE
argument_list|(
name|namestr
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
name|EFAULT
return|;
block|}
if|if
condition|(
name|idmap_add
argument_list|(
name|e
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|IDMAP_DEBUG
argument_list|(
literal|"idmap_add failed\n"
argument_list|)
expr_stmt|;
name|FREE
argument_list|(
name|e
argument_list|,
name|M_IDMAP
argument_list|)
expr_stmt|;
block|}
block|}
operator|*
name|id
operator|=
name|e
operator|->
name|id_info
operator|.
name|id_id
operator|.
name|gid
expr_stmt|;
name|FREE
argument_list|(
name|namestr
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


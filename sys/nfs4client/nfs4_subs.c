begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $FreeBSD$ */
end_comment

begin_comment
comment|/* $Id: nfs4_subs.c,v 1.52 2003/11/05 14:58:59 rees Exp $ */
end_comment

begin_comment
comment|/*  * copyright (c) 2003  * the regents of the university of michigan  * all rights reserved  *   * permission is granted to use, copy, create derivative works and redistribute  * this software and such derivative works for any purpose, so long as the name  * of the university of michigan is not used in any advertising or publicity  * pertaining to the use or distribution of this software without specific,  * written prior authorization.  if the above copyright notice or any other  * identification of the university of michigan is included in any copy of any  * portion of this software, then the disclaimer below must also be included.  *   * this software is provided as is, without representation from the university  * of michigan as to its fitness for any purpose, and without warranty by the  * university of michigan of any kind, either express or implied, including  * without limitation the implied warranties of merchantability and fitness for  * a particular purpose. the regents of the university of michigan shall not be  * liable for any damages, including special, indirect, incidental, or  * consequential damages, with respect to any claim arising out of or in  * connection with the use of the software, even if it has been or is hereafter  * advised of the possibility of such damages.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bio.h>
end_include

begin_include
include|#
directive|include
file|<sys/buf.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/mount.h>
end_include

begin_include
include|#
directive|include
file|<sys/vnode.h>
end_include

begin_include
include|#
directive|include
file|<sys/namei.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysent.h>
end_include

begin_include
include|#
directive|include
file|<sys/syscall.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysproto.h>
end_include

begin_include
include|#
directive|include
file|<sys/fcntl.h>
end_include

begin_include
include|#
directive|include
file|<machine/stdarg.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_object.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_extern.h>
end_include

begin_include
include|#
directive|include
file|<vm/uma.h>
end_include

begin_include
include|#
directive|include
file|<rpc/rpcclnt.h>
end_include

begin_include
include|#
directive|include
file|<nfs/rpcv2.h>
end_include

begin_include
include|#
directive|include
file|<nfs/nfsproto.h>
end_include

begin_include
include|#
directive|include
file|<nfsclient/nfs.h>
end_include

begin_include
include|#
directive|include
file|<nfs4client/nfs4.h>
end_include

begin_include
include|#
directive|include
file|<nfsclient/nfsnode.h>
end_include

begin_include
include|#
directive|include
file|<nfsclient/nfsmount.h>
end_include

begin_include
include|#
directive|include
file|<nfs/xdr_subs.h>
end_include

begin_include
include|#
directive|include
file|<nfsclient/nfsm_subs.h>
end_include

begin_include
include|#
directive|include
file|<nfs4client/nfs4_dev.h>
end_include

begin_include
include|#
directive|include
file|<nfs4client/nfs4_idmap.h>
end_include

begin_include
include|#
directive|include
file|<nfs4client/nfs4m_subs.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_define
define|#
directive|define
name|NFSM_DISSECT
parameter_list|(
name|s
parameter_list|)
value|do {							\ 	tl = nfsm_dissect_xx((s), md, dpos);					\ 	if (tl == NULL) {							\ 		printf("NFSM_DISSECT error; allocation (%s/%d) (%s:%d)\n", #s, s, __FILE__, __LINE__);	\ 		return (EBADRPC);						\ 	}									\ } while (0)
end_define

begin_define
define|#
directive|define
name|NFSM_ADV
parameter_list|(
name|s
parameter_list|)
value|do {						\ 	t1 = nfsm_adv_xx((s), md, dpos);				\ 	if (t1 != 0) {							\ 		printf("NFSM_ADV error; allocation (%s/%d) (%s:%d)\n", #s, s, __FILE__, __LINE__);	\ 		return (EBADRPC);					\ 	}								\ } while (0)
end_define

begin_define
define|#
directive|define
name|NFSM_MTOTIME
parameter_list|(
name|t
parameter_list|)
value|do {				\ 	NFSM_DISSECT(3 * NFSX_UNSIGNED);		\ 	(t).tv_sec = fxdr_hyper(tl);			\ 	tl += 2;					\ 	(t).tv_nsec = fxdr_unsigned(long, *tl++);	\ } while (0)
end_define

begin_decl_stmt
specifier|static
name|uint32_t
name|__fsinfo_bm
index|[
literal|2
index|]
decl_stmt|,
name|__fsattr_bm
index|[
literal|2
index|]
decl_stmt|,
name|__getattr_bm
index|[
literal|2
index|]
decl_stmt|,
name|__readdir_bm
index|[
literal|2
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|nfsv4bitmap
name|nfsv4_fsinfobm
init|=
block|{
literal|2
block|,
name|__fsinfo_bm
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|nfsv4bitmap
name|nfsv4_fsattrbm
init|=
block|{
literal|2
block|,
name|__fsattr_bm
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|nfsv4bitmap
name|nfsv4_getattrbm
init|=
block|{
literal|2
block|,
name|__getattr_bm
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|nfsv4bitmap
name|nfsv4_readdirbm
init|=
block|{
literal|2
block|,
name|__readdir_bm
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Helper routines */
end_comment

begin_function_decl
name|int
name|nfsm_v4build_attrs_xx
parameter_list|(
name|struct
name|vattr
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
parameter_list|,
name|caddr_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|nfsm_v4dissect_changeinfo_xx
parameter_list|(
name|nfsv4changeinfo
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
parameter_list|,
name|caddr_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|nfsm_v4init
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* Set up bitmasks */
name|FA4_SET
argument_list|(
name|FA4_FSID
argument_list|,
name|__fsinfo_bm
argument_list|)
expr_stmt|;
name|FA4_SET
argument_list|(
name|FA4_MAXREAD
argument_list|,
name|__fsinfo_bm
argument_list|)
expr_stmt|;
name|FA4_SET
argument_list|(
name|FA4_MAXWRITE
argument_list|,
name|__fsinfo_bm
argument_list|)
expr_stmt|;
name|FA4_SET
argument_list|(
name|FA4_LEASE_TIME
argument_list|,
name|__fsinfo_bm
argument_list|)
expr_stmt|;
name|FA4_SET
argument_list|(
name|FA4_FSID
argument_list|,
name|__fsattr_bm
argument_list|)
expr_stmt|;
name|FA4_SET
argument_list|(
name|FA4_FILES_FREE
argument_list|,
name|__fsattr_bm
argument_list|)
expr_stmt|;
name|FA4_SET
argument_list|(
name|FA4_FILES_TOTAL
argument_list|,
name|__fsattr_bm
argument_list|)
expr_stmt|;
name|FA4_SET
argument_list|(
name|FA4_SPACE_AVAIL
argument_list|,
name|__fsattr_bm
argument_list|)
expr_stmt|;
name|FA4_SET
argument_list|(
name|FA4_SPACE_FREE
argument_list|,
name|__fsattr_bm
argument_list|)
expr_stmt|;
name|FA4_SET
argument_list|(
name|FA4_SPACE_TOTAL
argument_list|,
name|__fsattr_bm
argument_list|)
expr_stmt|;
name|FA4_SET
argument_list|(
name|FA4_TYPE
argument_list|,
name|__getattr_bm
argument_list|)
expr_stmt|;
name|FA4_SET
argument_list|(
name|FA4_FSID
argument_list|,
name|__getattr_bm
argument_list|)
expr_stmt|;
name|FA4_SET
argument_list|(
name|FA4_SIZE
argument_list|,
name|__getattr_bm
argument_list|)
expr_stmt|;
name|FA4_SET
argument_list|(
name|FA4_MODE
argument_list|,
name|__getattr_bm
argument_list|)
expr_stmt|;
name|FA4_SET
argument_list|(
name|FA4_RAWDEV
argument_list|,
name|__getattr_bm
argument_list|)
expr_stmt|;
name|FA4_SET
argument_list|(
name|FA4_NUMLINKS
argument_list|,
name|__getattr_bm
argument_list|)
expr_stmt|;
name|FA4_SET
argument_list|(
name|FA4_OWNER
argument_list|,
name|__getattr_bm
argument_list|)
expr_stmt|;
name|FA4_SET
argument_list|(
name|FA4_OWNER_GROUP
argument_list|,
name|__getattr_bm
argument_list|)
expr_stmt|;
name|FA4_SET
argument_list|(
name|FA4_FILEID
argument_list|,
name|__getattr_bm
argument_list|)
expr_stmt|;
name|FA4_SET
argument_list|(
name|FA4_TIME_MODIFY
argument_list|,
name|__getattr_bm
argument_list|)
expr_stmt|;
name|FA4_SET
argument_list|(
name|FA4_TIME_ACCESS
argument_list|,
name|__getattr_bm
argument_list|)
expr_stmt|;
comment|/*        FA4_SET(FA4_TIME_CREATE, __getattr_bm);*/
name|FA4_SET
argument_list|(
name|FA4_TYPE
argument_list|,
name|__readdir_bm
argument_list|)
expr_stmt|;
name|FA4_SET
argument_list|(
name|FA4_FSID
argument_list|,
name|__readdir_bm
argument_list|)
expr_stmt|;
name|FA4_SET
argument_list|(
name|FA4_FILEID
argument_list|,
name|__readdir_bm
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Util  */
end_comment

begin_function
name|uint32_t
name|nfs_v4fileid4_to_fileid
parameter_list|(
name|uint64_t
name|fid
parameter_list|)
block|{
return|return
operator|(
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|fid
operator|>>
literal|32
operator|)
operator||
name|fid
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|nfs_v4initcompound
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|)
block|{
name|bzero
argument_list|(
name|cp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cp
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Build/dissect XDR buffer with a format string.  *  *    u - unsigned  *    h - hyper  *    s - stringlength, string  *    k - skip length (bytes)  *    a - arraylength, componentlenght, array  *    o - opaque fix length  *    O - opaque var length in bytes  */
end_comment

begin_function
name|void
name|nfsm_buildf_xx
parameter_list|(
name|struct
name|mbuf
modifier|*
modifier|*
name|mb
parameter_list|,
name|caddr_t
modifier|*
name|bpos
parameter_list|,
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|uint32_t
modifier|*
name|tl
decl_stmt|,
name|t1
decl_stmt|,
name|len
decl_stmt|,
name|uval
decl_stmt|;
name|uint64_t
name|hval
decl_stmt|;
name|va_list
name|args
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|which
decl_stmt|;
name|va_start
argument_list|(
name|args
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
for|for
control|(
name|which
operator|=
name|fmt
init|;
operator|*
name|which
operator|!=
literal|'\0'
condition|;
name|which
operator|++
control|)
switch|switch
condition|(
operator|*
name|which
condition|)
block|{
case|case
literal|'u'
case|:
comment|/* Unsigned */
name|tl
operator|=
name|nfsm_build_xx
argument_list|(
name|NFSX_UNSIGNED
argument_list|,
name|mb
argument_list|,
name|bpos
argument_list|)
expr_stmt|;
name|uval
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
name|uint32_t
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|uval
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
comment|/* Hyper */
name|tl
operator|=
name|nfsm_build_xx
argument_list|(
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|,
name|mb
argument_list|,
name|bpos
argument_list|)
expr_stmt|;
name|hval
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
name|uint64_t
argument_list|)
expr_stmt|;
name|txdr_hyper
argument_list|(
name|hval
argument_list|,
name|tl
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
comment|/* Fixed-length opaque */
name|len
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
name|uint32_t
argument_list|)
expr_stmt|;
name|p
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
name|char
operator|*
argument_list|)
expr_stmt|;
name|tl
operator|=
name|nfsm_build_xx
argument_list|(
name|nfsm_rndup
argument_list|(
name|len
argument_list|)
argument_list|,
name|mb
argument_list|,
name|bpos
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|p
argument_list|,
name|tl
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'O'
case|:
comment|/* Variable-length opaque */
case|case
literal|'s'
case|:
comment|/* String */
name|len
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
name|uint32_t
argument_list|)
expr_stmt|;
name|p
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
name|char
operator|*
argument_list|)
expr_stmt|;
name|t1
operator|=
name|nfsm_strtom_xx
argument_list|(
name|p
argument_list|,
name|len
argument_list|,
name|len
argument_list|,
name|mb
argument_list|,
name|bpos
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'k'
case|:
comment|/* Skip */
name|len
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
name|uint32_t
argument_list|)
expr_stmt|;
name|nfsm_build_xx
argument_list|(
name|nfsm_rndup
argument_list|(
name|len
argument_list|)
argument_list|,
name|mb
argument_list|,
name|bpos
argument_list|)
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"Invalid buildf string %s[%c]"
argument_list|,
name|fmt
argument_list|,
operator|*
name|which
argument_list|)
expr_stmt|;
break|break;
block|}
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|nfsm_dissectf_xx
parameter_list|(
name|struct
name|mbuf
modifier|*
modifier|*
name|md
parameter_list|,
name|caddr_t
modifier|*
name|dpos
parameter_list|,
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|uint32_t
modifier|*
name|tl
decl_stmt|,
name|t1
decl_stmt|,
name|len
decl_stmt|,
modifier|*
name|uval
decl_stmt|;
name|uint64_t
modifier|*
name|hval
decl_stmt|;
name|va_list
name|args
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|which
decl_stmt|;
name|va_start
argument_list|(
name|args
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
for|for
control|(
name|which
operator|=
name|fmt
init|;
operator|*
name|which
operator|!=
literal|'\0'
condition|;
name|which
operator|++
control|)
switch|switch
condition|(
operator|*
name|which
condition|)
block|{
case|case
literal|'u'
case|:
comment|/* Unsigned */
name|tl
operator|=
name|nfsm_dissect_xx
argument_list|(
name|NFSX_UNSIGNED
argument_list|,
name|md
argument_list|,
name|dpos
argument_list|)
expr_stmt|;
if|if
condition|(
name|tl
operator|==
name|NULL
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
name|uval
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
name|uint32_t
operator|*
argument_list|)
expr_stmt|;
operator|*
name|uval
operator|=
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
comment|/* Hyper */
name|tl
operator|=
name|nfsm_dissect_xx
argument_list|(
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|,
name|md
argument_list|,
name|dpos
argument_list|)
expr_stmt|;
if|if
condition|(
name|tl
operator|==
name|NULL
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
name|hval
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
name|uint64_t
operator|*
argument_list|)
expr_stmt|;
operator|*
name|hval
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
comment|/* Fixed-length opaque */
name|len
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
name|uint32_t
argument_list|)
expr_stmt|;
name|p
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
name|void
operator|*
argument_list|)
expr_stmt|;
name|tl
operator|=
name|nfsm_dissect_xx
argument_list|(
name|nfsm_rndup
argument_list|(
name|len
argument_list|)
argument_list|,
name|md
argument_list|,
name|dpos
argument_list|)
expr_stmt|;
if|if
condition|(
name|tl
operator|==
name|NULL
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
name|bcopy
argument_list|(
name|tl
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'O'
case|:
comment|/* Variable-length opaque */
case|case
literal|'s'
case|:
comment|/* String */
name|len
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
name|uint32_t
argument_list|)
expr_stmt|;
name|p
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
name|char
operator|*
argument_list|)
expr_stmt|;
name|tl
operator|=
name|nfsm_dissect_xx
argument_list|(
name|nfsm_rndup
argument_list|(
name|len
argument_list|)
argument_list|,
name|md
argument_list|,
name|dpos
argument_list|)
expr_stmt|;
if|if
condition|(
name|tl
operator|==
name|NULL
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
name|bcopy
argument_list|(
name|tl
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'k'
case|:
comment|/* Skip bytes */
name|len
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
name|uint32_t
argument_list|)
expr_stmt|;
name|t1
operator|=
name|nfsm_adv_xx
argument_list|(
name|nfsm_rndup
argument_list|(
name|len
argument_list|)
argument_list|,
name|md
argument_list|,
name|dpos
argument_list|)
expr_stmt|;
break|break;
default|default:
name|panic
argument_list|(
literal|"Invalid dissectf string %s[%c]"
argument_list|,
name|fmt
argument_list|,
operator|*
name|which
argument_list|)
expr_stmt|;
break|break;
block|}
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * XXX - There are a few problems with the way the postops are places  * in the code.  Ideally, they should be taken care of immediately, as  * to avoid uneceesary waits for mutexes, but then we would be  * introducing even more complexity by having to handle two separate  * cases.  Also, since they are placed at the end of the vnops', there  * may be operations which sleep in between, further extending this  * wait.  It is conceivable that there is a deadlock condition there,  * too.  *  * Also, for vnops that do multiple operations, it's inconvenient  * since on error, individual decoding will got nfsmout.  */
end_comment

begin_function
name|int
name|nfs_v4postop
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|int
name|status
parameter_list|)
block|{
name|struct
name|nfs4_fctx
modifier|*
name|fcp
init|=
name|cp
operator|->
name|fcp
decl_stmt|;
comment|/* 	 * XXX does the previous result need to be stores with the 	 * lockowner?  ack, spec is unclear .. 	 */
if|if
condition|(
name|fcp
operator|!=
name|NULL
condition|)
if|if
condition|(
name|cp
operator|->
name|seqidused
operator|<
name|cp
operator|->
name|rep_nops
operator|||
operator|(
name|cp
operator|->
name|seqidused
operator|+
literal|1
operator|==
name|cp
operator|->
name|rep_nops
operator|&&
name|NFS4_SEQIDMUTATINGERROR
argument_list|(
name|status
argument_list|)
operator|)
condition|)
name|fcp
operator|->
name|lop
operator|->
name|lo_seqid
operator|++
expr_stmt|;
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfs_v4handlestatus
parameter_list|(
name|int
name|status
parameter_list|,
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|)
block|{
return|return
operator|(
name|status
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Initial setup of compound.  */
end_comment

begin_function
name|int
name|nfsm_v4build_compound_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|char
modifier|*
name|tag
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mb
parameter_list|,
name|caddr_t
modifier|*
name|bpos
parameter_list|)
block|{
name|uint32_t
name|t1
decl_stmt|,
modifier|*
name|tl
decl_stmt|,
name|siz
decl_stmt|;
comment|/* Tag */
name|siz
operator|=
name|strlen
argument_list|(
name|tag
argument_list|)
expr_stmt|;
name|t1
operator|=
name|nfsm_rndup
argument_list|(
name|siz
argument_list|)
operator|+
name|NFSX_UNSIGNED
expr_stmt|;
if|if
condition|(
name|t1
operator|<=
name|M_TRAILINGSPACE
argument_list|(
operator|*
name|mb
argument_list|)
condition|)
block|{
name|tl
operator|=
name|nfsm_build_xx
argument_list|(
name|t1
argument_list|,
name|mb
argument_list|,
name|bpos
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|siz
argument_list|)
expr_stmt|;
operator|*
operator|(
name|tl
operator|+
operator|(
operator|(
name|t1
operator|>>
literal|2
operator|)
operator|-
literal|2
operator|)
operator|)
operator|=
literal|0
expr_stmt|;
name|bcopy
argument_list|(
name|tag
argument_list|,
name|tl
argument_list|,
name|siz
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|t1
operator|=
name|nfsm_strtmbuf
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|tag
argument_list|,
name|siz
argument_list|)
expr_stmt|;
if|if
condition|(
name|t1
operator|!=
literal|0
condition|)
return|return
operator|(
name|t1
operator|)
return|;
block|}
comment|/* Minor version and argarray*/
name|tl
operator|=
name|nfsm_build_xx
argument_list|(
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|,
name|mb
argument_list|,
name|bpos
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|NFS4_MINOR_VERSION
argument_list|)
expr_stmt|;
comment|/* Save for backfill */
name|cp
operator|->
name|req_nopsp
operator|=
name|tl
expr_stmt|;
operator|*
name|tl
operator|=
name|txdr_unsigned
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|cp
operator|->
name|curvp
operator|=
name|NULL
expr_stmt|;
name|cp
operator|->
name|savevp
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * XXX  * - backfill for stateid, and such  */
end_comment

begin_function
name|int
name|nfsm_v4build_finalize_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mb
parameter_list|,
name|caddr_t
modifier|*
name|bpos
parameter_list|)
block|{
operator|*
name|cp
operator|->
name|req_nopsp
operator|=
name|txdr_unsigned
argument_list|(
name|cp
operator|->
name|req_nops
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4build_putfh_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|vnode
modifier|*
name|vp
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mb
parameter_list|,
name|caddr_t
modifier|*
name|bpos
parameter_list|)
block|{
name|uint32_t
name|t1
decl_stmt|;
comment|/* Op */
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"u"
argument_list|,
name|NFSV4OP_PUTFH
argument_list|)
expr_stmt|;
comment|/* FH */
name|t1
operator|=
name|nfsm_fhtom_xx
argument_list|(
name|vp
argument_list|,
literal|1
argument_list|,
name|mb
argument_list|,
name|bpos
argument_list|)
expr_stmt|;
if|if
condition|(
name|t1
operator|!=
literal|0
condition|)
return|return
operator|(
name|t1
operator|)
return|;
name|cp
operator|->
name|req_nops
operator|++
expr_stmt|;
name|cp
operator|->
name|curvp
operator|=
name|vp
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4build_putfh_nv_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_oparg_getfh
modifier|*
name|gfh
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mb
parameter_list|,
name|caddr_t
modifier|*
name|bpos
parameter_list|)
block|{
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"uuo"
argument_list|,
name|NFSV4OP_PUTFH
argument_list|,
name|gfh
operator|->
name|fh_len
argument_list|,
name|gfh
operator|->
name|fh_len
argument_list|,
operator|&
name|gfh
operator|->
name|fh_val
argument_list|)
expr_stmt|;
name|cp
operator|->
name|req_nops
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4build_simple_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|uint32_t
name|op
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mb
parameter_list|,
name|caddr_t
modifier|*
name|bpos
parameter_list|)
block|{
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"u"
argument_list|,
name|op
argument_list|)
expr_stmt|;
name|cp
operator|->
name|req_nops
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4build_getattr_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_oparg_getattr
modifier|*
name|ga
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mb
parameter_list|,
name|caddr_t
modifier|*
name|bpos
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
comment|/* Op + bitmap length + bitmap */
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"uu"
argument_list|,
name|NFSV4OP_GETATTR
argument_list|,
name|ga
operator|->
name|bm
operator|->
name|bmlen
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ga
operator|->
name|bm
operator|->
name|bmlen
condition|;
name|i
operator|++
control|)
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"u"
argument_list|,
name|ga
operator|->
name|bm
operator|->
name|bmval
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ga
operator|->
name|vp
operator|=
name|cp
operator|->
name|curvp
expr_stmt|;
name|cp
operator|->
name|req_nops
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4build_setattr_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|vattr
modifier|*
name|vap
parameter_list|,
name|struct
name|nfs4_fctx
modifier|*
name|fcp
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mb
parameter_list|,
name|caddr_t
modifier|*
name|bpos
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"uo"
argument_list|,
name|NFSV4OP_SETATTR
argument_list|,
name|NFSX_V4STATEID
argument_list|,
name|fcp
operator|->
name|stateid
argument_list|)
expr_stmt|;
name|error
operator|=
name|nfsm_v4build_attrs_xx
argument_list|(
name|vap
argument_list|,
name|mb
argument_list|,
name|bpos
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|cp
operator|->
name|req_nops
operator|++
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4build_getfh_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_oparg_getfh
modifier|*
name|gfh
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mb
parameter_list|,
name|caddr_t
modifier|*
name|bpos
parameter_list|)
block|{
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"u"
argument_list|,
name|NFSV4OP_GETFH
argument_list|)
expr_stmt|;
name|gfh
operator|->
name|vp
operator|=
name|cp
operator|->
name|curvp
expr_stmt|;
name|cp
operator|->
name|req_nops
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4build_lookup_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_oparg_lookup
modifier|*
name|l
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mb
parameter_list|,
name|caddr_t
modifier|*
name|bpos
parameter_list|)
block|{
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"us"
argument_list|,
name|NFSV4OP_LOOKUP
argument_list|,
name|l
operator|->
name|namelen
argument_list|,
name|l
operator|->
name|name
argument_list|)
expr_stmt|;
name|cp
operator|->
name|curvp
operator|=
name|l
operator|->
name|vp
expr_stmt|;
name|cp
operator|->
name|req_nops
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4build_setclientid_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_oparg_setclientid
modifier|*
name|sci
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mb
parameter_list|,
name|caddr_t
modifier|*
name|bpos
parameter_list|)
block|{
name|struct
name|timeval
name|tv
decl_stmt|;
name|microtime
argument_list|(
operator|&
name|tv
argument_list|)
expr_stmt|;
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"uuusussu"
argument_list|,
name|NFSV4OP_SETCLIENTID
argument_list|,
name|tv
operator|.
name|tv_sec
argument_list|,
name|tv
operator|.
name|tv_usec
argument_list|,
name|sci
operator|->
name|namelen
argument_list|,
name|sci
operator|->
name|name
argument_list|,
name|sci
operator|->
name|cb_prog
argument_list|,
name|sci
operator|->
name|cb_netidlen
argument_list|,
name|sci
operator|->
name|cb_netid
argument_list|,
name|sci
operator|->
name|cb_univaddrlen
argument_list|,
name|sci
operator|->
name|cb_univaddr
argument_list|,
literal|0xCA11BACC
argument_list|)
expr_stmt|;
name|cp
operator|->
name|req_nops
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4build_setclientid_confirm_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_oparg_setclientid
modifier|*
name|sci
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mb
parameter_list|,
name|caddr_t
modifier|*
name|bpos
parameter_list|)
block|{
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"uho"
argument_list|,
name|NFSV4OP_SETCLIENTID_CONFIRM
argument_list|,
name|sci
operator|->
name|clientid
argument_list|,
sizeof|sizeof
argument_list|(
name|sci
operator|->
name|verf
argument_list|)
argument_list|,
name|sci
operator|->
name|verf
argument_list|)
expr_stmt|;
name|cp
operator|->
name|req_nops
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4build_open_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_oparg_open
modifier|*
name|op
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mb
parameter_list|,
name|caddr_t
modifier|*
name|bpos
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
name|struct
name|nfs4_lowner
modifier|*
name|lop
init|=
name|op
operator|->
name|fcp
operator|->
name|lop
decl_stmt|;
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"uuuuhuu"
argument_list|,
name|NFSV4OP_OPEN
argument_list|,
name|lop
operator|->
name|lo_seqid
argument_list|,
name|op
operator|->
name|flags
operator|&
name|O_ACCMODE
argument_list|,
name|NFSV4OPENSHARE_DENY_NONE
argument_list|,
name|cp
operator|->
name|nmp
operator|->
name|nm_clientid
argument_list|,
literal|4
argument_list|,
name|lop
operator|->
name|lo_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|->
name|flags
operator|&
name|O_CREAT
condition|)
block|{
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"u"
argument_list|,
name|OTCREATE
argument_list|)
expr_stmt|;
comment|/* openflag4: mode */
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"u"
argument_list|,
name|CMUNCHECKED
argument_list|)
expr_stmt|;
comment|/* openflag4: createattrs... */
if|if
condition|(
name|op
operator|->
name|vap
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|op
operator|->
name|flags
operator|&
name|O_TRUNC
condition|)
name|op
operator|->
name|vap
operator|->
name|va_size
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|nfsm_v4build_attrs_xx
argument_list|(
name|op
operator|->
name|vap
argument_list|,
name|mb
argument_list|,
name|bpos
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
else|else
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"uu"
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"u"
argument_list|,
name|OTNOCREATE
argument_list|)
expr_stmt|;
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"us"
argument_list|,
name|op
operator|->
name|ctype
argument_list|,
name|op
operator|->
name|cnp
operator|->
name|cn_namelen
argument_list|,
name|op
operator|->
name|cnp
operator|->
name|cn_nameptr
argument_list|)
expr_stmt|;
name|cp
operator|->
name|seqidused
operator|=
name|cp
operator|->
name|req_nops
operator|++
expr_stmt|;
name|cp
operator|->
name|fcp
operator|=
name|op
operator|->
name|fcp
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * XXX  * - Wait on recovery  */
end_comment

begin_function
name|int
name|nfsm_v4build_open_confirm_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_oparg_open
modifier|*
name|op
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mb
parameter_list|,
name|caddr_t
modifier|*
name|bpos
parameter_list|)
block|{
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"uou"
argument_list|,
name|NFSV4OP_OPEN_CONFIRM
argument_list|,
name|NFSX_V4STATEID
argument_list|,
name|op
operator|->
name|fcp
operator|->
name|stateid
argument_list|,
name|op
operator|->
name|fcp
operator|->
name|lop
operator|->
name|lo_seqid
argument_list|)
expr_stmt|;
name|cp
operator|->
name|seqidused
operator|=
name|cp
operator|->
name|req_nops
operator|++
expr_stmt|;
name|cp
operator|->
name|fcp
operator|=
name|op
operator|->
name|fcp
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * XXX  * - Wait on recovery  */
end_comment

begin_function
name|int
name|nfsm_v4build_close_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_fctx
modifier|*
name|fcp
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mb
parameter_list|,
name|caddr_t
modifier|*
name|bpos
parameter_list|)
block|{
name|struct
name|nfs4_lowner
modifier|*
name|lop
init|=
name|fcp
operator|->
name|lop
decl_stmt|;
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"uuo"
argument_list|,
name|NFSV4OP_CLOSE
argument_list|,
name|lop
operator|->
name|lo_seqid
argument_list|,
name|NFSX_V4STATEID
argument_list|,
name|fcp
operator|->
name|stateid
argument_list|)
expr_stmt|;
name|cp
operator|->
name|seqidused
operator|=
name|cp
operator|->
name|req_nops
operator|++
expr_stmt|;
name|cp
operator|->
name|fcp
operator|=
name|fcp
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4build_access_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_oparg_access
modifier|*
name|acc
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mb
parameter_list|,
name|caddr_t
modifier|*
name|bpos
parameter_list|)
block|{
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"uu"
argument_list|,
name|NFSV4OP_ACCESS
argument_list|,
name|acc
operator|->
name|mode
argument_list|)
expr_stmt|;
name|cp
operator|->
name|req_nops
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4build_read_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_oparg_read
modifier|*
name|r
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mb
parameter_list|,
name|caddr_t
modifier|*
name|bpos
parameter_list|)
block|{
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"uohu"
argument_list|,
name|NFSV4OP_READ
argument_list|,
name|NFSX_V4STATEID
argument_list|,
name|r
operator|->
name|fcp
operator|->
name|stateid
argument_list|,
name|r
operator|->
name|off
argument_list|,
name|r
operator|->
name|maxcnt
argument_list|)
expr_stmt|;
name|cp
operator|->
name|req_nops
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4build_write_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_oparg_write
modifier|*
name|w
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mb
parameter_list|,
name|caddr_t
modifier|*
name|bpos
parameter_list|)
block|{
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"uohuu"
argument_list|,
name|NFSV4OP_WRITE
argument_list|,
name|NFSX_V4STATEID
argument_list|,
name|w
operator|->
name|fcp
operator|->
name|stateid
argument_list|,
name|w
operator|->
name|off
argument_list|,
name|w
operator|->
name|stable
argument_list|,
name|w
operator|->
name|cnt
argument_list|)
expr_stmt|;
name|cp
operator|->
name|req_nops
operator|++
expr_stmt|;
return|return
operator|(
name|nfsm_uiotombuf
argument_list|(
name|w
operator|->
name|uiop
argument_list|,
name|mb
argument_list|,
name|w
operator|->
name|cnt
argument_list|,
name|bpos
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4build_commit_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_oparg_commit
modifier|*
name|c
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mb
parameter_list|,
name|caddr_t
modifier|*
name|bpos
parameter_list|)
block|{
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"uhu"
argument_list|,
name|NFSV4OP_COMMIT
argument_list|,
name|c
operator|->
name|start
argument_list|,
name|c
operator|->
name|len
argument_list|)
expr_stmt|;
name|cp
operator|->
name|req_nops
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4build_readdir_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_oparg_readdir
modifier|*
name|r
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mb
parameter_list|,
name|caddr_t
modifier|*
name|bpos
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"uhouuu"
argument_list|,
name|NFSV4OP_READDIR
argument_list|,
name|r
operator|->
name|cookie
argument_list|,
sizeof|sizeof
argument_list|(
name|r
operator|->
name|verf
argument_list|)
argument_list|,
name|r
operator|->
name|verf
argument_list|,
name|r
operator|->
name|cnt
operator|>>
literal|4
argument_list|,
comment|/* meaningless "dircount" field */
name|r
operator|->
name|cnt
argument_list|,
name|r
operator|->
name|bm
operator|->
name|bmlen
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|r
operator|->
name|bm
operator|->
name|bmlen
condition|;
name|i
operator|++
control|)
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"u"
argument_list|,
name|r
operator|->
name|bm
operator|->
name|bmval
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|cp
operator|->
name|req_nops
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4build_renew_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|uint64_t
name|cid
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mb
parameter_list|,
name|caddr_t
modifier|*
name|bpos
parameter_list|)
block|{
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"uh"
argument_list|,
name|NFSV4OP_RENEW
argument_list|,
name|cid
argument_list|)
expr_stmt|;
name|cp
operator|->
name|req_nops
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4build_create_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_oparg_create
modifier|*
name|c
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mb
parameter_list|,
name|caddr_t
modifier|*
name|bpos
parameter_list|)
block|{
name|uint32_t
name|t1
decl_stmt|;
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"uu"
argument_list|,
name|NFSV4OP_CREATE
argument_list|,
name|c
operator|->
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|NFLNK
condition|)
comment|/* XXX strlen */
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"s"
argument_list|,
name|strlen
argument_list|(
name|c
operator|->
name|linktext
argument_list|)
argument_list|,
name|c
operator|->
name|linktext
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|NFCHR
operator|||
name|c
operator|->
name|type
operator|==
name|NFBLK
condition|)
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"uu"
argument_list|,
name|umajor
argument_list|(
name|c
operator|->
name|vap
operator|->
name|va_rdev
argument_list|)
argument_list|,
name|uminor
argument_list|(
name|c
operator|->
name|vap
operator|->
name|va_rdev
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Name */
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"s"
argument_list|,
name|c
operator|->
name|namelen
argument_list|,
name|c
operator|->
name|name
argument_list|)
expr_stmt|;
comment|/* Attributes */
name|t1
operator|=
name|nfsm_v4build_attrs_xx
argument_list|(
name|c
operator|->
name|vap
argument_list|,
name|mb
argument_list|,
name|bpos
argument_list|)
expr_stmt|;
if|if
condition|(
name|t1
operator|!=
literal|0
condition|)
return|return
operator|(
name|t1
operator|)
return|;
name|cp
operator|->
name|req_nops
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4build_rename_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_oparg_rename
modifier|*
name|r
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mb
parameter_list|,
name|caddr_t
modifier|*
name|bpos
parameter_list|)
block|{
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"uss"
argument_list|,
name|NFSV4OP_RENAME
argument_list|,
name|r
operator|->
name|fnamelen
argument_list|,
name|r
operator|->
name|fname
argument_list|,
name|r
operator|->
name|tnamelen
argument_list|,
name|r
operator|->
name|tname
argument_list|)
expr_stmt|;
name|cp
operator|->
name|req_nops
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4build_link_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_oparg_link
modifier|*
name|l
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mb
parameter_list|,
name|caddr_t
modifier|*
name|bpos
parameter_list|)
block|{
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"us"
argument_list|,
name|NFSV4OP_LINK
argument_list|,
name|l
operator|->
name|namelen
argument_list|,
name|l
operator|->
name|name
argument_list|)
expr_stmt|;
name|cp
operator|->
name|req_nops
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4build_remove_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|u_int
name|namelen
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mb
parameter_list|,
name|caddr_t
modifier|*
name|bpos
parameter_list|)
block|{
name|nfsm_buildf_xx
argument_list|(
name|mb
argument_list|,
name|bpos
argument_list|,
literal|"us"
argument_list|,
name|NFSV4OP_REMOVE
argument_list|,
name|namelen
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|cp
operator|->
name|req_nops
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4build_attrs_xx
parameter_list|(
name|struct
name|vattr
modifier|*
name|vap
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|mb
parameter_list|,
name|caddr_t
modifier|*
name|bpos
parameter_list|)
block|{
name|uint32_t
modifier|*
name|tl
decl_stmt|,
modifier|*
name|attrlenp
decl_stmt|,
modifier|*
name|bmvalp
decl_stmt|,
name|siz
decl_stmt|,
name|len
decl_stmt|;
name|tl
operator|=
name|nfsm_build_xx
argument_list|(
literal|4
operator|*
name|NFSX_UNSIGNED
argument_list|,
name|mb
argument_list|,
name|bpos
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
literal|2
argument_list|)
expr_stmt|;
comment|/* bitmap length */
name|bmvalp
operator|=
name|tl
expr_stmt|;
name|bzero
argument_list|(
name|bmvalp
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
name|attrlenp
operator|=
name|tl
expr_stmt|;
name|len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|vap
operator|->
name|va_size
operator|!=
name|VNOVAL
condition|)
block|{
name|tl
operator|=
name|nfsm_build_xx
argument_list|(
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|,
name|mb
argument_list|,
name|bpos
argument_list|)
expr_stmt|;
name|FA4_SET
argument_list|(
name|FA4_SIZE
argument_list|,
name|bmvalp
argument_list|)
expr_stmt|;
name|txdr_hyper
argument_list|(
name|vap
operator|->
name|va_size
argument_list|,
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
name|len
operator|+=
literal|2
operator|*
name|NFSX_UNSIGNED
expr_stmt|;
block|}
if|if
condition|(
name|vap
operator|->
name|va_mode
operator|!=
operator|(
name|u_short
operator|)
name|VNOVAL
condition|)
block|{
name|tl
operator|=
name|nfsm_build_xx
argument_list|(
name|NFSX_UNSIGNED
argument_list|,
name|mb
argument_list|,
name|bpos
argument_list|)
expr_stmt|;
name|FA4_SET
argument_list|(
name|FA4_MODE
argument_list|,
name|bmvalp
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|vap
operator|->
name|va_mode
argument_list|)
expr_stmt|;
name|len
operator|+=
name|NFSX_UNSIGNED
expr_stmt|;
block|}
if|if
condition|(
name|vap
operator|->
name|va_uid
operator|!=
name|VNOVAL
condition|)
block|{
name|int
name|error
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|error
operator|=
name|idmap_uid_to_name
argument_list|(
name|vap
operator|->
name|va_uid
argument_list|,
operator|&
name|name
argument_list|,
operator|&
name|siz
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
name|name
operator|==
name|NULL
operator|||
name|siz
operator|==
literal|0
condition|)
block|{
comment|/* XXX */
name|siz
operator|=
sizeof|sizeof
argument_list|(
literal|"nobody"
argument_list|)
operator|-
literal|1
expr_stmt|;
name|tl
operator|=
name|nfsm_build_xx
argument_list|(
name|NFSX_UNSIGNED
operator|+
name|nfsm_rndup
argument_list|(
name|siz
argument_list|)
argument_list|,
name|mb
argument_list|,
name|bpos
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|siz
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
literal|"nobody"
argument_list|,
name|tl
argument_list|,
name|siz
argument_list|)
expr_stmt|;
name|len
operator|+=
name|NFSX_UNSIGNED
operator|+
name|nfsm_rndup
argument_list|(
name|siz
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tl
operator|=
name|nfsm_build_xx
argument_list|(
name|NFSX_UNSIGNED
operator|+
name|nfsm_rndup
argument_list|(
name|siz
argument_list|)
argument_list|,
name|mb
argument_list|,
name|bpos
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|siz
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|name
argument_list|,
name|tl
argument_list|,
name|siz
argument_list|)
expr_stmt|;
name|len
operator|+=
name|NFSX_UNSIGNED
operator|+
name|nfsm_rndup
argument_list|(
name|siz
argument_list|)
expr_stmt|;
block|}
name|FA4_SET
argument_list|(
name|FA4_OWNER
argument_list|,
name|bmvalp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|vap
operator|->
name|va_gid
operator|!=
name|VNOVAL
condition|)
block|{
name|int
name|error
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|error
operator|=
name|idmap_gid_to_name
argument_list|(
name|vap
operator|->
name|va_gid
argument_list|,
operator|&
name|name
argument_list|,
operator|&
name|siz
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
name|name
operator|==
name|NULL
operator|||
name|siz
operator|==
literal|0
condition|)
block|{
comment|/* XXX */
name|siz
operator|=
sizeof|sizeof
argument_list|(
literal|"nogroup"
argument_list|)
operator|-
literal|1
expr_stmt|;
name|tl
operator|=
name|nfsm_build_xx
argument_list|(
name|NFSX_UNSIGNED
operator|+
name|nfsm_rndup
argument_list|(
name|siz
argument_list|)
argument_list|,
name|mb
argument_list|,
name|bpos
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|siz
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
literal|"nogroup"
argument_list|,
name|tl
argument_list|,
name|siz
argument_list|)
expr_stmt|;
name|len
operator|+=
name|NFSX_UNSIGNED
operator|+
name|nfsm_rndup
argument_list|(
name|siz
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tl
operator|=
name|nfsm_build_xx
argument_list|(
name|NFSX_UNSIGNED
operator|+
name|nfsm_rndup
argument_list|(
name|siz
argument_list|)
argument_list|,
name|mb
argument_list|,
name|bpos
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|siz
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|name
argument_list|,
name|tl
argument_list|,
name|siz
argument_list|)
expr_stmt|;
name|len
operator|+=
name|NFSX_UNSIGNED
operator|+
name|nfsm_rndup
argument_list|(
name|siz
argument_list|)
expr_stmt|;
block|}
name|FA4_SET
argument_list|(
name|FA4_OWNER_GROUP
argument_list|,
name|bmvalp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|vap
operator|->
name|va_atime
operator|.
name|tv_sec
operator|!=
name|VNOVAL
condition|)
block|{
name|uint64_t
name|val
init|=
name|vap
operator|->
name|va_atime
operator|.
name|tv_sec
decl_stmt|;
name|tl
operator|=
name|nfsm_build_xx
argument_list|(
literal|4
operator|*
name|NFSX_UNSIGNED
argument_list|,
name|mb
argument_list|,
name|bpos
argument_list|)
expr_stmt|;
name|FA4_SET
argument_list|(
name|FA4_TIME_ACCESS_SET
argument_list|,
name|bmvalp
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|THCLIENTTIME
argument_list|)
expr_stmt|;
name|txdr_hyper
argument_list|(
name|val
argument_list|,
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|vap
operator|->
name|va_atime
operator|.
name|tv_nsec
argument_list|)
expr_stmt|;
name|len
operator|+=
literal|4
operator|*
name|NFSX_UNSIGNED
expr_stmt|;
block|}
if|if
condition|(
name|vap
operator|->
name|va_mtime
operator|.
name|tv_sec
operator|!=
name|VNOVAL
condition|)
block|{
name|uint64_t
name|val
init|=
name|vap
operator|->
name|va_mtime
operator|.
name|tv_sec
decl_stmt|;
name|tl
operator|=
name|nfsm_build_xx
argument_list|(
literal|4
operator|*
name|NFSX_UNSIGNED
argument_list|,
name|mb
argument_list|,
name|bpos
argument_list|)
expr_stmt|;
name|FA4_SET
argument_list|(
name|FA4_TIME_MODIFY_SET
argument_list|,
name|bmvalp
argument_list|)
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|THCLIENTTIME
argument_list|)
expr_stmt|;
name|txdr_hyper
argument_list|(
name|val
argument_list|,
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
operator|*
name|tl
operator|++
operator|=
name|txdr_unsigned
argument_list|(
name|vap
operator|->
name|va_mtime
operator|.
name|tv_nsec
argument_list|)
expr_stmt|;
name|len
operator|+=
literal|4
operator|*
name|NFSX_UNSIGNED
expr_stmt|;
block|}
name|bmvalp
index|[
literal|0
index|]
operator|=
name|txdr_unsigned
argument_list|(
name|bmvalp
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|bmvalp
index|[
literal|1
index|]
operator|=
name|txdr_unsigned
argument_list|(
name|bmvalp
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
operator|*
name|attrlenp
operator|=
name|txdr_unsigned
argument_list|(
name|len
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4dissect_compound_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|md
parameter_list|,
name|caddr_t
modifier|*
name|dpos
parameter_list|)
block|{
name|uint32_t
name|taglen
decl_stmt|,
name|t1
decl_stmt|,
modifier|*
name|tl
decl_stmt|;
name|tl
operator|=
name|nfsm_dissect_xx
argument_list|(
name|NFSX_UNSIGNED
argument_list|,
name|md
argument_list|,
name|dpos
argument_list|)
expr_stmt|;
if|if
condition|(
name|tl
operator|==
name|NULL
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
comment|/* Reply status is handled by the RPC code */
name|taglen
operator|=
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|t1
operator|=
name|nfsm_adv_xx
argument_list|(
name|nfsm_rndup
argument_list|(
name|taglen
argument_list|)
argument_list|,
name|md
argument_list|,
name|dpos
argument_list|)
expr_stmt|;
if|if
condition|(
name|t1
operator|!=
literal|0
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
name|tl
operator|=
name|nfsm_dissect_xx
argument_list|(
name|NFSX_UNSIGNED
argument_list|,
name|md
argument_list|,
name|dpos
argument_list|)
expr_stmt|;
if|if
condition|(
name|tl
operator|==
name|NULL
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
name|cp
operator|->
name|rep_nops
operator|=
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4dissect_simple_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|uint32_t
name|op
parameter_list|,
name|uint32_t
name|skipbytes
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|md
parameter_list|,
name|caddr_t
modifier|*
name|dpos
parameter_list|)
block|{
name|uint32_t
name|t1
decl_stmt|,
name|dop
decl_stmt|,
name|status
decl_stmt|;
name|t1
operator|=
name|nfsm_dissectf_xx
argument_list|(
name|md
argument_list|,
name|dpos
argument_list|,
literal|"uu"
argument_list|,
operator|&
name|dop
argument_list|,
operator|&
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|t1
operator|!=
literal|0
condition|)
return|return
operator|(
name|t1
operator|)
return|;
if|if
condition|(
name|dop
operator|!=
name|op
operator|||
name|status
operator|!=
literal|0
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
if|if
condition|(
name|skipbytes
operator|>
literal|0
condition|)
name|NFSM_ADV
argument_list|(
name|nfsm_rndup
argument_list|(
name|skipbytes
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4dissect_getattr_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_oparg_getattr
modifier|*
name|ga
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|md
parameter_list|,
name|caddr_t
modifier|*
name|dpos
parameter_list|)
block|{
name|uint32_t
modifier|*
name|tl
decl_stmt|;
name|tl
operator|=
name|nfsm_dissect_xx
argument_list|(
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|,
name|md
argument_list|,
name|dpos
argument_list|)
expr_stmt|;
if|if
condition|(
name|tl
operator|==
name|NULL
operator|||
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
operator|!=
name|NFSV4OP_GETATTR
operator|||
operator|*
name|tl
operator|++
operator|!=
literal|0
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
return|return
operator|(
name|nfsm_v4dissect_attrs_xx
argument_list|(
operator|&
name|ga
operator|->
name|fa
argument_list|,
name|md
argument_list|,
name|dpos
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4dissect_setattr_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|md
parameter_list|,
name|caddr_t
modifier|*
name|dpos
parameter_list|)
block|{
name|uint32_t
name|t1
decl_stmt|,
name|op
decl_stmt|,
name|bmlen
decl_stmt|,
name|status
decl_stmt|;
name|t1
operator|=
name|nfsm_dissectf_xx
argument_list|(
name|md
argument_list|,
name|dpos
argument_list|,
literal|"uu"
argument_list|,
operator|&
name|op
argument_list|,
operator|&
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|t1
operator|!=
literal|0
condition|)
return|return
operator|(
name|t1
operator|)
return|;
if|if
condition|(
name|op
operator|!=
name|NFSV4OP_SETATTR
operator|||
name|status
operator|!=
literal|0
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
name|t1
operator|=
name|nfsm_dissectf_xx
argument_list|(
name|md
argument_list|,
name|dpos
argument_list|,
literal|"u"
argument_list|,
operator|&
name|bmlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|t1
operator|!=
literal|0
condition|)
return|return
operator|(
name|t1
operator|)
return|;
return|return
operator|(
name|nfsm_dissectf_xx
argument_list|(
name|md
argument_list|,
name|dpos
argument_list|,
literal|"k"
argument_list|,
name|bmlen
operator|<<
literal|2
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4dissect_getfh_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_oparg_getfh
modifier|*
name|gfh
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|md
parameter_list|,
name|caddr_t
modifier|*
name|dpos
parameter_list|)
block|{
name|uint32_t
modifier|*
name|tl
decl_stmt|,
name|len
decl_stmt|,
name|xdrlen
decl_stmt|;
name|tl
operator|=
name|nfsm_dissect_xx
argument_list|(
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|,
name|md
argument_list|,
name|dpos
argument_list|)
expr_stmt|;
if|if
condition|(
name|tl
operator|==
name|NULL
operator|||
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
operator|!=
name|NFSV4OP_GETFH
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
if|if
condition|(
operator|*
name|tl
operator|++
operator|!=
literal|0
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
name|NFSM_DISSECT
argument_list|(
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|len
operator|=
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|NFSX_V4FH
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
comment|/* XXX integrate this into nfs_mtofh()? */
name|gfh
operator|->
name|fh_len
operator|=
name|len
expr_stmt|;
name|xdrlen
operator|=
name|nfsm_rndup
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|NFSM_DISSECT
argument_list|(
name|xdrlen
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|tl
argument_list|,
operator|&
name|gfh
operator|->
name|fh_val
argument_list|,
name|xdrlen
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4dissect_setclientid_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_oparg_setclientid
modifier|*
name|sci
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|md
parameter_list|,
name|caddr_t
modifier|*
name|dpos
parameter_list|)
block|{
name|uint32_t
modifier|*
name|tl
decl_stmt|;
name|tl
operator|=
name|nfsm_dissect_xx
argument_list|(
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|,
name|md
argument_list|,
name|dpos
argument_list|)
expr_stmt|;
if|if
condition|(
name|tl
operator|==
name|NULL
operator|||
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
operator|!=
name|NFSV4OP_SETCLIENTID
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
comment|/* Handle NFS4ERR_CLID_INUSE specially */
if|if
condition|(
operator|*
name|tl
operator|++
operator|!=
literal|0
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
name|NFSM_DISSECT
argument_list|(
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|sci
operator|->
name|clientid
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|NFSM_DISSECT
argument_list|(
name|nfsm_rndup
argument_list|(
name|NFSX_V4VERF
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|tl
argument_list|,
name|sci
operator|->
name|verf
argument_list|,
name|NFSX_V4VERF
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4dissect_close_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_fctx
modifier|*
name|fcp
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|md
parameter_list|,
name|caddr_t
modifier|*
name|dpos
parameter_list|)
block|{
name|uint32_t
modifier|*
name|tl
decl_stmt|,
name|t1
decl_stmt|;
name|tl
operator|=
name|nfsm_dissect_xx
argument_list|(
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|,
name|md
argument_list|,
name|dpos
argument_list|)
expr_stmt|;
if|if
condition|(
name|tl
operator|==
name|NULL
operator|||
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
operator|!=
name|NFSV4OP_CLOSE
operator|||
operator|*
name|tl
operator|++
operator|!=
literal|0
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
comment|/* Copy stateid */
name|t1
operator|=
name|nfsm_dissectf_xx
argument_list|(
name|md
argument_list|,
name|dpos
argument_list|,
literal|"o"
argument_list|,
name|NFSX_V4STATEID
argument_list|,
name|fcp
operator|->
name|stateid
argument_list|)
expr_stmt|;
if|if
condition|(
name|t1
operator|!=
literal|0
condition|)
return|return
operator|(
name|t1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4dissect_access_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_oparg_access
modifier|*
name|acc
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|md
parameter_list|,
name|caddr_t
modifier|*
name|dpos
parameter_list|)
block|{
name|uint32_t
modifier|*
name|tl
decl_stmt|;
name|tl
operator|=
name|nfsm_dissect_xx
argument_list|(
literal|4
operator|*
name|NFSX_UNSIGNED
argument_list|,
name|md
argument_list|,
name|dpos
argument_list|)
expr_stmt|;
if|if
condition|(
name|tl
operator|==
name|NULL
operator|||
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
operator|!=
name|NFSV4OP_ACCESS
operator|||
operator|*
name|tl
operator|++
operator|!=
literal|0
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
name|acc
operator|->
name|supported
operator|=
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|acc
operator|->
name|rmode
operator|=
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4dissect_open_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_oparg_open
modifier|*
name|op
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|md
parameter_list|,
name|caddr_t
modifier|*
name|dpos
parameter_list|)
block|{
name|uint32_t
modifier|*
name|tl
decl_stmt|,
name|t1
decl_stmt|,
name|bmlen
decl_stmt|,
name|delegtype
init|=
name|ODNONE
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
name|nfsv4changeinfo
name|cinfo
decl_stmt|;
name|struct
name|nfs4_fctx
modifier|*
name|fcp
init|=
name|op
operator|->
name|fcp
decl_stmt|;
name|tl
operator|=
name|nfsm_dissect_xx
argument_list|(
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|,
name|md
argument_list|,
name|dpos
argument_list|)
expr_stmt|;
if|if
condition|(
name|tl
operator|==
name|NULL
operator|||
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
operator|!=
name|NFSV4OP_OPEN
operator|||
operator|*
name|tl
operator|++
operator|!=
literal|0
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
name|t1
operator|=
name|nfsm_dissectf_xx
argument_list|(
name|md
argument_list|,
name|dpos
argument_list|,
literal|"o"
argument_list|,
name|NFSX_V4STATEID
argument_list|,
name|fcp
operator|->
name|stateid
argument_list|)
expr_stmt|;
if|if
condition|(
name|t1
operator|!=
literal|0
condition|)
return|return
operator|(
name|t1
operator|)
return|;
name|error
operator|=
name|nfsm_v4dissect_changeinfo_xx
argument_list|(
operator|&
name|cinfo
argument_list|,
name|md
argument_list|,
name|dpos
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
goto|goto
name|nfsmout
goto|;
name|NFSM_DISSECT
argument_list|(
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|op
operator|->
name|rflags
operator|=
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|bmlen
operator|=
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
if|if
condition|(
name|bmlen
operator|>
literal|2
condition|)
block|{
name|error
operator|=
name|EBADRPC
expr_stmt|;
goto|goto
name|nfsmout
goto|;
block|}
comment|/* Skip */
name|NFSM_ADV
argument_list|(
name|nfsm_rndup
argument_list|(
name|bmlen
operator|<<
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|NFSM_DISSECT
argument_list|(
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|delegtype
operator|=
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|delegtype
condition|)
block|{
case|case
name|ODREAD
case|:
case|case
name|ODWRITE
case|:
name|printf
argument_list|(
literal|"nfs4: client delegation not yet supported\n"
argument_list|)
expr_stmt|;
name|error
operator|=
name|EOPNOTSUPP
expr_stmt|;
goto|goto
name|nfsmout
goto|;
break|break;
case|case
name|ODNONE
case|:
default|default:
break|break;
block|}
name|nfsmout
label|:
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4dissect_open_confirm_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_oparg_open
modifier|*
name|op
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|md
parameter_list|,
name|caddr_t
modifier|*
name|dpos
parameter_list|)
block|{
name|uint32_t
modifier|*
name|tl
decl_stmt|;
name|tl
operator|=
name|nfsm_dissect_xx
argument_list|(
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|,
name|md
argument_list|,
name|dpos
argument_list|)
expr_stmt|;
if|if
condition|(
name|tl
operator|==
name|NULL
operator|||
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
operator|!=
name|NFSV4OP_OPEN_CONFIRM
operator|||
operator|*
name|tl
operator|++
operator|!=
literal|0
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
return|return
name|nfsm_dissectf_xx
argument_list|(
name|md
argument_list|,
name|dpos
argument_list|,
literal|"o"
argument_list|,
name|NFSX_V4STATEID
argument_list|,
name|op
operator|->
name|fcp
operator|->
name|stateid
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4dissect_read_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_oparg_read
modifier|*
name|r
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|md
parameter_list|,
name|caddr_t
modifier|*
name|dpos
parameter_list|)
block|{
name|uint32_t
name|op
decl_stmt|,
name|status
decl_stmt|,
name|t1
decl_stmt|;
name|t1
operator|=
name|nfsm_dissectf_xx
argument_list|(
name|md
argument_list|,
name|dpos
argument_list|,
literal|"uu"
argument_list|,
operator|&
name|op
argument_list|,
operator|&
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|t1
operator|!=
literal|0
condition|)
return|return
operator|(
name|t1
operator|)
return|;
if|if
condition|(
name|op
operator|!=
name|NFSV4OP_READ
operator|||
name|status
operator|!=
literal|0
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
name|t1
operator|=
name|nfsm_dissectf_xx
argument_list|(
name|md
argument_list|,
name|dpos
argument_list|,
literal|"uu"
argument_list|,
operator|&
name|r
operator|->
name|eof
argument_list|,
operator|&
name|r
operator|->
name|retlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|t1
operator|!=
literal|0
condition|)
return|return
operator|(
name|t1
operator|)
return|;
return|return
operator|(
name|nfsm_mbuftouio
argument_list|(
name|md
argument_list|,
name|r
operator|->
name|uiop
argument_list|,
name|r
operator|->
name|retlen
argument_list|,
name|dpos
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4dissect_write_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_oparg_write
modifier|*
name|w
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|md
parameter_list|,
name|caddr_t
modifier|*
name|dpos
parameter_list|)
block|{
name|uint32_t
name|op
decl_stmt|,
name|status
decl_stmt|,
name|t1
decl_stmt|;
name|t1
operator|=
name|nfsm_dissectf_xx
argument_list|(
name|md
argument_list|,
name|dpos
argument_list|,
literal|"uu"
argument_list|,
operator|&
name|op
argument_list|,
operator|&
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|t1
operator|!=
literal|0
condition|)
return|return
operator|(
name|t1
operator|)
return|;
if|if
condition|(
name|op
operator|!=
name|NFSV4OP_WRITE
operator|||
name|status
operator|!=
literal|0
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
return|return
operator|(
name|nfsm_dissectf_xx
argument_list|(
name|md
argument_list|,
name|dpos
argument_list|,
literal|"uuo"
argument_list|,
operator|&
name|w
operator|->
name|retlen
argument_list|,
operator|&
name|w
operator|->
name|committed
argument_list|,
name|NFSX_V4VERF
argument_list|,
name|w
operator|->
name|wverf
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4dissect_commit_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_oparg_commit
modifier|*
name|c
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|md
parameter_list|,
name|caddr_t
modifier|*
name|dpos
parameter_list|)
block|{
name|uint32_t
name|t1
decl_stmt|,
name|op
decl_stmt|,
name|status
decl_stmt|;
name|t1
operator|=
name|nfsm_dissectf_xx
argument_list|(
name|md
argument_list|,
name|dpos
argument_list|,
literal|"uu"
argument_list|,
operator|&
name|op
argument_list|,
operator|&
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|t1
operator|!=
literal|0
condition|)
return|return
operator|(
name|t1
operator|)
return|;
if|if
condition|(
name|op
operator|!=
name|NFSV4OP_COMMIT
operator|||
name|status
operator|!=
literal|0
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
return|return
operator|(
name|nfsm_dissectf_xx
argument_list|(
name|md
argument_list|,
name|dpos
argument_list|,
literal|"o"
argument_list|,
name|NFSX_V4VERF
argument_list|,
name|c
operator|->
name|verf
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4dissect_create_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|nfs4_oparg_create
modifier|*
name|c
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|md
parameter_list|,
name|caddr_t
modifier|*
name|dpos
parameter_list|)
block|{
name|uint32_t
name|t1
decl_stmt|,
modifier|*
name|tl
decl_stmt|,
name|op
decl_stmt|,
name|status
decl_stmt|,
name|bmlen
decl_stmt|;
name|nfsv4changeinfo
name|ci
decl_stmt|;
name|t1
operator|=
name|nfsm_dissectf_xx
argument_list|(
name|md
argument_list|,
name|dpos
argument_list|,
literal|"uu"
argument_list|,
operator|&
name|op
argument_list|,
operator|&
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|t1
operator|!=
literal|0
condition|)
return|return
operator|(
name|t1
operator|)
return|;
if|if
condition|(
name|op
operator|!=
name|NFSV4OP_CREATE
operator|||
name|status
operator|!=
literal|0
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
comment|/* Just throw this away for now */
name|t1
operator|=
name|nfsm_v4dissect_changeinfo_xx
argument_list|(
operator|&
name|ci
argument_list|,
name|md
argument_list|,
name|dpos
argument_list|)
expr_stmt|;
if|if
condition|(
name|t1
operator|!=
literal|0
condition|)
return|return
operator|(
name|t1
operator|)
return|;
comment|/* Throw this away too */
name|NFSM_DISSECT
argument_list|(
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|bmlen
operator|=
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|NFSM_DISSECT
argument_list|(
name|bmlen
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|tl
operator|+=
name|bmlen
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4dissect_readlink_xx
parameter_list|(
name|struct
name|nfs4_compound
modifier|*
name|cp
parameter_list|,
name|struct
name|uio
modifier|*
name|uiop
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|md
parameter_list|,
name|caddr_t
modifier|*
name|dpos
parameter_list|)
block|{
name|uint32_t
name|t1
decl_stmt|,
modifier|*
name|tl
decl_stmt|,
name|op
decl_stmt|,
name|status
decl_stmt|,
name|linklen
decl_stmt|;
name|t1
operator|=
name|nfsm_dissectf_xx
argument_list|(
name|md
argument_list|,
name|dpos
argument_list|,
literal|"uu"
argument_list|,
operator|&
name|op
argument_list|,
operator|&
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|t1
operator|!=
literal|0
condition|)
return|return
operator|(
name|t1
operator|)
return|;
if|if
condition|(
name|op
operator|!=
name|NFSV4OP_READLINK
operator|||
name|status
operator|!=
literal|0
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
comment|/* Do this one manually for careful checking of sizes. */
name|NFSM_DISSECT
argument_list|(
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|linklen
operator|=
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
if|if
condition|(
name|linklen
operator|<=
literal|0
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
return|return
operator|(
name|nfsm_mbuftouio
argument_list|(
name|md
argument_list|,
name|uiop
argument_list|,
name|MIN
argument_list|(
name|linklen
argument_list|,
name|uiop
operator|->
name|uio_resid
argument_list|)
argument_list|,
name|dpos
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4dissect_changeinfo_xx
parameter_list|(
name|nfsv4changeinfo
modifier|*
name|ci
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|md
parameter_list|,
name|caddr_t
modifier|*
name|dpos
parameter_list|)
block|{
name|uint32_t
modifier|*
name|tl
decl_stmt|;
name|NFSM_DISSECT
argument_list|(
literal|5
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|ci
operator|->
name|ciatomic
operator|=
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|ci
operator|->
name|cibefore
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
name|ci
operator|->
name|ciafter
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|nfsm_v4dissect_attrs_xx
parameter_list|(
name|struct
name|nfsv4_fattr
modifier|*
name|fa
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|md
parameter_list|,
name|caddr_t
modifier|*
name|dpos
parameter_list|)
block|{
name|uint32_t
name|t1
decl_stmt|,
modifier|*
name|tl
decl_stmt|,
name|bmlen
decl_stmt|,
name|bmval
index|[
literal|2
index|]
decl_stmt|,
name|attrlen
decl_stmt|,
name|len
init|=
literal|0
decl_stmt|;
comment|/* Bitmap length + value */
name|NFSM_DISSECT
argument_list|(
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|bmlen
operator|=
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
if|if
condition|(
name|bmlen
operator|>
literal|2
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
if|if
condition|(
name|bmlen
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|NFSM_DISSECT
argument_list|(
name|nfsm_rndup
argument_list|(
name|bmlen
operator|<<
literal|2
argument_list|)
operator|+
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|bmval
index|[
literal|0
index|]
operator|=
name|bmlen
operator|>
literal|0
condition|?
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
else|:
literal|0
expr_stmt|;
name|bmval
index|[
literal|1
index|]
operator|=
name|bmlen
operator|>
literal|1
condition|?
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
else|:
literal|0
expr_stmt|;
comment|/* Attribute length */
name|attrlen
operator|=
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
comment|/* 	 * XXX check for correct (<=) attributes mask return from 	 * server.  need to pass this in. 	 */
if|if
condition|(
name|FA4_ISSET
argument_list|(
name|FA4_TYPE
argument_list|,
name|bmval
argument_list|)
condition|)
block|{
comment|/* overflow check */
name|NFSM_DISSECT
argument_list|(
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_type
operator|=
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_valid
operator||=
name|FA4V_TYPE
expr_stmt|;
name|len
operator|+=
name|NFSX_UNSIGNED
expr_stmt|;
block|}
if|if
condition|(
name|FA4_ISSET
argument_list|(
name|FA4_CHANGE
argument_list|,
name|bmval
argument_list|)
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_changeid
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_valid
operator||=
name|FA4V_CHANGEID
expr_stmt|;
name|len
operator|+=
literal|2
operator|*
name|NFSX_UNSIGNED
expr_stmt|;
block|}
if|if
condition|(
name|FA4_ISSET
argument_list|(
name|FA4_SIZE
argument_list|,
name|bmval
argument_list|)
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_size
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_valid
operator||=
name|FA4V_SIZE
expr_stmt|;
name|len
operator|+=
literal|2
operator|*
name|NFSX_UNSIGNED
expr_stmt|;
block|}
if|if
condition|(
name|FA4_ISSET
argument_list|(
name|FA4_FSID
argument_list|,
name|bmval
argument_list|)
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
literal|4
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_fsid_major
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|tl
operator|+=
literal|2
expr_stmt|;
name|fa
operator|->
name|fa4_fsid_minor
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_valid
operator||=
name|FA4V_SIZE
expr_stmt|;
name|len
operator|+=
literal|4
operator|*
name|NFSX_UNSIGNED
expr_stmt|;
block|}
if|if
condition|(
name|FA4_ISSET
argument_list|(
name|FA4_LEASE_TIME
argument_list|,
name|bmval
argument_list|)
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_lease_time
operator|=
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_valid
operator||=
name|FA4V_LEASE_TIME
expr_stmt|;
name|len
operator|+=
name|NFSX_UNSIGNED
expr_stmt|;
block|}
if|if
condition|(
name|FA4_ISSET
argument_list|(
name|FA4_FILEID
argument_list|,
name|bmval
argument_list|)
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_fileid
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_valid
operator||=
name|FA4V_FILEID
expr_stmt|;
name|len
operator|+=
literal|2
operator|*
name|NFSX_UNSIGNED
expr_stmt|;
block|}
if|if
condition|(
name|FA4_ISSET
argument_list|(
name|FA4_FILES_FREE
argument_list|,
name|bmval
argument_list|)
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_ffree
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_valid
operator||=
name|FA4V_FFREE
expr_stmt|;
name|len
operator|+=
literal|2
operator|*
name|NFSX_UNSIGNED
expr_stmt|;
block|}
if|if
condition|(
name|FA4_ISSET
argument_list|(
name|FA4_FILES_TOTAL
argument_list|,
name|bmval
argument_list|)
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_ftotal
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_valid
operator||=
name|FA4V_FTOTAL
expr_stmt|;
name|len
operator|+=
literal|2
operator|*
name|NFSX_UNSIGNED
expr_stmt|;
block|}
if|if
condition|(
name|FA4_ISSET
argument_list|(
name|FA4_MAXFILESIZE
argument_list|,
name|bmval
argument_list|)
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_maxfilesize
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_valid
operator||=
name|FA4V_MAXFILESIZE
expr_stmt|;
name|len
operator|+=
literal|2
operator|*
name|NFSX_UNSIGNED
expr_stmt|;
block|}
if|if
condition|(
name|FA4_ISSET
argument_list|(
name|FA4_MAXNAME
argument_list|,
name|bmval
argument_list|)
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_maxname
operator|=
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_valid
operator||=
name|FA4V_MAXNAME
expr_stmt|;
name|len
operator|+=
name|NFSX_UNSIGNED
expr_stmt|;
block|}
if|if
condition|(
name|FA4_ISSET
argument_list|(
name|FA4_MAXREAD
argument_list|,
name|bmval
argument_list|)
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_maxread
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_valid
operator||=
name|FA4V_MAXREAD
expr_stmt|;
name|len
operator|+=
literal|2
operator|*
name|NFSX_UNSIGNED
expr_stmt|;
block|}
if|if
condition|(
name|FA4_ISSET
argument_list|(
name|FA4_MAXWRITE
argument_list|,
name|bmval
argument_list|)
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_maxwrite
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_valid
operator||=
name|FA4V_MAXWRITE
expr_stmt|;
name|len
operator|+=
literal|2
operator|*
name|NFSX_UNSIGNED
expr_stmt|;
block|}
if|if
condition|(
name|FA4_ISSET
argument_list|(
name|FA4_MODE
argument_list|,
name|bmval
argument_list|)
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_mode
operator|=
name|fxdr_unsigned
argument_list|(
name|mode_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_valid
operator||=
name|FA4V_MODE
expr_stmt|;
name|len
operator|+=
name|NFSX_UNSIGNED
expr_stmt|;
block|}
if|if
condition|(
name|FA4_ISSET
argument_list|(
name|FA4_NUMLINKS
argument_list|,
name|bmval
argument_list|)
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_nlink
operator|=
name|fxdr_unsigned
argument_list|(
name|nlink_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_valid
operator||=
name|FA4V_NLINK
expr_stmt|;
name|len
operator|+=
name|NFSX_UNSIGNED
expr_stmt|;
block|}
if|if
condition|(
name|FA4_ISSET
argument_list|(
name|FA4_OWNER
argument_list|,
name|bmval
argument_list|)
condition|)
block|{
name|uint32_t
name|ownerlen
decl_stmt|;
name|int
name|error
decl_stmt|;
name|NFSM_DISSECT
argument_list|(
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|ownerlen
operator|=
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|NFSM_DISSECT
argument_list|(
name|nfsm_rndup
argument_list|(
name|ownerlen
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|idmap_name_to_uid
argument_list|(
operator|(
name|char
operator|*
operator|)
name|tl
argument_list|,
name|ownerlen
argument_list|,
operator|&
name|fa
operator|->
name|fa4_uid
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|fa
operator|->
name|fa4_uid
operator|=
operator|-
literal|2
expr_stmt|;
name|fa
operator|->
name|fa4_valid
operator||=
name|FA4V_UID
expr_stmt|;
name|len
operator|+=
name|NFSX_UNSIGNED
operator|+
name|nfsm_rndup
argument_list|(
name|ownerlen
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|FA4_ISSET
argument_list|(
name|FA4_OWNER_GROUP
argument_list|,
name|bmval
argument_list|)
condition|)
block|{
name|uint32_t
name|ownergrouplen
decl_stmt|;
name|int
name|error
decl_stmt|;
name|NFSM_DISSECT
argument_list|(
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|ownergrouplen
operator|=
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|NFSM_DISSECT
argument_list|(
name|nfsm_rndup
argument_list|(
name|ownergrouplen
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|idmap_name_to_gid
argument_list|(
operator|(
name|char
operator|*
operator|)
name|tl
argument_list|,
name|ownergrouplen
argument_list|,
operator|&
name|fa
operator|->
name|fa4_gid
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|fa
operator|->
name|fa4_gid
operator|=
operator|-
literal|2
expr_stmt|;
name|fa
operator|->
name|fa4_valid
operator||=
name|FA4V_GID
expr_stmt|;
name|len
operator|+=
name|NFSX_UNSIGNED
operator|+
name|nfsm_rndup
argument_list|(
name|ownergrouplen
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|FA4_ISSET
argument_list|(
name|FA4_RAWDEV
argument_list|,
name|bmval
argument_list|)
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_rdev_major
operator|=
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_rdev_minor
operator|=
name|fxdr_unsigned
argument_list|(
name|uint32_t
argument_list|,
operator|*
name|tl
operator|++
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_valid
operator||=
name|FA4V_RDEV
expr_stmt|;
name|len
operator|+=
literal|2
operator|*
name|NFSX_UNSIGNED
expr_stmt|;
block|}
if|if
condition|(
name|FA4_ISSET
argument_list|(
name|FA4_SPACE_AVAIL
argument_list|,
name|bmval
argument_list|)
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_savail
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_valid
operator||=
name|FA4V_SAVAIL
expr_stmt|;
name|len
operator|+=
literal|2
operator|*
name|NFSX_UNSIGNED
expr_stmt|;
block|}
if|if
condition|(
name|FA4_ISSET
argument_list|(
name|FA4_SPACE_FREE
argument_list|,
name|bmval
argument_list|)
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_sfree
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_valid
operator||=
name|FA4V_SFREE
expr_stmt|;
name|len
operator|+=
literal|2
operator|*
name|NFSX_UNSIGNED
expr_stmt|;
block|}
if|if
condition|(
name|FA4_ISSET
argument_list|(
name|FA4_SPACE_TOTAL
argument_list|,
name|bmval
argument_list|)
condition|)
block|{
name|NFSM_DISSECT
argument_list|(
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_stotal
operator|=
name|fxdr_hyper
argument_list|(
name|tl
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_valid
operator||=
name|FA4V_STOTAL
expr_stmt|;
name|len
operator|+=
literal|2
operator|*
name|NFSX_UNSIGNED
expr_stmt|;
block|}
if|if
condition|(
name|FA4_ISSET
argument_list|(
name|FA4_SPACE_USED
argument_list|,
name|bmval
argument_list|)
condition|)
block|{
name|NFSM_ADV
argument_list|(
literal|2
operator|*
name|NFSX_UNSIGNED
argument_list|)
expr_stmt|;
name|len
operator|+=
literal|2
operator|*
name|NFSX_UNSIGNED
expr_stmt|;
block|}
if|if
condition|(
name|FA4_ISSET
argument_list|(
name|FA4_TIME_ACCESS
argument_list|,
name|bmval
argument_list|)
condition|)
block|{
name|NFSM_MTOTIME
argument_list|(
name|fa
operator|->
name|fa4_atime
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_valid
operator||=
name|FA4V_ATIME
expr_stmt|;
name|len
operator|+=
literal|3
operator|*
name|NFSX_UNSIGNED
expr_stmt|;
block|}
if|if
condition|(
name|FA4_ISSET
argument_list|(
name|FA4_TIME_CREATE
argument_list|,
name|bmval
argument_list|)
condition|)
block|{
name|NFSM_MTOTIME
argument_list|(
name|fa
operator|->
name|fa4_ctime
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_valid
operator||=
name|FA4V_CTIME
expr_stmt|;
name|len
operator|+=
literal|3
operator|*
name|NFSX_UNSIGNED
expr_stmt|;
block|}
if|if
condition|(
name|FA4_ISSET
argument_list|(
name|FA4_TIME_MODIFY
argument_list|,
name|bmval
argument_list|)
condition|)
block|{
name|NFSM_MTOTIME
argument_list|(
name|fa
operator|->
name|fa4_mtime
argument_list|)
expr_stmt|;
name|fa
operator|->
name|fa4_valid
operator||=
name|FA4V_MTIME
expr_stmt|;
name|len
operator|+=
literal|3
operator|*
name|NFSX_UNSIGNED
expr_stmt|;
block|}
if|if
condition|(
name|len
operator|!=
name|attrlen
condition|)
return|return
operator|(
name|EBADRPC
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


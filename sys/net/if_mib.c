begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 1996 Massachusetts Institute of Technology  *  * Permission to use, copy, modify, and distribute this software and  * its documentation for any purpose and without fee is hereby  * granted, provided that both the above copyright notice and this  * permission notice appear in all copies, that both the above  * copyright notice and this permission notice appear in all  * supporting documentation, and that the name of M.I.T. not be used  * in advertising or publicity pertaining to distribution of the  * software without specific, written prior permission.  M.I.T. makes  * no representations about the suitability of this software for any  * purpose.  It is provided "as is" without express or implied  * warranty.  *   * THIS SOFTWARE IS PROVIDED BY M.I.T. ``AS IS''.  M.I.T. DISCLAIMS  * ALL EXPRESS OR IMPLIED WARRANTIES WITH REGARD TO THIS SOFTWARE,  * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT  * SHALL M.I.T. BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF  * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,  * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT  * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_mib.h>
end_include

begin_comment
comment|/*  * A sysctl(3) MIB for generic interface information.  This information  * is exported in the net.link.generic branch, which has the following  * structure:  *  * net.link.generic	.system			- system-wide control variables  *						  and statistics (node)  *			.ifdata.<ifindex>.general  *						- what's in `struct ifdata'  *						  plus some other info  *			.ifdata.<ifindex>.linkspecific  *						- a link-type-specific data  *						  structure (as might be used  *						  by an SNMP agent  *  * Perhaps someday we will make addresses accessible via this interface  * as well (then there will be four such...).  The reason that the  * index comes before the last element in the name is because it  * seems more orthogonal that way, particularly with the possibility  * of other per-interface data living down here as well (e.g., integrated  * services stuff).  */
end_comment

begin_expr_stmt
name|SYSCTL_DECL
argument_list|(
name|_net_link_generic
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_NODE
argument_list|(
name|_net_link_generic
argument_list|,
name|IFMIB_SYSTEM
argument_list|,
name|system
argument_list|,
name|CTLFLAG_RW
argument_list|,
literal|0
argument_list|,
literal|"Variables global to all interfaces"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_INT
argument_list|(
name|_net_link_generic_system
argument_list|,
name|IFMIB_IFCOUNT
argument_list|,
name|ifcount
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|if_index
argument_list|,
literal|0
argument_list|,
literal|"Number of configured interfaces"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|int
name|sysctl_ifdata
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
comment|/* XXX bad syntax! */
block|{
name|int
modifier|*
name|name
init|=
operator|(
name|int
operator|*
operator|)
name|arg1
decl_stmt|;
name|int
name|error
decl_stmt|,
name|ifnlen
decl_stmt|;
name|u_int
name|namelen
init|=
name|arg2
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|char
name|workbuf
index|[
literal|64
index|]
decl_stmt|;
name|struct
name|ifmibdata
name|ifmd
decl_stmt|;
if|if
condition|(
name|namelen
operator|!=
literal|2
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
name|name
index|[
literal|0
index|]
operator|<=
literal|0
operator|||
name|name
index|[
literal|0
index|]
operator|>
name|if_index
condition|)
return|return
name|ENOENT
return|;
name|ifp
operator|=
name|ifnet_addrs
index|[
name|name
index|[
literal|0
index|]
operator|-
literal|1
index|]
operator|->
name|ifa_ifp
expr_stmt|;
switch|switch
condition|(
name|name
index|[
literal|1
index|]
condition|)
block|{
default|default:
return|return
name|ENOENT
return|;
case|case
name|IFDATA_GENERAL
case|:
name|ifnlen
operator|=
name|snprintf
argument_list|(
name|workbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|workbuf
argument_list|)
argument_list|,
literal|"%s%d"
argument_list|,
name|ifp
operator|->
name|if_name
argument_list|,
name|ifp
operator|->
name|if_unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifnlen
operator|+
literal|1
operator|>
sizeof|sizeof
name|ifmd
operator|.
name|ifmd_name
condition|)
block|{
return|return
name|ENAMETOOLONG
return|;
block|}
else|else
block|{
name|strcpy
argument_list|(
name|ifmd
operator|.
name|ifmd_name
argument_list|,
name|workbuf
argument_list|)
expr_stmt|;
block|}
define|#
directive|define
name|COPY
parameter_list|(
name|fld
parameter_list|)
value|ifmd.ifmd_##fld = ifp->if_##fld
name|COPY
argument_list|(
name|pcount
argument_list|)
expr_stmt|;
name|COPY
argument_list|(
name|flags
argument_list|)
expr_stmt|;
name|COPY
argument_list|(
name|data
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|COPY
name|ifmd
operator|.
name|ifmd_snd_len
operator|=
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_len
expr_stmt|;
name|ifmd
operator|.
name|ifmd_snd_maxlen
operator|=
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_maxlen
expr_stmt|;
name|ifmd
operator|.
name|ifmd_snd_drops
operator|=
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_drops
expr_stmt|;
name|error
operator|=
name|SYSCTL_OUT
argument_list|(
name|req
argument_list|,
operator|&
name|ifmd
argument_list|,
sizeof|sizeof
name|ifmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
return|return
name|error
return|;
name|error
operator|=
name|SYSCTL_IN
argument_list|(
name|req
argument_list|,
operator|&
name|ifmd
argument_list|,
sizeof|sizeof
name|ifmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
define|#
directive|define
name|DONTCOPY
parameter_list|(
name|fld
parameter_list|)
value|ifmd.ifmd_data.ifi_##fld = ifp->if_data.ifi_##fld
name|DONTCOPY
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|DONTCOPY
argument_list|(
name|physical
argument_list|)
expr_stmt|;
name|DONTCOPY
argument_list|(
name|addrlen
argument_list|)
expr_stmt|;
name|DONTCOPY
argument_list|(
name|hdrlen
argument_list|)
expr_stmt|;
name|DONTCOPY
argument_list|(
name|mtu
argument_list|)
expr_stmt|;
name|DONTCOPY
argument_list|(
name|metric
argument_list|)
expr_stmt|;
name|DONTCOPY
argument_list|(
name|baudrate
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|DONTCOPY
define|#
directive|define
name|COPY
parameter_list|(
name|fld
parameter_list|)
value|ifp->if_##fld = ifmd.ifmd_##fld
name|COPY
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_maxlen
operator|=
name|ifmd
operator|.
name|ifmd_snd_maxlen
expr_stmt|;
name|ifp
operator|->
name|if_snd
operator|.
name|ifq_drops
operator|=
name|ifmd
operator|.
name|ifmd_snd_drops
expr_stmt|;
undef|#
directive|undef
name|COPY
break|break;
case|case
name|IFDATA_LINKSPECIFIC
case|:
name|error
operator|=
name|SYSCTL_OUT
argument_list|(
name|req
argument_list|,
name|ifp
operator|->
name|if_linkmib
argument_list|,
name|ifp
operator|->
name|if_linkmiblen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
operator|!
name|req
operator|->
name|newptr
condition|)
return|return
name|error
return|;
name|error
operator|=
name|SYSCTL_IN
argument_list|(
name|req
argument_list|,
name|ifp
operator|->
name|if_linkmib
argument_list|,
name|ifp
operator|->
name|if_linkmiblen
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
name|error
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_expr_stmt
name|SYSCTL_NODE
argument_list|(
name|_net_link_generic
argument_list|,
name|IFMIB_IFDATA
argument_list|,
name|ifdata
argument_list|,
name|CTLFLAG_RW
argument_list|,
name|sysctl_ifdata
argument_list|,
literal|"Interface table"
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 2014, Bryan Venteicher<bryanv@FreeBSD.org>  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice unmodified, this list of conditions, and the following  *    disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"opt_inet.h"
end_include

begin_include
include|#
directive|include
file|"opt_inet6.h"
end_include

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/eventhandler.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/hash.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/refcount.h>
end_include

begin_include
include|#
directive|include
file|<sys/rmlock.h>
end_include

begin_include
include|#
directive|include
file|<sys/priv.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/sbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/socketvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<net/if_clone.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/if_vxlan.h>
end_include

begin_include
include|#
directive|include
file|<net/netisr.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_pcb.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip6.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet6/ip6_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/udp.h>
end_include

begin_include
include|#
directive|include
file|<netinet/udp_var.h>
end_include

begin_struct_decl
struct_decl|struct
name|vxlan_softc
struct_decl|;
end_struct_decl

begin_expr_stmt
name|LIST_HEAD
argument_list|(
name|vxlan_softc_head
argument_list|,
name|vxlan_softc
argument_list|)
expr_stmt|;
end_expr_stmt

begin_struct
struct|struct
name|vxlan_socket_mc_info
block|{
name|union
name|vxlan_sockaddr
name|vxlsomc_saddr
decl_stmt|;
name|union
name|vxlan_sockaddr
name|vxlsomc_gaddr
decl_stmt|;
name|int
name|vxlsomc_ifidx
decl_stmt|;
name|int
name|vxlsomc_users
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|VXLAN_SO_MC_MAX_GROUPS
value|32
end_define

begin_define
define|#
directive|define
name|VXLAN_SO_VNI_HASH_SHIFT
value|6
end_define

begin_define
define|#
directive|define
name|VXLAN_SO_VNI_HASH_SIZE
value|(1<< VXLAN_SO_VNI_HASH_SHIFT)
end_define

begin_define
define|#
directive|define
name|VXLAN_SO_VNI_HASH
parameter_list|(
name|_vni
parameter_list|)
value|((_vni) % VXLAN_SO_VNI_HASH_SIZE)
end_define

begin_struct
struct|struct
name|vxlan_socket
block|{
name|struct
name|socket
modifier|*
name|vxlso_sock
decl_stmt|;
name|struct
name|rmlock
name|vxlso_lock
decl_stmt|;
name|u_int
name|vxlso_refcnt
decl_stmt|;
name|union
name|vxlan_sockaddr
name|vxlso_laddr
decl_stmt|;
name|LIST_ENTRY
argument_list|(
argument|vxlan_socket
argument_list|)
name|vxlso_entry
expr_stmt|;
name|struct
name|vxlan_softc_head
name|vxlso_vni_hash
index|[
name|VXLAN_SO_VNI_HASH_SIZE
index|]
decl_stmt|;
name|struct
name|vxlan_socket_mc_info
name|vxlso_mc
index|[
name|VXLAN_SO_MC_MAX_GROUPS
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|VXLAN_SO_RLOCK
parameter_list|(
name|_vso
parameter_list|,
name|_p
parameter_list|)
value|rm_rlock(&(_vso)->vxlso_lock, (_p))
end_define

begin_define
define|#
directive|define
name|VXLAN_SO_RUNLOCK
parameter_list|(
name|_vso
parameter_list|,
name|_p
parameter_list|)
value|rm_runlock(&(_vso)->vxlso_lock, (_p))
end_define

begin_define
define|#
directive|define
name|VXLAN_SO_WLOCK
parameter_list|(
name|_vso
parameter_list|)
value|rm_wlock(&(_vso)->vxlso_lock)
end_define

begin_define
define|#
directive|define
name|VXLAN_SO_WUNLOCK
parameter_list|(
name|_vso
parameter_list|)
value|rm_wunlock(&(_vso)->vxlso_lock)
end_define

begin_define
define|#
directive|define
name|VXLAN_SO_LOCK_ASSERT
parameter_list|(
name|_vso
parameter_list|)
define|\
value|rm_assert(&(_vso)->vxlso_lock, RA_LOCKED)
end_define

begin_define
define|#
directive|define
name|VXLAN_SO_LOCK_WASSERT
parameter_list|(
name|_vso
parameter_list|)
define|\
value|rm_assert(&(_vso)->vxlso_lock, RA_WLOCKED)
end_define

begin_define
define|#
directive|define
name|VXLAN_SO_ACQUIRE
parameter_list|(
name|_vso
parameter_list|)
value|refcount_acquire(&(_vso)->vxlso_refcnt)
end_define

begin_define
define|#
directive|define
name|VXLAN_SO_RELEASE
parameter_list|(
name|_vso
parameter_list|)
value|refcount_release(&(_vso)->vxlso_refcnt)
end_define

begin_struct
struct|struct
name|vxlan_ftable_entry
block|{
name|LIST_ENTRY
argument_list|(
argument|vxlan_ftable_entry
argument_list|)
name|vxlfe_hash
expr_stmt|;
name|uint16_t
name|vxlfe_flags
decl_stmt|;
name|uint8_t
name|vxlfe_mac
index|[
name|ETHER_ADDR_LEN
index|]
decl_stmt|;
name|union
name|vxlan_sockaddr
name|vxlfe_raddr
decl_stmt|;
name|time_t
name|vxlfe_expire
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|VXLAN_FE_FLAG_DYNAMIC
value|0x01
end_define

begin_define
define|#
directive|define
name|VXLAN_FE_FLAG_STATIC
value|0x02
end_define

begin_define
define|#
directive|define
name|VXLAN_FE_IS_DYNAMIC
parameter_list|(
name|_fe
parameter_list|)
define|\
value|((_fe)->vxlfe_flags& VXLAN_FE_FLAG_DYNAMIC)
end_define

begin_define
define|#
directive|define
name|VXLAN_SC_FTABLE_SHIFT
value|9
end_define

begin_define
define|#
directive|define
name|VXLAN_SC_FTABLE_SIZE
value|(1<< VXLAN_SC_FTABLE_SHIFT)
end_define

begin_define
define|#
directive|define
name|VXLAN_SC_FTABLE_MASK
value|(VXLAN_SC_FTABLE_SIZE - 1)
end_define

begin_define
define|#
directive|define
name|VXLAN_SC_FTABLE_HASH
parameter_list|(
name|_sc
parameter_list|,
name|_mac
parameter_list|)
define|\
value|(vxlan_mac_hash(_sc, _mac) % VXLAN_SC_FTABLE_SIZE)
end_define

begin_expr_stmt
name|LIST_HEAD
argument_list|(
name|vxlan_ftable_head
argument_list|,
name|vxlan_ftable_entry
argument_list|)
expr_stmt|;
end_expr_stmt

begin_struct
struct|struct
name|vxlan_statistics
block|{
name|uint32_t
name|ftable_nospace
decl_stmt|;
name|uint32_t
name|ftable_lock_upgrade_failed
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|vxlan_softc
block|{
name|struct
name|ifnet
modifier|*
name|vxl_ifp
decl_stmt|;
name|struct
name|vxlan_socket
modifier|*
name|vxl_sock
decl_stmt|;
name|uint32_t
name|vxl_vni
decl_stmt|;
name|union
name|vxlan_sockaddr
name|vxl_src_addr
decl_stmt|;
name|union
name|vxlan_sockaddr
name|vxl_dst_addr
decl_stmt|;
name|uint32_t
name|vxl_flags
decl_stmt|;
define|#
directive|define
name|VXLAN_FLAG_INIT
value|0x0001
define|#
directive|define
name|VXLAN_FLAG_TEARDOWN
value|0x0002
define|#
directive|define
name|VXLAN_FLAG_LEARN
value|0x0004
name|uint32_t
name|vxl_port_hash_key
decl_stmt|;
name|uint16_t
name|vxl_min_port
decl_stmt|;
name|uint16_t
name|vxl_max_port
decl_stmt|;
name|uint8_t
name|vxl_ttl
decl_stmt|;
comment|/* Lookup table from MAC address to forwarding entry. */
name|uint32_t
name|vxl_ftable_cnt
decl_stmt|;
name|uint32_t
name|vxl_ftable_max
decl_stmt|;
name|uint32_t
name|vxl_ftable_timeout
decl_stmt|;
name|uint32_t
name|vxl_ftable_hash_key
decl_stmt|;
name|struct
name|vxlan_ftable_head
modifier|*
name|vxl_ftable
decl_stmt|;
comment|/* Derived from vxl_dst_addr. */
name|struct
name|vxlan_ftable_entry
name|vxl_default_fe
decl_stmt|;
name|struct
name|ip_moptions
modifier|*
name|vxl_im4o
decl_stmt|;
name|struct
name|ip6_moptions
modifier|*
name|vxl_im6o
decl_stmt|;
name|struct
name|rmlock
name|vxl_lock
decl_stmt|;
specifier|volatile
name|u_int
name|vxl_refcnt
decl_stmt|;
name|int
name|vxl_unit
decl_stmt|;
name|int
name|vxl_vso_mc_index
decl_stmt|;
name|struct
name|vxlan_statistics
name|vxl_stats
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|vxl_sysctl_node
decl_stmt|;
name|struct
name|sysctl_ctx_list
name|vxl_sysctl_ctx
decl_stmt|;
name|struct
name|callout
name|vxl_callout
decl_stmt|;
name|uint8_t
name|vxl_hwaddr
index|[
name|ETHER_ADDR_LEN
index|]
decl_stmt|;
name|int
name|vxl_mc_ifindex
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|vxl_mc_ifp
decl_stmt|;
name|char
name|vxl_mc_ifname
index|[
name|IFNAMSIZ
index|]
decl_stmt|;
name|LIST_ENTRY
argument_list|(
argument|vxlan_softc
argument_list|)
name|vxl_entry
expr_stmt|;
name|LIST_ENTRY
argument_list|(
argument|vxlan_softc
argument_list|)
name|vxl_ifdetach_list
expr_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|VXLAN_RLOCK
parameter_list|(
name|_sc
parameter_list|,
name|_p
parameter_list|)
value|rm_rlock(&(_sc)->vxl_lock, (_p))
end_define

begin_define
define|#
directive|define
name|VXLAN_RUNLOCK
parameter_list|(
name|_sc
parameter_list|,
name|_p
parameter_list|)
value|rm_runlock(&(_sc)->vxl_lock, (_p))
end_define

begin_define
define|#
directive|define
name|VXLAN_WLOCK
parameter_list|(
name|_sc
parameter_list|)
value|rm_wlock(&(_sc)->vxl_lock)
end_define

begin_define
define|#
directive|define
name|VXLAN_WUNLOCK
parameter_list|(
name|_sc
parameter_list|)
value|rm_wunlock(&(_sc)->vxl_lock)
end_define

begin_define
define|#
directive|define
name|VXLAN_LOCK_WOWNED
parameter_list|(
name|_sc
parameter_list|)
value|rm_wowned(&(_sc)->vxl_lock)
end_define

begin_define
define|#
directive|define
name|VXLAN_LOCK_ASSERT
parameter_list|(
name|_sc
parameter_list|)
value|rm_assert(&(_sc)->vxl_lock, RA_LOCKED)
end_define

begin_define
define|#
directive|define
name|VXLAN_LOCK_WASSERT
parameter_list|(
name|_sc
parameter_list|)
value|rm_assert(&(_sc)->vxl_lock, RA_WLOCKED)
end_define

begin_define
define|#
directive|define
name|VXLAN_UNLOCK
parameter_list|(
name|_sc
parameter_list|,
name|_p
parameter_list|)
value|do {		\     if (VXLAN_LOCK_WOWNED(_sc))			\ 	VXLAN_WUNLOCK(_sc);			\     else					\ 	VXLAN_RUNLOCK(_sc, _p);			\ } while (0)
end_define

begin_define
define|#
directive|define
name|VXLAN_ACQUIRE
parameter_list|(
name|_sc
parameter_list|)
value|refcount_acquire(&(_sc)->vxl_refcnt)
end_define

begin_define
define|#
directive|define
name|VXLAN_RELEASE
parameter_list|(
name|_sc
parameter_list|)
value|refcount_release(&(_sc)->vxl_refcnt)
end_define

begin_define
define|#
directive|define
name|satoconstsin
parameter_list|(
name|sa
parameter_list|)
value|((const struct sockaddr_in *)(sa))
end_define

begin_define
define|#
directive|define
name|satoconstsin6
parameter_list|(
name|sa
parameter_list|)
value|((const struct sockaddr_in6 *)(sa))
end_define

begin_struct
struct|struct
name|vxlanudphdr
block|{
name|struct
name|udphdr
name|vxlh_udp
decl_stmt|;
name|struct
name|vxlan_header
name|vxlh_hdr
decl_stmt|;
block|}
name|__packed
struct|;
end_struct

begin_function_decl
specifier|static
name|int
name|vxlan_ftable_addr_cmp
parameter_list|(
specifier|const
name|uint8_t
modifier|*
parameter_list|,
specifier|const
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_ftable_init
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_ftable_fini
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_ftable_flush
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_ftable_expire
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_ftable_update_locked
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
parameter_list|,
specifier|const
name|uint8_t
modifier|*
parameter_list|,
name|struct
name|rm_priotracker
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_ftable_update
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
parameter_list|,
specifier|const
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_ftable_sysctl_dump
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|vxlan_ftable_entry
modifier|*
name|vxlan_ftable_entry_alloc
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_ftable_entry_free
parameter_list|(
name|struct
name|vxlan_ftable_entry
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_ftable_entry_init
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
name|struct
name|vxlan_ftable_entry
modifier|*
parameter_list|,
specifier|const
name|uint8_t
modifier|*
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_ftable_entry_destroy
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
name|struct
name|vxlan_ftable_entry
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_ftable_entry_insert
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
name|struct
name|vxlan_ftable_entry
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|vxlan_ftable_entry
modifier|*
name|vxlan_ftable_entry_lookup
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
specifier|const
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_ftable_entry_dump
parameter_list|(
name|struct
name|vxlan_ftable_entry
modifier|*
parameter_list|,
name|struct
name|sbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|vxlan_socket
modifier|*
name|vxlan_socket_alloc
parameter_list|(
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_socket_destroy
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_socket_release
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|vxlan_socket
modifier|*
name|vxlan_socket_lookup
parameter_list|(
name|union
name|vxlan_sockaddr
modifier|*
name|vxlsa
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_socket_insert
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_socket_init
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
parameter_list|,
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_socket_bind
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
parameter_list|,
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_socket_create
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|int
parameter_list|,
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
parameter_list|,
name|struct
name|vxlan_socket
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_socket_ifdetach
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
parameter_list|,
name|struct
name|ifnet
modifier|*
parameter_list|,
name|struct
name|vxlan_softc_head
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|vxlan_socket
modifier|*
name|vxlan_socket_mc_lookup
parameter_list|(
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_sockaddr_mc_info_match
parameter_list|(
specifier|const
name|struct
name|vxlan_socket_mc_info
modifier|*
parameter_list|,
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
parameter_list|,
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_socket_mc_join_group
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
parameter_list|,
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
parameter_list|,
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|,
name|union
name|vxlan_sockaddr
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_socket_mc_leave_group
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
parameter_list|,
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
parameter_list|,
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_socket_mc_add_group
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
parameter_list|,
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
parameter_list|,
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_socket_mc_release_group_by_idx
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|vxlan_softc
modifier|*
name|vxlan_socket_lookup_softc_locked
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|vxlan_softc
modifier|*
name|vxlan_socket_lookup_softc
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_socket_insert_softc
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
parameter_list|,
name|struct
name|vxlan_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_socket_remove_softc
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
parameter_list|,
name|struct
name|vxlan_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|ifnet
modifier|*
name|vxlan_multicast_if_ref
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_free_multicast
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_setup_multicast_interface
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_setup_multicast
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_setup_socket
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_setup_interface
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_valid_init_config
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_init_wait
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_init_complete
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_init
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_release
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_teardown_wait
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_teardown_complete
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_teardown_locked
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_teardown
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_ifdetach
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
name|struct
name|ifnet
modifier|*
parameter_list|,
name|struct
name|vxlan_softc_head
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_timer
parameter_list|(
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_ctrl_get_config
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_ctrl_set_vni
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_ctrl_set_local_addr
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_ctrl_set_remote_addr
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_ctrl_set_local_port
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_ctrl_set_remote_port
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_ctrl_set_port_range
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_ctrl_set_ftable_timeout
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_ctrl_set_ftable_max
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_ctrl_set_multicast_if
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_ctrl_set_ttl
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_ctrl_set_learn
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_ctrl_ftable_entry_add
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_ctrl_ftable_entry_rem
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_ctrl_flush
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_ioctl_drvspec
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
name|struct
name|ifdrv
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_ioctl_ifflags
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|u_long
parameter_list|,
name|caddr_t
parameter_list|)
function_decl|;
end_function_decl

begin_if
if|#
directive|if
name|defined
argument_list|(
name|INET
argument_list|)
operator|||
name|defined
argument_list|(
name|INET6
argument_list|)
end_if

begin_function_decl
specifier|static
name|uint16_t
name|vxlan_pick_source_port
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_encap_header
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|int
parameter_list|,
name|uint16_t
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|int
name|vxlan_encap4
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_encap6
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_transmit
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_qflush
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_rcv_udp_packet
parameter_list|(
name|struct
name|mbuf
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|inpcb
modifier|*
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_input
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_set_default_config
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_set_user_config
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
name|struct
name|ifvxlanparam
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_clone_create
parameter_list|(
name|struct
name|if_clone
modifier|*
parameter_list|,
name|int
parameter_list|,
name|caddr_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_clone_destroy
parameter_list|(
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|vxlan_mac_hash
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
specifier|const
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_fakeaddr
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_sockaddr_cmp
parameter_list|(
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_sockaddr_copy
parameter_list|(
name|union
name|vxlan_sockaddr
modifier|*
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_sockaddr_in_equal
parameter_list|(
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_sockaddr_in_copy
parameter_list|(
name|union
name|vxlan_sockaddr
modifier|*
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_sockaddr_supported
parameter_list|(
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_sockaddr_in_any
parameter_list|(
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_sockaddr_in_multicast
parameter_list|(
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_can_change_config
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_check_vni
parameter_list|(
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_check_ttl
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_check_ftable_timeout
parameter_list|(
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_check_ftable_max
parameter_list|(
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_sysctl_setup
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_sysctl_destroy
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_tunable_int
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_ifdetach_event
parameter_list|(
name|void
modifier|*
parameter_list|,
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_load
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|vxlan_unload
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|vxlan_modevent
parameter_list|(
name|module_t
parameter_list|,
name|int
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
specifier|const
name|char
name|vxlan_name
index|[]
init|=
literal|"vxlan"
decl_stmt|;
end_decl_stmt

begin_expr_stmt
specifier|static
name|MALLOC_DEFINE
argument_list|(
name|M_VXLAN
argument_list|,
name|vxlan_name
argument_list|,
literal|"Virtual eXtensible LAN Interface"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|if_clone
modifier|*
name|vxlan_cloner
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|mtx
name|vxlan_list_mtx
decl_stmt|;
end_decl_stmt

begin_expr_stmt
specifier|static
name|LIST_HEAD
argument_list|(
argument_list|,
argument|vxlan_socket
argument_list|)
name|vxlan_socket_list
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|eventhandler_tag
name|vxlan_ifdetach_event_tag
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SYSCTL_DECL
argument_list|(
name|_net_link
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|SYSCTL_NODE
argument_list|(
name|_net_link
argument_list|,
name|OID_AUTO
argument_list|,
name|vxlan
argument_list|,
name|CTLFLAG_RW
argument_list|,
literal|0
argument_list|,
literal|"Virtual eXtensible Local Area Network"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|vxlan_legacy_port
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"net.link.vxlan.legacy_port"
argument_list|,
operator|&
name|vxlan_legacy_port
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|int
name|vxlan_reuse_port
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|TUNABLE_INT
argument_list|(
literal|"net.link.vxlan.reuse_port"
argument_list|,
operator|&
name|vxlan_reuse_port
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* Default maximum number of addresses in the forwarding table. */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|VXLAN_FTABLE_MAX
end_ifndef

begin_define
define|#
directive|define
name|VXLAN_FTABLE_MAX
value|2000
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Timeout (in seconds) of addresses learned in the forwarding table. */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|VXLAN_FTABLE_TIMEOUT
end_ifndef

begin_define
define|#
directive|define
name|VXLAN_FTABLE_TIMEOUT
value|(20 * 60)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Maximum timeout (in seconds) of addresses learned in the forwarding  * table.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|VXLAN_FTABLE_MAX_TIMEOUT
end_ifndef

begin_define
define|#
directive|define
name|VXLAN_FTABLE_MAX_TIMEOUT
value|(60 * 60 * 24)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Number of seconds between pruning attempts of the forwarding table. */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|VXLAN_FTABLE_PRUNE
end_ifndef

begin_define
define|#
directive|define
name|VXLAN_FTABLE_PRUNE
value|(5 * 60)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|int
name|vxlan_ftable_prune_period
init|=
name|VXLAN_FTABLE_PRUNE
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|vxlan_control
block|{
name|int
function_decl|(
modifier|*
name|vxlc_func
function_decl|)
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
function_decl|;
name|int
name|vxlc_argsize
decl_stmt|;
name|int
name|vxlc_flags
decl_stmt|;
define|#
directive|define
name|VXLAN_CTRL_FLAG_COPYIN
value|0x01
define|#
directive|define
name|VXLAN_CTRL_FLAG_COPYOUT
value|0x02
define|#
directive|define
name|VXLAN_CTRL_FLAG_SUSER
value|0x04
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|vxlan_control
name|vxlan_control_table
index|[]
init|=
block|{
index|[
name|VXLAN_CMD_GET_CONFIG
index|]
operator|=
block|{
name|vxlan_ctrl_get_config
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|ifvxlancfg
argument_list|)
block|,
name|VXLAN_CTRL_FLAG_COPYOUT
block|}
block|,
index|[
name|VXLAN_CMD_SET_VNI
index|]
operator|=
block|{
name|vxlan_ctrl_set_vni
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|ifvxlancmd
argument_list|)
block|,
name|VXLAN_CTRL_FLAG_COPYIN
operator||
name|VXLAN_CTRL_FLAG_SUSER
block|, 	    }
block|,
index|[
name|VXLAN_CMD_SET_LOCAL_ADDR
index|]
operator|=
block|{
name|vxlan_ctrl_set_local_addr
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|ifvxlancmd
argument_list|)
block|,
name|VXLAN_CTRL_FLAG_COPYIN
operator||
name|VXLAN_CTRL_FLAG_SUSER
block|, 	    }
block|,
index|[
name|VXLAN_CMD_SET_REMOTE_ADDR
index|]
operator|=
block|{
name|vxlan_ctrl_set_remote_addr
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|ifvxlancmd
argument_list|)
block|,
name|VXLAN_CTRL_FLAG_COPYIN
operator||
name|VXLAN_CTRL_FLAG_SUSER
block|, 	    }
block|,
index|[
name|VXLAN_CMD_SET_LOCAL_PORT
index|]
operator|=
block|{
name|vxlan_ctrl_set_local_port
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|ifvxlancmd
argument_list|)
block|,
name|VXLAN_CTRL_FLAG_COPYIN
operator||
name|VXLAN_CTRL_FLAG_SUSER
block|, 	    }
block|,
index|[
name|VXLAN_CMD_SET_REMOTE_PORT
index|]
operator|=
block|{
name|vxlan_ctrl_set_remote_port
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|ifvxlancmd
argument_list|)
block|,
name|VXLAN_CTRL_FLAG_COPYIN
operator||
name|VXLAN_CTRL_FLAG_SUSER
block|, 	    }
block|,
index|[
name|VXLAN_CMD_SET_PORT_RANGE
index|]
operator|=
block|{
name|vxlan_ctrl_set_port_range
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|ifvxlancmd
argument_list|)
block|,
name|VXLAN_CTRL_FLAG_COPYIN
operator||
name|VXLAN_CTRL_FLAG_SUSER
block|, 	    }
block|,
index|[
name|VXLAN_CMD_SET_FTABLE_TIMEOUT
index|]
operator|=
block|{
name|vxlan_ctrl_set_ftable_timeout
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|ifvxlancmd
argument_list|)
block|,
name|VXLAN_CTRL_FLAG_COPYIN
operator||
name|VXLAN_CTRL_FLAG_SUSER
block|, 	    }
block|,
index|[
name|VXLAN_CMD_SET_FTABLE_MAX
index|]
operator|=
block|{
name|vxlan_ctrl_set_ftable_max
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|ifvxlancmd
argument_list|)
block|,
name|VXLAN_CTRL_FLAG_COPYIN
operator||
name|VXLAN_CTRL_FLAG_SUSER
block|, 	    }
block|,
index|[
name|VXLAN_CMD_SET_MULTICAST_IF
index|]
operator|=
block|{
name|vxlan_ctrl_set_multicast_if
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|ifvxlancmd
argument_list|)
block|,
name|VXLAN_CTRL_FLAG_COPYIN
operator||
name|VXLAN_CTRL_FLAG_SUSER
block|, 	    }
block|,
index|[
name|VXLAN_CMD_SET_TTL
index|]
operator|=
block|{
name|vxlan_ctrl_set_ttl
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|ifvxlancmd
argument_list|)
block|,
name|VXLAN_CTRL_FLAG_COPYIN
operator||
name|VXLAN_CTRL_FLAG_SUSER
block|, 	    }
block|,
index|[
name|VXLAN_CMD_SET_LEARN
index|]
operator|=
block|{
name|vxlan_ctrl_set_learn
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|ifvxlancmd
argument_list|)
block|,
name|VXLAN_CTRL_FLAG_COPYIN
operator||
name|VXLAN_CTRL_FLAG_SUSER
block|, 	    }
block|,
index|[
name|VXLAN_CMD_FTABLE_ENTRY_ADD
index|]
operator|=
block|{
name|vxlan_ctrl_ftable_entry_add
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|ifvxlancmd
argument_list|)
block|,
name|VXLAN_CTRL_FLAG_COPYIN
operator||
name|VXLAN_CTRL_FLAG_SUSER
block|, 	    }
block|,
index|[
name|VXLAN_CMD_FTABLE_ENTRY_REM
index|]
operator|=
block|{
name|vxlan_ctrl_ftable_entry_rem
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|ifvxlancmd
argument_list|)
block|,
name|VXLAN_CTRL_FLAG_COPYIN
operator||
name|VXLAN_CTRL_FLAG_SUSER
block|, 	    }
block|,
index|[
name|VXLAN_CMD_FLUSH
index|]
operator|=
block|{
name|vxlan_ctrl_flush
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|ifvxlancmd
argument_list|)
block|,
name|VXLAN_CTRL_FLAG_COPYIN
operator||
name|VXLAN_CTRL_FLAG_SUSER
block|, 	    }
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|int
name|vxlan_control_table_size
init|=
name|nitems
argument_list|(
name|vxlan_control_table
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|vxlan_ftable_addr_cmp
parameter_list|(
specifier|const
name|uint8_t
modifier|*
name|a
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|b
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|d
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|d
operator|=
literal|0
init|;
name|i
operator|<
name|ETHER_ADDR_LEN
operator|&&
name|d
operator|==
literal|0
condition|;
name|i
operator|++
control|)
name|d
operator|=
operator|(
operator|(
name|int
operator|)
name|a
index|[
name|i
index|]
operator|)
operator|-
operator|(
operator|(
name|int
operator|)
name|b
index|[
name|i
index|]
operator|)
expr_stmt|;
return|return
operator|(
name|d
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_ftable_init
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|sc
operator|->
name|vxl_ftable
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|vxlan_ftable_head
argument_list|)
operator|*
name|VXLAN_SC_FTABLE_SIZE
argument_list|,
name|M_VXLAN
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXLAN_SC_FTABLE_SIZE
condition|;
name|i
operator|++
control|)
name|LIST_INIT
argument_list|(
operator|&
name|sc
operator|->
name|vxl_ftable
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vxl_ftable_hash_key
operator|=
name|arc4random
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_ftable_fini
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXLAN_SC_FTABLE_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|KASSERT
argument_list|(
name|LIST_EMPTY
argument_list|(
operator|&
name|sc
operator|->
name|vxl_ftable
index|[
name|i
index|]
argument_list|)
argument_list|,
operator|(
literal|"%s: vxlan %p ftable[%d] not empty"
operator|,
name|__func__
operator|,
name|sc
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
block|}
name|MPASS
argument_list|(
name|sc
operator|->
name|vxl_ftable_cnt
operator|==
literal|0
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sc
operator|->
name|vxl_ftable
argument_list|,
name|M_VXLAN
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vxl_ftable
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_ftable_flush
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
name|int
name|all
parameter_list|)
block|{
name|struct
name|vxlan_ftable_entry
modifier|*
name|fe
decl_stmt|,
modifier|*
name|tfe
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXLAN_SC_FTABLE_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|LIST_FOREACH_SAFE
argument_list|(
argument|fe
argument_list|,
argument|&sc->vxl_ftable[i]
argument_list|,
argument|vxlfe_hash
argument_list|,
argument|tfe
argument_list|)
block|{
if|if
condition|(
name|all
operator|||
name|VXLAN_FE_IS_DYNAMIC
argument_list|(
name|fe
argument_list|)
condition|)
name|vxlan_ftable_entry_destroy
argument_list|(
name|sc
argument_list|,
name|fe
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_ftable_expire
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|vxlan_ftable_entry
modifier|*
name|fe
decl_stmt|,
modifier|*
name|tfe
decl_stmt|;
name|int
name|i
decl_stmt|;
name|VXLAN_LOCK_WASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXLAN_SC_FTABLE_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|LIST_FOREACH_SAFE
argument_list|(
argument|fe
argument_list|,
argument|&sc->vxl_ftable[i]
argument_list|,
argument|vxlfe_hash
argument_list|,
argument|tfe
argument_list|)
block|{
if|if
condition|(
name|VXLAN_FE_IS_DYNAMIC
argument_list|(
name|fe
argument_list|)
operator|&&
name|time_uptime
operator|>=
name|fe
operator|->
name|vxlfe_expire
condition|)
name|vxlan_ftable_entry_destroy
argument_list|(
name|sc
argument_list|,
name|fe
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_ftable_update_locked
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|sa
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|mac
parameter_list|,
name|struct
name|rm_priotracker
modifier|*
name|tracker
parameter_list|)
block|{
name|union
name|vxlan_sockaddr
name|vxlsa
decl_stmt|;
name|struct
name|vxlan_ftable_entry
modifier|*
name|fe
decl_stmt|;
name|int
name|error
decl_stmt|;
name|VXLAN_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|again
label|:
comment|/* 	 * A forwarding entry for this MAC address might already exist. If 	 * so, update it, otherwise create a new one. We may have to upgrade 	 * the lock if we have to change or create an entry. 	 */
name|fe
operator|=
name|vxlan_ftable_entry_lookup
argument_list|(
name|sc
argument_list|,
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|fe
operator|!=
name|NULL
condition|)
block|{
name|fe
operator|->
name|vxlfe_expire
operator|=
name|time_uptime
operator|+
name|sc
operator|->
name|vxl_ftable_timeout
expr_stmt|;
if|if
condition|(
operator|!
name|VXLAN_FE_IS_DYNAMIC
argument_list|(
name|fe
argument_list|)
operator|||
name|vxlan_sockaddr_in_equal
argument_list|(
operator|&
name|fe
operator|->
name|vxlfe_raddr
argument_list|,
name|sa
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
name|VXLAN_LOCK_WOWNED
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|VXLAN_RUNLOCK
argument_list|(
name|sc
argument_list|,
name|tracker
argument_list|)
expr_stmt|;
name|VXLAN_WLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vxl_stats
operator|.
name|ftable_lock_upgrade_failed
operator|++
expr_stmt|;
goto|goto
name|again
goto|;
block|}
name|vxlan_sockaddr_in_copy
argument_list|(
operator|&
name|fe
operator|->
name|vxlfe_raddr
argument_list|,
name|sa
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|VXLAN_LOCK_WOWNED
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|VXLAN_RUNLOCK
argument_list|(
name|sc
argument_list|,
name|tracker
argument_list|)
expr_stmt|;
name|VXLAN_WLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vxl_stats
operator|.
name|ftable_lock_upgrade_failed
operator|++
expr_stmt|;
goto|goto
name|again
goto|;
block|}
if|if
condition|(
name|sc
operator|->
name|vxl_ftable_cnt
operator|>=
name|sc
operator|->
name|vxl_ftable_max
condition|)
block|{
name|sc
operator|->
name|vxl_stats
operator|.
name|ftable_nospace
operator|++
expr_stmt|;
return|return
operator|(
name|ENOSPC
operator|)
return|;
block|}
name|fe
operator|=
name|vxlan_ftable_entry_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
name|fe
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
comment|/* 	 * The source port may be randomly select by the remove host, so 	 * use the port of the default destination address. 	 */
name|vxlan_sockaddr_copy
argument_list|(
operator|&
name|vxlsa
argument_list|,
name|sa
argument_list|)
expr_stmt|;
name|vxlsa
operator|.
name|in4
operator|.
name|sin_port
operator|=
name|sc
operator|->
name|vxl_dst_addr
operator|.
name|in4
operator|.
name|sin_port
expr_stmt|;
name|vxlan_ftable_entry_init
argument_list|(
name|sc
argument_list|,
name|fe
argument_list|,
name|mac
argument_list|,
operator|&
name|vxlsa
operator|.
name|sa
argument_list|,
name|VXLAN_FE_FLAG_DYNAMIC
argument_list|)
expr_stmt|;
comment|/* The prior lookup failed, so the insert should not. */
name|error
operator|=
name|vxlan_ftable_entry_insert
argument_list|(
name|sc
argument_list|,
name|fe
argument_list|)
expr_stmt|;
name|MPASS
argument_list|(
name|error
operator|==
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_ftable_update
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|sa
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|rm_priotracker
name|tracker
decl_stmt|;
name|int
name|error
decl_stmt|;
name|VXLAN_RLOCK
argument_list|(
name|sc
argument_list|,
operator|&
name|tracker
argument_list|)
expr_stmt|;
name|error
operator|=
name|vxlan_ftable_update_locked
argument_list|(
name|sc
argument_list|,
name|sa
argument_list|,
name|mac
argument_list|,
operator|&
name|tracker
argument_list|)
expr_stmt|;
name|VXLAN_UNLOCK
argument_list|(
name|sc
argument_list|,
operator|&
name|tracker
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_ftable_sysctl_dump
parameter_list|(
name|SYSCTL_HANDLER_ARGS
parameter_list|)
block|{
name|struct
name|rm_priotracker
name|tracker
decl_stmt|;
name|struct
name|sbuf
name|sb
decl_stmt|;
name|struct
name|vxlan_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|vxlan_ftable_entry
modifier|*
name|fe
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|int
name|i
decl_stmt|,
name|error
decl_stmt|;
comment|/* 	 * This is mostly intended for debugging during development. It is 	 * not practical to dump an entire large table this way. 	 */
name|sc
operator|=
name|arg1
expr_stmt|;
name|size
operator|=
name|PAGE_SIZE
expr_stmt|;
comment|/* Calculate later. */
name|sbuf_new
argument_list|(
operator|&
name|sb
argument_list|,
name|NULL
argument_list|,
name|size
argument_list|,
name|SBUF_FIXEDLEN
argument_list|)
expr_stmt|;
name|sbuf_putc
argument_list|(
operator|&
name|sb
argument_list|,
literal|'\n'
argument_list|)
expr_stmt|;
name|VXLAN_RLOCK
argument_list|(
name|sc
argument_list|,
operator|&
name|tracker
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXLAN_SC_FTABLE_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|LIST_FOREACH
argument_list|(
argument|fe
argument_list|,
argument|&sc->vxl_ftable[i]
argument_list|,
argument|vxlfe_hash
argument_list|)
block|{
if|if
condition|(
name|sbuf_error
argument_list|(
operator|&
name|sb
argument_list|)
operator|!=
literal|0
condition|)
break|break;
name|vxlan_ftable_entry_dump
argument_list|(
name|fe
argument_list|,
operator|&
name|sb
argument_list|)
expr_stmt|;
block|}
block|}
name|VXLAN_RUNLOCK
argument_list|(
name|sc
argument_list|,
operator|&
name|tracker
argument_list|)
expr_stmt|;
if|if
condition|(
name|sbuf_len
argument_list|(
operator|&
name|sb
argument_list|)
operator|==
literal|1
condition|)
name|sbuf_setpos
argument_list|(
operator|&
name|sb
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sbuf_finish
argument_list|(
operator|&
name|sb
argument_list|)
expr_stmt|;
name|error
operator|=
name|sysctl_handle_string
argument_list|(
name|oidp
argument_list|,
name|sbuf_data
argument_list|(
operator|&
name|sb
argument_list|)
argument_list|,
name|sbuf_len
argument_list|(
operator|&
name|sb
argument_list|)
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|sbuf_delete
argument_list|(
operator|&
name|sb
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|vxlan_ftable_entry
modifier|*
name|vxlan_ftable_entry_alloc
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|vxlan_ftable_entry
modifier|*
name|fe
decl_stmt|;
name|fe
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|fe
argument_list|)
argument_list|,
name|M_VXLAN
argument_list|,
name|M_ZERO
operator||
name|M_NOWAIT
argument_list|)
expr_stmt|;
return|return
operator|(
name|fe
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_ftable_entry_free
parameter_list|(
name|struct
name|vxlan_ftable_entry
modifier|*
name|fe
parameter_list|)
block|{
name|free
argument_list|(
name|fe
argument_list|,
name|M_VXLAN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_ftable_entry_init
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|vxlan_ftable_entry
modifier|*
name|fe
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|mac
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|sa
parameter_list|,
name|uint32_t
name|flags
parameter_list|)
block|{
name|fe
operator|->
name|vxlfe_flags
operator|=
name|flags
expr_stmt|;
name|fe
operator|->
name|vxlfe_expire
operator|=
name|time_uptime
operator|+
name|sc
operator|->
name|vxl_ftable_timeout
expr_stmt|;
name|memcpy
argument_list|(
name|fe
operator|->
name|vxlfe_mac
argument_list|,
name|mac
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|vxlan_sockaddr_copy
argument_list|(
operator|&
name|fe
operator|->
name|vxlfe_raddr
argument_list|,
name|sa
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_ftable_entry_destroy
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|vxlan_ftable_entry
modifier|*
name|fe
parameter_list|)
block|{
name|sc
operator|->
name|vxl_ftable_cnt
operator|--
expr_stmt|;
name|LIST_REMOVE
argument_list|(
name|fe
argument_list|,
name|vxlfe_hash
argument_list|)
expr_stmt|;
name|vxlan_ftable_entry_free
argument_list|(
name|fe
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_ftable_entry_insert
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|vxlan_ftable_entry
modifier|*
name|fe
parameter_list|)
block|{
name|struct
name|vxlan_ftable_entry
modifier|*
name|lfe
decl_stmt|;
name|uint32_t
name|hash
decl_stmt|;
name|int
name|dir
decl_stmt|;
name|VXLAN_LOCK_WASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|hash
operator|=
name|VXLAN_SC_FTABLE_HASH
argument_list|(
name|sc
argument_list|,
name|fe
operator|->
name|vxlfe_mac
argument_list|)
expr_stmt|;
name|lfe
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|sc
operator|->
name|vxl_ftable
index|[
name|hash
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|lfe
operator|==
name|NULL
condition|)
block|{
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|sc
operator|->
name|vxl_ftable
index|[
name|hash
index|]
argument_list|,
name|fe
argument_list|,
name|vxlfe_hash
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
do|do
block|{
name|dir
operator|=
name|vxlan_ftable_addr_cmp
argument_list|(
name|fe
operator|->
name|vxlfe_mac
argument_list|,
name|lfe
operator|->
name|vxlfe_mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
operator|==
literal|0
condition|)
return|return
operator|(
name|EEXIST
operator|)
return|;
if|if
condition|(
name|dir
operator|>
literal|0
condition|)
block|{
name|LIST_INSERT_BEFORE
argument_list|(
name|lfe
argument_list|,
name|fe
argument_list|,
name|vxlfe_hash
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
elseif|else
if|if
condition|(
name|LIST_NEXT
argument_list|(
name|lfe
argument_list|,
name|vxlfe_hash
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|LIST_INSERT_AFTER
argument_list|(
name|lfe
argument_list|,
name|fe
argument_list|,
name|vxlfe_hash
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
else|else
name|lfe
operator|=
name|LIST_NEXT
argument_list|(
name|lfe
argument_list|,
name|vxlfe_hash
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|lfe
operator|!=
name|NULL
condition|)
do|;
name|out
label|:
name|sc
operator|->
name|vxl_ftable_cnt
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|vxlan_ftable_entry
modifier|*
name|vxlan_ftable_entry_lookup
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|vxlan_ftable_entry
modifier|*
name|fe
decl_stmt|;
name|uint32_t
name|hash
decl_stmt|;
name|int
name|dir
decl_stmt|;
name|VXLAN_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|hash
operator|=
name|VXLAN_SC_FTABLE_HASH
argument_list|(
name|sc
argument_list|,
name|mac
argument_list|)
expr_stmt|;
name|LIST_FOREACH
argument_list|(
argument|fe
argument_list|,
argument|&sc->vxl_ftable[hash]
argument_list|,
argument|vxlfe_hash
argument_list|)
block|{
name|dir
operator|=
name|vxlan_ftable_addr_cmp
argument_list|(
name|fe
operator|->
name|vxlfe_mac
argument_list|,
name|mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
operator|==
literal|0
condition|)
return|return
operator|(
name|fe
operator|)
return|;
if|if
condition|(
name|dir
operator|>
literal|0
condition|)
break|break;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_ftable_entry_dump
parameter_list|(
name|struct
name|vxlan_ftable_entry
modifier|*
name|fe
parameter_list|,
name|struct
name|sbuf
modifier|*
name|sb
parameter_list|)
block|{
name|char
name|buf
index|[
literal|64
index|]
decl_stmt|;
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
name|sa
decl_stmt|;
specifier|const
name|void
modifier|*
name|addr
decl_stmt|;
name|int
name|i
decl_stmt|,
name|len
decl_stmt|,
name|af
decl_stmt|,
name|width
decl_stmt|;
name|sa
operator|=
operator|&
name|fe
operator|->
name|vxlfe_raddr
expr_stmt|;
name|af
operator|=
name|sa
operator|->
name|sa
operator|.
name|sa_family
expr_stmt|;
name|len
operator|=
name|sbuf_len
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|sb
argument_list|,
literal|"%c 0x%02X "
argument_list|,
name|VXLAN_FE_IS_DYNAMIC
argument_list|(
name|fe
argument_list|)
condition|?
literal|'D'
else|:
literal|'S'
argument_list|,
name|fe
operator|->
name|vxlfe_flags
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ETHER_ADDR_LEN
operator|-
literal|1
condition|;
name|i
operator|++
control|)
name|sbuf_printf
argument_list|(
name|sb
argument_list|,
literal|"%02X:"
argument_list|,
name|fe
operator|->
name|vxlfe_mac
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|sb
argument_list|,
literal|"%02X "
argument_list|,
name|fe
operator|->
name|vxlfe_mac
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|af
operator|==
name|AF_INET
condition|)
block|{
name|addr
operator|=
operator|&
name|sa
operator|->
name|in4
operator|.
name|sin_addr
expr_stmt|;
name|width
operator|=
name|INET_ADDRSTRLEN
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
name|addr
operator|=
operator|&
name|sa
operator|->
name|in6
operator|.
name|sin6_addr
expr_stmt|;
name|width
operator|=
name|INET6_ADDRSTRLEN
operator|-
literal|1
expr_stmt|;
block|}
name|inet_ntop
argument_list|(
name|af
argument_list|,
name|addr
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|sb
argument_list|,
literal|"%*s "
argument_list|,
name|width
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|sbuf_printf
argument_list|(
name|sb
argument_list|,
literal|"%08jd"
argument_list|,
operator|(
name|intmax_t
operator|)
name|fe
operator|->
name|vxlfe_expire
argument_list|)
expr_stmt|;
name|sbuf_putc
argument_list|(
name|sb
argument_list|,
literal|'\n'
argument_list|)
expr_stmt|;
comment|/* Truncate a partial line. */
if|if
condition|(
name|sbuf_error
argument_list|(
name|sb
argument_list|)
operator|!=
literal|0
condition|)
name|sbuf_setpos
argument_list|(
name|sb
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|vxlan_socket
modifier|*
name|vxlan_socket_alloc
parameter_list|(
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
name|sa
parameter_list|)
block|{
name|struct
name|vxlan_socket
modifier|*
name|vso
decl_stmt|;
name|int
name|i
decl_stmt|;
name|vso
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|vso
argument_list|)
argument_list|,
name|M_VXLAN
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|rm_init
argument_list|(
operator|&
name|vso
operator|->
name|vxlso_lock
argument_list|,
literal|"vxlansorm"
argument_list|)
expr_stmt|;
name|refcount_init
argument_list|(
operator|&
name|vso
operator|->
name|vxlso_refcnt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXLAN_SO_VNI_HASH_SIZE
condition|;
name|i
operator|++
control|)
name|LIST_INIT
argument_list|(
operator|&
name|vso
operator|->
name|vxlso_vni_hash
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|vso
operator|->
name|vxlso_laddr
operator|=
operator|*
name|sa
expr_stmt|;
return|return
operator|(
name|vso
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_socket_destroy
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
name|vso
parameter_list|)
block|{
name|struct
name|socket
modifier|*
name|so
decl_stmt|;
name|struct
name|vxlan_socket_mc_info
modifier|*
name|mc
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXLAN_SO_MC_MAX_GROUPS
condition|;
name|i
operator|++
control|)
block|{
name|mc
operator|=
operator|&
name|vso
operator|->
name|vxlso_mc
index|[
name|i
index|]
expr_stmt|;
name|KASSERT
argument_list|(
name|mc
operator|->
name|vxlsomc_gaddr
operator|.
name|sa
operator|.
name|sa_family
operator|==
name|AF_UNSPEC
argument_list|,
operator|(
literal|"%s: socket %p mc[%d] still has address"
operator|,
name|__func__
operator|,
name|vso
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXLAN_SO_VNI_HASH_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|KASSERT
argument_list|(
name|LIST_EMPTY
argument_list|(
operator|&
name|vso
operator|->
name|vxlso_vni_hash
index|[
name|i
index|]
argument_list|)
argument_list|,
operator|(
literal|"%s: socket %p vni_hash[%d] not empty"
operator|,
name|__func__
operator|,
name|vso
operator|,
name|i
operator|)
argument_list|)
expr_stmt|;
block|}
name|so
operator|=
name|vso
operator|->
name|vxlso_sock
expr_stmt|;
if|if
condition|(
name|so
operator|!=
name|NULL
condition|)
block|{
name|vso
operator|->
name|vxlso_sock
operator|=
name|NULL
expr_stmt|;
name|soclose
argument_list|(
name|so
argument_list|)
expr_stmt|;
block|}
name|rm_destroy
argument_list|(
operator|&
name|vso
operator|->
name|vxlso_lock
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|vso
argument_list|,
name|M_VXLAN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_socket_release
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
name|vso
parameter_list|)
block|{
name|int
name|destroy
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|vxlan_list_mtx
argument_list|)
expr_stmt|;
name|destroy
operator|=
name|VXLAN_SO_RELEASE
argument_list|(
name|vso
argument_list|)
expr_stmt|;
if|if
condition|(
name|destroy
operator|!=
literal|0
condition|)
name|LIST_REMOVE
argument_list|(
name|vso
argument_list|,
name|vxlso_entry
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|vxlan_list_mtx
argument_list|)
expr_stmt|;
if|if
condition|(
name|destroy
operator|!=
literal|0
condition|)
name|vxlan_socket_destroy
argument_list|(
name|vso
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|vxlan_socket
modifier|*
name|vxlan_socket_lookup
parameter_list|(
name|union
name|vxlan_sockaddr
modifier|*
name|vxlsa
parameter_list|)
block|{
name|struct
name|vxlan_socket
modifier|*
name|vso
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|vxlan_list_mtx
argument_list|)
expr_stmt|;
name|LIST_FOREACH
argument_list|(
argument|vso
argument_list|,
argument|&vxlan_socket_list
argument_list|,
argument|vxlso_entry
argument_list|)
block|{
if|if
condition|(
name|vxlan_sockaddr_cmp
argument_list|(
operator|&
name|vso
operator|->
name|vxlso_laddr
argument_list|,
operator|&
name|vxlsa
operator|->
name|sa
argument_list|)
operator|==
literal|0
condition|)
block|{
name|VXLAN_SO_ACQUIRE
argument_list|(
name|vso
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|mtx_unlock
argument_list|(
operator|&
name|vxlan_list_mtx
argument_list|)
expr_stmt|;
return|return
operator|(
name|vso
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_socket_insert
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
name|vso
parameter_list|)
block|{
name|mtx_lock
argument_list|(
operator|&
name|vxlan_list_mtx
argument_list|)
expr_stmt|;
name|VXLAN_SO_ACQUIRE
argument_list|(
name|vso
argument_list|)
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|vxlan_socket_list
argument_list|,
name|vso
argument_list|,
name|vxlso_entry
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|vxlan_list_mtx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_socket_init
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
name|vso
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|int
name|error
decl_stmt|;
name|td
operator|=
name|curthread
expr_stmt|;
name|error
operator|=
name|socreate
argument_list|(
name|vso
operator|->
name|vxlso_laddr
operator|.
name|sa
operator|.
name|sa_family
argument_list|,
operator|&
name|vso
operator|->
name|vxlso_sock
argument_list|,
name|SOCK_DGRAM
argument_list|,
name|IPPROTO_UDP
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"cannot create socket: %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|error
operator|=
name|udp_set_kernel_tunneling
argument_list|(
name|vso
operator|->
name|vxlso_sock
argument_list|,
name|vxlan_rcv_udp_packet
argument_list|,
name|vso
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"cannot set tunneling function: %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
name|vxlan_reuse_port
operator|!=
literal|0
condition|)
block|{
name|struct
name|sockopt
name|sopt
decl_stmt|;
name|int
name|val
init|=
literal|1
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|sopt
argument_list|,
sizeof|sizeof
argument_list|(
name|sopt
argument_list|)
argument_list|)
expr_stmt|;
name|sopt
operator|.
name|sopt_dir
operator|=
name|SOPT_SET
expr_stmt|;
name|sopt
operator|.
name|sopt_level
operator|=
name|IPPROTO_IP
expr_stmt|;
name|sopt
operator|.
name|sopt_name
operator|=
name|SO_REUSEPORT
expr_stmt|;
name|sopt
operator|.
name|sopt_val
operator|=
operator|&
name|val
expr_stmt|;
name|sopt
operator|.
name|sopt_valsize
operator|=
sizeof|sizeof
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|error
operator|=
name|sosetopt
argument_list|(
name|vso
operator|->
name|vxlso_sock
argument_list|,
operator|&
name|sopt
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"cannot set REUSEADDR socket opt: %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_socket_bind
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
name|vso
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|union
name|vxlan_sockaddr
name|laddr
decl_stmt|;
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|int
name|error
decl_stmt|;
name|td
operator|=
name|curthread
expr_stmt|;
name|laddr
operator|=
name|vso
operator|->
name|vxlso_laddr
expr_stmt|;
name|error
operator|=
name|sobind
argument_list|(
name|vso
operator|->
name|vxlso_sock
argument_list|,
operator|&
name|laddr
operator|.
name|sa
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
if|if
condition|(
name|error
operator|!=
name|EADDRINUSE
condition|)
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"cannot bind socket: %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_socket_create
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|int
name|multicast
parameter_list|,
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
name|saddr
parameter_list|,
name|struct
name|vxlan_socket
modifier|*
modifier|*
name|vsop
parameter_list|)
block|{
name|union
name|vxlan_sockaddr
name|laddr
decl_stmt|;
name|struct
name|vxlan_socket
modifier|*
name|vso
decl_stmt|;
name|int
name|error
decl_stmt|;
name|laddr
operator|=
operator|*
name|saddr
expr_stmt|;
comment|/* 	 * If this socket will be multicast, then only the local port 	 * must be specified when binding. 	 */
if|if
condition|(
name|multicast
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|VXLAN_SOCKADDR_IS_IPV4
argument_list|(
operator|&
name|laddr
argument_list|)
condition|)
name|laddr
operator|.
name|in4
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|INADDR_ANY
expr_stmt|;
ifdef|#
directive|ifdef
name|INET6
else|else
name|laddr
operator|.
name|in6
operator|.
name|sin6_addr
operator|=
name|in6addr_any
expr_stmt|;
endif|#
directive|endif
block|}
name|vso
operator|=
name|vxlan_socket_alloc
argument_list|(
operator|&
name|laddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|vso
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|error
operator|=
name|vxlan_socket_init
argument_list|(
name|vso
argument_list|,
name|ifp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|vxlan_socket_bind
argument_list|(
name|vso
argument_list|,
name|ifp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
comment|/* 	 * There is a small window between the bind completing and 	 * inserting the socket, so that a concurrent create may fail. 	 * Let's not worry about that for now. 	 */
name|vxlan_socket_insert
argument_list|(
name|vso
argument_list|)
expr_stmt|;
operator|*
name|vsop
operator|=
name|vso
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|vxlan_socket_destroy
argument_list|(
name|vso
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_socket_ifdetach
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
name|vso
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|vxlan_softc_head
modifier|*
name|list
parameter_list|)
block|{
name|struct
name|rm_priotracker
name|tracker
decl_stmt|;
name|struct
name|vxlan_softc
modifier|*
name|sc
decl_stmt|;
name|int
name|i
decl_stmt|;
name|VXLAN_SO_RLOCK
argument_list|(
name|vso
argument_list|,
operator|&
name|tracker
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXLAN_SO_VNI_HASH_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|LIST_FOREACH
argument_list|(
argument|sc
argument_list|,
argument|&vso->vxlso_vni_hash[i]
argument_list|,
argument|vxl_entry
argument_list|)
name|vxlan_ifdetach
argument_list|(
name|sc
argument_list|,
name|ifp
argument_list|,
name|list
argument_list|)
expr_stmt|;
block|}
name|VXLAN_SO_RUNLOCK
argument_list|(
name|vso
argument_list|,
operator|&
name|tracker
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|vxlan_socket
modifier|*
name|vxlan_socket_mc_lookup
parameter_list|(
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
name|vxlsa
parameter_list|)
block|{
name|struct
name|vxlan_socket
modifier|*
name|vso
decl_stmt|;
name|union
name|vxlan_sockaddr
name|laddr
decl_stmt|;
name|laddr
operator|=
operator|*
name|vxlsa
expr_stmt|;
if|if
condition|(
name|VXLAN_SOCKADDR_IS_IPV4
argument_list|(
operator|&
name|laddr
argument_list|)
condition|)
name|laddr
operator|.
name|in4
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|INADDR_ANY
expr_stmt|;
ifdef|#
directive|ifdef
name|INET6
else|else
name|laddr
operator|.
name|in6
operator|.
name|sin6_addr
operator|=
name|in6addr_any
expr_stmt|;
endif|#
directive|endif
name|vso
operator|=
name|vxlan_socket_lookup
argument_list|(
operator|&
name|laddr
argument_list|)
expr_stmt|;
return|return
operator|(
name|vso
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_sockaddr_mc_info_match
parameter_list|(
specifier|const
name|struct
name|vxlan_socket_mc_info
modifier|*
name|mc
parameter_list|,
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
name|group
parameter_list|,
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
name|local
parameter_list|,
name|int
name|ifidx
parameter_list|)
block|{
if|if
condition|(
operator|!
name|vxlan_sockaddr_in_any
argument_list|(
name|local
argument_list|)
operator|&&
operator|!
name|vxlan_sockaddr_in_equal
argument_list|(
operator|&
name|mc
operator|->
name|vxlsomc_saddr
argument_list|,
operator|&
name|local
operator|->
name|sa
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
name|vxlan_sockaddr_in_equal
argument_list|(
operator|&
name|mc
operator|->
name|vxlsomc_gaddr
argument_list|,
operator|&
name|group
operator|->
name|sa
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|ifidx
operator|!=
literal|0
operator|&&
name|ifidx
operator|!=
name|mc
operator|->
name|vxlsomc_ifidx
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_socket_mc_join_group
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
name|vso
parameter_list|,
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
name|group
parameter_list|,
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
name|local
parameter_list|,
name|int
modifier|*
name|ifidx
parameter_list|,
name|union
name|vxlan_sockaddr
modifier|*
name|source
parameter_list|)
block|{
name|struct
name|sockopt
name|sopt
decl_stmt|;
name|int
name|error
decl_stmt|;
operator|*
name|source
operator|=
operator|*
name|local
expr_stmt|;
if|if
condition|(
name|VXLAN_SOCKADDR_IS_IPV4
argument_list|(
name|group
argument_list|)
condition|)
block|{
name|struct
name|ip_mreq
name|mreq
decl_stmt|;
name|mreq
operator|.
name|imr_multiaddr
operator|=
name|group
operator|->
name|in4
operator|.
name|sin_addr
expr_stmt|;
name|mreq
operator|.
name|imr_interface
operator|=
name|local
operator|->
name|in4
operator|.
name|sin_addr
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|sopt
argument_list|,
sizeof|sizeof
argument_list|(
name|sopt
argument_list|)
argument_list|)
expr_stmt|;
name|sopt
operator|.
name|sopt_dir
operator|=
name|SOPT_SET
expr_stmt|;
name|sopt
operator|.
name|sopt_level
operator|=
name|IPPROTO_IP
expr_stmt|;
name|sopt
operator|.
name|sopt_name
operator|=
name|IP_ADD_MEMBERSHIP
expr_stmt|;
name|sopt
operator|.
name|sopt_val
operator|=
operator|&
name|mreq
expr_stmt|;
name|sopt
operator|.
name|sopt_valsize
operator|=
sizeof|sizeof
argument_list|(
name|mreq
argument_list|)
expr_stmt|;
name|error
operator|=
name|sosetopt
argument_list|(
name|vso
operator|->
name|vxlso_sock
argument_list|,
operator|&
name|sopt
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* 		 * BMV: Ideally, there would be a formal way for us to get 		 * the local interface that was selected based on the 		 * imr_interface address. We could then update *ifidx so 		 * vxlan_sockaddr_mc_info_match() would return a match for 		 * later creates that explicitly set the multicast interface. 		 * 		 * If we really need to, we can of course look in the INP's 		 * membership list: 		 *     sotoinpcb(vso->vxlso_sock)->inp_moptions-> 		 *         imo_membership[]->inm_ifp 		 * similarly to imo_match_group(). 		 */
name|source
operator|->
name|in4
operator|.
name|sin_addr
operator|=
name|local
operator|->
name|in4
operator|.
name|sin_addr
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|VXLAN_SOCKADDR_IS_IPV6
argument_list|(
name|group
argument_list|)
condition|)
block|{
name|struct
name|ipv6_mreq
name|mreq
decl_stmt|;
name|mreq
operator|.
name|ipv6mr_multiaddr
operator|=
name|group
operator|->
name|in6
operator|.
name|sin6_addr
expr_stmt|;
name|mreq
operator|.
name|ipv6mr_interface
operator|=
operator|*
name|ifidx
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|sopt
argument_list|,
sizeof|sizeof
argument_list|(
name|sopt
argument_list|)
argument_list|)
expr_stmt|;
name|sopt
operator|.
name|sopt_dir
operator|=
name|SOPT_SET
expr_stmt|;
name|sopt
operator|.
name|sopt_level
operator|=
name|IPPROTO_IPV6
expr_stmt|;
name|sopt
operator|.
name|sopt_name
operator|=
name|IPV6_JOIN_GROUP
expr_stmt|;
name|sopt
operator|.
name|sopt_val
operator|=
operator|&
name|mreq
expr_stmt|;
name|sopt
operator|.
name|sopt_valsize
operator|=
sizeof|sizeof
argument_list|(
name|mreq
argument_list|)
expr_stmt|;
name|error
operator|=
name|sosetopt
argument_list|(
name|vso
operator|->
name|vxlso_sock
argument_list|,
operator|&
name|sopt
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* 		 * BMV: As with IPv4, we would really like to know what 		 * interface in6p_lookup_mcast_ifp() selected. 		 */
block|}
else|else
name|error
operator|=
name|EAFNOSUPPORT
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_socket_mc_leave_group
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
name|vso
parameter_list|,
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
name|group
parameter_list|,
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
name|source
parameter_list|,
name|int
name|ifidx
parameter_list|)
block|{
name|struct
name|sockopt
name|sopt
decl_stmt|;
name|int
name|error
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|sopt
argument_list|,
sizeof|sizeof
argument_list|(
name|sopt
argument_list|)
argument_list|)
expr_stmt|;
name|sopt
operator|.
name|sopt_dir
operator|=
name|SOPT_SET
expr_stmt|;
if|if
condition|(
name|VXLAN_SOCKADDR_IS_IPV4
argument_list|(
name|group
argument_list|)
condition|)
block|{
name|struct
name|ip_mreq
name|mreq
decl_stmt|;
name|mreq
operator|.
name|imr_multiaddr
operator|=
name|group
operator|->
name|in4
operator|.
name|sin_addr
expr_stmt|;
name|mreq
operator|.
name|imr_interface
operator|=
name|source
operator|->
name|in4
operator|.
name|sin_addr
expr_stmt|;
name|sopt
operator|.
name|sopt_level
operator|=
name|IPPROTO_IP
expr_stmt|;
name|sopt
operator|.
name|sopt_name
operator|=
name|IP_DROP_MEMBERSHIP
expr_stmt|;
name|sopt
operator|.
name|sopt_val
operator|=
operator|&
name|mreq
expr_stmt|;
name|sopt
operator|.
name|sopt_valsize
operator|=
sizeof|sizeof
argument_list|(
name|mreq
argument_list|)
expr_stmt|;
name|error
operator|=
name|sosetopt
argument_list|(
name|vso
operator|->
name|vxlso_sock
argument_list|,
operator|&
name|sopt
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|VXLAN_SOCKADDR_IS_IPV6
argument_list|(
name|group
argument_list|)
condition|)
block|{
name|struct
name|ipv6_mreq
name|mreq
decl_stmt|;
name|mreq
operator|.
name|ipv6mr_multiaddr
operator|=
name|group
operator|->
name|in6
operator|.
name|sin6_addr
expr_stmt|;
name|mreq
operator|.
name|ipv6mr_interface
operator|=
name|ifidx
expr_stmt|;
name|sopt
operator|.
name|sopt_level
operator|=
name|IPPROTO_IPV6
expr_stmt|;
name|sopt
operator|.
name|sopt_name
operator|=
name|IPV6_LEAVE_GROUP
expr_stmt|;
name|sopt
operator|.
name|sopt_val
operator|=
operator|&
name|mreq
expr_stmt|;
name|sopt
operator|.
name|sopt_valsize
operator|=
sizeof|sizeof
argument_list|(
name|mreq
argument_list|)
expr_stmt|;
name|error
operator|=
name|sosetopt
argument_list|(
name|vso
operator|->
name|vxlso_sock
argument_list|,
operator|&
name|sopt
argument_list|)
expr_stmt|;
block|}
else|else
name|error
operator|=
name|EAFNOSUPPORT
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_socket_mc_add_group
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
name|vso
parameter_list|,
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
name|group
parameter_list|,
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
name|local
parameter_list|,
name|int
name|ifidx
parameter_list|,
name|int
modifier|*
name|idx
parameter_list|)
block|{
name|union
name|vxlan_sockaddr
name|source
decl_stmt|;
name|struct
name|vxlan_socket_mc_info
modifier|*
name|mc
decl_stmt|;
name|int
name|i
decl_stmt|,
name|empty
decl_stmt|,
name|error
decl_stmt|;
comment|/* 	 * Within a socket, the same multicast group may be used by multiple 	 * interfaces, each with a different network identifier. But a socket 	 * may only join a multicast group once, so keep track of the users 	 * here. 	 */
name|VXLAN_SO_WLOCK
argument_list|(
name|vso
argument_list|)
expr_stmt|;
for|for
control|(
name|empty
operator|=
literal|0
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXLAN_SO_MC_MAX_GROUPS
condition|;
name|i
operator|++
control|)
block|{
name|mc
operator|=
operator|&
name|vso
operator|->
name|vxlso_mc
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|mc
operator|->
name|vxlsomc_gaddr
operator|.
name|sa
operator|.
name|sa_family
operator|==
name|AF_UNSPEC
condition|)
block|{
name|empty
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|vxlan_sockaddr_mc_info_match
argument_list|(
name|mc
argument_list|,
name|group
argument_list|,
name|local
argument_list|,
name|ifidx
argument_list|)
condition|)
goto|goto
name|out
goto|;
block|}
name|VXLAN_SO_WUNLOCK
argument_list|(
name|vso
argument_list|)
expr_stmt|;
if|if
condition|(
name|empty
operator|==
literal|0
condition|)
return|return
operator|(
name|ENOSPC
operator|)
return|;
name|error
operator|=
name|vxlan_socket_mc_join_group
argument_list|(
name|vso
argument_list|,
name|group
argument_list|,
name|local
argument_list|,
operator|&
name|ifidx
argument_list|,
operator|&
name|source
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|VXLAN_SO_WLOCK
argument_list|(
name|vso
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VXLAN_SO_MC_MAX_GROUPS
condition|;
name|i
operator|++
control|)
block|{
name|mc
operator|=
operator|&
name|vso
operator|->
name|vxlso_mc
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|mc
operator|->
name|vxlsomc_gaddr
operator|.
name|sa
operator|.
name|sa_family
operator|==
name|AF_UNSPEC
condition|)
block|{
name|vxlan_sockaddr_copy
argument_list|(
operator|&
name|mc
operator|->
name|vxlsomc_gaddr
argument_list|,
operator|&
name|group
operator|->
name|sa
argument_list|)
expr_stmt|;
name|vxlan_sockaddr_copy
argument_list|(
operator|&
name|mc
operator|->
name|vxlsomc_saddr
argument_list|,
operator|&
name|source
operator|.
name|sa
argument_list|)
expr_stmt|;
name|mc
operator|->
name|vxlsomc_ifidx
operator|=
name|ifidx
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|VXLAN_SO_WUNLOCK
argument_list|(
name|vso
argument_list|)
expr_stmt|;
name|error
operator|=
name|vxlan_socket_mc_leave_group
argument_list|(
name|vso
argument_list|,
name|group
argument_list|,
operator|&
name|source
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
name|MPASS
argument_list|(
name|error
operator|==
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOSPC
operator|)
return|;
name|out
label|:
name|mc
operator|->
name|vxlsomc_users
operator|++
expr_stmt|;
name|VXLAN_SO_WUNLOCK
argument_list|(
name|vso
argument_list|)
expr_stmt|;
operator|*
name|idx
operator|=
name|i
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_socket_mc_release_group_by_idx
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
name|vso
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|union
name|vxlan_sockaddr
name|group
decl_stmt|,
name|source
decl_stmt|;
name|struct
name|vxlan_socket_mc_info
modifier|*
name|mc
decl_stmt|;
name|int
name|ifidx
decl_stmt|,
name|leave
decl_stmt|;
name|KASSERT
argument_list|(
name|idx
operator|>=
literal|0
operator|&&
name|idx
operator|<
name|VXLAN_SO_MC_MAX_GROUPS
argument_list|,
operator|(
literal|"%s: vso %p idx %d out of bounds"
operator|,
name|__func__
operator|,
name|vso
operator|,
name|idx
operator|)
argument_list|)
expr_stmt|;
name|leave
operator|=
literal|0
expr_stmt|;
name|mc
operator|=
operator|&
name|vso
operator|->
name|vxlso_mc
index|[
name|idx
index|]
expr_stmt|;
name|VXLAN_SO_WLOCK
argument_list|(
name|vso
argument_list|)
expr_stmt|;
name|mc
operator|->
name|vxlsomc_users
operator|--
expr_stmt|;
if|if
condition|(
name|mc
operator|->
name|vxlsomc_users
operator|==
literal|0
condition|)
block|{
name|group
operator|=
name|mc
operator|->
name|vxlsomc_gaddr
expr_stmt|;
name|source
operator|=
name|mc
operator|->
name|vxlsomc_saddr
expr_stmt|;
name|ifidx
operator|=
name|mc
operator|->
name|vxlsomc_ifidx
expr_stmt|;
name|bzero
argument_list|(
name|mc
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|mc
argument_list|)
argument_list|)
expr_stmt|;
name|leave
operator|=
literal|1
expr_stmt|;
block|}
name|VXLAN_SO_WUNLOCK
argument_list|(
name|vso
argument_list|)
expr_stmt|;
if|if
condition|(
name|leave
operator|!=
literal|0
condition|)
block|{
comment|/* 		 * Our socket's membership in this group may have already 		 * been removed if we joined through an interface that's 		 * been detached. 		 */
name|vxlan_socket_mc_leave_group
argument_list|(
name|vso
argument_list|,
operator|&
name|group
argument_list|,
operator|&
name|source
argument_list|,
name|ifidx
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|vxlan_softc
modifier|*
name|vxlan_socket_lookup_softc_locked
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
name|vso
parameter_list|,
name|uint32_t
name|vni
parameter_list|)
block|{
name|struct
name|vxlan_softc
modifier|*
name|sc
decl_stmt|;
name|uint32_t
name|hash
decl_stmt|;
name|VXLAN_SO_LOCK_ASSERT
argument_list|(
name|vso
argument_list|)
expr_stmt|;
name|hash
operator|=
name|VXLAN_SO_VNI_HASH
argument_list|(
name|vni
argument_list|)
expr_stmt|;
name|LIST_FOREACH
argument_list|(
argument|sc
argument_list|,
argument|&vso->vxlso_vni_hash[hash]
argument_list|,
argument|vxl_entry
argument_list|)
block|{
if|if
condition|(
name|sc
operator|->
name|vxl_vni
operator|==
name|vni
condition|)
block|{
name|VXLAN_ACQUIRE
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
name|sc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|vxlan_softc
modifier|*
name|vxlan_socket_lookup_softc
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
name|vso
parameter_list|,
name|uint32_t
name|vni
parameter_list|)
block|{
name|struct
name|rm_priotracker
name|tracker
decl_stmt|;
name|struct
name|vxlan_softc
modifier|*
name|sc
decl_stmt|;
name|VXLAN_SO_RLOCK
argument_list|(
name|vso
argument_list|,
operator|&
name|tracker
argument_list|)
expr_stmt|;
name|sc
operator|=
name|vxlan_socket_lookup_softc_locked
argument_list|(
name|vso
argument_list|,
name|vni
argument_list|)
expr_stmt|;
name|VXLAN_SO_RUNLOCK
argument_list|(
name|vso
argument_list|,
operator|&
name|tracker
argument_list|)
expr_stmt|;
return|return
operator|(
name|sc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_socket_insert_softc
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
name|vso
parameter_list|,
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|vxlan_softc
modifier|*
name|tsc
decl_stmt|;
name|uint32_t
name|vni
decl_stmt|,
name|hash
decl_stmt|;
name|vni
operator|=
name|sc
operator|->
name|vxl_vni
expr_stmt|;
name|hash
operator|=
name|VXLAN_SO_VNI_HASH
argument_list|(
name|vni
argument_list|)
expr_stmt|;
name|VXLAN_SO_WLOCK
argument_list|(
name|vso
argument_list|)
expr_stmt|;
name|tsc
operator|=
name|vxlan_socket_lookup_softc_locked
argument_list|(
name|vso
argument_list|,
name|vni
argument_list|)
expr_stmt|;
if|if
condition|(
name|tsc
operator|!=
name|NULL
condition|)
block|{
name|VXLAN_SO_WUNLOCK
argument_list|(
name|vso
argument_list|)
expr_stmt|;
name|vxlan_release
argument_list|(
name|tsc
argument_list|)
expr_stmt|;
return|return
operator|(
name|EEXIST
operator|)
return|;
block|}
name|VXLAN_ACQUIRE
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|vso
operator|->
name|vxlso_vni_hash
index|[
name|hash
index|]
argument_list|,
name|sc
argument_list|,
name|vxl_entry
argument_list|)
expr_stmt|;
name|VXLAN_SO_WUNLOCK
argument_list|(
name|vso
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_socket_remove_softc
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
name|vso
parameter_list|,
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|)
block|{
name|VXLAN_SO_WLOCK
argument_list|(
name|vso
argument_list|)
expr_stmt|;
name|LIST_REMOVE
argument_list|(
name|sc
argument_list|,
name|vxl_entry
argument_list|)
expr_stmt|;
name|VXLAN_SO_WUNLOCK
argument_list|(
name|vso
argument_list|)
expr_stmt|;
name|vxlan_release
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ifnet
modifier|*
name|vxlan_multicast_if_ref
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
name|int
name|ipv4
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|VXLAN_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ipv4
operator|&&
name|sc
operator|->
name|vxl_im4o
operator|!=
name|NULL
condition|)
name|ifp
operator|=
name|sc
operator|->
name|vxl_im4o
operator|->
name|imo_multicast_ifp
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|ipv4
operator|&&
name|sc
operator|->
name|vxl_im6o
operator|!=
name|NULL
condition|)
name|ifp
operator|=
name|sc
operator|->
name|vxl_im6o
operator|->
name|im6o_multicast_ifp
expr_stmt|;
else|else
name|ifp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ifp
operator|!=
name|NULL
condition|)
name|if_ref
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
return|return
operator|(
name|ifp
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_free_multicast
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|)
block|{
if|if
condition|(
name|sc
operator|->
name|vxl_mc_ifp
operator|!=
name|NULL
condition|)
block|{
name|if_rele
argument_list|(
name|sc
operator|->
name|vxl_mc_ifp
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vxl_mc_ifp
operator|=
name|NULL
expr_stmt|;
name|sc
operator|->
name|vxl_mc_ifindex
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|vxl_im4o
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|sc
operator|->
name|vxl_im4o
argument_list|,
name|M_VXLAN
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vxl_im4o
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|sc
operator|->
name|vxl_im6o
operator|!=
name|NULL
condition|)
block|{
name|free
argument_list|(
name|sc
operator|->
name|vxl_im6o
argument_list|,
name|M_VXLAN
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vxl_im6o
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_setup_multicast_interface
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|ifp
operator|=
name|ifunit_ref
argument_list|(
name|sc
operator|->
name|vxl_mc_ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|vxl_ifp
argument_list|,
literal|"multicast interfaces %s does "
literal|"not exist\n"
argument_list|,
name|sc
operator|->
name|vxl_mc_ifname
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_MULTICAST
operator|)
operator|==
literal|0
condition|)
block|{
name|if_printf
argument_list|(
name|sc
operator|->
name|vxl_ifp
argument_list|,
literal|"interface %s does not support "
literal|"multicast\n"
argument_list|,
name|sc
operator|->
name|vxl_mc_ifname
argument_list|)
expr_stmt|;
name|if_rele
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOTSUP
operator|)
return|;
block|}
name|sc
operator|->
name|vxl_mc_ifp
operator|=
name|ifp
expr_stmt|;
name|sc
operator|->
name|vxl_mc_ifindex
operator|=
name|ifp
operator|->
name|if_index
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_setup_multicast
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|)
block|{
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
name|group
decl_stmt|;
name|int
name|error
decl_stmt|;
name|group
operator|=
operator|&
name|sc
operator|->
name|vxl_dst_addr
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vxl_mc_ifname
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
block|{
name|error
operator|=
name|vxlan_setup_multicast_interface
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
comment|/* 	 * Initialize an multicast options structure that is sufficiently 	 * populated for use in the respective IP output routine. This 	 * structure is typically stored in the socket, but our sockets 	 * may be shared among multiple interfaces. 	 */
if|if
condition|(
name|VXLAN_SOCKADDR_IS_IPV4
argument_list|(
name|group
argument_list|)
condition|)
block|{
name|sc
operator|->
name|vxl_im4o
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ip_moptions
argument_list|)
argument_list|,
name|M_VXLAN
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vxl_im4o
operator|->
name|imo_multicast_ifp
operator|=
name|sc
operator|->
name|vxl_mc_ifp
expr_stmt|;
name|sc
operator|->
name|vxl_im4o
operator|->
name|imo_multicast_ttl
operator|=
name|sc
operator|->
name|vxl_ttl
expr_stmt|;
name|sc
operator|->
name|vxl_im4o
operator|->
name|imo_multicast_vif
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|VXLAN_SOCKADDR_IS_IPV6
argument_list|(
name|group
argument_list|)
condition|)
block|{
name|sc
operator|->
name|vxl_im6o
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_moptions
argument_list|)
argument_list|,
name|M_VXLAN
argument_list|,
name|M_ZERO
operator||
name|M_WAITOK
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vxl_im6o
operator|->
name|im6o_multicast_ifp
operator|=
name|sc
operator|->
name|vxl_mc_ifp
expr_stmt|;
name|sc
operator|->
name|vxl_im6o
operator|->
name|im6o_multicast_hlim
operator|=
name|sc
operator|->
name|vxl_ttl
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_setup_socket
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|vxlan_socket
modifier|*
name|vso
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|union
name|vxlan_sockaddr
modifier|*
name|saddr
decl_stmt|,
modifier|*
name|daddr
decl_stmt|;
name|int
name|multicast
decl_stmt|,
name|error
decl_stmt|;
name|vso
operator|=
name|NULL
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vxl_ifp
expr_stmt|;
name|saddr
operator|=
operator|&
name|sc
operator|->
name|vxl_src_addr
expr_stmt|;
name|daddr
operator|=
operator|&
name|sc
operator|->
name|vxl_dst_addr
expr_stmt|;
name|multicast
operator|=
name|vxlan_sockaddr_in_multicast
argument_list|(
name|daddr
argument_list|)
expr_stmt|;
name|MPASS
argument_list|(
name|multicast
operator|!=
operator|-
literal|1
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vxl_vso_mc_index
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* 	 * Try to create the socket. If that fails, attempt to use an 	 * existing socket. 	 */
name|error
operator|=
name|vxlan_socket_create
argument_list|(
name|ifp
argument_list|,
name|multicast
argument_list|,
name|saddr
argument_list|,
operator|&
name|vso
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
if|if
condition|(
name|multicast
operator|!=
literal|0
condition|)
name|vso
operator|=
name|vxlan_socket_mc_lookup
argument_list|(
name|saddr
argument_list|)
expr_stmt|;
else|else
name|vso
operator|=
name|vxlan_socket_lookup
argument_list|(
name|saddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|vso
operator|==
name|NULL
condition|)
block|{
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"cannot create socket (error: %d), "
literal|"and no existing socket found\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
if|if
condition|(
name|multicast
operator|!=
literal|0
condition|)
block|{
name|error
operator|=
name|vxlan_setup_multicast
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|out
goto|;
name|error
operator|=
name|vxlan_socket_mc_add_group
argument_list|(
name|vso
argument_list|,
name|daddr
argument_list|,
name|saddr
argument_list|,
name|sc
operator|->
name|vxl_mc_ifindex
argument_list|,
operator|&
name|sc
operator|->
name|vxl_vso_mc_index
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|out
goto|;
block|}
name|sc
operator|->
name|vxl_sock
operator|=
name|vso
expr_stmt|;
name|error
operator|=
name|vxlan_socket_insert_softc
argument_list|(
name|vso
argument_list|,
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|sc
operator|->
name|vxl_sock
operator|=
name|NULL
expr_stmt|;
name|if_printf
argument_list|(
name|ifp
argument_list|,
literal|"network identifier %d already exists in "
literal|"this socket\n"
argument_list|,
name|sc
operator|->
name|vxl_vni
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|out
label|:
if|if
condition|(
name|vso
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|vxl_vso_mc_index
operator|!=
operator|-
literal|1
condition|)
block|{
name|vxlan_socket_mc_release_group_by_idx
argument_list|(
name|vso
argument_list|,
name|sc
operator|->
name|vxl_vso_mc_index
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vxl_vso_mc_index
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|multicast
operator|!=
literal|0
condition|)
name|vxlan_free_multicast
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|vxlan_socket_release
argument_list|(
name|vso
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_setup_interface
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vxl_ifp
expr_stmt|;
name|ifp
operator|->
name|if_hdrlen
operator|=
name|ETHER_HDR_LEN
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|vxlanudphdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|VXLAN_SOCKADDR_IS_IPV4
argument_list|(
operator|&
name|sc
operator|->
name|vxl_dst_addr
argument_list|)
operator|!=
literal|0
condition|)
name|ifp
operator|->
name|if_hdrlen
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|VXLAN_SOCKADDR_IS_IPV6
argument_list|(
operator|&
name|sc
operator|->
name|vxl_dst_addr
argument_list|)
operator|!=
literal|0
condition|)
name|ifp
operator|->
name|if_hdrlen
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_valid_init_config
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|reason
decl_stmt|;
if|if
condition|(
name|vxlan_check_vni
argument_list|(
name|sc
operator|->
name|vxl_vni
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|reason
operator|=
literal|"invalid virtual network identifier specified"
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|vxlan_sockaddr_supported
argument_list|(
operator|&
name|sc
operator|->
name|vxl_src_addr
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reason
operator|=
literal|"source address type is not supported"
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|vxlan_sockaddr_supported
argument_list|(
operator|&
name|sc
operator|->
name|vxl_dst_addr
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reason
operator|=
literal|"destination address type is not supported"
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|vxlan_sockaddr_in_any
argument_list|(
operator|&
name|sc
operator|->
name|vxl_dst_addr
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|reason
operator|=
literal|"no valid destination address specified"
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|vxlan_sockaddr_in_multicast
argument_list|(
operator|&
name|sc
operator|->
name|vxl_dst_addr
argument_list|)
operator|==
literal|0
operator|&&
name|sc
operator|->
name|vxl_mc_ifname
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
block|{
name|reason
operator|=
literal|"can only specify interface with a group address"
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|vxlan_sockaddr_in_any
argument_list|(
operator|&
name|sc
operator|->
name|vxl_src_addr
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|VXLAN_SOCKADDR_IS_IPV4
argument_list|(
operator|&
name|sc
operator|->
name|vxl_src_addr
argument_list|)
operator|^
name|VXLAN_SOCKADDR_IS_IPV4
argument_list|(
operator|&
name|sc
operator|->
name|vxl_dst_addr
argument_list|)
condition|)
block|{
name|reason
operator|=
literal|"source and destination address must both "
literal|"be either IPv4 or IPv6"
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
if|if
condition|(
name|sc
operator|->
name|vxl_src_addr
operator|.
name|in4
operator|.
name|sin_port
operator|==
literal|0
condition|)
block|{
name|reason
operator|=
literal|"local port not specified"
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|sc
operator|->
name|vxl_dst_addr
operator|.
name|in4
operator|.
name|sin_port
operator|==
literal|0
condition|)
block|{
name|reason
operator|=
literal|"remote port not specified"
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|if_printf
argument_list|(
name|sc
operator|->
name|vxl_ifp
argument_list|,
literal|"cannot initialize interface: %s\n"
argument_list|,
name|reason
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_init_wait
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|)
block|{
name|VXLAN_LOCK_WASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
while|while
condition|(
name|sc
operator|->
name|vxl_flags
operator|&
name|VXLAN_FLAG_INIT
condition|)
name|rm_sleep
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|vxl_lock
argument_list|,
literal|0
argument_list|,
literal|"vxlint"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_init_complete
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|)
block|{
name|VXLAN_WLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vxl_flags
operator|&=
operator|~
name|VXLAN_FLAG_INIT
expr_stmt|;
name|wakeup
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|VXLAN_WUNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_init
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
block|{
specifier|static
specifier|const
name|uint8_t
name|empty_mac
index|[
name|ETHER_ADDR_LEN
index|]
decl_stmt|;
name|struct
name|vxlan_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|sc
operator|=
name|xsc
expr_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vxl_ifp
expr_stmt|;
name|VXLAN_WLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
block|{
name|VXLAN_WUNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
name|sc
operator|->
name|vxl_flags
operator||=
name|VXLAN_FLAG_INIT
expr_stmt|;
name|VXLAN_WUNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|vxlan_valid_init_config
argument_list|(
name|sc
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|out
goto|;
name|vxlan_setup_interface
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|vxlan_setup_socket
argument_list|(
name|sc
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|out
goto|;
comment|/* Initialize the default forwarding entry. */
name|vxlan_ftable_entry_init
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|vxl_default_fe
argument_list|,
name|empty_mac
argument_list|,
operator|&
name|sc
operator|->
name|vxl_dst_addr
operator|.
name|sa
argument_list|,
name|VXLAN_FE_FLAG_STATIC
argument_list|)
expr_stmt|;
name|VXLAN_WLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator||=
name|IFF_DRV_RUNNING
expr_stmt|;
name|callout_reset
argument_list|(
operator|&
name|sc
operator|->
name|vxl_callout
argument_list|,
name|vxlan_ftable_prune_period
operator|*
name|hz
argument_list|,
name|vxlan_timer
argument_list|,
name|sc
argument_list|)
expr_stmt|;
name|VXLAN_WUNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|out
label|:
name|vxlan_init_complete
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_release
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* 	 * The softc may be destroyed as soon as we release our reference, 	 * so we cannot serialize the wakeup with the softc lock. We use a 	 * timeout in our sleeps so a missed wakeup is unfortunate but not 	 * fatal. 	 */
if|if
condition|(
name|VXLAN_RELEASE
argument_list|(
name|sc
argument_list|)
operator|!=
literal|0
condition|)
name|wakeup
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_teardown_wait
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|)
block|{
name|VXLAN_LOCK_WASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
while|while
condition|(
name|sc
operator|->
name|vxl_flags
operator|&
name|VXLAN_FLAG_TEARDOWN
condition|)
name|rm_sleep
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|vxl_lock
argument_list|,
literal|0
argument_list|,
literal|"vxltrn"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_teardown_complete
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|)
block|{
name|VXLAN_WLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vxl_flags
operator|&=
operator|~
name|VXLAN_FLAG_TEARDOWN
expr_stmt|;
name|wakeup
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|VXLAN_WUNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_teardown_locked
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|vxlan_socket
modifier|*
name|vso
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vxl_ifp
expr_stmt|;
name|VXLAN_LOCK_WASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|MPASS
argument_list|(
name|sc
operator|->
name|vxl_flags
operator|&
name|VXLAN_FLAG_TEARDOWN
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|&=
operator|~
name|IFF_UP
expr_stmt|;
name|ifp
operator|->
name|if_drv_flags
operator|&=
operator|~
name|IFF_DRV_RUNNING
expr_stmt|;
name|callout_stop
argument_list|(
operator|&
name|sc
operator|->
name|vxl_callout
argument_list|)
expr_stmt|;
name|vso
operator|=
name|sc
operator|->
name|vxl_sock
expr_stmt|;
name|sc
operator|->
name|vxl_sock
operator|=
name|NULL
expr_stmt|;
name|VXLAN_WUNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|vso
operator|!=
name|NULL
condition|)
block|{
name|vxlan_socket_remove_softc
argument_list|(
name|vso
argument_list|,
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vxl_vso_mc_index
operator|!=
operator|-
literal|1
condition|)
block|{
name|vxlan_socket_mc_release_group_by_idx
argument_list|(
name|vso
argument_list|,
name|sc
operator|->
name|vxl_vso_mc_index
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vxl_vso_mc_index
operator|=
operator|-
literal|1
expr_stmt|;
block|}
block|}
name|VXLAN_WLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
while|while
condition|(
name|sc
operator|->
name|vxl_refcnt
operator|!=
literal|0
condition|)
name|rm_sleep
argument_list|(
name|sc
argument_list|,
operator|&
name|sc
operator|->
name|vxl_lock
argument_list|,
literal|0
argument_list|,
literal|"vxldrn"
argument_list|,
name|hz
argument_list|)
expr_stmt|;
name|VXLAN_WUNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|callout_drain
argument_list|(
operator|&
name|sc
operator|->
name|vxl_callout
argument_list|)
expr_stmt|;
name|vxlan_free_multicast
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|vso
operator|!=
name|NULL
condition|)
name|vxlan_socket_release
argument_list|(
name|vso
argument_list|)
expr_stmt|;
name|vxlan_teardown_complete
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_teardown
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|)
block|{
name|VXLAN_WLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vxl_flags
operator|&
name|VXLAN_FLAG_TEARDOWN
condition|)
block|{
name|vxlan_teardown_wait
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|VXLAN_WUNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
name|sc
operator|->
name|vxl_flags
operator||=
name|VXLAN_FLAG_TEARDOWN
expr_stmt|;
name|vxlan_teardown_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_ifdetach
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|vxlan_softc_head
modifier|*
name|list
parameter_list|)
block|{
name|VXLAN_WLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vxl_mc_ifp
operator|!=
name|ifp
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|sc
operator|->
name|vxl_flags
operator|&
name|VXLAN_FLAG_TEARDOWN
condition|)
goto|goto
name|out
goto|;
name|sc
operator|->
name|vxl_flags
operator||=
name|VXLAN_FLAG_TEARDOWN
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
name|list
argument_list|,
name|sc
argument_list|,
name|vxl_ifdetach_list
argument_list|)
expr_stmt|;
name|out
label|:
name|VXLAN_WUNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_timer
parameter_list|(
name|void
modifier|*
name|xsc
parameter_list|)
block|{
name|struct
name|vxlan_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|xsc
expr_stmt|;
name|VXLAN_LOCK_WASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|vxlan_ftable_expire
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|callout_schedule
argument_list|(
operator|&
name|sc
operator|->
name|vxl_callout
argument_list|,
name|vxlan_ftable_prune_period
operator|*
name|hz
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_ioctl_ifflags
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vxl_ifp
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
name|vxlan_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
name|vxlan_teardown
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_ctrl_get_config
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|rm_priotracker
name|tracker
decl_stmt|;
name|struct
name|ifvxlancfg
modifier|*
name|cfg
decl_stmt|;
name|cfg
operator|=
name|arg
expr_stmt|;
name|bzero
argument_list|(
name|cfg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cfg
argument_list|)
argument_list|)
expr_stmt|;
name|VXLAN_RLOCK
argument_list|(
name|sc
argument_list|,
operator|&
name|tracker
argument_list|)
expr_stmt|;
name|cfg
operator|->
name|vxlc_vni
operator|=
name|sc
operator|->
name|vxl_vni
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|cfg
operator|->
name|vxlc_local_sa
argument_list|,
operator|&
name|sc
operator|->
name|vxl_src_addr
argument_list|,
sizeof|sizeof
argument_list|(
expr|union
name|vxlan_sockaddr
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|cfg
operator|->
name|vxlc_remote_sa
argument_list|,
operator|&
name|sc
operator|->
name|vxl_dst_addr
argument_list|,
sizeof|sizeof
argument_list|(
expr|union
name|vxlan_sockaddr
argument_list|)
argument_list|)
expr_stmt|;
name|cfg
operator|->
name|vxlc_mc_ifindex
operator|=
name|sc
operator|->
name|vxl_mc_ifindex
expr_stmt|;
name|cfg
operator|->
name|vxlc_ftable_cnt
operator|=
name|sc
operator|->
name|vxl_ftable_cnt
expr_stmt|;
name|cfg
operator|->
name|vxlc_ftable_max
operator|=
name|sc
operator|->
name|vxl_ftable_max
expr_stmt|;
name|cfg
operator|->
name|vxlc_ftable_timeout
operator|=
name|sc
operator|->
name|vxl_ftable_timeout
expr_stmt|;
name|cfg
operator|->
name|vxlc_port_min
operator|=
name|sc
operator|->
name|vxl_min_port
expr_stmt|;
name|cfg
operator|->
name|vxlc_port_max
operator|=
name|sc
operator|->
name|vxl_max_port
expr_stmt|;
name|cfg
operator|->
name|vxlc_learn
operator|=
operator|(
name|sc
operator|->
name|vxl_flags
operator|&
name|VXLAN_FLAG_LEARN
operator|)
operator|!=
literal|0
expr_stmt|;
name|cfg
operator|->
name|vxlc_ttl
operator|=
name|sc
operator|->
name|vxl_ttl
expr_stmt|;
name|VXLAN_RUNLOCK
argument_list|(
name|sc
argument_list|,
operator|&
name|tracker
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_ctrl_set_vni
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ifvxlancmd
modifier|*
name|cmd
decl_stmt|;
name|int
name|error
decl_stmt|;
name|cmd
operator|=
name|arg
expr_stmt|;
if|if
condition|(
name|vxlan_check_vni
argument_list|(
name|cmd
operator|->
name|vxlcmd_vni
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|VXLAN_WLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|vxlan_can_change_config
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|sc
operator|->
name|vxl_vni
operator|=
name|cmd
operator|->
name|vxlcmd_vni
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|error
operator|=
name|EBUSY
expr_stmt|;
name|VXLAN_WUNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_ctrl_set_local_addr
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ifvxlancmd
modifier|*
name|cmd
decl_stmt|;
name|union
name|vxlan_sockaddr
modifier|*
name|vxlsa
decl_stmt|;
name|int
name|error
decl_stmt|;
name|cmd
operator|=
name|arg
expr_stmt|;
name|vxlsa
operator|=
operator|&
name|cmd
operator|->
name|vxlcmd_sa
expr_stmt|;
if|if
condition|(
operator|!
name|VXLAN_SOCKADDR_IS_IPV46
argument_list|(
name|vxlsa
argument_list|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|vxlan_sockaddr_in_multicast
argument_list|(
name|vxlsa
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|VXLAN_WLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|vxlan_can_change_config
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|vxlan_sockaddr_in_copy
argument_list|(
operator|&
name|sc
operator|->
name|vxl_src_addr
argument_list|,
operator|&
name|vxlsa
operator|->
name|sa
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|error
operator|=
name|EBUSY
expr_stmt|;
name|VXLAN_WUNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_ctrl_set_remote_addr
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ifvxlancmd
modifier|*
name|cmd
decl_stmt|;
name|union
name|vxlan_sockaddr
modifier|*
name|vxlsa
decl_stmt|;
name|int
name|error
decl_stmt|;
name|cmd
operator|=
name|arg
expr_stmt|;
name|vxlsa
operator|=
operator|&
name|cmd
operator|->
name|vxlcmd_sa
expr_stmt|;
if|if
condition|(
operator|!
name|VXLAN_SOCKADDR_IS_IPV46
argument_list|(
name|vxlsa
argument_list|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|VXLAN_WLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|vxlan_can_change_config
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|vxlan_sockaddr_in_copy
argument_list|(
operator|&
name|sc
operator|->
name|vxl_dst_addr
argument_list|,
operator|&
name|vxlsa
operator|->
name|sa
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|error
operator|=
name|EBUSY
expr_stmt|;
name|VXLAN_WUNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_ctrl_set_local_port
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ifvxlancmd
modifier|*
name|cmd
decl_stmt|;
name|int
name|error
decl_stmt|;
name|cmd
operator|=
name|arg
expr_stmt|;
if|if
condition|(
name|cmd
operator|->
name|vxlcmd_port
operator|==
literal|0
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|VXLAN_WLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|vxlan_can_change_config
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|sc
operator|->
name|vxl_src_addr
operator|.
name|in4
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|cmd
operator|->
name|vxlcmd_port
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|error
operator|=
name|EBUSY
expr_stmt|;
name|VXLAN_WUNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_ctrl_set_remote_port
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ifvxlancmd
modifier|*
name|cmd
decl_stmt|;
name|int
name|error
decl_stmt|;
name|cmd
operator|=
name|arg
expr_stmt|;
if|if
condition|(
name|cmd
operator|->
name|vxlcmd_port
operator|==
literal|0
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|VXLAN_WLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|vxlan_can_change_config
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|sc
operator|->
name|vxl_dst_addr
operator|.
name|in4
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|cmd
operator|->
name|vxlcmd_port
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|error
operator|=
name|EBUSY
expr_stmt|;
name|VXLAN_WUNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_ctrl_set_port_range
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ifvxlancmd
modifier|*
name|cmd
decl_stmt|;
name|uint16_t
name|min
decl_stmt|,
name|max
decl_stmt|;
name|int
name|error
decl_stmt|;
name|cmd
operator|=
name|arg
expr_stmt|;
name|min
operator|=
name|cmd
operator|->
name|vxlcmd_port_min
expr_stmt|;
name|max
operator|=
name|cmd
operator|->
name|vxlcmd_port_max
expr_stmt|;
if|if
condition|(
name|max
operator|<
name|min
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|VXLAN_WLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|vxlan_can_change_config
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|sc
operator|->
name|vxl_min_port
operator|=
name|min
expr_stmt|;
name|sc
operator|->
name|vxl_max_port
operator|=
name|max
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|error
operator|=
name|EBUSY
expr_stmt|;
name|VXLAN_WUNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_ctrl_set_ftable_timeout
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ifvxlancmd
modifier|*
name|cmd
decl_stmt|;
name|int
name|error
decl_stmt|;
name|cmd
operator|=
name|arg
expr_stmt|;
name|VXLAN_WLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|vxlan_check_ftable_timeout
argument_list|(
name|cmd
operator|->
name|vxlcmd_ftable_timeout
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|vxl_ftable_timeout
operator|=
name|cmd
operator|->
name|vxlcmd_ftable_timeout
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|error
operator|=
name|EINVAL
expr_stmt|;
name|VXLAN_WUNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_ctrl_set_ftable_max
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ifvxlancmd
modifier|*
name|cmd
decl_stmt|;
name|int
name|error
decl_stmt|;
name|cmd
operator|=
name|arg
expr_stmt|;
name|VXLAN_WLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|vxlan_check_ftable_max
argument_list|(
name|cmd
operator|->
name|vxlcmd_ftable_max
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|vxl_ftable_max
operator|=
name|cmd
operator|->
name|vxlcmd_ftable_max
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|error
operator|=
name|EINVAL
expr_stmt|;
name|VXLAN_WUNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_ctrl_set_multicast_if
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ifvxlancmd
modifier|*
name|cmd
decl_stmt|;
name|int
name|error
decl_stmt|;
name|cmd
operator|=
name|arg
expr_stmt|;
name|VXLAN_WLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|vxlan_can_change_config
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|strlcpy
argument_list|(
name|sc
operator|->
name|vxl_mc_ifname
argument_list|,
name|cmd
operator|->
name|vxlcmd_ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|error
operator|=
name|EBUSY
expr_stmt|;
name|VXLAN_WUNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_ctrl_set_ttl
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ifvxlancmd
modifier|*
name|cmd
decl_stmt|;
name|int
name|error
decl_stmt|;
name|cmd
operator|=
name|arg
expr_stmt|;
name|VXLAN_WLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|vxlan_check_ttl
argument_list|(
name|cmd
operator|->
name|vxlcmd_ttl
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sc
operator|->
name|vxl_ttl
operator|=
name|cmd
operator|->
name|vxlcmd_ttl
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vxl_im4o
operator|!=
name|NULL
condition|)
name|sc
operator|->
name|vxl_im4o
operator|->
name|imo_multicast_ttl
operator|=
name|sc
operator|->
name|vxl_ttl
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vxl_im6o
operator|!=
name|NULL
condition|)
name|sc
operator|->
name|vxl_im6o
operator|->
name|im6o_multicast_hlim
operator|=
name|sc
operator|->
name|vxl_ttl
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|error
operator|=
name|EINVAL
expr_stmt|;
name|VXLAN_WUNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_ctrl_set_learn
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ifvxlancmd
modifier|*
name|cmd
decl_stmt|;
name|cmd
operator|=
name|arg
expr_stmt|;
name|VXLAN_WLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|->
name|vxlcmd_flags
operator|&
name|VXLAN_CMD_FLAG_LEARN
condition|)
name|sc
operator|->
name|vxl_flags
operator||=
name|VXLAN_FLAG_LEARN
expr_stmt|;
else|else
name|sc
operator|->
name|vxl_flags
operator|&=
operator|~
name|VXLAN_FLAG_LEARN
expr_stmt|;
name|VXLAN_WUNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_ctrl_ftable_entry_add
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|union
name|vxlan_sockaddr
name|vxlsa
decl_stmt|;
name|struct
name|ifvxlancmd
modifier|*
name|cmd
decl_stmt|;
name|struct
name|vxlan_ftable_entry
modifier|*
name|fe
decl_stmt|;
name|int
name|error
decl_stmt|;
name|cmd
operator|=
name|arg
expr_stmt|;
name|vxlsa
operator|=
name|cmd
operator|->
name|vxlcmd_sa
expr_stmt|;
if|if
condition|(
operator|!
name|VXLAN_SOCKADDR_IS_IPV46
argument_list|(
operator|&
name|vxlsa
argument_list|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|vxlan_sockaddr_in_any
argument_list|(
operator|&
name|vxlsa
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|vxlan_sockaddr_in_multicast
argument_list|(
operator|&
name|vxlsa
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
comment|/* BMV: We could support both IPv4 and IPv6 later. */
if|if
condition|(
name|vxlsa
operator|.
name|sa
operator|.
name|sa_family
operator|!=
name|sc
operator|->
name|vxl_dst_addr
operator|.
name|sa
operator|.
name|sa_family
condition|)
return|return
operator|(
name|EAFNOSUPPORT
operator|)
return|;
name|fe
operator|=
name|vxlan_ftable_entry_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
name|fe
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
if|if
condition|(
name|vxlsa
operator|.
name|in4
operator|.
name|sin_port
operator|==
literal|0
condition|)
name|vxlsa
operator|.
name|in4
operator|.
name|sin_port
operator|=
name|sc
operator|->
name|vxl_dst_addr
operator|.
name|in4
operator|.
name|sin_port
expr_stmt|;
name|vxlan_ftable_entry_init
argument_list|(
name|sc
argument_list|,
name|fe
argument_list|,
name|cmd
operator|->
name|vxlcmd_mac
argument_list|,
operator|&
name|vxlsa
operator|.
name|sa
argument_list|,
name|VXLAN_FE_FLAG_STATIC
argument_list|)
expr_stmt|;
name|VXLAN_WLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|error
operator|=
name|vxlan_ftable_entry_insert
argument_list|(
name|sc
argument_list|,
name|fe
argument_list|)
expr_stmt|;
name|VXLAN_WUNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|vxlan_ftable_entry_free
argument_list|(
name|fe
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_ctrl_ftable_entry_rem
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ifvxlancmd
modifier|*
name|cmd
decl_stmt|;
name|struct
name|vxlan_ftable_entry
modifier|*
name|fe
decl_stmt|;
name|int
name|error
decl_stmt|;
name|cmd
operator|=
name|arg
expr_stmt|;
name|VXLAN_WLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|fe
operator|=
name|vxlan_ftable_entry_lookup
argument_list|(
name|sc
argument_list|,
name|cmd
operator|->
name|vxlcmd_mac
argument_list|)
expr_stmt|;
if|if
condition|(
name|fe
operator|!=
name|NULL
condition|)
block|{
name|vxlan_ftable_entry_destroy
argument_list|(
name|sc
argument_list|,
name|fe
argument_list|)
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|error
operator|=
name|ENOENT
expr_stmt|;
name|VXLAN_WUNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_ctrl_flush
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ifvxlancmd
modifier|*
name|cmd
decl_stmt|;
name|int
name|all
decl_stmt|;
name|cmd
operator|=
name|arg
expr_stmt|;
name|all
operator|=
name|cmd
operator|->
name|vxlcmd_flags
operator|&
name|VXLAN_CMD_FLAG_FLUSH_ALL
expr_stmt|;
name|VXLAN_WLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|vxlan_ftable_flush
argument_list|(
name|sc
argument_list|,
name|all
argument_list|)
expr_stmt|;
name|VXLAN_WUNLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_ioctl_drvspec
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ifdrv
modifier|*
name|ifd
parameter_list|,
name|int
name|get
parameter_list|)
block|{
specifier|const
name|struct
name|vxlan_control
modifier|*
name|vc
decl_stmt|;
union|union
block|{
name|struct
name|ifvxlancfg
name|cfg
decl_stmt|;
name|struct
name|ifvxlancmd
name|cmd
decl_stmt|;
block|}
name|args
union|;
name|int
name|out
decl_stmt|,
name|error
decl_stmt|;
if|if
condition|(
name|ifd
operator|->
name|ifd_cmd
operator|>=
name|vxlan_control_table_size
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|bzero
argument_list|(
operator|&
name|args
argument_list|,
sizeof|sizeof
argument_list|(
name|args
argument_list|)
argument_list|)
expr_stmt|;
name|vc
operator|=
operator|&
name|vxlan_control_table
index|[
name|ifd
operator|->
name|ifd_cmd
index|]
expr_stmt|;
name|out
operator|=
operator|(
name|vc
operator|->
name|vxlc_flags
operator|&
name|VXLAN_CTRL_FLAG_COPYOUT
operator|)
operator|!=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|get
operator|!=
literal|0
operator|&&
name|out
operator|==
literal|0
operator|)
operator|||
operator|(
name|get
operator|==
literal|0
operator|&&
name|out
operator|!=
literal|0
operator|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|vc
operator|->
name|vxlc_flags
operator|&
name|VXLAN_CTRL_FLAG_SUSER
condition|)
block|{
name|error
operator|=
name|priv_check
argument_list|(
name|curthread
argument_list|,
name|PRIV_NET_VXLAN
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
name|ifd
operator|->
name|ifd_len
operator|!=
name|vc
operator|->
name|vxlc_argsize
operator|||
name|ifd
operator|->
name|ifd_len
operator|>
sizeof|sizeof
argument_list|(
name|args
argument_list|)
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|vc
operator|->
name|vxlc_flags
operator|&
name|VXLAN_CTRL_FLAG_COPYIN
condition|)
block|{
name|error
operator|=
name|copyin
argument_list|(
name|ifd
operator|->
name|ifd_data
argument_list|,
operator|&
name|args
argument_list|,
name|ifd
operator|->
name|ifd_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
name|error
operator|=
name|vc
operator|->
name|vxlc_func
argument_list|(
name|sc
argument_list|,
operator|&
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|vc
operator|->
name|vxlc_flags
operator|&
name|VXLAN_CTRL_FLAG_COPYOUT
condition|)
block|{
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|args
argument_list|,
name|ifd
operator|->
name|ifd_data
argument_list|,
name|ifd
operator|->
name|ifd_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_ioctl
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|u_long
name|cmd
parameter_list|,
name|caddr_t
name|data
parameter_list|)
block|{
name|struct
name|vxlan_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
decl_stmt|;
name|struct
name|ifdrv
modifier|*
name|ifd
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|ifr
operator|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
expr_stmt|;
name|ifd
operator|=
operator|(
expr|struct
name|ifdrv
operator|*
operator|)
name|data
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SIOCADDMULTI
case|:
case|case
name|SIOCDELMULTI
case|:
name|error
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|SIOCGDRVSPEC
case|:
case|case
name|SIOCSDRVSPEC
case|:
name|error
operator|=
name|vxlan_ioctl_drvspec
argument_list|(
name|sc
argument_list|,
name|ifd
argument_list|,
name|cmd
operator|==
name|SIOCGDRVSPEC
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSIFFLAGS
case|:
name|error
operator|=
name|vxlan_ioctl_ifflags
argument_list|(
name|sc
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|ether_ioctl
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|INET
argument_list|)
operator|||
name|defined
argument_list|(
name|INET6
argument_list|)
end_if

begin_function
specifier|static
name|uint16_t
name|vxlan_pick_source_port
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|int
name|range
decl_stmt|;
name|uint32_t
name|hash
decl_stmt|;
name|range
operator|=
name|sc
operator|->
name|vxl_max_port
operator|-
name|sc
operator|->
name|vxl_min_port
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|M_HASHTYPE_GET
argument_list|(
name|m
argument_list|)
operator|!=
name|M_HASHTYPE_NONE
operator|&&
name|M_HASHTYPE_GET
argument_list|(
name|m
argument_list|)
operator|!=
name|M_HASHTYPE_OPAQUE
condition|)
name|hash
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|flowid
expr_stmt|;
else|else
name|hash
operator|=
name|jenkins_hash
argument_list|(
name|m
operator|->
name|m_data
argument_list|,
name|ETHER_HDR_LEN
argument_list|,
name|sc
operator|->
name|vxl_port_hash_key
argument_list|)
expr_stmt|;
return|return
operator|(
name|sc
operator|->
name|vxl_min_port
operator|+
operator|(
name|hash
operator|%
name|range
operator|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_encap_header
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|int
name|ipoff
parameter_list|,
name|uint16_t
name|srcport
parameter_list|,
name|uint16_t
name|dstport
parameter_list|)
block|{
name|struct
name|vxlanudphdr
modifier|*
name|hdr
decl_stmt|;
name|struct
name|udphdr
modifier|*
name|udph
decl_stmt|;
name|struct
name|vxlan_header
modifier|*
name|vxh
decl_stmt|;
name|int
name|len
decl_stmt|;
name|len
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|-
name|ipoff
expr_stmt|;
name|MPASS
argument_list|(
name|len
operator|>=
sizeof|sizeof
argument_list|(
expr|struct
name|vxlanudphdr
argument_list|)
argument_list|)
expr_stmt|;
name|hdr
operator|=
name|mtodo
argument_list|(
name|m
argument_list|,
name|ipoff
argument_list|)
expr_stmt|;
name|udph
operator|=
operator|&
name|hdr
operator|->
name|vxlh_udp
expr_stmt|;
name|udph
operator|->
name|uh_sport
operator|=
name|srcport
expr_stmt|;
name|udph
operator|->
name|uh_dport
operator|=
name|dstport
expr_stmt|;
name|udph
operator|->
name|uh_ulen
operator|=
name|htons
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|udph
operator|->
name|uh_sum
operator|=
literal|0
expr_stmt|;
name|vxh
operator|=
operator|&
name|hdr
operator|->
name|vxlh_hdr
expr_stmt|;
name|vxh
operator|->
name|vxlh_flags
operator|=
name|htonl
argument_list|(
name|VXLAN_HDR_FLAGS_VALID_VNI
argument_list|)
expr_stmt|;
name|vxh
operator|->
name|vxlh_vni
operator|=
name|htonl
argument_list|(
name|sc
operator|->
name|vxl_vni
operator|<<
name|VXLAN_HDR_VNI_SHIFT
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|vxlan_encap4
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
name|fvxlsa
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|INET
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
name|struct
name|in_addr
name|srcaddr
decl_stmt|,
name|dstaddr
decl_stmt|;
name|uint16_t
name|srcport
decl_stmt|,
name|dstport
decl_stmt|;
name|int
name|len
decl_stmt|,
name|mcast
decl_stmt|,
name|error
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vxl_ifp
expr_stmt|;
name|srcaddr
operator|=
name|sc
operator|->
name|vxl_src_addr
operator|.
name|in4
operator|.
name|sin_addr
expr_stmt|;
name|srcport
operator|=
name|vxlan_pick_source_port
argument_list|(
name|sc
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|dstaddr
operator|=
name|fvxlsa
operator|->
name|in4
operator|.
name|sin_addr
expr_stmt|;
name|dstport
operator|=
name|fvxlsa
operator|->
name|in4
operator|.
name|sin_port
expr_stmt|;
name|M_PREPEND
argument_list|(
name|m
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|vxlanudphdr
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
name|len
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
name|ip
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ip
operator|*
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_tos
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|ip_len
operator|=
name|htons
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ip_off
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|ip_ttl
operator|=
name|sc
operator|->
name|vxl_ttl
expr_stmt|;
name|ip
operator|->
name|ip_p
operator|=
name|IPPROTO_UDP
expr_stmt|;
name|ip
operator|->
name|ip_sum
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|ip_src
operator|=
name|srcaddr
expr_stmt|;
name|ip
operator|->
name|ip_dst
operator|=
name|dstaddr
expr_stmt|;
name|vxlan_encap_header
argument_list|(
name|sc
argument_list|,
name|m
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
argument_list|,
name|srcport
argument_list|,
name|dstport
argument_list|)
expr_stmt|;
name|mcast
operator|=
operator|(
name|m
operator|->
name|m_flags
operator|&
operator|(
name|M_MCAST
operator||
name|M_BCAST
operator|)
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|m
operator|->
name|m_flags
operator|&=
operator|~
operator|(
name|M_MCAST
operator||
name|M_BCAST
operator|)
expr_stmt|;
name|error
operator|=
name|ip_output
argument_list|(
name|m
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|vxl_im4o
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OPACKETS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OBYTES
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|mcast
operator|!=
literal|0
condition|)
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OMCASTS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
else|#
directive|else
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOTSUP
operator|)
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_encap6
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
name|fvxlsa
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|INET6
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|ip6_hdr
modifier|*
name|ip6
decl_stmt|;
specifier|const
name|struct
name|in6_addr
modifier|*
name|srcaddr
decl_stmt|,
modifier|*
name|dstaddr
decl_stmt|;
name|uint16_t
name|srcport
decl_stmt|,
name|dstport
decl_stmt|;
name|int
name|len
decl_stmt|,
name|mcast
decl_stmt|,
name|error
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vxl_ifp
expr_stmt|;
name|srcaddr
operator|=
operator|&
name|sc
operator|->
name|vxl_src_addr
operator|.
name|in6
operator|.
name|sin6_addr
expr_stmt|;
name|srcport
operator|=
name|vxlan_pick_source_port
argument_list|(
name|sc
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|dstaddr
operator|=
operator|&
name|fvxlsa
operator|->
name|in6
operator|.
name|sin6_addr
expr_stmt|;
name|dstport
operator|=
name|fvxlsa
operator|->
name|in6
operator|.
name|sin6_port
expr_stmt|;
name|M_PREPEND
argument_list|(
name|m
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|vxlanudphdr
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOBUFS
operator|)
return|;
block|}
name|len
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|len
expr_stmt|;
name|ip6
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ip6_hdr
operator|*
argument_list|)
expr_stmt|;
name|ip6
operator|->
name|ip6_flow
operator|=
literal|0
expr_stmt|;
comment|/* BMV: Keep in forwarding entry? */
name|ip6
operator|->
name|ip6_vfc
operator|=
name|IPV6_VERSION
expr_stmt|;
name|ip6
operator|->
name|ip6_plen
operator|=
literal|0
expr_stmt|;
name|ip6
operator|->
name|ip6_nxt
operator|=
name|IPPROTO_UDP
expr_stmt|;
name|ip6
operator|->
name|ip6_hlim
operator|=
name|sc
operator|->
name|vxl_ttl
expr_stmt|;
name|ip6
operator|->
name|ip6_src
operator|=
operator|*
name|srcaddr
expr_stmt|;
name|ip6
operator|->
name|ip6_dst
operator|=
operator|*
name|dstaddr
expr_stmt|;
name|vxlan_encap_header
argument_list|(
name|sc
argument_list|,
name|m
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
argument_list|,
name|srcport
argument_list|,
name|dstport
argument_list|)
expr_stmt|;
comment|/* 	 * XXX BMV We need support for RFC6935 before we can send and 	 * receive IPv6 UDP packets with a zero checksum. 	 */
block|{
name|struct
name|udphdr
modifier|*
name|hdr
init|=
name|mtodo
argument_list|(
name|m
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
argument_list|)
decl_stmt|;
name|hdr
operator|->
name|uh_sum
operator|=
name|in6_cksum_pseudo
argument_list|(
name|ip6
argument_list|,
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
argument_list|,
name|IPPROTO_UDP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|=
name|CSUM_UDP_IPV6
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_data
operator|=
name|offsetof
argument_list|(
expr|struct
name|udphdr
argument_list|,
name|uh_sum
argument_list|)
expr_stmt|;
block|}
name|mcast
operator|=
operator|(
name|m
operator|->
name|m_flags
operator|&
operator|(
name|M_MCAST
operator||
name|M_BCAST
operator|)
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|m
operator|->
name|m_flags
operator|&=
operator|~
operator|(
name|M_MCAST
operator||
name|M_BCAST
operator|)
expr_stmt|;
name|error
operator|=
name|ip6_output
argument_list|(
name|m
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|vxl_im6o
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OPACKETS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OBYTES
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|mcast
operator|!=
literal|0
condition|)
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OMCASTS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|if_inc_counter
argument_list|(
name|ifp
argument_list|,
name|IFCOUNTER_OERRORS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
else|#
directive|else
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOTSUP
operator|)
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_transmit
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|rm_priotracker
name|tracker
decl_stmt|;
name|union
name|vxlan_sockaddr
name|vxlsa
decl_stmt|;
name|struct
name|vxlan_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|vxlan_ftable_entry
modifier|*
name|fe
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|mcifp
decl_stmt|;
name|struct
name|ether_header
modifier|*
name|eh
decl_stmt|;
name|int
name|ipv4
decl_stmt|,
name|error
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|eh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ether_header
operator|*
argument_list|)
expr_stmt|;
name|fe
operator|=
name|NULL
expr_stmt|;
name|mcifp
operator|=
name|NULL
expr_stmt|;
name|ETHER_BPF_MTAP
argument_list|(
name|ifp
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|VXLAN_RLOCK
argument_list|(
name|sc
argument_list|,
operator|&
name|tracker
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
block|{
name|VXLAN_RUNLOCK
argument_list|(
name|sc
argument_list|,
operator|&
name|tracker
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENETDOWN
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|m
operator|->
name|m_flags
operator|&
operator|(
name|M_BCAST
operator||
name|M_MCAST
operator|)
operator|)
operator|==
literal|0
condition|)
name|fe
operator|=
name|vxlan_ftable_entry_lookup
argument_list|(
name|sc
argument_list|,
name|eh
operator|->
name|ether_dhost
argument_list|)
expr_stmt|;
if|if
condition|(
name|fe
operator|==
name|NULL
condition|)
name|fe
operator|=
operator|&
name|sc
operator|->
name|vxl_default_fe
expr_stmt|;
name|vxlan_sockaddr_copy
argument_list|(
operator|&
name|vxlsa
argument_list|,
operator|&
name|fe
operator|->
name|vxlfe_raddr
operator|.
name|sa
argument_list|)
expr_stmt|;
name|ipv4
operator|=
name|VXLAN_SOCKADDR_IS_IPV4
argument_list|(
operator|&
name|vxlsa
argument_list|)
operator|!=
literal|0
expr_stmt|;
if|if
condition|(
name|vxlan_sockaddr_in_multicast
argument_list|(
operator|&
name|vxlsa
argument_list|)
operator|!=
literal|0
condition|)
name|mcifp
operator|=
name|vxlan_multicast_if_ref
argument_list|(
name|sc
argument_list|,
name|ipv4
argument_list|)
expr_stmt|;
name|VXLAN_ACQUIRE
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|VXLAN_RUNLOCK
argument_list|(
name|sc
argument_list|,
operator|&
name|tracker
argument_list|)
expr_stmt|;
if|if
condition|(
name|ipv4
operator|!=
literal|0
condition|)
name|error
operator|=
name|vxlan_encap4
argument_list|(
name|sc
argument_list|,
operator|&
name|vxlsa
argument_list|,
name|m
argument_list|)
expr_stmt|;
else|else
name|error
operator|=
name|vxlan_encap6
argument_list|(
name|sc
argument_list|,
operator|&
name|vxlsa
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|vxlan_release
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|mcifp
operator|!=
name|NULL
condition|)
name|if_rele
argument_list|(
name|mcifp
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_qflush
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
name|__unused
parameter_list|)
block|{ }
end_function

begin_function
specifier|static
name|void
name|vxlan_rcv_udp_packet
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|int
name|offset
parameter_list|,
name|struct
name|inpcb
modifier|*
name|inpcb
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|srcsa
parameter_list|,
name|void
modifier|*
name|xvso
parameter_list|)
block|{
name|struct
name|vxlan_socket
modifier|*
name|vso
decl_stmt|;
name|struct
name|vxlan_header
modifier|*
name|vxh
decl_stmt|,
name|vxlanhdr
decl_stmt|;
name|uint32_t
name|vni
decl_stmt|;
name|int
name|error
decl_stmt|;
name|M_ASSERTPKTHDR
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|vso
operator|=
name|xvso
expr_stmt|;
name|offset
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|udphdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|<
name|offset
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|vxlan_header
argument_list|)
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|__predict_false
argument_list|(
name|m
operator|->
name|m_len
operator|<
name|offset
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|vxlan_header
argument_list|)
argument_list|)
condition|)
block|{
name|m_copydata
argument_list|(
name|m
argument_list|,
name|offset
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|vxlan_header
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|vxlanhdr
argument_list|)
expr_stmt|;
name|vxh
operator|=
operator|&
name|vxlanhdr
expr_stmt|;
block|}
else|else
name|vxh
operator|=
name|mtodo
argument_list|(
name|m
argument_list|,
name|offset
argument_list|)
expr_stmt|;
comment|/* 	 * Drop if there is a reserved bit set in either the flags or VNI 	 * fields of the header. This goes against the specification, but 	 * a bit set may indicate an unsupported new feature. This matches 	 * the behavior of the Linux implementation. 	 */
if|if
condition|(
name|vxh
operator|->
name|vxlh_flags
operator|!=
name|htonl
argument_list|(
name|VXLAN_HDR_FLAGS_VALID_VNI
argument_list|)
operator|||
name|vxh
operator|->
name|vxlh_vni
operator|&
operator|~
name|htonl
argument_list|(
name|VXLAN_VNI_MASK
argument_list|)
condition|)
goto|goto
name|out
goto|;
name|vni
operator|=
name|ntohl
argument_list|(
name|vxh
operator|->
name|vxlh_vni
argument_list|)
operator|>>
name|VXLAN_HDR_VNI_SHIFT
expr_stmt|;
comment|/* Adjust to the start of the inner Ethernet frame. */
name|m_adj
argument_list|(
name|m
argument_list|,
name|offset
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|vxlan_header
argument_list|)
argument_list|)
expr_stmt|;
name|error
operator|=
name|vxlan_input
argument_list|(
name|vso
argument_list|,
name|vni
argument_list|,
operator|&
name|m
argument_list|,
name|srcsa
argument_list|)
expr_stmt|;
name|MPASS
argument_list|(
name|error
operator|!=
literal|0
operator|||
name|m
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|out
label|:
if|if
condition|(
name|m
operator|!=
name|NULL
condition|)
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_input
parameter_list|(
name|struct
name|vxlan_socket
modifier|*
name|vso
parameter_list|,
name|uint32_t
name|vni
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|m0
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|sa
parameter_list|)
block|{
name|struct
name|vxlan_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|struct
name|ether_header
modifier|*
name|eh
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
name|vxlan_socket_lookup_softc
argument_list|(
name|vso
argument_list|,
name|vni
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOENT
operator|)
return|;
name|ifp
operator|=
name|sc
operator|->
name|vxl_ifp
expr_stmt|;
name|m
operator|=
operator|*
name|m0
expr_stmt|;
name|eh
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ether_header
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
operator|)
operator|==
literal|0
condition|)
block|{
name|error
operator|=
name|ENETDOWN
expr_stmt|;
goto|goto
name|out
goto|;
block|}
elseif|else
if|if
condition|(
name|ifp
operator|==
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
condition|)
block|{
comment|/* XXX Does not catch more complex loops. */
name|error
operator|=
name|EDEADLK
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|sc
operator|->
name|vxl_flags
operator|&
name|VXLAN_FLAG_LEARN
condition|)
name|vxlan_ftable_update
argument_list|(
name|sc
argument_list|,
name|sa
argument_list|,
name|eh
operator|->
name|ether_shost
argument_list|)
expr_stmt|;
name|m_clrprotoflags
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|ifp
expr_stmt|;
name|M_SETFIB
argument_list|(
name|m
argument_list|,
name|ifp
operator|->
name|if_fib
argument_list|)
expr_stmt|;
name|error
operator|=
name|netisr_queue_src
argument_list|(
name|NETISR_ETHER
argument_list|,
literal|0
argument_list|,
name|m
argument_list|)
expr_stmt|;
operator|*
name|m0
operator|=
name|NULL
expr_stmt|;
name|out
label|:
name|vxlan_release
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_set_default_config
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|)
block|{
name|sc
operator|->
name|vxl_flags
operator||=
name|VXLAN_FLAG_LEARN
expr_stmt|;
name|sc
operator|->
name|vxl_vni
operator|=
name|VXLAN_VNI_MAX
expr_stmt|;
name|sc
operator|->
name|vxl_ttl
operator|=
name|IPDEFTTL
expr_stmt|;
if|if
condition|(
operator|!
name|vxlan_tunable_int
argument_list|(
name|sc
argument_list|,
literal|"legacy_port"
argument_list|,
name|vxlan_legacy_port
argument_list|)
condition|)
block|{
name|sc
operator|->
name|vxl_src_addr
operator|.
name|in4
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|VXLAN_PORT
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vxl_dst_addr
operator|.
name|in4
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|VXLAN_PORT
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sc
operator|->
name|vxl_src_addr
operator|.
name|in4
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|VXLAN_LEGACY_PORT
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vxl_dst_addr
operator|.
name|in4
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|VXLAN_LEGACY_PORT
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|vxl_min_port
operator|=
name|V_ipport_firstauto
expr_stmt|;
name|sc
operator|->
name|vxl_max_port
operator|=
name|V_ipport_lastauto
expr_stmt|;
name|sc
operator|->
name|vxl_ftable_max
operator|=
name|VXLAN_FTABLE_MAX
expr_stmt|;
name|sc
operator|->
name|vxl_ftable_timeout
operator|=
name|VXLAN_FTABLE_TIMEOUT
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_set_user_config
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
name|struct
name|ifvxlanparam
modifier|*
name|vxlp
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|INET
if|if
condition|(
name|vxlp
operator|->
name|vxlp_with
operator|&
operator|(
name|VXLAN_PARAM_WITH_LOCAL_ADDR4
operator||
name|VXLAN_PARAM_WITH_REMOTE_ADDR4
operator|)
condition|)
return|return
operator|(
name|EAFNOSUPPORT
operator|)
return|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|INET6
if|if
condition|(
name|vxlp
operator|->
name|vxlp_with
operator|&
operator|(
name|VXLAN_PARAM_WITH_LOCAL_ADDR6
operator||
name|VXLAN_PARAM_WITH_REMOTE_ADDR6
operator|)
condition|)
return|return
operator|(
name|EAFNOSUPPORT
operator|)
return|;
endif|#
directive|endif
if|if
condition|(
name|vxlp
operator|->
name|vxlp_with
operator|&
name|VXLAN_PARAM_WITH_VNI
condition|)
block|{
if|if
condition|(
name|vxlan_check_vni
argument_list|(
name|vxlp
operator|->
name|vxlp_vni
argument_list|)
operator|==
literal|0
condition|)
name|sc
operator|->
name|vxl_vni
operator|=
name|vxlp
operator|->
name|vxlp_vni
expr_stmt|;
block|}
if|if
condition|(
name|vxlp
operator|->
name|vxlp_with
operator|&
name|VXLAN_PARAM_WITH_LOCAL_ADDR4
condition|)
block|{
name|sc
operator|->
name|vxl_src_addr
operator|.
name|in4
operator|.
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vxl_src_addr
operator|.
name|in4
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|sc
operator|->
name|vxl_src_addr
operator|.
name|in4
operator|.
name|sin_addr
operator|=
name|vxlp
operator|->
name|vxlp_local_in4
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|vxlp
operator|->
name|vxlp_with
operator|&
name|VXLAN_PARAM_WITH_LOCAL_ADDR6
condition|)
block|{
name|sc
operator|->
name|vxl_src_addr
operator|.
name|in6
operator|.
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vxl_src_addr
operator|.
name|in6
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|sc
operator|->
name|vxl_src_addr
operator|.
name|in6
operator|.
name|sin6_addr
operator|=
name|vxlp
operator|->
name|vxlp_local_in6
expr_stmt|;
block|}
if|if
condition|(
name|vxlp
operator|->
name|vxlp_with
operator|&
name|VXLAN_PARAM_WITH_REMOTE_ADDR4
condition|)
block|{
name|sc
operator|->
name|vxl_dst_addr
operator|.
name|in4
operator|.
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vxl_dst_addr
operator|.
name|in4
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|sc
operator|->
name|vxl_dst_addr
operator|.
name|in4
operator|.
name|sin_addr
operator|=
name|vxlp
operator|->
name|vxlp_remote_in4
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|vxlp
operator|->
name|vxlp_with
operator|&
name|VXLAN_PARAM_WITH_REMOTE_ADDR6
condition|)
block|{
name|sc
operator|->
name|vxl_dst_addr
operator|.
name|in6
operator|.
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vxl_dst_addr
operator|.
name|in6
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|sc
operator|->
name|vxl_dst_addr
operator|.
name|in6
operator|.
name|sin6_addr
operator|=
name|vxlp
operator|->
name|vxlp_remote_in6
expr_stmt|;
block|}
if|if
condition|(
name|vxlp
operator|->
name|vxlp_with
operator|&
name|VXLAN_PARAM_WITH_LOCAL_PORT
condition|)
name|sc
operator|->
name|vxl_src_addr
operator|.
name|in4
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|vxlp
operator|->
name|vxlp_local_port
argument_list|)
expr_stmt|;
if|if
condition|(
name|vxlp
operator|->
name|vxlp_with
operator|&
name|VXLAN_PARAM_WITH_REMOTE_PORT
condition|)
name|sc
operator|->
name|vxl_dst_addr
operator|.
name|in4
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|vxlp
operator|->
name|vxlp_remote_port
argument_list|)
expr_stmt|;
if|if
condition|(
name|vxlp
operator|->
name|vxlp_with
operator|&
name|VXLAN_PARAM_WITH_PORT_RANGE
condition|)
block|{
if|if
condition|(
name|vxlp
operator|->
name|vxlp_min_port
operator|<=
name|vxlp
operator|->
name|vxlp_max_port
condition|)
block|{
name|sc
operator|->
name|vxl_min_port
operator|=
name|vxlp
operator|->
name|vxlp_min_port
expr_stmt|;
name|sc
operator|->
name|vxl_max_port
operator|=
name|vxlp
operator|->
name|vxlp_max_port
expr_stmt|;
block|}
block|}
if|if
condition|(
name|vxlp
operator|->
name|vxlp_with
operator|&
name|VXLAN_PARAM_WITH_MULTICAST_IF
condition|)
name|strlcpy
argument_list|(
name|sc
operator|->
name|vxl_mc_ifname
argument_list|,
name|vxlp
operator|->
name|vxlp_mc_ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|vxlp
operator|->
name|vxlp_with
operator|&
name|VXLAN_PARAM_WITH_FTABLE_TIMEOUT
condition|)
block|{
if|if
condition|(
name|vxlan_check_ftable_timeout
argument_list|(
name|vxlp
operator|->
name|vxlp_ftable_timeout
argument_list|)
operator|==
literal|0
condition|)
name|sc
operator|->
name|vxl_ftable_timeout
operator|=
name|vxlp
operator|->
name|vxlp_ftable_timeout
expr_stmt|;
block|}
if|if
condition|(
name|vxlp
operator|->
name|vxlp_with
operator|&
name|VXLAN_PARAM_WITH_FTABLE_MAX
condition|)
block|{
if|if
condition|(
name|vxlan_check_ftable_max
argument_list|(
name|vxlp
operator|->
name|vxlp_ftable_max
argument_list|)
operator|==
literal|0
condition|)
name|sc
operator|->
name|vxl_ftable_max
operator|=
name|vxlp
operator|->
name|vxlp_ftable_max
expr_stmt|;
block|}
if|if
condition|(
name|vxlp
operator|->
name|vxlp_with
operator|&
name|VXLAN_PARAM_WITH_TTL
condition|)
block|{
if|if
condition|(
name|vxlan_check_ttl
argument_list|(
name|vxlp
operator|->
name|vxlp_ttl
argument_list|)
operator|==
literal|0
condition|)
name|sc
operator|->
name|vxl_ttl
operator|=
name|vxlp
operator|->
name|vxlp_ttl
expr_stmt|;
block|}
if|if
condition|(
name|vxlp
operator|->
name|vxlp_with
operator|&
name|VXLAN_PARAM_WITH_LEARN
condition|)
block|{
if|if
condition|(
name|vxlp
operator|->
name|vxlp_learn
operator|==
literal|0
condition|)
name|sc
operator|->
name|vxl_flags
operator|&=
operator|~
name|VXLAN_FLAG_LEARN
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_clone_create
parameter_list|(
name|struct
name|if_clone
modifier|*
name|ifc
parameter_list|,
name|int
name|unit
parameter_list|,
name|caddr_t
name|params
parameter_list|)
block|{
name|struct
name|vxlan_softc
modifier|*
name|sc
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|ifvxlanparam
name|vxlp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|sc
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|vxlan_softc
argument_list|)
argument_list|,
name|M_VXLAN
argument_list|,
name|M_WAITOK
operator||
name|M_ZERO
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vxl_unit
operator|=
name|unit
expr_stmt|;
name|vxlan_set_default_config
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|!=
literal|0
condition|)
block|{
name|error
operator|=
name|copyin
argument_list|(
name|params
argument_list|,
operator|&
name|vxlp
argument_list|,
sizeof|sizeof
argument_list|(
name|vxlp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
name|error
operator|=
name|vxlan_set_user_config
argument_list|(
name|sc
argument_list|,
operator|&
name|vxlp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|fail
goto|;
block|}
name|ifp
operator|=
name|if_alloc
argument_list|(
name|IFT_ETHER
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOSPC
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|sc
operator|->
name|vxl_ifp
operator|=
name|ifp
expr_stmt|;
name|rm_init
argument_list|(
operator|&
name|sc
operator|->
name|vxl_lock
argument_list|,
literal|"vxlanrm"
argument_list|)
expr_stmt|;
name|callout_init_rw
argument_list|(
operator|&
name|sc
operator|->
name|vxl_callout
argument_list|,
operator|&
name|sc
operator|->
name|vxl_lock
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vxl_port_hash_key
operator|=
name|arc4random
argument_list|()
expr_stmt|;
name|vxlan_ftable_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|vxlan_sysctl_setup
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_softc
operator|=
name|sc
expr_stmt|;
name|if_initname
argument_list|(
name|ifp
argument_list|,
name|vxlan_name
argument_list|,
name|unit
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_SIMPLEX
operator||
name|IFF_MULTICAST
expr_stmt|;
name|ifp
operator|->
name|if_init
operator|=
name|vxlan_init
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|vxlan_ioctl
expr_stmt|;
name|ifp
operator|->
name|if_transmit
operator|=
name|vxlan_transmit
expr_stmt|;
name|ifp
operator|->
name|if_qflush
operator|=
name|vxlan_qflush
expr_stmt|;
name|vxlan_fakeaddr
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ether_ifattach
argument_list|(
name|ifp
argument_list|,
name|sc
operator|->
name|vxl_hwaddr
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_baudrate
operator|=
literal|0
expr_stmt|;
name|ifp
operator|->
name|if_hdrlen
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
name|fail
label|:
name|free
argument_list|(
name|sc
argument_list|,
name|M_VXLAN
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_clone_destroy
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|vxlan_softc
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|ifp
operator|->
name|if_softc
expr_stmt|;
name|vxlan_teardown
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|vxlan_ftable_flush
argument_list|(
name|sc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ether_ifdetach
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|if_free
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|vxlan_ftable_fini
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|vxlan_sysctl_destroy
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|rm_destroy
argument_list|(
operator|&
name|sc
operator|->
name|vxl_lock
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sc
argument_list|,
name|M_VXLAN
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* BMV: Taken from if_bridge. */
end_comment

begin_function
specifier|static
name|uint32_t
name|vxlan_mac_hash
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|addr
parameter_list|)
block|{
name|uint32_t
name|a
init|=
literal|0x9e3779b9
decl_stmt|,
name|b
init|=
literal|0x9e3779b9
decl_stmt|,
name|c
init|=
name|sc
operator|->
name|vxl_ftable_hash_key
decl_stmt|;
name|b
operator|+=
name|addr
index|[
literal|5
index|]
operator|<<
literal|8
expr_stmt|;
name|b
operator|+=
name|addr
index|[
literal|4
index|]
expr_stmt|;
name|a
operator|+=
name|addr
index|[
literal|3
index|]
operator|<<
literal|24
expr_stmt|;
name|a
operator|+=
name|addr
index|[
literal|2
index|]
operator|<<
literal|16
expr_stmt|;
name|a
operator|+=
name|addr
index|[
literal|1
index|]
operator|<<
literal|8
expr_stmt|;
name|a
operator|+=
name|addr
index|[
literal|0
index|]
expr_stmt|;
comment|/*  * The following hash function is adapted from "Hash Functions" by Bob Jenkins  * ("Algorithm Alley", Dr. Dobbs Journal, September 1997).  */
define|#
directive|define
name|mix
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|,
name|c
parameter_list|)
define|\
value|do {									\ 	a -= b; a -= c; a ^= (c>> 13);					\ 	b -= c; b -= a; b ^= (a<< 8);					\ 	c -= a; c -= b; c ^= (b>> 13);					\ 	a -= b; a -= c; a ^= (c>> 12);					\ 	b -= c; b -= a; b ^= (a<< 16);					\ 	c -= a; c -= b; c ^= (b>> 5);					\ 	a -= b; a -= c; a ^= (c>> 3);					\ 	b -= c; b -= a; b ^= (a<< 10);					\ 	c -= a; c -= b; c ^= (b>> 15);					\ } while (0)
name|mix
argument_list|(
name|a
argument_list|,
name|b
argument_list|,
name|c
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|mix
return|return
operator|(
name|c
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_fakeaddr
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|)
block|{
comment|/* 	 * Generate a non-multicast, locally administered address. 	 * 	 * BMV: Should we use the FreeBSD OUI range instead? 	 */
name|arc4rand
argument_list|(
name|sc
operator|->
name|vxl_hwaddr
argument_list|,
name|ETHER_ADDR_LEN
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vxl_hwaddr
index|[
literal|0
index|]
operator|&=
operator|~
literal|1
expr_stmt|;
name|sc
operator|->
name|vxl_hwaddr
index|[
literal|0
index|]
operator||=
literal|2
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_sockaddr_cmp
parameter_list|(
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
name|vxladdr
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|sa
parameter_list|)
block|{
return|return
operator|(
name|bcmp
argument_list|(
operator|&
name|vxladdr
operator|->
name|sa
argument_list|,
name|sa
argument_list|,
name|vxladdr
operator|->
name|sa
operator|.
name|sa_len
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_sockaddr_copy
parameter_list|(
name|union
name|vxlan_sockaddr
modifier|*
name|vxladdr
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|sa
parameter_list|)
block|{
name|MPASS
argument_list|(
name|sa
operator|->
name|sa_family
operator|==
name|AF_INET
operator|||
name|sa
operator|->
name|sa_family
operator|==
name|AF_INET6
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|vxladdr
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|vxladdr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sa
operator|->
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
name|vxladdr
operator|->
name|in4
operator|=
operator|*
name|satoconstsin
argument_list|(
name|sa
argument_list|)
expr_stmt|;
name|vxladdr
operator|->
name|in4
operator|.
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sa
operator|->
name|sa_family
operator|==
name|AF_INET6
condition|)
block|{
name|vxladdr
operator|->
name|in6
operator|=
operator|*
name|satoconstsin6
argument_list|(
name|sa
argument_list|)
expr_stmt|;
name|vxladdr
operator|->
name|in6
operator|.
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_sockaddr_in_equal
parameter_list|(
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
name|vxladdr
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|sa
parameter_list|)
block|{
name|int
name|equal
decl_stmt|;
if|if
condition|(
name|sa
operator|->
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
specifier|const
name|struct
name|in_addr
modifier|*
name|in4
init|=
operator|&
name|satoconstsin
argument_list|(
name|sa
argument_list|)
operator|->
name|sin_addr
decl_stmt|;
name|equal
operator|=
name|in4
operator|->
name|s_addr
operator|==
name|vxladdr
operator|->
name|in4
operator|.
name|sin_addr
operator|.
name|s_addr
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sa
operator|->
name|sa_family
operator|==
name|AF_INET6
condition|)
block|{
specifier|const
name|struct
name|in6_addr
modifier|*
name|in6
init|=
operator|&
name|satoconstsin6
argument_list|(
name|sa
argument_list|)
operator|->
name|sin6_addr
decl_stmt|;
name|equal
operator|=
name|IN6_ARE_ADDR_EQUAL
argument_list|(
name|in6
argument_list|,
operator|&
name|vxladdr
operator|->
name|in6
operator|.
name|sin6_addr
argument_list|)
expr_stmt|;
block|}
else|else
name|equal
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|equal
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_sockaddr_in_copy
parameter_list|(
name|union
name|vxlan_sockaddr
modifier|*
name|vxladdr
parameter_list|,
specifier|const
name|struct
name|sockaddr
modifier|*
name|sa
parameter_list|)
block|{
name|MPASS
argument_list|(
name|sa
operator|->
name|sa_family
operator|==
name|AF_INET
operator|||
name|sa
operator|->
name|sa_family
operator|==
name|AF_INET6
argument_list|)
expr_stmt|;
if|if
condition|(
name|sa
operator|->
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
specifier|const
name|struct
name|in_addr
modifier|*
name|in4
init|=
operator|&
name|satoconstsin
argument_list|(
name|sa
argument_list|)
operator|->
name|sin_addr
decl_stmt|;
name|vxladdr
operator|->
name|in4
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|vxladdr
operator|->
name|in4
operator|.
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
name|vxladdr
operator|->
name|in4
operator|.
name|sin_addr
operator|=
operator|*
name|in4
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sa
operator|->
name|sa_family
operator|==
name|AF_INET6
condition|)
block|{
specifier|const
name|struct
name|in6_addr
modifier|*
name|in6
init|=
operator|&
name|satoconstsin6
argument_list|(
name|sa
argument_list|)
operator|->
name|sin6_addr
decl_stmt|;
name|vxladdr
operator|->
name|in6
operator|.
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|vxladdr
operator|->
name|in6
operator|.
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in6
argument_list|)
expr_stmt|;
name|vxladdr
operator|->
name|in6
operator|.
name|sin6_addr
operator|=
operator|*
name|in6
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_sockaddr_supported
parameter_list|(
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
name|vxladdr
parameter_list|,
name|int
name|unspec
parameter_list|)
block|{
specifier|const
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
name|int
name|supported
decl_stmt|;
name|sa
operator|=
operator|&
name|vxladdr
operator|->
name|sa
expr_stmt|;
name|supported
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sa
operator|->
name|sa_family
operator|==
name|AF_UNSPEC
operator|&&
name|unspec
operator|!=
literal|0
condition|)
block|{
name|supported
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sa
operator|->
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
name|supported
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
name|sa
operator|->
name|sa_family
operator|==
name|AF_INET6
condition|)
block|{
ifdef|#
directive|ifdef
name|INET6
name|supported
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
block|}
return|return
operator|(
name|supported
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_sockaddr_in_any
parameter_list|(
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
name|vxladdr
parameter_list|)
block|{
specifier|const
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
name|int
name|any
decl_stmt|;
name|sa
operator|=
operator|&
name|vxladdr
operator|->
name|sa
expr_stmt|;
if|if
condition|(
name|sa
operator|->
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
specifier|const
name|struct
name|in_addr
modifier|*
name|in4
init|=
operator|&
name|satoconstsin
argument_list|(
name|sa
argument_list|)
operator|->
name|sin_addr
decl_stmt|;
name|any
operator|=
name|in4
operator|->
name|s_addr
operator|==
name|INADDR_ANY
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sa
operator|->
name|sa_family
operator|==
name|AF_INET6
condition|)
block|{
specifier|const
name|struct
name|in6_addr
modifier|*
name|in6
init|=
operator|&
name|satoconstsin6
argument_list|(
name|sa
argument_list|)
operator|->
name|sin6_addr
decl_stmt|;
name|any
operator|=
name|IN6_IS_ADDR_UNSPECIFIED
argument_list|(
name|in6
argument_list|)
expr_stmt|;
block|}
else|else
name|any
operator|=
operator|-
literal|1
expr_stmt|;
return|return
operator|(
name|any
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_sockaddr_in_multicast
parameter_list|(
specifier|const
name|union
name|vxlan_sockaddr
modifier|*
name|vxladdr
parameter_list|)
block|{
specifier|const
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
name|int
name|mc
decl_stmt|;
name|sa
operator|=
operator|&
name|vxladdr
operator|->
name|sa
expr_stmt|;
if|if
condition|(
name|sa
operator|->
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
specifier|const
name|struct
name|in_addr
modifier|*
name|in4
init|=
operator|&
name|satoconstsin
argument_list|(
name|sa
argument_list|)
operator|->
name|sin_addr
decl_stmt|;
name|mc
operator|=
name|IN_MULTICAST
argument_list|(
name|ntohl
argument_list|(
name|in4
operator|->
name|s_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sa
operator|->
name|sa_family
operator|==
name|AF_INET6
condition|)
block|{
specifier|const
name|struct
name|in6_addr
modifier|*
name|in6
init|=
operator|&
name|satoconstsin6
argument_list|(
name|sa
argument_list|)
operator|->
name|sin6_addr
decl_stmt|;
name|mc
operator|=
name|IN6_IS_ADDR_MULTICAST
argument_list|(
name|in6
argument_list|)
expr_stmt|;
block|}
else|else
name|mc
operator|=
operator|-
literal|1
expr_stmt|;
return|return
operator|(
name|mc
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_can_change_config
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|ifp
operator|=
name|sc
operator|->
name|vxl_ifp
expr_stmt|;
name|VXLAN_LOCK_ASSERT
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_drv_flags
operator|&
name|IFF_DRV_RUNNING
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|sc
operator|->
name|vxl_flags
operator|&
operator|(
name|VXLAN_FLAG_INIT
operator||
name|VXLAN_FLAG_TEARDOWN
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_check_vni
parameter_list|(
name|uint32_t
name|vni
parameter_list|)
block|{
return|return
operator|(
name|vni
operator|>=
name|VXLAN_VNI_MAX
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_check_ttl
parameter_list|(
name|int
name|ttl
parameter_list|)
block|{
return|return
operator|(
name|ttl
operator|>
name|MAXTTL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_check_ftable_timeout
parameter_list|(
name|uint32_t
name|timeout
parameter_list|)
block|{
return|return
operator|(
name|timeout
operator|>
name|VXLAN_FTABLE_MAX_TIMEOUT
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_check_ftable_max
parameter_list|(
name|uint32_t
name|max
parameter_list|)
block|{
return|return
operator|(
name|max
operator|>
name|VXLAN_FTABLE_MAX
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_sysctl_setup
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|)
block|{
name|struct
name|sysctl_ctx_list
modifier|*
name|ctx
decl_stmt|;
name|struct
name|sysctl_oid
modifier|*
name|node
decl_stmt|;
name|struct
name|vxlan_statistics
modifier|*
name|stats
decl_stmt|;
name|char
name|namebuf
index|[
literal|8
index|]
decl_stmt|;
name|ctx
operator|=
operator|&
name|sc
operator|->
name|vxl_sysctl_ctx
expr_stmt|;
name|stats
operator|=
operator|&
name|sc
operator|->
name|vxl_stats
expr_stmt|;
name|snprintf
argument_list|(
name|namebuf
argument_list|,
sizeof|sizeof
argument_list|(
name|namebuf
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|sc
operator|->
name|vxl_unit
argument_list|)
expr_stmt|;
name|sysctl_ctx_init
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vxl_sysctl_node
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_STATIC_CHILDREN
argument_list|(
name|_net_link_vxlan
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
name|namebuf
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|node
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|vxl_sysctl_node
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"ftable"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|node
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"count"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|vxl_ftable_cnt
argument_list|,
literal|0
argument_list|,
literal|"Number of entries in fowarding table"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|node
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"max"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|vxl_ftable_max
argument_list|,
literal|0
argument_list|,
literal|"Maximum number of entries allowed in fowarding table"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|node
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"timeout"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|sc
operator|->
name|vxl_ftable_timeout
argument_list|,
literal|0
argument_list|,
literal|"Number of seconds between prunes of the forwarding table"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_PROC
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|node
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"dump"
argument_list|,
name|CTLTYPE_STRING
operator||
name|CTLFLAG_RD
operator||
name|CTLFLAG_MPSAFE
operator||
name|CTLFLAG_SKIP
argument_list|,
name|sc
argument_list|,
literal|0
argument_list|,
name|vxlan_ftable_sysctl_dump
argument_list|,
literal|"A"
argument_list|,
literal|"Dump the forwarding table entries"
argument_list|)
expr_stmt|;
name|node
operator|=
name|SYSCTL_ADD_NODE
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|sc
operator|->
name|vxl_sysctl_node
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"stats"
argument_list|,
name|CTLFLAG_RD
argument_list|,
name|NULL
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|node
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"ftable_nospace"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|ftable_nospace
argument_list|,
literal|0
argument_list|,
literal|"Fowarding table reached maximum entries"
argument_list|)
expr_stmt|;
name|SYSCTL_ADD_UINT
argument_list|(
name|ctx
argument_list|,
name|SYSCTL_CHILDREN
argument_list|(
name|node
argument_list|)
argument_list|,
name|OID_AUTO
argument_list|,
literal|"ftable_lock_upgrade_failed"
argument_list|,
name|CTLFLAG_RD
argument_list|,
operator|&
name|stats
operator|->
name|ftable_lock_upgrade_failed
argument_list|,
literal|0
argument_list|,
literal|"Forwarding table update required lock upgrade"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_sysctl_destroy
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|)
block|{
name|sysctl_ctx_free
argument_list|(
operator|&
name|sc
operator|->
name|vxl_sysctl_ctx
argument_list|)
expr_stmt|;
name|sc
operator|->
name|vxl_sysctl_node
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_tunable_int
parameter_list|(
name|struct
name|vxlan_softc
modifier|*
name|sc
parameter_list|,
specifier|const
name|char
modifier|*
name|knob
parameter_list|,
name|int
name|def
parameter_list|)
block|{
name|char
name|path
index|[
literal|64
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|path
argument_list|,
sizeof|sizeof
argument_list|(
name|path
argument_list|)
argument_list|,
literal|"net.link.vxlan.%d.%s"
argument_list|,
name|sc
operator|->
name|vxl_unit
argument_list|,
name|knob
argument_list|)
expr_stmt|;
name|TUNABLE_INT_FETCH
argument_list|(
name|path
argument_list|,
operator|&
name|def
argument_list|)
expr_stmt|;
return|return
operator|(
name|def
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_ifdetach_event
parameter_list|(
name|void
modifier|*
name|arg
name|__unused
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|vxlan_softc_head
name|list
decl_stmt|;
name|struct
name|vxlan_socket
modifier|*
name|vso
decl_stmt|;
name|struct
name|vxlan_softc
modifier|*
name|sc
decl_stmt|,
modifier|*
name|tsc
decl_stmt|;
name|LIST_INIT
argument_list|(
operator|&
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_RENAMING
condition|)
return|return;
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_MULTICAST
operator|)
operator|==
literal|0
condition|)
return|return;
name|mtx_lock
argument_list|(
operator|&
name|vxlan_list_mtx
argument_list|)
expr_stmt|;
name|LIST_FOREACH
argument_list|(
argument|vso
argument_list|,
argument|&vxlan_socket_list
argument_list|,
argument|vxlso_entry
argument_list|)
name|vxlan_socket_ifdetach
argument_list|(
name|vso
argument_list|,
name|ifp
argument_list|,
operator|&
name|list
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|vxlan_list_mtx
argument_list|)
expr_stmt|;
name|LIST_FOREACH_SAFE
argument_list|(
argument|sc
argument_list|,
argument|&list
argument_list|,
argument|vxl_ifdetach_list
argument_list|,
argument|tsc
argument_list|)
block|{
name|LIST_REMOVE
argument_list|(
name|sc
argument_list|,
name|vxl_ifdetach_list
argument_list|)
expr_stmt|;
name|VXLAN_WLOCK
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|vxl_flags
operator|&
name|VXLAN_FLAG_INIT
condition|)
name|vxlan_init_wait
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|vxlan_teardown_locked
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_load
parameter_list|(
name|void
parameter_list|)
block|{
name|mtx_init
argument_list|(
operator|&
name|vxlan_list_mtx
argument_list|,
literal|"vxlan list"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|LIST_INIT
argument_list|(
operator|&
name|vxlan_socket_list
argument_list|)
expr_stmt|;
name|vxlan_ifdetach_event_tag
operator|=
name|EVENTHANDLER_REGISTER
argument_list|(
name|ifnet_departure_event
argument_list|,
name|vxlan_ifdetach_event
argument_list|,
name|NULL
argument_list|,
name|EVENTHANDLER_PRI_ANY
argument_list|)
expr_stmt|;
name|vxlan_cloner
operator|=
name|if_clone_simple
argument_list|(
name|vxlan_name
argument_list|,
name|vxlan_clone_create
argument_list|,
name|vxlan_clone_destroy
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|vxlan_unload
parameter_list|(
name|void
parameter_list|)
block|{
name|EVENTHANDLER_DEREGISTER
argument_list|(
name|ifnet_departure_event
argument_list|,
name|vxlan_ifdetach_event_tag
argument_list|)
expr_stmt|;
name|if_clone_detach
argument_list|(
name|vxlan_cloner
argument_list|)
expr_stmt|;
name|mtx_destroy
argument_list|(
operator|&
name|vxlan_list_mtx
argument_list|)
expr_stmt|;
name|MPASS
argument_list|(
name|LIST_EMPTY
argument_list|(
operator|&
name|vxlan_socket_list
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|vxlan_modevent
parameter_list|(
name|module_t
name|mod
parameter_list|,
name|int
name|type
parameter_list|,
name|void
modifier|*
name|unused
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|MOD_LOAD
case|:
name|vxlan_load
argument_list|()
expr_stmt|;
break|break;
case|case
name|MOD_UNLOAD
case|:
name|vxlan_unload
argument_list|()
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|ENOTSUP
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|moduledata_t
name|vxlan_mod
init|=
block|{
literal|"if_vxlan"
block|,
name|vxlan_modevent
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DECLARE_MODULE
argument_list|(
name|if_vxlan
argument_list|,
name|vxlan_mod
argument_list|,
name|SI_SUB_PSEUDO
argument_list|,
name|SI_ORDER_ANY
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|if_vxlan
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


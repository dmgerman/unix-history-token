begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*   * Copyright (c) 1998, Larry Lile  * All rights reserved.  *  * For latest sources and information on this driver, please  * go to http://anarchy.stdio.com.  *  * Questions, comments or suggestions should be directed to  * Larry Lile<lile@stdio.com>.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice unmodified, this list of conditions, and the following  *    disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $Id: if_oltr.c,v 1.3 1999/04/21 07:02:19 peter Exp $  */
end_comment

begin_include
include|#
directive|include
file|"pci.h"
end_include

begin_include
include|#
directive|include
file|"oltr.h"
end_include

begin_include
include|#
directive|include
file|"opt_inet.h"
end_include

begin_include
include|#
directive|include
file|"bpfilter.h"
end_include

begin_if
if|#
directive|if
operator|(
name|NOLTR
operator|+
name|NPCI
operator|)
operator|>
literal|0
end_if

begin_comment
comment|/*#define TRlldInlineIO*/
end_comment

begin_define
define|#
directive|define
name|ISA_ADAPTERS
value|(OC_3115 | OC_3117 | OC_3118)
end_define

begin_define
define|#
directive|define
name|PCI_ADAPTERS
value|(OC_3133 | OC_3136 | OC_3137 | \                        OC_3139 | OC_3140 | OC_3141 | \                        OC_3250 | OC_3540 )
end_define

begin_define
define|#
directive|define
name|PCI_VENDOR_OLICOM
value|0x108D
end_define

begin_decl_stmt
name|char
modifier|*
name|AdapterName
index|[]
init|=
block|{
comment|/*  0 */
literal|"Olicom XT Adapter [unsupported]"
block|,
comment|/*  1 */
literal|"Olicom OC-3115"
block|,
comment|/*  2 */
literal|"Olicom ISA 16/4 Adapter (OC-3117)"
block|,
comment|/*  3 */
literal|"Olicom ISA 16/4 Adapter (OC-3118)"
block|,
comment|/*  4 */
literal|"Olicom MCA 16/4 Adapter (OC-3129) [unsupported]"
block|,
comment|/*  5 */
literal|"Olicom MCA 16/4 Adapter (OC-3129) [unsupported]"
block|,
comment|/*  6 */
literal|"Olicom MCA 16/4 Adapter (OC-3129) [unsupported]"
block|,
comment|/*  7 */
literal|"Olicom EISA 16/4 Adapter (OC-3133)"
block|,
comment|/*  8 */
literal|"Olicom EISA 16/4 Adapter (OC-3133)"
block|,
comment|/*  9 */
literal|"Olicom EISA 16/4 Server Adapter (OC-3135)"
block|,
comment|/* 10 */
literal|"Olicom PCI 16/4 Adapter (OC-3136)"
block|,
comment|/* 11 */
literal|"Olicom PCI 16/4 Adapter (OC-3136)"
block|,
comment|/* 12 */
literal|"Olicom PCI/II 16/4 Adapter (OC-3137)"
block|,
comment|/* 13 */
literal|"Olicom PCI 16/4 Adapter (OC-3139)"
block|,
comment|/* 14 */
literal|"Olicom RapidFire 3140 16/4 PCI Adapter (OC-3140)"
block|,
comment|/* 15 */
literal|"Olicom RapidFire 3141 Fiber Adapter (OC-3141)"
block|,
comment|/* 16 */
literal|"Olicom PCMCIA 16/4 Adapter (OC-3220) [unsupported]"
block|,
comment|/* 17 */
literal|"Olicom PCMCIA 16/4 Adapter (OC-3121, OC-3230, OC-3232) [unsupported]"
block|,
comment|/* 18 */
literal|"Olicom PCMCIA 16/4 Adapter (OC-3250)"
block|,
comment|/* 19 */
literal|"Olicom RapidFire 3540 4/16/100 Adapter (OC-3540)"
block|}
decl_stmt|;
end_decl_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/syslog.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/interrupt.h>
end_include

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/iso88025.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_if
if|#
directive|if
name|NBPFILTER
operator|>
literal|0
end_if

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|NPNP
operator|>
literal|0
end_if

begin_include
include|#
directive|include
file|<i386/isa/pnp.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<machine/clock.h>
end_include

begin_include
include|#
directive|include
file|<machine/md_var.h>
end_include

begin_include
include|#
directive|include
file|<i386/isa/isa_device.h>
end_include

begin_if
if|#
directive|if
name|NPCI
operator|>
literal|0
end_if

begin_include
include|#
directive|include
file|<pci/pcivar.h>
end_include

begin_include
include|#
directive|include
file|<pci/pcireg.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"contrib/dev/oltr/trlld.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|TRLLD_SPEED_AUTO
end_ifndef

begin_define
define|#
directive|define
name|TRLLD_SPEED_AUTO
value|0
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|MIN
parameter_list|(
name|A
parameter_list|,
name|B
parameter_list|)
value|(((A)< (B)) ? (A) : (B))
end_define

begin_define
define|#
directive|define
name|MIN3
parameter_list|(
name|A
parameter_list|,
name|B
parameter_list|,
name|C
parameter_list|)
value|(MIN(A, (MIN(B, C))))
end_define

begin_function_decl
name|void
modifier|*
name|oltr_malloc
parameter_list|(
name|ssize_t
parameter_list|,
name|TRlldAdapterConfig_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Glue functions prototypes for PMW kit IO  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|TRlldInlineIO
end_ifndef

begin_decl_stmt
specifier|static
name|void
name|DriverOutByte
name|__P
argument_list|(
operator|(
name|unsigned
name|short
operator|,
name|unsigned
name|char
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|DriverOutWord
name|__P
argument_list|(
operator|(
name|unsigned
name|short
operator|,
name|unsigned
name|short
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|DriverOutDword
name|__P
argument_list|(
operator|(
name|unsigned
name|short
operator|,
name|unsigned
name|long
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|DriverRepOutByte
name|__P
argument_list|(
operator|(
name|unsigned
name|short
operator|,
name|unsigned
name|char
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|DriverRepOutWord
name|__P
argument_list|(
operator|(
name|unsigned
name|short
operator|,
name|unsigned
name|short
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|DriverRepOutDword
name|__P
argument_list|(
operator|(
name|unsigned
name|short
operator|,
name|unsigned
name|long
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|char
name|DriverInByte
name|__P
argument_list|(
operator|(
name|unsigned
name|short
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|short
name|DriverInWord
name|__P
argument_list|(
operator|(
name|unsigned
name|short
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|long
name|DriverInDword
name|__P
argument_list|(
operator|(
name|unsigned
name|short
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|DriverRepInByte
name|__P
argument_list|(
operator|(
name|unsigned
name|short
operator|,
name|unsigned
name|char
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|DriverRepInWord
name|__P
argument_list|(
operator|(
name|unsigned
name|short
operator|,
name|unsigned
name|short
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|DriverRepInDword
name|__P
argument_list|(
operator|(
name|unsigned
name|short
operator|,
name|unsigned
name|long
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*TRlldInlineIO*/
end_comment

begin_decl_stmt
specifier|static
name|void
name|DriverSuspend
name|__P
argument_list|(
operator|(
name|unsigned
name|short
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|DriverStatus
name|__P
argument_list|(
operator|(
name|void
operator|*
operator|,
name|TRlldStatus_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|DriverCloseCompleted
name|__P
argument_list|(
operator|(
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|DriverStatistics
name|__P
argument_list|(
operator|(
name|void
operator|*
operator|,
name|TRlldStatistics_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|DriverTransmitFrameCompleted
name|__P
argument_list|(
operator|(
name|void
operator|*
operator|,
name|void
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|DriverReceiveFrameCompleted
name|__P
argument_list|(
operator|(
name|void
operator|*
operator|,
name|int
operator|,
name|int
operator|,
name|void
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_typedef
typedef|typedef
struct|struct
name|tx_buf
block|{
name|int
name|index
decl_stmt|;
name|int
name|count
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
block|}
name|tx_buf_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|rx_buf
block|{
name|int
name|index
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
block|}
name|rx_buf_t
typedef|;
end_typedef

begin_ifndef
ifndef|#
directive|ifndef
name|EXTRA_OLTR
end_ifndef

begin_if
if|#
directive|if
name|NPCI
operator|>
literal|0
end_if

begin_define
define|#
directive|define
name|EXTRA_OLTR
value|8
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|EXTRA_OLTR
value|0
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NPCI */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EXTRA_OLTR */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|OLTR_PROMISC_MODE
end_ifndef

begin_define
define|#
directive|define
name|OLTR_PROMISC_MODE
value|(TRLLD_PROM_LLC)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|ALL_OPTIONS
value|(IFM_TOK_ETR | IFM_TOK_SRCRT | IFM_TOK_ALLR | IFM_TOK_DTR | IFM_TOK_CLASSIC | IFM_TOK_AUTO)
end_define

begin_comment
comment|/* List sizes MUST be a power of 2 */
end_comment

begin_define
define|#
directive|define
name|TX_LIST_SIZE
value|16
end_define

begin_define
define|#
directive|define
name|RX_LIST_SIZE
value|16
end_define

begin_define
define|#
directive|define
name|TX_LIST_MASK
value|(TX_LIST_SIZE - 1)
end_define

begin_define
define|#
directive|define
name|RX_LIST_MASK
value|(RX_LIST_SIZE - 1)
end_define

begin_define
define|#
directive|define
name|RX_BUFFER_LEN
value|(8*1024)
end_define

begin_define
define|#
directive|define
name|TX_BUFFER_LEN
value|(8*1024)
end_define

begin_struct
struct|struct
name|oltr_softc
block|{
name|struct
name|arpcom
name|arpcom
decl_stmt|;
name|struct
name|ifmedia
name|ifmedia
decl_stmt|;
name|TRlldAdapterConfig_t
modifier|*
name|config
decl_stmt|;
name|TRlldAdapter_t
modifier|*
name|TRlldAdapter
decl_stmt|;
name|int
name|unit
decl_stmt|;
name|u_short
name|PromiscMode
decl_stmt|;
name|u_short
name|AdapterMode
decl_stmt|;
name|int
name|hw_state
decl_stmt|;
define|#
directive|define
name|HW_UNKNOWN
value|0
comment|/* initial/absent state */
define|#
directive|define
name|HW_FOUND
value|1
comment|/* found, not initialized */
define|#
directive|define
name|HW_BAD
value|2
comment|/* fatal error */
define|#
directive|define
name|HW_FAILED
value|3
comment|/* closed eg. by remove, allow manual reopen */
define|#
directive|define
name|HW_LOADING
value|4
define|#
directive|define
name|HW_CLOSING
value|5
define|#
directive|define
name|HW_CLOSING2
value|6
define|#
directive|define
name|HW_CLOSED
value|7
define|#
directive|define
name|HW_OPENING
value|8
define|#
directive|define
name|HW_OPEN
value|9
define|#
directive|define
name|HW_ERROR
value|10
comment|/* temporary error */
name|u_long
name|GroupAddress
decl_stmt|;
name|u_long
name|FunctionalAddress
decl_stmt|;
name|int
name|poll_adapter
decl_stmt|;
name|int
name|tx_next
decl_stmt|;
name|int
name|tx_avail
decl_stmt|;
name|tx_buf_t
name|tx_buffer
index|[
name|TX_LIST_SIZE
index|]
decl_stmt|;
name|TRlldTransmit_t
name|tx_frame
decl_stmt|;
name|int
name|rx_next
decl_stmt|;
name|int
name|rx_avail
decl_stmt|;
name|rx_buf_t
name|rx_buffer
index|[
name|RX_LIST_SIZE
index|]
decl_stmt|;
name|struct
name|callout_handle
name|oltr_ch
decl_stmt|;
name|struct
name|callout_handle
name|poll_ch
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|oltr_softc
name|oltr_softc
index|[
name|NOLTR
operator|+
name|EXTRA_OLTR
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Driver function prototypes  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|oltr_probe
name|__P
argument_list|(
operator|(
expr|struct
name|isa_device
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|oltr_attach
name|__P
argument_list|(
operator|(
expr|struct
name|isa_device
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|oltr_init
name|__P
argument_list|(
operator|(
expr|struct
name|oltr_softc
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|oltr_intr
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|oltr_start
name|__P
argument_list|(
operator|(
expr|struct
name|ifnet
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|oltr_stop
name|__P
argument_list|(
operator|(
expr|struct
name|oltr_softc
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|oltr_ioctl
name|__P
argument_list|(
operator|(
expr|struct
name|ifnet
operator|*
operator|,
name|u_long
operator|,
name|caddr_t
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|oltr_attach_common
name|__P
argument_list|(
operator|(
expr|struct
name|oltr_softc
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|oltr_timeout
name|__P
argument_list|(
operator|(
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|adapter_poll
name|__P
argument_list|(
operator|(
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|isa_driver
name|oltrdriver
init|=
block|{
name|oltr_probe
block|,
name|oltr_attach
block|,
literal|"oltr"
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|isa_cards
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
name|NPCI
operator|>
literal|0
end_if

begin_decl_stmt
specifier|static
name|u_long
name|oltr_count
init|=
name|NOLTR
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|oltr_pci_probe
name|__P
argument_list|(
operator|(
name|pcici_t
operator|,
name|pcidi_t
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|oltr_pci_attach
name|__P
argument_list|(
operator|(
name|pcici_t
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|oltr_pci_intr
name|__P
argument_list|(
operator|(
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|oltr_pci_shutdown
name|__P
argument_list|(
operator|(
name|int
operator|,
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|pci_device
name|oltr_device
init|=
block|{
literal|"oltr"
block|,
name|oltr_pci_probe
block|,
name|oltr_pci_attach
block|,
operator|&
name|oltr_count
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|COMPAT_PCI_DRIVER
end_ifndef

begin_expr_stmt
name|DATA_SET
argument_list|(
name|pcidevice_set
argument_list|,
name|oltr_device
argument_list|)
expr_stmt|;
end_expr_stmt

begin_else
else|#
directive|else
end_else

begin_expr_stmt
name|COMPAT_PCI_DRIVER
argument_list|(
name|oltr_pci
argument_list|,
name|oltr_device
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* COMPAT_PCI_DRIVER */
end_comment

begin_decl_stmt
name|int
name|pci_cards
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NPCI */
end_comment

begin_decl_stmt
specifier|static
name|int
name|oltr_ifmedia_upd
name|__P
argument_list|(
operator|(
expr|struct
name|ifnet
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|oltr_ifmedia_sts
name|__P
argument_list|(
operator|(
expr|struct
name|ifnet
operator|*
operator|,
expr|struct
name|ifmediareq
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|TRlldDriver_t
name|oltrLldDriver
init|=
block|{
name|TRLLD_VERSION
block|,
ifndef|#
directive|ifndef
name|TRlldInlineIO
name|DriverOutByte
block|,
name|DriverOutWord
block|,
name|DriverOutDword
block|,
name|DriverRepOutByte
block|,
name|DriverRepOutWord
block|,
name|DriverRepOutDword
block|,
name|DriverInByte
block|,
name|DriverInWord
block|,
name|DriverInDword
block|,
name|DriverRepInByte
block|,
name|DriverRepInWord
block|,
name|DriverRepInDword
block|,
endif|#
directive|endif
comment|/*TRlldInlineIO*/
name|DriverSuspend
block|,
name|DriverStatus
block|,
name|DriverCloseCompleted
block|,
name|DriverStatistics
block|,
name|DriverTransmitFrameCompleted
block|,
name|DriverReceiveFrameCompleted
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|TRlldAdapterConfig_t
name|oltr_config
index|[
name|NOLTR
operator|+
name|EXTRA_OLTR
index|]
decl_stmt|;
end_decl_stmt

begin_function
name|void
modifier|*
name|oltr_malloc
parameter_list|(
name|Size
parameter_list|,
name|Adapter
parameter_list|)
name|ssize_t
name|Size
decl_stmt|;
name|TRlldAdapterConfig_t
modifier|*
name|Adapter
decl_stmt|;
block|{
comment|/* If the adapter needs memory below 16M for DMA then use contigmalloc */
if|if
condition|(
name|Adapter
operator|->
name|mode
operator|&
name|TRLLD_MODE_16M
condition|)
comment|/* Adapter using ISA DMA buffer below 16M */
return|return
operator|(
name|contigmalloc
argument_list|(
name|Size
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|,
literal|0ul
argument_list|,
literal|0xfffffful
argument_list|,
literal|1ul
argument_list|,
literal|0x10000ul
argument_list|)
operator|)
return|;
else|else
return|return
operator|(
name|malloc
argument_list|(
name|Size
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_NOWAIT
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Driver Functions   */
end_comment

begin_function
specifier|static
name|int
name|oltr_probe
parameter_list|(
name|is
parameter_list|)
name|struct
name|isa_device
modifier|*
name|is
decl_stmt|;
block|{
specifier|static
name|int
name|find_completed
init|=
literal|0
decl_stmt|,
name|assigned
index|[
name|NOLTR
index|]
decl_stmt|;
name|struct
name|oltr_softc
modifier|*
name|sc
init|=
operator|&
name|oltr_softc
index|[
name|is
operator|->
name|id_unit
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"oltr%d: oltr_probe\n"
argument_list|,
name|is
operator|->
name|id_unit
argument_list|)
expr_stmt|;
comment|/* Make life easy, use the Olicom supplied find function on the first probe      * to probe all of the ISA adapters.  Then give them to each unit as requested.      * Try to match the adapters to units based on the iobase, but if iobase? then      * just give out the next available adapter.      */
if|if
condition|(
operator|!
name|find_completed
condition|)
block|{
name|isa_cards
operator|=
name|TRlldFind
argument_list|(
operator|&
name|oltrLldDriver
argument_list|,
operator|&
name|oltr_config
index|[
literal|0
index|]
argument_list|,
name|ISA_ADAPTERS
argument_list|,
name|NOLTR
argument_list|)
expr_stmt|;
comment|/*for (i = 0; i< isa_cards; i++) {             printf("TRlldFind: card %d - %s MAC %6D\n", i + 1, AdapterName[oltr_config[i].type], oltr_config[i].macaddress, ":");         }*/
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NOLTR
condition|;
name|i
operator|++
control|)
name|assigned
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|find_completed
operator|=
literal|1
expr_stmt|;
block|}
name|sc
operator|->
name|unit
operator|=
name|is
operator|->
name|id_unit
expr_stmt|;
name|sc
operator|->
name|hw_state
operator|=
name|HW_UNKNOWN
expr_stmt|;
if|if
condition|(
name|find_completed
operator|&&
operator|(
operator|(
name|isa_cards
operator|==
literal|0
operator|)
operator|||
operator|(
name|is
operator|->
name|id_unit
operator|>
name|isa_cards
operator|)
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
operator|(
name|is
operator|->
name|id_iobase
operator|<
literal|0xa00
operator|)
operator|||
operator|(
name|is
operator|->
name|id_iobase
operator|>
literal|0xbe0
operator|)
operator|)
operator|&&
operator|(
name|is
operator|->
name|id_iobase
operator|!=
literal|0xffffffff
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"oltr%d: port address impossible (0x%X)\n"
argument_list|,
name|is
operator|->
name|id_unit
argument_list|,
name|is
operator|->
name|id_iobase
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/* Auto assign lowest available card not already in use */
if|if
condition|(
name|is
operator|->
name|id_iobase
operator|==
literal|0xffffffff
condition|)
block|{
name|printf
argument_list|(
literal|"oltr%d: auto assigning card.\n"
argument_list|,
name|is
operator|->
name|id_unit
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|assigned
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
empty_stmt|;
name|assigned
index|[
name|i
index|]
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|config
operator|=
operator|&
name|oltr_config
index|[
name|i
index|]
expr_stmt|;
name|is
operator|->
name|id_iobase
operator|=
name|sc
operator|->
name|config
operator|->
name|iobase0
expr_stmt|;
comment|/* Claim our port space */
if|if
condition|(
operator|!
name|is
operator|->
name|id_irq
condition|)
name|is
operator|->
name|id_irq
operator|=
operator|(
literal|1
operator|<<
name|sc
operator|->
name|config
operator|->
name|interruptlevel
operator|)
expr_stmt|;
comment|/* Claim our interrupt */
name|is
operator|->
name|id_intr
operator|=
operator|(
name|inthand2_t
operator|*
operator|)
name|oltr_intr
expr_stmt|;
if|if
condition|(
operator|(
name|is
operator|->
name|id_drq
operator|==
literal|0xffffffff
operator|)
operator|&&
operator|(
name|sc
operator|->
name|config
operator|->
name|dmalevel
operator|!=
name|TRLLD_DMA_PIO
operator|)
condition|)
name|is
operator|->
name|id_drq
operator|=
name|sc
operator|->
name|config
operator|->
name|dmalevel
expr_stmt|;
comment|/* Claim our dma channel */
name|printf
argument_list|(
literal|"oltr%d:<%s> [%6D]\n"
argument_list|,
name|is
operator|->
name|id_unit
argument_list|,
name|AdapterName
index|[
name|sc
operator|->
name|config
operator|->
name|type
index|]
argument_list|,
name|sc
operator|->
name|config
operator|->
name|macaddress
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|hw_state
operator|=
name|HW_FOUND
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
else|else
block|{
comment|/* Assign based on iobase address provided in kernel config */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NOLTR
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|is
operator|->
name|id_iobase
operator|==
name|oltr_config
index|[
name|i
index|]
operator|.
name|iobase0
condition|)
block|{
if|if
condition|(
name|assigned
index|[
name|i
index|]
condition|)
block|{
name|printf
argument_list|(
literal|"oltr%d: adapter (0x%X) already assigned.\n"
argument_list|,
name|is
operator|->
name|id_unit
argument_list|,
name|is
operator|->
name|id_iobase
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|assigned
index|[
name|i
index|]
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|config
operator|=
operator|&
name|oltr_config
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|is
operator|->
name|id_irq
operator|==
literal|0
condition|)
name|is
operator|->
name|id_irq
operator|=
operator|(
literal|1
operator|<<
name|sc
operator|->
name|config
operator|->
name|interruptlevel
operator|)
expr_stmt|;
comment|/* Claim our interrupt */
name|is
operator|->
name|id_intr
operator|=
operator|(
name|inthand2_t
operator|*
operator|)
name|oltr_intr
expr_stmt|;
if|if
condition|(
operator|(
name|is
operator|->
name|id_drq
operator|==
literal|0xffffffff
operator|)
operator|&&
operator|(
name|sc
operator|->
name|config
operator|->
name|dmalevel
operator|!=
name|TRLLD_DMA_PIO
operator|)
condition|)
name|is
operator|->
name|id_drq
operator|=
name|sc
operator|->
name|config
operator|->
name|dmalevel
expr_stmt|;
comment|/* Claim our dma channel */
name|printf
argument_list|(
literal|"oltr%d:<%s> [%6D]\n"
argument_list|,
name|is
operator|->
name|id_unit
argument_list|,
name|AdapterName
index|[
name|sc
operator|->
name|config
operator|->
name|type
index|]
argument_list|,
name|sc
operator|->
name|config
operator|->
name|macaddress
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
name|sc
operator|->
name|hw_state
operator|=
name|HW_FOUND
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
comment|/* Card was not found */
block|}
end_function

begin_if
if|#
directive|if
name|NPCI
operator|>
literal|0
end_if

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|oltr_pci_probe
parameter_list|(
name|config_id
parameter_list|,
name|device_id
parameter_list|)
name|pcici_t
name|config_id
decl_stmt|;
name|pcidi_t
name|device_id
decl_stmt|;
block|{
name|u_char
name|PCIConfigurationSpace
index|[
literal|64
index|]
decl_stmt|;
name|u_long
name|command
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|rc
decl_stmt|;
name|printf
argument_list|(
literal|"oltr: oltr_pci_probe\n"
argument_list|)
expr_stmt|;
name|j
operator|=
name|NOLTR
operator|+
name|pci_cards
expr_stmt|;
if|if
condition|(
name|pci_cards
operator|==
name|EXTRA_OLTR
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
if|if
condition|(
operator|(
operator|(
name|device_id
operator|&
literal|0xffff
operator|)
operator|==
name|PCI_VENDOR_OLICOM
operator|)
operator|&&
operator|(
operator|(
operator|(
operator|(
name|device_id
operator|>>
literal|16
operator|)
operator|&
literal|0xffff
operator|)
operator|==
literal|0x0001
operator|)
operator|||
operator|(
operator|(
operator|(
name|device_id
operator|>>
literal|16
operator|)
operator|&
literal|0xffff
operator|)
operator|==
literal|0x0004
operator|)
operator|||
operator|(
operator|(
operator|(
name|device_id
operator|>>
literal|16
operator|)
operator|&
literal|0xffff
operator|)
operator|==
literal|0x0005
operator|)
operator|||
operator|(
operator|(
operator|(
name|device_id
operator|>>
literal|16
operator|)
operator|&
literal|0xffff
operator|)
operator|==
literal|0x0007
operator|)
operator|||
operator|(
operator|(
operator|(
name|device_id
operator|>>
literal|16
operator|)
operator|&
literal|0xffff
operator|)
operator|==
literal|0x0008
operator|)
operator|)
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
name|PCIConfigurationSpace
index|[
name|i
index|]
operator|=
name|pci_cfgread
argument_list|(
name|config_id
argument_list|,
name|i
argument_list|,
comment|/*bytes*/
literal|1
argument_list|)
expr_stmt|;
name|rc
operator|=
name|TRlldPCIConfig
argument_list|(
operator|&
name|oltrLldDriver
argument_list|,
operator|&
name|oltr_config
index|[
name|j
index|]
argument_list|,
name|PCIConfigurationSpace
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|rc
operator|==
name|TRLLD_PCICONFIG_OK
operator|)
operator|||
operator|(
name|rc
operator|==
name|TRLLD_PCICONFIG_SET_COMMAND
operator|)
condition|)
block|{
if|if
condition|(
name|rc
operator|==
name|TRLLD_PCICONFIG_SET_COMMAND
condition|)
block|{
name|printf
argument_list|(
literal|"oltr: setting bus-master mode\n"
argument_list|)
expr_stmt|;
name|command
operator|=
name|pci_conf_read
argument_list|(
name|config_id
argument_list|,
name|PCIR_COMMAND
argument_list|)
expr_stmt|;
name|pci_conf_write
argument_list|(
name|config_id
argument_list|,
name|PCIR_COMMAND
argument_list|,
operator|(
name|command
operator||
name|PCIM_CMD_BUSMASTEREN
operator|)
argument_list|)
expr_stmt|;
block|}
name|pci_cards
operator|++
expr_stmt|;
return|return
operator|(
name|AdapterName
index|[
name|oltr_config
index|[
name|j
index|]
operator|.
name|type
index|]
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|rc
operator|==
name|TRLLD_PCICONFIG_FAIL
condition|)
name|printf
argument_list|(
literal|"oltr: TRlldPCIConfig failed!\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|TRLLD_PCICONFIG_VERSION
condition|)
name|printf
argument_list|(
literal|"oltr: wrong LLD version\n"
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NPCI */
end_comment

begin_function
specifier|static
name|int
name|oltr_attach
parameter_list|(
name|is
parameter_list|)
name|struct
name|isa_device
modifier|*
name|is
decl_stmt|;
block|{
name|struct
name|oltr_softc
modifier|*
name|sc
init|=
operator|&
name|oltr_softc
index|[
name|is
operator|->
name|id_unit
index|]
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|sc
operator|->
name|unit
operator|=
name|is
operator|->
name|id_unit
expr_stmt|;
if|if
condition|(
operator|!
name|oltr_attach_common
argument_list|(
name|sc
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
comment|/* If the kernel config does not match the current card configuration then      * adjust the card settings to match the kernel.      */
if|if
condition|(
operator|(
name|ffs
argument_list|(
name|is
operator|->
name|id_irq
argument_list|)
operator|-
literal|1
operator|)
operator|!=
name|sc
operator|->
name|config
operator|->
name|interruptlevel
condition|)
block|{
name|rc
operator|=
name|TRlldSetInterrupt
argument_list|(
name|sc
operator|->
name|TRlldAdapter
argument_list|,
name|is
operator|->
name|id_irq
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|TRLLD_CONFIG_OK
condition|)
block|{
name|printf
argument_list|(
literal|"oltr%d: Unable to change adapter interrupt level (%x)\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
comment|/* Set dma level, fall back to pio if possible. (following SCO driver example) */
if|if
condition|(
name|is
operator|->
name|id_drq
operator|!=
name|sc
operator|->
name|config
operator|->
name|dmalevel
condition|)
block|{
name|rc
operator|=
name|TRlldSetDMA
argument_list|(
name|sc
operator|->
name|TRlldAdapter
argument_list|,
name|is
operator|->
name|id_drq
argument_list|,
operator|&
name|sc
operator|->
name|config
operator|->
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|TRLLD_CONFIG_OK
condition|)
block|{
if|if
condition|(
operator|(
name|sc
operator|->
name|config
operator|->
name|dmalevel
operator|!=
name|TRLLD_DMA_PIO
operator|)
operator|&&
operator|(
name|TRlldSetDMA
argument_list|(
name|sc
operator|->
name|TRlldAdapter
argument_list|,
name|TRLLD_DMA_PIO
argument_list|,
operator|&
name|sc
operator|->
name|config
operator|->
name|mode
argument_list|)
operator|!=
name|TRLLD_CONFIG_OK
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"oltr%d: unable to change dma level from %d to %d (%x)\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
name|sc
operator|->
name|config
operator|->
name|dmalevel
argument_list|,
name|is
operator|->
name|id_drq
argument_list|,
name|rc
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"oltr%d: Unable to change adapter dma level, using PIO mode (%x)\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|config
operator|->
name|dmalevel
operator|=
name|TRLLD_DMA_PIO
expr_stmt|;
name|rc
operator|=
name|TRlldSetDMA
argument_list|(
name|sc
operator|->
name|TRlldAdapter
argument_list|,
name|is
operator|->
name|id_drq
argument_list|,
operator|&
name|sc
operator|->
name|config
operator|->
name|mode
argument_list|)
expr_stmt|;
block|}
name|is
operator|->
name|id_irq
operator|=
name|sc
operator|->
name|config
operator|->
name|dmalevel
expr_stmt|;
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
name|NPCI
operator|>
literal|0
end_if

begin_function
specifier|static
name|void
name|oltr_pci_attach
parameter_list|(
name|config_id
parameter_list|,
name|unit
parameter_list|)
name|pcici_t
name|config_id
decl_stmt|;
name|int
name|unit
decl_stmt|;
block|{
name|struct
name|oltr_softc
modifier|*
name|sc
init|=
operator|&
name|oltr_softc
index|[
name|unit
index|]
decl_stmt|;
name|sc
operator|->
name|unit
operator|=
name|unit
expr_stmt|;
name|sc
operator|->
name|config
operator|=
operator|&
name|oltr_config
index|[
name|unit
index|]
expr_stmt|;
name|sc
operator|->
name|hw_state
operator|=
name|HW_FOUND
expr_stmt|;
name|printf
argument_list|(
literal|"oltr%d: mac address [%6D]\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
name|sc
operator|->
name|config
operator|->
name|macaddress
argument_list|,
literal|":"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|oltr_attach_common
argument_list|(
name|sc
argument_list|)
condition|)
return|return;
comment|/* Map our interrupt */
if|if
condition|(
operator|!
name|pci_map_int
argument_list|(
name|config_id
argument_list|,
name|oltr_pci_intr
argument_list|,
name|sc
argument_list|,
operator|&
name|net_imask
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"oltr%d: couldn't map interrupt\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NPCI */
end_comment

begin_function
specifier|static
name|int
name|oltr_attach_common
parameter_list|(
name|sc
parameter_list|)
name|struct
name|oltr_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|&
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
decl_stmt|;
name|u_int
name|bufsize
decl_stmt|;
name|int
name|rc
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
comment|/*printf("oltr%d: attach_common called\n", sc->unit);*/
comment|/* Allocate adapter memory buffer */
name|bufsize
operator|=
name|TRlldAdapterSize
argument_list|()
expr_stmt|;
name|sc
operator|->
name|TRlldAdapter
operator|=
operator|(
name|TRlldAdapter_t
operator|*
operator|)
name|oltr_malloc
argument_list|(
name|bufsize
argument_list|,
name|sc
operator|->
name|config
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|TRlldAdapter
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"oltr%d: Unable to allocate adapter memory block (%d bytes)\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
name|bufsize
argument_list|)
expr_stmt|;
block|}
comment|/*printf("oltr%d: Adapter memory block (%p %d bytes)\n", sc->unit, sc->TRlldAdapter, bufsize);*/
comment|/* Setup transmit pool */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TX_LIST_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|sc
operator|->
name|tx_buffer
index|[
name|i
index|]
operator|.
name|index
operator|=
name|i
expr_stmt|;
name|sc
operator|->
name|tx_buffer
index|[
name|i
index|]
operator|.
name|buf
operator|=
operator|(
name|char
operator|*
operator|)
name|oltr_malloc
argument_list|(
name|TX_BUFFER_LEN
argument_list|,
name|sc
operator|->
name|config
argument_list|)
expr_stmt|;
comment|/* If we have a failure then free everything and get out */
if|if
condition|(
operator|!
name|sc
operator|->
name|tx_buffer
index|[
name|i
index|]
operator|.
name|buf
condition|)
block|{
name|printf
argument_list|(
literal|"oltr%d: Unable to allocate transmit buffers.\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|i
condition|;
name|j
operator|++
control|)
name|free
argument_list|(
name|sc
operator|->
name|tx_buffer
index|[
name|j
index|]
operator|.
name|buf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
name|sc
operator|->
name|tx_next
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|tx_avail
operator|=
name|TX_LIST_SIZE
expr_stmt|;
name|sc
operator|->
name|tx_frame
operator|.
name|FragmentCount
operator|=
literal|0
expr_stmt|;
comment|/* Setup receive pool */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RX_LIST_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|sc
operator|->
name|rx_buffer
index|[
name|i
index|]
operator|.
name|index
operator|=
name|i
expr_stmt|;
name|sc
operator|->
name|rx_buffer
index|[
name|i
index|]
operator|.
name|buf
operator|=
operator|(
name|char
operator|*
operator|)
name|oltr_malloc
argument_list|(
name|RX_BUFFER_LEN
argument_list|,
name|sc
operator|->
name|config
argument_list|)
expr_stmt|;
comment|/* If we have a failure then free everything and get out */
if|if
condition|(
operator|!
name|sc
operator|->
name|rx_buffer
index|[
name|i
index|]
operator|.
name|buf
condition|)
block|{
name|printf
argument_list|(
literal|"oltr%d: Unable to allocate receive buffers.\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|i
condition|;
name|j
operator|++
control|)
name|free
argument_list|(
name|sc
operator|->
name|rx_buffer
index|[
name|j
index|]
operator|.
name|buf
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
name|sc
operator|->
name|rx_next
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|rx_avail
operator|=
name|RX_LIST_SIZE
expr_stmt|;
comment|/*printf("oltr%d: Allocated receive buffers\n", sc->unit); */
comment|/* Set up adapter polling mechanism */
name|sc
operator|->
name|poll_adapter
operator|=
literal|1
expr_stmt|;
name|callout_handle_init
argument_list|(
operator|&
name|sc
operator|->
name|poll_ch
argument_list|)
expr_stmt|;
name|sc
operator|->
name|poll_ch
operator|=
name|timeout
argument_list|(
name|adapter_poll
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sc
operator|->
name|unit
argument_list|,
operator|(
literal|1
operator|*
name|hz
operator|)
operator|/
literal|1000
argument_list|)
expr_stmt|;
name|callout_handle_init
argument_list|(
operator|&
name|sc
operator|->
name|oltr_ch
argument_list|)
expr_stmt|;
comment|/* Initialize adapter */
name|rc
operator|=
name|TRlldAdapterInit
argument_list|(
operator|&
name|oltrLldDriver
argument_list|,
name|sc
operator|->
name|TRlldAdapter
argument_list|,
name|kvtop
argument_list|(
name|sc
operator|->
name|TRlldAdapter
argument_list|)
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sc
operator|->
name|unit
argument_list|,
name|sc
operator|->
name|config
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|TRLLD_INIT_OK
condition|)
block|{
switch|switch
condition|(
name|rc
condition|)
block|{
case|case
name|TRLLD_INIT_NOT_FOUND
case|:
name|printf
argument_list|(
literal|"oltr%d: Adapter not found or malfunctioning.\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
name|sc
operator|->
name|hw_state
operator|=
name|HW_BAD
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|TRLLD_INIT_UNSUPPORTED
case|:
name|printf
argument_list|(
literal|"oltr%d: Adapter not supported by low level driver.\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
name|sc
operator|->
name|hw_state
operator|=
name|HW_UNKNOWN
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|TRLLD_INIT_PHYS16
case|:
name|printf
argument_list|(
literal|"oltr%d: Adapter memory block above 16M, must be below 16M.\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|TRLLD_INIT_VERSION
case|:
name|printf
argument_list|(
literal|"oltr%d: Low level driver version mismatch.\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
default|default:
name|printf
argument_list|(
literal|"oltr%d: Unknown initilization error occoured (%x).\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
comment|/* Download Adapter Microcode */
comment|/*printf("oltr%d: Downloading adapter microcode...", sc->unit);*/
name|sc
operator|->
name|hw_state
operator|=
name|HW_LOADING
expr_stmt|;
switch|switch
condition|(
name|sc
operator|->
name|config
operator|->
name|mactype
condition|)
block|{
case|case
name|TRLLD_MAC_TMS
case|:
comment|/* TMS microcode */
name|rc
operator|=
name|TRlldDownload
argument_list|(
name|sc
operator|->
name|TRlldAdapter
argument_list|,
name|TRlldMacCode
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_MAC_HAWKEYE
case|:
comment|/* Hawkeye microcode */
name|rc
operator|=
name|TRlldDownload
argument_list|(
name|sc
operator|->
name|TRlldAdapter
argument_list|,
name|TRlldHawkeyeMac
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_MAC_BULLSEYE
case|:
comment|/* Bullseye microcode */
name|rc
operator|=
name|TRlldDownload
argument_list|(
name|sc
operator|->
name|TRlldAdapter
argument_list|,
name|TRlldBullseyeMac
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"oltr%d: unknown mactype %d\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
name|sc
operator|->
name|config
operator|->
name|mactype
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
comment|/*if (rc == TRLLD_DOWNLOAD_OK)          printf("done\n");*/
if|if
condition|(
operator|(
name|rc
operator|==
name|TRLLD_DOWNLOAD_ERROR
operator|)
operator|||
operator|(
name|rc
operator|==
name|TRLLD_STATE
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"oltr%d: Adapter microcode download failed! (rc = %x)\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|hw_state
operator|=
name|HW_BAD
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|TRlldSetSpeed
argument_list|(
name|sc
operator|->
name|TRlldAdapter
argument_list|,
name|TRLLD_SPEED_AUTO
argument_list|)
expr_stmt|;
name|sc
operator|->
name|PromiscMode
operator|=
literal|0
expr_stmt|;
name|sc
operator|->
name|AdapterMode
operator|=
literal|0
expr_stmt|;
comment|/* Do the ifnet initialization */
name|ifp
operator|->
name|if_softc
operator|=
name|sc
expr_stmt|;
name|ifp
operator|->
name|if_unit
operator|=
name|sc
operator|->
name|unit
expr_stmt|;
name|ifp
operator|->
name|if_name
operator|=
literal|"oltr"
expr_stmt|;
name|ifp
operator|->
name|if_output
operator|=
name|iso88025_output
expr_stmt|;
name|ifp
operator|->
name|if_init
operator|=
operator|(
name|if_init_f_t
operator|*
operator|)
name|oltr_init
expr_stmt|;
name|ifp
operator|->
name|if_start
operator|=
name|oltr_start
expr_stmt|;
name|ifp
operator|->
name|if_ioctl
operator|=
name|oltr_ioctl
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|=
name|IFF_BROADCAST
operator||
name|IFF_MULTICAST
operator||
name|IFF_SIMPLEX
expr_stmt|;
name|bcopy
argument_list|(
name|sc
operator|->
name|config
operator|->
name|macaddress
argument_list|,
name|sc
operator|->
name|arpcom
operator|.
name|ac_enaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
operator|->
name|config
operator|->
name|macaddress
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Set up common ifmedia options */
name|ifmedia_init
argument_list|(
operator|&
name|sc
operator|->
name|ifmedia
argument_list|,
literal|0
argument_list|,
name|oltr_ifmedia_upd
argument_list|,
name|oltr_ifmedia_sts
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|sc
operator|->
name|ifmedia
argument_list|,
name|IFM_TOKEN
operator||
name|IFM_AUTO
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|sc
operator|->
name|ifmedia
argument_list|,
name|IFM_TOKEN
operator||
name|IFM_TOK_UTP4
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_add
argument_list|(
operator|&
name|sc
operator|->
name|ifmedia
argument_list|,
name|IFM_TOKEN
operator||
name|IFM_TOK_UTP16
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ifmedia_set
argument_list|(
operator|&
name|sc
operator|->
name|ifmedia
argument_list|,
name|IFM_TOKEN
operator||
name|IFM_AUTO
argument_list|)
expr_stmt|;
name|if_attach
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
name|iso88025_ifattach
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
if|#
directive|if
name|NBPFILTER
operator|>
literal|0
name|bpfattach
argument_list|(
name|ifp
argument_list|,
name|DLT_IEEE802
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|iso88025_header
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"oltr%d: Adapter modes - "
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|config
operator|->
name|mode
operator|&
name|TRLLD_MODE_16M
condition|)
name|printf
argument_list|(
literal|"TRLLD_MODE_16M "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|config
operator|->
name|mode
operator|&
name|TRLLD_MODE_PHYSICAL
condition|)
name|printf
argument_list|(
literal|"TRLLD_MODE_PHYSICAL "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|config
operator|->
name|mode
operator|&
name|TRLLD_MODE_FIXED_CFG
condition|)
name|printf
argument_list|(
literal|"TRLLD_MODE_FIXED_CFG "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|config
operator|->
name|mode
operator|&
name|TRLLD_MODE_SHORT_SLOT
condition|)
name|printf
argument_list|(
literal|"TRLLD_MODE_SHORT_SLOT "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|config
operator|->
name|mode
operator|&
name|TRLLD_MODE_CANNOT_DISABLE
condition|)
name|printf
argument_list|(
literal|"TRLLD_MODE_CANNOT_DISABLE "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|config
operator|->
name|mode
operator|&
name|TRLLD_MODE_SHARE_INTERRUPT
condition|)
name|printf
argument_list|(
literal|"TRLLD_MODE_SHARE_INTERRUPT "
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|config
operator|->
name|mode
operator|&
name|TRLLD_MODE_MEMORY
condition|)
name|printf
argument_list|(
literal|"TRLLD_MODE_MEMORY "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
name|NPCI
operator|>
literal|0
end_if

begin_function
specifier|static
name|void
name|oltr_pci_shutdown
parameter_list|(
name|howto
parameter_list|,
name|sc
parameter_list|)
name|int
name|howto
decl_stmt|;
name|void
modifier|*
name|sc
decl_stmt|;
block|{
name|printf
argument_list|(
literal|"oltr: oltr_pci_shutdown called\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NPCI */
end_comment

begin_function
specifier|static
name|int
name|oltr_ifmedia_upd
parameter_list|(
name|ifp
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
block|{
name|struct
name|oltr_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ifmedia
modifier|*
name|ifm
init|=
operator|&
name|sc
operator|->
name|ifmedia
decl_stmt|;
if|if
condition|(
name|IFM_TYPE
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
operator|!=
name|IFM_TOKEN
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
switch|switch
condition|(
name|IFM_SUBTYPE
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
condition|)
block|{
case|case
name|IFM_AUTO
case|:
name|TRlldSetSpeed
argument_list|(
name|sc
operator|->
name|TRlldAdapter
argument_list|,
name|TRLLD_SPEED_AUTO
argument_list|)
expr_stmt|;
break|break;
case|case
name|IFM_TOK_UTP4
case|:
name|TRlldSetSpeed
argument_list|(
name|sc
operator|->
name|TRlldAdapter
argument_list|,
name|TRLLD_SPEED_4MBPS
argument_list|)
expr_stmt|;
break|break;
case|case
name|IFM_TOK_UTP16
case|:
name|TRlldSetSpeed
argument_list|(
name|sc
operator|->
name|TRlldAdapter
argument_list|,
name|TRLLD_SPEED_16MBPS
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
if|if
condition|(
name|IFM_TYPE_OPTIONS
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
operator|&
name|IFM_TOK_ETR
condition|)
name|printf
argument_list|(
literal|"oltr%d: ETR not implemented\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|IFM_TYPE_OPTIONS
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
operator|&
name|IFM_TOK_SRCRT
condition|)
name|printf
argument_list|(
literal|"oltr%d: source-routing not implemented\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|IFM_TYPE_OPTIONS
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
operator|&
name|IFM_TOK_ALLR
condition|)
name|printf
argument_list|(
literal|"oltr%d: all source routes not implemented\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|IFM_TYPE_OPTIONS
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
operator|&
name|IFM_TOK_DTR
condition|)
block|{
name|sc
operator|->
name|AdapterMode
operator||=
name|TRLLD_MODE_FORCE_TXI
expr_stmt|;
name|sc
operator|->
name|AdapterMode
operator|&=
operator|~
name|TRLLD_MODE_FORCE_TKP
expr_stmt|;
block|}
if|if
condition|(
name|IFM_TYPE_OPTIONS
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
operator|&
name|IFM_TOK_CLASSIC
condition|)
block|{
name|sc
operator|->
name|AdapterMode
operator||=
name|TRLLD_MODE_FORCE_TKP
expr_stmt|;
name|sc
operator|->
name|AdapterMode
operator|&=
operator|~
name|TRLLD_MODE_FORCE_TXI
expr_stmt|;
block|}
if|if
condition|(
name|IFM_TYPE_OPTIONS
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
operator|&
name|IFM_TOK_AUTO
condition|)
name|sc
operator|->
name|AdapterMode
operator|&=
operator|~
operator|(
name|TRLLD_MODE_FORCE_TXI
operator||
name|TRLLD_MODE_FORCE_TKP
operator|)
expr_stmt|;
if|if
condition|(
name|IFM_TYPE_OPTIONS
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
operator|&
operator|~
name|ALL_OPTIONS
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|oltr_ifmedia_sts
parameter_list|(
name|ifp
parameter_list|,
name|ifmr
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|ifmediareq
modifier|*
name|ifmr
decl_stmt|;
block|{
name|struct
name|oltr_softc
modifier|*
name|sc
init|=
name|ifp
operator|->
name|if_softc
decl_stmt|;
name|struct
name|ifmedia
modifier|*
name|ifm
init|=
operator|&
name|sc
operator|->
name|ifmedia
decl_stmt|;
name|ifmr
operator|->
name|ifm_active
operator|=
name|IFM_TYPE
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
operator||
name|IFM_SUBTYPE
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
operator||
name|IFM_TYPE_OPTIONS
argument_list|(
name|ifm
operator|->
name|ifm_media
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|oltr_timeout
parameter_list|(
name|token
parameter_list|)
name|void
modifier|*
name|token
decl_stmt|;
block|{
name|struct
name|oltr_softc
modifier|*
name|sc
init|=
operator|&
name|oltr_softc
index|[
operator|(
name|int
operator|)
name|token
index|]
decl_stmt|;
name|int
name|unit
init|=
operator|(
name|int
operator|)
name|token
decl_stmt|,
name|s
decl_stmt|;
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
name|printf
argument_list|(
literal|"oltr%d: adapter timed out (%x)\n"
argument_list|,
name|unit
argument_list|,
name|sc
operator|->
name|hw_state
argument_list|)
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|adapter_poll
parameter_list|(
name|token
parameter_list|)
name|void
modifier|*
name|token
decl_stmt|;
block|{
name|int
name|unit
init|=
operator|(
name|int
operator|)
name|token
decl_stmt|,
name|poll_timeout
init|=
literal|0
decl_stmt|,
name|s
decl_stmt|;
name|struct
name|oltr_softc
modifier|*
name|sc
init|=
operator|&
name|oltr_softc
index|[
name|unit
index|]
decl_stmt|;
if|#
directive|if
literal|0
block|static int rx_buffers = 0, tx_buffers = 0, rc;
endif|#
directive|endif
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
comment|/* Check to make sure we are not polling a dead card */
if|if
condition|(
operator|(
name|sc
operator|->
name|hw_state
operator|==
name|HW_BAD
operator|)
operator|||
operator|(
name|sc
operator|->
name|hw_state
operator|==
name|HW_UNKNOWN
operator|)
condition|)
block|{
name|sc
operator|->
name|poll_adapter
operator|=
operator|-
literal|1
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/*printf("oltr%d: adapter poll.\n", unit);*/
comment|/* If the adapter is to be polled again, then set up      * next timeout poll       */
if|if
condition|(
name|sc
operator|->
name|poll_adapter
condition|)
block|{
name|poll_timeout
operator|=
name|TRlldPoll
argument_list|(
name|sc
operator|->
name|TRlldAdapter
argument_list|)
expr_stmt|;
name|sc
operator|->
name|poll_ch
operator|=
name|timeout
argument_list|(
name|adapter_poll
argument_list|,
operator|(
name|void
operator|*
operator|)
name|unit
argument_list|,
operator|(
name|poll_timeout
operator|*
name|hz
operator|)
operator|/
literal|1000
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
literal|0
block|rc = TRlldReceiveFree(sc->TRlldAdapter);     if (rx_buffers != rc) {         printf("oltr%d: %d receive buffers available\n", sc->unit, rc);         rx_buffers = rc;     }      rc = TRlldTransmitFree(sc->TRlldAdapter);     if (tx_buffers != rc) {         printf("oltr%d: %d transmit buffers available\n", sc->unit, rc);         tx_buffers = rc;     }
endif|#
directive|endif
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|oltr_init
parameter_list|(
name|sc
parameter_list|)
name|struct
name|oltr_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|&
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
decl_stmt|;
name|int
name|i
decl_stmt|,
name|rc
decl_stmt|;
comment|/*printf("oltr%d: oltr_init\n", sc->unit);*/
comment|/*       * Adapter should be freshly downloaded or previously closed before      * bringing it back on line.      */
if|if
condition|(
operator|(
name|sc
operator|->
name|hw_state
operator|!=
name|HW_CLOSED
operator|)
operator|&&
operator|(
name|sc
operator|->
name|hw_state
operator|!=
name|HW_LOADING
operator|)
operator|&&
operator|(
name|sc
operator|->
name|hw_state
operator|!=
name|HW_CLOSING2
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"oltr%d: adapter not ready to be opened (%d).\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
name|sc
operator|->
name|hw_state
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Allocate and set up the DMA channel */
if|if
condition|(
name|sc
operator|->
name|config
operator|->
name|dmalevel
operator|!=
name|TRLLD_DMA_PIO
condition|)
block|{
name|rc
operator|=
name|isa_dma_acquire
argument_list|(
name|sc
operator|->
name|config
operator|->
name|dmalevel
argument_list|)
expr_stmt|;
name|isa_dmacascade
argument_list|(
name|sc
operator|->
name|config
operator|->
name|dmalevel
argument_list|)
expr_stmt|;
block|}
comment|/* Open the adapter */
name|sc
operator|->
name|hw_state
operator|=
name|HW_OPENING
expr_stmt|;
name|rc
operator|=
name|TRlldOpen
argument_list|(
name|sc
operator|->
name|TRlldAdapter
argument_list|,
name|sc
operator|->
name|arpcom
operator|.
name|ac_enaddr
argument_list|,
name|sc
operator|->
name|GroupAddress
argument_list|,
name|sc
operator|->
name|FunctionalAddress
argument_list|,
name|ifp
operator|->
name|if_mtu
operator|+
literal|52
argument_list|,
name|sc
operator|->
name|AdapterMode
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|TRLLD_OPEN_OK
condition|)
block|{
name|printf
argument_list|(
literal|"oltr%d: Adapter failed to open (rc = %x)\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|sc
operator|->
name|hw_state
operator|=
name|HW_FAILED
expr_stmt|;
block|}
else|else
block|{
comment|/*printf("oltr%d: adapter opening...\n", sc->unit);*/
comment|/*ifp->if_flags |= (IFF_UP | IFF_RUNNING);*/
name|ifp
operator|->
name|if_flags
operator|&=
operator|~
name|IFF_OACTIVE
expr_stmt|;
block|}
name|sc
operator|->
name|oltr_ch
operator|=
name|timeout
argument_list|(
name|oltr_timeout
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sc
operator|->
name|unit
argument_list|,
literal|30
operator|*
name|hz
argument_list|)
expr_stmt|;
name|tsleep
argument_list|(
operator|(
name|void
operator|*
operator|)
name|sc
operator|->
name|unit
argument_list|,
literal|1
argument_list|,
literal|"oltrop"
argument_list|,
literal|30
operator|*
name|hz
argument_list|)
expr_stmt|;
comment|/* Give the receive buffers to the adapter */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|RX_LIST_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|rc
operator|=
name|TRlldReceiveFragment
argument_list|(
name|sc
operator|->
name|TRlldAdapter
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sc
operator|->
name|rx_buffer
index|[
name|sc
operator|->
name|rx_next
operator|&
name|RX_LIST_MASK
index|]
operator|.
name|buf
argument_list|,
name|kvtop
argument_list|(
name|sc
operator|->
name|rx_buffer
index|[
name|sc
operator|->
name|rx_next
operator|&
name|RX_LIST_MASK
index|]
operator|.
name|buf
argument_list|)
argument_list|,
name|RX_BUFFER_LEN
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sc
operator|->
name|rx_buffer
index|[
name|sc
operator|->
name|rx_next
operator|&
name|RX_LIST_MASK
index|]
operator|.
name|index
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|TRLLD_RECEIVE_OK
condition|)
block|{
name|printf
argument_list|(
literal|"oltr%d: Adapter refused fragment %d (rc = %d).\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
name|i
argument_list|,
name|rc
argument_list|)
expr_stmt|;
break|break;
block|}
else|else
block|{
name|sc
operator|->
name|rx_avail
operator|--
expr_stmt|;
block|}
name|sc
operator|->
name|rx_next
operator|++
expr_stmt|;
block|}
name|sc
operator|->
name|tx_frame
operator|.
name|FragmentCount
operator|=
literal|0
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|oltr_intr
parameter_list|(
name|unit
parameter_list|)
name|int
name|unit
decl_stmt|;
block|{
name|struct
name|oltr_softc
modifier|*
name|sc
init|=
operator|&
name|oltr_softc
index|[
name|unit
index|]
decl_stmt|;
name|int
name|rc
decl_stmt|;
comment|/*printf("oltr%d: oltr_intr\n", unit);*/
comment|/* Too noisy */
name|rc
operator|=
name|TRlldInterruptService
argument_list|(
name|sc
operator|->
name|TRlldAdapter
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|TRLLD_NO_INTERRUPT
condition|)
name|printf
argument_list|(
literal|"oltr%d: interrupt not serviced.\n"
argument_list|,
name|unit
argument_list|)
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
name|NPCI
operator|>
literal|0
end_if

begin_function
specifier|static
name|void
name|oltr_pci_intr
parameter_list|(
name|psc
parameter_list|)
name|void
modifier|*
name|psc
decl_stmt|;
block|{
name|struct
name|oltr_softc
modifier|*
name|sc
init|=
operator|(
expr|struct
name|oltr_softc
operator|*
operator|)
name|psc
decl_stmt|;
name|int
name|rc
init|=
literal|0
decl_stmt|;
comment|/*printf("oltr%d: oltr_pci_intr\n", sc->unit);*/
comment|/* Too noisy */
name|rc
operator|=
name|TRlldInterruptService
argument_list|(
name|sc
operator|->
name|TRlldAdapter
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|TRLLD_NO_INTERRUPT
condition|)
name|printf
argument_list|(
literal|"oltr%d: pci interrupt not serviced.\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NPCI */
end_comment

begin_function
specifier|static
name|void
name|oltr_start
parameter_list|(
name|ifp
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
block|{
name|struct
name|oltr_softc
modifier|*
name|sc
init|=
operator|&
name|oltr_softc
index|[
name|ifp
operator|->
name|if_unit
index|]
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m0
decl_stmt|,
modifier|*
name|m
decl_stmt|;
name|int
name|len
decl_stmt|,
name|i
decl_stmt|,
name|k
decl_stmt|,
name|rc
decl_stmt|;
comment|/*printf("oltr%d: oltr_start\n", sc->unit);*/
name|outloop
label|:
name|i
operator|=
operator|(
name|sc
operator|->
name|tx_next
operator|&
name|TX_LIST_MASK
operator|)
expr_stmt|;
comment|/* Just to shorten thing up */
comment|/* Check to see if we have enough room to transmit */
if|if
condition|(
name|sc
operator|->
name|tx_avail
operator|<=
literal|0
condition|)
block|{
comment|/* No free buffers, hold off the upper layers */
comment|/*printf("oltr%d: transmit queue full.\n", sc->unit);*/
name|ifp
operator|->
name|if_flags
operator||=
name|IFF_OACTIVE
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|sc
operator|->
name|tx_frame
operator|.
name|FragmentCount
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|sc
operator|->
name|config
operator|->
name|mode
operator|&
name|TRLLD_MODE_16M
operator|)
condition|)
block|{
name|sc
operator|->
name|tx_next
operator|++
expr_stmt|;
name|m0
operator|=
name|sc
operator|->
name|tx_buffer
index|[
name|i
index|]
operator|.
name|m
expr_stmt|;
goto|goto
name|restart
goto|;
block|}
block|}
name|IF_DEQUEUE
argument_list|(
operator|&
name|ifp
operator|->
name|if_snd
argument_list|,
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
literal|0
condition|)
block|{
comment|/*printf("oltr%d: oltr_start NULL packet dequeued.\n", sc->unit);*/
name|ifp
operator|->
name|if_flags
operator|&=
operator|~
name|IFF_OACTIVE
expr_stmt|;
return|return;
block|}
comment|/* Keep a pointer to the head of the packet */
name|m0
operator|=
name|m
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|config
operator|->
name|mode
operator|&
name|TRLLD_MODE_16M
condition|)
block|{
comment|/*  ISA Adapters - bounce buffers */
for|for
control|(
name|len
operator|=
literal|0
init|;
name|m
operator|!=
literal|0
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
control|)
block|{
name|sc
operator|->
name|tx_frame
operator|.
name|TransmitFragment
index|[
literal|0
index|]
operator|.
name|VirtualAddress
operator|=
name|sc
operator|->
name|tx_buffer
index|[
name|i
index|]
operator|.
name|buf
expr_stmt|;
name|sc
operator|->
name|tx_frame
operator|.
name|TransmitFragment
index|[
literal|0
index|]
operator|.
name|PhysicalAddress
operator|=
name|kvtop
argument_list|(
name|sc
operator|->
name|tx_buffer
index|[
name|i
index|]
operator|.
name|buf
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|mtod
argument_list|(
name|m
argument_list|,
name|caddr_t
argument_list|)
argument_list|,
name|sc
operator|->
name|tx_buffer
index|[
name|i
index|]
operator|.
name|buf
operator|+
name|len
argument_list|,
name|m
operator|->
name|m_len
argument_list|)
expr_stmt|;
name|len
operator|+=
name|m
operator|->
name|m_len
expr_stmt|;
block|}
name|sc
operator|->
name|tx_frame
operator|.
name|FragmentCount
operator|=
literal|1
expr_stmt|;
name|sc
operator|->
name|tx_frame
operator|.
name|TransmitFragment
index|[
literal|0
index|]
operator|.
name|count
operator|=
name|len
expr_stmt|;
name|sc
operator|->
name|tx_next
operator|++
expr_stmt|;
name|sc
operator|->
name|tx_avail
operator|--
expr_stmt|;
block|}
else|else
block|{
comment|/* PCI Adapters w/DMA */
for|for
control|(
name|k
operator|=
literal|0
init|;
name|m
operator|!=
literal|0
condition|;
name|m
operator|=
name|m
operator|->
name|m_next
control|)
block|{
name|sc
operator|->
name|tx_frame
operator|.
name|TransmitFragment
index|[
name|k
index|]
operator|.
name|VirtualAddress
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
name|caddr_t
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tx_frame
operator|.
name|TransmitFragment
index|[
name|k
index|]
operator|.
name|PhysicalAddress
operator|=
name|kvtop
argument_list|(
name|mtod
argument_list|(
name|m
argument_list|,
name|caddr_t
argument_list|)
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tx_frame
operator|.
name|TransmitFragment
index|[
name|k
index|]
operator|.
name|count
operator|=
name|m
operator|->
name|m_len
expr_stmt|;
name|k
operator|++
expr_stmt|;
name|sc
operator|->
name|tx_avail
operator|--
expr_stmt|;
block|}
name|sc
operator|->
name|tx_frame
operator|.
name|FragmentCount
operator|=
name|k
expr_stmt|;
name|sc
operator|->
name|tx_buffer
index|[
name|i
index|]
operator|.
name|count
operator|=
name|k
expr_stmt|;
name|sc
operator|->
name|tx_buffer
index|[
name|i
index|]
operator|.
name|m
operator|=
name|m0
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|tx_avail
operator|<
literal|0
condition|)
block|{
comment|/*printf("oltr%d: transmit buffers exhausted.\n", sc->unit);*/
goto|goto
name|nobuffers
goto|;
block|}
name|sc
operator|->
name|tx_next
operator|++
expr_stmt|;
block|}
name|restart
label|:
name|rc
operator|=
name|TRlldTransmitFrame
argument_list|(
name|sc
operator|->
name|TRlldAdapter
argument_list|,
operator|&
name|sc
operator|->
name|tx_frame
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sc
operator|->
name|tx_buffer
index|[
name|i
index|]
operator|.
name|index
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tx_frame
operator|.
name|FragmentCount
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
name|TRLLD_TRANSMIT_OK
condition|)
block|{
name|printf
argument_list|(
literal|"oltr%d: TRlldTransmitFrame returned (%x)\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|#
directive|if
name|NBPFILTER
operator|>
literal|0
if|if
condition|(
name|ifp
operator|->
name|if_bpf
condition|)
name|bpf_mtap
argument_list|(
name|ifp
argument_list|,
name|m0
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|bad
label|:
if|if
condition|(
name|sc
operator|->
name|config
operator|->
name|mode
operator|&
name|TRLLD_MODE_16M
condition|)
block|{
name|m_freem
argument_list|(
name|m0
argument_list|)
expr_stmt|;
block|}
goto|goto
name|outloop
goto|;
name|nobuffers
label|:
name|ifp
operator|->
name|if_flags
operator||=
name|IFF_OACTIVE
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|oltr_stop
parameter_list|(
name|sc
parameter_list|)
name|struct
name|oltr_softc
modifier|*
name|sc
decl_stmt|;
block|{
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|&
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
decl_stmt|;
name|printf
argument_list|(
literal|"oltr%d: otlr_stop\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|&=
operator|~
operator|(
name|IFF_UP
operator||
name|IFF_RUNNING
operator||
name|IFF_OACTIVE
operator|)
expr_stmt|;
name|sc
operator|->
name|hw_state
operator|=
name|HW_CLOSING
expr_stmt|;
name|TRlldClose
argument_list|(
name|sc
operator|->
name|TRlldAdapter
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|oltr_ch
operator|=
name|timeout
argument_list|(
name|oltr_timeout
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sc
operator|->
name|unit
argument_list|,
literal|30
operator|*
name|hz
argument_list|)
expr_stmt|;
name|tsleep
argument_list|(
operator|(
name|void
operator|*
operator|)
name|sc
operator|->
name|unit
argument_list|,
literal|1
argument_list|,
literal|"oltrcl"
argument_list|,
literal|30
operator|*
name|hz
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|oltr_ioctl
parameter_list|(
name|ifp
parameter_list|,
name|cmd
parameter_list|,
name|data
parameter_list|)
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|u_long
name|cmd
decl_stmt|;
name|caddr_t
name|data
decl_stmt|;
block|{
name|struct
name|oltr_softc
modifier|*
name|sc
init|=
operator|&
name|oltr_softc
index|[
name|ifp
operator|->
name|if_unit
index|]
decl_stmt|;
name|struct
name|ifreq
modifier|*
name|ifr
init|=
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|data
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|,
name|s
decl_stmt|;
comment|/*printf("oltr%d: oltr_ioctl\n", ifp->if_unit);*/
name|s
operator|=
name|splimp
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SIOCSIFADDR
case|:
case|case
name|SIOCGIFADDR
case|:
case|case
name|SIOCSIFMTU
case|:
name|error
operator|=
name|iso88025_ioctl
argument_list|(
name|ifp
argument_list|,
name|cmd
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIOCSIFFLAGS
case|:
comment|/*              * If the interface is marked up and stopped, then start it.              * If it is marked down and running, then stop it.              */
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_UP
condition|)
block|{
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_RUNNING
operator|)
operator|==
literal|0
condition|)
name|oltr_init
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_RUNNING
condition|)
block|{
name|oltr_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator|&=
operator|~
name|IFF_RUNNING
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_PROMISC
operator|)
operator|!=
name|sc
operator|->
name|PromiscMode
condition|)
block|{
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_PROMISC
condition|)
name|TRlldSetPromiscuousMode
argument_list|(
name|sc
operator|->
name|TRlldAdapter
argument_list|,
name|OLTR_PROMISC_MODE
argument_list|)
expr_stmt|;
else|else
name|TRlldSetPromiscuousMode
argument_list|(
name|sc
operator|->
name|TRlldAdapter
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sc
operator|->
name|PromiscMode
operator|=
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_PROMISC
operator|)
expr_stmt|;
block|}
break|break;
case|case
name|SIOCGIFMEDIA
case|:
case|case
name|SIOCSIFMEDIA
case|:
name|error
operator|=
name|ifmedia_ioctl
argument_list|(
name|ifp
argument_list|,
name|ifr
argument_list|,
operator|&
name|sc
operator|->
name|ifmedia
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
block|}
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * PMW Callback functions ----------------------------------------------------  */
end_comment

begin_function
specifier|static
name|void
name|DriverSuspend
parameter_list|(
name|MicroSeconds
parameter_list|)
name|unsigned
name|short
name|MicroSeconds
decl_stmt|;
block|{
name|DELAY
argument_list|(
name|MicroSeconds
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DriverStatus
parameter_list|(
name|DriverHandle
parameter_list|,
name|Status
parameter_list|)
name|void
modifier|*
name|DriverHandle
decl_stmt|;
name|TRlldStatus_t
modifier|*
name|Status
decl_stmt|;
block|{
name|struct
name|oltr_softc
modifier|*
name|sc
init|=
operator|&
name|oltr_softc
index|[
operator|(
name|int
operator|)
name|DriverHandle
index|]
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|&
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
decl_stmt|;
switch|switch
condition|(
name|Status
operator|->
name|Type
condition|)
block|{
case|case
name|TRLLD_STS_ON_WIRE
case|:
if|if
condition|(
name|sc
operator|->
name|hw_state
operator|==
name|HW_OPENING
condition|)
block|{
name|sc
operator|->
name|hw_state
operator|=
name|HW_OPEN
expr_stmt|;
name|ifp
operator|->
name|if_flags
operator||=
operator|(
name|IFF_UP
operator||
name|IFF_RUNNING
operator|)
expr_stmt|;
comment|/*printf("oltr%d: Adapter inserted.\n", sc->unit);*/
name|untimeout
argument_list|(
name|oltr_timeout
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sc
operator|->
name|unit
argument_list|,
name|sc
operator|->
name|oltr_ch
argument_list|)
expr_stmt|;
name|wakeup_one
argument_list|(
operator|(
name|void
operator|*
operator|)
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|TRLLD_STS_SELFTEST_STATUS
case|:
if|if
condition|(
name|Status
operator|->
name|Specification
operator|.
name|SelftestStatus
operator|==
name|TRLLD_ST_OK
condition|)
block|{
name|printf
argument_list|(
literal|"oltr%d: adapter status good. (close completed/self-test)\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|hw_state
operator|==
name|HW_LOADING
operator|)
operator|||
operator|(
name|sc
operator|->
name|hw_state
operator|==
name|HW_CLOSING
operator|)
operator|||
operator|(
name|sc
operator|->
name|hw_state
operator|==
name|HW_CLOSING2
operator|)
condition|)
block|{
name|sc
operator|->
name|hw_state
operator|=
name|HW_CLOSED
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"oltr%d: Self test failed: "
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|Status
operator|->
name|Specification
operator|.
name|SelftestStatus
condition|)
block|{
case|case
name|TRLLD_ST_ERROR
operator|+
literal|0
case|:
name|printf
argument_list|(
literal|"Initial Test Error\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_ST_ERROR
operator|+
literal|1
case|:
name|printf
argument_list|(
literal|"Adapter Software Checksum Error\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_ST_ERROR
operator|+
literal|2
case|:
name|printf
argument_list|(
literal|"Adapter RAM Error\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_ST_ERROR
operator|+
literal|4
case|:
name|printf
argument_list|(
literal|"Instruction Test Error\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_ST_ERROR
operator|+
literal|5
case|:
name|printf
argument_list|(
literal|"Protocol Handler/RI Hw Error\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_ST_ERROR
operator|+
literal|6
case|:
name|printf
argument_list|(
literal|"System Interface Register Error\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_ST_TIMEOUT
case|:
name|printf
argument_list|(
literal|"Selftest did not complete\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"Unknown error (%x)\n"
argument_list|,
name|Status
operator|->
name|Specification
operator|.
name|SelftestStatus
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|TRLLD_STS_INIT_STATUS
case|:
name|printf
argument_list|(
literal|"oltr%d: Adapter initialization failed: "
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|Status
operator|->
name|Specification
operator|.
name|InitStatus
condition|)
block|{
case|case
name|TRLLD_INIT_ERROR
operator|+
literal|0x01
case|:
name|printf
argument_list|(
literal|"Invalid init block (LLD error)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_INIT_ERROR
operator|+
literal|0x02
case|:
name|printf
argument_list|(
literal|"Invalid options (LLD error)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_INIT_ERROR
operator|+
literal|0x03
case|:
name|printf
argument_list|(
literal|"Invalid rcv burst (LLD error)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_INIT_ERROR
operator|+
literal|0x04
case|:
name|printf
argument_list|(
literal|"Invalid xmt burst (LLD error)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_INIT_ERROR
operator|+
literal|0x05
case|:
name|printf
argument_list|(
literal|"Invalid DMA threshold (LLD error)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_INIT_ERROR
operator|+
literal|0x06
case|:
name|printf
argument_list|(
literal|"Invalid scb addr\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_INIT_ERROR
operator|+
literal|0x07
case|:
name|printf
argument_list|(
literal|"Invalid ssb addr\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_INIT_ERROR
operator|+
literal|0x08
case|:
name|printf
argument_list|(
literal|"DIO parity error (HW error)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_INIT_ERROR
operator|+
literal|0x09
case|:
name|printf
argument_list|(
literal|"DMA timeout (May be interrupt failing if PIO mode or PCI2)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_INIT_ERROR
operator|+
literal|0x0A
case|:
name|printf
argument_list|(
literal|"DMA parity error (HW error)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_INIT_ERROR
operator|+
literal|0x0B
case|:
name|printf
argument_list|(
literal|"DMA bus error (HW error)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_INIT_ERROR
operator|+
literal|0x0C
case|:
name|printf
argument_list|(
literal|"DMA data error\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_INIT_ERROR
operator|+
literal|0x0D
case|:
name|printf
argument_list|(
literal|"Adapter Check\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_INIT_TIMEOUT
case|:
name|printf
argument_list|(
literal|"Adapter initialization did not complete\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_INIT_DMA_ERROR
case|:
name|printf
argument_list|(
literal|"Adapter cannot access system memory\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_INIT_INTR_ERROR
case|:
name|printf
argument_list|(
literal|"Adapter cannot interrupt\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_OPEN_TIMEOUT
case|:
name|printf
argument_list|(
literal|"Adapter did not complete open within 30 seconds\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_OPEN_ERROR
operator|+
literal|0x01
case|:
name|printf
argument_list|(
literal|"Invalid open options (LLD error)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_OPEN_ERROR
operator|+
literal|0x04
case|:
name|printf
argument_list|(
literal|"TxBuffer count error (LLD error)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_OPEN_ERROR
operator|+
literal|0x10
case|:
name|printf
argument_list|(
literal|"Buffer size error (LLD error)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_OPEN_ERROR
operator|+
literal|0x20
case|:
name|printf
argument_list|(
literal|"List size error (LLD error)\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|Status
operator|->
name|Specification
operator|.
name|InitStatus
operator|&
literal|0x700
condition|)
block|{
switch|switch
condition|(
name|Status
operator|->
name|Specification
operator|.
name|InitStatus
operator|&
literal|0x70F
condition|)
block|{
case|case
name|TRLLD_OPEN_REPEAT
operator|+
literal|0x01
case|:
name|printf
argument_list|(
literal|"Lobe media test - "
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_OPEN_REPEAT
operator|+
literal|0x02
case|:
name|printf
argument_list|(
literal|"Physical insertion - "
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_OPEN_REPEAT
operator|+
literal|0x03
case|:
name|printf
argument_list|(
literal|"Address verification - "
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_OPEN_REPEAT
operator|+
literal|0x04
case|:
name|printf
argument_list|(
literal|"Participation in ring poll - "
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_OPEN_REPEAT
operator|+
literal|0x05
case|:
name|printf
argument_list|(
literal|"Request initialization - "
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_OPEN_REPEAT
operator|+
literal|0x09
case|:
name|printf
argument_list|(
literal|"Request registration (TXI) - "
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_OPEN_REPEAT
operator|+
literal|0x0A
case|:
name|printf
argument_list|(
literal|"Lobe media test (TXI) - "
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"Unknown phase (%x) - "
argument_list|,
name|Status
operator|->
name|Specification
operator|.
name|InitStatus
operator|&
literal|0x00F
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|Status
operator|->
name|Specification
operator|.
name|InitStatus
operator|&
literal|0x7F0
condition|)
block|{
case|case
name|TRLLD_OPEN_REPEAT
operator|+
literal|0x10
case|:
name|printf
argument_list|(
literal|"Function failure (No cable?)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_OPEN_REPEAT
operator|+
literal|0x20
case|:
name|printf
argument_list|(
literal|"Signal loss\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_OPEN_REPEAT
operator|+
literal|0x50
case|:
name|printf
argument_list|(
literal|"Timeout\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_OPEN_REPEAT
operator|+
literal|0x60
case|:
name|printf
argument_list|(
literal|"Ring failure (TKP) / Protocol error (TXI)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_OPEN_REPEAT
operator|+
literal|0x70
case|:
name|printf
argument_list|(
literal|"Ring beaconing\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_OPEN_REPEAT
operator|+
literal|0x80
case|:
name|printf
argument_list|(
literal|"Duplicate node address (TKP) / Insert denied (TXI)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_OPEN_REPEAT
operator|+
literal|0x90
case|:
name|printf
argument_list|(
literal|"Request initialization (TKP)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_OPEN_REPEAT
operator|+
literal|0xa0
case|:
name|printf
argument_list|(
literal|"Remove received\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_OPEN_REPEAT
operator|+
literal|0xb0
case|:
name|printf
argument_list|(
literal|"C-port address changed (TXI)\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"Unknown type (%x)\n"
argument_list|,
name|Status
operator|->
name|Specification
operator|.
name|InitStatus
operator|&
literal|0x0F0
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Unknown error (%x)\n"
argument_list|,
name|Status
operator|->
name|Specification
operator|.
name|InitStatus
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|TRLLD_STS_RING_STATUS
case|:
if|if
condition|(
name|Status
operator|->
name|Specification
operator|.
name|RingStatus
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"oltr%d: Ring status change: "
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|Status
operator|->
name|Specification
operator|.
name|RingStatus
operator|&
name|TRLLD_RS_HARD_ERROR
condition|)
name|printf
argument_list|(
literal|"[Hard error] "
argument_list|)
expr_stmt|;
if|if
condition|(
name|Status
operator|->
name|Specification
operator|.
name|RingStatus
operator|&
name|TRLLD_RS_SOFT_ERROR
condition|)
name|printf
argument_list|(
literal|"[Soft error] "
argument_list|)
expr_stmt|;
if|if
condition|(
name|Status
operator|->
name|Specification
operator|.
name|RingStatus
operator|&
name|TRLLD_RS_TRANSMIT_BEACON
condition|)
name|printf
argument_list|(
literal|"[Transmit beacon] "
argument_list|)
expr_stmt|;
if|if
condition|(
name|Status
operator|->
name|Specification
operator|.
name|RingStatus
operator|&
name|TRLLD_RS_LOBE_WIRE_FAULT
condition|)
name|printf
argument_list|(
literal|"[Wire fault] "
argument_list|)
expr_stmt|;
if|if
condition|(
name|Status
operator|->
name|Specification
operator|.
name|RingStatus
operator|&
name|TRLLD_RS_AUTO_REMOVAL_ERROR
condition|)
name|printf
argument_list|(
literal|"[Auto removal] "
argument_list|)
expr_stmt|;
if|if
condition|(
name|Status
operator|->
name|Specification
operator|.
name|RingStatus
operator|&
name|TRLLD_RS_REMOVE_RECEIVED
condition|)
name|printf
argument_list|(
literal|"[Remove received] "
argument_list|)
expr_stmt|;
if|if
condition|(
name|Status
operator|->
name|Specification
operator|.
name|RingStatus
operator|&
name|TRLLD_RS_COUNTER_OVERFLOW
condition|)
name|printf
argument_list|(
literal|"[Counter overflow] "
argument_list|)
expr_stmt|;
if|if
condition|(
name|Status
operator|->
name|Specification
operator|.
name|RingStatus
operator|&
name|TRLLD_RS_SINGLE_STATION
condition|)
name|printf
argument_list|(
literal|"[Single station] "
argument_list|)
expr_stmt|;
if|if
condition|(
name|Status
operator|->
name|Specification
operator|.
name|RingStatus
operator|&
name|TRLLD_RS_RING_RECOVERY
condition|)
name|printf
argument_list|(
literal|"[Ring recovery] "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|TRLLD_STS_ADAPTER_CHECK
case|:
name|printf
argument_list|(
literal|"oltr%d: Adapter check (%x %x %x %x)\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
name|Status
operator|->
name|Specification
operator|.
name|AdapterCheck
index|[
literal|0
index|]
argument_list|,
name|Status
operator|->
name|Specification
operator|.
name|AdapterCheck
index|[
literal|1
index|]
argument_list|,
name|Status
operator|->
name|Specification
operator|.
name|AdapterCheck
index|[
literal|2
index|]
argument_list|,
name|Status
operator|->
name|Specification
operator|.
name|AdapterCheck
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_STS_PROMISCUOUS_STOPPED
case|:
name|printf
argument_list|(
literal|"oltr%d: Promiscuous mode stopped: "
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|Status
operator|->
name|Specification
operator|.
name|PromRemovedCause
condition|)
block|{
case|case
name|TRLLD_PROM_REMOVE_RECEIVED
case|:
name|printf
argument_list|(
literal|"Remove received\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_PROM_POLL_FAILURE
case|:
name|printf
argument_list|(
literal|"Poll failure\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"Unknown (%x)\n"
argument_list|,
name|Status
operator|->
name|Specification
operator|.
name|PromRemovedCause
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|TRLLD_STS_LLD_ERROR
case|:
name|printf
argument_list|(
literal|"oltr%d: LLD error (%x %x %x %x) "
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
name|Status
operator|->
name|Specification
operator|.
name|InternalError
index|[
literal|0
index|]
argument_list|,
name|Status
operator|->
name|Specification
operator|.
name|InternalError
index|[
literal|1
index|]
argument_list|,
name|Status
operator|->
name|Specification
operator|.
name|InternalError
index|[
literal|2
index|]
argument_list|,
name|Status
operator|->
name|Specification
operator|.
name|InternalError
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|TRLLD_STS_ADAPTER_TIMEOUT
case|:
name|printf
argument_list|(
literal|"oltr%d: Adapter operation timed out: "
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|Status
operator|->
name|Specification
operator|.
name|AdapterTimeout
condition|)
block|{
case|case
name|TRLLD_COMMAND_TIMEOUT
case|:
name|printf
argument_list|(
literal|"Command\n"
argument_list|)
expr_stmt|;
case|case
name|TRLLD_TRANSMIT_TIMEOUT
case|:
name|printf
argument_list|(
literal|"Transmit\n"
argument_list|)
expr_stmt|;
case|case
name|TRLLD_INTERRUPT_TIMEOUT
case|:
name|printf
argument_list|(
literal|"Interrupt\n"
argument_list|)
expr_stmt|;
default|default:
name|printf
argument_list|(
literal|"Unknown (%x)\n"
argument_list|,
name|Status
operator|->
name|Specification
operator|.
name|AdapterTimeout
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|printf
argument_list|(
literal|"oltr%d: Unknown status type (%x)\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
name|Status
operator|->
name|Type
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|Status
operator|->
name|Closed
condition|)
block|{
if|if
condition|(
name|sc
operator|->
name|hw_state
operator|>
name|HW_BAD
condition|)
block|{
name|sc
operator|->
name|hw_state
operator|=
name|HW_FAILED
expr_stmt|;
name|printf
argument_list|(
literal|"oltr%d: closing adapter due to failure.\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
name|oltr_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|DriverCloseCompleted
parameter_list|(
name|DriverHandle
parameter_list|)
name|void
modifier|*
name|DriverHandle
decl_stmt|;
block|{
name|struct
name|oltr_softc
modifier|*
name|sc
init|=
operator|&
name|oltr_softc
index|[
operator|(
name|int
operator|)
name|DriverHandle
index|]
decl_stmt|;
name|printf
argument_list|(
literal|"oltr%d: DriverCloseCompleted\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
name|untimeout
argument_list|(
name|oltr_timeout
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sc
operator|->
name|unit
argument_list|,
name|sc
operator|->
name|oltr_ch
argument_list|)
expr_stmt|;
name|wakeup_one
argument_list|(
operator|(
name|void
operator|*
operator|)
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sc
operator|->
name|hw_state
operator|!=
name|HW_CLOSING
operator|)
operator|&&
operator|(
name|sc
operator|->
name|hw_state
operator|!=
name|HW_CLOSING2
operator|)
operator|&&
operator|(
name|sc
operator|->
name|hw_state
operator|!=
name|HW_CLOSED
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"oltr%d: adapter close complete called in wrong state (%d)\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
name|sc
operator|->
name|hw_state
argument_list|)
expr_stmt|;
return|return;
block|}
name|sc
operator|->
name|hw_state
operator|=
name|HW_CLOSING2
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|config
operator|->
name|dmalevel
operator|!=
name|TRLLD_DMA_PIO
condition|)
name|isa_dma_release
argument_list|(
name|sc
operator|->
name|config
operator|->
name|dmalevel
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DriverStatistics
parameter_list|(
name|DriverHandle
parameter_list|,
name|Statistics
parameter_list|)
name|void
modifier|*
name|DriverHandle
decl_stmt|;
name|TRlldStatistics_t
modifier|*
name|Statistics
decl_stmt|;
block|{
name|printf
argument_list|(
literal|"oltr: DriverStatistics\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DriverTransmitFrameCompleted
parameter_list|(
name|DriverHandle
parameter_list|,
name|FrameHandle
parameter_list|,
name|TransmitStatus
parameter_list|)
name|void
modifier|*
name|DriverHandle
decl_stmt|;
name|void
modifier|*
name|FrameHandle
decl_stmt|;
name|int
name|TransmitStatus
decl_stmt|;
block|{
name|int
name|frame
init|=
operator|(
name|int
operator|)
name|FrameHandle
decl_stmt|;
name|struct
name|oltr_softc
modifier|*
name|sc
init|=
operator|&
name|oltr_softc
index|[
operator|(
name|int
operator|)
name|DriverHandle
index|]
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|&
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
decl_stmt|;
comment|/*printf("oltr%d: transmit complete frame %d\n", sc->unit, frame);*/
if|if
condition|(
name|TransmitStatus
operator|==
name|TRLLD_TRANSMIT_OK
condition|)
block|{
name|ifp
operator|->
name|if_opackets
operator|++
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"oltr%d: DriverTransmitFrameCompleted (frame %d status %x)\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
name|frame
argument_list|,
name|TransmitStatus
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_oerrors
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|frame
operator|<
literal|0
operator|)
operator|||
operator|(
name|frame
operator|>
name|TX_LIST_SIZE
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"oltr%d: bogus transmit frame. (%d)\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
name|frame
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|sc
operator|->
name|config
operator|->
name|mode
operator|&
name|TRLLD_MODE_16M
condition|)
block|{
name|sc
operator|->
name|tx_avail
operator|++
expr_stmt|;
block|}
else|else
block|{
name|m_freem
argument_list|(
name|sc
operator|->
name|tx_buffer
index|[
name|frame
index|]
operator|.
name|m
argument_list|)
expr_stmt|;
name|sc
operator|->
name|tx_avail
operator|+=
name|sc
operator|->
name|tx_buffer
index|[
name|frame
index|]
operator|.
name|count
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_OACTIVE
operator|)
operator|&&
operator|(
name|sc
operator|->
name|tx_avail
operator|>
literal|0
operator|)
condition|)
block|{
name|ifp
operator|->
name|if_flags
operator|&=
operator|~
operator|(
name|IFF_OACTIVE
operator|)
expr_stmt|;
name|oltr_start
argument_list|(
name|ifp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|DriverReceiveFrameCompleted
parameter_list|(
name|DriverHandle
parameter_list|,
name|ByteCount
parameter_list|,
name|FragmentCount
parameter_list|,
name|FragmentHandle
parameter_list|,
name|ReceiveStatus
parameter_list|)
name|void
modifier|*
name|DriverHandle
decl_stmt|;
name|int
name|ByteCount
decl_stmt|;
name|int
name|FragmentCount
decl_stmt|;
name|void
modifier|*
name|FragmentHandle
decl_stmt|;
name|int
name|ReceiveStatus
decl_stmt|;
block|{
name|struct
name|oltr_softc
modifier|*
name|sc
init|=
operator|&
name|oltr_softc
index|[
operator|(
name|int
operator|)
name|DriverHandle
index|]
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
operator|&
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
decl_stmt|;
name|struct
name|iso88025_header
modifier|*
name|th
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m0
decl_stmt|,
modifier|*
name|m1
decl_stmt|,
modifier|*
name|m
decl_stmt|;
name|int
name|j
init|=
operator|(
name|int
operator|)
name|FragmentHandle
decl_stmt|,
name|rc
decl_stmt|,
name|frame_len
init|=
name|ByteCount
decl_stmt|,
name|mac_hdr_len
decl_stmt|;
name|int
name|mbuf_offset
decl_stmt|,
name|mbuf_size
decl_stmt|,
name|frag_offset
decl_stmt|,
name|length
decl_stmt|;
name|char
modifier|*
name|frag
init|=
name|sc
operator|->
name|rx_buffer
index|[
name|j
index|]
operator|.
name|buf
decl_stmt|;
comment|/*printf("oltr%d: ReceiveFrameCompleted (Size %d Count %d Start %d)\n", sc->unit, ByteCount, FragmentCount, j);*/
if|if
condition|(
name|sc
operator|->
name|hw_state
operator|>=
name|HW_OPEN
condition|)
block|{
comment|/* Hardware operating normally */
if|if
condition|(
name|frag
operator|!=
name|sc
operator|->
name|rx_buffer
index|[
name|sc
operator|->
name|rx_next
operator|&
name|RX_LIST_MASK
index|]
operator|.
name|buf
condition|)
block|{
name|printf
argument_list|(
literal|"oltr%d: ring buffer pointer blown\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
name|oltr_stop
argument_list|(
name|sc
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ReceiveStatus
operator|==
name|TRLLD_RCV_OK
condition|)
block|{
comment|/* Receive good frame */
name|MGETHDR
argument_list|(
name|m0
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
name|mbuf_size
operator|=
name|MHLEN
expr_stmt|;
if|if
condition|(
name|m0
operator|==
name|NULL
condition|)
block|{
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|ByteCount
operator|+
literal|2
operator|>
name|MHLEN
condition|)
block|{
name|MCLGET
argument_list|(
name|m0
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
name|mbuf_size
operator|=
name|MCLBYTES
expr_stmt|;
if|if
condition|(
operator|(
name|m0
operator|->
name|m_flags
operator|&
name|M_EXT
operator|)
operator|==
literal|0
condition|)
block|{
name|m_freem
argument_list|(
name|m0
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|m0
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
operator|&
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
expr_stmt|;
name|m0
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|ByteCount
expr_stmt|;
name|m0
operator|->
name|m_len
operator|=
literal|0
expr_stmt|;
name|m0
operator|->
name|m_data
operator|+=
literal|2
expr_stmt|;
name|mbuf_size
operator|-=
literal|2
expr_stmt|;
name|th
operator|=
name|mtod
argument_list|(
name|m0
argument_list|,
expr|struct
name|iso88025_header
operator|*
argument_list|)
expr_stmt|;
name|m0
operator|->
name|m_pkthdr
operator|.
name|header
operator|=
operator|(
name|void
operator|*
operator|)
name|th
expr_stmt|;
name|m
operator|=
name|m0
expr_stmt|;
name|mbuf_offset
operator|=
literal|0
expr_stmt|;
name|frag_offset
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|frame_len
operator|>
literal|0
condition|)
block|{
name|length
operator|=
name|MIN3
argument_list|(
name|frame_len
argument_list|,
operator|(
name|RX_BUFFER_LEN
operator|-
name|frag_offset
operator|)
argument_list|,
operator|(
name|mbuf_size
operator|-
name|mbuf_offset
operator|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|frag
operator|+
name|frag_offset
argument_list|,
name|mtod
argument_list|(
name|m
argument_list|,
name|char
operator|*
argument_list|)
operator|+
name|mbuf_offset
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_len
operator|+=
name|length
expr_stmt|;
name|mbuf_offset
operator|+=
name|length
expr_stmt|;
name|frag_offset
operator|+=
name|length
expr_stmt|;
name|frame_len
operator|-=
name|length
expr_stmt|;
if|if
condition|(
name|frag_offset
operator|==
name|RX_BUFFER_LEN
condition|)
block|{
name|frag
operator|=
name|sc
operator|->
name|rx_buffer
index|[
operator|++
name|j
index|]
operator|.
name|buf
expr_stmt|;
name|frag_offset
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|mbuf_offset
operator|==
name|mbuf_size
operator|)
operator|&&
operator|(
name|frame_len
operator|>
literal|0
operator|)
condition|)
block|{
name|MGET
argument_list|(
name|m1
argument_list|,
name|M_DONTWAIT
argument_list|,
name|MT_DATA
argument_list|)
expr_stmt|;
name|mbuf_size
operator|=
name|MHLEN
expr_stmt|;
if|if
condition|(
name|m1
operator|==
name|NULL
condition|)
block|{
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
name|m_freem
argument_list|(
name|m0
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|frame_len
operator|>
name|MHLEN
condition|)
block|{
name|MCLGET
argument_list|(
name|m1
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
name|mbuf_size
operator|=
name|MCLBYTES
expr_stmt|;
if|if
condition|(
operator|(
name|m1
operator|->
name|m_flags
operator|&
name|M_EXT
operator|)
operator|==
literal|0
condition|)
block|{
name|m_freem
argument_list|(
name|m0
argument_list|)
expr_stmt|;
name|m_freem
argument_list|(
name|m1
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|m
operator|->
name|m_next
operator|=
name|m1
expr_stmt|;
name|m
operator|=
name|m1
expr_stmt|;
name|mbuf_offset
operator|=
literal|0
expr_stmt|;
name|m
operator|->
name|m_len
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|ifp
operator|->
name|if_ipackets
operator|++
expr_stmt|;
if|#
directive|if
name|NBPFILTER
operator|>
literal|0
if|if
condition|(
name|ifp
operator|->
name|if_bpf
condition|)
name|bpf_mtap
argument_list|(
name|ifp
argument_list|,
name|m0
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ifp
operator|->
name|if_flags
operator|&
name|IFF_PROMISC
condition|)
if|if
condition|(
name|bcmp
argument_list|(
name|th
operator|->
name|iso88025_dhost
argument_list|,
name|etherbroadcastaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|th
operator|->
name|iso88025_dhost
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|th
operator|->
name|iso88025_dhost
index|[
literal|0
index|]
operator|&
literal|0x7f
operator|)
operator|!=
name|sc
operator|->
name|arpcom
operator|.
name|ac_enaddr
index|[
literal|0
index|]
operator|)
operator|||
operator|(
name|bcmp
argument_list|(
name|th
operator|->
name|iso88025_dhost
operator|+
literal|1
argument_list|,
name|sc
operator|->
name|arpcom
operator|.
name|ac_enaddr
operator|+
literal|1
argument_list|,
name|ISO88025_ADDR_LEN
operator|-
literal|1
argument_list|)
operator|)
condition|)
block|{
name|m_freem
argument_list|(
name|m0
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|mac_hdr_len
operator|=
name|ISO88025_HDR_LEN
expr_stmt|;
if|if
condition|(
name|th
operator|->
name|iso88025_shost
index|[
literal|0
index|]
operator|&
literal|0x80
condition|)
comment|/* Check for source routing info */
name|mac_hdr_len
operator|+=
operator|(
name|ntohs
argument_list|(
name|th
operator|->
name|rcf
argument_list|)
operator|&
literal|0x1f00
operator|)
operator|>>
literal|8
expr_stmt|;
name|m0
operator|->
name|m_pkthdr
operator|.
name|len
operator|-=
name|mac_hdr_len
expr_stmt|;
name|m0
operator|->
name|m_len
operator|-=
name|mac_hdr_len
expr_stmt|;
name|m0
operator|->
name|m_data
operator|+=
name|mac_hdr_len
expr_stmt|;
name|iso88025_input
argument_list|(
operator|&
name|sc
operator|->
name|arpcom
operator|.
name|ac_if
argument_list|,
name|th
argument_list|,
name|m0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ReceiveStatus
operator|!=
name|TRLLD_RCV_NO_DATA
condition|)
block|{
name|printf
argument_list|(
literal|"oltr%d: receive error. (ReceiveStatus=%d)\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
name|ReceiveStatus
argument_list|)
expr_stmt|;
name|ifp
operator|->
name|if_ierrors
operator|++
expr_stmt|;
block|}
block|}
name|out
label|:
while|while
condition|(
name|FragmentCount
operator|>
literal|0
condition|)
block|{
name|rc
operator|=
name|TRlldReceiveFragment
argument_list|(
name|sc
operator|->
name|TRlldAdapter
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sc
operator|->
name|rx_buffer
index|[
name|sc
operator|->
name|rx_next
operator|&
name|RX_LIST_MASK
index|]
operator|.
name|buf
argument_list|,
name|kvtop
argument_list|(
name|sc
operator|->
name|rx_buffer
index|[
name|sc
operator|->
name|rx_next
operator|&
name|RX_LIST_MASK
index|]
operator|.
name|buf
argument_list|)
argument_list|,
name|RX_BUFFER_LEN
argument_list|,
operator|(
name|void
operator|*
operator|)
name|sc
operator|->
name|rx_buffer
index|[
name|sc
operator|->
name|rx_next
operator|&
name|RX_LIST_MASK
index|]
operator|.
name|index
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
name|TRLLD_RECEIVE_OK
condition|)
block|{
name|sc
operator|->
name|rx_next
operator|++
expr_stmt|;
name|FragmentCount
operator|--
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"oltr%d: Adapter refused fragment (%d).\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
name|sc
operator|->
name|rx_next
operator|-
literal|1
argument_list|)
expr_stmt|;
name|sc
operator|->
name|rx_avail
operator|+=
name|FragmentCount
expr_stmt|;
break|break;
block|}
block|}
block|}
else|else
block|{
comment|/* Hardware being closed */
if|if
condition|(
name|frag
operator|!=
name|sc
operator|->
name|rx_buffer
index|[
name|sc
operator|->
name|rx_next
operator|++
operator|&
name|RX_LIST_MASK
index|]
operator|.
name|buf
condition|)
block|{
name|printf
argument_list|(
literal|"oltr%d: ring buffer pointer blown\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|rx_avail
operator|+=
name|FragmentCount
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * ---------------------------- PMW Glue -------------------------------  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|TRlldInlineIO
end_ifndef

begin_function
specifier|static
name|void
name|DriverOutByte
parameter_list|(
name|IOAddress
parameter_list|,
name|value
parameter_list|)
name|unsigned
name|short
name|IOAddress
decl_stmt|;
name|unsigned
name|char
name|value
decl_stmt|;
block|{
name|outb
argument_list|(
name|IOAddress
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DriverOutWord
parameter_list|(
name|IOAddress
parameter_list|,
name|value
parameter_list|)
name|unsigned
name|short
name|IOAddress
decl_stmt|;
name|unsigned
name|short
name|value
decl_stmt|;
block|{
name|outw
argument_list|(
name|IOAddress
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DriverOutDword
parameter_list|(
name|IOAddress
parameter_list|,
name|value
parameter_list|)
name|unsigned
name|short
name|IOAddress
decl_stmt|;
name|unsigned
name|long
name|value
decl_stmt|;
block|{
name|outl
argument_list|(
name|IOAddress
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DriverRepOutByte
parameter_list|(
name|IOAddress
parameter_list|,
name|DataPointer
parameter_list|,
name|ByteCount
parameter_list|)
name|unsigned
name|short
name|IOAddress
decl_stmt|;
name|unsigned
name|char
modifier|*
name|DataPointer
decl_stmt|;
name|int
name|ByteCount
decl_stmt|;
block|{
name|outsb
argument_list|(
name|IOAddress
argument_list|,
operator|(
name|void
operator|*
operator|)
name|DataPointer
argument_list|,
name|ByteCount
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DriverRepOutWord
parameter_list|(
name|IOAddress
parameter_list|,
name|DataPointer
parameter_list|,
name|WordCount
parameter_list|)
name|unsigned
name|short
name|IOAddress
decl_stmt|;
name|unsigned
name|short
modifier|*
name|DataPointer
decl_stmt|;
name|int
name|WordCount
decl_stmt|;
block|{
name|outsw
argument_list|(
name|IOAddress
argument_list|,
operator|(
name|void
operator|*
operator|)
name|DataPointer
argument_list|,
name|WordCount
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DriverRepOutDword
parameter_list|(
name|IOAddress
parameter_list|,
name|DataPointer
parameter_list|,
name|DWordCount
parameter_list|)
name|unsigned
name|short
name|IOAddress
decl_stmt|;
name|unsigned
name|long
modifier|*
name|DataPointer
decl_stmt|;
name|int
name|DWordCount
decl_stmt|;
block|{
name|outsl
argument_list|(
name|IOAddress
argument_list|,
operator|(
name|void
operator|*
operator|)
name|DataPointer
argument_list|,
name|DWordCount
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|char
name|DriverInByte
parameter_list|(
name|IOAddress
parameter_list|)
name|unsigned
name|short
name|IOAddress
decl_stmt|;
block|{
return|return
operator|(
name|inb
argument_list|(
name|IOAddress
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|short
name|DriverInWord
parameter_list|(
name|IOAddress
parameter_list|)
name|unsigned
name|short
name|IOAddress
decl_stmt|;
block|{
return|return
operator|(
name|inw
argument_list|(
name|IOAddress
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|long
name|DriverInDword
parameter_list|(
name|IOAddress
parameter_list|)
name|unsigned
name|short
name|IOAddress
decl_stmt|;
block|{
return|return
operator|(
name|inl
argument_list|(
name|IOAddress
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|DriverRepInByte
parameter_list|(
name|IOAddress
parameter_list|,
name|DataPointer
parameter_list|,
name|ByteCount
parameter_list|)
name|unsigned
name|short
name|IOAddress
decl_stmt|;
name|unsigned
name|char
modifier|*
name|DataPointer
decl_stmt|;
name|int
name|ByteCount
decl_stmt|;
block|{
name|insb
argument_list|(
name|IOAddress
argument_list|,
operator|(
name|void
operator|*
operator|)
name|DataPointer
argument_list|,
name|ByteCount
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DriverRepInWord
parameter_list|(
name|IOAddress
parameter_list|,
name|DataPointer
parameter_list|,
name|WordCount
parameter_list|)
name|unsigned
name|short
name|IOAddress
decl_stmt|;
name|unsigned
name|short
modifier|*
name|DataPointer
decl_stmt|;
name|int
name|WordCount
decl_stmt|;
block|{
name|insw
argument_list|(
name|IOAddress
argument_list|,
operator|(
name|void
operator|*
operator|)
name|DataPointer
argument_list|,
name|WordCount
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DriverRepInDword
parameter_list|(
name|IOAddress
parameter_list|,
name|DataPointer
parameter_list|,
name|DWordCount
parameter_list|)
name|unsigned
name|short
name|IOAddress
decl_stmt|;
name|unsigned
name|long
modifier|*
name|DataPointer
decl_stmt|;
name|int
name|DWordCount
decl_stmt|;
block|{
name|insl
argument_list|(
name|IOAddress
argument_list|,
operator|(
name|void
operator|*
operator|)
name|DataPointer
argument_list|,
name|DWordCount
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* TRlldInlineIO */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NOLTR */
end_comment

end_unit


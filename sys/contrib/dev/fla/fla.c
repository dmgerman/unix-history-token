begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * ----------------------------------------------------------------------------  * "THE BEER-WARE LICENSE" (Revision 42):  *<phk@FreeBSD.ORG> wrote this file.  As long as you retain this notice you  * can do whatever you want with this stuff. If we meet some day, and you think  * this stuff is worth it, you can buy me a beer in return.   Poul-Henning Kamp  * ----------------------------------------------------------------------------  *  * $FreeBSD$   *  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/bio.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<machine/resource.h>
end_include

begin_include
include|#
directive|include
file|<geom/geom_disk.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm_param.h>
end_include

begin_include
include|#
directive|include
file|<sys/bus.h>
end_include

begin_define
define|#
directive|define
name|LEAVE
parameter_list|()
end_define

begin_define
define|#
directive|define
name|ENTER
parameter_list|()
end_define

begin_include
include|#
directive|include
file|<contrib/dev/fla/msysosak.h>
end_include

begin_expr_stmt
specifier|static
name|MALLOC_DEFINE
argument_list|(
name|M_FLA
argument_list|,
literal|"fla driver"
argument_list|,
literal|"fla driver storage"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|void
modifier|*
name|doc2k_malloc
parameter_list|(
name|int
name|bytes
parameter_list|)
block|{
return|return
name|malloc
argument_list|(
name|bytes
argument_list|,
name|M_FLA
argument_list|,
name|M_WAITOK
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|doc2k_free
parameter_list|(
name|void
modifier|*
name|ptr
parameter_list|)
block|{
name|free
argument_list|(
name|ptr
argument_list|,
name|M_FLA
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|doc2k_delay
parameter_list|(
name|unsigned
name|msec
parameter_list|)
block|{
name|DELAY
argument_list|(
literal|1000
operator|*
name|msec
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|doc2k_memcpy
parameter_list|(
name|void
modifier|*
name|dst
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|unsigned
name|len
parameter_list|)
block|{
name|bcopy
argument_list|(
name|src
argument_list|,
name|dst
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|doc2k_memcmp
parameter_list|(
specifier|const
name|void
modifier|*
name|dst
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|unsigned
name|len
parameter_list|)
block|{
return|return
operator|(
name|bcmp
argument_list|(
name|src
argument_list|,
name|dst
argument_list|,
name|len
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|doc2k_memset
parameter_list|(
name|void
modifier|*
name|dst
parameter_list|,
name|int
name|c
parameter_list|,
name|unsigned
name|len
parameter_list|)
block|{
name|u_char
modifier|*
name|p
init|=
name|dst
decl_stmt|;
while|while
condition|(
name|len
operator|--
condition|)
operator|*
name|p
operator|++
operator|=
name|c
expr_stmt|;
block|}
end_function

begin_struct
specifier|static
struct|struct
name|fla_s
block|{
name|int
name|busy
decl_stmt|;
name|int
name|unit
decl_stmt|;
name|unsigned
name|nsect
decl_stmt|;
name|struct
name|doc2k_stat
name|ds
decl_stmt|;
name|struct
name|bio_queue_head
name|bio_queue
decl_stmt|;
name|struct
name|disk
modifier|*
name|disk
decl_stmt|;
name|dev_t
name|dev
decl_stmt|;
block|}
name|softc
index|[
literal|8
index|]
struct|;
end_struct

begin_function
specifier|static
name|int
name|flaopen
parameter_list|(
name|struct
name|disk
modifier|*
name|dp
parameter_list|)
block|{
name|struct
name|fla_s
modifier|*
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|;
name|u_int
name|spu
decl_stmt|,
name|ncyl
decl_stmt|,
name|nt
decl_stmt|,
name|ns
decl_stmt|;
name|sc
operator|=
name|dp
operator|->
name|d_drv1
expr_stmt|;
name|error
operator|=
name|doc2k_open
argument_list|(
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"doc2k_open(%d) -> err %d\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|error
operator|=
name|doc2k_size
argument_list|(
name|sc
operator|->
name|unit
argument_list|,
operator|&
name|spu
argument_list|,
operator|&
name|ncyl
argument_list|,
operator|&
name|nt
argument_list|,
operator|&
name|ns
argument_list|)
expr_stmt|;
name|sc
operator|->
name|disk
operator|->
name|d_sectorsize
operator|=
name|DEV_BSIZE
expr_stmt|;
name|sc
operator|->
name|disk
operator|->
name|d_mediasize
operator|=
operator|(
name|off_t
operator|)
name|spu
operator|*
name|DEV_BSIZE
expr_stmt|;
name|sc
operator|->
name|disk
operator|->
name|d_fwsectors
operator|=
name|ns
expr_stmt|;
name|sc
operator|->
name|disk
operator|->
name|d_fwheads
operator|=
name|nt
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|flaclose
parameter_list|(
name|struct
name|disk
modifier|*
name|dp
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|struct
name|fla_s
modifier|*
name|sc
decl_stmt|;
name|sc
operator|=
name|dp
operator|->
name|d_drv1
expr_stmt|;
name|error
operator|=
name|doc2k_close
argument_list|(
name|sc
operator|->
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"doc2k_close(%d) -> err %d\n"
argument_list|,
name|sc
operator|->
name|unit
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|flastrategy
parameter_list|(
name|struct
name|bio
modifier|*
name|bp
parameter_list|)
block|{
name|int
name|unit
decl_stmt|,
name|error
decl_stmt|;
name|struct
name|fla_s
modifier|*
name|sc
decl_stmt|;
name|enum
name|doc2k_work
name|what
decl_stmt|;
name|sc
operator|=
name|bp
operator|->
name|bio_disk
operator|->
name|d_drv1
expr_stmt|;
name|bioq_disksort
argument_list|(
operator|&
name|sc
operator|->
name|bio_queue
argument_list|,
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|sc
operator|->
name|busy
condition|)
block|{
return|return;
block|}
name|sc
operator|->
name|busy
operator|++
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|bp
operator|=
name|bioq_first
argument_list|(
operator|&
name|sc
operator|->
name|bio_queue
argument_list|)
expr_stmt|;
if|if
condition|(
name|bp
condition|)
name|bioq_remove
argument_list|(
operator|&
name|sc
operator|->
name|bio_queue
argument_list|,
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bp
condition|)
break|break;
name|bp
operator|->
name|bio_resid
operator|=
name|bp
operator|->
name|bio_bcount
expr_stmt|;
name|unit
operator|=
name|sc
operator|->
name|unit
expr_stmt|;
if|if
condition|(
name|bp
operator|->
name|bio_cmd
operator|==
name|BIO_DELETE
condition|)
name|what
operator|=
name|DOC2K_ERASE
expr_stmt|;
elseif|else
if|if
condition|(
name|bp
operator|->
name|bio_cmd
operator|==
name|BIO_READ
condition|)
name|what
operator|=
name|DOC2K_READ
expr_stmt|;
else|else
name|what
operator|=
name|DOC2K_WRITE
expr_stmt|;
name|LEAVE
argument_list|()
expr_stmt|;
name|error
operator|=
name|doc2k_rwe
argument_list|(
name|unit
argument_list|,
name|what
argument_list|,
name|bp
operator|->
name|bio_pblkno
argument_list|,
name|bp
operator|->
name|bio_bcount
operator|/
name|DEV_BSIZE
argument_list|,
name|bp
operator|->
name|bio_data
argument_list|)
expr_stmt|;
name|ENTER
argument_list|()
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"fla%d: %d = rwe(%p, %d, %d, %jd, %ld, %p)\n"
argument_list|,
name|unit
argument_list|,
name|error
argument_list|,
name|bp
argument_list|,
name|unit
argument_list|,
name|what
argument_list|,
operator|(
name|intmax_t
operator|)
name|bp
operator|->
name|bio_pblkno
argument_list|,
name|bp
operator|->
name|bio_bcount
operator|/
name|DEV_BSIZE
argument_list|,
name|bp
operator|->
name|bio_data
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|error
condition|)
block|{
name|bp
operator|->
name|bio_error
operator|=
name|EIO
expr_stmt|;
name|bp
operator|->
name|bio_flags
operator||=
name|BIO_ERROR
expr_stmt|;
block|}
else|else
block|{
name|bp
operator|->
name|bio_resid
operator|=
literal|0
expr_stmt|;
block|}
name|biodone
argument_list|(
name|bp
argument_list|)
expr_stmt|;
block|}
name|sc
operator|->
name|busy
operator|=
literal|0
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|flaprobe
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|int
name|unit
decl_stmt|;
name|struct
name|fla_s
modifier|*
name|sc
decl_stmt|;
name|int
name|i
decl_stmt|;
name|unit
operator|=
name|device_get_unit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|unit
operator|>=
literal|8
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|sc
operator|=
operator|&
name|softc
index|[
name|unit
index|]
expr_stmt|;
comment|/* This is slightly ugly */
name|i
operator|=
name|doc2k_probe
argument_list|(
name|unit
argument_list|,
name|KERNBASE
operator|+
literal|0xc0000
argument_list|,
name|KERNBASE
operator|+
literal|0xe0000
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|i
operator|=
name|doc2k_info
argument_list|(
name|unit
argument_list|,
operator|&
name|sc
operator|->
name|ds
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
condition|)
return|return
operator|(
name|ENXIO
operator|)
return|;
name|bus_set_resource
argument_list|(
name|dev
argument_list|,
name|SYS_RES_MEMORY
argument_list|,
literal|0
argument_list|,
name|sc
operator|->
name|ds
operator|.
name|window
operator|-
name|KERNBASE
argument_list|,
literal|8192
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|flaattach
parameter_list|(
name|device_t
name|dev
parameter_list|)
block|{
name|int
name|unit
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|,
name|l
decl_stmt|,
name|m
decl_stmt|,
name|error
decl_stmt|;
name|struct
name|fla_s
modifier|*
name|sc
decl_stmt|;
name|unit
operator|=
name|device_get_unit
argument_list|(
name|dev
argument_list|)
expr_stmt|;
name|sc
operator|=
operator|&
name|softc
index|[
name|unit
index|]
expr_stmt|;
name|error
operator|=
name|doc2k_open
argument_list|(
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"doc2k_open(%d) -> err %d\n"
argument_list|,
name|unit
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|error
operator|=
name|doc2k_size
argument_list|(
name|unit
argument_list|,
operator|&
name|sc
operator|->
name|nsect
argument_list|,
operator|&
name|i
argument_list|,
operator|&
name|j
argument_list|,
operator|&
name|k
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"doc2k_size(%d) -> err %d\n"
argument_list|,
name|unit
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|printf
argument_list|(
literal|"fla%d:<%s %s>\n"
argument_list|,
name|unit
argument_list|,
name|sc
operator|->
name|ds
operator|.
name|product
argument_list|,
name|sc
operator|->
name|ds
operator|.
name|model
argument_list|)
expr_stmt|;
name|error
operator|=
name|doc2k_close
argument_list|(
name|unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|printf
argument_list|(
literal|"doc2k_close(%d) -> err %d\n"
argument_list|,
name|unit
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|EIO
operator|)
return|;
block|}
name|m
operator|=
literal|1024L
operator|*
literal|1024L
operator|/
name|DEV_BSIZE
expr_stmt|;
name|l
operator|=
operator|(
name|sc
operator|->
name|nsect
operator|*
literal|10
operator|+
name|m
operator|/
literal|2
operator|)
operator|/
name|m
expr_stmt|;
name|printf
argument_list|(
literal|"fla%d: %d.%01dMB (%u sectors),"
literal|" %d cyls, %d heads, %d S/T, 512 B/S\n"
argument_list|,
name|unit
argument_list|,
name|l
operator|/
literal|10
argument_list|,
name|l
operator|%
literal|10
argument_list|,
name|sc
operator|->
name|nsect
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
name|k
argument_list|)
expr_stmt|;
if|if
condition|(
name|bootverbose
condition|)
name|printf
argument_list|(
literal|"fla%d: JEDEC=0x%x unitsize=%ld mediasize=%ld"
literal|" chipsize=%ld interleave=%d window=%lx\n"
argument_list|,
name|unit
argument_list|,
name|sc
operator|->
name|ds
operator|.
name|type
argument_list|,
name|sc
operator|->
name|ds
operator|.
name|unitSize
argument_list|,
name|sc
operator|->
name|ds
operator|.
name|mediaSize
argument_list|,
name|sc
operator|->
name|ds
operator|.
name|chipSize
argument_list|,
name|sc
operator|->
name|ds
operator|.
name|interleaving
argument_list|,
name|sc
operator|->
name|ds
operator|.
name|window
argument_list|)
expr_stmt|;
name|bioq_init
argument_list|(
operator|&
name|sc
operator|->
name|bio_queue
argument_list|)
expr_stmt|;
name|sc
operator|->
name|disk
operator|=
name|disk_alloc
argument_list|()
expr_stmt|;
name|sc
operator|->
name|disk
operator|->
name|d_open
operator|=
name|flaopen
expr_stmt|;
name|sc
operator|->
name|disk
operator|->
name|d_close
operator|=
name|flaclose
expr_stmt|;
name|sc
operator|->
name|disk
operator|->
name|d_strategy
operator|=
name|flastrategy
expr_stmt|;
name|sc
operator|->
name|disk
operator|->
name|d_drv1
operator|=
name|sc
expr_stmt|;
name|sc
operator|->
name|disk
operator|->
name|d_name
operator|=
literal|"fla"
expr_stmt|;
name|sc
operator|->
name|disk
operator|->
name|d_maxsize
operator|=
name|MAXPHYS
expr_stmt|;
name|sc
operator|->
name|unit
operator|=
name|unit
expr_stmt|;
name|sc
operator|->
name|disk
operator|->
name|d_unit
operator|=
name|unit
expr_stmt|;
name|sc
operator|->
name|disk
operator|->
name|d_flags
operator|=
name|DISKFLAG_CANDELETE
operator||
name|DISKFLAG_NEEDSGIANT
expr_stmt|;
name|disk_create
argument_list|(
name|sc
operator|->
name|disk
argument_list|,
name|DISK_VERSION
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|device_method_t
name|fla_methods
index|[]
init|=
block|{
comment|/* Device interface */
name|DEVMETHOD
argument_list|(
name|device_probe
argument_list|,
name|flaprobe
argument_list|)
block|,
name|DEVMETHOD
argument_list|(
name|device_attach
argument_list|,
name|flaattach
argument_list|)
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|driver_t
name|fladriver
init|=
block|{
literal|"fla"
block|,
name|fla_methods
block|,
sizeof|sizeof
argument_list|(
expr|struct
name|fla_s
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|devclass_t
name|fla_devclass
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DRIVER_MODULE
argument_list|(
name|fla
argument_list|,
name|isa
argument_list|,
name|fladriver
argument_list|,
name|fla_devclass
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2012, 2013 Adrian Chadd<adrian@FreeBSD.org>.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES  * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF  * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR  * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES  * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN  * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|"opt_ah.h"
end_include

begin_include
include|#
directive|include
file|"ah.h"
end_include

begin_include
include|#
directive|include
file|"ah_internal.h"
end_include

begin_include
include|#
directive|include
file|"ah_devid.h"
end_include

begin_include
include|#
directive|include
file|"ah_desc.h"
end_include

begin_include
include|#
directive|include
file|"ar9300.h"
end_include

begin_include
include|#
directive|include
file|"ar9300reg.h"
end_include

begin_include
include|#
directive|include
file|"ar9300phy.h"
end_include

begin_include
include|#
directive|include
file|"ar9300desc.h"
end_include

begin_include
include|#
directive|include
file|"ar9300_freebsd.h"
end_include

begin_include
include|#
directive|include
file|"ar9300_stub.h"
end_include

begin_include
include|#
directive|include
file|"ar9300_stub_funcs.h"
end_include

begin_define
define|#
directive|define
name|FIX_NOISE_FLOOR
value|1
end_define

begin_define
define|#
directive|define
name|NEXT_TBTT_NOW
value|5
end_define

begin_function_decl
specifier|static
name|HAL_BOOL
name|ar9300ClrMulticastFilterIndex
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|uint32_t
name|ix
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|HAL_BOOL
name|ar9300SetMulticastFilterIndex
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|uint32_t
name|ix
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ar9300_beacon_set_beacon_timers
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|HAL_BEACON_TIMERS
modifier|*
name|bt
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|ar9300SetChainMasks
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|uint32_t
name|tx_chainmask
parameter_list|,
name|uint32_t
name|rx_chainmask
parameter_list|)
block|{
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_tx_chainmask
operator|=
name|tx_chainmask
operator|&
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_caps
operator|.
name|halTxChainMask
expr_stmt|;
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_rx_chainmask
operator|=
name|rx_chainmask
operator|&
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_caps
operator|.
name|halRxChainMask
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|u_int
name|ar9300GetSlotTime
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|u_int
name|clks
init|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_D_GBL_IFS_SLOT
argument_list|)
operator|&
literal|0xffff
decl_stmt|;
return|return
operator|(
name|ath_hal_mac_usec
argument_list|(
name|ah
argument_list|,
name|clks
argument_list|)
operator|)
return|;
comment|/* convert from system clocks */
block|}
end_function

begin_function
specifier|static
name|HAL_BOOL
name|ar9300_freebsd_set_tx_power_limit
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|uint32_t
name|limit
parameter_list|)
block|{
return|return
operator|(
name|ar9300_set_tx_power_limit
argument_list|(
name|ah
argument_list|,
name|limit
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint64_t
name|ar9300_get_next_tbtt
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
return|return
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_NEXT_TBTT_TIMER
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * TODO: implement the antenna diversity control for AR9485 and  * other LNA mixing based NICs.  *  * For now we'll just go with the HAL default and make these no-ops.  */
end_comment

begin_function
specifier|static
name|HAL_ANT_SETTING
name|ar9300_freebsd_get_antenna_switch
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
return|return
operator|(
name|HAL_ANT_VARIABLE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|HAL_BOOL
name|ar9300_freebsd_set_antenna_switch
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_ANT_SETTING
name|setting
parameter_list|)
block|{
return|return
operator|(
name|AH_TRUE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|u_int
name|ar9300_freebsd_get_cts_timeout
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|u_int
name|clks
init|=
name|MS
argument_list|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_TIME_OUT
argument_list|)
argument_list|,
name|AR_TIME_OUT_CTS
argument_list|)
decl_stmt|;
return|return
name|ath_hal_mac_usec
argument_list|(
name|ah
argument_list|,
name|clks
argument_list|)
return|;
comment|/* convert from system clocks */
block|}
end_function

begin_function
specifier|static
name|void
name|ar9300_freebsd_set_tsf64
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|uint64_t
name|tsf64
parameter_list|)
block|{
comment|/* 	 * XXX TODO: read ar5416SetTsf64() - we should wait before we do 	 * this. 	 */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_TSF_L32
argument_list|,
name|tsf64
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_TSF_U32
argument_list|,
operator|(
name|tsf64
operator|>>
literal|32
operator|)
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Flags for pulse_bw_info */
end_comment

begin_define
define|#
directive|define
name|PRI_CH_RADAR_FOUND
value|0x01
end_define

begin_define
define|#
directive|define
name|EXT_CH_RADAR_FOUND
value|0x02
end_define

begin_define
define|#
directive|define
name|EXT_CH_RADAR_EARLY_FOUND
value|0x04
end_define

begin_function
specifier|static
name|HAL_BOOL
name|ar9300_freebsd_proc_radar_event
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_rx_status
modifier|*
name|rxs
parameter_list|,
name|uint64_t
name|fulltsf
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|HAL_DFS_EVENT
modifier|*
name|event
parameter_list|)
block|{
name|HAL_BOOL
name|doDfsExtCh
decl_stmt|;
name|HAL_BOOL
name|doDfsEnhanced
decl_stmt|;
name|HAL_BOOL
name|doDfsCombinedRssi
decl_stmt|;
name|uint8_t
name|rssi
init|=
literal|0
decl_stmt|,
name|ext_rssi
init|=
literal|0
decl_stmt|;
name|uint8_t
name|pulse_bw_info
init|=
literal|0
decl_stmt|,
name|pulse_length_ext
init|=
literal|0
decl_stmt|,
name|pulse_length_pri
init|=
literal|0
decl_stmt|;
name|uint32_t
name|dur
init|=
literal|0
decl_stmt|;
name|int
name|pri_found
init|=
literal|1
decl_stmt|,
name|ext_found
init|=
literal|0
decl_stmt|;
name|int
name|early_ext
init|=
literal|0
decl_stmt|;
name|int
name|is_dc
init|=
literal|0
decl_stmt|;
name|uint16_t
name|datalen
decl_stmt|;
comment|/* length from the RX status field */
comment|/* Check whether the given phy error is a radar event */
if|if
condition|(
operator|(
name|rxs
operator|->
name|rs_phyerr
operator|!=
name|HAL_PHYERR_RADAR
operator|)
operator|&&
operator|(
name|rxs
operator|->
name|rs_phyerr
operator|!=
name|HAL_PHYERR_FALSE_RADAR_EXT
operator|)
condition|)
block|{
return|return
name|AH_FALSE
return|;
block|}
comment|/* Grab copies of the capabilities; just to make the code clearer */
name|doDfsExtCh
operator|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_caps
operator|.
name|halExtChanDfsSupport
expr_stmt|;
name|doDfsEnhanced
operator|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_caps
operator|.
name|halEnhancedDfsSupport
expr_stmt|;
name|doDfsCombinedRssi
operator|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_caps
operator|.
name|halUseCombinedRadarRssi
expr_stmt|;
name|datalen
operator|=
name|rxs
operator|->
name|rs_datalen
expr_stmt|;
comment|/* If hardware supports it, use combined RSSI, else use chain 0 RSSI */
if|if
condition|(
name|doDfsCombinedRssi
condition|)
name|rssi
operator|=
operator|(
name|uint8_t
operator|)
name|rxs
operator|->
name|rs_rssi
expr_stmt|;
else|else
name|rssi
operator|=
operator|(
name|uint8_t
operator|)
name|rxs
operator|->
name|rs_rssi_ctl
index|[
literal|0
index|]
expr_stmt|;
comment|/* Set this; but only use it if doDfsExtCh is set */
name|ext_rssi
operator|=
operator|(
name|uint8_t
operator|)
name|rxs
operator|->
name|rs_rssi_ext
index|[
literal|0
index|]
expr_stmt|;
comment|/* Cap it at 0 if the RSSI is a negative number */
if|if
condition|(
name|rssi
operator|&
literal|0x80
condition|)
name|rssi
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ext_rssi
operator|&
literal|0x80
condition|)
name|ext_rssi
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Fetch the relevant data from the frame 	 */
if|if
condition|(
name|doDfsExtCh
condition|)
block|{
if|if
condition|(
name|datalen
operator|<
literal|3
condition|)
return|return
name|AH_FALSE
return|;
comment|/* Last three bytes of the frame are of interest */
name|pulse_length_pri
operator|=
operator|*
operator|(
name|buf
operator|+
name|datalen
operator|-
literal|3
operator|)
expr_stmt|;
name|pulse_length_ext
operator|=
operator|*
operator|(
name|buf
operator|+
name|datalen
operator|-
literal|2
operator|)
expr_stmt|;
name|pulse_bw_info
operator|=
operator|*
operator|(
name|buf
operator|+
name|datalen
operator|-
literal|1
operator|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_DFS
argument_list|,
literal|"%s: rssi=%d, ext_rssi=%d, pulse_length_pri=%d,"
literal|" pulse_length_ext=%d, pulse_bw_info=%x\n"
argument_list|,
name|__func__
argument_list|,
name|rssi
argument_list|,
name|ext_rssi
argument_list|,
name|pulse_length_pri
argument_list|,
name|pulse_length_ext
argument_list|,
name|pulse_bw_info
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* The pulse width is byte 0 of the data */
if|if
condition|(
name|datalen
operator|>=
literal|1
condition|)
name|dur
operator|=
operator|(
operator|(
name|uint8_t
operator|)
name|buf
index|[
literal|0
index|]
operator|)
operator|&
literal|0xff
expr_stmt|;
else|else
name|dur
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|dur
operator|==
literal|0
operator|&&
name|rssi
operator|==
literal|0
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_DFS
argument_list|,
literal|"%s: dur and rssi are 0\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_DFS
argument_list|,
literal|"%s: rssi=%d, dur=%d\n"
argument_list|,
name|__func__
argument_list|,
name|rssi
argument_list|,
name|dur
argument_list|)
expr_stmt|;
comment|/* Single-channel only */
name|pri_found
operator|=
literal|1
expr_stmt|;
name|ext_found
operator|=
literal|0
expr_stmt|;
block|}
comment|/* 	 * If doing extended channel data, pulse_bw_info must 	 * have one of the flags set. 	 */
if|if
condition|(
name|doDfsExtCh
operator|&&
name|pulse_bw_info
operator|==
literal|0x0
condition|)
return|return
name|AH_FALSE
return|;
comment|/* 	 * If the extended channel data is available, calculate 	 * which to pay attention to. 	 */
if|if
condition|(
name|doDfsExtCh
condition|)
block|{
comment|/* If pulse is on DC, take the larger duration of the two */
if|if
condition|(
operator|(
name|pulse_bw_info
operator|&
name|EXT_CH_RADAR_FOUND
operator|)
operator|&&
operator|(
name|pulse_bw_info
operator|&
name|PRI_CH_RADAR_FOUND
operator|)
condition|)
block|{
name|is_dc
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|pulse_length_ext
operator|>
name|pulse_length_pri
condition|)
block|{
name|dur
operator|=
name|pulse_length_ext
expr_stmt|;
name|pri_found
operator|=
literal|0
expr_stmt|;
name|ext_found
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|dur
operator|=
name|pulse_length_pri
expr_stmt|;
name|pri_found
operator|=
literal|1
expr_stmt|;
name|ext_found
operator|=
literal|0
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|pulse_bw_info
operator|&
name|EXT_CH_RADAR_EARLY_FOUND
condition|)
block|{
name|dur
operator|=
name|pulse_length_ext
expr_stmt|;
name|pri_found
operator|=
literal|0
expr_stmt|;
name|ext_found
operator|=
literal|1
expr_stmt|;
name|early_ext
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pulse_bw_info
operator|&
name|PRI_CH_RADAR_FOUND
condition|)
block|{
name|dur
operator|=
name|pulse_length_pri
expr_stmt|;
name|pri_found
operator|=
literal|1
expr_stmt|;
name|ext_found
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pulse_bw_info
operator|&
name|EXT_CH_RADAR_FOUND
condition|)
block|{
name|dur
operator|=
name|pulse_length_ext
expr_stmt|;
name|pri_found
operator|=
literal|0
expr_stmt|;
name|ext_found
operator|=
literal|1
expr_stmt|;
block|}
block|}
comment|/* 	 * For enhanced DFS (Merlin and later), pulse_bw_info has 	 * implications for selecting the correct RSSI value. 	 */
if|if
condition|(
name|doDfsEnhanced
condition|)
block|{
switch|switch
condition|(
name|pulse_bw_info
operator|&
literal|0x03
condition|)
block|{
case|case
literal|0
case|:
comment|/* No radar? */
name|rssi
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|PRI_CH_RADAR_FOUND
case|:
comment|/* Radar in primary channel */
comment|/* Cannot use ctrl channel RSSI if ext channel is stronger */
if|if
condition|(
name|ext_rssi
operator|>=
operator|(
name|rssi
operator|+
literal|3
operator|)
condition|)
block|{
name|rssi
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|EXT_CH_RADAR_FOUND
case|:
comment|/* Radar in extended channel */
comment|/* Cannot use ext channel RSSI if ctrl channel is stronger */
if|if
condition|(
name|rssi
operator|>=
operator|(
name|ext_rssi
operator|+
literal|12
operator|)
condition|)
block|{
name|rssi
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|rssi
operator|=
name|ext_rssi
expr_stmt|;
block|}
break|break;
case|case
operator|(
name|PRI_CH_RADAR_FOUND
operator||
name|EXT_CH_RADAR_FOUND
operator|)
case|:
comment|/* When both are present, use stronger one */
if|if
condition|(
name|rssi
operator|<
name|ext_rssi
condition|)
name|rssi
operator|=
name|ext_rssi
expr_stmt|;
break|break;
block|}
block|}
comment|/* 	 * If not doing enhanced DFS, choose the ext channel if 	 * it is stronger than the main channel 	 */
if|if
condition|(
name|doDfsExtCh
operator|&&
operator|!
name|doDfsEnhanced
condition|)
block|{
if|if
condition|(
operator|(
name|ext_rssi
operator|>
name|rssi
operator|)
operator|&&
operator|(
name|ext_rssi
operator|<
literal|128
operator|)
condition|)
name|rssi
operator|=
name|ext_rssi
expr_stmt|;
block|}
comment|/* 	 * XXX what happens if the above code decides the RSSI 	 * XXX wasn't valid, an sets it to 0? 	 */
comment|/* 	 * Fill out dfs_event structure. 	 */
name|event
operator|->
name|re_full_ts
operator|=
name|fulltsf
expr_stmt|;
name|event
operator|->
name|re_ts
operator|=
name|rxs
operator|->
name|rs_tstamp
expr_stmt|;
name|event
operator|->
name|re_rssi
operator|=
name|rssi
expr_stmt|;
name|event
operator|->
name|re_dur
operator|=
name|dur
expr_stmt|;
name|event
operator|->
name|re_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pri_found
condition|)
name|event
operator|->
name|re_flags
operator||=
name|HAL_DFS_EVENT_PRICH
expr_stmt|;
if|if
condition|(
name|ext_found
condition|)
name|event
operator|->
name|re_flags
operator||=
name|HAL_DFS_EVENT_EXTCH
expr_stmt|;
if|if
condition|(
name|early_ext
condition|)
name|event
operator|->
name|re_flags
operator||=
name|HAL_DFS_EVENT_EXTEARLY
expr_stmt|;
if|if
condition|(
name|is_dc
condition|)
name|event
operator|->
name|re_flags
operator||=
name|HAL_DFS_EVENT_ISDC
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_function
name|void
name|ar9300_attach_freebsd_ops
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
comment|/* Global functions */
name|ah
operator|->
name|ah_detach
operator|=
name|ar9300_detach
expr_stmt|;
name|ah
operator|->
name|ah_getRateTable
operator|=
name|ar9300_get_rate_table
expr_stmt|;
comment|/* Reset functions */
name|ah
operator|->
name|ah_reset
operator|=
name|ar9300_reset_freebsd
expr_stmt|;
name|ah
operator|->
name|ah_phyDisable
operator|=
name|ar9300_phy_disable
expr_stmt|;
name|ah
operator|->
name|ah_disable
operator|=
name|ar9300_disable
expr_stmt|;
name|ah
operator|->
name|ah_configPCIE
operator|=
name|ar9300_config_pcie_freebsd
expr_stmt|;
comment|//	ah->ah_disablePCIE		= ar9300_disable_pcie_phy;
name|ah
operator|->
name|ah_setPCUConfig
operator|=
name|ar9300_set_pcu_config
expr_stmt|;
comment|// perCalibration
name|ah
operator|->
name|ah_perCalibrationN
operator|=
name|ar9300_per_calibration_freebsd
expr_stmt|;
name|ah
operator|->
name|ah_resetCalValid
operator|=
name|ar9300_reset_cal_valid_freebsd
expr_stmt|;
name|ah
operator|->
name|ah_setTxPowerLimit
operator|=
name|ar9300_freebsd_set_tx_power_limit
expr_stmt|;
name|ah
operator|->
name|ah_getChanNoise
operator|=
name|ath_hal_getChanNoise
expr_stmt|;
comment|/* Transmit functions */
name|ah
operator|->
name|ah_setupTxQueue
operator|=
name|ar9300_setup_tx_queue
expr_stmt|;
name|ah
operator|->
name|ah_setTxQueueProps
operator|=
name|ar9300_set_tx_queue_props
expr_stmt|;
name|ah
operator|->
name|ah_getTxQueueProps
operator|=
name|ar9300_get_tx_queue_props
expr_stmt|;
name|ah
operator|->
name|ah_releaseTxQueue
operator|=
name|ar9300_release_tx_queue
expr_stmt|;
name|ah
operator|->
name|ah_resetTxQueue
operator|=
name|ar9300_reset_tx_queue
expr_stmt|;
name|ah
operator|->
name|ah_getTxDP
operator|=
name|ar9300_get_tx_dp
expr_stmt|;
name|ah
operator|->
name|ah_setTxDP
operator|=
name|ar9300_set_tx_dp
expr_stmt|;
name|ah
operator|->
name|ah_numTxPending
operator|=
name|ar9300_num_tx_pending
expr_stmt|;
name|ah
operator|->
name|ah_startTxDma
operator|=
name|ar9300_start_tx_dma
expr_stmt|;
name|ah
operator|->
name|ah_stopTxDma
operator|=
name|ar9300_stop_tx_dma_freebsd
expr_stmt|;
name|ah
operator|->
name|ah_setupTxDesc
operator|=
name|ar9300_freebsd_setup_tx_desc
expr_stmt|;
name|ah
operator|->
name|ah_setupXTxDesc
operator|=
name|ar9300_freebsd_setup_x_tx_desc
expr_stmt|;
name|ah
operator|->
name|ah_fillTxDesc
operator|=
name|ar9300_freebsd_fill_tx_desc
expr_stmt|;
name|ah
operator|->
name|ah_procTxDesc
operator|=
name|ar9300_freebsd_proc_tx_desc
expr_stmt|;
name|ah
operator|->
name|ah_getTxIntrQueue
operator|=
name|ar9300_get_tx_intr_queue
expr_stmt|;
comment|// reqTxIntrDesc
name|ah
operator|->
name|ah_getTxCompletionRates
operator|=
name|ar9300_freebsd_get_tx_completion_rates
expr_stmt|;
name|ah
operator|->
name|ah_setTxDescLink
operator|=
name|ar9300_set_desc_link
expr_stmt|;
name|ah
operator|->
name|ah_getTxDescLink
operator|=
name|ar9300_freebsd_get_desc_link
expr_stmt|;
name|ah
operator|->
name|ah_getTxDescLinkPtr
operator|=
name|ar9300_get_desc_link_ptr
expr_stmt|;
name|ah
operator|->
name|ah_setupTxStatusRing
operator|=
name|ar9300_setup_tx_status_ring
expr_stmt|;
name|ah
operator|->
name|ah_getTxRawTxDesc
operator|=
name|ar9300_get_raw_tx_desc
expr_stmt|;
name|ah
operator|->
name|ah_updateTxTrigLevel
operator|=
name|ar9300_update_tx_trig_level
expr_stmt|;
comment|/* RX functions */
name|ah
operator|->
name|ah_getRxDP
operator|=
name|ar9300_get_rx_dp
expr_stmt|;
name|ah
operator|->
name|ah_setRxDP
operator|=
name|ar9300_set_rx_dp
expr_stmt|;
name|ah
operator|->
name|ah_enableReceive
operator|=
name|ar9300_enable_receive
expr_stmt|;
name|ah
operator|->
name|ah_stopDmaReceive
operator|=
name|ar9300_stop_dma_receive_freebsd
expr_stmt|;
name|ah
operator|->
name|ah_startPcuReceive
operator|=
name|ar9300_start_pcu_receive_freebsd
expr_stmt|;
name|ah
operator|->
name|ah_stopPcuReceive
operator|=
name|ar9300_stop_pcu_receive
expr_stmt|;
name|ah
operator|->
name|ah_setMulticastFilter
operator|=
name|ar9300_set_multicast_filter
expr_stmt|;
name|ah
operator|->
name|ah_setMulticastFilterIndex
operator|=
name|ar9300SetMulticastFilterIndex
expr_stmt|;
name|ah
operator|->
name|ah_clrMulticastFilterIndex
operator|=
name|ar9300ClrMulticastFilterIndex
expr_stmt|;
name|ah
operator|->
name|ah_getRxFilter
operator|=
name|ar9300_get_rx_filter
expr_stmt|;
name|ah
operator|->
name|ah_setRxFilter
operator|=
name|ar9300_set_rx_filter
expr_stmt|;
comment|/* setupRxDesc */
name|ah
operator|->
name|ah_procRxDesc
operator|=
name|ar9300_proc_rx_desc_freebsd
expr_stmt|;
name|ah
operator|->
name|ah_rxMonitor
operator|=
name|ar9300_ani_rxmonitor_freebsd
expr_stmt|;
name|ah
operator|->
name|ah_aniPoll
operator|=
name|ar9300_ani_poll_freebsd
expr_stmt|;
name|ah
operator|->
name|ah_procMibEvent
operator|=
name|ar9300_process_mib_intr
expr_stmt|;
comment|/* Misc functions */
name|ah
operator|->
name|ah_getCapability
operator|=
name|ar9300_get_capability
expr_stmt|;
name|ah
operator|->
name|ah_setCapability
operator|=
name|ar9300_set_capability
expr_stmt|;
name|ah
operator|->
name|ah_getDiagState
operator|=
name|ar9300_get_diag_state
expr_stmt|;
name|ah
operator|->
name|ah_getMacAddress
operator|=
name|ar9300_get_mac_address
expr_stmt|;
name|ah
operator|->
name|ah_setMacAddress
operator|=
name|ar9300_set_mac_address
expr_stmt|;
name|ah
operator|->
name|ah_getBssIdMask
operator|=
name|ar9300_get_bss_id_mask
expr_stmt|;
name|ah
operator|->
name|ah_setBssIdMask
operator|=
name|ar9300_set_bss_id_mask
expr_stmt|;
name|ah
operator|->
name|ah_setRegulatoryDomain
operator|=
name|ar9300_set_regulatory_domain
expr_stmt|;
name|ah
operator|->
name|ah_setLedState
operator|=
name|ar9300_set_led_state
expr_stmt|;
name|ah
operator|->
name|ah_writeAssocid
operator|=
name|ar9300_write_associd
expr_stmt|;
name|ah
operator|->
name|ah_gpioCfgInput
operator|=
name|ar9300_gpio_cfg_input
expr_stmt|;
name|ah
operator|->
name|ah_gpioCfgOutput
operator|=
name|ar9300_gpio_cfg_output
expr_stmt|;
name|ah
operator|->
name|ah_gpioGet
operator|=
name|ar9300_gpio_get
expr_stmt|;
name|ah
operator|->
name|ah_gpioSet
operator|=
name|ar9300_gpio_set
expr_stmt|;
name|ah
operator|->
name|ah_gpioSetIntr
operator|=
name|ar9300_gpio_set_intr
expr_stmt|;
comment|/* polarity */
comment|/* mask */
name|ah
operator|->
name|ah_getTsf32
operator|=
name|ar9300_get_tsf32
expr_stmt|;
name|ah
operator|->
name|ah_getTsf64
operator|=
name|ar9300_get_tsf64
expr_stmt|;
name|ah
operator|->
name|ah_resetTsf
operator|=
name|ar9300_reset_tsf
expr_stmt|;
name|ah
operator|->
name|ah_setTsf64
operator|=
name|ar9300_freebsd_set_tsf64
expr_stmt|;
name|ah
operator|->
name|ah_detectCardPresent
operator|=
name|ar9300_detect_card_present
expr_stmt|;
comment|// ah->ah_updateMibCounters	= ar9300_update_mib_counters;
name|ah
operator|->
name|ah_getRfGain
operator|=
name|ar9300_get_rfgain
expr_stmt|;
name|ah
operator|->
name|ah_getDefAntenna
operator|=
name|ar9300_get_def_antenna
expr_stmt|;
name|ah
operator|->
name|ah_setDefAntenna
operator|=
name|ar9300_set_def_antenna
expr_stmt|;
name|ah
operator|->
name|ah_getAntennaSwitch
operator|=
name|ar9300_freebsd_get_antenna_switch
expr_stmt|;
name|ah
operator|->
name|ah_setAntennaSwitch
operator|=
name|ar9300_freebsd_set_antenna_switch
expr_stmt|;
comment|// ah->ah_setSifsTime		= ar9300_set_sifs_time;
comment|// ah->ah_getSifsTime		= ar9300_get_sifs_time;
name|ah
operator|->
name|ah_setSlotTime
operator|=
name|ar9300_set_slot_time
expr_stmt|;
name|ah
operator|->
name|ah_getSlotTime
operator|=
name|ar9300GetSlotTime
expr_stmt|;
name|ah
operator|->
name|ah_getAckTimeout
operator|=
name|ar9300_get_ack_timeout
expr_stmt|;
name|ah
operator|->
name|ah_setAckTimeout
operator|=
name|ar9300_set_ack_timeout
expr_stmt|;
comment|// XXX ack/ctsrate
comment|// XXX CTS timeout
name|ah
operator|->
name|ah_getCTSTimeout
operator|=
name|ar9300_freebsd_get_cts_timeout
expr_stmt|;
comment|// XXX decompmask
comment|// coverageclass
name|ah
operator|->
name|ah_setQuiet
operator|=
name|ar9300_set_quiet
expr_stmt|;
name|ah
operator|->
name|ah_getMibCycleCounts
operator|=
name|ar9300_freebsd_get_mib_cycle_counts
expr_stmt|;
comment|/* DFS functions */
name|ah
operator|->
name|ah_enableDfs
operator|=
name|ar9300_enable_dfs
expr_stmt|;
name|ah
operator|->
name|ah_getDfsThresh
operator|=
name|ar9300_get_dfs_thresh
expr_stmt|;
name|ah
operator|->
name|ah_getDfsDefaultThresh
operator|=
name|ar9300_get_default_dfs_thresh
expr_stmt|;
name|ah
operator|->
name|ah_procRadarEvent
operator|=
name|ar9300_freebsd_proc_radar_event
expr_stmt|;
name|ah
operator|->
name|ah_isFastClockEnabled
operator|=
name|ar9300_is_fast_clock_enabled
expr_stmt|;
name|ah
operator|->
name|ah_get11nExtBusy
operator|=
name|ar9300_get_11n_ext_busy
expr_stmt|;
name|ah
operator|->
name|ah_setDfsCacTxQuiet
operator|=
name|ar9300_cac_tx_quiet
expr_stmt|;
comment|/* Spectral Scan Functions */
name|ah
operator|->
name|ah_spectralConfigure
operator|=
name|ar9300_configure_spectral_scan
expr_stmt|;
name|ah
operator|->
name|ah_spectralGetConfig
operator|=
name|ar9300_get_spectral_params
expr_stmt|;
name|ah
operator|->
name|ah_spectralStart
operator|=
name|ar9300_start_spectral_scan
expr_stmt|;
name|ah
operator|->
name|ah_spectralStop
operator|=
name|ar9300_stop_spectral_scan
expr_stmt|;
name|ah
operator|->
name|ah_spectralIsEnabled
operator|=
name|ar9300_is_spectral_enabled
expr_stmt|;
name|ah
operator|->
name|ah_spectralIsActive
operator|=
name|ar9300_is_spectral_active
expr_stmt|;
comment|/* Key cache functions */
name|ah
operator|->
name|ah_getKeyCacheSize
operator|=
name|ar9300_get_key_cache_size
expr_stmt|;
name|ah
operator|->
name|ah_resetKeyCacheEntry
operator|=
name|ar9300_reset_key_cache_entry
expr_stmt|;
name|ah
operator|->
name|ah_isKeyCacheEntryValid
operator|=
name|ar9300_is_key_cache_entry_valid
expr_stmt|;
name|ah
operator|->
name|ah_setKeyCacheEntry
operator|=
name|ar9300_set_key_cache_entry
expr_stmt|;
name|ah
operator|->
name|ah_setKeyCacheEntryMac
operator|=
name|ar9300_set_key_cache_entry_mac
expr_stmt|;
comment|/* Power management functions */
name|ah
operator|->
name|ah_setPowerMode
operator|=
name|ar9300_set_power_mode
expr_stmt|;
name|ah
operator|->
name|ah_getPowerMode
operator|=
name|ar9300_get_power_mode
expr_stmt|;
comment|/* Beacon functions */
comment|/* ah_setBeaconTimers */
name|ah
operator|->
name|ah_beaconInit
operator|=
name|ar9300_freebsd_beacon_init
expr_stmt|;
name|ah
operator|->
name|ah_setBeaconTimers
operator|=
name|ar9300_beacon_set_beacon_timers
expr_stmt|;
name|ah
operator|->
name|ah_setStationBeaconTimers
operator|=
name|ar9300_set_sta_beacon_timers
expr_stmt|;
comment|/* ah_resetStationBeaconTimers */
name|ah
operator|->
name|ah_getNextTBTT
operator|=
name|ar9300_get_next_tbtt
expr_stmt|;
comment|/* Interrupt functions */
name|ah
operator|->
name|ah_isInterruptPending
operator|=
name|ar9300_is_interrupt_pending
expr_stmt|;
name|ah
operator|->
name|ah_getPendingInterrupts
operator|=
name|ar9300_get_pending_interrupts_freebsd
expr_stmt|;
name|ah
operator|->
name|ah_getInterrupts
operator|=
name|ar9300_get_interrupts
expr_stmt|;
name|ah
operator|->
name|ah_setInterrupts
operator|=
name|ar9300_set_interrupts_freebsd
expr_stmt|;
comment|/* Regulatory/internal functions */
comment|//    AH_PRIVATE(ah)->ah_getNfAdjust = ar9300_get_nf_adjust;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_eepromRead
operator|=
name|ar9300_eeprom_read_word
expr_stmt|;
comment|//    AH_PRIVATE(ah)->ah_getChipPowerLimits = ar9300_get_chip_power_limits;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_getWirelessModes
operator|=
name|ar9300_get_wireless_modes
expr_stmt|;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_getChannelEdges
operator|=
name|ar9300_get_channel_edges
expr_stmt|;
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_eepromRead
operator|=
name|ar9300_eeprom_read_word
expr_stmt|;
comment|/* XXX ah_eeprom */
comment|/* XXX ah_eeversion */
comment|/* XXX ah_eepromDetach */
comment|/* XXX ah_eepromGet */
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_eepromGet
operator|=
name|ar9300_eeprom_get_freebsd
expr_stmt|;
comment|/* XXX ah_eepromSet */
comment|/* XXX ah_getSpurChan */
comment|/* XXX ah_eepromDiag */
comment|/* 802.11n functions */
name|ah
operator|->
name|ah_chainTxDesc
operator|=
name|ar9300_freebsd_chain_tx_desc
expr_stmt|;
name|ah
operator|->
name|ah_setupFirstTxDesc
operator|=
name|ar9300_freebsd_setup_first_tx_desc
expr_stmt|;
name|ah
operator|->
name|ah_setupLastTxDesc
operator|=
name|ar9300_freebsd_setup_last_tx_desc
expr_stmt|;
name|ah
operator|->
name|ah_set11nRateScenario
operator|=
name|ar9300_freebsd_set_11n_rate_scenario
expr_stmt|;
name|ah
operator|->
name|ah_set11nTxDesc
operator|=
name|ar9300_freebsd_setup_11n_desc
expr_stmt|;
name|ah
operator|->
name|ah_set11nAggrFirst
operator|=
name|ar9300_set_11n_aggr_first
expr_stmt|;
name|ah
operator|->
name|ah_set11nAggrMiddle
operator|=
name|ar9300_set_11n_aggr_middle
expr_stmt|;
name|ah
operator|->
name|ah_set11nAggrLast
operator|=
name|ar9300_set_11n_aggr_last
expr_stmt|;
name|ah
operator|->
name|ah_clr11nAggr
operator|=
name|ar9300_clr_11n_aggr
expr_stmt|;
name|ah
operator|->
name|ah_set11nBurstDuration
operator|=
name|ar9300_set_11n_burst_duration
expr_stmt|;
comment|/* ah_get11nExtBusy */
name|ah
operator|->
name|ah_set11nMac2040
operator|=
name|ar9300_set_11n_mac2040
expr_stmt|;
name|ah
operator|->
name|ah_setChainMasks
operator|=
name|ar9300SetChainMasks
expr_stmt|;
comment|/* ah_get11nRxClear */
comment|/* ah_set11nRxClear */
comment|/* bluetooth coexistence functions */
name|ah
operator|->
name|ah_btCoexSetInfo
operator|=
name|ar9300_set_bt_coex_info
expr_stmt|;
name|ah
operator|->
name|ah_btCoexSetConfig
operator|=
name|ar9300_bt_coex_config
expr_stmt|;
name|ah
operator|->
name|ah_btCoexSetQcuThresh
operator|=
name|ar9300_bt_coex_set_qcu_thresh
expr_stmt|;
name|ah
operator|->
name|ah_btCoexSetWeights
operator|=
name|ar9300_bt_coex_set_weights
expr_stmt|;
name|ah
operator|->
name|ah_btCoexSetBmissThresh
operator|=
name|ar9300_bt_coex_setup_bmiss_thresh
expr_stmt|;
name|ah
operator|->
name|ah_btCoexSetParameter
operator|=
name|ar9300_bt_coex_set_parameter
expr_stmt|;
name|ah
operator|->
name|ah_btCoexDisable
operator|=
name|ar9300_bt_coex_disable
expr_stmt|;
name|ah
operator|->
name|ah_btCoexEnable
operator|=
name|ar9300_bt_coex_enable
expr_stmt|;
comment|/* MCI bluetooth functions */
if|if
condition|(
name|AR_SREV_JUPITER
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_APHRODITE
argument_list|(
name|ah
argument_list|)
condition|)
block|{
comment|/* 		 * Note: these are done in attach too for now, because 		 * at this point we haven't yet setup the mac/bb revision 		 * values, so this code is effectively NULL. 		 * However, I'm leaving this here so people digging 		 * into the code (a) see the MCI bits here, and (b) 		 * are now told they should look elsewhere for 		 * these methods. 		 */
name|ah
operator|->
name|ah_btCoexSetWeights
operator|=
name|ar9300_mci_bt_coex_set_weights
expr_stmt|;
name|ah
operator|->
name|ah_btCoexDisable
operator|=
name|ar9300_mci_bt_coex_disable
expr_stmt|;
name|ah
operator|->
name|ah_btCoexEnable
operator|=
name|ar9300_mci_bt_coex_enable
expr_stmt|;
block|}
name|ah
operator|->
name|ah_btMciSetup
operator|=
name|ar9300_mci_setup
expr_stmt|;
name|ah
operator|->
name|ah_btMciSendMessage
operator|=
name|ar9300_mci_send_message
expr_stmt|;
name|ah
operator|->
name|ah_btMciGetInterrupt
operator|=
name|ar9300_mci_get_interrupt
expr_stmt|;
name|ah
operator|->
name|ah_btMciState
operator|=
name|ar9300_mci_state
expr_stmt|;
name|ah
operator|->
name|ah_btMciDetach
operator|=
name|ar9300_mci_detach
expr_stmt|;
comment|/* LNA diversity functions */
name|ah
operator|->
name|ah_divLnaConfGet
operator|=
name|ar9300_ant_div_comb_get_config
expr_stmt|;
name|ah
operator|->
name|ah_divLnaConfSet
operator|=
name|ar9300_ant_div_comb_set_config
expr_stmt|;
block|}
end_function

begin_function
name|HAL_BOOL
name|ar9300_reset_freebsd
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_OPMODE
name|opmode
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|chan
parameter_list|,
name|HAL_BOOL
name|bChannelChange
parameter_list|,
name|HAL_RESET_TYPE
name|resetType
parameter_list|,
name|HAL_STATUS
modifier|*
name|status
parameter_list|)
block|{
name|HAL_BOOL
name|r
decl_stmt|;
name|HAL_HT_MACMODE
name|macmode
decl_stmt|;
name|struct
name|ath_hal_private
modifier|*
name|ap
init|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|macmode
operator|=
name|IEEE80211_IS_CHAN_HT40
argument_list|(
name|chan
argument_list|)
condition|?
name|HAL_HT_MACMODE_2040
else|:
name|HAL_HT_MACMODE_20
expr_stmt|;
name|r
operator|=
name|ar9300_reset
argument_list|(
name|ah
argument_list|,
name|opmode
argument_list|,
name|chan
argument_list|,
name|macmode
argument_list|,
name|ap
operator|->
name|ah_caps
operator|.
name|halTxChainMask
argument_list|,
name|ap
operator|->
name|ah_caps
operator|.
name|halRxChainMask
argument_list|,
name|HAL_HT_EXTPROTSPACING_20
argument_list|,
comment|/* always 20Mhz channel spacing */
name|bChannelChange
argument_list|,
name|status
argument_list|,
name|AH_FALSE
argument_list|)
expr_stmt|;
comment|/* XXX should really extend ath_hal_reset() */
return|return
operator|(
name|r
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ar9300_config_pcie_freebsd
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|restore
parameter_list|,
name|HAL_BOOL
name|powerOff
parameter_list|)
block|{
name|ar9300_config_pci_power_save
argument_list|(
name|ah
argument_list|,
name|restore
condition|?
literal|1
else|:
literal|0
argument_list|,
name|powerOff
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * This is a copy from ar9300_eeprom_get(), purely because the FreeBSD  * API is very silly and inconsistent.  *  * The AR93xx HAL doesn't call the eepromGetFlag() function, so this  * only occurs for FreeBSD code.  *  * When I fix this particular API, I'll undo this.  */
end_comment

begin_function
name|HAL_STATUS
name|ar9300_eeprom_get_freebsd
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|int
name|param
parameter_list|,
name|void
modifier|*
name|val
parameter_list|)
block|{
switch|switch
condition|(
name|param
condition|)
block|{
case|case
name|AR_EEP_FSTCLK_5G
case|:
return|return
name|HAL_OK
return|;
default|default:
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"%s: called, param=%d\n"
argument_list|,
name|__func__
argument_list|,
name|param
argument_list|)
expr_stmt|;
return|return
name|HAL_EIO
return|;
block|}
block|}
end_function

begin_function
name|HAL_BOOL
name|ar9300_stop_tx_dma_freebsd
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int
name|q
parameter_list|)
block|{
return|return
name|ar9300_stop_tx_dma
argument_list|(
name|ah
argument_list|,
name|q
argument_list|,
literal|1000
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|ar9300_ani_poll_freebsd
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|struct
name|ieee80211_channel
modifier|*
name|chan
parameter_list|)
block|{
name|HAL_NODE_STATS
name|stats
decl_stmt|;
name|HAL_ANISTATS
name|anistats
decl_stmt|;
name|HAL_SURVEY_SAMPLE
name|survey
decl_stmt|;
name|OS_MEMZERO
argument_list|(
operator|&
name|stats
argument_list|,
sizeof|sizeof
argument_list|(
name|stats
argument_list|)
argument_list|)
expr_stmt|;
name|OS_MEMZERO
argument_list|(
operator|&
name|anistats
argument_list|,
sizeof|sizeof
argument_list|(
name|anistats
argument_list|)
argument_list|)
expr_stmt|;
name|OS_MEMZERO
argument_list|(
operator|&
name|survey
argument_list|,
sizeof|sizeof
argument_list|(
name|survey
argument_list|)
argument_list|)
expr_stmt|;
name|ar9300_ani_ar_poll
argument_list|(
name|ah
argument_list|,
operator|&
name|stats
argument_list|,
name|chan
argument_list|,
operator|&
name|anistats
argument_list|)
expr_stmt|;
comment|/* 	 * If ANI stats are valid, use them to update the 	 * channel survey. 	 */
if|if
condition|(
name|anistats
operator|.
name|valid
condition|)
block|{
name|survey
operator|.
name|cycle_count
operator|=
name|anistats
operator|.
name|cyclecnt_diff
expr_stmt|;
name|survey
operator|.
name|chan_busy
operator|=
name|anistats
operator|.
name|rxclr_cnt
expr_stmt|;
name|survey
operator|.
name|ext_chan_busy
operator|=
name|anistats
operator|.
name|extrxclr_cnt
expr_stmt|;
name|survey
operator|.
name|tx_busy
operator|=
name|anistats
operator|.
name|txframecnt_diff
expr_stmt|;
name|survey
operator|.
name|rx_busy
operator|=
name|anistats
operator|.
name|rxframecnt_diff
expr_stmt|;
name|ath_hal_survey_add_sample
argument_list|(
name|ah
argument_list|,
operator|&
name|survey
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Setup the configuration parameters in the style the AR9300 HAL  * wants.  */
end_comment

begin_function
name|void
name|ar9300_config_defaults_freebsd
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_OPS_CONFIG
modifier|*
name|ah_config
parameter_list|)
block|{
comment|/* Until FreeBSD's HAL does this by default - just copy */
name|OS_MEMCPY
argument_list|(
operator|&
name|ah
operator|->
name|ah_config
argument_list|,
name|ah_config
argument_list|,
sizeof|sizeof
argument_list|(
name|HAL_OPS_CONFIG
argument_list|)
argument_list|)
expr_stmt|;
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_enable_ani
operator|=
name|AH_TRUE
expr_stmt|;
block|}
end_function

begin_function
name|HAL_BOOL
name|ar9300_stop_dma_receive_freebsd
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
return|return
name|ar9300_stop_dma_receive
argument_list|(
name|ah
argument_list|,
literal|1000
argument_list|)
return|;
block|}
end_function

begin_function
name|HAL_BOOL
name|ar9300_get_pending_interrupts_freebsd
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_INT
modifier|*
name|masked
parameter_list|)
block|{
comment|/* Non-MSI, so no MSI vector; and 'nortc' = 0 */
return|return
name|ar9300_get_pending_interrupts
argument_list|(
name|ah
argument_list|,
name|masked
argument_list|,
name|HAL_INT_LINE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|HAL_INT
name|ar9300_set_interrupts_freebsd
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_INT
name|ints
parameter_list|)
block|{
comment|/* nortc = 0 */
return|return
name|ar9300_set_interrupts
argument_list|(
name|ah
argument_list|,
name|ints
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|HAL_BOOL
name|ar9300_per_calibration_freebsd
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|chan
parameter_list|,
name|u_int
name|rxchainmask
parameter_list|,
name|HAL_BOOL
name|long_cal
parameter_list|,
name|HAL_BOOL
modifier|*
name|isCalDone
parameter_list|)
block|{
comment|/* XXX fake scheduled calibrations for now */
name|u_int32_t
name|sched_cals
init|=
literal|0xfffffff
decl_stmt|;
return|return
name|ar9300_calibration
argument_list|(
name|ah
argument_list|,
name|chan
argument_list|,
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_caps
operator|.
name|halRxChainMask
argument_list|,
name|long_cal
argument_list|,
name|isCalDone
argument_list|,
literal|0
argument_list|,
comment|/* is_scan */
operator|&
name|sched_cals
argument_list|)
return|;
block|}
end_function

begin_function
name|HAL_BOOL
name|ar9300_reset_cal_valid_freebsd
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|struct
name|ieee80211_channel
modifier|*
name|chan
parameter_list|)
block|{
name|HAL_BOOL
name|is_cal_done
init|=
name|AH_TRUE
decl_stmt|;
name|ar9300_reset_cal_valid
argument_list|(
name|ah
argument_list|,
name|chan
argument_list|,
operator|&
name|is_cal_done
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
return|return
operator|(
name|is_cal_done
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ar9300_start_pcu_receive_freebsd
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
comment|/* is_scanning flag == NULL */
name|ar9300_start_pcu_receive
argument_list|(
name|ah
argument_list|,
name|AH_FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * FreeBSD will just pass in the descriptor value as 'pa'.  * The Atheros HAL treats 'pa' as the physical address of the RX  * descriptor and 'bufaddr' as the physical address of the RX buffer.  * I'm not sure why they didn't collapse them - the AR9300 RX descriptor  * routine doesn't check 'pa'.  */
end_comment

begin_function
name|HAL_STATUS
name|ar9300_proc_rx_desc_freebsd
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|uint32_t
name|pa
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds_next
parameter_list|,
name|uint64_t
name|tsf
parameter_list|,
name|struct
name|ath_rx_status
modifier|*
name|rxs
parameter_list|)
block|{
return|return
operator|(
name|ar9300_proc_rx_desc_fast
argument_list|(
name|ah
argument_list|,
name|ds
argument_list|,
literal|0
argument_list|,
name|ds_next
argument_list|,
name|rxs
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ds
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ar9300_ani_rxmonitor_freebsd
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|HAL_NODE_STATS
modifier|*
name|stats
parameter_list|,
specifier|const
name|struct
name|ieee80211_channel
modifier|*
name|chan
parameter_list|)
block|{  }
end_function

begin_function
name|void
name|ar9300_freebsd_get_desc_link
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|void
modifier|*
name|ds
parameter_list|,
name|uint32_t
modifier|*
name|link
parameter_list|)
block|{
name|struct
name|ar9300_txc
modifier|*
name|ads
init|=
name|AR9300TXC
argument_list|(
name|ds
argument_list|)
decl_stmt|;
operator|(
operator|*
name|link
operator|)
operator|=
name|ads
operator|->
name|ds_link
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * TX descriptor field setting wrappers - eek.  */
end_comment

begin_function
name|HAL_BOOL
name|ar9300_freebsd_setup_tx_desc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|u_int
name|pktLen
parameter_list|,
name|u_int
name|hdrLen
parameter_list|,
name|HAL_PKT_TYPE
name|type
parameter_list|,
name|u_int
name|txPower
parameter_list|,
name|u_int
name|txRate0
parameter_list|,
name|u_int
name|txTries0
parameter_list|,
name|u_int
name|keyIx
parameter_list|,
name|u_int
name|antMode
parameter_list|,
name|u_int
name|flags
parameter_list|,
name|u_int
name|rtsctsRate
parameter_list|,
name|u_int
name|rtsCtsDuration
parameter_list|,
name|u_int
name|compicvLen
parameter_list|,
name|u_int
name|compivLen
parameter_list|,
name|u_int
name|comp
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HAL_KEY_TYPE
name|keyType
init|=
literal|0
decl_stmt|;
comment|/* XXX No padding */
if|if
condition|(
name|keyIx
operator|!=
name|HAL_TXKEYIX_INVALID
condition|)
name|keyType
operator|=
name|ahp
operator|->
name|ah_keytype
index|[
name|keyIx
index|]
expr_stmt|;
comment|/* XXX bounds check keyix */
name|ar9300_set_11n_tx_desc
argument_list|(
name|ah
argument_list|,
name|ds
argument_list|,
name|pktLen
argument_list|,
name|type
argument_list|,
name|txPower
argument_list|,
name|keyIx
argument_list|,
name|keyType
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_function
name|HAL_BOOL
name|ar9300_freebsd_setup_x_tx_desc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|u_int
name|txRate1
parameter_list|,
name|u_int
name|txTries1
parameter_list|,
name|u_int
name|txRate2
parameter_list|,
name|u_int
name|txTries2
parameter_list|,
name|u_int
name|txRate3
parameter_list|,
name|u_int
name|txTries3
parameter_list|)
block|{
if|#
directive|if
literal|0
block|ath_hal_printf(ah, "%s: called, 0x%x/%d, 0x%x/%d, 0x%x/%d\n", 	    __func__, 	    txRate1, txTries1, 	    txRate2, txTries2, 	    txRate3, txTries3);
endif|#
directive|endif
comment|/* XXX should only be called during probe */
return|return
operator|(
name|AH_TRUE
operator|)
return|;
block|}
end_function

begin_function
name|HAL_BOOL
name|ar9300_freebsd_fill_tx_desc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|HAL_DMA_ADDR
modifier|*
name|bufListPtr
parameter_list|,
name|uint32_t
modifier|*
name|segLenPtr
parameter_list|,
name|u_int
name|descId
parameter_list|,
name|u_int
name|qid
parameter_list|,
name|HAL_BOOL
name|firstSeg
parameter_list|,
name|HAL_BOOL
name|lastSeg
parameter_list|,
specifier|const
name|struct
name|ath_desc
modifier|*
name|ds0
parameter_list|)
block|{
name|HAL_KEY_TYPE
name|keyType
init|=
literal|0
decl_stmt|;
specifier|const
name|struct
name|ar9300_txc
modifier|*
name|ads
init|=
name|AR9300TXC_CONST
argument_list|(
name|ds0
argument_list|)
decl_stmt|;
comment|/* 	 * FreeBSD's HAL doesn't pass the keytype to fill_tx_desc(); 	 * it's copied as part of the descriptor chaining. 	 * 	 * So, extract it from ds0. 	 */
name|keyType
operator|=
name|MS
argument_list|(
name|ads
operator|->
name|ds_ctl17
argument_list|,
name|AR_encr_type
argument_list|)
expr_stmt|;
return|return
name|ar9300_fill_tx_desc
argument_list|(
name|ah
argument_list|,
name|ds
argument_list|,
name|bufListPtr
argument_list|,
name|segLenPtr
argument_list|,
name|descId
argument_list|,
name|qid
argument_list|,
name|keyType
argument_list|,
name|firstSeg
argument_list|,
name|lastSeg
argument_list|,
name|ds0
argument_list|)
return|;
block|}
end_function

begin_function
name|HAL_BOOL
name|ar9300_freebsd_get_tx_completion_rates
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|struct
name|ath_desc
modifier|*
name|ds0
parameter_list|,
name|int
modifier|*
name|rates
parameter_list|,
name|int
modifier|*
name|tries
parameter_list|)
block|{
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"%s: called\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
comment|/* XXX for now */
block|}
end_function

begin_comment
comment|/*  * 802.11n TX descriptor wrappers  */
end_comment

begin_function
name|void
name|ar9300_freebsd_set_11n_rate_scenario
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|u_int
name|durUpdateEn
parameter_list|,
name|u_int
name|rtsctsRate
parameter_list|,
name|HAL_11N_RATE_SERIES
name|series
index|[]
parameter_list|,
name|u_int
name|nseries
parameter_list|,
name|u_int
name|flags
parameter_list|)
block|{
comment|/* lastds=NULL, rtscts_duration is 0, smart antenna is 0 */
name|ar9300_set_11n_rate_scenario
argument_list|(
name|ah
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ds
argument_list|,
operator|(
name|void
operator|*
operator|)
name|ds
argument_list|,
name|durUpdateEn
argument_list|,
name|rtsctsRate
argument_list|,
literal|0
argument_list|,
name|series
argument_list|,
name|nseries
argument_list|,
name|flags
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* chaintxdesc */
end_comment

begin_function
name|HAL_BOOL
name|ar9300_freebsd_chain_tx_desc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|HAL_DMA_ADDR
modifier|*
name|bufLenList
parameter_list|,
name|uint32_t
modifier|*
name|segLenList
parameter_list|,
name|u_int
name|pktLen
parameter_list|,
name|u_int
name|hdrLen
parameter_list|,
name|HAL_PKT_TYPE
name|type
parameter_list|,
name|u_int
name|keyIx
parameter_list|,
name|HAL_CIPHER
name|cipher
parameter_list|,
name|uint8_t
name|numDelims
parameter_list|,
name|HAL_BOOL
name|firstSeg
parameter_list|,
name|HAL_BOOL
name|lastSeg
parameter_list|,
name|HAL_BOOL
name|lastAggr
parameter_list|)
block|{
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"%s: called\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
end_function

begin_comment
comment|/* setupfirsttxdesc */
end_comment

begin_function
name|HAL_BOOL
name|ar9300_freebsd_setup_first_tx_desc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|u_int
name|aggrLen
parameter_list|,
name|u_int
name|flags
parameter_list|,
name|u_int
name|txPower
parameter_list|,
name|u_int
name|txRate0
parameter_list|,
name|u_int
name|txTries0
parameter_list|,
name|u_int
name|antMode
parameter_list|,
name|u_int
name|rtsctsRate
parameter_list|,
name|u_int
name|rtsctsDuration
parameter_list|)
block|{
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"%s: called\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
end_function

begin_comment
comment|/* setuplasttxdesc */
end_comment

begin_comment
comment|/*  * This gets called but for now let's not log anything;  * it's only used to update the rate control information.  */
end_comment

begin_function
name|HAL_BOOL
name|ar9300_freebsd_setup_last_tx_desc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
specifier|const
name|struct
name|ath_desc
modifier|*
name|ds0
parameter_list|)
block|{
comment|//	ath_hal_printf(ah, "%s: called\n", __func__);
return|return
name|AH_FALSE
return|;
block|}
end_function

begin_function
name|void
name|ar9300_freebsd_setup_11n_desc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|void
modifier|*
name|ds
parameter_list|,
name|u_int
name|pktLen
parameter_list|,
name|HAL_PKT_TYPE
name|type
parameter_list|,
name|u_int
name|txPower
parameter_list|,
name|u_int
name|keyIx
parameter_list|,
name|u_int
name|flags
parameter_list|)
block|{
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"%s: called\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|struct ath_hal_9300 *ahp = AH9300(ah);  	HAL_KEY_TYPE keyType = 0;
comment|/* XXX No padding */
block|if (keyIx != HAL_TXKEYIX_INVALID) 		keyType = ahp->ah_keytype[keyIx];
comment|/* XXX bounds check keyix */
block|ar9300_set_11n_tx_desc(ah, ds, pktLen, type, txPower, keyIx, 	    keyType, flags);
endif|#
directive|endif
block|}
end_function

begin_function
name|HAL_STATUS
name|ar9300_freebsd_proc_tx_desc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|struct
name|ath_tx_status
modifier|*
name|ts
parameter_list|)
block|{
return|return
name|ar9300_proc_tx_desc
argument_list|(
name|ah
argument_list|,
name|ts
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|ar9300_freebsd_beacon_init
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|uint32_t
name|next_beacon
parameter_list|,
name|uint32_t
name|beacon_period
parameter_list|)
block|{
name|ar9300_beacon_init
argument_list|(
name|ah
argument_list|,
name|next_beacon
argument_list|,
name|beacon_period
argument_list|,
literal|0
argument_list|,
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_opmode
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|HAL_BOOL
name|ar9300_freebsd_get_mib_cycle_counts
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_SURVEY_SAMPLE
modifier|*
name|hs
parameter_list|)
block|{
return|return
operator|(
name|AH_FALSE
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Clear multicast filter by index - from FreeBSD ar5212_recv.c  */
end_comment

begin_function
specifier|static
name|HAL_BOOL
name|ar9300ClrMulticastFilterIndex
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|uint32_t
name|ix
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
if|if
condition|(
name|ix
operator|>=
literal|64
condition|)
return|return
operator|(
name|AH_FALSE
operator|)
return|;
if|if
condition|(
name|ix
operator|>=
literal|32
condition|)
block|{
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_MCAST_FIL1
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCAST_FIL1
argument_list|,
operator|(
name|val
operator|&
operator|~
operator|(
literal|1
operator|<<
operator|(
name|ix
operator|-
literal|32
operator|)
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_MCAST_FIL0
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCAST_FIL0
argument_list|,
operator|(
name|val
operator|&
operator|~
operator|(
literal|1
operator|<<
name|ix
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_comment
comment|/*  * Set multicast filter by index - from FreeBSD ar5212_recv.c  */
end_comment

begin_function
specifier|static
name|HAL_BOOL
name|ar9300SetMulticastFilterIndex
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|uint32_t
name|ix
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
if|if
condition|(
name|ix
operator|>=
literal|64
condition|)
return|return
operator|(
name|AH_FALSE
operator|)
return|;
if|if
condition|(
name|ix
operator|>=
literal|32
condition|)
block|{
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_MCAST_FIL1
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCAST_FIL1
argument_list|,
operator|(
name|val
operator||
operator|(
literal|1
operator|<<
operator|(
name|ix
operator|-
literal|32
operator|)
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_MCAST_FIL0
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCAST_FIL0
argument_list|,
operator|(
name|val
operator||
operator|(
literal|1
operator|<<
name|ix
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|AH_TRUE
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|TU_TO_USEC
parameter_list|(
name|_tu
parameter_list|)
value|((_tu)<< 10)
end_define

begin_define
define|#
directive|define
name|ONE_EIGHTH_TU_TO_USEC
parameter_list|(
name|_tu8
parameter_list|)
value|((_tu8)<< 7)
end_define

begin_comment
comment|/*  * Initializes all of the hardware registers used to  * send beacons.  Note that for station operation the  * driver calls ar9300_set_sta_beacon_timers instead.  */
end_comment

begin_function
specifier|static
name|void
name|ar9300_beacon_set_beacon_timers
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|HAL_BEACON_TIMERS
modifier|*
name|bt
parameter_list|)
block|{
name|uint32_t
name|bperiod
decl_stmt|;
if|#
directive|if
literal|0
block|HALASSERT(opmode == HAL_M_IBSS || opmode == HAL_M_HOSTAP);     if (opmode == HAL_M_IBSS) {         OS_REG_SET_BIT(ah, AR_TXCFG, AR_TXCFG_ADHOC_BEACON_ATIM_TX_POLICY);     }
endif|#
directive|endif
comment|/* XXX TODO: should migrate the HAL code to always use ONE_EIGHTH_TU */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_NEXT_TBTT_TIMER
argument_list|,
name|TU_TO_USEC
argument_list|(
name|bt
operator|->
name|bt_nexttbtt
argument_list|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_NEXT_DMA_BEACON_ALERT
argument_list|,
name|ONE_EIGHTH_TU_TO_USEC
argument_list|(
name|bt
operator|->
name|bt_nextdba
argument_list|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_NEXT_SWBA
argument_list|,
name|ONE_EIGHTH_TU_TO_USEC
argument_list|(
name|bt
operator|->
name|bt_nextswba
argument_list|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_NEXT_NDP_TIMER
argument_list|,
name|TU_TO_USEC
argument_list|(
name|bt
operator|->
name|bt_nextatim
argument_list|)
argument_list|)
expr_stmt|;
name|bperiod
operator|=
name|TU_TO_USEC
argument_list|(
name|bt
operator|->
name|bt_intval
operator|&
name|HAL_BEACON_PERIOD
argument_list|)
expr_stmt|;
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_beaconInterval
operator|=
name|bt
operator|->
name|bt_intval
operator|&
name|HAL_BEACON_PERIOD
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BEACON_PERIOD
argument_list|,
name|bperiod
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_DMA_BEACON_PERIOD
argument_list|,
name|bperiod
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_SWBA_PERIOD
argument_list|,
name|bperiod
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_NDP_PERIOD
argument_list|,
name|bperiod
argument_list|)
expr_stmt|;
comment|/* 	 * Reset TSF if required. 	 */
if|if
condition|(
name|bt
operator|->
name|bt_intval
operator|&
name|HAL_BEACON_RESET_TSF
condition|)
name|ar9300_reset_tsf
argument_list|(
name|ah
argument_list|)
expr_stmt|;
comment|/* enable timers */
comment|/* NB: flags == 0 handled specially for backwards compatibility */
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_TIMER_MODE
argument_list|,
name|bt
operator|->
name|bt_flags
operator|!=
literal|0
condition|?
name|bt
operator|->
name|bt_flags
else|:
name|AR_TBTT_TIMER_EN
operator||
name|AR_DBA_TIMER_EN
operator||
name|AR_SWBA_TIMER_EN
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * RF attach stubs  */
end_comment

begin_function
specifier|static
name|HAL_BOOL
name|rf9330_attach
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_STATUS
modifier|*
name|status
parameter_list|)
block|{
operator|(
operator|*
name|status
operator|)
operator|=
name|HAL_EINVAL
expr_stmt|;
return|return
operator|(
name|AH_FALSE
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|HAL_BOOL
name|rf9330_probe
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
return|return
operator|(
name|AH_FALSE
operator|)
return|;
block|}
end_function

begin_expr_stmt
name|AH_RF
argument_list|(
name|RF9330
argument_list|,
name|rf9330_probe
argument_list|,
name|rf9330_attach
argument_list|)
expr_stmt|;
end_expr_stmt

end_unit


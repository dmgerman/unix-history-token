begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2013 Qualcomm Atheros, Inc.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR  * OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|"opt_ah.h"
end_include

begin_include
include|#
directive|include
file|"ah.h"
end_include

begin_include
include|#
directive|include
file|"ah_internal.h"
end_include

begin_include
include|#
directive|include
file|"ar9300/ar9300.h"
end_include

begin_include
include|#
directive|include
file|"ar9300/ar9300reg.h"
end_include

begin_include
include|#
directive|include
file|"ar9300/ar9300phy.h"
end_include

begin_if
if|#
directive|if
name|ATH_SUPPORT_MCI
end_if

begin_define
define|#
directive|define
name|AH_MCI_REMOTE_RESET_INTERVAL_US
value|500
end_define

begin_define
define|#
directive|define
name|AH_MCI_DEBUG_PRINT_SCHED
value|0
end_define

begin_function
specifier|static
name|void
name|ar9300_mci_print_msg
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|send
parameter_list|,
name|u_int8_t
name|hdr
parameter_list|,
name|int
name|len
parameter_list|,
name|u_int32_t
modifier|*
name|pl
parameter_list|)
block|{
if|#
directive|if
literal|0
block|char s[128];     char *p = s;     int i;     u_int8_t *p_data = (u_int8_t *) pl;          if (send) {         p += snprintf(s, 60,                       "(MCI)>>>>> Hdr: %02X, Len: %d, Payload:", hdr, len);     }     else {         p += snprintf(s, 60,                       "(MCI)<<<<< Hdr: %02X, Len: %d, Payload:", hdr, len);     }     for ( i=0; i<len; i++)     {         p += snprintf(p, 60, " %02x", *(p_data + i));     }     HALDEBUG(ah, HAL_DEBUG_BT_COEX, "%s\n", s);
comment|/*     for ( i=0; i<(len + 3)/4; i++)     {         HALDEBUG(ah, HAL_DEBUG_BT_COEX, "(MCI)   0x%08x\n", *(pl + i));     } */
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|ar9300_mci_osla_setup
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|enable
parameter_list|)
block|{
comment|//    struct ath_hal_9300 *ahp = AH9300(ah);
name|u_int32_t
name|thresh
decl_stmt|;
if|if
condition|(
name|enable
condition|)
block|{
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_MCI_SCHD_TABLE_2
argument_list|,
name|AR_MCI_SCHD_TABLE_2_HW_BASED
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_MCI_SCHD_TABLE_2
argument_list|,
name|AR_MCI_SCHD_TABLE_2_MEM_BASED
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_mci_config
operator|&
name|ATH_MCI_CONFIG_DISABLE_AGGR_THRESH
operator|)
condition|)
block|{
name|thresh
operator|=
name|MS
argument_list|(
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_mci_config
argument_list|,
name|ATH_MCI_CONFIG_AGGR_THRESH
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_CTRL
argument_list|,
name|AR_BTCOEX_CTRL_AGGR_THRESH
argument_list|,
name|thresh
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_CTRL
argument_list|,
name|AR_BTCOEX_CTRL_TIME_TO_NEXT_BT_THRESH_EN
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) SCHED aggr thresh: on, thresh=%d (%d.%d%%)\n"
argument_list|,
name|thresh
argument_list|,
operator|(
name|thresh
operator|+
literal|1
operator|)
operator|*
literal|125
operator|/
literal|10
argument_list|,
operator|(
name|thresh
operator|+
literal|1
operator|)
operator|*
literal|125
operator|%
literal|10
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_CTRL
argument_list|,
name|AR_BTCOEX_CTRL_TIME_TO_NEXT_BT_THRESH_EN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) SCHED aggr thresh: off\n"
argument_list|)
expr_stmt|;
block|}
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_CTRL
argument_list|,
name|AR_BTCOEX_CTRL_ONE_STEP_LOOK_AHEAD_EN
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) SCHED one step look ahead: on\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_CTRL
argument_list|,
name|AR_BTCOEX_CTRL_ONE_STEP_LOOK_AHEAD_EN
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) SCHED one step look ahead: off\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ar9300_mci_reset_req_wakeup
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
comment|/* to be tested in emulation */
if|if
condition|(
name|AR_SREV_JUPITER_20
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_APHRODITE
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_MCI_COMMAND2
argument_list|,
name|AR_MCI_COMMAND2_RESET_REQ_WAKEUP
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_MCI_COMMAND2
argument_list|,
name|AR_MCI_COMMAND2_RESET_REQ_WAKEUP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int32_t
name|ar9300_mci_wait_for_interrupt
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int32_t
name|address
parameter_list|,
name|u_int32_t
name|bit_position
parameter_list|,
name|int32_t
name|time_out
parameter_list|)
block|{
name|int
name|data
decl_stmt|;
comment|//, loop;
while|while
condition|(
name|time_out
condition|)
block|{
name|data
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|address
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|&
name|bit_position
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|address
argument_list|,
name|bit_position
argument_list|)
expr_stmt|;
if|if
condition|(
name|address
operator|==
name|AR_MCI_INTERRUPT_RX_MSG_RAW
condition|)
block|{
if|if
condition|(
name|bit_position
operator|&
name|AR_MCI_INTERRUPT_RX_MSG_REQ_WAKE
condition|)
block|{
name|ar9300_mci_reset_req_wakeup
argument_list|(
name|ah
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bit_position
operator|&
operator|(
name|AR_MCI_INTERRUPT_RX_MSG_SYS_SLEEPING
operator||
name|AR_MCI_INTERRUPT_RX_MSG_SYS_WAKING
operator|)
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_RAW
argument_list|,
name|AR_MCI_INTERRUPT_REMOTE_SLEEP_UPDATE
argument_list|)
expr_stmt|;
block|}
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_RAW
argument_list|,
name|AR_MCI_INTERRUPT_RX_MSG
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
name|OS_DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|time_out
operator|-=
literal|10
expr_stmt|;
if|if
condition|(
name|time_out
operator|<
literal|0
condition|)
block|{
break|break;
block|}
block|}
if|if
condition|(
name|time_out
operator|<=
literal|0
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) %s: Wait for Reg0x%08x = 0x%08x timeout.\n"
argument_list|,
name|__func__
argument_list|,
name|address
argument_list|,
name|bit_position
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) INT_RAW = 0x%08x, RX_MSG_RAW = 0x%08x"
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_RAW
argument_list|)
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_RX_MSG_RAW
argument_list|)
argument_list|)
expr_stmt|;
name|time_out
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|time_out
return|;
block|}
end_function

begin_function
name|void
name|ar9300_mci_remote_reset
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|wait_done
parameter_list|)
block|{
name|u_int32_t
name|payload
index|[
literal|4
index|]
init|=
block|{
literal|0xffffffff
block|,
literal|0xffffffff
block|,
literal|0xffffffff
block|,
literal|0xffffff00
block|}
decl_stmt|;
name|ar9300_mci_send_message
argument_list|(
name|ah
argument_list|,
name|MCI_REMOTE_RESET
argument_list|,
literal|0
argument_list|,
name|payload
argument_list|,
literal|16
argument_list|,
name|wait_done
argument_list|,
name|AH_FALSE
argument_list|)
expr_stmt|;
name|OS_DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9300_mci_send_lna_transfer
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|wait_done
parameter_list|)
block|{
name|u_int32_t
name|payload
init|=
literal|0x00000000
decl_stmt|;
name|ar9300_mci_send_message
argument_list|(
name|ah
argument_list|,
name|MCI_LNA_TRANS
argument_list|,
literal|0
argument_list|,
operator|&
name|payload
argument_list|,
literal|1
argument_list|,
name|wait_done
argument_list|,
name|AH_FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ar9300_mci_send_req_wake
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|wait_done
parameter_list|)
block|{
name|ar9300_mci_send_message
argument_list|(
name|ah
argument_list|,
name|MCI_REQ_WAKE
argument_list|,
name|HAL_MCI_FLAG_DISABLE_TIMESTAMP
argument_list|,
name|AH_NULL
argument_list|,
literal|0
argument_list|,
name|wait_done
argument_list|,
name|AH_FALSE
argument_list|)
expr_stmt|;
name|OS_DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9300_mci_send_sys_waking
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|wait_done
parameter_list|)
block|{
name|ar9300_mci_send_message
argument_list|(
name|ah
argument_list|,
name|MCI_SYS_WAKING
argument_list|,
name|HAL_MCI_FLAG_DISABLE_TIMESTAMP
argument_list|,
name|AH_NULL
argument_list|,
literal|0
argument_list|,
name|wait_done
argument_list|,
name|AH_FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ar9300_mci_send_lna_take
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|wait_done
parameter_list|)
block|{
name|u_int32_t
name|payload
init|=
literal|0x70000000
decl_stmt|;
comment|/* LNA gain index is set to 7. */
name|ar9300_mci_send_message
argument_list|(
name|ah
argument_list|,
name|MCI_LNA_TAKE
argument_list|,
name|HAL_MCI_FLAG_DISABLE_TIMESTAMP
argument_list|,
operator|&
name|payload
argument_list|,
literal|1
argument_list|,
name|wait_done
argument_list|,
name|AH_FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ar9300_mci_send_sys_sleeping
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|wait_done
parameter_list|)
block|{
name|ar9300_mci_send_message
argument_list|(
name|ah
argument_list|,
name|MCI_SYS_SLEEPING
argument_list|,
name|HAL_MCI_FLAG_DISABLE_TIMESTAMP
argument_list|,
name|AH_NULL
argument_list|,
literal|0
argument_list|,
name|wait_done
argument_list|,
name|AH_FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ar9300_mci_send_coex_version_query
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|wait_done
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|u_int32_t
name|payload
index|[
literal|4
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
if|if
condition|(
operator|(
name|ahp
operator|->
name|ah_mci_coex_bt_version_known
operator|==
name|AH_FALSE
operator|)
operator|&&
operator|(
name|ahp
operator|->
name|ah_mci_bt_state
operator|!=
name|MCI_BT_SLEEP
operator|)
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) Send Coex version query.\n"
argument_list|)
expr_stmt|;
name|MCI_GPM_SET_TYPE_OPCODE
argument_list|(
name|payload
argument_list|,
name|MCI_GPM_COEX_AGENT
argument_list|,
name|MCI_GPM_COEX_VERSION_QUERY
argument_list|)
expr_stmt|;
name|ar9300_mci_send_message
argument_list|(
name|ah
argument_list|,
name|MCI_GPM
argument_list|,
literal|0
argument_list|,
name|payload
argument_list|,
literal|16
argument_list|,
name|wait_done
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ar9300_mci_send_coex_version_response
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|wait_done
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|u_int32_t
name|payload
index|[
literal|4
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) Send Coex version response.\n"
argument_list|)
expr_stmt|;
name|MCI_GPM_SET_TYPE_OPCODE
argument_list|(
name|payload
argument_list|,
name|MCI_GPM_COEX_AGENT
argument_list|,
name|MCI_GPM_COEX_VERSION_RESPONSE
argument_list|)
expr_stmt|;
operator|*
operator|(
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|payload
operator|)
operator|+
name|MCI_GPM_COEX_B_MAJOR_VERSION
operator|)
operator|=
name|ahp
operator|->
name|ah_mci_coex_major_version_wlan
expr_stmt|;
operator|*
operator|(
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|payload
operator|)
operator|+
name|MCI_GPM_COEX_B_MINOR_VERSION
operator|)
operator|=
name|ahp
operator|->
name|ah_mci_coex_minor_version_wlan
expr_stmt|;
name|ar9300_mci_send_message
argument_list|(
name|ah
argument_list|,
name|MCI_GPM
argument_list|,
literal|0
argument_list|,
name|payload
argument_list|,
literal|16
argument_list|,
name|wait_done
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ar9300_mci_send_coex_wlan_channels
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|wait_done
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|u_int32_t
modifier|*
name|payload
init|=
operator|&
name|ahp
operator|->
name|ah_mci_coex_wlan_channels
index|[
literal|0
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|ahp
operator|->
name|ah_mci_coex_wlan_channels_update
operator|==
name|AH_TRUE
operator|)
operator|&&
operator|(
name|ahp
operator|->
name|ah_mci_bt_state
operator|!=
name|MCI_BT_SLEEP
operator|)
condition|)
block|{
name|MCI_GPM_SET_TYPE_OPCODE
argument_list|(
name|payload
argument_list|,
name|MCI_GPM_COEX_AGENT
argument_list|,
name|MCI_GPM_COEX_WLAN_CHANNELS
argument_list|)
expr_stmt|;
name|ar9300_mci_send_message
argument_list|(
name|ah
argument_list|,
name|MCI_GPM
argument_list|,
literal|0
argument_list|,
name|payload
argument_list|,
literal|16
argument_list|,
name|wait_done
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
name|MCI_GPM_SET_TYPE_OPCODE
argument_list|(
name|payload
argument_list|,
literal|0xff
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ar9300_mci_send_coex_bt_status_query
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|wait_done
parameter_list|,
name|u_int8_t
name|query_type
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|u_int32_t
name|pld
index|[
literal|4
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|HAL_BOOL
name|query_btinfo
init|=
name|query_type
operator|&
operator|(
name|MCI_GPM_COEX_QUERY_BT_ALL_INFO
operator||
name|MCI_GPM_COEX_QUERY_BT_TOPOLOGY
operator|)
decl_stmt|;
if|if
condition|(
name|ahp
operator|->
name|ah_mci_bt_state
operator|!=
name|MCI_BT_SLEEP
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) Send Coex BT Status Query 0x%02X\n"
argument_list|,
name|query_type
argument_list|)
expr_stmt|;
name|MCI_GPM_SET_TYPE_OPCODE
argument_list|(
name|pld
argument_list|,
name|MCI_GPM_COEX_AGENT
argument_list|,
name|MCI_GPM_COEX_STATUS_QUERY
argument_list|)
expr_stmt|;
operator|*
operator|(
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|pld
operator|)
operator|+
name|MCI_GPM_COEX_B_BT_BITMAP
operator|)
operator|=
name|query_type
expr_stmt|;
comment|/*          * If bt_status_query message is thought not sent successfully,          * then ah_mci_need_flush_btinfo should be set again.          */
if|if
condition|(
operator|!
name|ar9300_mci_send_message
argument_list|(
name|ah
argument_list|,
name|MCI_GPM
argument_list|,
literal|0
argument_list|,
name|pld
argument_list|,
literal|16
argument_list|,
name|wait_done
argument_list|,
name|AH_TRUE
argument_list|)
condition|)
block|{
if|if
condition|(
name|query_btinfo
condition|)
block|{
name|ahp
operator|->
name|ah_mci_need_flush_btinfo
operator|=
name|AH_TRUE
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) send bt_status_query fail, set flush flag again\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|query_btinfo
condition|)
block|{
name|ahp
operator|->
name|ah_mci_query_bt
operator|=
name|AH_FALSE
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|ar9300_mci_send_coex_halt_bt_gpm
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|halt
parameter_list|,
name|HAL_BOOL
name|wait_done
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|u_int32_t
name|payload
index|[
literal|4
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) Send Coex %s BT GPM.\n"
argument_list|,
operator|(
name|halt
operator|==
name|AH_TRUE
operator|)
condition|?
literal|"HALT"
else|:
literal|"UNHALT"
argument_list|)
expr_stmt|;
name|MCI_GPM_SET_TYPE_OPCODE
argument_list|(
name|payload
argument_list|,
name|MCI_GPM_COEX_AGENT
argument_list|,
name|MCI_GPM_COEX_HALT_BT_GPM
argument_list|)
expr_stmt|;
if|if
condition|(
name|halt
operator|==
name|AH_TRUE
condition|)
block|{
name|ahp
operator|->
name|ah_mci_query_bt
operator|=
name|AH_TRUE
expr_stmt|;
comment|/* Send next UNHALT no matter HALT sent or not */
name|ahp
operator|->
name|ah_mci_unhalt_bt_gpm
operator|=
name|AH_TRUE
expr_stmt|;
name|ahp
operator|->
name|ah_mci_need_flush_btinfo
operator|=
name|AH_TRUE
expr_stmt|;
operator|*
operator|(
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|payload
operator|)
operator|+
name|MCI_GPM_COEX_B_HALT_STATE
operator|)
operator|=
name|MCI_GPM_COEX_BT_GPM_HALT
expr_stmt|;
block|}
else|else
block|{
operator|*
operator|(
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|payload
operator|)
operator|+
name|MCI_GPM_COEX_B_HALT_STATE
operator|)
operator|=
name|MCI_GPM_COEX_BT_GPM_UNHALT
expr_stmt|;
block|}
name|ar9300_mci_send_message
argument_list|(
name|ah
argument_list|,
name|MCI_GPM
argument_list|,
literal|0
argument_list|,
name|payload
argument_list|,
literal|16
argument_list|,
name|wait_done
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|HAL_BOOL
name|ar9300_mci_send_coex_bt_flags
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|wait_done
parameter_list|,
name|u_int8_t
name|opcode
parameter_list|,
name|u_int32_t
name|bt_flags
parameter_list|)
block|{
comment|//    struct ath_hal_9300 *ahp = AH9300(ah);
name|u_int32_t
name|pld
index|[
literal|4
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|MCI_GPM_SET_TYPE_OPCODE
argument_list|(
name|pld
argument_list|,
name|MCI_GPM_COEX_AGENT
argument_list|,
name|MCI_GPM_COEX_BT_UPDATE_FLAGS
argument_list|)
expr_stmt|;
operator|*
operator|(
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|pld
operator|)
operator|+
name|MCI_GPM_COEX_B_BT_FLAGS_OP
operator|)
operator|=
name|opcode
expr_stmt|;
operator|*
operator|(
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|pld
operator|)
operator|+
name|MCI_GPM_COEX_W_BT_FLAGS
operator|+
literal|0
operator|)
operator|=
name|bt_flags
operator|&
literal|0xFF
expr_stmt|;
operator|*
operator|(
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|pld
operator|)
operator|+
name|MCI_GPM_COEX_W_BT_FLAGS
operator|+
literal|1
operator|)
operator|=
operator|(
name|bt_flags
operator|>>
literal|8
operator|)
operator|&
literal|0xFF
expr_stmt|;
operator|*
operator|(
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|pld
operator|)
operator|+
name|MCI_GPM_COEX_W_BT_FLAGS
operator|+
literal|2
operator|)
operator|=
operator|(
name|bt_flags
operator|>>
literal|16
operator|)
operator|&
literal|0xFF
expr_stmt|;
operator|*
operator|(
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|pld
operator|)
operator|+
name|MCI_GPM_COEX_W_BT_FLAGS
operator|+
literal|3
operator|)
operator|=
operator|(
name|bt_flags
operator|>>
literal|24
operator|)
operator|&
literal|0xFF
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) BT_MCI_FLAGS: Send Coex BT Update Flags %s 0x%08x\n"
argument_list|,
operator|(
name|opcode
operator|==
name|MCI_GPM_COEX_BT_FLAGS_READ
operator|)
condition|?
literal|"READ"
else|:
operator|(
operator|(
name|opcode
operator|==
name|MCI_GPM_COEX_BT_FLAGS_SET
operator|)
condition|?
literal|"SET"
else|:
literal|"CLEAR"
operator|)
argument_list|,
name|bt_flags
argument_list|)
expr_stmt|;
return|return
name|ar9300_mci_send_message
argument_list|(
name|ah
argument_list|,
name|MCI_GPM
argument_list|,
literal|0
argument_list|,
name|pld
argument_list|,
literal|16
argument_list|,
name|wait_done
argument_list|,
name|AH_TRUE
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|ar9300_mci_2g5g_changed
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|is_2g
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
if|if
condition|(
name|ahp
operator|->
name|ah_mci_coex_2g5g_update
operator|==
name|AH_FALSE
condition|)
block|{
if|if
condition|(
name|ahp
operator|->
name|ah_mci_coex_is_2g
operator|==
name|is_2g
condition|)
block|{
comment|//HALDEBUG(ah, HAL_DEBUG_BT_COEX, "(MCI) BT_MCI_FLAGS: not changed\n");
block|}
else|else
block|{
name|ahp
operator|->
name|ah_mci_coex_2g5g_update
operator|=
name|AH_TRUE
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) BT_MCI_FLAGS: changed\n"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) BT_MCI_FLAGS: force send\n"
argument_list|)
expr_stmt|;
block|}
name|ahp
operator|->
name|ah_mci_coex_is_2g
operator|=
name|is_2g
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ar9300_mci_send_2g5g_status
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|wait_done
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|u_int32_t
name|new_flags
decl_stmt|,
name|to_set
decl_stmt|,
name|to_clear
decl_stmt|;
if|if
condition|(
operator|(
name|AR_SREV_JUPITER_20
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_APHRODITE
argument_list|(
name|ah
argument_list|)
operator|)
operator|&&
operator|(
name|ahp
operator|->
name|ah_mci_coex_2g5g_update
operator|==
name|AH_TRUE
operator|)
operator|&&
operator|(
name|ahp
operator|->
name|ah_mci_bt_state
operator|!=
name|MCI_BT_SLEEP
operator|)
condition|)
block|{
if|if
condition|(
name|ahp
operator|->
name|ah_mci_coex_is_2g
condition|)
block|{
name|new_flags
operator|=
name|HAL_MCI_2G_FLAGS
expr_stmt|;
name|to_clear
operator|=
name|HAL_MCI_2G_FLAGS_CLEAR_MASK
expr_stmt|;
name|to_set
operator|=
name|HAL_MCI_2G_FLAGS_SET_MASK
expr_stmt|;
block|}
else|else
block|{
name|new_flags
operator|=
name|HAL_MCI_5G_FLAGS
expr_stmt|;
name|to_clear
operator|=
name|HAL_MCI_5G_FLAGS_CLEAR_MASK
expr_stmt|;
name|to_set
operator|=
name|HAL_MCI_5G_FLAGS_SET_MASK
expr_stmt|;
block|}
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) BT_MCI_FLAGS: %s (0x%08x) clr=0x%08x, set=0x%08x\n"
argument_list|,
name|ahp
operator|->
name|ah_mci_coex_is_2g
condition|?
literal|"2G"
else|:
literal|"5G"
argument_list|,
name|new_flags
argument_list|,
name|to_clear
argument_list|,
name|to_set
argument_list|)
expr_stmt|;
if|if
condition|(
name|to_clear
condition|)
block|{
name|ar9300_mci_send_coex_bt_flags
argument_list|(
name|ah
argument_list|,
name|wait_done
argument_list|,
name|MCI_GPM_COEX_BT_FLAGS_CLEAR
argument_list|,
name|to_clear
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|to_set
condition|)
block|{
name|ar9300_mci_send_coex_bt_flags
argument_list|(
name|ah
argument_list|,
name|wait_done
argument_list|,
name|MCI_GPM_COEX_BT_FLAGS_SET
argument_list|,
name|to_set
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|AR_SREV_JUPITER_10
argument_list|(
name|ah
argument_list|)
operator|&&
operator|(
name|ahp
operator|->
name|ah_mci_bt_state
operator|!=
name|MCI_BT_SLEEP
operator|)
condition|)
block|{
name|ahp
operator|->
name|ah_mci_coex_2g5g_update
operator|=
name|AH_FALSE
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ar9300_mci_2g5g_switch
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|wait_done
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
if|if
condition|(
name|ahp
operator|->
name|ah_mci_coex_2g5g_update
condition|)
block|{
if|if
condition|(
name|ahp
operator|->
name|ah_mci_coex_is_2g
condition|)
block|{
name|ar9300_mci_send_2g5g_status
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) Send LNA trans\n"
argument_list|)
expr_stmt|;
name|ar9300_mci_send_lna_transfer
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
name|OS_DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_MCI_TX_CTRL
argument_list|,
name|AR_MCI_TX_CTRL_DISABLE_LNA_UPDATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|AR_SREV_JUPITER_20
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_APHRODITE
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_GLB_CONTROL
argument_list|,
name|AR_BTCOEX_CTRL_BT_OWN_SPDT_CTRL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_mci_config
operator|&
name|ATH_MCI_CONFIG_DISABLE_OSLA
operator|)
condition|)
block|{
name|ar9300_mci_osla_setup
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) Send LNA take\n"
argument_list|)
expr_stmt|;
name|ar9300_mci_send_lna_take
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
name|OS_DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_MCI_TX_CTRL
argument_list|,
name|AR_MCI_TX_CTRL_DISABLE_LNA_UPDATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|AR_SREV_JUPITER_20
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_APHRODITE
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_GLB_CONTROL
argument_list|,
name|AR_BTCOEX_CTRL_BT_OWN_SPDT_CTRL
argument_list|)
expr_stmt|;
name|ar9300_mci_osla_setup
argument_list|(
name|ah
argument_list|,
name|AH_FALSE
argument_list|)
expr_stmt|;
block|}
name|ar9300_mci_send_2g5g_status
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*      * Update self gen chain mask. Also set basic set for      * txbf.      */
if|if
condition|(
name|AR_SREV_JUPITER
argument_list|(
name|ah
argument_list|)
condition|)
block|{
if|if
condition|(
name|ahp
operator|->
name|ah_mci_coex_is_2g
condition|)
block|{
name|ahp
operator|->
name|ah_reduced_self_gen_mask
operator|=
name|AH_TRUE
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_SELFGEN_MASK
argument_list|,
literal|0x02
argument_list|)
expr_stmt|;
name|ar9300_txbf_set_basic_set
argument_list|(
name|ah
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ahp
operator|->
name|ah_reduced_self_gen_mask
operator|=
name|AH_FALSE
expr_stmt|;
name|ar9300_txbf_set_basic_set
argument_list|(
name|ah
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|ar9300_mci_mute_bt
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
comment|/* disable all MCI messages */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_MSG_ATTRIBUTES_TABLE
argument_list|,
literal|0xFFFF0000
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_WL_WEIGHTS0
argument_list|,
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_WL_WEIGHTS1
argument_list|,
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_WL_WEIGHTS2
argument_list|,
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_WL_WEIGHTS3
argument_list|,
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_MCI_TX_CTRL
argument_list|,
name|AR_MCI_TX_CTRL_DISABLE_LNA_UPDATE
argument_list|)
expr_stmt|;
comment|/* wait pending HW messages to flush out */
name|OS_DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
comment|/*      * Send LNA_TAKE and SYS_SLEEPING when      * 1. reset not after resuming from full sleep      * 2. before reset MCI RX, to quiet BT and avoid MCI RX misalignment      */
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) Send LNA take\n"
argument_list|)
expr_stmt|;
name|ar9300_mci_send_lna_take
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
name|OS_DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) Send sys sleeping\n"
argument_list|)
expr_stmt|;
name|ar9300_mci_send_sys_sleeping
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ar9300_mci_observation_set_up
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
comment|/*      * Set up the observation bus in order to monitor MCI bus      * through GPIOs (0, 1, 2, and 3).      */
comment|/*     OS_REG_WRITE(ah, AR_GPIO_INTR_POL, 0x00420000);     OS_REG_WRITE(ah, AR_GPIO_OE_OUT, 0x000000ff); // 4050     OS_REG_WRITE(ah, AR_GPIO_OUTPUT_MUX1, 0x000bdab4); // 4068     OS_REG_WRITE(ah, AR_OBS, 0x0000004b); // 4088     OS_REG_WRITE(ah, AR_DIAG_SW, 0x080c0000);     OS_REG_WRITE(ah, AR_MACMISC, 0x0001a000);     OS_REG_WRITE(ah, AR_PHY_TEST, 0x00080000); // a360     OS_REG_WRITE(ah, AR_PHY_TEST_CTL_STATUS, 0xe0000000); // a364     */
if|if
condition|(
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_mci_config
operator|&
name|ATH_MCI_CONFIG_MCI_OBS_MCI
condition|)
block|{
name|ar9300_gpio_cfg_output
argument_list|(
name|ah
argument_list|,
literal|3
argument_list|,
name|HAL_GPIO_OUTPUT_MUX_AS_MCI_WLAN_DATA
argument_list|)
expr_stmt|;
name|ar9300_gpio_cfg_output
argument_list|(
name|ah
argument_list|,
literal|2
argument_list|,
name|HAL_GPIO_OUTPUT_MUX_AS_MCI_WLAN_CLK
argument_list|)
expr_stmt|;
name|ar9300_gpio_cfg_output
argument_list|(
name|ah
argument_list|,
literal|1
argument_list|,
name|HAL_GPIO_OUTPUT_MUX_AS_MCI_BT_DATA
argument_list|)
expr_stmt|;
name|ar9300_gpio_cfg_output
argument_list|(
name|ah
argument_list|,
literal|0
argument_list|,
name|HAL_GPIO_OUTPUT_MUX_AS_MCI_BT_CLK
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_mci_config
operator|&
name|ATH_MCI_CONFIG_MCI_OBS_TXRX
condition|)
block|{
name|ar9300_gpio_cfg_output
argument_list|(
name|ah
argument_list|,
literal|3
argument_list|,
name|HAL_GPIO_OUTPUT_MUX_AS_WL_IN_TX
argument_list|)
expr_stmt|;
name|ar9300_gpio_cfg_output
argument_list|(
name|ah
argument_list|,
literal|2
argument_list|,
name|HAL_GPIO_OUTPUT_MUX_AS_WL_IN_RX
argument_list|)
expr_stmt|;
name|ar9300_gpio_cfg_output
argument_list|(
name|ah
argument_list|,
literal|1
argument_list|,
name|HAL_GPIO_OUTPUT_MUX_AS_BT_IN_TX
argument_list|)
expr_stmt|;
name|ar9300_gpio_cfg_output
argument_list|(
name|ah
argument_list|,
literal|0
argument_list|,
name|HAL_GPIO_OUTPUT_MUX_AS_BT_IN_RX
argument_list|)
expr_stmt|;
name|ar9300_gpio_cfg_output
argument_list|(
name|ah
argument_list|,
literal|5
argument_list|,
name|HAL_GPIO_OUTPUT_MUX_AS_OUTPUT
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_mci_config
operator|&
name|ATH_MCI_CONFIG_MCI_OBS_BT
condition|)
block|{
name|ar9300_gpio_cfg_output
argument_list|(
name|ah
argument_list|,
literal|3
argument_list|,
name|HAL_GPIO_OUTPUT_MUX_AS_BT_IN_TX
argument_list|)
expr_stmt|;
name|ar9300_gpio_cfg_output
argument_list|(
name|ah
argument_list|,
literal|2
argument_list|,
name|HAL_GPIO_OUTPUT_MUX_AS_BT_IN_RX
argument_list|)
expr_stmt|;
name|ar9300_gpio_cfg_output
argument_list|(
name|ah
argument_list|,
literal|1
argument_list|,
name|HAL_GPIO_OUTPUT_MUX_AS_MCI_BT_DATA
argument_list|)
expr_stmt|;
name|ar9300_gpio_cfg_output
argument_list|(
name|ah
argument_list|,
literal|0
argument_list|,
name|HAL_GPIO_OUTPUT_MUX_AS_MCI_BT_CLK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
return|return;
block|}
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_HOSTIF_REG
argument_list|(
name|ah
argument_list|,
name|AR_GPIO_INPUT_EN_VAL
argument_list|)
argument_list|,
name|AR_GPIO_JTAG_DISABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|AR_SREV_JUPITER_20_OR_LATER
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_APHRODITE
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_GLB_CONTROL
argument_list|,
name|AR_GLB_DS_JTAG_DISABLE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_GLB_CONTROL
argument_list|,
name|AR_GLB_WLAN_UART_INTF_EN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_GLB_GPIO_CONTROL
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_GLB_GPIO_CONTROL
argument_list|)
operator||
name|ATH_MCI_CONFIG_MCI_OBS_GPIO
operator|)
argument_list|)
expr_stmt|;
block|}
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_CTRL2
argument_list|,
name|AR_BTCOEX_CTRL2_GPIO_OBS_SEL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_CTRL2
argument_list|,
name|AR_BTCOEX_CTRL2_MAC_BB_OBS_SEL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_HOSTIF_REG
argument_list|(
name|ah
argument_list|,
name|AR_OBS
argument_list|)
argument_list|,
literal|0x4b
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_DIAG_SW
argument_list|,
name|AR_DIAG_OBS_PT_SEL1
argument_list|,
literal|0x03
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_DIAG_SW
argument_list|,
name|AR_DIAG_OBS_PT_SEL2
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_MACMISC
argument_list|,
name|AR_MACMISC_MISC_OBS_BUS_LSB
argument_list|,
literal|0x02
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_MACMISC
argument_list|,
name|AR_MACMISC_MISC_OBS_BUS_MSB
argument_list|,
literal|0x03
argument_list|)
expr_stmt|;
comment|//OS_REG_RMW_FIELD(ah, AR_PHY_TEST, AR_PHY_TEST_BBB_OBS_SEL, 0x01);
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TEST_CTL_STATUS
argument_list|,
name|AR_PHY_TEST_CTL_DEBUGPORT_SEL
argument_list|,
literal|0x07
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ar9300_mci_process_gpm_extra
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int8_t
name|gpm_type
parameter_list|,
name|u_int8_t
name|gpm_opcode
parameter_list|,
name|u_int32_t
modifier|*
name|p_gpm
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|u_int8_t
modifier|*
name|p_data
init|=
operator|(
name|u_int8_t
operator|*
operator|)
name|p_gpm
decl_stmt|;
switch|switch
condition|(
name|gpm_type
condition|)
block|{
case|case
name|MCI_GPM_COEX_AGENT
case|:
switch|switch
condition|(
name|gpm_opcode
condition|)
block|{
case|case
name|MCI_GPM_COEX_VERSION_QUERY
case|:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) Recv GPM COEX Version Query.\n"
argument_list|)
expr_stmt|;
name|ar9300_mci_send_coex_version_response
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
break|break;
case|case
name|MCI_GPM_COEX_VERSION_RESPONSE
case|:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) Recv GPM COEX Version Response.\n"
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|ah_mci_coex_major_version_bt
operator|=
operator|*
operator|(
name|p_data
operator|+
name|MCI_GPM_COEX_B_MAJOR_VERSION
operator|)
expr_stmt|;
name|ahp
operator|->
name|ah_mci_coex_minor_version_bt
operator|=
operator|*
operator|(
name|p_data
operator|+
name|MCI_GPM_COEX_B_MINOR_VERSION
operator|)
expr_stmt|;
name|ahp
operator|->
name|ah_mci_coex_bt_version_known
operator|=
name|AH_TRUE
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) BT Coex version: %d.%d\n"
argument_list|,
name|ahp
operator|->
name|ah_mci_coex_major_version_bt
argument_list|,
name|ahp
operator|->
name|ah_mci_coex_minor_version_bt
argument_list|)
expr_stmt|;
break|break;
case|case
name|MCI_GPM_COEX_STATUS_QUERY
case|:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) Recv GPM COEX Status Query = 0x%02X.\n"
argument_list|,
operator|*
operator|(
name|p_data
operator|+
name|MCI_GPM_COEX_B_WLAN_BITMAP
operator|)
argument_list|)
expr_stmt|;
comment|//if ((*(p_data + MCI_GPM_COEX_B_WLAN_BITMAP))&
comment|//    MCI_GPM_COEX_QUERY_WLAN_ALL_INFO)
block|{
name|ahp
operator|->
name|ah_mci_coex_wlan_channels_update
operator|=
name|AH_TRUE
expr_stmt|;
name|ar9300_mci_send_coex_wlan_channels
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|MCI_GPM_COEX_BT_PROFILE_INFO
case|:
name|ahp
operator|->
name|ah_mci_query_bt
operator|=
name|AH_TRUE
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) Recv GPM COEX BT_Profile_Info (drop&query)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MCI_GPM_COEX_BT_STATUS_UPDATE
case|:
name|ahp
operator|->
name|ah_mci_query_bt
operator|=
name|AH_TRUE
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) Recv GPM COEX BT_Status_Update "
literal|"SEQ=%d (drop&query)\n"
argument_list|,
operator|*
operator|(
name|p_gpm
operator|+
literal|3
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
default|default:
break|break;
block|}
block|}
end_function

begin_function
name|u_int32_t
name|ar9300_mci_wait_for_gpm
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int8_t
name|gpm_type
parameter_list|,
name|u_int8_t
name|gpm_opcode
parameter_list|,
name|int32_t
name|time_out
parameter_list|)
block|{
name|u_int32_t
modifier|*
name|p_gpm
init|=
name|NULL
decl_stmt|,
name|mismatch
init|=
literal|0
decl_stmt|,
name|more_data
init|=
name|HAL_MCI_GPM_NOMORE
decl_stmt|;
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HAL_BOOL
name|b_is_bt_cal_done
init|=
operator|(
name|gpm_type
operator|==
name|MCI_GPM_BT_CAL_DONE
operator|)
decl_stmt|;
name|u_int32_t
name|offset
decl_stmt|;
name|u_int8_t
name|recv_type
init|=
literal|0
decl_stmt|,
name|recv_opcode
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|time_out
operator|==
literal|0
condition|)
block|{
name|more_data
operator|=
name|HAL_MCI_GPM_MORE
expr_stmt|;
block|}
while|while
condition|(
name|time_out
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|p_gpm
operator|!=
name|NULL
condition|)
block|{
name|MCI_GPM_RECYCLE
argument_list|(
name|p_gpm
argument_list|)
expr_stmt|;
name|p_gpm
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|more_data
operator|!=
name|HAL_MCI_GPM_MORE
condition|)
block|{
name|time_out
operator|=
name|ar9300_mci_wait_for_interrupt
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_RX_MSG_RAW
argument_list|,
name|AR_MCI_INTERRUPT_RX_MSG_GPM
argument_list|,
name|time_out
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|time_out
condition|)
block|{
name|offset
operator|=
name|ar9300_mci_state
argument_list|(
name|ah
argument_list|,
name|HAL_MCI_STATE_NEXT_GPM_OFFSET
argument_list|,
operator|&
name|more_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
operator|==
name|HAL_MCI_GPM_INVALID
condition|)
block|{
continue|continue;
block|}
name|p_gpm
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|ahp
operator|->
name|ah_mci_gpm_buf
operator|+
name|offset
operator|)
expr_stmt|;
name|ar9300_mci_print_msg
argument_list|(
name|ah
argument_list|,
name|AH_FALSE
argument_list|,
name|MCI_GPM
argument_list|,
literal|16
argument_list|,
name|p_gpm
argument_list|)
expr_stmt|;
name|recv_type
operator|=
name|MCI_GPM_TYPE
argument_list|(
name|p_gpm
argument_list|)
expr_stmt|;
name|recv_opcode
operator|=
name|MCI_GPM_OPCODE
argument_list|(
name|p_gpm
argument_list|)
expr_stmt|;
if|if
condition|(
name|MCI_GPM_IS_CAL_TYPE
argument_list|(
name|recv_type
argument_list|)
condition|)
block|{
if|if
condition|(
name|recv_type
operator|==
name|gpm_type
condition|)
block|{
if|if
condition|(
operator|(
name|gpm_type
operator|==
name|MCI_GPM_BT_CAL_DONE
operator|)
operator|&&
operator|!
name|b_is_bt_cal_done
condition|)
block|{
name|gpm_type
operator|=
name|MCI_GPM_BT_CAL_GRANT
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) Rcv BT_CAL_DONE. Now Wait BT_CAL_GRANT\n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|gpm_type
operator|==
name|MCI_GPM_BT_CAL_GRANT
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) BT_CAL_GRANT seq=%d, req_count=%d\n"
argument_list|,
operator|*
operator|(
name|p_gpm
operator|+
literal|2
operator|)
argument_list|,
operator|*
operator|(
name|p_gpm
operator|+
literal|3
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
name|recv_type
operator|==
name|gpm_type
operator|)
operator|&&
operator|(
name|recv_opcode
operator|==
name|gpm_opcode
operator|)
condition|)
block|{
break|break;
block|}
block|}
comment|/* not expected message */
comment|/*              * Check if it's cal_grant              *              * When we're waiting for cal_grant in reset routine, it's              * possible that BT sends out cal_request at the same time.              * Since BT's calibration doesn't happen that often, we'll              * let BT completes calibration then we continue to wait               * for cal_grant from BT.              * Orginal: Wait BT_CAL_GRANT.              * New: Receive BT_CAL_REQ -> send WLAN_CAL_GRANT -> wait              * BT_CAL_DONE -> Wait BT_CAL_GRANT.              */
if|if
condition|(
operator|(
name|gpm_type
operator|==
name|MCI_GPM_BT_CAL_GRANT
operator|)
operator|&&
operator|(
name|recv_type
operator|==
name|MCI_GPM_BT_CAL_REQ
operator|)
condition|)
block|{
name|u_int32_t
name|payload
index|[
literal|4
index|]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|gpm_type
operator|=
name|MCI_GPM_BT_CAL_DONE
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) Rcv BT_CAL_REQ. Send WLAN_CAL_GRANT.\n"
argument_list|)
expr_stmt|;
name|MCI_GPM_SET_CAL_TYPE
argument_list|(
name|payload
argument_list|,
name|MCI_GPM_WLAN_CAL_GRANT
argument_list|)
expr_stmt|;
name|ar9300_mci_send_message
argument_list|(
name|ah
argument_list|,
name|MCI_GPM
argument_list|,
literal|0
argument_list|,
name|payload
argument_list|,
literal|16
argument_list|,
name|AH_FALSE
argument_list|,
name|AH_FALSE
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) Now wait for BT_CAL_DONE.\n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
else|else
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) GPM subtype not match 0x%x\n"
argument_list|,
operator|*
operator|(
name|p_gpm
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|mismatch
operator|++
expr_stmt|;
name|ar9300_mci_process_gpm_extra
argument_list|(
name|ah
argument_list|,
name|recv_type
argument_list|,
name|recv_opcode
argument_list|,
name|p_gpm
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|p_gpm
operator|!=
name|NULL
condition|)
block|{
name|MCI_GPM_RECYCLE
argument_list|(
name|p_gpm
argument_list|)
expr_stmt|;
name|p_gpm
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|time_out
operator|<=
literal|0
condition|)
block|{
name|time_out
operator|=
literal|0
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) GPM receiving timeout, mismatch = %d\n"
argument_list|,
name|mismatch
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) Receive GPM type=0x%x, code=0x%x\n"
argument_list|,
name|gpm_type
argument_list|,
name|gpm_opcode
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|more_data
operator|==
name|HAL_MCI_GPM_MORE
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) discard remaining GPM\n"
argument_list|)
expr_stmt|;
name|offset
operator|=
name|ar9300_mci_state
argument_list|(
name|ah
argument_list|,
name|HAL_MCI_STATE_NEXT_GPM_OFFSET
argument_list|,
operator|&
name|more_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
operator|==
name|HAL_MCI_GPM_INVALID
condition|)
block|{
break|break;
block|}
name|p_gpm
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|ahp
operator|->
name|ah_mci_gpm_buf
operator|+
name|offset
operator|)
expr_stmt|;
name|ar9300_mci_print_msg
argument_list|(
name|ah
argument_list|,
name|AH_FALSE
argument_list|,
name|MCI_GPM
argument_list|,
literal|16
argument_list|,
name|p_gpm
argument_list|)
expr_stmt|;
name|recv_type
operator|=
name|MCI_GPM_TYPE
argument_list|(
name|p_gpm
argument_list|)
expr_stmt|;
name|recv_opcode
operator|=
name|MCI_GPM_OPCODE
argument_list|(
name|p_gpm
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|MCI_GPM_IS_CAL_TYPE
argument_list|(
name|recv_type
argument_list|)
condition|)
block|{
name|ar9300_mci_process_gpm_extra
argument_list|(
name|ah
argument_list|,
name|recv_type
argument_list|,
name|recv_opcode
argument_list|,
name|p_gpm
argument_list|)
expr_stmt|;
block|}
name|MCI_GPM_RECYCLE
argument_list|(
name|p_gpm
argument_list|)
expr_stmt|;
block|}
return|return
name|time_out
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ar9300_mci_prep_interface
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|u_int32_t
name|saved_mci_int_en
decl_stmt|;
name|u_int32_t
name|mci_timeout
init|=
literal|150
decl_stmt|;
name|ahp
operator|->
name|ah_mci_bt_state
operator|=
name|MCI_BT_SLEEP
expr_stmt|;
name|saved_mci_int_en
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_EN
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_EN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_RX_MSG_RAW
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_RX_MSG_RAW
argument_list|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_RAW
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_RAW
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Remote Reset */
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) %s: Reset sequence start\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) send REMOTE_RESET\n"
argument_list|)
expr_stmt|;
name|ar9300_mci_remote_reset
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
comment|/*      * This delay is required for the reset delay worst case value 255 in       * MCI_COMMAND2 register       */
if|if
condition|(
name|AR_SREV_JUPITER_10
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_DELAY
argument_list|(
literal|252
argument_list|)
expr_stmt|;
block|}
comment|/* Send REQ_WAKE to BT */
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) %s: Send REQ_WAKE to remote(BT)\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ar9300_mci_send_req_wake
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ar9300_mci_wait_for_interrupt
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_RX_MSG_RAW
argument_list|,
name|AR_MCI_INTERRUPT_RX_MSG_SYS_WAKING
argument_list|,
literal|500
argument_list|)
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) %s: Saw SYS_WAKING from remote(BT)\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|ah_mci_bt_state
operator|=
name|MCI_BT_AWAKE
expr_stmt|;
if|if
condition|(
name|AR_SREV_JUPITER_10
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
comment|/*          * We don't need to send more remote_reset at this moment.          *          * If BT receive first remote_reset, then BT HW will be cleaned up and          * will be able to receive req_wake and BT HW will respond sys_waking.          * In this case, WLAN will receive BT's HW sys_waking.          *          * Otherwise, if BT SW missed initial remote_reset, that remote_reset          * will still clean up BT MCI RX, and the req_wake will wake BT up,          * and BT SW will respond this req_wake with a remote_reset and          * sys_waking. In this case, WLAN will receive BT's SW sys_waking.          *          * In either case, BT's RX is cleaned up. So we don't need to reply          * BT's remote_reset now, if any.          *          * Similarly, if in any case, WLAN can receive BT's sys_waking, that          * means WLAN's RX is also fine.          */
comment|/* Send SYS_WAKING to BT */
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) %s: Send SW SYS_WAKING to remot(BT)\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ar9300_mci_send_sys_waking
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
name|OS_DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
comment|/*          * Set BT priority interrupt value to be 0xff to          * avoid having too many BT PRIORITY interrupts.          */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_BT_PRI0
argument_list|,
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_BT_PRI1
argument_list|,
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_BT_PRI2
argument_list|,
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_BT_PRI3
argument_list|,
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_BT_PRI
argument_list|,
literal|0X000000FF
argument_list|)
expr_stmt|;
comment|/*          * A contention reset will be received after send out sys_waking.          * Also BT priority interrupt bits will be set. Clear those bits          * before the next step.          */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_RX_MSG_RAW
argument_list|,
name|AR_MCI_INTERRUPT_RX_MSG_CONT_RST
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_RAW
argument_list|,
name|AR_MCI_INTERRUPT_BT_PRI
argument_list|)
expr_stmt|;
if|if
condition|(
name|AR_SREV_JUPITER_10
argument_list|(
name|ah
argument_list|)
operator|||
name|ahp
operator|->
name|ah_mci_coex_is_2g
condition|)
block|{
comment|/* Send LNA_TRANS */
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) %s: Send LNA_TRANS to BT\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ar9300_mci_send_lna_transfer
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
name|OS_DELAY
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|AR_SREV_JUPITER_10
argument_list|(
name|ah
argument_list|)
operator|||
operator|(
name|ahp
operator|->
name|ah_mci_coex_is_2g
operator|&&
operator|!
name|ahp
operator|->
name|ah_mci_coex_2g5g_update
operator|)
condition|)
block|{
if|if
condition|(
name|ar9300_mci_wait_for_interrupt
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_RX_MSG_RAW
argument_list|,
name|AR_MCI_INTERRUPT_RX_MSG_LNA_INFO
argument_list|,
name|mci_timeout
argument_list|)
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) %s: WLAN has control over the LNA& BT obeys it\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) %s: BT did not respond to LNA_TRANS!\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
comment|//ahp->ah_mci_bt_state = MCI_BT_SLEEP;
block|}
block|}
if|if
condition|(
name|AR_SREV_JUPITER_10
argument_list|(
name|ah
argument_list|)
condition|)
block|{
comment|/* Send another remote_reset to deassert BT clk_req. */
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) %s: Another remote_reset to deassert clk_req.\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ar9300_mci_remote_reset
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
name|OS_DELAY
argument_list|(
literal|252
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Clear the extra redundant SYS_WAKING from BT */
if|if
condition|(
operator|(
name|ahp
operator|->
name|ah_mci_bt_state
operator|==
name|MCI_BT_AWAKE
operator|)
operator|&&
operator|(
name|OS_REG_READ_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_RX_MSG_RAW
argument_list|,
name|AR_MCI_INTERRUPT_RX_MSG_SYS_WAKING
argument_list|)
operator|)
operator|&&
operator|(
name|OS_REG_READ_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_RX_MSG_RAW
argument_list|,
name|AR_MCI_INTERRUPT_RX_MSG_SYS_SLEEPING
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_RX_MSG_RAW
argument_list|,
name|AR_MCI_INTERRUPT_RX_MSG_SYS_WAKING
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_RAW
argument_list|,
name|AR_MCI_INTERRUPT_REMOTE_SLEEP_UPDATE
argument_list|)
expr_stmt|;
block|}
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_EN
argument_list|,
name|saved_mci_int_en
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9300_mci_setup
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int32_t
name|gpm_addr
parameter_list|,
name|void
modifier|*
name|gpm_buf
parameter_list|,
name|u_int16_t
name|len
parameter_list|,
name|u_int32_t
name|sched_addr
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|void
modifier|*
name|sched_buf
init|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|gpm_buf
operator|+
operator|(
name|sched_addr
operator|-
name|gpm_addr
operator|)
operator|)
decl_stmt|;
name|ahp
operator|->
name|ah_mci_gpm_addr
operator|=
name|gpm_addr
expr_stmt|;
name|ahp
operator|->
name|ah_mci_gpm_buf
operator|=
name|gpm_buf
expr_stmt|;
name|ahp
operator|->
name|ah_mci_gpm_len
operator|=
name|len
expr_stmt|;
name|ahp
operator|->
name|ah_mci_sched_addr
operator|=
name|sched_addr
expr_stmt|;
name|ahp
operator|->
name|ah_mci_sched_buf
operator|=
name|sched_buf
expr_stmt|;
name|ar9300_mci_reset
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|,
name|AH_TRUE
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9300_mci_disable_interrupt
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_EN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_RX_MSG_EN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9300_mci_enable_interrupt
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_EN
argument_list|,
name|AR_MCI_INTERRUPT_DEFAULT
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_RX_MSG_EN
argument_list|,
name|AR_MCI_INTERRUPT_RX_MSG_DEFAULT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9300_mci_reset
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|en_int
parameter_list|,
name|HAL_BOOL
name|is_2g
parameter_list|,
name|HAL_BOOL
name|is_full_sleep
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
comment|//    struct ath_hal_private *ahpriv = AH_PRIVATE(ah);
name|u_int32_t
name|regval
decl_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) %s: full_sleep = %d, is_2g = %d\n"
argument_list|,
name|__func__
argument_list|,
name|is_full_sleep
argument_list|,
name|is_2g
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ahp
operator|->
name|ah_mci_gpm_addr
operator|&&
operator|!
name|ahp
operator|->
name|ah_mci_sched_addr
condition|)
block|{
comment|/* GPM buffer and scheduling message buffer are not allocated */
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) GPM and SCHEDULE buffers not allocated\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_CTRL
argument_list|)
operator|==
literal|0xdeadbeef
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) %s: ### It's deadbeef, quit mcireset()\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Program MCI DMA related registers */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_GPM_0
argument_list|,
name|ahp
operator|->
name|ah_mci_gpm_addr
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_GPM_1
argument_list|,
name|ahp
operator|->
name|ah_mci_gpm_len
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_SCHD_TABLE_0
argument_list|,
name|ahp
operator|->
name|ah_mci_sched_addr
argument_list|)
expr_stmt|;
comment|/*      * To avoid MCI state machine be affected by incoming remote MCI messages,      * MCI mode will be enabled later, right before reset the MCI TX and RX.      */
name|regval
operator|=
name|SM
argument_list|(
literal|1
argument_list|,
name|AR_BTCOEX_CTRL_JUPITER_MODE
argument_list|)
operator||
name|SM
argument_list|(
literal|1
argument_list|,
name|AR_BTCOEX_CTRL_WBTIMER_EN
argument_list|)
operator||
name|SM
argument_list|(
literal|1
argument_list|,
name|AR_BTCOEX_CTRL_PA_SHARED
argument_list|)
operator||
name|SM
argument_list|(
literal|1
argument_list|,
name|AR_BTCOEX_CTRL_LNA_SHARED
argument_list|)
operator||
name|SM
argument_list|(
literal|2
argument_list|,
name|AR_BTCOEX_CTRL_NUM_ANTENNAS
argument_list|)
operator||
name|SM
argument_list|(
literal|3
argument_list|,
name|AR_BTCOEX_CTRL_RX_CHAIN_MASK
argument_list|)
operator||
name|SM
argument_list|(
literal|0
argument_list|,
name|AR_BTCOEX_CTRL_1_CHAIN_ACK
argument_list|)
operator||
name|SM
argument_list|(
literal|0
argument_list|,
name|AR_BTCOEX_CTRL_1_CHAIN_BCN
argument_list|)
operator||
name|SM
argument_list|(
literal|0
argument_list|,
name|AR_BTCOEX_CTRL_ONE_STEP_LOOK_AHEAD_EN
argument_list|)
expr_stmt|;
if|if
condition|(
name|AR_SREV_JUPITER_10
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|regval
operator||=
name|SM
argument_list|(
literal|1
argument_list|,
name|AR_BTCOEX_CTRL_SPDT_ENABLE_10
argument_list|)
expr_stmt|;
block|}
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_CTRL
argument_list|,
name|regval
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_2g
operator|&&
operator|(
name|AR_SREV_JUPITER_20
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_APHRODITE
argument_list|(
name|ah
argument_list|)
operator|)
operator|&&
operator|!
operator|(
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_mci_config
operator|&
name|ATH_MCI_CONFIG_DISABLE_OSLA
operator|)
condition|)
block|{
name|ar9300_mci_osla_setup
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ar9300_mci_osla_setup
argument_list|(
name|ah
argument_list|,
name|AH_FALSE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|AR_SREV_JUPITER_20
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_APHRODITE
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_GLB_CONTROL
argument_list|,
name|AR_BTCOEX_CTRL_SPDT_ENABLE
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_CTRL3
argument_list|,
name|AR_BTCOEX_CTRL3_CONT_INFO_TIMEOUT
argument_list|,
literal|20
argument_list|)
expr_stmt|;
block|}
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_CTRL2
argument_list|,
name|AR_BTCOEX_CTRL2_RX_DEWEIGHT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PCU_MISC
argument_list|,
name|AR_PCU_BT_ANT_PREVENT_RX
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_mci_config
operator|&
name|ATH_MCI_CONFIG_CONCUR_TX
condition|)
block|{
name|u_int8_t
name|i
decl_stmt|;
name|u_int32_t
specifier|const
modifier|*
name|pmax_tx_pwr
decl_stmt|;
if|if
condition|(
operator|(
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_mci_config
operator|&
name|ATH_MCI_CONFIG_CONCUR_TX
operator|)
operator|==
name|ATH_MCI_CONCUR_TX_SHARED_CHN
condition|)
block|{
name|ahp
operator|->
name|ah_mci_concur_tx_en
operator|=
operator|(
name|ahp
operator|->
name|ah_bt_coex_flag
operator|&
name|HAL_BT_COEX_FLAG_MCI_MAX_TX_PWR
operator|)
condition|?
name|AH_TRUE
else|:
name|AH_FALSE
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) concur_tx_en = %d\n"
argument_list|,
name|ahp
operator|->
name|ah_mci_concur_tx_en
argument_list|)
expr_stmt|;
comment|/*              * We're not relying on HW to reduce WLAN tx power.              * Set the max tx power table to 0x7f for all.              */
if|#
directive|if
literal|0
block|if (AH_PRIVATE(ah)->ah_curchan) {                 chan_flags = AH_PRIVATE(ah)->ah_curchan->channel_flags;             }             if (chan_flags == CHANNEL_G_HT20) {                 pmax_tx_pwr =&mci_concur_tx_max_pwr[2][0];             }             else if (chan_flags == CHANNEL_G) {                 pmax_tx_pwr =&mci_concur_tx_max_pwr[1][0];             }             else if ((chan_flags == CHANNEL_G_HT40PLUS) ||                       (chan_flags == CHANNEL_G_HT40MINUS))             {                 pmax_tx_pwr =&mci_concur_tx_max_pwr[3][0];             }             else {                 pmax_tx_pwr =&mci_concur_tx_max_pwr[0][0];             }              if (ahp->ah_mci_concur_tx_en) {                 HALDEBUG(ah, HAL_DEBUG_BT_COEX,                          "(MCI) chan flags = 0x%x, max_tx_pwr = %d dBm\n",                          chan_flags,                          (MS(pmax_tx_pwr[2],                          ATH_MCI_CONCUR_TX_LOWEST_PWR_MASK)>> 1));             }
else|#
directive|else
name|pmax_tx_pwr
operator|=
operator|&
name|mci_concur_tx_max_pwr
index|[
literal|0
index|]
index|[
literal|0
index|]
expr_stmt|;
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
operator|(
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_mci_config
operator|&
name|ATH_MCI_CONFIG_CONCUR_TX
operator|)
operator|==
name|ATH_MCI_CONCUR_TX_UNSHARED_CHN
condition|)
block|{
name|pmax_tx_pwr
operator|=
operator|&
name|mci_concur_tx_max_pwr
index|[
literal|0
index|]
index|[
literal|0
index|]
expr_stmt|;
name|ahp
operator|->
name|ah_mci_concur_tx_en
operator|=
name|AH_TRUE
expr_stmt|;
block|}
else|else
block|{
name|pmax_tx_pwr
operator|=
operator|&
name|mci_concur_tx_max_pwr
index|[
literal|0
index|]
index|[
literal|0
index|]
expr_stmt|;
name|ahp
operator|->
name|ah_mci_concur_tx_en
operator|=
name|AH_TRUE
expr_stmt|;
block|}
comment|/* Default is using rate based TPC. */
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_CTRL2
argument_list|,
name|AR_BTCOEX_CTRL2_DESC_BASED_TXPWR_ENABLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_CTRL2
argument_list|,
name|AR_BTCOEX_CTRL2_TXPWR_THRESH
argument_list|,
literal|0x7f
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_CTRL
argument_list|,
name|AR_BTCOEX_CTRL_REDUCE_TXPWR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_MAX_TXPWR
argument_list|(
name|i
argument_list|)
argument_list|,
name|pmax_tx_pwr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|regval
operator|=
name|MS
argument_list|(
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_mci_config
argument_list|,
name|ATH_MCI_CONFIG_CLK_DIV
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_MCI_TX_CTRL
argument_list|,
name|AR_MCI_TX_CTRL_CLK_DIV
argument_list|,
name|regval
argument_list|)
expr_stmt|;
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_CTRL
argument_list|,
name|AR_BTCOEX_CTRL_MCI_MODE_EN
argument_list|)
expr_stmt|;
comment|/* Resetting the Rx and Tx paths of MCI */
name|regval
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_MCI_COMMAND2
argument_list|)
expr_stmt|;
name|regval
operator||=
name|SM
argument_list|(
literal|1
argument_list|,
name|AR_MCI_COMMAND2_RESET_TX
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_COMMAND2
argument_list|,
name|regval
argument_list|)
expr_stmt|;
name|OS_DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|regval
operator|&=
operator|~
name|SM
argument_list|(
literal|1
argument_list|,
name|AR_MCI_COMMAND2_RESET_TX
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_COMMAND2
argument_list|,
name|regval
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_full_sleep
condition|)
block|{
name|ar9300_mci_mute_bt
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|OS_DELAY
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
name|regval
operator||=
name|SM
argument_list|(
literal|1
argument_list|,
name|AR_MCI_COMMAND2_RESET_RX
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_COMMAND2
argument_list|,
name|regval
argument_list|)
expr_stmt|;
name|OS_DELAY
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|regval
operator|&=
operator|~
name|SM
argument_list|(
literal|1
argument_list|,
name|AR_MCI_COMMAND2_RESET_RX
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_COMMAND2
argument_list|,
name|regval
argument_list|)
expr_stmt|;
name|ar9300_mci_state
argument_list|(
name|ah
argument_list|,
name|HAL_MCI_STATE_INIT_GPM_OFFSET
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_MSG_ATTRIBUTES_TABLE
argument_list|,
operator|(
name|SM
argument_list|(
literal|0xe801
argument_list|,
name|AR_MCI_MSG_ATTRIBUTES_TABLE_INVALID_HDR
argument_list|)
operator||
name|SM
argument_list|(
literal|0x0000
argument_list|,
name|AR_MCI_MSG_ATTRIBUTES_TABLE_CHECKSUM
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_MCI_TX_CTRL
argument_list|,
name|AR_MCI_TX_CTRL_DISABLE_LNA_UPDATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|AR_SREV_JUPITER_20_OR_LATER
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_APHRODITE
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|ar9300_mci_observation_set_up
argument_list|(
name|ah
argument_list|)
expr_stmt|;
block|}
name|ahp
operator|->
name|ah_mci_ready
operator|=
name|AH_TRUE
expr_stmt|;
name|ar9300_mci_prep_interface
argument_list|(
name|ah
argument_list|)
expr_stmt|;
if|if
condition|(
name|en_int
condition|)
block|{
name|ar9300_mci_enable_interrupt
argument_list|(
name|ah
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
name|ATH_SUPPORT_AIC
if|if
condition|(
name|ahp
operator|->
name|ah_aic_enabled
condition|)
block|{
name|ar9300_aic_start_normal
argument_list|(
name|ah
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|ar9300_mci_queue_unsent_gpm
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int8_t
name|header
parameter_list|,
name|u_int32_t
modifier|*
name|payload
parameter_list|,
name|HAL_BOOL
name|queue
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|u_int8_t
name|type
decl_stmt|,
name|opcode
decl_stmt|;
if|if
condition|(
name|queue
operator|==
name|AH_TRUE
condition|)
block|{
if|if
condition|(
name|payload
operator|!=
name|NULL
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) ERROR: Send fail: %02x: %02x %02x %02x\n"
argument_list|,
name|header
argument_list|,
operator|*
operator|(
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|payload
operator|)
operator|+
literal|4
operator|)
argument_list|,
operator|*
operator|(
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|payload
operator|)
operator|+
literal|5
operator|)
argument_list|,
operator|*
operator|(
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|payload
operator|)
operator|+
literal|6
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) ERROR: Send fail: %02x\n"
argument_list|,
name|header
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* check if the message is to be queued */
if|if
condition|(
name|header
operator|==
name|MCI_GPM
condition|)
block|{
name|type
operator|=
name|MCI_GPM_TYPE
argument_list|(
name|payload
argument_list|)
expr_stmt|;
name|opcode
operator|=
name|MCI_GPM_OPCODE
argument_list|(
name|payload
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|MCI_GPM_COEX_AGENT
condition|)
block|{
switch|switch
condition|(
name|opcode
condition|)
block|{
case|case
name|MCI_GPM_COEX_BT_UPDATE_FLAGS
case|:
if|if
condition|(
name|AR_SREV_JUPITER_10
argument_list|(
name|ah
argument_list|)
condition|)
block|{
break|break;
block|}
if|if
condition|(
operator|*
operator|(
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|payload
operator|)
operator|+
name|MCI_GPM_COEX_B_BT_FLAGS_OP
operator|)
operator|==
name|MCI_GPM_COEX_BT_FLAGS_READ
condition|)
block|{
break|break;
block|}
name|ahp
operator|->
name|ah_mci_coex_2g5g_update
operator|=
name|queue
expr_stmt|;
if|if
condition|(
name|queue
operator|==
name|AH_TRUE
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) BT_MCI_FLAGS: 2G5G status<queued> %s.\n"
argument_list|,
name|ahp
operator|->
name|ah_mci_coex_is_2g
condition|?
literal|"2G"
else|:
literal|"5G"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) BT_MCI_FLAGS: 2G5G status<sent> %s.\n"
argument_list|,
name|ahp
operator|->
name|ah_mci_coex_is_2g
condition|?
literal|"2G"
else|:
literal|"5G"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|MCI_GPM_COEX_WLAN_CHANNELS
case|:
name|ahp
operator|->
name|ah_mci_coex_wlan_channels_update
operator|=
name|queue
expr_stmt|;
if|if
condition|(
name|queue
operator|==
name|AH_TRUE
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) WLAN channel map<queued>.\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) WLAN channel map<sent>.\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|MCI_GPM_COEX_HALT_BT_GPM
case|:
if|if
condition|(
operator|*
operator|(
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|payload
operator|)
operator|+
name|MCI_GPM_COEX_B_HALT_STATE
operator|)
operator|==
name|MCI_GPM_COEX_BT_GPM_UNHALT
condition|)
block|{
name|ahp
operator|->
name|ah_mci_unhalt_bt_gpm
operator|=
name|queue
expr_stmt|;
if|if
condition|(
name|queue
operator|==
name|AH_TRUE
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) UNHALT BT GPM<queued>.\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ahp
operator|->
name|ah_mci_halted_bt_gpm
operator|=
name|AH_FALSE
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) UNHALT BT GPM<sent>.\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|*
operator|(
operator|(
operator|(
name|u_int8_t
operator|*
operator|)
name|payload
operator|)
operator|+
name|MCI_GPM_COEX_B_HALT_STATE
operator|)
operator|==
name|MCI_GPM_COEX_BT_GPM_HALT
condition|)
block|{
name|ahp
operator|->
name|ah_mci_halted_bt_gpm
operator|=
operator|!
name|queue
expr_stmt|;
if|if
condition|(
name|queue
operator|==
name|AH_TRUE
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) HALT BT GPM<not sent>.\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) HALT BT GPM<sent>.\n"
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
default|default:
break|break;
block|}
block|}
block|}
block|}
end_function

begin_function
name|HAL_BOOL
name|ar9300_mci_send_message
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int8_t
name|header
parameter_list|,
name|u_int32_t
name|flag
parameter_list|,
name|u_int32_t
modifier|*
name|payload
parameter_list|,
name|u_int8_t
name|len
parameter_list|,
name|HAL_BOOL
name|wait_done
parameter_list|,
name|HAL_BOOL
name|check_bt
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HAL_BOOL
name|msg_sent
init|=
name|AH_FALSE
decl_stmt|;
name|u_int32_t
name|regval
decl_stmt|;
name|u_int32_t
name|saved_mci_int_en
init|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_EN
argument_list|)
decl_stmt|;
name|regval
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_CTRL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|regval
operator|==
literal|0xdeadbeef
operator|)
operator|||
operator|!
operator|(
name|regval
operator|&
name|AR_BTCOEX_CTRL_MCI_MODE_EN
operator|)
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) %s: Not send 0x%x. MCI is not enabled. full_sleep = %d\n"
argument_list|,
name|__func__
argument_list|,
name|header
argument_list|,
name|ahp
operator|->
name|ah_chip_full_sleep
argument_list|)
expr_stmt|;
name|ar9300_mci_queue_unsent_gpm
argument_list|(
name|ah
argument_list|,
name|header
argument_list|,
name|payload
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
elseif|else
if|if
condition|(
name|check_bt
operator|&&
operator|(
name|ahp
operator|->
name|ah_mci_bt_state
operator|==
name|MCI_BT_SLEEP
operator|)
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) %s: Don't send message(0x%x). BT is in sleep state\n"
argument_list|,
name|__func__
argument_list|,
name|header
argument_list|)
expr_stmt|;
name|ar9300_mci_queue_unsent_gpm
argument_list|(
name|ah
argument_list|,
name|header
argument_list|,
name|payload
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
if|if
condition|(
name|wait_done
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_EN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* Need to clear SW_MSG_DONE raw bit before wait */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_RAW
argument_list|,
name|AR_MCI_INTERRUPT_SW_MSG_DONE
operator||
name|AR_MCI_INTERRUPT_MSG_FAIL_MASK
argument_list|)
expr_stmt|;
if|if
condition|(
name|payload
operator|!=
name|AH_NULL
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
operator|(
name|i
operator|*
literal|4
operator|)
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
operator|(
name|AR_MCI_TX_PAYLOAD0
operator|+
name|i
operator|*
literal|4
operator|)
argument_list|,
operator|*
operator|(
name|payload
operator|+
name|i
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|ar9300_mci_print_msg
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|,
name|header
argument_list|,
name|len
argument_list|,
name|payload
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_COMMAND0
argument_list|,
operator|(
name|SM
argument_list|(
operator|(
name|flag
operator|&
name|HAL_MCI_FLAG_DISABLE_TIMESTAMP
operator|)
argument_list|,
name|AR_MCI_COMMAND0_DISABLE_TIMESTAMP
argument_list|)
operator||
name|SM
argument_list|(
name|len
argument_list|,
name|AR_MCI_COMMAND0_LEN
argument_list|)
operator||
name|SM
argument_list|(
name|header
argument_list|,
name|AR_MCI_COMMAND0_HEADER
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wait_done
operator|&&
name|ar9300_mci_wait_for_interrupt
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_RAW
argument_list|,
name|AR_MCI_INTERRUPT_SW_MSG_DONE
argument_list|,
literal|500
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ar9300_mci_queue_unsent_gpm
argument_list|(
name|ah
argument_list|,
name|header
argument_list|,
name|payload
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ar9300_mci_queue_unsent_gpm
argument_list|(
name|ah
argument_list|,
name|header
argument_list|,
name|payload
argument_list|,
name|AH_FALSE
argument_list|)
expr_stmt|;
name|msg_sent
operator|=
name|AH_TRUE
expr_stmt|;
block|}
if|if
condition|(
name|wait_done
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_EN
argument_list|,
name|saved_mci_int_en
argument_list|)
expr_stmt|;
block|}
return|return
name|msg_sent
return|;
block|}
end_function

begin_function
name|u_int32_t
name|ar9300_mci_get_interrupt
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int32_t
modifier|*
name|mci_int
parameter_list|,
name|u_int32_t
modifier|*
name|mci_int_rx_msg
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
operator|*
name|mci_int
operator|=
name|ahp
operator|->
name|ah_mci_int_raw
expr_stmt|;
operator|*
name|mci_int_rx_msg
operator|=
name|ahp
operator|->
name|ah_mci_int_rx_msg
expr_stmt|;
comment|/* Clean int bits after the values are read. */
name|ahp
operator|->
name|ah_mci_int_raw
operator|=
literal|0
expr_stmt|;
name|ahp
operator|->
name|ah_mci_int_rx_msg
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|u_int32_t
name|ar9300_mci_check_int
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int32_t
name|ints
parameter_list|)
block|{
name|u_int32_t
name|reg
decl_stmt|;
name|reg
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_RX_MSG_RAW
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|reg
operator|&
name|ints
operator|)
operator|==
name|ints
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ar9300_mci_sync_bt_state
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|u_int32_t
name|cur_bt_state
decl_stmt|;
name|cur_bt_state
operator|=
name|ar9300_mci_state
argument_list|(
name|ah
argument_list|,
name|HAL_MCI_STATE_REMOTE_SLEEP
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ahp
operator|->
name|ah_mci_bt_state
operator|!=
name|cur_bt_state
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) %s: BT state mismatches. old: %d, new: %d\n"
argument_list|,
name|__func__
argument_list|,
name|ahp
operator|->
name|ah_mci_bt_state
argument_list|,
name|cur_bt_state
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|ah_mci_bt_state
operator|=
name|cur_bt_state
expr_stmt|;
block|}
if|if
condition|(
name|ahp
operator|->
name|ah_mci_bt_state
operator|!=
name|MCI_BT_SLEEP
condition|)
block|{
if|#
directive|if
name|MCI_QUERY_BT_VERSION_VERBOSE
name|ar9300_mci_send_coex_version_query
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ar9300_mci_send_coex_wlan_channels
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ahp
operator|->
name|ah_mci_unhalt_bt_gpm
operator|==
name|AH_TRUE
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) %s: UNHALT BT GPM\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ar9300_mci_send_coex_halt_bt_gpm
argument_list|(
name|ah
argument_list|,
name|AH_FALSE
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|HAL_BOOL
name|ar9300_mci_is_gpm_valid
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int32_t
name|msg_index
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|u_int32_t
modifier|*
name|payload
decl_stmt|;
name|u_int32_t
name|recv_type
decl_stmt|,
name|offset
init|=
name|msg_index
operator|<<
literal|4
decl_stmt|;
if|if
condition|(
name|msg_index
operator|==
name|HAL_MCI_GPM_INVALID
condition|)
block|{
return|return
name|AH_FALSE
return|;
block|}
name|payload
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|ahp
operator|->
name|ah_mci_gpm_buf
operator|+
name|offset
operator|)
expr_stmt|;
name|recv_type
operator|=
name|MCI_GPM_TYPE
argument_list|(
name|payload
argument_list|)
expr_stmt|;
if|if
condition|(
name|recv_type
operator|==
name|MCI_GPM_RSVD_PATTERN
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) Skip RSVD GPM\n"
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_function
name|u_int32_t
name|ar9300_mci_state
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int32_t
name|state_type
parameter_list|,
name|u_int32_t
modifier|*
name|p_data
parameter_list|)
block|{
name|u_int32_t
name|value
init|=
literal|0
decl_stmt|,
name|more_gpm
init|=
literal|0
decl_stmt|,
name|gpm_ptr
decl_stmt|;
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|state_type
condition|)
block|{
case|case
name|HAL_MCI_STATE_ENABLE
case|:
if|if
condition|(
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_caps
operator|.
name|halMciSupport
operator|&&
name|ahp
operator|->
name|ah_mci_ready
condition|)
block|{
name|value
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_CTRL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|value
operator|==
literal|0xdeadbeef
operator|)
operator|||
operator|(
name|value
operator|==
literal|0xffffffff
operator|)
condition|)
block|{
comment|//    HALDEBUG(ah, HAL_DEBUG_BT_COEX,
comment|//        "(MCI) BTCOEX_CTRL = 0xdeadbeef\n");
name|value
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|value
operator|&=
name|AR_BTCOEX_CTRL_MCI_MODE_EN
expr_stmt|;
break|break;
case|case
name|HAL_MCI_STATE_INIT_GPM_OFFSET
case|:
name|value
operator|=
name|MS
argument_list|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_MCI_GPM_1
argument_list|)
argument_list|,
name|AR_MCI_GPM_WRITE_PTR
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) %s: GPM initial WRITE_PTR=%d.\n"
argument_list|,
name|__func__
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|ah_mci_gpm_idx
operator|=
name|value
expr_stmt|;
break|break;
case|case
name|HAL_MCI_STATE_NEXT_GPM_OFFSET
case|:
case|case
name|HAL_MCI_STATE_LAST_GPM_OFFSET
case|:
comment|/*              * This could be useful to avoid new GPM message interrupt which              * may lead to spurious interrupt after power sleep, or multiple              * entry of ath_coex_mci_intr().              * Adding empty GPM check by returning HAL_MCI_GPM_INVALID can              * alleviate this effect, but clearing GPM RX interrupt bit is              * safe, because whether this is called from HAL or LMAC, there              * must be an interrupt bit set/triggered initially.              */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MCI_INTERRUPT_RX_MSG_RAW
argument_list|,
name|AR_MCI_INTERRUPT_RX_MSG_GPM
argument_list|)
expr_stmt|;
name|gpm_ptr
operator|=
name|MS
argument_list|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_MCI_GPM_1
argument_list|)
argument_list|,
name|AR_MCI_GPM_WRITE_PTR
argument_list|)
expr_stmt|;
name|value
operator|=
name|gpm_ptr
expr_stmt|;
if|if
condition|(
name|value
operator|==
literal|0
condition|)
block|{
name|value
operator|=
name|ahp
operator|->
name|ah_mci_gpm_len
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|value
operator|>=
name|ahp
operator|->
name|ah_mci_gpm_len
condition|)
block|{
if|if
condition|(
name|value
operator|!=
literal|0xFFFF
condition|)
block|{
name|value
operator|=
literal|0
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) %s: GPM offset out of range.\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|value
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|value
operator|==
literal|0xFFFF
condition|)
block|{
name|value
operator|=
name|HAL_MCI_GPM_INVALID
expr_stmt|;
name|more_gpm
operator|=
name|HAL_MCI_GPM_NOMORE
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) %s: GPM ptr invalid "
literal|"@ptr=%d, @offset=%d, more=NOMORE.\n"
argument_list|,
name|__func__
argument_list|,
name|gpm_ptr
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|state_type
operator|==
name|HAL_MCI_STATE_NEXT_GPM_OFFSET
condition|)
block|{
if|if
condition|(
name|gpm_ptr
operator|==
name|ahp
operator|->
name|ah_mci_gpm_idx
condition|)
block|{
name|value
operator|=
name|HAL_MCI_GPM_INVALID
expr_stmt|;
name|more_gpm
operator|=
name|HAL_MCI_GPM_NOMORE
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) %s: GPM message not available "
literal|"@ptr=%d, @offset=%d, more=NOMORE.\n"
argument_list|,
name|__func__
argument_list|,
name|gpm_ptr
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
else|else
block|{
while|while
condition|(
literal|1
condition|)
block|{
name|u_int32_t
name|temp_index
decl_stmt|;
comment|/* skip reserved GPM if any */
if|if
condition|(
name|value
operator|!=
name|ahp
operator|->
name|ah_mci_gpm_idx
condition|)
block|{
name|more_gpm
operator|=
name|HAL_MCI_GPM_MORE
expr_stmt|;
block|}
else|else
block|{
name|more_gpm
operator|=
name|HAL_MCI_GPM_NOMORE
expr_stmt|;
block|}
name|temp_index
operator|=
name|ahp
operator|->
name|ah_mci_gpm_idx
expr_stmt|;
name|ahp
operator|->
name|ah_mci_gpm_idx
operator|++
expr_stmt|;
if|if
condition|(
name|ahp
operator|->
name|ah_mci_gpm_idx
operator|>=
name|ahp
operator|->
name|ah_mci_gpm_len
condition|)
block|{
name|ahp
operator|->
name|ah_mci_gpm_idx
operator|=
literal|0
expr_stmt|;
block|}
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) %s: GPM message got "
literal|"@ptr=%d, @offset=%d, more=%s.\n"
argument_list|,
name|__func__
argument_list|,
name|gpm_ptr
argument_list|,
name|temp_index
argument_list|,
operator|(
name|more_gpm
operator|==
name|HAL_MCI_GPM_MORE
operator|)
condition|?
literal|"MORE"
else|:
literal|"NOMORE"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ar9300_mci_is_gpm_valid
argument_list|(
name|ah
argument_list|,
name|temp_index
argument_list|)
condition|)
block|{
name|value
operator|=
name|temp_index
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|more_gpm
operator|==
name|HAL_MCI_GPM_NOMORE
condition|)
block|{
name|value
operator|=
name|HAL_MCI_GPM_INVALID
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
name|p_data
operator|!=
name|NULL
condition|)
block|{
operator|*
name|p_data
operator|=
name|more_gpm
expr_stmt|;
block|}
block|}
if|if
condition|(
name|value
operator|!=
name|HAL_MCI_GPM_INVALID
condition|)
block|{
name|value
operator|<<=
literal|4
expr_stmt|;
block|}
break|break;
case|case
name|HAL_MCI_STATE_LAST_SCHD_MSG_OFFSET
case|:
name|value
operator|=
name|MS
argument_list|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_MCI_RX_STATUS
argument_list|)
argument_list|,
name|AR_MCI_RX_LAST_SCHD_MSG_INDEX
argument_list|)
expr_stmt|;
if|#
directive|if
name|AH_MCI_DEBUG_PRINT_SCHED
block|{
name|u_int32_t
name|index
init|=
name|value
decl_stmt|;
name|u_int32_t
name|prev_index
decl_stmt|,
name|sched_idx
decl_stmt|;
name|u_int32_t
modifier|*
name|pld
decl_stmt|;
name|u_int8_t
modifier|*
name|pld8
decl_stmt|;
name|u_int32_t
name|wbtimer
init|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_WBTIMER
argument_list|)
decl_stmt|;
name|u_int32_t
name|schd_ctl
init|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_MCI_HW_SCHD_TBL_CTL
argument_list|)
decl_stmt|;
if|if
condition|(
name|index
operator|>
literal|0
condition|)
block|{
name|prev_index
operator|=
name|index
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
name|prev_index
operator|=
name|index
expr_stmt|;
block|}
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) SCHED\n"
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) SCHED SCHD_TBL_CTRL=0x%08x, WBTIMER=0x%08x (%d)\n"
argument_list|,
name|schd_ctl
argument_list|,
name|wbtimer
argument_list|,
name|wbtimer
argument_list|)
expr_stmt|;
for|for
control|(
name|sched_idx
operator|=
name|prev_index
init|;
name|sched_idx
operator|<=
name|index
condition|;
name|sched_idx
operator|++
control|)
block|{
name|pld
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|ahp
operator|->
name|ah_mci_sched_buf
operator|+
operator|(
name|sched_idx
operator|<<
literal|4
operator|)
operator|)
expr_stmt|;
name|pld8
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
name|pld
expr_stmt|;
name|ar9300_mci_print_msg
argument_list|(
name|ah
argument_list|,
name|AH_FALSE
argument_list|,
name|MCI_SCHD_INFO
argument_list|,
literal|16
argument_list|,
name|pld
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) SCHED    idx=%d, T1=0x%08x (%d), T2=0x%08x (%d)\n"
argument_list|,
name|sched_idx
argument_list|,
name|pld
index|[
literal|0
index|]
argument_list|,
name|pld
index|[
literal|0
index|]
argument_list|,
name|pld
index|[
literal|1
index|]
argument_list|,
name|pld
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) SCHED    addr=%d %s pwr=%d prio=%d %s link=%d\n"
argument_list|,
name|pld8
index|[
literal|11
index|]
operator|>>
literal|4
argument_list|,
operator|(
name|pld8
index|[
literal|11
index|]
operator|&
literal|0x08
operator|)
condition|?
literal|"TX"
else|:
literal|"RX"
argument_list|,
call|(
name|int8_t
call|)
argument_list|(
operator|(
operator|(
name|pld8
index|[
literal|11
index|]
operator|&
literal|0x07
operator|)
operator|<<
literal|5
operator|)
operator||
operator|(
name|pld8
index|[
literal|10
index|]
operator|>>
literal|3
operator|)
argument_list|)
argument_list|,
operator|(
operator|(
operator|(
name|pld8
index|[
literal|10
index|]
operator|&
literal|0x07
operator|)
operator|<<
literal|5
operator|)
operator||
operator|(
name|pld8
index|[
literal|9
index|]
operator|>>
literal|3
operator|)
operator|)
argument_list|,
operator|(
name|pld8
index|[
literal|9
index|]
operator|&
literal|0x04
operator|)
condition|?
literal|"LE"
else|:
literal|"BR/EDR"
argument_list|,
operator|(
operator|(
operator|(
name|pld8
index|[
literal|9
index|]
operator|&
literal|0x03
operator|)
operator|<<
literal|2
operator|)
operator||
operator|(
name|pld8
index|[
literal|8
index|]
operator|>>
literal|6
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* AH_MCI_DEBUG_PRINT_SCHED */
comment|/* Make it in bytes */
name|value
operator|<<=
literal|4
expr_stmt|;
break|break;
case|case
name|HAL_MCI_STATE_REMOTE_SLEEP
case|:
name|value
operator|=
name|MS
argument_list|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_MCI_RX_STATUS
argument_list|)
argument_list|,
name|AR_MCI_RX_REMOTE_SLEEP
argument_list|)
condition|?
name|MCI_BT_SLEEP
else|:
name|MCI_BT_AWAKE
expr_stmt|;
break|break;
case|case
name|HAL_MCI_STATE_CONT_RSSI_POWER
case|:
name|value
operator|=
name|MS
argument_list|(
name|ahp
operator|->
name|ah_mci_cont_status
argument_list|,
name|AR_MCI_CONT_RSSI_POWER
argument_list|)
expr_stmt|;
break|break;
case|case
name|HAL_MCI_STATE_CONT_PRIORITY
case|:
name|value
operator|=
name|MS
argument_list|(
name|ahp
operator|->
name|ah_mci_cont_status
argument_list|,
name|AR_MCI_CONT_RRIORITY
argument_list|)
expr_stmt|;
break|break;
case|case
name|HAL_MCI_STATE_CONT_TXRX
case|:
name|value
operator|=
name|MS
argument_list|(
name|ahp
operator|->
name|ah_mci_cont_status
argument_list|,
name|AR_MCI_CONT_TXRX
argument_list|)
expr_stmt|;
break|break;
case|case
name|HAL_MCI_STATE_BT
case|:
name|value
operator|=
name|ahp
operator|->
name|ah_mci_bt_state
expr_stmt|;
break|break;
case|case
name|HAL_MCI_STATE_SET_BT_SLEEP
case|:
name|ahp
operator|->
name|ah_mci_bt_state
operator|=
name|MCI_BT_SLEEP
expr_stmt|;
break|break;
case|case
name|HAL_MCI_STATE_SET_BT_AWAKE
case|:
name|ahp
operator|->
name|ah_mci_bt_state
operator|=
name|MCI_BT_AWAKE
expr_stmt|;
name|ar9300_mci_send_coex_version_query
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
name|ar9300_mci_send_coex_wlan_channels
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ahp
operator|->
name|ah_mci_unhalt_bt_gpm
operator|==
name|AH_TRUE
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) %s: UNHALT BT GPM\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ar9300_mci_send_coex_halt_bt_gpm
argument_list|(
name|ah
argument_list|,
name|AH_FALSE
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
block|}
name|ar9300_mci_2g5g_switch
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
break|break;
case|case
name|HAL_MCI_STATE_SET_BT_CAL_START
case|:
name|ahp
operator|->
name|ah_mci_bt_state
operator|=
name|MCI_BT_CAL_START
expr_stmt|;
break|break;
case|case
name|HAL_MCI_STATE_SET_BT_CAL
case|:
name|ahp
operator|->
name|ah_mci_bt_state
operator|=
name|MCI_BT_CAL
expr_stmt|;
break|break;
case|case
name|HAL_MCI_STATE_RESET_REQ_WAKE
case|:
name|ar9300_mci_reset_req_wakeup
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|ah_mci_coex_2g5g_update
operator|=
name|AH_TRUE
expr_stmt|;
if|if
condition|(
operator|(
name|AR_SREV_JUPITER_20_OR_LATER
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_APHRODITE
argument_list|(
name|ah
argument_list|)
operator|)
operator|&&
operator|(
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_mci_config
operator|&
name|ATH_MCI_CONFIG_MCI_OBS_MASK
operator|)
condition|)
block|{
comment|/* Check if we still have control of the GPIOs */
if|if
condition|(
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_GLB_GPIO_CONTROL
argument_list|)
operator|&
name|ATH_MCI_CONFIG_MCI_OBS_GPIO
operator|)
operator|!=
name|ATH_MCI_CONFIG_MCI_OBS_GPIO
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) Reconfigure observation\n"
argument_list|)
expr_stmt|;
name|ar9300_mci_observation_set_up
argument_list|(
name|ah
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|HAL_MCI_STATE_SEND_WLAN_COEX_VERSION
case|:
name|ar9300_mci_send_coex_version_response
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
break|break;
case|case
name|HAL_MCI_STATE_SET_BT_COEX_VERSION
case|:
if|if
condition|(
name|p_data
operator|==
name|NULL
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) Error: Set BT Coex version with NULL data !!!\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ahp
operator|->
name|ah_mci_coex_major_version_bt
operator|=
operator|(
operator|*
name|p_data
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|ahp
operator|->
name|ah_mci_coex_minor_version_bt
operator|=
operator|(
operator|*
name|p_data
operator|)
operator|&
literal|0xff
expr_stmt|;
name|ahp
operator|->
name|ah_mci_coex_bt_version_known
operator|=
name|AH_TRUE
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) BT version set: %d.%d\n"
argument_list|,
name|ahp
operator|->
name|ah_mci_coex_major_version_bt
argument_list|,
name|ahp
operator|->
name|ah_mci_coex_minor_version_bt
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|HAL_MCI_STATE_SEND_WLAN_CHANNELS
case|:
if|if
condition|(
name|p_data
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|ahp
operator|->
name|ah_mci_coex_wlan_channels
index|[
literal|1
index|]
operator|&
literal|0xffff0000
operator|)
operator|==
operator|(
operator|*
operator|(
name|p_data
operator|+
literal|1
operator|)
operator|&
literal|0xffff0000
operator|)
operator|)
operator|&&
operator|(
name|ahp
operator|->
name|ah_mci_coex_wlan_channels
index|[
literal|2
index|]
operator|==
operator|*
operator|(
name|p_data
operator|+
literal|2
operator|)
operator|)
operator|&&
operator|(
name|ahp
operator|->
name|ah_mci_coex_wlan_channels
index|[
literal|3
index|]
operator|==
operator|*
operator|(
name|p_data
operator|+
literal|3
operator|)
operator|)
condition|)
block|{
break|break;
block|}
name|ahp
operator|->
name|ah_mci_coex_wlan_channels
index|[
literal|0
index|]
operator|=
operator|*
name|p_data
operator|++
expr_stmt|;
name|ahp
operator|->
name|ah_mci_coex_wlan_channels
index|[
literal|1
index|]
operator|=
operator|*
name|p_data
operator|++
expr_stmt|;
name|ahp
operator|->
name|ah_mci_coex_wlan_channels
index|[
literal|2
index|]
operator|=
operator|*
name|p_data
operator|++
expr_stmt|;
name|ahp
operator|->
name|ah_mci_coex_wlan_channels
index|[
literal|3
index|]
operator|=
operator|*
name|p_data
operator|++
expr_stmt|;
block|}
name|ahp
operator|->
name|ah_mci_coex_wlan_channels_update
operator|=
name|AH_TRUE
expr_stmt|;
name|ar9300_mci_send_coex_wlan_channels
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
break|break;
case|case
name|HAL_MCI_STATE_SEND_VERSION_QUERY
case|:
name|ar9300_mci_send_coex_version_query
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
break|break;
case|case
name|HAL_MCI_STATE_SEND_STATUS_QUERY
case|:
if|if
condition|(
name|AR_SREV_JUPITER_10
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|ar9300_mci_send_coex_bt_status_query
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|,
name|MCI_GPM_COEX_QUERY_BT_ALL_INFO
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ar9300_mci_send_coex_bt_status_query
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|,
name|MCI_GPM_COEX_QUERY_BT_TOPOLOGY
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|HAL_MCI_STATE_NEED_FLUSH_BT_INFO
case|:
comment|/*              * ah_mci_unhalt_bt_gpm means whether it's needed to send              * UNHALT message. It's set whenever there's a request to send HALT              * message. ah_mci_halted_bt_gpm means whether HALT message is sent              * out successfully.              *              * Checking (ah_mci_unhalt_bt_gpm == AH_FALSE) instead of checking              * (ahp->ah_mci_halted_bt_gpm == AH_FALSE) will make sure currently is              * in UNHALT-ed mode and BT can respond to status query.              */
if|if
condition|(
operator|(
name|ahp
operator|->
name|ah_mci_unhalt_bt_gpm
operator|==
name|AH_FALSE
operator|)
operator|&&
operator|(
name|ahp
operator|->
name|ah_mci_need_flush_btinfo
operator|==
name|AH_TRUE
operator|)
condition|)
block|{
name|value
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|value
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|p_data
operator|!=
name|NULL
condition|)
block|{
name|ahp
operator|->
name|ah_mci_need_flush_btinfo
operator|=
operator|(
operator|*
name|p_data
operator|!=
literal|0
operator|)
condition|?
name|AH_TRUE
else|:
name|AH_FALSE
expr_stmt|;
block|}
break|break;
case|case
name|HAL_MCI_STATE_SET_CONCUR_TX_PRI
case|:
if|if
condition|(
name|p_data
condition|)
block|{
name|ahp
operator|->
name|ah_mci_stomp_none_tx_pri
operator|=
operator|*
name|p_data
operator|&
literal|0xff
expr_stmt|;
name|ahp
operator|->
name|ah_mci_stomp_low_tx_pri
operator|=
operator|(
operator|*
name|p_data
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|ahp
operator|->
name|ah_mci_stomp_all_tx_pri
operator|=
operator|(
operator|*
name|p_data
operator|>>
literal|16
operator|)
operator|&
literal|0xff
expr_stmt|;
block|}
break|break;
case|case
name|HAL_MCI_STATE_RECOVER_RX
case|:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) hal RECOVER_RX\n"
argument_list|)
expr_stmt|;
name|ar9300_mci_prep_interface
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|ah_mci_query_bt
operator|=
name|AH_TRUE
expr_stmt|;
name|ahp
operator|->
name|ah_mci_need_flush_btinfo
operator|=
name|AH_TRUE
expr_stmt|;
name|ar9300_mci_send_coex_wlan_channels
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
name|ar9300_mci_2g5g_switch
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
break|break;
case|case
name|HAL_MCI_STATE_DEBUG
case|:
if|if
condition|(
name|p_data
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|*
name|p_data
operator|==
name|HAL_MCI_STATE_DEBUG_REQ_BT_DEBUG
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) QUERY_BT_DEBUG\n"
argument_list|)
expr_stmt|;
name|ar9300_mci_send_coex_bt_status_query
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|,
name|MCI_GPM_COEX_QUERY_BT_DEBUG
argument_list|)
expr_stmt|;
name|OS_DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|AR_SREV_JUPITER_20
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_APHRODITE
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|ar9300_mci_send_coex_bt_flags
argument_list|(
name|ah
argument_list|,
name|AH_TRUE
argument_list|,
name|MCI_GPM_COEX_BT_FLAGS_READ
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
break|break;
case|case
name|HAL_MCI_STATE_NEED_FTP_STOMP
case|:
name|value
operator|=
operator|(
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_mci_config
operator|&
name|ATH_MCI_CONFIG_DISABLE_FTP_STOMP
operator|)
condition|?
literal|0
else|:
literal|1
expr_stmt|;
break|break;
case|case
name|HAL_MCI_STATE_NEED_TUNING
case|:
name|value
operator|=
operator|(
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_mci_config
operator|&
name|ATH_MCI_CONFIG_DISABLE_TUNING
operator|)
condition|?
literal|0
else|:
literal|1
expr_stmt|;
break|break;
case|case
name|HAL_MCI_STATE_SHARED_CHAIN_CONCUR_TX
case|:
name|value
operator|=
operator|(
operator|(
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_mci_config
operator|&
name|ATH_MCI_CONFIG_CONCUR_TX
operator|)
operator|==
name|ATH_MCI_CONCUR_TX_SHARED_CHN
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
name|value
return|;
block|}
end_function

begin_function
name|void
name|ar9300_mci_detach
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
comment|/* Turn off MCI and Jupiter mode. */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_CTRL
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) ar9300_mci_detach\n"
argument_list|)
expr_stmt|;
name|ar9300_mci_disable_interrupt
argument_list|(
name|ah
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Low priority BT: 0 - 59(0x3b)  * High priority BT: 60 - 125(0x7d)  * Critical BT: 126 - 255      BTCOEX_WL_WEIGHTS0_VALUE0 ; // wl_idle                            BTCOEX_WL_WEIGHTS0_VALUE1 ; // sw_ctrl[3] - all_stomp             BTCOEX_WL_WEIGHTS0_VALUE2 ; // sw_ctrl[2] - all_not_stomp         BTCOEX_WL_WEIGHTS0_VALUE3 ; // sw_ctrl[1] - pa_pre_distortion     BTCOEX_WL_WEIGHTS1_VALUE0 ; // sw_ctrl[0] - general purpose       BTCOEX_WL_WEIGHTS1_VALUE1 ; // tm_wl_wait_beacon                  BTCOEX_WL_WEIGHTS1_VALUE2 ; // ts_state_wait_ack_cts              BTCOEX_WL_WEIGHTS1_VALUE3 ; // self_gen                           BTCOEX_WL_WEIGHTS2_VALUE0 ; // idle                               BTCOEX_WL_WEIGHTS2_VALUE1 ; // rx                                 BTCOEX_WL_WEIGHTS2_VALUE2 ; // tx                                 BTCOEX_WL_WEIGHTS2_VALUE3 ; // rx + tx                            BTCOEX_WL_WEIGHTS3_VALUE0 ; // tx                                 BTCOEX_WL_WEIGHTS3_VALUE1 ; // rx                                 BTCOEX_WL_WEIGHTS3_VALUE2 ; // tx                                 BTCOEX_WL_WEIGHTS3_VALUE3 ; // rx + tx                             Stomp all:     ah_bt_coex_wlan_weight[0] = 0x00007d00     ah_bt_coex_wlan_weight[1] = 0x7d7d7d00     ah_bt_coex_wlan_weight[2] = 0x7d7d7d00     ah_bt_coex_wlan_weight[3] = 0x7d7d7d7d     Stomp low:     ah_bt_coex_wlan_weight[0] = 0x00007d00     ah_bt_coex_wlan_weight[1] = 0x7d3b3b00     ah_bt_coex_wlan_weight[2] = 0x3b3b3b00     ah_bt_coex_wlan_weight[3] = 0x3b3b3b3b     Stomp none:     ah_bt_coex_wlan_weight[0] = 0x00007d00     ah_bt_coex_wlan_weight[1] = 0x7d000000     ah_bt_coex_wlan_weight[2] = 0x00000000     ah_bt_coex_wlan_weight[3] = 0x00000000 */
end_comment

begin_function
name|void
name|ar9300_mci_bt_coex_set_weights
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int32_t
name|stomp_type
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
comment|//    struct ath_hal_private *ahpriv = AH_PRIVATE(ah);
name|u_int32_t
name|tx_priority
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|stomp_type
condition|)
block|{
case|case
name|HAL_BT_COEX_STOMP_ALL
case|:
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|0
index|]
operator|=
name|JUPITER_STOMP_ALL_WLAN_WGHT0
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|1
index|]
operator|=
name|JUPITER_STOMP_ALL_WLAN_WGHT1
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|2
index|]
operator|=
name|JUPITER_STOMP_ALL_WLAN_WGHT2
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|3
index|]
operator|=
name|JUPITER_STOMP_ALL_WLAN_WGHT3
expr_stmt|;
if|if
condition|(
name|ahp
operator|->
name|ah_mci_concur_tx_en
operator|&&
name|ahp
operator|->
name|ah_mci_stomp_all_tx_pri
condition|)
block|{
name|tx_priority
operator|=
name|ahp
operator|->
name|ah_mci_stomp_all_tx_pri
expr_stmt|;
block|}
break|break;
case|case
name|HAL_BT_COEX_STOMP_LOW
case|:
if|if
condition|(
name|ahp
operator|->
name|ah_bt_coex_flag
operator|&
name|HAL_BT_COEX_FLAG_MCI_FTP_STOMP_RX
condition|)
block|{
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|0
index|]
operator|=
name|JUPITER_STOMP_LOW_FTP_WLAN_WGHT0
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|1
index|]
operator|=
name|JUPITER_STOMP_LOW_FTP_WLAN_WGHT1
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|2
index|]
operator|=
name|JUPITER_STOMP_LOW_FTP_WLAN_WGHT2
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|3
index|]
operator|=
name|JUPITER_STOMP_LOW_FTP_WLAN_WGHT3
expr_stmt|;
block|}
else|else
block|{
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|0
index|]
operator|=
name|JUPITER_STOMP_LOW_WLAN_WGHT0
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|1
index|]
operator|=
name|JUPITER_STOMP_LOW_WLAN_WGHT1
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|2
index|]
operator|=
name|JUPITER_STOMP_LOW_WLAN_WGHT2
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|3
index|]
operator|=
name|JUPITER_STOMP_LOW_WLAN_WGHT3
expr_stmt|;
block|}
if|if
condition|(
name|ahp
operator|->
name|ah_mci_concur_tx_en
operator|&&
name|ahp
operator|->
name|ah_mci_stomp_low_tx_pri
condition|)
block|{
name|tx_priority
operator|=
name|ahp
operator|->
name|ah_mci_stomp_low_tx_pri
expr_stmt|;
block|}
if|if
condition|(
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_mci_config
operator|&
name|ATH_MCI_CONFIG_MCI_OBS_TXRX
condition|)
block|{
name|ar9300_gpio_set
argument_list|(
name|ah
argument_list|,
literal|5
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|HAL_BT_COEX_STOMP_ALL_FORCE
case|:
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|0
index|]
operator|=
name|JUPITER_STOMP_ALL_FORCE_WLAN_WGHT0
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|1
index|]
operator|=
name|JUPITER_STOMP_ALL_FORCE_WLAN_WGHT1
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|2
index|]
operator|=
name|JUPITER_STOMP_ALL_FORCE_WLAN_WGHT2
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|3
index|]
operator|=
name|JUPITER_STOMP_ALL_FORCE_WLAN_WGHT3
expr_stmt|;
break|break;
case|case
name|HAL_BT_COEX_STOMP_LOW_FORCE
case|:
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|0
index|]
operator|=
name|JUPITER_STOMP_LOW_FORCE_WLAN_WGHT0
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|1
index|]
operator|=
name|JUPITER_STOMP_LOW_FORCE_WLAN_WGHT1
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|2
index|]
operator|=
name|JUPITER_STOMP_LOW_FORCE_WLAN_WGHT2
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|3
index|]
operator|=
name|JUPITER_STOMP_LOW_FORCE_WLAN_WGHT3
expr_stmt|;
if|if
condition|(
name|ahp
operator|->
name|ah_mci_concur_tx_en
operator|&&
name|ahp
operator|->
name|ah_mci_stomp_low_tx_pri
condition|)
block|{
name|tx_priority
operator|=
name|ahp
operator|->
name|ah_mci_stomp_low_tx_pri
expr_stmt|;
block|}
break|break;
case|case
name|HAL_BT_COEX_STOMP_NONE
case|:
case|case
name|HAL_BT_COEX_NO_STOMP
case|:
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|0
index|]
operator|=
name|JUPITER_STOMP_NONE_WLAN_WGHT0
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|1
index|]
operator|=
name|JUPITER_STOMP_NONE_WLAN_WGHT1
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|2
index|]
operator|=
name|JUPITER_STOMP_NONE_WLAN_WGHT2
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|3
index|]
operator|=
name|JUPITER_STOMP_NONE_WLAN_WGHT3
expr_stmt|;
if|if
condition|(
name|ahp
operator|->
name|ah_mci_concur_tx_en
operator|&&
name|ahp
operator|->
name|ah_mci_stomp_none_tx_pri
condition|)
block|{
name|tx_priority
operator|=
name|ahp
operator|->
name|ah_mci_stomp_none_tx_pri
expr_stmt|;
block|}
if|if
condition|(
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_mci_config
operator|&
name|ATH_MCI_CONFIG_MCI_OBS_TXRX
condition|)
block|{
name|ar9300_gpio_set
argument_list|(
name|ah
argument_list|,
literal|5
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
comment|/* There is a forceWeight from registry */
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|0
index|]
operator|=
name|stomp_type
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|1
index|]
operator|=
name|stomp_type
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ahp
operator|->
name|ah_mci_concur_tx_en
operator|&&
name|tx_priority
condition|)
block|{
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|1
index|]
operator|&=
operator|~
name|MCI_CONCUR_TX_WLAN_WGHT1_MASK
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|1
index|]
operator||=
name|SM
argument_list|(
name|tx_priority
argument_list|,
name|MCI_CONCUR_TX_WLAN_WGHT1_MASK
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|2
index|]
operator|&=
operator|~
name|MCI_CONCUR_TX_WLAN_WGHT2_MASK
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|2
index|]
operator||=
name|SM
argument_list|(
name|tx_priority
argument_list|,
name|MCI_CONCUR_TX_WLAN_WGHT2_MASK
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|3
index|]
operator|&=
operator|~
name|MCI_CONCUR_TX_WLAN_WGHT3_MASK
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|3
index|]
operator||=
name|SM
argument_list|(
name|tx_priority
argument_list|,
name|MCI_CONCUR_TX_WLAN_WGHT3_MASK
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|3
index|]
operator|&=
operator|~
name|MCI_CONCUR_TX_WLAN_WGHT3_MASK2
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|3
index|]
operator||=
name|SM
argument_list|(
name|tx_priority
argument_list|,
name|MCI_CONCUR_TX_WLAN_WGHT3_MASK2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_mci_config
operator|&
name|ATH_MCI_CONFIG_MCI_WEIGHT_DBG
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) Set weights: 0x%08x 0x%08x 0x%08x 0x%08x\n"
argument_list|,
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|0
index|]
argument_list|,
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|1
index|]
argument_list|,
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|2
index|]
argument_list|,
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ar9300_mci_bt_coex_disable
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) %s: Set weight to stomp none.\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ar9300_mci_bt_coex_set_weights
argument_list|(
name|ah
argument_list|,
name|HAL_BT_COEX_STOMP_NONE
argument_list|)
expr_stmt|;
comment|/*       * In Jupiter, when coex is disabled, we just set weight      * table to be in favor of WLAN.      */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_WL_WEIGHTS0
argument_list|,
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_WL_WEIGHTS1
argument_list|,
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_WL_WEIGHTS2
argument_list|,
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_WL_WEIGHTS3
argument_list|,
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_enabled
operator|=
name|AH_FALSE
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ar9300_mci_bt_coex_enable
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
comment|/* Mainly change the WLAN weight table */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_WL_WEIGHTS0
argument_list|,
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_WL_WEIGHTS1
argument_list|,
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_WL_WEIGHTS2
argument_list|,
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BTCOEX_WL_WEIGHTS3
argument_list|,
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
comment|/* Send ACK even when BT has higher priority. */
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_QUIET1
argument_list|,
name|AR_QUIET1_QUIET_ACK_CTS_ENABLE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ahp
operator|->
name|ah_bt_coex_flag
operator|&
name|HAL_BT_COEX_FLAG_LOW_ACK_PWR
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_TPC
argument_list|,
name|HAL_BT_COEX_LOW_ACK_POWER
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_TPC
argument_list|,
name|HAL_BT_COEX_HIGH_ACK_POWER
argument_list|)
expr_stmt|;
block|}
name|ahp
operator|->
name|ah_bt_coex_enabled
operator|=
name|AH_TRUE
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ATH_SUPPORT_MCI */
end_comment

end_unit


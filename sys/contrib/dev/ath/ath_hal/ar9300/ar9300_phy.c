begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2013 Qualcomm Atheros, Inc.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR  * OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|"opt_ah.h"
end_include

begin_include
include|#
directive|include
file|"ah.h"
end_include

begin_include
include|#
directive|include
file|"ah_internal.h"
end_include

begin_include
include|#
directive|include
file|"ar9300/ar9300.h"
end_include

begin_comment
comment|/* shorthands to compact tables for readability */
end_comment

begin_define
define|#
directive|define
name|OFDM
value|IEEE80211_T_OFDM
end_define

begin_define
define|#
directive|define
name|CCK
value|IEEE80211_T_CCK
end_define

begin_define
define|#
directive|define
name|TURBO
value|IEEE80211_T_TURBO
end_define

begin_define
define|#
directive|define
name|XR
value|ATHEROS_T_XR
end_define

begin_define
define|#
directive|define
name|HT
value|IEEE80211_T_HT
end_define

begin_define
define|#
directive|define
name|AR9300_NUM_OFDM_RATES
value|8
end_define

begin_define
define|#
directive|define
name|AR9300_NUM_HT_SS_RATES
value|8
end_define

begin_define
define|#
directive|define
name|AR9300_NUM_HT_DS_RATES
value|8
end_define

begin_define
define|#
directive|define
name|AR9300_NUM_HT_TS_RATES
value|8
end_define

begin_comment
comment|/* Array Gain defined for TxBF */
end_comment

begin_define
define|#
directive|define
name|AR9300_TXBF_2TX_ARRAY_GAIN
value|6
end_define

begin_comment
comment|/* 2TX/SS 3 */
end_comment

begin_define
define|#
directive|define
name|AR9300_TXBF_3TX_ARRAY_GAIN
value|10
end_define

begin_comment
comment|/* 3TX/SS or 3TX/DS 4.8 */
end_comment

begin_define
define|#
directive|define
name|AR9300_STBC_3TX_ARRAY_GAIN
value|10
end_define

begin_comment
comment|/* 3TX/SS or 3TX/DS 4.8 */
end_comment

begin_comment
comment|/* MCS RATE CODES - first and last */
end_comment

begin_define
define|#
directive|define
name|AR9300_MCS0_RATE_CODE
value|0x80
end_define

begin_define
define|#
directive|define
name|AR9300_MCS23_RATE_CODE
value|0x97
end_define

begin_function_decl
specifier|static
specifier|inline
name|void
name|ar9300_init_rate_txpower_cck
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|HAL_RATE_TABLE
modifier|*
name|rt
parameter_list|,
name|u_int8_t
name|rates_array
index|[]
parameter_list|,
name|u_int8_t
name|chainmask
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|ar9300_init_rate_txpower_ofdm
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|HAL_RATE_TABLE
modifier|*
name|rt
parameter_list|,
name|u_int8_t
name|rates_array
index|[]
parameter_list|,
name|int
name|rt_offset
parameter_list|,
name|u_int8_t
name|chainmask
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|ar9300_init_rate_txpower_ht
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|HAL_RATE_TABLE
modifier|*
name|rt
parameter_list|,
name|HAL_BOOL
name|is40
parameter_list|,
name|u_int8_t
name|rates_array
index|[]
parameter_list|,
name|int
name|rt_ss_offset
parameter_list|,
name|int
name|rt_ds_offset
parameter_list|,
name|int
name|rt_ts_offset
parameter_list|,
name|u_int8_t
name|chainmask
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|ar9300_init_rate_txpower_stbc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|HAL_RATE_TABLE
modifier|*
name|rt
parameter_list|,
name|HAL_BOOL
name|is40
parameter_list|,
name|int
name|rt_ss_offset
parameter_list|,
name|int
name|rt_ds_offset
parameter_list|,
name|int
name|rt_ts_offset
parameter_list|,
name|u_int8_t
name|chainmask
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
specifier|inline
name|void
name|ar9300_adjust_rate_txpower_cdd
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|HAL_RATE_TABLE
modifier|*
name|rt
parameter_list|,
name|HAL_BOOL
name|is40
parameter_list|,
name|int
name|rt_ss_offset
parameter_list|,
name|int
name|rt_ds_offset
parameter_list|,
name|int
name|rt_ts_offset
parameter_list|,
name|u_int8_t
name|chainmask
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|AR9300_11A_RT_OFDM_OFFSET
value|0
end_define

begin_decl_stmt
name|HAL_RATE_TABLE
name|ar9300_11a_table
init|=
block|{
literal|8
block|,
comment|/* number of rates */
block|{
literal|0
block|}
block|,
block|{
comment|/*                                                  short            ctrl */
comment|/*             valid                 rate_code Preamble    dot11Rate Rate */
comment|/*   6 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|6000
block|,
literal|0x0b
block|,
literal|0x00
block|,
operator|(
literal|0x80
operator||
literal|12
operator|)
block|,
literal|0
block|}
block|,
comment|/*   9 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|9000
block|,
literal|0x0f
block|,
literal|0x00
block|,
literal|18
block|,
literal|0
block|}
block|,
comment|/*  12 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|12000
block|,
literal|0x0a
block|,
literal|0x00
block|,
operator|(
literal|0x80
operator||
literal|24
operator|)
block|,
literal|2
block|}
block|,
comment|/*  18 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|18000
block|,
literal|0x0e
block|,
literal|0x00
block|,
literal|36
block|,
literal|2
block|}
block|,
comment|/*  24 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|24000
block|,
literal|0x09
block|,
literal|0x00
block|,
operator|(
literal|0x80
operator||
literal|48
operator|)
block|,
literal|4
block|}
block|,
comment|/*  36 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|36000
block|,
literal|0x0d
block|,
literal|0x00
block|,
literal|72
block|,
literal|4
block|}
block|,
comment|/*  48 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|48000
block|,
literal|0x08
block|,
literal|0x00
block|,
literal|96
block|,
literal|4
block|}
block|,
comment|/*  54 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|54000
block|,
literal|0x0c
block|,
literal|0x00
block|,
literal|108
block|,
literal|4
block|}
block|,     }
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|HAL_RATE_TABLE
name|ar9300_11a_half_table
init|=
block|{
literal|8
block|,
comment|/* number of rates */
block|{
literal|0
block|}
block|,
block|{
comment|/*                                                  short            ctrl */
comment|/*             valid                 rate_code Preamble    dot11Rate Rate */
comment|/*   6 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|3000
block|,
literal|0x0b
block|,
literal|0x00
block|,
operator|(
literal|0x80
operator||
literal|6
operator|)
block|,
literal|0
block|}
block|,
comment|/*   9 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|4500
block|,
literal|0x0f
block|,
literal|0x00
block|,
literal|9
block|,
literal|0
block|}
block|,
comment|/*  12 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|6000
block|,
literal|0x0a
block|,
literal|0x00
block|,
operator|(
literal|0x80
operator||
literal|12
operator|)
block|,
literal|2
block|}
block|,
comment|/*  18 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|9000
block|,
literal|0x0e
block|,
literal|0x00
block|,
literal|18
block|,
literal|2
block|}
block|,
comment|/*  24 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|12000
block|,
literal|0x09
block|,
literal|0x00
block|,
operator|(
literal|0x80
operator||
literal|24
operator|)
block|,
literal|4
block|}
block|,
comment|/*  36 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|18000
block|,
literal|0x0d
block|,
literal|0x00
block|,
literal|36
block|,
literal|4
block|}
block|,
comment|/*  48 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|24000
block|,
literal|0x08
block|,
literal|0x00
block|,
literal|48
block|,
literal|4
block|}
block|,
comment|/*  54 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|27000
block|,
literal|0x0c
block|,
literal|0x00
block|,
literal|54
block|,
literal|4
block|}
block|,     }
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|HAL_RATE_TABLE
name|ar9300_11a_quarter_table
init|=
block|{
literal|8
block|,
comment|/* number of rates */
block|{
literal|0
block|}
block|,
block|{
comment|/*                                                  short           ctrl */
comment|/*            valid                 rate_code Preamble    dot11Rate Rate */
comment|/*  6 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|1500
block|,
literal|0x0b
block|,
literal|0x00
block|,
operator|(
literal|0x80
operator||
literal|3
operator|)
block|,
literal|0
block|}
block|,
comment|/*  9 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|2250
block|,
literal|0x0f
block|,
literal|0x00
block|,
literal|4
block|,
literal|0
block|}
block|,
comment|/* 12 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|3000
block|,
literal|0x0a
block|,
literal|0x00
block|,
operator|(
literal|0x80
operator||
literal|6
operator|)
block|,
literal|2
block|}
block|,
comment|/* 18 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|4500
block|,
literal|0x0e
block|,
literal|0x00
block|,
literal|9
block|,
literal|2
block|}
block|,
comment|/* 24 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|6000
block|,
literal|0x09
block|,
literal|0x00
block|,
operator|(
literal|0x80
operator||
literal|12
operator|)
block|,
literal|4
block|}
block|,
comment|/* 36 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|9000
block|,
literal|0x0d
block|,
literal|0x00
block|,
literal|18
block|,
literal|4
block|}
block|,
comment|/* 48 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|12000
block|,
literal|0x08
block|,
literal|0x00
block|,
literal|24
block|,
literal|4
block|}
block|,
comment|/* 54 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|13500
block|,
literal|0x0c
block|,
literal|0x00
block|,
literal|27
block|,
literal|4
block|}
block|,     }
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|HAL_RATE_TABLE
name|ar9300_turbo_table
init|=
block|{
literal|8
block|,
comment|/* number of rates */
block|{
literal|0
block|}
block|,
block|{
comment|/*                                                 short            ctrl */
comment|/*             valid                rate_code Preamble    dot11Rate Rate */
comment|/*   6 Mb */
block|{
name|AH_TRUE
block|,
name|TURBO
block|,
literal|6000
block|,
literal|0x0b
block|,
literal|0x00
block|,
operator|(
literal|0x80
operator||
literal|12
operator|)
block|,
literal|0
block|}
block|,
comment|/*   9 Mb */
block|{
name|AH_TRUE
block|,
name|TURBO
block|,
literal|9000
block|,
literal|0x0f
block|,
literal|0x00
block|,
literal|18
block|,
literal|0
block|}
block|,
comment|/*  12 Mb */
block|{
name|AH_TRUE
block|,
name|TURBO
block|,
literal|12000
block|,
literal|0x0a
block|,
literal|0x00
block|,
operator|(
literal|0x80
operator||
literal|24
operator|)
block|,
literal|2
block|}
block|,
comment|/*  18 Mb */
block|{
name|AH_TRUE
block|,
name|TURBO
block|,
literal|18000
block|,
literal|0x0e
block|,
literal|0x00
block|,
literal|36
block|,
literal|2
block|}
block|,
comment|/*  24 Mb */
block|{
name|AH_TRUE
block|,
name|TURBO
block|,
literal|24000
block|,
literal|0x09
block|,
literal|0x00
block|,
operator|(
literal|0x80
operator||
literal|48
operator|)
block|,
literal|4
block|}
block|,
comment|/*  36 Mb */
block|{
name|AH_TRUE
block|,
name|TURBO
block|,
literal|36000
block|,
literal|0x0d
block|,
literal|0x00
block|,
literal|72
block|,
literal|4
block|}
block|,
comment|/*  48 Mb */
block|{
name|AH_TRUE
block|,
name|TURBO
block|,
literal|48000
block|,
literal|0x08
block|,
literal|0x00
block|,
literal|96
block|,
literal|4
block|}
block|,
comment|/*  54 Mb */
block|{
name|AH_TRUE
block|,
name|TURBO
block|,
literal|54000
block|,
literal|0x0c
block|,
literal|0x00
block|,
literal|108
block|,
literal|4
block|}
block|,     }
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|HAL_RATE_TABLE
name|ar9300_11b_table
init|=
block|{
literal|4
block|,
comment|/* number of rates */
block|{
literal|0
block|}
block|,
block|{
comment|/*                                                 short            ctrl */
comment|/*             valid                rate_code Preamble    dot11Rate Rate */
comment|/*   1 Mb */
block|{
name|AH_TRUE
block|,
name|CCK
block|,
literal|1000
block|,
literal|0x1b
block|,
literal|0x00
block|,
operator|(
literal|0x80
operator||
literal|2
operator|)
block|,
literal|0
block|}
block|,
comment|/*   2 Mb */
block|{
name|AH_TRUE
block|,
name|CCK
block|,
literal|2000
block|,
literal|0x1a
block|,
literal|0x04
block|,
operator|(
literal|0x80
operator||
literal|4
operator|)
block|,
literal|1
block|}
block|,
comment|/* 5.5 Mb */
block|{
name|AH_TRUE
block|,
name|CCK
block|,
literal|5500
block|,
literal|0x19
block|,
literal|0x04
block|,
operator|(
literal|0x80
operator||
literal|11
operator|)
block|,
literal|1
block|}
block|,
comment|/*  11 Mb */
block|{
name|AH_TRUE
block|,
name|CCK
block|,
literal|11000
block|,
literal|0x18
block|,
literal|0x04
block|,
operator|(
literal|0x80
operator||
literal|22
operator|)
block|,
literal|1
block|}
block|,     }
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Venice TODO: round_up_rate() is broken when the rate table does not represent  * rates in increasing order  e.g.  5.5, 11, 6, 9.  * An average rate of 6 Mbps will currently map to 11 Mbps.  */
end_comment

begin_define
define|#
directive|define
name|AR9300_11G_RT_OFDM_OFFSET
value|4
end_define

begin_decl_stmt
name|HAL_RATE_TABLE
name|ar9300_11g_table
init|=
block|{
literal|12
block|,
comment|/* number of rates */
block|{
literal|0
block|}
block|,
block|{
comment|/*                                                 short            ctrl */
comment|/*             valid                rate_code Preamble    dot11Rate Rate */
comment|/*   1 Mb */
block|{
name|AH_TRUE
block|,
name|CCK
block|,
literal|1000
block|,
literal|0x1b
block|,
literal|0x00
block|,
operator|(
literal|0x80
operator||
literal|2
operator|)
block|,
literal|0
block|}
block|,
comment|/*   2 Mb */
block|{
name|AH_TRUE
block|,
name|CCK
block|,
literal|2000
block|,
literal|0x1a
block|,
literal|0x04
block|,
operator|(
literal|0x80
operator||
literal|4
operator|)
block|,
literal|1
block|}
block|,
comment|/* 5.5 Mb */
block|{
name|AH_TRUE
block|,
name|CCK
block|,
literal|5500
block|,
literal|0x19
block|,
literal|0x04
block|,
operator|(
literal|0x80
operator||
literal|11
operator|)
block|,
literal|2
block|}
block|,
comment|/*  11 Mb */
block|{
name|AH_TRUE
block|,
name|CCK
block|,
literal|11000
block|,
literal|0x18
block|,
literal|0x04
block|,
operator|(
literal|0x80
operator||
literal|22
operator|)
block|,
literal|3
block|}
block|,
comment|/* Hardware workaround - remove rates 6, 9 from rate ctrl */
comment|/*   6 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|6000
block|,
literal|0x0b
block|,
literal|0x00
block|,
literal|12
block|,
literal|4
block|}
block|,
comment|/*   9 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|9000
block|,
literal|0x0f
block|,
literal|0x00
block|,
literal|18
block|,
literal|4
block|}
block|,
comment|/*  12 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|12000
block|,
literal|0x0a
block|,
literal|0x00
block|,
literal|24
block|,
literal|6
block|}
block|,
comment|/*  18 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|18000
block|,
literal|0x0e
block|,
literal|0x00
block|,
literal|36
block|,
literal|6
block|}
block|,
comment|/*  24 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|24000
block|,
literal|0x09
block|,
literal|0x00
block|,
literal|48
block|,
literal|8
block|}
block|,
comment|/*  36 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|36000
block|,
literal|0x0d
block|,
literal|0x00
block|,
literal|72
block|,
literal|8
block|}
block|,
comment|/*  48 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|48000
block|,
literal|0x08
block|,
literal|0x00
block|,
literal|96
block|,
literal|8
block|}
block|,
comment|/*  54 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|54000
block|,
literal|0x0c
block|,
literal|0x00
block|,
literal|108
block|,
literal|8
block|}
block|,     }
block|, }
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
unit|HAL_RATE_TABLE ar9300_xr_table = {     13,
comment|/* number of rates */
end_comment

begin_comment
unit|{ 0 },     {
comment|/*                                                 short     ctrl */
end_comment

begin_comment
comment|/*            valid          rate_code Preamble    dot11Rate Rate */
end_comment

begin_comment
comment|/* 0.25 Mb */
end_comment

begin_comment
unit|{AH_TRUE,   XR,   250, 0x03,   0x00, (0x80 |  1),   0, 612, 612 },
comment|/*  0.5 Mb */
end_comment

begin_comment
unit|{AH_TRUE,   XR,   500, 0x07,   0x00, (0x80 |  1),   0, 457, 457 },
comment|/*    1 Mb */
end_comment

begin_comment
unit|{AH_TRUE,   XR,  1000, 0x02,   0x00, (0x80 |  2),   1, 228, 228 },
comment|/*    2 Mb */
end_comment

begin_comment
unit|{AH_TRUE,   XR,  2000, 0x06,   0x00, (0x80 |  4),   2, 160, 160 },
comment|/*    3 Mb */
end_comment

begin_comment
unit|{AH_TRUE,   XR,  3000, 0x01,   0x00, (0x80 |  6),   3, 140, 140 },
comment|/*    6 Mb */
end_comment

begin_comment
unit|{AH_TRUE, OFDM,  6000, 0x0b,   0x00, (0x80 | 12),   4, 60,  60  },
comment|/*    9 Mb */
end_comment

begin_comment
unit|{AH_TRUE, OFDM,  9000, 0x0f,   0x00,          18,   4, 60,  60  },
comment|/*   12 Mb */
end_comment

begin_comment
unit|{AH_TRUE, OFDM, 12000, 0x0a,   0x00, (0x80 | 24),   6, 48,  48  },
comment|/*   18 Mb */
end_comment

begin_comment
unit|{AH_TRUE, OFDM, 18000, 0x0e,   0x00,          36,   6, 48,  48  },
comment|/*   24 Mb */
end_comment

begin_comment
unit|{AH_TRUE, OFDM, 24000, 0x09,   0x00,          48,   8, 44,  44  },
comment|/*   36 Mb */
end_comment

begin_comment
unit|{AH_TRUE, OFDM, 36000, 0x0d,   0x00,          72,   8, 44,  44  },
comment|/*   48 Mb */
end_comment

begin_comment
unit|{AH_TRUE, OFDM, 48000, 0x08,   0x00,          96,   8, 44,  44  },
comment|/*   54 Mb */
end_comment

begin_endif
unit|{AH_TRUE, OFDM, 54000, 0x0c,   0x00,         108,   8, 44,  44  },     }, };
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|AR9300_11NG_RT_OFDM_OFFSET
value|4
end_define

begin_define
define|#
directive|define
name|AR9300_11NG_RT_HT_SS_OFFSET
value|12
end_define

begin_define
define|#
directive|define
name|AR9300_11NG_RT_HT_DS_OFFSET
value|20
end_define

begin_define
define|#
directive|define
name|AR9300_11NG_RT_HT_TS_OFFSET
value|28
end_define

begin_decl_stmt
name|HAL_RATE_TABLE
name|ar9300_11ng_table
init|=
block|{
literal|36
block|,
comment|/* number of rates */
block|{
literal|0
block|}
block|,
block|{
comment|/*                                                 short            ctrl */
comment|/*             valid                rate_code Preamble    dot11Rate Rate */
comment|/*   1 Mb */
block|{
name|AH_TRUE
block|,
name|CCK
block|,
literal|1000
block|,
literal|0x1b
block|,
literal|0x00
block|,
operator|(
literal|0x80
operator||
literal|2
operator|)
block|,
literal|0
block|}
block|,
comment|/*   2 Mb */
block|{
name|AH_TRUE
block|,
name|CCK
block|,
literal|2000
block|,
literal|0x1a
block|,
literal|0x04
block|,
operator|(
literal|0x80
operator||
literal|4
operator|)
block|,
literal|1
block|}
block|,
comment|/* 5.5 Mb */
block|{
name|AH_TRUE
block|,
name|CCK
block|,
literal|5500
block|,
literal|0x19
block|,
literal|0x04
block|,
operator|(
literal|0x80
operator||
literal|11
operator|)
block|,
literal|2
block|}
block|,
comment|/*  11 Mb */
block|{
name|AH_TRUE
block|,
name|CCK
block|,
literal|11000
block|,
literal|0x18
block|,
literal|0x04
block|,
operator|(
literal|0x80
operator||
literal|22
operator|)
block|,
literal|3
block|}
block|,
comment|/* Hardware workaround - remove rates 6, 9 from rate ctrl */
comment|/*   6 Mb */
block|{
name|AH_FALSE
block|,
name|OFDM
block|,
literal|6000
block|,
literal|0x0b
block|,
literal|0x00
block|,
literal|12
block|,
literal|4
block|}
block|,
comment|/*   9 Mb */
block|{
name|AH_FALSE
block|,
name|OFDM
block|,
literal|9000
block|,
literal|0x0f
block|,
literal|0x00
block|,
literal|18
block|,
literal|4
block|}
block|,
comment|/*  12 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|12000
block|,
literal|0x0a
block|,
literal|0x00
block|,
literal|24
block|,
literal|6
block|}
block|,
comment|/*  18 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|18000
block|,
literal|0x0e
block|,
literal|0x00
block|,
literal|36
block|,
literal|6
block|}
block|,
comment|/*  24 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|24000
block|,
literal|0x09
block|,
literal|0x00
block|,
literal|48
block|,
literal|8
block|}
block|,
comment|/*  36 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|36000
block|,
literal|0x0d
block|,
literal|0x00
block|,
literal|72
block|,
literal|8
block|}
block|,
comment|/*  48 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|48000
block|,
literal|0x08
block|,
literal|0x00
block|,
literal|96
block|,
literal|8
block|}
block|,
comment|/*  54 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|54000
block|,
literal|0x0c
block|,
literal|0x00
block|,
literal|108
block|,
literal|8
block|}
block|,
comment|/*--- HT SS rates ---*/
comment|/* 6.5 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|6500
block|,
literal|0x80
block|,
literal|0x00
block|,
literal|0
block|,
literal|4
block|}
block|,
comment|/*  13 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|13000
block|,
literal|0x81
block|,
literal|0x00
block|,
literal|1
block|,
literal|6
block|}
block|,
comment|/*19.5 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|19500
block|,
literal|0x82
block|,
literal|0x00
block|,
literal|2
block|,
literal|6
block|}
block|,
comment|/*  26 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|26000
block|,
literal|0x83
block|,
literal|0x00
block|,
literal|3
block|,
literal|8
block|}
block|,
comment|/*  39 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|39000
block|,
literal|0x84
block|,
literal|0x00
block|,
literal|4
block|,
literal|8
block|}
block|,
comment|/*  52 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|52000
block|,
literal|0x85
block|,
literal|0x00
block|,
literal|5
block|,
literal|8
block|}
block|,
comment|/*58.5 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|58500
block|,
literal|0x86
block|,
literal|0x00
block|,
literal|6
block|,
literal|8
block|}
block|,
comment|/*  65 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|65000
block|,
literal|0x87
block|,
literal|0x00
block|,
literal|7
block|,
literal|8
block|}
block|,
comment|/*--- HT DS rates ---*/
comment|/*  13 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|13000
block|,
literal|0x88
block|,
literal|0x00
block|,
literal|8
block|,
literal|4
block|}
block|,
comment|/*  26 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|26000
block|,
literal|0x89
block|,
literal|0x00
block|,
literal|9
block|,
literal|6
block|}
block|,
comment|/*  39 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|39000
block|,
literal|0x8a
block|,
literal|0x00
block|,
literal|10
block|,
literal|6
block|}
block|,
comment|/*  52 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|52000
block|,
literal|0x8b
block|,
literal|0x00
block|,
literal|11
block|,
literal|8
block|}
block|,
comment|/*  78 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|78000
block|,
literal|0x8c
block|,
literal|0x00
block|,
literal|12
block|,
literal|8
block|}
block|,
comment|/* 104 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|104000
block|,
literal|0x8d
block|,
literal|0x00
block|,
literal|13
block|,
literal|8
block|}
block|,
comment|/* 117 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|117000
block|,
literal|0x8e
block|,
literal|0x00
block|,
literal|14
block|,
literal|8
block|}
block|,
comment|/* 130 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|130000
block|,
literal|0x8f
block|,
literal|0x00
block|,
literal|15
block|,
literal|8
block|}
block|,
comment|/*--- HT TS rates ---*/
comment|/*19.5 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|19500
block|,
literal|0x90
block|,
literal|0x00
block|,
literal|16
block|,
literal|4
block|}
block|,
comment|/*  39 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|39000
block|,
literal|0x91
block|,
literal|0x00
block|,
literal|17
block|,
literal|6
block|}
block|,
comment|/*58.5 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|58500
block|,
literal|0x92
block|,
literal|0x00
block|,
literal|18
block|,
literal|6
block|}
block|,
comment|/*  78 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|78000
block|,
literal|0x93
block|,
literal|0x00
block|,
literal|19
block|,
literal|8
block|}
block|,
comment|/* 117 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|117000
block|,
literal|0x94
block|,
literal|0x00
block|,
literal|20
block|,
literal|8
block|}
block|,
comment|/* 156 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|156000
block|,
literal|0x95
block|,
literal|0x00
block|,
literal|21
block|,
literal|8
block|}
block|,
comment|/*175.5Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|175500
block|,
literal|0x96
block|,
literal|0x00
block|,
literal|22
block|,
literal|8
block|}
block|,
comment|/* 195 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|195000
block|,
literal|0x97
block|,
literal|0x00
block|,
literal|23
block|,
literal|8
block|}
block|,     }
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|AR9300_11NA_RT_OFDM_OFFSET
value|0
end_define

begin_define
define|#
directive|define
name|AR9300_11NA_RT_HT_SS_OFFSET
value|8
end_define

begin_define
define|#
directive|define
name|AR9300_11NA_RT_HT_DS_OFFSET
value|16
end_define

begin_define
define|#
directive|define
name|AR9300_11NA_RT_HT_TS_OFFSET
value|24
end_define

begin_decl_stmt
specifier|static
name|HAL_RATE_TABLE
name|ar9300_11na_table
init|=
block|{
literal|32
block|,
comment|/* number of rates */
block|{
literal|0
block|}
block|,
block|{
comment|/*                                                 short            ctrl */
comment|/*             valid                rate_code Preamble    dot11Rate Rate */
comment|/*   6 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|6000
block|,
literal|0x0b
block|,
literal|0x00
block|,
operator|(
literal|0x80
operator||
literal|12
operator|)
block|,
literal|0
block|}
block|,
comment|/*   9 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|9000
block|,
literal|0x0f
block|,
literal|0x00
block|,
literal|18
block|,
literal|0
block|}
block|,
comment|/*  12 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|12000
block|,
literal|0x0a
block|,
literal|0x00
block|,
operator|(
literal|0x80
operator||
literal|24
operator|)
block|,
literal|2
block|}
block|,
comment|/*  18 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|18000
block|,
literal|0x0e
block|,
literal|0x00
block|,
literal|36
block|,
literal|2
block|}
block|,
comment|/*  24 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|24000
block|,
literal|0x09
block|,
literal|0x00
block|,
operator|(
literal|0x80
operator||
literal|48
operator|)
block|,
literal|4
block|}
block|,
comment|/*  36 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|36000
block|,
literal|0x0d
block|,
literal|0x00
block|,
literal|72
block|,
literal|4
block|}
block|,
comment|/*  48 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|48000
block|,
literal|0x08
block|,
literal|0x00
block|,
literal|96
block|,
literal|4
block|}
block|,
comment|/*  54 Mb */
block|{
name|AH_TRUE
block|,
name|OFDM
block|,
literal|54000
block|,
literal|0x0c
block|,
literal|0x00
block|,
literal|108
block|,
literal|4
block|}
block|,
comment|/*--- HT SS rates ---*/
comment|/* 6.5 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|6500
block|,
literal|0x80
block|,
literal|0x00
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/*  13 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|13000
block|,
literal|0x81
block|,
literal|0x00
block|,
literal|1
block|,
literal|2
block|}
block|,
comment|/*19.5 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|19500
block|,
literal|0x82
block|,
literal|0x00
block|,
literal|2
block|,
literal|2
block|}
block|,
comment|/*  26 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|26000
block|,
literal|0x83
block|,
literal|0x00
block|,
literal|3
block|,
literal|4
block|}
block|,
comment|/*  39 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|39000
block|,
literal|0x84
block|,
literal|0x00
block|,
literal|4
block|,
literal|4
block|}
block|,
comment|/*  52 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|52000
block|,
literal|0x85
block|,
literal|0x00
block|,
literal|5
block|,
literal|4
block|}
block|,
comment|/*58.5 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|58500
block|,
literal|0x86
block|,
literal|0x00
block|,
literal|6
block|,
literal|4
block|}
block|,
comment|/*  65 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|65000
block|,
literal|0x87
block|,
literal|0x00
block|,
literal|7
block|,
literal|4
block|}
block|,
comment|/*--- HT DS rates ---*/
comment|/*  13 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|13000
block|,
literal|0x88
block|,
literal|0x00
block|,
literal|8
block|,
literal|0
block|}
block|,
comment|/*  26 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|26000
block|,
literal|0x89
block|,
literal|0x00
block|,
literal|9
block|,
literal|2
block|}
block|,
comment|/*  39 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|39000
block|,
literal|0x8a
block|,
literal|0x00
block|,
literal|10
block|,
literal|2
block|}
block|,
comment|/*  52 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|52000
block|,
literal|0x8b
block|,
literal|0x00
block|,
literal|11
block|,
literal|4
block|}
block|,
comment|/*  78 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|78000
block|,
literal|0x8c
block|,
literal|0x00
block|,
literal|12
block|,
literal|4
block|}
block|,
comment|/* 104 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|104000
block|,
literal|0x8d
block|,
literal|0x00
block|,
literal|13
block|,
literal|4
block|}
block|,
comment|/* 117 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|117000
block|,
literal|0x8e
block|,
literal|0x00
block|,
literal|14
block|,
literal|4
block|}
block|,
comment|/* 130 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|130000
block|,
literal|0x8f
block|,
literal|0x00
block|,
literal|15
block|,
literal|4
block|}
block|,
comment|/*--- HT TS rates ---*/
comment|/*19.5 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|19500
block|,
literal|0x90
block|,
literal|0x00
block|,
literal|16
block|,
literal|0
block|}
block|,
comment|/*  39 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|39000
block|,
literal|0x91
block|,
literal|0x00
block|,
literal|17
block|,
literal|2
block|}
block|,
comment|/*58.5 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|58500
block|,
literal|0x92
block|,
literal|0x00
block|,
literal|18
block|,
literal|2
block|}
block|,
comment|/*  78 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|78000
block|,
literal|0x93
block|,
literal|0x00
block|,
literal|19
block|,
literal|4
block|}
block|,
comment|/* 117 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|117000
block|,
literal|0x94
block|,
literal|0x00
block|,
literal|20
block|,
literal|4
block|}
block|,
comment|/* 156 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|156000
block|,
literal|0x95
block|,
literal|0x00
block|,
literal|21
block|,
literal|4
block|}
block|,
comment|/*175.5Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|175500
block|,
literal|0x96
block|,
literal|0x00
block|,
literal|22
block|,
literal|4
block|}
block|,
comment|/* 195 Mb */
block|{
name|AH_TRUE
block|,
name|HT
block|,
literal|195000
block|,
literal|0x97
block|,
literal|0x00
block|,
literal|23
block|,
literal|4
block|}
block|,     }
block|, }
decl_stmt|;
end_decl_stmt

begin_undef
undef|#
directive|undef
name|OFDM
end_undef

begin_undef
undef|#
directive|undef
name|CCK
end_undef

begin_undef
undef|#
directive|undef
name|TURBO
end_undef

begin_undef
undef|#
directive|undef
name|XR
end_undef

begin_undef
undef|#
directive|undef
name|HT
end_undef

begin_undef
undef|#
directive|undef
name|HT_HGI
end_undef

begin_function
specifier|const
name|HAL_RATE_TABLE
modifier|*
name|ar9300_get_rate_table
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int
name|mode
parameter_list|)
block|{
name|struct
name|ath_hal_private
modifier|*
name|ahpriv
init|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HAL_CAPABILITIES
modifier|*
name|p_cap
init|=
operator|&
name|ahpriv
operator|->
name|ah_caps
decl_stmt|;
name|HAL_RATE_TABLE
modifier|*
name|rt
decl_stmt|;
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|HAL_MODE_11A
case|:
name|rt
operator|=
operator|&
name|ar9300_11a_table
expr_stmt|;
break|break;
case|case
name|HAL_MODE_11A_HALF_RATE
case|:
if|if
condition|(
name|p_cap
operator|->
name|halChanHalfRate
condition|)
block|{
name|rt
operator|=
operator|&
name|ar9300_11a_half_table
expr_stmt|;
break|break;
block|}
return|return
name|AH_NULL
return|;
case|case
name|HAL_MODE_11A_QUARTER_RATE
case|:
if|if
condition|(
name|p_cap
operator|->
name|halChanQuarterRate
condition|)
block|{
name|rt
operator|=
operator|&
name|ar9300_11a_quarter_table
expr_stmt|;
break|break;
block|}
return|return
name|AH_NULL
return|;
case|case
name|HAL_MODE_11B
case|:
name|rt
operator|=
operator|&
name|ar9300_11b_table
expr_stmt|;
break|break;
case|case
name|HAL_MODE_11G
case|:
name|rt
operator|=
operator|&
name|ar9300_11g_table
expr_stmt|;
break|break;
case|case
name|HAL_MODE_TURBO
case|:
case|case
name|HAL_MODE_108G
case|:
name|rt
operator|=
operator|&
name|ar9300_turbo_table
expr_stmt|;
break|break;
if|#
directive|if
literal|0
block|case HAL_MODE_XR:         rt =&ar9300_xr_table;         break;
endif|#
directive|endif
case|case
name|HAL_MODE_11NG_HT20
case|:
case|case
name|HAL_MODE_11NG_HT40PLUS
case|:
case|case
name|HAL_MODE_11NG_HT40MINUS
case|:
name|rt
operator|=
operator|&
name|ar9300_11ng_table
expr_stmt|;
break|break;
case|case
name|HAL_MODE_11NA_HT20
case|:
case|case
name|HAL_MODE_11NA_HT40PLUS
case|:
case|case
name|HAL_MODE_11NA_HT40MINUS
case|:
name|rt
operator|=
operator|&
name|ar9300_11na_table
expr_stmt|;
break|break;
default|default:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_CHANNEL
argument_list|,
literal|"%s: invalid mode 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|mode
argument_list|)
expr_stmt|;
return|return
name|AH_NULL
return|;
block|}
name|ath_hal_setupratetable
argument_list|(
name|ah
argument_list|,
name|rt
argument_list|)
expr_stmt|;
return|return
name|rt
return|;
block|}
end_function

begin_function
specifier|static
name|HAL_BOOL
name|ar9300_invalid_stbc_cfg
parameter_list|(
name|int
name|tx_chains
parameter_list|,
name|u_int8_t
name|rate_code
parameter_list|)
block|{
switch|switch
condition|(
name|tx_chains
condition|)
block|{
case|case
literal|0
case|:
comment|/* Single Chain */
return|return
name|AH_TRUE
return|;
case|case
literal|1
case|:
comment|/* 2 Chains */
if|if
condition|(
operator|(
name|rate_code
operator|<
literal|0x80
operator|)
operator|||
operator|(
name|rate_code
operator|>
literal|0x87
operator|)
condition|)
block|{
return|return
name|AH_TRUE
return|;
block|}
else|else
block|{
return|return
name|AH_FALSE
return|;
block|}
case|case
literal|2
case|:
comment|/* 3 Chains */
if|if
condition|(
operator|(
name|rate_code
operator|<
literal|0x80
operator|)
operator|||
operator|(
name|rate_code
operator|>
literal|0x87
operator|)
condition|)
block|{
return|return
name|AH_TRUE
return|;
block|}
else|else
block|{
return|return
name|AH_FALSE
return|;
block|}
default|default:
name|HALASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_function
name|int16_t
name|ar9300_get_rate_txpower
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int
name|mode
parameter_list|,
name|u_int8_t
name|rate_index
parameter_list|,
name|u_int8_t
name|chainmask
parameter_list|,
name|u_int8_t
name|xmit_mode
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|int
name|num_chains
init|=
name|ar9300_get_ntxchains
argument_list|(
name|chainmask
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|xmit_mode
condition|)
block|{
case|case
name|AR9300_DEF_MODE
case|:
return|return
name|ahp
operator|->
name|txpower
index|[
name|rate_index
index|]
index|[
name|num_chains
operator|-
literal|1
index|]
return|;
case|case
name|AR9300_STBC_MODE
case|:
return|return
name|ahp
operator|->
name|txpower_stbc
index|[
name|rate_index
index|]
index|[
name|num_chains
operator|-
literal|1
index|]
return|;
default|default:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_POWER_MGMT
argument_list|,
literal|"%s: invalid mode 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|xmit_mode
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|ahp
operator|->
name|txpower
index|[
name|rate_index
index|]
index|[
name|num_chains
operator|-
literal|1
index|]
return|;
block|}
end_function

begin_function
specifier|extern
name|void
name|ar9300_adjust_reg_txpower_cdd
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int8_t
name|power_per_rate
index|[]
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|int16_t
name|twice_array_gain
decl_stmt|,
name|cdd_power
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/*      *  Adjust the upper limit for CDD factoring in the array gain .      *  The array gain is the same as TxBF, hence reuse the same defines.       */
switch|switch
condition|(
name|ahp
operator|->
name|ah_tx_chainmask
condition|)
block|{
case|case
name|OSPREY_1_CHAINMASK
case|:
name|cdd_power
operator|=
name|ahp
operator|->
name|upper_limit
index|[
literal|0
index|]
expr_stmt|;
break|break;
case|case
name|OSPREY_2LOHI_CHAINMASK
case|:
case|case
name|OSPREY_2LOMID_CHAINMASK
case|:
name|twice_array_gain
operator|=
operator|(
name|ahp
operator|->
name|twice_antenna_gain
operator|>=
name|ahp
operator|->
name|twice_antenna_reduction
operator|)
condition|?
operator|-
operator|(
name|AR9300_TXBF_2TX_ARRAY_GAIN
operator|)
else|:
operator|(
operator|(
name|int16_t
operator|)
name|AH_MIN
argument_list|(
operator|(
name|ahp
operator|->
name|twice_antenna_reduction
operator|-
operator|(
name|ahp
operator|->
name|twice_antenna_gain
operator|+
name|AR9300_TXBF_2TX_ARRAY_GAIN
operator|)
operator|)
argument_list|,
literal|0
argument_list|)
operator|)
expr_stmt|;
name|cdd_power
operator|=
name|ahp
operator|->
name|upper_limit
index|[
literal|1
index|]
operator|+
name|twice_array_gain
expr_stmt|;
comment|/* Adjust OFDM legacy rates as well */
for|for
control|(
name|i
operator|=
name|ALL_TARGET_LEGACY_6_24
init|;
name|i
operator|<=
name|ALL_TARGET_LEGACY_54
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|power_per_rate
index|[
name|i
index|]
operator|>
name|cdd_power
condition|)
block|{
name|power_per_rate
index|[
name|i
index|]
operator|=
name|cdd_power
expr_stmt|;
block|}
block|}
comment|/* 2Tx/(n-1) stream Adjust rates MCS0 through MCS 7  HT 20*/
for|for
control|(
name|i
operator|=
name|ALL_TARGET_HT20_0_8_16
init|;
name|i
operator|<=
name|ALL_TARGET_HT20_7
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|power_per_rate
index|[
name|i
index|]
operator|>
name|cdd_power
condition|)
block|{
name|power_per_rate
index|[
name|i
index|]
operator|=
name|cdd_power
expr_stmt|;
block|}
block|}
comment|/* 2Tx/(n-1) stream Adjust rates MCS0 through MCS 7  HT 40*/
for|for
control|(
name|i
operator|=
name|ALL_TARGET_HT40_0_8_16
init|;
name|i
operator|<=
name|ALL_TARGET_HT40_7
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|power_per_rate
index|[
name|i
index|]
operator|>
name|cdd_power
condition|)
block|{
name|power_per_rate
index|[
name|i
index|]
operator|=
name|cdd_power
expr_stmt|;
block|}
block|}
break|break;
case|case
name|OSPREY_3_CHAINMASK
case|:
name|twice_array_gain
operator|=
operator|(
name|ahp
operator|->
name|twice_antenna_gain
operator|>=
name|ahp
operator|->
name|twice_antenna_reduction
operator|)
condition|?
operator|-
operator|(
name|AR9300_TXBF_3TX_ARRAY_GAIN
operator|)
else|:
operator|(
operator|(
name|int16_t
operator|)
name|AH_MIN
argument_list|(
operator|(
name|ahp
operator|->
name|twice_antenna_reduction
operator|-
operator|(
name|ahp
operator|->
name|twice_antenna_gain
operator|+
name|AR9300_TXBF_3TX_ARRAY_GAIN
operator|)
operator|)
argument_list|,
literal|0
argument_list|)
operator|)
expr_stmt|;
name|cdd_power
operator|=
name|ahp
operator|->
name|upper_limit
index|[
literal|2
index|]
operator|+
name|twice_array_gain
expr_stmt|;
comment|/* Adjust OFDM legacy rates as well */
for|for
control|(
name|i
operator|=
name|ALL_TARGET_LEGACY_6_24
init|;
name|i
operator|<=
name|ALL_TARGET_LEGACY_54
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|power_per_rate
index|[
name|i
index|]
operator|>
name|cdd_power
condition|)
block|{
name|power_per_rate
index|[
name|i
index|]
operator|=
name|cdd_power
expr_stmt|;
block|}
block|}
comment|/* 3Tx/(n-1)streams Adjust rates MCS0 through MCS 15 HT20 */
for|for
control|(
name|i
operator|=
name|ALL_TARGET_HT20_0_8_16
init|;
name|i
operator|<=
name|ALL_TARGET_HT20_15
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|power_per_rate
index|[
name|i
index|]
operator|>
name|cdd_power
condition|)
block|{
name|power_per_rate
index|[
name|i
index|]
operator|=
name|cdd_power
expr_stmt|;
block|}
block|}
comment|/* 3Tx/(n-1)streams Adjust rates MCS0 through MCS 15 HT40 */
for|for
control|(
name|i
operator|=
name|ALL_TARGET_HT40_0_8_16
init|;
name|i
operator|<=
name|ALL_TARGET_HT40_15
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|power_per_rate
index|[
name|i
index|]
operator|>
name|cdd_power
condition|)
block|{
name|power_per_rate
index|[
name|i
index|]
operator|=
name|cdd_power
expr_stmt|;
block|}
block|}
break|break;
default|default:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_POWER_MGMT
argument_list|,
literal|"%s: invalid chainmask 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|ahp
operator|->
name|ah_tx_chainmask
argument_list|)
expr_stmt|;
break|break;
block|}
return|return;
block|}
end_function

begin_function
specifier|extern
name|void
name|ar9300_init_rate_txpower
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int
name|mode
parameter_list|,
specifier|const
name|struct
name|ieee80211_channel
modifier|*
name|chan
parameter_list|,
name|u_int8_t
name|power_per_rate
index|[]
parameter_list|,
name|u_int8_t
name|chainmask
parameter_list|)
block|{
specifier|const
name|HAL_RATE_TABLE
modifier|*
name|rt
decl_stmt|;
name|HAL_BOOL
name|is40
init|=
name|IEEE80211_IS_CHAN_HT40
argument_list|(
name|chan
argument_list|)
decl_stmt|;
name|rt
operator|=
name|ar9300_get_rate_table
argument_list|(
name|ah
argument_list|,
name|mode
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
name|rt
operator|!=
name|NULL
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|HAL_MODE_11A
case|:
name|ar9300_init_rate_txpower_ofdm
argument_list|(
name|ah
argument_list|,
name|rt
argument_list|,
name|power_per_rate
argument_list|,
name|AR9300_11A_RT_OFDM_OFFSET
argument_list|,
name|chainmask
argument_list|)
expr_stmt|;
break|break;
case|case
name|HAL_MODE_11NA_HT20
case|:
case|case
name|HAL_MODE_11NA_HT40PLUS
case|:
case|case
name|HAL_MODE_11NA_HT40MINUS
case|:
name|ar9300_init_rate_txpower_ofdm
argument_list|(
name|ah
argument_list|,
name|rt
argument_list|,
name|power_per_rate
argument_list|,
name|AR9300_11NA_RT_OFDM_OFFSET
argument_list|,
name|chainmask
argument_list|)
expr_stmt|;
name|ar9300_init_rate_txpower_ht
argument_list|(
name|ah
argument_list|,
name|rt
argument_list|,
name|is40
argument_list|,
name|power_per_rate
argument_list|,
name|AR9300_11NA_RT_HT_SS_OFFSET
argument_list|,
name|AR9300_11NA_RT_HT_DS_OFFSET
argument_list|,
name|AR9300_11NA_RT_HT_TS_OFFSET
argument_list|,
name|chainmask
argument_list|)
expr_stmt|;
name|ar9300_init_rate_txpower_stbc
argument_list|(
name|ah
argument_list|,
name|rt
argument_list|,
name|is40
argument_list|,
name|AR9300_11NA_RT_HT_SS_OFFSET
argument_list|,
name|AR9300_11NA_RT_HT_DS_OFFSET
argument_list|,
name|AR9300_11NA_RT_HT_TS_OFFSET
argument_list|,
name|chainmask
argument_list|)
expr_stmt|;
comment|/* For FCC the array gain has to be factored for CDD mode */
if|if
condition|(
name|is_reg_dmn_fcc
argument_list|(
name|ath_hal_getctl
argument_list|(
name|ah
argument_list|,
name|chan
argument_list|)
argument_list|)
condition|)
block|{
name|ar9300_adjust_rate_txpower_cdd
argument_list|(
name|ah
argument_list|,
name|rt
argument_list|,
name|is40
argument_list|,
name|AR9300_11NA_RT_HT_SS_OFFSET
argument_list|,
name|AR9300_11NA_RT_HT_DS_OFFSET
argument_list|,
name|AR9300_11NA_RT_HT_TS_OFFSET
argument_list|,
name|chainmask
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|HAL_MODE_11G
case|:
name|ar9300_init_rate_txpower_cck
argument_list|(
name|ah
argument_list|,
name|rt
argument_list|,
name|power_per_rate
argument_list|,
name|chainmask
argument_list|)
expr_stmt|;
name|ar9300_init_rate_txpower_ofdm
argument_list|(
name|ah
argument_list|,
name|rt
argument_list|,
name|power_per_rate
argument_list|,
name|AR9300_11G_RT_OFDM_OFFSET
argument_list|,
name|chainmask
argument_list|)
expr_stmt|;
break|break;
case|case
name|HAL_MODE_11B
case|:
name|ar9300_init_rate_txpower_cck
argument_list|(
name|ah
argument_list|,
name|rt
argument_list|,
name|power_per_rate
argument_list|,
name|chainmask
argument_list|)
expr_stmt|;
break|break;
case|case
name|HAL_MODE_11NG_HT20
case|:
case|case
name|HAL_MODE_11NG_HT40PLUS
case|:
case|case
name|HAL_MODE_11NG_HT40MINUS
case|:
name|ar9300_init_rate_txpower_cck
argument_list|(
name|ah
argument_list|,
name|rt
argument_list|,
name|power_per_rate
argument_list|,
name|chainmask
argument_list|)
expr_stmt|;
name|ar9300_init_rate_txpower_ofdm
argument_list|(
name|ah
argument_list|,
name|rt
argument_list|,
name|power_per_rate
argument_list|,
name|AR9300_11NG_RT_OFDM_OFFSET
argument_list|,
name|chainmask
argument_list|)
expr_stmt|;
name|ar9300_init_rate_txpower_ht
argument_list|(
name|ah
argument_list|,
name|rt
argument_list|,
name|is40
argument_list|,
name|power_per_rate
argument_list|,
name|AR9300_11NG_RT_HT_SS_OFFSET
argument_list|,
name|AR9300_11NG_RT_HT_DS_OFFSET
argument_list|,
name|AR9300_11NG_RT_HT_TS_OFFSET
argument_list|,
name|chainmask
argument_list|)
expr_stmt|;
name|ar9300_init_rate_txpower_stbc
argument_list|(
name|ah
argument_list|,
name|rt
argument_list|,
name|is40
argument_list|,
name|AR9300_11NG_RT_HT_SS_OFFSET
argument_list|,
name|AR9300_11NG_RT_HT_DS_OFFSET
argument_list|,
name|AR9300_11NG_RT_HT_TS_OFFSET
argument_list|,
name|chainmask
argument_list|)
expr_stmt|;
comment|/* For FCC the array gain needs to be factored for CDD mode */
if|if
condition|(
name|is_reg_dmn_fcc
argument_list|(
name|ath_hal_getctl
argument_list|(
name|ah
argument_list|,
name|chan
argument_list|)
argument_list|)
condition|)
block|{
name|ar9300_adjust_rate_txpower_cdd
argument_list|(
name|ah
argument_list|,
name|rt
argument_list|,
name|is40
argument_list|,
name|AR9300_11NG_RT_HT_SS_OFFSET
argument_list|,
name|AR9300_11NG_RT_HT_DS_OFFSET
argument_list|,
name|AR9300_11NG_RT_HT_TS_OFFSET
argument_list|,
name|chainmask
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_POWER_MGMT
argument_list|,
literal|"%s: invalid mode 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|mode
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|ar9300_init_rate_txpower_cck
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|HAL_RATE_TABLE
modifier|*
name|rt
parameter_list|,
name|u_int8_t
name|rates_array
index|[]
parameter_list|,
name|u_int8_t
name|chainmask
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
comment|/*      * Pick the lower of the long-preamble txpower, and short-preamble tx power.      * Unfortunately, the rate table doesn't have separate entries for these!.      */
switch|switch
condition|(
name|chainmask
condition|)
block|{
case|case
name|OSPREY_1_CHAINMASK
case|:
name|ahp
operator|->
name|txpower
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|=
name|rates_array
index|[
name|ALL_TARGET_LEGACY_1L_5L
index|]
expr_stmt|;
name|ahp
operator|->
name|txpower
index|[
literal|1
index|]
index|[
literal|0
index|]
operator|=
name|rates_array
index|[
name|ALL_TARGET_LEGACY_1L_5L
index|]
expr_stmt|;
name|ahp
operator|->
name|txpower
index|[
literal|2
index|]
index|[
literal|0
index|]
operator|=
name|AH_MIN
argument_list|(
name|rates_array
index|[
name|ALL_TARGET_LEGACY_1L_5L
index|]
argument_list|,
name|rates_array
index|[
name|ALL_TARGET_LEGACY_5S
index|]
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|txpower
index|[
literal|3
index|]
index|[
literal|0
index|]
operator|=
name|AH_MIN
argument_list|(
name|rates_array
index|[
name|ALL_TARGET_LEGACY_11L
index|]
argument_list|,
name|rates_array
index|[
name|ALL_TARGET_LEGACY_11S
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSPREY_2LOHI_CHAINMASK
case|:
case|case
name|OSPREY_2LOMID_CHAINMASK
case|:
name|ahp
operator|->
name|txpower
index|[
literal|0
index|]
index|[
literal|1
index|]
operator|=
name|rates_array
index|[
name|ALL_TARGET_LEGACY_1L_5L
index|]
expr_stmt|;
name|ahp
operator|->
name|txpower
index|[
literal|1
index|]
index|[
literal|1
index|]
operator|=
name|rates_array
index|[
name|ALL_TARGET_LEGACY_1L_5L
index|]
expr_stmt|;
name|ahp
operator|->
name|txpower
index|[
literal|2
index|]
index|[
literal|1
index|]
operator|=
name|AH_MIN
argument_list|(
name|rates_array
index|[
name|ALL_TARGET_LEGACY_1L_5L
index|]
argument_list|,
name|rates_array
index|[
name|ALL_TARGET_LEGACY_5S
index|]
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|txpower
index|[
literal|3
index|]
index|[
literal|1
index|]
operator|=
name|AH_MIN
argument_list|(
name|rates_array
index|[
name|ALL_TARGET_LEGACY_11L
index|]
argument_list|,
name|rates_array
index|[
name|ALL_TARGET_LEGACY_11S
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|OSPREY_3_CHAINMASK
case|:
name|ahp
operator|->
name|txpower
index|[
literal|0
index|]
index|[
literal|2
index|]
operator|=
name|rates_array
index|[
name|ALL_TARGET_LEGACY_1L_5L
index|]
expr_stmt|;
name|ahp
operator|->
name|txpower
index|[
literal|1
index|]
index|[
literal|2
index|]
operator|=
name|rates_array
index|[
name|ALL_TARGET_LEGACY_1L_5L
index|]
expr_stmt|;
name|ahp
operator|->
name|txpower
index|[
literal|2
index|]
index|[
literal|2
index|]
operator|=
name|AH_MIN
argument_list|(
name|rates_array
index|[
name|ALL_TARGET_LEGACY_1L_5L
index|]
argument_list|,
name|rates_array
index|[
name|ALL_TARGET_LEGACY_5S
index|]
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|txpower
index|[
literal|3
index|]
index|[
literal|2
index|]
operator|=
name|AH_MIN
argument_list|(
name|rates_array
index|[
name|ALL_TARGET_LEGACY_11L
index|]
argument_list|,
name|rates_array
index|[
name|ALL_TARGET_LEGACY_11S
index|]
argument_list|)
expr_stmt|;
break|break;
default|default:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_POWER_MGMT
argument_list|,
literal|"%s: invalid chainmask 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|chainmask
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|ar9300_init_rate_txpower_ofdm
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|HAL_RATE_TABLE
modifier|*
name|rt
parameter_list|,
name|u_int8_t
name|rates_array
index|[]
parameter_list|,
name|int
name|rt_offset
parameter_list|,
name|u_int8_t
name|chainmask
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|int16_t
name|twice_array_gain
decl_stmt|,
name|cdd_power
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|u_int8_t
name|ofdm_rt_2_pwr_idx
index|[
literal|8
index|]
init|=
block|{
name|ALL_TARGET_LEGACY_6_24
block|,
name|ALL_TARGET_LEGACY_6_24
block|,
name|ALL_TARGET_LEGACY_6_24
block|,
name|ALL_TARGET_LEGACY_6_24
block|,
name|ALL_TARGET_LEGACY_6_24
block|,
name|ALL_TARGET_LEGACY_36
block|,
name|ALL_TARGET_LEGACY_48
block|,
name|ALL_TARGET_LEGACY_54
block|,     }
decl_stmt|;
comment|/*      *  For FCC adjust the upper limit for CDD factoring in the array gain.      *  The array gain is the same as TxBF, hence reuse the same defines.       */
for|for
control|(
name|i
operator|=
name|rt_offset
init|;
name|i
operator|<
name|rt_offset
operator|+
name|AR9300_NUM_OFDM_RATES
condition|;
name|i
operator|++
control|)
block|{
comment|/* Get the correct OFDM rate to Power table Index */
name|j
operator|=
name|ofdm_rt_2_pwr_idx
index|[
name|i
operator|-
name|rt_offset
index|]
expr_stmt|;
switch|switch
condition|(
name|chainmask
condition|)
block|{
case|case
name|OSPREY_1_CHAINMASK
case|:
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|0
index|]
operator|=
name|rates_array
index|[
name|j
index|]
expr_stmt|;
break|break;
case|case
name|OSPREY_2LOHI_CHAINMASK
case|:
case|case
name|OSPREY_2LOMID_CHAINMASK
case|:
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|1
index|]
operator|=
name|rates_array
index|[
name|j
index|]
expr_stmt|;
if|if
condition|(
name|is_reg_dmn_fcc
argument_list|(
name|ahp
operator|->
name|reg_dmn
argument_list|)
condition|)
block|{
name|twice_array_gain
operator|=
operator|(
name|ahp
operator|->
name|twice_antenna_gain
operator|>=
name|ahp
operator|->
name|twice_antenna_reduction
operator|)
condition|?
operator|-
operator|(
name|AR9300_TXBF_2TX_ARRAY_GAIN
operator|)
else|:
operator|(
operator|(
name|int16_t
operator|)
name|AH_MIN
argument_list|(
operator|(
name|ahp
operator|->
name|twice_antenna_reduction
operator|-
operator|(
name|ahp
operator|->
name|twice_antenna_gain
operator|+
name|AR9300_TXBF_2TX_ARRAY_GAIN
operator|)
operator|)
argument_list|,
literal|0
argument_list|)
operator|)
expr_stmt|;
name|cdd_power
operator|=
name|ahp
operator|->
name|upper_limit
index|[
literal|1
index|]
operator|+
name|twice_array_gain
expr_stmt|;
if|if
condition|(
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|1
index|]
operator|>
name|cdd_power
condition|)
block|{
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|1
index|]
operator|=
name|cdd_power
expr_stmt|;
block|}
block|}
break|break;
case|case
name|OSPREY_3_CHAINMASK
case|:
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|2
index|]
operator|=
name|rates_array
index|[
name|j
index|]
expr_stmt|;
if|if
condition|(
name|is_reg_dmn_fcc
argument_list|(
name|ahp
operator|->
name|reg_dmn
argument_list|)
condition|)
block|{
name|twice_array_gain
operator|=
operator|(
name|ahp
operator|->
name|twice_antenna_gain
operator|>=
name|ahp
operator|->
name|twice_antenna_reduction
operator|)
condition|?
operator|-
operator|(
name|AR9300_TXBF_3TX_ARRAY_GAIN
operator|)
else|:
operator|(
operator|(
name|int16_t
operator|)
name|AH_MIN
argument_list|(
operator|(
name|ahp
operator|->
name|twice_antenna_reduction
operator|-
operator|(
name|ahp
operator|->
name|twice_antenna_gain
operator|+
name|AR9300_TXBF_3TX_ARRAY_GAIN
operator|)
operator|)
argument_list|,
literal|0
argument_list|)
operator|)
expr_stmt|;
name|cdd_power
operator|=
name|ahp
operator|->
name|upper_limit
index|[
literal|2
index|]
operator|+
name|twice_array_gain
expr_stmt|;
if|if
condition|(
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|2
index|]
operator|>
name|cdd_power
condition|)
block|{
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|2
index|]
operator|=
name|cdd_power
expr_stmt|;
block|}
block|}
break|break;
default|default:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_POWER_MGMT
argument_list|,
literal|"%s: invalid chainmask 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|chainmask
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_decl_stmt
specifier|static
name|u_int8_t
name|mcs_rate_2_pwr_idx_ht20
index|[
literal|24
index|]
init|=
block|{
name|ALL_TARGET_HT20_0_8_16
block|,
name|ALL_TARGET_HT20_1_3_9_11_17_19
block|,
name|ALL_TARGET_HT20_1_3_9_11_17_19
block|,
name|ALL_TARGET_HT20_1_3_9_11_17_19
block|,
name|ALL_TARGET_HT20_4
block|,
name|ALL_TARGET_HT20_5
block|,
name|ALL_TARGET_HT20_6
block|,
name|ALL_TARGET_HT20_7
block|,
name|ALL_TARGET_HT20_0_8_16
block|,
name|ALL_TARGET_HT20_1_3_9_11_17_19
block|,
name|ALL_TARGET_HT20_1_3_9_11_17_19
block|,
name|ALL_TARGET_HT20_1_3_9_11_17_19
block|,
name|ALL_TARGET_HT20_12
block|,
name|ALL_TARGET_HT20_13
block|,
name|ALL_TARGET_HT20_14
block|,
name|ALL_TARGET_HT20_15
block|,
name|ALL_TARGET_HT20_0_8_16
block|,
name|ALL_TARGET_HT20_1_3_9_11_17_19
block|,
name|ALL_TARGET_HT20_1_3_9_11_17_19
block|,
name|ALL_TARGET_HT20_1_3_9_11_17_19
block|,
name|ALL_TARGET_HT20_20
block|,
name|ALL_TARGET_HT20_21
block|,
name|ALL_TARGET_HT20_22
block|,
name|ALL_TARGET_HT20_23
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_int8_t
name|mcs_rate_2_pwr_idx_ht40
index|[
literal|24
index|]
init|=
block|{
name|ALL_TARGET_HT40_0_8_16
block|,
name|ALL_TARGET_HT40_1_3_9_11_17_19
block|,
name|ALL_TARGET_HT40_1_3_9_11_17_19
block|,
name|ALL_TARGET_HT40_1_3_9_11_17_19
block|,
name|ALL_TARGET_HT40_4
block|,
name|ALL_TARGET_HT40_5
block|,
name|ALL_TARGET_HT40_6
block|,
name|ALL_TARGET_HT40_7
block|,
name|ALL_TARGET_HT40_0_8_16
block|,
name|ALL_TARGET_HT40_1_3_9_11_17_19
block|,
name|ALL_TARGET_HT40_1_3_9_11_17_19
block|,
name|ALL_TARGET_HT40_1_3_9_11_17_19
block|,
name|ALL_TARGET_HT40_12
block|,
name|ALL_TARGET_HT40_13
block|,
name|ALL_TARGET_HT40_14
block|,
name|ALL_TARGET_HT40_15
block|,
name|ALL_TARGET_HT40_0_8_16
block|,
name|ALL_TARGET_HT40_1_3_9_11_17_19
block|,
name|ALL_TARGET_HT40_1_3_9_11_17_19
block|,
name|ALL_TARGET_HT40_1_3_9_11_17_19
block|,
name|ALL_TARGET_HT40_20
block|,
name|ALL_TARGET_HT40_21
block|,
name|ALL_TARGET_HT40_22
block|,
name|ALL_TARGET_HT40_23
block|,     }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
specifier|inline
name|void
name|ar9300_init_rate_txpower_ht
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|HAL_RATE_TABLE
modifier|*
name|rt
parameter_list|,
name|HAL_BOOL
name|is40
parameter_list|,
name|u_int8_t
name|rates_array
index|[]
parameter_list|,
name|int
name|rt_ss_offset
parameter_list|,
name|int
name|rt_ds_offset
parameter_list|,
name|int
name|rt_ts_offset
parameter_list|,
name|u_int8_t
name|chainmask
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|u_int8_t
name|mcs_index
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
name|rt_ss_offset
init|;
name|i
operator|<
name|rt_ss_offset
operator|+
name|AR9300_NUM_HT_SS_RATES
condition|;
name|i
operator|++
control|)
block|{
comment|/* Get the correct MCS rate to Power table Index */
name|j
operator|=
operator|(
name|is40
operator|)
condition|?
name|mcs_rate_2_pwr_idx_ht40
index|[
name|mcs_index
index|]
else|:
name|mcs_rate_2_pwr_idx_ht20
index|[
name|mcs_index
index|]
expr_stmt|;
switch|switch
condition|(
name|chainmask
condition|)
block|{
case|case
name|OSPREY_1_CHAINMASK
case|:
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|0
index|]
operator|=
name|rates_array
index|[
name|j
index|]
expr_stmt|;
break|break;
case|case
name|OSPREY_2LOHI_CHAINMASK
case|:
case|case
name|OSPREY_2LOMID_CHAINMASK
case|:
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|1
index|]
operator|=
name|rates_array
index|[
name|j
index|]
expr_stmt|;
break|break;
case|case
name|OSPREY_3_CHAINMASK
case|:
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|2
index|]
operator|=
name|rates_array
index|[
name|j
index|]
expr_stmt|;
break|break;
default|default:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_POWER_MGMT
argument_list|,
literal|"%s: invalid chainmask 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|chainmask
argument_list|)
expr_stmt|;
break|break;
block|}
name|mcs_index
operator|++
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
name|rt_ds_offset
init|;
name|i
operator|<
name|rt_ds_offset
operator|+
name|AR9300_NUM_HT_DS_RATES
condition|;
name|i
operator|++
control|)
block|{
comment|/* Get the correct MCS rate to Power table Index */
name|j
operator|=
operator|(
name|is40
operator|)
condition|?
name|mcs_rate_2_pwr_idx_ht40
index|[
name|mcs_index
index|]
else|:
name|mcs_rate_2_pwr_idx_ht20
index|[
name|mcs_index
index|]
expr_stmt|;
switch|switch
condition|(
name|chainmask
condition|)
block|{
case|case
name|OSPREY_1_CHAINMASK
case|:
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|0
index|]
operator|=
name|rates_array
index|[
name|j
index|]
expr_stmt|;
break|break;
case|case
name|OSPREY_2LOHI_CHAINMASK
case|:
case|case
name|OSPREY_2LOMID_CHAINMASK
case|:
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|1
index|]
operator|=
name|rates_array
index|[
name|j
index|]
expr_stmt|;
break|break;
case|case
name|OSPREY_3_CHAINMASK
case|:
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|2
index|]
operator|=
name|rates_array
index|[
name|j
index|]
expr_stmt|;
break|break;
default|default:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_POWER_MGMT
argument_list|,
literal|"%s: invalid chainmask 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|chainmask
argument_list|)
expr_stmt|;
break|break;
block|}
name|mcs_index
operator|++
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
name|rt_ts_offset
init|;
name|i
operator|<
name|rt_ts_offset
operator|+
name|AR9300_NUM_HT_TS_RATES
condition|;
name|i
operator|++
control|)
block|{
comment|/* Get the correct MCS rate to Power table Index */
name|j
operator|=
operator|(
name|is40
operator|)
condition|?
name|mcs_rate_2_pwr_idx_ht40
index|[
name|mcs_index
index|]
else|:
name|mcs_rate_2_pwr_idx_ht20
index|[
name|mcs_index
index|]
expr_stmt|;
switch|switch
condition|(
name|chainmask
condition|)
block|{
case|case
name|OSPREY_1_CHAINMASK
case|:
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|0
index|]
operator|=
name|rates_array
index|[
name|j
index|]
expr_stmt|;
break|break;
case|case
name|OSPREY_2LOHI_CHAINMASK
case|:
case|case
name|OSPREY_2LOMID_CHAINMASK
case|:
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|1
index|]
operator|=
name|rates_array
index|[
name|j
index|]
expr_stmt|;
break|break;
case|case
name|OSPREY_3_CHAINMASK
case|:
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|2
index|]
operator|=
name|rates_array
index|[
name|j
index|]
expr_stmt|;
break|break;
default|default:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_POWER_MGMT
argument_list|,
literal|"%s: invalid chainmask 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|chainmask
argument_list|)
expr_stmt|;
break|break;
block|}
name|mcs_index
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|ar9300_init_rate_txpower_stbc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|HAL_RATE_TABLE
modifier|*
name|rt
parameter_list|,
name|HAL_BOOL
name|is40
parameter_list|,
name|int
name|rt_ss_offset
parameter_list|,
name|int
name|rt_ds_offset
parameter_list|,
name|int
name|rt_ts_offset
parameter_list|,
name|u_int8_t
name|chainmask
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int16_t
name|twice_array_gain
decl_stmt|,
name|stbc_power
init|=
literal|0
decl_stmt|;
name|u_int8_t
name|mcs_index
init|=
literal|0
decl_stmt|;
comment|/* Upper Limit with STBC */
switch|switch
condition|(
name|chainmask
condition|)
block|{
case|case
name|OSPREY_1_CHAINMASK
case|:
name|stbc_power
operator|=
name|ahp
operator|->
name|upper_limit
index|[
literal|0
index|]
expr_stmt|;
break|break;
case|case
name|OSPREY_2LOHI_CHAINMASK
case|:
case|case
name|OSPREY_2LOMID_CHAINMASK
case|:
name|stbc_power
operator|=
name|ahp
operator|->
name|upper_limit
index|[
literal|1
index|]
expr_stmt|;
break|break;
case|case
name|OSPREY_3_CHAINMASK
case|:
name|stbc_power
operator|=
name|ahp
operator|->
name|upper_limit
index|[
literal|2
index|]
expr_stmt|;
comment|/* Ony FCC requires that we back off with 3 transmit chains */
if|if
condition|(
name|is_reg_dmn_fcc
argument_list|(
name|ahp
operator|->
name|reg_dmn
argument_list|)
condition|)
block|{
name|twice_array_gain
operator|=
operator|(
name|ahp
operator|->
name|twice_antenna_gain
operator|>=
name|ahp
operator|->
name|twice_antenna_reduction
operator|)
condition|?
operator|-
operator|(
name|AR9300_STBC_3TX_ARRAY_GAIN
operator|)
else|:
operator|(
operator|(
name|int16_t
operator|)
name|AH_MIN
argument_list|(
operator|(
name|ahp
operator|->
name|twice_antenna_reduction
operator|-
operator|(
name|ahp
operator|->
name|twice_antenna_gain
operator|+
name|AR9300_STBC_3TX_ARRAY_GAIN
operator|)
operator|)
argument_list|,
literal|0
argument_list|)
operator|)
expr_stmt|;
name|stbc_power
operator|=
name|ahp
operator|->
name|upper_limit
index|[
literal|2
index|]
operator|+
name|twice_array_gain
expr_stmt|;
block|}
break|break;
default|default:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_POWER_MGMT
argument_list|,
literal|"%s: invalid chainmask 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|chainmask
argument_list|)
expr_stmt|;
break|break;
block|}
for|for
control|(
name|i
operator|=
name|rt_ss_offset
init|;
name|i
operator|<
name|rt_ss_offset
operator|+
name|AR9300_NUM_HT_SS_RATES
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|chainmask
condition|)
block|{
case|case
name|OSPREY_1_CHAINMASK
case|:
name|ahp
operator|->
name|txpower_stbc
index|[
name|i
index|]
index|[
literal|0
index|]
operator|=
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|0
index|]
expr_stmt|;
break|break;
case|case
name|OSPREY_2LOHI_CHAINMASK
case|:
case|case
name|OSPREY_2LOMID_CHAINMASK
case|:
name|ahp
operator|->
name|txpower_stbc
index|[
name|i
index|]
index|[
literal|1
index|]
operator|=
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|1
index|]
expr_stmt|;
break|break;
case|case
name|OSPREY_3_CHAINMASK
case|:
name|ahp
operator|->
name|txpower_stbc
index|[
name|i
index|]
index|[
literal|2
index|]
operator|=
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|2
index|]
expr_stmt|;
comment|/* 3 TX/1 stream  STBC gain adjustment */
if|if
condition|(
name|ahp
operator|->
name|txpower_stbc
index|[
name|i
index|]
index|[
literal|2
index|]
operator|>
name|stbc_power
condition|)
block|{
name|ahp
operator|->
name|txpower_stbc
index|[
name|i
index|]
index|[
literal|2
index|]
operator|=
name|stbc_power
expr_stmt|;
block|}
break|break;
default|default:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_POWER_MGMT
argument_list|,
literal|"%s: invalid chainmask 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|chainmask
argument_list|)
expr_stmt|;
break|break;
block|}
name|mcs_index
operator|++
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
name|rt_ds_offset
init|;
name|i
operator|<
name|rt_ds_offset
operator|+
name|AR9300_NUM_HT_DS_RATES
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|chainmask
condition|)
block|{
case|case
name|OSPREY_1_CHAINMASK
case|:
name|ahp
operator|->
name|txpower_stbc
index|[
name|i
index|]
index|[
literal|0
index|]
operator|=
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|0
index|]
expr_stmt|;
break|break;
case|case
name|OSPREY_2LOHI_CHAINMASK
case|:
case|case
name|OSPREY_2LOMID_CHAINMASK
case|:
name|ahp
operator|->
name|txpower_stbc
index|[
name|i
index|]
index|[
literal|1
index|]
operator|=
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|1
index|]
expr_stmt|;
break|break;
case|case
name|OSPREY_3_CHAINMASK
case|:
name|ahp
operator|->
name|txpower_stbc
index|[
name|i
index|]
index|[
literal|2
index|]
operator|=
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|2
index|]
expr_stmt|;
comment|/* 3 TX/2 stream  STBC gain adjustment */
if|if
condition|(
name|ahp
operator|->
name|txpower_stbc
index|[
name|i
index|]
index|[
literal|2
index|]
operator|>
name|stbc_power
condition|)
block|{
name|ahp
operator|->
name|txpower_stbc
index|[
name|i
index|]
index|[
literal|2
index|]
operator|=
name|stbc_power
expr_stmt|;
block|}
break|break;
default|default:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_POWER_MGMT
argument_list|,
literal|"%s: invalid chainmask 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|chainmask
argument_list|)
expr_stmt|;
break|break;
block|}
name|mcs_index
operator|++
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
name|rt_ts_offset
init|;
name|i
operator|<
name|rt_ts_offset
operator|+
name|AR9300_NUM_HT_TS_RATES
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|chainmask
condition|)
block|{
case|case
name|OSPREY_1_CHAINMASK
case|:
name|ahp
operator|->
name|txpower_stbc
index|[
name|i
index|]
index|[
literal|0
index|]
operator|=
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|0
index|]
expr_stmt|;
break|break;
case|case
name|OSPREY_2LOHI_CHAINMASK
case|:
case|case
name|OSPREY_2LOMID_CHAINMASK
case|:
name|ahp
operator|->
name|txpower_stbc
index|[
name|i
index|]
index|[
literal|1
index|]
operator|=
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|1
index|]
expr_stmt|;
break|break;
case|case
name|OSPREY_3_CHAINMASK
case|:
name|ahp
operator|->
name|txpower_stbc
index|[
name|i
index|]
index|[
literal|2
index|]
operator|=
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|2
index|]
expr_stmt|;
break|break;
default|default:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_POWER_MGMT
argument_list|,
literal|"%s: invalid chainmask 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|chainmask
argument_list|)
expr_stmt|;
break|break;
block|}
name|mcs_index
operator|++
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|ar9300_adjust_rate_txpower_cdd
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|HAL_RATE_TABLE
modifier|*
name|rt
parameter_list|,
name|HAL_BOOL
name|is40
parameter_list|,
name|int
name|rt_ss_offset
parameter_list|,
name|int
name|rt_ds_offset
parameter_list|,
name|int
name|rt_ts_offset
parameter_list|,
name|u_int8_t
name|chainmask
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int16_t
name|twice_array_gain
decl_stmt|,
name|cdd_power
init|=
literal|0
decl_stmt|;
name|u_int8_t
name|mcs_index
init|=
literal|0
decl_stmt|;
comment|/*      *  Adjust the upper limit for CDD factoring in the array gain .      *  The array gain is the same as TxBF, hence reuse the same defines.       */
switch|switch
condition|(
name|chainmask
condition|)
block|{
case|case
name|OSPREY_1_CHAINMASK
case|:
name|cdd_power
operator|=
name|ahp
operator|->
name|upper_limit
index|[
literal|0
index|]
expr_stmt|;
break|break;
case|case
name|OSPREY_2LOHI_CHAINMASK
case|:
case|case
name|OSPREY_2LOMID_CHAINMASK
case|:
name|twice_array_gain
operator|=
operator|(
name|ahp
operator|->
name|twice_antenna_gain
operator|>=
name|ahp
operator|->
name|twice_antenna_reduction
operator|)
condition|?
operator|-
operator|(
name|AR9300_TXBF_2TX_ARRAY_GAIN
operator|)
else|:
operator|(
operator|(
name|int16_t
operator|)
name|AH_MIN
argument_list|(
operator|(
name|ahp
operator|->
name|twice_antenna_reduction
operator|-
operator|(
name|ahp
operator|->
name|twice_antenna_gain
operator|+
name|AR9300_TXBF_2TX_ARRAY_GAIN
operator|)
operator|)
argument_list|,
literal|0
argument_list|)
operator|)
expr_stmt|;
name|cdd_power
operator|=
name|ahp
operator|->
name|upper_limit
index|[
literal|1
index|]
operator|+
name|twice_array_gain
expr_stmt|;
break|break;
case|case
name|OSPREY_3_CHAINMASK
case|:
name|twice_array_gain
operator|=
operator|(
name|ahp
operator|->
name|twice_antenna_gain
operator|>=
name|ahp
operator|->
name|twice_antenna_reduction
operator|)
condition|?
operator|-
operator|(
name|AR9300_TXBF_3TX_ARRAY_GAIN
operator|)
else|:
operator|(
operator|(
name|int16_t
operator|)
name|AH_MIN
argument_list|(
operator|(
name|ahp
operator|->
name|twice_antenna_reduction
operator|-
operator|(
name|ahp
operator|->
name|twice_antenna_gain
operator|+
name|AR9300_TXBF_3TX_ARRAY_GAIN
operator|)
operator|)
argument_list|,
literal|0
argument_list|)
operator|)
expr_stmt|;
name|cdd_power
operator|=
name|ahp
operator|->
name|upper_limit
index|[
literal|2
index|]
operator|+
name|twice_array_gain
expr_stmt|;
break|break;
default|default:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_POWER_MGMT
argument_list|,
literal|"%s: invalid chainmask 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|chainmask
argument_list|)
expr_stmt|;
break|break;
block|}
for|for
control|(
name|i
operator|=
name|rt_ss_offset
init|;
name|i
operator|<
name|rt_ss_offset
operator|+
name|AR9300_NUM_HT_SS_RATES
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|chainmask
condition|)
block|{
case|case
name|OSPREY_1_CHAINMASK
case|:
break|break;
case|case
name|OSPREY_2LOHI_CHAINMASK
case|:
case|case
name|OSPREY_2LOMID_CHAINMASK
case|:
comment|/* 2 TX/1 stream  CDD gain adjustment */
if|if
condition|(
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|1
index|]
operator|>
name|cdd_power
condition|)
block|{
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|1
index|]
operator|=
name|cdd_power
expr_stmt|;
block|}
break|break;
case|case
name|OSPREY_3_CHAINMASK
case|:
comment|/* 3 TX/1 stream  CDD gain adjustment */
if|if
condition|(
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|2
index|]
operator|>
name|cdd_power
condition|)
block|{
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|2
index|]
operator|=
name|cdd_power
expr_stmt|;
block|}
break|break;
default|default:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_POWER_MGMT
argument_list|,
literal|"%s: invalid chainmask 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|chainmask
argument_list|)
expr_stmt|;
break|break;
block|}
name|mcs_index
operator|++
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
name|rt_ds_offset
init|;
name|i
operator|<
name|rt_ds_offset
operator|+
name|AR9300_NUM_HT_DS_RATES
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|chainmask
condition|)
block|{
case|case
name|OSPREY_1_CHAINMASK
case|:
case|case
name|OSPREY_2LOHI_CHAINMASK
case|:
case|case
name|OSPREY_2LOMID_CHAINMASK
case|:
break|break;
case|case
name|OSPREY_3_CHAINMASK
case|:
comment|/* 3 TX/2 stream  TxBF gain adjustment */
if|if
condition|(
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|2
index|]
operator|>
name|cdd_power
condition|)
block|{
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
literal|2
index|]
operator|=
name|cdd_power
expr_stmt|;
block|}
break|break;
default|default:
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_POWER_MGMT
argument_list|,
literal|"%s: invalid chainmask 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|chainmask
argument_list|)
expr_stmt|;
break|break;
block|}
name|mcs_index
operator|++
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|void
name|ar9300_disp_tpc_tables
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
specifier|const
name|struct
name|ieee80211_channel
modifier|*
name|chan
init|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_curchan
decl_stmt|;
name|u_int
name|mode
init|=
name|ath_hal_get_curmode
argument_list|(
name|ah
argument_list|,
name|chan
argument_list|)
decl_stmt|;
specifier|const
name|HAL_RATE_TABLE
modifier|*
name|rt
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
comment|/* Check whether TPC is enabled */
if|if
condition|(
operator|!
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_desc_tpc
condition|)
block|{
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"\n TPC Register method in use\n"
argument_list|)
expr_stmt|;
return|return;
block|}
name|rt
operator|=
name|ar9300_get_rate_table
argument_list|(
name|ah
argument_list|,
name|mode
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
name|rt
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"\n===TARGET POWER TABLE===\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ar9300_get_ntxchains
argument_list|(
name|ahp
operator|->
name|ah_tx_chainmask
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rt
operator|->
name|rateCount
condition|;
name|i
operator|++
control|)
block|{
name|int16_t
name|txpower
index|[
name|AR9300_MAX_CHAINS
index|]
decl_stmt|;
name|txpower
index|[
name|j
index|]
operator|=
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
name|j
index|]
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|" Index[%2d] Rate[0x%02x] %6d kbps "
literal|"Power (%d Chain) [%2d.%1d dBm]\n"
argument_list|,
name|i
argument_list|,
name|rt
operator|->
name|info
index|[
name|i
index|]
operator|.
name|rateCode
argument_list|,
name|rt
operator|->
name|info
index|[
name|i
index|]
operator|.
name|rateKbps
argument_list|,
name|j
operator|+
literal|1
argument_list|,
name|txpower
index|[
name|j
index|]
operator|/
literal|2
argument_list|,
name|txpower
index|[
name|j
index|]
operator|%
literal|2
operator|*
literal|5
argument_list|)
expr_stmt|;
block|}
block|}
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"\n\n===TARGET POWER TABLE with STBC===\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ar9300_get_ntxchains
argument_list|(
name|ahp
operator|->
name|ah_tx_chainmask
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rt
operator|->
name|rateCount
condition|;
name|i
operator|++
control|)
block|{
name|int16_t
name|txpower
index|[
name|AR9300_MAX_CHAINS
index|]
decl_stmt|;
name|txpower
index|[
name|j
index|]
operator|=
name|ahp
operator|->
name|txpower_stbc
index|[
name|i
index|]
index|[
name|j
index|]
expr_stmt|;
comment|/* Do not display invalid configurations */
if|if
condition|(
operator|(
name|rt
operator|->
name|info
index|[
name|i
index|]
operator|.
name|rateCode
operator|<
name|AR9300_MCS0_RATE_CODE
operator|)
operator|||
operator|(
name|rt
operator|->
name|info
index|[
name|i
index|]
operator|.
name|rateCode
operator|>
name|AR9300_MCS23_RATE_CODE
operator|)
operator|||
name|ar9300_invalid_stbc_cfg
argument_list|(
name|j
argument_list|,
name|rt
operator|->
name|info
index|[
name|i
index|]
operator|.
name|rateCode
argument_list|)
operator|==
name|AH_TRUE
condition|)
block|{
continue|continue;
block|}
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|" Index[%2d] Rate[0x%02x] %6d kbps "
literal|"Power (%d Chain) [%2d.%1d dBm]\n"
argument_list|,
name|i
argument_list|,
name|rt
operator|->
name|info
index|[
name|i
index|]
operator|.
name|rateCode
argument_list|,
name|rt
operator|->
name|info
index|[
name|i
index|]
operator|.
name|rateKbps
argument_list|,
name|j
operator|+
literal|1
argument_list|,
name|txpower
index|[
name|j
index|]
operator|/
literal|2
argument_list|,
name|txpower
index|[
name|j
index|]
operator|%
literal|2
operator|*
literal|5
argument_list|)
expr_stmt|;
block|}
block|}
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * The followings are customer specific APIs for querying power limit.  * Power limit is based on regulatory domain, chipset, and transmission rate.  * Here we only consider EEPROM values, no array gain/CTL considered here.  */
end_comment

begin_struct
struct|struct
name|rate_power_tbl
block|{
name|u_int8_t
name|rateIdx
decl_stmt|;
comment|/* rate index in the rate table */
name|u_int32_t
name|rateKbps
decl_stmt|;
comment|/* transfer rate in kbs */
name|u_int8_t
name|rateCode
decl_stmt|;
comment|/* rate for h/w descriptors */
name|u_int8_t
name|txbf
range|:
literal|1
decl_stmt|,
comment|/* txbf eligible */
name|stbc
range|:
literal|1
decl_stmt|,
comment|/* stbc eligible */
name|chain1
range|:
literal|1
decl_stmt|,
comment|/* one-chain eligible */
name|chain2
range|:
literal|1
decl_stmt|,
comment|/* two-chain eligible */
name|chain3
range|:
literal|1
decl_stmt|;
comment|/* three-chain eligible */
name|int16_t
name|txpower
index|[
name|AR9300_MAX_CHAINS
index|]
decl_stmt|;
comment|/* txpower for different chainmasks */
name|int16_t
name|txpower_stbc
index|[
name|AR9300_MAX_CHAINS
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|u_int8_t
modifier|*
name|ar9300_get_tpc_tables
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
specifier|const
name|struct
name|ieee80211_channel
modifier|*
name|chan
init|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_curchan
decl_stmt|;
name|u_int
name|mode
init|=
name|ath_hal_get_curmode
argument_list|(
name|ah
argument_list|,
name|chan
argument_list|)
decl_stmt|;
specifier|const
name|HAL_RATE_TABLE
modifier|*
name|rt
decl_stmt|;
name|u_int8_t
modifier|*
name|data
decl_stmt|;
name|struct
name|rate_power_tbl
modifier|*
name|table
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
comment|/* Check whether TPC is enabled */
if|if
condition|(
operator|!
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_desc_tpc
condition|)
block|{
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"\n TPC Register method in use\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|rt
operator|=
operator|(
specifier|const
name|HAL_RATE_TABLE
operator|*
operator|)
name|ar9300_get_rate_table
argument_list|(
name|ah
argument_list|,
name|mode
argument_list|)
expr_stmt|;
name|HALASSERT
argument_list|(
name|rt
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|data
operator|=
operator|(
name|u_int8_t
operator|*
operator|)
name|ath_hal_malloc
argument_list|(
literal|1
operator|+
name|rt
operator|->
name|rateCount
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|rate_power_tbl
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|OS_MEMZERO
argument_list|(
name|data
argument_list|,
literal|1
operator|+
name|rt
operator|->
name|rateCount
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|rate_power_tbl
argument_list|)
argument_list|)
expr_stmt|;
comment|/* store the rate count at the beginning */
operator|*
name|data
operator|=
name|rt
operator|->
name|rateCount
expr_stmt|;
name|table
operator|=
operator|(
expr|struct
name|rate_power_tbl
operator|*
operator|)
operator|&
name|data
index|[
literal|1
index|]
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ar9300_get_ntxchains
argument_list|(
name|ahp
operator|->
name|ah_tx_chainmask
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rt
operator|->
name|rateCount
condition|;
name|i
operator|++
control|)
block|{
name|table
index|[
name|i
index|]
operator|.
name|rateIdx
operator|=
name|i
expr_stmt|;
name|table
index|[
name|i
index|]
operator|.
name|rateCode
operator|=
name|rt
operator|->
name|info
index|[
name|i
index|]
operator|.
name|rateCode
expr_stmt|;
name|table
index|[
name|i
index|]
operator|.
name|rateKbps
operator|=
name|rt
operator|->
name|info
index|[
name|i
index|]
operator|.
name|rateKbps
expr_stmt|;
switch|switch
condition|(
name|j
condition|)
block|{
case|case
literal|0
case|:
name|table
index|[
name|i
index|]
operator|.
name|chain1
operator|=
name|rt
operator|->
name|info
index|[
name|i
index|]
operator|.
name|rateCode
operator|<=
literal|0x87
condition|?
literal|1
else|:
literal|0
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|table
index|[
name|i
index|]
operator|.
name|chain2
operator|=
name|rt
operator|->
name|info
index|[
name|i
index|]
operator|.
name|rateCode
operator|<=
literal|0x8f
condition|?
literal|1
else|:
literal|0
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|table
index|[
name|i
index|]
operator|.
name|chain3
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
operator|(
name|j
operator|==
literal|0
operator|&&
name|table
index|[
name|i
index|]
operator|.
name|chain1
operator|)
operator|||
operator|(
name|j
operator|==
literal|1
operator|&&
name|table
index|[
name|i
index|]
operator|.
name|chain2
operator|)
operator|||
operator|(
name|j
operator|==
literal|2
operator|&&
name|table
index|[
name|i
index|]
operator|.
name|chain3
operator|)
condition|)
name|table
index|[
name|i
index|]
operator|.
name|txpower
index|[
name|j
index|]
operator|=
name|ahp
operator|->
name|txpower
index|[
name|i
index|]
index|[
name|j
index|]
expr_stmt|;
block|}
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ar9300_get_ntxchains
argument_list|(
name|ahp
operator|->
name|ah_tx_chainmask
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rt
operator|->
name|rateCount
condition|;
name|i
operator|++
control|)
block|{
comment|/* Do not display invalid configurations */
if|if
condition|(
operator|(
name|rt
operator|->
name|info
index|[
name|i
index|]
operator|.
name|rateCode
operator|<
name|AR9300_MCS0_RATE_CODE
operator|)
operator|||
operator|(
name|rt
operator|->
name|info
index|[
name|i
index|]
operator|.
name|rateCode
operator|>
name|AR9300_MCS23_RATE_CODE
operator|)
operator|||
name|ar9300_invalid_stbc_cfg
argument_list|(
name|j
argument_list|,
name|rt
operator|->
name|info
index|[
name|i
index|]
operator|.
name|rateCode
argument_list|)
operator|==
name|AH_TRUE
condition|)
block|{
continue|continue;
block|}
name|table
index|[
name|i
index|]
operator|.
name|stbc
operator|=
literal|1
expr_stmt|;
name|table
index|[
name|i
index|]
operator|.
name|txpower_stbc
index|[
name|j
index|]
operator|=
name|ahp
operator|->
name|txpower_stbc
index|[
name|i
index|]
index|[
name|j
index|]
expr_stmt|;
block|}
block|}
return|return
name|data
return|;
comment|/* the caller is responsible to free data */
block|}
end_function

begin_function
name|HAL_STATUS
name|ath_hal_get_rate_power_limit_from_eeprom
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int16_t
name|freq
parameter_list|,
name|int8_t
modifier|*
name|max_rate_power
parameter_list|,
name|int8_t
modifier|*
name|min_rate_power
parameter_list|)
block|{
comment|/*      * Used for AR9300 series chip only      */
if|if
condition|(
name|ah
operator|->
name|ah_magic
operator|==
name|AR9300_MAGIC
condition|)
block|{
name|u_int8_t
name|target_rate_power_limit_val_t2
index|[
name|ar9300_rate_size
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
operator|*
name|max_rate_power
operator|=
literal|0
expr_stmt|;
operator|*
name|min_rate_power
operator|=
name|AR9300_MAX_RATE_POWER
expr_stmt|;
name|ar9300_set_target_power_from_eeprom
argument_list|(
name|ah
argument_list|,
name|freq
argument_list|,
name|target_rate_power_limit_val_t2
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ar9300_rate_size
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|target_rate_power_limit_val_t2
index|[
name|i
index|]
operator|>
operator|*
name|max_rate_power
condition|)
operator|*
name|max_rate_power
operator|=
name|target_rate_power_limit_val_t2
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|target_rate_power_limit_val_t2
index|[
name|i
index|]
operator|<
operator|*
name|min_rate_power
condition|)
operator|*
name|min_rate_power
operator|=
name|target_rate_power_limit_val_t2
index|[
name|i
index|]
expr_stmt|;
block|}
block|}
else|else
block|{
operator|*
name|max_rate_power
operator|=
literal|0
expr_stmt|;
operator|*
name|min_rate_power
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|HAL_OK
return|;
block|}
end_function

end_unit


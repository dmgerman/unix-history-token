begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2013 Qualcomm Atheros, Inc.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR  * OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|"opt_ah.h"
end_include

begin_include
include|#
directive|include
file|"ah.h"
end_include

begin_include
include|#
directive|include
file|"ah_internal.h"
end_include

begin_include
include|#
directive|include
file|"ah_devid.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|AH_DEBUG
end_ifdef

begin_include
include|#
directive|include
file|"ah_desc.h"
end_include

begin_comment
comment|/* NB: for HAL_PHYERR* */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"ar9300/ar9300.h"
end_include

begin_include
include|#
directive|include
file|"ar9300/ar9300reg.h"
end_include

begin_include
include|#
directive|include
file|"ar9300/ar9300phy.h"
end_include

begin_function
name|void
name|ar9300_get_hw_hangs
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|hal_hw_hangs_t
modifier|*
name|hangs
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
operator|*
name|hangs
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ar9300_get_capability
argument_list|(
name|ah
argument_list|,
name|HAL_CAP_BB_RIFS_HANG
argument_list|,
literal|0
argument_list|,
name|AH_NULL
argument_list|)
operator|==
name|HAL_OK
condition|)
block|{
operator|*
name|hangs
operator||=
name|HAL_RIFS_BB_HANG_WAR
expr_stmt|;
block|}
if|if
condition|(
name|ar9300_get_capability
argument_list|(
name|ah
argument_list|,
name|HAL_CAP_BB_DFS_HANG
argument_list|,
literal|0
argument_list|,
name|AH_NULL
argument_list|)
operator|==
name|HAL_OK
condition|)
block|{
operator|*
name|hangs
operator||=
name|HAL_DFS_BB_HANG_WAR
expr_stmt|;
block|}
if|if
condition|(
name|ar9300_get_capability
argument_list|(
name|ah
argument_list|,
name|HAL_CAP_BB_RX_CLEAR_STUCK_HANG
argument_list|,
literal|0
argument_list|,
name|AH_NULL
argument_list|)
operator|==
name|HAL_OK
condition|)
block|{
operator|*
name|hangs
operator||=
name|HAL_RX_STUCK_LOW_BB_HANG_WAR
expr_stmt|;
block|}
if|if
condition|(
name|ar9300_get_capability
argument_list|(
name|ah
argument_list|,
name|HAL_CAP_MAC_HANG
argument_list|,
literal|0
argument_list|,
name|AH_NULL
argument_list|)
operator|==
name|HAL_OK
condition|)
block|{
operator|*
name|hangs
operator||=
name|HAL_MAC_HANG_WAR
expr_stmt|;
block|}
if|if
condition|(
name|ar9300_get_capability
argument_list|(
name|ah
argument_list|,
name|HAL_CAP_PHYRESTART_CLR_WAR
argument_list|,
literal|0
argument_list|,
name|AH_NULL
argument_list|)
operator|==
name|HAL_OK
condition|)
block|{
operator|*
name|hangs
operator||=
name|HAL_PHYRESTART_CLR_WAR
expr_stmt|;
block|}
name|ahp
operator|->
name|ah_hang_wars
operator|=
operator|*
name|hangs
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * XXX FreeBSD: the HAL version of ath_hal_mac_usec() knows about  * HT20, HT40, fast-clock, turbo mode, etc.  */
end_comment

begin_function
specifier|static
name|u_int
name|ar9300_mac_to_usec
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int
name|clks
parameter_list|)
block|{
if|#
directive|if
literal|0
block|const struct ieee80211_channel *chan = AH_PRIVATE(ah)->ah_curchan;      if (chan&& IEEE80211_IS_CHAN_HT40(chan)) {         return (ath_hal_mac_usec(ah, clks) / 2);     } else {         return (ath_hal_mac_usec(ah, clks));     }
endif|#
directive|endif
return|return
operator|(
name|ath_hal_mac_usec
argument_list|(
name|ah
argument_list|,
name|clks
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|u_int
name|ar9300_mac_to_clks
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int
name|usecs
parameter_list|)
block|{
if|#
directive|if
literal|0
block|const struct ieee80211_channel *chan = AH_PRIVATE(ah)->ah_curchan;      if (chan&& IEEE80211_IS_CHAN_HT40(chan)) {         return (ath_hal_mac_clks(ah, usecs) * 2);     } else {         return (ath_hal_mac_clks(ah, usecs));     }
endif|#
directive|endif
return|return
operator|(
name|ath_hal_mac_clks
argument_list|(
name|ah
argument_list|,
name|usecs
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|void
name|ar9300_get_mac_address
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int8_t
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|OS_MEMCPY
argument_list|(
name|mac
argument_list|,
name|ahp
operator|->
name|ah_macaddr
argument_list|,
name|IEEE80211_ADDR_LEN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|HAL_BOOL
name|ar9300_set_mac_address
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|u_int8_t
modifier|*
name|mac
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|OS_MEMCPY
argument_list|(
name|ahp
operator|->
name|ah_macaddr
argument_list|,
name|mac
argument_list|,
name|IEEE80211_ADDR_LEN
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_function
name|void
name|ar9300_get_bss_id_mask
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int8_t
modifier|*
name|mask
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|OS_MEMCPY
argument_list|(
name|mask
argument_list|,
name|ahp
operator|->
name|ah_bssid_mask
argument_list|,
name|IEEE80211_ADDR_LEN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|HAL_BOOL
name|ar9300_set_bss_id_mask
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|u_int8_t
modifier|*
name|mask
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
comment|/* save it since it must be rewritten on reset */
name|OS_MEMCPY
argument_list|(
name|ahp
operator|->
name|ah_bssid_mask
argument_list|,
name|mask
argument_list|,
name|IEEE80211_ADDR_LEN
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BSSMSKL
argument_list|,
name|LE_READ_4
argument_list|(
name|ahp
operator|->
name|ah_bssid_mask
argument_list|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BSSMSKU
argument_list|,
name|LE_READ_2
argument_list|(
name|ahp
operator|->
name|ah_bssid_mask
operator|+
literal|4
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_comment
comment|/*  * Attempt to change the cards operating regulatory domain to the given value  * Returns: A_EINVAL for an unsupported regulatory domain.  *          A_HARDWARE for an unwritable EEPROM or bad EEPROM version  */
end_comment

begin_function
name|HAL_BOOL
name|ar9300_set_regulatory_domain
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int16_t
name|reg_domain
parameter_list|,
name|HAL_STATUS
modifier|*
name|status
parameter_list|)
block|{
name|HAL_STATUS
name|ecode
decl_stmt|;
if|if
condition|(
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_currentRD
operator|==
literal|0
condition|)
block|{
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_currentRD
operator|=
name|reg_domain
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
name|ecode
operator|=
name|HAL_EIO
expr_stmt|;
if|#
directive|if
literal|0
block|bad:
endif|#
directive|endif
if|if
condition|(
name|status
condition|)
block|{
operator|*
name|status
operator|=
name|ecode
expr_stmt|;
block|}
return|return
name|AH_FALSE
return|;
block|}
end_function

begin_comment
comment|/*  * Return the wireless modes (a,b,g,t) supported by hardware.  *  * This value is what is actually supported by the hardware  * and is unaffected by regulatory/country code settings.  *  */
end_comment

begin_function
name|u_int
name|ar9300_get_wireless_modes
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
return|return
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_caps
operator|.
name|halWirelessModes
return|;
block|}
end_function

begin_comment
comment|/*  * Set the interrupt and GPIO values so the ISR can disable RF  * on a switch signal.  Assumes GPIO port and interrupt polarity  * are set prior to call.  */
end_comment

begin_function
name|void
name|ar9300_enable_rf_kill
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
comment|/* TODO - can this really be above the hal on the GPIO interface for      * TODO - the client only?      */
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
if|if
condition|(
name|AR_SREV_JUPITER
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_APHRODITE
argument_list|(
name|ah
argument_list|)
condition|)
block|{
comment|/* Check RF kill GPIO before set/clear RFSILENT bits. */
if|if
condition|(
name|ar9300_gpio_get
argument_list|(
name|ah
argument_list|,
name|ahp
operator|->
name|ah_gpio_select
argument_list|)
operator|==
name|ahp
operator|->
name|ah_polarity
condition|)
block|{
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_HOSTIF_REG
argument_list|(
name|ah
argument_list|,
name|AR_RFSILENT
argument_list|)
argument_list|,
name|AR_RFSILENT_FORCE
argument_list|)
expr_stmt|;
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TEST
argument_list|,
name|RFSILENT_BB
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_HOSTIF_REG
argument_list|(
name|ah
argument_list|,
name|AR_RFSILENT
argument_list|)
argument_list|,
name|AR_RFSILENT_FORCE
argument_list|)
expr_stmt|;
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TEST
argument_list|,
name|RFSILENT_BB
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Connect rfsilent_bb_l to baseband */
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_HOSTIF_REG
argument_list|(
name|ah
argument_list|,
name|AR_GPIO_INPUT_EN_VAL
argument_list|)
argument_list|,
name|AR_GPIO_INPUT_EN_VAL_RFSILENT_BB
argument_list|)
expr_stmt|;
comment|/* Set input mux for rfsilent_bb_l to GPIO #0 */
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_HOSTIF_REG
argument_list|(
name|ah
argument_list|,
name|AR_GPIO_INPUT_MUX2
argument_list|)
argument_list|,
name|AR_GPIO_INPUT_MUX2_RFSILENT
argument_list|)
expr_stmt|;
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_HOSTIF_REG
argument_list|(
name|ah
argument_list|,
name|AR_GPIO_INPUT_MUX2
argument_list|)
argument_list|,
operator|(
name|ahp
operator|->
name|ah_gpio_select
operator|&
literal|0x0f
operator|)
operator|<<
literal|4
argument_list|)
expr_stmt|;
comment|/*          * Configure the desired GPIO port for input and          * enable baseband rf silence          */
name|ath_hal_gpioCfgInput
argument_list|(
name|ah
argument_list|,
name|ahp
operator|->
name|ah_gpio_select
argument_list|)
expr_stmt|;
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TEST
argument_list|,
name|RFSILENT_BB
argument_list|)
expr_stmt|;
block|}
comment|/*      * If radio disable switch connection to GPIO bit x is enabled      * program GPIO interrupt.      * If rfkill bit on eeprom is 1, setupeeprommap routine has already      * verified that it is a later version of eeprom, it has a place for      * rfkill bit and it is set to 1, indicating that GPIO bit x hardware      * connection is present.      */
comment|/*       * RFKill uses polling not interrupt,       * disable interrupt to avoid Eee PC 2.6.21.4 hang up issue       */
if|if
condition|(
name|ath_hal_hasrfkill_int
argument_list|(
name|ah
argument_list|)
condition|)
block|{
if|if
condition|(
name|ahp
operator|->
name|ah_gpio_bit
operator|==
name|ar9300_gpio_get
argument_list|(
name|ah
argument_list|,
name|ahp
operator|->
name|ah_gpio_select
argument_list|)
condition|)
block|{
comment|/* switch already closed, set to interrupt upon open */
name|ar9300_gpio_set_intr
argument_list|(
name|ah
argument_list|,
name|ahp
operator|->
name|ah_gpio_select
argument_list|,
operator|!
name|ahp
operator|->
name|ah_gpio_bit
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ar9300_gpio_set_intr
argument_list|(
name|ah
argument_list|,
name|ahp
operator|->
name|ah_gpio_select
argument_list|,
name|ahp
operator|->
name|ah_gpio_bit
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Change the LED blinking pattern to correspond to the connectivity  */
end_comment

begin_function
name|void
name|ar9300_set_led_state
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_LED_STATE
name|state
parameter_list|)
block|{
specifier|static
specifier|const
name|u_int32_t
name|ledbits
index|[
literal|8
index|]
init|=
block|{
name|AR_CFG_LED_ASSOC_NONE
block|,
comment|/* HAL_LED_RESET */
name|AR_CFG_LED_ASSOC_PENDING
block|,
comment|/* HAL_LED_INIT  */
name|AR_CFG_LED_ASSOC_PENDING
block|,
comment|/* HAL_LED_READY */
name|AR_CFG_LED_ASSOC_PENDING
block|,
comment|/* HAL_LED_SCAN  */
name|AR_CFG_LED_ASSOC_PENDING
block|,
comment|/* HAL_LED_AUTH  */
name|AR_CFG_LED_ASSOC_ACTIVE
block|,
comment|/* HAL_LED_ASSOC */
name|AR_CFG_LED_ASSOC_ACTIVE
block|,
comment|/* HAL_LED_RUN   */
name|AR_CFG_LED_ASSOC_NONE
block|,     }
decl_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_CFG_LED
argument_list|,
name|AR_CFG_LED_ASSOC_CTL
argument_list|,
name|ledbits
index|[
name|state
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Sets the Power LED on the cardbus without affecting the Network LED.  */
end_comment

begin_function
name|void
name|ar9300_set_power_led_state
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int8_t
name|enabled
parameter_list|)
block|{
name|u_int32_t
name|val
decl_stmt|;
name|val
operator|=
name|enabled
condition|?
name|AR_CFG_LED_MODE_POWER_ON
else|:
name|AR_CFG_LED_MODE_POWER_OFF
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_CFG_LED
argument_list|,
name|AR_CFG_LED_POWER
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Sets the Network LED on the cardbus without affecting the Power LED.  */
end_comment

begin_function
name|void
name|ar9300_set_network_led_state
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int8_t
name|enabled
parameter_list|)
block|{
name|u_int32_t
name|val
decl_stmt|;
name|val
operator|=
name|enabled
condition|?
name|AR_CFG_LED_MODE_NETWORK_ON
else|:
name|AR_CFG_LED_MODE_NETWORK_OFF
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_CFG_LED
argument_list|,
name|AR_CFG_LED_NETWORK
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Change association related fields programmed into the hardware.  * Writing a valid BSSID to the hardware effectively enables the hardware  * to synchronize its TSF to the correct beacons and receive frames coming  * from that BSSID. It is called by the SME JOIN operation.  */
end_comment

begin_function
name|void
name|ar9300_write_associd
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|u_int8_t
modifier|*
name|bssid
parameter_list|,
name|u_int16_t
name|assoc_id
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
comment|/* save bssid and assoc_id for restore on reset */
name|OS_MEMCPY
argument_list|(
name|ahp
operator|->
name|ah_bssid
argument_list|,
name|bssid
argument_list|,
name|IEEE80211_ADDR_LEN
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|ah_assoc_id
operator|=
name|assoc_id
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BSS_ID0
argument_list|,
name|LE_READ_4
argument_list|(
name|ahp
operator|->
name|ah_bssid
argument_list|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BSS_ID1
argument_list|,
name|LE_READ_2
argument_list|(
name|ahp
operator|->
name|ah_bssid
operator|+
literal|4
argument_list|)
operator||
operator|(
operator|(
name|assoc_id
operator|&
literal|0x3fff
operator|)
operator|<<
name|AR_BSS_ID1_AID_S
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Get the current hardware tsf for stamlme  */
end_comment

begin_function
name|u_int64_t
name|ar9300_get_tsf64
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|u_int64_t
name|tsf
decl_stmt|;
comment|/* XXX sync multi-word read? */
name|tsf
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_TSF_U32
argument_list|)
expr_stmt|;
name|tsf
operator|=
operator|(
name|tsf
operator|<<
literal|32
operator|)
operator||
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_TSF_L32
argument_list|)
expr_stmt|;
return|return
name|tsf
return|;
block|}
end_function

begin_function
name|void
name|ar9300_set_tsf64
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int64_t
name|tsf
parameter_list|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_TSF_L32
argument_list|,
operator|(
name|tsf
operator|&
literal|0xffffffff
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_TSF_U32
argument_list|,
operator|(
operator|(
name|tsf
operator|>>
literal|32
operator|)
operator|&
literal|0xffffffff
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Get the current hardware tsf for stamlme  */
end_comment

begin_function
name|u_int32_t
name|ar9300_get_tsf32
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
return|return
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_TSF_L32
argument_list|)
return|;
block|}
end_function

begin_function
name|u_int32_t
name|ar9300_get_tsf2_32
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
return|return
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_TSF2_L32
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Reset the current hardware tsf for stamlme.  */
end_comment

begin_function
name|void
name|ar9300_reset_tsf
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|int
name|count
decl_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_SLP32_MODE
argument_list|)
operator|&
name|AR_SLP32_TSF_WRITE_STATUS
condition|)
block|{
name|count
operator|++
expr_stmt|;
if|if
condition|(
name|count
operator|>
literal|10
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_RESET
argument_list|,
literal|"%s: AR_SLP32_TSF_WRITE_STATUS limit exceeded\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
break|break;
block|}
name|OS_DELAY
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_RESET_TSF
argument_list|,
name|AR_RESET_TSF_ONCE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Set or clear hardware basic rate bit  * Set hardware basic rate set if basic rate is found  * and basic rate is equal or less than 2Mbps  */
end_comment

begin_function
name|void
name|ar9300_set_basic_rate
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_RATE_SET
modifier|*
name|rs
parameter_list|)
block|{
specifier|const
name|struct
name|ieee80211_channel
modifier|*
name|chan
init|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_curchan
decl_stmt|;
name|u_int32_t
name|reg
decl_stmt|;
name|u_int8_t
name|xset
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|chan
operator|==
name|AH_NULL
operator|||
operator|!
name|IEEE80211_IS_CHAN_CCK
argument_list|(
name|chan
argument_list|)
condition|)
block|{
return|return;
block|}
name|xset
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rs
operator|->
name|rs_count
condition|;
name|i
operator|++
control|)
block|{
name|u_int8_t
name|rset
init|=
name|rs
operator|->
name|rs_rates
index|[
name|i
index|]
decl_stmt|;
comment|/* Basic rate defined? */
if|if
condition|(
operator|(
name|rset
operator|&
literal|0x80
operator|)
operator|&&
operator|(
name|rset
operator|&=
literal|0x7f
operator|)
operator|>=
name|xset
condition|)
block|{
name|xset
operator|=
name|rset
expr_stmt|;
block|}
block|}
comment|/*      * Set the h/w bit to reflect whether or not the basic      * rate is found to be equal or less than 2Mbps.      */
name|reg
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_STA_ID1
argument_list|)
expr_stmt|;
if|if
condition|(
name|xset
operator|&&
name|xset
operator|/
literal|2
operator|<=
literal|2
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_STA_ID1
argument_list|,
name|reg
operator||
name|AR_STA_ID1_BASE_RATE_11B
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_STA_ID1
argument_list|,
name|reg
operator|&
operator|~
name|AR_STA_ID1_BASE_RATE_11B
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Grab a semi-random value from hardware registers - may not  * change often  */
end_comment

begin_function
name|u_int32_t
name|ar9300_get_random_seed
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|u_int32_t
name|nf
decl_stmt|;
name|nf
operator|=
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY
argument_list|(
literal|25
argument_list|)
argument_list|)
operator|>>
literal|19
operator|)
operator|&
literal|0x1ff
expr_stmt|;
if|if
condition|(
name|nf
operator|&
literal|0x100
condition|)
block|{
name|nf
operator|=
literal|0
operator|-
operator|(
operator|(
name|nf
operator|^
literal|0x1ff
operator|)
operator|+
literal|1
operator|)
expr_stmt|;
block|}
return|return
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_TSF_U32
argument_list|)
operator|^
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_TSF_L32
argument_list|)
operator|^
name|nf
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Detect if our card is present  */
end_comment

begin_function
name|HAL_BOOL
name|ar9300_detect_card_present
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|u_int16_t
name|mac_version
decl_stmt|,
name|mac_rev
decl_stmt|;
name|u_int32_t
name|v
decl_stmt|;
comment|/*      * Read the Silicon Revision register and compare that      * to what we read at attach time.  If the same, we say      * a card/device is present.      */
name|v
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_HOSTIF_REG
argument_list|(
name|ah
argument_list|,
name|AR_SREV
argument_list|)
argument_list|)
operator|&
name|AR_SREV_ID
expr_stmt|;
if|if
condition|(
name|v
operator|==
literal|0xFF
condition|)
block|{
comment|/* new SREV format */
name|v
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_HOSTIF_REG
argument_list|(
name|ah
argument_list|,
name|AR_SREV
argument_list|)
argument_list|)
expr_stmt|;
comment|/*          * Include 6-bit Chip Type (masked to 0) to differentiate          * from pre-Sowl versions          */
name|mac_version
operator|=
operator|(
name|v
operator|&
name|AR_SREV_VERSION2
operator|)
operator|>>
name|AR_SREV_TYPE2_S
expr_stmt|;
name|mac_rev
operator|=
name|MS
argument_list|(
name|v
argument_list|,
name|AR_SREV_REVISION2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|mac_version
operator|=
name|MS
argument_list|(
name|v
argument_list|,
name|AR_SREV_VERSION
argument_list|)
expr_stmt|;
name|mac_rev
operator|=
name|v
operator|&
name|AR_SREV_REVISION
expr_stmt|;
block|}
return|return
operator|(
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_macVersion
operator|==
name|mac_version
operator|&&
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_macRev
operator|==
name|mac_rev
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Update MIB Counters  */
end_comment

begin_function
name|void
name|ar9300_update_mib_mac_stats
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HAL_MIB_STATS
modifier|*
name|stats
init|=
operator|&
name|ahp
operator|->
name|ah_stats
operator|.
name|ast_mibstats
decl_stmt|;
name|stats
operator|->
name|ackrcv_bad
operator|+=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_ACK_FAIL
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rts_bad
operator|+=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_RTS_FAIL
argument_list|)
expr_stmt|;
name|stats
operator|->
name|fcs_bad
operator|+=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_FCS_FAIL
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rts_good
operator|+=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_RTS_OK
argument_list|)
expr_stmt|;
name|stats
operator|->
name|beacons
operator|+=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_BEACON_CNT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9300_get_mib_mac_stats
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_MIB_STATS
modifier|*
name|stats
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HAL_MIB_STATS
modifier|*
name|istats
init|=
operator|&
name|ahp
operator|->
name|ah_stats
operator|.
name|ast_mibstats
decl_stmt|;
name|stats
operator|->
name|ackrcv_bad
operator|=
name|istats
operator|->
name|ackrcv_bad
expr_stmt|;
name|stats
operator|->
name|rts_bad
operator|=
name|istats
operator|->
name|rts_bad
expr_stmt|;
name|stats
operator|->
name|fcs_bad
operator|=
name|istats
operator|->
name|fcs_bad
expr_stmt|;
name|stats
operator|->
name|rts_good
operator|=
name|istats
operator|->
name|rts_good
expr_stmt|;
name|stats
operator|->
name|beacons
operator|=
name|istats
operator|->
name|beacons
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Detect if the HW supports spreading a CCK signal on channel 14  */
end_comment

begin_function
name|HAL_BOOL
name|ar9300_is_japan_channel_spread_supported
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_comment
comment|/*  * Get the rssi of frame curently being received.  */
end_comment

begin_function
name|u_int32_t
name|ar9300_get_cur_rssi
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
comment|/* XXX return (OS_REG_READ(ah, AR_PHY_CURRENT_RSSI)& 0xff); */
comment|/* get combined RSSI */
return|return
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_RSSI_3
argument_list|)
operator|&
literal|0xff
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
name|ATH_GEN_RANDOMNESS
end_if

begin_comment
comment|/*  * Get the rssi value from BB on ctl chain0.  */
end_comment

begin_function
name|u_int32_t
name|ar9300_get_rssi_chain0
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
comment|/* get ctl chain0 RSSI */
return|return
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_RSSI_0
argument_list|)
operator|&
literal|0xff
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|u_int
name|ar9300_get_def_antenna
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
return|return
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_DEF_ANTENNA
argument_list|)
operator|&
literal|0x7
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Setup coverage class */
end_comment

begin_function
name|void
name|ar9300_set_coverage_class
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int8_t
name|coverageclass
parameter_list|,
name|int
name|now
parameter_list|)
block|{ }
end_function

begin_function
name|void
name|ar9300_set_def_antenna
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int
name|antenna
parameter_list|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_DEF_ANTENNA
argument_list|,
operator|(
name|antenna
operator|&
literal|0x7
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|HAL_BOOL
name|ar9300_set_antenna_switch
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_ANT_SETTING
name|settings
parameter_list|,
specifier|const
name|struct
name|ieee80211_channel
modifier|*
name|chan
parameter_list|,
name|u_int8_t
modifier|*
name|tx_chainmask
parameter_list|,
name|u_int8_t
modifier|*
name|rx_chainmask
parameter_list|,
name|u_int8_t
modifier|*
name|antenna_cfgd
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
comment|/*      * Owl does not support diversity or changing antennas.      *      * Instead this API and function are defined differently for AR9300.      * To support Tablet PC's, this interface allows the system      * to dramatically reduce the TX power on a particular chain.      *      * Based on the value of (redefined) diversity_control, the      * reset code will decrease power on chain 0 or chain 1/2.      *      * Based on the value of bit 0 of antenna_switch_swap,      * the mapping between OID call and chain is defined as:      *  0:  map A -> 0, B -> 1;      *  1:  map A -> 1, B -> 0;      *      * NOTE:      *   The devices that use this OID should use a tx_chain_mask and      *   tx_chain_select_legacy setting of 5 or 3 if ANTENNA_FIXED_B is      *   used in order to ensure an active transmit antenna.  This      *   API will allow the host to turn off the only transmitting      *   antenna to ensure the antenna closest to the user's body is      *   powered-down.      */
comment|/*      * Set antenna control for use during reset sequence by      * ar9300_decrease_chain_power()      */
name|ahp
operator|->
name|ah_diversity_control
operator|=
name|settings
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_function
name|HAL_BOOL
name|ar9300_is_sleep_after_beacon_broken
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_function
name|HAL_BOOL
name|ar9300_set_slot_time
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int
name|us
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
if|if
condition|(
name|us
operator|<
name|HAL_SLOT_TIME_9
operator|||
name|us
operator|>
name|ar9300_mac_to_usec
argument_list|(
name|ah
argument_list|,
literal|0xffff
argument_list|)
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_RESET
argument_list|,
literal|"%s: bad slot time %u\n"
argument_list|,
name|__func__
argument_list|,
name|us
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|ah_slot_time
operator|=
operator|(
name|u_int
operator|)
operator|-
literal|1
expr_stmt|;
comment|/* restore default handling */
return|return
name|AH_FALSE
return|;
block|}
else|else
block|{
comment|/* convert to system clocks */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_D_GBL_IFS_SLOT
argument_list|,
name|ar9300_mac_to_clks
argument_list|(
name|ah
argument_list|,
name|us
argument_list|)
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|ah_slot_time
operator|=
name|us
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
block|}
end_function

begin_function
name|HAL_BOOL
name|ar9300_set_ack_timeout
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int
name|us
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
if|if
condition|(
name|us
operator|>
name|ar9300_mac_to_usec
argument_list|(
name|ah
argument_list|,
name|MS
argument_list|(
literal|0xffffffff
argument_list|,
name|AR_TIME_OUT_ACK
argument_list|)
argument_list|)
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_RESET
argument_list|,
literal|"%s: bad ack timeout %u\n"
argument_list|,
name|__func__
argument_list|,
name|us
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|ah_ack_timeout
operator|=
operator|(
name|u_int
operator|)
operator|-
literal|1
expr_stmt|;
comment|/* restore default handling */
return|return
name|AH_FALSE
return|;
block|}
else|else
block|{
comment|/* convert to system clocks */
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_TIME_OUT
argument_list|,
name|AR_TIME_OUT_ACK
argument_list|,
name|ar9300_mac_to_clks
argument_list|(
name|ah
argument_list|,
name|us
argument_list|)
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|ah_ack_timeout
operator|=
name|us
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
block|}
end_function

begin_function
name|u_int
name|ar9300_get_ack_timeout
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|u_int
name|clks
init|=
name|MS
argument_list|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_TIME_OUT
argument_list|)
argument_list|,
name|AR_TIME_OUT_ACK
argument_list|)
decl_stmt|;
return|return
name|ar9300_mac_to_usec
argument_list|(
name|ah
argument_list|,
name|clks
argument_list|)
return|;
comment|/* convert from system clocks */
block|}
end_function

begin_function
name|HAL_STATUS
name|ar9300_set_quiet
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int32_t
name|period
parameter_list|,
name|u_int32_t
name|duration
parameter_list|,
name|u_int32_t
name|next_start
parameter_list|,
name|HAL_QUIET_FLAG
name|flag
parameter_list|)
block|{
define|#
directive|define
name|TU_TO_USEC
parameter_list|(
name|_tu
parameter_list|)
value|((_tu)<< 10)
name|HAL_STATUS
name|status
init|=
name|HAL_EIO
decl_stmt|;
name|u_int32_t
name|tsf
init|=
literal|0
decl_stmt|,
name|j
decl_stmt|,
name|next_start_us
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|flag
operator|&
name|HAL_QUIET_ENABLE
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|2
condition|;
name|j
operator|++
control|)
block|{
name|next_start_us
operator|=
name|TU_TO_USEC
argument_list|(
name|next_start
argument_list|)
expr_stmt|;
name|tsf
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_TSF_L32
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|next_start
operator|)
operator|||
operator|(
name|flag
operator|&
name|HAL_QUIET_ADD_CURRENT_TSF
operator|)
condition|)
block|{
name|next_start_us
operator|+=
name|tsf
expr_stmt|;
block|}
if|if
condition|(
name|flag
operator|&
name|HAL_QUIET_ADD_SWBA_RESP_TIME
condition|)
block|{
name|next_start_us
operator|+=
name|ah
operator|->
name|ah_config
operator|.
name|ah_sw_beacon_response_time
expr_stmt|;
block|}
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_QUIET1
argument_list|,
name|AR_QUIET1_QUIET_ACK_CTS_ENABLE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_QUIET2
argument_list|,
name|SM
argument_list|(
name|duration
argument_list|,
name|AR_QUIET2_QUIET_DUR
argument_list|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_QUIET_PERIOD
argument_list|,
name|TU_TO_USEC
argument_list|(
name|period
argument_list|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_NEXT_QUIET_TIMER
argument_list|,
name|next_start_us
argument_list|)
expr_stmt|;
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_TIMER_MODE
argument_list|,
name|AR_QUIET_TIMER_EN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_TSF_L32
argument_list|)
operator|>>
literal|10
operator|)
operator|==
name|tsf
operator|>>
literal|10
condition|)
block|{
name|status
operator|=
name|HAL_OK
expr_stmt|;
break|break;
block|}
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_QUEUE
argument_list|,
literal|"%s: TSF have moved "
literal|"while trying to set quiet time TSF: 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|tsf
argument_list|)
expr_stmt|;
comment|/* TSF shouldn't count twice or reg access is taking forever */
name|HALASSERT
argument_list|(
name|j
operator|<
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_TIMER_MODE
argument_list|,
name|AR_QUIET_TIMER_EN
argument_list|)
expr_stmt|;
name|status
operator|=
name|HAL_OK
expr_stmt|;
block|}
return|return
name|status
return|;
undef|#
directive|undef
name|TU_TO_USEC
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|ATH_SUPPORT_DFS
end_ifdef

begin_function
name|void
name|ar9300_cac_tx_quiet
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|enable
parameter_list|)
block|{
name|u32
name|reg1
decl_stmt|,
name|reg2
decl_stmt|;
name|reg1
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_MAC_PCU_OFFSET
argument_list|(
name|MAC_PCU_MISC_MODE
argument_list|)
argument_list|)
expr_stmt|;
name|reg2
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_MAC_PCU_OFFSET
argument_list|(
name|MAC_PCU_QUIET_TIME_1
argument_list|)
argument_list|)
expr_stmt|;
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_cac_quiet_enabled
operator|=
name|enable
expr_stmt|;
if|if
condition|(
name|enable
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MAC_PCU_OFFSET
argument_list|(
name|MAC_PCU_MISC_MODE
argument_list|)
argument_list|,
name|reg1
operator||
name|AR_PCU_FORCE_QUIET_COLL
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MAC_PCU_OFFSET
argument_list|(
name|MAC_PCU_QUIET_TIME_1
argument_list|)
argument_list|,
name|reg2
operator|&
operator|~
name|AR_QUIET1_QUIET_ACK_CTS_ENABLE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MAC_PCU_OFFSET
argument_list|(
name|MAC_PCU_MISC_MODE
argument_list|)
argument_list|,
name|reg1
operator|&
operator|~
name|AR_PCU_FORCE_QUIET_COLL
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MAC_PCU_OFFSET
argument_list|(
name|MAC_PCU_QUIET_TIME_1
argument_list|)
argument_list|,
name|reg2
operator||
name|AR_QUIET1_QUIET_ACK_CTS_ENABLE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ATH_SUPPORT_DFS */
end_comment

begin_function
name|void
name|ar9300_set_pcu_config
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|ar9300_set_operating_mode
argument_list|(
name|ah
argument_list|,
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_opmode
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|HAL_STATUS
name|ar9300_get_capability
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_CAPABILITY_TYPE
name|type
parameter_list|,
name|u_int32_t
name|capability
parameter_list|,
name|u_int32_t
modifier|*
name|result
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
specifier|const
name|HAL_CAPABILITIES
modifier|*
name|p_cap
init|=
operator|&
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_caps
decl_stmt|;
name|struct
name|ar9300_ani_state
modifier|*
name|ani
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|HAL_CAP_CIPHER
case|:
comment|/* cipher handled in hardware */
switch|switch
condition|(
name|capability
condition|)
block|{
case|case
name|HAL_CIPHER_AES_CCM
case|:
case|case
name|HAL_CIPHER_AES_OCB
case|:
case|case
name|HAL_CIPHER_TKIP
case|:
case|case
name|HAL_CIPHER_WEP
case|:
case|case
name|HAL_CIPHER_MIC
case|:
case|case
name|HAL_CIPHER_CLR
case|:
return|return
name|HAL_OK
return|;
default|default:
return|return
name|HAL_ENOTSUPP
return|;
block|}
case|case
name|HAL_CAP_TKIP_MIC
case|:
comment|/* handle TKIP MIC in hardware */
switch|switch
condition|(
name|capability
condition|)
block|{
case|case
literal|0
case|:
comment|/* hardware capability */
return|return
name|HAL_OK
return|;
case|case
literal|1
case|:
return|return
operator|(
name|ahp
operator|->
name|ah_sta_id1_defaults
operator|&
name|AR_STA_ID1_CRPT_MIC_ENABLE
operator|)
condition|?
name|HAL_OK
else|:
name|HAL_ENXIO
return|;
default|default:
return|return
name|HAL_ENOTSUPP
return|;
block|}
case|case
name|HAL_CAP_TKIP_SPLIT
case|:
comment|/* hardware TKIP uses split keys */
switch|switch
condition|(
name|capability
condition|)
block|{
case|case
literal|0
case|:
comment|/* hardware capability */
return|return
name|p_cap
operator|->
name|halTkipMicTxRxKeySupport
condition|?
name|HAL_ENXIO
else|:
name|HAL_OK
return|;
case|case
literal|1
case|:
comment|/* current setting */
return|return
operator|(
name|ahp
operator|->
name|ah_misc_mode
operator|&
name|AR_PCU_MIC_NEW_LOC_ENA
operator|)
condition|?
name|HAL_ENXIO
else|:
name|HAL_OK
return|;
default|default:
return|return
name|HAL_ENOTSUPP
return|;
block|}
case|case
name|HAL_CAP_WME_TKIPMIC
case|:
comment|/* hardware can do TKIP MIC when WMM is turned on */
return|return
name|HAL_OK
return|;
case|case
name|HAL_CAP_PHYCOUNTERS
case|:
comment|/* hardware PHY error counters */
return|return
name|HAL_OK
return|;
case|case
name|HAL_CAP_DIVERSITY
case|:
comment|/* hardware supports fast diversity */
switch|switch
condition|(
name|capability
condition|)
block|{
case|case
literal|0
case|:
comment|/* hardware capability */
return|return
name|HAL_OK
return|;
case|case
literal|1
case|:
comment|/* current setting */
return|return
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CCK_DETECT
argument_list|)
operator|&
name|AR_PHY_CCK_DETECT_BB_ENABLE_ANT_FAST_DIV
operator|)
condition|?
name|HAL_OK
else|:
name|HAL_ENXIO
return|;
block|}
return|return
name|HAL_EINVAL
return|;
case|case
name|HAL_CAP_TPC
case|:
switch|switch
condition|(
name|capability
condition|)
block|{
case|case
literal|0
case|:
comment|/* hardware capability */
return|return
name|HAL_OK
return|;
case|case
literal|1
case|:
return|return
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_desc_tpc
condition|?
name|HAL_OK
else|:
name|HAL_ENXIO
return|;
block|}
return|return
name|HAL_OK
return|;
case|case
name|HAL_CAP_PHYDIAG
case|:
comment|/* radar pulse detection capability */
return|return
name|HAL_OK
return|;
case|case
name|HAL_CAP_MCAST_KEYSRCH
case|:
comment|/* multicast frame keycache search */
switch|switch
condition|(
name|capability
condition|)
block|{
case|case
literal|0
case|:
comment|/* hardware capability */
return|return
name|HAL_OK
return|;
case|case
literal|1
case|:
if|if
condition|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_STA_ID1
argument_list|)
operator|&
name|AR_STA_ID1_ADHOC
condition|)
block|{
comment|/*                  * Owl and Merlin have problems in mcast key search.                  * Disable this cap. in Ad-hoc mode. see Bug 25776 and                  * 26802                  */
return|return
name|HAL_ENXIO
return|;
block|}
else|else
block|{
return|return
operator|(
name|ahp
operator|->
name|ah_sta_id1_defaults
operator|&
name|AR_STA_ID1_MCAST_KSRCH
operator|)
condition|?
name|HAL_OK
else|:
name|HAL_ENXIO
return|;
block|}
block|}
return|return
name|HAL_EINVAL
return|;
case|case
name|HAL_CAP_TSF_ADJUST
case|:
comment|/* hardware has beacon tsf adjust */
switch|switch
condition|(
name|capability
condition|)
block|{
case|case
literal|0
case|:
comment|/* hardware capability */
return|return
name|p_cap
operator|->
name|halTsfAddSupport
condition|?
name|HAL_OK
else|:
name|HAL_ENOTSUPP
return|;
case|case
literal|1
case|:
return|return
operator|(
name|ahp
operator|->
name|ah_misc_mode
operator|&
name|AR_PCU_TX_ADD_TSF
operator|)
condition|?
name|HAL_OK
else|:
name|HAL_ENXIO
return|;
block|}
return|return
name|HAL_EINVAL
return|;
case|case
name|HAL_CAP_RFSILENT
case|:
comment|/* rfsilent support  */
if|if
condition|(
name|capability
operator|==
literal|3
condition|)
block|{
comment|/* rfkill interrupt */
comment|/*              * XXX: Interrupt-based notification of RF Kill state              *      changes not working yet. Report that this feature              *      is not supported so that polling is used instead.              */
return|return
operator|(
name|HAL_ENOTSUPP
operator|)
return|;
block|}
return|return
name|ath_hal_getcapability
argument_list|(
name|ah
argument_list|,
name|type
argument_list|,
name|capability
argument_list|,
name|result
argument_list|)
return|;
case|case
name|HAL_CAP_4ADDR_AGGR
case|:
return|return
name|HAL_OK
return|;
case|case
name|HAL_CAP_BB_RIFS_HANG
case|:
return|return
name|HAL_ENOTSUPP
return|;
case|case
name|HAL_CAP_BB_DFS_HANG
case|:
return|return
name|HAL_ENOTSUPP
return|;
case|case
name|HAL_CAP_BB_RX_CLEAR_STUCK_HANG
case|:
comment|/* Track chips that are known to have BB hangs related          * to rx_clear stuck low.          */
return|return
name|HAL_ENOTSUPP
return|;
case|case
name|HAL_CAP_MAC_HANG
case|:
comment|/* Track chips that are known to have MAC hangs.          */
return|return
name|HAL_OK
return|;
case|case
name|HAL_CAP_RIFS_RX_ENABLED
case|:
comment|/* Is RIFS RX currently enabled */
return|return
operator|(
name|ahp
operator|->
name|ah_rifs_enabled
operator|==
name|AH_TRUE
operator|)
condition|?
name|HAL_OK
else|:
name|HAL_ENOTSUPP
return|;
if|#
directive|if
literal|0
block|case HAL_CAP_ANT_CFG_2GHZ:         *result = p_cap->halNumAntCfg2Ghz;         return HAL_OK;     case HAL_CAP_ANT_CFG_5GHZ:         *result = p_cap->halNumAntCfg5Ghz;         return HAL_OK;     case HAL_CAP_RX_STBC:         *result = p_cap->hal_rx_stbc_support;         return HAL_OK;     case HAL_CAP_TX_STBC:         *result = p_cap->hal_tx_stbc_support;         return HAL_OK;
endif|#
directive|endif
case|case
name|HAL_CAP_LDPC
case|:
operator|*
name|result
operator|=
name|p_cap
operator|->
name|halLDPCSupport
expr_stmt|;
return|return
name|HAL_OK
return|;
case|case
name|HAL_CAP_DYNAMIC_SMPS
case|:
return|return
name|HAL_OK
return|;
case|case
name|HAL_CAP_DS
case|:
return|return
operator|(
name|AR_SREV_HORNET
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_APHRODITE
argument_list|(
name|ah
argument_list|)
operator|||
operator|(
name|p_cap
operator|->
name|halTxChainMask
operator|&
literal|0x3
operator|)
operator|!=
literal|0x3
operator|||
operator|(
name|p_cap
operator|->
name|halRxChainMask
operator|&
literal|0x3
operator|)
operator|!=
literal|0x3
operator|)
condition|?
name|HAL_ENOTSUPP
else|:
name|HAL_OK
return|;
case|case
name|HAL_CAP_TS
case|:
return|return
operator|(
name|AR_SREV_HORNET
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_APHRODITE
argument_list|(
name|ah
argument_list|)
operator|||
operator|(
name|p_cap
operator|->
name|halTxChainMask
operator|&
literal|0x7
operator|)
operator|!=
literal|0x7
operator|||
operator|(
name|p_cap
operator|->
name|halRxChainMask
operator|&
literal|0x7
operator|)
operator|!=
literal|0x7
operator|)
condition|?
name|HAL_ENOTSUPP
else|:
name|HAL_OK
return|;
case|case
name|HAL_CAP_OL_PWRCTRL
case|:
return|return
operator|(
name|ar9300_eeprom_get
argument_list|(
name|ahp
argument_list|,
name|EEP_OL_PWRCTRL
argument_list|)
operator|)
condition|?
name|HAL_OK
else|:
name|HAL_ENOTSUPP
return|;
case|case
name|HAL_CAP_CRDC
case|:
if|#
directive|if
name|ATH_SUPPORT_CRDC
return|return
operator|(
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
operator|&&
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_crdc_enable
operator|)
condition|?
name|HAL_OK
else|:
name|HAL_ENOTSUPP
return|;
else|#
directive|else
return|return
name|HAL_ENOTSUPP
return|;
endif|#
directive|endif
if|#
directive|if
literal|0
block|case HAL_CAP_MAX_WEP_TKIP_HT20_TX_RATEKBPS:         *result = (u_int32_t)(-1);         return HAL_OK;     case HAL_CAP_MAX_WEP_TKIP_HT40_TX_RATEKBPS:         *result = (u_int32_t)(-1);         return HAL_OK;
endif|#
directive|endif
case|case
name|HAL_CAP_BB_PANIC_WATCHDOG
case|:
return|return
name|HAL_OK
return|;
case|case
name|HAL_CAP_PHYRESTART_CLR_WAR
case|:
if|if
condition|(
operator|(
name|AH_PRIVATE
argument_list|(
operator|(
name|ah
operator|)
argument_list|)
operator|->
name|ah_macVersion
operator|==
name|AR_SREV_VERSION_OSPREY
operator|)
operator|&&
operator|(
name|AH_PRIVATE
argument_list|(
operator|(
name|ah
operator|)
argument_list|)
operator|->
name|ah_macRev
operator|<
name|AR_SREV_REVISION_AR9580_10
operator|)
condition|)
block|{
return|return
name|HAL_OK
return|;
block|}
else|else
block|{
return|return
name|HAL_ENOTSUPP
return|;
block|}
case|case
name|HAL_CAP_ENTERPRISE_MODE
case|:
operator|*
name|result
operator|=
name|ahp
operator|->
name|ah_enterprise_mode
operator|>>
literal|16
expr_stmt|;
comment|/*          * WAR for EV 77658 - Add delimiters to first sub-frame when using          * RTS/CTS with aggregation and non-enterprise Osprey.          *          * Bug fixed in AR9580/Peacock, Wasp1.1 and later          */
if|if
condition|(
operator|(
name|ahp
operator|->
name|ah_enterprise_mode
operator|&
name|AR_ENT_OTP_MIN_PKT_SIZE_DISABLE
operator|)
operator|&&
operator|!
name|AR_SREV_AR9580_10_OR_LATER
argument_list|(
name|ah
argument_list|)
operator|&&
operator|(
operator|!
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_WASP_10
argument_list|(
name|ah
argument_list|)
operator|)
condition|)
block|{
operator|*
name|result
operator||=
name|AH_ENT_RTSCTS_DELIM_WAR
expr_stmt|;
block|}
return|return
name|HAL_OK
return|;
case|case
name|HAL_CAP_LDPCWAR
case|:
comment|/* WAR for RIFS+LDPC issue is required for all chips currently           * supported by ar9300 HAL.          */
return|return
name|HAL_OK
return|;
case|case
name|HAL_CAP_ENABLE_APM
case|:
operator|*
name|result
operator|=
name|p_cap
operator|->
name|halApmEnable
expr_stmt|;
return|return
name|HAL_OK
return|;
case|case
name|HAL_CAP_PCIE_LCR_EXTSYNC_EN
case|:
return|return
operator|(
name|p_cap
operator|->
name|hal_pcie_lcr_extsync_en
operator|==
name|AH_TRUE
operator|)
condition|?
name|HAL_OK
else|:
name|HAL_ENOTSUPP
return|;
case|case
name|HAL_CAP_PCIE_LCR_OFFSET
case|:
operator|*
name|result
operator|=
name|p_cap
operator|->
name|hal_pcie_lcr_offset
expr_stmt|;
return|return
name|HAL_OK
return|;
case|case
name|HAL_CAP_SMARTANTENNA
case|:
comment|/* FIXME A request is pending with h/w team to add feature bit in          * caldata to detect if board has smart antenna or not, once added          * we need to fix his piece of code to read and return value without          * any compile flags          */
if|#
directive|if
name|UMAC_SUPPORT_SMARTANTENNA
comment|/* enable smart antenna for  Peacock, Wasp and scorpion             for future chips need to modify */
if|if
condition|(
name|AR_SREV_AR9580_10
argument_list|(
name|ah
argument_list|)
operator|||
operator|(
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
operator|)
operator|||
name|AR_SREV_SCORPION
argument_list|(
name|ah
argument_list|)
condition|)
block|{
return|return
name|HAL_OK
return|;
block|}
else|else
block|{
return|return
name|HAL_ENOTSUPP
return|;
block|}
else|#
directive|else
return|return
name|HAL_ENOTSUPP
return|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|ATH_TRAFFIC_FAST_RECOVER
case|case
name|HAL_CAP_TRAFFIC_FAST_RECOVER
case|:
if|if
condition|(
name|AR_SREV_HORNET
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_WASP_11
argument_list|(
name|ah
argument_list|)
condition|)
block|{
return|return
name|HAL_OK
return|;
block|}
else|else
block|{
return|return
name|HAL_ENOTSUPP
return|;
block|}
endif|#
directive|endif
comment|/* FreeBSD ANI */
case|case
name|HAL_CAP_INTMIT
case|:
comment|/* interference mitigation */
switch|switch
condition|(
name|capability
condition|)
block|{
case|case
name|HAL_CAP_INTMIT_PRESENT
case|:
comment|/* hardware capability */
return|return
name|HAL_OK
return|;
case|case
name|HAL_CAP_INTMIT_ENABLE
case|:
return|return
operator|(
name|ahp
operator|->
name|ah_proc_phy_err
operator|&
name|HAL_PROCESS_ANI
operator|)
condition|?
name|HAL_OK
else|:
name|HAL_ENXIO
return|;
case|case
name|HAL_CAP_INTMIT_NOISE_IMMUNITY_LEVEL
case|:
case|case
name|HAL_CAP_INTMIT_OFDM_WEAK_SIGNAL_LEVEL
case|:
comment|//            case HAL_CAP_INTMIT_CCK_WEAK_SIGNAL_THR:
case|case
name|HAL_CAP_INTMIT_FIRSTEP_LEVEL
case|:
case|case
name|HAL_CAP_INTMIT_SPUR_IMMUNITY_LEVEL
case|:
name|ani
operator|=
name|ar9300_ani_get_current_state
argument_list|(
name|ah
argument_list|)
expr_stmt|;
if|if
condition|(
name|ani
operator|==
name|AH_NULL
condition|)
return|return
name|HAL_ENXIO
return|;
switch|switch
condition|(
name|capability
condition|)
block|{
comment|/* XXX AR9300 HAL has OFDM/CCK noise immunity level params? */
case|case
literal|2
case|:
operator|*
name|result
operator|=
name|ani
operator|->
name|ofdm_noise_immunity_level
expr_stmt|;
break|break;
case|case
literal|3
case|:
operator|*
name|result
operator|=
operator|!
name|ani
operator|->
name|ofdm_weak_sig_detect_off
expr_stmt|;
break|break;
comment|//                   case 4: *result = ani->cck_weak_sig_threshold; break;
case|case
literal|5
case|:
operator|*
name|result
operator|=
name|ani
operator|->
name|firstep_level
expr_stmt|;
break|break;
case|case
literal|6
case|:
operator|*
name|result
operator|=
name|ani
operator|->
name|spur_immunity_level
expr_stmt|;
break|break;
block|}
return|return
name|HAL_OK
return|;
block|}
return|return
name|HAL_EINVAL
return|;
default|default:
return|return
name|ath_hal_getcapability
argument_list|(
name|ah
argument_list|,
name|type
argument_list|,
name|capability
argument_list|,
name|result
argument_list|)
return|;
block|}
block|}
end_function

begin_function
name|HAL_BOOL
name|ar9300_set_capability
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_CAPABILITY_TYPE
name|type
parameter_list|,
name|u_int32_t
name|capability
parameter_list|,
name|u_int32_t
name|setting
parameter_list|,
name|HAL_STATUS
modifier|*
name|status
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
specifier|const
name|HAL_CAPABILITIES
modifier|*
name|p_cap
init|=
operator|&
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_caps
decl_stmt|;
name|u_int32_t
name|v
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|HAL_CAP_TKIP_SPLIT
case|:
comment|/* hardware TKIP uses split keys */
if|if
condition|(
operator|!
name|p_cap
operator|->
name|halTkipMicTxRxKeySupport
condition|)
return|return
name|AH_FALSE
return|;
if|if
condition|(
name|setting
condition|)
name|ahp
operator|->
name|ah_misc_mode
operator|&=
operator|~
name|AR_PCU_MIC_NEW_LOC_ENA
expr_stmt|;
else|else
name|ahp
operator|->
name|ah_misc_mode
operator||=
name|AR_PCU_MIC_NEW_LOC_ENA
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PCU_MISC
argument_list|,
name|ahp
operator|->
name|ah_misc_mode
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
case|case
name|HAL_CAP_TKIP_MIC
case|:
comment|/* handle TKIP MIC in hardware */
if|if
condition|(
name|setting
condition|)
block|{
name|ahp
operator|->
name|ah_sta_id1_defaults
operator||=
name|AR_STA_ID1_CRPT_MIC_ENABLE
expr_stmt|;
block|}
else|else
block|{
name|ahp
operator|->
name|ah_sta_id1_defaults
operator|&=
operator|~
name|AR_STA_ID1_CRPT_MIC_ENABLE
expr_stmt|;
block|}
return|return
name|AH_TRUE
return|;
case|case
name|HAL_CAP_DIVERSITY
case|:
name|v
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CCK_DETECT
argument_list|)
expr_stmt|;
if|if
condition|(
name|setting
condition|)
block|{
name|v
operator||=
name|AR_PHY_CCK_DETECT_BB_ENABLE_ANT_FAST_DIV
expr_stmt|;
block|}
else|else
block|{
name|v
operator|&=
operator|~
name|AR_PHY_CCK_DETECT_BB_ENABLE_ANT_FAST_DIV
expr_stmt|;
block|}
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CCK_DETECT
argument_list|,
name|v
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
case|case
name|HAL_CAP_DIAG
case|:
comment|/* hardware diagnostic support */
comment|/*          * NB: could split this up into virtual capabilities,          *     (e.g. 1 => ACK, 2 => CTS, etc.) but it hardly          *     seems worth the additional complexity.          */
ifdef|#
directive|ifdef
name|AH_DEBUG
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_diagreg
operator|=
name|setting
expr_stmt|;
else|#
directive|else
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_diagreg
operator|=
name|setting
operator|&
literal|0x6
expr_stmt|;
comment|/* ACK+CTS */
endif|#
directive|endif
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_DIAG_SW
argument_list|,
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_diagreg
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
case|case
name|HAL_CAP_TPC
case|:
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_desc_tpc
operator|=
operator|(
name|setting
operator|!=
literal|0
operator|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
case|case
name|HAL_CAP_MCAST_KEYSRCH
case|:
comment|/* multicast frame keycache search */
if|if
condition|(
name|setting
condition|)
block|{
name|ahp
operator|->
name|ah_sta_id1_defaults
operator||=
name|AR_STA_ID1_MCAST_KSRCH
expr_stmt|;
block|}
else|else
block|{
name|ahp
operator|->
name|ah_sta_id1_defaults
operator|&=
operator|~
name|AR_STA_ID1_MCAST_KSRCH
expr_stmt|;
block|}
return|return
name|AH_TRUE
return|;
case|case
name|HAL_CAP_TSF_ADJUST
case|:
comment|/* hardware has beacon tsf adjust */
if|if
condition|(
name|p_cap
operator|->
name|halTsfAddSupport
condition|)
block|{
if|if
condition|(
name|setting
condition|)
block|{
name|ahp
operator|->
name|ah_misc_mode
operator||=
name|AR_PCU_TX_ADD_TSF
expr_stmt|;
block|}
else|else
block|{
name|ahp
operator|->
name|ah_misc_mode
operator|&=
operator|~
name|AR_PCU_TX_ADD_TSF
expr_stmt|;
block|}
return|return
name|AH_TRUE
return|;
block|}
return|return
name|AH_FALSE
return|;
comment|/* FreeBSD interrupt mitigation / ANI */
case|case
name|HAL_CAP_INTMIT
case|:
block|{
comment|/* interference mitigation */
comment|/* This maps the public ANI commands to the internal ANI commands */
comment|/* Private: HAL_ANI_CMD; Public: HAL_CAP_INTMIT_CMD */
specifier|static
specifier|const
name|HAL_ANI_CMD
name|cmds
index|[]
init|=
block|{
name|HAL_ANI_PRESENT
block|,
name|HAL_ANI_MODE
block|,
name|HAL_ANI_NOISE_IMMUNITY_LEVEL
block|,
name|HAL_ANI_OFDM_WEAK_SIGNAL_DETECTION
block|,
name|HAL_ANI_CCK_WEAK_SIGNAL_THR
block|,
name|HAL_ANI_FIRSTEP_LEVEL
block|,
name|HAL_ANI_SPUR_IMMUNITY_LEVEL
block|,             }
decl_stmt|;
define|#
directive|define
name|N
parameter_list|(
name|a
parameter_list|)
value|(sizeof(a) / sizeof(a[0]))
return|return
name|capability
operator|<
name|N
argument_list|(
name|cmds
argument_list|)
condition|?
name|ar9300_ani_control
argument_list|(
name|ah
argument_list|,
name|cmds
index|[
name|capability
index|]
argument_list|,
name|setting
argument_list|)
else|:
name|AH_FALSE
return|;
undef|#
directive|undef
name|N
block|}
case|case
name|HAL_CAP_RXBUFSIZE
case|:
comment|/* set MAC receive buffer size */
name|ahp
operator|->
name|rx_buf_size
operator|=
name|setting
operator|&
name|AR_DATABUF_MASK
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_DATABUF
argument_list|,
name|ahp
operator|->
name|rx_buf_size
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
comment|/* fall thru... */
default|default:
return|return
name|ath_hal_setcapability
argument_list|(
name|ah
argument_list|,
name|type
argument_list|,
name|capability
argument_list|,
name|setting
argument_list|,
name|status
argument_list|)
return|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|AH_DEBUG
end_ifdef

begin_function
specifier|static
name|void
name|ar9300_print_reg
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int32_t
name|args
parameter_list|)
block|{
name|u_int32_t
name|i
init|=
literal|0
decl_stmt|;
comment|/* Read 0x80d0 to trigger pcie analyzer */
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"0x%04x 0x%08x\n"
argument_list|,
literal|0x80d0
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
literal|0x80d0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|args
operator|&
name|HAL_DIAG_PRINT_REG_COUNTER
condition|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|u_int32_t
name|tf
decl_stmt|,
name|rf
decl_stmt|,
name|rc
decl_stmt|,
name|cc
decl_stmt|;
name|tf
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_TFCNT
argument_list|)
expr_stmt|;
name|rf
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_RFCNT
argument_list|)
expr_stmt|;
name|rc
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_RCCNT
argument_list|)
expr_stmt|;
name|cc
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_CCCNT
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"AR_TFCNT Diff= 0x%x\n"
argument_list|,
name|tf
operator|-
name|ahp
operator|->
name|last_tf
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"AR_RFCNT Diff= 0x%x\n"
argument_list|,
name|rf
operator|-
name|ahp
operator|->
name|last_rf
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"AR_RCCNT Diff= 0x%x\n"
argument_list|,
name|rc
operator|-
name|ahp
operator|->
name|last_rc
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"AR_CCCNT Diff= 0x%x\n"
argument_list|,
name|cc
operator|-
name|ahp
operator|->
name|last_cc
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|last_tf
operator|=
name|tf
expr_stmt|;
name|ahp
operator|->
name|last_rf
operator|=
name|rf
expr_stmt|;
name|ahp
operator|->
name|last_rc
operator|=
name|rc
expr_stmt|;
name|ahp
operator|->
name|last_cc
operator|=
name|cc
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"DMADBG0 = 0x%x\n"
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_DMADBG_0
argument_list|)
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"DMADBG1 = 0x%x\n"
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_DMADBG_1
argument_list|)
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"DMADBG2 = 0x%x\n"
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_DMADBG_2
argument_list|)
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"DMADBG3 = 0x%x\n"
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_DMADBG_3
argument_list|)
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"DMADBG4 = 0x%x\n"
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_DMADBG_4
argument_list|)
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"DMADBG5 = 0x%x\n"
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_DMADBG_5
argument_list|)
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"DMADBG6 = 0x%x\n"
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_DMADBG_6
argument_list|)
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"DMADBG7 = 0x%x\n"
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_DMADBG_7
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|args
operator|&
name|HAL_DIAG_PRINT_REG_ALL
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0x8
init|;
name|i
operator|<=
literal|0xB8
condition|;
name|i
operator|+=
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
control|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"0x%04x 0x%08x\n"
argument_list|,
name|i
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0x800
init|;
name|i
operator|<=
operator|(
literal|0x800
operator|+
operator|(
literal|10
operator|<<
literal|2
operator|)
operator|)
condition|;
name|i
operator|+=
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
control|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"0x%04x 0x%08x\n"
argument_list|,
name|i
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"0x%04x 0x%08x\n"
argument_list|,
literal|0x840
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"0x%04x 0x%08x\n"
argument_list|,
literal|0x880
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0x8C0
init|;
name|i
operator|<=
operator|(
literal|0x8C0
operator|+
operator|(
literal|10
operator|<<
literal|2
operator|)
operator|)
condition|;
name|i
operator|+=
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
control|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"0x%04x 0x%08x\n"
argument_list|,
name|i
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0x1F00
init|;
name|i
operator|<=
literal|0x1F04
condition|;
name|i
operator|+=
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
control|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"0x%04x 0x%08x\n"
argument_list|,
name|i
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0x4000
init|;
name|i
operator|<=
literal|0x408C
condition|;
name|i
operator|+=
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
control|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"0x%04x 0x%08x\n"
argument_list|,
name|i
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0x5000
init|;
name|i
operator|<=
literal|0x503C
condition|;
name|i
operator|+=
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
control|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"0x%04x 0x%08x\n"
argument_list|,
name|i
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0x7040
init|;
name|i
operator|<=
literal|0x7058
condition|;
name|i
operator|+=
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
control|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"0x%04x 0x%08x\n"
argument_list|,
name|i
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0x8000
init|;
name|i
operator|<=
literal|0x8098
condition|;
name|i
operator|+=
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
control|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"0x%04x 0x%08x\n"
argument_list|,
name|i
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0x80D4
init|;
name|i
operator|<=
literal|0x8200
condition|;
name|i
operator|+=
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
control|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"0x%04x 0x%08x\n"
argument_list|,
name|i
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0x8240
init|;
name|i
operator|<=
literal|0x97FC
condition|;
name|i
operator|+=
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
control|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"0x%04x 0x%08x\n"
argument_list|,
name|i
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0x9800
init|;
name|i
operator|<=
literal|0x99f0
condition|;
name|i
operator|+=
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
control|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"0x%04x 0x%08x\n"
argument_list|,
name|i
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0x9c10
init|;
name|i
operator|<=
literal|0x9CFC
condition|;
name|i
operator|+=
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
control|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"0x%04x 0x%08x\n"
argument_list|,
name|i
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0xA200
init|;
name|i
operator|<=
literal|0xA26C
condition|;
name|i
operator|+=
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
control|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PRINT_REG
argument_list|,
literal|"0x%04x 0x%08x\n"
argument_list|,
name|i
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|HAL_BOOL
name|ar9300_get_diag_state
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|int
name|request
parameter_list|,
specifier|const
name|void
modifier|*
name|args
parameter_list|,
name|u_int32_t
name|argsize
parameter_list|,
name|void
modifier|*
modifier|*
name|result
parameter_list|,
name|u_int32_t
modifier|*
name|resultsize
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|struct
name|ar9300_ani_state
modifier|*
name|ani
decl_stmt|;
operator|(
name|void
operator|)
name|ahp
expr_stmt|;
if|if
condition|(
name|ath_hal_getdiagstate
argument_list|(
name|ah
argument_list|,
name|request
argument_list|,
name|args
argument_list|,
name|argsize
argument_list|,
name|result
argument_list|,
name|resultsize
argument_list|)
condition|)
block|{
return|return
name|AH_TRUE
return|;
block|}
switch|switch
condition|(
name|request
condition|)
block|{
ifdef|#
directive|ifdef
name|AH_PRIVATE_DIAG
case|case
name|HAL_DIAG_EEPROM
case|:
operator|*
name|result
operator|=
operator|&
name|ahp
operator|->
name|ah_eeprom
expr_stmt|;
operator|*
name|resultsize
operator|=
sizeof|sizeof
argument_list|(
name|ar9300_eeprom_t
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
if|#
directive|if
literal|0
comment|/* XXX - TODO */
block|case HAL_DIAG_EEPROM_EXP_11A:     case HAL_DIAG_EEPROM_EXP_11B:     case HAL_DIAG_EEPROM_EXP_11G:         pe =&ahp->ah_mode_power_array2133[request - HAL_DIAG_EEPROM_EXP_11A];         *result = pe->p_channels;         *resultsize = (*result == AH_NULL) ? 0 :             roundup(sizeof(u_int16_t) * pe->num_channels,             sizeof(u_int32_t)) +                 sizeof(EXPN_DATA_PER_CHANNEL_2133) * pe->num_channels;         return AH_TRUE;
endif|#
directive|endif
case|case
name|HAL_DIAG_RFGAIN
case|:
operator|*
name|result
operator|=
operator|&
name|ahp
operator|->
name|ah_gain_values
expr_stmt|;
operator|*
name|resultsize
operator|=
sizeof|sizeof
argument_list|(
name|GAIN_VALUES
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
case|case
name|HAL_DIAG_RFGAIN_CURSTEP
case|:
operator|*
name|result
operator|=
operator|(
name|void
operator|*
operator|)
name|ahp
operator|->
name|ah_gain_values
operator|.
name|curr_step
expr_stmt|;
operator|*
name|resultsize
operator|=
operator|(
operator|*
name|result
operator|==
name|AH_NULL
operator|)
condition|?
literal|0
else|:
sizeof|sizeof
argument_list|(
name|GAIN_OPTIMIZATION_STEP
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
if|#
directive|if
literal|0
comment|/* XXX - TODO */
block|case HAL_DIAG_PCDAC:         *result = ahp->ah_pcdac_table;         *resultsize = ahp->ah_pcdac_table_size;         return AH_TRUE;
endif|#
directive|endif
case|case
name|HAL_DIAG_ANI_CURRENT
case|:
name|ani
operator|=
name|ar9300_ani_get_current_state
argument_list|(
name|ah
argument_list|)
expr_stmt|;
if|if
condition|(
name|ani
operator|==
name|AH_NULL
condition|)
return|return
name|AH_FALSE
return|;
comment|/* Convert ar9300 HAL to FreeBSD HAL ANI state */
comment|/* XXX TODO: add all of these to the HAL ANI state structure */
name|bzero
argument_list|(
operator|&
name|ahp
operator|->
name|ext_ani_state
argument_list|,
sizeof|sizeof
argument_list|(
name|ahp
operator|->
name|ext_ani_state
argument_list|)
argument_list|)
expr_stmt|;
comment|/* XXX should this be OFDM or CCK noise immunity level? */
name|ahp
operator|->
name|ext_ani_state
operator|.
name|noiseImmunityLevel
operator|=
name|ani
operator|->
name|ofdm_noise_immunity_level
expr_stmt|;
name|ahp
operator|->
name|ext_ani_state
operator|.
name|spurImmunityLevel
operator|=
name|ani
operator|->
name|spur_immunity_level
expr_stmt|;
name|ahp
operator|->
name|ext_ani_state
operator|.
name|firstepLevel
operator|=
name|ani
operator|->
name|firstep_level
expr_stmt|;
name|ahp
operator|->
name|ext_ani_state
operator|.
name|ofdmWeakSigDetectOff
operator|=
name|ani
operator|->
name|ofdm_weak_sig_detect_off
expr_stmt|;
comment|/* mrc_cck_off */
comment|/* cck_noise_immunity_level */
name|ahp
operator|->
name|ext_ani_state
operator|.
name|listenTime
operator|=
name|ani
operator|->
name|listen_time
expr_stmt|;
operator|*
name|result
operator|=
operator|&
name|ahp
operator|->
name|ext_ani_state
expr_stmt|;
operator|*
name|resultsize
operator|=
sizeof|sizeof
argument_list|(
name|ahp
operator|->
name|ext_ani_state
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|*result = ar9300_ani_get_current_state(ah);         *resultsize = (*result == AH_NULL) ?             0 : sizeof(struct ar9300_ani_state);
endif|#
directive|endif
return|return
name|AH_TRUE
return|;
case|case
name|HAL_DIAG_ANI_STATS
case|:
operator|*
name|result
operator|=
name|ar9300_ani_get_current_stats
argument_list|(
name|ah
argument_list|)
expr_stmt|;
operator|*
name|resultsize
operator|=
operator|(
operator|*
name|result
operator|==
name|AH_NULL
operator|)
condition|?
literal|0
else|:
sizeof|sizeof
argument_list|(
name|HAL_ANI_STATS
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
case|case
name|HAL_DIAG_ANI_CMD
case|:
if|if
condition|(
name|argsize
operator|!=
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
condition|)
block|{
return|return
name|AH_FALSE
return|;
block|}
name|ar9300_ani_control
argument_list|(
name|ah
argument_list|,
operator|(
operator|(
specifier|const
name|u_int32_t
operator|*
operator|)
name|args
operator|)
index|[
literal|0
index|]
argument_list|,
operator|(
operator|(
specifier|const
name|u_int32_t
operator|*
operator|)
name|args
operator|)
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
if|#
directive|if
literal|0
block|case HAL_DIAG_TXCONT:
comment|/*AR9300_CONTTXMODE(ah, (struct ath_desc *)args, argsize );*/
block|return AH_TRUE;
endif|#
directive|endif
comment|/* 0 */
endif|#
directive|endif
comment|/* AH_PRIVATE_DIAG */
case|case
name|HAL_DIAG_CHANNELS
case|:
if|#
directive|if
literal|0
block|*result =&(ahp->ah_priv.ah_channels[0]);         *resultsize =             sizeof(ahp->ah_priv.ah_channels[0]) * ahp->ah_priv.priv.ah_nchan;
endif|#
directive|endif
return|return
name|AH_TRUE
return|;
ifdef|#
directive|ifdef
name|AH_DEBUG
case|case
name|HAL_DIAG_PRINT_REG
case|:
name|ar9300_print_reg
argument_list|(
name|ah
argument_list|,
operator|*
operator|(
operator|(
specifier|const
name|u_int32_t
operator|*
operator|)
name|args
operator|)
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
endif|#
directive|endif
default|default:
break|break;
block|}
return|return
name|AH_FALSE
return|;
block|}
end_function

begin_function
name|void
name|ar9300_dma_reg_dump
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|AH_DEBUG
define|#
directive|define
name|NUM_DMA_DEBUG_REGS
value|8
define|#
directive|define
name|NUM_QUEUES
value|10
name|u_int32_t
name|val
index|[
name|NUM_DMA_DEBUG_REGS
index|]
decl_stmt|;
name|int
name|qcu_offset
init|=
literal|0
decl_stmt|,
name|dcu_offset
init|=
literal|0
decl_stmt|;
name|u_int32_t
modifier|*
name|qcu_base
init|=
operator|&
name|val
index|[
literal|0
index|]
decl_stmt|,
modifier|*
name|dcu_base
init|=
operator|&
name|val
index|[
literal|4
index|]
decl_stmt|,
name|reg
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|;
name|int16_t
name|nfarray
index|[
name|HAL_NUM_NF_READINGS
index|]
decl_stmt|;
ifdef|#
directive|ifdef
name|ATH_NF_PER_CHAN
name|HAL_CHANNEL_INTERNAL
modifier|*
name|ichan
init|=
name|ath_hal_checkchannel
argument_list|(
name|ah
argument_list|,
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_curchan
argument_list|)
decl_stmt|;
endif|#
directive|endif
comment|/* ATH_NF_PER_CHAN */
name|HAL_NFCAL_HIST_FULL
modifier|*
name|h
init|=
name|AH_HOME_CHAN_NFCAL_HIST
argument_list|(
name|ah
argument_list|,
name|ichan
argument_list|)
decl_stmt|;
comment|/* selecting DMA OBS 8 */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MACMISC
argument_list|,
operator|(
operator|(
name|AR_MACMISC_DMA_OBS_LINE_8
operator|<<
name|AR_MACMISC_DMA_OBS_S
operator|)
operator||
operator|(
name|AR_MACMISC_MISC_OBS_BUS_1
operator|<<
name|AR_MACMISC_MISC_OBS_BUS_MSB_S
operator|)
operator|)
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"Raw DMA Debug values:\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_DMA_DEBUG_REGS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|%
literal|4
operator|==
literal|0
condition|)
block|{
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|val
index|[
name|i
index|]
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_DMADBG_0
operator|+
operator|(
name|i
operator|*
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"%d: %08x "
argument_list|,
name|i
argument_list|,
name|val
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"\n\n"
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"Num QCU: chain_st fsp_ok fsp_st DCU: chain_st\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_QUEUES
condition|;
name|i
operator|++
operator|,
name|qcu_offset
operator|+=
literal|4
operator|,
name|dcu_offset
operator|+=
literal|5
control|)
block|{
if|if
condition|(
name|i
operator|==
literal|8
condition|)
block|{
comment|/* only 8 QCU entries in val[0] */
name|qcu_offset
operator|=
literal|0
expr_stmt|;
name|qcu_base
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|==
literal|6
condition|)
block|{
comment|/* only 6 DCU entries in val[4] */
name|dcu_offset
operator|=
literal|0
expr_stmt|;
name|dcu_base
operator|++
expr_stmt|;
block|}
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"%2d          %2x      %1x     %2x           %2x\n"
argument_list|,
name|i
argument_list|,
operator|(
operator|*
name|qcu_base
operator|&
operator|(
literal|0x7
operator|<<
name|qcu_offset
operator|)
operator|)
operator|>>
name|qcu_offset
argument_list|,
operator|(
operator|*
name|qcu_base
operator|&
operator|(
literal|0x8
operator|<<
name|qcu_offset
operator|)
operator|)
operator|>>
operator|(
name|qcu_offset
operator|+
literal|3
operator|)
argument_list|,
name|val
index|[
literal|2
index|]
operator|&
operator|(
literal|0x7
operator|<<
operator|(
name|i
operator|*
literal|3
operator|)
operator|)
operator|>>
operator|(
name|i
operator|*
literal|3
operator|)
argument_list|,
operator|(
operator|*
name|dcu_base
operator|&
operator|(
literal|0x1f
operator|<<
name|dcu_offset
operator|)
operator|)
operator|>>
name|dcu_offset
argument_list|)
expr_stmt|;
block|}
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"qcu_stitch state:   %2x    qcu_fetch state:        %2x\n"
argument_list|,
operator|(
name|val
index|[
literal|3
index|]
operator|&
literal|0x003c0000
operator|)
operator|>>
literal|18
argument_list|,
operator|(
name|val
index|[
literal|3
index|]
operator|&
literal|0x03c00000
operator|)
operator|>>
literal|22
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"qcu_complete state: %2x    dcu_complete state:     %2x\n"
argument_list|,
operator|(
name|val
index|[
literal|3
index|]
operator|&
literal|0x1c000000
operator|)
operator|>>
literal|26
argument_list|,
operator|(
name|val
index|[
literal|6
index|]
operator|&
literal|0x3
operator|)
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"dcu_arb state:      %2x    dcu_fp state:           %2x\n"
argument_list|,
operator|(
name|val
index|[
literal|5
index|]
operator|&
literal|0x06000000
operator|)
operator|>>
literal|25
argument_list|,
operator|(
name|val
index|[
literal|5
index|]
operator|&
literal|0x38000000
operator|)
operator|>>
literal|27
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"chan_idle_dur:     %3d    chan_idle_dur_valid:     %1d\n"
argument_list|,
operator|(
name|val
index|[
literal|6
index|]
operator|&
literal|0x000003fc
operator|)
operator|>>
literal|2
argument_list|,
operator|(
name|val
index|[
literal|6
index|]
operator|&
literal|0x00000400
operator|)
operator|>>
literal|10
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"txfifo_valid_0:      %1d    txfifo_valid_1:          %1d\n"
argument_list|,
operator|(
name|val
index|[
literal|6
index|]
operator|&
literal|0x00000800
operator|)
operator|>>
literal|11
argument_list|,
operator|(
name|val
index|[
literal|6
index|]
operator|&
literal|0x00001000
operator|)
operator|>>
literal|12
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"txfifo_dcu_num_0:   %2d    txfifo_dcu_num_1:       %2d\n"
argument_list|,
operator|(
name|val
index|[
literal|6
index|]
operator|&
literal|0x0001e000
operator|)
operator|>>
literal|13
argument_list|,
operator|(
name|val
index|[
literal|6
index|]
operator|&
literal|0x001e0000
operator|)
operator|>>
literal|17
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"pcu observe 0x%x \n"
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_OBS_BUS_1
argument_list|)
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"AR_CR 0x%x \n"
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_CR
argument_list|)
argument_list|)
expr_stmt|;
name|ar9300_upload_noise_floor
argument_list|(
name|ah
argument_list|,
literal|1
argument_list|,
name|nfarray
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"2G:\n"
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"Min CCA Out:\n"
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"\t\tChain 0\t\tChain 1\t\tChain 2\n"
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"Control:\t%8d\t%8d\t%8d\n"
argument_list|,
name|nfarray
index|[
literal|0
index|]
argument_list|,
name|nfarray
index|[
literal|1
index|]
argument_list|,
name|nfarray
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"Extension:\t%8d\t%8d\t%8d\n\n"
argument_list|,
name|nfarray
index|[
literal|3
index|]
argument_list|,
name|nfarray
index|[
literal|4
index|]
argument_list|,
name|nfarray
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|ar9300_upload_noise_floor
argument_list|(
name|ah
argument_list|,
literal|0
argument_list|,
name|nfarray
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"5G:\n"
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"Min CCA Out:\n"
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"\t\tChain 0\t\tChain 1\t\tChain 2\n"
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"Control:\t%8d\t%8d\t%8d\n"
argument_list|,
name|nfarray
index|[
literal|0
index|]
argument_list|,
name|nfarray
index|[
literal|1
index|]
argument_list|,
name|nfarray
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"Extension:\t%8d\t%8d\t%8d\n\n"
argument_list|,
name|nfarray
index|[
literal|3
index|]
argument_list|,
name|nfarray
index|[
literal|4
index|]
argument_list|,
name|nfarray
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|HAL_NUM_NF_READINGS
condition|;
name|i
operator|++
control|)
block|{
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"%s Chain %d NF History:\n"
argument_list|,
operator|(
operator|(
name|i
operator|<
literal|3
operator|)
condition|?
literal|"Control "
else|:
literal|"Extension "
operator|)
argument_list|,
name|i
operator|%
literal|3
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
operator|,
name|k
operator|=
name|h
operator|->
name|base
operator|.
name|curr_index
init|;
name|j
operator|<
name|HAL_NF_CAL_HIST_LEN_FULL
condition|;
name|j
operator|++
operator|,
name|k
operator|++
control|)
block|{
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"Element %d: %d\n"
argument_list|,
name|j
argument_list|,
name|h
operator|->
name|nf_cal_buffer
index|[
name|k
operator|%
name|HAL_NF_CAL_HIST_LEN_FULL
index|]
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"Last Programmed NF: %d\n\n"
argument_list|,
name|h
operator|->
name|base
operator|.
name|priv_nf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|reg
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_FIND_SIG_LOW
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"FIRStep Low = 0x%x (%d)\n"
argument_list|,
name|MS
argument_list|(
name|reg
argument_list|,
name|AR_PHY_FIND_SIG_LOW_FIRSTEP_LOW
argument_list|)
argument_list|,
name|MS
argument_list|(
name|reg
argument_list|,
name|AR_PHY_FIND_SIG_LOW_FIRSTEP_LOW
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_DESIRED_SZ
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"Total Desired = 0x%x (%d)\n"
argument_list|,
name|MS
argument_list|(
name|reg
argument_list|,
name|AR_PHY_DESIRED_SZ_TOT_DES
argument_list|)
argument_list|,
name|MS
argument_list|(
name|reg
argument_list|,
name|AR_PHY_DESIRED_SZ_TOT_DES
argument_list|)
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"ADC Desired = 0x%x (%d)\n"
argument_list|,
name|MS
argument_list|(
name|reg
argument_list|,
name|AR_PHY_DESIRED_SZ_ADC
argument_list|)
argument_list|,
name|MS
argument_list|(
name|reg
argument_list|,
name|AR_PHY_DESIRED_SZ_ADC
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_FIND_SIG
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"FIRStep = 0x%x (%d)\n"
argument_list|,
name|MS
argument_list|(
name|reg
argument_list|,
name|AR_PHY_FIND_SIG_FIRSTEP
argument_list|)
argument_list|,
name|MS
argument_list|(
name|reg
argument_list|,
name|AR_PHY_FIND_SIG_FIRSTEP
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_AGC
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"Coarse High = 0x%x (%d)\n"
argument_list|,
name|MS
argument_list|(
name|reg
argument_list|,
name|AR_PHY_AGC_COARSE_HIGH
argument_list|)
argument_list|,
name|MS
argument_list|(
name|reg
argument_list|,
name|AR_PHY_AGC_COARSE_HIGH
argument_list|)
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"Coarse Low = 0x%x (%d)\n"
argument_list|,
name|MS
argument_list|(
name|reg
argument_list|,
name|AR_PHY_AGC_COARSE_LOW
argument_list|)
argument_list|,
name|MS
argument_list|(
name|reg
argument_list|,
name|AR_PHY_AGC_COARSE_LOW
argument_list|)
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"Coarse Power Constant = 0x%x (%d)\n"
argument_list|,
name|MS
argument_list|(
name|reg
argument_list|,
name|AR_PHY_AGC_COARSE_PWR_CONST
argument_list|)
argument_list|,
name|MS
argument_list|(
name|reg
argument_list|,
name|AR_PHY_AGC_COARSE_PWR_CONST
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TIMING5
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"Enable Cyclic Power Thresh = %d\n"
argument_list|,
name|MS
argument_list|(
name|reg
argument_list|,
name|AR_PHY_TIMING5_CYCPWR_THR1_ENABLE
argument_list|)
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"Cyclic Power Thresh = 0x%x (%d)\n"
argument_list|,
name|MS
argument_list|(
name|reg
argument_list|,
name|AR_PHY_TIMING5_CYCPWR_THR1
argument_list|)
argument_list|,
name|MS
argument_list|(
name|reg
argument_list|,
name|AR_PHY_TIMING5_CYCPWR_THR1
argument_list|)
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"Cyclic Power Thresh 1A= 0x%x (%d)\n"
argument_list|,
name|MS
argument_list|(
name|reg
argument_list|,
name|AR_PHY_TIMING5_CYCPWR_THR1A
argument_list|)
argument_list|,
name|MS
argument_list|(
name|reg
argument_list|,
name|AR_PHY_TIMING5_CYCPWR_THR1A
argument_list|)
argument_list|)
expr_stmt|;
name|reg
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_DAG_CTRLCCK
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"Barker RSSI Thresh Enable = %d\n"
argument_list|,
name|MS
argument_list|(
name|reg
argument_list|,
name|AR_PHY_DAG_CTRLCCK_EN_RSSI_THR
argument_list|)
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"Barker RSSI Thresh = 0x%x (%d)\n"
argument_list|,
name|MS
argument_list|(
name|reg
argument_list|,
name|AR_PHY_DAG_CTRLCCK_RSSI_THR
argument_list|)
argument_list|,
name|MS
argument_list|(
name|reg
argument_list|,
name|AR_PHY_DAG_CTRLCCK_RSSI_THR
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Step 1a: Set bit 23 of register 0xa360 to 0 */
name|reg
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
literal|0xa360
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
literal|0x00800000
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa360
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Step 2a: Set register 0xa364 to 0x1000 */
name|reg
operator|=
literal|0x1000
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa364
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Step 3a: Read bits 17:0 of register 0x9c20 */
name|reg
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
literal|0x9c20
argument_list|)
expr_stmt|;
name|reg
operator|&=
literal|0x0003ffff
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"%s: Test Control Status [0x1000] 0x9c20[17:0] = 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Step 1b: Set bit 23 of register 0xa360 to 0 */
name|reg
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
literal|0xa360
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
literal|0x00800000
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa360
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Step 2b: Set register 0xa364 to 0x1400 */
name|reg
operator|=
literal|0x1400
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa364
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Step 3b: Read bits 17:0 of register 0x9c20 */
name|reg
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
literal|0x9c20
argument_list|)
expr_stmt|;
name|reg
operator|&=
literal|0x0003ffff
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"%s: Test Control Status [0x1400] 0x9c20[17:0] = 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Step 1c: Set bit 23 of register 0xa360 to 0 */
name|reg
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
literal|0xa360
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
literal|0x00800000
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa360
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Step 2c: Set register 0xa364 to 0x3C00 */
name|reg
operator|=
literal|0x3c00
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa364
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Step 3c: Read bits 17:0 of register 0x9c20 */
name|reg
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
literal|0x9c20
argument_list|)
expr_stmt|;
name|reg
operator|&=
literal|0x0003ffff
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"%s: Test Control Status [0x3C00] 0x9c20[17:0] = 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Step 1d: Set bit 24 of register 0xa360 to 0 */
name|reg
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
literal|0xa360
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
literal|0x001040000
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa360
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Step 2d: Set register 0xa364 to 0x5005D */
name|reg
operator|=
literal|0x5005D
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa364
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Step 3d: Read bits 17:0 of register 0xa368 */
name|reg
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
literal|0xa368
argument_list|)
expr_stmt|;
name|reg
operator|&=
literal|0x0003ffff
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"%s: Test Control Status [0x5005D] 0xa368[17:0] = 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Step 1e: Set bit 24 of register 0xa360 to 0 */
name|reg
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
literal|0xa360
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
literal|0x001040000
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa360
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Step 2e: Set register 0xa364 to 0x7005D */
name|reg
operator|=
literal|0x7005D
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa364
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Step 3e: Read bits 17:0 of register 0xa368 */
name|reg
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
literal|0xa368
argument_list|)
expr_stmt|;
name|reg
operator|&=
literal|0x0003ffff
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"%s: Test Control Status [0x7005D] 0xa368[17:0] = 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Step 1f: Set bit 24 of register 0xa360 to 0 */
name|reg
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
literal|0xa360
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
literal|0x001000000
expr_stmt|;
name|reg
operator||=
literal|0x40000
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa360
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Step 2f: Set register 0xa364 to 0x3005D */
name|reg
operator|=
literal|0x3005D
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa364
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Step 3f: Read bits 17:0 of register 0xa368 */
name|reg
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
literal|0xa368
argument_list|)
expr_stmt|;
name|reg
operator|&=
literal|0x0003ffff
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"%s: Test Control Status [0x3005D] 0xa368[17:0] = 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Step 1g: Set bit 24 of register 0xa360 to 0 */
name|reg
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
literal|0xa360
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
literal|0x001000000
expr_stmt|;
name|reg
operator||=
literal|0x40000
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa360
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Step 2g: Set register 0xa364 to 0x6005D */
name|reg
operator|=
literal|0x6005D
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa364
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Step 3g: Read bits 17:0 of register 0xa368 */
name|reg
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
literal|0xa368
argument_list|)
expr_stmt|;
name|reg
operator|&=
literal|0x0003ffff
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"%s: Test Control Status [0x6005D] 0xa368[17:0] = 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|reg
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* AH_DEBUG */
block|}
end_function

begin_comment
comment|/*  * Return the busy for rx_frame, rx_clear, and tx_frame  */
end_comment

begin_function
name|u_int32_t
name|ar9300_get_mib_cycle_counts_pct
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int32_t
modifier|*
name|rxc_pcnt
parameter_list|,
name|u_int32_t
modifier|*
name|rxf_pcnt
parameter_list|,
name|u_int32_t
modifier|*
name|txf_pcnt
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|u_int32_t
name|good
init|=
literal|1
decl_stmt|;
name|u_int32_t
name|rc
init|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_RCCNT
argument_list|)
decl_stmt|;
name|u_int32_t
name|rf
init|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_RFCNT
argument_list|)
decl_stmt|;
name|u_int32_t
name|tf
init|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_TFCNT
argument_list|)
decl_stmt|;
name|u_int32_t
name|cc
init|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_CCCNT
argument_list|)
decl_stmt|;
comment|/* read cycles last */
if|if
condition|(
name|ahp
operator|->
name|ah_cycles
operator|==
literal|0
operator|||
name|ahp
operator|->
name|ah_cycles
operator|>
name|cc
condition|)
block|{
comment|/*          * Cycle counter wrap (or initial call); it's not possible          * to accurately calculate a value because the registers          * right shift rather than wrap--so punt and return 0.          */
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_CHANNEL
argument_list|,
literal|"%s: cycle counter wrap. ExtBusy = 0\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|good
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|u_int32_t
name|cc_d
init|=
name|cc
operator|-
name|ahp
operator|->
name|ah_cycles
decl_stmt|;
name|u_int32_t
name|rc_d
init|=
name|rc
operator|-
name|ahp
operator|->
name|ah_rx_clear
decl_stmt|;
name|u_int32_t
name|rf_d
init|=
name|rf
operator|-
name|ahp
operator|->
name|ah_rx_frame
decl_stmt|;
name|u_int32_t
name|tf_d
init|=
name|tf
operator|-
name|ahp
operator|->
name|ah_tx_frame
decl_stmt|;
if|if
condition|(
name|cc_d
operator|!=
literal|0
condition|)
block|{
operator|*
name|rxc_pcnt
operator|=
name|rc_d
operator|*
literal|100
operator|/
name|cc_d
expr_stmt|;
operator|*
name|rxf_pcnt
operator|=
name|rf_d
operator|*
literal|100
operator|/
name|cc_d
expr_stmt|;
operator|*
name|txf_pcnt
operator|=
name|tf_d
operator|*
literal|100
operator|/
name|cc_d
expr_stmt|;
block|}
else|else
block|{
name|good
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|ahp
operator|->
name|ah_cycles
operator|=
name|cc
expr_stmt|;
name|ahp
operator|->
name|ah_rx_frame
operator|=
name|rf
expr_stmt|;
name|ahp
operator|->
name|ah_rx_clear
operator|=
name|rc
expr_stmt|;
name|ahp
operator|->
name|ah_tx_frame
operator|=
name|tf
expr_stmt|;
return|return
name|good
return|;
block|}
end_function

begin_comment
comment|/*  * Return approximation of extension channel busy over an time interval  * 0% (clear) -> 100% (busy)  * -1 for invalid estimate   */
end_comment

begin_function
name|uint32_t
name|ar9300_get_11n_ext_busy
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
comment|/*      * Overflow condition to check before multiplying to get %      * (x * 100> 0xFFFFFFFF ) => (x> 0x28F5C28)      */
define|#
directive|define
name|OVERFLOW_LIMIT
value|0x28F5C28
define|#
directive|define
name|ERROR_CODE
value|-1
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|u_int32_t
name|busy
init|=
literal|0
decl_stmt|;
comment|/* percentage */
name|int8_t
name|busyper
init|=
literal|0
decl_stmt|;
name|u_int32_t
name|cycle_count
decl_stmt|,
name|ctl_busy
decl_stmt|,
name|ext_busy
decl_stmt|;
comment|/* cycle_count will always be the first to wrap; therefore, read it last      * This sequence of reads is not atomic, and MIB counter wrap      * could happen during it ?      */
name|ctl_busy
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_RCCNT
argument_list|)
expr_stmt|;
name|ext_busy
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_EXTRCCNT
argument_list|)
expr_stmt|;
name|cycle_count
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_CCCNT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ahp
operator|->
name|ah_cycle_count
operator|==
literal|0
operator|)
operator|||
operator|(
name|ahp
operator|->
name|ah_cycle_count
operator|>
name|cycle_count
operator|)
operator|||
operator|(
name|ahp
operator|->
name|ah_ctl_busy
operator|>
name|ctl_busy
operator|)
operator|||
operator|(
name|ahp
operator|->
name|ah_ext_busy
operator|>
name|ext_busy
operator|)
condition|)
block|{
comment|/*          * Cycle counter wrap (or initial call); it's not possible          * to accurately calculate a value because the registers          * right shift rather than wrap--so punt and return 0.          */
name|busyper
operator|=
name|ERROR_CODE
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_CHANNEL
argument_list|,
literal|"%s: cycle counter wrap. ExtBusy = 0\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|u_int32_t
name|cycle_delta
init|=
name|cycle_count
operator|-
name|ahp
operator|->
name|ah_cycle_count
decl_stmt|;
name|u_int32_t
name|ext_busy_delta
init|=
name|ext_busy
operator|-
name|ahp
operator|->
name|ah_ext_busy
decl_stmt|;
comment|/*          * Compute extension channel busy percentage          * Overflow condition: 0xFFFFFFFF< ext_busy_delta * 100          * Underflow condition/Divide-by-zero: check that cycle_delta>> 7 != 0          * Will never happen, since (ext_busy_delta< cycle_delta) always,          * and shift necessitated by large ext_busy_delta.          * Due to timing difference to read the registers and counter overflow,          * it may still happen that cycle_delta>> 7 = 0.          *          */
if|if
condition|(
name|cycle_delta
condition|)
block|{
if|if
condition|(
name|ext_busy_delta
operator|>
name|OVERFLOW_LIMIT
condition|)
block|{
if|if
condition|(
name|cycle_delta
operator|>>
literal|7
condition|)
block|{
name|busy
operator|=
operator|(
operator|(
name|ext_busy_delta
operator|>>
literal|7
operator|)
operator|*
literal|100
operator|)
operator|/
operator|(
name|cycle_delta
operator|>>
literal|7
operator|)
expr_stmt|;
block|}
else|else
block|{
name|busyper
operator|=
name|ERROR_CODE
expr_stmt|;
block|}
block|}
else|else
block|{
name|busy
operator|=
operator|(
name|ext_busy_delta
operator|*
literal|100
operator|)
operator|/
name|cycle_delta
expr_stmt|;
block|}
block|}
else|else
block|{
name|busyper
operator|=
name|ERROR_CODE
expr_stmt|;
block|}
if|if
condition|(
name|busy
operator|>
literal|100
condition|)
block|{
name|busy
operator|=
literal|100
expr_stmt|;
block|}
if|if
condition|(
name|busyper
operator|!=
name|ERROR_CODE
condition|)
block|{
name|busyper
operator|=
name|busy
expr_stmt|;
block|}
block|}
name|ahp
operator|->
name|ah_cycle_count
operator|=
name|cycle_count
expr_stmt|;
name|ahp
operator|->
name|ah_ctl_busy
operator|=
name|ctl_busy
expr_stmt|;
name|ahp
operator|->
name|ah_ext_busy
operator|=
name|ext_busy
expr_stmt|;
return|return
name|busyper
return|;
undef|#
directive|undef
name|OVERFLOW_LIMIT
undef|#
directive|undef
name|ERROR_CODE
block|}
end_function

begin_comment
comment|/* BB Panic Watchdog declarations */
end_comment

begin_define
define|#
directive|define
name|HAL_BB_PANIC_WD_HT20_FACTOR
value|74
end_define

begin_comment
comment|/* 0.74 */
end_comment

begin_define
define|#
directive|define
name|HAL_BB_PANIC_WD_HT40_FACTOR
value|37
end_define

begin_comment
comment|/* 0.37 */
end_comment

begin_function
name|void
name|ar9300_config_bb_panic_watchdog
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
define|#
directive|define
name|HAL_BB_PANIC_IDLE_TIME_OUT
value|0x0a8c0000
specifier|const
name|struct
name|ieee80211_channel
modifier|*
name|chan
init|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_curchan
decl_stmt|;
name|u_int32_t
name|idle_tmo_ms
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_bb_panic_timeout_ms
decl_stmt|;
name|u_int32_t
name|val
decl_stmt|,
name|idle_count
decl_stmt|;
if|if
condition|(
name|idle_tmo_ms
operator|!=
literal|0
condition|)
block|{
comment|/* enable IRQ, disable chip-reset for BB panic */
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PANIC_WD_CTL_2
argument_list|)
operator|&
name|AR_PHY_BB_PANIC_CNTL2_MASK
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PANIC_WD_CTL_2
argument_list|,
operator|(
name|val
operator||
name|AR_PHY_BB_PANIC_IRQ_ENABLE
operator|)
operator|&
operator|~
name|AR_PHY_BB_PANIC_RST_ENABLE
argument_list|)
expr_stmt|;
comment|/* bound limit to 10 secs */
if|if
condition|(
name|idle_tmo_ms
operator|>
literal|10000
condition|)
block|{
name|idle_tmo_ms
operator|=
literal|10000
expr_stmt|;
block|}
if|if
condition|(
name|chan
operator|!=
name|AH_NULL
operator|&&
name|IEEE80211_IS_CHAN_HT40
argument_list|(
name|chan
argument_list|)
condition|)
block|{
name|idle_count
operator|=
operator|(
literal|100
operator|*
name|idle_tmo_ms
operator|)
operator|/
name|HAL_BB_PANIC_WD_HT40_FACTOR
expr_stmt|;
block|}
else|else
block|{
name|idle_count
operator|=
operator|(
literal|100
operator|*
name|idle_tmo_ms
operator|)
operator|/
name|HAL_BB_PANIC_WD_HT20_FACTOR
expr_stmt|;
block|}
comment|/*          * enable panic in non-IDLE mode,          * disable in IDLE mode,          * set idle time-out          */
comment|// EV92527 : Enable IDLE mode panic
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PANIC_WD_CTL_1
argument_list|,
name|AR_PHY_BB_PANIC_NON_IDLE_ENABLE
operator||
name|AR_PHY_BB_PANIC_IDLE_ENABLE
operator||
operator|(
name|AR_PHY_BB_PANIC_IDLE_MASK
operator|&
name|HAL_BB_PANIC_IDLE_TIME_OUT
operator|)
operator||
operator|(
name|AR_PHY_BB_PANIC_NON_IDLE_MASK
operator|&
operator|(
name|idle_count
operator|<<
literal|2
operator|)
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* disable IRQ, disable chip-reset for BB panic */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PANIC_WD_CTL_2
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PANIC_WD_CTL_2
argument_list|)
operator|&
operator|~
operator|(
name|AR_PHY_BB_PANIC_RST_ENABLE
operator||
name|AR_PHY_BB_PANIC_IRQ_ENABLE
operator|)
argument_list|)
expr_stmt|;
comment|/* disable panic in non-IDLE mode, disable in IDLE mode */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PANIC_WD_CTL_1
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PANIC_WD_CTL_1
argument_list|)
operator|&
operator|~
operator|(
name|AR_PHY_BB_PANIC_NON_IDLE_ENABLE
operator||
name|AR_PHY_BB_PANIC_IDLE_ENABLE
operator|)
argument_list|)
expr_stmt|;
block|}
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_RFPARAM
argument_list|,
literal|"%s: %s BB Panic Watchdog tmo=%ums\n"
argument_list|,
name|__func__
argument_list|,
name|idle_tmo_ms
condition|?
literal|"Enabled"
else|:
literal|"Disabled"
argument_list|,
name|idle_tmo_ms
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|HAL_BB_PANIC_IDLE_TIME_OUT
block|}
end_function

begin_function
name|void
name|ar9300_handle_bb_panic
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|u_int32_t
name|status
decl_stmt|;
comment|/*      * we want to avoid printing in ISR context so we save       * panic watchdog status to be printed later in DPC context      */
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_bb_panic_last_status
operator|=
name|status
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PANIC_WD_STATUS
argument_list|)
expr_stmt|;
comment|/*      * panic watchdog timer should reset on status read      * but to make sure we write 0 to the watchdog status bit      */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PANIC_WD_STATUS
argument_list|,
name|status
operator|&
operator|~
name|AR_PHY_BB_WD_STATUS_CLR
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ar9300_get_bb_panic_info
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|hal_bb_panic_info
modifier|*
name|bb_panic
parameter_list|)
block|{
name|bb_panic
operator|->
name|status
operator|=
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_bb_panic_last_status
expr_stmt|;
comment|/*      * For signature 04000539 do not print anything.      * This is a very common occurence as a compromise between      * BB Panic and AH_FALSE detects (EV71009). It indicates       * radar hang, which can be cleared by reprogramming      * radar related register and does not requre a chip reset       */
comment|/* Suppress BB Status mesg following signature */
switch|switch
condition|(
name|bb_panic
operator|->
name|status
condition|)
block|{
case|case
literal|0x04000539
case|:
case|case
literal|0x04008009
case|:
case|case
literal|0x04000b09
case|:
case|case
literal|0x1300000a
case|:
return|return
operator|-
literal|1
return|;
block|}
name|bb_panic
operator|->
name|tsf
operator|=
name|ar9300_get_tsf32
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|bb_panic
operator|->
name|wd
operator|=
name|MS
argument_list|(
name|bb_panic
operator|->
name|status
argument_list|,
name|AR_PHY_BB_WD_STATUS
argument_list|)
expr_stmt|;
name|bb_panic
operator|->
name|det
operator|=
name|MS
argument_list|(
name|bb_panic
operator|->
name|status
argument_list|,
name|AR_PHY_BB_WD_DET_HANG
argument_list|)
expr_stmt|;
name|bb_panic
operator|->
name|rdar
operator|=
name|MS
argument_list|(
name|bb_panic
operator|->
name|status
argument_list|,
name|AR_PHY_BB_WD_RADAR_SM
argument_list|)
expr_stmt|;
name|bb_panic
operator|->
name|r_odfm
operator|=
name|MS
argument_list|(
name|bb_panic
operator|->
name|status
argument_list|,
name|AR_PHY_BB_WD_RX_OFDM_SM
argument_list|)
expr_stmt|;
name|bb_panic
operator|->
name|r_cck
operator|=
name|MS
argument_list|(
name|bb_panic
operator|->
name|status
argument_list|,
name|AR_PHY_BB_WD_RX_CCK_SM
argument_list|)
expr_stmt|;
name|bb_panic
operator|->
name|t_odfm
operator|=
name|MS
argument_list|(
name|bb_panic
operator|->
name|status
argument_list|,
name|AR_PHY_BB_WD_TX_OFDM_SM
argument_list|)
expr_stmt|;
name|bb_panic
operator|->
name|t_cck
operator|=
name|MS
argument_list|(
name|bb_panic
operator|->
name|status
argument_list|,
name|AR_PHY_BB_WD_TX_CCK_SM
argument_list|)
expr_stmt|;
name|bb_panic
operator|->
name|agc
operator|=
name|MS
argument_list|(
name|bb_panic
operator|->
name|status
argument_list|,
name|AR_PHY_BB_WD_AGC_SM
argument_list|)
expr_stmt|;
name|bb_panic
operator|->
name|src
operator|=
name|MS
argument_list|(
name|bb_panic
operator|->
name|status
argument_list|,
name|AR_PHY_BB_WD_SRCH_SM
argument_list|)
expr_stmt|;
name|bb_panic
operator|->
name|phy_panic_wd_ctl1
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PANIC_WD_CTL_1
argument_list|)
expr_stmt|;
name|bb_panic
operator|->
name|phy_panic_wd_ctl2
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PANIC_WD_CTL_2
argument_list|)
expr_stmt|;
name|bb_panic
operator|->
name|phy_gen_ctrl
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_GEN_CTRL
argument_list|)
expr_stmt|;
name|bb_panic
operator|->
name|rxc_pcnt
operator|=
name|bb_panic
operator|->
name|rxf_pcnt
operator|=
name|bb_panic
operator|->
name|txf_pcnt
operator|=
literal|0
expr_stmt|;
name|bb_panic
operator|->
name|cycles
operator|=
name|ar9300_get_mib_cycle_counts_pct
argument_list|(
name|ah
argument_list|,
operator|&
name|bb_panic
operator|->
name|rxc_pcnt
argument_list|,
operator|&
name|bb_panic
operator|->
name|rxf_pcnt
argument_list|,
operator|&
name|bb_panic
operator|->
name|txf_pcnt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_show_bb_panic
condition|)
block|{
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"\n==== BB update: BB status=0x%08x, "
literal|"tsf=0x%08x ====\n"
argument_list|,
name|bb_panic
operator|->
name|status
argument_list|,
name|bb_panic
operator|->
name|tsf
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"** BB state: wd=%u det=%u rdar=%u rOFDM=%d "
literal|"rCCK=%u tOFDM=%u tCCK=%u agc=%u src=%u **\n"
argument_list|,
name|bb_panic
operator|->
name|wd
argument_list|,
name|bb_panic
operator|->
name|det
argument_list|,
name|bb_panic
operator|->
name|rdar
argument_list|,
name|bb_panic
operator|->
name|r_odfm
argument_list|,
name|bb_panic
operator|->
name|r_cck
argument_list|,
name|bb_panic
operator|->
name|t_odfm
argument_list|,
name|bb_panic
operator|->
name|t_cck
argument_list|,
name|bb_panic
operator|->
name|agc
argument_list|,
name|bb_panic
operator|->
name|src
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"** BB WD cntl: cntl1=0x%08x cntl2=0x%08x **\n"
argument_list|,
name|bb_panic
operator|->
name|phy_panic_wd_ctl1
argument_list|,
name|bb_panic
operator|->
name|phy_panic_wd_ctl2
argument_list|)
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"** BB mode: BB_gen_controls=0x%08x **\n"
argument_list|,
name|bb_panic
operator|->
name|phy_gen_ctrl
argument_list|)
expr_stmt|;
if|if
condition|(
name|bb_panic
operator|->
name|cycles
condition|)
block|{
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"** BB busy times: rx_clear=%d%%, "
literal|"rx_frame=%d%%, tx_frame=%d%% **\n"
argument_list|,
name|bb_panic
operator|->
name|rxc_pcnt
argument_list|,
name|bb_panic
operator|->
name|rxf_pcnt
argument_list|,
name|bb_panic
operator|->
name|txf_pcnt
argument_list|)
expr_stmt|;
block|}
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"==== BB update: done ====\n\n"
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
comment|//The returned data will be stored for athstats to retrieve it
block|}
end_function

begin_comment
comment|/* set the reason for HAL reset */
end_comment

begin_function
name|void
name|ar9300_set_hal_reset_reason
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int8_t
name|resetreason
parameter_list|)
block|{
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_reset_reason
operator|=
name|resetreason
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Configure 20/40 operation  *  * 20/40 = joint rx clear (control and extension)  * 20    = rx clear (control)  *  * - NOTE: must stop MAC (tx) and requeue 40 MHz packets as 20 MHz  *         when changing from 20/40 => 20 only  */
end_comment

begin_function
name|void
name|ar9300_set_11n_mac2040
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_HT_MACMODE
name|mode
parameter_list|)
block|{
name|u_int32_t
name|macmode
decl_stmt|;
comment|/* Configure MAC for 20/40 operation */
if|if
condition|(
name|mode
operator|==
name|HAL_HT_MACMODE_2040
operator|&&
operator|!
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_cwm_ignore_ext_cca
condition|)
block|{
name|macmode
operator|=
name|AR_2040_JOINED_RX_CLEAR
expr_stmt|;
block|}
else|else
block|{
name|macmode
operator|=
literal|0
expr_stmt|;
block|}
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_2040_MODE
argument_list|,
name|macmode
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Get Rx clear (control/extension channel)  *  * Returns active low (busy) for ctrl/ext channel  * Owl 2.0  */
end_comment

begin_function
name|HAL_HT_RXCLEAR
name|ar9300_get_11n_rx_clear
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|HAL_HT_RXCLEAR
name|rxclear
init|=
literal|0
decl_stmt|;
name|u_int32_t
name|val
decl_stmt|;
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_DIAG_SW
argument_list|)
expr_stmt|;
comment|/* control channel */
if|if
condition|(
name|val
operator|&
name|AR_DIAG_RX_CLEAR_CTL_LOW
condition|)
block|{
name|rxclear
operator||=
name|HAL_RX_CLEAR_CTL_LOW
expr_stmt|;
block|}
comment|/* extension channel */
if|if
condition|(
name|val
operator|&
name|AR_DIAG_RX_CLEAR_EXT_LOW
condition|)
block|{
name|rxclear
operator||=
name|HAL_RX_CLEAR_EXT_LOW
expr_stmt|;
block|}
return|return
name|rxclear
return|;
block|}
end_function

begin_comment
comment|/*  * Set Rx clear (control/extension channel)  *  * Useful for forcing the channel to appear busy for  * debugging/diagnostics  * Owl 2.0  */
end_comment

begin_function
name|void
name|ar9300_set_11n_rx_clear
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_HT_RXCLEAR
name|rxclear
parameter_list|)
block|{
comment|/* control channel */
if|if
condition|(
name|rxclear
operator|&
name|HAL_RX_CLEAR_CTL_LOW
condition|)
block|{
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_DIAG_SW
argument_list|,
name|AR_DIAG_RX_CLEAR_CTL_LOW
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_DIAG_SW
argument_list|,
name|AR_DIAG_RX_CLEAR_CTL_LOW
argument_list|)
expr_stmt|;
block|}
comment|/* extension channel */
if|if
condition|(
name|rxclear
operator|&
name|HAL_RX_CLEAR_EXT_LOW
condition|)
block|{
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_DIAG_SW
argument_list|,
name|AR_DIAG_RX_CLEAR_EXT_LOW
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_DIAG_SW
argument_list|,
name|AR_DIAG_RX_CLEAR_EXT_LOW
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * HAL support code for force ppm tracking workaround.  */
end_comment

begin_function
name|u_int32_t
name|ar9300_ppm_get_rssi_dump
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|u_int32_t
name|retval
decl_stmt|;
name|u_int32_t
name|off1
decl_stmt|;
name|u_int32_t
name|off2
decl_stmt|;
if|if
condition|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_ANALOG_SWAP
argument_list|)
operator|&
name|AR_PHY_SWAP_ALT_CHAIN
condition|)
block|{
name|off1
operator|=
literal|0x2000
expr_stmt|;
name|off2
operator|=
literal|0x1000
expr_stmt|;
block|}
else|else
block|{
name|off1
operator|=
literal|0x1000
expr_stmt|;
name|off2
operator|=
literal|0x2000
expr_stmt|;
block|}
name|retval
operator|=
operator|(
operator|(
literal|0xff
operator|&
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CHAN_INFO_GAIN_0
argument_list|)
operator|)
operator|<<
literal|0
operator|)
operator||
operator|(
operator|(
literal|0xff
operator|&
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CHAN_INFO_GAIN_0
operator|+
name|off1
argument_list|)
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
literal|0xff
operator|&
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CHAN_INFO_GAIN_0
operator|+
name|off2
argument_list|)
operator|)
operator|<<
literal|16
operator|)
expr_stmt|;
return|return
name|retval
return|;
block|}
end_function

begin_function
name|u_int32_t
name|ar9300_ppm_force
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|u_int32_t
name|data_fine
decl_stmt|;
name|u_int32_t
name|data4
decl_stmt|;
comment|//u_int32_t off1;
comment|//u_int32_t off2;
name|HAL_BOOL
name|signed_val
init|=
name|AH_FALSE
decl_stmt|;
comment|//    if (OS_REG_READ(ah, AR_PHY_ANALOG_SWAP)& AR_PHY_SWAP_ALT_CHAIN) {
comment|//        off1 = 0x2000;
comment|//        off2 = 0x1000;
comment|//    } else {
comment|//        off1 = 0x1000;
comment|//        off2 = 0x2000;
comment|//    }
name|data_fine
operator|=
name|AR_PHY_CHAN_INFO_GAIN_DIFF_PPM_MASK
operator|&
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CHNINFO_GAINDIFF
argument_list|)
expr_stmt|;
comment|/*      * bit [11-0] is new ppm value. bit 11 is the signed bit.      * So check value from bit[10:0].      * Now get the abs val of the ppm value read in bit[0:11].      * After that do bound check on abs value.      * if value is off limit, CAP the value and and restore signed bit.      */
if|if
condition|(
name|data_fine
operator|&
name|AR_PHY_CHAN_INFO_GAIN_DIFF_PPM_SIGNED_BIT
condition|)
block|{
comment|/* get the positive value */
name|data_fine
operator|=
operator|(
operator|~
name|data_fine
operator|+
literal|1
operator|)
operator|&
name|AR_PHY_CHAN_INFO_GAIN_DIFF_PPM_MASK
expr_stmt|;
name|signed_val
operator|=
name|AH_TRUE
expr_stmt|;
block|}
if|if
condition|(
name|data_fine
operator|>
name|AR_PHY_CHAN_INFO_GAIN_DIFF_UPPER_LIMIT
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_REGIO
argument_list|,
literal|"%s Correcting ppm out of range %x\n"
argument_list|,
name|__func__
argument_list|,
operator|(
name|data_fine
operator|&
literal|0x7ff
operator|)
argument_list|)
expr_stmt|;
name|data_fine
operator|=
name|AR_PHY_CHAN_INFO_GAIN_DIFF_UPPER_LIMIT
expr_stmt|;
block|}
comment|/*      * Restore signed value if changed above.      * Use typecast to avoid compilation errors      */
if|if
condition|(
name|signed_val
condition|)
block|{
name|data_fine
operator|=
operator|(
operator|-
operator|(
name|int32_t
operator|)
name|data_fine
operator|)
operator|&
name|AR_PHY_CHAN_INFO_GAIN_DIFF_PPM_MASK
expr_stmt|;
block|}
comment|/* write value */
name|data4
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TIMING2
argument_list|)
operator|&
operator|~
operator|(
name|AR_PHY_TIMING2_USE_FORCE_PPM
operator||
name|AR_PHY_TIMING2_FORCE_PPM_VAL
operator|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TIMING2
argument_list|,
name|data4
operator||
name|data_fine
operator||
name|AR_PHY_TIMING2_USE_FORCE_PPM
argument_list|)
expr_stmt|;
return|return
name|data_fine
return|;
block|}
end_function

begin_function
name|void
name|ar9300_ppm_un_force
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|u_int32_t
name|data4
decl_stmt|;
name|data4
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TIMING2
argument_list|)
operator|&
operator|~
name|AR_PHY_TIMING2_USE_FORCE_PPM
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TIMING2
argument_list|,
name|data4
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u_int32_t
name|ar9300_ppm_arm_trigger
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|u_int32_t
name|val
decl_stmt|;
name|u_int32_t
name|ret
decl_stmt|;
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CHAN_INFO_MEMORY
argument_list|)
expr_stmt|;
name|ret
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_TSF_L32
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CHAN_INFO_MEMORY
argument_list|,
name|val
operator||
name|AR_PHY_CHAN_INFO_MEMORY_CAPTURE_MASK
argument_list|)
expr_stmt|;
comment|/* return low word of TSF at arm time */
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|ar9300_ppm_get_trigger
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
if|if
condition|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CHAN_INFO_MEMORY
argument_list|)
operator|&
name|AR_PHY_CHAN_INFO_MEMORY_CAPTURE_MASK
condition|)
block|{
comment|/* has not triggered yet, return AH_FALSE */
return|return
literal|0
return|;
block|}
comment|/* else triggered, return AH_TRUE */
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|ar9300_mark_phy_inactive
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_ACTIVE
argument_list|,
name|AR_PHY_ACTIVE_DIS
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* DEBUG */
end_comment

begin_function
name|u_int32_t
name|ar9300_ppm_get_force_state
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
return|return
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TIMING2
argument_list|)
operator|&
operator|(
name|AR_PHY_TIMING2_USE_FORCE_PPM
operator||
name|AR_PHY_TIMING2_FORCE_PPM_VAL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Return the Cycle counts for rx_frame, rx_clear, and tx_frame  */
end_comment

begin_function
name|HAL_BOOL
name|ar9300_get_mib_cycle_counts
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_SURVEY_SAMPLE
modifier|*
name|hs
parameter_list|)
block|{
comment|/*      * XXX FreeBSD todo: reimplement this      */
if|#
directive|if
literal|0
block|p_cnts->tx_frame_count = OS_REG_READ(ah, AR_TFCNT);     p_cnts->rx_frame_count = OS_REG_READ(ah, AR_RFCNT);     p_cnts->rx_clear_count = OS_REG_READ(ah, AR_RCCNT);     p_cnts->cycle_count   = OS_REG_READ(ah, AR_CCCNT);     p_cnts->is_tx_active   = (OS_REG_READ(ah, AR_TFCNT) ==                            p_cnts->tx_frame_count) ? AH_FALSE : AH_TRUE;     p_cnts->is_rx_active   = (OS_REG_READ(ah, AR_RFCNT) ==                            p_cnts->rx_frame_count) ? AH_FALSE : AH_TRUE;
endif|#
directive|endif
return|return
name|AH_FALSE
return|;
block|}
end_function

begin_function
name|void
name|ar9300_clear_mib_counters
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|u_int32_t
name|reg_val
decl_stmt|;
name|reg_val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_MIBC
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MIBC
argument_list|,
name|reg_val
operator||
name|AR_MIBC_CMC
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MIBC
argument_list|,
name|reg_val
operator|&
operator|~
name|AR_MIBC_CMC
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Enable or Disable RIFS Rx capability as part of SW WAR for Bug 31602 */
end_comment

begin_function
name|HAL_BOOL
name|ar9300_set_rifs_delay
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|enable
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HAL_CHANNEL_INTERNAL
modifier|*
name|ichan
init|=
name|ath_hal_checkchannel
argument_list|(
name|ah
argument_list|,
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_curchan
argument_list|)
decl_stmt|;
name|HAL_BOOL
name|is_chan_2g
init|=
name|IS_CHAN_2GHZ
argument_list|(
name|ichan
argument_list|)
decl_stmt|;
name|u_int32_t
name|tmp
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|enable
condition|)
block|{
if|if
condition|(
name|ahp
operator|->
name|ah_rifs_enabled
operator|==
name|AH_TRUE
condition|)
block|{
return|return
name|AH_TRUE
return|;
block|}
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_SEARCH_START_DELAY
argument_list|,
name|ahp
operator|->
name|ah_rifs_reg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_RIFS_SRCH
argument_list|,
name|ahp
operator|->
name|ah_rifs_reg
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|ah_rifs_enabled
operator|=
name|AH_TRUE
expr_stmt|;
name|OS_MEMZERO
argument_list|(
name|ahp
operator|->
name|ah_rifs_reg
argument_list|,
sizeof|sizeof
argument_list|(
name|ahp
operator|->
name|ah_rifs_reg
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ahp
operator|->
name|ah_rifs_enabled
operator|==
name|AH_TRUE
condition|)
block|{
name|ahp
operator|->
name|ah_rifs_reg
index|[
literal|0
index|]
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_SEARCH_START_DELAY
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|ah_rifs_reg
index|[
literal|1
index|]
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_RIFS_SRCH
argument_list|)
expr_stmt|;
block|}
comment|/* Change rifs init delay to 0 */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_RIFS_SRCH
argument_list|,
operator|(
name|ahp
operator|->
name|ah_rifs_reg
index|[
literal|1
index|]
operator|&
operator|~
operator|(
name|AR_PHY_RIFS_INIT_DELAY
operator|)
operator|)
argument_list|)
expr_stmt|;
name|tmp
operator|=
literal|0xfffff000
operator|&
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_SEARCH_START_DELAY
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_chan_2g
condition|)
block|{
if|if
condition|(
name|IEEE80211_IS_CHAN_HT40
argument_list|(
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_curchan
argument_list|)
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_SEARCH_START_DELAY
argument_list|,
name|tmp
operator||
literal|500
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Sowl 2G HT-20 default is 0x134 for search start delay */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_SEARCH_START_DELAY
argument_list|,
name|tmp
operator||
literal|250
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|IEEE80211_IS_CHAN_HT40
argument_list|(
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_curchan
argument_list|)
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_SEARCH_START_DELAY
argument_list|,
name|tmp
operator||
literal|0x370
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Sowl 5G HT-20 default is 0x1b8 for search start delay */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_SEARCH_START_DELAY
argument_list|,
name|tmp
operator||
literal|0x1b8
argument_list|)
expr_stmt|;
block|}
block|}
name|ahp
operator|->
name|ah_rifs_enabled
operator|=
name|AH_FALSE
expr_stmt|;
block|}
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_comment
comment|/* ar9300_set_rifs_delay () */
end_comment

begin_comment
comment|/* Set the current RIFS Rx setting */
end_comment

begin_function
name|HAL_BOOL
name|ar9300_set_11n_rx_rifs
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|enable
parameter_list|)
block|{
comment|/* Non-Owl 11n chips */
if|if
condition|(
operator|(
name|ath_hal_getcapability
argument_list|(
name|ah
argument_list|,
name|HAL_CAP_RIFS_RX
argument_list|,
literal|0
argument_list|,
name|AH_NULL
argument_list|)
operator|==
name|HAL_OK
operator|)
condition|)
block|{
if|if
condition|(
name|ar9300_get_capability
argument_list|(
name|ah
argument_list|,
name|HAL_CAP_LDPCWAR
argument_list|,
literal|0
argument_list|,
name|AH_NULL
argument_list|)
operator|==
name|HAL_OK
condition|)
block|{
return|return
name|ar9300_set_rifs_delay
argument_list|(
name|ah
argument_list|,
name|enable
argument_list|)
return|;
block|}
return|return
name|AH_FALSE
return|;
block|}
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_comment
comment|/* ar9300_set_11n_rx_rifs () */
end_comment

begin_function
specifier|static
name|hal_mac_hangs_t
name|ar9300_compare_dbg_hang
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|mac_dbg_regs_t
name|mac_dbg
parameter_list|,
name|hal_mac_hang_check_t
name|hang_check
parameter_list|,
name|hal_mac_hangs_t
name|hangs
parameter_list|,
name|u_int8_t
modifier|*
name|dcu_chain
parameter_list|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
name|hal_mac_hangs_t
name|found_hangs
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|hangs
operator|&
name|dcu_chain_state
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
operator|(
name|mac_dbg
operator|.
name|dma_dbg_4
operator|>>
operator|(
literal|5
operator|*
name|i
operator|)
operator|)
operator|&
literal|0x1f
operator|)
operator|==
name|hang_check
operator|.
name|dcu_chain_state
condition|)
block|{
name|found_hangs
operator||=
name|dcu_chain_state
expr_stmt|;
operator|*
name|dcu_chain
operator|=
name|i
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
operator|(
name|mac_dbg
operator|.
name|dma_dbg_5
operator|>>
operator|(
literal|5
operator|*
name|i
operator|)
operator|)
operator|&
literal|0x1f
operator|)
operator|==
name|hang_check
operator|.
name|dcu_chain_state
condition|)
block|{
name|found_hangs
operator||=
name|dcu_chain_state
expr_stmt|;
operator|*
name|dcu_chain
operator|=
name|i
operator|+
literal|6
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|hangs
operator|&
name|dcu_complete_state
condition|)
block|{
if|if
condition|(
operator|(
name|mac_dbg
operator|.
name|dma_dbg_6
operator|&
literal|0x3
operator|)
operator|==
name|hang_check
operator|.
name|dcu_complete_state
condition|)
block|{
name|found_hangs
operator||=
name|dcu_complete_state
expr_stmt|;
block|}
block|}
return|return
name|found_hangs
return|;
block|}
end_function

begin_comment
comment|/* end - ar9300_compare_dbg_hang */
end_comment

begin_define
define|#
directive|define
name|NUM_STATUS_READS
value|50
end_define

begin_function
name|HAL_BOOL
name|ar9300_detect_mac_hang
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|mac_dbg_regs_t
name|mac_dbg
decl_stmt|;
name|hal_mac_hang_check_t
name|hang_sig1_val
init|=
block|{
literal|0x6
block|,
literal|0x1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|hal_mac_hangs_t
name|hang_sig1
init|=
operator|(
name|dcu_chain_state
operator||
name|dcu_complete_state
operator|)
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|u_int8_t
name|dcu_chain
init|=
literal|0
decl_stmt|,
name|current_dcu_chain_state
decl_stmt|,
name|shift_val
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ahp
operator|->
name|ah_hang_wars
operator|&
name|HAL_MAC_HANG_WAR
operator|)
condition|)
block|{
return|return
name|AH_FALSE
return|;
block|}
name|OS_MEMZERO
argument_list|(
operator|&
name|mac_dbg
argument_list|,
sizeof|sizeof
argument_list|(
name|mac_dbg
argument_list|)
argument_list|)
expr_stmt|;
name|mac_dbg
operator|.
name|dma_dbg_4
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_DMADBG_4
argument_list|)
expr_stmt|;
name|mac_dbg
operator|.
name|dma_dbg_5
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_DMADBG_5
argument_list|)
expr_stmt|;
name|mac_dbg
operator|.
name|dma_dbg_6
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_DMADBG_6
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_DFS
argument_list|,
literal|" dma regs: %X %X %X \n"
argument_list|,
name|mac_dbg
operator|.
name|dma_dbg_4
argument_list|,
name|mac_dbg
operator|.
name|dma_dbg_5
argument_list|,
name|mac_dbg
operator|.
name|dma_dbg_6
argument_list|)
expr_stmt|;
if|if
condition|(
name|hang_sig1
operator|!=
name|ar9300_compare_dbg_hang
argument_list|(
name|ah
argument_list|,
name|mac_dbg
argument_list|,
name|hang_sig1_val
argument_list|,
name|hang_sig1
argument_list|,
operator|&
name|dcu_chain
argument_list|)
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_DFS
argument_list|,
literal|" hang sig1 not found \n"
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
block|}
name|shift_val
operator|=
operator|(
name|dcu_chain
operator|>=
literal|6
operator|)
condition|?
operator|(
name|dcu_chain
operator|-
literal|6
operator|)
else|:
operator|(
name|dcu_chain
operator|)
expr_stmt|;
name|shift_val
operator|*=
literal|5
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|NUM_STATUS_READS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|dcu_chain
operator|<
literal|6
condition|)
block|{
name|mac_dbg
operator|.
name|dma_dbg_4
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_DMADBG_4
argument_list|)
expr_stmt|;
name|current_dcu_chain_state
operator|=
operator|(
operator|(
name|mac_dbg
operator|.
name|dma_dbg_4
operator|>>
name|shift_val
operator|)
operator|&
literal|0x1f
operator|)
expr_stmt|;
block|}
else|else
block|{
name|mac_dbg
operator|.
name|dma_dbg_5
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_DMADBG_5
argument_list|)
expr_stmt|;
name|current_dcu_chain_state
operator|=
operator|(
operator|(
name|mac_dbg
operator|.
name|dma_dbg_5
operator|>>
name|shift_val
operator|)
operator|&
literal|0x1f
operator|)
expr_stmt|;
block|}
name|mac_dbg
operator|.
name|dma_dbg_6
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_DMADBG_6
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|mac_dbg
operator|.
name|dma_dbg_6
operator|&
literal|0x3
operator|)
operator|!=
name|hang_sig1_val
operator|.
name|dcu_complete_state
operator|)
operator|||
operator|(
name|current_dcu_chain_state
operator|!=
name|hang_sig1_val
operator|.
name|dcu_chain_state
operator|)
condition|)
block|{
return|return
name|AH_FALSE
return|;
block|}
block|}
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_DFS
argument_list|,
literal|"%s sig5count=%d sig6count=%d "
argument_list|,
name|__func__
argument_list|,
name|ahp
operator|->
name|ah_hang
index|[
name|MAC_HANG_SIG1
index|]
argument_list|,
name|ahp
operator|->
name|ah_hang
index|[
name|MAC_HANG_SIG2
index|]
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|ah_hang
index|[
name|MAC_HANG_SIG1
index|]
operator|++
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_comment
comment|/* end - ar9300_detect_mac_hang */
end_comment

begin_comment
comment|/* Determine if the baseband is hung by reading the Observation Bus Register */
end_comment

begin_function
name|HAL_BOOL
name|ar9300_detect_bb_hang
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
define|#
directive|define
name|N
parameter_list|(
name|a
parameter_list|)
value|(sizeof(a) / sizeof(a[0]))
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|u_int32_t
name|hang_sig
init|=
literal|0
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
comment|/* Check the PCU Observation Bus 1 register (0x806c) NUM_STATUS_READS times      *      * 4 known BB hang signatures -      * [1] bits 8,9,11 are 0. State machine state (bits 25-31) is 0x1E      * [2] bits 8,9 are 1, bit 11 is 0. State machine state (bits 25-31) is 0x52      * [3] bits 8,9 are 1, bit 11 is 0. State machine state (bits 25-31) is 0x18      * [4] bit 10 is 1, bit 11 is 0. WEP state (bits 12-17) is 0x2,      *     Rx State (bits 20-24) is 0x7.      */
name|hal_hw_hang_check_t
name|hang_list
index|[]
init|=
block|{
comment|/* Offset        Reg Value   Reg Mask    Hang Offset */
block|{
name|AR_OBS_BUS_1
block|,
literal|0x1E000000
block|,
literal|0x7E000B00
block|,
name|BB_HANG_SIG1
block|}
block|,
block|{
name|AR_OBS_BUS_1
block|,
literal|0x52000B00
block|,
literal|0x7E000B00
block|,
name|BB_HANG_SIG2
block|}
block|,
block|{
name|AR_OBS_BUS_1
block|,
literal|0x18000B00
block|,
literal|0x7E000B00
block|,
name|BB_HANG_SIG3
block|}
block|,
block|{
name|AR_OBS_BUS_1
block|,
literal|0x00702400
block|,
literal|0x7E7FFFEF
block|,
name|BB_HANG_SIG4
block|}
block|}
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ahp
operator|->
name|ah_hang_wars
operator|&
operator|(
name|HAL_RIFS_BB_HANG_WAR
operator||
name|HAL_DFS_BB_HANG_WAR
operator||
name|HAL_RX_STUCK_LOW_BB_HANG_WAR
operator|)
operator|)
condition|)
block|{
return|return
name|AH_FALSE
return|;
block|}
name|hang_sig
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_OBS_BUS_1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|NUM_STATUS_READS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|hang_sig
operator|!=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_OBS_BUS_1
argument_list|)
condition|)
block|{
return|return
name|AH_FALSE
return|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
argument_list|(
name|hang_list
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|hang_sig
operator|&
name|hang_list
index|[
name|i
index|]
operator|.
name|hang_mask
operator|)
operator|==
name|hang_list
index|[
name|i
index|]
operator|.
name|hang_val
condition|)
block|{
name|ahp
operator|->
name|ah_hang
index|[
name|hang_list
index|[
name|i
index|]
operator|.
name|hang_offset
index|]
operator|++
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_DFS
argument_list|,
literal|"%s sig1count=%d sig2count=%d "
literal|"sig3count=%d sig4count=%d\n"
argument_list|,
name|__func__
argument_list|,
name|ahp
operator|->
name|ah_hang
index|[
name|BB_HANG_SIG1
index|]
argument_list|,
name|ahp
operator|->
name|ah_hang
index|[
name|BB_HANG_SIG2
index|]
argument_list|,
name|ahp
operator|->
name|ah_hang
index|[
name|BB_HANG_SIG3
index|]
argument_list|,
name|ahp
operator|->
name|ah_hang
index|[
name|BB_HANG_SIG4
index|]
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
block|}
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_DFS
argument_list|,
literal|"%s Found an unknown BB hang signature! "
literal|"<0x806c>=0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|hang_sig
argument_list|)
expr_stmt|;
return|return
name|AH_FALSE
return|;
undef|#
directive|undef
name|N
block|}
end_function

begin_comment
comment|/* end - ar9300_detect_bb_hang () */
end_comment

begin_undef
undef|#
directive|undef
name|NUM_STATUS_READS
end_undef

begin_function
name|HAL_STATUS
name|ar9300_select_ant_config
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int32_t
name|cfg
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
specifier|const
name|struct
name|ieee80211_channel
modifier|*
name|chan
init|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_curchan
decl_stmt|;
name|HAL_CHANNEL_INTERNAL
modifier|*
name|ichan
init|=
name|ath_hal_checkchannel
argument_list|(
name|ah
argument_list|,
name|chan
argument_list|)
decl_stmt|;
specifier|const
name|HAL_CAPABILITIES
modifier|*
name|p_cap
init|=
operator|&
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_caps
decl_stmt|;
name|u_int16_t
name|ant_config
decl_stmt|;
name|u_int32_t
name|hal_num_ant_config
decl_stmt|;
name|hal_num_ant_config
operator|=
name|IS_CHAN_2GHZ
argument_list|(
name|ichan
argument_list|)
condition|?
name|p_cap
operator|->
name|halNumAntCfg2GHz
else|:
name|p_cap
operator|->
name|halNumAntCfg5GHz
expr_stmt|;
if|if
condition|(
name|cfg
operator|<
name|hal_num_ant_config
condition|)
block|{
if|if
condition|(
name|HAL_OK
operator|==
name|ar9300_eeprom_get_ant_cfg
argument_list|(
name|ahp
argument_list|,
name|chan
argument_list|,
name|cfg
argument_list|,
operator|&
name|ant_config
argument_list|)
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_SWITCH_COM
argument_list|,
name|ant_config
argument_list|)
expr_stmt|;
return|return
name|HAL_OK
return|;
block|}
block|}
return|return
name|HAL_EINVAL
return|;
block|}
end_function

begin_comment
comment|/*  * Functions to get/set DCS mode  */
end_comment

begin_function
name|void
name|ar9300_set_dcs_mode
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int32_t
name|mode
parameter_list|)
block|{
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_dcs_enable
operator|=
name|mode
expr_stmt|;
block|}
end_function

begin_function
name|u_int32_t
name|ar9300_get_dcs_mode
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
return|return
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_dcs_enable
return|;
block|}
end_function

begin_if
if|#
directive|if
name|ATH_BT_COEX
end_if

begin_function
name|void
name|ar9300_set_bt_coex_info
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BT_COEX_INFO
modifier|*
name|btinfo
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|ahp
operator|->
name|ah_bt_module
operator|=
name|btinfo
operator|->
name|bt_module
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_config_type
operator|=
name|btinfo
operator|->
name|bt_coex_config
expr_stmt|;
name|ahp
operator|->
name|ah_bt_active_gpio_select
operator|=
name|btinfo
operator|->
name|bt_gpio_bt_active
expr_stmt|;
name|ahp
operator|->
name|ah_bt_priority_gpio_select
operator|=
name|btinfo
operator|->
name|bt_gpio_bt_priority
expr_stmt|;
name|ahp
operator|->
name|ah_wlan_active_gpio_select
operator|=
name|btinfo
operator|->
name|bt_gpio_wlan_active
expr_stmt|;
name|ahp
operator|->
name|ah_bt_active_polarity
operator|=
name|btinfo
operator|->
name|bt_active_polarity
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_single_ant
operator|=
name|btinfo
operator|->
name|bt_single_ant
expr_stmt|;
name|ahp
operator|->
name|ah_bt_wlan_isolation
operator|=
name|btinfo
operator|->
name|bt_isolation
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9300_bt_coex_config
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BT_COEX_CONFIG
modifier|*
name|btconf
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HAL_BOOL
name|rx_clear_polarity
decl_stmt|;
comment|/*      * For Kiwi and Osprey, the polarity of rx_clear is active high.      * The bt_rxclear_polarity flag from ath_dev needs to be inverted.      */
name|rx_clear_polarity
operator|=
operator|!
name|btconf
operator|->
name|bt_rxclear_polarity
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_mode
operator|=
operator|(
name|ahp
operator|->
name|ah_bt_coex_mode
operator|&
name|AR_BT_QCU_THRESH
operator|)
operator||
name|SM
argument_list|(
name|btconf
operator|->
name|bt_time_extend
argument_list|,
name|AR_BT_TIME_EXTEND
argument_list|)
operator||
name|SM
argument_list|(
name|btconf
operator|->
name|bt_txstate_extend
argument_list|,
name|AR_BT_TXSTATE_EXTEND
argument_list|)
operator||
name|SM
argument_list|(
name|btconf
operator|->
name|bt_txframe_extend
argument_list|,
name|AR_BT_TX_FRAME_EXTEND
argument_list|)
operator||
name|SM
argument_list|(
name|btconf
operator|->
name|bt_mode
argument_list|,
name|AR_BT_MODE
argument_list|)
operator||
name|SM
argument_list|(
name|btconf
operator|->
name|bt_quiet_collision
argument_list|,
name|AR_BT_QUIET
argument_list|)
operator||
name|SM
argument_list|(
name|rx_clear_polarity
argument_list|,
name|AR_BT_RX_CLEAR_POLARITY
argument_list|)
operator||
name|SM
argument_list|(
name|btconf
operator|->
name|bt_priority_time
argument_list|,
name|AR_BT_PRIORITY_TIME
argument_list|)
operator||
name|SM
argument_list|(
name|btconf
operator|->
name|bt_first_slot_time
argument_list|,
name|AR_BT_FIRST_SLOT_TIME
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_mode2
operator||=
name|SM
argument_list|(
name|btconf
operator|->
name|bt_hold_rxclear
argument_list|,
name|AR_BT_HOLD_RX_CLEAR
argument_list|)
expr_stmt|;
if|if
condition|(
name|ahp
operator|->
name|ah_bt_coex_single_ant
operator|==
name|AH_FALSE
condition|)
block|{
comment|/* Enable ACK to go out even though BT has higher priority. */
name|ahp
operator|->
name|ah_bt_coex_mode2
operator||=
name|AR_BT_DISABLE_BT_ANT
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ar9300_bt_coex_set_qcu_thresh
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|int
name|qnum
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
comment|/* clear the old value, then set the new value */
name|ahp
operator|->
name|ah_bt_coex_mode
operator|&=
operator|~
name|AR_BT_QCU_THRESH
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_mode
operator||=
name|SM
argument_list|(
name|qnum
argument_list|,
name|AR_BT_QCU_THRESH
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9300_bt_coex_set_weights
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int32_t
name|stomp_type
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|ahp
operator|->
name|ah_bt_coex_bt_weight
index|[
literal|0
index|]
operator|=
name|AR9300_BT_WGHT
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_bt_weight
index|[
literal|1
index|]
operator|=
name|AR9300_BT_WGHT
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_bt_weight
index|[
literal|2
index|]
operator|=
name|AR9300_BT_WGHT
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_bt_weight
index|[
literal|3
index|]
operator|=
name|AR9300_BT_WGHT
expr_stmt|;
switch|switch
condition|(
name|stomp_type
condition|)
block|{
case|case
name|HAL_BT_COEX_STOMP_ALL
case|:
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|0
index|]
operator|=
name|AR9300_STOMP_ALL_WLAN_WGHT0
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|1
index|]
operator|=
name|AR9300_STOMP_ALL_WLAN_WGHT1
expr_stmt|;
break|break;
case|case
name|HAL_BT_COEX_STOMP_LOW
case|:
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|0
index|]
operator|=
name|AR9300_STOMP_LOW_WLAN_WGHT0
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|1
index|]
operator|=
name|AR9300_STOMP_LOW_WLAN_WGHT1
expr_stmt|;
break|break;
case|case
name|HAL_BT_COEX_STOMP_ALL_FORCE
case|:
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|0
index|]
operator|=
name|AR9300_STOMP_ALL_FORCE_WLAN_WGHT0
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|1
index|]
operator|=
name|AR9300_STOMP_ALL_FORCE_WLAN_WGHT1
expr_stmt|;
break|break;
case|case
name|HAL_BT_COEX_STOMP_LOW_FORCE
case|:
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|0
index|]
operator|=
name|AR9300_STOMP_LOW_FORCE_WLAN_WGHT0
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|1
index|]
operator|=
name|AR9300_STOMP_LOW_FORCE_WLAN_WGHT1
expr_stmt|;
break|break;
case|case
name|HAL_BT_COEX_STOMP_NONE
case|:
case|case
name|HAL_BT_COEX_NO_STOMP
case|:
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|0
index|]
operator|=
name|AR9300_STOMP_NONE_WLAN_WGHT0
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|1
index|]
operator|=
name|AR9300_STOMP_NONE_WLAN_WGHT1
expr_stmt|;
break|break;
default|default:
comment|/* There is a force_weight from registry */
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|0
index|]
operator|=
name|stomp_type
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|1
index|]
operator|=
name|stomp_type
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|ar9300_bt_coex_setup_bmiss_thresh
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int32_t
name|thresh
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
comment|/* clear the old value, then set the new value */
name|ahp
operator|->
name|ah_bt_coex_mode2
operator|&=
operator|~
name|AR_BT_BCN_MISS_THRESH
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_mode2
operator||=
name|SM
argument_list|(
name|thresh
argument_list|,
name|AR_BT_BCN_MISS_THRESH
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ar9300_bt_coex_antenna_diversity
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int32_t
name|value
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
if|#
directive|if
name|ATH_ANT_DIV_COMB
comment|//struct ath_hal_private *ahpriv = AH_PRIVATE(ah);
specifier|const
name|struct
name|ieee80211_channel
modifier|*
name|chan
init|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_curchan
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ahp
operator|->
name|ah_bt_coex_flag
operator|&
name|HAL_BT_COEX_FLAG_ANT_DIV_ALLOW
condition|)
block|{
if|if
condition|(
name|ahp
operator|->
name|ah_diversity_control
operator|==
name|HAL_ANT_VARIABLE
condition|)
block|{
comment|/* Config antenna diversity */
if|#
directive|if
name|ATH_ANT_DIV_COMB
name|ar9300_ant_ctrl_set_lna_div_use_bt_ant
argument_list|(
name|ah
argument_list|,
name|value
argument_list|,
name|chan
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
block|}
block|}
end_function

begin_function
name|void
name|ar9300_bt_coex_set_parameter
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int32_t
name|type
parameter_list|,
name|u_int32_t
name|value
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|struct
name|ath_hal_private
modifier|*
name|ahpriv
init|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|HAL_BT_COEX_SET_ACK_PWR
case|:
if|if
condition|(
name|value
condition|)
block|{
name|ahp
operator|->
name|ah_bt_coex_flag
operator||=
name|HAL_BT_COEX_FLAG_LOW_ACK_PWR
expr_stmt|;
block|}
else|else
block|{
name|ahp
operator|->
name|ah_bt_coex_flag
operator|&=
operator|~
name|HAL_BT_COEX_FLAG_LOW_ACK_PWR
expr_stmt|;
block|}
name|ar9300_set_tx_power_limit
argument_list|(
name|ah
argument_list|,
name|ahpriv
operator|->
name|ah_powerLimit
argument_list|,
name|ahpriv
operator|->
name|ah_extraTxPow
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|HAL_BT_COEX_ANTENNA_DIVERSITY
case|:
if|if
condition|(
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|ahp
operator|->
name|ah_bt_coex_flag
operator||=
name|HAL_BT_COEX_FLAG_ANT_DIV_ALLOW
expr_stmt|;
if|if
condition|(
name|value
condition|)
block|{
name|ahp
operator|->
name|ah_bt_coex_flag
operator||=
name|HAL_BT_COEX_FLAG_ANT_DIV_ENABLE
expr_stmt|;
block|}
else|else
block|{
name|ahp
operator|->
name|ah_bt_coex_flag
operator|&=
operator|~
name|HAL_BT_COEX_FLAG_ANT_DIV_ENABLE
expr_stmt|;
block|}
name|ar9300_bt_coex_antenna_diversity
argument_list|(
name|ah
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|HAL_BT_COEX_LOWER_TX_PWR
case|:
if|if
condition|(
name|value
condition|)
block|{
name|ahp
operator|->
name|ah_bt_coex_flag
operator||=
name|HAL_BT_COEX_FLAG_LOWER_TX_PWR
expr_stmt|;
block|}
else|else
block|{
name|ahp
operator|->
name|ah_bt_coex_flag
operator|&=
operator|~
name|HAL_BT_COEX_FLAG_LOWER_TX_PWR
expr_stmt|;
block|}
name|ar9300_set_tx_power_limit
argument_list|(
name|ah
argument_list|,
name|ahpriv
operator|->
name|ah_powerLimit
argument_list|,
name|ahpriv
operator|->
name|ah_extraTxPow
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
if|#
directive|if
name|ATH_SUPPORT_MCI
case|case
name|HAL_BT_COEX_MCI_MAX_TX_PWR
case|:
if|if
condition|(
operator|(
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_mci_config
operator|&
name|ATH_MCI_CONFIG_CONCUR_TX
operator|)
operator|==
name|ATH_MCI_CONCUR_TX_SHARED_CHN
condition|)
block|{
if|if
condition|(
name|value
condition|)
block|{
name|ahp
operator|->
name|ah_bt_coex_flag
operator||=
name|HAL_BT_COEX_FLAG_MCI_MAX_TX_PWR
expr_stmt|;
name|ahp
operator|->
name|ah_mci_concur_tx_en
operator|=
name|AH_TRUE
expr_stmt|;
block|}
else|else
block|{
name|ahp
operator|->
name|ah_bt_coex_flag
operator|&=
operator|~
name|HAL_BT_COEX_FLAG_MCI_MAX_TX_PWR
expr_stmt|;
name|ahp
operator|->
name|ah_mci_concur_tx_en
operator|=
name|AH_FALSE
expr_stmt|;
block|}
name|ar9300_set_tx_power_limit
argument_list|(
name|ah
argument_list|,
name|ahpriv
operator|->
name|ah_powerLimit
argument_list|,
name|ahpriv
operator|->
name|ah_extraTxPow
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_BT_COEX
argument_list|,
literal|"(MCI) concur_tx_en = %d\n"
argument_list|,
name|ahp
operator|->
name|ah_mci_concur_tx_en
argument_list|)
expr_stmt|;
break|break;
case|case
name|HAL_BT_COEX_MCI_FTP_STOMP_RX
case|:
if|if
condition|(
name|value
condition|)
block|{
name|ahp
operator|->
name|ah_bt_coex_flag
operator||=
name|HAL_BT_COEX_FLAG_MCI_FTP_STOMP_RX
expr_stmt|;
block|}
else|else
block|{
name|ahp
operator|->
name|ah_bt_coex_flag
operator|&=
operator|~
name|HAL_BT_COEX_FLAG_MCI_FTP_STOMP_RX
expr_stmt|;
block|}
break|break;
endif|#
directive|endif
default|default:
break|break;
block|}
block|}
end_function

begin_function
name|void
name|ar9300_bt_coex_disable
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
comment|/* Always drive rx_clear_external output as 0 */
name|ath_hal_gpioCfgOutput
argument_list|(
name|ah
argument_list|,
name|ahp
operator|->
name|ah_wlan_active_gpio_select
argument_list|,
name|HAL_GPIO_OUTPUT_MUX_AS_OUTPUT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ahp
operator|->
name|ah_bt_coex_single_ant
operator|==
name|AH_TRUE
condition|)
block|{
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_QUIET1
argument_list|,
name|AR_QUIET1_QUIET_ACK_CTS_ENABLE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PCU_MISC
argument_list|,
name|AR_PCU_BT_ANT_PREVENT_RX
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BT_COEX_MODE
argument_list|,
name|AR_BT_QUIET
operator||
name|AR_BT_MODE
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BT_COEX_MODE2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BT_COEX_WL_WEIGHTS0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BT_COEX_WL_WEIGHTS1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BT_COEX_BT_WEIGHTS0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BT_COEX_BT_WEIGHTS1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BT_COEX_BT_WEIGHTS2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BT_COEX_BT_WEIGHTS3
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_enabled
operator|=
name|AH_FALSE
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ar9300_bt_coex_enable
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
comment|/* Program coex mode and weight registers to actually enable coex */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BT_COEX_MODE
argument_list|,
name|ahp
operator|->
name|ah_bt_coex_mode
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BT_COEX_MODE2
argument_list|,
name|ahp
operator|->
name|ah_bt_coex_mode2
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BT_COEX_WL_WEIGHTS0
argument_list|,
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BT_COEX_WL_WEIGHTS1
argument_list|,
name|ahp
operator|->
name|ah_bt_coex_wlan_weight
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BT_COEX_BT_WEIGHTS0
argument_list|,
name|ahp
operator|->
name|ah_bt_coex_bt_weight
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BT_COEX_BT_WEIGHTS1
argument_list|,
name|ahp
operator|->
name|ah_bt_coex_bt_weight
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BT_COEX_BT_WEIGHTS2
argument_list|,
name|ahp
operator|->
name|ah_bt_coex_bt_weight
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_BT_COEX_BT_WEIGHTS3
argument_list|,
name|ahp
operator|->
name|ah_bt_coex_bt_weight
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ahp
operator|->
name|ah_bt_coex_flag
operator|&
name|HAL_BT_COEX_FLAG_LOW_ACK_PWR
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_TPC
argument_list|,
name|HAL_BT_COEX_LOW_ACK_POWER
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_TPC
argument_list|,
name|HAL_BT_COEX_HIGH_ACK_POWER
argument_list|)
expr_stmt|;
block|}
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_QUIET1
argument_list|,
name|AR_QUIET1_QUIET_ACK_CTS_ENABLE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ahp
operator|->
name|ah_bt_coex_single_ant
operator|==
name|AH_TRUE
condition|)
block|{
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PCU_MISC
argument_list|,
name|AR_PCU_BT_ANT_PREVENT_RX
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PCU_MISC
argument_list|,
name|AR_PCU_BT_ANT_PREVENT_RX
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ahp
operator|->
name|ah_bt_coex_config_type
operator|==
name|HAL_BT_COEX_CFG_3WIRE
condition|)
block|{
comment|/* For 3-wire, configure the desired GPIO port for rx_clear */
name|ath_hal_gpioCfgOutput
argument_list|(
name|ah
argument_list|,
name|ahp
operator|->
name|ah_wlan_active_gpio_select
argument_list|,
name|HAL_GPIO_OUTPUT_MUX_AS_WLAN_ACTIVE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ahp
operator|->
name|ah_bt_coex_config_type
operator|>=
name|HAL_BT_COEX_CFG_2WIRE_2CH
operator|)
operator|&&
operator|(
name|ahp
operator|->
name|ah_bt_coex_config_type
operator|<=
name|HAL_BT_COEX_CFG_2WIRE_CH0
operator|)
condition|)
block|{
comment|/* For 2-wire, configure the desired GPIO port for TX_FRAME output */
name|ath_hal_gpioCfgOutput
argument_list|(
name|ah
argument_list|,
name|ahp
operator|->
name|ah_wlan_active_gpio_select
argument_list|,
name|HAL_GPIO_OUTPUT_MUX_AS_TX_FRAME
argument_list|)
expr_stmt|;
block|}
comment|/*      * Enable a weak pull down on BT_ACTIVE.      * When BT device is disabled, BT_ACTIVE might be floating.      */
name|OS_REG_RMW
argument_list|(
name|ah
argument_list|,
name|AR_HOSTIF_REG
argument_list|(
name|ah
argument_list|,
name|AR_GPIO_PDPU
argument_list|)
argument_list|,
operator|(
name|AR_GPIO_PULL_DOWN
operator|<<
operator|(
name|ahp
operator|->
name|ah_bt_active_gpio_select
operator|*
literal|2
operator|)
operator|)
argument_list|,
operator|(
name|AR_GPIO_PDPU_OPTION
operator|<<
operator|(
name|ahp
operator|->
name|ah_bt_active_gpio_select
operator|*
literal|2
operator|)
operator|)
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|ah_bt_coex_enabled
operator|=
name|AH_TRUE
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|u_int32_t
name|ar9300_get_bt_active_gpio
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int32_t
name|reg
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
name|u_int32_t
name|ar9300_get_wlan_active_gpio
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int32_t
name|reg
parameter_list|,
name|u_int32_t
name|bOn
parameter_list|)
block|{
return|return
name|bOn
return|;
block|}
end_function

begin_function
name|void
name|ar9300_init_bt_coex
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
if|if
condition|(
name|ahp
operator|->
name|ah_bt_coex_config_type
operator|==
name|HAL_BT_COEX_CFG_3WIRE
condition|)
block|{
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_HOSTIF_REG
argument_list|(
name|ah
argument_list|,
name|AR_GPIO_INPUT_EN_VAL
argument_list|)
argument_list|,
operator|(
name|AR_GPIO_INPUT_EN_VAL_BT_PRIORITY_BB
operator||
name|AR_GPIO_INPUT_EN_VAL_BT_ACTIVE_BB
operator|)
argument_list|)
expr_stmt|;
comment|/*          * Set input mux for bt_prority_async and          * bt_active_async to GPIO pins          */
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_HOSTIF_REG
argument_list|(
name|ah
argument_list|,
name|AR_GPIO_INPUT_MUX1
argument_list|)
argument_list|,
name|AR_GPIO_INPUT_MUX1_BT_ACTIVE
argument_list|,
name|ahp
operator|->
name|ah_bt_active_gpio_select
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_HOSTIF_REG
argument_list|(
name|ah
argument_list|,
name|AR_GPIO_INPUT_MUX1
argument_list|)
argument_list|,
name|AR_GPIO_INPUT_MUX1_BT_PRIORITY
argument_list|,
name|ahp
operator|->
name|ah_bt_priority_gpio_select
argument_list|)
expr_stmt|;
comment|/* Configure the desired GPIO ports for input */
name|ath_hal_gpioCfgInput
argument_list|(
name|ah
argument_list|,
name|ahp
operator|->
name|ah_bt_active_gpio_select
argument_list|)
expr_stmt|;
name|ath_hal_gpioCfgInput
argument_list|(
name|ah
argument_list|,
name|ahp
operator|->
name|ah_bt_priority_gpio_select
argument_list|)
expr_stmt|;
if|if
condition|(
name|ahp
operator|->
name|ah_bt_coex_enabled
condition|)
block|{
name|ar9300_bt_coex_enable
argument_list|(
name|ah
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ar9300_bt_coex_disable
argument_list|(
name|ah
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|ahp
operator|->
name|ah_bt_coex_config_type
operator|>=
name|HAL_BT_COEX_CFG_2WIRE_2CH
operator|)
operator|&&
operator|(
name|ahp
operator|->
name|ah_bt_coex_config_type
operator|<=
name|HAL_BT_COEX_CFG_2WIRE_CH0
operator|)
condition|)
block|{
comment|/* 2-wire */
if|if
condition|(
name|ahp
operator|->
name|ah_bt_coex_enabled
condition|)
block|{
comment|/* Connect bt_active_async to baseband */
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_HOSTIF_REG
argument_list|(
name|ah
argument_list|,
name|AR_GPIO_INPUT_EN_VAL
argument_list|)
argument_list|,
operator|(
name|AR_GPIO_INPUT_EN_VAL_BT_PRIORITY_DEF
operator||
name|AR_GPIO_INPUT_EN_VAL_BT_FREQUENCY_DEF
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_HOSTIF_REG
argument_list|(
name|ah
argument_list|,
name|AR_GPIO_INPUT_EN_VAL
argument_list|)
argument_list|,
name|AR_GPIO_INPUT_EN_VAL_BT_ACTIVE_BB
argument_list|)
expr_stmt|;
comment|/*              * Set input mux for bt_prority_async and              * bt_active_async to GPIO pins              */
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_HOSTIF_REG
argument_list|(
name|ah
argument_list|,
name|AR_GPIO_INPUT_MUX1
argument_list|)
argument_list|,
name|AR_GPIO_INPUT_MUX1_BT_ACTIVE
argument_list|,
name|ahp
operator|->
name|ah_bt_active_gpio_select
argument_list|)
expr_stmt|;
comment|/* Configure the desired GPIO ports for input */
name|ath_hal_gpioCfgInput
argument_list|(
name|ah
argument_list|,
name|ahp
operator|->
name|ah_bt_active_gpio_select
argument_list|)
expr_stmt|;
comment|/* Enable coexistence on initialization */
name|ar9300_bt_coex_enable
argument_list|(
name|ah
argument_list|)
expr_stmt|;
block|}
block|}
if|#
directive|if
name|ATH_SUPPORT_MCI
elseif|else
if|if
condition|(
name|ahp
operator|->
name|ah_bt_coex_config_type
operator|==
name|HAL_BT_COEX_CFG_MCI
condition|)
block|{
if|if
condition|(
name|ahp
operator|->
name|ah_bt_coex_enabled
condition|)
block|{
name|ar9300_mci_bt_coex_enable
argument_list|(
name|ah
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ar9300_mci_bt_coex_disable
argument_list|(
name|ah
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* ATH_SUPPORT_MCI */
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ATH_BT_COEX */
end_comment

begin_function
name|HAL_STATUS
name|ar9300_set_proxy_sta
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|enable
parameter_list|)
block|{
name|u_int32_t
name|val
decl_stmt|;
name|int
name|wasp_mm_rev
decl_stmt|;
define|#
directive|define
name|AR_SOC_RST_REVISION_ID
value|0xB8060090
define|#
directive|define
name|REG_READ
parameter_list|(
name|_reg
parameter_list|)
value|*((volatile u_int32_t *)(_reg))
name|wasp_mm_rev
operator|=
operator|(
name|REG_READ
argument_list|(
name|AR_SOC_RST_REVISION_ID
argument_list|)
operator|&
name|AR_SREV_REVISION_WASP_MINOR_MINOR_MASK
operator|)
operator|>>
name|AR_SREV_REVISION_WASP_MINOR_MINOR_SHIFT
expr_stmt|;
undef|#
directive|undef
name|AR_SOC_RST_REVISION_ID
undef|#
directive|undef
name|REG_READ
comment|/*      * Azimuth (ProxySTA) Mode is only supported correctly by      * Peacock or WASP 1.3.0.1 or later (hopefully) chips.      *      * Enable this feature for Scorpion at this time. The silicon      * still needs to be validated.      */
if|if
condition|(
operator|!
operator|(
name|AH_PRIVATE
argument_list|(
operator|(
name|ah
operator|)
argument_list|)
operator|->
name|ah_macVersion
operator|==
name|AR_SREV_VERSION_AR9580
operator|)
operator|&&
operator|!
operator|(
name|AH_PRIVATE
argument_list|(
operator|(
name|ah
operator|)
argument_list|)
operator|->
name|ah_macVersion
operator|==
name|AR_SREV_VERSION_SCORPION
operator|)
operator|&&
operator|!
operator|(
operator|(
name|AH_PRIVATE
argument_list|(
operator|(
name|ah
operator|)
argument_list|)
operator|->
name|ah_macVersion
operator|==
name|AR_SREV_VERSION_WASP
operator|)
operator|&&
operator|(
operator|(
name|AH_PRIVATE
argument_list|(
operator|(
name|ah
operator|)
argument_list|)
operator|->
name|ah_macRev
operator|>
name|AR_SREV_REVISION_WASP_13
operator|)
operator|||
operator|(
name|AH_PRIVATE
argument_list|(
operator|(
name|ah
operator|)
argument_list|)
operator|->
name|ah_macRev
operator|==
name|AR_SREV_REVISION_WASP_13
operator|&&
name|wasp_mm_rev
operator|>=
literal|0
comment|/* 1 */
operator|)
operator|)
operator|)
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_UNMASKABLE
argument_list|,
literal|"%s error: current chip (ver 0x%x, "
literal|"rev 0x%x, minor minor rev 0x%x) cannot support Azimuth Mode\n"
argument_list|,
name|__func__
argument_list|,
name|AH_PRIVATE
argument_list|(
operator|(
name|ah
operator|)
argument_list|)
operator|->
name|ah_macVersion
argument_list|,
name|AH_PRIVATE
argument_list|(
operator|(
name|ah
operator|)
argument_list|)
operator|->
name|ah_macRev
argument_list|,
name|wasp_mm_rev
argument_list|)
expr_stmt|;
return|return
name|HAL_ENOTSUPP
return|;
block|}
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MAC_PCU_LOGIC_ANALYZER
argument_list|,
name|AR_MAC_PCU_LOGIC_ANALYZER_PSTABUG75996
argument_list|)
expr_stmt|;
comment|/* turn on mode bit[24] for proxy sta */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PCU_MISC_MODE2
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PCU_MISC_MODE2
argument_list|)
operator||
name|AR_PCU_MISC_MODE2_PROXY_STA
argument_list|)
expr_stmt|;
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_AZIMUTH_MODE
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
condition|)
block|{
name|val
operator||=
name|AR_AZIMUTH_KEY_SEARCH_AD1
operator||
name|AR_AZIMUTH_CTS_MATCH_TX_AD2
operator||
name|AR_AZIMUTH_BA_USES_AD1
expr_stmt|;
comment|/* turn off filter pass hold (bit 9) */
name|val
operator|&=
operator|~
name|AR_AZIMUTH_FILTER_PASS_HOLD
expr_stmt|;
block|}
else|else
block|{
name|val
operator|&=
operator|~
operator|(
name|AR_AZIMUTH_KEY_SEARCH_AD1
operator||
name|AR_AZIMUTH_CTS_MATCH_TX_AD2
operator||
name|AR_AZIMUTH_BA_USES_AD1
operator|)
expr_stmt|;
block|}
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_AZIMUTH_MODE
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* enable promiscous mode */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_RX_FILTER
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_RX_FILTER
argument_list|)
operator||
name|HAL_RX_FILTER_PROM
argument_list|)
expr_stmt|;
comment|/* enable promiscous in azimuth mode */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PCU_MISC_MODE2
argument_list|,
name|AR_PCU_MISC_MODE2_PROM_VC_MODE
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_MAC_PCU_LOGIC_ANALYZER
argument_list|,
name|AR_MAC_PCU_LOGIC_ANALYZER_VC_MODE
argument_list|)
expr_stmt|;
comment|/* turn on filter pass hold (bit 9) */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_AZIMUTH_MODE
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_AZIMUTH_MODE
argument_list|)
operator||
name|AR_AZIMUTH_FILTER_PASS_HOLD
argument_list|)
expr_stmt|;
return|return
name|HAL_OK
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
unit|void ar9300_mat_enable(struct ath_hal *ah, int enable) {
comment|/*      * MAT (s/w ProxySTA) implementation requires to turn off interrupt      * mitigation and turn on key search always for better performance.      */
end_comment

begin_comment
unit|struct ath_hal_9300 *ahp = AH9300(ah);     struct ath_hal_private *ap = AH_PRIVATE(ah);      ahp->ah_intr_mitigation_rx = !enable;     if (ahp->ah_intr_mitigation_rx) {
comment|/*          * Enable Interrupt Mitigation for Rx.          * If no build-specific limits for the rx interrupt mitigation          * timer have been specified, use conservative defaults.          */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|AH_RIMT_VAL_LAST
end_ifndef

begin_define
define|#
directive|define
name|AH_RIMT_LAST_MICROSEC
value|500
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|AH_RIMT_VAL_FIRST
end_ifndef

begin_define
define|#
directive|define
name|AH_RIMT_FIRST_MICROSEC
value|2000
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_endif
unit|OS_REG_RMW_FIELD(ah, AR_RIMT, AR_RIMT_LAST, AH_RIMT_LAST_MICROSEC);         OS_REG_RMW_FIELD(ah, AR_RIMT, AR_RIMT_FIRST, AH_RIMT_FIRST_MICROSEC);     } else {         OS_REG_WRITE(ah, AR_RIMT, 0);     }      ahp->ah_enable_keysearch_always = !!enable;     ar9300_enable_keysearch_always(ah, ahp->ah_enable_keysearch_always); }
endif|#
directive|endif
end_endif

begin_function
name|void
name|ar9300_enable_tpc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|u_int32_t
name|val
init|=
literal|0
decl_stmt|;
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_desc_tpc
operator|=
literal|1
expr_stmt|;
comment|/* Enable TPC */
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PWRTX_MAX
argument_list|,
name|AR_PHY_PER_PACKET_POWERTX_MAX
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/*      * Disable per chain power reduction since we are already      * accounting for this in our calculations      */
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_POWER_TX_SUB
argument_list|)
expr_stmt|;
if|if
condition|(
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_POWER_TX_SUB
argument_list|,
name|val
operator|&
name|AR_PHY_POWER_TX_SUB_2_DISABLE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_POWER_TX_SUB
argument_list|,
name|val
operator|&
name|AR_PHY_POWER_TX_SUB_3_DISABLE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * ar9300_force_tsf_sync   * This function forces the TSF sync to the given bssid, this is implemented  * as a temp hack to get the AoW demo, and is primarily used in the WDS client  * mode of operation, where we sync the TSF to RootAP TSF values  */
end_comment

begin_function
name|void
name|ar9300_force_tsf_sync
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
specifier|const
name|u_int8_t
modifier|*
name|bssid
parameter_list|,
name|u_int16_t
name|assoc_id
parameter_list|)
block|{
name|ar9300_set_operating_mode
argument_list|(
name|ah
argument_list|,
name|HAL_M_STA
argument_list|)
expr_stmt|;
name|ar9300_write_associd
argument_list|(
name|ah
argument_list|,
name|bssid
argument_list|,
name|assoc_id
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9300_chk_rssi_update_tx_pwr
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|int
name|rssi
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|u_int32_t
name|temp_obdb_reg_val
init|=
literal|0
decl_stmt|,
name|temp_tcp_reg_val
decl_stmt|;
name|u_int32_t
name|temp_powertx_rate9_reg_val
decl_stmt|;
name|int8_t
name|olpc_power_offset
init|=
literal|0
decl_stmt|;
name|int8_t
name|tmp_olpc_val
init|=
literal|0
decl_stmt|;
name|HAL_RSSI_TX_POWER
name|old_greentx_status
decl_stmt|;
name|u_int8_t
name|target_power_val_t
index|[
name|ar9300_rate_size
index|]
decl_stmt|;
name|int8_t
name|tmp_rss1_thr1
decl_stmt|,
name|tmp_rss1_thr2
decl_stmt|;
if|if
condition|(
operator|(
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_opmode
operator|!=
name|HAL_M_STA
operator|)
operator|||
operator|!
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_sta_update_tx_pwr_enable
condition|)
block|{
return|return;
block|}
name|old_greentx_status
operator|=
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|green_tx_status
expr_stmt|;
if|if
condition|(
name|ahp
operator|->
name|ah_hw_green_tx_enable
condition|)
block|{
name|tmp_rss1_thr1
operator|=
name|AR9485_HW_GREEN_TX_THRES1_DB
expr_stmt|;
name|tmp_rss1_thr2
operator|=
name|AR9485_HW_GREEN_TX_THRES2_DB
expr_stmt|;
block|}
else|else
block|{
name|tmp_rss1_thr1
operator|=
name|WB225_SW_GREEN_TX_THRES1_DB
expr_stmt|;
name|tmp_rss1_thr2
operator|=
name|WB225_SW_GREEN_TX_THRES2_DB
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_sta_update_tx_pwr_enable_S1
operator|)
operator|&&
operator|(
name|rssi
operator|>
name|tmp_rss1_thr1
operator|)
condition|)
block|{
if|if
condition|(
name|old_greentx_status
operator|!=
name|HAL_RSSI_TX_POWER_SHORT
condition|)
block|{
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|green_tx_status
operator|=
name|HAL_RSSI_TX_POWER_SHORT
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_sta_update_tx_pwr_enable_S2
operator|&&
operator|(
name|rssi
operator|>
name|tmp_rss1_thr2
operator|)
condition|)
block|{
if|if
condition|(
name|old_greentx_status
operator|!=
name|HAL_RSSI_TX_POWER_MIDDLE
condition|)
block|{
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|green_tx_status
operator|=
name|HAL_RSSI_TX_POWER_MIDDLE
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_sta_update_tx_pwr_enable_S3
condition|)
block|{
if|if
condition|(
name|old_greentx_status
operator|!=
name|HAL_RSSI_TX_POWER_LONG
condition|)
block|{
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|green_tx_status
operator|=
name|HAL_RSSI_TX_POWER_LONG
expr_stmt|;
block|}
block|}
comment|/* If status is not change, don't do anything */
if|if
condition|(
name|old_greentx_status
operator|==
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|green_tx_status
condition|)
block|{
return|return;
block|}
comment|/* for Poseidon which ath_hal_sta_update_tx_pwr_enable is enabled */
if|if
condition|(
operator|(
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|green_tx_status
operator|!=
name|HAL_RSSI_TX_POWER_NONE
operator|)
operator|&&
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
condition|)
block|{
if|if
condition|(
name|ahp
operator|->
name|ah_hw_green_tx_enable
condition|)
block|{
switch|switch
condition|(
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|green_tx_status
condition|)
block|{
case|case
name|HAL_RSSI_TX_POWER_SHORT
case|:
comment|/* 1. TxPower Config */
name|OS_MEMCPY
argument_list|(
name|target_power_val_t
argument_list|,
name|ar9485_hw_gtx_tp_distance_short
argument_list|,
sizeof|sizeof
argument_list|(
name|target_power_val_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 1.1 Store OLPC Delta Calibration Offset*/
name|olpc_power_offset
operator|=
literal|0
expr_stmt|;
comment|/* 2. Store OB/DB */
comment|/* 3. Store TPC settting */
name|temp_tcp_reg_val
operator|=
operator|(
name|SM
argument_list|(
literal|14
argument_list|,
name|AR_TPC_ACK
argument_list|)
operator||
name|SM
argument_list|(
literal|14
argument_list|,
name|AR_TPC_CTS
argument_list|)
operator||
name|SM
argument_list|(
literal|14
argument_list|,
name|AR_TPC_CHIRP
argument_list|)
operator||
name|SM
argument_list|(
literal|14
argument_list|,
name|AR_TPC_RPT
argument_list|)
operator|)
expr_stmt|;
comment|/* 4. Store BB_powertx_rate9 value */
name|temp_powertx_rate9_reg_val
operator|=
name|AR9485_BBPWRTXRATE9_HW_GREEN_TX_SHORT_VALUE
expr_stmt|;
break|break;
case|case
name|HAL_RSSI_TX_POWER_MIDDLE
case|:
comment|/* 1. TxPower Config */
name|OS_MEMCPY
argument_list|(
name|target_power_val_t
argument_list|,
name|ar9485_hw_gtx_tp_distance_middle
argument_list|,
sizeof|sizeof
argument_list|(
name|target_power_val_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 1.1 Store OLPC Delta Calibration Offset*/
name|olpc_power_offset
operator|=
literal|0
expr_stmt|;
comment|/* 2. Store OB/DB */
comment|/* 3. Store TPC settting */
name|temp_tcp_reg_val
operator|=
operator|(
name|SM
argument_list|(
literal|18
argument_list|,
name|AR_TPC_ACK
argument_list|)
operator||
name|SM
argument_list|(
literal|18
argument_list|,
name|AR_TPC_CTS
argument_list|)
operator||
name|SM
argument_list|(
literal|18
argument_list|,
name|AR_TPC_CHIRP
argument_list|)
operator||
name|SM
argument_list|(
literal|18
argument_list|,
name|AR_TPC_RPT
argument_list|)
operator|)
expr_stmt|;
comment|/* 4. Store BB_powertx_rate9 value */
name|temp_powertx_rate9_reg_val
operator|=
name|AR9485_BBPWRTXRATE9_HW_GREEN_TX_MIDDLE_VALUE
expr_stmt|;
break|break;
case|case
name|HAL_RSSI_TX_POWER_LONG
case|:
default|default:
comment|/* 1. TxPower Config */
name|OS_MEMCPY
argument_list|(
name|target_power_val_t
argument_list|,
name|ahp
operator|->
name|ah_default_tx_power
argument_list|,
sizeof|sizeof
argument_list|(
name|target_power_val_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 1.1 Store OLPC Delta Calibration Offset*/
name|olpc_power_offset
operator|=
literal|0
expr_stmt|;
comment|/* 2. Store OB/DB1/DB2 */
comment|/* 3. Store TPC settting */
name|temp_tcp_reg_val
operator|=
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ob_db1
index|[
name|POSEIDON_STORED_REG_TPC
index|]
expr_stmt|;
comment|/* 4. Store BB_powertx_rate9 value */
name|temp_powertx_rate9_reg_val
operator|=
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ob_db1
index|[
name|POSEIDON_STORED_REG_BB_PWRTX_RATE9
index|]
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
switch|switch
condition|(
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|green_tx_status
condition|)
block|{
case|case
name|HAL_RSSI_TX_POWER_SHORT
case|:
comment|/* 1. TxPower Config */
name|OS_MEMCPY
argument_list|(
name|target_power_val_t
argument_list|,
name|wb225_sw_gtx_tp_distance_short
argument_list|,
sizeof|sizeof
argument_list|(
name|target_power_val_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 1.1 Store OLPC Delta Calibration Offset*/
name|olpc_power_offset
operator|=
name|wb225_gtx_olpc_cal_offset
index|[
name|WB225_OB_GREEN_TX_SHORT_VALUE
index|]
operator|-
name|wb225_gtx_olpc_cal_offset
index|[
name|WB225_OB_CALIBRATION_VALUE
index|]
expr_stmt|;
comment|/* 2. Store OB/DB */
name|temp_obdb_reg_val
operator|=
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ob_db1
index|[
name|POSEIDON_STORED_REG_OBDB
index|]
expr_stmt|;
name|temp_obdb_reg_val
operator|&=
operator|~
operator|(
name|AR_PHY_65NM_CH0_TXRF2_DB2G
operator||
name|AR_PHY_65NM_CH0_TXRF2_OB2G_CCK
operator||
name|AR_PHY_65NM_CH0_TXRF2_OB2G_PSK
operator||
name|AR_PHY_65NM_CH0_TXRF2_OB2G_QAM
operator|)
expr_stmt|;
name|temp_obdb_reg_val
operator||=
operator|(
name|SM
argument_list|(
literal|5
argument_list|,
name|AR_PHY_65NM_CH0_TXRF2_DB2G
argument_list|)
operator||
name|SM
argument_list|(
name|WB225_OB_GREEN_TX_SHORT_VALUE
argument_list|,
name|AR_PHY_65NM_CH0_TXRF2_OB2G_CCK
argument_list|)
operator||
name|SM
argument_list|(
name|WB225_OB_GREEN_TX_SHORT_VALUE
argument_list|,
name|AR_PHY_65NM_CH0_TXRF2_OB2G_PSK
argument_list|)
operator||
name|SM
argument_list|(
name|WB225_OB_GREEN_TX_SHORT_VALUE
argument_list|,
name|AR_PHY_65NM_CH0_TXRF2_OB2G_QAM
argument_list|)
operator|)
expr_stmt|;
comment|/* 3. Store TPC settting */
name|temp_tcp_reg_val
operator|=
operator|(
name|SM
argument_list|(
literal|6
argument_list|,
name|AR_TPC_ACK
argument_list|)
operator||
name|SM
argument_list|(
literal|6
argument_list|,
name|AR_TPC_CTS
argument_list|)
operator||
name|SM
argument_list|(
literal|6
argument_list|,
name|AR_TPC_CHIRP
argument_list|)
operator||
name|SM
argument_list|(
literal|6
argument_list|,
name|AR_TPC_RPT
argument_list|)
operator|)
expr_stmt|;
comment|/* 4. Store BB_powertx_rate9 value */
name|temp_powertx_rate9_reg_val
operator|=
name|WB225_BBPWRTXRATE9_SW_GREEN_TX_SHORT_VALUE
expr_stmt|;
break|break;
case|case
name|HAL_RSSI_TX_POWER_MIDDLE
case|:
comment|/* 1. TxPower Config */
name|OS_MEMCPY
argument_list|(
name|target_power_val_t
argument_list|,
name|wb225_sw_gtx_tp_distance_middle
argument_list|,
sizeof|sizeof
argument_list|(
name|target_power_val_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 1.1 Store OLPC Delta Calibration Offset*/
name|olpc_power_offset
operator|=
name|wb225_gtx_olpc_cal_offset
index|[
name|WB225_OB_GREEN_TX_MIDDLE_VALUE
index|]
operator|-
name|wb225_gtx_olpc_cal_offset
index|[
name|WB225_OB_CALIBRATION_VALUE
index|]
expr_stmt|;
comment|/* 2. Store OB/DB */
name|temp_obdb_reg_val
operator|=
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ob_db1
index|[
name|POSEIDON_STORED_REG_OBDB
index|]
expr_stmt|;
name|temp_obdb_reg_val
operator|&=
operator|~
operator|(
name|AR_PHY_65NM_CH0_TXRF2_DB2G
operator||
name|AR_PHY_65NM_CH0_TXRF2_OB2G_CCK
operator||
name|AR_PHY_65NM_CH0_TXRF2_OB2G_PSK
operator||
name|AR_PHY_65NM_CH0_TXRF2_OB2G_QAM
operator|)
expr_stmt|;
name|temp_obdb_reg_val
operator||=
operator|(
name|SM
argument_list|(
literal|5
argument_list|,
name|AR_PHY_65NM_CH0_TXRF2_DB2G
argument_list|)
operator||
name|SM
argument_list|(
name|WB225_OB_GREEN_TX_MIDDLE_VALUE
argument_list|,
name|AR_PHY_65NM_CH0_TXRF2_OB2G_CCK
argument_list|)
operator||
name|SM
argument_list|(
name|WB225_OB_GREEN_TX_MIDDLE_VALUE
argument_list|,
name|AR_PHY_65NM_CH0_TXRF2_OB2G_PSK
argument_list|)
operator||
name|SM
argument_list|(
name|WB225_OB_GREEN_TX_MIDDLE_VALUE
argument_list|,
name|AR_PHY_65NM_CH0_TXRF2_OB2G_QAM
argument_list|)
operator|)
expr_stmt|;
comment|/* 3. Store TPC settting */
name|temp_tcp_reg_val
operator|=
operator|(
name|SM
argument_list|(
literal|14
argument_list|,
name|AR_TPC_ACK
argument_list|)
operator||
name|SM
argument_list|(
literal|14
argument_list|,
name|AR_TPC_CTS
argument_list|)
operator||
name|SM
argument_list|(
literal|14
argument_list|,
name|AR_TPC_CHIRP
argument_list|)
operator||
name|SM
argument_list|(
literal|14
argument_list|,
name|AR_TPC_RPT
argument_list|)
operator|)
expr_stmt|;
comment|/* 4. Store BB_powertx_rate9 value */
name|temp_powertx_rate9_reg_val
operator|=
name|WB225_BBPWRTXRATE9_SW_GREEN_TX_MIDDLE_VALUE
expr_stmt|;
break|break;
case|case
name|HAL_RSSI_TX_POWER_LONG
case|:
default|default:
comment|/* 1. TxPower Config */
name|OS_MEMCPY
argument_list|(
name|target_power_val_t
argument_list|,
name|ahp
operator|->
name|ah_default_tx_power
argument_list|,
sizeof|sizeof
argument_list|(
name|target_power_val_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 1.1 Store OLPC Delta Calibration Offset*/
name|olpc_power_offset
operator|=
name|wb225_gtx_olpc_cal_offset
index|[
name|WB225_OB_GREEN_TX_LONG_VALUE
index|]
operator|-
name|wb225_gtx_olpc_cal_offset
index|[
name|WB225_OB_CALIBRATION_VALUE
index|]
expr_stmt|;
comment|/* 2. Store OB/DB1/DB2 */
name|temp_obdb_reg_val
operator|=
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ob_db1
index|[
name|POSEIDON_STORED_REG_OBDB
index|]
expr_stmt|;
comment|/* 3. Store TPC settting */
name|temp_tcp_reg_val
operator|=
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ob_db1
index|[
name|POSEIDON_STORED_REG_TPC
index|]
expr_stmt|;
comment|/* 4. Store BB_powertx_rate9 value */
name|temp_powertx_rate9_reg_val
operator|=
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_ob_db1
index|[
name|POSEIDON_STORED_REG_BB_PWRTX_RATE9
index|]
expr_stmt|;
break|break;
block|}
block|}
comment|/* 1.1 Do OLPC Delta Calibration Offset */
name|tmp_olpc_val
operator|=
operator|(
name|int8_t
operator|)
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_db2
index|[
name|POSEIDON_STORED_REG_G2_OLPC_OFFSET
index|]
expr_stmt|;
name|tmp_olpc_val
operator|+=
name|olpc_power_offset
expr_stmt|;
name|OS_REG_RMW
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TPC_11_B0
argument_list|,
operator|(
name|tmp_olpc_val
operator|<<
name|AR_PHY_TPC_OLPC_GAIN_DELTA_S
operator|)
argument_list|,
name|AR_PHY_TPC_OLPC_GAIN_DELTA
argument_list|)
expr_stmt|;
comment|/* 1.2 TxPower Config */
name|ar9300_transmit_power_reg_write
argument_list|(
name|ah
argument_list|,
name|target_power_val_t
argument_list|)
expr_stmt|;
comment|/* 2. Config OB/DB */
if|if
condition|(
operator|!
name|ahp
operator|->
name|ah_hw_green_tx_enable
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TXRF2
argument_list|,
name|temp_obdb_reg_val
argument_list|)
expr_stmt|;
block|}
comment|/* 3. config TPC settting */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_TPC
argument_list|,
name|temp_tcp_reg_val
argument_list|)
expr_stmt|;
comment|/* 4. config BB_powertx_rate9 value */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_BB_POWERTX_RATE9
argument_list|,
name|temp_powertx_rate9_reg_val
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|void ar9300_get_vow_stats(     struct ath_hal *ah, HAL_VOWSTATS* p_stats, u_int8_t vow_reg_flags) {     if (vow_reg_flags& AR_REG_TX_FRM_CNT) {         p_stats->tx_frame_count = OS_REG_READ(ah, AR_TFCNT);     }     if (vow_reg_flags& AR_REG_RX_FRM_CNT) {         p_stats->rx_frame_count = OS_REG_READ(ah, AR_RFCNT);     }     if (vow_reg_flags& AR_REG_RX_CLR_CNT) {         p_stats->rx_clear_count = OS_REG_READ(ah, AR_RCCNT);     }     if (vow_reg_flags& AR_REG_CYCLE_CNT) {         p_stats->cycle_count   = OS_REG_READ(ah, AR_CCCNT);     }     if (vow_reg_flags& AR_REG_EXT_CYCLE_CNT) {         p_stats->ext_cycle_count   = OS_REG_READ(ah, AR_EXTRCCNT);     } }
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * ar9300_is_skip_paprd_by_greentx  *  * This function check if we need to skip PAPRD tuning   * when GreenTx in specific state.  */
end_comment

begin_function
name|HAL_BOOL
name|ar9300_is_skip_paprd_by_greentx
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
if|if
condition|(
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
operator|&&
name|ah
operator|->
name|ah_config
operator|.
name|ath_hal_sta_update_tx_pwr_enable
operator|&&
operator|(
operator|(
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|green_tx_status
operator|==
name|HAL_RSSI_TX_POWER_SHORT
operator|)
operator|||
operator|(
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|green_tx_status
operator|==
name|HAL_RSSI_TX_POWER_MIDDLE
operator|)
operator|)
condition|)
block|{
return|return
name|AH_TRUE
return|;
block|}
return|return
name|AH_FALSE
return|;
block|}
end_function

begin_function
name|void
name|ar9300_control_signals_for_green_tx_mode
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|unsigned
name|int
name|valid_obdb_0_b0
init|=
literal|0x2d
decl_stmt|;
comment|// 5,5 - dB[0:2],oB[5:3]
name|unsigned
name|int
name|valid_obdb_1_b0
init|=
literal|0x25
decl_stmt|;
comment|// 4,5 - dB[0:2],oB[5:3]
name|unsigned
name|int
name|valid_obdb_2_b0
init|=
literal|0x1d
decl_stmt|;
comment|// 3,5 - dB[0:2],oB[5:3]
name|unsigned
name|int
name|valid_obdb_3_b0
init|=
literal|0x15
decl_stmt|;
comment|// 2,5 - dB[0:2],oB[5:3]
name|unsigned
name|int
name|valid_obdb_4_b0
init|=
literal|0xd
decl_stmt|;
comment|// 1,5 - dB[0:2],oB[5:3]
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
if|if
condition|(
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
operator|&&
name|ahp
operator|->
name|ah_hw_green_tx_enable
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_VALID_OBDB_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_VALID_OBDB_0
argument_list|,
name|valid_obdb_0_b0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_VALID_OBDB_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_VALID_OBDB_1
argument_list|,
name|valid_obdb_1_b0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_VALID_OBDB_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_VALID_OBDB_2
argument_list|,
name|valid_obdb_2_b0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_VALID_OBDB_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_VALID_OBDB_3
argument_list|,
name|valid_obdb_3_b0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_VALID_OBDB_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_VALID_OBDB_4
argument_list|,
name|valid_obdb_4_b0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ar9300_hwgreentx_set_pal_spare
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|int
name|value
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
if|if
condition|(
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
operator|&&
name|ahp
operator|->
name|ah_hw_green_tx_enable
condition|)
block|{
if|if
condition|(
operator|(
name|value
operator|==
literal|0
operator|)
operator|||
operator|(
name|value
operator|==
literal|1
operator|)
condition|)
block|{
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TXRF3
argument_list|,
name|AR_PHY_65NM_CH0_TXRF3_OLD_PAL_SPARE
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|ar9300_reset_hw_beacon_proc_crc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_HWBCNPROC1
argument_list|,
name|AR_HWBCNPROC1_RESET_CRC
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int32_t
name|ar9300_get_hw_beacon_rssi
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|int32_t
name|val
init|=
name|OS_REG_READ_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_BCN_RSSI_AVE
argument_list|,
name|AR_BCN_RSSI_AVE_VAL
argument_list|)
decl_stmt|;
comment|/* RSSI format is 8.4.  Ignore lowest four bits */
name|val
operator|=
name|val
operator|>>
literal|4
expr_stmt|;
return|return
name|val
return|;
block|}
end_function

begin_function
name|void
name|ar9300_set_hw_beacon_rssi_threshold
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int32_t
name|rssi_threshold
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_RSSI_THR
argument_list|,
name|AR_RSSI_THR_VAL
argument_list|,
name|rssi_threshold
argument_list|)
expr_stmt|;
comment|/* save value for restoring after chip reset */
name|ahp
operator|->
name|ah_beacon_rssi_threshold
operator|=
name|rssi_threshold
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9300_reset_hw_beacon_rssi
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_RSSI_THR
argument_list|,
name|AR_RSSI_BCN_RSSI_RST
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9300_set_hw_beacon_proc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|on
parameter_list|)
block|{
if|if
condition|(
name|on
condition|)
block|{
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_HWBCNPROC1
argument_list|,
name|AR_HWBCNPROC1_CRC_ENABLE
operator||
name|AR_HWBCNPROC1_EXCLUDE_TIM_ELM
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_HWBCNPROC1
argument_list|,
name|AR_HWBCNPROC1_CRC_ENABLE
operator||
name|AR_HWBCNPROC1_EXCLUDE_TIM_ELM
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Gets the contents of the specified key cache entry.  */
end_comment

begin_function
name|HAL_BOOL
name|ar9300_print_keycache
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
specifier|const
name|HAL_CAPABILITIES
modifier|*
name|p_cap
init|=
operator|&
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_caps
decl_stmt|;
name|u_int32_t
name|key0
decl_stmt|,
name|key1
decl_stmt|,
name|key2
decl_stmt|,
name|key3
decl_stmt|,
name|key4
decl_stmt|;
name|u_int32_t
name|mac_hi
decl_stmt|,
name|mac_lo
decl_stmt|;
name|u_int16_t
name|entry
init|=
literal|0
decl_stmt|;
name|u_int32_t
name|valid
init|=
literal|0
decl_stmt|;
name|u_int32_t
name|key_type
decl_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"Slot   Key\t\t\t          Valid  Type  Mac  \n"
argument_list|)
expr_stmt|;
for|for
control|(
name|entry
operator|=
literal|0
init|;
name|entry
operator|<
name|p_cap
operator|->
name|halKeyCacheSize
condition|;
name|entry
operator|++
control|)
block|{
name|key0
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_KEYTABLE_KEY0
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|key1
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_KEYTABLE_KEY1
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|key2
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_KEYTABLE_KEY2
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|key3
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_KEYTABLE_KEY3
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|key4
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_KEYTABLE_KEY4
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|key_type
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_KEYTABLE_TYPE
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|mac_lo
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_KEYTABLE_MAC0
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|mac_hi
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_KEYTABLE_MAC1
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mac_hi
operator|&
name|AR_KEYTABLE_VALID
condition|)
block|{
name|valid
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|valid
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|mac_hi
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|mac_lo
operator|!=
literal|0
operator|)
condition|)
block|{
name|mac_hi
operator|&=
operator|~
literal|0x8000
expr_stmt|;
name|mac_hi
operator|<<=
literal|1
expr_stmt|;
name|mac_hi
operator||=
operator|(
operator|(
name|mac_lo
operator|&
operator|(
literal|1
operator|<<
literal|31
operator|)
operator|)
operator|)
operator|>>
literal|31
expr_stmt|;
name|mac_lo
operator|<<=
literal|1
expr_stmt|;
block|}
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"%03d    "
literal|"%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x%02x"
literal|"   %02d     %02d    "
literal|"%02x:%02x:%02x:%02x:%02x:%02x \n"
argument_list|,
name|entry
argument_list|,
operator|(
name|key0
operator|<<
literal|24
operator|)
operator|>>
literal|24
argument_list|,
operator|(
name|key0
operator|<<
literal|16
operator|)
operator|>>
literal|24
argument_list|,
operator|(
name|key0
operator|<<
literal|8
operator|)
operator|>>
literal|24
argument_list|,
name|key0
operator|>>
literal|24
argument_list|,
operator|(
name|key1
operator|<<
literal|24
operator|)
operator|>>
literal|24
argument_list|,
operator|(
name|key1
operator|<<
literal|16
operator|)
operator|>>
literal|24
argument_list|,
comment|//(key1<< 8)>> 24, key1>> 24,
operator|(
name|key2
operator|<<
literal|24
operator|)
operator|>>
literal|24
argument_list|,
operator|(
name|key2
operator|<<
literal|16
operator|)
operator|>>
literal|24
argument_list|,
operator|(
name|key2
operator|<<
literal|8
operator|)
operator|>>
literal|24
argument_list|,
name|key2
operator|>>
literal|24
argument_list|,
operator|(
name|key3
operator|<<
literal|24
operator|)
operator|>>
literal|24
argument_list|,
operator|(
name|key3
operator|<<
literal|16
operator|)
operator|>>
literal|24
argument_list|,
comment|//(key3<< 8)>> 24, key3>> 24,
operator|(
name|key4
operator|<<
literal|24
operator|)
operator|>>
literal|24
argument_list|,
operator|(
name|key4
operator|<<
literal|16
operator|)
operator|>>
literal|24
argument_list|,
operator|(
name|key4
operator|<<
literal|8
operator|)
operator|>>
literal|24
argument_list|,
name|key4
operator|>>
literal|24
argument_list|,
name|valid
argument_list|,
name|key_type
argument_list|,
operator|(
name|mac_lo
operator|<<
literal|24
operator|)
operator|>>
literal|24
argument_list|,
operator|(
name|mac_lo
operator|<<
literal|16
operator|)
operator|>>
literal|24
argument_list|,
operator|(
name|mac_lo
operator|<<
literal|8
operator|)
operator|>>
literal|24
argument_list|,
operator|(
name|mac_lo
operator|)
operator|>>
literal|24
argument_list|,
operator|(
name|mac_hi
operator|<<
literal|24
operator|)
operator|>>
literal|24
argument_list|,
operator|(
name|mac_hi
operator|<<
literal|16
operator|)
operator|>>
literal|24
argument_list|)
expr_stmt|;
block|}
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_comment
comment|/* enable/disable smart antenna mode */
end_comment

begin_function
name|HAL_BOOL
name|ar9300_set_smart_antenna
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|enable
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
if|if
condition|(
name|enable
condition|)
block|{
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_XRTO
argument_list|,
name|AR_ENABLE_SMARTANTENNA
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_XRTO
argument_list|,
name|AR_ENABLE_SMARTANTENNA
argument_list|)
expr_stmt|;
block|}
comment|/* if scropion and smart antenna is enabled, write swcom1 with 0x440      * and swcom2 with 0      * FIXME Ideally these registers need to be made read from caldata.      * Until the calibration team gets them, keep them along with board      * configuration.      */
if|if
condition|(
name|enable
operator|&&
name|AR_SREV_SCORPION
argument_list|(
name|ah
argument_list|)
operator|&&
operator|(
name|HAL_OK
operator|==
name|ar9300_get_capability
argument_list|(
name|ah
argument_list|,
name|HAL_CAP_SMARTANTENNA
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|)
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_SWITCH_COM
argument_list|,
literal|0x440
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_SWITCH_COM_2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|ahp
operator|->
name|ah_smartantenna_enable
operator|=
name|enable
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|ATH_TX99_DIAG
end_ifdef

begin_ifndef
ifndef|#
directive|ifndef
name|ATH_SUPPORT_HTC
end_ifndef

begin_function
name|void
name|ar9300_tx99_channel_pwr_update
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_CHANNEL
modifier|*
name|c
parameter_list|,
name|u_int32_t
name|txpower
parameter_list|)
block|{
define|#
directive|define
name|PWR_MAS
parameter_list|(
name|_r
parameter_list|,
name|_s
parameter_list|)
value|(((_r)& 0x3f)<< (_s))
specifier|static
name|int16_t
name|p_pwr_array
index|[
name|ar9300_rate_size
index|]
init|=
block|{
literal|0
block|}
decl_stmt|;
name|int32_t
name|i
decl_stmt|;
comment|/* The max power is limited to 63 */
if|if
condition|(
name|txpower
operator|<=
name|AR9300_MAX_RATE_POWER
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ar9300_rate_size
condition|;
name|i
operator|++
control|)
block|{
name|p_pwr_array
index|[
name|i
index|]
operator|=
name|txpower
expr_stmt|;
block|}
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ar9300_rate_size
condition|;
name|i
operator|++
control|)
block|{
name|p_pwr_array
index|[
name|i
index|]
operator|=
name|AR9300_MAX_RATE_POWER
expr_stmt|;
block|}
block|}
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa458
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Write the OFDM power per rate set */
comment|/* 6 (LSB), 9, 12, 18 (MSB) */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa3c0
argument_list|,
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_LEGACY_6_24
index|]
argument_list|,
literal|24
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_LEGACY_6_24
index|]
argument_list|,
literal|16
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_LEGACY_6_24
index|]
argument_list|,
literal|8
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_LEGACY_6_24
index|]
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 24 (LSB), 36, 48, 54 (MSB) */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa3c4
argument_list|,
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_LEGACY_54
index|]
argument_list|,
literal|24
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_LEGACY_48
index|]
argument_list|,
literal|16
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_LEGACY_36
index|]
argument_list|,
literal|8
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_LEGACY_6_24
index|]
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Write the CCK power per rate set */
comment|/* 1L (LSB), reserved, 2L, 2S (MSB) */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa3c8
argument_list|,
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_LEGACY_1L_5L
index|]
argument_list|,
literal|24
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_LEGACY_1L_5L
index|]
argument_list|,
literal|16
argument_list|)
comment|/* | PWR_MAS(txPowerTimes2,  8) */
comment|/* this is reserved for Osprey */
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_LEGACY_1L_5L
index|]
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 5.5L (LSB), 5.5S, 11L, 11S (MSB) */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa3cc
argument_list|,
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_LEGACY_11S
index|]
argument_list|,
literal|24
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_LEGACY_11L
index|]
argument_list|,
literal|16
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_LEGACY_5S
index|]
argument_list|,
literal|8
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_LEGACY_1L_5L
index|]
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Write the HT20 power per rate set */
comment|/* 0/8/16 (LSB), 1-3/9-11/17-19, 4, 5 (MSB) */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa3d0
argument_list|,
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT20_5
index|]
argument_list|,
literal|24
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT20_4
index|]
argument_list|,
literal|16
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT20_1_3_9_11_17_19
index|]
argument_list|,
literal|8
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT20_0_8_16
index|]
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 6 (LSB), 7, 12, 13 (MSB) */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa3d4
argument_list|,
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT20_13
index|]
argument_list|,
literal|24
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT20_12
index|]
argument_list|,
literal|16
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT20_7
index|]
argument_list|,
literal|8
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT20_6
index|]
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 14 (LSB), 15, 20, 21 */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa3e4
argument_list|,
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT20_21
index|]
argument_list|,
literal|24
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT20_20
index|]
argument_list|,
literal|16
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT20_15
index|]
argument_list|,
literal|8
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT20_14
index|]
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Mixed HT20 and HT40 rates */
comment|/* HT20 22 (LSB), HT20 23, HT40 22, HT40 23 (MSB) */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa3e8
argument_list|,
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT40_23
index|]
argument_list|,
literal|24
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT40_22
index|]
argument_list|,
literal|16
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT20_23
index|]
argument_list|,
literal|8
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT20_22
index|]
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Write the HT40 power per rate set */
comment|/* correct PAR difference between HT40 and HT20/LEGACY */
comment|/* 0/8/16 (LSB), 1-3/9-11/17-19, 4, 5 (MSB) */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa3d8
argument_list|,
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT40_5
index|]
argument_list|,
literal|24
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT40_4
index|]
argument_list|,
literal|16
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT40_1_3_9_11_17_19
index|]
argument_list|,
literal|8
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT40_0_8_16
index|]
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 6 (LSB), 7, 12, 13 (MSB) */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa3dc
argument_list|,
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT40_13
index|]
argument_list|,
literal|24
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT40_12
index|]
argument_list|,
literal|16
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT40_7
index|]
argument_list|,
literal|8
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT40_6
index|]
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 14 (LSB), 15, 20, 21 */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa3ec
argument_list|,
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT40_21
index|]
argument_list|,
literal|24
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT40_20
index|]
argument_list|,
literal|16
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT40_15
index|]
argument_list|,
literal|8
argument_list|)
operator||
name|PWR_MAS
argument_list|(
name|p_pwr_array
index|[
name|ALL_TARGET_HT40_14
index|]
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|PWR_MAS
block|}
end_function

begin_function
name|void
name|ar9300_tx99_chainmsk_setup
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|int
name|tx_chainmask
parameter_list|)
block|{
if|if
condition|(
name|tx_chainmask
operator|==
literal|0x5
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_ANALOG_SWAP
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_ANALOG_SWAP
argument_list|)
operator||
name|AR_PHY_SWAP_ALT_CHAIN
argument_list|)
expr_stmt|;
block|}
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_RX_CHAINMASK
argument_list|,
name|tx_chainmask
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CAL_CHAINMASK
argument_list|,
name|tx_chainmask
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_SELFGEN_MASK
argument_list|,
name|tx_chainmask
argument_list|)
expr_stmt|;
if|if
condition|(
name|tx_chainmask
operator|==
literal|0x5
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_ANALOG_SWAP
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_ANALOG_SWAP
argument_list|)
operator||
name|AR_PHY_SWAP_ALT_CHAIN
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ar9300_tx99_set_single_carrier
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|int
name|tx_chain_mask
parameter_list|,
name|int
name|chtype
parameter_list|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0x98a4
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
literal|0x98a4
argument_list|)
operator||
operator|(
literal|0x7ff
operator|<<
literal|11
operator|)
operator||
literal|0x7ff
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa364
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
literal|0xa364
argument_list|)
operator||
operator|(
literal|1
operator|<<
literal|7
operator|)
operator||
operator|(
literal|1
operator|<<
literal|1
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa350
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
literal|0xa350
argument_list|)
operator||
operator|(
literal|1
operator|<<
literal|31
operator|)
operator||
operator|(
literal|1
operator|<<
literal|15
operator|)
operator|)
operator|&
operator|~
operator|(
literal|1
operator|<<
literal|13
operator|)
argument_list|)
expr_stmt|;
comment|/* 11G mode */
if|if
condition|(
operator|!
name|chtype
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_RXTX2
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_RXTX2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|2
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|AR_SREV_OSPREY
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TOP
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TOP
argument_list|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|4
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TOP2
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TOP2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|26
operator|)
operator||
operator|(
literal|0x7
operator|<<
literal|24
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|22
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_HORNET_CH0_TOP
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_HORNET_CH0_TOP
argument_list|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|4
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_HORNET_CH0_TOP2
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_HORNET_CH0_TOP2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|26
operator|)
operator||
operator|(
literal|0x7
operator|<<
literal|24
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|22
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* chain zero */
if|if
condition|(
operator|(
name|tx_chain_mask
operator|&
literal|0x01
operator|)
operator|==
literal|0x01
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_RXTX1
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_RXTX1
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|31
operator|)
operator||
operator|(
literal|0x5
operator|<<
literal|15
operator|)
operator||
operator|(
literal|0x3
operator|<<
literal|9
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|27
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|12
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_RXTX2
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_RXTX2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|12
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|10
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|9
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|8
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|7
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|11
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_RXTX3
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_RXTX3
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|29
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|25
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|23
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|19
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|10
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|9
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|8
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|28
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|24
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|22
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|7
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TXRF1
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TXRF1
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|23
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|21
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_BB1
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_BB1
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|12
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|10
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|9
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|8
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|6
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|5
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|4
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|2
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_BB2
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_BB2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|31
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|AR_SREV_OSPREY
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
condition|)
block|{
comment|/* chain one */
if|if
condition|(
operator|(
name|tx_chain_mask
operator|&
literal|0x02
operator|)
operator|==
literal|0x02
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_RXTX1
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_RXTX1
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|31
operator|)
operator||
operator|(
literal|0x5
operator|<<
literal|15
operator|)
operator||
operator|(
literal|0x3
operator|<<
literal|9
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|27
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|12
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_RXTX2
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_RXTX2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|12
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|10
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|9
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|8
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|7
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|11
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_RXTX3
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_RXTX3
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|29
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|25
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|23
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|19
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|10
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|9
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|8
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|28
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|24
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|22
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|7
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_TXRF1
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_TXRF1
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|23
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|21
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_BB1
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_BB1
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|12
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|10
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|9
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|8
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|6
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|5
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|4
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|2
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_BB2
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_BB2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|31
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|AR_SREV_OSPREY
argument_list|(
name|ah
argument_list|)
condition|)
block|{
comment|/* chain two */
if|if
condition|(
operator|(
name|tx_chain_mask
operator|&
literal|0x04
operator|)
operator|==
literal|0x04
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_RXTX1
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_RXTX1
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|31
operator|)
operator||
operator|(
literal|0x5
operator|<<
literal|15
operator|)
operator||
operator|(
literal|0x3
operator|<<
literal|9
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|27
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|12
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_RXTX2
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_RXTX2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|12
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|10
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|9
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|8
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|7
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|11
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_RXTX3
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_RXTX3
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|29
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|25
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|23
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|19
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|10
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|9
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|8
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|28
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|24
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|22
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|7
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_TXRF1
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_TXRF1
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|23
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|21
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_BB1
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_BB1
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|12
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|10
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|9
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|8
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|6
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|5
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|4
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|2
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_BB2
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_BB2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|31
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa28c
argument_list|,
literal|0x11111
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa288
argument_list|,
literal|0x111
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* chain zero */
if|if
condition|(
operator|(
name|tx_chain_mask
operator|&
literal|0x01
operator|)
operator|==
literal|0x01
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_RXTX1
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_RXTX1
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|31
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|27
operator|)
operator||
operator|(
literal|0x3
operator|<<
literal|23
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|19
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|15
operator|)
operator||
operator|(
literal|0x3
operator|<<
literal|9
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|12
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_RXTX2
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_RXTX2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|12
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|10
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|9
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|8
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|7
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|2
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|1
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|11
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|0
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_RXTX3
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_RXTX3
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|29
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|25
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|23
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|19
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|10
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|9
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|8
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|28
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|24
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|22
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|7
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TXRF1
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TXRF1
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|23
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|21
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TXRF2
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TXRF2
argument_list|)
operator||
operator|(
literal|0x3
operator|<<
literal|3
operator|)
operator||
operator|(
literal|0x3
operator|<<
literal|0
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TXRF3
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TXRF3
argument_list|)
operator||
operator|(
literal|0x3
operator|<<
literal|29
operator|)
operator||
operator|(
literal|0x3
operator|<<
literal|26
operator|)
operator||
operator|(
literal|0x2
operator|<<
literal|23
operator|)
operator||
operator|(
literal|0x2
operator|<<
literal|20
operator|)
operator||
operator|(
literal|0x2
operator|<<
literal|17
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|14
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_BB1
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_BB1
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|12
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|10
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|9
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|8
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|6
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|5
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|4
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|2
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_BB2
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_BB2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|31
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|AR_SREV_OSPREY
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TOP
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TOP
argument_list|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|4
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TOP2
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TOP2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|26
operator|)
operator||
operator|(
literal|0x7
operator|<<
literal|24
operator|)
operator||
operator|(
literal|0x3
operator|<<
literal|22
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_HORNET_CH0_TOP
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_HORNET_CH0_TOP
argument_list|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|4
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_HORNET_CH0_TOP2
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_HORNET_CH0_TOP2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|26
operator|)
operator||
operator|(
literal|0x7
operator|<<
literal|24
operator|)
operator||
operator|(
literal|0x3
operator|<<
literal|22
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|AR_SREV_OSPREY
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_RXTX2
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_RXTX2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|2
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|1
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|0
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_RXTX3
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_RXTX3
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|19
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_TXRF1
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_TXRF1
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|23
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|AR_SREV_OSPREY
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_RXTX2
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_RXTX2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|2
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|1
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|0
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_RXTX3
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_RXTX3
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|19
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_TXRF1
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_TXRF1
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|23
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|AR_SREV_OSPREY
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
condition|)
block|{
comment|/* chain one */
if|if
condition|(
operator|(
name|tx_chain_mask
operator|&
literal|0x02
operator|)
operator|==
literal|0x02
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_RXTX2
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_RXTX2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|2
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|1
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|0
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_RXTX3
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_RXTX3
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|19
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TXRF1
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TXRF1
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|23
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|AR_SREV_OSPREY
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TOP
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TOP
argument_list|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|4
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TOP2
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TOP2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|26
operator|)
operator||
operator|(
literal|0x7
operator|<<
literal|24
operator|)
operator||
operator|(
literal|0x3
operator|<<
literal|22
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_HORNET_CH0_TOP
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_HORNET_CH0_TOP
argument_list|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|4
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_HORNET_CH0_TOP2
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_HORNET_CH0_TOP2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|26
operator|)
operator||
operator|(
literal|0x7
operator|<<
literal|24
operator|)
operator||
operator|(
literal|0x3
operator|<<
literal|22
operator|)
argument_list|)
expr_stmt|;
block|}
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_RXTX1
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_RXTX1
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|31
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|27
operator|)
operator||
operator|(
literal|0x3
operator|<<
literal|23
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|19
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|15
operator|)
operator||
operator|(
literal|0x3
operator|<<
literal|9
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|12
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_RXTX2
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_RXTX2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|12
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|10
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|9
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|8
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|7
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|2
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|1
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|11
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|0
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_RXTX3
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_RXTX3
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|29
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|25
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|23
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|19
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|10
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|9
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|8
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|28
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|24
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|22
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|7
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_TXRF1
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_TXRF1
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|23
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|21
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_TXRF2
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_TXRF2
argument_list|)
operator||
operator|(
literal|0x3
operator|<<
literal|3
operator|)
operator||
operator|(
literal|0x3
operator|<<
literal|0
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_TXRF3
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_TXRF3
argument_list|)
operator||
operator|(
literal|0x3
operator|<<
literal|29
operator|)
operator||
operator|(
literal|0x3
operator|<<
literal|26
operator|)
operator||
operator|(
literal|0x2
operator|<<
literal|23
operator|)
operator||
operator|(
literal|0x2
operator|<<
literal|20
operator|)
operator||
operator|(
literal|0x2
operator|<<
literal|17
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|14
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_BB1
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_BB1
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|12
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|10
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|9
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|8
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|6
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|5
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|4
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|2
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_BB2
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_BB2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|31
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|AR_SREV_OSPREY
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_RXTX2
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_RXTX2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|2
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|1
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|0
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_RXTX3
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_RXTX3
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|19
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_TXRF1
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_TXRF1
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|23
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|AR_SREV_OSPREY
argument_list|(
name|ah
argument_list|)
condition|)
block|{
comment|/* chain two */
if|if
condition|(
operator|(
name|tx_chain_mask
operator|&
literal|0x04
operator|)
operator|==
literal|0x04
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_RXTX2
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_RXTX2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|2
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|1
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|0
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_RXTX3
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_RXTX3
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|19
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TXRF1
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TXRF1
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|23
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|AR_SREV_OSPREY
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TOP
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TOP
argument_list|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|4
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TOP2
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TOP2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|26
operator|)
operator||
operator|(
literal|0x7
operator|<<
literal|24
operator|)
operator||
operator|(
literal|0x3
operator|<<
literal|22
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_HORNET_CH0_TOP
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_HORNET_CH0_TOP
argument_list|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|4
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_HORNET_CH0_TOP2
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_HORNET_CH0_TOP2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|26
operator|)
operator||
operator|(
literal|0x7
operator|<<
literal|24
operator|)
operator||
operator|(
literal|0x3
operator|<<
literal|22
operator|)
argument_list|)
expr_stmt|;
block|}
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_RXTX2
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_RXTX2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|2
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|1
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|0
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_RXTX3
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_RXTX3
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|19
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_TXRF1
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH1_TXRF1
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|23
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_RXTX1
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_RXTX1
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|31
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|27
operator|)
operator||
operator|(
literal|0x3
operator|<<
literal|23
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|19
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|15
operator|)
operator||
operator|(
literal|0x3
operator|<<
literal|9
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|12
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_RXTX2
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_RXTX2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|12
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|10
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|9
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|8
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|7
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|2
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|1
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|11
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|0
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_RXTX3
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_RXTX3
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|29
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|25
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|23
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|19
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|10
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|9
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|8
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|28
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|24
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|22
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|7
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_TXRF1
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_TXRF1
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|23
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|21
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_TXRF2
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_TXRF2
argument_list|)
operator||
operator|(
literal|0x3
operator|<<
literal|3
operator|)
operator||
operator|(
literal|0x3
operator|<<
literal|0
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_TXRF3
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_TXRF3
argument_list|)
operator||
operator|(
literal|0x3
operator|<<
literal|29
operator|)
operator||
operator|(
literal|0x3
operator|<<
literal|26
operator|)
operator||
operator|(
literal|0x2
operator|<<
literal|23
operator|)
operator||
operator|(
literal|0x2
operator|<<
literal|20
operator|)
operator||
operator|(
literal|0x2
operator|<<
literal|17
operator|)
operator|)
operator|&
operator|~
operator|(
literal|0x1
operator|<<
literal|14
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_BB1
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_BB1
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|12
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|10
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|9
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|8
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|6
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|5
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|4
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|3
operator|)
operator||
operator|(
literal|0x1
operator|<<
literal|2
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_BB2
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH2_BB2
argument_list|)
operator||
operator|(
literal|0x1
operator|<<
literal|31
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa28c
argument_list|,
literal|0x22222
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
literal|0xa288
argument_list|,
literal|0x222
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ar9300_tx99_start
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int8_t
modifier|*
name|data
parameter_list|)
block|{
name|u_int32_t
name|val
decl_stmt|;
name|u_int32_t
name|qnum
init|=
operator|(
name|u_int32_t
operator|)
name|data
decl_stmt|;
comment|/* Disable AGC to A2 */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TEST
argument_list|,
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TEST
argument_list|)
operator||
name|PHY_AGC_CLR
operator|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_DIAG_SW
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_DIAG_SW
argument_list|)
operator|&
operator|~
name|AR_DIAG_RX_DIS
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_CR
argument_list|,
name|AR_CR_RXD
argument_list|)
expr_stmt|;
comment|/* set receive disable */
comment|/* set CW_MIN and CW_MAX both to 0, AIFS=2 */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_DLCL_IFS
argument_list|(
name|qnum
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_D_GBL_IFS_SIFS
argument_list|,
literal|20
argument_list|)
expr_stmt|;
comment|/* 50 OK */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_D_GBL_IFS_EIFS
argument_list|,
literal|20
argument_list|)
expr_stmt|;
comment|/* 200 ok for HT20, 400 ok for HT40 */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_TIME_OUT
argument_list|,
literal|0x00000400
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_DRETRY_LIMIT
argument_list|(
name|qnum
argument_list|)
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
comment|/* set QCU modes to early termination */
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_QMISC
argument_list|(
name|qnum
argument_list|)
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_QMISC
argument_list|(
name|qnum
argument_list|)
argument_list|,
name|val
operator||
name|AR_Q_MISC_DCU_EARLY_TERM_REQ
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9300_tx99_stop
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
comment|/* this should follow the setting of start */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TEST
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TEST
argument_list|)
operator|&
operator|~
name|PHY_AGC_CLR
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_DIAG_SW
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_DIAG_SW
argument_list|)
operator||
name|AR_DIAG_RX_DIS
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ATH_TX99_DIAG */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ATH_SUPPORT_HTC */
end_comment

begin_function
name|HAL_BOOL
name|ar9300Get3StreamSignature
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
return|return
name|AH_FALSE
return|;
block|}
end_function

begin_function
name|HAL_BOOL
name|ar9300ForceVCS
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
return|return
name|AH_FALSE
return|;
block|}
end_function

begin_function
name|HAL_BOOL
name|ar9300SetDfs3StreamFix
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int32_t
name|val
parameter_list|)
block|{
return|return
name|AH_FALSE
return|;
block|}
end_function

begin_function
name|HAL_BOOL
name|ar9300_set_ctl_pwr
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int8_t
modifier|*
name|ctl_array
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|ar9300_eeprom_t
modifier|*
name|p_eep_data
init|=
operator|&
name|ahp
operator|->
name|ah_eeprom
decl_stmt|;
name|u_int8_t
modifier|*
name|ctl_index
decl_stmt|;
name|u_int32_t
name|offset
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|ctl_array
condition|)
return|return
name|AH_FALSE
return|;
comment|/* copy 2G ctl freqbin and power data */
name|ctl_index
operator|=
name|p_eep_data
operator|->
name|ctl_index_2g
expr_stmt|;
name|OS_MEMCPY
argument_list|(
name|ctl_index
operator|+
name|OSPREY_NUM_CTLS_2G
argument_list|,
name|ctl_array
argument_list|,
name|OSPREY_NUM_CTLS_2G
operator|*
name|OSPREY_NUM_BAND_EDGES_2G
operator|+
comment|/* ctl_freqbin_2G */
name|OSPREY_NUM_CTLS_2G
operator|*
sizeof|sizeof
argument_list|(
name|OSP_CAL_CTL_DATA_2G
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ctl_power_data_2g */
name|offset
operator|=
operator|(
name|OSPREY_NUM_CTLS_2G
operator|*
name|OSPREY_NUM_BAND_EDGES_2G
operator|)
operator|+
operator|(
name|OSPREY_NUM_CTLS_2G
operator|*
sizeof|sizeof
argument_list|(
name|OSP_CAL_CTL_DATA_2G
argument_list|)
operator|)
expr_stmt|;
comment|/* copy 2G ctl freqbin and power data */
name|ctl_index
operator|=
name|p_eep_data
operator|->
name|ctl_index_5g
expr_stmt|;
name|OS_MEMCPY
argument_list|(
name|ctl_index
operator|+
name|OSPREY_NUM_CTLS_5G
argument_list|,
name|ctl_array
operator|+
name|offset
argument_list|,
name|OSPREY_NUM_CTLS_5G
operator|*
name|OSPREY_NUM_BAND_EDGES_5G
operator|+
comment|/* ctl_freqbin_5G */
name|OSPREY_NUM_CTLS_5G
operator|*
sizeof|sizeof
argument_list|(
name|OSP_CAL_CTL_DATA_5G
argument_list|)
argument_list|)
expr_stmt|;
comment|/* ctl_power_data_5g */
return|return
name|AH_FALSE
return|;
block|}
end_function

begin_function
name|void
name|ar9300_set_txchainmaskopt
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int8_t
name|mask
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
comment|/* optional txchainmask should be subset of primary txchainmask */
if|if
condition|(
operator|(
name|mask
operator|&
name|ahp
operator|->
name|ah_tx_chainmask
operator|)
operator|!=
name|mask
condition|)
block|{
name|ahp
operator|->
name|ah_tx_chainmaskopt
operator|=
literal|0
expr_stmt|;
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"Error: ah_tx_chainmask=%d, mask=%d\n"
argument_list|,
name|ahp
operator|->
name|ah_tx_chainmask
argument_list|,
name|mask
argument_list|)
expr_stmt|;
return|return;
block|}
name|ahp
operator|->
name|ah_tx_chainmaskopt
operator|=
name|mask
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2013 Qualcomm Atheros, Inc.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR  * OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|"opt_ah.h"
end_include

begin_include
include|#
directive|include
file|"ah.h"
end_include

begin_include
include|#
directive|include
file|"ah_desc.h"
end_include

begin_include
include|#
directive|include
file|"ah_internal.h"
end_include

begin_include
include|#
directive|include
file|"ar9300/ar9300.h"
end_include

begin_include
include|#
directive|include
file|"ar9300/ar9300reg.h"
end_include

begin_include
include|#
directive|include
file|"ar9300/ar9300desc.h"
end_include

begin_comment
comment|/*  * Process an RX descriptor, and return the status to the caller.  * Copy some hardware specific items into the software portion  * of the descriptor.  *  * NB: the caller is responsible for validating the memory contents  *     of the descriptor (e.g. flushing any cached copy).  */
end_comment

begin_function
name|HAL_STATUS
name|ar9300_proc_rx_desc_fast
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|u_int32_t
name|pa
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|nds
parameter_list|,
name|struct
name|ath_rx_status
modifier|*
name|rxs
parameter_list|,
name|void
modifier|*
name|buf_addr
parameter_list|)
block|{
name|struct
name|ar9300_rxs
modifier|*
name|rxsp
init|=
name|AR9300RXS
argument_list|(
name|buf_addr
argument_list|)
decl_stmt|;
comment|/*     ath_hal_printf(ah,"CHH=RX: ds_info 0x%x  status1: 0x%x  status11: 0x%x\n",                         rxsp->ds_info,rxsp->status1,rxsp->status11);      */
if|if
condition|(
operator|(
name|rxsp
operator|->
name|status11
operator|&
name|AR_rx_done
operator|)
operator|==
literal|0
condition|)
block|{
return|return
name|HAL_EINPROGRESS
return|;
block|}
if|if
condition|(
name|MS
argument_list|(
name|rxsp
operator|->
name|ds_info
argument_list|,
name|AR_desc_id
argument_list|)
operator|!=
literal|0x168c
condition|)
block|{
if|#
directive|if
name|__PKT_SERIOUS_ERRORS__
comment|/*BUG: 63564-HT */
name|HALDEBUG
argument_list|(
name|AH_NULL
argument_list|,
name|HAL_DEBUG_UNMASKABLE
argument_list|,
literal|"%s: Rx Descriptor error 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|rxsp
operator|->
name|ds_info
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|HAL_EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|rxsp
operator|->
name|ds_info
operator|&
operator|(
name|AR_tx_rx_desc
operator||
name|AR_ctrl_stat
operator|)
operator|)
operator|!=
literal|0
condition|)
block|{
if|#
directive|if
name|__PKT_SERIOUS_ERRORS__
name|HALDEBUG
argument_list|(
name|AH_NULL
argument_list|,
name|HAL_DEBUG_UNMASKABLE
argument_list|,
literal|"%s: Rx Descriptor wrong info 0x%x\n"
argument_list|,
name|__func__
argument_list|,
name|rxsp
operator|->
name|ds_info
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|HAL_EINPROGRESS
return|;
block|}
name|rxs
operator|->
name|rs_status
operator|=
literal|0
expr_stmt|;
name|rxs
operator|->
name|rs_flags
operator|=
literal|0
expr_stmt|;
name|rxs
operator|->
name|rs_phyerr
operator|=
literal|0
expr_stmt|;
name|rxs
operator|->
name|rs_datalen
operator|=
name|rxsp
operator|->
name|status2
operator|&
name|AR_data_len
expr_stmt|;
name|rxs
operator|->
name|rs_tstamp
operator|=
name|rxsp
operator|->
name|status3
expr_stmt|;
comment|/* XXX what about key_cache_miss? */
name|rxs
operator|->
name|rs_rssi
operator|=
name|MS
argument_list|(
name|rxsp
operator|->
name|status5
argument_list|,
name|AR_rx_rssi_combined
argument_list|)
expr_stmt|;
name|rxs
operator|->
name|rs_rssi_ctl
index|[
literal|0
index|]
operator|=
name|MS
argument_list|(
name|rxsp
operator|->
name|status1
argument_list|,
name|AR_rx_rssi_ant00
argument_list|)
expr_stmt|;
name|rxs
operator|->
name|rs_rssi_ctl
index|[
literal|1
index|]
operator|=
name|MS
argument_list|(
name|rxsp
operator|->
name|status1
argument_list|,
name|AR_rx_rssi_ant01
argument_list|)
expr_stmt|;
name|rxs
operator|->
name|rs_rssi_ctl
index|[
literal|2
index|]
operator|=
name|MS
argument_list|(
name|rxsp
operator|->
name|status1
argument_list|,
name|AR_rx_rssi_ant02
argument_list|)
expr_stmt|;
name|rxs
operator|->
name|rs_rssi_ext
index|[
literal|0
index|]
operator|=
name|MS
argument_list|(
name|rxsp
operator|->
name|status5
argument_list|,
name|AR_rx_rssi_ant10
argument_list|)
expr_stmt|;
name|rxs
operator|->
name|rs_rssi_ext
index|[
literal|1
index|]
operator|=
name|MS
argument_list|(
name|rxsp
operator|->
name|status5
argument_list|,
name|AR_rx_rssi_ant11
argument_list|)
expr_stmt|;
name|rxs
operator|->
name|rs_rssi_ext
index|[
literal|2
index|]
operator|=
name|MS
argument_list|(
name|rxsp
operator|->
name|status5
argument_list|,
name|AR_rx_rssi_ant12
argument_list|)
expr_stmt|;
if|if
condition|(
name|rxsp
operator|->
name|status11
operator|&
name|AR_rx_key_idx_valid
condition|)
block|{
name|rxs
operator|->
name|rs_keyix
operator|=
name|MS
argument_list|(
name|rxsp
operator|->
name|status11
argument_list|,
name|AR_key_idx
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rxs
operator|->
name|rs_keyix
operator|=
name|HAL_RXKEYIX_INVALID
expr_stmt|;
block|}
comment|/* NB: caller expected to do rate table mapping */
name|rxs
operator|->
name|rs_rate
operator|=
name|MS
argument_list|(
name|rxsp
operator|->
name|status1
argument_list|,
name|AR_rx_rate
argument_list|)
expr_stmt|;
name|rxs
operator|->
name|rs_more
operator|=
operator|(
name|rxsp
operator|->
name|status2
operator|&
name|AR_rx_more
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|rxs
operator|->
name|rs_isaggr
operator|=
operator|(
name|rxsp
operator|->
name|status11
operator|&
name|AR_rx_aggr
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|rxs
operator|->
name|rs_moreaggr
operator|=
operator|(
name|rxsp
operator|->
name|status11
operator|&
name|AR_rx_more_aggr
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|rxs
operator|->
name|rs_antenna
operator|=
operator|(
name|MS
argument_list|(
name|rxsp
operator|->
name|status4
argument_list|,
name|AR_rx_antenna
argument_list|)
operator|&
literal|0x7
operator|)
expr_stmt|;
name|rxs
operator|->
name|rs_flags
operator|=
operator|(
name|rxsp
operator|->
name|status11
operator|&
name|AR_apsd_trig
operator|)
condition|?
name|HAL_RX_IS_APSD
else|:
literal|0
expr_stmt|;
name|rxs
operator|->
name|rs_flags
operator||=
operator|(
name|rxsp
operator|->
name|status4
operator|&
name|AR_gi
operator|)
condition|?
name|HAL_RX_GI
else|:
literal|0
expr_stmt|;
name|rxs
operator|->
name|rs_flags
operator||=
operator|(
name|rxsp
operator|->
name|status4
operator|&
name|AR_2040
operator|)
condition|?
name|HAL_RX_2040
else|:
literal|0
expr_stmt|;
comment|/* Copy EVM information */
name|rxs
operator|->
name|rs_evm0
operator|=
name|rxsp
operator|->
name|status6
expr_stmt|;
name|rxs
operator|->
name|rs_evm1
operator|=
name|rxsp
operator|->
name|status7
expr_stmt|;
name|rxs
operator|->
name|rs_evm2
operator|=
name|rxsp
operator|->
name|status8
expr_stmt|;
name|rxs
operator|->
name|rs_evm3
operator|=
name|rxsp
operator|->
name|status9
expr_stmt|;
name|rxs
operator|->
name|rs_evm4
operator|=
operator|(
name|rxsp
operator|->
name|status10
operator|&
literal|0xffff
operator|)
expr_stmt|;
if|if
condition|(
name|rxsp
operator|->
name|status11
operator|&
name|AR_pre_delim_crc_err
condition|)
block|{
name|rxs
operator|->
name|rs_flags
operator||=
name|HAL_RX_DELIM_CRC_PRE
expr_stmt|;
block|}
if|if
condition|(
name|rxsp
operator|->
name|status11
operator|&
name|AR_post_delim_crc_err
condition|)
block|{
name|rxs
operator|->
name|rs_flags
operator||=
name|HAL_RX_DELIM_CRC_POST
expr_stmt|;
block|}
if|if
condition|(
name|rxsp
operator|->
name|status11
operator|&
name|AR_decrypt_busy_err
condition|)
block|{
name|rxs
operator|->
name|rs_flags
operator||=
name|HAL_RX_DECRYPT_BUSY
expr_stmt|;
block|}
if|if
condition|(
name|rxsp
operator|->
name|status11
operator|&
name|AR_hi_rx_chain
condition|)
block|{
name|rxs
operator|->
name|rs_flags
operator||=
name|HAL_RX_HI_RX_CHAIN
expr_stmt|;
block|}
if|if
condition|(
name|rxsp
operator|->
name|status11
operator|&
name|AR_key_miss
condition|)
block|{
name|rxs
operator|->
name|rs_status
operator||=
name|HAL_RXERR_KEYMISS
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|rxsp
operator|->
name|status11
operator|&
name|AR_rx_frame_ok
operator|)
operator|==
literal|0
condition|)
block|{
comment|/*          * These four bits should not be set together.  The          * 9300 spec states a Michael error can only occur if          * decrypt_crc_err not set (and TKIP is used).  Experience          * indicates however that you can also get Michael errors          * when a CRC error is detected, but these are specious.          * Consequently we filter them out here so we don't          * confuse and/or complicate drivers.          */
if|if
condition|(
name|rxsp
operator|->
name|status11
operator|&
name|AR_crc_err
condition|)
block|{
name|rxs
operator|->
name|rs_status
operator||=
name|HAL_RXERR_CRC
expr_stmt|;
comment|/*  			 * ignore CRC flag for phy reports 			 */
if|if
condition|(
name|rxsp
operator|->
name|status11
operator|&
name|AR_phyerr
condition|)
block|{
name|u_int
name|phyerr
init|=
name|MS
argument_list|(
name|rxsp
operator|->
name|status11
argument_list|,
name|AR_phy_err_code
argument_list|)
decl_stmt|;
name|rxs
operator|->
name|rs_status
operator||=
name|HAL_RXERR_PHY
expr_stmt|;
name|rxs
operator|->
name|rs_phyerr
operator|=
name|phyerr
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|rxsp
operator|->
name|status11
operator|&
name|AR_phyerr
condition|)
block|{
name|u_int
name|phyerr
decl_stmt|;
comment|/*              * Packets with OFDM_RESTART on post delimiter are CRC OK and              * usable and MAC ACKs them.              * To avoid packet from being lost, we remove the PHY Err flag              * so that lmac layer does not drop them.              * (EV 70071)              */
name|phyerr
operator|=
name|MS
argument_list|(
name|rxsp
operator|->
name|status11
argument_list|,
name|AR_phy_err_code
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|phyerr
operator|==
name|HAL_PHYERR_OFDM_RESTART
operator|)
operator|&&
operator|(
name|rxsp
operator|->
name|status11
operator|&
name|AR_post_delim_crc_err
operator|)
condition|)
block|{
name|rxs
operator|->
name|rs_phyerr
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|rxs
operator|->
name|rs_status
operator||=
name|HAL_RXERR_PHY
expr_stmt|;
name|rxs
operator|->
name|rs_phyerr
operator|=
name|phyerr
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|rxsp
operator|->
name|status11
operator|&
name|AR_decrypt_crc_err
condition|)
block|{
name|rxs
operator|->
name|rs_status
operator||=
name|HAL_RXERR_DECRYPT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rxsp
operator|->
name|status11
operator|&
name|AR_michael_err
condition|)
block|{
name|rxs
operator|->
name|rs_status
operator||=
name|HAL_RXERR_MIC
expr_stmt|;
block|}
block|}
if|#
directive|if
literal|0
block|rxs->rs_channel = AH_PRIVATE(ah)->ah_curchan->channel;
endif|#
directive|endif
return|return
name|HAL_OK
return|;
block|}
end_function

begin_function
name|HAL_STATUS
name|ar9300_proc_rx_desc
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|u_int32_t
name|pa
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|nds
parameter_list|,
name|u_int64_t
name|tsf
parameter_list|,
name|struct
name|ath_rx_status
modifier|*
name|rxs
parameter_list|)
block|{
return|return
name|HAL_ENOTSUPP
return|;
block|}
end_function

begin_comment
comment|/*  * rx path in ISR is different for ar9300 from ar5416, and  * ath_rx_proc_descfast will not be called if edmasupport is true.  * So this function ath_hal_get_rxkeyidx will not be   * called for ar9300.  * This function in ar9300's HAL is just a stub one because we need   * to link something to the callback interface of the HAL module.  */
end_comment

begin_function
name|HAL_STATUS
name|ar9300_get_rx_key_idx
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ath_desc
modifier|*
name|ds
parameter_list|,
name|u_int8_t
modifier|*
name|keyix
parameter_list|,
name|u_int8_t
modifier|*
name|status
parameter_list|)
block|{
operator|*
name|status
operator|=
literal|0
expr_stmt|;
operator|*
name|keyix
operator|=
name|HAL_RXKEYIX_INVALID
expr_stmt|;
return|return
name|HAL_ENOTSUPP
return|;
block|}
end_function

end_unit


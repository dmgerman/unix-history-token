begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2013 Qualcomm Atheros, Inc.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR  * OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|"opt_ah.h"
end_include

begin_include
include|#
directive|include
file|"ah.h"
end_include

begin_include
include|#
directive|include
file|"ar9300.h"
end_include

begin_include
include|#
directive|include
file|"ah_internal.h"
end_include

begin_include
include|#
directive|include
file|"ar9300paprd.h"
end_include

begin_include
include|#
directive|include
file|"ar9300reg.h"
end_include

begin_if
if|#
directive|if
name|ATH_SUPPORT_PAPRD
end_if

begin_decl_stmt
specifier|static
name|struct
name|ar9300_paprd_pwr_adjust
name|ar9300_paprd_pwr_adj_array
index|[]
init|=
block|{
comment|/*   rate index     ,   register offset   ,  mask of register               , */
block|{
name|ALL_TARGET_HT20_5
block|,
name|AR_PHY_POWERTX_RATE5
block|,
name|AR_PHY_POWERTX_RATE5_POWERTXHT20_3
block|,
comment|/* mask offset of register             ,  offset  dB*/
name|AR_PHY_POWERTX_RATE5_POWERTXHT20_3_S
block|,
literal|1
block|}
block|,
block|{
name|ALL_TARGET_HT20_6
block|,
name|AR_PHY_POWERTX_RATE6
block|,
name|AR_PHY_POWERTX_RATE6_POWERTXHT20_4
block|,
name|AR_PHY_POWERTX_RATE6_POWERTXHT20_4_S
block|,
literal|2
block|}
block|,
block|{
name|ALL_TARGET_HT20_7
block|,
name|AR_PHY_POWERTX_RATE6
block|,
name|AR_PHY_POWERTX_RATE6_POWERTXHT20_5
block|,
name|AR_PHY_POWERTX_RATE6_POWERTXHT20_5_S
block|,
literal|2
block|}
block|,
block|{
name|ALL_TARGET_HT40_5
block|,
name|AR_PHY_POWERTX_RATE7
block|,
name|AR_PHY_POWERTX_RATE7_POWERTXHT40_3
block|,
name|AR_PHY_POWERTX_RATE7_POWERTXHT40_3_S
block|,
literal|1
block|}
block|,
block|{
name|ALL_TARGET_HT40_6
block|,
name|AR_PHY_POWERTX_RATE8
block|,
name|AR_PHY_POWERTX_RATE8_POWERTXHT40_4
block|,
name|AR_PHY_POWERTX_RATE8_POWERTXHT40_4_S
block|,
literal|2
block|}
block|,
block|{
name|ALL_TARGET_HT40_7
block|,
name|AR_PHY_POWERTX_RATE8
block|,
name|AR_PHY_POWERTX_RATE8_POWERTXHT40_5
block|,
name|AR_PHY_POWERTX_RATE8_POWERTXHT40_5_S
block|,
literal|2
block|}
block|,
block|{
name|ALL_TARGET_LEGACY_54
block|,
name|AR_PHY_POWERTX_RATE2
block|,
name|AR_PHY_POWERTX_RATE2_POWERTX54M_7
block|,
name|AR_PHY_POWERTX_RATE2_POWERTX54M_7_S
block|,
literal|2
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function_decl
name|HAL_BOOL
name|create_pa_curve
parameter_list|(
name|u_int32_t
modifier|*
name|paprd_train_data_l
parameter_list|,
name|u_int32_t
modifier|*
name|paprd_train_data_u
parameter_list|,
name|u_int32_t
modifier|*
name|pa_table
parameter_list|,
name|u_int32_t
modifier|*
name|g_fxp_ext
parameter_list|,
name|int
modifier|*
name|pa_in
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|ar9300_paprd_setup_single_table
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|chan
parameter_list|)
block|{
name|int
name|is_2g
init|=
name|IEEE80211_IS_CHAN_2GHZ
argument_list|(
name|chan
argument_list|)
decl_stmt|;
name|HAL_CHANNEL_INTERNAL
modifier|*
name|ichan
init|=
name|ath_hal_checkchannel
argument_list|(
name|ah
argument_list|,
name|chan
argument_list|)
decl_stmt|;
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|int
name|is_ht40
init|=
literal|0
decl_stmt|;
name|u_int32_t
name|am_mask
init|=
literal|0
decl_stmt|;
name|u_int32_t
name|val
init|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_2040_MODE
argument_list|)
decl_stmt|;
name|u_int8_t
name|target_power_val_t2
index|[
name|ar9300_rate_size
index|]
decl_stmt|;
name|int
name|power_tblindex
init|=
literal|0
decl_stmt|,
name|power_delta
init|=
literal|0
decl_stmt|;
name|int
name|paprd_scale_factor
init|=
literal|5
decl_stmt|;
specifier|const
name|u_int8_t
name|mask2num
index|[
literal|8
index|]
init|=
block|{
literal|0
comment|/* 000 */
block|,
literal|1
comment|/* 001 */
block|,
literal|1
comment|/* 010 */
block|,
literal|2
comment|/* 011 */
block|,
literal|1
comment|/* 100 */
block|,
literal|2
comment|/* 101 */
block|,
literal|2
comment|/* 110 */
block|,
literal|3
comment|/* 111 */
block|}
decl_stmt|;
name|ar9300_eeprom_t
modifier|*
name|eep
init|=
operator|&
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_eeprom
decl_stmt|;
define|#
directive|define
name|ABS
parameter_list|(
name|_x
parameter_list|,
name|_y
parameter_list|)
value|((int)_x> (int)_y ? (int)_x - (int)_y : (int)_y - (int)_x)
name|ar9300_set_target_power_from_eeprom
argument_list|(
name|ah
argument_list|,
name|ichan
operator|->
name|channel
argument_list|,
name|target_power_val_t2
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|&
name|HAL_HT_MACMODE_2040
condition|)
block|{
name|is_ht40
operator|=
literal|1
expr_stmt|;
block|}
comment|/*      * Note on paprd_scale_factor      * This factor is saved in eeprom as 3 bit fields in following fashion.       * In 5G there are 3 scale factors -- upper, mid and lower band.      * Upper band scale factor is coded in bits 25-27 of      * modal_header_5g.paprd_rate_mask_ht20.      * Mid band scale factor is coded in bits 28-30 of      * modal_header_5g.paprd_rate_mask_ht40.      * Lower band scale factor is coded in bits 25-27 of      * modal_header_5g.paprd_rate_mask_ht40.      * For 2G there is only one scale factor. It is saved in bits 25-27 of      * modal_header_2g.paprd_rate_mask_ht20.      */
name|AH_PAPRD_GET_SCALE_FACTOR
argument_list|(
name|paprd_scale_factor
argument_list|,
name|eep
argument_list|,
name|is_2g
argument_list|,
name|ichan
operator|->
name|channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_2g
condition|)
block|{
if|if
condition|(
name|is_ht40
condition|)
block|{
name|am_mask
operator|=
name|ahp
operator|->
name|ah_2g_paprd_rate_mask_ht40
operator|&
name|AH_PAPRD_AM_PM_MASK
expr_stmt|;
name|power_tblindex
operator|=
name|ALL_TARGET_HT40_0_8_16
expr_stmt|;
block|}
else|else
block|{
name|am_mask
operator|=
name|ahp
operator|->
name|ah_2g_paprd_rate_mask_ht20
operator|&
name|AH_PAPRD_AM_PM_MASK
expr_stmt|;
name|power_tblindex
operator|=
name|ALL_TARGET_HT20_0_8_16
expr_stmt|;
block|}
if|if
condition|(
name|AR_SREV_HORNET
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_JUPITER
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_APHRODITE
argument_list|(
name|ah
argument_list|)
condition|)
block|{
if|if
condition|(
name|is_ht40
condition|)
block|{
name|ahp
operator|->
name|paprd_training_power
operator|=
name|target_power_val_t2
index|[
name|ALL_TARGET_HT40_7
index|]
operator|+
literal|2
expr_stmt|;
block|}
else|else
block|{
name|ahp
operator|->
name|paprd_training_power
operator|=
name|target_power_val_t2
index|[
name|ALL_TARGET_HT20_7
index|]
operator|+
literal|2
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|ahp
operator|->
name|paprd_training_power
operator|=
literal|25
expr_stmt|;
block|}
else|else
block|{
name|ahp
operator|->
name|paprd_training_power
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_POWERTX_RATE5
argument_list|,
name|AR_PHY_POWERTX_RATE5_POWERTXHT20_0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ABS
argument_list|(
name|target_power_val_t2
index|[
name|power_tblindex
index|]
argument_list|,
name|ahp
operator|->
name|paprd_training_power
argument_list|)
operator|>
name|paprd_scale_factor
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_CALIBRATE
argument_list|,
literal|"%s[%d]: Chan %d paprd failing EEP PWR 0x%08x"
literal|"TGT PWR 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|ichan
operator|->
name|channel
argument_list|,
name|target_power_val_t2
index|[
name|power_tblindex
index|]
argument_list|,
name|ahp
operator|->
name|paprd_training_power
argument_list|)
expr_stmt|;
goto|goto
name|FAILED
goto|;
block|}
name|power_delta
operator|=
name|ABS
argument_list|(
name|ahp
operator|->
name|paprd_training_power
argument_list|,
name|target_power_val_t2
index|[
name|power_tblindex
index|]
argument_list|)
expr_stmt|;
name|power_delta
operator|=
name|power_delta
operator|>
literal|4
condition|?
literal|0
else|:
literal|4
operator|-
name|power_delta
expr_stmt|;
name|ahp
operator|->
name|paprd_training_power
operator|=
name|ahp
operator|->
name|paprd_training_power
operator|-
name|power_delta
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|is_ht40
condition|)
block|{
name|ahp
operator|->
name|paprd_training_power
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_POWERTX_RATE8
argument_list|,
name|AR_PHY_POWERTX_RATE8_POWERTXHT40_5
argument_list|)
expr_stmt|;
name|am_mask
operator|=
name|ahp
operator|->
name|ah_5g_paprd_rate_mask_ht40
operator|&
name|AH_PAPRD_AM_PM_MASK
expr_stmt|;
switch|switch
condition|(
name|mask2num
index|[
name|ahp
operator|->
name|ah_tx_chainmask
index|]
condition|)
block|{
case|case
literal|1
case|:
name|power_delta
operator|=
literal|6
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|power_delta
operator|=
literal|4
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|power_delta
operator|=
literal|2
expr_stmt|;
break|break;
default|default:
goto|goto
name|FAILED
goto|;
break|break;
block|}
name|power_tblindex
operator|=
name|ALL_TARGET_HT40_7
expr_stmt|;
block|}
else|else
block|{
name|ahp
operator|->
name|paprd_training_power
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_POWERTX_RATE6
argument_list|,
name|AR_PHY_POWERTX_RATE6_POWERTXHT20_5
argument_list|)
expr_stmt|;
name|am_mask
operator|=
name|ahp
operator|->
name|ah_5g_paprd_rate_mask_ht20
operator|&
name|AH_PAPRD_AM_PM_MASK
expr_stmt|;
switch|switch
condition|(
name|mask2num
index|[
name|ahp
operator|->
name|ah_tx_chainmask
index|]
condition|)
block|{
case|case
literal|1
case|:
name|power_delta
operator|=
literal|6
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|power_delta
operator|=
literal|4
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|power_delta
operator|=
literal|2
expr_stmt|;
break|break;
default|default:
goto|goto
name|FAILED
goto|;
break|break;
block|}
name|power_tblindex
operator|=
name|ALL_TARGET_HT20_7
expr_stmt|;
block|}
comment|/* Adjust for scale factor */
name|ahp
operator|->
name|paprd_training_power
operator|+=
name|paprd_scale_factor
expr_stmt|;
comment|/*         ath_hal_printf(ah, "%s[%d] paprd_scale_factor %d power_delta %d\n",             __func__, __LINE__, paprd_scale_factor, power_delta);          */
if|if
condition|(
name|ABS
argument_list|(
name|target_power_val_t2
index|[
name|power_tblindex
index|]
argument_list|,
name|ahp
operator|->
name|paprd_training_power
argument_list|)
operator|>
name|paprd_scale_factor
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_CALIBRATE
argument_list|,
literal|"%s[%d]: Chan %d paprd failing EEP PWR 0x%08x TGT PWR 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|ichan
operator|->
name|channel
argument_list|,
name|target_power_val_t2
index|[
name|power_tblindex
index|]
argument_list|,
name|ahp
operator|->
name|paprd_training_power
argument_list|)
expr_stmt|;
goto|goto
name|FAILED
goto|;
block|}
name|ahp
operator|->
name|paprd_training_power
operator|=
name|ahp
operator|->
name|paprd_training_power
operator|+
name|power_delta
expr_stmt|;
block|}
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_CALIBRATE
argument_list|,
literal|"%s 2G %d HT40 %d am_mask 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|is_2g
argument_list|,
name|is_ht40
argument_list|,
name|am_mask
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_AM2AM
argument_list|,
name|AR_PHY_PAPRD_AM2AM_MASK
argument_list|,
name|am_mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|AR_SREV_HORNET
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_AM2PM
argument_list|,
name|AR_PHY_PAPRD_AM2PM_MASK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_AM2PM
argument_list|,
name|AR_PHY_PAPRD_AM2PM_MASK
argument_list|,
name|am_mask
argument_list|)
expr_stmt|;
block|}
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_HT40
argument_list|,
name|AR_PHY_PAPRD_HT40_MASK
argument_list|,
name|AR_PHY_PAPRD_HT40_MASK
argument_list|)
expr_stmt|;
comment|/* chain0 */
if|if
condition|(
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_tx_chainmask
operator|&
name|AR9300_CHAIN0_MASK
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B0
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B0_USE_SINGLE_TABLE_MASK
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0_ADAPTIVE_AM2PM_ENABLE_0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0_ADAPTIVE_AM2AM_ENABLE_0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0_ADAPTIVE_SCALING_ENA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0_PA_GAIN_SCALE_FACT_0_MASK
argument_list|,
literal|181
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0_PAPRD_MAG_SCALE_FACT_0
argument_list|,
literal|361
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0_ADAPTIVE_SCALING_ENA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B0
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B0_PAPRD_MAG_THRSH_0
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
comment|/* chain1 */
if|if
condition|(
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_tx_chainmask
operator|&
name|AR9300_CHAIN1_MASK
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B1
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B1_PAPRD_ADAPTIVE_USE_SINGLE_TABLE_1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1_ADAPTIVE_AM2PM_ENABLE_1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1_ADAPTIVE_AM2AM_ENABLE_1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1_ADAPTIVE_SCALING_ENA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1_PA_GAIN_SCALE_FACT_1_MASK
argument_list|,
literal|181
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1_PAPRD_MAG_SCALE_FACT_1
argument_list|,
literal|361
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1_ADAPTIVE_SCALING_ENA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B1
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B1_PAPRD_MAG_THRSH_1
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
comment|/* chain2 */
if|if
condition|(
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_tx_chainmask
operator|&
name|AR9300_CHAIN2_MASK
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B2
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B2_PAPRD_ADAPTIVE_USE_SINGLE_TABLE_2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2_ADAPTIVE_AM2PM_ENABLE_2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2_ADAPTIVE_AM2AM_ENABLE_2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2_ADAPTIVE_SCALING_ENA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2_PA_GAIN_SCALE_FACT_2_MASK
argument_list|,
literal|181
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2_PAPRD_MAG_SCALE_FACT_2
argument_list|,
literal|361
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2_ADAPTIVE_SCALING_ENA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B2
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B2_PAPRD_MAG_THRSH_2
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
name|ar9300_enable_paprd
argument_list|(
name|ah
argument_list|,
name|AH_FALSE
argument_list|,
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_LB_SKIP
argument_list|,
literal|0x30
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_LB_ENABLE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_TX_GAIN_FORCE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_RX_BB_GAIN_FORCE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_IQCORR_ENABLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_AGC2_SETTLING
argument_list|,
literal|28
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_CF_PAPRD_TRAIN_ENABLE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL2_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL2_CF_PAPRD_INIT_RX_BB_GAIN
argument_list|,
literal|148
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_FINE_CORR_LEN
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_COARSE_CORR_LEN
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_NUM_CORR_STAGES
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_MIN_LOOPBACK_DEL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP
argument_list|,
operator|-
literal|3
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_ADC_DESIRED_SIZE
argument_list|,
operator|-
literal|15
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_BBTXMIX_DISABLE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL4_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_SAFETY_DELTA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL4_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_MIN_CORR
argument_list|,
literal|400
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL4_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_NUM_TRAIN_SAMPLES
argument_list|,
literal|100
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_LB_SKIP
argument_list|,
literal|0x30
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_LB_ENABLE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_TX_GAIN_FORCE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_RX_BB_GAIN_FORCE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_IQCORR_ENABLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_AGC2_SETTLING
argument_list|,
literal|28
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_CF_PAPRD_TRAIN_ENABLE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_2g
condition|)
block|{
if|if
condition|(
name|AR_SREV_JUPITER
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_APHRODITE
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL2
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL2_CF_PAPRD_INIT_RX_BB_GAIN
argument_list|,
literal|0x91
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL2
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL2_CF_PAPRD_INIT_RX_BB_GAIN
argument_list|,
literal|147
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
operator|&&
operator|!
name|is_2g
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL2
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL2_CF_PAPRD_INIT_RX_BB_GAIN
argument_list|,
literal|137
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL2
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL2_CF_PAPRD_INIT_RX_BB_GAIN
argument_list|,
literal|147
argument_list|)
expr_stmt|;
block|}
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_FINE_CORR_LEN
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_COARSE_CORR_LEN
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_NUM_CORR_STAGES
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_MIN_LOOPBACK_DEL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|AR_SREV_HORNET
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_JUPITER
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_APHRODITE
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP
argument_list|,
operator|-
literal|3
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP
argument_list|,
operator|-
literal|6
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|is_2g
condition|)
block|{
if|if
condition|(
name|AR_SREV_JUPITER
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_APHRODITE
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_ADC_DESIRED_SIZE
argument_list|,
operator|-
literal|10
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_ADC_DESIRED_SIZE
argument_list|,
operator|-
literal|15
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_ADC_DESIRED_SIZE
argument_list|,
operator|-
literal|10
argument_list|)
expr_stmt|;
block|}
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_BBTXMIX_DISABLE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL4
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_SAFETY_DELTA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL4
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_MIN_CORR
argument_list|,
literal|400
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL4
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_NUM_TRAIN_SAMPLES
argument_list|,
literal|100
argument_list|)
expr_stmt|;
block|}
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_PRE_POST_SCALE_0_B0
argument_list|,
name|AR_PHY_PAPRD_PRE_POST_SCALE_0_B0_PAPRD_PRE_POST_SCALING_0_0
argument_list|,
literal|261376
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_PRE_POST_SCALE_1_B0
argument_list|,
name|AR_PHY_PAPRD_PRE_POST_SCALE_1_B0_PAPRD_PRE_POST_SCALING_1_0
argument_list|,
literal|248079
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_PRE_POST_SCALE_2_B0
argument_list|,
name|AR_PHY_PAPRD_PRE_POST_SCALE_2_B0_PAPRD_PRE_POST_SCALING_2_0
argument_list|,
literal|233759
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_PRE_POST_SCALE_3_B0
argument_list|,
name|AR_PHY_PAPRD_PRE_POST_SCALE_3_B0_PAPRD_PRE_POST_SCALING_3_0
argument_list|,
literal|220464
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_PRE_POST_SCALE_4_B0
argument_list|,
name|AR_PHY_PAPRD_PRE_POST_SCALE_4_B0_PAPRD_PRE_POST_SCALING_4_0
argument_list|,
literal|208194
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_PRE_POST_SCALE_5_B0
argument_list|,
name|AR_PHY_PAPRD_PRE_POST_SCALE_5_B0_PAPRD_PRE_POST_SCALING_5_0
argument_list|,
literal|196949
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_PRE_POST_SCALE_6_B0
argument_list|,
name|AR_PHY_PAPRD_PRE_POST_SCALE_6_B0_PAPRD_PRE_POST_SCALING_6_0
argument_list|,
literal|185706
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_PRE_POST_SCALE_7_B0
argument_list|,
name|AR_PHY_PAPRD_PRE_POST_SCALE_7_B0_PAPRD_PRE_POST_SCALING_7_0
argument_list|,
literal|175487
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|FAILED
label|:
return|return
operator|-
literal|1
return|;
undef|#
directive|undef
name|ABS
block|}
end_function

begin_comment
comment|/*  * XXX There's another copy of this in ar9300_reset.c, use that!  */
end_comment

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static inline HAL_CHANNEL_INTERNAL* ar9300_check_chan(struct ath_hal *ah, HAL_CHANNEL *chan) {     if ((AR9300_IS_CHAN(chan, CHANNEL_2GHZ) ^          AR9300_IS_CHAN(chan, CHANNEL_5GHZ)) == 0)     {         HALDEBUG(ah, HAL_DEBUG_CHANNEL,             "%s: invalid channel %u/0x%x; not marked as 2GHz or 5GHz\n",             __func__, chan->channel, chan->channel_flags);         return AH_NULL;     }      if ((AR9300_IS_CHAN(chan, CHANNEL_OFDM)     ^          AR9300_IS_CHAN(chan, CHANNEL_CCK)      ^          AR9300_IS_CHAN(chan, CHANNEL_HT20)     ^          AR9300_IS_CHAN(chan, CHANNEL_HT40PLUS) ^          AR9300_IS_CHAN(chan, CHANNEL_HT40MINUS)) == 0)     {         HALDEBUG(ah, HAL_DEBUG_CHANNEL,             "%s: invalid channel %u/0x%x; not marked as "             "OFDM or CCK or HT20 or HT40PLUS or HT40MINUS\n", __func__,             chan->channel, chan->channel_flags);         return AH_NULL;     }      return (ath_hal_checkchannel(ah, chan)); }
endif|#
directive|endif
end_endif

begin_function
name|void
name|ar9300_enable_paprd
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|enable_flag
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|chan
parameter_list|)
block|{
name|HAL_BOOL
name|enable
init|=
name|enable_flag
decl_stmt|;
name|u_int32_t
name|am_mask
init|=
literal|0
decl_stmt|;
name|u_int32_t
name|val
init|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_2040_MODE
argument_list|)
decl_stmt|;
name|int
name|is_2g
init|=
name|IEEE80211_IS_CHAN_2GHZ
argument_list|(
name|chan
argument_list|)
decl_stmt|;
name|HAL_CHANNEL_INTERNAL
modifier|*
name|ichan
init|=
name|ath_hal_checkchannel
argument_list|(
name|ah
argument_list|,
name|chan
argument_list|)
decl_stmt|;
name|int
name|is_ht40
init|=
literal|0
decl_stmt|;
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
if|if
condition|(
name|val
operator|&
name|HAL_HT_MACMODE_2040
condition|)
block|{
name|is_ht40
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|enable_flag
operator|==
name|AH_TRUE
condition|)
block|{
name|ar9300_eeprom_t
modifier|*
name|eep
init|=
operator|&
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_eeprom
decl_stmt|;
if|if
condition|(
operator|!
name|is_2g
condition|)
block|{
comment|/*              * 3 bits for modal_header_5g.paprd_rate_mask_ht20              * is used for sub band disabling of paprd.              * 5G band is divided into 3 sub bands -- upper, mid, lower.              * If bit 30 of modal_header_5g.paprd_rate_mask_ht20 is set              * to one -- disable paprd for upper 5G              * If bit 29 of modal_header_5g.paprd_rate_mask_ht20 is set              * to one -- disable paprd for mid 5G              * If bit 28 of modal_header_5g.paprd_rate_mask_ht20 is set              * to one -- disable paprd for lower 5G              * u_int32_t am_mask = eep->modal_header_5g.paprd_rate_mask_ht20;              */
if|if
condition|(
name|ichan
operator|->
name|channel
operator|>=
name|UPPER_5G_SUB_BANDSTART
condition|)
block|{
if|if
condition|(
name|eep
operator|->
name|modal_header_5g
operator|.
name|paprd_rate_mask_ht20
operator|&
operator|(
literal|1
operator|<<
literal|30
operator|)
condition|)
block|{
name|enable
operator|=
name|AH_FALSE
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|ichan
operator|->
name|channel
operator|>=
name|MID_5G_SUB_BANDSTART
condition|)
block|{
if|if
condition|(
name|eep
operator|->
name|modal_header_5g
operator|.
name|paprd_rate_mask_ht20
operator|&
operator|(
literal|1
operator|<<
literal|29
operator|)
condition|)
block|{
name|enable
operator|=
name|AH_FALSE
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* must be in the lower 5G subband */
if|if
condition|(
name|eep
operator|->
name|modal_header_5g
operator|.
name|paprd_rate_mask_ht20
operator|&
operator|(
literal|1
operator|<<
literal|28
operator|)
condition|)
block|{
name|enable
operator|=
name|AH_FALSE
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|ahp
operator|->
name|ah_paprd_broken
condition|)
block|{
name|ahp
operator|->
name|ah_paprd_broken
operator|=
name|AH_FALSE
expr_stmt|;
name|enable
operator|=
name|AH_FALSE
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_UNMASKABLE
argument_list|,
literal|"%s: PAPRD is in bad state. Don't enable PAPRD\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|enable
condition|)
block|{
name|HAL_CHANNEL_INTERNAL
modifier|*
name|ichan
decl_stmt|;
if|if
condition|(
name|is_2g
condition|)
block|{
if|if
condition|(
name|is_ht40
condition|)
block|{
name|am_mask
operator|=
name|ahp
operator|->
name|ah_2g_paprd_rate_mask_ht40
operator|&
name|AH_PAPRD_AM_PM_MASK
expr_stmt|;
block|}
else|else
block|{
name|am_mask
operator|=
name|ahp
operator|->
name|ah_2g_paprd_rate_mask_ht20
operator|&
name|AH_PAPRD_AM_PM_MASK
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|is_ht40
condition|)
block|{
name|am_mask
operator|=
name|ahp
operator|->
name|ah_5g_paprd_rate_mask_ht40
operator|&
name|AH_PAPRD_AM_PM_MASK
expr_stmt|;
block|}
else|else
block|{
name|am_mask
operator|=
name|ahp
operator|->
name|ah_5g_paprd_rate_mask_ht20
operator|&
name|AH_PAPRD_AM_PM_MASK
expr_stmt|;
block|}
block|}
comment|/* Earlier we promgrammed TGT Power with Scaled down value, since          * PAPRD CAL was not done.          * Now we finish PAPRD CAL, so bump up the TGT PWR to original          * EEPROM Power. CTLs calc and Maverickd in          * "ar9300_eeprom_set_transmit_power"          */
name|ichan
operator|=
name|ar9300_check_chan
argument_list|(
name|ah
argument_list|,
name|chan
argument_list|)
expr_stmt|;
name|ichan
operator|->
name|paprd_table_write_done
operator|=
literal|1
expr_stmt|;
comment|//        chan->paprd_table_write_done = 1;
comment|/*         ath_hal_printf(ah, "%s[%d] eeprom_set_transmit_power PAPRD\n",             __func__, __LINE__);          */
if|if
condition|(
name|ar9300_eeprom_set_transmit_power
argument_list|(
name|ah
argument_list|,
operator|&
name|ahp
operator|->
name|ah_eeprom
argument_list|,
name|chan
argument_list|,
name|ath_hal_getctl
argument_list|(
name|ah
argument_list|,
name|chan
argument_list|)
argument_list|,
name|ath_hal_getantennaallowed
argument_list|(
name|ah
argument_list|,
name|chan
argument_list|)
argument_list|,
name|ath_hal_get_twice_max_regpower
argument_list|(
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
argument_list|,
name|ichan
argument_list|,
name|chan
argument_list|)
argument_list|,
name|AH_MIN
argument_list|(
name|MAX_RATE_POWER
argument_list|,
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_powerLimit
argument_list|)
argument_list|)
operator|!=
name|HAL_OK
condition|)
block|{
name|ichan
operator|->
name|paprd_table_write_done
operator|=
literal|0
expr_stmt|;
comment|//            chan->paprd_table_write_done = 0;
comment|/* Intentional print */
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"%s[%d] eeprom_set_transmit_power failed ABORT PAPRD\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B0
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B0_PAPRD_ENABLE_0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
operator|&&
operator|!
name|AR_SREV_HORNET
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B1
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B1_PAPRD_ENABLE_1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|AR_SREV_JUPITER
argument_list|(
name|ah
argument_list|)
operator|||
operator|(
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_tx_chainmask
operator|&
name|AR9300_CHAIN2_MASK
operator|)
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B2
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B2_PAPRD_ENABLE_2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
return|return;
block|}
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_CALIBRATE
argument_list|,
literal|"%s 2G %d HT40 %d am_mask 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|is_2g
argument_list|,
name|is_ht40
argument_list|,
name|am_mask
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_AM2AM
argument_list|,
name|AR_PHY_PAPRD_AM2AM_MASK
argument_list|,
name|am_mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|AR_SREV_HORNET
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_AM2PM
argument_list|,
name|AR_PHY_PAPRD_AM2PM_MASK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_AM2PM
argument_list|,
name|AR_PHY_PAPRD_AM2PM_MASK
argument_list|,
name|am_mask
argument_list|)
expr_stmt|;
block|}
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_HT40
argument_list|,
name|AR_PHY_PAPRD_HT40_MASK
argument_list|,
name|AR_PHY_PAPRD_HT40_MASK
argument_list|)
expr_stmt|;
comment|/* chain0 */
if|if
condition|(
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_tx_chainmask
operator|&
name|AR9300_CHAIN0_MASK
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B0
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B0_USE_SINGLE_TABLE_MASK
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0_ADAPTIVE_AM2PM_ENABLE_0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0_ADAPTIVE_AM2AM_ENABLE_0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0_ADAPTIVE_SCALING_ENA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0_PA_GAIN_SCALE_FACT_0_MASK
argument_list|,
literal|181
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0_PAPRD_MAG_SCALE_FACT_0
argument_list|,
literal|361
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0_ADAPTIVE_SCALING_ENA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B0
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B0_PAPRD_MAG_THRSH_0
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
comment|/* chain1 */
if|if
condition|(
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_tx_chainmask
operator|&
name|AR9300_CHAIN1_MASK
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B1
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B1_PAPRD_ADAPTIVE_USE_SINGLE_TABLE_1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1_ADAPTIVE_AM2PM_ENABLE_1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1_ADAPTIVE_AM2AM_ENABLE_1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1_ADAPTIVE_SCALING_ENA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1_PA_GAIN_SCALE_FACT_1_MASK
argument_list|,
literal|181
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1_PAPRD_MAG_SCALE_FACT_1
argument_list|,
literal|361
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1_ADAPTIVE_SCALING_ENA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B1
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B1_PAPRD_MAG_THRSH_1
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
comment|/* chain2 */
if|if
condition|(
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_tx_chainmask
operator|&
name|AR9300_CHAIN2_MASK
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B2
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B2_PAPRD_ADAPTIVE_USE_SINGLE_TABLE_2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2_ADAPTIVE_AM2PM_ENABLE_2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2_ADAPTIVE_AM2AM_ENABLE_2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2_ADAPTIVE_SCALING_ENA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2_PA_GAIN_SCALE_FACT_2_MASK
argument_list|,
literal|181
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2_PAPRD_MAG_SCALE_FACT_2
argument_list|,
literal|361
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2_ADAPTIVE_SCALING_ENA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B2
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B2_PAPRD_MAG_THRSH_2
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_tx_chainmask
operator|&
name|AR9300_CHAIN0_MASK
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B0
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B0_PAPRD_ENABLE_0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_tx_chainmask
operator|&
name|AR9300_CHAIN1_MASK
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B1
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B1_PAPRD_ENABLE_1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_tx_chainmask
operator|&
name|AR9300_CHAIN2_MASK
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B2
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B2_PAPRD_ENABLE_2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_tx_chainmask
operator|&
name|AR9300_CHAIN0_MASK
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B0
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B0_PAPRD_ENABLE_0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_tx_chainmask
operator|&
name|AR9300_CHAIN1_MASK
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B1
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B1_PAPRD_ENABLE_1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_tx_chainmask
operator|&
name|AR9300_CHAIN2_MASK
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B2
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B2_PAPRD_ENABLE_2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ar9300_gain_table_entries
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u_int32_t
name|reg
decl_stmt|;
name|u_int32_t
modifier|*
name|gain_table_entries
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|paprd_gain_table_entries
decl_stmt|;
name|u_int32_t
modifier|*
name|gain_vs_table_index
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|paprd_gain_table_index
decl_stmt|;
name|reg
operator|=
name|AR_PHY_TXGAIN_TAB
argument_list|(
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|gain_table_entries
index|[
name|i
index|]
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|gain_vs_table_index
index|[
name|i
index|]
operator|=
operator|(
name|gain_table_entries
index|[
name|i
index|]
operator|>>
literal|24
operator|)
operator|&
literal|0xff
expr_stmt|;
comment|/*          * ath_hal_printf(          *     ah, "+++reg 0x%08x gain_table_entries[%d] = 0x%08x \n",           *     reg, i, gain_table_entries[i]);          */
name|reg
operator|=
name|reg
operator|+
literal|4
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Get gain index for Target power */
end_comment

begin_function
specifier|static
name|unsigned
name|int
name|ar9300_get_desired_gain_for_chain
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|int
name|chain_num
parameter_list|,
name|int
name|target_power
parameter_list|)
block|{
name|int
name|olpc_gain_delta
init|=
literal|0
decl_stmt|;
name|int
name|alpha_therm
init|=
literal|0
decl_stmt|,
name|alpha_volt
init|=
literal|0
decl_stmt|;
name|int
name|therm_cal_value
init|=
literal|0
decl_stmt|,
name|volt_cal_value
init|=
literal|0
decl_stmt|;
name|int
name|latest_therm_value
init|=
literal|0
decl_stmt|,
name|latest_volt_value
init|=
literal|0
decl_stmt|,
name|olpc_gain_delta_tmp
init|=
literal|0
decl_stmt|;
name|int
name|thermal_gain_corr
init|=
literal|0
decl_stmt|,
name|voltage_gain_corr
init|=
literal|0
decl_stmt|,
name|desired_scale
init|=
literal|0
decl_stmt|;
name|int
name|desired_gain
init|=
literal|0
decl_stmt|;
name|int
name|cl_gain_mod
init|=
literal|0
decl_stmt|;
comment|/* Clear the training done bit */
if|if
condition|(
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/*field_read("BB_tpc_12.desired_scale_ht40_5",&desired_scale);*/
name|desired_scale
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TPC_12
argument_list|,
name|AR_PHY_TPC_12_DESIRED_SCALE_HT40_5
argument_list|)
expr_stmt|;
comment|/*field_read("BB_tpc_19.alpha_therm",&alpha_therm);*/
name|alpha_therm
operator|=
name|OS_REG_READ_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TPC_19
argument_list|,
name|AR_PHY_TPC_19_ALPHA_THERM
argument_list|)
expr_stmt|;
comment|/*field_read("BB_tpc_19.alpha_volt",&alpha_volt);*/
name|alpha_volt
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TPC_19
argument_list|,
name|AR_PHY_TPC_19_ALT_ALPHA_VOLT
argument_list|)
expr_stmt|;
comment|/*field_read("BB_tpc_18.therm_cal_value",&therm_cal_value);*/
name|therm_cal_value
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TPC_18
argument_list|,
name|AR_PHY_TPC_18_ALT_THERM_CAL_VALUE
argument_list|)
expr_stmt|;
comment|/*field_read("BB_tpc_18.volt_cal_value",&volt_cal_value);*/
name|volt_cal_value
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TPC_18
argument_list|,
name|AR_PHY_TPC_18_ALT_VOLT_CAL_VALUE
argument_list|)
expr_stmt|;
comment|/*field_read("BB_therm_adc_4.latest_therm_value",&latest_therm_value);*/
name|latest_therm_value
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_THERM_ADC_4
argument_list|,
name|AR_PHY_THERM_ADC_4_LATEST_THERM_VALUE
argument_list|)
expr_stmt|;
comment|/*field_read("BB_therm_adc_4.latest_volt_value",&latest_volt_value);*/
name|latest_volt_value
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_THERM_ADC_4
argument_list|,
name|AR_PHY_THERM_ADC_4_LATEST_VOLT_VALUE
argument_list|)
expr_stmt|;
comment|/*      * sprintf(      *     field_name, "%s%d%s%d\0", "BB_tpc_11_b",       *     chain_num, ".olpc_gain_delta_", chain_num);      */
comment|/*field_read(field_name,&olpc_gain_delta_tmp);*/
if|if
condition|(
name|chain_num
operator|==
literal|0
condition|)
block|{
name|olpc_gain_delta_tmp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TPC_11_B0
argument_list|,
name|AR_PHY_TPC_11_B0_OLPC_GAIN_DELTA_0
argument_list|)
expr_stmt|;
name|cl_gain_mod
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CL_TAB_0
argument_list|,
name|AR_PHY_CL_TAB_0_CL_GAIN_MOD
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|chain_num
operator|==
literal|1
condition|)
block|{
if|if
condition|(
operator|!
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|olpc_gain_delta_tmp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TPC_11_B1
argument_list|,
name|AR_PHY_TPC_11_B1_OLPC_GAIN_DELTA_1
argument_list|)
expr_stmt|;
name|cl_gain_mod
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CL_TAB_1
argument_list|,
name|AR_PHY_CL_TAB_1_CL_GAIN_MOD
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|chain_num
operator|==
literal|2
condition|)
block|{
if|if
condition|(
operator|!
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|olpc_gain_delta_tmp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TPC_11_B2
argument_list|,
name|AR_PHY_TPC_11_B2_OLPC_GAIN_DELTA_2
argument_list|)
expr_stmt|;
name|cl_gain_mod
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CL_TAB_2
argument_list|,
name|AR_PHY_CL_TAB_2_CL_GAIN_MOD
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* invalid chain_num */
block|}
if|if
condition|(
name|olpc_gain_delta_tmp
operator|<
literal|128
condition|)
block|{
name|olpc_gain_delta
operator|=
name|olpc_gain_delta_tmp
expr_stmt|;
block|}
else|else
block|{
name|olpc_gain_delta
operator|=
name|olpc_gain_delta_tmp
operator|-
literal|256
expr_stmt|;
block|}
name|thermal_gain_corr
operator|=
call|(
name|int
call|)
argument_list|(
name|alpha_therm
operator|*
operator|(
name|latest_therm_value
operator|-
name|therm_cal_value
operator|)
operator|+
literal|128
argument_list|)
operator|>>
literal|8
expr_stmt|;
name|voltage_gain_corr
operator|=
call|(
name|int
call|)
argument_list|(
name|alpha_volt
operator|*
operator|(
name|latest_volt_value
operator|-
name|volt_cal_value
operator|)
operator|+
literal|64
argument_list|)
operator|>>
literal|7
expr_stmt|;
name|desired_gain
operator|=
name|target_power
operator|-
name|olpc_gain_delta
operator|-
name|thermal_gain_corr
operator|-
name|voltage_gain_corr
operator|+
name|desired_scale
operator|+
name|cl_gain_mod
expr_stmt|;
comment|/*      * printf(      *     "olpc_gain_delta %d, desired_gain %d\n",       *     olpc_gain_delta, desired_gain);      */
if|#
directive|if
literal|0
block|ath_hal_printf(ah,         "+++ target_power %d olpc_gain_delta %d, cl_gain_mod %d,"         "thermal_gain_corr %d  voltage_gain_corr %d desired_scale %d"         "desired_gain %d\n",         target_power, olpc_gain_delta, cl_gain_mod, thermal_gain_corr,         voltage_gain_corr,         desired_scale, desired_gain);
endif|#
directive|endif
return|return
operator|(
name|unsigned
name|int
operator|)
name|desired_gain
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ar9300_tx_force_gain
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|unsigned
name|int
name|gain_index
parameter_list|)
block|{
name|int
name|selected_gain_entry
decl_stmt|,
name|txbb1dbgain
decl_stmt|,
name|txbb6dbgain
decl_stmt|,
name|txmxrgain
decl_stmt|;
name|int
name|padrvgn_a
decl_stmt|,
name|padrvgn_b
decl_stmt|,
name|padrvgn_c
decl_stmt|,
name|padrvgn_d
decl_stmt|;
name|u_int32_t
modifier|*
name|gain_table_entries
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|paprd_gain_table_entries
decl_stmt|;
comment|/*u_int32_t *gain_vs_table_index = ah->paprd_gain_table_index;*/
name|selected_gain_entry
operator|=
name|gain_table_entries
index|[
name|gain_index
index|]
expr_stmt|;
name|txbb1dbgain
operator|=
name|selected_gain_entry
operator|&
literal|0x7
expr_stmt|;
name|txbb6dbgain
operator|=
operator|(
name|selected_gain_entry
operator|>>
literal|3
operator|)
operator|&
literal|0x3
expr_stmt|;
name|txmxrgain
operator|=
operator|(
name|selected_gain_entry
operator|>>
literal|5
operator|)
operator|&
literal|0xf
expr_stmt|;
name|padrvgn_a
operator|=
operator|(
name|selected_gain_entry
operator|>>
literal|9
operator|)
operator|&
literal|0xf
expr_stmt|;
name|padrvgn_b
operator|=
operator|(
name|selected_gain_entry
operator|>>
literal|13
operator|)
operator|&
literal|0xf
expr_stmt|;
name|padrvgn_c
operator|=
operator|(
name|selected_gain_entry
operator|>>
literal|17
operator|)
operator|&
literal|0xf
expr_stmt|;
name|padrvgn_d
operator|=
operator|(
name|selected_gain_entry
operator|>>
literal|21
operator|)
operator|&
literal|0x3
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TX_FORCED_GAIN
argument_list|,
name|AR_PHY_TX_FORCED_GAIN_FORCED_TXBB1DBGAIN
argument_list|,
name|txbb1dbgain
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TX_FORCED_GAIN
argument_list|,
name|AR_PHY_TX_FORCED_GAIN_FORCED_TXBB6DBGAIN
argument_list|,
name|txbb6dbgain
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TX_FORCED_GAIN
argument_list|,
name|AR_PHY_TX_FORCED_GAIN_FORCED_TXMXRGAIN
argument_list|,
name|txmxrgain
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TX_FORCED_GAIN
argument_list|,
name|AR_PHY_TX_FORCED_GAIN_FORCED_PADRVGNA
argument_list|,
name|padrvgn_a
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TX_FORCED_GAIN
argument_list|,
name|AR_PHY_TX_FORCED_GAIN_FORCED_PADRVGNB
argument_list|,
name|padrvgn_b
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TX_FORCED_GAIN
argument_list|,
name|AR_PHY_TX_FORCED_GAIN_FORCED_PADRVGNC
argument_list|,
name|padrvgn_c
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TX_FORCED_GAIN
argument_list|,
name|AR_PHY_TX_FORCED_GAIN_FORCED_PADRVGND
argument_list|,
name|padrvgn_d
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TX_FORCED_GAIN
argument_list|,
name|AR_PHY_TX_FORCED_GAIN_FORCED_ENABLE_PAL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TX_FORCED_GAIN
argument_list|,
name|AR_PHY_TX_FORCED_GAIN_FORCE_TX_GAIN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TPC_1
argument_list|,
name|AR_PHY_TPC_1_FORCED_DAC_GAIN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TPC_1
argument_list|,
name|AR_PHY_TPC_1_FORCE_DAC_GAIN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|HAL_DEBUG_PAPRD
value|HAL_DEBUG_CALIBRATE
end_define

begin_comment
comment|/* driver: conditionally print */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|ART_PAPRD_DEBUG
argument_list|)
operator|||
name|defined
argument_list|(
name|AH_DEBUG
argument_list|)
end_if

begin_function
specifier|static
name|void
name|ar9300_paprd_debug_print
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|int
name|temp
decl_stmt|;
name|int
name|txbb1dbgain
decl_stmt|,
name|txbb6dbgain
decl_stmt|,
name|txmxrgain
decl_stmt|;
name|int
name|padrvgn_a
decl_stmt|,
name|padrvgn_b
decl_stmt|,
name|padrvgn_c
decl_stmt|,
name|padrvgn_d
decl_stmt|;
if|if
condition|(
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
condition|)
block|{
comment|/*field_read("BB_paprd_trainer_cntl1.cf_paprd_lb_skip",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_LB_SKIP
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl1.cf_paprd_lb_skip=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_cntl1.cf_paprd_lb_enable",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_LB_ENABLE
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl1.cf_paprd_lb_enable=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_cntl1.cf_paprd_tx_gain_force",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_TX_GAIN_FORCE
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl1.cf_paprd_tx_gain_force=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*          * field_read(          *     "BB_paprd_trainer_cntl1.cf_paprd_rx_bb_gain_force",&temp);          */
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_RX_BB_GAIN_FORCE
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl1.cf_paprd_rx_bb_gain_force=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_cntl1.cf_paprd_iqcorr_enable",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_IQCORR_ENABLE
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl1.cf_paprd_iqcorr_enable=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_cntl1.cf_paprd_agc2_settling",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_AGC2_SETTLING
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl1.cf_paprd_agc2_settling=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_cntl1.cf_paprd_train_enable",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_CF_PAPRD_TRAIN_ENABLE
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl1.cf_paprd_train_enable=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*          * field_read("BB_paprd_trainer_cntl2.cf_paprd_init_rx_bb_gain",&temp);          */
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL2_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL2_CF_PAPRD_INIT_RX_BB_GAIN
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl2.cf_paprd_init_rx_bb_gain=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_cntl3.cf_paprd_fine_corr_len",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_FINE_CORR_LEN
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl3.cf_paprd_fine_corr_len=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*          * field_read("BB_paprd_trainer_cntl3.cf_paprd_coarse_corr_len",&temp);          */
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_COARSE_CORR_LEN
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl3.cf_paprd_coarse_corr_len=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*          * field_read("BB_paprd_trainer_cntl3.cf_paprd_num_corr_stages",&temp);          */
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_NUM_CORR_STAGES
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl3.cf_paprd_num_corr_stages=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*          * field_read(          *     "BB_paprd_trainer_cntl3.cf_paprd_min_loopback_del",&temp);          */
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_MIN_LOOPBACK_DEL
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl3.cf_paprd_min_loopback_del=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_cntl3.cf_paprd_quick_drop",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl3.cf_paprd_quick_drop=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*          * field_read(          *     "BB_paprd_trainer_cntl3.cf_paprd_adc_desired_size",&temp);          */
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_ADC_DESIRED_SIZE
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl3.cf_paprd_adc_desired_size=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*          * field_read("BB_paprd_trainer_cntl3.cf_paprd_bbtxmix_disable",&temp);          */
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_BBTXMIX_DISABLE
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl3.cf_paprd_bbtxmix_disable=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_cntl4.cf_paprd_safety_delta",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL4_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_SAFETY_DELTA
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl4.cf_paprd_safety_delta=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_cntl4.cf_paprd_min_corr",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL4_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_MIN_CORR
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl4.cf_paprd_min_corr=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_stat1.paprd_agc2_pwr",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_AGC2_PWR
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"    paprd_agc2_pwr              = 0x%02x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_stat1.paprd_rx_gain_idx",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_RX_GAIN_IDX
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"    paprd_rx_gain_idx           = 0x%02x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_stat1.paprd_train_active",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_ACTIVE
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"    paprd_train_active          = 0x%08x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_stat1.paprd_corr_err",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_CORR_ERR
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"    paprd_corr_err              = 0x%08x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_stat1.paprd_train_incomplete",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_INCOMPLETE
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"    paprd_train_incomplete      = 0x%08x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_stat1.paprd_train_done",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"    paprd_train_done            = 0x%08x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_stat2.paprd_fine_idx",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT2_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT2_PAPRD_FINE_IDX
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"    paprd_fine_idx              = 0x%08x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_stat2.paprd_coarse_idx",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT2_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT2_PAPRD_COARSE_IDX
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"    paprd_coarse_idx            = 0x%08x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_stat2.paprd_fine_val",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT2_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT2_PAPRD_FINE_VAL
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"    paprd_fine_val              = 0x%08x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_stat3.paprd_train_samples_cnt",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT3_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT3_PAPRD_TRAIN_SAMPLES_CNT
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"    paprd_train_samples_cnt     = 0x%08x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/*field_read("BB_paprd_trainer_cntl1.cf_paprd_lb_skip",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_LB_SKIP
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl1.cf_paprd_lb_skip=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_cntl1.cf_paprd_lb_enable",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_LB_ENABLE
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl1.cf_paprd_lb_enable=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_cntl1.cf_paprd_tx_gain_force",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_TX_GAIN_FORCE
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl1.cf_paprd_tx_gain_force=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*          * field_read(          *     "BB_paprd_trainer_cntl1.cf_paprd_rx_bb_gain_force",&temp);          */
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_RX_BB_GAIN_FORCE
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl1.cf_paprd_rx_bb_gain_force=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_cntl1.cf_paprd_iqcorr_enable",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_IQCORR_ENABLE
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl1.cf_paprd_iqcorr_enable=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_cntl1.cf_paprd_agc2_settling",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_AGC2_SETTLING
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl1.cf_paprd_agc2_settling=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_cntl1.cf_paprd_train_enable",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL1_CF_CF_PAPRD_TRAIN_ENABLE
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl1.cf_paprd_train_enable=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*          * field_read("BB_paprd_trainer_cntl2.cf_paprd_init_rx_bb_gain",&temp);          */
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL2
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL2_CF_PAPRD_INIT_RX_BB_GAIN
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl2.cf_paprd_init_rx_bb_gain=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_cntl3.cf_paprd_fine_corr_len",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_FINE_CORR_LEN
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl3.cf_paprd_fine_corr_len=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*          * field_read("BB_paprd_trainer_cntl3.cf_paprd_coarse_corr_len",&temp);          */
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_COARSE_CORR_LEN
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl3.cf_paprd_coarse_corr_len=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*          * field_read("BB_paprd_trainer_cntl3.cf_paprd_num_corr_stages",&temp);          */
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_NUM_CORR_STAGES
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl3.cf_paprd_num_corr_stages=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*          * field_read(          *     "BB_paprd_trainer_cntl3.cf_paprd_min_loopback_del",&temp);          */
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_MIN_LOOPBACK_DEL
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl3.cf_paprd_min_loopback_del=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_cntl3.cf_paprd_quick_drop",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl3.cf_paprd_quick_drop=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*          * field_read(          *     "BB_paprd_trainer_cntl3.cf_paprd_adc_desired_size",&temp);          */
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_ADC_DESIRED_SIZE
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl3.cf_paprd_adc_desired_size=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*          * field_read(          *     "BB_paprd_trainer_cntl3.cf_paprd_bbtxmix_disable",&temp);          */
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_BBTXMIX_DISABLE
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl3.cf_paprd_bbtxmix_disable=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_cntl4.cf_paprd_safety_delta",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL4
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_SAFETY_DELTA
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl4.cf_paprd_safety_delta=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_cntl4.cf_paprd_min_corr",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL4
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_MIN_CORR
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"BB_paprd_trainer_cntl4.cf_paprd_min_corr=0x%x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_stat1.paprd_agc2_pwr",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_AGC2_PWR
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"    paprd_agc2_pwr              = 0x%02x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_stat1.paprd_rx_gain_idx",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_RX_GAIN_IDX
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"    paprd_rx_gain_idx           = 0x%02x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_stat1.paprd_train_active",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_ACTIVE
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"    paprd_train_active          = 0x%08x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_stat1.paprd_corr_err",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_CORR_ERR
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"    paprd_corr_err              = 0x%08x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_stat1.paprd_train_incomplete",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_INCOMPLETE
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"    paprd_train_incomplete      = 0x%08x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_stat1.paprd_train_done",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"    paprd_train_done            = 0x%08x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_stat2.paprd_fine_idx",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT2
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT2_PAPRD_FINE_IDX
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"    paprd_fine_idx              = 0x%08x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_stat2.paprd_coarse_idx",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT2
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT2_PAPRD_COARSE_IDX
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"    paprd_coarse_idx            = 0x%08x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_stat2.paprd_fine_val",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT2
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT2_PAPRD_FINE_VAL
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"    paprd_fine_val              = 0x%08x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_trainer_stat3.paprd_train_samples_cnt",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT3
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT3_PAPRD_TRAIN_SAMPLES_CNT
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"    paprd_train_samples_cnt     = 0x%08x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
block|}
comment|/*field_read("BB_tpc_1.force_dac_gain",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TPC_1
argument_list|,
name|AR_PHY_TPC_1_FORCE_DAC_GAIN
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"    dac_gain_forced     = 0x%08x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_tpc_1.forced_dac_gain",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TPC_1
argument_list|,
name|AR_PHY_TPC_1_FORCED_DAC_GAIN
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"    forced_dac_gain     = 0x%08x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/*field_read("BB_paprd_ctrl0_b0.paprd_enable_0",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B0
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B0_PAPRD_ENABLE_0
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"    BB_paprd_ctrl0_b0.paprd_enable_0     = 0x%08x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
condition|)
block|{
comment|/*field_read("BB_paprd_ctrl0_b1.paprd_enable_1",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B1
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B1_PAPRD_ENABLE_1
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"    BB_paprd_ctrl0_b1.paprd_enable_1     = 0x%08x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
if|if
condition|(
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_tx_chainmask
operator|&
name|AR9300_CHAIN2_MASK
condition|)
block|{
comment|/*field_read("BB_paprd_ctrl0_b2.paprd_enable_2",&temp);*/
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B2
argument_list|,
name|AR_PHY_PAPRD_CTRL0_B2_PAPRD_ENABLE_2
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"    BB_paprd_ctrl0_b2.paprd_enable_2     = 0x%08x\n"
argument_list|,
name|temp
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*field_read("BB_tx_forced_gain.forced_txbb1dbgain",&txbb1dbgain);*/
name|txbb1dbgain
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TX_FORCED_GAIN
argument_list|,
name|AR_PHY_TX_FORCED_GAIN_FORCED_TXBB1DBGAIN
argument_list|)
expr_stmt|;
comment|/*field_read("BB_tx_forced_gain.forced_txbb6dbgain",&txbb6dbgain);*/
name|txbb6dbgain
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TX_FORCED_GAIN
argument_list|,
name|AR_PHY_TX_FORCED_GAIN_FORCED_TXBB6DBGAIN
argument_list|)
expr_stmt|;
comment|/*field_read("BB_tx_forced_gain.forced_txmxrgain",&txmxrgain);*/
name|txmxrgain
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TX_FORCED_GAIN
argument_list|,
name|AR_PHY_TX_FORCED_GAIN_FORCED_TXMXRGAIN
argument_list|)
expr_stmt|;
comment|/*field_read("BB_tx_forced_gain.forced_padrvgn_a",&padrvgn_a);*/
name|padrvgn_a
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TX_FORCED_GAIN
argument_list|,
name|AR_PHY_TX_FORCED_GAIN_FORCED_PADRVGNA
argument_list|)
expr_stmt|;
comment|/*field_read("BB_tx_forced_gain.forced_padrvgn_b",&padrvgn_b);*/
name|padrvgn_b
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TX_FORCED_GAIN
argument_list|,
name|AR_PHY_TX_FORCED_GAIN_FORCED_PADRVGNB
argument_list|)
expr_stmt|;
comment|/*field_read("BB_tx_forced_gain.forced_padrvgn_c",&padrvgn_c);*/
name|padrvgn_c
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TX_FORCED_GAIN
argument_list|,
name|AR_PHY_TX_FORCED_GAIN_FORCED_PADRVGNC
argument_list|)
expr_stmt|;
comment|/*field_read("BB_tx_forced_gain.forced_padrvgn_d",&padrvgn_d);*/
name|padrvgn_d
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TX_FORCED_GAIN
argument_list|,
name|AR_PHY_TX_FORCED_GAIN_FORCED_PADRVGND
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"txbb1dbgain=0x%x, txbb6dbgain=0x%x, txmxrgain=0x%x\n"
argument_list|,
name|txbb1dbgain
argument_list|,
name|txbb6dbgain
argument_list|,
name|txmxrgain
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"padrvgn_a=0x%x, padrvgn_b=0x%x\n"
argument_list|,
name|padrvgn_a
argument_list|,
name|padrvgn_b
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_PAPRD
argument_list|,
literal|"padrvgn_c=0x%x, padrvgn_d=0x%x\n"
argument_list|,
name|padrvgn_c
argument_list|,
name|padrvgn_d
argument_list|)
expr_stmt|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|ar9300_paprd_debug_print
parameter_list|(
name|ah
parameter_list|)
end_define

begin_comment
comment|/* dummy macro */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* defined(ART_PAPRD_DEBUG) || defined(AH_DEBUG) */
end_comment

begin_function
specifier|static
name|int
name|ar9300_create_pa_curve
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int32_t
modifier|*
name|pa_table
parameter_list|,
name|u_int32_t
modifier|*
name|small_signal_gain
parameter_list|,
name|int
modifier|*
name|pa_in
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|status
decl_stmt|;
comment|/*char field_name[100];*/
name|u_int32_t
name|paprd_train_data_l
index|[
literal|48
index|]
decl_stmt|,
name|paprd_train_data_u
index|[
literal|48
index|]
decl_stmt|;
name|u_int32_t
name|reg
decl_stmt|;
name|ar9300_paprd_debug_print
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CHAN_INFO_MEMORY
argument_list|,
name|AR_PHY_CHAN_INFO_MEMORY_CHANINFOMEM_S2_READ
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|reg
operator|=
name|AR_PHY_CHAN_INFO_TAB_0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|48
condition|;
name|i
operator|++
control|)
block|{
comment|/*          * sprintf(          *     field_name, "%s%d%s\0", "BB_chan_info_chan_tab_b0[",           *     i, "].chaninfo_word");          */
comment|/*field_read(field_name,&paprd_train_data_l[i]);*/
name|paprd_train_data_l
index|[
name|i
index|]
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|reg
operator|+
literal|4
expr_stmt|;
block|}
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CHAN_INFO_MEMORY
argument_list|,
name|AR_PHY_CHAN_INFO_MEMORY_CHANINFOMEM_S2_READ
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|reg
operator|=
name|AR_PHY_CHAN_INFO_TAB_0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|48
condition|;
name|i
operator|++
control|)
block|{
comment|/*          * sprintf(          *     field_name, "%s%d%s\0", "BB_chan_info_chan_tab_b0[",           *     i, "].chaninfo_word");          */
comment|/*field_read(field_name,&paprd_train_data_u[i]);*/
name|paprd_train_data_u
index|[
name|i
index|]
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|reg
operator|+
literal|4
expr_stmt|;
block|}
comment|/*      * for(i=0; i<48; i++)      *     ath_hal_printf(      *         ah, "%08x%08x\n", paprd_train_data_u[i], paprd_train_data_l[i]);      */
name|status
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|create_pa_curve
argument_list|(
name|paprd_train_data_l
argument_list|,
name|paprd_train_data_u
argument_list|,
name|pa_table
argument_list|,
name|small_signal_gain
argument_list|,
name|pa_in
argument_list|)
operator|==
name|AH_FALSE
condition|)
block|{
name|status
operator|=
operator|-
literal|2
expr_stmt|;
block|}
comment|/* Clear the training done bit */
if|if
condition|(
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|find_expn
parameter_list|(
name|int
name|num
parameter_list|)
block|{
name|int
name|tmp
decl_stmt|,
name|exp
decl_stmt|;
name|exp
operator|=
literal|0
expr_stmt|;
name|tmp
operator|=
name|num
operator|>>
literal|1
expr_stmt|;
while|while
condition|(
name|tmp
operator|!=
literal|0
condition|)
block|{
name|tmp
operator|=
name|tmp
operator|>>
literal|1
expr_stmt|;
name|exp
operator|++
expr_stmt|;
block|}
return|return
name|exp
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|find_proper_scale
parameter_list|(
name|int
name|expn
parameter_list|,
name|int
name|n
parameter_list|)
block|{
name|int
name|q_pw
decl_stmt|;
name|q_pw
operator|=
operator|(
name|expn
operator|>
name|n
operator|)
condition|?
name|expn
operator|-
literal|10
else|:
literal|0
expr_stmt|;
return|return
name|q_pw
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|find_max
parameter_list|(
name|int
modifier|*
name|array
parameter_list|,
name|int
name|length
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|loc_max
decl_stmt|;
name|loc_max
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|length
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|array
index|[
name|i
index|]
operator|>
name|loc_max
condition|)
block|{
name|loc_max
operator|=
name|array
index|[
name|i
index|]
expr_stmt|;
block|}
block|}
return|return
name|loc_max
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|paprd_abs
parameter_list|(
name|int
name|num
parameter_list|)
block|{
if|if
condition|(
name|num
operator|<
literal|0
condition|)
block|{
return|return
operator|-
name|num
return|;
block|}
return|return
name|num
return|;
block|}
end_function

begin_define
define|#
directive|define
name|NUM_BIN
value|23
end_define

begin_function
name|HAL_BOOL
name|create_pa_curve
parameter_list|(
name|u_int32_t
modifier|*
name|paprd_train_data_l
parameter_list|,
name|u_int32_t
modifier|*
name|paprd_train_data_u
parameter_list|,
name|u_int32_t
modifier|*
name|pa_table
parameter_list|,
name|u_int32_t
modifier|*
name|g_fxp_ext
parameter_list|,
name|int
modifier|*
name|pa_in
parameter_list|)
block|{
name|unsigned
name|int
name|accum_cnt
index|[
name|NUM_BIN
operator|+
literal|1
index|]
decl_stmt|;
name|unsigned
name|int
name|accum_tx
index|[
name|NUM_BIN
operator|+
literal|1
index|]
decl_stmt|;
name|unsigned
name|int
name|accum_rx
index|[
name|NUM_BIN
operator|+
literal|1
index|]
decl_stmt|;
name|unsigned
name|int
name|accum_ang
index|[
name|NUM_BIN
operator|+
literal|1
index|]
decl_stmt|;
name|unsigned
name|int
name|thresh_accum_cnt
decl_stmt|;
name|int
name|max_index
decl_stmt|;
name|int
name|scale_factor
decl_stmt|;
name|int
name|x_est
index|[
name|NUM_BIN
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|y
index|[
name|NUM_BIN
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|theta
index|[
name|NUM_BIN
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|y_sqr
index|[
name|NUM_BIN
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|y_quad
index|[
name|NUM_BIN
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|theta_tilde
index|[
name|NUM_BIN
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|pa_angle
index|[
name|NUM_BIN
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|b1_tmp
index|[
name|NUM_BIN
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|b2_tmp
index|[
name|NUM_BIN
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|b1_abs
index|[
name|NUM_BIN
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|b2_abs
index|[
name|NUM_BIN
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|y_lin
index|[
name|NUM_BIN
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|y_est
index|[
name|NUM_BIN
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|x_est_fxp1_nonlin
index|[
name|NUM_BIN
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|x_tilde
index|[
name|NUM_BIN
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|x_tilde_abs
index|[
name|NUM_BIN
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|g_fxp
decl_stmt|;
name|int
name|y_intercept
decl_stmt|;
name|int
name|order_x_by_y
decl_stmt|;
name|int
name|m
decl_stmt|,
name|half_lo
decl_stmt|,
name|half_hi
decl_stmt|;
name|int
name|sum_y_sqr
decl_stmt|;
name|int
name|sum_y_quad
decl_stmt|;
name|int
name|q_x
decl_stmt|,
name|q_b1
decl_stmt|,
name|q_b2
decl_stmt|;
name|int
name|beta_raw
decl_stmt|,
name|alpha_raw
decl_stmt|,
name|scale_b
decl_stmt|;
name|int
name|q_scale_b
decl_stmt|,
name|q_beta
decl_stmt|,
name|q_alpha
decl_stmt|;
name|int
name|alpha
decl_stmt|,
name|beta
decl_stmt|;
name|int
name|order_1
decl_stmt|,
name|order_2
decl_stmt|;
name|int
name|order1_5x
decl_stmt|,
name|order2_3x
decl_stmt|;
name|int
name|order1_5x_rem
decl_stmt|,
name|order2_3x_rem
decl_stmt|;
name|int
name|y5
decl_stmt|,
name|y3
decl_stmt|,
name|tmp
decl_stmt|;
name|int
name|bin
decl_stmt|,
name|idx
decl_stmt|;
name|int
name|theta_low_bin
init|=
literal|0
decl_stmt|;
comment|/*      * [15:00] u16, accum_cnt[15:00]: number of samples in the bin      * [42:16] u27, accum_tx[26:00]: sum(tx amplitude) of the bin      * [63:43] u21, accum_rx[20:00]:       *     sum(rx amplitude distance to lower bin edge) of the bin      * [90:64] s27, accum_ang[26:00]: sum(angles) of the bin      */
name|max_index
operator|=
literal|0
expr_stmt|;
comment|/*      * Disregard any bin that contains less than       * or equal to 16 counts of samples      */
name|thresh_accum_cnt
operator|=
literal|16
expr_stmt|;
name|scale_factor
operator|=
literal|5
expr_stmt|;
for|for
control|(
name|bin
operator|=
literal|0
init|;
name|bin
operator|<
name|NUM_BIN
condition|;
name|bin
operator|++
control|)
block|{
name|accum_cnt
index|[
name|bin
index|]
operator|=
name|paprd_train_data_l
index|[
name|bin
index|]
operator|&
literal|0xffff
expr_stmt|;
comment|/* lower 16 bit OR-ed  upper 11 bits */
name|accum_tx
index|[
name|bin
index|]
operator|=
operator|(
operator|(
name|paprd_train_data_l
index|[
name|bin
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xffff
operator|)
operator||
operator|(
operator|(
name|paprd_train_data_u
index|[
name|bin
index|]
operator|&
literal|0x7ff
operator|)
operator|<<
literal|16
operator|)
expr_stmt|;
name|accum_rx
index|[
name|bin
index|]
operator|=
operator|(
operator|(
name|paprd_train_data_u
index|[
name|bin
index|]
operator|>>
literal|11
operator|)
operator|&
literal|0x1f
operator|)
operator||
operator|(
operator|(
name|paprd_train_data_l
index|[
name|bin
operator|+
literal|23
index|]
operator|&
literal|0xffff
operator|)
operator|<<
literal|5
operator|)
expr_stmt|;
name|accum_ang
index|[
name|bin
index|]
operator|=
operator|(
operator|(
name|paprd_train_data_l
index|[
name|bin
operator|+
literal|23
index|]
operator|>>
literal|16
operator|)
operator|&
literal|0xffff
operator|)
operator||
operator|(
operator|(
name|paprd_train_data_u
index|[
name|bin
operator|+
literal|23
index|]
operator|&
literal|0x7ff
operator|)
operator|<<
literal|16
operator|)
expr_stmt|;
comment|/*          * printf(          *     "%d\t%d\t%d\t%d\n", accum_cnt[bin], accum_tx[bin],          *     accum_rx[bin], accum_ang[bin]);          */
if|if
condition|(
name|accum_cnt
index|[
name|bin
index|]
operator|>
name|thresh_accum_cnt
condition|)
block|{
comment|/* accum_cnt[i] will be non-zero at this point */
name|x_est
index|[
name|bin
operator|+
literal|1
index|]
operator|=
operator|(
operator|(
operator|(
operator|(
name|accum_tx
index|[
name|bin
index|]
operator|<<
name|scale_factor
operator|)
operator|+
name|accum_cnt
index|[
name|bin
index|]
operator|)
operator|/
name|accum_cnt
index|[
name|bin
index|]
operator|)
operator|+
literal|32
operator|)
operator|>>
name|scale_factor
expr_stmt|;
name|y
index|[
name|bin
operator|+
literal|1
index|]
operator|=
operator|(
operator|(
operator|(
operator|(
operator|(
name|accum_rx
index|[
name|bin
index|]
operator|<<
name|scale_factor
operator|)
operator|+
name|accum_cnt
index|[
name|bin
index|]
operator|)
operator|/
name|accum_cnt
index|[
name|bin
index|]
operator|)
operator|+
literal|32
operator|)
operator|>>
name|scale_factor
operator|)
operator|+
operator|(
literal|1
operator|<<
name|scale_factor
operator|)
operator|*
name|max_index
operator|+
literal|16
expr_stmt|;
if|if
condition|(
name|accum_ang
index|[
name|bin
index|]
operator|>=
operator|(
literal|1
operator|<<
literal|26
operator|)
condition|)
block|{
name|theta
index|[
name|bin
operator|+
literal|1
index|]
operator|=
operator|(
operator|(
name|accum_ang
index|[
name|bin
index|]
operator|-
operator|(
literal|1
operator|<<
literal|27
operator|)
operator|)
operator|*
operator|(
literal|1
operator|<<
name|scale_factor
operator|)
operator|+
name|accum_cnt
index|[
name|bin
index|]
operator|)
expr_stmt|;
name|theta
index|[
name|bin
operator|+
literal|1
index|]
operator|=
name|theta
index|[
name|bin
operator|+
literal|1
index|]
operator|/
operator|(
name|int
operator|)
name|accum_cnt
index|[
name|bin
index|]
expr_stmt|;
comment|/*                  *  theta[i+1] =                   *      ((accum_ang[i] - (1<< 27)) *                   *      (1<< scale_factor) + zz) / zz;                  */
block|}
else|else
block|{
name|theta
index|[
name|bin
operator|+
literal|1
index|]
operator|=
operator|(
operator|(
name|accum_ang
index|[
name|bin
index|]
operator|*
operator|(
literal|1
operator|<<
name|scale_factor
operator|)
operator|)
operator|+
name|accum_cnt
index|[
name|bin
index|]
operator|)
operator|/
name|accum_cnt
index|[
name|bin
index|]
expr_stmt|;
block|}
name|max_index
operator|++
expr_stmt|;
block|}
comment|/*          * printf(          *     "i=%d, theta[i+1]=%d\t%d\t%d\t%d\t%d\n",           *     i, theta[i+1], accum_cnt[i],           *     accum_tx[i], accum_rx[i], accum_ang[i]);          */
block|}
comment|/*      * Find average theta of first 5 bin and all of those to same value.       * Curve is linear at that range.      */
for|for
control|(
name|bin
operator|=
literal|1
init|;
name|bin
operator|<
literal|6
condition|;
name|bin
operator|++
control|)
block|{
name|theta_low_bin
operator|+=
name|theta
index|[
name|bin
index|]
expr_stmt|;
block|}
name|theta_low_bin
operator|=
name|theta_low_bin
operator|/
literal|5
expr_stmt|;
for|for
control|(
name|bin
operator|=
literal|1
init|;
name|bin
operator|<
literal|6
condition|;
name|bin
operator|++
control|)
block|{
name|theta
index|[
name|bin
index|]
operator|=
name|theta_low_bin
expr_stmt|;
block|}
comment|/* Set values at origin */
name|theta
index|[
literal|0
index|]
operator|=
name|theta_low_bin
expr_stmt|;
for|for
control|(
name|bin
operator|=
literal|0
init|;
name|bin
operator|<=
name|max_index
condition|;
name|bin
operator|++
control|)
block|{
name|theta
index|[
name|bin
index|]
operator|=
name|theta
index|[
name|bin
index|]
operator|-
name|theta_low_bin
expr_stmt|;
comment|/*printf("bin=%d, theta[bin] = %d\n", bin, theta[bin]);*/
block|}
name|x_est
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|y
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|scale_factor
operator|=
literal|8
expr_stmt|;
comment|/* low signal gain */
if|if
condition|(
name|x_est
index|[
literal|6
index|]
operator|==
name|x_est
index|[
literal|3
index|]
condition|)
block|{
return|return
name|AH_FALSE
return|;
block|}
name|g_fxp
operator|=
operator|(
operator|(
operator|(
name|y
index|[
literal|6
index|]
operator|-
name|y
index|[
literal|3
index|]
operator|)
operator|*
literal|1
operator|<<
name|scale_factor
operator|)
operator|+
operator|(
name|x_est
index|[
literal|6
index|]
operator|-
name|x_est
index|[
literal|3
index|]
operator|)
operator|)
operator|/
operator|(
name|x_est
index|[
literal|6
index|]
operator|-
name|x_est
index|[
literal|3
index|]
operator|)
expr_stmt|;
if|if
condition|(
name|g_fxp
operator|==
literal|0
condition|)
block|{
comment|/*          * ath_hal_printf(          *     NULL, "%s[%d] Potential divide by zero error\n",          *     __func__, __LINE__);          */
return|return
name|AH_FALSE
return|;
block|}
for|for
control|(
name|bin
operator|=
literal|0
init|;
name|bin
operator|<=
name|max_index
condition|;
name|bin
operator|++
control|)
block|{
name|y_lin
index|[
name|bin
index|]
operator|=
operator|(
name|g_fxp
operator|*
operator|(
name|x_est
index|[
name|bin
index|]
operator|-
name|x_est
index|[
literal|3
index|]
operator|)
operator|+
operator|(
literal|1
operator|<<
name|scale_factor
operator|)
operator|)
operator|/
operator|(
literal|1
operator|<<
name|scale_factor
operator|)
operator|+
name|y
index|[
literal|3
index|]
expr_stmt|;
block|}
name|y_intercept
operator|=
name|y_lin
index|[
literal|0
index|]
expr_stmt|;
for|for
control|(
name|bin
operator|=
literal|0
init|;
name|bin
operator|<=
name|max_index
condition|;
name|bin
operator|++
control|)
block|{
name|y_est
index|[
name|bin
index|]
operator|=
name|y
index|[
name|bin
index|]
operator|-
name|y_intercept
expr_stmt|;
name|y_lin
index|[
name|bin
index|]
operator|=
name|y_lin
index|[
name|bin
index|]
operator|-
name|y_intercept
expr_stmt|;
block|}
for|for
control|(
name|bin
operator|=
literal|0
init|;
name|bin
operator|<=
literal|3
condition|;
name|bin
operator|++
control|)
block|{
name|y_est
index|[
name|bin
index|]
operator|=
name|bin
operator|*
literal|32
expr_stmt|;
comment|/* g_fxp was checked for zero already */
name|x_est
index|[
name|bin
index|]
operator|=
operator|(
operator|(
name|y_est
index|[
name|bin
index|]
operator|*
literal|1
operator|<<
name|scale_factor
operator|)
operator|+
name|g_fxp
operator|)
operator|/
name|g_fxp
expr_stmt|;
block|}
comment|/*      *  for (bin = 0; bin<= max_index; bin++) {      *      printf("y_est[%d] = %d, x_est[%d]=%d\n",      *          bin, y_est[bin], bin, x_est[bin]);      *  }      */
for|for
control|(
name|bin
operator|=
literal|0
init|;
name|bin
operator|<=
name|max_index
condition|;
name|bin
operator|++
control|)
block|{
name|x_est_fxp1_nonlin
index|[
name|bin
index|]
operator|=
name|x_est
index|[
name|bin
index|]
operator|-
operator|(
operator|(
literal|1
operator|<<
name|scale_factor
operator|)
operator|*
name|y_est
index|[
name|bin
index|]
operator|+
name|g_fxp
operator|)
operator|/
name|g_fxp
expr_stmt|;
comment|/*printf("x_est_fxp1_nonlin[%d] = %d\n", bin, x_est_fxp1_nonlin[bin]);*/
block|}
comment|/* Check for divide by 0 */
if|if
condition|(
name|y_est
index|[
name|max_index
index|]
operator|==
literal|0
condition|)
block|{
return|return
name|AH_FALSE
return|;
block|}
name|order_x_by_y
operator|=
operator|(
name|x_est_fxp1_nonlin
index|[
name|max_index
index|]
operator|+
name|y_est
index|[
name|max_index
index|]
operator|)
operator|/
name|y_est
index|[
name|max_index
index|]
expr_stmt|;
if|if
condition|(
name|order_x_by_y
operator|==
literal|0
condition|)
block|{
name|m
operator|=
literal|10
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|order_x_by_y
operator|==
literal|1
condition|)
block|{
name|m
operator|=
literal|9
expr_stmt|;
block|}
else|else
block|{
name|m
operator|=
literal|8
expr_stmt|;
block|}
name|half_lo
operator|=
operator|(
name|max_index
operator|>
literal|15
operator|)
condition|?
literal|7
else|:
name|max_index
operator|>>
literal|1
expr_stmt|;
name|half_hi
operator|=
name|max_index
operator|-
name|half_lo
expr_stmt|;
name|scale_factor
operator|=
literal|8
expr_stmt|;
name|sum_y_sqr
operator|=
literal|0
expr_stmt|;
name|sum_y_quad
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|bin
operator|=
literal|0
init|;
name|bin
operator|<=
name|half_hi
condition|;
name|bin
operator|++
control|)
block|{
if|if
condition|(
name|y_est
index|[
name|bin
operator|+
name|half_lo
index|]
operator|==
literal|0
condition|)
block|{
comment|/*              * ath_hal_printf(              *     NULL, "%s Potential divide by zero error\n", __func__);              */
return|return
name|AH_FALSE
return|;
block|}
name|x_tilde
index|[
name|bin
index|]
operator|=
operator|(
name|x_est_fxp1_nonlin
index|[
name|bin
operator|+
name|half_lo
index|]
operator|*
operator|(
literal|1
operator|<<
name|m
operator|)
operator|+
name|y_est
index|[
name|bin
operator|+
name|half_lo
index|]
operator|)
operator|/
name|y_est
index|[
name|bin
operator|+
name|half_lo
index|]
expr_stmt|;
name|x_tilde
index|[
name|bin
index|]
operator|=
operator|(
name|x_tilde
index|[
name|bin
index|]
operator|*
operator|(
literal|1
operator|<<
name|m
operator|)
operator|+
name|y_est
index|[
name|bin
operator|+
name|half_lo
index|]
operator|)
operator|/
name|y_est
index|[
name|bin
operator|+
name|half_lo
index|]
expr_stmt|;
name|x_tilde
index|[
name|bin
index|]
operator|=
operator|(
name|x_tilde
index|[
name|bin
index|]
operator|*
operator|(
literal|1
operator|<<
name|m
operator|)
operator|+
name|y_est
index|[
name|bin
operator|+
name|half_lo
index|]
operator|)
operator|/
name|y_est
index|[
name|bin
operator|+
name|half_lo
index|]
expr_stmt|;
name|y_sqr
index|[
name|bin
index|]
operator|=
operator|(
name|y_est
index|[
name|bin
operator|+
name|half_lo
index|]
operator|*
name|y_est
index|[
name|bin
operator|+
name|half_lo
index|]
operator|+
operator|(
name|scale_factor
operator|*
name|scale_factor
operator|)
operator|)
operator|/
operator|(
name|scale_factor
operator|*
name|scale_factor
operator|)
expr_stmt|;
name|x_tilde_abs
index|[
name|bin
index|]
operator|=
name|paprd_abs
argument_list|(
name|x_tilde
index|[
name|bin
index|]
argument_list|)
expr_stmt|;
name|y_quad
index|[
name|bin
index|]
operator|=
name|y_sqr
index|[
name|bin
index|]
operator|*
name|y_sqr
index|[
name|bin
index|]
expr_stmt|;
name|sum_y_sqr
operator|=
name|sum_y_sqr
operator|+
name|y_sqr
index|[
name|bin
index|]
expr_stmt|;
name|sum_y_quad
operator|=
name|sum_y_quad
operator|+
name|y_quad
index|[
name|bin
index|]
expr_stmt|;
block|}
comment|/*printf("sum_y_sqr = %d, sum_y_quad=%d\n", sum_y_sqr, sum_y_quad);*/
for|for
control|(
name|bin
operator|=
literal|0
init|;
name|bin
operator|<=
name|half_hi
condition|;
name|bin
operator|++
control|)
block|{
name|b1_tmp
index|[
name|bin
index|]
operator|=
name|y_sqr
index|[
name|bin
index|]
operator|*
operator|(
name|half_hi
operator|+
literal|1
operator|)
operator|-
name|sum_y_sqr
expr_stmt|;
name|b2_tmp
index|[
name|bin
index|]
operator|=
name|sum_y_quad
operator|-
name|sum_y_sqr
operator|*
name|y_sqr
index|[
name|bin
index|]
expr_stmt|;
name|b1_abs
index|[
name|bin
index|]
operator|=
name|paprd_abs
argument_list|(
name|b1_tmp
index|[
name|bin
index|]
argument_list|)
expr_stmt|;
name|b2_abs
index|[
name|bin
index|]
operator|=
name|paprd_abs
argument_list|(
name|b2_tmp
index|[
name|bin
index|]
argument_list|)
expr_stmt|;
comment|/*          * printf(          *     "bin=%d, b1_tmp[bin] = %d, b2_tmp[bin] = %d\n",           *     bin, b1_tmp[bin], b2_tmp[bin]);          */
block|}
name|q_x
operator|=
name|find_proper_scale
argument_list|(
name|find_expn
argument_list|(
name|find_max
argument_list|(
name|x_tilde_abs
argument_list|,
name|half_hi
operator|+
literal|1
argument_list|)
argument_list|)
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|q_b1
operator|=
name|find_proper_scale
argument_list|(
name|find_expn
argument_list|(
name|find_max
argument_list|(
name|b1_abs
argument_list|,
name|half_hi
operator|+
literal|1
argument_list|)
argument_list|)
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|q_b2
operator|=
name|find_proper_scale
argument_list|(
name|find_expn
argument_list|(
name|find_max
argument_list|(
name|b2_abs
argument_list|,
name|half_hi
operator|+
literal|1
argument_list|)
argument_list|)
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|beta_raw
operator|=
literal|0
expr_stmt|;
name|alpha_raw
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|bin
operator|=
literal|0
init|;
name|bin
operator|<=
name|half_hi
condition|;
name|bin
operator|++
control|)
block|{
name|x_tilde
index|[
name|bin
index|]
operator|=
name|x_tilde
index|[
name|bin
index|]
operator|/
operator|(
literal|1
operator|<<
name|q_x
operator|)
expr_stmt|;
name|b1_tmp
index|[
name|bin
index|]
operator|=
name|b1_tmp
index|[
name|bin
index|]
operator|/
operator|(
literal|1
operator|<<
name|q_b1
operator|)
expr_stmt|;
name|b2_tmp
index|[
name|bin
index|]
operator|=
name|b2_tmp
index|[
name|bin
index|]
operator|/
operator|(
literal|1
operator|<<
name|q_b2
operator|)
expr_stmt|;
comment|/*          * printf(          *     "bin=%d, b1_tmp[bin]=%d b2_tmp[bin]=%d x_tilde[bin] = %d\n",           *     bin, b1_tmp[bin], b2_tmp[bin], x_tilde[bin]);          */
name|beta_raw
operator|=
name|beta_raw
operator|+
name|b1_tmp
index|[
name|bin
index|]
operator|*
name|x_tilde
index|[
name|bin
index|]
expr_stmt|;
name|alpha_raw
operator|=
name|alpha_raw
operator|+
name|b2_tmp
index|[
name|bin
index|]
operator|*
name|x_tilde
index|[
name|bin
index|]
expr_stmt|;
block|}
name|scale_b
operator|=
operator|(
operator|(
name|sum_y_quad
operator|/
name|scale_factor
operator|)
operator|*
operator|(
name|half_hi
operator|+
literal|1
operator|)
operator|-
operator|(
name|sum_y_sqr
operator|/
name|scale_factor
operator|)
operator|*
name|sum_y_sqr
operator|)
operator|*
name|scale_factor
expr_stmt|;
name|q_scale_b
operator|=
name|find_proper_scale
argument_list|(
name|find_expn
argument_list|(
name|paprd_abs
argument_list|(
name|scale_b
argument_list|)
argument_list|)
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|scale_b
operator|=
name|scale_b
operator|/
operator|(
literal|1
operator|<<
name|q_scale_b
operator|)
expr_stmt|;
comment|/* Check for divide by 0 */
if|if
condition|(
name|scale_b
operator|==
literal|0
condition|)
block|{
return|return
name|AH_FALSE
return|;
block|}
name|q_beta
operator|=
name|find_proper_scale
argument_list|(
name|find_expn
argument_list|(
name|paprd_abs
argument_list|(
name|beta_raw
argument_list|)
argument_list|)
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|q_alpha
operator|=
name|find_proper_scale
argument_list|(
name|find_expn
argument_list|(
name|paprd_abs
argument_list|(
name|alpha_raw
argument_list|)
argument_list|)
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|beta_raw
operator|=
name|beta_raw
operator|/
operator|(
literal|1
operator|<<
name|q_beta
operator|)
expr_stmt|;
name|alpha_raw
operator|=
name|alpha_raw
operator|/
operator|(
literal|1
operator|<<
name|q_alpha
operator|)
expr_stmt|;
name|alpha
operator|=
operator|(
name|alpha_raw
operator|<<
literal|10
operator|)
operator|/
name|scale_b
expr_stmt|;
name|beta
operator|=
operator|(
name|beta_raw
operator|<<
literal|10
operator|)
operator|/
name|scale_b
expr_stmt|;
name|order_1
operator|=
literal|3
operator|*
name|m
operator|-
name|q_x
operator|-
name|q_b1
operator|-
name|q_beta
operator|+
literal|10
operator|+
name|q_scale_b
expr_stmt|;
name|order_2
operator|=
literal|3
operator|*
name|m
operator|-
name|q_x
operator|-
name|q_b2
operator|-
name|q_alpha
operator|+
literal|10
operator|+
name|q_scale_b
expr_stmt|;
name|order1_5x
operator|=
name|order_1
operator|/
literal|5
expr_stmt|;
name|order2_3x
operator|=
name|order_2
operator|/
literal|3
expr_stmt|;
name|order1_5x_rem
operator|=
name|order_1
operator|-
literal|5
operator|*
name|order1_5x
expr_stmt|;
name|order2_3x_rem
operator|=
name|order_2
operator|-
literal|3
operator|*
name|order2_3x
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|AR9300_PAPRD_TABLE_SZ
condition|;
name|idx
operator|++
control|)
block|{
name|tmp
operator|=
name|idx
operator|*
literal|32
expr_stmt|;
name|y5
operator|=
operator|(
operator|(
name|beta
operator|*
name|tmp
operator|)
operator|>>
literal|6
operator|)
operator|>>
name|order1_5x
expr_stmt|;
name|y5
operator|=
operator|(
name|y5
operator|*
name|tmp
operator|)
operator|>>
name|order1_5x
expr_stmt|;
name|y5
operator|=
operator|(
name|y5
operator|*
name|tmp
operator|)
operator|>>
name|order1_5x
expr_stmt|;
name|y5
operator|=
operator|(
name|y5
operator|*
name|tmp
operator|)
operator|>>
name|order1_5x
expr_stmt|;
name|y5
operator|=
operator|(
name|y5
operator|*
name|tmp
operator|)
operator|>>
name|order1_5x
expr_stmt|;
name|y5
operator|=
name|y5
operator|>>
name|order1_5x_rem
expr_stmt|;
name|y3
operator|=
operator|(
name|alpha
operator|*
name|tmp
operator|)
operator|>>
name|order2_3x
expr_stmt|;
name|y3
operator|=
operator|(
name|y3
operator|*
name|tmp
operator|)
operator|>>
name|order2_3x
expr_stmt|;
name|y3
operator|=
operator|(
name|y3
operator|*
name|tmp
operator|)
operator|>>
name|order2_3x
expr_stmt|;
name|y3
operator|=
name|y3
operator|>>
name|order2_3x_rem
expr_stmt|;
comment|/* g_fxp was checked for zero already */
name|pa_in
index|[
name|idx
index|]
operator|=
name|y5
operator|+
name|y3
operator|+
operator|(
literal|256
operator|*
name|tmp
operator|)
operator|/
name|g_fxp
expr_stmt|;
block|}
for|for
control|(
name|idx
operator|=
literal|1
init|;
name|idx
operator|<
literal|23
condition|;
name|idx
operator|++
control|)
block|{
name|tmp
operator|=
name|pa_in
index|[
name|idx
operator|+
literal|1
index|]
operator|-
name|pa_in
index|[
name|idx
index|]
expr_stmt|;
if|if
condition|(
name|tmp
operator|<
literal|0
condition|)
block|{
name|pa_in
index|[
name|idx
operator|+
literal|1
index|]
operator|=
name|pa_in
index|[
name|idx
index|]
operator|+
operator|(
name|pa_in
index|[
name|idx
index|]
operator|-
name|pa_in
index|[
name|idx
operator|-
literal|1
index|]
operator|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|AR9300_PAPRD_TABLE_SZ
condition|;
name|idx
operator|++
control|)
block|{
name|pa_in
index|[
name|idx
index|]
operator|=
operator|(
name|pa_in
index|[
name|idx
index|]
operator|<
literal|1400
operator|)
condition|?
name|pa_in
index|[
name|idx
index|]
else|:
literal|1400
expr_stmt|;
comment|/*printf("idx=%d, pa_in[idx]=%d\n", i, pa_in[idx]);*/
block|}
name|beta_raw
operator|=
literal|0
expr_stmt|;
name|alpha_raw
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|bin
operator|=
literal|0
init|;
name|bin
operator|<=
name|half_hi
condition|;
name|bin
operator|++
control|)
block|{
comment|/*          *  printf(          *      "bin=%d half_lo=%d m=%d theta[bin+half_lo]=%d "          *      "y_est[bin+half_lo]=%d\n",           *      bin, half_lo, m, theta[bin+half_lo], y_est[bin+half_lo]);          */
comment|/* y_est[] was already checked for zero */
name|theta_tilde
index|[
name|bin
index|]
operator|=
operator|(
operator|(
name|theta
index|[
name|bin
operator|+
name|half_lo
index|]
operator|<<
name|m
operator|)
operator|+
name|y_est
index|[
name|bin
operator|+
name|half_lo
index|]
operator|)
operator|/
name|y_est
index|[
name|bin
operator|+
name|half_lo
index|]
expr_stmt|;
name|theta_tilde
index|[
name|bin
index|]
operator|=
operator|(
operator|(
name|theta_tilde
index|[
name|bin
index|]
operator|<<
name|m
operator|)
operator|+
name|y_est
index|[
name|bin
operator|+
name|half_lo
index|]
operator|)
operator|/
name|y_est
index|[
name|bin
operator|+
name|half_lo
index|]
expr_stmt|;
name|theta_tilde
index|[
name|bin
index|]
operator|=
operator|(
operator|(
name|theta_tilde
index|[
name|bin
index|]
operator|<<
name|m
operator|)
operator|+
name|y_est
index|[
name|bin
operator|+
name|half_lo
index|]
operator|)
operator|/
name|y_est
index|[
name|bin
operator|+
name|half_lo
index|]
expr_stmt|;
comment|/*printf("bin=%d theta_tilde[bin]=%d\n", bin, theta_tilde[bin]);*/
name|beta_raw
operator|=
name|beta_raw
operator|+
name|b1_tmp
index|[
name|bin
index|]
operator|*
name|theta_tilde
index|[
name|bin
index|]
expr_stmt|;
name|alpha_raw
operator|=
name|alpha_raw
operator|+
name|b2_tmp
index|[
name|bin
index|]
operator|*
name|theta_tilde
index|[
name|bin
index|]
expr_stmt|;
comment|/*         printf("bin=%d, alpha_raw=%d, beta_raw=%d\n", bin, alpha_raw, beta_raw);          */
block|}
name|q_beta
operator|=
name|find_proper_scale
argument_list|(
name|find_expn
argument_list|(
name|paprd_abs
argument_list|(
name|beta_raw
argument_list|)
argument_list|)
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|q_alpha
operator|=
name|find_proper_scale
argument_list|(
name|find_expn
argument_list|(
name|paprd_abs
argument_list|(
name|alpha_raw
argument_list|)
argument_list|)
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|beta_raw
operator|=
name|beta_raw
operator|/
operator|(
literal|1
operator|<<
name|q_beta
operator|)
expr_stmt|;
name|alpha_raw
operator|=
name|alpha_raw
operator|/
operator|(
literal|1
operator|<<
name|q_alpha
operator|)
expr_stmt|;
comment|/* scale_b checked for zero previously */
name|alpha
operator|=
operator|(
name|alpha_raw
operator|<<
literal|10
operator|)
operator|/
name|scale_b
expr_stmt|;
name|beta
operator|=
operator|(
name|beta_raw
operator|<<
literal|10
operator|)
operator|/
name|scale_b
expr_stmt|;
name|order_1
operator|=
literal|3
operator|*
name|m
operator|-
name|q_x
operator|-
name|q_b1
operator|-
name|q_beta
operator|+
literal|10
operator|+
name|q_scale_b
operator|+
literal|5
expr_stmt|;
name|order_2
operator|=
literal|3
operator|*
name|m
operator|-
name|q_x
operator|-
name|q_b2
operator|-
name|q_alpha
operator|+
literal|10
operator|+
name|q_scale_b
operator|+
literal|5
expr_stmt|;
name|order1_5x
operator|=
name|order_1
operator|/
literal|5
expr_stmt|;
name|order2_3x
operator|=
name|order_2
operator|/
literal|3
expr_stmt|;
name|order1_5x_rem
operator|=
name|order_1
operator|-
literal|5
operator|*
name|order1_5x
expr_stmt|;
name|order2_3x_rem
operator|=
name|order_2
operator|-
literal|3
operator|*
name|order2_3x
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|AR9300_PAPRD_TABLE_SZ
condition|;
name|idx
operator|++
control|)
block|{
name|tmp
operator|=
name|idx
operator|*
literal|32
expr_stmt|;
if|if
condition|(
name|beta
operator|>
literal|0
condition|)
block|{
name|y5
operator|=
operator|(
operator|(
operator|(
name|beta
operator|*
name|tmp
operator|-
literal|64
operator|)
operator|>>
literal|6
operator|)
operator|-
operator|(
literal|1
operator|<<
name|order1_5x
operator|)
operator|)
operator|/
operator|(
literal|1
operator|<<
name|order1_5x
operator|)
expr_stmt|;
block|}
else|else
block|{
name|y5
operator|=
operator|(
operator|(
operator|(
operator|(
name|beta
operator|*
name|tmp
operator|-
literal|64
operator|)
operator|>>
literal|6
operator|)
operator|+
operator|(
literal|1
operator|<<
name|order1_5x
operator|)
operator|)
operator|/
operator|(
literal|1
operator|<<
name|order1_5x
operator|)
operator|)
expr_stmt|;
block|}
name|y5
operator|=
operator|(
name|y5
operator|*
name|tmp
operator|)
operator|/
operator|(
literal|1
operator|<<
name|order1_5x
operator|)
expr_stmt|;
name|y5
operator|=
operator|(
name|y5
operator|*
name|tmp
operator|)
operator|/
operator|(
literal|1
operator|<<
name|order1_5x
operator|)
expr_stmt|;
name|y5
operator|=
operator|(
name|y5
operator|*
name|tmp
operator|)
operator|/
operator|(
literal|1
operator|<<
name|order1_5x
operator|)
expr_stmt|;
name|y5
operator|=
operator|(
name|y5
operator|*
name|tmp
operator|)
operator|/
operator|(
literal|1
operator|<<
name|order1_5x
operator|)
expr_stmt|;
name|y5
operator|=
name|y5
operator|/
operator|(
literal|1
operator|<<
name|order1_5x_rem
operator|)
expr_stmt|;
if|if
condition|(
name|beta
operator|>
literal|0
condition|)
block|{
name|y3
operator|=
operator|(
name|alpha
operator|*
name|tmp
operator|-
operator|(
literal|1
operator|<<
name|order2_3x
operator|)
operator|)
operator|/
operator|(
literal|1
operator|<<
name|order2_3x
operator|)
expr_stmt|;
block|}
else|else
block|{
name|y3
operator|=
operator|(
name|alpha
operator|*
name|tmp
operator|+
operator|(
literal|1
operator|<<
name|order2_3x
operator|)
operator|)
operator|/
operator|(
literal|1
operator|<<
name|order2_3x
operator|)
expr_stmt|;
block|}
name|y3
operator|=
operator|(
name|y3
operator|*
name|tmp
operator|)
operator|/
operator|(
literal|1
operator|<<
name|order2_3x
operator|)
expr_stmt|;
name|y3
operator|=
operator|(
name|y3
operator|*
name|tmp
operator|)
operator|/
operator|(
literal|1
operator|<<
name|order2_3x
operator|)
expr_stmt|;
name|y3
operator|=
name|y3
operator|/
operator|(
literal|1
operator|<<
name|order2_3x_rem
operator|)
expr_stmt|;
name|pa_angle
index|[
name|idx
index|]
operator|=
name|y5
operator|+
name|y3
expr_stmt|;
comment|/*printf("idx=%d, y5 = %d, y3=%d\n", idx, y5, y3);*/
name|pa_angle
index|[
name|idx
index|]
operator|=
operator|(
name|pa_angle
index|[
name|idx
index|]
operator|<
operator|-
literal|150
operator|)
condition|?
operator|-
literal|150
else|:
operator|(
operator|(
name|pa_angle
index|[
name|idx
index|]
operator|>
literal|150
operator|)
condition|?
literal|150
else|:
name|pa_angle
index|[
name|idx
index|]
operator|)
expr_stmt|;
block|}
name|pa_angle
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|pa_angle
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|pa_angle
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|pa_angle
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
name|pa_angle
index|[
literal|4
index|]
operator|=
operator|(
name|pa_angle
index|[
literal|5
index|]
operator|+
literal|2
operator|)
operator|>>
literal|1
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|AR9300_PAPRD_TABLE_SZ
condition|;
name|idx
operator|++
control|)
block|{
name|pa_table
index|[
name|idx
index|]
operator|=
operator|(
operator|(
name|pa_in
index|[
name|idx
index|]
operator|&
literal|0x7ff
operator|)
operator|<<
literal|11
operator|)
operator|+
operator|(
name|pa_angle
index|[
name|idx
index|]
operator|&
literal|0x7ff
operator|)
expr_stmt|;
comment|/*          * HALDEBUG(          *     NULL, HAL_DEBUG_UNMASKABLE,"%d\t%d\t0x%x\n",           *     pa_in[idx], pa_angle[idx], pa_table[idx]);          */
block|}
comment|/*HALDEBUG(NULL, HAL_DEBUG_UNMASKABLE, "g_fxp = %d\n", g_fxp);*/
operator|*
name|g_fxp_ext
operator|=
name|g_fxp
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
end_function

begin_comment
comment|// Due to a hardware bug, when transmitting with just one chain the papd
end_comment

begin_comment
comment|// data for chain 0 is always used. So when using chain 2 or 4, the
end_comment

begin_comment
comment|// corresponding data must be copied into the chain 0 area.
end_comment

begin_function
name|void
name|ar9300_swizzle_paprd_entries
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|unsigned
name|int
name|txchain
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|u_int32_t
modifier|*
name|paprd_table_val
init|=
name|NULL
decl_stmt|;
name|u_int32_t
name|small_signal_gain
init|=
literal|0
decl_stmt|;
name|u_int32_t
name|reg
init|=
literal|0
decl_stmt|;
name|reg
operator|=
name|AR_PHY_PAPRD_MEM_TAB_B0
expr_stmt|;
switch|switch
condition|(
name|txchain
condition|)
block|{
case|case
literal|0x1
case|:
case|case
literal|0x3
case|:
case|case
literal|0x7
case|:
name|paprd_table_val
operator|=
operator|&
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|pa_table
index|[
literal|0
index|]
index|[
literal|0
index|]
expr_stmt|;
name|small_signal_gain
operator|=
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|small_signal_gain
index|[
literal|0
index|]
expr_stmt|;
break|break;
case|case
literal|0x2
case|:
name|paprd_table_val
operator|=
operator|&
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|pa_table
index|[
literal|1
index|]
index|[
literal|0
index|]
expr_stmt|;
name|small_signal_gain
operator|=
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|small_signal_gain
index|[
literal|1
index|]
expr_stmt|;
break|break;
case|case
literal|0x4
case|:
name|paprd_table_val
operator|=
operator|&
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|pa_table
index|[
literal|2
index|]
index|[
literal|0
index|]
expr_stmt|;
name|small_signal_gain
operator|=
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|small_signal_gain
index|[
literal|2
index|]
expr_stmt|;
break|break;
default|default:
comment|// Error out.
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"YAK! Bad chain mask %x\n"
argument_list|,
name|txchain
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|AR9300_PAPRD_TABLE_SZ
condition|;
name|i
operator|++
control|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|reg
argument_list|,
name|paprd_table_val
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_CALIBRATE
argument_list|,
literal|"%s[%d] reg %08x = 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|reg
argument_list|,
name|paprd_table_val
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|reg
operator|=
name|reg
operator|+
literal|4
expr_stmt|;
block|}
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PA_GAIN123_B0
argument_list|,
name|AR_PHY_PA_GAIN123_B0_PA_GAIN1_0
argument_list|,
name|small_signal_gain
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_CALIBRATE
argument_list|,
literal|"%s[%d] reg %08x small_signal_gain 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
operator|(
name|unsigned
operator|)
name|AR_PHY_PA_GAIN123_B0
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PA_GAIN123_B0
argument_list|)
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0_PAPRD_POWER_AT_AM2AM_CAL_0
argument_list|,
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|paprd_training_power
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_CALIBRATE
argument_list|,
literal|"%s[%d] reg %08x = 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
operator|(
name|unsigned
operator|)
name|AR_PHY_PAPRD_CTRL1_B0
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9300_populate_paprd_single_table
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|chan
parameter_list|,
name|int
name|chain_num
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|bad_read
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|AH_DEBUG
name|HAL_CHANNEL_INTERNAL
modifier|*
name|ichan
init|=
name|ath_hal_checkchannel
argument_list|(
name|ah
argument_list|,
name|chan
argument_list|)
decl_stmt|;
endif|#
directive|endif
name|u_int32_t
modifier|*
name|paprd_table_val
init|=
operator|&
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|pa_table
index|[
name|chain_num
index|]
index|[
literal|0
index|]
decl_stmt|;
name|u_int32_t
name|small_signal_gain
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|small_signal_gain
index|[
name|chain_num
index|]
decl_stmt|;
name|u_int32_t
name|reg
init|=
literal|0
decl_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_CALIBRATE
argument_list|,
literal|"%s[%d]: channel %d paprd_done %d write %d\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|ichan
operator|->
name|channel
argument_list|,
name|ichan
operator|->
name|paprd_done
argument_list|,
name|ichan
operator|->
name|paprd_table_write_done
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain_num
operator|==
literal|0
condition|)
block|{
name|reg
operator|=
name|AR_PHY_PAPRD_MEM_TAB_B0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|chain_num
operator|==
literal|1
condition|)
block|{
name|reg
operator|=
name|AR_PHY_PAPRD_MEM_TAB_B1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|chain_num
operator|==
literal|2
condition|)
block|{
name|reg
operator|=
name|AR_PHY_PAPRD_MEM_TAB_B2
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|AR9300_PAPRD_TABLE_SZ
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|HALASSERT
argument_list|(
name|chain_num
operator|==
literal|0x1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|reg
operator|==
name|AR_PHY_PAPRD_MEM_TAB_B1
operator|)
operator|||
operator|(
name|reg
operator|==
name|AR_PHY_PAPRD_MEM_TAB_B2
operator|)
condition|)
block|{
continue|continue;
block|}
block|}
comment|/*          * sprintf(          *     field_name, "%s%d[%d]%s\0", "BB_paprd_mem_tab_b",           *     chain_num, i, ".paprd_mem");          */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|reg
argument_list|,
name|paprd_table_val
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_CALIBRATE
argument_list|,
literal|"%s[%d] reg %08x = 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
name|reg
argument_list|,
name|paprd_table_val
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/*          * printf(          *     "%s[%d] reg %08x = 0x%08x\n",           *     __func__, __LINE__, reg, paprd_table_val[i]);          */
if|if
condition|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|reg
argument_list|)
operator|==
literal|0xdeadbeef
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_UNMASKABLE
argument_list|,
literal|"%s: Reg0x%x = 0xdeadbeef\n"
argument_list|,
name|__func__
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|bad_read
operator|++
expr_stmt|;
for|for
control|(
name|j
operator|=
name|AR_PHY_PAPRD_MEM_TAB_B0
init|;
name|j
operator|<
operator|(
name|AR_PHY_PAPRD_MEM_TAB_B0
operator|+
literal|0x10
operator|)
condition|;
name|j
operator|+=
literal|4
control|)
block|{
if|if
condition|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|j
argument_list|)
operator|==
literal|0xdeadbeef
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_UNMASKABLE
argument_list|,
literal|"%s: Reg0x%x = 0xdeadbeef\n"
argument_list|,
name|__func__
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|bad_read
operator|++
expr_stmt|;
block|}
block|}
for|for
control|(
name|j
operator|=
name|AR_PHY_PAPRD_MEM_TAB_B1
init|;
name|j
operator|<
operator|(
name|AR_PHY_PAPRD_MEM_TAB_B1
operator|+
literal|0x10
operator|)
condition|;
name|j
operator|+=
literal|4
control|)
block|{
if|if
condition|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|j
argument_list|)
operator|==
literal|0xdeadbeef
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_UNMASKABLE
argument_list|,
literal|"%s: Reg0x%x = 0xdeadbeef\n"
argument_list|,
name|__func__
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|bad_read
operator|++
expr_stmt|;
block|}
block|}
block|}
name|reg
operator|=
name|reg
operator|+
literal|4
expr_stmt|;
block|}
if|if
condition|(
name|bad_read
operator|>
literal|4
condition|)
block|{
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_UNMASKABLE
argument_list|,
literal|"%s: Get %d 0xdeadbeef. Mark PAPRD as broken.\n"
argument_list|,
name|__func__
argument_list|,
name|bad_read
argument_list|)
expr_stmt|;
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_paprd_broken
operator|=
name|AH_TRUE
expr_stmt|;
block|}
if|if
condition|(
name|chain_num
operator|==
literal|0
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PA_GAIN123_B0
argument_list|,
name|AR_PHY_PA_GAIN123_B0_PA_GAIN1_0
argument_list|,
name|small_signal_gain
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_CALIBRATE
argument_list|,
literal|"%s[%d] reg %08x small_signal_gain 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
operator|(
name|unsigned
operator|)
name|AR_PHY_PA_GAIN123_B0
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PA_GAIN123_B0
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|chain_num
operator|==
literal|1
condition|)
block|{
if|if
condition|(
operator|!
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
operator|&&
operator|!
name|AR_SREV_HORNET
argument_list|(
name|ah
argument_list|)
operator|&&
operator|!
name|AR_SREV_APHRODITE
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PA_GAIN123_B1
argument_list|,
name|AR_PHY_PA_GAIN123_B1_PA_GAIN1_1
argument_list|,
name|small_signal_gain
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_CALIBRATE
argument_list|,
literal|"%s[%d] reg %08x small_signal_gain 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
operator|(
name|unsigned
operator|)
name|AR_PHY_PA_GAIN123_B1
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PA_GAIN123_B1
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|chain_num
operator|==
literal|2
condition|)
block|{
if|if
condition|(
operator|!
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
operator|&&
operator|!
name|AR_SREV_HORNET
argument_list|(
name|ah
argument_list|)
operator|&&
operator|!
name|AR_SREV_APHRODITE
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PA_GAIN123_B2
argument_list|,
name|AR_PHY_PA_GAIN123_B2_PA_GAIN1_2
argument_list|,
name|small_signal_gain
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_CALIBRATE
argument_list|,
literal|"%s[%d] reg %08x small_signal_gain 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
operator|(
name|unsigned
operator|)
name|AR_PHY_PA_GAIN123_B2
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PA_GAIN123_B2
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* invalid channel number */
block|}
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0_PAPRD_POWER_AT_AM2AM_CAL_0
argument_list|,
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|paprd_training_power
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_CALIBRATE
argument_list|,
literal|"%s[%d] reg %08x = 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
operator|(
name|unsigned
operator|)
name|AR_PHY_PAPRD_CTRL1_B0
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
operator|&&
operator|!
name|AR_SREV_HORNET
argument_list|(
name|ah
argument_list|)
operator|&&
operator|!
name|AR_SREV_APHRODITE
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1_PAPRD_POWER_AT_AM2AM_CAL_1
argument_list|,
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|paprd_training_power
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_CALIBRATE
argument_list|,
literal|"%s[%d] reg %08x = 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
operator|(
name|unsigned
operator|)
name|AR_PHY_PAPRD_CTRL1_B1
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B1
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
operator|&&
operator|!
name|AR_SREV_JUPITER
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2_PAPRD_POWER_AT_AM2AM_CAL_2
argument_list|,
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|paprd_training_power
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_CALIBRATE
argument_list|,
literal|"%s[%d] reg %08x = 0x%08x\n"
argument_list|,
name|__func__
argument_list|,
name|__LINE__
argument_list|,
operator|(
name|unsigned
operator|)
name|AR_PHY_PAPRD_CTRL1_B2
argument_list|,
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_CTRL1_B2
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*ar9300_enable_paprd(ah, AH_TRUE);*/
block|}
end_function

begin_function
name|HAL_STATUS
name|ar9300_paprd_setup_gain_table
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|int
name|chain_num
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|,
name|desired_gain
decl_stmt|,
name|gain_index
decl_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_CALIBRATE
argument_list|,
literal|"Run papredistortion single table algorithm:: Training power = %d\n"
argument_list|,
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|paprd_training_power
operator|/
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_tx_chainmask
operator|&
operator|(
literal|1
operator|<<
name|chain_num
operator|)
condition|)
block|{
comment|/* this is an active chain */
name|desired_gain
operator|=
name|ar9300_get_desired_gain_for_chain
argument_list|(
name|ah
argument_list|,
name|chain_num
argument_list|,
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|paprd_training_power
argument_list|)
expr_stmt|;
comment|/* find out gain index */
name|gain_index
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|paprd_gain_table_index
index|[
name|i
index|]
operator|<
name|desired_gain
condition|)
block|{
name|gain_index
operator|=
name|gain_index
operator|+
literal|1
expr_stmt|;
block|}
else|else
block|{
break|break;
block|}
block|}
comment|/*printf("gain_index = %d\n", gain_index);*/
comment|/*ath_hal_printf(ah, "++++ gain_index = %d\n", gain_index);*/
name|ar9300_tx_force_gain
argument_list|(
name|ah
argument_list|,
name|gain_index
argument_list|)
expr_stmt|;
if|if
condition|(
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|HAL_OK
return|;
block|}
end_function

begin_function
specifier|static
name|HAL_BOOL
name|ar9300_paprd_retrain_pain
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|int
modifier|*
name|pa_in
parameter_list|)
block|{
name|int
name|count
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|;
name|int
name|capdiv_offset
init|=
literal|0
decl_stmt|,
name|quick_drop_offset
decl_stmt|;
name|int
name|capdiv2g
decl_stmt|,
name|quick_drop
decl_stmt|;
name|capdiv2g
operator|=
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TXRF3
argument_list|)
operator|>>
literal|1
operator|)
operator|&
literal|0xF
expr_stmt|;
if|if
condition|(
operator|!
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|quick_drop
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|quick_drop
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|quick_drop
operator|!=
literal|0
condition|)
block|{
name|quick_drop
operator|-=
literal|0x40
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|NUM_BIN
operator|+
literal|1
operator|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|pa_in
index|[
name|i
index|]
operator|==
literal|1400
condition|)
block|{
name|count
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|pa_in
index|[
literal|23
index|]
operator|<
literal|800
operator|)
operator|||
operator|(
name|pa_in
index|[
literal|23
index|]
operator|==
literal|1400
operator|)
condition|)
block|{
if|if
condition|(
name|pa_in
index|[
literal|23
index|]
operator|<
literal|800
condition|)
block|{
name|capdiv_offset
operator|=
call|(
name|int
call|)
argument_list|(
operator|(
literal|1000
operator|-
name|pa_in
index|[
literal|23
index|]
operator|+
literal|75
operator|)
operator|/
literal|150
argument_list|)
expr_stmt|;
name|capdiv2g
operator|=
name|capdiv2g
operator|+
name|capdiv_offset
expr_stmt|;
if|if
condition|(
name|capdiv2g
operator|>
literal|7
condition|)
block|{
name|capdiv2g
operator|=
literal|7
expr_stmt|;
if|if
condition|(
name|pa_in
index|[
literal|23
index|]
operator|<
literal|600
condition|)
block|{
name|quick_drop
operator|=
name|quick_drop
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|quick_drop
operator|>
literal|0
condition|)
block|{
name|quick_drop
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TXRF3
argument_list|,
name|AR_PHY_65NM_CH0_TXRF3_CAPDIV2G
argument_list|,
name|capdiv2g
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP
argument_list|,
name|quick_drop
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
comment|/* end of if (pa_in[23]< 800) */
elseif|else
if|if
condition|(
name|pa_in
index|[
literal|23
index|]
operator|==
literal|1400
condition|)
block|{
name|quick_drop_offset
operator|=
call|(
name|int
call|)
argument_list|(
name|count
operator|/
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|quick_drop_offset
operator|>
literal|2
condition|)
block|{
name|quick_drop_offset
operator|=
literal|2
expr_stmt|;
block|}
name|quick_drop
operator|=
name|quick_drop
operator|+
name|quick_drop_offset
expr_stmt|;
name|capdiv2g
operator|=
name|capdiv2g
operator|+
call|(
name|int
call|)
argument_list|(
name|quick_drop_offset
operator|/
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|capdiv2g
operator|>
literal|7
condition|)
block|{
name|capdiv2g
operator|=
literal|7
expr_stmt|;
block|}
if|if
condition|(
name|quick_drop
operator|>
literal|0
condition|)
block|{
name|quick_drop
operator|=
literal|0
expr_stmt|;
name|capdiv2g
operator|=
name|capdiv2g
operator|-
call|(
name|int
call|)
argument_list|(
name|quick_drop_offset
operator|/
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|capdiv2g
operator|<
literal|0
condition|)
block|{
name|capdiv2g
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TXRF3
argument_list|,
name|AR_PHY_65NM_CH0_TXRF3_CAPDIV2G
argument_list|,
name|capdiv2g
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP
argument_list|,
name|quick_drop
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
comment|/* sleep(1); */
block|}
comment|/* end of if (pa_in[23] == 1400)*/
block|}
comment|/* end of if ((pa_in[23]< 800) || (pa_in[23] == 1400)) */
block|}
elseif|else
if|if
condition|(
name|AR_SREV_HORNET
argument_list|(
name|ah
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|pa_in
index|[
literal|23
index|]
operator|<
literal|1000
operator|)
operator|||
operator|(
name|pa_in
index|[
literal|23
index|]
operator|==
literal|1400
operator|)
condition|)
block|{
if|if
condition|(
name|pa_in
index|[
literal|23
index|]
operator|<
literal|1000
condition|)
block|{
name|capdiv_offset
operator|=
operator|(
operator|(
literal|1000
operator|-
name|pa_in
index|[
literal|23
index|]
operator|)
operator|/
literal|100
operator|)
expr_stmt|;
name|capdiv2g
operator|=
name|capdiv2g
operator|+
name|capdiv_offset
expr_stmt|;
if|if
condition|(
name|capdiv_offset
operator|>
literal|3
condition|)
block|{
name|quick_drop_offset
operator|=
literal|1
expr_stmt|;
name|quick_drop
operator|=
name|quick_drop
operator|-
name|quick_drop_offset
expr_stmt|;
name|capdiv2g
operator|=
name|capdiv2g
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|capdiv2g
operator|>
literal|6
condition|)
block|{
name|capdiv2g
operator|=
literal|6
expr_stmt|;
block|}
if|if
condition|(
name|quick_drop
operator|<
operator|-
literal|4
condition|)
block|{
name|quick_drop
operator|=
operator|-
literal|4
expr_stmt|;
block|}
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TXRF3
argument_list|,
name|AR_PHY_65NM_CH0_TXRF3_CAPDIV2G
argument_list|,
name|capdiv2g
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP
argument_list|,
name|quick_drop
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
else|else
block|{
name|capdiv2g
operator|=
name|capdiv2g
operator|+
name|capdiv_offset
expr_stmt|;
if|if
condition|(
name|capdiv2g
operator|>
literal|6
condition|)
block|{
name|capdiv2g
operator|=
literal|6
expr_stmt|;
block|}
if|if
condition|(
name|quick_drop
operator|<
operator|-
literal|4
condition|)
block|{
name|quick_drop
operator|=
operator|-
literal|4
expr_stmt|;
block|}
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TXRF3
argument_list|,
name|AR_PHY_65NM_CH0_TXRF3_CAPDIV2G
argument_list|,
name|capdiv2g
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP
argument_list|,
name|quick_drop
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
block|}
comment|/* end of if (PA_in[23]< 1000) */
elseif|else
if|if
condition|(
name|pa_in
index|[
literal|23
index|]
operator|==
literal|1400
condition|)
block|{
if|if
condition|(
name|count
operator|>
literal|3
condition|)
block|{
name|quick_drop_offset
operator|=
literal|1
expr_stmt|;
name|quick_drop
operator|=
name|quick_drop
operator|+
name|quick_drop_offset
expr_stmt|;
name|capdiv2g
operator|=
name|capdiv2g
operator|-
operator|(
name|count
operator|/
literal|4
operator|)
expr_stmt|;
if|if
condition|(
name|capdiv2g
operator|<
literal|0
condition|)
block|{
name|capdiv2g
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|quick_drop
operator|>
operator|-
literal|2
condition|)
block|{
name|quick_drop
operator|=
operator|-
literal|2
expr_stmt|;
block|}
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TXRF3
argument_list|,
name|AR_PHY_65NM_CH0_TXRF3_CAPDIV2G
argument_list|,
name|capdiv2g
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP
argument_list|,
name|quick_drop
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
else|else
block|{
name|capdiv2g
operator|=
name|capdiv2g
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|capdiv2g
operator|<
literal|0
condition|)
block|{
name|capdiv2g
operator|=
literal|0
expr_stmt|;
block|}
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_65NM_CH0_TXRF3
argument_list|,
name|AR_PHY_65NM_CH0_TXRF3_CAPDIV2G
argument_list|,
name|capdiv2g
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3
argument_list|,
name|AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP
argument_list|,
name|quick_drop
argument_list|)
expr_stmt|;
return|return
name|AH_TRUE
return|;
block|}
block|}
comment|/* end of if (PA_in[23] == 1400)*/
block|}
comment|/* end of if ((PA_in[23]< 1000) || (PA_in[23] == 1400)) */
block|}
return|return
name|AH_FALSE
return|;
block|}
end_function

begin_function
name|HAL_STATUS
name|ar9300_paprd_create_curve
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|chan
parameter_list|,
name|int
name|chain_num
parameter_list|)
block|{
name|int
name|status
init|=
literal|0
decl_stmt|;
name|u_int32_t
modifier|*
name|pa_table
decl_stmt|,
name|small_signal_gain
decl_stmt|;
name|int
name|pa_in
index|[
name|NUM_BIN
operator|+
literal|1
index|]
decl_stmt|;
if|if
condition|(
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_tx_chainmask
operator|&
operator|(
literal|1
operator|<<
name|chain_num
operator|)
condition|)
block|{
name|pa_table
operator|=
operator|&
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|pa_table
index|[
name|chain_num
index|]
index|[
literal|0
index|]
expr_stmt|;
comment|/* Compute PA table and gain index */
name|status
operator|=
name|ar9300_create_pa_curve
argument_list|(
name|ah
argument_list|,
operator|&
name|pa_table
index|[
literal|0
index|]
argument_list|,
operator|&
name|small_signal_gain
argument_list|,
operator|&
name|pa_in
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|OS_DELAY
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|!=
literal|0
condition|)
block|{
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"ERROR:: paprd failed with error code = %d\n"
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|small_signal_gain
index|[
name|chain_num
index|]
operator|=
name|small_signal_gain
expr_stmt|;
if|if
condition|(
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_HORNET
argument_list|(
name|ah
argument_list|)
condition|)
block|{
if|if
condition|(
name|ar9300_paprd_retrain_pain
argument_list|(
name|ah
argument_list|,
name|pa_in
argument_list|)
condition|)
block|{
comment|/* need re-train PAPRD */
return|return
name|HAL_EINPROGRESS
return|;
block|}
block|}
block|}
return|return
name|HAL_OK
return|;
block|}
end_function

begin_function
name|int
name|ar9300_paprd_init_table
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|struct
name|ieee80211_channel
modifier|*
name|chan
parameter_list|)
block|{
name|HAL_CHANNEL_INTERNAL
modifier|*
name|ichan
init|=
name|ath_hal_checkchannel
argument_list|(
name|ah
argument_list|,
name|chan
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
operator|&&
name|IS_CHAN_5GHZ
argument_list|(
name|ichan
argument_list|)
operator|)
operator|||
name|ar9300_paprd_setup_single_table
argument_list|(
name|ah
argument_list|,
name|chan
argument_list|)
condition|)
block|{
goto|goto
name|FAIL
goto|;
block|}
name|OS_MEMZERO
argument_list|(
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|paprd_gain_table_entries
argument_list|,
sizeof|sizeof
argument_list|(
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|paprd_gain_table_entries
argument_list|)
argument_list|)
expr_stmt|;
name|OS_MEMZERO
argument_list|(
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|paprd_gain_table_index
argument_list|,
sizeof|sizeof
argument_list|(
name|AH9300
argument_list|(
name|ah
argument_list|)
operator|->
name|paprd_gain_table_index
argument_list|)
argument_list|)
expr_stmt|;
name|ar9300_gain_table_entries
argument_list|(
name|ah
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|FAIL
label|:
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|ar9300_paprd_is_done
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|int
name|temp
decl_stmt|,
name|agc2_pwr
decl_stmt|;
comment|/*field_read("BB_paprd_trainer_stat1.paprd_train_done",&temp);*/
if|if
condition|(
operator|!
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE
argument_list|)
expr_stmt|;
if|if
condition|(
name|temp
operator|==
literal|0x1
condition|)
block|{
name|agc2_pwr
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_AGC2_PWR
argument_list|)
expr_stmt|;
name|HALDEBUG
argument_list|(
name|ah
argument_list|,
name|HAL_DEBUG_CALIBRATE
argument_list|,
literal|"%s AGC2_PWR=0x%2x Training done=0x%2x\n"
argument_list|,
name|__func__
argument_list|,
name|agc2_pwr
argument_list|,
name|temp
argument_list|)
expr_stmt|;
comment|/* Retrain if agc2_pwr is not in ideal range */
if|if
condition|(
name|agc2_pwr
operator|<=
name|AH_PAPRD_IDEAL_AGC2_PWR_RANGE
condition|)
block|{
name|temp
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|temp
operator|=
name|OS_REG_READ_FIELD_ALT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_POSEIDON
argument_list|,
name|AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|temp
condition|)
block|{
comment|/*ath_hal_printf(ah, "%s[%d] PAPRD TEMp Error\n", __func__, __LINE__);*/
block|}
return|return
name|temp
return|;
block|}
end_function

begin_comment
comment|/*  * ar9300_paprd_dec_tx_pwr  *  * This function do decrease tx power if Paprd is off or train failed.  */
end_comment

begin_function
name|void
name|ar9300_paprd_dec_tx_pwr
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|u_int32_t
name|pwr_temp
decl_stmt|,
name|pwr_reg
decl_stmt|;
name|int
name|i
decl_stmt|,
name|loop_cnt
decl_stmt|;
name|struct
name|ar9300_paprd_pwr_adjust
modifier|*
name|p_item
decl_stmt|;
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
if|if
condition|(
name|AR_SREV_POSEIDON
argument_list|(
name|ah
argument_list|)
condition|)
block|{
name|loop_cnt
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|ar9300_paprd_pwr_adj_array
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|ar9300_paprd_pwr_adjust
argument_list|)
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|loop_cnt
condition|;
name|i
operator|++
control|)
block|{
name|p_item
operator|=
operator|&
name|ar9300_paprd_pwr_adj_array
index|[
name|i
index|]
expr_stmt|;
name|pwr_reg
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|p_item
operator|->
name|reg_addr
argument_list|)
expr_stmt|;
name|pwr_temp
operator|=
name|ahp
operator|->
name|ah_default_tx_power
index|[
name|p_item
operator|->
name|target_rate
index|]
expr_stmt|;
name|pwr_temp
operator|-=
operator|(
name|p_item
operator|->
name|sub_db
operator|*
literal|2
operator|)
expr_stmt|;
name|pwr_temp
operator|=
name|pwr_temp
operator|<<
name|p_item
operator|->
name|reg_mask_offset
expr_stmt|;
name|pwr_temp
operator||=
operator|(
name|pwr_reg
operator|&
operator|~
operator|(
name|p_item
operator|->
name|reg_mask
operator|<<
name|p_item
operator|->
name|reg_mask_offset
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|pwr_temp
operator|!=
name|pwr_reg
condition|)
block|{
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|p_item
operator|->
name|reg_addr
argument_list|,
name|pwr_temp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return;
block|}
end_function

begin_function
name|int
name|ar9300_paprd_thermal_send
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
if|if
condition|(
name|AR_SREV_HORNET
argument_list|(
name|ah
argument_list|)
condition|)
block|{
return|return
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_TFCNT
argument_list|)
return|;
block|}
else|else
block|{
return|return
literal|1
return|;
block|}
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
unit|void ar9300_paprd_test_prints(struct ath_hal *ah) {     u_int32_t i, reg = 0;      HALDEBUG(NULL, HAL_DEBUG_CALIBRATE, "=====ar9300_paprd_test_prints=======\n");
comment|/*printf("=====ar9300_paprd_test_prints=======\n");*/
end_comment

begin_comment
unit|HALDEBUG(NULL, HAL_DEBUG_CALIBRATE, "BB_paprd_ctrl0_b0 = 0x%08x\n",         OS_REG_READ(ah, AR_PHY_PAPRD_CTRL0_B0));
comment|/*      * printf(      *     "BB_paprd_ctrl0_b0 = 0x%08x\n",       *     OS_REG_READ(ah, AR_PHY_PAPRD_CTRL0_B0));      */
end_comment

begin_comment
unit|if (!AR_SREV_POSEIDON(ah)&& !AR_SREV_HORNET(ah)) {         HALDEBUG(NULL, HAL_DEBUG_CALIBRATE, "BB_paprd_ctrl0_b1 = 0x%08x\n",             OS_REG_READ(ah, AR_PHY_PAPRD_CTRL0_B1));
comment|/*          * printf(          *     "BB_paprd_ctrl0_b1 = 0x%08x\n",           *     OS_REG_READ(ah, AR_PHY_PAPRD_CTRL0_B1));          */
end_comment

begin_comment
unit|HALDEBUG(NULL, HAL_DEBUG_CALIBRATE, "BB_paprd_ctrl0_b2 = 0x%08x\n",             OS_REG_READ(ah, AR_PHY_PAPRD_CTRL0_B2));
comment|/*          * printf(          *     "BB_paprd_ctrl0_b2 = 0x%08x\n",           *     OS_REG_READ(ah, AR_PHY_PAPRD_CTRL0_B2));          */
end_comment

begin_comment
unit|}      reg = AR_PHY_PAPRD_MEM_TAB_B0;     HALDEBUG(NULL, HAL_DEBUG_CALIBRATE,         "%s[%d] reg %08lx small_signal_gain ch0 0x%08x\n", __func__, __LINE__,         AR_PHY_PA_GAIN123_B0, OS_REG_READ(ah, AR_PHY_PA_GAIN123_B0));
comment|/*      * printf(      *     "%s[%d] reg %08lx small_signal_gain ch0 0x%08x\n",      *     __func__,  __LINE__, AR_PHY_PA_GAIN123_B0,       *     OS_REG_READ(ah, AR_PHY_PA_GAIN123_B0));      */
end_comment

begin_comment
unit|for (i = 0; i< 24; i++) {         HALDEBUG(NULL, HAL_DEBUG_CALIBRATE, "%s[%d] reg %08x = 0x%08x\n",             __func__, __LINE__, reg, OS_REG_READ(ah, reg));
comment|/*          * printf(          *     "%s[%d] reg %08x = 0x%08x\n", __func__, __LINE__,          *     reg, OS_REG_READ(ah, reg));          */
end_comment

begin_comment
unit|reg = reg + 4;     }      ar9300_paprd_debug_print(ah);     HALDEBUG(NULL, HAL_DEBUG_CALIBRATE,         "=====ar9300_paprd_test_prints end=======\n");
comment|/*printf("=====ar9300_paprd_test_prints end=======\n");*/
end_comment

begin_endif
unit|if (!AR_SREV_POSEIDON(ah)) {         reg = AR_PHY_PAPRD_MEM_TAB_B1;         printf("%s[%d] reg %08lx small_signal_gain ch1 0x%08x\n",             __func__, __LINE__,             AR_PHY_PA_GAIN123_B1, OS_REG_READ(ah, AR_PHY_PA_GAIN123_B1));         for (i = 0; i< 24; i++) {             OS_REG_WRITE(ah, reg, paprd_table_val[i]);             HALDEBUG(NULL, HAL_DEBUG_CALIBRATE, "%s[%d] reg %08x = 0x%08x\n",                 __func__, __LINE__, reg, OS_REG_READ(ah, reg));             printf("%s[%d] reg %08x = 0x%08x\n", __func__, __LINE__, reg,                 OS_REG_READ(ah, reg));             reg = reg + 4;         }              reg = AR_PHY_PAPRD_MEM_TAB_B2;         printf("%s[%d] reg %08lx small_signal_gain ch2 0x%08x\n",             __func__, __LINE__,             AR_PHY_PA_GAIN123_B2, OS_REG_READ(ah, AR_PHY_PA_GAIN123_B2));     } }
endif|#
directive|endif
end_endif

begin_else
else|#
directive|else
end_else

begin_function
name|int
name|ar9300_paprd_init_table
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_CHANNEL
modifier|*
name|chan
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
name|HAL_STATUS
name|ar9300_paprd_setup_gain_table
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|int
name|chain_num
parameter_list|)
block|{
return|return
name|HAL_OK
return|;
block|}
end_function

begin_function
name|HAL_STATUS
name|ar9300_paprd_create_curve
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_CHANNEL
modifier|*
name|chan
parameter_list|,
name|int
name|chain_num
parameter_list|)
block|{
return|return
name|HAL_OK
return|;
block|}
end_function

begin_function
name|int
name|ar9300_paprd_is_done
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|ar9300_enable_paprd
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_BOOL
name|enable_flag
parameter_list|,
name|HAL_CHANNEL
modifier|*
name|chan
parameter_list|)
block|{
return|return;
block|}
end_function

begin_function
name|void
name|ar9300_populate_paprd_single_table
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_CHANNEL
modifier|*
name|chan
parameter_list|,
name|int
name|chain_num
parameter_list|)
block|{
return|return;
block|}
end_function

begin_function
name|void
name|ar9300_paprd_dec_tx_pwr
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
return|return;
block|}
end_function

begin_function
name|int
name|ar9300_paprd_thermal_send
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
return|return
literal|1
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ATH_SUPPORT_PAPRD */
end_comment

end_unit


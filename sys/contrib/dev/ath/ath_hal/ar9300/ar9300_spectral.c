begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2013 Qualcomm Atheros, Inc.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR  * OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|"opt_ah.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|AH_SUPPORT_AR9300
end_ifdef

begin_include
include|#
directive|include
file|"ah.h"
end_include

begin_include
include|#
directive|include
file|"ah_desc.h"
end_include

begin_include
include|#
directive|include
file|"ah_internal.h"
end_include

begin_include
include|#
directive|include
file|"ar9300/ar9300phy.h"
end_include

begin_include
include|#
directive|include
file|"ar9300/ar9300.h"
end_include

begin_include
include|#
directive|include
file|"ar9300/ar9300reg.h"
end_include

begin_include
include|#
directive|include
file|"ar9300/ar9300desc.h"
end_include

begin_if
if|#
directive|if
name|ATH_SUPPORT_SPECTRAL
end_if

begin_comment
comment|/*  * Default 9300 spectral scan parameters  */
end_comment

begin_define
define|#
directive|define
name|AR9300_SPECTRAL_SCAN_ENA
value|0
end_define

begin_define
define|#
directive|define
name|AR9300_SPECTRAL_SCAN_ACTIVE
value|0
end_define

begin_define
define|#
directive|define
name|AR9300_SPECTRAL_SCAN_FFT_PERIOD
value|8
end_define

begin_define
define|#
directive|define
name|AR9300_SPECTRAL_SCAN_PERIOD
value|1
end_define

begin_define
define|#
directive|define
name|AR9300_SPECTRAL_SCAN_COUNT
value|16
end_define

begin_comment
comment|/* used to be 128 */
end_comment

begin_define
define|#
directive|define
name|AR9300_SPECTRAL_SCAN_SHORT_REPEAT
value|1
end_define

begin_comment
comment|/* constants */
end_comment

begin_define
define|#
directive|define
name|MAX_RADAR_DC_PWR_THRESH
value|127
end_define

begin_define
define|#
directive|define
name|MAX_RADAR_RSSI_THRESH
value|0x3f
end_define

begin_define
define|#
directive|define
name|MAX_RADAR_HEIGHT
value|0x3f
end_define

begin_define
define|#
directive|define
name|MAX_CCA_THRESH
value|127
end_define

begin_define
define|#
directive|define
name|ENABLE_ALL_PHYERR
value|0xffffffff
end_define

begin_function_decl
name|void
name|ar9300_disable_cck
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ar9300_disable_radar
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ar9300_disable_restart
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ar9300_set_radar_dc_thresh
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ar9300_disable_weak_signal
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ar9300_disable_strong_signal
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ar9300_prep_spectral_scan
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ar9300_disable_dc_offset
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ar9300_enable_cck_detect
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|ar9300_disable_cck
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|u_int32_t
name|val
decl_stmt|;
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_MODE
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
operator|(
name|AR_PHY_MODE_DYN_CCK_DISABLE
operator|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_MODE
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9300_disable_radar
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|u_int32_t
name|val
decl_stmt|;
comment|/* Enable radar FFT */
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_RADAR_0
argument_list|)
expr_stmt|;
name|val
operator||=
name|AR_PHY_RADAR_0_FFT_ENA
expr_stmt|;
comment|/* set radar detect thresholds to max to effectively disable radar */
name|val
operator|&=
operator|~
name|AR_PHY_RADAR_0_RRSSI
expr_stmt|;
name|val
operator||=
name|SM
argument_list|(
name|MAX_RADAR_RSSI_THRESH
argument_list|,
name|AR_PHY_RADAR_0_RRSSI
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|AR_PHY_RADAR_0_HEIGHT
expr_stmt|;
name|val
operator||=
name|SM
argument_list|(
name|MAX_RADAR_HEIGHT
argument_list|,
name|AR_PHY_RADAR_0_HEIGHT
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
operator|(
name|AR_PHY_RADAR_0_ENA
operator|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_RADAR_0
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* disable extension radar detect */
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_RADAR_EXT
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_RADAR_EXT
argument_list|,
name|val
operator|&
operator|~
name|AR_PHY_RADAR_EXT_ENA
argument_list|)
expr_stmt|;
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_RX_FILTER
argument_list|)
expr_stmt|;
name|val
operator||=
operator|(
literal|1
operator|<<
literal|13
operator|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_RX_FILTER
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9300_disable_restart
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|u_int32_t
name|val
decl_stmt|;
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_RESTART
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|AR_PHY_RESTART_ENA
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_RESTART
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_RESTART
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9300_set_radar_dc_thresh
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|u_int32_t
name|val
decl_stmt|;
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_RADAR_EXT
argument_list|)
expr_stmt|;
name|val
operator|&=
operator|~
name|AR_PHY_RADAR_DC_PWR_THRESH
expr_stmt|;
name|val
operator||=
name|SM
argument_list|(
name|MAX_RADAR_DC_PWR_THRESH
argument_list|,
name|AR_PHY_RADAR_DC_PWR_THRESH
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_RADAR_EXT
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_RADAR_EXT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9300_disable_weak_signal
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
comment|/* set firpwr to max (signed) */
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_FIND_SIG
argument_list|,
name|AR_PHY_FIND_SIG_FIRPWR
argument_list|,
literal|0x7f
argument_list|)
expr_stmt|;
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_FIND_SIG
argument_list|,
name|AR_PHY_FIND_SIG_FIRPWR_SIGN_BIT
argument_list|)
expr_stmt|;
comment|/* set firstep to max */
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_FIND_SIG
argument_list|,
name|AR_PHY_FIND_SIG_FIRSTEP
argument_list|,
literal|0x3f
argument_list|)
expr_stmt|;
comment|/* set relpwr to max (signed) */
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_FIND_SIG
argument_list|,
name|AR_PHY_FIND_SIG_RELPWR
argument_list|,
literal|0x1f
argument_list|)
expr_stmt|;
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_FIND_SIG
argument_list|,
name|AR_PHY_FIND_SIG_RELPWR_SIGN_BIT
argument_list|)
expr_stmt|;
comment|/* set relstep to max (signed) */
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_FIND_SIG
argument_list|,
name|AR_PHY_FIND_SIG_RELSTEP
argument_list|,
literal|0x1f
argument_list|)
expr_stmt|;
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_FIND_SIG
argument_list|,
name|AR_PHY_FIND_SIG_RELSTEP_SIGN_BIT
argument_list|)
expr_stmt|;
comment|/* set firpwr_low to max (signed) */
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_FIND_SIG_LOW
argument_list|,
name|AR_PHY_FIND_SIG_LOW_FIRPWR
argument_list|,
literal|0x7f
argument_list|)
expr_stmt|;
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_FIND_SIG_LOW
argument_list|,
name|AR_PHY_FIND_SIG_LOW_FIRPWR_SIGN_BIT
argument_list|)
expr_stmt|;
comment|/* set firstep_low to max */
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_FIND_SIG_LOW
argument_list|,
name|AR_PHY_FIND_SIG_LOW_FIRSTEP_LOW
argument_list|,
literal|0x3f
argument_list|)
expr_stmt|;
comment|/* set relstep_low to max (signed) */
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_FIND_SIG_LOW
argument_list|,
name|AR_PHY_FIND_SIG_LOW_RELSTEP
argument_list|,
literal|0x1f
argument_list|)
expr_stmt|;
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_PHY_FIND_SIG_LOW
argument_list|,
name|AR_PHY_FIND_SIG_LOW_RELSTEP_SIGN_BIT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9300_disable_strong_signal
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|u_int32_t
name|val
decl_stmt|;
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TIMING5
argument_list|)
expr_stmt|;
name|val
operator||=
name|AR_PHY_TIMING5_RSSI_THR1A_ENA
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TIMING5
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TIMING5
argument_list|,
name|AR_PHY_TIMING5_RSSI_THR1A
argument_list|,
literal|0x7f
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9300_set_cca_threshold
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int8_t
name|thresh62
parameter_list|)
block|{
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CCA_0
argument_list|,
name|AR_PHY_CCA_THRESH62
argument_list|,
name|thresh62
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_EXT_CCA0
argument_list|,
name|AR_PHY_EXT_CCA0_THRESH62
argument_list|,
name|thresh62
argument_list|)
expr_stmt|;
comment|/*     OS_REG_RMW_FIELD(ah,         AR_PHY_EXTCHN_PWRTHR1, AR_PHY_EXT_CCA0_THRESH62, thresh62);      */
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_EXT_CCA
argument_list|,
name|AR_PHY_EXT_CCA_THRESH62
argument_list|,
name|thresh62
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ar9300_classify_strong_bins
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_RADAR_1
argument_list|,
name|AR_PHY_RADAR_1_CF_BIN_THRESH
argument_list|,
literal|0x1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9300_disable_dc_offset
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TIMING2
argument_list|,
name|AR_PHY_TIMING2_DC_OFFSET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9300_enable_cck_detect
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_MODE
argument_list|,
name|AR_PHY_MODE_DISABLE_CCK
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_MODE
argument_list|,
name|AR_PHY_MODE_DYNAMIC
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9300_prep_spectral_scan
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|ar9300_disable_radar
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|ar9300_classify_strong_bins
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|ar9300_disable_dc_offset
argument_list|(
name|ah
argument_list|)
expr_stmt|;
if|if
condition|(
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_curchan
operator|&&
name|IS_5GHZ_FAST_CLOCK_EN
argument_list|(
name|ah
argument_list|,
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_curchan
argument_list|)
condition|)
block|{
comment|/* fast clock */
name|ar9300_enable_cck_detect
argument_list|(
name|ah
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DEMO_MODE
name|ar9300_disable_strong_signal
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|ar9300_disable_weak_signal
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|ar9300_set_radar_dc_thresh
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|ar9300_set_cca_threshold
argument_list|(
name|ah
argument_list|,
name|MAX_CCA_THRESH
argument_list|)
expr_stmt|;
comment|/*ar9300_disable_restart(ah);*/
endif|#
directive|endif
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_ERR
argument_list|,
name|HAL_PHYERR_SPECTRAL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|//#define TEST_NOISE_PWR_WITHOUT_EEPROM 1
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|TEST_NOISE_PWR_WITHOUT_EEPROM
end_ifdef

begin_struct
struct|struct
name|nf_cal
block|{
name|int
name|cal
decl_stmt|;
name|int
name|pwr
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|nf_cal_table_t
block|{
name|int
name|freq
decl_stmt|;
name|struct
name|nf_cal
name|chain
index|[
name|AH_MAX_CHAINS
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|nf_cal_table_t
name|nf_cal_table
index|[]
init|=
block|{
comment|/* ch 1  */
block|{
literal|2412
block|,
block|{
block|{
name|N2DBM
argument_list|(
operator|-
literal|101
argument_list|,
literal|00
argument_list|)
block|,
name|N2DBM
argument_list|(
argument|-
literal|94
argument_list|,
literal|25
argument_list|)
block|}
block|,
block|{
name|N2DBM
argument_list|(
operator|-
literal|107
argument_list|,
literal|75
argument_list|)
block|,
name|N2DBM
argument_list|(
argument|-
literal|99
argument_list|,
literal|75
argument_list|)
block|}
block|,                    }
block|}
block|,
comment|/* ch 6  */
block|{
literal|2437
block|,
block|{
block|{
name|N2DBM
argument_list|(
operator|-
literal|102
argument_list|,
literal|25
argument_list|)
block|,
name|N2DBM
argument_list|(
argument|-
literal|94
argument_list|,
literal|25
argument_list|)
block|}
block|,
block|{
name|N2DBM
argument_list|(
operator|-
literal|106
argument_list|,
literal|00
argument_list|)
block|,
name|N2DBM
argument_list|(
argument|-
literal|97
argument_list|,
literal|25
argument_list|)
block|}
block|,                    }
block|}
block|,
comment|/* ch 11 */
block|{
literal|2462
block|,
block|{
block|{
name|N2DBM
argument_list|(
operator|-
literal|101
argument_list|,
literal|50
argument_list|)
block|,
name|N2DBM
argument_list|(
argument|-
literal|95
argument_list|,
literal|00
argument_list|)
block|}
block|,
block|{
name|N2DBM
argument_list|(
operator|-
literal|105
argument_list|,
literal|50
argument_list|)
block|,
name|N2DBM
argument_list|(
argument|-
literal|98
argument_list|,
literal|00
argument_list|)
block|}
block|,                    }
block|}
block|,
comment|/* ch 36 */
block|{
literal|5180
block|,
block|{
block|{
name|N2DBM
argument_list|(
operator|-
literal|114
argument_list|,
literal|25
argument_list|)
block|,
name|N2DBM
argument_list|(
argument|-
literal|95
argument_list|,
literal|00
argument_list|)
block|}
block|,
block|{
name|N2DBM
argument_list|(
operator|-
literal|114
argument_list|,
literal|75
argument_list|)
block|,
name|N2DBM
argument_list|(
argument|-
literal|94
argument_list|,
literal|00
argument_list|)
block|}
block|,                    }
block|}
block|,
comment|/* ch 44 */
block|{
literal|5220
block|,
block|{
block|{
name|N2DBM
argument_list|(
operator|-
literal|113
argument_list|,
literal|00
argument_list|)
block|,
name|N2DBM
argument_list|(
argument|-
literal|95
argument_list|,
literal|00
argument_list|)
block|}
block|,
block|{
name|N2DBM
argument_list|(
operator|-
literal|115
argument_list|,
literal|00
argument_list|)
block|,
name|N2DBM
argument_list|(
argument|-
literal|94
argument_list|,
literal|50
argument_list|)
block|}
block|,                    }
block|}
block|,
comment|/* ch 64 */
block|{
literal|5320
block|,
block|{
block|{
name|N2DBM
argument_list|(
operator|-
literal|113
argument_list|,
literal|00
argument_list|)
block|,
name|N2DBM
argument_list|(
argument|-
literal|95
argument_list|,
literal|00
argument_list|)
block|}
block|,
comment|// not cal'ed
block|{
name|N2DBM
argument_list|(
operator|-
literal|115
argument_list|,
literal|00
argument_list|)
block|,
name|N2DBM
argument_list|(
argument|-
literal|94
argument_list|,
literal|50
argument_list|)
block|}
block|,                    }
block|}
block|,
comment|/* ch 100*/
block|{
literal|5500
block|,
block|{
block|{
name|N2DBM
argument_list|(
operator|-
literal|111
argument_list|,
literal|50
argument_list|)
block|,
name|N2DBM
argument_list|(
argument|-
literal|93
argument_list|,
literal|75
argument_list|)
block|}
block|,
block|{
name|N2DBM
argument_list|(
operator|-
literal|112
argument_list|,
literal|00
argument_list|)
block|,
name|N2DBM
argument_list|(
argument|-
literal|95
argument_list|,
literal|25
argument_list|)
block|}
block|,                    }
block|}
block|,
comment|/* ch 120*/
block|{
literal|5600
block|,
block|{
block|{
name|N2DBM
argument_list|(
operator|-
literal|111
argument_list|,
literal|50
argument_list|)
block|,
name|N2DBM
argument_list|(
argument|-
literal|93
argument_list|,
literal|75
argument_list|)
block|}
block|,
block|{
name|N2DBM
argument_list|(
operator|-
literal|112
argument_list|,
literal|00
argument_list|)
block|,
name|N2DBM
argument_list|(
argument|-
literal|95
argument_list|,
literal|25
argument_list|)
block|}
block|,                    }
block|}
block|,
comment|/* ch 140*/
block|{
literal|5700
block|,
block|{
block|{
name|N2DBM
argument_list|(
operator|-
literal|111
argument_list|,
literal|75
argument_list|)
block|,
name|N2DBM
argument_list|(
argument|-
literal|95
argument_list|,
literal|00
argument_list|)
block|}
block|,
block|{
name|N2DBM
argument_list|(
operator|-
literal|111
argument_list|,
literal|75
argument_list|)
block|,
name|N2DBM
argument_list|(
argument|-
literal|96
argument_list|,
literal|00
argument_list|)
block|}
block|,                    }
block|}
block|,
comment|/* ch 157*/
block|{
literal|5785
block|,
block|{
block|{
name|N2DBM
argument_list|(
operator|-
literal|112
argument_list|,
literal|50
argument_list|)
block|,
name|N2DBM
argument_list|(
argument|-
literal|94
argument_list|,
literal|75
argument_list|)
block|}
block|,
block|{
name|N2DBM
argument_list|(
operator|-
literal|111
argument_list|,
literal|75
argument_list|)
block|,
name|N2DBM
argument_list|(
argument|-
literal|95
argument_list|,
literal|50
argument_list|)
block|}
block|,                    }
block|}
block|,
comment|/* ch 165*/
block|{
literal|5825
block|,
block|{
block|{
name|N2DBM
argument_list|(
operator|-
literal|111
argument_list|,
literal|50
argument_list|)
block|,
name|N2DBM
argument_list|(
argument|-
literal|95
argument_list|,
literal|00
argument_list|)
block|}
block|,
block|{
name|N2DBM
argument_list|(
operator|-
literal|112
argument_list|,
literal|00
argument_list|)
block|,
name|N2DBM
argument_list|(
argument|-
literal|95
argument_list|,
literal|00
argument_list|)
block|}
block|,                    }
block|}
block|,
block|{
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|ar9300_noise_floor_get
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|int
name|freq_mhz
parameter_list|,
name|int
name|ch
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|nf_cal_table
index|[
name|i
index|]
operator|.
name|freq
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|nf_cal_table
index|[
name|i
operator|+
literal|0
index|]
operator|.
name|freq
operator|==
name|freq_mhz
operator|||
name|nf_cal_table
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|freq
operator|>
name|freq_mhz
operator|||
name|nf_cal_table
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|freq
operator|==
literal|0
condition|)
block|{
return|return
name|nf_cal_table
index|[
name|i
index|]
operator|.
name|chain
index|[
name|ch
index|]
operator|.
name|cal
return|;
block|}
block|}
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"%s: **Warning: device %d.%d: "
literal|"no nf cal offset found for freq %d chain %d\n"
argument_list|,
name|__func__
argument_list|,
operator|(
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|)
operator|->
name|ah_macVersion
argument_list|,
operator|(
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|)
operator|->
name|ah_macRev
argument_list|,
name|freq_mhz
argument_list|,
name|ch
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ar9300_noise_floor_power_get
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|int
name|freq_mhz
parameter_list|,
name|int
name|ch
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|nf_cal_table
index|[
name|i
index|]
operator|.
name|freq
operator|!=
literal|0
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|nf_cal_table
index|[
name|i
operator|+
literal|0
index|]
operator|.
name|freq
operator|==
name|freq_mhz
operator|||
name|nf_cal_table
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|freq
operator|>
name|freq_mhz
operator|||
name|nf_cal_table
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|freq
operator|==
literal|0
condition|)
block|{
return|return
name|nf_cal_table
index|[
name|i
index|]
operator|.
name|chain
index|[
name|ch
index|]
operator|.
name|pwr
return|;
block|}
block|}
name|ath_hal_printf
argument_list|(
name|ah
argument_list|,
literal|"%s: **Warning: device %d.%d: "
literal|"no nf pwr offset found for freq %d chain %d\n"
argument_list|,
name|__func__
argument_list|,
operator|(
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|)
operator|->
name|ah_macVersion
argument_list|,
operator|(
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|)
operator|->
name|ah_macRev
argument_list|,
name|freq_mhz
argument_list|,
name|ch
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|ar9300_noise_floor_get
parameter_list|(
name|_ah
parameter_list|,
name|_f
parameter_list|,
name|_ich
parameter_list|)
value|ar9300_noise_floor_cal_or_power_get((_ah), (_f), (_ich), 1
comment|/*use_cal*/
value|)
end_define

begin_define
define|#
directive|define
name|ar9300_noise_floor_power_get
parameter_list|(
name|_ah
parameter_list|,
name|_f
parameter_list|,
name|_ich
parameter_list|)
value|ar9300_noise_floor_cal_or_power_get((_ah), (_f), (_ich), 0
comment|/*use_cal*/
value|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|ar9300_configure_spectral_scan
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_SPECTRAL_PARAM
modifier|*
name|ss
parameter_list|)
block|{
name|u_int32_t
name|val
decl_stmt|,
name|i
decl_stmt|;
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HAL_BOOL
name|asleep
init|=
name|ahp
operator|->
name|ah_chip_full_sleep
decl_stmt|;
name|int16_t
name|nf_buf
index|[
name|NUM_NF_READINGS
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_SCORPION
argument_list|(
name|ah
argument_list|)
operator|)
operator|&&
name|asleep
condition|)
block|{
name|ar9300_set_power_mode
argument_list|(
name|ah
argument_list|,
name|HAL_PM_AWAKE
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
block|}
name|ar9300_prep_spectral_scan
argument_list|(
name|ah
argument_list|)
expr_stmt|;
if|if
condition|(
name|ss
operator|->
name|ss_spectral_pri
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_NF_READINGS
condition|;
name|i
operator|++
control|)
block|{
name|nf_buf
index|[
name|i
index|]
operator|=
name|NOISE_PWR_DBM_2_INT
argument_list|(
name|ss
operator|->
name|ss_nf_cal
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|ar9300_load_nf
argument_list|(
name|ah
argument_list|,
name|nf_buf
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEMO_MODE
name|ar9300_disable_strong_signal
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|ar9300_disable_weak_signal
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|ar9300_set_radar_dc_thresh
argument_list|(
name|ah
argument_list|)
expr_stmt|;
name|ar9300_set_cca_threshold
argument_list|(
name|ah
argument_list|,
name|MAX_CCA_THRESH
argument_list|)
expr_stmt|;
comment|/*ar9300_disable_restart(ah);*/
endif|#
directive|endif
block|}
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_SPECTRAL_SCAN
argument_list|)
expr_stmt|;
if|if
condition|(
name|ss
operator|->
name|ss_fft_period
operator|!=
name|HAL_SPECTRAL_PARAM_NOVAL
condition|)
block|{
name|val
operator|&=
operator|~
name|AR_PHY_SPECTRAL_SCAN_FFT_PERIOD
expr_stmt|;
name|val
operator||=
name|SM
argument_list|(
name|ss
operator|->
name|ss_fft_period
argument_list|,
name|AR_PHY_SPECTRAL_SCAN_FFT_PERIOD
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ss
operator|->
name|ss_period
operator|!=
name|HAL_SPECTRAL_PARAM_NOVAL
condition|)
block|{
name|val
operator|&=
operator|~
name|AR_PHY_SPECTRAL_SCAN_PERIOD
expr_stmt|;
name|val
operator||=
name|SM
argument_list|(
name|ss
operator|->
name|ss_period
argument_list|,
name|AR_PHY_SPECTRAL_SCAN_PERIOD
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ss
operator|->
name|ss_count
operator|!=
name|HAL_SPECTRAL_PARAM_NOVAL
condition|)
block|{
name|val
operator|&=
operator|~
name|AR_PHY_SPECTRAL_SCAN_COUNT
expr_stmt|;
comment|/* Remnants of a Merlin bug, 128 translates to 0 for          * continuous scanning. Instead we do piecemeal captures          * of 64 samples for Osprey.          */
if|if
condition|(
name|ss
operator|->
name|ss_count
operator|==
literal|128
condition|)
block|{
name|val
operator||=
name|SM
argument_list|(
literal|0
argument_list|,
name|AR_PHY_SPECTRAL_SCAN_COUNT
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|val
operator||=
name|SM
argument_list|(
name|ss
operator|->
name|ss_count
argument_list|,
name|AR_PHY_SPECTRAL_SCAN_COUNT
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ss
operator|->
name|ss_period
operator|!=
name|HAL_SPECTRAL_PARAM_NOVAL
condition|)
block|{
name|val
operator|&=
operator|~
name|AR_PHY_SPECTRAL_SCAN_PERIOD
expr_stmt|;
name|val
operator||=
name|SM
argument_list|(
name|ss
operator|->
name|ss_period
argument_list|,
name|AR_PHY_SPECTRAL_SCAN_PERIOD
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ss
operator|->
name|ss_short_report
operator|==
name|AH_TRUE
condition|)
block|{
name|val
operator||=
name|AR_PHY_SPECTRAL_SCAN_SHORT_REPEAT
expr_stmt|;
block|}
else|else
block|{
name|val
operator|&=
operator|~
name|AR_PHY_SPECTRAL_SCAN_SHORT_REPEAT
expr_stmt|;
block|}
comment|/* if noise power cal, force high priority */
if|if
condition|(
name|ss
operator|->
name|ss_spectral_pri
condition|)
block|{
name|val
operator||=
name|AR_PHY_SPECTRAL_SCAN_PRIORITY_HI
expr_stmt|;
block|}
else|else
block|{
name|val
operator|&=
operator|~
name|AR_PHY_SPECTRAL_SCAN_PRIORITY_HI
expr_stmt|;
block|}
comment|/* enable spectral scan */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_SPECTRAL_SCAN
argument_list|,
name|val
operator||
name|AR_PHY_SPECTRAL_SCAN_ENABLE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_SCORPION
argument_list|(
name|ah
argument_list|)
operator|)
operator|&&
name|asleep
condition|)
block|{
name|ar9300_set_power_mode
argument_list|(
name|ah
argument_list|,
name|HAL_PM_FULL_SLEEP
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Get the spectral parameter values and return them in the pe  * structure  */
end_comment

begin_function
name|void
name|ar9300_get_spectral_params
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_SPECTRAL_PARAM
modifier|*
name|ss
parameter_list|)
block|{
name|u_int32_t
name|val
decl_stmt|;
name|HAL_CHANNEL_INTERNAL
modifier|*
name|chan
init|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_curchan
decl_stmt|;
name|int
name|i
decl_stmt|,
name|ichain
decl_stmt|,
name|rx_chain_status
decl_stmt|;
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HAL_BOOL
name|asleep
init|=
name|ahp
operator|->
name|ah_chip_full_sleep
decl_stmt|;
if|if
condition|(
operator|(
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_SCORPION
argument_list|(
name|ah
argument_list|)
operator|)
operator|&&
name|asleep
condition|)
block|{
name|ar9300_set_power_mode
argument_list|(
name|ah
argument_list|,
name|HAL_PM_AWAKE
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
block|}
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_SPECTRAL_SCAN
argument_list|)
expr_stmt|;
name|ss
operator|->
name|ss_fft_period
operator|=
name|MS
argument_list|(
name|val
argument_list|,
name|AR_PHY_SPECTRAL_SCAN_FFT_PERIOD
argument_list|)
expr_stmt|;
name|ss
operator|->
name|ss_period
operator|=
name|MS
argument_list|(
name|val
argument_list|,
name|AR_PHY_SPECTRAL_SCAN_PERIOD
argument_list|)
expr_stmt|;
name|ss
operator|->
name|ss_count
operator|=
name|MS
argument_list|(
name|val
argument_list|,
name|AR_PHY_SPECTRAL_SCAN_COUNT
argument_list|)
expr_stmt|;
name|ss
operator|->
name|ss_short_report
operator|=
operator|(
name|val
operator|&
name|AR_PHY_SPECTRAL_SCAN_SHORT_REPEAT
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|ss
operator|->
name|ss_spectral_pri
operator|=
operator|(
name|val
operator|&
name|AR_PHY_SPECTRAL_SCAN_PRIORITY_HI
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|OS_MEMZERO
argument_list|(
name|ss
operator|->
name|ss_nf_cal
argument_list|,
sizeof|sizeof
argument_list|(
name|ss
operator|->
name|ss_nf_cal
argument_list|)
argument_list|)
expr_stmt|;
name|OS_MEMZERO
argument_list|(
name|ss
operator|->
name|ss_nf_pwr
argument_list|,
sizeof|sizeof
argument_list|(
name|ss
operator|->
name|ss_nf_cal
argument_list|)
argument_list|)
expr_stmt|;
name|ss
operator|->
name|ss_nf_temp_data
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|chan
operator|!=
name|NULL
condition|)
block|{
name|rx_chain_status
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_RX_CHAINMASK
argument_list|)
operator|&
literal|0x7
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_NF_READINGS
condition|;
name|i
operator|++
control|)
block|{
name|ichain
operator|=
name|i
operator|%
literal|3
expr_stmt|;
if|if
condition|(
name|rx_chain_status
operator|&
operator|(
literal|1
operator|<<
name|ichain
operator|)
condition|)
block|{
name|ss
operator|->
name|ss_nf_cal
index|[
name|i
index|]
operator|=
name|ar9300_noise_floor_get
argument_list|(
name|ah
argument_list|,
name|chan
operator|->
name|channel
argument_list|,
name|ichain
argument_list|)
expr_stmt|;
name|ss
operator|->
name|ss_nf_pwr
index|[
name|i
index|]
operator|=
name|ar9300_noise_floor_power_get
argument_list|(
name|ah
argument_list|,
name|chan
operator|->
name|channel
argument_list|,
name|ichain
argument_list|)
expr_stmt|;
block|}
block|}
name|ss
operator|->
name|ss_nf_temp_data
operator|=
name|OS_REG_READ_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_BB_THERM_ADC_4
argument_list|,
name|AR_PHY_BB_THERM_ADC_4_LATEST_THERM
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|HALDEBUG
argument_list|(
name|AH_NULL
argument_list|,
name|HAL_DEBUG_UNMASKABLE
argument_list|,
literal|"%s: chan is NULL - no ss nf values\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_SCORPION
argument_list|(
name|ah
argument_list|)
operator|)
operator|&&
name|asleep
condition|)
block|{
name|ar9300_set_power_mode
argument_list|(
name|ah
argument_list|,
name|HAL_PM_FULL_SLEEP
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|HAL_BOOL
name|ar9300_is_spectral_active
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|u_int32_t
name|val
decl_stmt|;
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_SPECTRAL_SCAN
argument_list|)
expr_stmt|;
return|return
name|MS
argument_list|(
name|val
argument_list|,
name|AR_PHY_SPECTRAL_SCAN_ACTIVE
argument_list|)
return|;
block|}
end_function

begin_function
name|HAL_BOOL
name|ar9300_is_spectral_enabled
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|u_int32_t
name|val
decl_stmt|;
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_SPECTRAL_SCAN
argument_list|)
expr_stmt|;
return|return
name|MS
argument_list|(
name|val
argument_list|,
name|AR_PHY_SPECTRAL_SCAN_ENABLE
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|ar9300_start_spectral_scan
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|u_int32_t
name|val
decl_stmt|;
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HAL_BOOL
name|asleep
init|=
name|ahp
operator|->
name|ah_chip_full_sleep
decl_stmt|;
if|if
condition|(
operator|(
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_SCORPION
argument_list|(
name|ah
argument_list|)
operator|)
operator|&&
name|asleep
condition|)
block|{
name|ar9300_set_power_mode
argument_list|(
name|ah
argument_list|,
name|HAL_PM_AWAKE
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
block|}
name|ar9300_prep_spectral_scan
argument_list|(
name|ah
argument_list|)
expr_stmt|;
comment|/* activate spectral scan */
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_SPECTRAL_SCAN
argument_list|)
expr_stmt|;
comment|/* This is a hardware bug fix, the enable and active bits should       * not be set/reset in the same write operation to the register       */
if|if
condition|(
operator|!
operator|(
name|val
operator|&
name|AR_PHY_SPECTRAL_SCAN_ENABLE
operator|)
condition|)
block|{
name|val
operator||=
name|AR_PHY_SPECTRAL_SCAN_ENABLE
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_SPECTRAL_SCAN
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_SPECTRAL_SCAN
argument_list|)
expr_stmt|;
block|}
name|val
operator||=
name|AR_PHY_SPECTRAL_SCAN_ACTIVE
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_SPECTRAL_SCAN
argument_list|,
name|val
argument_list|)
expr_stmt|;
comment|/* Reset the PHY_ERR_MASK */
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_ERR_MASK_REG
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_ERR_MASK_REG
argument_list|,
name|val
operator||
name|AR_PHY_ERR_RADAR
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_SCORPION
argument_list|(
name|ah
argument_list|)
operator|)
operator|&&
name|asleep
condition|)
block|{
name|ar9300_set_power_mode
argument_list|(
name|ah
argument_list|,
name|HAL_PM_FULL_SLEEP
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ar9300_stop_spectral_scan
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|u_int32_t
name|val
decl_stmt|;
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HAL_BOOL
name|asleep
init|=
name|ahp
operator|->
name|ah_chip_full_sleep
decl_stmt|;
if|if
condition|(
operator|(
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_SCORPION
argument_list|(
name|ah
argument_list|)
operator|)
operator|&&
name|asleep
condition|)
block|{
name|ar9300_set_power_mode
argument_list|(
name|ah
argument_list|,
name|HAL_PM_AWAKE
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
block|}
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_SPECTRAL_SCAN
argument_list|)
expr_stmt|;
comment|/* deactivate spectral scan */
comment|/* HW Bug fix -- Do not disable the spectral scan      * only turn off the active bit      */
comment|//val&= ~AR_PHY_SPECTRAL_SCAN_ENABLE;
name|val
operator|&=
operator|~
name|AR_PHY_SPECTRAL_SCAN_ACTIVE
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_SPECTRAL_SCAN
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_SPECTRAL_SCAN
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_RADAR_1
argument_list|,
name|AR_PHY_RADAR_1_CF_BIN_THRESH
argument_list|,
name|ahp
operator|->
name|ah_radar1
argument_list|)
expr_stmt|;
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_TIMING2
argument_list|,
name|AR_PHY_TIMING2_DC_OFFSET
argument_list|,
name|ahp
operator|->
name|ah_dc_offset
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_ERR
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_curchan
operator|&&
name|IS_5GHZ_FAST_CLOCK_EN
argument_list|(
name|ah
argument_list|,
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
operator|->
name|ah_curchan
argument_list|)
condition|)
block|{
comment|/* fast clock */
name|OS_REG_RMW_FIELD
argument_list|(
name|ah
argument_list|,
name|AR_PHY_MODE
argument_list|,
name|AR_PHY_MODE_DISABLE_CCK
argument_list|,
name|ahp
operator|->
name|ah_disable_cck
argument_list|)
expr_stmt|;
block|}
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_ERR
argument_list|)
expr_stmt|;
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_ERR_MASK_REG
argument_list|)
operator|&
operator|(
operator|~
name|AR_PHY_ERR_RADAR
operator|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|AR_PHY_ERR_MASK_REG
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_SCORPION
argument_list|(
name|ah
argument_list|)
operator|)
operator|&&
name|asleep
condition|)
block|{
name|ar9300_set_power_mode
argument_list|(
name|ah
argument_list|,
name|HAL_PM_FULL_SLEEP
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|u_int32_t
name|ar9300_get_spectral_config
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|u_int32_t
name|val
decl_stmt|;
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|HAL_BOOL
name|asleep
init|=
name|ahp
operator|->
name|ah_chip_full_sleep
decl_stmt|;
if|if
condition|(
operator|(
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_SCORPION
argument_list|(
name|ah
argument_list|)
operator|)
operator|&&
name|asleep
condition|)
block|{
name|ar9300_set_power_mode
argument_list|(
name|ah
argument_list|,
name|HAL_PM_AWAKE
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
block|}
name|val
operator|=
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_SPECTRAL_SCAN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|AR_SREV_WASP
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_SCORPION
argument_list|(
name|ah
argument_list|)
operator|)
operator|&&
name|asleep
condition|)
block|{
name|ar9300_set_power_mode
argument_list|(
name|ah
argument_list|,
name|HAL_PM_FULL_SLEEP
argument_list|,
name|AH_TRUE
argument_list|)
expr_stmt|;
block|}
return|return
name|val
return|;
block|}
end_function

begin_function
name|int16_t
name|ar9300_get_ctl_chan_nf
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|int16_t
name|nf
decl_stmt|;
name|struct
name|ath_hal_private
modifier|*
name|ahpriv
init|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_AGC_CONTROL
argument_list|)
operator|&
name|AR_PHY_AGC_CONTROL_NF
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* Noise floor calibration value is ready */
name|nf
operator|=
name|MS
argument_list|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_CCA_0
argument_list|)
argument_list|,
name|AR_PHY_MINCCA_PWR
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* NF calibration is not done, return nominal value */
name|nf
operator|=
name|ahpriv
operator|->
name|nfp
operator|->
name|nominal
expr_stmt|;
block|}
if|if
condition|(
name|nf
operator|&
literal|0x100
condition|)
block|{
name|nf
operator|=
operator|(
literal|0
operator|-
operator|(
operator|(
name|nf
operator|^
literal|0x1ff
operator|)
operator|+
literal|1
operator|)
operator|)
expr_stmt|;
block|}
return|return
name|nf
return|;
block|}
end_function

begin_function
name|int16_t
name|ar9300_get_ext_chan_nf
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|int16_t
name|nf
decl_stmt|;
name|struct
name|ath_hal_private
modifier|*
name|ahpriv
init|=
name|AH_PRIVATE
argument_list|(
name|ah
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_AGC_CONTROL
argument_list|)
operator|&
name|AR_PHY_AGC_CONTROL_NF
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* Noise floor calibration value is ready */
name|nf
operator|=
name|MS
argument_list|(
name|OS_REG_READ
argument_list|(
name|ah
argument_list|,
name|AR_PHY_EXT_CCA
argument_list|)
argument_list|,
name|AR_PHY_EXT_MINCCA_PWR
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* NF calibration is not done, return nominal value */
name|nf
operator|=
name|ahpriv
operator|->
name|nfp
operator|->
name|nominal
expr_stmt|;
block|}
if|if
condition|(
name|nf
operator|&
literal|0x100
condition|)
block|{
name|nf
operator|=
operator|(
literal|0
operator|-
operator|(
operator|(
name|nf
operator|^
literal|0x1ff
operator|)
operator|+
literal|1
operator|)
operator|)
expr_stmt|;
block|}
return|return
name|nf
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ATH_SUPPORT_SPECTRAL */
end_comment

end_unit


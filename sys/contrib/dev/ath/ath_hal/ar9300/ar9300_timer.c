begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2013 Qualcomm Atheros, Inc.  *  * Permission to use, copy, modify, and/or distribute this software for any  * purpose with or without fee is hereby granted, provided that the above  * copyright notice and this permission notice appear in all copies.  *  * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH  * REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY  * AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,  * INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM  * LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR  * OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  * PERFORMANCE OF THIS SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|"opt_ah.h"
end_include

begin_include
include|#
directive|include
file|"ah.h"
end_include

begin_include
include|#
directive|include
file|"ah_internal.h"
end_include

begin_include
include|#
directive|include
file|"ar9300/ar9300.h"
end_include

begin_include
include|#
directive|include
file|"ar9300/ar9300reg.h"
end_include

begin_include
include|#
directive|include
file|"ar9300/ar9300desc.h"
end_include

begin_typedef
typedef|typedef
struct|struct
name|gen_timer_configuation
block|{
name|u_int32_t
name|next_addr
decl_stmt|;
name|u_int32_t
name|period_addr
decl_stmt|;
name|u_int32_t
name|mode_addr
decl_stmt|;
name|u_int32_t
name|mode_mask
decl_stmt|;
block|}
name|GEN_TIMER_CONFIGURATION
typedef|;
end_typedef

begin_define
define|#
directive|define
name|AR_GEN_TIMERS2_CFG
parameter_list|(
name|num
parameter_list|)
define|\
value|AR_GEN_TIMERS2_ ## num ## _NEXT, \     AR_GEN_TIMERS2_ ## num ## _PERIOD, \     AR_GEN_TIMERS2_MODE, \     (1<< num)
end_define

begin_decl_stmt
specifier|static
specifier|const
name|GEN_TIMER_CONFIGURATION
name|gen_timer_configuration
index|[]
init|=
block|{
block|{
name|AR_NEXT_NDP_TIMER
block|,
name|AR_NDP_PERIOD
block|,
name|AR_TIMER_MODE
block|,
literal|0x0080
block|}
block|,
block|{
name|AR_NEXT_NDP_TIMER
block|,
name|AR_NDP_PERIOD
block|,
name|AR_TIMER_MODE
block|,
literal|0x0080
block|}
block|,
block|{
name|AR_NEXT_NDP_TIMER
block|,
name|AR_NDP_PERIOD
block|,
name|AR_TIMER_MODE
block|,
literal|0x0080
block|}
block|,
block|{
name|AR_NEXT_NDP_TIMER
block|,
name|AR_NDP_PERIOD
block|,
name|AR_TIMER_MODE
block|,
literal|0x0080
block|}
block|,
block|{
name|AR_NEXT_NDP_TIMER
block|,
name|AR_NDP_PERIOD
block|,
name|AR_TIMER_MODE
block|,
literal|0x0080
block|}
block|,
block|{
name|AR_NEXT_NDP_TIMER
block|,
name|AR_NDP_PERIOD
block|,
name|AR_TIMER_MODE
block|,
literal|0x0080
block|}
block|,
block|{
name|AR_NEXT_NDP_TIMER
block|,
name|AR_NDP_PERIOD
block|,
name|AR_TIMER_MODE
block|,
literal|0x0080
block|}
block|,
block|{
name|AR_NEXT_NDP_TIMER
block|,
name|AR_NDP_PERIOD
block|,
name|AR_TIMER_MODE
block|,
literal|0x0080
block|}
block|,
block|{
name|AR_GEN_TIMERS2_CFG
argument_list|(
literal|0
argument_list|)
block|}
block|,
block|{
name|AR_GEN_TIMERS2_CFG
argument_list|(
literal|1
argument_list|)
block|}
block|,
block|{
name|AR_GEN_TIMERS2_CFG
argument_list|(
literal|2
argument_list|)
block|}
block|,
block|{
name|AR_GEN_TIMERS2_CFG
argument_list|(
literal|3
argument_list|)
block|}
block|,
block|{
name|AR_GEN_TIMERS2_CFG
argument_list|(
literal|4
argument_list|)
block|}
block|,
block|{
name|AR_GEN_TIMERS2_CFG
argument_list|(
literal|5
argument_list|)
block|}
block|,
block|{
name|AR_GEN_TIMERS2_CFG
argument_list|(
literal|6
argument_list|)
block|}
block|,
block|{
name|AR_GEN_TIMERS2_CFG
argument_list|(
literal|7
argument_list|)
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|AR_GENTMR_BIT
parameter_list|(
name|_index
parameter_list|)
value|(1<< (_index))
end_define

begin_function
name|int
name|ar9300_alloc_generic_timer
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|HAL_GEN_TIMER_DOMAIN
name|tsf
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|u_int32_t
name|i
decl_stmt|,
name|mask
decl_stmt|;
name|u_int32_t
name|avail_timer_start
decl_stmt|,
name|avail_timer_end
decl_stmt|;
if|if
condition|(
name|tsf
operator|==
name|HAL_GEN_TIMER_TSF
condition|)
block|{
name|avail_timer_start
operator|=
name|AR_FIRST_NDP_TIMER
expr_stmt|;
name|avail_timer_end
operator|=
name|AR_GEN_TIMER_BANK_1_LEN
expr_stmt|;
block|}
else|else
block|{
name|avail_timer_start
operator|=
name|AR_GEN_TIMER_BANK_1_LEN
expr_stmt|;
name|avail_timer_end
operator|=
name|AR_NUM_GEN_TIMERS
expr_stmt|;
block|}
comment|/* Find the first availabe timer index */
name|i
operator|=
name|avail_timer_start
expr_stmt|;
name|mask
operator|=
name|ahp
operator|->
name|ah_avail_gen_timers
operator|>>
name|i
expr_stmt|;
for|for
control|(
init|;
name|mask
operator|&&
operator|(
name|i
operator|<
name|avail_timer_end
operator|)
condition|;
name|mask
operator|>>=
literal|1
operator|,
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mask
operator|&
literal|0x1
condition|)
block|{
name|ahp
operator|->
name|ah_avail_gen_timers
operator|&=
operator|~
operator|(
name|AR_GENTMR_BIT
argument_list|(
name|i
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|tsf
operator|==
name|HAL_GEN_TIMER_TSF2
operator|)
operator|&&
operator|!
name|ahp
operator|->
name|ah_enable_tsf2
condition|)
block|{
name|ahp
operator|->
name|ah_enable_tsf2
operator|=
name|AH_TRUE
expr_stmt|;
name|ar9300_start_tsf2
argument_list|(
name|ah
argument_list|)
expr_stmt|;
block|}
return|return
name|i
return|;
block|}
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|void
name|ar9300_start_tsf2
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
if|if
condition|(
name|ahp
operator|->
name|ah_enable_tsf2
condition|)
block|{
comment|/* Delay might be needed after TSF2 reset */
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_DIRECT_CONNECT
argument_list|,
name|AR_DC_AP_STA_EN
argument_list|)
expr_stmt|;
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_RESET_TSF
argument_list|,
name|AR_RESET_TSF2_ONCE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ar9300_free_generic_timer
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|int
name|index
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
name|ar9300_stop_generic_timer
argument_list|(
name|ah
argument_list|,
name|index
argument_list|)
expr_stmt|;
name|ahp
operator|->
name|ah_avail_gen_timers
operator||=
name|AR_GENTMR_BIT
argument_list|(
name|index
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9300_start_generic_timer
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|int
name|index
parameter_list|,
name|u_int32_t
name|timer_next
parameter_list|,
name|u_int32_t
name|timer_period
parameter_list|)
block|{
if|if
condition|(
operator|(
name|index
operator|<
name|AR_FIRST_NDP_TIMER
operator|)
operator|||
operator|(
name|index
operator|>=
name|AR_NUM_GEN_TIMERS
operator|)
condition|)
block|{
return|return;
block|}
comment|/*      * Program generic timer registers      */
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|gen_timer_configuration
index|[
name|index
index|]
operator|.
name|next_addr
argument_list|,
name|timer_next
argument_list|)
expr_stmt|;
name|OS_REG_WRITE
argument_list|(
name|ah
argument_list|,
name|gen_timer_configuration
index|[
name|index
index|]
operator|.
name|period_addr
argument_list|,
name|timer_period
argument_list|)
expr_stmt|;
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|gen_timer_configuration
index|[
name|index
index|]
operator|.
name|mode_addr
argument_list|,
name|gen_timer_configuration
index|[
name|index
index|]
operator|.
name|mode_mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|AR_SREV_JUPITER
argument_list|(
name|ah
argument_list|)
operator|||
name|AR_SREV_APHRODITE
argument_list|(
name|ah
argument_list|)
condition|)
block|{
comment|/*          * Starting from Jupiter, each generic timer can select which tsf to          * use. But we still follow the old rule, 0 - 7 use tsf and 8 - 15          * use tsf2.          */
if|if
condition|(
operator|(
name|index
operator|<
name|AR_GEN_TIMER_BANK_1_LEN
operator|)
condition|)
block|{
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_MAC_PCU_GEN_TIMER_TSF_SEL
argument_list|,
operator|(
literal|1
operator|<<
name|index
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_MAC_PCU_GEN_TIMER_TSF_SEL
argument_list|,
operator|(
literal|1
operator|<<
name|index
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Enable both trigger and thresh interrupt masks */
name|OS_REG_SET_BIT
argument_list|(
name|ah
argument_list|,
name|AR_IMR_S5
argument_list|,
operator|(
name|SM
argument_list|(
name|AR_GENTMR_BIT
argument_list|(
name|index
argument_list|)
argument_list|,
name|AR_IMR_S5_GENTIMER_THRESH
argument_list|)
operator||
name|SM
argument_list|(
name|AR_GENTMR_BIT
argument_list|(
name|index
argument_list|)
argument_list|,
name|AR_IMR_S5_GENTIMER_TRIG
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9300_stop_generic_timer
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|int
name|index
parameter_list|)
block|{
if|if
condition|(
operator|(
name|index
operator|<
name|AR_FIRST_NDP_TIMER
operator|)
operator|||
operator|(
name|index
operator|>=
name|AR_NUM_GEN_TIMERS
operator|)
condition|)
block|{
return|return;
block|}
comment|/*      * Clear generic timer enable bits.      */
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|gen_timer_configuration
index|[
name|index
index|]
operator|.
name|mode_addr
argument_list|,
name|gen_timer_configuration
index|[
name|index
index|]
operator|.
name|mode_mask
argument_list|)
expr_stmt|;
comment|/* Disable both trigger and thresh interrupt masks */
name|OS_REG_CLR_BIT
argument_list|(
name|ah
argument_list|,
name|AR_IMR_S5
argument_list|,
operator|(
name|SM
argument_list|(
name|AR_GENTMR_BIT
argument_list|(
name|index
argument_list|)
argument_list|,
name|AR_IMR_S5_GENTIMER_THRESH
argument_list|)
operator||
name|SM
argument_list|(
name|AR_GENTMR_BIT
argument_list|(
name|index
argument_list|)
argument_list|,
name|AR_IMR_S5_GENTIMER_TRIG
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ar9300_get_gen_timer_interrupts
parameter_list|(
name|struct
name|ath_hal
modifier|*
name|ah
parameter_list|,
name|u_int32_t
modifier|*
name|trigger
parameter_list|,
name|u_int32_t
modifier|*
name|thresh
parameter_list|)
block|{
name|struct
name|ath_hal_9300
modifier|*
name|ahp
init|=
name|AH9300
argument_list|(
name|ah
argument_list|)
decl_stmt|;
operator|*
name|trigger
operator|=
name|ahp
operator|->
name|ah_intr_gen_timer_trigger
expr_stmt|;
operator|*
name|thresh
operator|=
name|ahp
operator|->
name|ah_intr_gen_timer_thresh
expr_stmt|;
block|}
end_function

end_unit


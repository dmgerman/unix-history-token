begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$OpenBSD: x86emu_util.c,v 1.5 2009/06/18 14:19:21 pirofti Exp $	*/
end_comment

begin_comment
comment|/*	$NetBSD: x86emu_util.c,v 1.2 2007/12/04 17:32:22 joerg Exp $	*/
end_comment

begin_comment
comment|/*  *  *  Realmode X86 Emulator Library  *  *  Copyright (C) 1996-1999 SciTech Software, Inc.  *  Copyright (C) David Mosberger-Tang  *  Copyright (C) 1999 Egbert Eich  *  Copyright (C) 2007 Joerg Sonnenberger  *  *  ========================================================================  *  *  Permission to use, copy, modify, distribute, and sell this software and  *  its documentation for any purpose is hereby granted without fee,  *  provided that the above copyright notice appear in all copies and that  *  both that copyright notice and this permission notice appear in  *  supporting documentation, and that the name of the authors not be used  *  in advertising or publicity pertaining to distribution of the software  *  without specific, written prior permission.  The authors makes no  *  representations about the suitability of this software for any purpose.  *  It is provided "as is" without express or implied warranty.  *  *  THE AUTHORS DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,  *  INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO  *  EVENT SHALL THE AUTHORS BE LIABLE FOR ANY SPECIAL, INDIRECT OR  *  CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF  *  USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR  *  OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  *  PERFORMANCE OF THIS SOFTWARE.  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<contrib/x86emu/x86emu.h>
end_include

begin_include
include|#
directive|include
file|<contrib/x86emu/x86emu_regs.h>
end_include

begin_comment
comment|/*  * PARAMETERS:  * addr	- Emulator memory address to read  *   * RETURNS:  * Byte value read from emulator memory.  *   * REMARKS:  * Reads a byte value from the emulator memory.  */
end_comment

begin_function
specifier|static
name|uint8_t
name|rdb
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|addr
parameter_list|)
block|{
if|if
condition|(
name|addr
operator|>
name|emu
operator|->
name|mem_size
operator|-
literal|1
condition|)
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
return|return
name|emu
operator|->
name|mem_base
index|[
name|addr
index|]
return|;
block|}
end_function

begin_comment
comment|/*  * PARAMETERS:  * addr	- Emulator memory address to read  *   * RETURNS:  * Word value read from emulator memory.  *   * REMARKS:  * Reads a word value from the emulator memory.  */
end_comment

begin_function
specifier|static
name|uint16_t
name|rdw
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|addr
parameter_list|)
block|{
if|if
condition|(
name|addr
operator|>
name|emu
operator|->
name|mem_size
operator|-
literal|2
condition|)
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|__STRICT_ALIGNMENT
if|if
condition|(
name|addr
operator|&
literal|1
condition|)
block|{
name|u_int8_t
modifier|*
name|a
init|=
name|emu
operator|->
name|mem_base
operator|+
name|addr
decl_stmt|;
name|u_int16_t
name|r
decl_stmt|;
name|r
operator|=
operator|(
operator|(
operator|*
operator|(
name|a
operator|+
literal|0
operator|)
operator|<<
literal|0
operator|)
operator|&
literal|0x00ff
operator|)
operator||
operator|(
operator|(
operator|*
operator|(
name|a
operator|+
literal|1
operator|)
operator|<<
literal|8
operator|)
operator|&
literal|0xff00
operator|)
expr_stmt|;
return|return
name|r
return|;
block|}
else|else
return|return
name|le32toh
argument_list|(
operator|*
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|emu
operator|->
name|mem_base
operator|+
name|addr
operator|)
argument_list|)
return|;
else|#
directive|else
return|return
name|le16toh
argument_list|(
operator|*
operator|(
name|u_int16_t
operator|*
operator|)
operator|(
name|emu
operator|->
name|mem_base
operator|+
name|addr
operator|)
argument_list|)
return|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  * PARAMETERS:  * addr	- Emulator memory address to read  *   * RETURNS:  * Long value read from emulator memory.  * REMARKS:  * Reads a long value from the emulator memory.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|rdl
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|addr
parameter_list|)
block|{
if|if
condition|(
name|addr
operator|>
name|emu
operator|->
name|mem_size
operator|-
literal|4
condition|)
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|__STRICT_ALIGNMENT
if|if
condition|(
name|addr
operator|&
literal|3
condition|)
block|{
name|u_int8_t
modifier|*
name|a
init|=
name|emu
operator|->
name|mem_base
operator|+
name|addr
decl_stmt|;
name|u_int32_t
name|r
decl_stmt|;
name|r
operator|=
operator|(
operator|(
operator|*
operator|(
name|a
operator|+
literal|0
operator|)
operator|<<
literal|0
operator|)
operator|&
literal|0x000000ff
operator|)
operator||
operator|(
operator|(
operator|*
operator|(
name|a
operator|+
literal|1
operator|)
operator|<<
literal|8
operator|)
operator|&
literal|0x0000ff00
operator|)
operator||
operator|(
operator|(
operator|*
operator|(
name|a
operator|+
literal|2
operator|)
operator|<<
literal|16
operator|)
operator|&
literal|0x00ff0000
operator|)
operator||
operator|(
operator|(
operator|*
operator|(
name|a
operator|+
literal|3
operator|)
operator|<<
literal|24
operator|)
operator|&
literal|0xff000000
operator|)
expr_stmt|;
return|return
name|r
return|;
block|}
else|else
return|return
name|le32toh
argument_list|(
operator|*
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|emu
operator|->
name|mem_base
operator|+
name|addr
operator|)
argument_list|)
return|;
else|#
directive|else
return|return
name|le32toh
argument_list|(
operator|*
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|emu
operator|->
name|mem_base
operator|+
name|addr
operator|)
argument_list|)
return|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  * PARAMETERS:  * addr	- Emulator memory address to read  * val		- Value to store  *   * REMARKS:  * Writes a byte value to emulator memory.  */
end_comment

begin_function
specifier|static
name|void
name|wrb
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|addr
parameter_list|,
name|uint8_t
name|val
parameter_list|)
block|{
if|if
condition|(
name|addr
operator|>
name|emu
operator|->
name|mem_size
operator|-
literal|1
condition|)
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|mem_base
index|[
name|addr
index|]
operator|=
name|val
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * PARAMETERS:  * addr	- Emulator memory address to read  * val		- Value to store  *   * REMARKS:  * Writes a word value to emulator memory.  */
end_comment

begin_function
specifier|static
name|void
name|wrw
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|addr
parameter_list|,
name|uint16_t
name|val
parameter_list|)
block|{
if|if
condition|(
name|addr
operator|>
name|emu
operator|->
name|mem_size
operator|-
literal|2
condition|)
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|__STRICT_ALIGNMENT
if|if
condition|(
name|addr
operator|&
literal|1
condition|)
block|{
name|u_int8_t
modifier|*
name|a
init|=
name|emu
operator|->
name|mem_base
operator|+
name|addr
decl_stmt|;
operator|*
operator|(
operator|(
name|a
operator|+
literal|0
operator|)
operator|)
operator|=
operator|(
name|val
operator|>>
literal|0
operator|)
operator|&
literal|0xff
expr_stmt|;
operator|*
operator|(
operator|(
name|a
operator|+
literal|1
operator|)
operator|)
operator|=
operator|(
name|val
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
block|}
else|else
operator|*
operator|(
operator|(
name|u_int16_t
operator|*
operator|)
operator|(
name|emu
operator|->
name|mem_base
operator|+
name|addr
operator|)
operator|)
operator|=
name|htole16
argument_list|(
name|val
argument_list|)
expr_stmt|;
else|#
directive|else
operator|*
operator|(
operator|(
name|u_int16_t
operator|*
operator|)
operator|(
name|emu
operator|->
name|mem_base
operator|+
name|addr
operator|)
operator|)
operator|=
name|htole16
argument_list|(
name|val
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/*  * PARAMETERS:  * addr	- Emulator memory address to read  * val		- Value to store  *   * REMARKS:  * Writes a long value to emulator memory.  */
end_comment

begin_function
specifier|static
name|void
name|wrl
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|addr
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
if|if
condition|(
name|addr
operator|>
name|emu
operator|->
name|mem_size
operator|-
literal|4
condition|)
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|__STRICT_ALIGNMENT
if|if
condition|(
name|addr
operator|&
literal|3
condition|)
block|{
name|u_int8_t
modifier|*
name|a
init|=
name|emu
operator|->
name|mem_base
operator|+
name|addr
decl_stmt|;
operator|*
operator|(
operator|(
name|a
operator|+
literal|0
operator|)
operator|=
operator|(
name|val
operator|>>
literal|0
operator|)
operator|&
literal|0xff
expr|;
operator|*
operator|(
operator|(
name|a
operator|+
literal|1
operator|)
operator|=
operator|(
name|val
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr|;
operator|*
operator|(
operator|(
name|a
operator|+
literal|2
operator|)
operator|=
operator|(
name|val
operator|>>
literal|16
operator|)
operator|&
literal|0xff
expr|;
operator|*
operator|(
operator|(
name|a
operator|+
literal|3
operator|)
operator|=
operator|(
name|val
operator|>>
literal|24
operator|)
operator|&
literal|0xff
expr|;
block|}
else|else
operator|*
operator|(
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|emu
operator|->
name|mem_base
operator|+
name|addr
operator|)
operator|)
operator|=
name|htole32
argument_list|(
name|val
argument_list|)
expr_stmt|;
else|#
directive|else
operator|*
operator|(
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|emu
operator|->
name|mem_base
operator|+
name|addr
operator|)
operator|)
operator|=
name|htole32
argument_list|(
name|val
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/* Setup */
end_comment

begin_function
name|void
name|x86emu_init_default
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|emu
operator|->
name|emu_rdb
operator|=
name|rdb
expr_stmt|;
name|emu
operator|->
name|emu_rdw
operator|=
name|rdw
expr_stmt|;
name|emu
operator|->
name|emu_rdl
operator|=
name|rdl
expr_stmt|;
name|emu
operator|->
name|emu_wrb
operator|=
name|wrb
expr_stmt|;
name|emu
operator|->
name|emu_wrw
operator|=
name|wrw
expr_stmt|;
name|emu
operator|->
name|emu_wrl
operator|=
name|wrl
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
name|emu
operator|->
name|_x86emu_intrTab
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
end_function

end_unit


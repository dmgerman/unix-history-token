begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$OpenBSD: x86emu.c,v 1.9 2014/06/15 11:04:49 pirofti Exp $	*/
end_comment

begin_comment
comment|/*	$NetBSD: x86emu.c,v 1.7 2009/02/03 19:26:29 joerg Exp $	*/
end_comment

begin_comment
comment|/*  *  *  Realmode X86 Emulator Library  *  *  Copyright (C) 1996-1999 SciTech Software, Inc.  *  Copyright (C) David Mosberger-Tang  *  Copyright (C) 1999 Egbert Eich  *  Copyright (C) 2007 Joerg Sonnenberger  *  *  ========================================================================  *  *  Permission to use, copy, modify, distribute, and sell this software and  *  its documentation for any purpose is hereby granted without fee,  *  provided that the above copyright notice appear in all copies and that  *  both that copyright notice and this permission notice appear in  *  supporting documentation, and that the name of the authors not be used  *  in advertising or publicity pertaining to distribution of the software  *  without specific, written prior permission.  The authors makes no  *  representations about the suitability of this software for any purpose.  *  It is provided "as is" without express or implied warranty.  *  *  THE AUTHORS DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,  *  INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS, IN NO  *  EVENT SHALL THE AUTHORS BE LIABLE FOR ANY SPECIAL, INDIRECT OR  *  CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF  *  USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR  *  OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR  *  PERFORMANCE OF THIS SOFTWARE.  *  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<contrib/x86emu/x86emu.h>
end_include

begin_include
include|#
directive|include
file|<contrib/x86emu/x86emu_regs.h>
end_include

begin_function_decl
specifier|static
name|void
name|x86emu_intr_raise
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|x86emu_exec_one_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|x86emu_exec_two_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|fetch_decode_modrm
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|fetch_byte_imm
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|fetch_word_imm
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|fetch_long_imm
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|fetch_data_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|offset
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|fetch_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|u_int
name|segment
parameter_list|,
name|uint32_t
name|offset
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|fetch_data_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|offset
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|fetch_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|segment
parameter_list|,
name|uint32_t
name|offset
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|fetch_data_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|offset
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|fetch_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|segment
parameter_list|,
name|uint32_t
name|offset
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|store_data_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|offset
parameter_list|,
name|uint8_t
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|store_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|segment
parameter_list|,
name|uint32_t
name|offset
parameter_list|,
name|uint8_t
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|store_data_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|offset
parameter_list|,
name|uint16_t
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|store_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|segment
parameter_list|,
name|uint32_t
name|offset
parameter_list|,
name|uint16_t
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|store_data_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|offset
parameter_list|,
name|uint32_t
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|store_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|segment
parameter_list|,
name|uint32_t
name|offset
parameter_list|,
name|uint32_t
name|val
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
modifier|*
name|decode_rl_byte_register
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
modifier|*
name|decode_rl_word_register
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
modifier|*
name|decode_rl_long_register
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
modifier|*
name|decode_rh_byte_register
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
modifier|*
name|decode_rh_word_register
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
modifier|*
name|decode_rh_long_register
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
modifier|*
name|decode_rh_seg_register
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|decode_rl_address
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|decode_and_fetch_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|decode_and_fetch_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|decode_and_fetch_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|decode_and_fetch_byte_imm8
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|decode_and_fetch_word_imm8
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|decode_and_fetch_long_imm8
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|decode_and_fetch_word_disp
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|int16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|decode_and_fetch_long_disp
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|int16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|write_back_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|write_back_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|write_back_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|aaa_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|d
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|aas_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|d
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|aad_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|d
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|aam_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|d
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|adc_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|adc_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint16_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|adc_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint32_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|add_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|add_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint16_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|add_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint32_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|and_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|and_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint16_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|and_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint32_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|cmp_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|cmp_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint16_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|cmp_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint32_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|cmp_byte_no_return
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|cmp_word_no_return
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint16_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|cmp_long_no_return
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint32_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|daa_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|d
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|das_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|d
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|dec_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|d
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|dec_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|d
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|dec_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|d
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|inc_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|d
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|inc_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|d
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|inc_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|d
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|or_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|or_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint16_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|or_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint32_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|neg_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|neg_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|neg_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|rcl_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|rcl_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|rcl_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|rcr_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|rcr_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|rcr_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|rol_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|rol_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|rol_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|ror_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|ror_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|ror_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|shl_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|shl_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|shl_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|shr_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|shr_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|shr_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|sar_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|sar_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|sar_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|shld_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint16_t
name|fill
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|shld_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint32_t
name|fill
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|shrd_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint16_t
name|fill
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|shrd_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint32_t
name|fill
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|sbb_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|sbb_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint16_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|sbb_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint32_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|sub_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|sub_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint16_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|sub_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint32_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|test_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|test_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint16_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|test_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint32_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint8_t
name|xor_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|xor_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint16_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|xor_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint32_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|imul_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|imul_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|imul_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mul_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mul_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|mul_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|idiv_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|idiv_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|idiv_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|div_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|div_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|div_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|ins
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|int
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|outs
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|int
name|size
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|push_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
name|w
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|push_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
name|w
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint16_t
name|pop_word
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|uint32_t
name|pop_long
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * REMARKS:  * Handles any pending asychronous interrupts.  */
end_comment

begin_function
specifier|static
name|void
name|x86emu_intr_dispatch
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|intno
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|_x86emu_intrTab
index|[
name|intno
index|]
condition|)
block|{
call|(
modifier|*
name|emu
operator|->
name|_x86emu_intrTab
index|[
name|intno
index|]
call|)
argument_list|(
name|emu
argument_list|,
name|intno
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|push_word
argument_list|(
name|emu
argument_list|,
operator|(
name|uint16_t
operator|)
name|emu
operator|->
name|x86
operator|.
name|R_FLG
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_IF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_TF
argument_list|)
expr_stmt|;
name|push_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_CS
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_CS
operator|=
name|fetch_word
argument_list|(
name|emu
argument_list|,
literal|0
argument_list|,
name|intno
operator|*
literal|4
operator|+
literal|2
argument_list|)
expr_stmt|;
name|push_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_IP
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|=
name|fetch_word
argument_list|(
name|emu
argument_list|,
literal|0
argument_list|,
name|intno
operator|*
literal|4
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|x86emu_intr_handle
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint8_t
name|intno
decl_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|intr
operator|&
name|INTR_SYNCH
condition|)
block|{
name|intno
operator|=
name|emu
operator|->
name|x86
operator|.
name|intno
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|intr
operator|=
literal|0
expr_stmt|;
name|x86emu_intr_dispatch
argument_list|(
name|emu
argument_list|,
name|intno
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * PARAMETERS:  * intrnum - Interrupt number to raise  *   * REMARKS:  * Raise the specified interrupt to be handled before the execution of the  * next instruction.  */
end_comment

begin_function
name|void
name|x86emu_intr_raise
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|intrnum
parameter_list|)
block|{
name|emu
operator|->
name|x86
operator|.
name|intno
operator|=
name|intrnum
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|intr
operator||=
name|INTR_SYNCH
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Main execution loop for the emulator. We return from here when the system  * halts, which is normally caused by a stack fault when we return from the  * original real mode call.  */
end_comment

begin_function
name|void
name|x86emu_exec
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|emu
operator|->
name|x86
operator|.
name|intr
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|setjmp
argument_list|(
name|emu
operator|->
name|exec_state
argument_list|)
condition|)
return|return;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|intr
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|emu
operator|->
name|x86
operator|.
name|intr
operator|&
name|INTR_SYNCH
operator|)
operator|&&
operator|(
name|emu
operator|->
name|x86
operator|.
name|intno
operator|==
literal|0
operator|||
name|emu
operator|->
name|x86
operator|.
name|intno
operator|==
literal|2
operator|)
operator|)
operator|||
operator|!
name|ACCESS_FLAG
argument_list|(
name|F_IF
argument_list|)
condition|)
block|{
name|x86emu_intr_handle
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|R_CS
operator|==
literal|0
operator|&&
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|==
literal|0
condition|)
return|return;
name|x86emu_exec_one_byte
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|++
name|emu
operator|->
name|cur_cycles
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|x86emu_exec_call
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|seg
parameter_list|,
name|uint16_t
name|off
parameter_list|)
block|{
name|push_word
argument_list|(
name|emu
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|push_word
argument_list|(
name|emu
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_CS
operator|=
name|seg
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|=
name|off
expr_stmt|;
name|x86emu_exec
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|x86emu_exec_intr
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|intr
parameter_list|)
block|{
name|push_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_FLG
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_IF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_TF
argument_list|)
expr_stmt|;
name|push_word
argument_list|(
name|emu
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|push_word
argument_list|(
name|emu
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_CS
operator|=
call|(
modifier|*
name|emu
operator|->
name|emu_rdw
call|)
argument_list|(
name|emu
argument_list|,
name|intr
operator|*
literal|4
operator|+
literal|2
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|=
call|(
modifier|*
name|emu
operator|->
name|emu_rdw
call|)
argument_list|(
name|emu
argument_list|,
name|intr
operator|*
literal|4
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|intr
operator|=
literal|0
expr_stmt|;
name|x86emu_exec
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Halts the system by setting the halted system flag.  */
end_comment

begin_function
name|void
name|x86emu_halt_sys
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|longjmp
argument_list|(
name|emu
operator|->
name|exec_state
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * PARAMETERS:  * mod		- Mod value from decoded byte  * regh	- Reg h value from decoded byte  * regl	- Reg l value from decoded byte  *   * REMARKS:  * Raise the specified interrupt to be handled before the execution of the  * next instruction.  *   * NOTE: Do not inline this function, as (*emu->emu_rdb) is already inline!  */
end_comment

begin_function
specifier|static
name|void
name|fetch_decode_modrm
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|int
name|fetched
decl_stmt|;
name|fetched
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|cur_mod
operator|=
operator|(
name|fetched
operator|>>
literal|6
operator|)
operator|&
literal|0x03
expr_stmt|;
name|emu
operator|->
name|cur_rh
operator|=
operator|(
name|fetched
operator|>>
literal|3
operator|)
operator|&
literal|0x07
expr_stmt|;
name|emu
operator|->
name|cur_rl
operator|=
operator|(
name|fetched
operator|>>
literal|0
operator|)
operator|&
literal|0x07
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * RETURNS:  * Immediate byte value read from instruction queue  *   * REMARKS:  * This function returns the immediate byte from the instruction queue, and  * moves the instruction pointer to the next value.  *   * NOTE: Do not inline this function, as (*emu->emu_rdb) is already inline!  */
end_comment

begin_function
specifier|static
name|uint8_t
name|fetch_byte_imm
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint8_t
name|fetched
decl_stmt|;
name|fetched
operator|=
name|fetch_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_CS
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_IP
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|++
expr_stmt|;
return|return
name|fetched
return|;
block|}
end_function

begin_comment
comment|/*  * RETURNS:  * Immediate word value read from instruction queue  *   * REMARKS:  * This function returns the immediate byte from the instruction queue, and  * moves the instruction pointer to the next value.  *   * NOTE: Do not inline this function, as (*emu->emu_rdw) is already inline!  */
end_comment

begin_function
specifier|static
name|uint16_t
name|fetch_word_imm
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint16_t
name|fetched
decl_stmt|;
name|fetched
operator|=
name|fetch_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_CS
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_IP
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|+=
literal|2
expr_stmt|;
return|return
name|fetched
return|;
block|}
end_function

begin_comment
comment|/*  * RETURNS:  * Immediate lone value read from instruction queue  *   * REMARKS:  * This function returns the immediate byte from the instruction queue, and  * moves the instruction pointer to the next value.  *   * NOTE: Do not inline this function, as (*emu->emu_rdw) is already inline!  */
end_comment

begin_function
specifier|static
name|uint32_t
name|fetch_long_imm
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|fetched
decl_stmt|;
name|fetched
operator|=
name|fetch_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_CS
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_IP
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|+=
literal|4
expr_stmt|;
return|return
name|fetched
return|;
block|}
end_function

begin_comment
comment|/*  * RETURNS:  * Value of the default data segment  *   * REMARKS:  * Inline function that returns the default data segment for the current  * instruction.  *   * On the x86 processor, the default segment is not always DS if there is  * no segment override. Address modes such as -3[BP] or 10[BP+SI] all refer to  * addresses relative to SS (ie: on the stack). So, at the minimum, all  * decodings of addressing modes would have to set/clear a bit describing  * whether the access is relative to DS or SS.  That is the function of the  * cpu-state-varible emu->x86.mode. There are several potential states:  *   * 	repe prefix seen  (handled elsewhere)  * 	repne prefix seen  (ditto)  *   * 	cs segment override  * 	ds segment override  * 	es segment override  * 	fs segment override  * 	gs segment override  * 	ss segment override  *   * 	ds/ss select (in absense of override)  *   * Each of the above 7 items are handled with a bit in the mode field.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|get_data_segment
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
switch|switch
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_SEGMASK
condition|)
block|{
case|case
literal|0
case|:
comment|/* default case: use ds register */
case|case
name|SYSMODE_SEGOVR_DS
case|:
case|case
name|SYSMODE_SEGOVR_DS
operator||
name|SYSMODE_SEG_DS_SS
case|:
return|return
name|emu
operator|->
name|x86
operator|.
name|R_DS
return|;
case|case
name|SYSMODE_SEG_DS_SS
case|:
comment|/* non-overridden, use ss register */
return|return
name|emu
operator|->
name|x86
operator|.
name|R_SS
return|;
case|case
name|SYSMODE_SEGOVR_CS
case|:
case|case
name|SYSMODE_SEGOVR_CS
operator||
name|SYSMODE_SEG_DS_SS
case|:
return|return
name|emu
operator|->
name|x86
operator|.
name|R_CS
return|;
case|case
name|SYSMODE_SEGOVR_ES
case|:
case|case
name|SYSMODE_SEGOVR_ES
operator||
name|SYSMODE_SEG_DS_SS
case|:
return|return
name|emu
operator|->
name|x86
operator|.
name|R_ES
return|;
case|case
name|SYSMODE_SEGOVR_FS
case|:
case|case
name|SYSMODE_SEGOVR_FS
operator||
name|SYSMODE_SEG_DS_SS
case|:
return|return
name|emu
operator|->
name|x86
operator|.
name|R_FS
return|;
case|case
name|SYSMODE_SEGOVR_GS
case|:
case|case
name|SYSMODE_SEGOVR_GS
operator||
name|SYSMODE_SEG_DS_SS
case|:
return|return
name|emu
operator|->
name|x86
operator|.
name|R_GS
return|;
case|case
name|SYSMODE_SEGOVR_SS
case|:
case|case
name|SYSMODE_SEGOVR_SS
operator||
name|SYSMODE_SEG_DS_SS
case|:
return|return
name|emu
operator|->
name|x86
operator|.
name|R_SS
return|;
block|}
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * PARAMETERS:  * offset	- Offset to load data from  *   * RETURNS:  * Byte value read from the absolute memory location.  *   * NOTE: Do not inline this function as (*emu->emu_rdX) is already inline!  */
end_comment

begin_function
specifier|static
name|uint8_t
name|fetch_data_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|offset
parameter_list|)
block|{
return|return
name|fetch_byte
argument_list|(
name|emu
argument_list|,
name|get_data_segment
argument_list|(
name|emu
argument_list|)
argument_list|,
name|offset
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * PARAMETERS:  * offset	- Offset to load data from  *   * RETURNS:  * Word value read from the absolute memory location.  *   * NOTE: Do not inline this function as (*emu->emu_rdX) is already inline!  */
end_comment

begin_function
specifier|static
name|uint16_t
name|fetch_data_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|offset
parameter_list|)
block|{
return|return
name|fetch_word
argument_list|(
name|emu
argument_list|,
name|get_data_segment
argument_list|(
name|emu
argument_list|)
argument_list|,
name|offset
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * PARAMETERS:  * offset	- Offset to load data from  *   * RETURNS:  * Long value read from the absolute memory location.  *   * NOTE: Do not inline this function as (*emu->emu_rdX) is already inline!  */
end_comment

begin_function
specifier|static
name|uint32_t
name|fetch_data_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|offset
parameter_list|)
block|{
return|return
name|fetch_long
argument_list|(
name|emu
argument_list|,
name|get_data_segment
argument_list|(
name|emu
argument_list|)
argument_list|,
name|offset
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * PARAMETERS:  * segment	- Segment to load data from  * offset	- Offset to load data from  *   * RETURNS:  * Byte value read from the absolute memory location.  *   * NOTE: Do not inline this function as (*emu->emu_rdX) is already inline!  */
end_comment

begin_function
specifier|static
name|uint8_t
name|fetch_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|segment
parameter_list|,
name|uint32_t
name|offset
parameter_list|)
block|{
return|return
call|(
modifier|*
name|emu
operator|->
name|emu_rdb
call|)
argument_list|(
name|emu
argument_list|,
operator|(
operator|(
name|uint32_t
operator|)
name|segment
operator|<<
literal|4
operator|)
operator|+
name|offset
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * PARAMETERS:  * segment	- Segment to load data from  * offset	- Offset to load data from  *   * RETURNS:  * Word value read from the absolute memory location.  *   * NOTE: Do not inline this function as (*emu->emu_rdX) is already inline!  */
end_comment

begin_function
specifier|static
name|uint16_t
name|fetch_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|segment
parameter_list|,
name|uint32_t
name|offset
parameter_list|)
block|{
return|return
call|(
modifier|*
name|emu
operator|->
name|emu_rdw
call|)
argument_list|(
name|emu
argument_list|,
operator|(
operator|(
name|uint32_t
operator|)
name|segment
operator|<<
literal|4
operator|)
operator|+
name|offset
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * PARAMETERS:  * segment	- Segment to load data from  * offset	- Offset to load data from  *   * RETURNS:  * Long value read from the absolute memory location.  *   * NOTE: Do not inline this function as (*emu->emu_rdX) is already inline!  */
end_comment

begin_function
specifier|static
name|uint32_t
name|fetch_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|segment
parameter_list|,
name|uint32_t
name|offset
parameter_list|)
block|{
return|return
call|(
modifier|*
name|emu
operator|->
name|emu_rdl
call|)
argument_list|(
name|emu
argument_list|,
operator|(
operator|(
name|uint32_t
operator|)
name|segment
operator|<<
literal|4
operator|)
operator|+
name|offset
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * PARAMETERS:  * offset	- Offset to store data at  * val		- Value to store  *   * REMARKS:  * Writes a word value to an segmented memory location. The segment used is  * the current 'default' segment, which may have been overridden.  *   * NOTE: Do not inline this function as (*emu->emu_wrX) is already inline!  */
end_comment

begin_function
specifier|static
name|void
name|store_data_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|offset
parameter_list|,
name|uint8_t
name|val
parameter_list|)
block|{
name|store_byte
argument_list|(
name|emu
argument_list|,
name|get_data_segment
argument_list|(
name|emu
argument_list|)
argument_list|,
name|offset
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * PARAMETERS:  * offset	- Offset to store data at  * val		- Value to store  *   * REMARKS:  * Writes a word value to an segmented memory location. The segment used is  * the current 'default' segment, which may have been overridden.  *   * NOTE: Do not inline this function as (*emu->emu_wrX) is already inline!  */
end_comment

begin_function
specifier|static
name|void
name|store_data_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|offset
parameter_list|,
name|uint16_t
name|val
parameter_list|)
block|{
name|store_word
argument_list|(
name|emu
argument_list|,
name|get_data_segment
argument_list|(
name|emu
argument_list|)
argument_list|,
name|offset
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * PARAMETERS:  * offset	- Offset to store data at  * val		- Value to store  *   * REMARKS:  * Writes a long value to an segmented memory location. The segment used is  * the current 'default' segment, which may have been overridden.  *   * NOTE: Do not inline this function as (*emu->emu_wrX) is already inline!  */
end_comment

begin_function
specifier|static
name|void
name|store_data_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|offset
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|store_long
argument_list|(
name|emu
argument_list|,
name|get_data_segment
argument_list|(
name|emu
argument_list|)
argument_list|,
name|offset
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * PARAMETERS:  * segment	- Segment to store data at  * offset	- Offset to store data at  * val		- Value to store  *   * REMARKS:  * Writes a byte value to an absolute memory location.  *   * NOTE: Do not inline this function as (*emu->emu_wrX) is already inline!  */
end_comment

begin_function
specifier|static
name|void
name|store_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|segment
parameter_list|,
name|uint32_t
name|offset
parameter_list|,
name|uint8_t
name|val
parameter_list|)
block|{
call|(
modifier|*
name|emu
operator|->
name|emu_wrb
call|)
argument_list|(
name|emu
argument_list|,
operator|(
operator|(
name|uint32_t
operator|)
name|segment
operator|<<
literal|4
operator|)
operator|+
name|offset
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * PARAMETERS:  * segment	- Segment to store data at  * offset	- Offset to store data at  * val		- Value to store  *   * REMARKS:  * Writes a word value to an absolute memory location.  *   * NOTE: Do not inline this function as (*emu->emu_wrX) is already inline!  */
end_comment

begin_function
specifier|static
name|void
name|store_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|segment
parameter_list|,
name|uint32_t
name|offset
parameter_list|,
name|uint16_t
name|val
parameter_list|)
block|{
call|(
modifier|*
name|emu
operator|->
name|emu_wrw
call|)
argument_list|(
name|emu
argument_list|,
operator|(
operator|(
name|uint32_t
operator|)
name|segment
operator|<<
literal|4
operator|)
operator|+
name|offset
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * PARAMETERS:  * segment	- Segment to store data at  * offset	- Offset to store data at  * val		- Value to store  *   * REMARKS:  * Writes a long value to an absolute memory location.  *   * NOTE: Do not inline this function as (*emu->emu_wrX) is already inline!  */
end_comment

begin_function
specifier|static
name|void
name|store_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|segment
parameter_list|,
name|uint32_t
name|offset
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
call|(
modifier|*
name|emu
operator|->
name|emu_wrl
call|)
argument_list|(
name|emu
argument_list|,
operator|(
operator|(
name|uint32_t
operator|)
name|segment
operator|<<
literal|4
operator|)
operator|+
name|offset
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * PARAMETERS:  * reg	- Register to decode  *   * RETURNS:  * Pointer to the appropriate register  *   * REMARKS:  * Return a pointer to the register given by the R/RM field of the  * modrm byte, for byte operands. Also enables the decoding of instructions.  */
end_comment

begin_function
specifier|static
name|uint8_t
modifier|*
name|decode_rm_byte_register
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|int
name|reg
parameter_list|)
block|{
switch|switch
condition|(
name|reg
condition|)
block|{
case|case
literal|0
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_AL
return|;
case|case
literal|1
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_CL
return|;
case|case
literal|2
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_DL
return|;
case|case
literal|3
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_BL
return|;
case|case
literal|4
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_AH
return|;
case|case
literal|5
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_CH
return|;
case|case
literal|6
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_DH
return|;
case|case
literal|7
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_BH
return|;
default|default:
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint8_t
modifier|*
name|decode_rl_byte_register
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
return|return
name|decode_rm_byte_register
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|cur_rl
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
modifier|*
name|decode_rh_byte_register
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
return|return
name|decode_rm_byte_register
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|cur_rh
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * PARAMETERS:  * reg	- Register to decode  *   * RETURNS:  * Pointer to the appropriate register  *   * REMARKS:  * Return a pointer to the register given by the R/RM field of the  * modrm byte, for word operands.  Also enables the decoding of instructions.  */
end_comment

begin_function
specifier|static
name|uint16_t
modifier|*
name|decode_rm_word_register
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|int
name|reg
parameter_list|)
block|{
switch|switch
condition|(
name|reg
condition|)
block|{
case|case
literal|0
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_AX
return|;
case|case
literal|1
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_CX
return|;
case|case
literal|2
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_DX
return|;
case|case
literal|3
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_BX
return|;
case|case
literal|4
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_SP
return|;
case|case
literal|5
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_BP
return|;
case|case
literal|6
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_SI
return|;
case|case
literal|7
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_DI
return|;
default|default:
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint16_t
modifier|*
name|decode_rl_word_register
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
return|return
name|decode_rm_word_register
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|cur_rl
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
modifier|*
name|decode_rh_word_register
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
return|return
name|decode_rm_word_register
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|cur_rh
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * PARAMETERS:  * reg	- Register to decode  *   * RETURNS:  * Pointer to the appropriate register  *   * REMARKS:  * Return a pointer to the register given by the R/RM field of the  * modrm byte, for dword operands.  Also enables the decoding of instructions.  */
end_comment

begin_function
specifier|static
name|uint32_t
modifier|*
name|decode_rm_long_register
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|int
name|reg
parameter_list|)
block|{
switch|switch
condition|(
name|reg
condition|)
block|{
case|case
literal|0
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_EAX
return|;
case|case
literal|1
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_ECX
return|;
case|case
literal|2
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_EDX
return|;
case|case
literal|3
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_EBX
return|;
case|case
literal|4
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_ESP
return|;
case|case
literal|5
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_EBP
return|;
case|case
literal|6
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_ESI
return|;
case|case
literal|7
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_EDI
return|;
default|default:
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint32_t
modifier|*
name|decode_rl_long_register
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
return|return
name|decode_rm_long_register
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|cur_rl
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
modifier|*
name|decode_rh_long_register
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
return|return
name|decode_rm_long_register
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|cur_rh
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * PARAMETERS:  * reg	- Register to decode  *   * RETURNS:  * Pointer to the appropriate register  *   * REMARKS:  * Return a pointer to the register given by the R/RM field of the  * modrm byte, for word operands, modified from above for the weirdo  * special case of segreg operands.  Also enables the decoding of instructions.  */
end_comment

begin_function
specifier|static
name|uint16_t
modifier|*
name|decode_rh_seg_register
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
switch|switch
condition|(
name|emu
operator|->
name|cur_rh
condition|)
block|{
case|case
literal|0
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_ES
return|;
case|case
literal|1
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_CS
return|;
case|case
literal|2
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_SS
return|;
case|case
literal|3
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_DS
return|;
case|case
literal|4
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_FS
return|;
case|case
literal|5
case|:
return|return
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_GS
return|;
default|default:
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Return offset from the SIB Byte.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|decode_sib_address
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|int
name|sib
parameter_list|,
name|int
name|mod
parameter_list|)
block|{
name|uint32_t
name|base
init|=
literal|0
decl_stmt|,
name|i
init|=
literal|0
decl_stmt|,
name|scale
init|=
literal|1
decl_stmt|;
switch|switch
condition|(
name|sib
operator|&
literal|0x07
condition|)
block|{
case|case
literal|0
case|:
name|base
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EAX
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|base
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_ECX
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|base
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EDX
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|base
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EBX
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|base
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_ESP
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|mode
operator||=
name|SYSMODE_SEG_DS_SS
expr_stmt|;
break|break;
case|case
literal|5
case|:
if|if
condition|(
name|mod
operator|==
literal|0
condition|)
block|{
name|base
operator|=
name|fetch_long_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|base
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EBP
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|mode
operator||=
name|SYSMODE_SEG_DS_SS
expr_stmt|;
block|}
break|break;
case|case
literal|6
case|:
name|base
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_ESI
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|base
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EDI
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
operator|(
name|sib
operator|>>
literal|3
operator|)
operator|&
literal|0x07
condition|)
block|{
case|case
literal|0
case|:
name|i
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EAX
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|i
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_ECX
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|i
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EDX
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|i
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EBX
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|i
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|i
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EBP
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|i
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_ESI
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|i
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EDI
expr_stmt|;
break|break;
block|}
name|scale
operator|=
literal|1
operator|<<
operator|(
operator|(
name|sib
operator|>>
literal|6
operator|)
operator|&
literal|0x03
operator|)
expr_stmt|;
return|return
name|base
operator|+
operator|(
name|i
operator|*
name|scale
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * PARAMETERS:  * rm	- RM value to decode  *   * RETURNS:  * Offset in memory for the address decoding  *   * REMARKS:  * Return the offset given by mod=00, mod=01 or mod=10 addressing.  * Also enables the decoding of instructions.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|decode_rl_address
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_ADDR
condition|)
block|{
name|uint32_t
name|offset
decl_stmt|,
name|sib
decl_stmt|;
comment|/* 32-bit addressing */
switch|switch
condition|(
name|emu
operator|->
name|cur_rl
condition|)
block|{
case|case
literal|0
case|:
name|offset
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EAX
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|offset
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_ECX
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|offset
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EDX
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|offset
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EBX
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|sib
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|offset
operator|=
name|decode_sib_address
argument_list|(
name|emu
argument_list|,
name|sib
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|==
literal|0
condition|)
block|{
name|offset
operator|=
name|fetch_long_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|emu
operator|->
name|x86
operator|.
name|mode
operator||=
name|SYSMODE_SEG_DS_SS
expr_stmt|;
name|offset
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EBP
expr_stmt|;
block|}
break|break;
case|case
literal|6
case|:
name|offset
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_ESI
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|offset
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EDI
expr_stmt|;
break|break;
default|default:
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|==
literal|1
condition|)
name|offset
operator|+=
operator|(
name|int8_t
operator|)
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|==
literal|2
condition|)
name|offset
operator|+=
name|fetch_long_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
return|return
name|offset
return|;
block|}
else|else
block|{
name|uint16_t
name|offset
decl_stmt|;
comment|/* 16-bit addressing */
switch|switch
condition|(
name|emu
operator|->
name|cur_rl
condition|)
block|{
case|case
literal|0
case|:
name|offset
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_BX
operator|+
name|emu
operator|->
name|x86
operator|.
name|R_SI
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|offset
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_BX
operator|+
name|emu
operator|->
name|x86
operator|.
name|R_DI
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|emu
operator|->
name|x86
operator|.
name|mode
operator||=
name|SYSMODE_SEG_DS_SS
expr_stmt|;
name|offset
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_BP
operator|+
name|emu
operator|->
name|x86
operator|.
name|R_SI
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|emu
operator|->
name|x86
operator|.
name|mode
operator||=
name|SYSMODE_SEG_DS_SS
expr_stmt|;
name|offset
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_BP
operator|+
name|emu
operator|->
name|x86
operator|.
name|R_DI
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|offset
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_SI
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|offset
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_DI
expr_stmt|;
break|break;
case|case
literal|6
case|:
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|==
literal|0
condition|)
block|{
name|offset
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|emu
operator|->
name|x86
operator|.
name|mode
operator||=
name|SYSMODE_SEG_DS_SS
expr_stmt|;
name|offset
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_BP
expr_stmt|;
block|}
break|break;
case|case
literal|7
case|:
name|offset
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_BX
expr_stmt|;
break|break;
default|default:
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|==
literal|1
condition|)
name|offset
operator|+=
operator|(
name|int8_t
operator|)
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|==
literal|2
condition|)
name|offset
operator|+=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
return|return
name|offset
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|decode_and_fetch_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|emu
operator|->
name|cur_offset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
return|return
name|fetch_data_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|cur_offset
argument_list|)
return|;
block|}
else|else
block|{
return|return
operator|*
name|decode_rl_byte_register
argument_list|(
name|emu
argument_list|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|decode_and_fetch_word_disp
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|int16_t
name|disp
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
comment|/* TODO: A20 gate emulation */
name|emu
operator|->
name|cur_offset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
operator|+
name|disp
expr_stmt|;
if|if
condition|(
operator|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_ADDR
operator|)
operator|==
literal|0
condition|)
name|emu
operator|->
name|cur_offset
operator|&=
literal|0xffff
expr_stmt|;
return|return
name|fetch_data_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|cur_offset
argument_list|)
return|;
block|}
else|else
block|{
return|return
operator|*
name|decode_rl_word_register
argument_list|(
name|emu
argument_list|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|decode_and_fetch_long_disp
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|int16_t
name|disp
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
comment|/* TODO: A20 gate emulation */
name|emu
operator|->
name|cur_offset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
operator|+
name|disp
expr_stmt|;
if|if
condition|(
operator|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_ADDR
operator|)
operator|==
literal|0
condition|)
name|emu
operator|->
name|cur_offset
operator|&=
literal|0xffff
expr_stmt|;
return|return
name|fetch_data_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|cur_offset
argument_list|)
return|;
block|}
else|else
block|{
return|return
operator|*
name|decode_rl_long_register
argument_list|(
name|emu
argument_list|)
return|;
block|}
block|}
end_function

begin_function
name|uint16_t
name|decode_and_fetch_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
return|return
name|decode_and_fetch_word_disp
argument_list|(
name|emu
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|uint32_t
name|decode_and_fetch_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
return|return
name|decode_and_fetch_long_disp
argument_list|(
name|emu
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|uint8_t
name|decode_and_fetch_byte_imm8
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
modifier|*
name|imm
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|emu
operator|->
name|cur_offset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|imm
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
return|return
name|fetch_data_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|cur_offset
argument_list|)
return|;
block|}
else|else
block|{
operator|*
name|imm
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
return|return
operator|*
name|decode_rl_byte_register
argument_list|(
name|emu
argument_list|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|decode_and_fetch_word_imm8
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
modifier|*
name|imm
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|emu
operator|->
name|cur_offset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|imm
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
return|return
name|fetch_data_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|cur_offset
argument_list|)
return|;
block|}
else|else
block|{
operator|*
name|imm
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
return|return
operator|*
name|decode_rl_word_register
argument_list|(
name|emu
argument_list|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|decode_and_fetch_long_imm8
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
modifier|*
name|imm
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|emu
operator|->
name|cur_offset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|imm
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
return|return
name|fetch_data_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|cur_offset
argument_list|)
return|;
block|}
else|else
block|{
operator|*
name|imm
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
return|return
operator|*
name|decode_rl_long_register
argument_list|(
name|emu
argument_list|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|write_back_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|val
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
name|store_data_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|cur_offset
argument_list|,
name|val
argument_list|)
expr_stmt|;
else|else
operator|*
name|decode_rl_byte_register
argument_list|(
name|emu
argument_list|)
operator|=
name|val
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_back_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|val
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
name|store_data_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|cur_offset
argument_list|,
name|val
argument_list|)
expr_stmt|;
else|else
operator|*
name|decode_rl_word_register
argument_list|(
name|emu
argument_list|)
operator|=
name|val
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|write_back_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
name|store_data_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|cur_offset
argument_list|,
name|val
argument_list|)
expr_stmt|;
else|else
operator|*
name|decode_rl_long_register
argument_list|(
name|emu
argument_list|)
operator|=
name|val
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|common_inc_word_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|union
name|x86emu_register
modifier|*
name|reg
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|reg
operator|->
name|I32_reg
operator|.
name|e_reg
operator|=
name|inc_long
argument_list|(
name|emu
argument_list|,
name|reg
operator|->
name|I32_reg
operator|.
name|e_reg
argument_list|)
expr_stmt|;
else|else
name|reg
operator|->
name|I16_reg
operator|.
name|x_reg
operator|=
name|inc_word
argument_list|(
name|emu
argument_list|,
name|reg
operator|->
name|I16_reg
operator|.
name|x_reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|common_dec_word_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|union
name|x86emu_register
modifier|*
name|reg
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|reg
operator|->
name|I32_reg
operator|.
name|e_reg
operator|=
name|dec_long
argument_list|(
name|emu
argument_list|,
name|reg
operator|->
name|I32_reg
operator|.
name|e_reg
argument_list|)
expr_stmt|;
else|else
name|reg
operator|->
name|I16_reg
operator|.
name|x_reg
operator|=
name|dec_word
argument_list|(
name|emu
argument_list|,
name|reg
operator|->
name|I16_reg
operator|.
name|x_reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|common_binop_byte_rm_r
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
function_decl|(
modifier|*
name|binop
function_decl|)
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint8_t
parameter_list|)
parameter_list|)
block|{
name|uint32_t
name|destoffset
decl_stmt|;
name|uint8_t
modifier|*
name|destreg
decl_stmt|,
name|srcval
decl_stmt|;
name|uint8_t
name|destval
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
operator|*
name|decode_rh_byte_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|destoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|fetch_data_byte
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|)
expr_stmt|;
name|destval
operator|=
call|(
modifier|*
name|binop
call|)
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
name|store_data_byte
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|,
name|destval
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|destreg
operator|=
name|decode_rl_byte_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|destreg
operator|=
call|(
modifier|*
name|binop
call|)
argument_list|(
name|emu
argument_list|,
operator|*
name|destreg
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|common_binop_ns_byte_rm_r
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|void
function_decl|(
modifier|*
name|binop
function_decl|)
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint8_t
parameter_list|)
parameter_list|)
block|{
name|uint32_t
name|destoffset
decl_stmt|;
name|uint8_t
name|destval
decl_stmt|,
name|srcval
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
operator|*
name|decode_rh_byte_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|destoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|fetch_data_byte
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|destval
operator|=
operator|*
name|decode_rl_byte_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
call|(
modifier|*
name|binop
call|)
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|common_binop_word_rm_r
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
function_decl|(
modifier|*
name|binop
function_decl|)
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint16_t
parameter_list|)
parameter_list|)
block|{
name|uint32_t
name|destoffset
decl_stmt|;
name|uint16_t
name|destval
decl_stmt|,
modifier|*
name|destreg
decl_stmt|,
name|srcval
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
operator|*
name|decode_rh_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|destoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|fetch_data_word
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|)
expr_stmt|;
name|destval
operator|=
call|(
modifier|*
name|binop
call|)
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
name|store_data_word
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|,
name|destval
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|destreg
operator|=
name|decode_rl_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|destreg
operator|=
call|(
modifier|*
name|binop
call|)
argument_list|(
name|emu
argument_list|,
operator|*
name|destreg
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|common_binop_byte_r_rm
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
function_decl|(
modifier|*
name|binop
function_decl|)
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint8_t
parameter_list|)
parameter_list|)
block|{
name|uint8_t
modifier|*
name|destreg
decl_stmt|,
name|srcval
decl_stmt|;
name|uint32_t
name|srcoffset
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destreg
operator|=
name|decode_rh_byte_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|srcoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
name|fetch_data_byte
argument_list|(
name|emu
argument_list|,
name|srcoffset
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|srcval
operator|=
operator|*
name|decode_rl_byte_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
operator|*
name|destreg
operator|=
call|(
modifier|*
name|binop
call|)
argument_list|(
name|emu
argument_list|,
operator|*
name|destreg
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|common_binop_long_rm_r
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
function_decl|(
modifier|*
name|binop
function_decl|)
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|)
parameter_list|)
block|{
name|uint32_t
name|destoffset
decl_stmt|;
name|uint32_t
name|destval
decl_stmt|,
modifier|*
name|destreg
decl_stmt|,
name|srcval
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
operator|*
name|decode_rh_long_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|destoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|fetch_data_long
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|)
expr_stmt|;
name|destval
operator|=
call|(
modifier|*
name|binop
call|)
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
name|store_data_long
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|,
name|destval
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|destreg
operator|=
name|decode_rl_long_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|destreg
operator|=
call|(
modifier|*
name|binop
call|)
argument_list|(
name|emu
argument_list|,
operator|*
name|destreg
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|common_binop_word_long_rm_r
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
function_decl|(
modifier|*
name|binop16
function_decl|)
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint16_t
parameter_list|)
parameter_list|,
name|uint32_t
function_decl|(
modifier|*
name|binop32
function_decl|)
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|)
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|common_binop_long_rm_r
argument_list|(
name|emu
argument_list|,
name|binop32
argument_list|)
expr_stmt|;
else|else
name|common_binop_word_rm_r
argument_list|(
name|emu
argument_list|,
name|binop16
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|common_binop_ns_word_rm_r
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|void
function_decl|(
modifier|*
name|binop
function_decl|)
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint16_t
parameter_list|)
parameter_list|)
block|{
name|uint32_t
name|destoffset
decl_stmt|;
name|uint16_t
name|destval
decl_stmt|,
name|srcval
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
operator|*
name|decode_rh_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|destoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|fetch_data_word
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|destval
operator|=
operator|*
name|decode_rl_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
call|(
modifier|*
name|binop
call|)
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|common_binop_ns_long_rm_r
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|void
function_decl|(
modifier|*
name|binop
function_decl|)
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|)
parameter_list|)
block|{
name|uint32_t
name|destoffset
decl_stmt|;
name|uint32_t
name|destval
decl_stmt|,
name|srcval
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
operator|*
name|decode_rh_long_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|destoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|fetch_data_long
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|destval
operator|=
operator|*
name|decode_rl_long_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
call|(
modifier|*
name|binop
call|)
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|common_binop_ns_word_long_rm_r
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|void
function_decl|(
modifier|*
name|binop16
function_decl|)
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint16_t
parameter_list|)
parameter_list|,
name|void
function_decl|(
modifier|*
name|binop32
function_decl|)
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|)
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|common_binop_ns_long_rm_r
argument_list|(
name|emu
argument_list|,
name|binop32
argument_list|)
expr_stmt|;
else|else
name|common_binop_ns_word_rm_r
argument_list|(
name|emu
argument_list|,
name|binop16
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|common_binop_long_r_rm
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
function_decl|(
modifier|*
name|binop
function_decl|)
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|)
parameter_list|)
block|{
name|uint32_t
name|srcoffset
decl_stmt|;
name|uint32_t
modifier|*
name|destreg
decl_stmt|,
name|srcval
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destreg
operator|=
name|decode_rh_long_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|srcoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
name|fetch_data_long
argument_list|(
name|emu
argument_list|,
name|srcoffset
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|srcval
operator|=
operator|*
name|decode_rl_long_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
operator|*
name|destreg
operator|=
call|(
modifier|*
name|binop
call|)
argument_list|(
name|emu
argument_list|,
operator|*
name|destreg
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|common_binop_word_r_rm
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
function_decl|(
modifier|*
name|binop
function_decl|)
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint16_t
parameter_list|)
parameter_list|)
block|{
name|uint32_t
name|srcoffset
decl_stmt|;
name|uint16_t
modifier|*
name|destreg
decl_stmt|,
name|srcval
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destreg
operator|=
name|decode_rh_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|srcoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
name|fetch_data_word
argument_list|(
name|emu
argument_list|,
name|srcoffset
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|srcval
operator|=
operator|*
name|decode_rl_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
operator|*
name|destreg
operator|=
call|(
modifier|*
name|binop
call|)
argument_list|(
name|emu
argument_list|,
operator|*
name|destreg
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|common_binop_word_long_r_rm
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
function_decl|(
modifier|*
name|binop16
function_decl|)
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint16_t
parameter_list|)
parameter_list|,
name|uint32_t
function_decl|(
modifier|*
name|binop32
function_decl|)
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|)
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|common_binop_long_r_rm
argument_list|(
name|emu
argument_list|,
name|binop32
argument_list|)
expr_stmt|;
else|else
name|common_binop_word_r_rm
argument_list|(
name|emu
argument_list|,
name|binop16
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|common_binop_byte_imm
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
function_decl|(
modifier|*
name|binop
function_decl|)
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint8_t
parameter_list|,
name|uint8_t
parameter_list|)
parameter_list|)
block|{
name|uint8_t
name|srcval
decl_stmt|;
name|srcval
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_AL
operator|=
call|(
modifier|*
name|binop
call|)
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AL
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|common_binop_word_long_imm
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
function_decl|(
modifier|*
name|binop16
function_decl|)
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint16_t
parameter_list|,
name|uint16_t
parameter_list|)
parameter_list|,
name|uint32_t
function_decl|(
modifier|*
name|binop32
function_decl|)
parameter_list|(
name|struct
name|x86emu
modifier|*
parameter_list|,
name|uint32_t
parameter_list|,
name|uint32_t
parameter_list|)
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|uint32_t
name|srcval
decl_stmt|;
name|srcval
operator|=
name|fetch_long_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|=
call|(
modifier|*
name|binop32
call|)
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_EAX
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|uint16_t
name|srcval
decl_stmt|;
name|srcval
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|=
call|(
modifier|*
name|binop16
call|)
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AX
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|common_push_word_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|union
name|x86emu_register
modifier|*
name|reg
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|push_long
argument_list|(
name|emu
argument_list|,
name|reg
operator|->
name|I32_reg
operator|.
name|e_reg
argument_list|)
expr_stmt|;
else|else
name|push_word
argument_list|(
name|emu
argument_list|,
name|reg
operator|->
name|I16_reg
operator|.
name|x_reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|common_pop_word_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|union
name|x86emu_register
modifier|*
name|reg
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|reg
operator|->
name|I32_reg
operator|.
name|e_reg
operator|=
name|pop_long
argument_list|(
name|emu
argument_list|)
expr_stmt|;
else|else
name|reg
operator|->
name|I16_reg
operator|.
name|x_reg
operator|=
name|pop_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|common_imul_long_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|int
name|byte_imm
parameter_list|)
block|{
name|uint32_t
name|srcoffset
decl_stmt|;
name|uint32_t
modifier|*
name|destreg
decl_stmt|,
name|srcval
decl_stmt|;
name|int32_t
name|imm
decl_stmt|;
name|uint64_t
name|res
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destreg
operator|=
name|decode_rh_long_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|srcoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
name|fetch_data_long
argument_list|(
name|emu
argument_list|,
name|srcoffset
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|srcval
operator|=
operator|*
name|decode_rl_long_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|byte_imm
condition|)
name|imm
operator|=
operator|(
name|int8_t
operator|)
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
else|else
name|imm
operator|=
name|fetch_long_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|res
operator|=
operator|(
name|int32_t
operator|)
name|srcval
operator|*
name|imm
expr_stmt|;
if|if
condition|(
name|res
operator|>
literal|0xffffffff
condition|)
block|{
name|SET_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
operator|*
name|destreg
operator|=
operator|(
name|uint32_t
operator|)
name|res
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|common_imul_word_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|int
name|byte_imm
parameter_list|)
block|{
name|uint32_t
name|srcoffset
decl_stmt|;
name|uint16_t
modifier|*
name|destreg
decl_stmt|,
name|srcval
decl_stmt|;
name|int16_t
name|imm
decl_stmt|;
name|uint32_t
name|res
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destreg
operator|=
name|decode_rh_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|srcoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
name|fetch_data_word
argument_list|(
name|emu
argument_list|,
name|srcoffset
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|srcval
operator|=
operator|*
name|decode_rl_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|byte_imm
condition|)
name|imm
operator|=
operator|(
name|int8_t
operator|)
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
else|else
name|imm
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|res
operator|=
operator|(
name|int16_t
operator|)
name|srcval
operator|*
name|imm
expr_stmt|;
if|if
condition|(
name|res
operator|>
literal|0xffff
condition|)
block|{
name|SET_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
operator|*
name|destreg
operator|=
operator|(
name|uint16_t
operator|)
name|res
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|common_imul_imm
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|int
name|byte_imm
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|common_imul_long_IMM
argument_list|(
name|emu
argument_list|,
name|byte_imm
argument_list|)
expr_stmt|;
else|else
name|common_imul_word_IMM
argument_list|(
name|emu
argument_list|,
name|byte_imm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|common_jmp_near
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|int
name|cond
parameter_list|)
block|{
name|int8_t
name|offset
decl_stmt|;
name|uint16_t
name|target
decl_stmt|;
name|offset
operator|=
operator|(
name|int8_t
operator|)
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|target
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|+
operator|(
name|int16_t
operator|)
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|cond
condition|)
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|=
name|target
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|common_load_far_pointer
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
modifier|*
name|seg
parameter_list|)
block|{
name|uint16_t
modifier|*
name|dstreg
decl_stmt|;
name|uint32_t
name|srcoffset
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|==
literal|3
condition|)
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|dstreg
operator|=
name|decode_rh_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|dstreg
operator|=
name|fetch_data_word
argument_list|(
name|emu
argument_list|,
name|srcoffset
argument_list|)
expr_stmt|;
operator|*
name|seg
operator|=
name|fetch_data_word
argument_list|(
name|emu
argument_list|,
name|srcoffset
operator|+
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Implementation */
end_comment

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x3a  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_cmp_byte_R_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint8_t
modifier|*
name|destreg
decl_stmt|,
name|srcval
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destreg
operator|=
name|decode_rh_byte_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
name|decode_and_fetch_byte
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|cmp_byte
argument_list|(
name|emu
argument_list|,
operator|*
name|destreg
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  *   * Handles opcode 0x3b  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp32_cmp_word_R_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|srcval
decl_stmt|,
modifier|*
name|destreg
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destreg
operator|=
name|decode_rh_long_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
name|decode_and_fetch_long
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|cmp_long
argument_list|(
name|emu
argument_list|,
operator|*
name|destreg
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp16_cmp_word_R_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint16_t
name|srcval
decl_stmt|,
modifier|*
name|destreg
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destreg
operator|=
name|decode_rh_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
name|decode_and_fetch_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|cmp_word
argument_list|(
name|emu
argument_list|,
operator|*
name|destreg
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp_cmp_word_R_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|x86emuOp32_cmp_word_R_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
else|else
name|x86emuOp16_cmp_word_R_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x3c  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_cmp_byte_AL_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint8_t
name|srcval
decl_stmt|;
name|srcval
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|cmp_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AL
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x3d  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp32_cmp_word_AX_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|srcval
decl_stmt|;
name|srcval
operator|=
name|fetch_long_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|cmp_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_EAX
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp16_cmp_word_AX_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint16_t
name|srcval
decl_stmt|;
name|srcval
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|cmp_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AX
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp_cmp_word_AX_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|x86emuOp32_cmp_word_AX_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
else|else
name|x86emuOp16_cmp_word_AX_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x60  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_push_all
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|uint32_t
name|old_sp
init|=
name|emu
operator|->
name|x86
operator|.
name|R_ESP
decl_stmt|;
name|push_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_EAX
argument_list|)
expr_stmt|;
name|push_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ECX
argument_list|)
expr_stmt|;
name|push_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_EDX
argument_list|)
expr_stmt|;
name|push_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_EBX
argument_list|)
expr_stmt|;
name|push_long
argument_list|(
name|emu
argument_list|,
name|old_sp
argument_list|)
expr_stmt|;
name|push_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_EBP
argument_list|)
expr_stmt|;
name|push_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ESI
argument_list|)
expr_stmt|;
name|push_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_EDI
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|uint16_t
name|old_sp
init|=
name|emu
operator|->
name|x86
operator|.
name|R_SP
decl_stmt|;
name|push_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AX
argument_list|)
expr_stmt|;
name|push_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_CX
argument_list|)
expr_stmt|;
name|push_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DX
argument_list|)
expr_stmt|;
name|push_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_BX
argument_list|)
expr_stmt|;
name|push_word
argument_list|(
name|emu
argument_list|,
name|old_sp
argument_list|)
expr_stmt|;
name|push_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_BP
argument_list|)
expr_stmt|;
name|push_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SI
argument_list|)
expr_stmt|;
name|push_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x61  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_pop_all
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|emu
operator|->
name|x86
operator|.
name|R_EDI
operator|=
name|pop_long
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_ESI
operator|=
name|pop_long
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EBP
operator|=
name|pop_long
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_ESP
operator|+=
literal|4
expr_stmt|;
comment|/* skip ESP */
name|emu
operator|->
name|x86
operator|.
name|R_EBX
operator|=
name|pop_long
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EDX
operator|=
name|pop_long
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_ECX
operator|=
name|pop_long
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|=
name|pop_long
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|emu
operator|->
name|x86
operator|.
name|R_DI
operator|=
name|pop_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_SI
operator|=
name|pop_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_BP
operator|=
name|pop_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_SP
operator|+=
literal|2
expr_stmt|;
comment|/* skip SP */
name|emu
operator|->
name|x86
operator|.
name|R_BX
operator|=
name|pop_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_DX
operator|=
name|pop_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|=
name|pop_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|=
name|pop_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*opcode 0x62   ILLEGAL OP, calls x86emuOp_illegal_op() */
end_comment

begin_comment
comment|/*opcode 0x63   ILLEGAL OP, calls x86emuOp_illegal_op() */
end_comment

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x68  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_push_word_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|uint32_t
name|imm
decl_stmt|;
name|imm
operator|=
name|fetch_long_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|push_long
argument_list|(
name|emu
argument_list|,
name|imm
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|uint16_t
name|imm
decl_stmt|;
name|imm
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|push_word
argument_list|(
name|emu
argument_list|,
name|imm
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x6a  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_push_byte_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|int16_t
name|imm
decl_stmt|;
name|imm
operator|=
operator|(
name|int8_t
operator|)
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|push_long
argument_list|(
name|emu
argument_list|,
operator|(
name|int32_t
operator|)
name|imm
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|push_word
argument_list|(
name|emu
argument_list|,
name|imm
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x6c and 0x6d  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_ins_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|ins
argument_list|(
name|emu
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ins
argument_list|(
name|emu
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x6f  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_outs_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|outs
argument_list|(
name|emu
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|outs
argument_list|(
name|emu
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x7c  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_jump_near_L
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|int
name|sf
decl_stmt|,
name|of
decl_stmt|;
name|sf
operator|=
name|ACCESS_FLAG
argument_list|(
name|F_SF
argument_list|)
operator|!=
literal|0
expr_stmt|;
name|of
operator|=
name|ACCESS_FLAG
argument_list|(
name|F_OF
argument_list|)
operator|!=
literal|0
expr_stmt|;
name|common_jmp_near
argument_list|(
name|emu
argument_list|,
name|sf
operator|!=
name|of
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x7d  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_jump_near_NL
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|int
name|sf
decl_stmt|,
name|of
decl_stmt|;
name|sf
operator|=
name|ACCESS_FLAG
argument_list|(
name|F_SF
argument_list|)
operator|!=
literal|0
expr_stmt|;
name|of
operator|=
name|ACCESS_FLAG
argument_list|(
name|F_OF
argument_list|)
operator|!=
literal|0
expr_stmt|;
name|common_jmp_near
argument_list|(
name|emu
argument_list|,
name|sf
operator|==
name|of
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x7e  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_jump_near_LE
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|int
name|sf
decl_stmt|,
name|of
decl_stmt|;
name|sf
operator|=
name|ACCESS_FLAG
argument_list|(
name|F_SF
argument_list|)
operator|!=
literal|0
expr_stmt|;
name|of
operator|=
name|ACCESS_FLAG
argument_list|(
name|F_OF
argument_list|)
operator|!=
literal|0
expr_stmt|;
name|common_jmp_near
argument_list|(
name|emu
argument_list|,
name|sf
operator|!=
name|of
operator|||
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x7f  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_jump_near_NLE
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|int
name|sf
decl_stmt|,
name|of
decl_stmt|;
name|sf
operator|=
name|ACCESS_FLAG
argument_list|(
name|F_SF
argument_list|)
operator|!=
literal|0
expr_stmt|;
name|of
operator|=
name|ACCESS_FLAG
argument_list|(
name|F_OF
argument_list|)
operator|!=
literal|0
expr_stmt|;
name|common_jmp_near
argument_list|(
name|emu
argument_list|,
name|sf
operator|==
name|of
operator|&&
operator|!
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
specifier|static
name|uint8_t
argument_list|(
argument|*const opc80_byte_operation[]
argument_list|)
operator|(
expr|struct
name|x86emu
operator|*
operator|,
name|uint8_t
name|d
operator|,
name|uint8_t
name|s
operator|)
operator|=
block|{
name|add_byte
block|,
comment|/* 00 */
name|or_byte
block|,
comment|/* 01 */
name|adc_byte
block|,
comment|/* 02 */
name|sbb_byte
block|,
comment|/* 03 */
name|and_byte
block|,
comment|/* 04 */
name|sub_byte
block|,
comment|/* 05 */
name|xor_byte
block|,
comment|/* 06 */
name|cmp_byte
block|,
comment|/* 07 */
block|}
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x80  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_opc80_byte_RM_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint8_t
name|imm
decl_stmt|,
name|destval
decl_stmt|;
comment|/*          * Weirdo special case instruction format.  Part of the opcode          * held below in "RH".  Doubly nested case would result, except          * that the decoded instruction          */
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|decode_and_fetch_byte
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|imm
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
call|(
modifier|*
name|opc80_byte_operation
index|[
name|emu
operator|->
name|cur_rh
index|]
call|)
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
name|imm
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_rh
operator|!=
literal|7
condition|)
name|write_back_byte
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
specifier|static
name|uint16_t
argument_list|(
argument|* const opc81_word_operation[]
argument_list|)
operator|(
expr|struct
name|x86emu
operator|*
operator|,
name|uint16_t
name|d
operator|,
name|uint16_t
name|s
operator|)
operator|=
block|{
name|add_word
block|,
comment|/* 00 */
name|or_word
block|,
comment|/* 01 */
name|adc_word
block|,
comment|/* 02 */
name|sbb_word
block|,
comment|/* 03 */
name|and_word
block|,
comment|/* 04 */
name|sub_word
block|,
comment|/* 05 */
name|xor_word
block|,
comment|/* 06 */
name|cmp_word
block|,
comment|/* 07 */
block|}
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|uint32_t
argument_list|(
argument|* const opc81_long_operation[]
argument_list|)
operator|(
expr|struct
name|x86emu
operator|*
operator|,
name|uint32_t
name|d
operator|,
name|uint32_t
name|s
operator|)
operator|=
block|{
name|add_long
block|,
comment|/* 00 */
name|or_long
block|,
comment|/* 01 */
name|adc_long
block|,
comment|/* 02 */
name|sbb_long
block|,
comment|/* 03 */
name|and_long
block|,
comment|/* 04 */
name|sub_long
block|,
comment|/* 05 */
name|xor_long
block|,
comment|/* 06 */
name|cmp_long
block|,
comment|/* 07 */
block|}
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x81  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp32_opc81_word_RM_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|destval
decl_stmt|,
name|imm
decl_stmt|;
comment|/*          * Weirdo special case instruction format.  Part of the opcode          * held below in "RH".  Doubly nested case would result, except          * that the decoded instruction          */
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|decode_and_fetch_long
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|imm
operator|=
name|fetch_long_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
call|(
modifier|*
name|opc81_long_operation
index|[
name|emu
operator|->
name|cur_rh
index|]
call|)
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
name|imm
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_rh
operator|!=
literal|7
condition|)
name|write_back_long
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp16_opc81_word_RM_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint16_t
name|destval
decl_stmt|,
name|imm
decl_stmt|;
comment|/*          * Weirdo special case instruction format.  Part of the opcode          * held below in "RH".  Doubly nested case would result, except          * that the decoded instruction          */
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|decode_and_fetch_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|imm
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
call|(
modifier|*
name|opc81_word_operation
index|[
name|emu
operator|->
name|cur_rh
index|]
call|)
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
name|imm
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_rh
operator|!=
literal|7
condition|)
name|write_back_word
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp_opc81_word_RM_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|x86emuOp32_opc81_word_RM_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
else|else
name|x86emuOp16_opc81_word_RM_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
specifier|static
name|uint8_t
argument_list|(
argument|* const opc82_byte_operation[]
argument_list|)
operator|(
expr|struct
name|x86emu
operator|*
operator|,
name|uint8_t
name|s
operator|,
name|uint8_t
name|d
operator|)
operator|=
block|{
name|add_byte
block|,
comment|/* 00 */
name|or_byte
block|,
comment|/* 01 */
comment|/* YYY UNUSED ???? */
name|adc_byte
block|,
comment|/* 02 */
name|sbb_byte
block|,
comment|/* 03 */
name|and_byte
block|,
comment|/* 04 */
comment|/* YYY UNUSED ???? */
name|sub_byte
block|,
comment|/* 05 */
name|xor_byte
block|,
comment|/* 06 */
comment|/* YYY UNUSED ???? */
name|cmp_byte
block|,
comment|/* 07 */
block|}
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x82  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_opc82_byte_RM_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint8_t
name|imm
decl_stmt|,
name|destval
decl_stmt|;
comment|/*          * Weirdo special case instruction format.  Part of the opcode          * held below in "RH".  Doubly nested case would result, except          * that the decoded instruction Similar to opcode 81, except that          * the immediate byte is sign extended to a word length.          */
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|decode_and_fetch_byte
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|imm
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
call|(
modifier|*
name|opc82_byte_operation
index|[
name|emu
operator|->
name|cur_rh
index|]
call|)
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
name|imm
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_rh
operator|!=
literal|7
condition|)
name|write_back_byte
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
specifier|static
name|uint16_t
argument_list|(
argument|* const opc83_word_operation[]
argument_list|)
operator|(
expr|struct
name|x86emu
operator|*
operator|,
name|uint16_t
name|s
operator|,
name|uint16_t
name|d
operator|)
operator|=
block|{
name|add_word
block|,
comment|/* 00 */
name|or_word
block|,
comment|/* 01 */
comment|/* YYY UNUSED ???? */
name|adc_word
block|,
comment|/* 02 */
name|sbb_word
block|,
comment|/* 03 */
name|and_word
block|,
comment|/* 04 */
comment|/* YYY UNUSED ???? */
name|sub_word
block|,
comment|/* 05 */
name|xor_word
block|,
comment|/* 06 */
comment|/* YYY UNUSED ???? */
name|cmp_word
block|,
comment|/* 07 */
block|}
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|uint32_t
argument_list|(
argument|* const opc83_long_operation[]
argument_list|)
operator|(
expr|struct
name|x86emu
operator|*
operator|,
name|uint32_t
name|s
operator|,
name|uint32_t
name|d
operator|)
operator|=
block|{
name|add_long
block|,
comment|/* 00 */
name|or_long
block|,
comment|/* 01 */
comment|/* YYY UNUSED ???? */
name|adc_long
block|,
comment|/* 02 */
name|sbb_long
block|,
comment|/* 03 */
name|and_long
block|,
comment|/* 04 */
comment|/* YYY UNUSED ???? */
name|sub_long
block|,
comment|/* 05 */
name|xor_long
block|,
comment|/* 06 */
comment|/* YYY UNUSED ???? */
name|cmp_long
block|,
comment|/* 07 */
block|}
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x83  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp32_opc83_word_RM_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|destval
decl_stmt|,
name|imm
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|decode_and_fetch_long
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|imm
operator|=
operator|(
name|int8_t
operator|)
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
call|(
modifier|*
name|opc83_long_operation
index|[
name|emu
operator|->
name|cur_rh
index|]
call|)
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
name|imm
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_rh
operator|!=
literal|7
condition|)
name|write_back_long
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp16_opc83_word_RM_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint16_t
name|destval
decl_stmt|,
name|imm
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|decode_and_fetch_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|imm
operator|=
operator|(
name|int8_t
operator|)
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
call|(
modifier|*
name|opc83_word_operation
index|[
name|emu
operator|->
name|cur_rh
index|]
call|)
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
name|imm
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_rh
operator|!=
literal|7
condition|)
name|write_back_word
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp_opc83_word_RM_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|x86emuOp32_opc83_word_RM_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
else|else
name|x86emuOp16_opc83_word_RM_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x86  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_xchg_byte_RM_R
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint8_t
modifier|*
name|srcreg
decl_stmt|,
name|destval
decl_stmt|,
name|tmp
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|decode_and_fetch_byte
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcreg
operator|=
name|decode_rh_byte_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|destval
expr_stmt|;
name|destval
operator|=
operator|*
name|srcreg
expr_stmt|;
operator|*
name|srcreg
operator|=
name|tmp
expr_stmt|;
name|write_back_byte
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x87  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp32_xchg_word_RM_R
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
modifier|*
name|srcreg
decl_stmt|,
name|destval
decl_stmt|,
name|tmp
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|decode_and_fetch_long
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcreg
operator|=
name|decode_rh_long_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|destval
expr_stmt|;
name|destval
operator|=
operator|*
name|srcreg
expr_stmt|;
operator|*
name|srcreg
operator|=
name|tmp
expr_stmt|;
name|write_back_long
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp16_xchg_word_RM_R
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint16_t
modifier|*
name|srcreg
decl_stmt|,
name|destval
decl_stmt|,
name|tmp
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|decode_and_fetch_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcreg
operator|=
name|decode_rh_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|destval
expr_stmt|;
name|destval
operator|=
operator|*
name|srcreg
expr_stmt|;
operator|*
name|srcreg
operator|=
name|tmp
expr_stmt|;
name|write_back_word
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp_xchg_word_RM_R
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|x86emuOp32_xchg_word_RM_R
argument_list|(
name|emu
argument_list|)
expr_stmt|;
else|else
name|x86emuOp16_xchg_word_RM_R
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x88  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_mov_byte_RM_R
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint8_t
modifier|*
name|destreg
decl_stmt|,
modifier|*
name|srcreg
decl_stmt|;
name|uint32_t
name|destoffset
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcreg
operator|=
name|decode_rh_byte_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|destoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|store_data_byte
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|,
operator|*
name|srcreg
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|destreg
operator|=
name|decode_rl_byte_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|destreg
operator|=
operator|*
name|srcreg
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x89  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp32_mov_word_RM_R
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|destoffset
decl_stmt|;
name|uint32_t
modifier|*
name|destreg
decl_stmt|,
name|srcval
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
operator|*
name|decode_rh_long_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|destoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|store_data_long
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|destreg
operator|=
name|decode_rl_long_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|destreg
operator|=
name|srcval
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp16_mov_word_RM_R
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|destoffset
decl_stmt|;
name|uint16_t
modifier|*
name|destreg
decl_stmt|,
name|srcval
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
operator|*
name|decode_rh_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|destoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|store_data_word
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|destreg
operator|=
name|decode_rl_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|destreg
operator|=
name|srcval
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp_mov_word_RM_R
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|x86emuOp32_mov_word_RM_R
argument_list|(
name|emu
argument_list|)
expr_stmt|;
else|else
name|x86emuOp16_mov_word_RM_R
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x8a  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_mov_byte_R_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint8_t
modifier|*
name|destreg
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destreg
operator|=
name|decode_rh_byte_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|destreg
operator|=
name|decode_and_fetch_byte
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x8b  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_mov_word_R_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|uint32_t
modifier|*
name|destreg
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destreg
operator|=
name|decode_rh_long_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|destreg
operator|=
name|decode_and_fetch_long
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|uint16_t
modifier|*
name|destreg
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destreg
operator|=
name|decode_rh_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|destreg
operator|=
name|decode_and_fetch_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x8c  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_mov_word_RM_SR
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint16_t
modifier|*
name|destreg
decl_stmt|,
name|srcval
decl_stmt|;
name|uint32_t
name|destoffset
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
operator|*
name|decode_rh_seg_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|destoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|store_data_word
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|destreg
operator|=
name|decode_rl_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|destreg
operator|=
name|srcval
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x8d  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_lea_word_R_M
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|destoffset
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|==
literal|3
condition|)
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_ADDR
condition|)
block|{
name|uint32_t
modifier|*
name|srcreg
decl_stmt|;
name|srcreg
operator|=
name|decode_rh_long_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|srcreg
operator|=
operator|(
name|uint32_t
operator|)
name|destoffset
expr_stmt|;
block|}
else|else
block|{
name|uint16_t
modifier|*
name|srcreg
decl_stmt|;
name|srcreg
operator|=
name|decode_rh_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|srcreg
operator|=
operator|(
name|uint16_t
operator|)
name|destoffset
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x8e  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_mov_word_SR_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint16_t
modifier|*
name|destreg
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destreg
operator|=
name|decode_rh_seg_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|destreg
operator|=
name|decode_and_fetch_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
comment|/*          * Clean up, and reset all the R_xSP pointers to the correct          * locations.  This is about 3x too much overhead (doing all the          * segreg ptrs when only one is needed, but this instruction          * *cannot* be that common, and this isn't too much work anyway.          */
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x8f  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp32_pop_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|destoffset
decl_stmt|;
name|uint32_t
name|destval
decl_stmt|,
modifier|*
name|destreg
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|destoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|pop_long
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|store_data_long
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|,
name|destval
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|destreg
operator|=
name|decode_rl_long_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|destreg
operator|=
name|pop_long
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp16_pop_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|destoffset
decl_stmt|;
name|uint16_t
name|destval
decl_stmt|,
modifier|*
name|destreg
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|destoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|pop_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|store_data_word
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|,
name|destval
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|destreg
operator|=
name|decode_rl_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|destreg
operator|=
name|pop_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp_pop_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|x86emuOp32_pop_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
else|else
name|x86emuOp16_pop_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x91  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_xchg_word_AX_CX
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|tmp
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EAX
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_ECX
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_ECX
operator|=
name|tmp
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_AX
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_CX
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|=
operator|(
name|uint16_t
operator|)
name|tmp
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x92  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_xchg_word_AX_DX
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|tmp
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EAX
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EDX
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EDX
operator|=
name|tmp
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_AX
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_DX
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_DX
operator|=
operator|(
name|uint16_t
operator|)
name|tmp
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x93  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_xchg_word_AX_BX
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|tmp
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EAX
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EBX
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EBX
operator|=
name|tmp
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_AX
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_BX
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_BX
operator|=
operator|(
name|uint16_t
operator|)
name|tmp
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x94  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_xchg_word_AX_SP
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|tmp
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EAX
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_ESP
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_ESP
operator|=
name|tmp
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_AX
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_SP
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_SP
operator|=
operator|(
name|uint16_t
operator|)
name|tmp
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x95  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_xchg_word_AX_BP
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|tmp
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EAX
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EBP
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EBP
operator|=
name|tmp
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_AX
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_BP
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_BP
operator|=
operator|(
name|uint16_t
operator|)
name|tmp
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x96  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_xchg_word_AX_SI
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|tmp
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EAX
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_ESI
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_ESI
operator|=
name|tmp
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_AX
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_SI
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_SI
operator|=
operator|(
name|uint16_t
operator|)
name|tmp
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x97  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_xchg_word_AX_DI
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|tmp
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EAX
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EDI
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EDI
operator|=
name|tmp
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_AX
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_DI
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_DI
operator|=
operator|(
name|uint16_t
operator|)
name|tmp
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x98  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_cbw
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|&
literal|0x8000
condition|)
block|{
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator||=
literal|0xffff0000
expr_stmt|;
block|}
else|else
block|{
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|&=
literal|0x0000ffff
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|R_AL
operator|&
literal|0x80
condition|)
block|{
name|emu
operator|->
name|x86
operator|.
name|R_AH
operator|=
literal|0xff
expr_stmt|;
block|}
else|else
block|{
name|emu
operator|->
name|x86
operator|.
name|R_AH
operator|=
literal|0x0
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x99  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_cwd
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|&
literal|0x80000000
condition|)
block|{
name|emu
operator|->
name|x86
operator|.
name|R_EDX
operator|=
literal|0xffffffff
expr_stmt|;
block|}
else|else
block|{
name|emu
operator|->
name|x86
operator|.
name|R_EDX
operator|=
literal|0x0
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|&
literal|0x8000
condition|)
block|{
name|emu
operator|->
name|x86
operator|.
name|R_DX
operator|=
literal|0xffff
expr_stmt|;
block|}
else|else
block|{
name|emu
operator|->
name|x86
operator|.
name|R_DX
operator|=
literal|0x0
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x9a  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_call_far_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint16_t
name|farseg
decl_stmt|,
name|faroff
decl_stmt|;
name|faroff
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|farseg
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
comment|/* XXX 	 *  	 * Hooked interrupt vectors calling into our "BIOS" will cause problems 	 * unless all intersegment stuff is checked for BIOS access.  Check 	 * needed here.  For moment, let it alone. */
name|push_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_CS
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_CS
operator|=
name|farseg
expr_stmt|;
name|push_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_IP
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|=
name|faroff
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x9c  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_pushf_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|flags
decl_stmt|;
comment|/* clear out *all* bits not representing flags, and turn on real bits */
name|flags
operator|=
operator|(
name|emu
operator|->
name|x86
operator|.
name|R_EFLG
operator|&
name|F_MSK
operator|)
operator||
name|F_ALWAYS_ON
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|push_long
argument_list|(
name|emu
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|push_word
argument_list|(
name|emu
argument_list|,
operator|(
name|uint16_t
operator|)
name|flags
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x9d  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_popf_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|emu
operator|->
name|x86
operator|.
name|R_EFLG
operator|=
name|pop_long
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|emu
operator|->
name|x86
operator|.
name|R_FLG
operator|=
name|pop_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x9e  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_sahf
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
comment|/* clear the lower bits of the flag register */
name|emu
operator|->
name|x86
operator|.
name|R_FLG
operator|&=
literal|0xffffff00
expr_stmt|;
comment|/* or in the AH register into the flags register */
name|emu
operator|->
name|x86
operator|.
name|R_FLG
operator||=
name|emu
operator|->
name|x86
operator|.
name|R_AH
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x9f  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_lahf
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|emu
operator|->
name|x86
operator|.
name|R_AH
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|emu
operator|->
name|x86
operator|.
name|R_FLG
operator|&
literal|0xff
argument_list|)
expr_stmt|;
comment|/* undocumented TC++ behavior??? Nope.  It's documented, but you have 	 * too look real hard to notice it. */
name|emu
operator|->
name|x86
operator|.
name|R_AH
operator||=
literal|0x2
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xa0  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_mov_AL_M_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint16_t
name|offset
decl_stmt|;
name|offset
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_AL
operator|=
name|fetch_data_byte
argument_list|(
name|emu
argument_list|,
name|offset
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xa1  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_mov_AX_M_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint16_t
name|offset
decl_stmt|;
name|offset
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|=
name|fetch_data_long
argument_list|(
name|emu
argument_list|,
name|offset
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|=
name|fetch_data_word
argument_list|(
name|emu
argument_list|,
name|offset
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xa2  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_mov_M_AL_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint16_t
name|offset
decl_stmt|;
name|offset
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|store_data_byte
argument_list|(
name|emu
argument_list|,
name|offset
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xa3  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_mov_M_AX_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint16_t
name|offset
decl_stmt|;
name|offset
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|store_data_long
argument_list|(
name|emu
argument_list|,
name|offset
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_EAX
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|store_data_word
argument_list|(
name|emu
argument_list|,
name|offset
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AX
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xa4  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_movs_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint8_t
name|val
decl_stmt|;
name|uint32_t
name|count
decl_stmt|;
name|int
name|inc
decl_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_DF
argument_list|)
condition|)
comment|/* down */
name|inc
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|inc
operator|=
literal|1
expr_stmt|;
name|count
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
operator|(
name|SYSMODE_PREFIX_REPE
operator||
name|SYSMODE_PREFIX_REPNE
operator|)
condition|)
block|{
comment|/* dont care whether REPE or REPNE */
comment|/* move them until CX is ZERO. */
name|count
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_CX
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|=
literal|0
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&=
operator|~
operator|(
name|SYSMODE_PREFIX_REPE
operator||
name|SYSMODE_PREFIX_REPNE
operator|)
expr_stmt|;
block|}
while|while
condition|(
name|count
operator|--
condition|)
block|{
name|val
operator|=
name|fetch_data_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SI
argument_list|)
expr_stmt|;
name|store_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_SI
operator|+=
name|inc
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_DI
operator|+=
name|inc
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xa5  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_movs_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|int
name|inc
decl_stmt|;
name|uint32_t
name|count
decl_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|inc
operator|=
literal|4
expr_stmt|;
else|else
name|inc
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_DF
argument_list|)
condition|)
comment|/* down */
name|inc
operator|=
operator|-
name|inc
expr_stmt|;
name|count
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
operator|(
name|SYSMODE_PREFIX_REPE
operator||
name|SYSMODE_PREFIX_REPNE
operator|)
condition|)
block|{
comment|/* dont care whether REPE or REPNE */
comment|/* move them until CX is ZERO. */
name|count
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_CX
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|=
literal|0
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&=
operator|~
operator|(
name|SYSMODE_PREFIX_REPE
operator||
name|SYSMODE_PREFIX_REPNE
operator|)
expr_stmt|;
block|}
while|while
condition|(
name|count
operator|--
condition|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|val
operator|=
name|fetch_data_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SI
argument_list|)
expr_stmt|;
name|store_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|val
operator|=
name|fetch_data_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SI
argument_list|)
expr_stmt|;
name|store_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|,
operator|(
name|uint16_t
operator|)
name|val
argument_list|)
expr_stmt|;
block|}
name|emu
operator|->
name|x86
operator|.
name|R_SI
operator|+=
name|inc
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_DI
operator|+=
name|inc
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xa6  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_cmps_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|int8_t
name|val1
decl_stmt|,
name|val2
decl_stmt|;
name|int
name|inc
decl_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_DF
argument_list|)
condition|)
comment|/* down */
name|inc
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|inc
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_REPE
condition|)
block|{
comment|/* REPE  */
comment|/* move them until CX is ZERO. */
while|while
condition|(
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|!=
literal|0
condition|)
block|{
name|val1
operator|=
name|fetch_data_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SI
argument_list|)
expr_stmt|;
name|val2
operator|=
name|fetch_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|)
expr_stmt|;
name|cmp_byte
argument_list|(
name|emu
argument_list|,
name|val1
argument_list|,
name|val2
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|-=
literal|1
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_SI
operator|+=
name|inc
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_DI
operator|+=
name|inc
expr_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&=
operator|~
name|SYSMODE_PREFIX_REPE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_REPNE
condition|)
block|{
comment|/* REPNE  */
comment|/* move them until CX is ZERO. */
while|while
condition|(
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|!=
literal|0
condition|)
block|{
name|val1
operator|=
name|fetch_data_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SI
argument_list|)
expr_stmt|;
name|val2
operator|=
name|fetch_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|)
expr_stmt|;
name|cmp_byte
argument_list|(
name|emu
argument_list|,
name|val1
argument_list|,
name|val2
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|-=
literal|1
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_SI
operator|+=
name|inc
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_DI
operator|+=
name|inc
expr_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
condition|)
break|break;
comment|/* zero flag set means equal */
block|}
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&=
operator|~
name|SYSMODE_PREFIX_REPNE
expr_stmt|;
block|}
else|else
block|{
name|val1
operator|=
name|fetch_data_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SI
argument_list|)
expr_stmt|;
name|val2
operator|=
name|fetch_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|)
expr_stmt|;
name|cmp_byte
argument_list|(
name|emu
argument_list|,
name|val1
argument_list|,
name|val2
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_SI
operator|+=
name|inc
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_DI
operator|+=
name|inc
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xa7  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_cmps_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|val1
decl_stmt|,
name|val2
decl_stmt|;
name|int
name|inc
decl_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_DF
argument_list|)
condition|)
comment|/* down */
name|inc
operator|=
operator|-
literal|4
expr_stmt|;
else|else
name|inc
operator|=
literal|4
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_DF
argument_list|)
condition|)
comment|/* down */
name|inc
operator|=
operator|-
literal|2
expr_stmt|;
else|else
name|inc
operator|=
literal|2
expr_stmt|;
block|}
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_REPE
condition|)
block|{
comment|/* REPE  */
comment|/* move them until CX is ZERO. */
while|while
condition|(
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|val1
operator|=
name|fetch_data_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SI
argument_list|)
expr_stmt|;
name|val2
operator|=
name|fetch_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|)
expr_stmt|;
name|cmp_long
argument_list|(
name|emu
argument_list|,
name|val1
argument_list|,
name|val2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|val1
operator|=
name|fetch_data_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SI
argument_list|)
expr_stmt|;
name|val2
operator|=
name|fetch_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|)
expr_stmt|;
name|cmp_word
argument_list|(
name|emu
argument_list|,
operator|(
name|uint16_t
operator|)
name|val1
argument_list|,
operator|(
name|uint16_t
operator|)
name|val2
argument_list|)
expr_stmt|;
block|}
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|-=
literal|1
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_SI
operator|+=
name|inc
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_DI
operator|+=
name|inc
expr_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&=
operator|~
name|SYSMODE_PREFIX_REPE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_REPNE
condition|)
block|{
comment|/* REPNE  */
comment|/* move them until CX is ZERO. */
while|while
condition|(
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|val1
operator|=
name|fetch_data_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SI
argument_list|)
expr_stmt|;
name|val2
operator|=
name|fetch_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|)
expr_stmt|;
name|cmp_long
argument_list|(
name|emu
argument_list|,
name|val1
argument_list|,
name|val2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|val1
operator|=
name|fetch_data_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SI
argument_list|)
expr_stmt|;
name|val2
operator|=
name|fetch_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|)
expr_stmt|;
name|cmp_word
argument_list|(
name|emu
argument_list|,
operator|(
name|uint16_t
operator|)
name|val1
argument_list|,
operator|(
name|uint16_t
operator|)
name|val2
argument_list|)
expr_stmt|;
block|}
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|-=
literal|1
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_SI
operator|+=
name|inc
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_DI
operator|+=
name|inc
expr_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
condition|)
break|break;
comment|/* zero flag set means equal */
block|}
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&=
operator|~
name|SYSMODE_PREFIX_REPNE
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|val1
operator|=
name|fetch_data_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SI
argument_list|)
expr_stmt|;
name|val2
operator|=
name|fetch_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|)
expr_stmt|;
name|cmp_long
argument_list|(
name|emu
argument_list|,
name|val1
argument_list|,
name|val2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|val1
operator|=
name|fetch_data_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SI
argument_list|)
expr_stmt|;
name|val2
operator|=
name|fetch_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|)
expr_stmt|;
name|cmp_word
argument_list|(
name|emu
argument_list|,
operator|(
name|uint16_t
operator|)
name|val1
argument_list|,
operator|(
name|uint16_t
operator|)
name|val2
argument_list|)
expr_stmt|;
block|}
name|emu
operator|->
name|x86
operator|.
name|R_SI
operator|+=
name|inc
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_DI
operator|+=
name|inc
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xa9  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_test_AX_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|test_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_EAX
argument_list|,
name|fetch_long_imm
argument_list|(
name|emu
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|test_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AX
argument_list|,
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xaa  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_stos_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|int
name|inc
decl_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_DF
argument_list|)
condition|)
comment|/* down */
name|inc
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|inc
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
operator|(
name|SYSMODE_PREFIX_REPE
operator||
name|SYSMODE_PREFIX_REPNE
operator|)
condition|)
block|{
comment|/* dont care whether REPE or REPNE */
comment|/* move them until CX is ZERO. */
while|while
condition|(
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|!=
literal|0
condition|)
block|{
name|store_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AL
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|-=
literal|1
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_DI
operator|+=
name|inc
expr_stmt|;
block|}
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&=
operator|~
operator|(
name|SYSMODE_PREFIX_REPE
operator||
name|SYSMODE_PREFIX_REPNE
operator|)
expr_stmt|;
block|}
else|else
block|{
name|store_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AL
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_DI
operator|+=
name|inc
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xab  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_stos_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|int
name|inc
decl_stmt|;
name|uint32_t
name|count
decl_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|inc
operator|=
literal|4
expr_stmt|;
else|else
name|inc
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_DF
argument_list|)
condition|)
comment|/* down */
name|inc
operator|=
operator|-
name|inc
expr_stmt|;
name|count
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
operator|(
name|SYSMODE_PREFIX_REPE
operator||
name|SYSMODE_PREFIX_REPNE
operator|)
condition|)
block|{
comment|/* dont care whether REPE or REPNE */
comment|/* move them until CX is ZERO. */
name|count
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_CX
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|=
literal|0
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&=
operator|~
operator|(
name|SYSMODE_PREFIX_REPE
operator||
name|SYSMODE_PREFIX_REPNE
operator|)
expr_stmt|;
block|}
while|while
condition|(
name|count
operator|--
condition|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|store_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_EAX
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|store_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AX
argument_list|)
expr_stmt|;
block|}
name|emu
operator|->
name|x86
operator|.
name|R_DI
operator|+=
name|inc
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xac  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_lods_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|int
name|inc
decl_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_DF
argument_list|)
condition|)
comment|/* down */
name|inc
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|inc
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
operator|(
name|SYSMODE_PREFIX_REPE
operator||
name|SYSMODE_PREFIX_REPNE
operator|)
condition|)
block|{
comment|/* dont care whether REPE or REPNE */
comment|/* move them until CX is ZERO. */
while|while
condition|(
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|!=
literal|0
condition|)
block|{
name|emu
operator|->
name|x86
operator|.
name|R_AL
operator|=
name|fetch_data_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SI
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|-=
literal|1
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_SI
operator|+=
name|inc
expr_stmt|;
block|}
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&=
operator|~
operator|(
name|SYSMODE_PREFIX_REPE
operator||
name|SYSMODE_PREFIX_REPNE
operator|)
expr_stmt|;
block|}
else|else
block|{
name|emu
operator|->
name|x86
operator|.
name|R_AL
operator|=
name|fetch_data_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SI
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_SI
operator|+=
name|inc
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xad  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_lods_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|int
name|inc
decl_stmt|;
name|uint32_t
name|count
decl_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|inc
operator|=
literal|4
expr_stmt|;
else|else
name|inc
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_DF
argument_list|)
condition|)
comment|/* down */
name|inc
operator|=
operator|-
name|inc
expr_stmt|;
name|count
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
operator|(
name|SYSMODE_PREFIX_REPE
operator||
name|SYSMODE_PREFIX_REPNE
operator|)
condition|)
block|{
comment|/* dont care whether REPE or REPNE */
comment|/* move them until CX is ZERO. */
name|count
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_CX
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|=
literal|0
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&=
operator|~
operator|(
name|SYSMODE_PREFIX_REPE
operator||
name|SYSMODE_PREFIX_REPNE
operator|)
expr_stmt|;
block|}
while|while
condition|(
name|count
operator|--
condition|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|=
name|fetch_data_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SI
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|=
name|fetch_data_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SI
argument_list|)
expr_stmt|;
block|}
name|emu
operator|->
name|x86
operator|.
name|R_SI
operator|+=
name|inc
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xae  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_scas_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|int8_t
name|val2
decl_stmt|;
name|int
name|inc
decl_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_DF
argument_list|)
condition|)
comment|/* down */
name|inc
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|inc
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_REPE
condition|)
block|{
comment|/* REPE  */
comment|/* move them until CX is ZERO. */
while|while
condition|(
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|!=
literal|0
condition|)
block|{
name|val2
operator|=
name|fetch_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|)
expr_stmt|;
name|cmp_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AL
argument_list|,
name|val2
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|-=
literal|1
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_DI
operator|+=
name|inc
expr_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&=
operator|~
name|SYSMODE_PREFIX_REPE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_REPNE
condition|)
block|{
comment|/* REPNE  */
comment|/* move them until CX is ZERO. */
while|while
condition|(
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|!=
literal|0
condition|)
block|{
name|val2
operator|=
name|fetch_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|)
expr_stmt|;
name|cmp_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AL
argument_list|,
name|val2
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|-=
literal|1
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_DI
operator|+=
name|inc
expr_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
condition|)
break|break;
comment|/* zero flag set means equal */
block|}
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&=
operator|~
name|SYSMODE_PREFIX_REPNE
expr_stmt|;
block|}
else|else
block|{
name|val2
operator|=
name|fetch_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|)
expr_stmt|;
name|cmp_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AL
argument_list|,
name|val2
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_DI
operator|+=
name|inc
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xaf  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_scas_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|int
name|inc
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|inc
operator|=
literal|4
expr_stmt|;
else|else
name|inc
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_DF
argument_list|)
condition|)
comment|/* down */
name|inc
operator|=
operator|-
name|inc
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_REPE
condition|)
block|{
comment|/* REPE  */
comment|/* move them until CX is ZERO. */
while|while
condition|(
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|val
operator|=
name|fetch_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|)
expr_stmt|;
name|cmp_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_EAX
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|val
operator|=
name|fetch_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|)
expr_stmt|;
name|cmp_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AX
argument_list|,
operator|(
name|uint16_t
operator|)
name|val
argument_list|)
expr_stmt|;
block|}
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|-=
literal|1
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_DI
operator|+=
name|inc
expr_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&=
operator|~
name|SYSMODE_PREFIX_REPE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_REPNE
condition|)
block|{
comment|/* REPNE  */
comment|/* move them until CX is ZERO. */
while|while
condition|(
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|val
operator|=
name|fetch_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|)
expr_stmt|;
name|cmp_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_EAX
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|val
operator|=
name|fetch_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|)
expr_stmt|;
name|cmp_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AX
argument_list|,
operator|(
name|uint16_t
operator|)
name|val
argument_list|)
expr_stmt|;
block|}
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|-=
literal|1
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_DI
operator|+=
name|inc
expr_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
condition|)
break|break;
comment|/* zero flag set means equal */
block|}
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&=
operator|~
name|SYSMODE_PREFIX_REPNE
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|val
operator|=
name|fetch_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|)
expr_stmt|;
name|cmp_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_EAX
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|val
operator|=
name|fetch_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|)
expr_stmt|;
name|cmp_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AX
argument_list|,
operator|(
name|uint16_t
operator|)
name|val
argument_list|)
expr_stmt|;
block|}
name|emu
operator|->
name|x86
operator|.
name|R_DI
operator|+=
name|inc
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xb8  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_mov_word_AX_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|=
name|fetch_long_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
else|else
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xb9  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_mov_word_CX_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|emu
operator|->
name|x86
operator|.
name|R_ECX
operator|=
name|fetch_long_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
else|else
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xba  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_mov_word_DX_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|emu
operator|->
name|x86
operator|.
name|R_EDX
operator|=
name|fetch_long_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
else|else
name|emu
operator|->
name|x86
operator|.
name|R_DX
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xbb  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_mov_word_BX_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|emu
operator|->
name|x86
operator|.
name|R_EBX
operator|=
name|fetch_long_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
else|else
name|emu
operator|->
name|x86
operator|.
name|R_BX
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xbc  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_mov_word_SP_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|emu
operator|->
name|x86
operator|.
name|R_ESP
operator|=
name|fetch_long_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
else|else
name|emu
operator|->
name|x86
operator|.
name|R_SP
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xbd  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_mov_word_BP_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|emu
operator|->
name|x86
operator|.
name|R_EBP
operator|=
name|fetch_long_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
else|else
name|emu
operator|->
name|x86
operator|.
name|R_BP
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xbe  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_mov_word_SI_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|emu
operator|->
name|x86
operator|.
name|R_ESI
operator|=
name|fetch_long_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
else|else
name|emu
operator|->
name|x86
operator|.
name|R_SI
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xbf  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_mov_word_DI_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|emu
operator|->
name|x86
operator|.
name|R_EDI
operator|=
name|fetch_long_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
else|else
name|emu
operator|->
name|x86
operator|.
name|R_DI
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* used by opcodes c0, d0, and d2. */
end_comment

begin_expr_stmt
specifier|static
name|uint8_t
argument_list|(
argument|* const opcD0_byte_operation[]
argument_list|)
operator|(
expr|struct
name|x86emu
operator|*
operator|,
name|uint8_t
name|d
operator|,
name|uint8_t
name|s
operator|)
operator|=
block|{
name|rol_byte
block|,
name|ror_byte
block|,
name|rcl_byte
block|,
name|rcr_byte
block|,
name|shl_byte
block|,
name|shr_byte
block|,
name|shl_byte
block|,
comment|/* sal_byte === shl_byte  by definition */
name|sar_byte
block|, }
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xc0  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_opcC0_byte_RM_MEM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint8_t
name|destval
decl_stmt|,
name|amt
decl_stmt|;
comment|/*          * Yet another weirdo special case instruction format.  Part of          * the opcode held below in "RH".  Doubly nested case would          * result, except that the decoded instruction          */
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
comment|/* know operation, decode the mod byte to find the addressing mode. */
name|destval
operator|=
name|decode_and_fetch_byte_imm8
argument_list|(
name|emu
argument_list|,
operator|&
name|amt
argument_list|)
expr_stmt|;
name|destval
operator|=
call|(
modifier|*
name|opcD0_byte_operation
index|[
name|emu
operator|->
name|cur_rh
index|]
call|)
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
name|amt
argument_list|)
expr_stmt|;
name|write_back_byte
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* used by opcodes c1, d1, and d3. */
end_comment

begin_expr_stmt
specifier|static
name|uint16_t
argument_list|(
argument|* const opcD1_word_operation[]
argument_list|)
operator|(
expr|struct
name|x86emu
operator|*
operator|,
name|uint16_t
name|s
operator|,
name|uint8_t
name|d
operator|)
operator|=
block|{
name|rol_word
block|,
name|ror_word
block|,
name|rcl_word
block|,
name|rcr_word
block|,
name|shl_word
block|,
name|shr_word
block|,
name|shl_word
block|,
comment|/* sal_byte === shl_byte  by definition */
name|sar_word
block|, }
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* used by opcodes c1, d1, and d3. */
end_comment

begin_expr_stmt
specifier|static
name|uint32_t
argument_list|(
argument|* const opcD1_long_operation[]
argument_list|)
operator|(
expr|struct
name|x86emu
operator|*
operator|,
name|uint32_t
name|s
operator|,
name|uint8_t
name|d
operator|)
operator|=
block|{
name|rol_long
block|,
name|ror_long
block|,
name|rcl_long
block|,
name|rcr_long
block|,
name|shl_long
block|,
name|shr_long
block|,
name|shl_long
block|,
comment|/* sal_byte === shl_byte  by definition */
name|sar_long
block|, }
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xc1  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_opcC1_word_RM_MEM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint8_t
name|amt
decl_stmt|;
comment|/*          * Yet another weirdo special case instruction format.  Part of          * the opcode held below in "RH".  Doubly nested case would          * result, except that the decoded instruction          */
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|uint32_t
name|destval
decl_stmt|;
name|destval
operator|=
name|decode_and_fetch_long_imm8
argument_list|(
name|emu
argument_list|,
operator|&
name|amt
argument_list|)
expr_stmt|;
name|destval
operator|=
call|(
modifier|*
name|opcD1_long_operation
index|[
name|emu
operator|->
name|cur_rh
index|]
call|)
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
name|amt
argument_list|)
expr_stmt|;
name|write_back_long
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|uint16_t
name|destval
decl_stmt|;
name|destval
operator|=
name|decode_and_fetch_word_imm8
argument_list|(
name|emu
argument_list|,
operator|&
name|amt
argument_list|)
expr_stmt|;
name|destval
operator|=
call|(
modifier|*
name|opcD1_word_operation
index|[
name|emu
operator|->
name|cur_rh
index|]
call|)
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
name|amt
argument_list|)
expr_stmt|;
name|write_back_word
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xc2  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_ret_near_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint16_t
name|imm
decl_stmt|;
name|imm
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|=
name|pop_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_SP
operator|+=
name|imm
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xc6  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_mov_byte_RM_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint8_t
modifier|*
name|destreg
decl_stmt|;
name|uint32_t
name|destoffset
decl_stmt|;
name|uint8_t
name|imm
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_rh
operator|!=
literal|0
condition|)
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|destoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|imm
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|store_data_byte
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|,
name|imm
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|destreg
operator|=
name|decode_rl_byte_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|imm
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|destreg
operator|=
name|imm
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xc7  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp32_mov_word_RM_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|destoffset
decl_stmt|;
name|uint32_t
name|imm
decl_stmt|,
modifier|*
name|destreg
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_rh
operator|!=
literal|0
condition|)
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|destoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|imm
operator|=
name|fetch_long_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|store_data_long
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|,
name|imm
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|destreg
operator|=
name|decode_rl_long_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|imm
operator|=
name|fetch_long_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|destreg
operator|=
name|imm
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp16_mov_word_RM_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|destoffset
decl_stmt|;
name|uint16_t
name|imm
decl_stmt|,
modifier|*
name|destreg
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_rh
operator|!=
literal|0
condition|)
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|destoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|imm
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|store_data_word
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|,
name|imm
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|destreg
operator|=
name|decode_rl_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|imm
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|destreg
operator|=
name|imm
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp_mov_word_RM_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|x86emuOp32_mov_word_RM_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
else|else
name|x86emuOp16_mov_word_RM_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xc8  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_enter
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint16_t
name|local
decl_stmt|,
name|frame_pointer
decl_stmt|;
name|uint8_t
name|nesting
decl_stmt|;
name|int
name|i
decl_stmt|;
name|local
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|nesting
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|push_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_BP
argument_list|)
expr_stmt|;
name|frame_pointer
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_SP
expr_stmt|;
if|if
condition|(
name|nesting
operator|>
literal|0
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|nesting
condition|;
name|i
operator|++
control|)
block|{
name|emu
operator|->
name|x86
operator|.
name|R_BP
operator|-=
literal|2
expr_stmt|;
name|push_word
argument_list|(
name|emu
argument_list|,
name|fetch_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SS
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_BP
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|push_word
argument_list|(
name|emu
argument_list|,
name|frame_pointer
argument_list|)
expr_stmt|;
block|}
name|emu
operator|->
name|x86
operator|.
name|R_BP
operator|=
name|frame_pointer
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_SP
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|emu
operator|->
name|x86
operator|.
name|R_SP
operator|-
name|local
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xc9  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_leave
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|emu
operator|->
name|x86
operator|.
name|R_SP
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_BP
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_BP
operator|=
name|pop_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xca  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_ret_far_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint16_t
name|imm
decl_stmt|;
name|imm
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|=
name|pop_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_CS
operator|=
name|pop_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_SP
operator|+=
name|imm
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xcb  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_ret_far
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|=
name|pop_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_CS
operator|=
name|pop_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xcc  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_int3
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|x86emu_intr_dispatch
argument_list|(
name|emu
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xcd  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_int_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint8_t
name|intnum
decl_stmt|;
name|intnum
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|x86emu_intr_dispatch
argument_list|(
name|emu
argument_list|,
name|intnum
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xce  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_into
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_OF
argument_list|)
condition|)
name|x86emu_intr_dispatch
argument_list|(
name|emu
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xcf  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_iret
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|=
name|pop_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_CS
operator|=
name|pop_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_FLG
operator|=
name|pop_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xd0  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_opcD0_byte_RM_1
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint8_t
name|destval
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|decode_and_fetch_byte
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
call|(
modifier|*
name|opcD0_byte_operation
index|[
name|emu
operator|->
name|cur_rh
index|]
call|)
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|write_back_byte
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xd1  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_opcD1_word_RM_1
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|uint32_t
name|destval
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|decode_and_fetch_long
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
call|(
modifier|*
name|opcD1_long_operation
index|[
name|emu
operator|->
name|cur_rh
index|]
call|)
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|write_back_long
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|uint16_t
name|destval
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|decode_and_fetch_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
call|(
modifier|*
name|opcD1_word_operation
index|[
name|emu
operator|->
name|cur_rh
index|]
call|)
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|write_back_word
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xd2  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_opcD2_byte_RM_CL
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint8_t
name|destval
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|decode_and_fetch_byte
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
call|(
modifier|*
name|opcD0_byte_operation
index|[
name|emu
operator|->
name|cur_rh
index|]
call|)
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_CL
argument_list|)
expr_stmt|;
name|write_back_byte
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xd3  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_opcD3_word_RM_CL
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|uint32_t
name|destval
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|decode_and_fetch_long
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
call|(
modifier|*
name|opcD1_long_operation
index|[
name|emu
operator|->
name|cur_rh
index|]
call|)
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_CL
argument_list|)
expr_stmt|;
name|write_back_long
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|uint16_t
name|destval
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|decode_and_fetch_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
call|(
modifier|*
name|opcD1_word_operation
index|[
name|emu
operator|->
name|cur_rh
index|]
call|)
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_CL
argument_list|)
expr_stmt|;
name|write_back_word
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xd4  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_aam
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint8_t
name|a
decl_stmt|;
name|a
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
comment|/* this is a stupid encoding. */
if|if
condition|(
name|a
operator|!=
literal|10
condition|)
block|{
comment|/* fix: add base decoding aam_word(uint8_t val, int base a) */
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
comment|/* note the type change here --- returning AL and AH in AX. */
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|=
name|aam_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xd5  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_aad
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint8_t
name|a
decl_stmt|;
name|a
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|!=
literal|10
condition|)
block|{
comment|/* fix: add base decoding aad_word(uint16_t val, int base a) */
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|=
name|aad_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AX
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* opcode 0xd6 ILLEGAL OPCODE */
end_comment

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xd7  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_xlat
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint16_t
name|addr
decl_stmt|;
name|addr
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|emu
operator|->
name|x86
operator|.
name|R_BX
operator|+
operator|(
name|uint8_t
operator|)
name|emu
operator|->
name|x86
operator|.
name|R_AL
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_AL
operator|=
name|fetch_data_byte
argument_list|(
name|emu
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* opcode=0xd8 */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_esc_coprocess_d8
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{ }
end_function

begin_comment
comment|/* opcode=0xd9 */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_esc_coprocess_d9
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* opcode=0xda */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_esc_coprocess_da
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* opcode=0xdb */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_esc_coprocess_db
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* opcode=0xdc */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_esc_coprocess_dc
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* opcode=0xdd */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_esc_coprocess_dd
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* opcode=0xde */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_esc_coprocess_de
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* opcode=0xdf */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_esc_coprocess_df
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xe0  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_loopne
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|int16_t
name|ip
decl_stmt|;
name|ip
operator|=
operator|(
name|int8_t
operator|)
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|ip
operator|+=
operator|(
name|int16_t
operator|)
name|emu
operator|->
name|x86
operator|.
name|R_IP
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|-=
literal|1
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|!=
literal|0
operator|&&
operator|!
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
condition|)
comment|/* CX != 0 and !ZF */
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|=
name|ip
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xe1  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_loope
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|int16_t
name|ip
decl_stmt|;
name|ip
operator|=
operator|(
name|int8_t
operator|)
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|ip
operator|+=
operator|(
name|int16_t
operator|)
name|emu
operator|->
name|x86
operator|.
name|R_IP
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|-=
literal|1
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|!=
literal|0
operator|&&
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
condition|)
comment|/* CX != 0 and ZF */
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|=
name|ip
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xe2  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_loop
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|int16_t
name|ip
decl_stmt|;
name|ip
operator|=
operator|(
name|int8_t
operator|)
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|ip
operator|+=
operator|(
name|int16_t
operator|)
name|emu
operator|->
name|x86
operator|.
name|R_IP
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|-=
literal|1
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|!=
literal|0
condition|)
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|=
name|ip
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xe3  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_jcxz
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint16_t
name|target
decl_stmt|;
name|int8_t
name|offset
decl_stmt|;
comment|/* jump to byte offset if overflow flag is set */
name|offset
operator|=
operator|(
name|int8_t
operator|)
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|target
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|+
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|==
literal|0
condition|)
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|=
name|target
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xe4  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_in_byte_AL_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint8_t
name|port
decl_stmt|;
name|port
operator|=
operator|(
name|uint8_t
operator|)
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_AL
operator|=
call|(
modifier|*
name|emu
operator|->
name|emu_inb
call|)
argument_list|(
name|emu
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xe5  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_in_word_AX_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint8_t
name|port
decl_stmt|;
name|port
operator|=
operator|(
name|uint8_t
operator|)
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|=
call|(
modifier|*
name|emu
operator|->
name|emu_inl
call|)
argument_list|(
name|emu
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|=
call|(
modifier|*
name|emu
operator|->
name|emu_inw
call|)
argument_list|(
name|emu
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xe6  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_out_byte_IMM_AL
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint8_t
name|port
decl_stmt|;
name|port
operator|=
operator|(
name|uint8_t
operator|)
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
call|(
modifier|*
name|emu
operator|->
name|emu_outb
call|)
argument_list|(
name|emu
argument_list|,
name|port
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xe7  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_out_word_IMM_AX
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint8_t
name|port
decl_stmt|;
name|port
operator|=
operator|(
name|uint8_t
operator|)
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
call|(
modifier|*
name|emu
operator|->
name|emu_outl
call|)
argument_list|(
name|emu
argument_list|,
name|port
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_EAX
argument_list|)
expr_stmt|;
block|}
else|else
block|{
call|(
modifier|*
name|emu
operator|->
name|emu_outw
call|)
argument_list|(
name|emu
argument_list|,
name|port
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AX
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xe8  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_call_near_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|int32_t
name|ip
decl_stmt|;
name|ip
operator|=
operator|(
name|int32_t
operator|)
name|fetch_long_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|ip
operator|+=
operator|(
name|int32_t
operator|)
name|emu
operator|->
name|x86
operator|.
name|R_EIP
expr_stmt|;
name|push_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_EIP
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EIP
operator|=
name|ip
expr_stmt|;
block|}
else|else
block|{
name|int16_t
name|ip
decl_stmt|;
name|ip
operator|=
operator|(
name|int16_t
operator|)
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|ip
operator|+=
operator|(
name|int16_t
operator|)
name|emu
operator|->
name|x86
operator|.
name|R_IP
expr_stmt|;
comment|/* CHECK SIGN */
name|push_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_IP
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|=
name|ip
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xe9  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_jump_near_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|int
name|ip
decl_stmt|;
name|ip
operator|=
operator|(
name|int16_t
operator|)
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|ip
operator|+=
operator|(
name|int16_t
operator|)
name|emu
operator|->
name|x86
operator|.
name|R_IP
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|=
operator|(
name|uint16_t
operator|)
name|ip
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xea  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_jump_far_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint16_t
name|cs
decl_stmt|,
name|ip
decl_stmt|;
name|ip
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|cs
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|=
name|ip
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_CS
operator|=
name|cs
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xeb  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_jump_byte_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint16_t
name|target
decl_stmt|;
name|int8_t
name|offset
decl_stmt|;
name|offset
operator|=
operator|(
name|int8_t
operator|)
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|target
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|+
name|offset
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|=
name|target
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xec  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_in_byte_AL_DX
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|emu
operator|->
name|x86
operator|.
name|R_AL
operator|=
call|(
modifier|*
name|emu
operator|->
name|emu_inb
call|)
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DX
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xed  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_in_word_AX_DX
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|=
call|(
modifier|*
name|emu
operator|->
name|emu_inl
call|)
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DX
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|=
call|(
modifier|*
name|emu
operator|->
name|emu_inw
call|)
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DX
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xee  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_out_byte_DX_AL
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
call|(
modifier|*
name|emu
operator|->
name|emu_outb
call|)
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DX
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xef  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_out_word_DX_AX
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
call|(
modifier|*
name|emu
operator|->
name|emu_outl
call|)
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DX
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_EAX
argument_list|)
expr_stmt|;
block|}
else|else
block|{
call|(
modifier|*
name|emu
operator|->
name|emu_outw
call|)
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DX
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AX
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xf0  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_lock
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{ }
end_function

begin_comment
comment|/*opcode 0xf1 ILLEGAL OPERATION */
end_comment

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xf5  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_cmc
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
condition|)
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
else|else
name|SET_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xf6  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_opcF6_byte_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint8_t
name|destval
decl_stmt|,
name|srcval
decl_stmt|;
comment|/* long, drawn out code follows.  Double switch for a total of 32 	 * cases.  */
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_rh
operator|==
literal|1
condition|)
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_rh
operator|==
literal|0
condition|)
block|{
name|destval
operator|=
name|decode_and_fetch_byte_imm8
argument_list|(
name|emu
argument_list|,
operator|&
name|srcval
argument_list|)
expr_stmt|;
name|test_byte
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
return|return;
block|}
name|destval
operator|=
name|decode_and_fetch_byte
argument_list|(
name|emu
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|emu
operator|->
name|cur_rh
condition|)
block|{
case|case
literal|2
case|:
name|destval
operator|=
operator|~
name|destval
expr_stmt|;
name|write_back_byte
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|destval
operator|=
name|neg_byte
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
name|write_back_byte
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|mul_byte
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|imul_byte
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|div_byte
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|idiv_byte
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xf7  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp32_opcF7_word_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|destval
decl_stmt|,
name|srcval
decl_stmt|;
comment|/* long, drawn out code follows.  Double switch for a total of 32 	 * cases.  */
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_rh
operator|==
literal|1
condition|)
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_rh
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|uint32_t
name|destoffset
decl_stmt|;
name|destoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
name|fetch_long_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|fetch_data_long
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|srcval
operator|=
name|fetch_long_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
operator|*
name|decode_rl_long_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
name|test_long
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
return|return;
block|}
name|destval
operator|=
name|decode_and_fetch_long
argument_list|(
name|emu
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|emu
operator|->
name|cur_rh
condition|)
block|{
case|case
literal|2
case|:
name|destval
operator|=
operator|~
name|destval
expr_stmt|;
name|write_back_long
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|destval
operator|=
name|neg_long
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
name|write_back_long
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|mul_long
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|imul_long
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|div_long
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|idiv_long
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp16_opcF7_word_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint16_t
name|destval
decl_stmt|,
name|srcval
decl_stmt|;
comment|/* long, drawn out code follows.  Double switch for a total of 32 	 * cases.  */
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_rh
operator|==
literal|1
condition|)
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_rh
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|uint32_t
name|destoffset
decl_stmt|;
name|destoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|fetch_data_word
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|srcval
operator|=
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
operator|*
name|decode_rl_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
name|test_word
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
name|srcval
argument_list|)
expr_stmt|;
return|return;
block|}
name|destval
operator|=
name|decode_and_fetch_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|emu
operator|->
name|cur_rh
condition|)
block|{
case|case
literal|2
case|:
name|destval
operator|=
operator|~
name|destval
expr_stmt|;
name|write_back_word
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|destval
operator|=
name|neg_word
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
name|write_back_word
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|mul_word
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|imul_word
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|div_word
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|idiv_word
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp_opcF7_word_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|x86emuOp32_opcF7_word_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
else|else
name|x86emuOp16_opcF7_word_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xfe  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp_opcFE_byte_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint8_t
name|destval
decl_stmt|;
name|uint32_t
name|destoffset
decl_stmt|;
name|uint8_t
modifier|*
name|destreg
decl_stmt|;
comment|/* Yet another special case instruction. */
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|destoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|emu
operator|->
name|cur_rh
condition|)
block|{
case|case
literal|0
case|:
comment|/* inc word ptr ... */
name|destval
operator|=
name|fetch_data_byte
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|)
expr_stmt|;
name|destval
operator|=
name|inc_byte
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
name|store_data_byte
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|,
name|destval
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* dec word ptr ... */
name|destval
operator|=
name|fetch_data_byte
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|)
expr_stmt|;
name|destval
operator|=
name|dec_byte
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
name|store_data_byte
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|,
name|destval
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|destreg
operator|=
name|decode_rl_byte_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|emu
operator|->
name|cur_rh
condition|)
block|{
case|case
literal|0
case|:
operator|*
name|destreg
operator|=
name|inc_byte
argument_list|(
name|emu
argument_list|,
operator|*
name|destreg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
operator|*
name|destreg
operator|=
name|dec_byte
argument_list|(
name|emu
argument_list|,
operator|*
name|destreg
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0xff  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp32_opcFF_word_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|destoffset
init|=
literal|0
decl_stmt|;
name|uint32_t
name|destval
decl_stmt|,
modifier|*
name|destreg
decl_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|destoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|fetch_data_long
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|emu
operator|->
name|cur_rh
condition|)
block|{
case|case
literal|0
case|:
comment|/* inc word ptr ... */
name|destval
operator|=
name|inc_long
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
name|store_data_long
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|,
name|destval
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* dec word ptr ... */
name|destval
operator|=
name|dec_long
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
name|store_data_long
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|,
name|destval
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
comment|/* push word ptr ... */
name|push_long
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|destreg
operator|=
name|decode_rl_long_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|emu
operator|->
name|cur_rh
condition|)
block|{
case|case
literal|0
case|:
operator|*
name|destreg
operator|=
name|inc_long
argument_list|(
name|emu
argument_list|,
operator|*
name|destreg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
operator|*
name|destreg
operator|=
name|dec_long
argument_list|(
name|emu
argument_list|,
operator|*
name|destreg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|push_long
argument_list|(
name|emu
argument_list|,
operator|*
name|destreg
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp16_opcFF_word_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|destoffset
init|=
literal|0
decl_stmt|;
name|uint16_t
modifier|*
name|destreg
decl_stmt|;
name|uint16_t
name|destval
decl_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|destoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|fetch_data_word
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|emu
operator|->
name|cur_rh
condition|)
block|{
case|case
literal|0
case|:
name|destval
operator|=
name|inc_word
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
name|store_data_word
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|,
name|destval
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
comment|/* dec word ptr ... */
name|destval
operator|=
name|dec_word
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
name|store_data_word
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|,
name|destval
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
comment|/* push word ptr ... */
name|push_word
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|destreg
operator|=
name|decode_rl_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|emu
operator|->
name|cur_rh
condition|)
block|{
case|case
literal|0
case|:
operator|*
name|destreg
operator|=
name|inc_word
argument_list|(
name|emu
argument_list|,
operator|*
name|destreg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
operator|*
name|destreg
operator|=
name|dec_word
argument_list|(
name|emu
argument_list|,
operator|*
name|destreg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|push_word
argument_list|(
name|emu
argument_list|,
operator|*
name|destreg
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp_opcFF_word_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|destoffset
init|=
literal|0
decl_stmt|;
name|uint16_t
name|destval
decl_stmt|,
name|destval2
decl_stmt|;
comment|/* Yet another special case instruction. */
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|emu
operator|->
name|cur_mod
operator|==
literal|3
operator|&&
operator|(
name|emu
operator|->
name|cur_rh
operator|==
literal|3
operator|||
name|emu
operator|->
name|cur_rh
operator|==
literal|5
operator|)
operator|)
operator|||
name|emu
operator|->
name|cur_rh
operator|==
literal|7
condition|)
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_rh
operator|==
literal|0
operator|||
name|emu
operator|->
name|cur_rh
operator|==
literal|1
operator|||
name|emu
operator|->
name|cur_rh
operator|==
literal|6
condition|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|x86emuOp32_opcFF_word_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
else|else
name|x86emuOp16_opcFF_word_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|destoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|fetch_data_word
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|emu
operator|->
name|cur_rh
condition|)
block|{
case|case
literal|3
case|:
comment|/* call far ptr ... */
name|destval2
operator|=
name|fetch_data_word
argument_list|(
name|emu
argument_list|,
name|destoffset
operator|+
literal|2
argument_list|)
expr_stmt|;
name|push_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_CS
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_CS
operator|=
name|destval2
expr_stmt|;
name|push_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_IP
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|=
name|destval
expr_stmt|;
break|break;
case|case
literal|5
case|:
comment|/* jmp far ptr ... */
name|destval2
operator|=
name|fetch_data_word
argument_list|(
name|emu
argument_list|,
name|destoffset
operator|+
literal|2
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|=
name|destval
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_CS
operator|=
name|destval2
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|destval
operator|=
operator|*
name|decode_rl_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|emu
operator|->
name|cur_rh
condition|)
block|{
case|case
literal|2
case|:
comment|/* call word ptr */
name|push_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_IP
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|=
name|destval
expr_stmt|;
break|break;
case|case
literal|4
case|:
comment|/* jmp */
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|=
name|destval
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  *  * Single byte operation code table:  */
end_comment

begin_function
specifier|static
name|void
name|x86emu_exec_one_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint8_t
name|op1
decl_stmt|;
name|op1
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|op1
condition|)
block|{
case|case
literal|0x00
case|:
name|common_binop_byte_rm_r
argument_list|(
name|emu
argument_list|,
name|add_byte
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x01
case|:
name|common_binop_word_long_rm_r
argument_list|(
name|emu
argument_list|,
name|add_word
argument_list|,
name|add_long
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x02
case|:
name|common_binop_byte_r_rm
argument_list|(
name|emu
argument_list|,
name|add_byte
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x03
case|:
name|common_binop_word_long_r_rm
argument_list|(
name|emu
argument_list|,
name|add_word
argument_list|,
name|add_long
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x04
case|:
name|common_binop_byte_imm
argument_list|(
name|emu
argument_list|,
name|add_byte
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x05
case|:
name|common_binop_word_long_imm
argument_list|(
name|emu
argument_list|,
name|add_word
argument_list|,
name|add_long
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x06
case|:
name|push_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x07
case|:
name|emu
operator|->
name|x86
operator|.
name|R_ES
operator|=
name|pop_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x08
case|:
name|common_binop_byte_rm_r
argument_list|(
name|emu
argument_list|,
name|or_byte
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x09
case|:
name|common_binop_word_long_rm_r
argument_list|(
name|emu
argument_list|,
name|or_word
argument_list|,
name|or_long
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0a
case|:
name|common_binop_byte_r_rm
argument_list|(
name|emu
argument_list|,
name|or_byte
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0b
case|:
name|common_binop_word_long_r_rm
argument_list|(
name|emu
argument_list|,
name|or_word
argument_list|,
name|or_long
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0c
case|:
name|common_binop_byte_imm
argument_list|(
name|emu
argument_list|,
name|or_byte
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0d
case|:
name|common_binop_word_long_imm
argument_list|(
name|emu
argument_list|,
name|or_word
argument_list|,
name|or_long
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0e
case|:
name|push_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_CS
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x0f
case|:
name|x86emu_exec_two_byte
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x10
case|:
name|common_binop_byte_rm_r
argument_list|(
name|emu
argument_list|,
name|adc_byte
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x11
case|:
name|common_binop_word_long_rm_r
argument_list|(
name|emu
argument_list|,
name|adc_word
argument_list|,
name|adc_long
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x12
case|:
name|common_binop_byte_r_rm
argument_list|(
name|emu
argument_list|,
name|adc_byte
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x13
case|:
name|common_binop_word_long_r_rm
argument_list|(
name|emu
argument_list|,
name|adc_word
argument_list|,
name|adc_long
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x14
case|:
name|common_binop_byte_imm
argument_list|(
name|emu
argument_list|,
name|adc_byte
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x15
case|:
name|common_binop_word_long_imm
argument_list|(
name|emu
argument_list|,
name|adc_word
argument_list|,
name|adc_long
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x16
case|:
name|push_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SS
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x17
case|:
name|emu
operator|->
name|x86
operator|.
name|R_SS
operator|=
name|pop_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x18
case|:
name|common_binop_byte_rm_r
argument_list|(
name|emu
argument_list|,
name|sbb_byte
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x19
case|:
name|common_binop_word_long_rm_r
argument_list|(
name|emu
argument_list|,
name|sbb_word
argument_list|,
name|sbb_long
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x1a
case|:
name|common_binop_byte_r_rm
argument_list|(
name|emu
argument_list|,
name|sbb_byte
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x1b
case|:
name|common_binop_word_long_r_rm
argument_list|(
name|emu
argument_list|,
name|sbb_word
argument_list|,
name|sbb_long
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x1c
case|:
name|common_binop_byte_imm
argument_list|(
name|emu
argument_list|,
name|sbb_byte
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x1d
case|:
name|common_binop_word_long_imm
argument_list|(
name|emu
argument_list|,
name|sbb_word
argument_list|,
name|sbb_long
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x1e
case|:
name|push_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DS
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x1f
case|:
name|emu
operator|->
name|x86
operator|.
name|R_DS
operator|=
name|pop_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x20
case|:
name|common_binop_byte_rm_r
argument_list|(
name|emu
argument_list|,
name|and_byte
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x21
case|:
name|common_binop_word_long_rm_r
argument_list|(
name|emu
argument_list|,
name|and_word
argument_list|,
name|and_long
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x22
case|:
name|common_binop_byte_r_rm
argument_list|(
name|emu
argument_list|,
name|and_byte
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x23
case|:
name|common_binop_word_long_r_rm
argument_list|(
name|emu
argument_list|,
name|and_word
argument_list|,
name|and_long
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x24
case|:
name|common_binop_byte_imm
argument_list|(
name|emu
argument_list|,
name|and_byte
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x25
case|:
name|common_binop_word_long_imm
argument_list|(
name|emu
argument_list|,
name|and_word
argument_list|,
name|and_long
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x26
case|:
name|emu
operator|->
name|x86
operator|.
name|mode
operator||=
name|SYSMODE_SEGOVR_ES
expr_stmt|;
break|break;
case|case
literal|0x27
case|:
name|emu
operator|->
name|x86
operator|.
name|R_AL
operator|=
name|daa_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AL
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x28
case|:
name|common_binop_byte_rm_r
argument_list|(
name|emu
argument_list|,
name|sub_byte
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x29
case|:
name|common_binop_word_long_rm_r
argument_list|(
name|emu
argument_list|,
name|sub_word
argument_list|,
name|sub_long
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x2a
case|:
name|common_binop_byte_r_rm
argument_list|(
name|emu
argument_list|,
name|sub_byte
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x2b
case|:
name|common_binop_word_long_r_rm
argument_list|(
name|emu
argument_list|,
name|sub_word
argument_list|,
name|sub_long
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x2c
case|:
name|common_binop_byte_imm
argument_list|(
name|emu
argument_list|,
name|sub_byte
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x2d
case|:
name|common_binop_word_long_imm
argument_list|(
name|emu
argument_list|,
name|sub_word
argument_list|,
name|sub_long
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x2e
case|:
name|emu
operator|->
name|x86
operator|.
name|mode
operator||=
name|SYSMODE_SEGOVR_CS
expr_stmt|;
break|break;
case|case
literal|0x2f
case|:
name|emu
operator|->
name|x86
operator|.
name|R_AL
operator|=
name|das_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AL
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x30
case|:
name|common_binop_byte_rm_r
argument_list|(
name|emu
argument_list|,
name|xor_byte
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x31
case|:
name|common_binop_word_long_rm_r
argument_list|(
name|emu
argument_list|,
name|xor_word
argument_list|,
name|xor_long
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x32
case|:
name|common_binop_byte_r_rm
argument_list|(
name|emu
argument_list|,
name|xor_byte
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x33
case|:
name|common_binop_word_long_r_rm
argument_list|(
name|emu
argument_list|,
name|xor_word
argument_list|,
name|xor_long
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x34
case|:
name|common_binop_byte_imm
argument_list|(
name|emu
argument_list|,
name|xor_byte
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x35
case|:
name|common_binop_word_long_imm
argument_list|(
name|emu
argument_list|,
name|xor_word
argument_list|,
name|xor_long
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x36
case|:
name|emu
operator|->
name|x86
operator|.
name|mode
operator||=
name|SYSMODE_SEGOVR_SS
expr_stmt|;
break|break;
case|case
literal|0x37
case|:
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|=
name|aaa_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AX
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x38
case|:
name|common_binop_ns_byte_rm_r
argument_list|(
name|emu
argument_list|,
name|cmp_byte_no_return
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x39
case|:
name|common_binop_ns_word_long_rm_r
argument_list|(
name|emu
argument_list|,
name|cmp_word_no_return
argument_list|,
name|cmp_long_no_return
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x3a
case|:
name|x86emuOp_cmp_byte_R_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x3b
case|:
name|x86emuOp_cmp_word_R_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x3c
case|:
name|x86emuOp_cmp_byte_AL_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x3d
case|:
name|x86emuOp_cmp_word_AX_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x3e
case|:
name|emu
operator|->
name|x86
operator|.
name|mode
operator||=
name|SYSMODE_SEGOVR_DS
expr_stmt|;
break|break;
case|case
literal|0x3f
case|:
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|=
name|aas_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AX
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x40
case|:
name|common_inc_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_a
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x41
case|:
name|common_inc_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_c
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x42
case|:
name|common_inc_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_d
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x43
case|:
name|common_inc_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_b
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x44
case|:
name|common_inc_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_sp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x45
case|:
name|common_inc_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_bp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x46
case|:
name|common_inc_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_si
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x47
case|:
name|common_inc_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_di
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x48
case|:
name|common_dec_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_a
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x49
case|:
name|common_dec_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_c
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x4a
case|:
name|common_dec_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_d
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x4b
case|:
name|common_dec_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_b
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x4c
case|:
name|common_dec_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_sp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x4d
case|:
name|common_dec_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_bp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x4e
case|:
name|common_dec_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_si
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x4f
case|:
name|common_dec_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_di
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x50
case|:
name|common_push_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_a
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x51
case|:
name|common_push_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_c
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x52
case|:
name|common_push_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_d
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x53
case|:
name|common_push_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_b
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x54
case|:
name|common_push_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_sp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x55
case|:
name|common_push_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_bp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x56
case|:
name|common_push_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_si
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x57
case|:
name|common_push_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_di
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x58
case|:
name|common_pop_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_a
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x59
case|:
name|common_pop_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_c
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x5a
case|:
name|common_pop_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_d
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x5b
case|:
name|common_pop_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_b
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x5c
case|:
name|common_pop_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_sp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x5d
case|:
name|common_pop_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_bp
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x5e
case|:
name|common_pop_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_si
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x5f
case|:
name|common_pop_word_long
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|register_di
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x60
case|:
name|x86emuOp_push_all
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x61
case|:
name|x86emuOp_pop_all
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
comment|/* 0x62 bound */
comment|/* 0x63 arpl */
case|case
literal|0x64
case|:
name|emu
operator|->
name|x86
operator|.
name|mode
operator||=
name|SYSMODE_SEGOVR_FS
expr_stmt|;
break|break;
case|case
literal|0x65
case|:
name|emu
operator|->
name|x86
operator|.
name|mode
operator||=
name|SYSMODE_SEGOVR_GS
expr_stmt|;
break|break;
case|case
literal|0x66
case|:
name|emu
operator|->
name|x86
operator|.
name|mode
operator||=
name|SYSMODE_PREFIX_DATA
expr_stmt|;
break|break;
case|case
literal|0x67
case|:
name|emu
operator|->
name|x86
operator|.
name|mode
operator||=
name|SYSMODE_PREFIX_ADDR
expr_stmt|;
break|break;
case|case
literal|0x68
case|:
name|x86emuOp_push_word_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x69
case|:
name|common_imul_imm
argument_list|(
name|emu
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x6a
case|:
name|x86emuOp_push_byte_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x6b
case|:
name|common_imul_imm
argument_list|(
name|emu
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x6c
case|:
name|ins
argument_list|(
name|emu
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x6d
case|:
name|x86emuOp_ins_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x6e
case|:
name|outs
argument_list|(
name|emu
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x6f
case|:
name|x86emuOp_outs_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x70
case|:
name|common_jmp_near
argument_list|(
name|emu
argument_list|,
name|ACCESS_FLAG
argument_list|(
name|F_OF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x71
case|:
name|common_jmp_near
argument_list|(
name|emu
argument_list|,
operator|!
name|ACCESS_FLAG
argument_list|(
name|F_OF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x72
case|:
name|common_jmp_near
argument_list|(
name|emu
argument_list|,
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x73
case|:
name|common_jmp_near
argument_list|(
name|emu
argument_list|,
operator|!
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x74
case|:
name|common_jmp_near
argument_list|(
name|emu
argument_list|,
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x75
case|:
name|common_jmp_near
argument_list|(
name|emu
argument_list|,
operator|!
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x76
case|:
name|common_jmp_near
argument_list|(
name|emu
argument_list|,
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
operator|||
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x77
case|:
name|common_jmp_near
argument_list|(
name|emu
argument_list|,
operator|!
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
operator|&&
operator|!
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x78
case|:
name|common_jmp_near
argument_list|(
name|emu
argument_list|,
name|ACCESS_FLAG
argument_list|(
name|F_SF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x79
case|:
name|common_jmp_near
argument_list|(
name|emu
argument_list|,
operator|!
name|ACCESS_FLAG
argument_list|(
name|F_SF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x7a
case|:
name|common_jmp_near
argument_list|(
name|emu
argument_list|,
name|ACCESS_FLAG
argument_list|(
name|F_PF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x7b
case|:
name|common_jmp_near
argument_list|(
name|emu
argument_list|,
operator|!
name|ACCESS_FLAG
argument_list|(
name|F_PF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x7c
case|:
name|x86emuOp_jump_near_L
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x7d
case|:
name|x86emuOp_jump_near_NL
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x7e
case|:
name|x86emuOp_jump_near_LE
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x7f
case|:
name|x86emuOp_jump_near_NLE
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x80
case|:
name|x86emuOp_opc80_byte_RM_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x81
case|:
name|x86emuOp_opc81_word_RM_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x82
case|:
name|x86emuOp_opc82_byte_RM_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x83
case|:
name|x86emuOp_opc83_word_RM_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x84
case|:
name|common_binop_ns_byte_rm_r
argument_list|(
name|emu
argument_list|,
name|test_byte
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x85
case|:
name|common_binop_ns_word_long_rm_r
argument_list|(
name|emu
argument_list|,
name|test_word
argument_list|,
name|test_long
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x86
case|:
name|x86emuOp_xchg_byte_RM_R
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x87
case|:
name|x86emuOp_xchg_word_RM_R
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x88
case|:
name|x86emuOp_mov_byte_RM_R
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x89
case|:
name|x86emuOp_mov_word_RM_R
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x8a
case|:
name|x86emuOp_mov_byte_R_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x8b
case|:
name|x86emuOp_mov_word_R_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x8c
case|:
name|x86emuOp_mov_word_RM_SR
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x8d
case|:
name|x86emuOp_lea_word_R_M
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x8e
case|:
name|x86emuOp_mov_word_SR_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x8f
case|:
name|x86emuOp_pop_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x90
case|:
comment|/* nop */
break|break;
case|case
literal|0x91
case|:
name|x86emuOp_xchg_word_AX_CX
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x92
case|:
name|x86emuOp_xchg_word_AX_DX
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x93
case|:
name|x86emuOp_xchg_word_AX_BX
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x94
case|:
name|x86emuOp_xchg_word_AX_SP
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x95
case|:
name|x86emuOp_xchg_word_AX_BP
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x96
case|:
name|x86emuOp_xchg_word_AX_SI
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x97
case|:
name|x86emuOp_xchg_word_AX_DI
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x98
case|:
name|x86emuOp_cbw
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x99
case|:
name|x86emuOp_cwd
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x9a
case|:
name|x86emuOp_call_far_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x9b
case|:
comment|/* wait */
break|break;
case|case
literal|0x9c
case|:
name|x86emuOp_pushf_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x9d
case|:
name|x86emuOp_popf_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x9e
case|:
name|x86emuOp_sahf
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x9f
case|:
name|x86emuOp_lahf
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xa0
case|:
name|x86emuOp_mov_AL_M_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xa1
case|:
name|x86emuOp_mov_AX_M_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xa2
case|:
name|x86emuOp_mov_M_AL_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xa3
case|:
name|x86emuOp_mov_M_AX_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xa4
case|:
name|x86emuOp_movs_byte
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xa5
case|:
name|x86emuOp_movs_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xa6
case|:
name|x86emuOp_cmps_byte
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xa7
case|:
name|x86emuOp_cmps_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xa8
case|:
name|test_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_AL
argument_list|,
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xa9
case|:
name|x86emuOp_test_AX_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xaa
case|:
name|x86emuOp_stos_byte
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xab
case|:
name|x86emuOp_stos_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xac
case|:
name|x86emuOp_lods_byte
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xad
case|:
name|x86emuOp_lods_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xae
case|:
name|x86emuOp_scas_byte
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xaf
case|:
name|x86emuOp_scas_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xb0
case|:
name|emu
operator|->
name|x86
operator|.
name|R_AL
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xb1
case|:
name|emu
operator|->
name|x86
operator|.
name|R_CL
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xb2
case|:
name|emu
operator|->
name|x86
operator|.
name|R_DL
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xb3
case|:
name|emu
operator|->
name|x86
operator|.
name|R_BL
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xb4
case|:
name|emu
operator|->
name|x86
operator|.
name|R_AH
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xb5
case|:
name|emu
operator|->
name|x86
operator|.
name|R_CH
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xb6
case|:
name|emu
operator|->
name|x86
operator|.
name|R_DH
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xb7
case|:
name|emu
operator|->
name|x86
operator|.
name|R_BH
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xb8
case|:
name|x86emuOp_mov_word_AX_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xb9
case|:
name|x86emuOp_mov_word_CX_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xba
case|:
name|x86emuOp_mov_word_DX_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xbb
case|:
name|x86emuOp_mov_word_BX_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xbc
case|:
name|x86emuOp_mov_word_SP_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xbd
case|:
name|x86emuOp_mov_word_BP_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xbe
case|:
name|x86emuOp_mov_word_SI_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xbf
case|:
name|x86emuOp_mov_word_DI_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xc0
case|:
name|x86emuOp_opcC0_byte_RM_MEM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xc1
case|:
name|x86emuOp_opcC1_word_RM_MEM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xc2
case|:
name|x86emuOp_ret_near_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xc3
case|:
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|=
name|pop_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xc4
case|:
name|common_load_far_pointer
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xc5
case|:
name|common_load_far_pointer
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_DS
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xc6
case|:
name|x86emuOp_mov_byte_RM_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xc7
case|:
name|x86emuOp_mov_word_RM_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xc8
case|:
name|x86emuOp_enter
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xc9
case|:
name|x86emuOp_leave
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xca
case|:
name|x86emuOp_ret_far_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xcb
case|:
name|x86emuOp_ret_far
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xcc
case|:
name|x86emuOp_int3
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xcd
case|:
name|x86emuOp_int_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xce
case|:
name|x86emuOp_into
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xcf
case|:
name|x86emuOp_iret
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xd0
case|:
name|x86emuOp_opcD0_byte_RM_1
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xd1
case|:
name|x86emuOp_opcD1_word_RM_1
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xd2
case|:
name|x86emuOp_opcD2_byte_RM_CL
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xd3
case|:
name|x86emuOp_opcD3_word_RM_CL
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xd4
case|:
name|x86emuOp_aam
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xd5
case|:
name|x86emuOp_aad
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
comment|/* 0xd6 Undocumented SETALC instruction */
case|case
literal|0xd7
case|:
name|x86emuOp_xlat
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xd8
case|:
name|x86emuOp_esc_coprocess_d8
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xd9
case|:
name|x86emuOp_esc_coprocess_d9
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xda
case|:
name|x86emuOp_esc_coprocess_da
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xdb
case|:
name|x86emuOp_esc_coprocess_db
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xdc
case|:
name|x86emuOp_esc_coprocess_dc
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xdd
case|:
name|x86emuOp_esc_coprocess_dd
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xde
case|:
name|x86emuOp_esc_coprocess_de
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xdf
case|:
name|x86emuOp_esc_coprocess_df
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xe0
case|:
name|x86emuOp_loopne
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xe1
case|:
name|x86emuOp_loope
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xe2
case|:
name|x86emuOp_loop
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xe3
case|:
name|x86emuOp_jcxz
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xe4
case|:
name|x86emuOp_in_byte_AL_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xe5
case|:
name|x86emuOp_in_word_AX_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xe6
case|:
name|x86emuOp_out_byte_IMM_AL
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xe7
case|:
name|x86emuOp_out_word_IMM_AX
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xe8
case|:
name|x86emuOp_call_near_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xe9
case|:
name|x86emuOp_jump_near_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xea
case|:
name|x86emuOp_jump_far_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xeb
case|:
name|x86emuOp_jump_byte_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xec
case|:
name|x86emuOp_in_byte_AL_DX
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xed
case|:
name|x86emuOp_in_word_AX_DX
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xee
case|:
name|x86emuOp_out_byte_DX_AL
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xef
case|:
name|x86emuOp_out_word_DX_AX
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xf0
case|:
name|x86emuOp_lock
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xf2
case|:
name|emu
operator|->
name|x86
operator|.
name|mode
operator||=
name|SYSMODE_PREFIX_REPNE
expr_stmt|;
break|break;
case|case
literal|0xf3
case|:
name|emu
operator|->
name|x86
operator|.
name|mode
operator||=
name|SYSMODE_PREFIX_REPE
expr_stmt|;
break|break;
case|case
literal|0xf4
case|:
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xf5
case|:
name|x86emuOp_cmc
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xf6
case|:
name|x86emuOp_opcF6_byte_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xf7
case|:
name|x86emuOp_opcF7_word_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xf8
case|:
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xf9
case|:
name|SET_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xfa
case|:
name|CLEAR_FLAG
argument_list|(
name|F_IF
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xfb
case|:
name|SET_FLAG
argument_list|(
name|F_IF
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xfc
case|:
name|CLEAR_FLAG
argument_list|(
name|F_DF
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xfd
case|:
name|SET_FLAG
argument_list|(
name|F_DF
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xfe
case|:
name|x86emuOp_opcFE_byte_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xff
case|:
name|x86emuOp_opcFF_word_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
default|default:
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|op1
operator|!=
literal|0x26
operator|&&
name|op1
operator|!=
literal|0x2e
operator|&&
name|op1
operator|!=
literal|0x36
operator|&&
name|op1
operator|!=
literal|0x3e
operator|&&
operator|(
name|op1
operator||
literal|3
operator|)
operator|!=
literal|0x67
condition|)
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&=
operator|~
name|SYSMODE_CLRMASK
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|common_jmp_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|int
name|cond
parameter_list|)
block|{
name|int16_t
name|target
decl_stmt|;
name|target
operator|=
operator|(
name|int16_t
operator|)
name|fetch_word_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|target
operator|+=
operator|(
name|int16_t
operator|)
name|emu
operator|->
name|x86
operator|.
name|R_IP
expr_stmt|;
if|if
condition|(
name|cond
condition|)
name|emu
operator|->
name|x86
operator|.
name|R_IP
operator|=
operator|(
name|uint16_t
operator|)
name|target
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|common_set_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|int
name|cond
parameter_list|)
block|{
name|uint32_t
name|destoffset
decl_stmt|;
name|uint8_t
modifier|*
name|destreg
decl_stmt|,
name|destval
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destval
operator|=
name|cond
condition|?
literal|0x01
else|:
literal|0x00
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_mod
operator|!=
literal|3
condition|)
block|{
name|destoffset
operator|=
name|decode_rl_address
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|store_data_byte
argument_list|(
name|emu
argument_list|,
name|destoffset
argument_list|,
name|destval
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|destreg
operator|=
name|decode_rl_byte_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|destreg
operator|=
name|destval
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|common_bitstring32
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|int
name|op
parameter_list|)
block|{
name|int
name|bit
decl_stmt|;
name|uint32_t
name|srcval
decl_stmt|,
modifier|*
name|shiftreg
decl_stmt|,
name|mask
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|shiftreg
operator|=
name|decode_rh_long_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
name|decode_and_fetch_long_disp
argument_list|(
name|emu
argument_list|,
operator|(
name|int16_t
operator|)
operator|*
name|shiftreg
operator|>>
literal|5
argument_list|)
expr_stmt|;
name|bit
operator|=
operator|*
name|shiftreg
operator|&
literal|0x1F
expr_stmt|;
name|mask
operator|=
literal|0x1
operator|<<
name|bit
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|srcval
operator|&
name|mask
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|op
condition|)
block|{
case|case
literal|0
case|:
break|break;
case|case
literal|1
case|:
name|write_back_long
argument_list|(
name|emu
argument_list|,
name|srcval
operator||
name|mask
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|write_back_long
argument_list|(
name|emu
argument_list|,
name|srcval
operator|&
operator|~
name|mask
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|write_back_long
argument_list|(
name|emu
argument_list|,
name|srcval
operator|^
name|mask
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|common_bitstring16
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|int
name|op
parameter_list|)
block|{
name|int
name|bit
decl_stmt|;
name|uint16_t
name|srcval
decl_stmt|,
modifier|*
name|shiftreg
decl_stmt|,
name|mask
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|shiftreg
operator|=
name|decode_rh_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
name|decode_and_fetch_word_disp
argument_list|(
name|emu
argument_list|,
operator|(
name|int16_t
operator|)
operator|*
name|shiftreg
operator|>>
literal|4
argument_list|)
expr_stmt|;
name|bit
operator|=
operator|*
name|shiftreg
operator|&
literal|0xF
expr_stmt|;
name|mask
operator|=
literal|0x1
operator|<<
name|bit
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|srcval
operator|&
name|mask
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|op
condition|)
block|{
case|case
literal|0
case|:
break|break;
case|case
literal|1
case|:
name|write_back_word
argument_list|(
name|emu
argument_list|,
name|srcval
operator||
name|mask
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|write_back_word
argument_list|(
name|emu
argument_list|,
name|srcval
operator|&
operator|~
name|mask
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|write_back_word
argument_list|(
name|emu
argument_list|,
name|srcval
operator|^
name|mask
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|common_bitstring
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|int
name|op
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|common_bitstring32
argument_list|(
name|emu
argument_list|,
name|op
argument_list|)
expr_stmt|;
else|else
name|common_bitstring16
argument_list|(
name|emu
argument_list|,
name|op
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|common_bitsearch32
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|int
name|diff
parameter_list|)
block|{
name|uint32_t
name|srcval
decl_stmt|,
modifier|*
name|dstreg
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|dstreg
operator|=
name|decode_rh_long_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
name|decode_and_fetch_long
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|srcval
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
for|for
control|(
operator|*
name|dstreg
operator|=
literal|0
init|;
operator|*
name|dstreg
operator|<
literal|32
condition|;
operator|*
name|dstreg
operator|+=
name|diff
control|)
block|{
if|if
condition|(
operator|(
name|srcval
operator|>>
operator|*
name|dstreg
operator|)
operator|&
literal|1
condition|)
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|common_bitsearch16
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|int
name|diff
parameter_list|)
block|{
name|uint16_t
name|srcval
decl_stmt|,
modifier|*
name|dstreg
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|dstreg
operator|=
name|decode_rh_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
name|decode_and_fetch_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|srcval
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
for|for
control|(
operator|*
name|dstreg
operator|=
literal|0
init|;
operator|*
name|dstreg
operator|<
literal|16
condition|;
operator|*
name|dstreg
operator|+=
name|diff
control|)
block|{
if|if
condition|(
operator|(
name|srcval
operator|>>
operator|*
name|dstreg
operator|)
operator|&
literal|1
condition|)
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|common_bitsearch
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|int
name|diff
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|common_bitsearch32
argument_list|(
name|emu
argument_list|,
name|diff
argument_list|)
expr_stmt|;
else|else
name|common_bitsearch16
argument_list|(
name|emu
argument_list|,
name|diff
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|common_shift32
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|int
name|shift_left
parameter_list|,
name|int
name|use_cl
parameter_list|)
block|{
name|uint8_t
name|shift
decl_stmt|;
name|uint32_t
name|destval
decl_stmt|,
modifier|*
name|shiftreg
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|shiftreg
operator|=
name|decode_rh_long_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|use_cl
condition|)
block|{
name|destval
operator|=
name|decode_and_fetch_long
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|shift
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_CL
expr_stmt|;
block|}
else|else
block|{
name|destval
operator|=
name|decode_and_fetch_long_imm8
argument_list|(
name|emu
argument_list|,
operator|&
name|shift
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|shift_left
condition|)
name|destval
operator|=
name|shld_long
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
operator|*
name|shiftreg
argument_list|,
name|shift
argument_list|)
expr_stmt|;
else|else
name|destval
operator|=
name|shrd_long
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
operator|*
name|shiftreg
argument_list|,
name|shift
argument_list|)
expr_stmt|;
name|write_back_long
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|common_shift16
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|int
name|shift_left
parameter_list|,
name|int
name|use_cl
parameter_list|)
block|{
name|uint8_t
name|shift
decl_stmt|;
name|uint16_t
name|destval
decl_stmt|,
modifier|*
name|shiftreg
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|shiftreg
operator|=
name|decode_rh_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|use_cl
condition|)
block|{
name|destval
operator|=
name|decode_and_fetch_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|shift
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_CL
expr_stmt|;
block|}
else|else
block|{
name|destval
operator|=
name|decode_and_fetch_word_imm8
argument_list|(
name|emu
argument_list|,
operator|&
name|shift
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|shift_left
condition|)
name|destval
operator|=
name|shld_word
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
operator|*
name|shiftreg
argument_list|,
name|shift
argument_list|)
expr_stmt|;
else|else
name|destval
operator|=
name|shrd_word
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|,
operator|*
name|shiftreg
argument_list|,
name|shift
argument_list|)
expr_stmt|;
name|write_back_word
argument_list|(
name|emu
argument_list|,
name|destval
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|common_shift
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|int
name|shift_left
parameter_list|,
name|int
name|use_cl
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|common_shift32
argument_list|(
name|emu
argument_list|,
name|shift_left
argument_list|,
name|use_cl
argument_list|)
expr_stmt|;
else|else
name|common_shift16
argument_list|(
name|emu
argument_list|,
name|shift_left
argument_list|,
name|use_cl
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Implementation  */
end_comment

begin_define
define|#
directive|define
name|xorl
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|((a)&& !(b)) || (!(a)&& (b))
end_define

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x0f,0x31  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp2_rdtsc
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|=
name|emu
operator|->
name|cur_cycles
operator|&
literal|0xffffffff
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EDX
operator|=
name|emu
operator|->
name|cur_cycles
operator|>>
literal|32
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x0f,0xa0  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp2_push_FS
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|push_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_FS
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x0f,0xa1  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp2_pop_FS
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|emu
operator|->
name|x86
operator|.
name|R_FS
operator|=
name|pop_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x0f,0xa1  */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__i386__
argument_list|)
operator|||
name|defined
argument_list|(
name|__amd64__
argument_list|)
end_if

begin_function
specifier|static
name|void
name|hw_cpuid
parameter_list|(
name|uint32_t
modifier|*
name|a
parameter_list|,
name|uint32_t
modifier|*
name|b
parameter_list|,
name|uint32_t
modifier|*
name|c
parameter_list|,
name|uint32_t
modifier|*
name|d
parameter_list|)
block|{
asm|__asm__
specifier|volatile
asm|("cpuid" 			     : "=a" (*a), "=b" (*b), 			       "=c" (*c), "=d" (*d) 			     : "a" (*a), "c" (*c) 			     : "cc");
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|x86emuOp2_cpuid
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|__i386__
argument_list|)
operator|||
name|defined
argument_list|(
name|__amd64__
argument_list|)
name|hw_cpuid
argument_list|(
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_EAX
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_EBX
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_ECX
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_EDX
argument_list|)
expr_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|emu
operator|->
name|x86
operator|.
name|R_EAX
condition|)
block|{
case|case
literal|0
case|:
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|=
literal|1
expr_stmt|;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|__i386__
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__amd64__
argument_list|)
comment|/* "GenuineIntel" */
name|emu
operator|->
name|x86
operator|.
name|R_EBX
operator|=
literal|0x756e6547
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EDX
operator|=
literal|0x49656e69
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_ECX
operator|=
literal|0x6c65746e
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
literal|1
case|:
if|#
directive|if
operator|!
name|defined
argument_list|(
name|__i386__
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__amd64__
argument_list|)
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|=
literal|0x00000480
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EBX
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_ECX
operator|=
literal|0
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EDX
operator|=
literal|0x00000002
expr_stmt|;
else|#
directive|else
name|emu
operator|->
name|x86
operator|.
name|R_EDX
operator|&=
literal|0x00000012
expr_stmt|;
endif|#
directive|endif
break|break;
default|default:
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EBX
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_ECX
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_EDX
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x0f,0xa3  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp2_bt_R
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|common_bitstring
argument_list|(
name|emu
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x0f,0xa4  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp2_shld_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|common_shift
argument_list|(
name|emu
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x0f,0xa5  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp2_shld_CL
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|common_shift
argument_list|(
name|emu
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x0f,0xa8  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp2_push_GS
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|push_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_GS
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x0f,0xa9  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp2_pop_GS
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|emu
operator|->
name|x86
operator|.
name|R_GS
operator|=
name|pop_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x0f,0xab  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp2_bts_R
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|common_bitstring
argument_list|(
name|emu
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x0f,0xac  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp2_shrd_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|common_shift
argument_list|(
name|emu
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x0f,0xad  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp2_shrd_CL
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|common_shift
argument_list|(
name|emu
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x0f,0xaf  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp2_32_imul_R_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
modifier|*
name|destreg
decl_stmt|,
name|srcval
decl_stmt|;
name|uint64_t
name|res
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destreg
operator|=
name|decode_rh_long_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
name|decode_and_fetch_long
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|res
operator|=
operator|(
name|int32_t
operator|)
operator|*
name|destreg
operator|*
operator|(
name|int32_t
operator|)
name|srcval
expr_stmt|;
if|if
condition|(
name|res
operator|>
literal|0xffffffff
condition|)
block|{
name|SET_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
operator|*
name|destreg
operator|=
operator|(
name|uint32_t
operator|)
name|res
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp2_16_imul_R_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint16_t
modifier|*
name|destreg
decl_stmt|,
name|srcval
decl_stmt|;
name|uint32_t
name|res
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destreg
operator|=
name|decode_rh_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
name|decode_and_fetch_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|res
operator|=
operator|(
name|int16_t
operator|)
operator|*
name|destreg
operator|*
operator|(
name|int16_t
operator|)
name|srcval
expr_stmt|;
if|if
condition|(
name|res
operator|>
literal|0xFFFF
condition|)
block|{
name|SET_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
operator|*
name|destreg
operator|=
operator|(
name|uint16_t
operator|)
name|res
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp2_imul_R_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|x86emuOp2_32_imul_R_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
else|else
name|x86emuOp2_16_imul_R_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x0f,0xb2  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp2_lss_R_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|common_load_far_pointer
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_SS
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x0f,0xb3  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp2_btr_R
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|common_bitstring
argument_list|(
name|emu
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x0f,0xb4  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp2_lfs_R_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|common_load_far_pointer
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_FS
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x0f,0xb5  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp2_lgs_R_IMM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|common_load_far_pointer
argument_list|(
name|emu
argument_list|,
operator|&
name|emu
operator|->
name|x86
operator|.
name|R_GS
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x0f,0xb6  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp2_32_movzx_byte_R_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
modifier|*
name|destreg
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destreg
operator|=
name|decode_rh_long_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|destreg
operator|=
name|decode_and_fetch_byte
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp2_16_movzx_byte_R_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint16_t
modifier|*
name|destreg
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destreg
operator|=
name|decode_rh_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|destreg
operator|=
name|decode_and_fetch_byte
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp2_movzx_byte_R_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|x86emuOp2_32_movzx_byte_R_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
else|else
name|x86emuOp2_16_movzx_byte_R_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x0f,0xb7  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp2_movzx_word_R_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
modifier|*
name|destreg
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destreg
operator|=
name|decode_rh_long_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|destreg
operator|=
name|decode_and_fetch_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x0f,0xba  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp2_32_btX_I
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|int
name|bit
decl_stmt|;
name|uint32_t
name|srcval
decl_stmt|,
name|mask
decl_stmt|;
name|uint8_t
name|shift
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_rh
operator|<
literal|4
condition|)
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
name|decode_and_fetch_long_imm8
argument_list|(
name|emu
argument_list|,
operator|&
name|shift
argument_list|)
expr_stmt|;
name|bit
operator|=
name|shift
operator|&
literal|0x1F
expr_stmt|;
name|mask
operator|=
operator|(
literal|0x1
operator|<<
name|bit
operator|)
expr_stmt|;
switch|switch
condition|(
name|emu
operator|->
name|cur_rh
condition|)
block|{
case|case
literal|5
case|:
name|write_back_long
argument_list|(
name|emu
argument_list|,
name|srcval
operator||
name|mask
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|write_back_long
argument_list|(
name|emu
argument_list|,
name|srcval
operator|&
operator|~
name|mask
argument_list|)
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|write_back_long
argument_list|(
name|emu
argument_list|,
name|srcval
operator|^
name|mask
argument_list|)
expr_stmt|;
break|break;
block|}
name|CONDITIONAL_SET_FLAG
argument_list|(
name|srcval
operator|&
name|mask
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp2_16_btX_I
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|int
name|bit
decl_stmt|;
name|uint16_t
name|srcval
decl_stmt|,
name|mask
decl_stmt|;
name|uint8_t
name|shift
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|cur_rh
operator|<
literal|4
condition|)
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|srcval
operator|=
name|decode_and_fetch_word_imm8
argument_list|(
name|emu
argument_list|,
operator|&
name|shift
argument_list|)
expr_stmt|;
name|bit
operator|=
name|shift
operator|&
literal|0xF
expr_stmt|;
name|mask
operator|=
operator|(
literal|0x1
operator|<<
name|bit
operator|)
expr_stmt|;
switch|switch
condition|(
name|emu
operator|->
name|cur_rh
condition|)
block|{
case|case
literal|5
case|:
name|write_back_word
argument_list|(
name|emu
argument_list|,
name|srcval
operator||
name|mask
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|write_back_word
argument_list|(
name|emu
argument_list|,
name|srcval
operator|&
operator|~
name|mask
argument_list|)
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|write_back_word
argument_list|(
name|emu
argument_list|,
name|srcval
operator|^
name|mask
argument_list|)
expr_stmt|;
break|break;
block|}
name|CONDITIONAL_SET_FLAG
argument_list|(
name|srcval
operator|&
name|mask
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp2_btX_I
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|x86emuOp2_32_btX_I
argument_list|(
name|emu
argument_list|)
expr_stmt|;
else|else
name|x86emuOp2_16_btX_I
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x0f,0xbb  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp2_btc_R
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|common_bitstring
argument_list|(
name|emu
argument_list|,
literal|3
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x0f,0xbc  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp2_bsf
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|common_bitsearch
argument_list|(
name|emu
argument_list|,
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x0f,0xbd  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp2_bsr
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|common_bitsearch
argument_list|(
name|emu
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x0f,0xbe  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp2_32_movsx_byte_R_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
modifier|*
name|destreg
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destreg
operator|=
name|decode_rh_long_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|destreg
operator|=
operator|(
name|int32_t
operator|)
operator|(
name|int8_t
operator|)
name|decode_and_fetch_byte
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp2_16_movsx_byte_R_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint16_t
modifier|*
name|destreg
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destreg
operator|=
name|decode_rh_word_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|destreg
operator|=
operator|(
name|int16_t
operator|)
operator|(
name|int8_t
operator|)
name|decode_and_fetch_byte
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|x86emuOp2_movsx_byte_R_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
name|x86emuOp2_32_movsx_byte_R_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
else|else
name|x86emuOp2_16_movsx_byte_R_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Handles opcode 0x0f,0xbf  */
end_comment

begin_function
specifier|static
name|void
name|x86emuOp2_movsx_word_R_RM
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
modifier|*
name|destreg
decl_stmt|;
name|fetch_decode_modrm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
name|destreg
operator|=
name|decode_rh_long_register
argument_list|(
name|emu
argument_list|)
expr_stmt|;
operator|*
name|destreg
operator|=
operator|(
name|int32_t
operator|)
operator|(
name|int16_t
operator|)
name|decode_and_fetch_word
argument_list|(
name|emu
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|x86emu_exec_two_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint8_t
name|op2
decl_stmt|;
name|op2
operator|=
name|fetch_byte_imm
argument_list|(
name|emu
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|op2
condition|)
block|{
comment|/* 0x00 Group F (ring 0 PM)      */
comment|/* 0x01 Group G (ring 0 PM)      */
comment|/* 0x02 lar (ring 0 PM)          */
comment|/* 0x03 lsl (ring 0 PM)          */
comment|/* 0x05 loadall (undocumented)   */
comment|/* 0x06 clts (ring 0 PM)         */
comment|/* 0x07 loadall (undocumented)   */
comment|/* 0x08 invd (ring 0 PM)         */
comment|/* 0x09 wbinvd (ring 0 PM)       */
comment|/* 0x20 mov reg32(op2); break;creg (ring 0 PM) */
comment|/* 0x21 mov reg32(op2); break;dreg (ring 0 PM) */
comment|/* 0x22 mov creg(op2); break;reg32 (ring 0 PM) */
comment|/* 0x23 mov dreg(op2); break;reg32 (ring 0 PM) */
comment|/* 0x24 mov reg32(op2); break;treg (ring 0 PM) */
comment|/* 0x26 mov treg(op2); break;reg32 (ring 0 PM) */
case|case
literal|0x31
case|:
name|x86emuOp2_rdtsc
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x80
case|:
name|common_jmp_long
argument_list|(
name|emu
argument_list|,
name|ACCESS_FLAG
argument_list|(
name|F_OF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x81
case|:
name|common_jmp_long
argument_list|(
name|emu
argument_list|,
operator|!
name|ACCESS_FLAG
argument_list|(
name|F_OF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x82
case|:
name|common_jmp_long
argument_list|(
name|emu
argument_list|,
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x83
case|:
name|common_jmp_long
argument_list|(
name|emu
argument_list|,
operator|!
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x84
case|:
name|common_jmp_long
argument_list|(
name|emu
argument_list|,
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x85
case|:
name|common_jmp_long
argument_list|(
name|emu
argument_list|,
operator|!
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x86
case|:
name|common_jmp_long
argument_list|(
name|emu
argument_list|,
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
operator|||
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x87
case|:
name|common_jmp_long
argument_list|(
name|emu
argument_list|,
operator|!
operator|(
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
operator|||
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x88
case|:
name|common_jmp_long
argument_list|(
name|emu
argument_list|,
name|ACCESS_FLAG
argument_list|(
name|F_SF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x89
case|:
name|common_jmp_long
argument_list|(
name|emu
argument_list|,
operator|!
name|ACCESS_FLAG
argument_list|(
name|F_SF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x8a
case|:
name|common_jmp_long
argument_list|(
name|emu
argument_list|,
name|ACCESS_FLAG
argument_list|(
name|F_PF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x8b
case|:
name|common_jmp_long
argument_list|(
name|emu
argument_list|,
operator|!
name|ACCESS_FLAG
argument_list|(
name|F_PF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x8c
case|:
name|common_jmp_long
argument_list|(
name|emu
argument_list|,
name|xorl
argument_list|(
name|ACCESS_FLAG
argument_list|(
name|F_SF
argument_list|)
argument_list|,
name|ACCESS_FLAG
argument_list|(
name|F_OF
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x8d
case|:
name|common_jmp_long
argument_list|(
name|emu
argument_list|,
operator|!
operator|(
name|xorl
argument_list|(
name|ACCESS_FLAG
argument_list|(
name|F_SF
argument_list|)
argument_list|,
name|ACCESS_FLAG
argument_list|(
name|F_OF
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x8e
case|:
name|common_jmp_long
argument_list|(
name|emu
argument_list|,
operator|(
name|xorl
argument_list|(
name|ACCESS_FLAG
argument_list|(
name|F_SF
argument_list|)
argument_list|,
name|ACCESS_FLAG
argument_list|(
name|F_OF
argument_list|)
argument_list|)
operator|||
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x8f
case|:
name|common_jmp_long
argument_list|(
name|emu
argument_list|,
operator|!
operator|(
name|xorl
argument_list|(
name|ACCESS_FLAG
argument_list|(
name|F_SF
argument_list|)
argument_list|,
name|ACCESS_FLAG
argument_list|(
name|F_OF
argument_list|)
argument_list|)
operator|||
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x90
case|:
name|common_set_byte
argument_list|(
name|emu
argument_list|,
name|ACCESS_FLAG
argument_list|(
name|F_OF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x91
case|:
name|common_set_byte
argument_list|(
name|emu
argument_list|,
operator|!
name|ACCESS_FLAG
argument_list|(
name|F_OF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x92
case|:
name|common_set_byte
argument_list|(
name|emu
argument_list|,
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x93
case|:
name|common_set_byte
argument_list|(
name|emu
argument_list|,
operator|!
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x94
case|:
name|common_set_byte
argument_list|(
name|emu
argument_list|,
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x95
case|:
name|common_set_byte
argument_list|(
name|emu
argument_list|,
operator|!
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x96
case|:
name|common_set_byte
argument_list|(
name|emu
argument_list|,
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
operator|||
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x97
case|:
name|common_set_byte
argument_list|(
name|emu
argument_list|,
operator|!
operator|(
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
operator|||
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x98
case|:
name|common_set_byte
argument_list|(
name|emu
argument_list|,
name|ACCESS_FLAG
argument_list|(
name|F_SF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x99
case|:
name|common_set_byte
argument_list|(
name|emu
argument_list|,
operator|!
name|ACCESS_FLAG
argument_list|(
name|F_SF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x9a
case|:
name|common_set_byte
argument_list|(
name|emu
argument_list|,
name|ACCESS_FLAG
argument_list|(
name|F_PF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x9b
case|:
name|common_set_byte
argument_list|(
name|emu
argument_list|,
operator|!
name|ACCESS_FLAG
argument_list|(
name|F_PF
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x9c
case|:
name|common_set_byte
argument_list|(
name|emu
argument_list|,
name|xorl
argument_list|(
name|ACCESS_FLAG
argument_list|(
name|F_SF
argument_list|)
argument_list|,
name|ACCESS_FLAG
argument_list|(
name|F_OF
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x9d
case|:
name|common_set_byte
argument_list|(
name|emu
argument_list|,
name|xorl
argument_list|(
name|ACCESS_FLAG
argument_list|(
name|F_SF
argument_list|)
argument_list|,
name|ACCESS_FLAG
argument_list|(
name|F_OF
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x9e
case|:
name|common_set_byte
argument_list|(
name|emu
argument_list|,
operator|(
name|xorl
argument_list|(
name|ACCESS_FLAG
argument_list|(
name|F_SF
argument_list|)
argument_list|,
name|ACCESS_FLAG
argument_list|(
name|F_OF
argument_list|)
argument_list|)
operator|||
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0x9f
case|:
name|common_set_byte
argument_list|(
name|emu
argument_list|,
operator|!
operator|(
name|xorl
argument_list|(
name|ACCESS_FLAG
argument_list|(
name|F_SF
argument_list|)
argument_list|,
name|ACCESS_FLAG
argument_list|(
name|F_OF
argument_list|)
argument_list|)
operator|||
name|ACCESS_FLAG
argument_list|(
name|F_ZF
argument_list|)
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xa0
case|:
name|x86emuOp2_push_FS
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xa1
case|:
name|x86emuOp2_pop_FS
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xa2
case|:
name|x86emuOp2_cpuid
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xa3
case|:
name|x86emuOp2_bt_R
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xa4
case|:
name|x86emuOp2_shld_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xa5
case|:
name|x86emuOp2_shld_CL
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xa8
case|:
name|x86emuOp2_push_GS
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xa9
case|:
name|x86emuOp2_pop_GS
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xab
case|:
name|x86emuOp2_bts_R
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xac
case|:
name|x86emuOp2_shrd_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xad
case|:
name|x86emuOp2_shrd_CL
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xaf
case|:
name|x86emuOp2_imul_R_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
comment|/* 0xb0 TODO: cmpxchg */
comment|/* 0xb1 TODO: cmpxchg */
case|case
literal|0xb2
case|:
name|x86emuOp2_lss_R_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xb3
case|:
name|x86emuOp2_btr_R
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xb4
case|:
name|x86emuOp2_lfs_R_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xb5
case|:
name|x86emuOp2_lgs_R_IMM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xb6
case|:
name|x86emuOp2_movzx_byte_R_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xb7
case|:
name|x86emuOp2_movzx_word_R_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xba
case|:
name|x86emuOp2_btX_I
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xbb
case|:
name|x86emuOp2_btc_R
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xbc
case|:
name|x86emuOp2_bsf
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xbd
case|:
name|x86emuOp2_bsr
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xbe
case|:
name|x86emuOp2_movsx_byte_R_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xbf
case|:
name|x86emuOp2_movsx_word_R_RM
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
comment|/* 0xc0 TODO: xadd */
comment|/* 0xc1 TODO: xadd */
comment|/* 0xc8 TODO: bswap */
comment|/* 0xc9 TODO: bswap */
comment|/* 0xca TODO: bswap */
comment|/* 0xcb TODO: bswap */
comment|/* 0xcc TODO: bswap */
comment|/* 0xcd TODO: bswap */
comment|/* 0xce TODO: bswap */
comment|/* 0xcf TODO: bswap */
default|default:
name|x86emu_halt_sys
argument_list|(
name|emu
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * Carry Chain Calculation  *  * This represents a somewhat expensive calculation which is  * apparently required to emulate the setting of the OF and AF flag.  * The latter is not so important, but the former is.  The overflow  * flag is the XOR of the top two bits of the carry chain for an  * addition (similar for subtraction).  Since we do not want to  * simulate the addition in a bitwise manner, we try to calculate the  * carry chain given the two operands and the result.  *  * So, given the following table, which represents the addition of two  * bits, we can derive a formula for the carry chain.  *  * a   b   cin   r     cout  * 0   0   0     0     0  * 0   0   1     1     0  * 0   1   0     1     0  * 0   1   1     0     1  * 1   0   0     1     0  * 1   0   1     0     1  * 1   1   0     0     1  * 1   1   1     1     1  *  * Construction of table for cout:  *  * ab  * r  \  00   01   11  10  * |------------------  * 0  |   0    1    1   1  * 1  |   0    0    1   0  *  * By inspection, one gets:  cc = ab +  r'(a + b)  *  * That represents alot of operations, but NO CHOICE....  *  * Borrow Chain Calculation.  *  * The following table represents the subtraction of two bits, from  * which we can derive a formula for the borrow chain.  *  * a   b   bin   r     bout  * 0   0   0     0     0  * 0   0   1     1     1  * 0   1   0     1     1  * 0   1   1     0     1  * 1   0   0     1     0  * 1   0   1     0     0  * 1   1   0     0     0  * 1   1   1     1     1  *  * Construction of table for cout:  *  * ab  * r  \  00   01   11  10  * |------------------  * 0  |   0    1    0   0  * 1  |   1    1    1   0  *  * By inspection, one gets:  bc = a'b +  r(a' + b)  *  */
end_comment

begin_comment
comment|/*  * Global Variables  */
end_comment

begin_decl_stmt
specifier|static
name|uint32_t
name|x86emu_parity_tab
index|[
literal|8
index|]
init|=
block|{
literal|0x96696996
block|,
literal|0x69969669
block|,
literal|0x69969669
block|,
literal|0x96696996
block|,
literal|0x69969669
block|,
literal|0x96696996
block|,
literal|0x96696996
block|,
literal|0x69969669
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PARITY
parameter_list|(
name|x
parameter_list|)
value|(((x86emu_parity_tab[(x) / 32]>> ((x) % 32))& 1) == 0)
end_define

begin_define
define|#
directive|define
name|XOR2
parameter_list|(
name|x
parameter_list|)
value|(((x) ^ ((x)>>1))& 0x1)
end_define

begin_comment
comment|/*  * REMARKS:  * Implements the AAA instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint16_t
name|aaa_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|d
parameter_list|)
block|{
name|uint16_t
name|res
decl_stmt|;
if|if
condition|(
operator|(
name|d
operator|&
literal|0xf
operator|)
operator|>
literal|0x9
operator|||
name|ACCESS_FLAG
argument_list|(
name|F_AF
argument_list|)
condition|)
block|{
name|d
operator|+=
literal|0x6
expr_stmt|;
name|d
operator|+=
literal|0x100
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_AF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_AF
argument_list|)
expr_stmt|;
block|}
name|res
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|d
operator|&
literal|0xFF0F
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the AAA instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint16_t
name|aas_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|d
parameter_list|)
block|{
name|uint16_t
name|res
decl_stmt|;
if|if
condition|(
operator|(
name|d
operator|&
literal|0xf
operator|)
operator|>
literal|0x9
operator|||
name|ACCESS_FLAG
argument_list|(
name|F_AF
argument_list|)
condition|)
block|{
name|d
operator|-=
literal|0x6
expr_stmt|;
name|d
operator|-=
literal|0x100
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_AF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_AF
argument_list|)
expr_stmt|;
block|}
name|res
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|d
operator|&
literal|0xFF0F
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the AAD instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint16_t
name|aad_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|d
parameter_list|)
block|{
name|uint16_t
name|l
decl_stmt|;
name|uint8_t
name|hb
decl_stmt|,
name|lb
decl_stmt|;
name|hb
operator|=
call|(
name|uint8_t
call|)
argument_list|(
operator|(
name|d
operator|>>
literal|8
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|lb
operator|=
call|(
name|uint8_t
call|)
argument_list|(
operator|(
name|d
operator|&
literal|0xff
operator|)
argument_list|)
expr_stmt|;
name|l
operator|=
call|(
name|uint16_t
call|)
argument_list|(
operator|(
name|lb
operator|+
literal|10
operator|*
name|hb
operator|)
operator|&
literal|0xFF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_AF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|l
operator|&
literal|0x80
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|l
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|l
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
return|return
name|l
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the AAM instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint16_t
name|aam_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|d
parameter_list|)
block|{
name|uint16_t
name|h
decl_stmt|,
name|l
decl_stmt|;
name|h
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|d
operator|/
literal|10
argument_list|)
expr_stmt|;
name|l
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|d
operator|%
literal|10
argument_list|)
expr_stmt|;
name|l
operator||=
call|(
name|uint16_t
call|)
argument_list|(
name|h
operator|<<
literal|8
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_AF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|l
operator|&
literal|0x80
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|l
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|l
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
return|return
name|l
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the ADC instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint8_t
name|adc_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|uint32_t
name|cc
decl_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
condition|)
name|res
operator|=
literal|1
operator|+
name|d
operator|+
name|s
expr_stmt|;
else|else
name|res
operator|=
name|d
operator|+
name|s
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x100
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* calculate the carry chain  SEE NOTE AT TOP. */
name|cc
operator|=
operator|(
name|s
operator|&
name|d
operator|)
operator||
operator|(
operator|(
operator|~
name|res
operator|)
operator|&
operator|(
name|s
operator||
name|d
operator|)
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|cc
operator|>>
literal|6
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cc
operator|&
literal|0x8
argument_list|,
name|F_AF
argument_list|)
expr_stmt|;
return|return
operator|(
name|uint8_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the ADC instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint16_t
name|adc_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint16_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|uint32_t
name|cc
decl_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
condition|)
name|res
operator|=
literal|1
operator|+
name|d
operator|+
name|s
expr_stmt|;
else|else
name|res
operator|=
name|d
operator|+
name|s
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x10000
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xffff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x8000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* calculate the carry chain  SEE NOTE AT TOP. */
name|cc
operator|=
operator|(
name|s
operator|&
name|d
operator|)
operator||
operator|(
operator|(
operator|~
name|res
operator|)
operator|&
operator|(
name|s
operator||
name|d
operator|)
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|cc
operator|>>
literal|14
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cc
operator|&
literal|0x8
argument_list|,
name|F_AF
argument_list|)
expr_stmt|;
return|return
operator|(
name|uint16_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the ADC instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|adc_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint32_t
name|s
parameter_list|)
block|{
name|uint32_t
name|lo
decl_stmt|;
comment|/* all operands in native machine order */
name|uint32_t
name|hi
decl_stmt|;
name|uint32_t
name|res
decl_stmt|;
name|uint32_t
name|cc
decl_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
condition|)
block|{
name|lo
operator|=
literal|1
operator|+
operator|(
name|d
operator|&
literal|0xFFFF
operator|)
operator|+
operator|(
name|s
operator|&
literal|0xFFFF
operator|)
expr_stmt|;
name|res
operator|=
literal|1
operator|+
name|d
operator|+
name|s
expr_stmt|;
block|}
else|else
block|{
name|lo
operator|=
operator|(
name|d
operator|&
literal|0xFFFF
operator|)
operator|+
operator|(
name|s
operator|&
literal|0xFFFF
operator|)
expr_stmt|;
name|res
operator|=
name|d
operator|+
name|s
expr_stmt|;
block|}
name|hi
operator|=
operator|(
name|lo
operator|>>
literal|16
operator|)
operator|+
operator|(
name|d
operator|>>
literal|16
operator|)
operator|+
operator|(
name|s
operator|>>
literal|16
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|hi
operator|&
literal|0x10000
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xffffffff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80000000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* calculate the carry chain  SEE NOTE AT TOP. */
name|cc
operator|=
operator|(
name|s
operator|&
name|d
operator|)
operator||
operator|(
operator|(
operator|~
name|res
operator|)
operator|&
operator|(
name|s
operator||
name|d
operator|)
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|cc
operator|>>
literal|30
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cc
operator|&
literal|0x8
argument_list|,
name|F_AF
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the ADD instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint8_t
name|add_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|uint32_t
name|cc
decl_stmt|;
name|res
operator|=
name|d
operator|+
name|s
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x100
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* calculate the carry chain  SEE NOTE AT TOP. */
name|cc
operator|=
operator|(
name|s
operator|&
name|d
operator|)
operator||
operator|(
operator|(
operator|~
name|res
operator|)
operator|&
operator|(
name|s
operator||
name|d
operator|)
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|cc
operator|>>
literal|6
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cc
operator|&
literal|0x8
argument_list|,
name|F_AF
argument_list|)
expr_stmt|;
return|return
operator|(
name|uint8_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the ADD instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint16_t
name|add_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint16_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|uint32_t
name|cc
decl_stmt|;
name|res
operator|=
name|d
operator|+
name|s
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x10000
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xffff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x8000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* calculate the carry chain  SEE NOTE AT TOP. */
name|cc
operator|=
operator|(
name|s
operator|&
name|d
operator|)
operator||
operator|(
operator|(
operator|~
name|res
operator|)
operator|&
operator|(
name|s
operator||
name|d
operator|)
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|cc
operator|>>
literal|14
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cc
operator|&
literal|0x8
argument_list|,
name|F_AF
argument_list|)
expr_stmt|;
return|return
operator|(
name|uint16_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the ADD instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|add_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint32_t
name|s
parameter_list|)
block|{
name|uint32_t
name|lo
decl_stmt|;
comment|/* all operands in native machine order */
name|uint32_t
name|hi
decl_stmt|;
name|uint32_t
name|res
decl_stmt|;
name|uint32_t
name|cc
decl_stmt|;
name|lo
operator|=
operator|(
name|d
operator|&
literal|0xFFFF
operator|)
operator|+
operator|(
name|s
operator|&
literal|0xFFFF
operator|)
expr_stmt|;
name|res
operator|=
name|d
operator|+
name|s
expr_stmt|;
name|hi
operator|=
operator|(
name|lo
operator|>>
literal|16
operator|)
operator|+
operator|(
name|d
operator|>>
literal|16
operator|)
operator|+
operator|(
name|s
operator|>>
literal|16
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|hi
operator|&
literal|0x10000
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xffffffff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80000000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* calculate the carry chain  SEE NOTE AT TOP. */
name|cc
operator|=
operator|(
name|s
operator|&
name|d
operator|)
operator||
operator|(
operator|(
operator|~
name|res
operator|)
operator|&
operator|(
name|s
operator||
name|d
operator|)
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|cc
operator|>>
literal|30
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cc
operator|&
literal|0x8
argument_list|,
name|F_AF
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the AND instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint8_t
name|and_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|uint8_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|res
operator|=
name|d
operator|&
name|s
expr_stmt|;
comment|/* set the flags  */
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_AF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the AND instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint16_t
name|and_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint16_t
name|s
parameter_list|)
block|{
name|uint16_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|res
operator|=
name|d
operator|&
name|s
expr_stmt|;
comment|/* set the flags  */
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_AF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x8000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the AND instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|and_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint32_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|res
operator|=
name|d
operator|&
name|s
expr_stmt|;
comment|/* set the flags  */
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_AF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80000000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the CMP instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint8_t
name|cmp_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|uint32_t
name|bc
decl_stmt|;
name|res
operator|=
name|d
operator|-
name|s
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* calculate the borrow chain.  See note at top */
name|bc
operator|=
operator|(
name|res
operator|&
operator|(
operator|~
name|d
operator||
name|s
operator|)
operator|)
operator||
operator|(
operator|~
name|d
operator|&
name|s
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|bc
operator|&
literal|0x80
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|bc
operator|>>
literal|6
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|bc
operator|&
literal|0x8
argument_list|,
name|F_AF
argument_list|)
expr_stmt|;
return|return
name|d
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cmp_byte_no_return
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|cmp_byte
argument_list|(
name|emu
argument_list|,
name|d
argument_list|,
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the CMP instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint16_t
name|cmp_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint16_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|uint32_t
name|bc
decl_stmt|;
name|res
operator|=
name|d
operator|-
name|s
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x8000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xffff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* calculate the borrow chain.  See note at top */
name|bc
operator|=
operator|(
name|res
operator|&
operator|(
operator|~
name|d
operator||
name|s
operator|)
operator|)
operator||
operator|(
operator|~
name|d
operator|&
name|s
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|bc
operator|&
literal|0x8000
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|bc
operator|>>
literal|14
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|bc
operator|&
literal|0x8
argument_list|,
name|F_AF
argument_list|)
expr_stmt|;
return|return
name|d
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cmp_word_no_return
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint16_t
name|s
parameter_list|)
block|{
name|cmp_word
argument_list|(
name|emu
argument_list|,
name|d
argument_list|,
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the CMP instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|cmp_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint32_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|uint32_t
name|bc
decl_stmt|;
name|res
operator|=
name|d
operator|-
name|s
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80000000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xffffffff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* calculate the borrow chain.  See note at top */
name|bc
operator|=
operator|(
name|res
operator|&
operator|(
operator|~
name|d
operator||
name|s
operator|)
operator|)
operator||
operator|(
operator|~
name|d
operator|&
name|s
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|bc
operator|&
literal|0x80000000
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|bc
operator|>>
literal|30
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|bc
operator|&
literal|0x8
argument_list|,
name|F_AF
argument_list|)
expr_stmt|;
return|return
name|d
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cmp_long_no_return
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint32_t
name|s
parameter_list|)
block|{
name|cmp_long
argument_list|(
name|emu
argument_list|,
name|d
argument_list|,
name|s
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the DAA instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint8_t
name|daa_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|d
parameter_list|)
block|{
name|uint32_t
name|res
init|=
name|d
decl_stmt|;
if|if
condition|(
operator|(
name|d
operator|&
literal|0xf
operator|)
operator|>
literal|9
operator|||
name|ACCESS_FLAG
argument_list|(
name|F_AF
argument_list|)
condition|)
block|{
name|res
operator|+=
literal|6
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_AF
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|res
operator|>
literal|0x9F
operator|||
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
condition|)
block|{
name|res
operator|+=
literal|0x60
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
block|}
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xFF
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
return|return
operator|(
name|uint8_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the DAS instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint8_t
name|das_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|d
parameter_list|)
block|{
if|if
condition|(
operator|(
name|d
operator|&
literal|0xf
operator|)
operator|>
literal|9
operator|||
name|ACCESS_FLAG
argument_list|(
name|F_AF
argument_list|)
condition|)
block|{
name|d
operator|-=
literal|6
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_AF
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|d
operator|>
literal|0x9F
operator|||
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
condition|)
block|{
name|d
operator|-=
literal|0x60
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
block|}
name|CONDITIONAL_SET_FLAG
argument_list|(
name|d
operator|&
literal|0x80
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|d
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|d
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
return|return
name|d
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the DEC instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint8_t
name|dec_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|d
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|uint32_t
name|bc
decl_stmt|;
name|res
operator|=
name|d
operator|-
literal|1
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* calculate the borrow chain.  See note at top */
comment|/* based on sub_byte, uses s==1.  */
name|bc
operator|=
operator|(
name|res
operator|&
operator|(
operator|~
name|d
operator||
literal|1
operator|)
operator|)
operator||
operator|(
operator|~
name|d
operator|&
literal|1
operator|)
expr_stmt|;
comment|/* carry flag unchanged */
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|bc
operator|>>
literal|6
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|bc
operator|&
literal|0x8
argument_list|,
name|F_AF
argument_list|)
expr_stmt|;
return|return
operator|(
name|uint8_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the DEC instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint16_t
name|dec_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|d
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|uint32_t
name|bc
decl_stmt|;
name|res
operator|=
name|d
operator|-
literal|1
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x8000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xffff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* calculate the borrow chain.  See note at top */
comment|/* based on the sub_byte routine, with s==1 */
name|bc
operator|=
operator|(
name|res
operator|&
operator|(
operator|~
name|d
operator||
literal|1
operator|)
operator|)
operator||
operator|(
operator|~
name|d
operator|&
literal|1
operator|)
expr_stmt|;
comment|/* carry flag unchanged */
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|bc
operator|>>
literal|14
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|bc
operator|&
literal|0x8
argument_list|,
name|F_AF
argument_list|)
expr_stmt|;
return|return
operator|(
name|uint16_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the DEC instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|dec_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|d
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|uint32_t
name|bc
decl_stmt|;
name|res
operator|=
name|d
operator|-
literal|1
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80000000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xffffffff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* calculate the borrow chain.  See note at top */
name|bc
operator|=
operator|(
name|res
operator|&
operator|(
operator|~
name|d
operator||
literal|1
operator|)
operator|)
operator||
operator|(
operator|~
name|d
operator|&
literal|1
operator|)
expr_stmt|;
comment|/* carry flag unchanged */
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|bc
operator|>>
literal|30
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|bc
operator|&
literal|0x8
argument_list|,
name|F_AF
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the INC instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint8_t
name|inc_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|d
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|uint32_t
name|cc
decl_stmt|;
name|res
operator|=
name|d
operator|+
literal|1
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* calculate the carry chain  SEE NOTE AT TOP. */
name|cc
operator|=
operator|(
operator|(
literal|1
operator|&
name|d
operator|)
operator||
operator|(
operator|~
name|res
operator|)
operator|)
operator|&
operator|(
literal|1
operator||
name|d
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|cc
operator|>>
literal|6
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cc
operator|&
literal|0x8
argument_list|,
name|F_AF
argument_list|)
expr_stmt|;
return|return
operator|(
name|uint8_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the INC instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint16_t
name|inc_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|d
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|uint32_t
name|cc
decl_stmt|;
name|res
operator|=
name|d
operator|+
literal|1
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xffff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x8000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* calculate the carry chain  SEE NOTE AT TOP. */
name|cc
operator|=
operator|(
literal|1
operator|&
name|d
operator|)
operator||
operator|(
operator|(
operator|~
name|res
operator|)
operator|&
operator|(
literal|1
operator||
name|d
operator|)
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|cc
operator|>>
literal|14
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cc
operator|&
literal|0x8
argument_list|,
name|F_AF
argument_list|)
expr_stmt|;
return|return
operator|(
name|uint16_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the INC instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|inc_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|d
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|uint32_t
name|cc
decl_stmt|;
name|res
operator|=
name|d
operator|+
literal|1
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xffffffff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80000000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* calculate the carry chain  SEE NOTE AT TOP. */
name|cc
operator|=
operator|(
literal|1
operator|&
name|d
operator|)
operator||
operator|(
operator|(
operator|~
name|res
operator|)
operator|&
operator|(
literal|1
operator||
name|d
operator|)
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|cc
operator|>>
literal|30
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cc
operator|&
literal|0x8
argument_list|,
name|F_AF
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the OR instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint8_t
name|or_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|uint8_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|res
operator|=
name|d
operator||
name|s
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_AF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the OR instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint16_t
name|or_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint16_t
name|s
parameter_list|)
block|{
name|uint16_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|res
operator|=
name|d
operator||
name|s
expr_stmt|;
comment|/* set the carry flag to be bit 8 */
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_AF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x8000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the OR instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|or_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint32_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|res
operator|=
name|d
operator||
name|s
expr_stmt|;
comment|/* set the carry flag to be bit 8 */
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_AF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80000000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the OR instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint8_t
name|neg_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|uint8_t
name|res
decl_stmt|;
name|uint8_t
name|bc
decl_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|s
operator|!=
literal|0
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|res
operator|=
operator|(
name|uint8_t
operator|)
operator|-
name|s
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* calculate the borrow chain --- modified such that d=0. 	 * substitutiing d=0 into     bc= res&(~d|s)|(~d&s); (the one used for 	 * sub) and simplifying, since ~d=0xff..., ~d|s == 0xffff..., and 	 * res&0xfff... == res.  Similarly ~d&s == s.  So the simplified 	 * result is: */
name|bc
operator|=
name|res
operator||
name|s
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|bc
operator|>>
literal|6
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|bc
operator|&
literal|0x8
argument_list|,
name|F_AF
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the OR instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint16_t
name|neg_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|s
parameter_list|)
block|{
name|uint16_t
name|res
decl_stmt|;
name|uint16_t
name|bc
decl_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|s
operator|!=
literal|0
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|res
operator|=
operator|(
name|uint16_t
operator|)
operator|-
name|s
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xffff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x8000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* calculate the borrow chain --- modified such that d=0. 	 * substitutiing d=0 into     bc= res&(~d|s)|(~d&s); (the one used for 	 * sub) and simplifying, since ~d=0xff..., ~d|s == 0xffff..., and 	 * res&0xfff... == res.  Similarly ~d&s == s.  So the simplified 	 * result is: */
name|bc
operator|=
name|res
operator||
name|s
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|bc
operator|>>
literal|14
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|bc
operator|&
literal|0x8
argument_list|,
name|F_AF
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the OR instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|neg_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
name|uint32_t
name|bc
decl_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|s
operator|!=
literal|0
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|res
operator|=
operator|(
name|uint32_t
operator|)
operator|-
name|s
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xffffffff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80000000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* calculate the borrow chain --- modified such that d=0. 	 * substitutiing d=0 into     bc= res&(~d|s)|(~d&s); (the one used for 	 * sub) and simplifying, since ~d=0xff..., ~d|s == 0xffff..., and 	 * res&0xfff... == res.  Similarly ~d&s == s.  So the simplified 	 * result is: */
name|bc
operator|=
name|res
operator||
name|s
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|bc
operator|>>
literal|30
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|bc
operator|&
literal|0x8
argument_list|,
name|F_AF
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the RCL instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint8_t
name|rcl_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|unsigned
name|int
name|res
decl_stmt|,
name|cnt
decl_stmt|,
name|mask
decl_stmt|,
name|cf
decl_stmt|;
comment|/* s is the rotate distance.  It varies from 0 - 8. */
comment|/* have 	 *  	 * CF  B_7 B_6 B_5 B_4 B_3 B_2 B_1 B_0 	 *  	 * want to rotate through the carry by "s" bits.  We could loop, but 	 * that's inefficient.  So the width is 9, and we split into three 	 * parts: 	 *  	 * The new carry flag   (was B_n) the stuff in B_n-1 .. B_0 the stuff 	 * in B_7 .. B_n+1 	 *  	 * The new rotate is done mod 9, and given this, for a rotation of n 	 * bits (mod 9) the new carry flag is then located n bits from the MSB. 	 * The low part is then shifted up cnt bits, and the high part is or'd 	 * in.  Using CAPS for new values, and lowercase for the original 	 * values, this can be expressed as: 	 *  	 * IF n> 0 1) CF<-  b_(8-n) 2) B_(7) .. B_(n)<-  b_(8-(n+1)) .. b_0 	 * 3) B_(n-1)<- cf 4) B_(n-2) .. B_0<-  b_7 .. b_(8-(n-1)) 	 */
name|res
operator|=
name|d
expr_stmt|;
if|if
condition|(
operator|(
name|cnt
operator|=
name|s
operator|%
literal|9
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* extract the new CARRY FLAG. */
comment|/* CF<-  b_(8-n)             */
name|cf
operator|=
operator|(
name|d
operator|>>
operator|(
literal|8
operator|-
name|cnt
operator|)
operator|)
operator|&
literal|0x1
expr_stmt|;
comment|/*  		 * Get the low stuff which rotated into the range B_7 .. B_cnt 		 * B_(7) .. B_(n)<-  b_(8-(n+1)) .. b_0 		 * note that the right hand side done by the mask. 		 */
name|res
operator|=
operator|(
name|d
operator|<<
name|cnt
operator|)
operator|&
literal|0xff
expr_stmt|;
comment|/*  		 * now the high stuff which rotated around into the positions 		 * B_cnt-2 .. B_0 		 * B_(n-2) .. B_0<-  b_7 .. b_(8-(n-1)) 		 * shift it downward, 7-(n-2) = 9-n positions. and mask off 		 * the result before or'ing in. 		 */
name|mask
operator|=
operator|(
literal|1
operator|<<
operator|(
name|cnt
operator|-
literal|1
operator|)
operator|)
operator|-
literal|1
expr_stmt|;
name|res
operator||=
operator|(
name|d
operator|>>
operator|(
literal|9
operator|-
name|cnt
operator|)
operator|)
operator|&
name|mask
expr_stmt|;
comment|/* if the carry flag was set, or it in.  */
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
condition|)
block|{
comment|/* carry flag is set */
comment|/* B_(n-1)<- cf */
name|res
operator||=
literal|1
operator|<<
operator|(
name|cnt
operator|-
literal|1
operator|)
expr_stmt|;
block|}
comment|/* set the new carry flag, based on the variable "cf" */
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cf
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
comment|/* OVERFLOW is set *IFF* cnt==1, then it is the xor of CF and 		 * the most significant bit.  Blecck. */
comment|/* parenthesized this expression since it appears to be 		 * causing OF to be misset */
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cnt
operator|==
literal|1
operator|&&
name|XOR2
argument_list|(
name|cf
operator|+
operator|(
operator|(
name|res
operator|>>
literal|6
operator|)
operator|&
literal|0x2
operator|)
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|uint8_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the RCL instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint16_t
name|rcl_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|unsigned
name|int
name|res
decl_stmt|,
name|cnt
decl_stmt|,
name|mask
decl_stmt|,
name|cf
decl_stmt|;
name|res
operator|=
name|d
expr_stmt|;
if|if
condition|(
operator|(
name|cnt
operator|=
name|s
operator|%
literal|17
operator|)
operator|!=
literal|0
condition|)
block|{
name|cf
operator|=
operator|(
name|d
operator|>>
operator|(
literal|16
operator|-
name|cnt
operator|)
operator|)
operator|&
literal|0x1
expr_stmt|;
name|res
operator|=
operator|(
name|d
operator|<<
name|cnt
operator|)
operator|&
literal|0xffff
expr_stmt|;
name|mask
operator|=
operator|(
literal|1
operator|<<
operator|(
name|cnt
operator|-
literal|1
operator|)
operator|)
operator|-
literal|1
expr_stmt|;
name|res
operator||=
operator|(
name|d
operator|>>
operator|(
literal|17
operator|-
name|cnt
operator|)
operator|)
operator|&
name|mask
expr_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
condition|)
block|{
name|res
operator||=
literal|1
operator|<<
operator|(
name|cnt
operator|-
literal|1
operator|)
expr_stmt|;
block|}
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cf
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cnt
operator|==
literal|1
operator|&&
name|XOR2
argument_list|(
name|cf
operator|+
operator|(
operator|(
name|res
operator|>>
literal|14
operator|)
operator|&
literal|0x2
operator|)
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|uint16_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the RCL instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|rcl_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|,
name|cnt
decl_stmt|,
name|mask
decl_stmt|,
name|cf
decl_stmt|;
name|res
operator|=
name|d
expr_stmt|;
if|if
condition|(
operator|(
name|cnt
operator|=
name|s
operator|%
literal|33
operator|)
operator|!=
literal|0
condition|)
block|{
name|cf
operator|=
operator|(
name|d
operator|>>
operator|(
literal|32
operator|-
name|cnt
operator|)
operator|)
operator|&
literal|0x1
expr_stmt|;
name|res
operator|=
operator|(
name|d
operator|<<
name|cnt
operator|)
operator|&
literal|0xffffffff
expr_stmt|;
name|mask
operator|=
operator|(
literal|1
operator|<<
operator|(
name|cnt
operator|-
literal|1
operator|)
operator|)
operator|-
literal|1
expr_stmt|;
name|res
operator||=
operator|(
name|d
operator|>>
operator|(
literal|33
operator|-
name|cnt
operator|)
operator|)
operator|&
name|mask
expr_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
condition|)
block|{
comment|/* carry flag is set */
name|res
operator||=
literal|1
operator|<<
operator|(
name|cnt
operator|-
literal|1
operator|)
expr_stmt|;
block|}
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cf
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cnt
operator|==
literal|1
operator|&&
name|XOR2
argument_list|(
name|cf
operator|+
operator|(
operator|(
name|res
operator|>>
literal|30
operator|)
operator|&
literal|0x2
operator|)
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
block|}
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the RCR instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint8_t
name|rcr_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|,
name|cnt
decl_stmt|;
name|uint32_t
name|mask
decl_stmt|,
name|cf
decl_stmt|,
name|ocf
init|=
literal|0
decl_stmt|;
comment|/* rotate right through carry */
comment|/* s is the rotate distance.  It varies from 0 - 8. d is the byte 	 * object rotated. 	 *  	 * have 	 *  	 * CF  B_7 B_6 B_5 B_4 B_3 B_2 B_1 B_0 	 *  	 * The new rotate is done mod 9, and given this, for a rotation of n 	 * bits (mod 9) the new carry flag is then located n bits from the LSB. 	 * The low part is then shifted up cnt bits, and the high part is or'd 	 * in.  Using CAPS for new values, and lowercase for the original 	 * values, this can be expressed as: 	 *  	 * IF n> 0  	 *	1) CF<-  b_(n-1)  	 *	2) B_(8-(n+1)) .. B_(0)<-  b_(7) .. b_(n) 	 * 	3) B_(8-n)<- cf 4) B_(7) .. B_(8-(n-1))<-  b_(n-2) .. b_(0) 	 */
name|res
operator|=
name|d
expr_stmt|;
if|if
condition|(
operator|(
name|cnt
operator|=
name|s
operator|%
literal|9
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* extract the new CARRY FLAG. */
comment|/* CF<-  b_(n-1)              */
if|if
condition|(
name|cnt
operator|==
literal|1
condition|)
block|{
name|cf
operator|=
name|d
operator|&
literal|0x1
expr_stmt|;
comment|/* note hackery here.  Access_flag(..) evaluates to 			 * either 0 if flag not set non-zero if flag is set. 			 * doing access_flag(..) != 0 casts that into either 			 * 0..1 in any representation of the flags register 			 * (i.e. packed bit array or unpacked.) */
name|ocf
operator|=
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
operator|!=
literal|0
expr_stmt|;
block|}
else|else
name|cf
operator|=
operator|(
name|d
operator|>>
operator|(
name|cnt
operator|-
literal|1
operator|)
operator|)
operator|&
literal|0x1
expr_stmt|;
comment|/* B_(8-(n+1)) .. B_(0)<-  b_(7) .. b_n  */
comment|/* note that the right hand side done by the mask This is 		 * effectively done by shifting the object to the right.  The 		 * result must be masked, in case the object came in and was 		 * treated as a negative number.  Needed??? */
name|mask
operator|=
operator|(
literal|1
operator|<<
operator|(
literal|8
operator|-
name|cnt
operator|)
operator|)
operator|-
literal|1
expr_stmt|;
name|res
operator|=
operator|(
name|d
operator|>>
name|cnt
operator|)
operator|&
name|mask
expr_stmt|;
comment|/* now the high stuff which rotated around into the positions 		 * B_cnt-2 .. B_0 */
comment|/* B_(7) .. B_(8-(n-1))<-  b_(n-2) .. b_(0) */
comment|/* shift it downward, 7-(n-2) = 9-n positions. and mask off 		 * the result before or'ing in. */
name|res
operator||=
operator|(
name|d
operator|<<
operator|(
literal|9
operator|-
name|cnt
operator|)
operator|)
expr_stmt|;
comment|/* if the carry flag was set, or it in.  */
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
condition|)
block|{
comment|/* carry flag is set */
comment|/* B_(8-n)<- cf */
name|res
operator||=
literal|1
operator|<<
operator|(
literal|8
operator|-
name|cnt
operator|)
expr_stmt|;
block|}
comment|/* set the new carry flag, based on the variable "cf" */
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cf
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
comment|/* OVERFLOW is set *IFF* cnt==1, then it is the xor of CF and 		 * the most significant bit.  Blecck. */
comment|/* parenthesized... */
if|if
condition|(
name|cnt
operator|==
literal|1
condition|)
block|{
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|ocf
operator|+
operator|(
operator|(
name|d
operator|>>
literal|6
operator|)
operator|&
literal|0x2
operator|)
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|uint8_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the RCR instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint16_t
name|rcr_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|,
name|cnt
decl_stmt|;
name|uint32_t
name|mask
decl_stmt|,
name|cf
decl_stmt|,
name|ocf
init|=
literal|0
decl_stmt|;
comment|/* rotate right through carry */
name|res
operator|=
name|d
expr_stmt|;
if|if
condition|(
operator|(
name|cnt
operator|=
name|s
operator|%
literal|17
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|cnt
operator|==
literal|1
condition|)
block|{
name|cf
operator|=
name|d
operator|&
literal|0x1
expr_stmt|;
name|ocf
operator|=
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
operator|!=
literal|0
expr_stmt|;
block|}
else|else
name|cf
operator|=
operator|(
name|d
operator|>>
operator|(
name|cnt
operator|-
literal|1
operator|)
operator|)
operator|&
literal|0x1
expr_stmt|;
name|mask
operator|=
operator|(
literal|1
operator|<<
operator|(
literal|16
operator|-
name|cnt
operator|)
operator|)
operator|-
literal|1
expr_stmt|;
name|res
operator|=
operator|(
name|d
operator|>>
name|cnt
operator|)
operator|&
name|mask
expr_stmt|;
name|res
operator||=
operator|(
name|d
operator|<<
operator|(
literal|17
operator|-
name|cnt
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
condition|)
block|{
name|res
operator||=
literal|1
operator|<<
operator|(
literal|16
operator|-
name|cnt
operator|)
expr_stmt|;
block|}
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cf
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
if|if
condition|(
name|cnt
operator|==
literal|1
condition|)
block|{
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|ocf
operator|+
operator|(
operator|(
name|d
operator|>>
literal|14
operator|)
operator|&
literal|0x2
operator|)
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|uint16_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the RCR instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|rcr_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|,
name|cnt
decl_stmt|;
name|uint32_t
name|mask
decl_stmt|,
name|cf
decl_stmt|,
name|ocf
init|=
literal|0
decl_stmt|;
comment|/* rotate right through carry */
name|res
operator|=
name|d
expr_stmt|;
if|if
condition|(
operator|(
name|cnt
operator|=
name|s
operator|%
literal|33
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|cnt
operator|==
literal|1
condition|)
block|{
name|cf
operator|=
name|d
operator|&
literal|0x1
expr_stmt|;
name|ocf
operator|=
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
operator|!=
literal|0
expr_stmt|;
block|}
else|else
name|cf
operator|=
operator|(
name|d
operator|>>
operator|(
name|cnt
operator|-
literal|1
operator|)
operator|)
operator|&
literal|0x1
expr_stmt|;
name|mask
operator|=
operator|(
literal|1
operator|<<
operator|(
literal|32
operator|-
name|cnt
operator|)
operator|)
operator|-
literal|1
expr_stmt|;
name|res
operator|=
operator|(
name|d
operator|>>
name|cnt
operator|)
operator|&
name|mask
expr_stmt|;
if|if
condition|(
name|cnt
operator|!=
literal|1
condition|)
name|res
operator||=
operator|(
name|d
operator|<<
operator|(
literal|33
operator|-
name|cnt
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
condition|)
block|{
comment|/* carry flag is set */
name|res
operator||=
literal|1
operator|<<
operator|(
literal|32
operator|-
name|cnt
operator|)
expr_stmt|;
block|}
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cf
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
if|if
condition|(
name|cnt
operator|==
literal|1
condition|)
block|{
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|ocf
operator|+
operator|(
operator|(
name|d
operator|>>
literal|30
operator|)
operator|&
literal|0x2
operator|)
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the ROL instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint8_t
name|rol_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|unsigned
name|int
name|res
decl_stmt|,
name|cnt
decl_stmt|,
name|mask
decl_stmt|;
comment|/* rotate left */
comment|/* s is the rotate distance.  It varies from 0 - 8. d is the byte 	 * object rotated. 	 *  	 * have 	 *  	 * CF  B_7 ... B_0 	 *  	 * The new rotate is done mod 8. Much simpler than the "rcl" or "rcr" 	 * operations. 	 *  	 * IF n> 0 1) B_(7) .. B_(n)<-  b_(8-(n+1)) .. b_(0) 2) B_(n-1) .. 	 * B_(0)<-  b_(7) .. b_(8-n) */
name|res
operator|=
name|d
expr_stmt|;
if|if
condition|(
operator|(
name|cnt
operator|=
name|s
operator|%
literal|8
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* B_(7) .. B_(n)<-  b_(8-(n+1)) .. b_(0) */
name|res
operator|=
operator|(
name|d
operator|<<
name|cnt
operator|)
expr_stmt|;
comment|/* B_(n-1) .. B_(0)<-  b_(7) .. b_(8-n) */
name|mask
operator|=
operator|(
literal|1
operator|<<
name|cnt
operator|)
operator|-
literal|1
expr_stmt|;
name|res
operator||=
operator|(
name|d
operator|>>
operator|(
literal|8
operator|-
name|cnt
operator|)
operator|)
operator|&
name|mask
expr_stmt|;
comment|/* set the new carry flag, Note that it is the low order bit 		 * of the result!!!                               */
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x1
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
comment|/* OVERFLOW is set *IFF* s==1, then it is the xor of CF and 		 * the most significant bit.  Blecck. */
name|CONDITIONAL_SET_FLAG
argument_list|(
name|s
operator|==
literal|1
operator|&&
name|XOR2
argument_list|(
operator|(
name|res
operator|&
literal|0x1
operator|)
operator|+
operator|(
operator|(
name|res
operator|>>
literal|6
operator|)
operator|&
literal|0x2
operator|)
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|s
operator|!=
literal|0
condition|)
block|{
comment|/* set the new carry flag, Note that it is the low order bit 		 * of the result!!!                               */
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x1
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|uint8_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the ROL instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint16_t
name|rol_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|unsigned
name|int
name|res
decl_stmt|,
name|cnt
decl_stmt|,
name|mask
decl_stmt|;
name|res
operator|=
name|d
expr_stmt|;
if|if
condition|(
operator|(
name|cnt
operator|=
name|s
operator|%
literal|16
operator|)
operator|!=
literal|0
condition|)
block|{
name|res
operator|=
operator|(
name|d
operator|<<
name|cnt
operator|)
expr_stmt|;
name|mask
operator|=
operator|(
literal|1
operator|<<
name|cnt
operator|)
operator|-
literal|1
expr_stmt|;
name|res
operator||=
operator|(
name|d
operator|>>
operator|(
literal|16
operator|-
name|cnt
operator|)
operator|)
operator|&
name|mask
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x1
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|s
operator|==
literal|1
operator|&&
name|XOR2
argument_list|(
operator|(
name|res
operator|&
literal|0x1
operator|)
operator|+
operator|(
operator|(
name|res
operator|>>
literal|14
operator|)
operator|&
literal|0x2
operator|)
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|s
operator|!=
literal|0
condition|)
block|{
comment|/* set the new carry flag, Note that it is the low order bit 		 * of the result!!!                               */
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x1
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|uint16_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the ROL instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|rol_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|,
name|cnt
decl_stmt|,
name|mask
decl_stmt|;
name|res
operator|=
name|d
expr_stmt|;
if|if
condition|(
operator|(
name|cnt
operator|=
name|s
operator|%
literal|32
operator|)
operator|!=
literal|0
condition|)
block|{
name|res
operator|=
operator|(
name|d
operator|<<
name|cnt
operator|)
expr_stmt|;
name|mask
operator|=
operator|(
literal|1
operator|<<
name|cnt
operator|)
operator|-
literal|1
expr_stmt|;
name|res
operator||=
operator|(
name|d
operator|>>
operator|(
literal|32
operator|-
name|cnt
operator|)
operator|)
operator|&
name|mask
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x1
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|s
operator|==
literal|1
operator|&&
name|XOR2
argument_list|(
operator|(
name|res
operator|&
literal|0x1
operator|)
operator|+
operator|(
operator|(
name|res
operator|>>
literal|30
operator|)
operator|&
literal|0x2
operator|)
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|s
operator|!=
literal|0
condition|)
block|{
comment|/* set the new carry flag, Note that it is the low order bit 		 * of the result!!!                               */
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x1
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
block|}
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the ROR instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint8_t
name|ror_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|unsigned
name|int
name|res
decl_stmt|,
name|cnt
decl_stmt|,
name|mask
decl_stmt|;
comment|/* rotate right */
comment|/* s is the rotate distance.  It varies from 0 - 8. d is the byte 	 * object rotated. 	 *  	 * have 	 *  	 * B_7 ... B_0 	 *  	 * The rotate is done mod 8. 	 *  	 * IF n> 0 1) B_(8-(n+1)) .. B_(0)<-  b_(7) .. b_(n) 2) B_(7) .. 	 * B_(8-n)<-  b_(n-1) .. b_(0) */
name|res
operator|=
name|d
expr_stmt|;
if|if
condition|(
operator|(
name|cnt
operator|=
name|s
operator|%
literal|8
operator|)
operator|!=
literal|0
condition|)
block|{
comment|/* not a typo, do nada if cnt==0 */
comment|/* B_(7) .. B_(8-n)<-  b_(n-1) .. b_(0) */
name|res
operator|=
operator|(
name|d
operator|<<
operator|(
literal|8
operator|-
name|cnt
operator|)
operator|)
expr_stmt|;
comment|/* B_(8-(n+1)) .. B_(0)<-  b_(7) .. b_(n) */
name|mask
operator|=
operator|(
literal|1
operator|<<
operator|(
literal|8
operator|-
name|cnt
operator|)
operator|)
operator|-
literal|1
expr_stmt|;
name|res
operator||=
operator|(
name|d
operator|>>
operator|(
name|cnt
operator|)
operator|)
operator|&
name|mask
expr_stmt|;
comment|/* set the new carry flag, Note that it is the low order bit 		 * of the result!!!                               */
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
comment|/* OVERFLOW is set *IFF* s==1, then it is the xor of the two 		 * most significant bits.  Blecck. */
name|CONDITIONAL_SET_FLAG
argument_list|(
name|s
operator|==
literal|1
operator|&&
name|XOR2
argument_list|(
name|res
operator|>>
literal|6
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|s
operator|!=
literal|0
condition|)
block|{
comment|/* set the new carry flag, Note that it is the low order bit 		 * of the result!!!                               */
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|uint8_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the ROR instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint16_t
name|ror_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|unsigned
name|int
name|res
decl_stmt|,
name|cnt
decl_stmt|,
name|mask
decl_stmt|;
name|res
operator|=
name|d
expr_stmt|;
if|if
condition|(
operator|(
name|cnt
operator|=
name|s
operator|%
literal|16
operator|)
operator|!=
literal|0
condition|)
block|{
name|res
operator|=
operator|(
name|d
operator|<<
operator|(
literal|16
operator|-
name|cnt
operator|)
operator|)
expr_stmt|;
name|mask
operator|=
operator|(
literal|1
operator|<<
operator|(
literal|16
operator|-
name|cnt
operator|)
operator|)
operator|-
literal|1
expr_stmt|;
name|res
operator||=
operator|(
name|d
operator|>>
operator|(
name|cnt
operator|)
operator|)
operator|&
name|mask
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x8000
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|s
operator|==
literal|1
operator|&&
name|XOR2
argument_list|(
name|res
operator|>>
literal|14
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|s
operator|!=
literal|0
condition|)
block|{
comment|/* set the new carry flag, Note that it is the low order bit 		 * of the result!!!                               */
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x8000
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|uint16_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the ROR instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|ror_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|,
name|cnt
decl_stmt|,
name|mask
decl_stmt|;
name|res
operator|=
name|d
expr_stmt|;
if|if
condition|(
operator|(
name|cnt
operator|=
name|s
operator|%
literal|32
operator|)
operator|!=
literal|0
condition|)
block|{
name|res
operator|=
operator|(
name|d
operator|<<
operator|(
literal|32
operator|-
name|cnt
operator|)
operator|)
expr_stmt|;
name|mask
operator|=
operator|(
literal|1
operator|<<
operator|(
literal|32
operator|-
name|cnt
operator|)
operator|)
operator|-
literal|1
expr_stmt|;
name|res
operator||=
operator|(
name|d
operator|>>
operator|(
name|cnt
operator|)
operator|)
operator|&
name|mask
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80000000
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|s
operator|==
literal|1
operator|&&
name|XOR2
argument_list|(
name|res
operator|>>
literal|30
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|s
operator|!=
literal|0
condition|)
block|{
comment|/* set the new carry flag, Note that it is the low order bit 		 * of the result!!!                               */
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80000000
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
block|}
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the SHL instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint8_t
name|shl_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|unsigned
name|int
name|cnt
decl_stmt|,
name|res
decl_stmt|,
name|cf
decl_stmt|;
if|if
condition|(
name|s
operator|<
literal|8
condition|)
block|{
name|cnt
operator|=
name|s
operator|%
literal|8
expr_stmt|;
comment|/* last bit shifted out goes into carry flag */
if|if
condition|(
name|cnt
operator|>
literal|0
condition|)
block|{
name|res
operator|=
name|d
operator|<<
name|cnt
expr_stmt|;
name|cf
operator|=
name|d
operator|&
operator|(
literal|1
operator|<<
operator|(
literal|8
operator|-
name|cnt
operator|)
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cf
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|res
operator|=
operator|(
name|uint8_t
operator|)
name|d
expr_stmt|;
block|}
if|if
condition|(
name|cnt
operator|==
literal|1
condition|)
block|{
comment|/* Needs simplification. */
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
operator|(
operator|(
name|res
operator|&
literal|0x80
operator|)
operator|==
literal|0x80
operator|)
operator|^
operator|(
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
operator|!=
literal|0
operator|)
operator|)
argument_list|,
comment|/* was (emu->x86.R_FLG&F_CF)==F_CF)), */
name|F_OF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|res
operator|=
literal|0
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|d
operator|<<
operator|(
name|s
operator|-
literal|1
operator|)
operator|)
operator|&
literal|0x80
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_SF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_PF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_ZF
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|uint8_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the SHL instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint16_t
name|shl_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|unsigned
name|int
name|cnt
decl_stmt|,
name|res
decl_stmt|,
name|cf
decl_stmt|;
if|if
condition|(
name|s
operator|<
literal|16
condition|)
block|{
name|cnt
operator|=
name|s
operator|%
literal|16
expr_stmt|;
if|if
condition|(
name|cnt
operator|>
literal|0
condition|)
block|{
name|res
operator|=
name|d
operator|<<
name|cnt
expr_stmt|;
name|cf
operator|=
name|d
operator|&
operator|(
literal|1
operator|<<
operator|(
literal|16
operator|-
name|cnt
operator|)
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cf
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xffff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x8000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|res
operator|=
operator|(
name|uint16_t
operator|)
name|d
expr_stmt|;
block|}
if|if
condition|(
name|cnt
operator|==
literal|1
condition|)
block|{
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
operator|(
operator|(
name|res
operator|&
literal|0x8000
operator|)
operator|==
literal|0x8000
operator|)
operator|^
operator|(
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
operator|!=
literal|0
operator|)
operator|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|res
operator|=
literal|0
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|d
operator|<<
operator|(
name|s
operator|-
literal|1
operator|)
operator|)
operator|&
literal|0x8000
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_SF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_PF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_ZF
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|uint16_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the SHL instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|shl_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|unsigned
name|int
name|cnt
decl_stmt|,
name|res
decl_stmt|,
name|cf
decl_stmt|;
if|if
condition|(
name|s
operator|<
literal|32
condition|)
block|{
name|cnt
operator|=
name|s
operator|%
literal|32
expr_stmt|;
if|if
condition|(
name|cnt
operator|>
literal|0
condition|)
block|{
name|res
operator|=
name|d
operator|<<
name|cnt
expr_stmt|;
name|cf
operator|=
name|d
operator|&
operator|(
literal|1
operator|<<
operator|(
literal|32
operator|-
name|cnt
operator|)
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cf
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xffffffff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80000000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|res
operator|=
name|d
expr_stmt|;
block|}
if|if
condition|(
name|cnt
operator|==
literal|1
condition|)
block|{
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
operator|(
operator|(
name|res
operator|&
literal|0x80000000
operator|)
operator|==
literal|0x80000000
operator|)
operator|^
operator|(
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
operator|!=
literal|0
operator|)
operator|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|res
operator|=
literal|0
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|d
operator|<<
operator|(
name|s
operator|-
literal|1
operator|)
operator|)
operator|&
literal|0x80000000
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_SF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_PF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_ZF
argument_list|)
expr_stmt|;
block|}
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the SHR instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint8_t
name|shr_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|unsigned
name|int
name|cnt
decl_stmt|,
name|res
decl_stmt|,
name|cf
decl_stmt|;
if|if
condition|(
name|s
operator|<
literal|8
condition|)
block|{
name|cnt
operator|=
name|s
operator|%
literal|8
expr_stmt|;
if|if
condition|(
name|cnt
operator|>
literal|0
condition|)
block|{
name|cf
operator|=
name|d
operator|&
operator|(
literal|1
operator|<<
operator|(
name|cnt
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
name|res
operator|=
name|d
operator|>>
name|cnt
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cf
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|res
operator|=
operator|(
name|uint8_t
operator|)
name|d
expr_stmt|;
block|}
if|if
condition|(
name|cnt
operator|==
literal|1
condition|)
block|{
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|res
operator|>>
literal|6
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|res
operator|=
literal|0
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|d
operator|>>
operator|(
name|s
operator|-
literal|1
operator|)
operator|)
operator|&
literal|0x1
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_SF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_PF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_ZF
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|uint8_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the SHR instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint16_t
name|shr_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|unsigned
name|int
name|cnt
decl_stmt|,
name|res
decl_stmt|,
name|cf
decl_stmt|;
if|if
condition|(
name|s
operator|<
literal|16
condition|)
block|{
name|cnt
operator|=
name|s
operator|%
literal|16
expr_stmt|;
if|if
condition|(
name|cnt
operator|>
literal|0
condition|)
block|{
name|cf
operator|=
name|d
operator|&
operator|(
literal|1
operator|<<
operator|(
name|cnt
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
name|res
operator|=
name|d
operator|>>
name|cnt
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cf
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xffff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x8000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|res
operator|=
name|d
expr_stmt|;
block|}
if|if
condition|(
name|cnt
operator|==
literal|1
condition|)
block|{
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|res
operator|>>
literal|14
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|res
operator|=
literal|0
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_ZF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_SF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_PF
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|uint16_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the SHR instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|shr_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|unsigned
name|int
name|cnt
decl_stmt|,
name|res
decl_stmt|,
name|cf
decl_stmt|;
if|if
condition|(
name|s
operator|<
literal|32
condition|)
block|{
name|cnt
operator|=
name|s
operator|%
literal|32
expr_stmt|;
if|if
condition|(
name|cnt
operator|>
literal|0
condition|)
block|{
name|cf
operator|=
name|d
operator|&
operator|(
literal|1
operator|<<
operator|(
name|cnt
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
name|res
operator|=
name|d
operator|>>
name|cnt
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cf
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xffffffff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80000000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|res
operator|=
name|d
expr_stmt|;
block|}
if|if
condition|(
name|cnt
operator|==
literal|1
condition|)
block|{
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|res
operator|>>
literal|30
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|res
operator|=
literal|0
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_ZF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_SF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_PF
argument_list|)
expr_stmt|;
block|}
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the SAR instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint8_t
name|sar_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|unsigned
name|int
name|cnt
decl_stmt|,
name|res
decl_stmt|,
name|cf
decl_stmt|,
name|mask
decl_stmt|,
name|sf
decl_stmt|;
name|res
operator|=
name|d
expr_stmt|;
name|sf
operator|=
name|d
operator|&
literal|0x80
expr_stmt|;
name|cnt
operator|=
name|s
operator|%
literal|8
expr_stmt|;
if|if
condition|(
name|cnt
operator|>
literal|0
operator|&&
name|cnt
operator|<
literal|8
condition|)
block|{
name|mask
operator|=
operator|(
literal|1
operator|<<
operator|(
literal|8
operator|-
name|cnt
operator|)
operator|)
operator|-
literal|1
expr_stmt|;
name|cf
operator|=
name|d
operator|&
operator|(
literal|1
operator|<<
operator|(
name|cnt
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
name|res
operator|=
operator|(
name|d
operator|>>
name|cnt
operator|)
operator|&
name|mask
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cf
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
if|if
condition|(
name|sf
condition|)
block|{
name|res
operator||=
operator|~
name|mask
expr_stmt|;
block|}
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cnt
operator|>=
literal|8
condition|)
block|{
if|if
condition|(
name|sf
condition|)
block|{
name|res
operator|=
literal|0xff
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_ZF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_SF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_PF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|res
operator|=
literal|0
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_ZF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_SF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_PF
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|uint8_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the SAR instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint16_t
name|sar_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|unsigned
name|int
name|cnt
decl_stmt|,
name|res
decl_stmt|,
name|cf
decl_stmt|,
name|mask
decl_stmt|,
name|sf
decl_stmt|;
name|sf
operator|=
name|d
operator|&
literal|0x8000
expr_stmt|;
name|cnt
operator|=
name|s
operator|%
literal|16
expr_stmt|;
name|res
operator|=
name|d
expr_stmt|;
if|if
condition|(
name|cnt
operator|>
literal|0
operator|&&
name|cnt
operator|<
literal|16
condition|)
block|{
name|mask
operator|=
operator|(
literal|1
operator|<<
operator|(
literal|16
operator|-
name|cnt
operator|)
operator|)
operator|-
literal|1
expr_stmt|;
name|cf
operator|=
name|d
operator|&
operator|(
literal|1
operator|<<
operator|(
name|cnt
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
name|res
operator|=
operator|(
name|d
operator|>>
name|cnt
operator|)
operator|&
name|mask
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cf
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
if|if
condition|(
name|sf
condition|)
block|{
name|res
operator||=
operator|~
name|mask
expr_stmt|;
block|}
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xffff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x8000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cnt
operator|>=
literal|16
condition|)
block|{
if|if
condition|(
name|sf
condition|)
block|{
name|res
operator|=
literal|0xffff
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_ZF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_SF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_PF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|res
operator|=
literal|0
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_ZF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_SF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_PF
argument_list|)
expr_stmt|;
block|}
block|}
return|return
operator|(
name|uint16_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the SAR instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|sar_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|uint32_t
name|cnt
decl_stmt|,
name|res
decl_stmt|,
name|cf
decl_stmt|,
name|mask
decl_stmt|,
name|sf
decl_stmt|;
name|sf
operator|=
name|d
operator|&
literal|0x80000000
expr_stmt|;
name|cnt
operator|=
name|s
operator|%
literal|32
expr_stmt|;
name|res
operator|=
name|d
expr_stmt|;
if|if
condition|(
name|cnt
operator|>
literal|0
operator|&&
name|cnt
operator|<
literal|32
condition|)
block|{
name|mask
operator|=
operator|(
literal|1
operator|<<
operator|(
literal|32
operator|-
name|cnt
operator|)
operator|)
operator|-
literal|1
expr_stmt|;
name|cf
operator|=
name|d
operator|&
operator|(
literal|1
operator|<<
operator|(
name|cnt
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
name|res
operator|=
operator|(
name|d
operator|>>
name|cnt
operator|)
operator|&
name|mask
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cf
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
if|if
condition|(
name|sf
condition|)
block|{
name|res
operator||=
operator|~
name|mask
expr_stmt|;
block|}
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xffffffff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80000000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cnt
operator|>=
literal|32
condition|)
block|{
if|if
condition|(
name|sf
condition|)
block|{
name|res
operator|=
literal|0xffffffff
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_ZF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_SF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_PF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|res
operator|=
literal|0
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_ZF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_SF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_PF
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the SHLD instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint16_t
name|shld_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint16_t
name|fill
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|unsigned
name|int
name|cnt
decl_stmt|,
name|res
decl_stmt|,
name|cf
decl_stmt|;
if|if
condition|(
name|s
operator|<
literal|16
condition|)
block|{
name|cnt
operator|=
name|s
operator|%
literal|16
expr_stmt|;
if|if
condition|(
name|cnt
operator|>
literal|0
condition|)
block|{
name|res
operator|=
operator|(
name|d
operator|<<
name|cnt
operator|)
operator||
operator|(
name|fill
operator|>>
operator|(
literal|16
operator|-
name|cnt
operator|)
operator|)
expr_stmt|;
name|cf
operator|=
name|d
operator|&
operator|(
literal|1
operator|<<
operator|(
literal|16
operator|-
name|cnt
operator|)
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cf
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xffff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x8000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|res
operator|=
name|d
expr_stmt|;
block|}
if|if
condition|(
name|cnt
operator|==
literal|1
condition|)
block|{
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
operator|(
operator|(
name|res
operator|&
literal|0x8000
operator|)
operator|==
literal|0x8000
operator|)
operator|^
operator|(
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
operator|!=
literal|0
operator|)
operator|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|res
operator|=
literal|0
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|d
operator|<<
operator|(
name|s
operator|-
literal|1
operator|)
operator|)
operator|&
literal|0x8000
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_SF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_PF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_ZF
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|uint16_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the SHLD instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|shld_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint32_t
name|fill
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|unsigned
name|int
name|cnt
decl_stmt|,
name|res
decl_stmt|,
name|cf
decl_stmt|;
if|if
condition|(
name|s
operator|<
literal|32
condition|)
block|{
name|cnt
operator|=
name|s
operator|%
literal|32
expr_stmt|;
if|if
condition|(
name|cnt
operator|>
literal|0
condition|)
block|{
name|res
operator|=
operator|(
name|d
operator|<<
name|cnt
operator|)
operator||
operator|(
name|fill
operator|>>
operator|(
literal|32
operator|-
name|cnt
operator|)
operator|)
expr_stmt|;
name|cf
operator|=
name|d
operator|&
operator|(
literal|1
operator|<<
operator|(
literal|32
operator|-
name|cnt
operator|)
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cf
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xffffffff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80000000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|res
operator|=
name|d
expr_stmt|;
block|}
if|if
condition|(
name|cnt
operator|==
literal|1
condition|)
block|{
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
operator|(
operator|(
name|res
operator|&
literal|0x80000000
operator|)
operator|==
literal|0x80000000
operator|)
operator|^
operator|(
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
operator|!=
literal|0
operator|)
operator|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|res
operator|=
literal|0
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|d
operator|<<
operator|(
name|s
operator|-
literal|1
operator|)
operator|)
operator|&
literal|0x80000000
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_SF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_PF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_ZF
argument_list|)
expr_stmt|;
block|}
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the SHRD instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint16_t
name|shrd_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint16_t
name|fill
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|unsigned
name|int
name|cnt
decl_stmt|,
name|res
decl_stmt|,
name|cf
decl_stmt|;
if|if
condition|(
name|s
operator|<
literal|16
condition|)
block|{
name|cnt
operator|=
name|s
operator|%
literal|16
expr_stmt|;
if|if
condition|(
name|cnt
operator|>
literal|0
condition|)
block|{
name|cf
operator|=
name|d
operator|&
operator|(
literal|1
operator|<<
operator|(
name|cnt
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
name|res
operator|=
operator|(
name|d
operator|>>
name|cnt
operator|)
operator||
operator|(
name|fill
operator|<<
operator|(
literal|16
operator|-
name|cnt
operator|)
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cf
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xffff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x8000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|res
operator|=
name|d
expr_stmt|;
block|}
if|if
condition|(
name|cnt
operator|==
literal|1
condition|)
block|{
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|res
operator|>>
literal|14
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|res
operator|=
literal|0
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_ZF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_SF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_PF
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|uint16_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the SHRD instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|shrd_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint32_t
name|fill
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|unsigned
name|int
name|cnt
decl_stmt|,
name|res
decl_stmt|,
name|cf
decl_stmt|;
if|if
condition|(
name|s
operator|<
literal|32
condition|)
block|{
name|cnt
operator|=
name|s
operator|%
literal|32
expr_stmt|;
if|if
condition|(
name|cnt
operator|>
literal|0
condition|)
block|{
name|cf
operator|=
name|d
operator|&
operator|(
literal|1
operator|<<
operator|(
name|cnt
operator|-
literal|1
operator|)
operator|)
expr_stmt|;
name|res
operator|=
operator|(
name|d
operator|>>
name|cnt
operator|)
operator||
operator|(
name|fill
operator|<<
operator|(
literal|32
operator|-
name|cnt
operator|)
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|cf
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xffffffff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80000000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|res
operator|=
name|d
expr_stmt|;
block|}
if|if
condition|(
name|cnt
operator|==
literal|1
condition|)
block|{
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|res
operator|>>
literal|30
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|res
operator|=
literal|0
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_ZF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_SF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_PF
argument_list|)
expr_stmt|;
block|}
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the SBB instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint8_t
name|sbb_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|uint32_t
name|bc
decl_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
condition|)
name|res
operator|=
name|d
operator|-
name|s
operator|-
literal|1
expr_stmt|;
else|else
name|res
operator|=
name|d
operator|-
name|s
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* calculate the borrow chain.  See note at top */
name|bc
operator|=
operator|(
name|res
operator|&
operator|(
operator|~
name|d
operator||
name|s
operator|)
operator|)
operator||
operator|(
operator|~
name|d
operator|&
name|s
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|bc
operator|&
literal|0x80
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|bc
operator|>>
literal|6
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|bc
operator|&
literal|0x8
argument_list|,
name|F_AF
argument_list|)
expr_stmt|;
return|return
operator|(
name|uint8_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the SBB instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint16_t
name|sbb_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint16_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|uint32_t
name|bc
decl_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
condition|)
name|res
operator|=
name|d
operator|-
name|s
operator|-
literal|1
expr_stmt|;
else|else
name|res
operator|=
name|d
operator|-
name|s
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x8000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xffff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* calculate the borrow chain.  See note at top */
name|bc
operator|=
operator|(
name|res
operator|&
operator|(
operator|~
name|d
operator||
name|s
operator|)
operator|)
operator||
operator|(
operator|~
name|d
operator|&
name|s
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|bc
operator|&
literal|0x8000
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|bc
operator|>>
literal|14
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|bc
operator|&
literal|0x8
argument_list|,
name|F_AF
argument_list|)
expr_stmt|;
return|return
operator|(
name|uint16_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the SBB instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|sbb_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint32_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|uint32_t
name|bc
decl_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_CF
argument_list|)
condition|)
name|res
operator|=
name|d
operator|-
name|s
operator|-
literal|1
expr_stmt|;
else|else
name|res
operator|=
name|d
operator|-
name|s
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80000000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xffffffff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* calculate the borrow chain.  See note at top */
name|bc
operator|=
operator|(
name|res
operator|&
operator|(
operator|~
name|d
operator||
name|s
operator|)
operator|)
operator||
operator|(
operator|~
name|d
operator|&
name|s
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|bc
operator|&
literal|0x80000000
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|bc
operator|>>
literal|30
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|bc
operator|&
literal|0x8
argument_list|,
name|F_AF
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the SUB instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint8_t
name|sub_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|uint32_t
name|bc
decl_stmt|;
name|res
operator|=
name|d
operator|-
name|s
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* calculate the borrow chain.  See note at top */
name|bc
operator|=
operator|(
name|res
operator|&
operator|(
operator|~
name|d
operator||
name|s
operator|)
operator|)
operator||
operator|(
operator|~
name|d
operator|&
name|s
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|bc
operator|&
literal|0x80
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|bc
operator|>>
literal|6
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|bc
operator|&
literal|0x8
argument_list|,
name|F_AF
argument_list|)
expr_stmt|;
return|return
operator|(
name|uint8_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the SUB instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint16_t
name|sub_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint16_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|uint32_t
name|bc
decl_stmt|;
name|res
operator|=
name|d
operator|-
name|s
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x8000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xffff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* calculate the borrow chain.  See note at top */
name|bc
operator|=
operator|(
name|res
operator|&
operator|(
operator|~
name|d
operator||
name|s
operator|)
operator|)
operator||
operator|(
operator|~
name|d
operator|&
name|s
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|bc
operator|&
literal|0x8000
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|bc
operator|>>
literal|14
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|bc
operator|&
literal|0x8
argument_list|,
name|F_AF
argument_list|)
expr_stmt|;
return|return
operator|(
name|uint16_t
operator|)
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the SUB instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|sub_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint32_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|uint32_t
name|bc
decl_stmt|;
name|res
operator|=
name|d
operator|-
name|s
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80000000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
operator|(
name|res
operator|&
literal|0xffffffff
operator|)
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* calculate the borrow chain.  See note at top */
name|bc
operator|=
operator|(
name|res
operator|&
operator|(
operator|~
name|d
operator||
name|s
operator|)
operator|)
operator||
operator|(
operator|~
name|d
operator|&
name|s
operator|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|bc
operator|&
literal|0x80000000
argument_list|,
name|F_CF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|XOR2
argument_list|(
name|bc
operator|>>
literal|30
argument_list|)
argument_list|,
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|bc
operator|&
literal|0x8
argument_list|,
name|F_AF
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the TEST instruction and side effects.  */
end_comment

begin_function
specifier|static
name|void
name|test_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|res
operator|=
name|d
operator|&
name|s
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* AF == dont care */
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the TEST instruction and side effects.  */
end_comment

begin_function
specifier|static
name|void
name|test_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint16_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|res
operator|=
name|d
operator|&
name|s
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x8000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* AF == dont care */
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the TEST instruction and side effects.  */
end_comment

begin_function
specifier|static
name|void
name|test_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint32_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|res
operator|=
name|d
operator|&
name|s
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80000000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
comment|/* AF == dont care */
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the XOR instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint8_t
name|xor_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|d
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|uint8_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|res
operator|=
name|d
operator|^
name|s
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_AF
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the XOR instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint16_t
name|xor_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|d
parameter_list|,
name|uint16_t
name|s
parameter_list|)
block|{
name|uint16_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|res
operator|=
name|d
operator|^
name|s
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x8000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_AF
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the XOR instruction and side effects.  */
end_comment

begin_function
specifier|static
name|uint32_t
name|xor_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|d
parameter_list|,
name|uint32_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
comment|/* all operands in native machine order */
name|res
operator|=
name|d
operator|^
name|s
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|&
literal|0x80000000
argument_list|,
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|res
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|res
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_AF
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the IMUL instruction and side effects.  */
end_comment

begin_function
specifier|static
name|void
name|imul_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|int16_t
name|res
init|=
call|(
name|int16_t
call|)
argument_list|(
operator|(
name|int8_t
operator|)
name|emu
operator|->
name|x86
operator|.
name|R_AL
operator|*
operator|(
name|int8_t
operator|)
name|s
argument_list|)
decl_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|=
name|res
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|emu
operator|->
name|x86
operator|.
name|R_AL
operator|&
literal|0x80
operator|)
operator|==
literal|0
operator|&&
name|emu
operator|->
name|x86
operator|.
name|R_AH
operator|==
literal|0x00
operator|)
operator|||
operator|(
operator|(
name|emu
operator|->
name|x86
operator|.
name|R_AL
operator|&
literal|0x80
operator|)
operator|!=
literal|0
operator|&&
name|emu
operator|->
name|x86
operator|.
name|R_AH
operator|==
literal|0xFF
operator|)
condition|)
block|{
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SET_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the IMUL instruction and side effects.  */
end_comment

begin_function
specifier|static
name|void
name|imul_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|s
parameter_list|)
block|{
name|int32_t
name|res
init|=
operator|(
name|int16_t
operator|)
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|*
operator|(
name|int16_t
operator|)
name|s
decl_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|=
operator|(
name|uint16_t
operator|)
name|res
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_DX
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|res
operator|>>
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|&
literal|0x8000
operator|)
operator|==
literal|0
operator|&&
name|emu
operator|->
name|x86
operator|.
name|R_DX
operator|==
literal|0x00
operator|)
operator|||
operator|(
operator|(
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|&
literal|0x8000
operator|)
operator|!=
literal|0
operator|&&
name|emu
operator|->
name|x86
operator|.
name|R_DX
operator|==
literal|0xFF
operator|)
condition|)
block|{
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SET_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the IMUL instruction and side effects.  */
end_comment

begin_function
specifier|static
name|void
name|imul_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|s
parameter_list|)
block|{
name|int64_t
name|res
decl_stmt|;
name|res
operator|=
operator|(
name|int64_t
operator|)
operator|(
name|int32_t
operator|)
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|*
operator|(
name|int32_t
operator|)
name|s
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|=
operator|(
name|uint32_t
operator|)
name|res
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EDX
operator|=
operator|(
operator|(
name|uint64_t
operator|)
name|res
operator|)
operator|>>
literal|32
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|&
literal|0x80000000
operator|)
operator|==
literal|0
operator|&&
name|emu
operator|->
name|x86
operator|.
name|R_EDX
operator|==
literal|0x00
operator|)
operator|||
operator|(
operator|(
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|&
literal|0x80000000
operator|)
operator|!=
literal|0
operator|&&
name|emu
operator|->
name|x86
operator|.
name|R_EDX
operator|==
literal|0xFF
operator|)
condition|)
block|{
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SET_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the MUL instruction and side effects.  */
end_comment

begin_function
specifier|static
name|void
name|mul_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|uint16_t
name|res
init|=
call|(
name|uint16_t
call|)
argument_list|(
name|emu
operator|->
name|x86
operator|.
name|R_AL
operator|*
name|s
argument_list|)
decl_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|=
name|res
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|R_AH
operator|==
literal|0
condition|)
block|{
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SET_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the MUL instruction and side effects.  */
end_comment

begin_function
specifier|static
name|void
name|mul_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|s
parameter_list|)
block|{
name|uint32_t
name|res
init|=
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|*
name|s
decl_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|=
operator|(
name|uint16_t
operator|)
name|res
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_DX
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|res
operator|>>
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|R_DX
operator|==
literal|0
condition|)
block|{
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SET_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the MUL instruction and side effects.  */
end_comment

begin_function
specifier|static
name|void
name|mul_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|s
parameter_list|)
block|{
name|uint64_t
name|res
init|=
operator|(
name|uint64_t
operator|)
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|*
name|s
decl_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|=
operator|(
name|uint32_t
operator|)
name|res
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EDX
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|res
operator|>>
literal|32
argument_list|)
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|R_EDX
operator|==
literal|0
condition|)
block|{
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SET_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_OF
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the IDIV instruction and side effects.  */
end_comment

begin_function
specifier|static
name|void
name|idiv_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|int32_t
name|dvd
decl_stmt|,
name|div
decl_stmt|,
name|mod
decl_stmt|;
name|dvd
operator|=
operator|(
name|int16_t
operator|)
name|emu
operator|->
name|x86
operator|.
name|R_AX
expr_stmt|;
if|if
condition|(
name|s
operator|==
literal|0
condition|)
block|{
name|x86emu_intr_raise
argument_list|(
name|emu
argument_list|,
literal|8
argument_list|)
expr_stmt|;
return|return;
block|}
name|div
operator|=
name|dvd
operator|/
operator|(
name|int8_t
operator|)
name|s
expr_stmt|;
name|mod
operator|=
name|dvd
operator|%
operator|(
name|int8_t
operator|)
name|s
expr_stmt|;
if|if
condition|(
name|div
operator|>
literal|0x7f
operator|||
name|div
operator|<
operator|-
literal|0x7f
condition|)
block|{
name|x86emu_intr_raise
argument_list|(
name|emu
argument_list|,
literal|8
argument_list|)
expr_stmt|;
return|return;
block|}
name|emu
operator|->
name|x86
operator|.
name|R_AL
operator|=
operator|(
name|int8_t
operator|)
name|div
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_AH
operator|=
operator|(
name|int8_t
operator|)
name|mod
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the IDIV instruction and side effects.  */
end_comment

begin_function
specifier|static
name|void
name|idiv_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|s
parameter_list|)
block|{
name|int32_t
name|dvd
decl_stmt|,
name|div
decl_stmt|,
name|mod
decl_stmt|;
name|dvd
operator|=
operator|(
operator|(
operator|(
name|int32_t
operator|)
name|emu
operator|->
name|x86
operator|.
name|R_DX
operator|)
operator|<<
literal|16
operator|)
operator||
name|emu
operator|->
name|x86
operator|.
name|R_AX
expr_stmt|;
if|if
condition|(
name|s
operator|==
literal|0
condition|)
block|{
name|x86emu_intr_raise
argument_list|(
name|emu
argument_list|,
literal|8
argument_list|)
expr_stmt|;
return|return;
block|}
name|div
operator|=
name|dvd
operator|/
operator|(
name|int16_t
operator|)
name|s
expr_stmt|;
name|mod
operator|=
name|dvd
operator|%
operator|(
name|int16_t
operator|)
name|s
expr_stmt|;
if|if
condition|(
name|div
operator|>
literal|0x7fff
operator|||
name|div
operator|<
operator|-
literal|0x7fff
condition|)
block|{
name|x86emu_intr_raise
argument_list|(
name|emu
argument_list|,
literal|8
argument_list|)
expr_stmt|;
return|return;
block|}
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|div
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|mod
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|=
operator|(
name|uint16_t
operator|)
name|div
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_DX
operator|=
operator|(
name|uint16_t
operator|)
name|mod
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the IDIV instruction and side effects.  */
end_comment

begin_function
specifier|static
name|void
name|idiv_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|s
parameter_list|)
block|{
name|int64_t
name|dvd
decl_stmt|,
name|div
decl_stmt|,
name|mod
decl_stmt|;
name|dvd
operator|=
operator|(
operator|(
operator|(
name|int64_t
operator|)
name|emu
operator|->
name|x86
operator|.
name|R_EDX
operator|)
operator|<<
literal|32
operator|)
operator||
name|emu
operator|->
name|x86
operator|.
name|R_EAX
expr_stmt|;
if|if
condition|(
name|s
operator|==
literal|0
condition|)
block|{
name|x86emu_intr_raise
argument_list|(
name|emu
argument_list|,
literal|8
argument_list|)
expr_stmt|;
return|return;
block|}
name|div
operator|=
name|dvd
operator|/
operator|(
name|int32_t
operator|)
name|s
expr_stmt|;
name|mod
operator|=
name|dvd
operator|%
operator|(
name|int32_t
operator|)
name|s
expr_stmt|;
if|if
condition|(
name|div
operator|>
literal|0x7fffffff
operator|||
name|div
operator|<
operator|-
literal|0x7fffffff
condition|)
block|{
name|x86emu_intr_raise
argument_list|(
name|emu
argument_list|,
literal|8
argument_list|)
expr_stmt|;
return|return;
block|}
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_AF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_SF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|mod
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|=
operator|(
name|uint32_t
operator|)
name|div
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EDX
operator|=
operator|(
name|uint32_t
operator|)
name|mod
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the DIV instruction and side effects.  */
end_comment

begin_function
specifier|static
name|void
name|div_byte
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint8_t
name|s
parameter_list|)
block|{
name|uint32_t
name|dvd
decl_stmt|,
name|div
decl_stmt|,
name|mod
decl_stmt|;
name|dvd
operator|=
name|emu
operator|->
name|x86
operator|.
name|R_AX
expr_stmt|;
if|if
condition|(
name|s
operator|==
literal|0
condition|)
block|{
name|x86emu_intr_raise
argument_list|(
name|emu
argument_list|,
literal|8
argument_list|)
expr_stmt|;
return|return;
block|}
name|div
operator|=
name|dvd
operator|/
operator|(
name|uint8_t
operator|)
name|s
expr_stmt|;
name|mod
operator|=
name|dvd
operator|%
operator|(
name|uint8_t
operator|)
name|s
expr_stmt|;
if|if
condition|(
name|div
operator|>
literal|0xff
condition|)
block|{
name|x86emu_intr_raise
argument_list|(
name|emu
argument_list|,
literal|8
argument_list|)
expr_stmt|;
return|return;
block|}
name|emu
operator|->
name|x86
operator|.
name|R_AL
operator|=
operator|(
name|uint8_t
operator|)
name|div
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_AH
operator|=
operator|(
name|uint8_t
operator|)
name|mod
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the DIV instruction and side effects.  */
end_comment

begin_function
specifier|static
name|void
name|div_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|s
parameter_list|)
block|{
name|uint32_t
name|dvd
decl_stmt|,
name|div
decl_stmt|,
name|mod
decl_stmt|;
name|dvd
operator|=
operator|(
operator|(
operator|(
name|uint32_t
operator|)
name|emu
operator|->
name|x86
operator|.
name|R_DX
operator|)
operator|<<
literal|16
operator|)
operator||
name|emu
operator|->
name|x86
operator|.
name|R_AX
expr_stmt|;
if|if
condition|(
name|s
operator|==
literal|0
condition|)
block|{
name|x86emu_intr_raise
argument_list|(
name|emu
argument_list|,
literal|8
argument_list|)
expr_stmt|;
return|return;
block|}
name|div
operator|=
name|dvd
operator|/
operator|(
name|uint16_t
operator|)
name|s
expr_stmt|;
name|mod
operator|=
name|dvd
operator|%
operator|(
name|uint16_t
operator|)
name|s
expr_stmt|;
if|if
condition|(
name|div
operator|>
literal|0xffff
condition|)
block|{
name|x86emu_intr_raise
argument_list|(
name|emu
argument_list|,
literal|8
argument_list|)
expr_stmt|;
return|return;
block|}
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_SF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|div
operator|==
literal|0
argument_list|,
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|mod
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_AX
operator|=
operator|(
name|uint16_t
operator|)
name|div
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_DX
operator|=
operator|(
name|uint16_t
operator|)
name|mod
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the DIV instruction and side effects.  */
end_comment

begin_function
specifier|static
name|void
name|div_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|s
parameter_list|)
block|{
name|uint64_t
name|dvd
decl_stmt|,
name|div
decl_stmt|,
name|mod
decl_stmt|;
name|dvd
operator|=
operator|(
operator|(
operator|(
name|uint64_t
operator|)
name|emu
operator|->
name|x86
operator|.
name|R_EDX
operator|)
operator|<<
literal|32
operator|)
operator||
name|emu
operator|->
name|x86
operator|.
name|R_EAX
expr_stmt|;
if|if
condition|(
name|s
operator|==
literal|0
condition|)
block|{
name|x86emu_intr_raise
argument_list|(
name|emu
argument_list|,
literal|8
argument_list|)
expr_stmt|;
return|return;
block|}
name|div
operator|=
name|dvd
operator|/
operator|(
name|uint32_t
operator|)
name|s
expr_stmt|;
name|mod
operator|=
name|dvd
operator|%
operator|(
name|uint32_t
operator|)
name|s
expr_stmt|;
if|if
condition|(
name|div
operator|>
literal|0xffffffff
condition|)
block|{
name|x86emu_intr_raise
argument_list|(
name|emu
argument_list|,
literal|8
argument_list|)
expr_stmt|;
return|return;
block|}
name|CLEAR_FLAG
argument_list|(
name|F_CF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_AF
argument_list|)
expr_stmt|;
name|CLEAR_FLAG
argument_list|(
name|F_SF
argument_list|)
expr_stmt|;
name|SET_FLAG
argument_list|(
name|F_ZF
argument_list|)
expr_stmt|;
name|CONDITIONAL_SET_FLAG
argument_list|(
name|PARITY
argument_list|(
name|mod
operator|&
literal|0xff
argument_list|)
argument_list|,
name|F_PF
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EAX
operator|=
operator|(
name|uint32_t
operator|)
name|div
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_EDX
operator|=
operator|(
name|uint32_t
operator|)
name|mod
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the IN string instruction and side effects.  */
end_comment

begin_function
specifier|static
name|void
name|ins
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|int
name|inc
init|=
name|size
decl_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_DF
argument_list|)
condition|)
block|{
name|inc
operator|=
operator|-
name|size
expr_stmt|;
block|}
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
operator|(
name|SYSMODE_PREFIX_REPE
operator||
name|SYSMODE_PREFIX_REPNE
operator|)
condition|)
block|{
comment|/* dont care whether REPE or REPNE */
comment|/* in until CX is ZERO. */
name|uint32_t
name|count
init|=
operator|(
operator|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
operator|)
condition|?
name|emu
operator|->
name|x86
operator|.
name|R_ECX
else|:
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|)
decl_stmt|;
switch|switch
condition|(
name|size
condition|)
block|{
case|case
literal|1
case|:
while|while
condition|(
name|count
operator|--
condition|)
block|{
name|store_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|,
call|(
modifier|*
name|emu
operator|->
name|emu_inb
call|)
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DX
argument_list|)
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_DI
operator|+=
name|inc
expr_stmt|;
block|}
break|break;
case|case
literal|2
case|:
while|while
condition|(
name|count
operator|--
condition|)
block|{
name|store_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|,
call|(
modifier|*
name|emu
operator|->
name|emu_inw
call|)
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DX
argument_list|)
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_DI
operator|+=
name|inc
expr_stmt|;
block|}
break|break;
case|case
literal|4
case|:
while|while
condition|(
name|count
operator|--
condition|)
block|{
name|store_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|,
call|(
modifier|*
name|emu
operator|->
name|emu_inl
call|)
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DX
argument_list|)
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_DI
operator|+=
name|inc
expr_stmt|;
break|break;
block|}
block|}
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|emu
operator|->
name|x86
operator|.
name|R_ECX
operator|=
literal|0
expr_stmt|;
block|}
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&=
operator|~
operator|(
name|SYSMODE_PREFIX_REPE
operator||
name|SYSMODE_PREFIX_REPNE
operator|)
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|size
condition|)
block|{
case|case
literal|1
case|:
name|store_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|,
call|(
modifier|*
name|emu
operator|->
name|emu_inb
call|)
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DX
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|store_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|,
call|(
modifier|*
name|emu
operator|->
name|emu_inw
call|)
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DX
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|store_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DI
argument_list|,
call|(
modifier|*
name|emu
operator|->
name|emu_inl
call|)
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DX
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|emu
operator|->
name|x86
operator|.
name|R_DI
operator|+=
name|inc
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Implements the OUT string instruction and side effects.  */
end_comment

begin_function
specifier|static
name|void
name|outs
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|int
name|size
parameter_list|)
block|{
name|int
name|inc
init|=
name|size
decl_stmt|;
if|if
condition|(
name|ACCESS_FLAG
argument_list|(
name|F_DF
argument_list|)
condition|)
block|{
name|inc
operator|=
operator|-
name|size
expr_stmt|;
block|}
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
operator|(
name|SYSMODE_PREFIX_REPE
operator||
name|SYSMODE_PREFIX_REPNE
operator|)
condition|)
block|{
comment|/* dont care whether REPE or REPNE */
comment|/* out until CX is ZERO. */
name|uint32_t
name|count
init|=
operator|(
operator|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
operator|)
condition|?
name|emu
operator|->
name|x86
operator|.
name|R_ECX
else|:
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|)
decl_stmt|;
switch|switch
condition|(
name|size
condition|)
block|{
case|case
literal|1
case|:
while|while
condition|(
name|count
operator|--
condition|)
block|{
call|(
modifier|*
name|emu
operator|->
name|emu_outb
call|)
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DX
argument_list|,
name|fetch_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SI
argument_list|)
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_SI
operator|+=
name|inc
expr_stmt|;
block|}
break|break;
case|case
literal|2
case|:
while|while
condition|(
name|count
operator|--
condition|)
block|{
call|(
modifier|*
name|emu
operator|->
name|emu_outw
call|)
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DX
argument_list|,
name|fetch_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SI
argument_list|)
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_SI
operator|+=
name|inc
expr_stmt|;
block|}
break|break;
case|case
literal|4
case|:
while|while
condition|(
name|count
operator|--
condition|)
block|{
call|(
modifier|*
name|emu
operator|->
name|emu_outl
call|)
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DX
argument_list|,
name|fetch_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SI
argument_list|)
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_SI
operator|+=
name|inc
expr_stmt|;
break|break;
block|}
block|}
name|emu
operator|->
name|x86
operator|.
name|R_CX
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&
name|SYSMODE_PREFIX_DATA
condition|)
block|{
name|emu
operator|->
name|x86
operator|.
name|R_ECX
operator|=
literal|0
expr_stmt|;
block|}
name|emu
operator|->
name|x86
operator|.
name|mode
operator|&=
operator|~
operator|(
name|SYSMODE_PREFIX_REPE
operator||
name|SYSMODE_PREFIX_REPNE
operator|)
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|size
condition|)
block|{
case|case
literal|1
case|:
call|(
modifier|*
name|emu
operator|->
name|emu_outb
call|)
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DX
argument_list|,
name|fetch_byte
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SI
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
call|(
modifier|*
name|emu
operator|->
name|emu_outw
call|)
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DX
argument_list|,
name|fetch_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SI
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
call|(
modifier|*
name|emu
operator|->
name|emu_outl
call|)
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_DX
argument_list|,
name|fetch_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_ES
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SI
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|emu
operator|->
name|x86
operator|.
name|R_SI
operator|+=
name|inc
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Pushes a word onto the stack.  *   * NOTE: Do not inline this, as (*emu->emu_wrX) is already inline!  */
end_comment

begin_function
specifier|static
name|void
name|push_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint16_t
name|w
parameter_list|)
block|{
name|emu
operator|->
name|x86
operator|.
name|R_SP
operator|-=
literal|2
expr_stmt|;
name|store_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SS
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SP
argument_list|,
name|w
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Pushes a long onto the stack.  *   * NOTE: Do not inline this, as (*emu->emu_wrX) is already inline!  */
end_comment

begin_function
specifier|static
name|void
name|push_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|,
name|uint32_t
name|w
parameter_list|)
block|{
name|emu
operator|->
name|x86
operator|.
name|R_SP
operator|-=
literal|4
expr_stmt|;
name|store_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SS
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SP
argument_list|,
name|w
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Pops a word from the stack.  *   * NOTE: Do not inline this, as (*emu->emu_rdX) is already inline!  */
end_comment

begin_function
specifier|static
name|uint16_t
name|pop_word
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint16_t
name|res
decl_stmt|;
name|res
operator|=
name|fetch_word
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SS
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SP
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_SP
operator|+=
literal|2
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/*  * REMARKS:  * Pops a long from the stack.  *   * NOTE: Do not inline this, as (*emu->emu_rdX) is already inline!  */
end_comment

begin_function
specifier|static
name|uint32_t
name|pop_long
parameter_list|(
name|struct
name|x86emu
modifier|*
name|emu
parameter_list|)
block|{
name|uint32_t
name|res
decl_stmt|;
name|res
operator|=
name|fetch_long
argument_list|(
name|emu
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SS
argument_list|,
name|emu
operator|->
name|x86
operator|.
name|R_SP
argument_list|)
expr_stmt|;
name|emu
operator|->
name|x86
operator|.
name|R_SP
operator|+=
literal|4
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

end_unit


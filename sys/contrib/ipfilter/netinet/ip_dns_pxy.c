begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2012 by Darren Reed.  *  * See the IPFILTER.LICENCE file for details on licencing.  *  * $Id: ip_dns_pxy.c,v 1.1.2.10 2012/07/22 08:04:23 darren_r Exp $  */
end_comment

begin_define
define|#
directive|define
name|IPF_DNS_PROXY
end_define

begin_comment
comment|/*  * map ... proxy port dns/udp 53 { block .cnn.com; }  */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|ipf_dns_filter
block|{
name|struct
name|ipf_dns_filter
modifier|*
name|idns_next
decl_stmt|;
name|char
modifier|*
name|idns_name
decl_stmt|;
name|int
name|idns_namelen
decl_stmt|;
name|int
name|idns_pass
decl_stmt|;
block|}
name|ipf_dns_filter_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
name|ipf_dns_softc_s
block|{
name|ipf_dns_filter_t
modifier|*
name|ipf_p_dns_list
decl_stmt|;
name|ipfrwlock_t
name|ipf_p_dns_rwlock
decl_stmt|;
name|u_long
name|ipf_p_dns_compress
decl_stmt|;
name|u_long
name|ipf_p_dns_toolong
decl_stmt|;
name|u_long
name|ipf_p_dns_nospace
decl_stmt|;
block|}
name|ipf_dns_softc_t
typedef|;
end_typedef

begin_decl_stmt
name|int
name|ipf_p_dns_allow_query
name|__P
argument_list|(
operator|(
name|ipf_dns_softc_t
operator|*
operator|,
name|dnsinfo_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ipf_p_dns_ctl
name|__P
argument_list|(
operator|(
name|ipf_main_softc_t
operator|*
operator|,
name|void
operator|*
operator|,
name|ap_ctl_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ipf_p_dns_del
name|__P
argument_list|(
operator|(
name|ipf_main_softc_t
operator|*
operator|,
name|ap_session_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ipf_p_dns_get_name
name|__P
argument_list|(
operator|(
name|ipf_dns_softc_t
operator|*
operator|,
name|char
operator|*
operator|,
name|int
operator|,
name|char
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ipf_p_dns_inout
name|__P
argument_list|(
operator|(
name|void
operator|*
operator|,
name|fr_info_t
operator|*
operator|,
name|ap_session_t
operator|*
operator|,
name|nat_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ipf_p_dns_match
name|__P
argument_list|(
operator|(
name|fr_info_t
operator|*
operator|,
name|ap_session_t
operator|*
operator|,
name|nat_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ipf_p_dns_match_names
name|__P
argument_list|(
operator|(
name|ipf_dns_filter_t
operator|*
operator|,
name|char
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ipf_p_dns_new
name|__P
argument_list|(
operator|(
name|void
operator|*
operator|,
name|fr_info_t
operator|*
operator|,
name|ap_session_t
operator|*
operator|,
name|nat_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
modifier|*
name|ipf_p_dns_soft_create
name|__P
argument_list|(
operator|(
name|ipf_main_softc_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ipf_p_dns_soft_destroy
name|__P
argument_list|(
operator|(
name|ipf_main_softc_t
operator|*
operator|,
name|void
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_typedef
typedef|typedef
struct|struct
block|{
name|u_char
name|dns_id
index|[
literal|2
index|]
decl_stmt|;
name|u_short
name|dns_ctlword
decl_stmt|;
name|u_short
name|dns_qdcount
decl_stmt|;
name|u_short
name|dns_ancount
decl_stmt|;
name|u_short
name|dns_nscount
decl_stmt|;
name|u_short
name|dns_arcount
decl_stmt|;
block|}
name|ipf_dns_hdr_t
typedef|;
end_typedef

begin_define
define|#
directive|define
name|DNS_QR
parameter_list|(
name|x
parameter_list|)
value|((ntohs(x)& 0x8000)>> 15)
end_define

begin_define
define|#
directive|define
name|DNS_OPCODE
parameter_list|(
name|x
parameter_list|)
value|((ntohs(x)& 0x7800)>> 11)
end_define

begin_define
define|#
directive|define
name|DNS_AA
parameter_list|(
name|x
parameter_list|)
value|((ntohs(x)& 0x0400)>> 10)
end_define

begin_define
define|#
directive|define
name|DNS_TC
parameter_list|(
name|x
parameter_list|)
value|((ntohs(x)& 0x0200)>> 9)
end_define

begin_define
define|#
directive|define
name|DNS_RD
parameter_list|(
name|x
parameter_list|)
value|((ntohs(x)& 0x0100)>> 8)
end_define

begin_define
define|#
directive|define
name|DNS_RA
parameter_list|(
name|x
parameter_list|)
value|((ntohs(x)& 0x0080)>> 7)
end_define

begin_define
define|#
directive|define
name|DNS_Z
parameter_list|(
name|x
parameter_list|)
value|((ntohs(x)& 0x0070)>> 4)
end_define

begin_define
define|#
directive|define
name|DNS_RCODE
parameter_list|(
name|x
parameter_list|)
value|((ntohs(x)& 0x000f)>> 0)
end_define

begin_function
name|void
modifier|*
name|ipf_p_dns_soft_create
parameter_list|(
name|softc
parameter_list|)
name|ipf_main_softc_t
modifier|*
name|softc
decl_stmt|;
block|{
name|ipf_dns_softc_t
modifier|*
name|softd
decl_stmt|;
name|KMALLOC
argument_list|(
name|softd
argument_list|,
name|ipf_dns_softc_t
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|softd
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|softd
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|softd
argument_list|)
argument_list|)
expr_stmt|;
name|RWLOCK_INIT
argument_list|(
operator|&
name|softd
operator|->
name|ipf_p_dns_rwlock
argument_list|,
literal|"ipf dns rwlock"
argument_list|)
expr_stmt|;
return|return
name|softd
return|;
block|}
end_function

begin_function
name|void
name|ipf_p_dns_soft_destroy
parameter_list|(
name|softc
parameter_list|,
name|arg
parameter_list|)
name|ipf_main_softc_t
modifier|*
name|softc
decl_stmt|;
name|void
modifier|*
name|arg
decl_stmt|;
block|{
name|ipf_dns_softc_t
modifier|*
name|softd
init|=
name|arg
decl_stmt|;
name|ipf_dns_filter_t
modifier|*
name|idns
decl_stmt|;
while|while
condition|(
operator|(
name|idns
operator|=
name|softd
operator|->
name|ipf_p_dns_list
operator|)
operator|!=
name|NULL
condition|)
block|{
name|KFREES
argument_list|(
name|idns
operator|->
name|idns_name
argument_list|,
name|idns
operator|->
name|idns_namelen
argument_list|)
expr_stmt|;
name|idns
operator|->
name|idns_name
operator|=
name|NULL
expr_stmt|;
name|idns
operator|->
name|idns_namelen
operator|=
literal|0
expr_stmt|;
name|softd
operator|->
name|ipf_p_dns_list
operator|=
name|idns
operator|->
name|idns_next
expr_stmt|;
name|KFREE
argument_list|(
name|idns
argument_list|)
expr_stmt|;
block|}
name|RW_DESTROY
argument_list|(
operator|&
name|softd
operator|->
name|ipf_p_dns_rwlock
argument_list|)
expr_stmt|;
name|KFREE
argument_list|(
name|softd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ipf_p_dns_ctl
parameter_list|(
name|softc
parameter_list|,
name|arg
parameter_list|,
name|ctl
parameter_list|)
name|ipf_main_softc_t
modifier|*
name|softc
decl_stmt|;
name|void
modifier|*
name|arg
decl_stmt|;
name|ap_ctl_t
modifier|*
name|ctl
decl_stmt|;
block|{
name|ipf_dns_softc_t
modifier|*
name|softd
init|=
name|arg
decl_stmt|;
name|ipf_dns_filter_t
modifier|*
name|tmp
decl_stmt|,
modifier|*
name|idns
decl_stmt|,
modifier|*
modifier|*
name|idnsp
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
comment|/* 	 * To make locking easier. 	 */
name|KMALLOC
argument_list|(
name|tmp
argument_list|,
name|ipf_dns_filter_t
operator|*
argument_list|)
expr_stmt|;
name|WRITE_ENTER
argument_list|(
operator|&
name|softd
operator|->
name|ipf_p_dns_rwlock
argument_list|)
expr_stmt|;
for|for
control|(
name|idnsp
operator|=
operator|&
name|softd
operator|->
name|ipf_p_dns_list
init|;
operator|(
name|idns
operator|=
operator|*
name|idnsp
operator|)
operator|!=
name|NULL
condition|;
name|idnsp
operator|=
operator|&
name|idns
operator|->
name|idns_next
control|)
block|{
if|if
condition|(
name|idns
operator|->
name|idns_namelen
operator|!=
name|ctl
operator|->
name|apc_dsize
condition|)
continue|continue;
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|ctl
operator|->
name|apc_data
argument_list|,
name|idns
operator|->
name|idns_name
argument_list|,
name|idns
operator|->
name|idns_namelen
argument_list|)
condition|)
break|break;
block|}
switch|switch
condition|(
name|ctl
operator|->
name|apc_cmd
condition|)
block|{
case|case
name|APC_CMD_DEL
case|:
if|if
condition|(
name|idns
operator|==
name|NULL
condition|)
block|{
name|IPFERROR
argument_list|(
literal|80006
argument_list|)
expr_stmt|;
name|error
operator|=
name|ESRCH
expr_stmt|;
break|break;
block|}
operator|*
name|idnsp
operator|=
name|idns
operator|->
name|idns_next
expr_stmt|;
name|idns
operator|->
name|idns_next
operator|=
name|NULL
expr_stmt|;
name|KFREES
argument_list|(
name|idns
operator|->
name|idns_name
argument_list|,
name|idns
operator|->
name|idns_namelen
argument_list|)
expr_stmt|;
name|idns
operator|->
name|idns_name
operator|=
name|NULL
expr_stmt|;
name|idns
operator|->
name|idns_namelen
operator|=
literal|0
expr_stmt|;
name|KFREE
argument_list|(
name|idns
argument_list|)
expr_stmt|;
break|break;
case|case
name|APC_CMD_ADD
case|:
if|if
condition|(
name|idns
operator|!=
name|NULL
condition|)
block|{
name|IPFERROR
argument_list|(
literal|80007
argument_list|)
expr_stmt|;
name|error
operator|=
name|EEXIST
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
block|{
name|IPFERROR
argument_list|(
literal|80008
argument_list|)
expr_stmt|;
name|error
operator|=
name|ENOMEM
expr_stmt|;
break|break;
block|}
name|idns
operator|=
name|tmp
expr_stmt|;
name|tmp
operator|=
name|NULL
expr_stmt|;
name|idns
operator|->
name|idns_namelen
operator|=
name|ctl
operator|->
name|apc_dsize
expr_stmt|;
name|idns
operator|->
name|idns_name
operator|=
name|ctl
operator|->
name|apc_data
expr_stmt|;
name|idns
operator|->
name|idns_pass
operator|=
name|ctl
operator|->
name|apc_arg
expr_stmt|;
name|idns
operator|->
name|idns_next
operator|=
name|NULL
expr_stmt|;
operator|*
name|idnsp
operator|=
name|idns
expr_stmt|;
name|ctl
operator|->
name|apc_data
operator|=
name|NULL
expr_stmt|;
name|ctl
operator|->
name|apc_dsize
operator|=
literal|0
expr_stmt|;
break|break;
default|default :
name|IPFERROR
argument_list|(
literal|80009
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|RWLOCK_EXIT
argument_list|(
operator|&
name|softd
operator|->
name|ipf_p_dns_rwlock
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|!=
name|NULL
condition|)
block|{
name|KFREE
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|error
return|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|int
name|ipf_p_dns_new
parameter_list|(
name|arg
parameter_list|,
name|fin
parameter_list|,
name|aps
parameter_list|,
name|nat
parameter_list|)
name|void
modifier|*
name|arg
decl_stmt|;
name|fr_info_t
modifier|*
name|fin
decl_stmt|;
name|ap_session_t
modifier|*
name|aps
decl_stmt|;
name|nat_t
modifier|*
name|nat
decl_stmt|;
block|{
name|dnsinfo_t
modifier|*
name|di
decl_stmt|;
name|int
name|dlen
decl_stmt|;
if|if
condition|(
name|fin
operator|->
name|fin_v
operator|!=
literal|4
condition|)
return|return
operator|-
literal|1
return|;
name|dlen
operator|=
name|fin
operator|->
name|fin_dlen
operator|-
sizeof|sizeof
argument_list|(
name|udphdr_t
argument_list|)
expr_stmt|;
if|if
condition|(
name|dlen
operator|<
sizeof|sizeof
argument_list|(
name|ipf_dns_hdr_t
argument_list|)
condition|)
block|{
comment|/* 		 * No real DNS packet is smaller than that. 		 */
return|return
operator|-
literal|1
return|;
block|}
name|aps
operator|->
name|aps_psiz
operator|=
sizeof|sizeof
argument_list|(
name|dnsinfo_t
argument_list|)
expr_stmt|;
name|KMALLOCS
argument_list|(
name|di
argument_list|,
name|dnsinfo_t
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
name|dnsinfo_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|di
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"ipf_dns_new:KMALLOCS(%d) failed\n"
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|di
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|MUTEX_INIT
argument_list|(
operator|&
name|di
operator|->
name|dnsi_lock
argument_list|,
literal|"dns lock"
argument_list|)
expr_stmt|;
name|aps
operator|->
name|aps_data
operator|=
name|di
expr_stmt|;
name|dlen
operator|=
name|fin
operator|->
name|fin_dlen
operator|-
sizeof|sizeof
argument_list|(
name|udphdr_t
argument_list|)
expr_stmt|;
name|COPYDATA
argument_list|(
name|fin
operator|->
name|fin_m
argument_list|,
name|fin
operator|->
name|fin_hlen
operator|+
sizeof|sizeof
argument_list|(
name|udphdr_t
argument_list|)
argument_list|,
name|MIN
argument_list|(
name|dlen
argument_list|,
sizeof|sizeof
argument_list|(
name|di
operator|->
name|dnsi_buffer
argument_list|)
argument_list|)
argument_list|,
name|di
operator|->
name|dnsi_buffer
argument_list|)
expr_stmt|;
name|di
operator|->
name|dnsi_id
operator|=
operator|(
name|di
operator|->
name|dnsi_buffer
index|[
literal|0
index|]
operator|<<
literal|8
operator|)
operator||
name|di
operator|->
name|dnsi_buffer
index|[
literal|1
index|]
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|void
name|ipf_p_dns_del
parameter_list|(
name|softc
parameter_list|,
name|aps
parameter_list|)
name|ipf_main_softc_t
modifier|*
name|softc
decl_stmt|;
name|ap_session_t
modifier|*
name|aps
decl_stmt|;
block|{
ifdef|#
directive|ifdef
name|USE_MUTEXES
name|dnsinfo_t
modifier|*
name|di
init|=
name|aps
operator|->
name|aps_data
decl_stmt|;
name|MUTEX_DESTROY
argument_list|(
operator|&
name|di
operator|->
name|dnsi_lock
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|KFREES
argument_list|(
name|aps
operator|->
name|aps_data
argument_list|,
name|aps
operator|->
name|aps_psiz
argument_list|)
expr_stmt|;
name|aps
operator|->
name|aps_data
operator|=
name|NULL
expr_stmt|;
name|aps
operator|->
name|aps_psiz
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Tries to match the base string (in our ACL) with the query from a packet.  */
end_comment

begin_function
name|int
name|ipf_p_dns_match_names
parameter_list|(
name|idns
parameter_list|,
name|query
parameter_list|,
name|qlen
parameter_list|)
name|ipf_dns_filter_t
modifier|*
name|idns
decl_stmt|;
name|char
modifier|*
name|query
decl_stmt|;
name|int
name|qlen
decl_stmt|;
block|{
name|int
name|blen
decl_stmt|;
name|char
modifier|*
name|base
decl_stmt|;
name|blen
operator|=
name|idns
operator|->
name|idns_namelen
expr_stmt|;
name|base
operator|=
name|idns
operator|->
name|idns_name
expr_stmt|;
if|if
condition|(
name|blen
operator|>
name|qlen
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|blen
operator|==
name|qlen
condition|)
return|return
name|strncasecmp
argument_list|(
name|base
argument_list|,
name|query
argument_list|,
name|qlen
argument_list|)
return|;
comment|/* 	 * If the base string string is shorter than the query, allow the 	 * tail of the base to match the same length tail of the query *if*: 	 * - the base string starts with a '*' (*cnn.com) 	 * - the base string represents a domain (.cnn.com) 	 * as otherwise it would not be possible to block just "cnn.com" 	 * without also impacting "foocnn.com", etc. 	 */
if|if
condition|(
operator|*
name|base
operator|==
literal|'*'
condition|)
block|{
name|base
operator|++
expr_stmt|;
name|blen
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|base
operator|!=
literal|'.'
condition|)
return|return
literal|1
return|;
return|return
name|strncasecmp
argument_list|(
name|base
argument_list|,
name|query
operator|+
name|qlen
operator|-
name|blen
argument_list|,
name|blen
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|ipf_p_dns_get_name
parameter_list|(
name|softd
parameter_list|,
name|start
parameter_list|,
name|len
parameter_list|,
name|buffer
parameter_list|,
name|buflen
parameter_list|)
name|ipf_dns_softc_t
modifier|*
name|softd
decl_stmt|;
name|char
modifier|*
name|start
decl_stmt|;
name|int
name|len
decl_stmt|;
name|char
modifier|*
name|buffer
decl_stmt|;
name|int
name|buflen
decl_stmt|;
block|{
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|t
decl_stmt|,
name|clen
decl_stmt|;
name|int
name|slen
decl_stmt|,
name|blen
decl_stmt|;
name|s
operator|=
name|start
expr_stmt|;
name|t
operator|=
name|buffer
expr_stmt|;
name|slen
operator|=
name|len
expr_stmt|;
name|blen
operator|=
name|buflen
operator|-
literal|1
expr_stmt|;
comment|/* Always make room for trailing \0 */
while|while
condition|(
operator|*
name|s
operator|!=
literal|'\0'
condition|)
block|{
name|clen
operator|=
operator|*
name|s
expr_stmt|;
if|if
condition|(
operator|(
name|clen
operator|&
literal|0xc0
operator|)
operator|==
literal|0xc0
condition|)
block|{
comment|/* Doesn't do compression */
name|softd
operator|->
name|ipf_p_dns_compress
operator|++
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|clen
operator|>
name|slen
condition|)
block|{
name|softd
operator|->
name|ipf_p_dns_toolong
operator|++
expr_stmt|;
return|return
literal|0
return|;
comment|/* Does the name run off the end? */
block|}
if|if
condition|(
operator|(
name|clen
operator|+
literal|1
operator|)
operator|>
name|blen
condition|)
block|{
name|softd
operator|->
name|ipf_p_dns_nospace
operator|++
expr_stmt|;
return|return
literal|0
return|;
comment|/* Enough room for name+.? */
block|}
name|s
operator|++
expr_stmt|;
name|bcopy
argument_list|(
name|s
argument_list|,
name|t
argument_list|,
name|clen
argument_list|)
expr_stmt|;
name|t
operator|+=
name|clen
expr_stmt|;
name|s
operator|+=
name|clen
expr_stmt|;
operator|*
name|t
operator|++
operator|=
literal|'.'
expr_stmt|;
name|slen
operator|-=
name|clen
expr_stmt|;
name|blen
operator|-=
operator|(
name|clen
operator|+
literal|1
operator|)
expr_stmt|;
block|}
operator|*
operator|(
name|t
operator|-
literal|1
operator|)
operator|=
literal|'\0'
expr_stmt|;
return|return
name|s
operator|-
name|start
return|;
block|}
end_function

begin_function
name|int
name|ipf_p_dns_allow_query
parameter_list|(
name|softd
parameter_list|,
name|dnsi
parameter_list|)
name|ipf_dns_softc_t
modifier|*
name|softd
decl_stmt|;
name|dnsinfo_t
modifier|*
name|dnsi
decl_stmt|;
block|{
name|ipf_dns_filter_t
modifier|*
name|idns
decl_stmt|;
name|int
name|len
decl_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|dnsi
operator|->
name|dnsi_buffer
argument_list|)
expr_stmt|;
for|for
control|(
name|idns
operator|=
name|softd
operator|->
name|ipf_p_dns_list
init|;
name|idns
operator|!=
name|NULL
condition|;
name|idns
operator|=
name|idns
operator|->
name|idns_next
control|)
if|if
condition|(
name|ipf_p_dns_match_names
argument_list|(
name|idns
argument_list|,
name|dnsi
operator|->
name|dnsi_buffer
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
return|return
name|idns
operator|->
name|idns_pass
return|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|int
name|ipf_p_dns_inout
parameter_list|(
name|arg
parameter_list|,
name|fin
parameter_list|,
name|aps
parameter_list|,
name|nat
parameter_list|)
name|void
modifier|*
name|arg
decl_stmt|;
name|fr_info_t
modifier|*
name|fin
decl_stmt|;
name|ap_session_t
modifier|*
name|aps
decl_stmt|;
name|nat_t
modifier|*
name|nat
decl_stmt|;
block|{
name|ipf_dns_softc_t
modifier|*
name|softd
init|=
name|arg
decl_stmt|;
name|ipf_dns_hdr_t
modifier|*
name|dns
decl_stmt|;
name|dnsinfo_t
modifier|*
name|di
decl_stmt|;
name|char
modifier|*
name|data
decl_stmt|;
name|int
name|dlen
decl_stmt|,
name|q
decl_stmt|,
name|rc
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|fin
operator|->
name|fin_dlen
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|dns
argument_list|)
condition|)
return|return
name|APR_ERR
argument_list|(
literal|1
argument_list|)
return|;
name|dns
operator|=
operator|(
name|ipf_dns_hdr_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|fin
operator|->
name|fin_dp
operator|+
sizeof|sizeof
argument_list|(
name|udphdr_t
argument_list|)
operator|)
expr_stmt|;
name|q
operator|=
name|dns
operator|->
name|dns_qdcount
expr_stmt|;
name|data
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
name|dns
operator|+
literal|1
operator|)
expr_stmt|;
name|dlen
operator|=
name|fin
operator|->
name|fin_dlen
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|dns
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
name|udphdr_t
argument_list|)
expr_stmt|;
name|di
operator|=
name|aps
operator|->
name|aps_data
expr_stmt|;
name|READ_ENTER
argument_list|(
operator|&
name|softd
operator|->
name|ipf_p_dns_rwlock
argument_list|)
expr_stmt|;
name|MUTEX_ENTER
argument_list|(
operator|&
name|di
operator|->
name|dnsi_lock
argument_list|)
expr_stmt|;
for|for
control|(
init|;
operator|(
name|dlen
operator|>
literal|0
operator|)
operator|&&
operator|(
name|q
operator|>
literal|0
operator|)
condition|;
name|q
operator|--
control|)
block|{
name|int
name|len
decl_stmt|;
name|len
operator|=
name|ipf_p_dns_get_name
argument_list|(
name|softd
argument_list|,
name|data
argument_list|,
name|dlen
argument_list|,
name|di
operator|->
name|dnsi_buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|di
operator|->
name|dnsi_buffer
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
block|{
name|rc
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|rc
operator|=
name|ipf_p_dns_allow_query
argument_list|(
name|softd
argument_list|,
name|di
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
break|break;
name|data
operator|+=
name|len
expr_stmt|;
name|dlen
operator|-=
name|len
expr_stmt|;
block|}
name|MUTEX_EXIT
argument_list|(
operator|&
name|di
operator|->
name|dnsi_lock
argument_list|)
expr_stmt|;
name|RWLOCK_EXIT
argument_list|(
operator|&
name|softd
operator|->
name|ipf_p_dns_rwlock
argument_list|)
expr_stmt|;
return|return
name|APR_ERR
argument_list|(
name|rc
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|int
name|ipf_p_dns_match
parameter_list|(
name|fin
parameter_list|,
name|aps
parameter_list|,
name|nat
parameter_list|)
name|fr_info_t
modifier|*
name|fin
decl_stmt|;
name|ap_session_t
modifier|*
name|aps
decl_stmt|;
name|nat_t
modifier|*
name|nat
decl_stmt|;
block|{
name|dnsinfo_t
modifier|*
name|di
init|=
name|aps
operator|->
name|aps_data
decl_stmt|;
name|ipf_dns_hdr_t
modifier|*
name|dnh
decl_stmt|;
if|if
condition|(
operator|(
name|fin
operator|->
name|fin_dlen
operator|<
sizeof|sizeof
argument_list|(
name|u_short
argument_list|)
operator|)
operator|||
operator|(
name|fin
operator|->
name|fin_flx
operator|&
name|FI_FRAG
operator|)
condition|)
return|return
operator|-
literal|1
return|;
name|dnh
operator|=
operator|(
name|ipf_dns_hdr_t
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|fin
operator|->
name|fin_dp
operator|+
sizeof|sizeof
argument_list|(
name|udphdr_t
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|dnh
operator|->
name|dns_id
index|[
literal|0
index|]
operator|<<
literal|8
operator|)
operator||
name|dnh
operator|->
name|dns_id
index|[
literal|1
index|]
operator|)
operator|!=
name|di
operator|->
name|dnsi_id
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

end_unit


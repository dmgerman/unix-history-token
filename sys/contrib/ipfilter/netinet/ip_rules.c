begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$FreeBSD$	*/
end_comment

begin_comment
comment|/* * Copyright (C) 2012 by Darren Reed. * * Redistribution and use in source and binary forms are permitted * provided that this notice is preserved and due credit is given * to the original author and the contributors. */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD_version
argument_list|)
operator|&&
operator|(
name|__FreeBSD_version
operator|>=
literal|40000
operator|)
end_if

begin_if
if|#
directive|if
name|defined
argument_list|(
name|_KERNEL
argument_list|)
end_if

begin_include
include|#
directive|include
file|<sys/libkern.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<sys/unistd.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__NetBSD_Version__
argument_list|)
operator|&&
operator|(
name|__NetBSD_Version__
operator|>=
literal|399000000
operator|)
end_if

begin_else
else|#
directive|else
end_else

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__OpenBSD__
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__sgi
argument_list|)
end_if

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/errno.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|__SVR4
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__svr4__
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__hpux
argument_list|)
end_if

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
operator|&&
operator|(
name|__FreeBSD_version
operator|>
literal|220000
operator|)
end_if

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* FreeBSD */
end_comment

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp.h>
end_include

begin_include
include|#
directive|include
file|"netinet/ip_compat.h"
end_include

begin_include
include|#
directive|include
file|"netinet/ip_fil.h"
end_include

begin_include
include|#
directive|include
file|"netinet/ip_rules.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|_KERNEL
end_ifndef

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* _KERNEL */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|IPFILTER_COMPILED
end_ifdef

begin_decl_stmt
specifier|extern
name|ipf_main_softc_t
name|ipfmain
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_long
name|in_rule__0
index|[]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0x8070d88
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0xffffffff
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0xffffffff
block|,
literal|0x1b0
block|,
literal|0x1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0x2
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0x40000000
block|,
literal|0x8002
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0xffff
block|,
literal|0
block|,
literal|0xffffffff
block|,
literal|0xffffffff
block|,
literal|0xffffffff
block|,
literal|0xffffffff
block|,
literal|0xffffffff
block|,
literal|0xffffffff
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0xffffffff
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0xffffffff
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0xffffffff
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0xffffffff
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|u_long
name|out_rule__0
index|[]
init|=
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0x8070d88
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0xffffffff
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0xffffffff
block|,
literal|0x1b0
block|,
literal|0x1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0x3
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0x40000000
block|,
literal|0x4002
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0xffff
block|,
literal|0
block|,
literal|0xffffffff
block|,
literal|0xffffffff
block|,
literal|0xffffffff
block|,
literal|0xffffffff
block|,
literal|0xffffffff
block|,
literal|0xffffffff
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0xffffffff
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0xffffffff
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0xffffffff
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0xffffffff
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|frentry_t
modifier|*
name|ipf_rules_in_
index|[
literal|1
index|]
init|=
block|{
operator|(
name|frentry_t
operator|*
operator|)
operator|&
name|in_rule__0
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* XXX	This file (ip_rules.c) is not part of the ipfilter tarball, it is    XXX	generated by the ipfilter build process. Unfortunately the build    XXX  process did not generate the following lines so they are added    XXX	by hand here. This is a bit of a hack but it works for now. Future    XXX  imports/merges of ipfilter may generate this so the following will    XXX	need to be removed following some future merge.    XXX	*/
end_comment

begin_decl_stmt
name|frentry_t
modifier|*
name|ipf_rules_out_
index|[
literal|1
index|]
init|=
block|{
operator|(
name|frentry_t
operator|*
operator|)
operator|&
name|out_rule__0
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|frentry_t
modifier|*
name|ipfrule_match_in_
parameter_list|(
name|fin
parameter_list|,
name|passp
parameter_list|)
name|fr_info_t
modifier|*
name|fin
decl_stmt|;
name|u_32_t
modifier|*
name|passp
decl_stmt|;
block|{
name|frentry_t
modifier|*
name|fr
init|=
name|NULL
decl_stmt|;
name|fr
operator|=
operator|(
name|frentry_t
operator|*
operator|)
operator|&
name|in_rule__0
expr_stmt|;
return|return
name|fr
return|;
block|}
end_function

begin_function
name|frentry_t
modifier|*
name|ipfrule_match_out_
parameter_list|(
name|fin
parameter_list|,
name|passp
parameter_list|)
name|fr_info_t
modifier|*
name|fin
decl_stmt|;
name|u_32_t
modifier|*
name|passp
decl_stmt|;
block|{
name|frentry_t
modifier|*
name|fr
init|=
name|NULL
decl_stmt|;
name|fr
operator|=
operator|(
name|frentry_t
operator|*
operator|)
operator|&
name|out_rule__0
expr_stmt|;
return|return
name|fr
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|frentry_t
name|ipfrule_out_
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|ipfrule_add_out_
parameter_list|()
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|err
init|=
literal|0
decl_stmt|,
name|max
decl_stmt|;
name|frentry_t
modifier|*
name|fp
decl_stmt|;
name|max
operator|=
sizeof|sizeof
argument_list|(
name|ipf_rules_out_
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|frentry_t
operator|*
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|max
condition|;
name|i
operator|++
control|)
block|{
name|fp
operator|=
name|ipf_rules_out_
index|[
name|i
index|]
expr_stmt|;
name|fp
operator|->
name|fr_next
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|j
operator|=
name|i
operator|+
literal|1
init|;
name|j
operator|<
name|max
condition|;
name|j
operator|++
control|)
if|if
condition|(
name|strncmp
argument_list|(
name|fp
operator|->
name|fr_names
operator|+
name|fp
operator|->
name|fr_group
argument_list|,
name|ipf_rules_out_
index|[
name|j
index|]
operator|->
name|fr_names
operator|+
name|ipf_rules_out_
index|[
name|j
index|]
operator|->
name|fr_group
argument_list|,
name|FR_GROUPLEN
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|ipf_rules_out_
index|[
name|j
index|]
operator|!=
name|NULL
condition|)
name|ipf_rules_out_
index|[
name|j
index|]
operator|->
name|fr_pnext
operator|=
operator|&
name|fp
operator|->
name|fr_next
expr_stmt|;
name|fp
operator|->
name|fr_pnext
operator|=
operator|&
name|ipf_rules_out_
index|[
name|j
index|]
expr_stmt|;
name|fp
operator|->
name|fr_next
operator|=
name|ipf_rules_out_
index|[
name|j
index|]
expr_stmt|;
break|break;
block|}
block|}
name|fp
operator|=
operator|&
name|ipfrule_out_
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|fp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fp
argument_list|)
argument_list|)
expr_stmt|;
name|fp
operator|->
name|fr_type
operator|=
name|FR_T_CALLFUNC_BUILTIN
expr_stmt|;
name|fp
operator|->
name|fr_flags
operator|=
name|FR_OUTQUE
operator||
name|FR_NOMATCH
expr_stmt|;
name|fp
operator|->
name|fr_data
operator|=
operator|(
name|void
operator|*
operator|)
name|ipf_rules_out_
index|[
literal|0
index|]
expr_stmt|;
name|fp
operator|->
name|fr_dsize
operator|=
sizeof|sizeof
argument_list|(
name|ipf_rules_out_
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|fp
operator|->
name|fr_family
operator|=
name|AF_INET
expr_stmt|;
name|fp
operator|->
name|fr_func
operator|=
operator|(
name|ipfunc_t
operator|)
name|ipfrule_match_out_
expr_stmt|;
name|err
operator|=
name|frrequest
argument_list|(
operator|&
name|ipfmain
argument_list|,
name|IPL_LOGIPF
argument_list|,
name|SIOCADDFR
argument_list|,
operator|(
name|caddr_t
operator|)
name|fp
argument_list|,
name|ipfmain
operator|.
name|ipf_active
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|ipfrule_remove_out_
parameter_list|()
block|{
name|int
name|err
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|;
name|frentry_t
modifier|*
name|fp
decl_stmt|;
comment|/* 	 * Try to remove the outbound rule. 	 */
if|if
condition|(
name|ipfrule_out_
operator|.
name|fr_ref
operator|>
literal|0
condition|)
block|{
name|err
operator|=
name|EBUSY
expr_stmt|;
block|}
else|else
block|{
name|i
operator|=
sizeof|sizeof
argument_list|(
name|ipf_rules_out_
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|frentry_t
operator|*
argument_list|)
operator|-
literal|1
expr_stmt|;
for|for
control|(
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|fp
operator|=
name|ipf_rules_out_
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_ref
operator|>
literal|1
condition|)
block|{
name|err
operator|=
name|EBUSY
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
name|err
operator|==
literal|0
condition|)
name|err
operator|=
name|frrequest
argument_list|(
operator|&
name|ipfmain
argument_list|,
name|IPL_LOGIPF
argument_list|,
name|SIOCDELFR
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ipfrule_out_
argument_list|,
name|ipfmain
operator|.
name|ipf_active
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
return|return
name|err
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|frentry_t
name|ipfrule_in_
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|ipfrule_add_in_
parameter_list|()
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|err
init|=
literal|0
decl_stmt|,
name|max
decl_stmt|;
name|frentry_t
modifier|*
name|fp
decl_stmt|;
name|max
operator|=
sizeof|sizeof
argument_list|(
name|ipf_rules_in_
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|frentry_t
operator|*
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|max
condition|;
name|i
operator|++
control|)
block|{
name|fp
operator|=
name|ipf_rules_in_
index|[
name|i
index|]
expr_stmt|;
name|fp
operator|->
name|fr_next
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|j
operator|=
name|i
operator|+
literal|1
init|;
name|j
operator|<
name|max
condition|;
name|j
operator|++
control|)
if|if
condition|(
name|strncmp
argument_list|(
name|fp
operator|->
name|fr_names
operator|+
name|fp
operator|->
name|fr_group
argument_list|,
name|ipf_rules_in_
index|[
name|j
index|]
operator|->
name|fr_names
operator|+
name|ipf_rules_in_
index|[
name|j
index|]
operator|->
name|fr_group
argument_list|,
name|FR_GROUPLEN
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|ipf_rules_in_
index|[
name|j
index|]
operator|!=
name|NULL
condition|)
name|ipf_rules_in_
index|[
name|j
index|]
operator|->
name|fr_pnext
operator|=
operator|&
name|fp
operator|->
name|fr_next
expr_stmt|;
name|fp
operator|->
name|fr_pnext
operator|=
operator|&
name|ipf_rules_in_
index|[
name|j
index|]
expr_stmt|;
name|fp
operator|->
name|fr_next
operator|=
name|ipf_rules_in_
index|[
name|j
index|]
expr_stmt|;
break|break;
block|}
block|}
name|fp
operator|=
operator|&
name|ipfrule_in_
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|fp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fp
argument_list|)
argument_list|)
expr_stmt|;
name|fp
operator|->
name|fr_type
operator|=
name|FR_T_CALLFUNC_BUILTIN
expr_stmt|;
name|fp
operator|->
name|fr_flags
operator|=
name|FR_INQUE
operator||
name|FR_NOMATCH
expr_stmt|;
name|fp
operator|->
name|fr_data
operator|=
operator|(
name|void
operator|*
operator|)
name|ipf_rules_in_
index|[
literal|0
index|]
expr_stmt|;
name|fp
operator|->
name|fr_dsize
operator|=
sizeof|sizeof
argument_list|(
name|ipf_rules_in_
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|fp
operator|->
name|fr_family
operator|=
name|AF_INET
expr_stmt|;
name|fp
operator|->
name|fr_func
operator|=
operator|(
name|ipfunc_t
operator|)
name|ipfrule_match_in_
expr_stmt|;
name|err
operator|=
name|frrequest
argument_list|(
operator|&
name|ipfmain
argument_list|,
name|IPL_LOGIPF
argument_list|,
name|SIOCADDFR
argument_list|,
operator|(
name|caddr_t
operator|)
name|fp
argument_list|,
name|ipfmain
operator|.
name|ipf_active
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|ipfrule_remove_in_
parameter_list|()
block|{
name|int
name|err
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|;
name|frentry_t
modifier|*
name|fp
decl_stmt|;
comment|/* 	 * Try to remove the inbound rule. 	 */
if|if
condition|(
name|ipfrule_in_
operator|.
name|fr_ref
operator|>
literal|0
condition|)
block|{
name|err
operator|=
name|EBUSY
expr_stmt|;
block|}
else|else
block|{
name|i
operator|=
sizeof|sizeof
argument_list|(
name|ipf_rules_in_
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|frentry_t
operator|*
argument_list|)
operator|-
literal|1
expr_stmt|;
for|for
control|(
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|fp
operator|=
name|ipf_rules_in_
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|fp
operator|->
name|fr_ref
operator|>
literal|1
condition|)
block|{
name|err
operator|=
name|EBUSY
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
name|err
operator|==
literal|0
condition|)
name|err
operator|=
name|frrequest
argument_list|(
operator|&
name|ipfmain
argument_list|,
name|IPL_LOGIPF
argument_list|,
name|SIOCDELFR
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ipfrule_in_
argument_list|,
name|ipfmain
operator|.
name|ipf_active
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|int
name|ipfrule_add
parameter_list|()
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
name|ipfrule_add_out_
argument_list|()
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
return|return
name|err
return|;
name|err
operator|=
name|ipfrule_add_in_
argument_list|()
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
return|return
name|err
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ipfrule_remove
parameter_list|()
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
name|ipfrule_remove_out_
argument_list|()
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
return|return
name|err
return|;
name|err
operator|=
name|ipfrule_remove_in_
argument_list|()
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
return|return
name|err
return|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* IPFILTER_COMPILED */
end_comment

end_unit


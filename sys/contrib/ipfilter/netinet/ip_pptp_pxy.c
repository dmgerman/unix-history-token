begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) 2002-2003 by Darren Reed  *  * Simple PPTP transparent proxy for in-kernel use.  For use with the NAT  * code.  *  * $Id: ip_pptp_pxy.c,v 2.10.2.11 2005/12/04 23:39:27 darrenr Exp $  *  */
end_comment

begin_define
define|#
directive|define
name|IPF_PPTP_PROXY
end_define

begin_typedef
typedef|typedef
struct|struct
name|pptp_hdr
block|{
name|u_short
name|pptph_len
decl_stmt|;
name|u_short
name|pptph_type
decl_stmt|;
name|u_32_t
name|pptph_cookie
decl_stmt|;
block|}
name|pptp_hdr_t
typedef|;
end_typedef

begin_define
define|#
directive|define
name|PPTP_MSGTYPE_CTL
value|1
end_define

begin_define
define|#
directive|define
name|PPTP_MTCTL_STARTREQ
value|1
end_define

begin_define
define|#
directive|define
name|PPTP_MTCTL_STARTREP
value|2
end_define

begin_define
define|#
directive|define
name|PPTP_MTCTL_STOPREQ
value|3
end_define

begin_define
define|#
directive|define
name|PPTP_MTCTL_STOPREP
value|4
end_define

begin_define
define|#
directive|define
name|PPTP_MTCTL_ECHOREQ
value|5
end_define

begin_define
define|#
directive|define
name|PPTP_MTCTL_ECHOREP
value|6
end_define

begin_define
define|#
directive|define
name|PPTP_MTCTL_OUTREQ
value|7
end_define

begin_define
define|#
directive|define
name|PPTP_MTCTL_OUTREP
value|8
end_define

begin_define
define|#
directive|define
name|PPTP_MTCTL_INREQ
value|9
end_define

begin_define
define|#
directive|define
name|PPTP_MTCTL_INREP
value|10
end_define

begin_define
define|#
directive|define
name|PPTP_MTCTL_INCONNECT
value|11
end_define

begin_define
define|#
directive|define
name|PPTP_MTCTL_CLEAR
value|12
end_define

begin_define
define|#
directive|define
name|PPTP_MTCTL_DISCONNECT
value|13
end_define

begin_define
define|#
directive|define
name|PPTP_MTCTL_WANERROR
value|14
end_define

begin_define
define|#
directive|define
name|PPTP_MTCTL_LINKINFO
value|15
end_define

begin_decl_stmt
name|int
name|ippr_pptp_init
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ippr_pptp_fini
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ippr_pptp_new
name|__P
argument_list|(
operator|(
name|fr_info_t
operator|*
operator|,
name|ap_session_t
operator|*
operator|,
name|nat_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ippr_pptp_del
name|__P
argument_list|(
operator|(
name|ap_session_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ippr_pptp_inout
name|__P
argument_list|(
operator|(
name|fr_info_t
operator|*
operator|,
name|ap_session_t
operator|*
operator|,
name|nat_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|void
name|ippr_pptp_donatstate
name|__P
argument_list|(
operator|(
name|fr_info_t
operator|*
operator|,
name|nat_t
operator|*
operator|,
name|pptp_pxy_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ippr_pptp_message
name|__P
argument_list|(
operator|(
name|fr_info_t
operator|*
operator|,
name|nat_t
operator|*
operator|,
name|pptp_pxy_t
operator|*
operator|,
name|pptp_side_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ippr_pptp_nextmessage
name|__P
argument_list|(
operator|(
name|fr_info_t
operator|*
operator|,
name|nat_t
operator|*
operator|,
name|pptp_pxy_t
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ippr_pptp_mctl
name|__P
argument_list|(
operator|(
name|fr_info_t
operator|*
operator|,
name|nat_t
operator|*
operator|,
name|pptp_pxy_t
operator|*
operator|,
name|pptp_side_t
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|frentry_t
name|pptpfr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|pptp_proxy_init
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ippr_pptp_debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ippr_pptp_gretimeout
init|=
name|IPF_TTLVAL
argument_list|(
literal|120
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* 2 minutes */
end_comment

begin_comment
comment|/*  * PPTP application proxy initialization.  */
end_comment

begin_function
name|int
name|ippr_pptp_init
parameter_list|()
block|{
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|pptpfr
argument_list|,
sizeof|sizeof
argument_list|(
name|pptpfr
argument_list|)
argument_list|)
expr_stmt|;
name|pptpfr
operator|.
name|fr_ref
operator|=
literal|1
expr_stmt|;
name|pptpfr
operator|.
name|fr_age
index|[
literal|0
index|]
operator|=
name|ippr_pptp_gretimeout
expr_stmt|;
name|pptpfr
operator|.
name|fr_age
index|[
literal|1
index|]
operator|=
name|ippr_pptp_gretimeout
expr_stmt|;
name|pptpfr
operator|.
name|fr_flags
operator|=
name|FR_OUTQUE
operator||
name|FR_PASS
operator||
name|FR_QUICK
operator||
name|FR_KEEPSTATE
expr_stmt|;
name|MUTEX_INIT
argument_list|(
operator|&
name|pptpfr
operator|.
name|fr_lock
argument_list|,
literal|"PPTP proxy rule lock"
argument_list|)
expr_stmt|;
name|pptp_proxy_init
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|ippr_pptp_fini
parameter_list|()
block|{
if|if
condition|(
name|pptp_proxy_init
operator|==
literal|1
condition|)
block|{
name|MUTEX_DESTROY
argument_list|(
operator|&
name|pptpfr
operator|.
name|fr_lock
argument_list|)
expr_stmt|;
name|pptp_proxy_init
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Setup for a new PPTP proxy.  */
end_comment

begin_function
name|int
name|ippr_pptp_new
parameter_list|(
name|fin
parameter_list|,
name|aps
parameter_list|,
name|nat
parameter_list|)
name|fr_info_t
modifier|*
name|fin
decl_stmt|;
name|ap_session_t
modifier|*
name|aps
decl_stmt|;
name|nat_t
modifier|*
name|nat
decl_stmt|;
block|{
name|pptp_pxy_t
modifier|*
name|pptp
decl_stmt|;
name|ipnat_t
modifier|*
name|ipn
decl_stmt|;
name|ip_t
modifier|*
name|ip
decl_stmt|;
name|ip
operator|=
name|fin
operator|->
name|fin_ip
expr_stmt|;
if|if
condition|(
name|nat_outlookup
argument_list|(
name|fin
argument_list|,
literal|0
argument_list|,
name|IPPROTO_GRE
argument_list|,
name|nat
operator|->
name|nat_inip
argument_list|,
name|ip
operator|->
name|ip_dst
argument_list|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|ippr_pptp_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"ippr_pptp_new: GRE session already exists\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|aps
operator|->
name|aps_psiz
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|pptp
argument_list|)
expr_stmt|;
name|KMALLOCS
argument_list|(
name|aps
operator|->
name|aps_data
argument_list|,
name|pptp_pxy_t
operator|*
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pptp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|aps
operator|->
name|aps_data
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|ippr_pptp_debug
operator|>
literal|0
condition|)
name|printf
argument_list|(
literal|"ippr_pptp_new: malloc for aps_data failed\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* 	 * Create NAT rule against which the tunnel/transport mapping is 	 * created.  This is required because the current NAT rule does not 	 * describe GRE but TCP instead. 	 */
name|pptp
operator|=
name|aps
operator|->
name|aps_data
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|pptp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pptp
argument_list|)
argument_list|)
expr_stmt|;
name|ipn
operator|=
operator|&
name|pptp
operator|->
name|pptp_rule
expr_stmt|;
name|ipn
operator|->
name|in_ifps
index|[
literal|0
index|]
operator|=
name|fin
operator|->
name|fin_ifp
expr_stmt|;
name|ipn
operator|->
name|in_apr
operator|=
name|NULL
expr_stmt|;
name|ipn
operator|->
name|in_use
operator|=
literal|1
expr_stmt|;
name|ipn
operator|->
name|in_hits
operator|=
literal|1
expr_stmt|;
name|ipn
operator|->
name|in_ippip
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|nat
operator|->
name|nat_dir
operator|==
name|NAT_OUTBOUND
condition|)
block|{
name|ipn
operator|->
name|in_nip
operator|=
name|ntohl
argument_list|(
name|nat
operator|->
name|nat_outip
operator|.
name|s_addr
argument_list|)
expr_stmt|;
name|ipn
operator|->
name|in_outip
operator|=
name|fin
operator|->
name|fin_saddr
expr_stmt|;
name|ipn
operator|->
name|in_redir
operator|=
name|NAT_MAP
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|nat
operator|->
name|nat_dir
operator|==
name|NAT_INBOUND
condition|)
block|{
name|ipn
operator|->
name|in_nip
operator|=
literal|0
expr_stmt|;
name|ipn
operator|->
name|in_outip
operator|=
name|nat
operator|->
name|nat_outip
operator|.
name|s_addr
expr_stmt|;
name|ipn
operator|->
name|in_redir
operator|=
name|NAT_REDIRECT
expr_stmt|;
block|}
name|ipn
operator|->
name|in_inip
operator|=
name|nat
operator|->
name|nat_inip
operator|.
name|s_addr
expr_stmt|;
name|ipn
operator|->
name|in_inmsk
operator|=
literal|0xffffffff
expr_stmt|;
name|ipn
operator|->
name|in_outmsk
operator|=
literal|0xffffffff
expr_stmt|;
name|ipn
operator|->
name|in_srcip
operator|=
name|fin
operator|->
name|fin_saddr
expr_stmt|;
name|ipn
operator|->
name|in_srcmsk
operator|=
literal|0xffffffff
expr_stmt|;
name|bcopy
argument_list|(
name|nat
operator|->
name|nat_ptr
operator|->
name|in_ifnames
index|[
literal|0
index|]
argument_list|,
name|ipn
operator|->
name|in_ifnames
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|ipn
operator|->
name|in_ifnames
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|ipn
operator|->
name|in_p
operator|=
name|IPPROTO_GRE
expr_stmt|;
name|pptp
operator|->
name|pptp_side
index|[
literal|0
index|]
operator|.
name|pptps_wptr
operator|=
name|pptp
operator|->
name|pptp_side
index|[
literal|0
index|]
operator|.
name|pptps_buffer
expr_stmt|;
name|pptp
operator|->
name|pptp_side
index|[
literal|1
index|]
operator|.
name|pptps_wptr
operator|=
name|pptp
operator|->
name|pptp_side
index|[
literal|1
index|]
operator|.
name|pptps_buffer
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|ippr_pptp_donatstate
parameter_list|(
name|fin
parameter_list|,
name|nat
parameter_list|,
name|pptp
parameter_list|)
name|fr_info_t
modifier|*
name|fin
decl_stmt|;
name|nat_t
modifier|*
name|nat
decl_stmt|;
name|pptp_pxy_t
modifier|*
name|pptp
decl_stmt|;
block|{
name|fr_info_t
name|fi
decl_stmt|;
name|grehdr_t
name|gre
decl_stmt|;
name|nat_t
modifier|*
name|nat2
decl_stmt|;
name|u_char
name|p
decl_stmt|;
name|ip_t
modifier|*
name|ip
decl_stmt|;
name|ip
operator|=
name|fin
operator|->
name|fin_ip
expr_stmt|;
name|p
operator|=
name|ip
operator|->
name|ip_p
expr_stmt|;
name|nat2
operator|=
name|pptp
operator|->
name|pptp_nat
expr_stmt|;
if|if
condition|(
operator|(
name|nat2
operator|==
name|NULL
operator|)
operator|||
operator|(
name|pptp
operator|->
name|pptp_state
operator|==
name|NULL
operator|)
condition|)
block|{
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|fin
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|fi
argument_list|,
sizeof|sizeof
argument_list|(
name|fi
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|gre
argument_list|,
sizeof|sizeof
argument_list|(
name|gre
argument_list|)
argument_list|)
expr_stmt|;
name|fi
operator|.
name|fin_state
operator|=
name|NULL
expr_stmt|;
name|fi
operator|.
name|fin_nat
operator|=
name|NULL
expr_stmt|;
name|fi
operator|.
name|fin_fi
operator|.
name|fi_p
operator|=
name|IPPROTO_GRE
expr_stmt|;
name|fi
operator|.
name|fin_fr
operator|=
operator|&
name|pptpfr
expr_stmt|;
if|if
condition|(
operator|(
name|nat
operator|->
name|nat_dir
operator|==
name|NAT_OUTBOUND
operator|&&
name|fin
operator|->
name|fin_out
operator|)
operator|||
operator|(
name|nat
operator|->
name|nat_dir
operator|==
name|NAT_INBOUND
operator|&&
operator|!
name|fin
operator|->
name|fin_out
operator|)
condition|)
block|{
name|fi
operator|.
name|fin_data
index|[
literal|0
index|]
operator|=
name|pptp
operator|->
name|pptp_call
index|[
literal|0
index|]
expr_stmt|;
name|fi
operator|.
name|fin_data
index|[
literal|1
index|]
operator|=
name|pptp
operator|->
name|pptp_call
index|[
literal|1
index|]
expr_stmt|;
block|}
else|else
block|{
name|fi
operator|.
name|fin_data
index|[
literal|0
index|]
operator|=
name|pptp
operator|->
name|pptp_call
index|[
literal|1
index|]
expr_stmt|;
name|fi
operator|.
name|fin_data
index|[
literal|1
index|]
operator|=
name|pptp
operator|->
name|pptp_call
index|[
literal|0
index|]
expr_stmt|;
block|}
name|ip
operator|=
name|fin
operator|->
name|fin_ip
expr_stmt|;
name|ip
operator|->
name|ip_p
operator|=
name|IPPROTO_GRE
expr_stmt|;
name|fi
operator|.
name|fin_flx
operator|&=
operator|~
operator|(
name|FI_TCPUDP
operator||
name|FI_STATE
operator||
name|FI_FRAG
operator|)
expr_stmt|;
name|fi
operator|.
name|fin_flx
operator||=
name|FI_IGNORE
expr_stmt|;
name|fi
operator|.
name|fin_dp
operator|=
operator|&
name|gre
expr_stmt|;
name|gre
operator|.
name|gr_flags
operator|=
name|htons
argument_list|(
literal|1
operator|<<
literal|13
argument_list|)
expr_stmt|;
if|if
condition|(
name|fin
operator|->
name|fin_out
operator|&&
name|nat
operator|->
name|nat_dir
operator|==
name|NAT_INBOUND
condition|)
block|{
name|fi
operator|.
name|fin_fi
operator|.
name|fi_saddr
operator|=
name|fin
operator|->
name|fin_fi
operator|.
name|fi_daddr
expr_stmt|;
name|fi
operator|.
name|fin_fi
operator|.
name|fi_daddr
operator|=
name|nat
operator|->
name|nat_outip
operator|.
name|s_addr
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|fin
operator|->
name|fin_out
operator|&&
name|nat
operator|->
name|nat_dir
operator|==
name|NAT_OUTBOUND
condition|)
block|{
name|fi
operator|.
name|fin_fi
operator|.
name|fi_saddr
operator|=
name|nat
operator|->
name|nat_inip
operator|.
name|s_addr
expr_stmt|;
name|fi
operator|.
name|fin_fi
operator|.
name|fi_daddr
operator|=
name|fin
operator|->
name|fin_fi
operator|.
name|fi_saddr
expr_stmt|;
block|}
block|}
comment|/* 	 * Update NAT timeout/create NAT if missing. 	 */
if|if
condition|(
name|nat2
operator|!=
name|NULL
condition|)
name|fr_queueback
argument_list|(
operator|&
name|nat2
operator|->
name|nat_tqe
argument_list|)
expr_stmt|;
else|else
block|{
name|nat2
operator|=
name|nat_new
argument_list|(
operator|&
name|fi
argument_list|,
operator|&
name|pptp
operator|->
name|pptp_rule
argument_list|,
operator|&
name|pptp
operator|->
name|pptp_nat
argument_list|,
name|NAT_SLAVE
argument_list|,
name|nat
operator|->
name|nat_dir
argument_list|)
expr_stmt|;
name|pptp
operator|->
name|pptp_nat
operator|=
name|nat2
expr_stmt|;
if|if
condition|(
name|nat2
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|nat_proto
argument_list|(
operator|&
name|fi
argument_list|,
name|nat2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|nat_update
argument_list|(
operator|&
name|fi
argument_list|,
name|nat2
argument_list|,
name|nat2
operator|->
name|nat_ptr
argument_list|)
expr_stmt|;
block|}
block|}
name|READ_ENTER
argument_list|(
operator|&
name|ipf_state
argument_list|)
expr_stmt|;
if|if
condition|(
name|pptp
operator|->
name|pptp_state
operator|!=
name|NULL
condition|)
block|{
name|fr_queueback
argument_list|(
operator|&
name|pptp
operator|->
name|pptp_state
operator|->
name|is_sti
argument_list|)
expr_stmt|;
name|RWLOCK_EXIT
argument_list|(
operator|&
name|ipf_state
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|RWLOCK_EXIT
argument_list|(
operator|&
name|ipf_state
argument_list|)
expr_stmt|;
if|if
condition|(
name|nat
operator|->
name|nat_dir
operator|==
name|NAT_INBOUND
condition|)
name|fi
operator|.
name|fin_fi
operator|.
name|fi_daddr
operator|=
name|nat2
operator|->
name|nat_inip
operator|.
name|s_addr
expr_stmt|;
else|else
name|fi
operator|.
name|fin_fi
operator|.
name|fi_saddr
operator|=
name|nat2
operator|->
name|nat_inip
operator|.
name|s_addr
expr_stmt|;
name|fi
operator|.
name|fin_ifp
operator|=
name|NULL
expr_stmt|;
name|pptp
operator|->
name|pptp_state
operator|=
name|fr_addstate
argument_list|(
operator|&
name|fi
argument_list|,
operator|&
name|pptp
operator|->
name|pptp_state
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fi
operator|.
name|fin_state
operator|!=
name|NULL
condition|)
name|fr_statederef
argument_list|(
operator|&
name|fi
argument_list|,
operator|(
name|ipstate_t
operator|*
operator|*
operator|)
operator|&
name|fi
operator|.
name|fin_state
argument_list|)
expr_stmt|;
block|}
name|ip
operator|->
name|ip_p
operator|=
name|p
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/*  * Try and build up the next PPTP message in the TCP stream and if we can  * build it up completely (fits in our buffer) then pass it off to the message  * parsing function.  */
end_comment

begin_function
name|int
name|ippr_pptp_nextmessage
parameter_list|(
name|fin
parameter_list|,
name|nat
parameter_list|,
name|pptp
parameter_list|,
name|rev
parameter_list|)
name|fr_info_t
modifier|*
name|fin
decl_stmt|;
name|nat_t
modifier|*
name|nat
decl_stmt|;
name|pptp_pxy_t
modifier|*
name|pptp
decl_stmt|;
name|int
name|rev
decl_stmt|;
block|{
specifier|static
specifier|const
name|char
modifier|*
name|funcname
init|=
literal|"ippr_pptp_nextmessage"
decl_stmt|;
name|pptp_side_t
modifier|*
name|pptps
decl_stmt|;
name|u_32_t
name|start
decl_stmt|,
name|end
decl_stmt|;
name|pptp_hdr_t
modifier|*
name|hdr
decl_stmt|;
name|tcphdr_t
modifier|*
name|tcp
decl_stmt|;
name|int
name|dlen
decl_stmt|,
name|off
decl_stmt|;
name|u_short
name|len
decl_stmt|;
name|char
modifier|*
name|msg
decl_stmt|;
name|tcp
operator|=
name|fin
operator|->
name|fin_dp
expr_stmt|;
name|dlen
operator|=
name|fin
operator|->
name|fin_dlen
operator|-
operator|(
name|TCP_OFF
argument_list|(
name|tcp
argument_list|)
operator|<<
literal|2
operator|)
expr_stmt|;
name|start
operator|=
name|ntohl
argument_list|(
name|tcp
operator|->
name|th_seq
argument_list|)
expr_stmt|;
name|pptps
operator|=
operator|&
name|pptp
operator|->
name|pptp_side
index|[
name|rev
index|]
expr_stmt|;
name|off
operator|=
operator|(
name|char
operator|*
operator|)
name|tcp
operator|-
operator|(
name|char
operator|*
operator|)
name|fin
operator|->
name|fin_ip
operator|+
operator|(
name|TCP_OFF
argument_list|(
name|tcp
argument_list|)
operator|<<
literal|2
operator|)
operator|+
name|fin
operator|->
name|fin_ipoff
expr_stmt|;
if|if
condition|(
name|dlen
operator|<=
literal|0
condition|)
return|return
literal|0
return|;
comment|/* 	 * If the complete data packet is before what we expect to see 	 * "next", just ignore it as the chances are we've already seen it. 	 * The next if statement following this one really just causes packets 	 * ahead of what we've seen to be dropped, implying that something in 	 * the middle went missing and we want to see that first. 	 */
name|end
operator|=
name|start
operator|+
name|dlen
expr_stmt|;
if|if
condition|(
name|pptps
operator|->
name|pptps_next
operator|>
name|end
operator|&&
name|pptps
operator|->
name|pptps_next
operator|>
name|start
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|pptps
operator|->
name|pptps_next
operator|!=
name|start
condition|)
block|{
if|if
condition|(
name|ippr_pptp_debug
operator|>
literal|5
condition|)
name|printf
argument_list|(
literal|"%s: next (%x) != start (%x)\n"
argument_list|,
name|funcname
argument_list|,
name|pptps
operator|->
name|pptps_next
argument_list|,
name|start
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|=
operator|(
name|char
operator|*
operator|)
name|fin
operator|->
name|fin_dp
operator|+
operator|(
name|TCP_OFF
argument_list|(
name|tcp
argument_list|)
operator|<<
literal|2
operator|)
expr_stmt|;
while|while
condition|(
name|dlen
operator|>
literal|0
condition|)
block|{
name|off
operator|+=
name|pptps
operator|->
name|pptps_bytes
expr_stmt|;
if|if
condition|(
name|pptps
operator|->
name|pptps_gothdr
operator|==
literal|0
condition|)
block|{
comment|/* 			 * PPTP has an 8 byte header that inclues the cookie. 			 * The start of every message should include one and 			 * it should match 1a2b3c4d.  Byte order is ignored, 			 * deliberately, when printing out the error. 			 */
name|len
operator|=
name|MIN
argument_list|(
literal|8
operator|-
name|pptps
operator|->
name|pptps_bytes
argument_list|,
name|dlen
argument_list|)
expr_stmt|;
name|COPYDATA
argument_list|(
name|fin
operator|->
name|fin_m
argument_list|,
name|off
argument_list|,
name|len
argument_list|,
name|pptps
operator|->
name|pptps_wptr
argument_list|)
expr_stmt|;
name|pptps
operator|->
name|pptps_bytes
operator|+=
name|len
expr_stmt|;
name|pptps
operator|->
name|pptps_wptr
operator|+=
name|len
expr_stmt|;
name|hdr
operator|=
operator|(
name|pptp_hdr_t
operator|*
operator|)
name|pptps
operator|->
name|pptps_buffer
expr_stmt|;
if|if
condition|(
name|pptps
operator|->
name|pptps_bytes
operator|==
literal|8
condition|)
block|{
name|pptps
operator|->
name|pptps_next
operator|+=
literal|8
expr_stmt|;
if|if
condition|(
name|ntohl
argument_list|(
name|hdr
operator|->
name|pptph_cookie
argument_list|)
operator|!=
literal|0x1a2b3c4d
condition|)
block|{
if|if
condition|(
name|ippr_pptp_debug
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"%s: bad cookie (%x)\n"
argument_list|,
name|funcname
argument_list|,
name|hdr
operator|->
name|pptph_cookie
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|dlen
operator|-=
name|len
expr_stmt|;
name|msg
operator|+=
name|len
expr_stmt|;
name|off
operator|+=
name|len
expr_stmt|;
name|pptps
operator|->
name|pptps_gothdr
operator|=
literal|1
expr_stmt|;
name|len
operator|=
name|ntohs
argument_list|(
name|hdr
operator|->
name|pptph_len
argument_list|)
expr_stmt|;
name|pptps
operator|->
name|pptps_len
operator|=
name|len
expr_stmt|;
name|pptps
operator|->
name|pptps_nexthdr
operator|+=
name|len
expr_stmt|;
comment|/* 			 * If a message is too big for the buffer, just set 			 * the fields for the next message to come along. 			 * The messages defined in RFC 2637 will not exceed 			 * 512 bytes (in total length) so this is likely a 			 * bad data packet, anyway. 			 */
if|if
condition|(
name|len
operator|>
sizeof|sizeof
argument_list|(
name|pptps
operator|->
name|pptps_buffer
argument_list|)
condition|)
block|{
if|if
condition|(
name|ippr_pptp_debug
operator|>
literal|3
condition|)
name|printf
argument_list|(
literal|"%s: message too big (%d)\n"
argument_list|,
name|funcname
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|pptps
operator|->
name|pptps_next
operator|=
name|pptps
operator|->
name|pptps_nexthdr
expr_stmt|;
name|pptps
operator|->
name|pptps_wptr
operator|=
name|pptps
operator|->
name|pptps_buffer
expr_stmt|;
name|pptps
operator|->
name|pptps_gothdr
operator|=
literal|0
expr_stmt|;
name|pptps
operator|->
name|pptps_bytes
operator|=
literal|0
expr_stmt|;
name|pptps
operator|->
name|pptps_len
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
name|len
operator|=
name|MIN
argument_list|(
name|pptps
operator|->
name|pptps_len
operator|-
name|pptps
operator|->
name|pptps_bytes
argument_list|,
name|dlen
argument_list|)
expr_stmt|;
name|COPYDATA
argument_list|(
name|fin
operator|->
name|fin_m
argument_list|,
name|off
argument_list|,
name|len
argument_list|,
name|pptps
operator|->
name|pptps_wptr
argument_list|)
expr_stmt|;
name|pptps
operator|->
name|pptps_bytes
operator|+=
name|len
expr_stmt|;
name|pptps
operator|->
name|pptps_wptr
operator|+=
name|len
expr_stmt|;
name|pptps
operator|->
name|pptps_next
operator|+=
name|len
expr_stmt|;
if|if
condition|(
name|pptps
operator|->
name|pptps_len
operator|>
name|pptps
operator|->
name|pptps_bytes
condition|)
break|break;
name|ippr_pptp_message
argument_list|(
name|fin
argument_list|,
name|nat
argument_list|,
name|pptp
argument_list|,
name|pptps
argument_list|)
expr_stmt|;
name|pptps
operator|->
name|pptps_wptr
operator|=
name|pptps
operator|->
name|pptps_buffer
expr_stmt|;
name|pptps
operator|->
name|pptps_gothdr
operator|=
literal|0
expr_stmt|;
name|pptps
operator|->
name|pptps_bytes
operator|=
literal|0
expr_stmt|;
name|pptps
operator|->
name|pptps_len
operator|=
literal|0
expr_stmt|;
name|start
operator|+=
name|len
expr_stmt|;
name|msg
operator|+=
name|len
expr_stmt|;
name|dlen
operator|-=
name|len
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * handle a complete PPTP message  */
end_comment

begin_function
name|int
name|ippr_pptp_message
parameter_list|(
name|fin
parameter_list|,
name|nat
parameter_list|,
name|pptp
parameter_list|,
name|pptps
parameter_list|)
name|fr_info_t
modifier|*
name|fin
decl_stmt|;
name|nat_t
modifier|*
name|nat
decl_stmt|;
name|pptp_pxy_t
modifier|*
name|pptp
decl_stmt|;
name|pptp_side_t
modifier|*
name|pptps
decl_stmt|;
block|{
name|pptp_hdr_t
modifier|*
name|hdr
init|=
operator|(
name|pptp_hdr_t
operator|*
operator|)
name|pptps
operator|->
name|pptps_buffer
decl_stmt|;
switch|switch
condition|(
name|ntohs
argument_list|(
name|hdr
operator|->
name|pptph_type
argument_list|)
condition|)
block|{
case|case
name|PPTP_MSGTYPE_CTL
case|:
name|ippr_pptp_mctl
argument_list|(
name|fin
argument_list|,
name|nat
argument_list|,
name|pptp
argument_list|,
name|pptps
argument_list|)
expr_stmt|;
break|break;
default|default :
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * handle a complete PPTP control message  */
end_comment

begin_function
name|int
name|ippr_pptp_mctl
parameter_list|(
name|fin
parameter_list|,
name|nat
parameter_list|,
name|pptp
parameter_list|,
name|pptps
parameter_list|)
name|fr_info_t
modifier|*
name|fin
decl_stmt|;
name|nat_t
modifier|*
name|nat
decl_stmt|;
name|pptp_pxy_t
modifier|*
name|pptp
decl_stmt|;
name|pptp_side_t
modifier|*
name|pptps
decl_stmt|;
block|{
name|u_short
modifier|*
name|buffer
init|=
operator|(
name|u_short
operator|*
operator|)
operator|(
name|pptps
operator|->
name|pptps_buffer
operator|)
decl_stmt|;
name|pptp_side_t
modifier|*
name|pptpo
decl_stmt|;
if|if
condition|(
name|pptps
operator|==
operator|&
name|pptp
operator|->
name|pptp_side
index|[
literal|0
index|]
condition|)
name|pptpo
operator|=
operator|&
name|pptp
operator|->
name|pptp_side
index|[
literal|1
index|]
expr_stmt|;
else|else
name|pptpo
operator|=
operator|&
name|pptp
operator|->
name|pptp_side
index|[
literal|0
index|]
expr_stmt|;
comment|/* 	 * Breakout to handle all the various messages.  Most are just state 	 * transition. 	 */
switch|switch
condition|(
name|ntohs
argument_list|(
name|buffer
index|[
literal|4
index|]
argument_list|)
condition|)
block|{
case|case
name|PPTP_MTCTL_STARTREQ
case|:
name|pptps
operator|->
name|pptps_state
operator|=
name|PPTP_MTCTL_STARTREQ
expr_stmt|;
break|break;
case|case
name|PPTP_MTCTL_STARTREP
case|:
if|if
condition|(
name|pptpo
operator|->
name|pptps_state
operator|==
name|PPTP_MTCTL_STARTREQ
condition|)
name|pptps
operator|->
name|pptps_state
operator|=
name|PPTP_MTCTL_STARTREP
expr_stmt|;
break|break;
case|case
name|PPTP_MTCTL_STOPREQ
case|:
name|pptps
operator|->
name|pptps_state
operator|=
name|PPTP_MTCTL_STOPREQ
expr_stmt|;
break|break;
case|case
name|PPTP_MTCTL_STOPREP
case|:
if|if
condition|(
name|pptpo
operator|->
name|pptps_state
operator|==
name|PPTP_MTCTL_STOPREQ
condition|)
name|pptps
operator|->
name|pptps_state
operator|=
name|PPTP_MTCTL_STOPREP
expr_stmt|;
break|break;
case|case
name|PPTP_MTCTL_ECHOREQ
case|:
name|pptps
operator|->
name|pptps_state
operator|=
name|PPTP_MTCTL_ECHOREQ
expr_stmt|;
break|break;
case|case
name|PPTP_MTCTL_ECHOREP
case|:
if|if
condition|(
name|pptpo
operator|->
name|pptps_state
operator|==
name|PPTP_MTCTL_ECHOREQ
condition|)
name|pptps
operator|->
name|pptps_state
operator|=
name|PPTP_MTCTL_ECHOREP
expr_stmt|;
break|break;
case|case
name|PPTP_MTCTL_OUTREQ
case|:
name|pptps
operator|->
name|pptps_state
operator|=
name|PPTP_MTCTL_OUTREQ
expr_stmt|;
break|break;
case|case
name|PPTP_MTCTL_OUTREP
case|:
if|if
condition|(
name|pptpo
operator|->
name|pptps_state
operator|==
name|PPTP_MTCTL_OUTREQ
condition|)
block|{
name|pptps
operator|->
name|pptps_state
operator|=
name|PPTP_MTCTL_OUTREP
expr_stmt|;
name|pptp
operator|->
name|pptp_call
index|[
literal|0
index|]
operator|=
name|buffer
index|[
literal|7
index|]
expr_stmt|;
name|pptp
operator|->
name|pptp_call
index|[
literal|1
index|]
operator|=
name|buffer
index|[
literal|6
index|]
expr_stmt|;
name|ippr_pptp_donatstate
argument_list|(
name|fin
argument_list|,
name|nat
argument_list|,
name|pptp
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PPTP_MTCTL_INREQ
case|:
name|pptps
operator|->
name|pptps_state
operator|=
name|PPTP_MTCTL_INREQ
expr_stmt|;
break|break;
case|case
name|PPTP_MTCTL_INREP
case|:
if|if
condition|(
name|pptpo
operator|->
name|pptps_state
operator|==
name|PPTP_MTCTL_INREQ
condition|)
block|{
name|pptps
operator|->
name|pptps_state
operator|=
name|PPTP_MTCTL_INREP
expr_stmt|;
name|pptp
operator|->
name|pptp_call
index|[
literal|0
index|]
operator|=
name|buffer
index|[
literal|7
index|]
expr_stmt|;
name|pptp
operator|->
name|pptp_call
index|[
literal|1
index|]
operator|=
name|buffer
index|[
literal|6
index|]
expr_stmt|;
name|ippr_pptp_donatstate
argument_list|(
name|fin
argument_list|,
name|nat
argument_list|,
name|pptp
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PPTP_MTCTL_INCONNECT
case|:
name|pptps
operator|->
name|pptps_state
operator|=
name|PPTP_MTCTL_INCONNECT
expr_stmt|;
break|break;
case|case
name|PPTP_MTCTL_CLEAR
case|:
name|pptps
operator|->
name|pptps_state
operator|=
name|PPTP_MTCTL_CLEAR
expr_stmt|;
break|break;
case|case
name|PPTP_MTCTL_DISCONNECT
case|:
name|pptps
operator|->
name|pptps_state
operator|=
name|PPTP_MTCTL_DISCONNECT
expr_stmt|;
break|break;
case|case
name|PPTP_MTCTL_WANERROR
case|:
name|pptps
operator|->
name|pptps_state
operator|=
name|PPTP_MTCTL_WANERROR
expr_stmt|;
break|break;
case|case
name|PPTP_MTCTL_LINKINFO
case|:
name|pptps
operator|->
name|pptps_state
operator|=
name|PPTP_MTCTL_LINKINFO
expr_stmt|;
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * For outgoing PPTP packets.  refresh timeouts for NAT& state entries, if  * we can.  If they have disappeared, recreate them.  */
end_comment

begin_function
name|int
name|ippr_pptp_inout
parameter_list|(
name|fin
parameter_list|,
name|aps
parameter_list|,
name|nat
parameter_list|)
name|fr_info_t
modifier|*
name|fin
decl_stmt|;
name|ap_session_t
modifier|*
name|aps
decl_stmt|;
name|nat_t
modifier|*
name|nat
decl_stmt|;
block|{
name|pptp_pxy_t
modifier|*
name|pptp
decl_stmt|;
name|tcphdr_t
modifier|*
name|tcp
decl_stmt|;
name|int
name|rev
decl_stmt|;
if|if
condition|(
operator|(
name|fin
operator|->
name|fin_out
operator|==
literal|1
operator|)
operator|&&
operator|(
name|nat
operator|->
name|nat_dir
operator|==
name|NAT_INBOUND
operator|)
condition|)
name|rev
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|fin
operator|->
name|fin_out
operator|==
literal|0
operator|)
operator|&&
operator|(
name|nat
operator|->
name|nat_dir
operator|==
name|NAT_OUTBOUND
operator|)
condition|)
name|rev
operator|=
literal|1
expr_stmt|;
else|else
name|rev
operator|=
literal|0
expr_stmt|;
name|tcp
operator|=
operator|(
name|tcphdr_t
operator|*
operator|)
name|fin
operator|->
name|fin_dp
expr_stmt|;
if|if
condition|(
operator|(
name|tcp
operator|->
name|th_flags
operator|&
name|TH_OPENING
operator|)
operator|==
name|TH_OPENING
condition|)
block|{
name|pptp
operator|=
operator|(
name|pptp_pxy_t
operator|*
operator|)
name|aps
operator|->
name|aps_data
expr_stmt|;
name|pptp
operator|->
name|pptp_side
index|[
literal|1
operator|-
name|rev
index|]
operator|.
name|pptps_next
operator|=
name|ntohl
argument_list|(
name|tcp
operator|->
name|th_ack
argument_list|)
expr_stmt|;
name|pptp
operator|->
name|pptp_side
index|[
literal|1
operator|-
name|rev
index|]
operator|.
name|pptps_nexthdr
operator|=
name|ntohl
argument_list|(
name|tcp
operator|->
name|th_ack
argument_list|)
expr_stmt|;
name|pptp
operator|->
name|pptp_side
index|[
name|rev
index|]
operator|.
name|pptps_next
operator|=
name|ntohl
argument_list|(
name|tcp
operator|->
name|th_seq
argument_list|)
operator|+
literal|1
expr_stmt|;
name|pptp
operator|->
name|pptp_side
index|[
name|rev
index|]
operator|.
name|pptps_nexthdr
operator|=
name|ntohl
argument_list|(
name|tcp
operator|->
name|th_seq
argument_list|)
operator|+
literal|1
expr_stmt|;
block|}
return|return
name|ippr_pptp_nextmessage
argument_list|(
name|fin
argument_list|,
name|nat
argument_list|,
operator|(
name|pptp_pxy_t
operator|*
operator|)
name|aps
operator|->
name|aps_data
argument_list|,
name|rev
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * clean up after ourselves.  */
end_comment

begin_function
name|void
name|ippr_pptp_del
parameter_list|(
name|aps
parameter_list|)
name|ap_session_t
modifier|*
name|aps
decl_stmt|;
block|{
name|pptp_pxy_t
modifier|*
name|pptp
decl_stmt|;
name|pptp
operator|=
name|aps
operator|->
name|aps_data
expr_stmt|;
if|if
condition|(
name|pptp
operator|!=
name|NULL
condition|)
block|{
comment|/* 		 * Don't bother changing any of the NAT structure details, 		 * *_del() is on a callback from aps_free(), from nat_delete() 		 */
name|READ_ENTER
argument_list|(
operator|&
name|ipf_state
argument_list|)
expr_stmt|;
if|if
condition|(
name|pptp
operator|->
name|pptp_state
operator|!=
name|NULL
condition|)
block|{
name|pptp
operator|->
name|pptp_state
operator|->
name|is_die
operator|=
name|fr_ticks
operator|+
literal|1
expr_stmt|;
name|pptp
operator|->
name|pptp_state
operator|->
name|is_me
operator|=
name|NULL
expr_stmt|;
name|fr_queuefront
argument_list|(
operator|&
name|pptp
operator|->
name|pptp_state
operator|->
name|is_sti
argument_list|)
expr_stmt|;
block|}
name|RWLOCK_EXIT
argument_list|(
operator|&
name|ipf_state
argument_list|)
expr_stmt|;
name|pptp
operator|->
name|pptp_state
operator|=
name|NULL
expr_stmt|;
name|pptp
operator|->
name|pptp_nat
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * BSD LICENSE  *  * Copyright (c) 2015-2017 Amazon.com, Inc. or its affiliates.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  * * Redistributions of source code must retain the above copyright  * notice, this list of conditions and the following disclaimer.  * * Redistributions in binary form must reproduce the above copyright  * notice, this list of conditions and the following disclaimer in  * the documentation and/or other materials provided with the  * distribution.  * * Neither the name of copyright holder nor the names of its  * contributors may be used to endorse or promote products derived  * from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT  * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE  * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"ena_eth_com.h"
end_include

begin_function
specifier|static
specifier|inline
name|struct
name|ena_eth_io_rx_cdesc_base
modifier|*
name|ena_com_get_next_rx_cdesc
parameter_list|(
name|struct
name|ena_com_io_cq
modifier|*
name|io_cq
parameter_list|)
block|{
name|struct
name|ena_eth_io_rx_cdesc_base
modifier|*
name|cdesc
decl_stmt|;
name|u16
name|expected_phase
decl_stmt|,
name|head_masked
decl_stmt|;
name|u16
name|desc_phase
decl_stmt|;
name|head_masked
operator|=
name|io_cq
operator|->
name|head
operator|&
operator|(
name|io_cq
operator|->
name|q_depth
operator|-
literal|1
operator|)
expr_stmt|;
name|expected_phase
operator|=
name|io_cq
operator|->
name|phase
expr_stmt|;
name|cdesc
operator|=
operator|(
expr|struct
name|ena_eth_io_rx_cdesc_base
operator|*
operator|)
operator|(
name|io_cq
operator|->
name|cdesc_addr
operator|.
name|virt_addr
operator|+
operator|(
name|head_masked
operator|*
name|io_cq
operator|->
name|cdesc_entry_size_in_bytes
operator|)
operator|)
expr_stmt|;
name|desc_phase
operator|=
operator|(
name|READ_ONCE
argument_list|(
name|cdesc
operator|->
name|status
argument_list|)
operator|&
name|ENA_ETH_IO_RX_CDESC_BASE_PHASE_MASK
operator|)
operator|>>
name|ENA_ETH_IO_RX_CDESC_BASE_PHASE_SHIFT
expr_stmt|;
if|if
condition|(
name|desc_phase
operator|!=
name|expected_phase
condition|)
return|return
name|NULL
return|;
return|return
name|cdesc
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|ena_com_cq_inc_head
parameter_list|(
name|struct
name|ena_com_io_cq
modifier|*
name|io_cq
parameter_list|)
block|{
name|io_cq
operator|->
name|head
operator|++
expr_stmt|;
comment|/* Switch phase bit in case of wrap around */
if|if
condition|(
name|unlikely
argument_list|(
operator|(
name|io_cq
operator|->
name|head
operator|&
operator|(
name|io_cq
operator|->
name|q_depth
operator|-
literal|1
operator|)
operator|)
operator|==
literal|0
argument_list|)
condition|)
name|io_cq
operator|->
name|phase
operator|^=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
modifier|*
name|get_sq_desc
parameter_list|(
name|struct
name|ena_com_io_sq
modifier|*
name|io_sq
parameter_list|)
block|{
name|u16
name|tail_masked
decl_stmt|;
name|u32
name|offset
decl_stmt|;
name|tail_masked
operator|=
name|io_sq
operator|->
name|tail
operator|&
operator|(
name|io_sq
operator|->
name|q_depth
operator|-
literal|1
operator|)
expr_stmt|;
name|offset
operator|=
name|tail_masked
operator|*
name|io_sq
operator|->
name|desc_entry_size
expr_stmt|;
return|return
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|io_sq
operator|->
name|desc_addr
operator|.
name|virt_addr
operator|+
name|offset
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|ena_com_copy_curr_sq_desc_to_dev
parameter_list|(
name|struct
name|ena_com_io_sq
modifier|*
name|io_sq
parameter_list|)
block|{
name|u16
name|tail_masked
init|=
name|io_sq
operator|->
name|tail
operator|&
operator|(
name|io_sq
operator|->
name|q_depth
operator|-
literal|1
operator|)
decl_stmt|;
name|u32
name|offset
init|=
name|tail_masked
operator|*
name|io_sq
operator|->
name|desc_entry_size
decl_stmt|;
comment|/* In case this queue isn't a LLQ */
if|if
condition|(
name|io_sq
operator|->
name|mem_queue_type
operator|==
name|ENA_ADMIN_PLACEMENT_POLICY_HOST
condition|)
return|return;
name|memcpy_toio
argument_list|(
name|io_sq
operator|->
name|desc_addr
operator|.
name|pbuf_dev_addr
operator|+
name|offset
argument_list|,
name|io_sq
operator|->
name|desc_addr
operator|.
name|virt_addr
operator|+
name|offset
argument_list|,
name|io_sq
operator|->
name|desc_entry_size
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|ena_com_sq_update_tail
parameter_list|(
name|struct
name|ena_com_io_sq
modifier|*
name|io_sq
parameter_list|)
block|{
name|io_sq
operator|->
name|tail
operator|++
expr_stmt|;
comment|/* Switch phase bit in case of wrap around */
if|if
condition|(
name|unlikely
argument_list|(
operator|(
name|io_sq
operator|->
name|tail
operator|&
operator|(
name|io_sq
operator|->
name|q_depth
operator|-
literal|1
operator|)
operator|)
operator|==
literal|0
argument_list|)
condition|)
name|io_sq
operator|->
name|phase
operator|^=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|ena_com_write_header
parameter_list|(
name|struct
name|ena_com_io_sq
modifier|*
name|io_sq
parameter_list|,
name|u8
modifier|*
name|head_src
parameter_list|,
name|u16
name|header_len
parameter_list|)
block|{
name|u16
name|tail_masked
init|=
name|io_sq
operator|->
name|tail
operator|&
operator|(
name|io_sq
operator|->
name|q_depth
operator|-
literal|1
operator|)
decl_stmt|;
name|u8
name|__iomem
modifier|*
name|dev_head_addr
init|=
name|io_sq
operator|->
name|header_addr
operator|+
operator|(
name|tail_masked
operator|*
name|io_sq
operator|->
name|tx_max_header_size
operator|)
decl_stmt|;
if|if
condition|(
name|io_sq
operator|->
name|mem_queue_type
operator|==
name|ENA_ADMIN_PLACEMENT_POLICY_HOST
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|unlikely
argument_list|(
operator|!
name|io_sq
operator|->
name|header_addr
argument_list|)
condition|)
block|{
name|ena_trc_err
argument_list|(
literal|"Push buffer header ptr is NULL\n"
argument_list|)
expr_stmt|;
return|return
name|ENA_COM_INVAL
return|;
block|}
name|memcpy_toio
argument_list|(
name|dev_head_addr
argument_list|,
name|head_src
argument_list|,
name|header_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|struct
name|ena_eth_io_rx_cdesc_base
modifier|*
name|ena_com_rx_cdesc_idx_to_ptr
parameter_list|(
name|struct
name|ena_com_io_cq
modifier|*
name|io_cq
parameter_list|,
name|u16
name|idx
parameter_list|)
block|{
name|idx
operator|&=
operator|(
name|io_cq
operator|->
name|q_depth
operator|-
literal|1
operator|)
expr_stmt|;
return|return
operator|(
expr|struct
name|ena_eth_io_rx_cdesc_base
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|io_cq
operator|->
name|cdesc_addr
operator|.
name|virt_addr
operator|+
name|idx
operator|*
name|io_cq
operator|->
name|cdesc_entry_size_in_bytes
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|u16
name|ena_com_cdesc_rx_pkt_get
parameter_list|(
name|struct
name|ena_com_io_cq
modifier|*
name|io_cq
parameter_list|,
name|u16
modifier|*
name|first_cdesc_idx
parameter_list|)
block|{
name|struct
name|ena_eth_io_rx_cdesc_base
modifier|*
name|cdesc
decl_stmt|;
name|u16
name|count
init|=
literal|0
decl_stmt|,
name|head_masked
decl_stmt|;
name|u32
name|last
init|=
literal|0
decl_stmt|;
do|do
block|{
name|cdesc
operator|=
name|ena_com_get_next_rx_cdesc
argument_list|(
name|io_cq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cdesc
condition|)
break|break;
name|ena_com_cq_inc_head
argument_list|(
name|io_cq
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
name|last
operator|=
operator|(
name|READ_ONCE
argument_list|(
name|cdesc
operator|->
name|status
argument_list|)
operator|&
name|ENA_ETH_IO_RX_CDESC_BASE_LAST_MASK
operator|)
operator|>>
name|ENA_ETH_IO_RX_CDESC_BASE_LAST_SHIFT
expr_stmt|;
block|}
do|while
condition|(
operator|!
name|last
condition|)
do|;
if|if
condition|(
name|last
condition|)
block|{
operator|*
name|first_cdesc_idx
operator|=
name|io_cq
operator|->
name|cur_rx_pkt_cdesc_start_idx
expr_stmt|;
name|count
operator|+=
name|io_cq
operator|->
name|cur_rx_pkt_cdesc_count
expr_stmt|;
name|head_masked
operator|=
name|io_cq
operator|->
name|head
operator|&
operator|(
name|io_cq
operator|->
name|q_depth
operator|-
literal|1
operator|)
expr_stmt|;
name|io_cq
operator|->
name|cur_rx_pkt_cdesc_count
operator|=
literal|0
expr_stmt|;
name|io_cq
operator|->
name|cur_rx_pkt_cdesc_start_idx
operator|=
name|head_masked
expr_stmt|;
name|ena_trc_dbg
argument_list|(
literal|"ena q_id: %d packets were completed. first desc idx %u descs# %d\n"
argument_list|,
name|io_cq
operator|->
name|qid
argument_list|,
operator|*
name|first_cdesc_idx
argument_list|,
name|count
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|io_cq
operator|->
name|cur_rx_pkt_cdesc_count
operator|+=
name|count
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|count
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|bool
name|ena_com_meta_desc_changed
parameter_list|(
name|struct
name|ena_com_io_sq
modifier|*
name|io_sq
parameter_list|,
name|struct
name|ena_com_tx_ctx
modifier|*
name|ena_tx_ctx
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
if|if
condition|(
name|ena_tx_ctx
operator|->
name|meta_valid
condition|)
block|{
name|rc
operator|=
name|memcmp
argument_list|(
operator|&
name|io_sq
operator|->
name|cached_tx_meta
argument_list|,
operator|&
name|ena_tx_ctx
operator|->
name|ena_meta
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ena_com_tx_meta
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|rc
operator|!=
literal|0
argument_list|)
condition|)
return|return
name|true
return|;
block|}
return|return
name|false
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|ena_com_create_and_store_tx_meta_desc
parameter_list|(
name|struct
name|ena_com_io_sq
modifier|*
name|io_sq
parameter_list|,
name|struct
name|ena_com_tx_ctx
modifier|*
name|ena_tx_ctx
parameter_list|)
block|{
name|struct
name|ena_eth_io_tx_meta_desc
modifier|*
name|meta_desc
init|=
name|NULL
decl_stmt|;
name|struct
name|ena_com_tx_meta
modifier|*
name|ena_meta
init|=
operator|&
name|ena_tx_ctx
operator|->
name|ena_meta
decl_stmt|;
name|meta_desc
operator|=
name|get_sq_desc
argument_list|(
name|io_sq
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|meta_desc
argument_list|,
literal|0x0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ena_eth_io_tx_meta_desc
argument_list|)
argument_list|)
expr_stmt|;
name|meta_desc
operator|->
name|len_ctrl
operator||=
name|ENA_ETH_IO_TX_META_DESC_META_DESC_MASK
expr_stmt|;
name|meta_desc
operator|->
name|len_ctrl
operator||=
name|ENA_ETH_IO_TX_META_DESC_EXT_VALID_MASK
expr_stmt|;
comment|/* bits 0-9 of the mss */
name|meta_desc
operator|->
name|word2
operator||=
operator|(
name|ena_meta
operator|->
name|mss
operator|<<
name|ENA_ETH_IO_TX_META_DESC_MSS_LO_SHIFT
operator|)
operator|&
name|ENA_ETH_IO_TX_META_DESC_MSS_LO_MASK
expr_stmt|;
comment|/* bits 10-13 of the mss */
name|meta_desc
operator|->
name|len_ctrl
operator||=
operator|(
operator|(
name|ena_meta
operator|->
name|mss
operator|>>
literal|10
operator|)
operator|<<
name|ENA_ETH_IO_TX_META_DESC_MSS_HI_SHIFT
operator|)
operator|&
name|ENA_ETH_IO_TX_META_DESC_MSS_HI_MASK
expr_stmt|;
comment|/* Extended meta desc */
name|meta_desc
operator|->
name|len_ctrl
operator||=
name|ENA_ETH_IO_TX_META_DESC_ETH_META_TYPE_MASK
expr_stmt|;
name|meta_desc
operator|->
name|len_ctrl
operator||=
name|ENA_ETH_IO_TX_META_DESC_META_STORE_MASK
expr_stmt|;
name|meta_desc
operator|->
name|len_ctrl
operator||=
operator|(
name|io_sq
operator|->
name|phase
operator|<<
name|ENA_ETH_IO_TX_META_DESC_PHASE_SHIFT
operator|)
operator|&
name|ENA_ETH_IO_TX_META_DESC_PHASE_MASK
expr_stmt|;
name|meta_desc
operator|->
name|len_ctrl
operator||=
name|ENA_ETH_IO_TX_META_DESC_FIRST_MASK
expr_stmt|;
name|meta_desc
operator|->
name|word2
operator||=
name|ena_meta
operator|->
name|l3_hdr_len
operator|&
name|ENA_ETH_IO_TX_META_DESC_L3_HDR_LEN_MASK
expr_stmt|;
name|meta_desc
operator|->
name|word2
operator||=
operator|(
name|ena_meta
operator|->
name|l3_hdr_offset
operator|<<
name|ENA_ETH_IO_TX_META_DESC_L3_HDR_OFF_SHIFT
operator|)
operator|&
name|ENA_ETH_IO_TX_META_DESC_L3_HDR_OFF_MASK
expr_stmt|;
name|meta_desc
operator|->
name|word2
operator||=
operator|(
name|ena_meta
operator|->
name|l4_hdr_len
operator|<<
name|ENA_ETH_IO_TX_META_DESC_L4_HDR_LEN_IN_WORDS_SHIFT
operator|)
operator|&
name|ENA_ETH_IO_TX_META_DESC_L4_HDR_LEN_IN_WORDS_MASK
expr_stmt|;
name|meta_desc
operator|->
name|len_ctrl
operator||=
name|ENA_ETH_IO_TX_META_DESC_META_STORE_MASK
expr_stmt|;
comment|/* Cached the meta desc */
name|memcpy
argument_list|(
operator|&
name|io_sq
operator|->
name|cached_tx_meta
argument_list|,
name|ena_meta
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ena_com_tx_meta
argument_list|)
argument_list|)
expr_stmt|;
name|ena_com_copy_curr_sq_desc_to_dev
argument_list|(
name|io_sq
argument_list|)
expr_stmt|;
name|ena_com_sq_update_tail
argument_list|(
name|io_sq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|ena_com_rx_set_flags
parameter_list|(
name|struct
name|ena_com_rx_ctx
modifier|*
name|ena_rx_ctx
parameter_list|,
name|struct
name|ena_eth_io_rx_cdesc_base
modifier|*
name|cdesc
parameter_list|)
block|{
name|ena_rx_ctx
operator|->
name|l3_proto
operator|=
name|cdesc
operator|->
name|status
operator|&
name|ENA_ETH_IO_RX_CDESC_BASE_L3_PROTO_IDX_MASK
expr_stmt|;
name|ena_rx_ctx
operator|->
name|l4_proto
operator|=
operator|(
name|cdesc
operator|->
name|status
operator|&
name|ENA_ETH_IO_RX_CDESC_BASE_L4_PROTO_IDX_MASK
operator|)
operator|>>
name|ENA_ETH_IO_RX_CDESC_BASE_L4_PROTO_IDX_SHIFT
expr_stmt|;
name|ena_rx_ctx
operator|->
name|l3_csum_err
operator|=
operator|(
name|cdesc
operator|->
name|status
operator|&
name|ENA_ETH_IO_RX_CDESC_BASE_L3_CSUM_ERR_MASK
operator|)
operator|>>
name|ENA_ETH_IO_RX_CDESC_BASE_L3_CSUM_ERR_SHIFT
expr_stmt|;
name|ena_rx_ctx
operator|->
name|l4_csum_err
operator|=
operator|(
name|cdesc
operator|->
name|status
operator|&
name|ENA_ETH_IO_RX_CDESC_BASE_L4_CSUM_ERR_MASK
operator|)
operator|>>
name|ENA_ETH_IO_RX_CDESC_BASE_L4_CSUM_ERR_SHIFT
expr_stmt|;
name|ena_rx_ctx
operator|->
name|hash
operator|=
name|cdesc
operator|->
name|hash
expr_stmt|;
name|ena_rx_ctx
operator|->
name|frag
operator|=
operator|(
name|cdesc
operator|->
name|status
operator|&
name|ENA_ETH_IO_RX_CDESC_BASE_IPV4_FRAG_MASK
operator|)
operator|>>
name|ENA_ETH_IO_RX_CDESC_BASE_IPV4_FRAG_SHIFT
expr_stmt|;
name|ena_trc_dbg
argument_list|(
literal|"ena_rx_ctx->l3_proto %d ena_rx_ctx->l4_proto %d\nena_rx_ctx->l3_csum_err %d ena_rx_ctx->l4_csum_err %d\nhash frag %d frag: %d cdesc_status: %x\n"
argument_list|,
name|ena_rx_ctx
operator|->
name|l3_proto
argument_list|,
name|ena_rx_ctx
operator|->
name|l4_proto
argument_list|,
name|ena_rx_ctx
operator|->
name|l3_csum_err
argument_list|,
name|ena_rx_ctx
operator|->
name|l4_csum_err
argument_list|,
name|ena_rx_ctx
operator|->
name|hash
argument_list|,
name|ena_rx_ctx
operator|->
name|frag
argument_list|,
name|cdesc
operator|->
name|status
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*****************************     API      **********************************/
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|int
name|ena_com_prepare_tx
parameter_list|(
name|struct
name|ena_com_io_sq
modifier|*
name|io_sq
parameter_list|,
name|struct
name|ena_com_tx_ctx
modifier|*
name|ena_tx_ctx
parameter_list|,
name|int
modifier|*
name|nb_hw_desc
parameter_list|)
block|{
name|struct
name|ena_eth_io_tx_desc
modifier|*
name|desc
init|=
name|NULL
decl_stmt|;
name|struct
name|ena_com_buf
modifier|*
name|ena_bufs
init|=
name|ena_tx_ctx
operator|->
name|ena_bufs
decl_stmt|;
name|void
modifier|*
name|push_header
init|=
name|ena_tx_ctx
operator|->
name|push_header
decl_stmt|;
name|u16
name|header_len
init|=
name|ena_tx_ctx
operator|->
name|header_len
decl_stmt|;
name|u16
name|num_bufs
init|=
name|ena_tx_ctx
operator|->
name|num_bufs
decl_stmt|;
name|int
name|total_desc
decl_stmt|,
name|i
decl_stmt|,
name|rc
decl_stmt|;
name|bool
name|have_meta
decl_stmt|;
name|u64
name|addr_hi
decl_stmt|;
name|ENA_WARN
argument_list|(
name|io_sq
operator|->
name|direction
operator|!=
name|ENA_COM_IO_QUEUE_DIRECTION_TX
argument_list|,
literal|"wrong Q type"
argument_list|)
expr_stmt|;
comment|/* num_bufs +1 for potential meta desc */
if|if
condition|(
name|ena_com_sq_empty_space
argument_list|(
name|io_sq
argument_list|)
operator|<
operator|(
name|num_bufs
operator|+
literal|1
operator|)
condition|)
block|{
name|ena_trc_err
argument_list|(
literal|"Not enough space in the tx queue\n"
argument_list|)
expr_stmt|;
return|return
name|ENA_COM_NO_MEM
return|;
block|}
if|if
condition|(
name|unlikely
argument_list|(
name|header_len
operator|>
name|io_sq
operator|->
name|tx_max_header_size
argument_list|)
condition|)
block|{
name|ena_trc_err
argument_list|(
literal|"header size is too large %d max header: %d\n"
argument_list|,
name|header_len
argument_list|,
name|io_sq
operator|->
name|tx_max_header_size
argument_list|)
expr_stmt|;
return|return
name|ENA_COM_INVAL
return|;
block|}
comment|/* start with pushing the header (if needed) */
name|rc
operator|=
name|ena_com_write_header
argument_list|(
name|io_sq
argument_list|,
name|push_header
argument_list|,
name|header_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|rc
argument_list|)
condition|)
return|return
name|rc
return|;
name|have_meta
operator|=
name|ena_tx_ctx
operator|->
name|meta_valid
operator|&&
name|ena_com_meta_desc_changed
argument_list|(
name|io_sq
argument_list|,
name|ena_tx_ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_meta
condition|)
name|ena_com_create_and_store_tx_meta_desc
argument_list|(
name|io_sq
argument_list|,
name|ena_tx_ctx
argument_list|)
expr_stmt|;
comment|/* If the caller doesn't want send packets */
if|if
condition|(
name|unlikely
argument_list|(
operator|!
name|num_bufs
operator|&&
operator|!
name|header_len
argument_list|)
condition|)
block|{
operator|*
name|nb_hw_desc
operator|=
name|have_meta
condition|?
literal|0
else|:
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
name|desc
operator|=
name|get_sq_desc
argument_list|(
name|io_sq
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|desc
argument_list|,
literal|0x0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ena_eth_io_tx_desc
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Set first desc when we don't have meta descriptor */
if|if
condition|(
operator|!
name|have_meta
condition|)
name|desc
operator|->
name|len_ctrl
operator||=
name|ENA_ETH_IO_TX_DESC_FIRST_MASK
expr_stmt|;
name|desc
operator|->
name|buff_addr_hi_hdr_sz
operator||=
operator|(
name|header_len
operator|<<
name|ENA_ETH_IO_TX_DESC_HEADER_LENGTH_SHIFT
operator|)
operator|&
name|ENA_ETH_IO_TX_DESC_HEADER_LENGTH_MASK
expr_stmt|;
name|desc
operator|->
name|len_ctrl
operator||=
operator|(
name|io_sq
operator|->
name|phase
operator|<<
name|ENA_ETH_IO_TX_DESC_PHASE_SHIFT
operator|)
operator|&
name|ENA_ETH_IO_TX_DESC_PHASE_MASK
expr_stmt|;
name|desc
operator|->
name|len_ctrl
operator||=
name|ENA_ETH_IO_TX_DESC_COMP_REQ_MASK
expr_stmt|;
comment|/* Bits 0-9 */
name|desc
operator|->
name|meta_ctrl
operator||=
operator|(
name|ena_tx_ctx
operator|->
name|req_id
operator|<<
name|ENA_ETH_IO_TX_DESC_REQ_ID_LO_SHIFT
operator|)
operator|&
name|ENA_ETH_IO_TX_DESC_REQ_ID_LO_MASK
expr_stmt|;
name|desc
operator|->
name|meta_ctrl
operator||=
operator|(
name|ena_tx_ctx
operator|->
name|df
operator|<<
name|ENA_ETH_IO_TX_DESC_DF_SHIFT
operator|)
operator|&
name|ENA_ETH_IO_TX_DESC_DF_MASK
expr_stmt|;
comment|/* Bits 10-15 */
name|desc
operator|->
name|len_ctrl
operator||=
operator|(
operator|(
name|ena_tx_ctx
operator|->
name|req_id
operator|>>
literal|10
operator|)
operator|<<
name|ENA_ETH_IO_TX_DESC_REQ_ID_HI_SHIFT
operator|)
operator|&
name|ENA_ETH_IO_TX_DESC_REQ_ID_HI_MASK
expr_stmt|;
if|if
condition|(
name|ena_tx_ctx
operator|->
name|meta_valid
condition|)
block|{
name|desc
operator|->
name|meta_ctrl
operator||=
operator|(
name|ena_tx_ctx
operator|->
name|tso_enable
operator|<<
name|ENA_ETH_IO_TX_DESC_TSO_EN_SHIFT
operator|)
operator|&
name|ENA_ETH_IO_TX_DESC_TSO_EN_MASK
expr_stmt|;
name|desc
operator|->
name|meta_ctrl
operator||=
name|ena_tx_ctx
operator|->
name|l3_proto
operator|&
name|ENA_ETH_IO_TX_DESC_L3_PROTO_IDX_MASK
expr_stmt|;
name|desc
operator|->
name|meta_ctrl
operator||=
operator|(
name|ena_tx_ctx
operator|->
name|l4_proto
operator|<<
name|ENA_ETH_IO_TX_DESC_L4_PROTO_IDX_SHIFT
operator|)
operator|&
name|ENA_ETH_IO_TX_DESC_L4_PROTO_IDX_MASK
expr_stmt|;
name|desc
operator|->
name|meta_ctrl
operator||=
operator|(
name|ena_tx_ctx
operator|->
name|l3_csum_enable
operator|<<
name|ENA_ETH_IO_TX_DESC_L3_CSUM_EN_SHIFT
operator|)
operator|&
name|ENA_ETH_IO_TX_DESC_L3_CSUM_EN_MASK
expr_stmt|;
name|desc
operator|->
name|meta_ctrl
operator||=
operator|(
name|ena_tx_ctx
operator|->
name|l4_csum_enable
operator|<<
name|ENA_ETH_IO_TX_DESC_L4_CSUM_EN_SHIFT
operator|)
operator|&
name|ENA_ETH_IO_TX_DESC_L4_CSUM_EN_MASK
expr_stmt|;
name|desc
operator|->
name|meta_ctrl
operator||=
operator|(
name|ena_tx_ctx
operator|->
name|l4_csum_partial
operator|<<
name|ENA_ETH_IO_TX_DESC_L4_CSUM_PARTIAL_SHIFT
operator|)
operator|&
name|ENA_ETH_IO_TX_DESC_L4_CSUM_PARTIAL_MASK
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_bufs
condition|;
name|i
operator|++
control|)
block|{
comment|/* The first desc share the same desc as the header */
if|if
condition|(
name|likely
argument_list|(
name|i
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|ena_com_copy_curr_sq_desc_to_dev
argument_list|(
name|io_sq
argument_list|)
expr_stmt|;
name|ena_com_sq_update_tail
argument_list|(
name|io_sq
argument_list|)
expr_stmt|;
name|desc
operator|=
name|get_sq_desc
argument_list|(
name|io_sq
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|desc
argument_list|,
literal|0x0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ena_eth_io_tx_desc
argument_list|)
argument_list|)
expr_stmt|;
name|desc
operator|->
name|len_ctrl
operator||=
operator|(
name|io_sq
operator|->
name|phase
operator|<<
name|ENA_ETH_IO_TX_DESC_PHASE_SHIFT
operator|)
operator|&
name|ENA_ETH_IO_TX_DESC_PHASE_MASK
expr_stmt|;
block|}
name|desc
operator|->
name|len_ctrl
operator||=
name|ena_bufs
operator|->
name|len
operator|&
name|ENA_ETH_IO_TX_DESC_LENGTH_MASK
expr_stmt|;
name|addr_hi
operator|=
operator|(
operator|(
name|ena_bufs
operator|->
name|paddr
operator|&
name|GENMASK_ULL
argument_list|(
name|io_sq
operator|->
name|dma_addr_bits
operator|-
literal|1
argument_list|,
literal|32
argument_list|)
operator|)
operator|>>
literal|32
operator|)
expr_stmt|;
name|desc
operator|->
name|buff_addr_lo
operator|=
operator|(
name|u32
operator|)
name|ena_bufs
operator|->
name|paddr
expr_stmt|;
name|desc
operator|->
name|buff_addr_hi_hdr_sz
operator||=
name|addr_hi
operator|&
name|ENA_ETH_IO_TX_DESC_ADDR_HI_MASK
expr_stmt|;
name|ena_bufs
operator|++
expr_stmt|;
block|}
comment|/* set the last desc indicator */
name|desc
operator|->
name|len_ctrl
operator||=
name|ENA_ETH_IO_TX_DESC_LAST_MASK
expr_stmt|;
name|ena_com_copy_curr_sq_desc_to_dev
argument_list|(
name|io_sq
argument_list|)
expr_stmt|;
name|ena_com_sq_update_tail
argument_list|(
name|io_sq
argument_list|)
expr_stmt|;
name|total_desc
operator|=
name|ENA_MAX16
argument_list|(
name|num_bufs
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|total_desc
operator|+=
name|have_meta
condition|?
literal|1
else|:
literal|0
expr_stmt|;
operator|*
name|nb_hw_desc
operator|=
name|total_desc
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ena_com_rx_pkt
parameter_list|(
name|struct
name|ena_com_io_cq
modifier|*
name|io_cq
parameter_list|,
name|struct
name|ena_com_io_sq
modifier|*
name|io_sq
parameter_list|,
name|struct
name|ena_com_rx_ctx
modifier|*
name|ena_rx_ctx
parameter_list|)
block|{
name|struct
name|ena_com_rx_buf_info
modifier|*
name|ena_buf
init|=
operator|&
name|ena_rx_ctx
operator|->
name|ena_bufs
index|[
literal|0
index|]
decl_stmt|;
name|struct
name|ena_eth_io_rx_cdesc_base
modifier|*
name|cdesc
init|=
name|NULL
decl_stmt|;
name|u16
name|cdesc_idx
init|=
literal|0
decl_stmt|;
name|u16
name|nb_hw_desc
decl_stmt|;
name|u16
name|i
decl_stmt|;
name|ENA_WARN
argument_list|(
name|io_cq
operator|->
name|direction
operator|!=
name|ENA_COM_IO_QUEUE_DIRECTION_RX
argument_list|,
literal|"wrong Q type"
argument_list|)
expr_stmt|;
name|nb_hw_desc
operator|=
name|ena_com_cdesc_rx_pkt_get
argument_list|(
name|io_cq
argument_list|,
operator|&
name|cdesc_idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|nb_hw_desc
operator|==
literal|0
condition|)
block|{
name|ena_rx_ctx
operator|->
name|descs
operator|=
name|nb_hw_desc
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ena_trc_dbg
argument_list|(
literal|"fetch rx packet: queue %d completed desc: %d\n"
argument_list|,
name|io_cq
operator|->
name|qid
argument_list|,
name|nb_hw_desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|nb_hw_desc
operator|>
name|ena_rx_ctx
operator|->
name|max_bufs
argument_list|)
condition|)
block|{
name|ena_trc_err
argument_list|(
literal|"Too many RX cdescs (%d)> MAX(%d)\n"
argument_list|,
name|nb_hw_desc
argument_list|,
name|ena_rx_ctx
operator|->
name|max_bufs
argument_list|)
expr_stmt|;
return|return
name|ENA_COM_NO_SPACE
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nb_hw_desc
condition|;
name|i
operator|++
control|)
block|{
name|cdesc
operator|=
name|ena_com_rx_cdesc_idx_to_ptr
argument_list|(
name|io_cq
argument_list|,
name|cdesc_idx
operator|+
name|i
argument_list|)
expr_stmt|;
name|ena_buf
operator|->
name|len
operator|=
name|cdesc
operator|->
name|length
expr_stmt|;
name|ena_buf
operator|->
name|req_id
operator|=
name|cdesc
operator|->
name|req_id
expr_stmt|;
name|ena_buf
operator|++
expr_stmt|;
block|}
comment|/* Update SQ head ptr */
name|io_sq
operator|->
name|next_to_comp
operator|+=
name|nb_hw_desc
expr_stmt|;
name|ena_trc_dbg
argument_list|(
literal|"[%s][QID#%d] Updating SQ head to: %d\n"
argument_list|,
name|__func__
argument_list|,
name|io_sq
operator|->
name|qid
argument_list|,
name|io_sq
operator|->
name|next_to_comp
argument_list|)
expr_stmt|;
comment|/* Get rx flags from the last pkt */
name|ena_com_rx_set_flags
argument_list|(
name|ena_rx_ctx
argument_list|,
name|cdesc
argument_list|)
expr_stmt|;
name|ena_rx_ctx
operator|->
name|descs
operator|=
name|nb_hw_desc
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ena_com_add_single_rx_desc
parameter_list|(
name|struct
name|ena_com_io_sq
modifier|*
name|io_sq
parameter_list|,
name|struct
name|ena_com_buf
modifier|*
name|ena_buf
parameter_list|,
name|u16
name|req_id
parameter_list|)
block|{
name|struct
name|ena_eth_io_rx_desc
modifier|*
name|desc
decl_stmt|;
name|ENA_WARN
argument_list|(
name|io_sq
operator|->
name|direction
operator|!=
name|ENA_COM_IO_QUEUE_DIRECTION_RX
argument_list|,
literal|"wrong Q type"
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|ena_com_sq_empty_space
argument_list|(
name|io_sq
argument_list|)
operator|==
literal|0
argument_list|)
condition|)
return|return
name|ENA_COM_NO_SPACE
return|;
name|desc
operator|=
name|get_sq_desc
argument_list|(
name|io_sq
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|desc
argument_list|,
literal|0x0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ena_eth_io_rx_desc
argument_list|)
argument_list|)
expr_stmt|;
name|desc
operator|->
name|length
operator|=
name|ena_buf
operator|->
name|len
expr_stmt|;
name|desc
operator|->
name|ctrl
operator||=
name|ENA_ETH_IO_RX_DESC_FIRST_MASK
expr_stmt|;
name|desc
operator|->
name|ctrl
operator||=
name|ENA_ETH_IO_RX_DESC_LAST_MASK
expr_stmt|;
name|desc
operator|->
name|ctrl
operator||=
name|io_sq
operator|->
name|phase
operator|&
name|ENA_ETH_IO_RX_DESC_PHASE_MASK
expr_stmt|;
name|desc
operator|->
name|ctrl
operator||=
name|ENA_ETH_IO_RX_DESC_COMP_REQ_MASK
expr_stmt|;
name|desc
operator|->
name|req_id
operator|=
name|req_id
expr_stmt|;
name|desc
operator|->
name|buff_addr_lo
operator|=
operator|(
name|u32
operator|)
name|ena_buf
operator|->
name|paddr
expr_stmt|;
name|desc
operator|->
name|buff_addr_hi
operator|=
operator|(
operator|(
name|ena_buf
operator|->
name|paddr
operator|&
name|GENMASK_ULL
argument_list|(
name|io_sq
operator|->
name|dma_addr_bits
operator|-
literal|1
argument_list|,
literal|32
argument_list|)
operator|)
operator|>>
literal|32
operator|)
expr_stmt|;
name|ena_com_sq_update_tail
argument_list|(
name|io_sq
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|ena_com_tx_comp_req_id_get
parameter_list|(
name|struct
name|ena_com_io_cq
modifier|*
name|io_cq
parameter_list|,
name|u16
modifier|*
name|req_id
parameter_list|)
block|{
name|u8
name|expected_phase
decl_stmt|,
name|cdesc_phase
decl_stmt|;
name|struct
name|ena_eth_io_tx_cdesc
modifier|*
name|cdesc
decl_stmt|;
name|u16
name|masked_head
decl_stmt|;
name|masked_head
operator|=
name|io_cq
operator|->
name|head
operator|&
operator|(
name|io_cq
operator|->
name|q_depth
operator|-
literal|1
operator|)
expr_stmt|;
name|expected_phase
operator|=
name|io_cq
operator|->
name|phase
expr_stmt|;
name|cdesc
operator|=
operator|(
expr|struct
name|ena_eth_io_tx_cdesc
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|io_cq
operator|->
name|cdesc_addr
operator|.
name|virt_addr
operator|+
operator|(
name|masked_head
operator|*
name|io_cq
operator|->
name|cdesc_entry_size_in_bytes
operator|)
operator|)
expr_stmt|;
comment|/* When the current completion descriptor phase isn't the same as the 	 * expected, it mean that the device still didn't update 	 * this completion. 	 */
name|cdesc_phase
operator|=
name|READ_ONCE
argument_list|(
name|cdesc
operator|->
name|flags
argument_list|)
operator|&
name|ENA_ETH_IO_TX_CDESC_PHASE_MASK
expr_stmt|;
if|if
condition|(
name|cdesc_phase
operator|!=
name|expected_phase
condition|)
return|return
name|ENA_COM_TRY_AGAIN
return|;
name|ena_com_cq_inc_head
argument_list|(
name|io_cq
argument_list|)
expr_stmt|;
operator|*
name|req_id
operator|=
name|READ_ONCE
argument_list|(
name|cdesc
operator|->
name|req_id
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


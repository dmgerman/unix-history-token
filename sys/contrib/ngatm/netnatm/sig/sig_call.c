begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1996-2003  *	Fraunhofer Institute for Open Communication Systems (FhG Fokus).  * 	All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * Author: Hartmut Brandt<harti@freebsd.org>  *  * $Begemot: libunimsg/netnatm/sig/sig_call.c,v 1.65 2004/08/05 07:11:00 brandt Exp $  *  * Call instance handling  *  * Note:  *	In all functions that handle messages from the user or from  *	the SAAL, commit memory allocation always at the begin of the  *	function. If allocation fails, ignore saal messages and  *	respond with an error to user messages.  */
end_comment

begin_include
include|#
directive|include
file|<netnatm/unimsg.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/saal/sscfudef.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/msg/unistruct.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/msg/unimsglib.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/sig/uni.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/sig/unipriv.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/sig/unimkmsg.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/sig/unimsgcpy.h>
end_include

begin_function_decl
specifier|static
name|enum
name|call_state
name|state_compat
parameter_list|(
name|struct
name|call
modifier|*
parameter_list|,
name|enum
name|uni_callstate
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|respond_drop_party_ack
parameter_list|(
name|struct
name|call
modifier|*
parameter_list|,
name|struct
name|uni_ie_epref
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|DEF_PRIV_SIG
parameter_list|(
name|NAME
parameter_list|,
name|FROM
parameter_list|)
value|[SIG##NAME] =	"SIG"#NAME,
end_define

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|call_sigs
index|[]
init|=
block|{
name|DEF_CALL_SIGS
block|}
decl_stmt|;
end_decl_stmt

begin_undef
undef|#
directive|undef
name|DEF_PRIV_SIG
end_undef

begin_macro
name|TIMER_FUNC_CALL
argument_list|(
argument|t308
argument_list|,
argument|t308_func
argument_list|)
end_macro

begin_macro
name|TIMER_FUNC_CALL
argument_list|(
argument|t303
argument_list|,
argument|t303_func
argument_list|)
end_macro

begin_macro
name|TIMER_FUNC_CALL
argument_list|(
argument|t301
argument_list|,
argument|t301_func
argument_list|)
end_macro

begin_macro
name|TIMER_FUNC_CALL
argument_list|(
argument|t310
argument_list|,
argument|t310_func
argument_list|)
end_macro

begin_macro
name|TIMER_FUNC_CALL
argument_list|(
argument|t313
argument_list|,
argument|t313_func
argument_list|)
end_macro

begin_macro
name|TIMER_FUNC_CALL
argument_list|(
argument|t322
argument_list|,
argument|t322_func
argument_list|)
end_macro

begin_decl_stmt
specifier|const
name|struct
name|callstates
name|callstates
index|[]
init|=
block|{
index|[
name|CALLST_NULL
index|]
operator|=
block|{
literal|"NU0"
block|,
name|UNI_CALLSTATE_U0
block|}
block|,
index|[
name|CALLST_U1
index|]
operator|=
block|{
literal|"U1"
block|,
name|UNI_CALLSTATE_U1
block|}
block|,
index|[
name|CALLST_U3
index|]
operator|=
block|{
literal|"U3"
block|,
name|UNI_CALLSTATE_U3
block|}
block|,
index|[
name|CALLST_U4
index|]
operator|=
block|{
literal|"U4"
block|,
name|UNI_CALLSTATE_U4
block|}
block|,
index|[
name|CALLST_U6
index|]
operator|=
block|{
literal|"U6"
block|,
name|UNI_CALLSTATE_U6
block|}
block|,
index|[
name|CALLST_U7
index|]
operator|=
block|{
literal|"U7"
block|,
name|UNI_CALLSTATE_U7
block|}
block|,
index|[
name|CALLST_U8
index|]
operator|=
block|{
literal|"U8"
block|,
name|UNI_CALLSTATE_U8
block|}
block|,
index|[
name|CALLST_U9
index|]
operator|=
block|{
literal|"U9"
block|,
name|UNI_CALLSTATE_U9
block|}
block|,
index|[
name|CALLST_U10
index|]
operator|=
block|{
literal|"U10"
block|,
name|UNI_CALLSTATE_U10
block|}
block|,
index|[
name|CALLST_U11
index|]
operator|=
block|{
literal|"U11"
block|,
name|UNI_CALLSTATE_U11
block|}
block|,
index|[
name|CALLST_U12
index|]
operator|=
block|{
literal|"U12"
block|,
name|UNI_CALLSTATE_U12
block|}
block|,
index|[
name|CALLST_N1
index|]
operator|=
block|{
literal|"N1"
block|,
name|UNI_CALLSTATE_N1
block|}
block|,
index|[
name|CALLST_N3
index|]
operator|=
block|{
literal|"N3"
block|,
name|UNI_CALLSTATE_N3
block|}
block|,
index|[
name|CALLST_N4
index|]
operator|=
block|{
literal|"N4"
block|,
name|UNI_CALLSTATE_N4
block|}
block|,
index|[
name|CALLST_N6
index|]
operator|=
block|{
literal|"N6"
block|,
name|UNI_CALLSTATE_N6
block|}
block|,
index|[
name|CALLST_N7
index|]
operator|=
block|{
literal|"N7"
block|,
name|UNI_CALLSTATE_N7
block|}
block|,
index|[
name|CALLST_N8
index|]
operator|=
block|{
literal|"N8"
block|,
name|UNI_CALLSTATE_N8
block|}
block|,
index|[
name|CALLST_N9
index|]
operator|=
block|{
literal|"N9"
block|,
name|UNI_CALLSTATE_N9
block|}
block|,
index|[
name|CALLST_N10
index|]
operator|=
block|{
literal|"N10"
block|,
name|UNI_CALLSTATE_N10
block|}
block|,
index|[
name|CALLST_N11
index|]
operator|=
block|{
literal|"N11"
block|,
name|UNI_CALLSTATE_N11
block|}
block|,
index|[
name|CALLST_N12
index|]
operator|=
block|{
literal|"N12"
block|,
name|UNI_CALLSTATE_N12
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|unx_send_add_party_rej
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|__inline
name|void
name|set_call_state
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|enum
name|call_state
name|state
parameter_list|)
block|{
name|ASSERT
argument_list|(
name|state
operator|==
name|CALLST_NULL
operator|||
operator|(
name|c
operator|->
name|uni
operator|->
name|proto
operator|==
name|UNIPROTO_UNI40U
operator|&&
operator|(
name|state
operator|>=
name|CALLST_U1
operator|&&
name|state
operator|<=
name|CALLST_U12
operator|)
operator|)
operator|||
operator|(
name|c
operator|->
name|uni
operator|->
name|proto
operator|==
name|UNIPROTO_UNI40N
operator|&&
operator|(
name|state
operator|>=
name|CALLST_N1
operator|&&
name|state
operator|<=
name|CALLST_N12
operator|)
operator|)
argument_list|,
operator|(
literal|"setting wrong callstate for proto %u: %u"
operator|,
name|c
operator|->
name|uni
operator|->
name|proto
operator|,
name|state
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|cstate
operator|!=
name|state
condition|)
block|{
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_CALL
argument_list|,
literal|1
argument_list|,
literal|"call %d/%d %s -> %s"
argument_list|,
name|c
operator|->
name|cref
argument_list|,
name|c
operator|->
name|mine
argument_list|,
name|callstates
index|[
name|c
operator|->
name|cstate
index|]
operator|.
name|name
argument_list|,
name|callstates
index|[
name|state
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|c
operator|->
name|cstate
operator|=
name|state
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|enum
name|uni_callstate
name|map_callstate
parameter_list|(
name|enum
name|call_state
name|state
parameter_list|)
block|{
return|return
operator|(
name|callstates
index|[
name|state
index|]
operator|.
name|ext
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Find the call. Assume, that the cref is one of a message just received.  * That is, if the call reference flag is 0 it is his call, if it is 1 it  * is my call.  */
end_comment

begin_function
name|struct
name|call
modifier|*
name|uni_find_call
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|struct
name|uni_cref
modifier|*
name|cref
parameter_list|)
block|{
name|struct
name|call
modifier|*
name|c
decl_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|c
argument_list|,
argument|&uni->calls
argument_list|,
argument|link
argument_list|)
if|if
condition|(
name|c
operator|->
name|cref
operator|==
name|cref
operator|->
name|cref
operator|&&
operator|(
operator|!
name|c
operator|->
name|mine
operator|==
operator|!
name|cref
operator|->
name|flag
operator|)
condition|)
return|return
operator|(
name|c
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|call
modifier|*
name|uni_find_callx
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|u_int
name|cref
parameter_list|,
name|u_int
name|mine
parameter_list|)
block|{
name|struct
name|call
modifier|*
name|c
decl_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|c
argument_list|,
argument|&uni->calls
argument_list|,
argument|link
argument_list|)
if|if
condition|(
name|c
operator|->
name|cref
operator|==
name|cref
operator|&&
operator|!
name|c
operator|->
name|mine
operator|==
operator|!
name|mine
condition|)
return|return
operator|(
name|c
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Create a new call instance. The type must be set by the caller.  */
end_comment

begin_function
name|struct
name|call
modifier|*
name|uni_create_call
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|u_int
name|cref
parameter_list|,
name|u_int
name|mine
parameter_list|,
name|uint32_t
name|cookie
parameter_list|)
block|{
name|struct
name|call
modifier|*
name|c
decl_stmt|;
name|struct
name|uniapi_call_created
modifier|*
name|ind
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|api
decl_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|CALL_ALLOC
argument_list|()
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
if|if
condition|(
operator|(
name|ind
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_call_created
argument_list|,
name|api
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|CALL_FREE
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|ind
operator|->
name|cref
operator|.
name|cref
operator|=
name|cref
expr_stmt|;
name|ind
operator|->
name|cref
operator|.
name|flag
operator|=
name|mine
expr_stmt|;
name|c
operator|->
name|uni
operator|=
name|uni
expr_stmt|;
name|c
operator|->
name|type
operator|=
name|CALL_NULL
expr_stmt|;
name|c
operator|->
name|cref
operator|=
name|cref
expr_stmt|;
name|c
operator|->
name|mine
operator|=
name|mine
expr_stmt|;
name|c
operator|->
name|cstate
operator|=
name|CALLST_NULL
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|c
operator|->
name|parties
argument_list|)
expr_stmt|;
name|TIMER_INIT_CALL
argument_list|(
name|c
argument_list|,
name|t301
argument_list|)
expr_stmt|;
name|TIMER_INIT_CALL
argument_list|(
name|c
argument_list|,
name|t303
argument_list|)
expr_stmt|;
name|TIMER_INIT_CALL
argument_list|(
name|c
argument_list|,
name|t308
argument_list|)
expr_stmt|;
name|TIMER_INIT_CALL
argument_list|(
name|c
argument_list|,
name|t310
argument_list|)
expr_stmt|;
name|TIMER_INIT_CALL
argument_list|(
name|c
argument_list|,
name|t313
argument_list|)
expr_stmt|;
name|TIMER_INIT_CALL
argument_list|(
name|c
argument_list|,
name|t322
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_HEAD
argument_list|(
operator|&
name|uni
operator|->
name|calls
argument_list|,
name|c
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|uni
argument_list|,
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_CALL_CREATED
argument_list|,
name|cookie
argument_list|,
name|api
argument_list|)
expr_stmt|;
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_CALL
argument_list|,
literal|1
argument_list|,
literal|"created call %u/%s"
argument_list|,
name|c
operator|->
name|cref
argument_list|,
name|c
operator|->
name|mine
condition|?
literal|"mine"
else|:
literal|"his"
argument_list|)
expr_stmt|;
return|return
operator|(
name|c
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|call
modifier|*
name|uni_create_new_call
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|uint32_t
name|cookie
parameter_list|)
block|{
name|struct
name|call
modifier|*
name|c
decl_stmt|;
name|uint32_t
name|old
init|=
name|uni
operator|->
name|cref_alloc
operator|++
decl_stmt|;
name|again
label|:
if|if
condition|(
name|uni
operator|->
name|cref_alloc
operator|==
operator|(
literal|1
operator|<<
literal|23
operator|)
condition|)
name|uni
operator|->
name|cref_alloc
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|uni
operator|->
name|cref_alloc
operator|==
name|old
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* all crefs exhausted!!! */
name|TAILQ_FOREACH
argument_list|(
argument|c
argument_list|,
argument|&uni->calls
argument_list|,
argument|link
argument_list|)
if|if
condition|(
name|c
operator|->
name|mine
operator|&&
name|c
operator|->
name|cref
operator|==
name|uni
operator|->
name|cref_alloc
condition|)
block|{
name|uni
operator|->
name|cref_alloc
operator|++
expr_stmt|;
goto|goto
name|again
goto|;
block|}
return|return
operator|(
name|uni_create_call
argument_list|(
name|uni
argument_list|,
name|uni
operator|->
name|cref_alloc
argument_list|,
literal|1
argument_list|,
name|cookie
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Assume timers are all stopped. Memory is not actually freed unless  * the reference count drops to 0.  * This function is assumed to remove the call from the parent UNI's   * call queue.  */
end_comment

begin_function
name|void
name|uni_destroy_call
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|int
name|really
parameter_list|)
block|{
name|struct
name|uniapi_call_destroyed
modifier|*
name|ind
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|api
decl_stmt|;
name|struct
name|party
modifier|*
name|p
decl_stmt|;
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_CALL
argument_list|,
literal|1
argument_list|,
literal|"destroying call %u/%s"
argument_list|,
name|c
operator|->
name|cref
argument_list|,
name|c
operator|->
name|mine
condition|?
literal|"mine"
else|:
literal|"his"
argument_list|)
expr_stmt|;
name|TIMER_DESTROY_CALL
argument_list|(
name|c
argument_list|,
name|t301
argument_list|)
expr_stmt|;
name|TIMER_DESTROY_CALL
argument_list|(
name|c
argument_list|,
name|t303
argument_list|)
expr_stmt|;
name|TIMER_DESTROY_CALL
argument_list|(
name|c
argument_list|,
name|t308
argument_list|)
expr_stmt|;
name|TIMER_DESTROY_CALL
argument_list|(
name|c
argument_list|,
name|t310
argument_list|)
expr_stmt|;
name|TIMER_DESTROY_CALL
argument_list|(
name|c
argument_list|,
name|t313
argument_list|)
expr_stmt|;
name|TIMER_DESTROY_CALL
argument_list|(
name|c
argument_list|,
name|t322
argument_list|)
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|c
operator|->
name|uni
operator|->
name|calls
argument_list|,
name|c
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|uni_delsig
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|SIG_CALL
argument_list|,
name|c
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|p
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|c
operator|->
name|parties
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|c
operator|->
name|parties
argument_list|,
name|p
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|uni_destroy_party
argument_list|(
name|p
argument_list|,
name|really
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|really
condition|)
block|{
name|ind
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_call_destroyed
argument_list|,
name|api
argument_list|)
expr_stmt|;
if|if
condition|(
name|ind
operator|!=
name|NULL
condition|)
block|{
name|ind
operator|->
name|cref
operator|.
name|cref
operator|=
name|c
operator|->
name|cref
expr_stmt|;
name|ind
operator|->
name|cref
operator|.
name|flag
operator|=
name|c
operator|->
name|mine
expr_stmt|;
name|uni_enq_coord
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|SIGO_CALL_DESTROYED
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
block|}
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_CALL_DELETE
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return;
block|}
name|CALL_FREE
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|allocate_epref
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_ie_epref
modifier|*
name|epref
parameter_list|)
block|{
name|struct
name|party
modifier|*
name|p
decl_stmt|;
name|uint32_t
name|old
init|=
name|c
operator|->
name|epref_alloc
operator|++
decl_stmt|;
name|again
label|:
if|if
condition|(
name|c
operator|->
name|epref_alloc
operator|==
operator|(
literal|1
operator|<<
literal|15
operator|)
condition|)
name|c
operator|->
name|epref_alloc
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|epref_alloc
operator|==
name|old
condition|)
return|return;
comment|/* all crefs exhausted!!! */
name|TAILQ_FOREACH
argument_list|(
argument|p
argument_list|,
argument|&c->parties
argument_list|,
argument|link
argument_list|)
if|if
condition|(
name|p
operator|->
name|epref
operator|==
name|c
operator|->
name|epref_alloc
condition|)
block|{
name|c
operator|->
name|epref_alloc
operator|++
expr_stmt|;
goto|goto
name|again
goto|;
block|}
name|IE_SETPRESENT
argument_list|(
operator|*
name|epref
argument_list|)
expr_stmt|;
name|epref
operator|->
name|flag
operator|=
literal|0
expr_stmt|;
name|epref
operator|->
name|epref
operator|=
name|c
operator|->
name|epref_alloc
expr_stmt|;
name|epref
operator|->
name|h
operator|.
name|coding
operator|=
name|UNI_CODING_ITU
expr_stmt|;
name|epref
operator|->
name|h
operator|.
name|act
operator|=
name|UNI_IEACT_DEFAULT
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|reset_all_timers
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|)
block|{
name|TIMER_STOP_CALL
argument_list|(
name|c
argument_list|,
name|t301
argument_list|)
expr_stmt|;
name|TIMER_STOP_CALL
argument_list|(
name|c
argument_list|,
name|t303
argument_list|)
expr_stmt|;
name|TIMER_STOP_CALL
argument_list|(
name|c
argument_list|,
name|t308
argument_list|)
expr_stmt|;
name|TIMER_STOP_CALL
argument_list|(
name|c
argument_list|,
name|t310
argument_list|)
expr_stmt|;
name|TIMER_STOP_CALL
argument_list|(
name|c
argument_list|,
name|t313
argument_list|)
expr_stmt|;
name|TIMER_STOP_CALL
argument_list|(
name|c
argument_list|,
name|t322
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Initiate call clearing because of a problem. This is label D in   * the SDLs and is called from many places.  * The call must have constructed the cause IE in struct call.  *  * Q.2971:Call-Control-U 27/39  * Q.2971:Call-Control-N 28/39  *  * Memory problems are handled differently here: we simply ignore them  * by not sending messages or user indications. Because of T308 we  * may be lucky to send the message in a second run.  *  * It is assumed, that the cause for the release is constructed by  * the calling function in uni->cause.  */
end_comment

begin_function
specifier|static
name|void
name|clear_callD
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|)
block|{
name|struct
name|uni_msg
modifier|*
name|api
decl_stmt|;
name|struct
name|uniapi_release_indication
modifier|*
name|ind
decl_stmt|;
name|struct
name|party
modifier|*
name|p
decl_stmt|;
name|struct
name|uni_all
modifier|*
name|rel
decl_stmt|;
comment|/* 	 * Send indication to API 	 */
if|if
condition|(
operator|(
name|ind
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_release_indication
argument_list|,
name|api
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|ind
operator|->
name|release
operator|.
name|hdr
operator|.
name|cref
operator|.
name|cref
operator|=
name|c
operator|->
name|cref
expr_stmt|;
name|ind
operator|->
name|release
operator|.
name|hdr
operator|.
name|cref
operator|.
name|flag
operator|=
name|c
operator|->
name|mine
expr_stmt|;
name|ind
operator|->
name|release
operator|.
name|hdr
operator|.
name|act
operator|=
name|UNI_MSGACT_DEFAULT
expr_stmt|;
name|ind
operator|->
name|release
operator|.
name|cause
index|[
literal|0
index|]
operator|=
name|c
operator|->
name|uni
operator|->
name|cause
expr_stmt|;
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_RELEASE_indication
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
block|}
name|reset_all_timers
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|CALL_LEAF
operator|||
name|c
operator|->
name|type
operator|==
name|CALL_ROOT
condition|)
block|{
name|TAILQ_FOREACH
argument_list|(
argument|p
argument_list|,
argument|&c->parties
argument_list|,
argument|link
argument_list|)
block|{
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_RELEASE_request
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
name|memset
argument_list|(
operator|&
name|c
operator|->
name|msg_release
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|c
operator|->
name|msg_release
argument_list|)
argument_list|)
expr_stmt|;
name|c
operator|->
name|msg_release
operator|.
name|cause
index|[
literal|0
index|]
operator|=
name|c
operator|->
name|uni
operator|->
name|cause
expr_stmt|;
if|if
condition|(
operator|(
name|rel
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|!=
name|NULL
condition|)
block|{
name|rel
operator|->
name|u
operator|.
name|release
operator|=
name|c
operator|->
name|msg_release
expr_stmt|;
name|MK_MSG_ORIG
argument_list|(
name|rel
argument_list|,
name|UNI_RELEASE
argument_list|,
name|c
operator|->
name|cref
argument_list|,
operator|!
name|c
operator|->
name|mine
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|rel
argument_list|,
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|rel
argument_list|)
expr_stmt|;
block|}
name|TIMER_START_CALL
argument_list|(
name|c
argument_list|,
name|t308
argument_list|,
name|c
operator|->
name|uni
operator|->
name|timer308
argument_list|)
expr_stmt|;
name|c
operator|->
name|cnt308
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|uni
operator|->
name|proto
operator|==
name|UNIPROTO_UNI40N
condition|)
name|set_call_state
argument_list|(
name|c
argument_list|,
name|CALLST_N12
argument_list|)
expr_stmt|;
else|else
name|set_call_state
argument_list|(
name|c
argument_list|,
name|CALLST_U11
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************/
end_comment

begin_comment
comment|/*  * SETUP message in state NULL  *  * Q.2971:Call-Control-U 4/39  * Q.2971:Call-Control-N 4/39  */
end_comment

begin_function
specifier|static
name|void
name|un0_setup
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|,
name|enum
name|call_state
name|new_state
parameter_list|)
block|{
name|struct
name|uni_all
modifier|*
name|resp
decl_stmt|;
name|struct
name|party
modifier|*
name|p
decl_stmt|;
name|struct
name|uniapi_setup_indication
modifier|*
name|ind
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|api
decl_stmt|;
name|enum
name|verify
name|v
decl_stmt|;
if|if
condition|(
operator|(
name|ind
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_setup_indication
argument_list|,
name|api
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|clear
label|:
name|uni_destroy_call
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Analyze message 	 */
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|m
argument_list|,
name|u
argument_list|,
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
name|MANDATE_IE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|setup
operator|.
name|bearer
argument_list|,
name|UNI_IE_BEARER
argument_list|)
expr_stmt|;
name|MANDATE_IE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|setup
operator|.
name|traffic
argument_list|,
name|UNI_IE_TRAFFIC
argument_list|)
expr_stmt|;
name|MANDATE_IE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|setup
operator|.
name|called
argument_list|,
name|UNI_IE_CALLED
argument_list|)
expr_stmt|;
comment|/* 	 * UNI4.0: 9.1.1.2 Notes 2/3 	 */
if|if
condition|(
operator|!
name|IE_ISPRESENT
argument_list|(
name|u
operator|->
name|u
operator|.
name|setup
operator|.
name|qos
argument_list|)
condition|)
name|MANDATE_IE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|setup
operator|.
name|exqos
argument_list|,
name|UNI_IE_EXQOS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IE_ISPRESENT
argument_list|(
name|u
operator|->
name|u
operator|.
name|setup
operator|.
name|exqos
argument_list|)
condition|)
name|MANDATE_IE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|setup
operator|.
name|qos
argument_list|,
name|UNI_IE_QOS
argument_list|)
expr_stmt|;
comment|/* 	 * Q.2971 	 */
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|setup
operator|.
name|bearer
argument_list|)
operator|&&
name|u
operator|->
name|u
operator|.
name|setup
operator|.
name|bearer
operator|.
name|cfg
operator|==
name|UNI_BEARER_MP
condition|)
block|{
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|setup
operator|.
name|epref
argument_list|)
operator|&&
name|u
operator|->
name|u
operator|.
name|setup
operator|.
name|epref
operator|.
name|flag
operator|==
literal|1
condition|)
block|{
name|IE_SETERROR
argument_list|(
name|u
operator|->
name|u
operator|.
name|setup
operator|.
name|epref
argument_list|)
expr_stmt|;
name|UNI_SAVE_IERR
argument_list|(
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|,
name|UNI_IE_EPREF
argument_list|,
name|u
operator|->
name|u
operator|.
name|setup
operator|.
name|epref
operator|.
name|h
operator|.
name|act
argument_list|,
name|UNI_IERR_BAD
argument_list|)
expr_stmt|;
block|}
name|uni_mandate_epref
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|setup
operator|.
name|epref
argument_list|)
expr_stmt|;
block|}
name|v
operator|=
name|uni_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|v
condition|)
block|{
case|case
name|VFY_RAI
case|:
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|UNI_CALLSTATE_U0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* FALLTHRU */
case|case
name|VFY_I
case|:
name|uni_msg_destroy
argument_list|(
name|api
argument_list|)
expr_stmt|;
goto|goto
name|clear
goto|;
case|case
name|VFY_RAIM
case|:
case|case
name|VFY_CLR
case|:
if|if
condition|(
operator|(
name|resp
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|!=
name|NULL
condition|)
block|{
name|MK_MSG_RESP
argument_list|(
name|resp
argument_list|,
name|UNI_RELEASE_COMPL
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|)
expr_stmt|;
name|uni_vfy_collect_ies
argument_list|(
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|resp
operator|->
name|u
operator|.
name|release_compl
operator|.
name|cause
index|[
literal|0
index|]
operator|=
name|c
operator|->
name|uni
operator|->
name|cause
expr_stmt|;
name|uni_send_output
argument_list|(
name|resp
argument_list|,
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|resp
argument_list|)
expr_stmt|;
block|}
name|uni_msg_destroy
argument_list|(
name|api
argument_list|)
expr_stmt|;
goto|goto
name|clear
goto|;
case|case
name|VFY_RAP
case|:
case|case
name|VFY_RAPU
case|:
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|new_state
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* FALLTHRU */
case|case
name|VFY_OK
case|:
break|break;
block|}
if|if
condition|(
name|u
operator|->
name|u
operator|.
name|setup
operator|.
name|bearer
operator|.
name|cfg
operator|==
name|UNI_BEARER_P2P
condition|)
block|{
name|c
operator|->
name|type
operator|=
name|CALL_P2P
expr_stmt|;
block|}
else|else
block|{
name|c
operator|->
name|type
operator|=
name|CALL_LEAF
expr_stmt|;
if|if
condition|(
operator|(
name|p
operator|=
name|uni_create_party
argument_list|(
name|c
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|setup
operator|.
name|epref
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|api
argument_list|)
expr_stmt|;
goto|goto
name|clear
goto|;
block|}
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_SETUP
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|ind
operator|->
name|setup
operator|.
name|hdr
operator|=
name|u
operator|->
name|u
operator|.
name|hdr
expr_stmt|;
name|copy_msg_setup
argument_list|(
operator|&
name|u
operator|->
name|u
operator|.
name|setup
argument_list|,
operator|&
name|ind
operator|->
name|setup
argument_list|)
expr_stmt|;
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_SETUP_indication
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
name|set_call_state
argument_list|(
name|c
argument_list|,
name|new_state
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Setup.request from user  *  * Q.2971:Call-Control-U 4/39 (U0)  * Q.2971:Call-Control-N 4/39 (N0)  */
end_comment

begin_function
specifier|static
name|void
name|un0_setup_request
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|uint32_t
name|cookie
parameter_list|,
name|enum
name|call_state
name|new_state
parameter_list|)
block|{
name|struct
name|uniapi_setup_request
modifier|*
name|arg
init|=
name|uni_msg_rptr
argument_list|(
name|m
argument_list|,
expr|struct
name|uniapi_setup_request
operator|*
argument_list|)
decl_stmt|;
name|struct
name|uni_setup
modifier|*
name|setup
init|=
operator|&
name|arg
operator|->
name|setup
decl_stmt|;
name|struct
name|uni_all
modifier|*
name|out
decl_stmt|;
name|struct
name|party
modifier|*
name|p
decl_stmt|;
if|if
condition|(
operator|!
name|IE_ISGOOD
argument_list|(
name|setup
operator|->
name|bearer
argument_list|)
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_MISSING_IE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_destroy_call
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|out
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|==
name|NULL
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_NOMEM
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_destroy_call
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|c
operator|->
name|msg_setup
operator|=
operator|*
name|setup
expr_stmt|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|setup
operator|->
name|connid
argument_list|)
condition|)
name|c
operator|->
name|connid
operator|=
name|setup
operator|->
name|connid
expr_stmt|;
if|if
condition|(
name|setup
operator|->
name|bearer
operator|.
name|cfg
operator|==
name|UNI_BEARER_P2P
condition|)
block|{
name|c
operator|->
name|type
operator|=
name|CALL_P2P
expr_stmt|;
block|}
else|else
block|{
name|c
operator|->
name|type
operator|=
name|CALL_ROOT
expr_stmt|;
comment|/* 		 * If the user didn't specify a endpoint reference, 		 * use 0. Use IE_IGNORE accoring to Appendix II Q.2971 		 */
if|if
condition|(
operator|!
name|IE_ISPRESENT
argument_list|(
name|c
operator|->
name|msg_setup
operator|.
name|epref
argument_list|)
condition|)
block|{
name|MK_IE_EPREF
argument_list|(
name|c
operator|->
name|msg_setup
operator|.
name|epref
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|uni
operator|->
name|proto
operator|==
name|UNIPROTO_UNI40N
condition|)
name|c
operator|->
name|msg_setup
operator|.
name|epref
operator|.
name|h
operator|.
name|act
operator|=
name|UNI_IEACT_IGNORE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|IE_ISGOOD
argument_list|(
name|c
operator|->
name|msg_setup
operator|.
name|epref
argument_list|)
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_IE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_destroy_call
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|p
operator|=
name|uni_create_partyx
argument_list|(
name|c
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|cookie
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_NOMEM
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_destroy_call
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_SETUP_request
argument_list|,
name|cookie
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|out
operator|->
name|u
operator|.
name|setup
operator|=
name|c
operator|->
name|msg_setup
expr_stmt|;
name|MK_MSG_ORIG
argument_list|(
name|out
argument_list|,
name|UNI_SETUP
argument_list|,
name|c
operator|->
name|cref
argument_list|,
operator|!
name|c
operator|->
name|mine
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|out
argument_list|,
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|TIMER_START_CALL
argument_list|(
name|c
argument_list|,
name|t303
argument_list|,
name|c
operator|->
name|uni
operator|->
name|timer303
argument_list|)
expr_stmt|;
name|c
operator|->
name|cnt303
operator|=
literal|0
expr_stmt|;
name|set_call_state
argument_list|(
name|c
argument_list|,
name|new_state
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_OK
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * CALL PROCEEDING message  *  * Q.2971:Call-Control-U 6/39 (in U1)  * Q.2971:Call-Control-N 11/39 (in N6)  */
end_comment

begin_function
specifier|static
name|void
name|u1n6_call_proc
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|,
name|enum
name|call_state
name|new_state
parameter_list|)
block|{
name|struct
name|uni_call_proc
modifier|*
name|cp
init|=
operator|&
name|u
operator|->
name|u
operator|.
name|call_proc
decl_stmt|;
name|struct
name|uniapi_proceeding_indication
modifier|*
name|ind
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|api
decl_stmt|;
name|ind
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_proceeding_indication
argument_list|,
name|api
argument_list|)
expr_stmt|;
if|if
condition|(
name|ind
operator|==
name|NULL
condition|)
block|{
name|ignore
label|:
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Analyze message 	 */
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|m
argument_list|,
name|u
argument_list|,
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IE_ISPRESENT
argument_list|(
name|c
operator|->
name|connid
argument_list|)
operator|&&
operator|!
name|IE_ISGOOD
argument_list|(
name|cp
operator|->
name|connid
argument_list|)
condition|)
name|uni_mandate_ie
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_IE_CONNID
argument_list|)
expr_stmt|;
comment|/* 	 * Q.2971: L3MU_01_03 requests us to ignore the message if 	 * the EPREF is missing. 	 */
if|if
condition|(
name|c
operator|->
name|msg_setup
operator|.
name|bearer
operator|.
name|cfg
operator|==
name|UNI_BEARER_MP
operator|&&
name|IE_ISPRESENT
argument_list|(
name|c
operator|->
name|msg_setup
operator|.
name|epref
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|IE_ISPRESENT
argument_list|(
name|cp
operator|->
name|epref
argument_list|)
condition|)
name|uni_mandate_ie
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_IE_EPREF
argument_list|)
expr_stmt|;
if|\
elseif|else
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|cp
operator|->
name|epref
argument_list|)
operator|&&
operator|(
name|cp
operator|->
name|epref
operator|.
name|flag
operator|!=
literal|1
operator|||
name|cp
operator|->
name|epref
operator|.
name|epref
operator|!=
name|c
operator|->
name|msg_setup
operator|.
name|epref
operator|.
name|epref
operator|)
condition|)
block|{
name|IE_SETERROR
argument_list|(
name|cp
operator|->
name|epref
argument_list|)
expr_stmt|;
name|UNI_SAVE_IERR
argument_list|(
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|,
name|UNI_IE_EPREF
argument_list|,
name|cp
operator|->
name|epref
operator|.
name|h
operator|.
name|act
argument_list|,
name|UNI_IERR_BAD
argument_list|)
expr_stmt|;
block|}
block|}
switch|switch
condition|(
name|uni_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
argument_list|)
condition|)
block|{
case|case
name|VFY_CLR
case|:
name|uni_vfy_collect_ies
argument_list|(
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
comment|/* FALLTHRU */
case|case
name|VFY_I
case|:
name|uni_msg_destroy
argument_list|(
name|api
argument_list|)
expr_stmt|;
goto|goto
name|ignore
goto|;
case|case
name|VFY_RAIM
case|:
case|case
name|VFY_RAI
case|:
name|report
label|:
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|c
operator|->
name|cstate
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|api
argument_list|)
expr_stmt|;
goto|goto
name|ignore
goto|;
case|case
name|VFY_RAP
case|:
case|case
name|VFY_RAPU
case|:
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|CALL_ROOT
operator|&&
operator|!
name|IE_ISGOOD
argument_list|(
name|cp
operator|->
name|epref
argument_list|)
condition|)
goto|goto
name|report
goto|;
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|new_state
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* FALLTHRU */
case|case
name|VFY_OK
case|:
break|break;
block|}
name|TIMER_STOP_CALL
argument_list|(
name|c
argument_list|,
name|t303
argument_list|)
expr_stmt|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|cp
operator|->
name|connid
argument_list|)
condition|)
name|c
operator|->
name|connid
operator|=
name|cp
operator|->
name|connid
expr_stmt|;
name|ind
operator|->
name|call_proc
operator|.
name|hdr
operator|=
name|u
operator|->
name|u
operator|.
name|hdr
expr_stmt|;
name|copy_msg_call_proc
argument_list|(
name|cp
argument_list|,
operator|&
name|ind
operator|->
name|call_proc
argument_list|)
expr_stmt|;
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_PROCEEDING_indication
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
name|TIMER_START_CALL
argument_list|(
name|c
argument_list|,
name|t310
argument_list|,
name|c
operator|->
name|uni
operator|->
name|timer310
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
name|set_call_state
argument_list|(
name|c
argument_list|,
name|new_state
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * T303 tick.  *  * Q.2971:Call-Control-U 6/39  * Q.2971:Call-Control-N 11/39  */
end_comment

begin_function
specifier|static
name|void
name|u1n6_t303
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|)
block|{
name|struct
name|uni_all
modifier|*
name|msg
decl_stmt|;
name|struct
name|uniapi_release_confirm
modifier|*
name|conf
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|api
decl_stmt|;
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_TIMEOUT
argument_list|,
literal|1
argument_list|,
literal|"call %u/%s T303 tick %d"
argument_list|,
name|c
operator|->
name|cref
argument_list|,
name|c
operator|->
name|mine
condition|?
literal|"mine"
else|:
literal|"his"
argument_list|,
name|c
operator|->
name|cnt303
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|c
operator|->
name|cnt303
operator|<
name|c
operator|->
name|uni
operator|->
name|init303
condition|)
block|{
if|if
condition|(
operator|(
name|msg
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|!=
name|NULL
condition|)
block|{
name|msg
operator|->
name|u
operator|.
name|setup
operator|=
name|c
operator|->
name|msg_setup
expr_stmt|;
name|MK_MSG_ORIG
argument_list|(
name|msg
argument_list|,
name|UNI_SETUP
argument_list|,
name|c
operator|->
name|cref
argument_list|,
operator|!
name|c
operator|->
name|mine
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|msg
argument_list|,
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
name|TIMER_START_CALL
argument_list|(
name|c
argument_list|,
name|t303
argument_list|,
name|c
operator|->
name|uni
operator|->
name|timer303
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Send indication to API 	 */
if|if
condition|(
operator|(
name|conf
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_release_confirm
argument_list|,
name|api
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|conf
operator|->
name|release
operator|.
name|hdr
operator|.
name|cref
operator|.
name|cref
operator|=
name|c
operator|->
name|cref
expr_stmt|;
name|conf
operator|->
name|release
operator|.
name|hdr
operator|.
name|cref
operator|.
name|flag
operator|=
name|c
operator|->
name|mine
expr_stmt|;
name|conf
operator|->
name|release
operator|.
name|hdr
operator|.
name|act
operator|=
name|UNI_MSGACT_DEFAULT
expr_stmt|;
name|MK_IE_CAUSE
argument_list|(
name|conf
operator|->
name|release
operator|.
name|cause
index|[
literal|0
index|]
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|UNI_CAUSE_NO_RESPONSE
argument_list|)
expr_stmt|;
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_RELEASE_confirm
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * send to party (there may be only one) 	 */
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|CALL_ROOT
operator|&&
operator|!
name|TAILQ_EMPTY
argument_list|(
operator|&
name|c
operator|->
name|parties
argument_list|)
condition|)
block|{
name|uni_enq_party
argument_list|(
name|TAILQ_FIRST
argument_list|(
operator|&
name|c
operator|->
name|parties
argument_list|)
argument_list|,
name|SIGP_RELEASE_confirm
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|uni_destroy_call
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * T310 (Call Proceeding) timer tick.  *  * Q.2971:Call-Control-U 7/39  * Q.2971:Call-Control-N 17/39  */
end_comment

begin_function
specifier|static
name|void
name|u3n9_t310
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|)
block|{
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_TIMEOUT
argument_list|,
literal|1
argument_list|,
literal|"call %u/%s T310 tick"
argument_list|,
name|c
operator|->
name|cref
argument_list|,
name|c
operator|->
name|mine
condition|?
literal|"mine"
else|:
literal|"his"
argument_list|)
expr_stmt|;
name|MK_IE_CAUSE
argument_list|(
name|c
operator|->
name|uni
operator|->
name|cause
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|UNI_CAUSE_NO_RESPONSE
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * T301 (Alerting) timer tick.  *  * Q.2971:Call-Control-U Missing  * Q.2971:Call-Control-N 14/39  */
end_comment

begin_function
specifier|static
name|void
name|u4n7_t301
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|)
block|{
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_TIMEOUT
argument_list|,
literal|1
argument_list|,
literal|"call %u/%s T301 tick"
argument_list|,
name|c
operator|->
name|cref
argument_list|,
name|c
operator|->
name|mine
condition|?
literal|"mine"
else|:
literal|"his"
argument_list|)
expr_stmt|;
name|MK_IE_CAUSE
argument_list|(
name|c
operator|->
name|uni
operator|->
name|cause
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|UNI_CAUSE_NO_RESP_ALERT
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * ALERTING received  *  * Q.2971:Call-Control-U 37/39 (U1)  * Q.2971:Call-Control-U 7/39 (U3)  * Q.2971:Call-Control-N 9/39 (N6)  * Q.2971:Call-Control-N 17/39 (N9)  *  * There are two errors in the user side SDL Annex A:  *  *   - the resetted timers are swapped (T310 and T303)  *  *   - for U1 we should go to C12, not C3 to start T301.  */
end_comment

begin_function
specifier|static
name|void
name|unx_alerting
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|,
name|enum
name|call_state
name|new_state
parameter_list|)
block|{
name|struct
name|uni_alerting
modifier|*
name|al
init|=
operator|&
name|u
operator|->
name|u
operator|.
name|alerting
decl_stmt|;
name|struct
name|uniapi_alerting_indication
modifier|*
name|ind
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|api
decl_stmt|;
name|ind
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_alerting_indication
argument_list|,
name|api
argument_list|)
expr_stmt|;
if|if
condition|(
name|ind
operator|==
name|NULL
condition|)
block|{
name|ignore
label|:
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Analyze message 	 */
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|m
argument_list|,
name|u
argument_list|,
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IE_ISPRESENT
argument_list|(
name|c
operator|->
name|connid
argument_list|)
operator|&&
operator|!
name|IE_ISGOOD
argument_list|(
name|al
operator|->
name|connid
argument_list|)
condition|)
name|uni_mandate_ie
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_IE_CONNID
argument_list|)
expr_stmt|;
comment|/* 	 * Q.2971: L3MU_01_04 requests us to ignore the message if the 	 * EPREF is missing. 	 */
if|if
condition|(
name|c
operator|->
name|msg_setup
operator|.
name|bearer
operator|.
name|cfg
operator|==
name|UNI_BEARER_MP
operator|&&
name|IE_ISPRESENT
argument_list|(
name|c
operator|->
name|msg_setup
operator|.
name|epref
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|IE_ISPRESENT
argument_list|(
name|al
operator|->
name|epref
argument_list|)
condition|)
name|uni_mandate_ie
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_IE_EPREF
argument_list|)
expr_stmt|;
if|\
elseif|else
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|al
operator|->
name|epref
argument_list|)
operator|&&
operator|(
name|al
operator|->
name|epref
operator|.
name|flag
operator|!=
literal|1
operator|||
name|al
operator|->
name|epref
operator|.
name|epref
operator|!=
name|c
operator|->
name|msg_setup
operator|.
name|epref
operator|.
name|epref
operator|)
condition|)
block|{
name|IE_SETERROR
argument_list|(
name|al
operator|->
name|epref
argument_list|)
expr_stmt|;
name|UNI_SAVE_IERR
argument_list|(
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|,
name|UNI_IE_EPREF
argument_list|,
name|al
operator|->
name|epref
operator|.
name|h
operator|.
name|act
argument_list|,
name|UNI_IERR_BAD
argument_list|)
expr_stmt|;
block|}
block|}
switch|switch
condition|(
name|uni_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
argument_list|)
condition|)
block|{
case|case
name|VFY_CLR
case|:
name|uni_vfy_collect_ies
argument_list|(
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
case|case
name|VFY_I
case|:
name|uni_msg_destroy
argument_list|(
name|api
argument_list|)
expr_stmt|;
goto|goto
name|ignore
goto|;
case|case
name|VFY_RAIM
case|:
case|case
name|VFY_RAI
case|:
name|report
label|:
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|c
operator|->
name|cstate
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|api
argument_list|)
expr_stmt|;
goto|goto
name|ignore
goto|;
case|case
name|VFY_RAP
case|:
case|case
name|VFY_RAPU
case|:
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|CALL_ROOT
operator|&&
operator|!
name|IE_ISGOOD
argument_list|(
name|al
operator|->
name|epref
argument_list|)
condition|)
goto|goto
name|report
goto|;
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|c
operator|->
name|cstate
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
case|case
name|VFY_OK
case|:
break|break;
block|}
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U1
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N6
condition|)
name|TIMER_STOP_CALL
argument_list|(
name|c
argument_list|,
name|t303
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U3
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N9
condition|)
name|TIMER_STOP_CALL
argument_list|(
name|c
argument_list|,
name|t310
argument_list|)
expr_stmt|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|al
operator|->
name|connid
argument_list|)
condition|)
name|c
operator|->
name|connid
operator|=
name|al
operator|->
name|connid
expr_stmt|;
name|ind
operator|->
name|alerting
operator|.
name|hdr
operator|=
name|u
operator|->
name|u
operator|.
name|hdr
expr_stmt|;
name|copy_msg_alerting
argument_list|(
name|al
argument_list|,
operator|&
name|ind
operator|->
name|alerting
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|CALL_LEAF
operator|||
name|c
operator|->
name|type
operator|==
name|CALL_ROOT
condition|)
block|{
name|uni_enq_party
argument_list|(
name|TAILQ_FIRST
argument_list|(
operator|&
name|c
operator|->
name|parties
argument_list|)
argument_list|,
name|SIGP_ALERTING
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_ALERTING_indication
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_ALERTING_indication
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
name|TIMER_START_CALL
argument_list|(
name|c
argument_list|,
name|t301
argument_list|,
name|c
operator|->
name|uni
operator|->
name|timer301
argument_list|)
expr_stmt|;
block|}
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|set_call_state
argument_list|(
name|c
argument_list|,
name|new_state
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Proceeding.request from API  *  * Q.2971:Call-Control-U 12/39 (U6)  * Q.2971:Call-Control-N 6/39 (N1)  */
end_comment

begin_function
specifier|static
name|void
name|u6n1_proceeding_request
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|uint32_t
name|cookie
parameter_list|,
name|enum
name|call_state
name|new_state
parameter_list|)
block|{
name|struct
name|uni_all
modifier|*
name|msg
decl_stmt|;
name|struct
name|uniapi_proceeding_request
modifier|*
name|arg
init|=
name|uni_msg_rptr
argument_list|(
name|m
argument_list|,
expr|struct
name|uniapi_proceeding_request
operator|*
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|msg
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|==
name|NULL
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_NOMEM
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|arg
operator|->
name|call_proc
operator|.
name|connid
argument_list|)
condition|)
name|c
operator|->
name|connid
operator|=
name|arg
operator|->
name|call_proc
operator|.
name|connid
expr_stmt|;
name|msg
operator|->
name|u
operator|.
name|call_proc
operator|=
name|arg
operator|->
name|call_proc
expr_stmt|;
name|MK_MSG_ORIG
argument_list|(
name|msg
argument_list|,
name|UNI_CALL_PROC
argument_list|,
name|c
operator|->
name|cref
argument_list|,
operator|!
name|c
operator|->
name|mine
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|msg
argument_list|,
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|set_call_state
argument_list|(
name|c
argument_list|,
name|new_state
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_OK
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Alerting.request from API  *  * Q.2971:Call-Control-U 13/39 (U6)  * Q.2971:Call-Control-U 17/39 (U9)  * Q.2971:Call-Control-N 38/39 (N1)  * Q.2971:Call-Control-N 7/39  (N3)  */
end_comment

begin_function
specifier|static
name|void
name|unx_alerting_request
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|uint32_t
name|cookie
parameter_list|,
name|enum
name|call_state
name|new_state
parameter_list|)
block|{
name|struct
name|uni_all
modifier|*
name|msg
decl_stmt|;
name|struct
name|uniapi_alerting_request
modifier|*
name|arg
init|=
name|uni_msg_rptr
argument_list|(
name|m
argument_list|,
expr|struct
name|uniapi_alerting_request
operator|*
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|msg
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|==
name|NULL
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_NOMEM
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|CALL_ROOT
operator|||
name|c
operator|->
name|type
operator|==
name|CALL_LEAF
condition|)
block|{
name|uni_enq_party
argument_list|(
name|TAILQ_FIRST
argument_list|(
operator|&
name|c
operator|->
name|parties
argument_list|)
argument_list|,
name|SIGP_ALERTING_request
argument_list|,
name|cookie
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * It's not really clear, what happens, if we send another 	 * connid in CALL_PROC and ALERTING 	 */
if|if
condition|(
operator|!
name|IE_ISGOOD
argument_list|(
name|c
operator|->
name|connid
argument_list|)
operator|&&
name|IE_ISGOOD
argument_list|(
name|arg
operator|->
name|alerting
operator|.
name|connid
argument_list|)
condition|)
name|c
operator|->
name|connid
operator|=
name|arg
operator|->
name|alerting
operator|.
name|connid
expr_stmt|;
name|msg
operator|->
name|u
operator|.
name|alerting
operator|=
name|arg
operator|->
name|alerting
expr_stmt|;
name|MK_MSG_ORIG
argument_list|(
name|msg
argument_list|,
name|UNI_ALERTING
argument_list|,
name|c
operator|->
name|cref
argument_list|,
operator|!
name|c
operator|->
name|mine
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|msg
argument_list|,
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|set_call_state
argument_list|(
name|c
argument_list|,
name|new_state
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_OK
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Setup.response from API  *  * Q.2971:Call-Control-U 13/39	(U6)  * Q.2971:Call-Control-U 14/39	(U7)  * Q.2971:Call-Control-U 17/39	(U9)  * Q.2971:Call-Control-N 39/39  (N1)  * Q.2971:Call-Control-N 7/39   (N3)  * Q.2971:Call-Control-N 8/39   (N4)  */
end_comment

begin_function
specifier|static
name|void
name|unx_setup_response
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|uint32_t
name|cookie
parameter_list|,
name|enum
name|call_state
name|new_state
parameter_list|)
block|{
name|struct
name|uni_all
modifier|*
name|msg
decl_stmt|;
name|struct
name|uniapi_setup_response
modifier|*
name|arg
init|=
name|uni_msg_rptr
argument_list|(
name|m
argument_list|,
expr|struct
name|uniapi_setup_response
operator|*
argument_list|)
decl_stmt|;
name|struct
name|party
modifier|*
name|p
decl_stmt|;
if|if
condition|(
operator|(
name|msg
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|==
name|NULL
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_NOMEM
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|IE_ISGOOD
argument_list|(
name|c
operator|->
name|connid
argument_list|)
operator|&&
name|IE_ISGOOD
argument_list|(
name|arg
operator|->
name|connect
operator|.
name|connid
argument_list|)
condition|)
name|c
operator|->
name|connid
operator|=
name|arg
operator|->
name|connect
operator|.
name|connid
expr_stmt|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|arg
operator|->
name|connect
operator|.
name|epref
argument_list|)
condition|)
block|{
name|p
operator|=
name|uni_find_partyx
argument_list|(
name|c
argument_list|,
name|arg
operator|->
name|connect
operator|.
name|epref
operator|.
name|epref
argument_list|,
operator|!
name|arg
operator|->
name|connect
operator|.
name|epref
operator|.
name|flag
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_PARTY
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* we need to remember that we have sent the CONNECT from this 		 * party because the CONNECT ACK must move only this party 		 * into P7 */
name|p
operator|->
name|flags
operator||=
name|PARTY_CONNECT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|CALL_LEAF
condition|)
block|{
comment|/* XXX don't mandate if only one party */
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_PARTY
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* inform the parties on the network side */
if|if
condition|(
name|c
operator|->
name|uni
operator|->
name|proto
operator|==
name|UNIPROTO_UNI40N
operator|&&
name|c
operator|->
name|type
operator|==
name|CALL_LEAF
condition|)
name|TAILQ_FOREACH
argument_list|(
argument|p
argument_list|,
argument|&c->parties
argument_list|,
argument|link
argument_list|)
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_SETUP_response
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|->
name|u
operator|.
name|connect
operator|=
name|arg
operator|->
name|connect
expr_stmt|;
name|MK_MSG_ORIG
argument_list|(
name|msg
argument_list|,
name|UNI_CONNECT
argument_list|,
name|c
operator|->
name|cref
argument_list|,
operator|!
name|c
operator|->
name|mine
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|msg
argument_list|,
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|uni
operator|->
name|proto
operator|==
name|UNIPROTO_UNI40U
condition|)
name|TIMER_START_CALL
argument_list|(
name|c
argument_list|,
name|t313
argument_list|,
name|c
operator|->
name|uni
operator|->
name|timer313
argument_list|)
expr_stmt|;
name|set_call_state
argument_list|(
name|c
argument_list|,
name|new_state
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_OK
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Setup_complete.request  *  * Q.2971:Call-Control-N 15/39 (N8)  */
end_comment

begin_function
specifier|static
name|void
name|n8_setup_compl_request
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|uint32_t
name|cookie
parameter_list|,
name|enum
name|call_state
name|new_state
parameter_list|)
block|{
name|struct
name|uni_all
modifier|*
name|msg
decl_stmt|;
name|struct
name|uniapi_setup_complete_request
modifier|*
name|arg
init|=
name|uni_msg_rptr
argument_list|(
name|m
argument_list|,
expr|struct
name|uniapi_setup_complete_request
operator|*
argument_list|)
decl_stmt|;
name|struct
name|party
modifier|*
name|p
decl_stmt|;
if|if
condition|(
operator|(
name|msg
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|==
name|NULL
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_NOMEM
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* inform the parties on the network side */
if|if
condition|(
name|c
operator|->
name|uni
operator|->
name|proto
operator|==
name|UNIPROTO_UNI40N
operator|&&
operator|(
name|c
operator|->
name|type
operator|==
name|CALL_LEAF
operator|||
name|c
operator|->
name|type
operator|==
name|CALL_ROOT
operator|)
condition|)
block|{
name|TAILQ_FOREACH
argument_list|(
argument|p
argument_list|,
argument|&c->parties
argument_list|,
argument|link
argument_list|)
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_SETUP_COMPL_request
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|msg
operator|->
name|u
operator|.
name|connect_ack
operator|=
name|arg
operator|->
name|connect_ack
expr_stmt|;
name|MK_MSG_ORIG
argument_list|(
name|msg
argument_list|,
name|UNI_CONNECT_ACK
argument_list|,
name|c
operator|->
name|cref
argument_list|,
operator|!
name|c
operator|->
name|mine
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|msg
argument_list|,
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|set_call_state
argument_list|(
name|c
argument_list|,
name|new_state
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_OK
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * CONNECT message  *  * Q.2971:Call-Control-U 7-8/39  (U3)  * Q.2971:Call-Control-U 11/39   (U4)  * Q.2971:Call-Control-U 37/39   (U1)  * Q.2971:Call-Control-N 9-10/39 (N6)  * Q.2971:Call-Control-N 14/39   (N7)  * Q.2971:Call-Control-N 17/39   (N9)  */
end_comment

begin_function
specifier|static
name|void
name|unx_connect
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|,
name|enum
name|call_state
name|new_state
parameter_list|)
block|{
name|struct
name|uni_connect
modifier|*
name|co
init|=
operator|&
name|u
operator|->
name|u
operator|.
name|connect
decl_stmt|;
name|struct
name|uniapi_setup_confirm
modifier|*
name|conf
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|api
decl_stmt|;
name|struct
name|uni_all
modifier|*
name|ack
decl_stmt|;
name|struct
name|party
modifier|*
name|p
decl_stmt|;
name|conf
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_setup_confirm
argument_list|,
name|api
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|==
name|NULL
condition|)
block|{
name|ignore
label|:
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|ack
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|==
name|NULL
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|api
argument_list|)
expr_stmt|;
goto|goto
name|ignore
goto|;
block|}
comment|/* 	 * Analyze message 	 */
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|m
argument_list|,
name|u
argument_list|,
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IE_ISPRESENT
argument_list|(
name|c
operator|->
name|connid
argument_list|)
operator|&&
operator|!
name|IE_ISGOOD
argument_list|(
name|co
operator|->
name|connid
argument_list|)
condition|)
name|uni_mandate_ie
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_IE_CONNID
argument_list|)
expr_stmt|;
comment|/* 	 * Q.2971: L3MU_01_05 requires the epref to be present. 	 */
name|p
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|msg_setup
operator|.
name|bearer
operator|.
name|cfg
operator|==
name|UNI_BEARER_MP
condition|)
block|{
if|if
condition|(
name|IE_ISPRESENT
argument_list|(
name|c
operator|->
name|msg_setup
operator|.
name|epref
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|IE_ISPRESENT
argument_list|(
name|co
operator|->
name|epref
argument_list|)
condition|)
name|uni_mandate_ie
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_IE_EPREF
argument_list|)
expr_stmt|;
block|\
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|co
operator|->
name|epref
argument_list|)
operator|&&
name|co
operator|->
name|epref
operator|.
name|flag
operator|!=
literal|1
condition|)
block|{
name|IE_SETERROR
argument_list|(
name|co
operator|->
name|epref
argument_list|)
expr_stmt|;
name|UNI_SAVE_IERR
argument_list|(
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|,
name|UNI_IE_EPREF
argument_list|,
name|co
operator|->
name|epref
operator|.
name|h
operator|.
name|act
argument_list|,
name|UNI_IERR_BAD
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|co
operator|->
name|epref
argument_list|)
condition|)
block|{
name|p
operator|=
name|uni_find_party
argument_list|(
name|c
argument_list|,
operator|&
name|co
operator|->
name|epref
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|respond_drop_party_ack
argument_list|(
name|c
argument_list|,
operator|&
name|co
operator|->
name|epref
argument_list|,
name|UNI_CAUSE_ENDP_INV
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|api
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|ack
argument_list|)
expr_stmt|;
goto|goto
name|ignore
goto|;
block|}
block|}
block|}
switch|switch
condition|(
name|uni_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
argument_list|)
condition|)
block|{
case|case
name|VFY_CLR
case|:
name|uni_vfy_collect_ies
argument_list|(
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
comment|/* FALLTHRU */
case|case
name|VFY_I
case|:
name|uni_msg_destroy
argument_list|(
name|api
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|ack
argument_list|)
expr_stmt|;
goto|goto
name|ignore
goto|;
case|case
name|VFY_RAIM
case|:
case|case
name|VFY_RAI
case|:
name|report
label|:
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|c
operator|->
name|cstate
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|api
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|ack
argument_list|)
expr_stmt|;
goto|goto
name|ignore
goto|;
case|case
name|VFY_RAP
case|:
case|case
name|VFY_RAPU
case|:
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|CALL_ROOT
operator|&&
operator|!
name|IE_ISGOOD
argument_list|(
name|co
operator|->
name|epref
argument_list|)
condition|)
goto|goto
name|report
goto|;
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|new_state
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* FALLTHRU */
case|case
name|VFY_OK
case|:
break|break;
block|}
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|co
operator|->
name|connid
argument_list|)
condition|)
name|c
operator|->
name|connid
operator|=
name|co
operator|->
name|connid
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U1
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N6
condition|)
name|TIMER_STOP_CALL
argument_list|(
name|c
argument_list|,
name|t303
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U3
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N9
condition|)
name|TIMER_STOP_CALL
argument_list|(
name|c
argument_list|,
name|t310
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U4
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N7
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|CALL_P2P
condition|)
name|TIMER_STOP_CALL
argument_list|(
name|c
argument_list|,
name|t301
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * This is sent to the party only on the user side and only 	 * to the one party in the epref (L3MU_05_03). 	 */
if|if
condition|(
name|c
operator|->
name|uni
operator|->
name|proto
operator|==
name|UNIPROTO_UNI40U
operator|&&
operator|(
name|c
operator|->
name|type
operator|==
name|CALL_LEAF
operator|||
name|c
operator|->
name|type
operator|==
name|CALL_ROOT
operator|)
condition|)
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_CONNECT
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|conf
operator|->
name|connect
operator|.
name|hdr
operator|=
name|u
operator|->
name|u
operator|.
name|hdr
expr_stmt|;
name|copy_msg_connect
argument_list|(
name|co
argument_list|,
operator|&
name|conf
operator|->
name|connect
argument_list|)
expr_stmt|;
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_SETUP_confirm
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|uni
operator|->
name|proto
operator|==
name|UNIPROTO_UNI40U
condition|)
block|{
comment|/* this is left to the application on the network side */
name|MK_MSG_ORIG
argument_list|(
name|ack
argument_list|,
name|UNI_CONNECT_ACK
argument_list|,
name|c
operator|->
name|cref
argument_list|,
operator|!
name|c
operator|->
name|mine
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|ack
argument_list|,
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|ack
argument_list|)
expr_stmt|;
block|}
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|set_call_state
argument_list|(
name|c
argument_list|,
name|new_state
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * T313 (Connect) timer tick.  *  * Q.2971:Call-Control-U 15/39  */
end_comment

begin_function
specifier|static
name|void
name|u8_t313
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|)
block|{
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_TIMEOUT
argument_list|,
literal|1
argument_list|,
literal|"call %u/%s T313 tick"
argument_list|,
name|c
operator|->
name|cref
argument_list|,
name|c
operator|->
name|mine
condition|?
literal|"mine"
else|:
literal|"his"
argument_list|)
expr_stmt|;
name|MK_IE_CAUSE
argument_list|(
name|c
operator|->
name|uni
operator|->
name|cause
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|UNI_CAUSE_RECOVER
argument_list|)
expr_stmt|;
name|ADD_CAUSE_TIMER
argument_list|(
name|c
operator|->
name|uni
operator|->
name|cause
argument_list|,
literal|"313"
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * CONNECT ACKNOWLEDGE message in U8  *  * Q.2971:Call-Control-U 15-16/39  */
end_comment

begin_function
specifier|static
name|void
name|u8_connect_ack
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|,
name|enum
name|call_state
name|new_state
parameter_list|)
block|{
name|struct
name|uniapi_setup_complete_indication
modifier|*
name|ind
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|api
decl_stmt|;
name|ind
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_setup_complete_indication
argument_list|,
name|api
argument_list|)
expr_stmt|;
if|if
condition|(
name|ind
operator|==
name|NULL
condition|)
block|{
name|ignore
label|:
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Analyze message 	 */
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|m
argument_list|,
name|u
argument_list|,
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|uni_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
argument_list|)
condition|)
block|{
case|case
name|VFY_CLR
case|:
name|uni_vfy_collect_ies
argument_list|(
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
comment|/* FALLTHRU */
case|case
name|VFY_I
case|:
name|uni_msg_destroy
argument_list|(
name|api
argument_list|)
expr_stmt|;
goto|goto
name|ignore
goto|;
case|case
name|VFY_RAIM
case|:
case|case
name|VFY_RAI
case|:
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|c
operator|->
name|cstate
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|api
argument_list|)
expr_stmt|;
goto|goto
name|ignore
goto|;
case|case
name|VFY_RAP
case|:
case|case
name|VFY_RAPU
case|:
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|new_state
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* FALLTHRU */
case|case
name|VFY_OK
case|:
break|break;
block|}
name|TIMER_STOP_CALL
argument_list|(
name|c
argument_list|,
name|t313
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|CALL_LEAF
condition|)
block|{
name|struct
name|party
modifier|*
name|p
decl_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|p
argument_list|,
argument|&c->parties
argument_list|,
argument|link
argument_list|)
block|{
if|if
condition|(
name|p
operator|->
name|flags
operator|&
name|PARTY_CONNECT
condition|)
block|{
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_CONNECT_ACK
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
name|ind
operator|->
name|connect_ack
operator|.
name|hdr
operator|=
name|u
operator|->
name|u
operator|.
name|hdr
expr_stmt|;
name|copy_msg_connect_ack
argument_list|(
operator|&
name|u
operator|->
name|u
operator|.
name|connect_ack
argument_list|,
operator|&
name|ind
operator|->
name|connect_ack
argument_list|)
expr_stmt|;
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_SETUP_COMPLETE_indication
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|set_call_state
argument_list|(
name|c
argument_list|,
name|new_state
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * CONNECT ACKNOWLEDGE message in N10  *  * Q.2971:Call-Control-N 18/39  */
end_comment

begin_function
specifier|static
name|void
name|n10_connect_ack
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
block|{
comment|/* 	 * Analyze message 	 */
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|m
argument_list|,
name|u
argument_list|,
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|uni_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
argument_list|)
condition|)
block|{
case|case
name|VFY_CLR
case|:
name|uni_vfy_collect_ies
argument_list|(
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
comment|/* FALLTHRU */
case|case
name|VFY_I
case|:
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
return|return;
case|case
name|VFY_RAIM
case|:
case|case
name|VFY_RAI
case|:
case|case
name|VFY_RAP
case|:
case|case
name|VFY_RAPU
case|:
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|c
operator|->
name|cstate
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* FALLTHRU */
case|case
name|VFY_OK
case|:
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_comment
comment|/*  * Release.response in U6 or U12.  *  * Q.2971:Call-Control-U 12/39 (U6)  * Q.2971:Call-Control-U 30/39 (U12)  * Q.2971:Call-Control-N 6/39  (N1)  * Q.2971:Call-Control-N 29/39 (N11)  */
end_comment

begin_function
specifier|static
name|void
name|unx_release_response
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|uint32_t
name|cookie
parameter_list|)
block|{
name|struct
name|party
modifier|*
name|p
decl_stmt|;
name|struct
name|uni_all
modifier|*
name|msg
decl_stmt|;
name|struct
name|uniapi_release_response
modifier|*
name|arg
init|=
name|uni_msg_rptr
argument_list|(
name|m
argument_list|,
expr|struct
name|uniapi_release_response
operator|*
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|msg
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|==
name|NULL
condition|)
block|{
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_NOMEM
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U6
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N1
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|CALL_ROOT
operator|||
name|c
operator|->
name|type
operator|==
name|CALL_LEAF
condition|)
block|{
name|TAILQ_FOREACH
argument_list|(
argument|p
argument_list|,
argument|&c->parties
argument_list|,
argument|link
argument_list|)
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_RELEASE_response
argument_list|,
name|cookie
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
name|msg
operator|->
name|u
operator|.
name|release_compl
operator|=
name|arg
operator|->
name|release_compl
expr_stmt|;
name|MK_MSG_ORIG
argument_list|(
name|msg
argument_list|,
name|UNI_RELEASE_COMPL
argument_list|,
name|c
operator|->
name|cref
argument_list|,
operator|!
name|c
operator|->
name|mine
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|msg
argument_list|,
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_OK
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_destroy_call
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Got a RELEASE COMPLETE in any state expect U0  *  * Q.2971:Call-Control-U 25/39  * Q.2971:Call-Control-N 26/39  *  * This is also called from the restart processes.  */
end_comment

begin_function
name|void
name|uni_release_compl
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
block|{
name|struct
name|uni_msg
modifier|*
name|api
decl_stmt|;
name|struct
name|uniapi_release_confirm
modifier|*
name|conf
decl_stmt|;
name|struct
name|party
modifier|*
name|p
decl_stmt|;
name|u_int
name|i
decl_stmt|,
name|j
decl_stmt|;
if|if
condition|(
operator|(
name|conf
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_release_confirm
argument_list|,
name|api
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
name|reset_all_timers
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|CALL_ROOT
operator|||
name|c
operator|->
name|type
operator|==
name|CALL_LEAF
condition|)
block|{
name|TAILQ_FOREACH
argument_list|(
argument|p
argument_list|,
argument|&c->parties
argument_list|,
argument|link
argument_list|)
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_RELEASE_COMPL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* YYY optional call reoffering 10.3.3/10.3.4 */
block|}
name|conf
operator|->
name|release
operator|.
name|hdr
operator|=
name|u
operator|->
name|u
operator|.
name|hdr
expr_stmt|;
for|for
control|(
name|i
operator|=
name|j
operator|=
literal|0
init|;
name|i
operator|<
literal|2
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|release_compl
operator|.
name|cause
index|[
name|i
index|]
argument_list|)
condition|)
name|conf
operator|->
name|release
operator|.
name|cause
index|[
name|j
operator|++
index|]
operator|=
name|u
operator|->
name|u
operator|.
name|release_compl
operator|.
name|cause
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
name|j
operator|=
literal|0
init|;
name|i
operator|<
name|UNI_NUM_IE_GIT
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|release_compl
operator|.
name|git
index|[
name|i
index|]
argument_list|)
condition|)
name|conf
operator|->
name|release
operator|.
name|git
index|[
name|j
operator|++
index|]
operator|=
name|u
operator|->
name|u
operator|.
name|release_compl
operator|.
name|git
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|release_compl
operator|.
name|uu
argument_list|)
condition|)
name|conf
operator|->
name|release
operator|.
name|uu
operator|=
name|u
operator|->
name|u
operator|.
name|release_compl
operator|.
name|uu
expr_stmt|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|release_compl
operator|.
name|crankback
argument_list|)
condition|)
name|conf
operator|->
name|release
operator|.
name|crankback
operator|=
name|u
operator|->
name|u
operator|.
name|release_compl
operator|.
name|crankback
expr_stmt|;
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_RELEASE_confirm
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
name|uni_destroy_call
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|unx_release_compl
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
block|{
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|m
argument_list|,
name|u
argument_list|,
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|uni_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
argument_list|)
expr_stmt|;
comment|/* no point :-) */
name|uni_release_compl
argument_list|(
name|c
argument_list|,
name|u
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Got a RELEASE COMPLETE in any state expect U0 and U11  *  * Q.2971:Call-Control-U 25/39  * Q.2971:Call-Control-N 26/39  */
end_comment

begin_function
specifier|static
name|void
name|unx_release
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|,
name|enum
name|call_state
name|new_state
parameter_list|)
block|{
name|struct
name|uniapi_release_indication
modifier|*
name|ind
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|api
decl_stmt|;
if|if
condition|(
operator|(
name|ind
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_release_indication
argument_list|,
name|api
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
return|return;
block|}
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|m
argument_list|,
name|u
argument_list|,
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|uni_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
argument_list|)
expr_stmt|;
comment|/* no point :-) */
name|reset_all_timers
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|CALL_ROOT
operator|||
name|c
operator|->
name|type
operator|==
name|CALL_LEAF
condition|)
block|{
name|struct
name|party
modifier|*
name|p
decl_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|p
argument_list|,
argument|&c->parties
argument_list|,
argument|link
argument_list|)
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_RELEASE
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* YYY optional call reoffering 10.3.3/10.3.4 */
block|}
if|if
condition|(
name|c
operator|->
name|cstate
operator|!=
name|new_state
condition|)
block|{
comment|/* 		 * According to Q.2971 we should send a 2nd 		 * Release.indication. 		 * According to Q.2931 the recipte of a RELEASE in U12/N11 		 * is illegal. 		 * According to us make it legal, but don't send a 2nd 		 * indication. 		 */
name|ind
operator|->
name|release
operator|.
name|hdr
operator|=
name|u
operator|->
name|u
operator|.
name|hdr
expr_stmt|;
name|copy_msg_release
argument_list|(
operator|&
name|u
operator|->
name|u
operator|.
name|release
argument_list|,
operator|&
name|ind
operator|->
name|release
argument_list|)
expr_stmt|;
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_RELEASE_indication
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
block|}
else|else
name|uni_msg_destroy
argument_list|(
name|api
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
name|set_call_state
argument_list|(
name|c
argument_list|,
name|new_state
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Got RELEASE in U11 or N12  *  * Q.2971:Call-Control-U 28/39  * Q.2971:Call-Control-N 30/39  */
end_comment

begin_function
specifier|static
name|void
name|u11n12_release
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
block|{
name|struct
name|uniapi_release_confirm
modifier|*
name|conf
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|api
decl_stmt|;
if|if
condition|(
operator|(
name|conf
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_release_confirm
argument_list|,
name|api
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
return|return;
block|}
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|m
argument_list|,
name|u
argument_list|,
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|uni_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
argument_list|)
expr_stmt|;
comment|/* no point :-) */
name|TIMER_STOP_CALL
argument_list|(
name|c
argument_list|,
name|t308
argument_list|)
expr_stmt|;
name|conf
operator|->
name|release
operator|.
name|hdr
operator|=
name|u
operator|->
name|u
operator|.
name|hdr
expr_stmt|;
name|copy_msg_release
argument_list|(
operator|&
name|u
operator|->
name|u
operator|.
name|release
argument_list|,
operator|&
name|conf
operator|->
name|release
argument_list|)
expr_stmt|;
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_RELEASE_confirm
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
name|uni_destroy_call
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * NOTIFY message  *  * Q.2971:Call-Control-U 18/39  * Q.2971:Call-Control-N 19/39  */
end_comment

begin_function
specifier|static
name|void
name|unx_notify
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
block|{
name|struct
name|uniapi_notify_indication
modifier|*
name|ind
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|api
decl_stmt|;
name|struct
name|party
modifier|*
name|p
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|(
name|ind
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_notify_indication
argument_list|,
name|api
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|ignore
label|:
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Analyze message 	 */
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|m
argument_list|,
name|u
argument_list|,
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
name|MANDATE_IE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|notify
operator|.
name|notify
argument_list|,
name|UNI_IE_NOTIFY
argument_list|)
expr_stmt|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|notify
operator|.
name|epref
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|p
operator|=
name|uni_find_party
argument_list|(
name|c
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|notify
operator|.
name|epref
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|respond_drop_party_ack
argument_list|(
name|c
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|notify
operator|.
name|epref
argument_list|,
name|UNI_CAUSE_ENDP_INV
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|api
argument_list|)
expr_stmt|;
goto|goto
name|ignore
goto|;
block|}
block|}
switch|switch
condition|(
name|uni_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
argument_list|)
condition|)
block|{
case|case
name|VFY_CLR
case|:
name|uni_msg_destroy
argument_list|(
name|api
argument_list|)
expr_stmt|;
name|uni_vfy_collect_ies
argument_list|(
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
goto|goto
name|ignore
goto|;
case|case
name|VFY_RAIM
case|:
case|case
name|VFY_RAI
case|:
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|c
operator|->
name|cstate
argument_list|)
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|notify
operator|.
name|epref
argument_list|,
name|p
condition|?
name|p
operator|->
name|state
else|:
literal|0
argument_list|)
expr_stmt|;
comment|/* FALLTHRU */
case|case
name|VFY_I
case|:
name|uni_msg_destroy
argument_list|(
name|api
argument_list|)
expr_stmt|;
goto|goto
name|ignore
goto|;
case|case
name|VFY_RAP
case|:
case|case
name|VFY_RAPU
case|:
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|c
operator|->
name|cstate
argument_list|)
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|notify
operator|.
name|epref
argument_list|,
name|p
condition|?
name|p
operator|->
name|state
else|:
literal|0
argument_list|)
expr_stmt|;
case|case
name|VFY_OK
case|:
comment|/* FALLTHRU */
break|break;
block|}
name|ind
operator|->
name|notify
operator|.
name|hdr
operator|=
name|u
operator|->
name|u
operator|.
name|hdr
expr_stmt|;
name|copy_msg_notify
argument_list|(
operator|&
name|u
operator|->
name|u
operator|.
name|notify
argument_list|,
operator|&
name|ind
operator|->
name|notify
argument_list|)
expr_stmt|;
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_NOTIFY_indication
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Notify.request from user  *  * Q.2971:Call-Control-U 18/39  * Q.2971:Call-Control-N 19/39  */
end_comment

begin_function
specifier|static
name|void
name|unx_notify_request
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|uint32_t
name|cookie
parameter_list|)
block|{
name|struct
name|uni_all
modifier|*
name|msg
decl_stmt|;
name|struct
name|uniapi_notify_request
modifier|*
name|arg
init|=
name|uni_msg_rptr
argument_list|(
name|m
argument_list|,
expr|struct
name|uniapi_notify_request
operator|*
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|msg
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|==
name|NULL
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_NOMEM
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
return|return;
block|}
name|msg
operator|->
name|u
operator|.
name|notify
operator|=
name|arg
operator|->
name|notify
expr_stmt|;
name|MK_MSG_ORIG
argument_list|(
name|msg
argument_list|,
name|UNI_NOTIFY
argument_list|,
name|c
operator|->
name|cref
argument_list|,
operator|!
name|c
operator|->
name|mine
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|msg
argument_list|,
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_OK
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************/
end_comment

begin_comment
comment|/*  * Release.request from API in any state except U11, U12, N11, N12  *  * Q.2971:Call-Control-U 27/39  * Q.2971:Call-Control-N 28/39  */
end_comment

begin_function
specifier|static
name|void
name|unx_release_request
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|uint32_t
name|cookie
parameter_list|,
name|enum
name|call_state
name|new_state
parameter_list|)
block|{
name|struct
name|uni_all
modifier|*
name|msg
decl_stmt|;
name|struct
name|uniapi_release_request
modifier|*
name|arg
init|=
name|uni_msg_rptr
argument_list|(
name|m
argument_list|,
expr|struct
name|uniapi_release_request
operator|*
argument_list|)
decl_stmt|;
name|struct
name|party
modifier|*
name|p
decl_stmt|;
if|if
condition|(
operator|(
name|msg
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|==
name|NULL
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_NOMEM
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
return|return;
block|}
name|reset_all_timers
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|CALL_LEAF
operator|||
name|c
operator|->
name|type
operator|==
name|CALL_ROOT
condition|)
block|{
name|TAILQ_FOREACH
argument_list|(
argument|p
argument_list|,
argument|&c->parties
argument_list|,
argument|link
argument_list|)
block|{
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_RELEASE_request
argument_list|,
name|cookie
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
name|c
operator|->
name|msg_release
operator|=
name|arg
operator|->
name|release
expr_stmt|;
if|if
condition|(
operator|!
name|IE_ISPRESENT
argument_list|(
name|c
operator|->
name|msg_release
operator|.
name|cause
index|[
literal|0
index|]
argument_list|)
operator|&&
operator|!
name|IE_ISPRESENT
argument_list|(
name|c
operator|->
name|msg_release
operator|.
name|cause
index|[
literal|1
index|]
argument_list|)
condition|)
name|MK_IE_CAUSE
argument_list|(
name|c
operator|->
name|msg_release
operator|.
name|cause
index|[
literal|0
index|]
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|UNI_CAUSE_UNSPEC
argument_list|)
expr_stmt|;
name|msg
operator|->
name|u
operator|.
name|release
operator|=
name|c
operator|->
name|msg_release
expr_stmt|;
name|MK_MSG_ORIG
argument_list|(
name|msg
argument_list|,
name|UNI_RELEASE
argument_list|,
name|c
operator|->
name|cref
argument_list|,
operator|!
name|c
operator|->
name|mine
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|msg
argument_list|,
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|TIMER_START_CALL
argument_list|(
name|c
argument_list|,
name|t308
argument_list|,
name|c
operator|->
name|uni
operator|->
name|timer308
argument_list|)
expr_stmt|;
name|c
operator|->
name|cnt308
operator|=
literal|0
expr_stmt|;
name|set_call_state
argument_list|(
name|c
argument_list|,
name|new_state
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_OK
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Message with unknown EPREF - send a drop party according to 9.5.3.2.3a)  */
end_comment

begin_function
specifier|static
name|void
name|respond_drop_party_ack
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_ie_epref
modifier|*
name|epref
parameter_list|,
name|u_int
name|cause
parameter_list|)
block|{
name|struct
name|uni_all
modifier|*
name|msg
decl_stmt|;
if|if
condition|(
operator|(
name|msg
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|==
name|NULL
condition|)
return|return;
name|MK_MSG_ORIG
argument_list|(
name|msg
argument_list|,
name|UNI_DROP_PARTY_ACK
argument_list|,
name|c
operator|->
name|cref
argument_list|,
operator|!
name|c
operator|->
name|mine
argument_list|)
expr_stmt|;
name|MK_IE_EPREF
argument_list|(
name|msg
operator|->
name|u
operator|.
name|drop_party_ack
operator|.
name|epref
argument_list|,
name|epref
operator|->
name|epref
argument_list|,
operator|!
name|epref
operator|->
name|flag
argument_list|)
expr_stmt|;
name|MK_IE_CAUSE
argument_list|(
name|msg
operator|->
name|u
operator|.
name|drop_party_ack
operator|.
name|cause
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|cause
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|msg
argument_list|,
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * T308 (RELEASE) timer  *  * Q.2971:Call-Control-U 28/39  * Q.2971:Call-Control-N 30/39  */
end_comment

begin_function
specifier|static
name|void
name|u11n12_t308
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|)
block|{
name|struct
name|uni_all
modifier|*
name|msg
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|api
decl_stmt|;
name|struct
name|uniapi_release_confirm
modifier|*
name|conf
decl_stmt|;
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_TIMEOUT
argument_list|,
literal|1
argument_list|,
literal|"call %u/%s T308 tick %d"
argument_list|,
name|c
operator|->
name|cref
argument_list|,
name|c
operator|->
name|mine
condition|?
literal|"mine"
else|:
literal|"his"
argument_list|,
name|c
operator|->
name|cnt308
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|c
operator|->
name|cnt308
operator|<
name|c
operator|->
name|uni
operator|->
name|init308
condition|)
block|{
if|if
condition|(
operator|(
name|msg
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|!=
name|NULL
condition|)
block|{
name|msg
operator|->
name|u
operator|.
name|release
operator|=
name|c
operator|->
name|msg_release
expr_stmt|;
name|MK_MSG_ORIG
argument_list|(
name|msg
argument_list|,
name|UNI_RELEASE
argument_list|,
name|c
operator|->
name|cref
argument_list|,
operator|!
name|c
operator|->
name|mine
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IE_ISPRESENT
argument_list|(
name|msg
operator|->
name|u
operator|.
name|release
operator|.
name|cause
index|[
literal|1
index|]
argument_list|)
condition|)
block|{
name|MK_IE_CAUSE
argument_list|(
name|msg
operator|->
name|u
operator|.
name|release
operator|.
name|cause
index|[
literal|1
index|]
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|UNI_CAUSE_RECOVER
argument_list|)
expr_stmt|;
name|ADD_CAUSE_TIMER
argument_list|(
name|msg
operator|->
name|u
operator|.
name|release
operator|.
name|cause
index|[
literal|1
index|]
argument_list|,
literal|"308"
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|msg
argument_list|,
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
name|TIMER_START_CALL
argument_list|(
name|c
argument_list|,
name|t308
argument_list|,
name|c
operator|->
name|uni
operator|->
name|timer308
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Send indication to API 	 */
if|if
condition|(
operator|(
name|conf
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_release_confirm
argument_list|,
name|api
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|conf
operator|->
name|release
operator|.
name|hdr
operator|.
name|cref
operator|.
name|cref
operator|=
name|c
operator|->
name|cref
expr_stmt|;
name|conf
operator|->
name|release
operator|.
name|hdr
operator|.
name|cref
operator|.
name|flag
operator|=
name|c
operator|->
name|mine
expr_stmt|;
name|conf
operator|->
name|release
operator|.
name|hdr
operator|.
name|act
operator|=
name|UNI_MSGACT_DEFAULT
expr_stmt|;
name|MK_IE_CAUSE
argument_list|(
name|conf
operator|->
name|release
operator|.
name|cause
index|[
literal|0
index|]
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|UNI_CAUSE_RECOVER
argument_list|)
expr_stmt|;
name|ADD_CAUSE_TIMER
argument_list|(
name|conf
operator|->
name|release
operator|.
name|cause
index|[
literal|0
index|]
argument_list|,
literal|"308"
argument_list|)
expr_stmt|;
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_RELEASE_confirm
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
block|}
name|uni_destroy_call
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************/
end_comment

begin_comment
comment|/*  * STATUS in U11/U12  *  * Q.2971:Call-Control-U 29/39 (U11)  * Q.2971:Call-Control-U 30/39 (U12)  * Q.2971:Call-Control-N 29/39 (N11)  * Q.2971:Call-Control-N 31/39 (N12)  */
end_comment

begin_function
specifier|static
name|void
name|un11un12_status
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
block|{
name|enum
name|call_state
name|ns
decl_stmt|;
name|struct
name|uniapi_release_confirm
modifier|*
name|conf
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|api
decl_stmt|;
name|struct
name|party
modifier|*
name|p
decl_stmt|;
name|struct
name|uniapi_status_indication
modifier|*
name|stat
decl_stmt|;
comment|/* 	 * Analyze message 	 */
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|m
argument_list|,
name|u
argument_list|,
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
name|MANDATE_IE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
argument_list|,
name|UNI_IE_CALLSTATE
argument_list|)
expr_stmt|;
name|MANDATE_IE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|cause
argument_list|,
name|UNI_IE_CAUSE
argument_list|)
expr_stmt|;
name|ns
operator|=
name|c
operator|->
name|cstate
expr_stmt|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
argument_list|)
operator|&&
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
operator|.
name|state
operator|==
name|UNI_CALLSTATE_U0
condition|)
name|ns
operator|=
name|CALLST_NULL
expr_stmt|;
name|p
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|epref
argument_list|)
condition|)
name|p
operator|=
name|uni_find_party
argument_list|(
name|c
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|epref
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|uni_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
argument_list|)
condition|)
block|{
case|case
name|VFY_CLR
case|:
name|uni_vfy_collect_ies
argument_list|(
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
return|return;
case|case
name|VFY_RAIM
case|:
case|case
name|VFY_RAI
case|:
case|case
name|VFY_RAP
case|:
case|case
name|VFY_RAPU
case|:
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|ns
argument_list|)
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|epref
argument_list|,
name|p
condition|?
name|p
operator|->
name|state
else|:
name|UNI_EPSTATE_NULL
argument_list|)
expr_stmt|;
case|case
name|VFY_I
case|:
case|case
name|VFY_OK
case|:
break|break;
block|}
if|if
condition|(
name|ns
operator|==
name|c
operator|->
name|cstate
condition|)
block|{
comment|/* 		 * Inform API 		 */
name|stat
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_status_indication
argument_list|,
name|api
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
operator|!=
name|NULL
condition|)
block|{
name|stat
operator|->
name|cref
operator|=
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
expr_stmt|;
name|stat
operator|->
name|my_state
operator|=
name|map_callstate
argument_list|(
name|c
operator|->
name|cstate
argument_list|)
expr_stmt|;
name|stat
operator|->
name|his_state
operator|=
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
expr_stmt|;
name|stat
operator|->
name|his_cause
operator|=
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|cause
expr_stmt|;
name|stat
operator|->
name|epref
operator|=
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|epref
expr_stmt|;
name|stat
operator|->
name|epstate
operator|=
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|epstate
expr_stmt|;
name|stat
operator|->
name|my_cause
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_STATUS_indication
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
block|}
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
return|return;
block|}
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
comment|/* 	 * Send indication to API 	 */
if|if
condition|(
operator|(
name|conf
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_release_confirm
argument_list|,
name|api
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|conf
operator|->
name|release
operator|.
name|hdr
operator|.
name|cref
operator|.
name|cref
operator|=
name|c
operator|->
name|cref
expr_stmt|;
name|conf
operator|->
name|release
operator|.
name|hdr
operator|.
name|cref
operator|.
name|flag
operator|=
name|c
operator|->
name|mine
expr_stmt|;
name|conf
operator|->
name|release
operator|.
name|hdr
operator|.
name|act
operator|=
name|UNI_MSGACT_DEFAULT
expr_stmt|;
name|MK_IE_CAUSE
argument_list|(
name|conf
operator|->
name|release
operator|.
name|cause
index|[
literal|0
index|]
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|UNI_CAUSE_MSG_INCOMP
argument_list|)
expr_stmt|;
name|ADD_CAUSE_MTYPE
argument_list|(
name|conf
operator|->
name|release
operator|.
name|cause
index|[
literal|0
index|]
argument_list|,
name|UNI_STATUS
argument_list|)
expr_stmt|;
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_RELEASE_confirm
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
block|}
name|uni_destroy_call
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|status_enq_filter
parameter_list|(
name|struct
name|sig
modifier|*
name|sig
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
return|return
operator|(
name|sig
operator|->
name|type
operator|==
name|SIG_CALL
operator|&&
operator|(
expr|struct
name|call
operator|*
operator|)
name|arg
operator|==
name|sig
operator|->
name|call
operator|&&
name|sig
operator|->
name|sig
operator|==
name|SIGC_SEND_STATUS_ENQ
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * STATUS in any state except U0/U11/U12 N0/N11/N12  *  * Q.2971:Call-Control-U 32/39  * Q.2971:Call-Control-N 33/39  */
end_comment

begin_function
specifier|static
name|void
name|unx_status
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
block|{
name|struct
name|uniapi_status_indication
modifier|*
name|stat
decl_stmt|;
name|struct
name|uniapi_release_confirm
modifier|*
name|conf
decl_stmt|;
name|enum
name|call_state
name|ns
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|api
decl_stmt|;
name|struct
name|party
modifier|*
name|p
decl_stmt|;
comment|/* 	 * Analyze message 	 */
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|m
argument_list|,
name|u
argument_list|,
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
name|MANDATE_IE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
argument_list|,
name|UNI_IE_CALLSTATE
argument_list|)
expr_stmt|;
name|MANDATE_IE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|cause
argument_list|,
name|UNI_IE_CAUSE
argument_list|)
expr_stmt|;
name|ns
operator|=
name|c
operator|->
name|cstate
expr_stmt|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
argument_list|)
condition|)
name|ns
operator|=
name|state_compat
argument_list|(
name|c
argument_list|,
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
operator|.
name|state
argument_list|)
expr_stmt|;
name|p
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|epref
argument_list|)
condition|)
block|{
name|p
operator|=
name|uni_find_party
argument_list|(
name|c
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|epref
argument_list|)
expr_stmt|;
name|MANDATE_IE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|epstate
argument_list|,
name|UNI_IE_EPSTATE
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|uni_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
argument_list|)
condition|)
block|{
case|case
name|VFY_CLR
case|:
name|uni_vfy_collect_ies
argument_list|(
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
return|return;
case|case
name|VFY_RAIM
case|:
case|case
name|VFY_RAI
case|:
case|case
name|VFY_RAP
case|:
case|case
name|VFY_RAPU
case|:
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|ns
argument_list|)
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|notify
operator|.
name|epref
argument_list|,
name|p
condition|?
name|p
operator|->
name|state
else|:
name|UNI_EPSTATE_NULL
argument_list|)
expr_stmt|;
comment|/* FALLTHRU */
case|case
name|VFY_I
case|:
case|case
name|VFY_OK
case|:
break|break;
block|}
if|if
condition|(
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
operator|.
name|state
operator|==
name|UNI_CALLSTATE_U0
condition|)
block|{
comment|/* release_complete */
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|CALL_LEAF
operator|||
name|c
operator|->
name|type
operator|==
name|CALL_ROOT
condition|)
block|{
name|TAILQ_FOREACH
argument_list|(
argument|p
argument_list|,
argument|&c->parties
argument_list|,
argument|link
argument_list|)
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_RELEASE_COMPL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * Send indication to API 		 */
name|conf
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_release_confirm
argument_list|,
name|api
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|!=
name|NULL
condition|)
block|{
name|conf
operator|->
name|release
operator|.
name|hdr
operator|.
name|cref
operator|.
name|cref
operator|=
name|c
operator|->
name|cref
expr_stmt|;
name|conf
operator|->
name|release
operator|.
name|hdr
operator|.
name|cref
operator|.
name|flag
operator|=
name|c
operator|->
name|mine
expr_stmt|;
name|conf
operator|->
name|release
operator|.
name|hdr
operator|.
name|act
operator|=
name|UNI_MSGACT_DEFAULT
expr_stmt|;
name|MK_IE_CAUSE
argument_list|(
name|conf
operator|->
name|release
operator|.
name|cause
index|[
literal|0
index|]
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|UNI_CAUSE_MSG_INCOMP
argument_list|)
expr_stmt|;
name|ADD_CAUSE_MTYPE
argument_list|(
name|conf
operator|->
name|release
operator|.
name|cause
index|[
literal|0
index|]
argument_list|,
name|UNI_STATUS
argument_list|)
expr_stmt|;
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_RELEASE_confirm
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
block|}
name|uni_destroy_call
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|cause
argument_list|)
operator|&&
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|cause
operator|.
name|cause
operator|==
name|UNI_CAUSE_STATUS
condition|)
block|{
name|c
operator|->
name|se_active
operator|=
literal|0
expr_stmt|;
name|TIMER_STOP_CALL
argument_list|(
name|c
argument_list|,
name|t322
argument_list|)
expr_stmt|;
name|uni_undel
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|status_enq_filter
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Inform API 	 */
if|if
condition|(
operator|(
name|stat
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_status_indication
argument_list|,
name|api
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|stat
operator|->
name|cref
operator|=
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
expr_stmt|;
name|stat
operator|->
name|my_state
operator|=
name|map_callstate
argument_list|(
name|c
operator|->
name|cstate
argument_list|)
expr_stmt|;
name|stat
operator|->
name|his_state
operator|=
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
expr_stmt|;
name|stat
operator|->
name|his_cause
operator|=
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|cause
expr_stmt|;
name|stat
operator|->
name|epref
operator|=
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|epref
expr_stmt|;
name|stat
operator|->
name|epstate
operator|=
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|epstate
expr_stmt|;
block|}
if|if
condition|(
name|ns
operator|==
name|c
operator|->
name|cstate
condition|)
block|{
comment|/* compatible or recovered */
if|if
condition|(
name|p
operator|!=
name|NULL
condition|)
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_STATUS
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|epref
argument_list|)
operator|&&
operator|(
operator|!
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|epstate
argument_list|)
operator|||
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|epstate
operator|.
name|state
operator|!=
name|UNI_EPSTATE_NULL
operator|)
condition|)
name|respond_drop_party_ack
argument_list|(
name|c
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|epref
argument_list|,
name|UNI_CAUSE_MSG_INCOMP
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|stat
operator|!=
name|NULL
condition|)
block|{
name|stat
operator|->
name|my_cause
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_STATUS_indication
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
comment|/* incompatible */
if|if
condition|(
name|stat
operator|!=
name|NULL
condition|)
block|{
name|stat
operator|->
name|my_cause
operator|=
name|UNI_CAUSE_MSG_INCOMP
expr_stmt|;
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_STATUS_indication
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
block|}
name|MK_IE_CAUSE
argument_list|(
name|c
operator|->
name|uni
operator|->
name|cause
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|UNI_CAUSE_MSG_INCOMP
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Enquiry peer status  *  * Q.2971:Call-Control-U 31/39  * Q.2971:Call-Control-N 32/39  */
end_comment

begin_function
specifier|static
name|void
name|unx_status_enquiry_request
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|msg
parameter_list|,
name|uint32_t
name|cookie
parameter_list|)
block|{
name|struct
name|uniapi_status_enquiry_request
modifier|*
name|arg
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_status_enquiry_request
operator|*
argument_list|)
decl_stmt|;
name|struct
name|party
modifier|*
name|p
decl_stmt|;
name|struct
name|uni_all
modifier|*
name|stat
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|se_active
condition|)
block|{
comment|/* This case is not handled in the SDLs */
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BUSY
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|c
operator|->
name|type
operator|==
name|CALL_ROOT
operator|||
name|c
operator|->
name|type
operator|==
name|CALL_LEAF
operator|)
operator|&&
name|IE_ISGOOD
argument_list|(
name|arg
operator|->
name|epref
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|p
operator|=
name|uni_find_partyx
argument_list|(
name|c
argument_list|,
name|arg
operator|->
name|epref
operator|.
name|epref
argument_list|,
operator|!
name|arg
operator|->
name|epref
operator|.
name|flag
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_PARTY
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_STATUS_ENQUIRY_request
argument_list|,
name|cookie
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|stat
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|==
name|NULL
condition|)
block|{
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_NOMEM
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
name|memset
argument_list|(
operator|&
name|c
operator|->
name|stat_epref
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|c
operator|->
name|stat_epref
argument_list|)
argument_list|)
expr_stmt|;
name|MK_MSG_ORIG
argument_list|(
name|stat
argument_list|,
name|UNI_STATUS_ENQ
argument_list|,
name|c
operator|->
name|cref
argument_list|,
operator|!
name|c
operator|->
name|mine
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|stat
argument_list|,
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|stat
argument_list|)
expr_stmt|;
name|TIMER_START_CALL
argument_list|(
name|c
argument_list|,
name|t322
argument_list|,
name|c
operator|->
name|uni
operator|->
name|timer322
argument_list|)
expr_stmt|;
name|c
operator|->
name|cnt322
operator|=
literal|0
expr_stmt|;
name|c
operator|->
name|se_active
operator|=
literal|1
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_OK
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * T322 tick  *  * Q.2971:Call-Control-U 34/39  * Q.2971:Call-Control-N 35/39  */
end_comment

begin_function
specifier|static
name|void
name|unx_t322
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|)
block|{
name|struct
name|uni_all
modifier|*
name|stat
decl_stmt|;
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_TIMEOUT
argument_list|,
literal|1
argument_list|,
literal|"call %u/%s T322 tick %d"
argument_list|,
name|c
operator|->
name|cref
argument_list|,
name|c
operator|->
name|mine
condition|?
literal|"mine"
else|:
literal|"his"
argument_list|,
name|c
operator|->
name|cnt322
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|++
name|c
operator|->
name|cnt322
operator|<
name|c
operator|->
name|uni
operator|->
name|init322
condition|)
block|{
if|if
condition|(
operator|(
name|stat
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|!=
name|NULL
condition|)
block|{
name|MK_MSG_ORIG
argument_list|(
name|stat
argument_list|,
name|UNI_STATUS_ENQ
argument_list|,
name|c
operator|->
name|cref
argument_list|,
operator|!
name|c
operator|->
name|mine
argument_list|)
expr_stmt|;
name|stat
operator|->
name|u
operator|.
name|status_enq
operator|.
name|epref
operator|=
name|c
operator|->
name|stat_epref
expr_stmt|;
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|stat
argument_list|,
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|stat
argument_list|)
expr_stmt|;
block|}
name|TIMER_START_CALL
argument_list|(
name|c
argument_list|,
name|t322
argument_list|,
name|c
operator|->
name|uni
operator|->
name|timer322
argument_list|)
expr_stmt|;
return|return;
block|}
name|c
operator|->
name|se_active
operator|=
literal|0
expr_stmt|;
name|MK_IE_CAUSE
argument_list|(
name|c
operator|->
name|uni
operator|->
name|cause
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|UNI_CAUSE_RECOVER
argument_list|)
expr_stmt|;
name|ADD_CAUSE_TIMER
argument_list|(
name|c
operator|->
name|uni
operator|->
name|cause
argument_list|,
literal|"322"
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * STATUS ENQUIRY message  *  * Q.2971:Call-Control-U 31/39  * Q.2971:Call-Control-N 32/39  */
end_comment

begin_function
specifier|static
name|void
name|unx_status_enq
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
block|{
name|struct
name|party
modifier|*
name|p
init|=
name|NULL
decl_stmt|;
name|u_int
name|epref
decl_stmt|,
name|flag
decl_stmt|;
comment|/* 	 * Analyze message 	 */
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|m
argument_list|,
name|u
argument_list|,
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|uni_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
argument_list|)
condition|)
block|{
case|case
name|VFY_CLR
case|:
name|uni_vfy_collect_ies
argument_list|(
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
return|return;
case|case
name|VFY_RAIM
case|:
case|case
name|VFY_RAI
case|:
case|case
name|VFY_RAP
case|:
case|case
name|VFY_RAPU
case|:
case|case
name|VFY_I
case|:
case|case
name|VFY_OK
case|:
break|break;
block|}
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|->
name|type
operator|==
name|CALL_ROOT
operator|||
name|c
operator|->
name|type
operator|==
name|CALL_LEAF
operator|)
operator|&&
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|status_enq
operator|.
name|epref
argument_list|)
condition|)
block|{
name|p
operator|=
name|uni_find_party
argument_list|(
name|c
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|status_enq
operator|.
name|epref
argument_list|)
expr_stmt|;
name|epref
operator|=
name|u
operator|->
name|u
operator|.
name|status_enq
operator|.
name|epref
operator|.
name|epref
expr_stmt|;
name|flag
operator|=
name|u
operator|->
name|u
operator|.
name|status_enq
operator|.
name|epref
operator|.
name|flag
expr_stmt|;
name|memset
argument_list|(
name|u
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|u
argument_list|)
argument_list|)
expr_stmt|;
name|MK_IE_EPREF
argument_list|(
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|epref
argument_list|,
name|epref
argument_list|,
operator|!
name|flag
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|!=
name|NULL
condition|)
name|MK_IE_EPSTATE
argument_list|(
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|epstate
argument_list|,
name|p
operator|->
name|state
argument_list|)
expr_stmt|;
else|else
name|MK_IE_EPSTATE
argument_list|(
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|epstate
argument_list|,
name|UNI_EPSTATE_NULL
argument_list|)
expr_stmt|;
block|}
else|else
name|memset
argument_list|(
name|u
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|u
argument_list|)
argument_list|)
expr_stmt|;
name|MK_MSG_ORIG
argument_list|(
name|u
argument_list|,
name|UNI_STATUS
argument_list|,
name|c
operator|->
name|cref
argument_list|,
operator|!
name|c
operator|->
name|mine
argument_list|)
expr_stmt|;
name|MK_IE_CALLSTATE
argument_list|(
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
argument_list|,
name|map_callstate
argument_list|(
name|c
operator|->
name|cstate
argument_list|)
argument_list|)
expr_stmt|;
name|MK_IE_CAUSE
argument_list|(
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|cause
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|UNI_CAUSE_STATUS
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|u
argument_list|,
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************/
end_comment

begin_comment
comment|/*  * Link-release.indication from SAAL in state U10 or N10.  *  * Q.2971:Call-Control-U 19/39  * Q.2971:Call-Control-N 20/39  */
end_comment

begin_function
specifier|static
name|void
name|un10_link_release_indication
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|)
block|{
name|struct
name|party
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|CALL_LEAF
operator|||
name|c
operator|->
name|type
operator|==
name|CALL_ROOT
condition|)
name|TAILQ_FOREACH
argument_list|(
argument|p
argument_list|,
argument|&c->parties
argument_list|,
argument|link
argument_list|)
block|{
if|if
condition|(
name|p
operator|->
name|state
operator|!=
name|UNI_EPSTATE_ACTIVE
condition|)
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_RELEASE_COMPL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|uni_enq_coord
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|SIGO_LINK_ESTABLISH_request
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Link-release.indication from SAAL in all state except U10 and N10.  *  * Q.2971:Call-Control-U 36/39  * Q.2971:Call-Control-N 37/39  */
end_comment

begin_function
specifier|static
name|void
name|unx_link_release_indication
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|)
block|{
name|struct
name|uniapi_release_confirm
modifier|*
name|conf
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|api
decl_stmt|;
name|struct
name|party
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|CALL_LEAF
operator|||
name|c
operator|->
name|type
operator|==
name|CALL_ROOT
condition|)
name|TAILQ_FOREACH
argument_list|(
argument|p
argument_list|,
argument|&c->parties
argument_list|,
argument|link
argument_list|)
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_RELEASE_COMPL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|conf
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_release_confirm
argument_list|,
name|api
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|conf
operator|->
name|release
operator|.
name|hdr
operator|.
name|cref
operator|.
name|cref
operator|=
name|c
operator|->
name|cref
expr_stmt|;
name|conf
operator|->
name|release
operator|.
name|hdr
operator|.
name|cref
operator|.
name|flag
operator|=
name|c
operator|->
name|mine
expr_stmt|;
name|conf
operator|->
name|release
operator|.
name|hdr
operator|.
name|act
operator|=
name|UNI_MSGACT_DEFAULT
expr_stmt|;
name|MK_IE_CAUSE
argument_list|(
name|conf
operator|->
name|release
operator|.
name|cause
index|[
literal|0
index|]
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|UNI_CAUSE_DST_OOO
argument_list|)
expr_stmt|;
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_RELEASE_confirm
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
block|}
name|uni_destroy_call
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Failed to establish SAAL link. Can happen only in U10 or N10.  *  * Q.2971:Call-Control-U 19/39  * Q.2971:Call-Control-N 20/39  */
end_comment

begin_function
specifier|static
name|void
name|un10_link_establish_error_indication
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|)
block|{
name|struct
name|party
modifier|*
name|p
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|api
decl_stmt|;
name|struct
name|uniapi_release_confirm
modifier|*
name|conf
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|CALL_LEAF
operator|||
name|c
operator|->
name|type
operator|==
name|CALL_ROOT
condition|)
name|TAILQ_FOREACH
argument_list|(
argument|p
argument_list|,
argument|&c->parties
argument_list|,
argument|link
argument_list|)
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_RELEASE_COMPL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|conf
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_release_confirm
argument_list|,
name|api
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|conf
operator|->
name|release
operator|.
name|hdr
operator|.
name|cref
operator|.
name|cref
operator|=
name|c
operator|->
name|cref
expr_stmt|;
name|conf
operator|->
name|release
operator|.
name|hdr
operator|.
name|cref
operator|.
name|flag
operator|=
name|c
operator|->
name|mine
expr_stmt|;
name|conf
operator|->
name|release
operator|.
name|hdr
operator|.
name|act
operator|=
name|UNI_MSGACT_DEFAULT
expr_stmt|;
name|MK_IE_CAUSE
argument_list|(
name|conf
operator|->
name|release
operator|.
name|cause
index|[
literal|0
index|]
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|UNI_CAUSE_DST_OOO
argument_list|)
expr_stmt|;
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_RELEASE_confirm
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
block|}
name|uni_destroy_call
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Issue a STATUS ENQUIRY of we are not busy  *  * Q.2971: Call-Control-U: 34/39  * Q.2971: Call-Control-N: 34/39  */
end_comment

begin_function
specifier|static
name|void
name|call_se
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|)
block|{
name|struct
name|uni_all
modifier|*
name|stat
decl_stmt|;
name|c
operator|->
name|cnt322
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|se_active
condition|)
return|return;
name|memset
argument_list|(
operator|&
name|c
operator|->
name|stat_epref
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|c
operator|->
name|stat_epref
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|stat
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|!=
name|NULL
condition|)
block|{
name|MK_MSG_ORIG
argument_list|(
name|stat
argument_list|,
name|UNI_STATUS_ENQ
argument_list|,
name|c
operator|->
name|cref
argument_list|,
operator|!
name|c
operator|->
name|mine
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|stat
argument_list|,
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|stat
argument_list|)
expr_stmt|;
block|}
name|TIMER_START_CALL
argument_list|(
name|c
argument_list|,
name|t322
argument_list|,
name|c
operator|->
name|uni
operator|->
name|timer322
argument_list|)
expr_stmt|;
name|c
operator|->
name|se_active
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Link-establish.indication in U10  *  * Q.2971:Call-Control-U 19-20/39  * Q.2971:Call-Control-N 20-22/39  */
end_comment

begin_function
specifier|static
name|void
name|un10_link_establish_indication
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|)
block|{
name|int
name|act
init|=
literal|0
decl_stmt|;
name|struct
name|party
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|CALL_ROOT
operator|||
name|c
operator|->
name|type
operator|==
name|CALL_LEAF
condition|)
block|{
name|TAILQ_FOREACH
argument_list|(
argument|p
argument_list|,
argument|&c->parties
argument_list|,
argument|link
argument_list|)
if|if
condition|(
name|p
operator|->
name|state
operator|==
name|UNI_EPSTATE_ACTIVE
condition|)
block|{
name|act
operator|=
literal|1
expr_stmt|;
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_STATUS_ENQUIRY_request
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|act
condition|)
return|return;
block|}
name|call_se
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Link-establish.indication in NOT U10/U11/U12 N10/N11/N12  *  * Q.2971:Call-Control-U 36/39  * Q.2971:Call-Control-N 37/39  */
end_comment

begin_function
specifier|static
name|void
name|unx_link_establish_indication
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|)
block|{
name|call_se
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Link-establish.confirm in U10 or N10  *  * Q.2971:Call-Control-U 19/39  * Q.2971:Call-Control-N 20/39  */
end_comment

begin_function
specifier|static
name|void
name|un10_link_establish_confirm
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|)
block|{
name|struct
name|party
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|CALL_ROOT
operator|||
name|c
operator|->
name|type
operator|==
name|CALL_LEAF
condition|)
block|{
name|TAILQ_FOREACH
argument_list|(
argument|p
argument_list|,
argument|&c->parties
argument_list|,
argument|link
argument_list|)
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_STATUS_ENQUIRY_request
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return;
block|}
name|call_se
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * STATUS ENQ from party  *  * Q.2971:Call-Control-U 21/39  * Q.2971:Call-Control-U 25/39  */
end_comment

begin_function
specifier|static
name|void
name|unx_send_party_status_enq
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
block|{
if|if
condition|(
name|c
operator|->
name|se_active
condition|)
block|{
name|uni_delenq_sig
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|SIG_CALL
argument_list|,
name|c
argument_list|,
name|NULL
argument_list|,
name|SIGC_SEND_STATUS_ENQ
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
block|}
name|c
operator|->
name|stat_epref
operator|=
name|u
operator|->
name|u
operator|.
name|status_enq
operator|.
name|epref
expr_stmt|;
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|u
argument_list|,
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
name|TIMER_START_CALL
argument_list|(
name|c
argument_list|,
name|t322
argument_list|,
name|c
operator|->
name|uni
operator|->
name|timer322
argument_list|)
expr_stmt|;
name|c
operator|->
name|se_active
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|make_drop_cause
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_ie_cause
modifier|*
name|cause
parameter_list|)
block|{
if|if
condition|(
operator|!
name|IE_ISGOOD
argument_list|(
operator|*
name|cause
argument_list|)
condition|)
block|{
comment|/* 9.5.7.1 paragraph 2 */
if|if
condition|(
name|IE_ISPRESENT
argument_list|(
operator|*
name|cause
argument_list|)
condition|)
name|MK_IE_CAUSE
argument_list|(
name|c
operator|->
name|uni
operator|->
name|cause
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|UNI_CAUSE_IE_INV
argument_list|)
expr_stmt|;
else|else
name|MK_IE_CAUSE
argument_list|(
name|c
operator|->
name|uni
operator|->
name|cause
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|UNI_CAUSE_MANDAT
argument_list|)
expr_stmt|;
name|c
operator|->
name|uni
operator|->
name|cause
operator|.
name|u
operator|.
name|ie
operator|.
name|len
operator|=
literal|1
expr_stmt|;
name|c
operator|->
name|uni
operator|->
name|cause
operator|.
name|u
operator|.
name|ie
operator|.
name|ie
index|[
literal|0
index|]
operator|=
name|UNI_IE_CAUSE
expr_stmt|;
name|c
operator|->
name|uni
operator|->
name|cause
operator|.
name|h
operator|.
name|present
operator||=
name|UNI_CAUSE_IE_P
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|IE_ISGOOD
argument_list|(
name|c
operator|->
name|uni
operator|->
name|cause
argument_list|)
condition|)
name|c
operator|->
name|uni
operator|->
name|cause
operator|=
operator|*
name|cause
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Drop-party.indication from Party-Control in any state.  *  * Q.2971:Call-Control-U 23/39  */
end_comment

begin_function
specifier|static
name|void
name|ux_drop_party_indication
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|api
parameter_list|)
block|{
name|struct
name|uniapi_drop_party_indication
modifier|*
name|drop
init|=
name|uni_msg_rptr
argument_list|(
name|api
argument_list|,
expr|struct
name|uniapi_drop_party_indication
operator|*
argument_list|)
decl_stmt|;
if|if
condition|(
name|uni_party_act_count
argument_list|(
name|c
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|cstate
operator|!=
name|CALLST_U11
condition|)
block|{
name|make_drop_cause
argument_list|(
name|c
argument_list|,
operator|&
name|drop
operator|->
name|drop
operator|.
name|cause
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
name|uni_msg_destroy
argument_list|(
name|api
argument_list|)
expr_stmt|;
return|return;
block|}
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_DROP_PARTY_indication
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Drop-party.indication from Party-Control in any state.  *  * Q.2971:Call-Control-N 23/39  */
end_comment

begin_function
specifier|static
name|void
name|nx_drop_party_indication
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|api
parameter_list|)
block|{
name|struct
name|uniapi_drop_party_indication
modifier|*
name|drop
init|=
name|uni_msg_rptr
argument_list|(
name|api
argument_list|,
expr|struct
name|uniapi_drop_party_indication
operator|*
argument_list|)
decl_stmt|;
if|if
condition|(
name|uni_party_act_count
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|uni_party_act_count
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|cstate
operator|!=
name|CALLST_U11
condition|)
block|{
name|make_drop_cause
argument_list|(
name|c
argument_list|,
operator|&
name|drop
operator|->
name|drop
operator|.
name|cause
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
name|uni_msg_destroy
argument_list|(
name|api
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_DROP_PARTY_indication
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
name|set_call_state
argument_list|(
name|c
argument_list|,
name|CALLST_N7
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_DROP_PARTY_indication
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Drop-party-ack.indication from Party-Control in any state.  *  * Q.2971:Call-Control-U 23/39  */
end_comment

begin_function
specifier|static
name|void
name|ux_drop_party_ack_indication
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|api
parameter_list|)
block|{
name|struct
name|uniapi_drop_party_ack_indication
modifier|*
name|drop
init|=
name|uni_msg_rptr
argument_list|(
name|api
argument_list|,
expr|struct
name|uniapi_drop_party_ack_indication
operator|*
argument_list|)
decl_stmt|;
if|if
condition|(
name|uni_party_act_count
argument_list|(
name|c
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|cstate
operator|!=
name|CALLST_U11
condition|)
block|{
name|make_drop_cause
argument_list|(
name|c
argument_list|,
operator|&
name|drop
operator|->
name|drop
operator|.
name|cause
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
name|uni_msg_destroy
argument_list|(
name|api
argument_list|)
expr_stmt|;
return|return;
block|}
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_DROP_PARTY_ACK_indication
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Drop-party-ack.indication from Party-Control in any state.  *  * Q.2971:Call-Control-N 23/39  */
end_comment

begin_function
specifier|static
name|void
name|nx_drop_party_ack_indication
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|api
parameter_list|)
block|{
name|struct
name|uniapi_drop_party_ack_indication
modifier|*
name|drop
init|=
name|uni_msg_rptr
argument_list|(
name|api
argument_list|,
expr|struct
name|uniapi_drop_party_ack_indication
operator|*
argument_list|)
decl_stmt|;
if|if
condition|(
name|uni_party_act_count
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|uni_party_act_count
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|cstate
operator|!=
name|CALLST_U11
condition|)
block|{
name|make_drop_cause
argument_list|(
name|c
argument_list|,
operator|&
name|drop
operator|->
name|drop
operator|.
name|cause
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
name|uni_msg_destroy
argument_list|(
name|api
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_DROP_PARTY_ACK_indication
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
name|set_call_state
argument_list|(
name|c
argument_list|,
name|CALLST_N7
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_DROP_PARTY_ACK_indication
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Add-party-rej.indication from Party-Control in any state.  *  * Q.2971:Call-Control-U 23/39  */
end_comment

begin_function
specifier|static
name|void
name|ux_add_party_rej_indication
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|api
parameter_list|)
block|{
name|struct
name|uniapi_add_party_rej_indication
modifier|*
name|rej
init|=
name|uni_msg_rptr
argument_list|(
name|api
argument_list|,
expr|struct
name|uniapi_add_party_rej_indication
operator|*
argument_list|)
decl_stmt|;
if|if
condition|(
name|uni_party_act_count
argument_list|(
name|c
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|cstate
operator|!=
name|CALLST_U11
condition|)
block|{
name|make_drop_cause
argument_list|(
name|c
argument_list|,
operator|&
name|rej
operator|->
name|rej
operator|.
name|cause
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
name|uni_msg_destroy
argument_list|(
name|api
argument_list|)
expr_stmt|;
return|return;
block|}
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_ADD_PARTY_REJ_indication
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Add-party-rej.indication from Party-Control in any state.  *  * Q.2971:Call-Control-N 23/39  */
end_comment

begin_function
specifier|static
name|void
name|nx_add_party_rej_indication
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|api
parameter_list|)
block|{
name|struct
name|uniapi_add_party_rej_indication
modifier|*
name|rej
init|=
name|uni_msg_rptr
argument_list|(
name|api
argument_list|,
expr|struct
name|uniapi_add_party_rej_indication
operator|*
argument_list|)
decl_stmt|;
if|if
condition|(
name|uni_party_act_count
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|uni_party_act_count
argument_list|(
name|c
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|cstate
operator|!=
name|CALLST_U11
condition|)
block|{
name|make_drop_cause
argument_list|(
name|c
argument_list|,
operator|&
name|rej
operator|->
name|rej
operator|.
name|cause
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
name|uni_msg_destroy
argument_list|(
name|api
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_ADD_PARTY_REJ_indication
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
name|set_call_state
argument_list|(
name|c
argument_list|,
name|CALLST_N7
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_ADD_PARTY_REJ_indication
argument_list|,
literal|0
argument_list|,
name|api
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Add-party.request from API in U4 or U10  *  * Q.2971:Call-Control-U 9-10/39 (U4)  * Q.2971:Call-Control-U 21/39 (U10)  * Q.2971:Call-Control-N 12/39 (N7)  * Q.2971:Call-Control-N 22/39 (N10)  */
end_comment

begin_function
specifier|static
name|void
name|unx_add_party_request
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|msg
parameter_list|,
name|uint32_t
name|cookie
parameter_list|)
block|{
name|struct
name|uniapi_add_party_request
modifier|*
name|add
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_add_party_request
operator|*
argument_list|)
decl_stmt|;
name|struct
name|party
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|add
operator|->
name|add
operator|.
name|epref
argument_list|)
condition|)
block|{
if|if
condition|(
name|add
operator|->
name|add
operator|.
name|epref
operator|.
name|flag
operator|!=
literal|0
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_IE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
return|return;
block|}
name|p
operator|=
name|uni_find_partyx
argument_list|(
name|c
argument_list|,
name|add
operator|->
name|add
operator|.
name|epref
operator|.
name|epref
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|!=
name|NULL
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_EPREF_INUSE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|IE_ISPRESENT
argument_list|(
name|add
operator|->
name|add
operator|.
name|epref
argument_list|)
condition|)
block|{
name|allocate_epref
argument_list|(
name|c
argument_list|,
operator|&
name|add
operator|->
name|add
operator|.
name|epref
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IE_ISPRESENT
argument_list|(
name|add
operator|->
name|add
operator|.
name|epref
argument_list|)
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_EPREF_INUSE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_IE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|p
operator|=
name|uni_create_partyx
argument_list|(
name|c
argument_list|,
name|add
operator|->
name|add
operator|.
name|epref
operator|.
name|epref
argument_list|,
literal|1
argument_list|,
name|cookie
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_NOMEM
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
return|return;
block|}
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_ADD_PARTY_request
argument_list|,
name|cookie
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Add-party-ack.request from API in U10/N10  *  * Q.2971:Call-Control-U 21/39  * Q.2971:Call-Control-N 22/39  */
end_comment

begin_function
specifier|static
name|void
name|un10_add_party_ack_request
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|msg
parameter_list|,
name|uint32_t
name|cookie
parameter_list|)
block|{
name|struct
name|uniapi_add_party_ack_request
modifier|*
name|ack
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_add_party_ack_request
operator|*
argument_list|)
decl_stmt|;
name|struct
name|party
modifier|*
name|p
decl_stmt|;
if|if
condition|(
operator|!
name|IE_ISGOOD
argument_list|(
name|ack
operator|->
name|ack
operator|.
name|epref
argument_list|)
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_IE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ack
operator|->
name|ack
operator|.
name|epref
operator|.
name|flag
operator|!=
literal|1
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_IE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|p
operator|=
name|uni_find_partyx
argument_list|(
name|c
argument_list|,
name|ack
operator|->
name|ack
operator|.
name|epref
operator|.
name|epref
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_PARTY
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
return|return;
block|}
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_ADD_PARTY_ACK_request
argument_list|,
name|cookie
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Party-alerting.request from API in U7/U8/U10  *  * Q.2971:Call-Control-U 14/39 U7  * Q.2971:Call-Control-U 15/39 U8  * Q.2971:Call-Control-U 21/39 U10  * Q.2971:Call-Control-N 8/39  N4  * Q.2971:Call-Control-N 22/39 N10  */
end_comment

begin_function
specifier|static
name|void
name|unx_party_alerting_request
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|msg
parameter_list|,
name|uint32_t
name|cookie
parameter_list|)
block|{
name|struct
name|uniapi_party_alerting_request
modifier|*
name|alert
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_party_alerting_request
operator|*
argument_list|)
decl_stmt|;
name|struct
name|party
modifier|*
name|p
decl_stmt|;
if|if
condition|(
operator|!
name|IE_ISGOOD
argument_list|(
name|alert
operator|->
name|alert
operator|.
name|epref
argument_list|)
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_IE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|alert
operator|->
name|alert
operator|.
name|epref
operator|.
name|flag
operator|!=
literal|1
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_IE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|p
operator|=
name|uni_find_partyx
argument_list|(
name|c
argument_list|,
name|alert
operator|->
name|alert
operator|.
name|epref
operator|.
name|epref
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_PARTY
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
return|return;
block|}
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_PARTY_ALERTING_request
argument_list|,
name|cookie
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Add-party-rej.request from API in U7/U8/U10/N4/N10  *  * Q.2971:Call-Control-U 14/39 U7  * Q.2971:Call-Control-U 15/39 U8  * Q.2971:Call-Control-U 21/39 U10  * Q.2971:Call-Control-N 8/39  N4  * Q.2971:Call-Control-N 22/39 N10  */
end_comment

begin_function
specifier|static
name|void
name|unx_add_party_rej_request
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|msg
parameter_list|,
name|uint32_t
name|cookie
parameter_list|)
block|{
name|struct
name|uniapi_add_party_rej_request
modifier|*
name|rej
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_add_party_rej_request
operator|*
argument_list|)
decl_stmt|;
name|struct
name|party
modifier|*
name|p
decl_stmt|;
if|if
condition|(
operator|!
name|IE_ISGOOD
argument_list|(
name|rej
operator|->
name|rej
operator|.
name|epref
argument_list|)
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_IE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|rej
operator|->
name|rej
operator|.
name|epref
operator|.
name|flag
operator|!=
literal|1
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_IE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|p
operator|=
name|uni_find_partyx
argument_list|(
name|c
argument_list|,
name|rej
operator|->
name|rej
operator|.
name|epref
operator|.
name|epref
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_PARTY
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
return|return;
block|}
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_ADD_PARTY_REJ_request
argument_list|,
name|cookie
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Drop-party.request from API in U1-U10  *  * Q.2971:Call-Control-U 21/39 U10  * Q.2971:Call-Control-U 26/39 U1-U9  * Q.2971:Call-Control-N 22/39 N10  * Q.2971:Call-Control-N 27/39 N1-N9  */
end_comment

begin_function
specifier|static
name|void
name|unx_drop_party_request
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|msg
parameter_list|,
name|uint32_t
name|cookie
parameter_list|)
block|{
name|struct
name|uniapi_drop_party_request
modifier|*
name|drop
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_drop_party_request
operator|*
argument_list|)
decl_stmt|;
name|struct
name|party
modifier|*
name|p
decl_stmt|;
if|if
condition|(
operator|!
name|IE_ISGOOD
argument_list|(
name|drop
operator|->
name|drop
operator|.
name|epref
argument_list|)
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_IE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|p
operator|=
name|uni_find_partyx
argument_list|(
name|c
argument_list|,
name|drop
operator|->
name|drop
operator|.
name|epref
operator|.
name|epref
argument_list|,
operator|!
name|drop
operator|->
name|drop
operator|.
name|epref
operator|.
name|flag
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_PARTY
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
return|return;
block|}
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_DROP_PARTY_request
argument_list|,
name|cookie
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Drop-party-ack.request from API in U1-U10  *  * Q.2971:Call-Control-U 21/39 U10  * Q.2971:Call-Control-U 26/39 U1-U9  * Q.2971:Call-Control-N 22/39 N10  * Q.2971:Call-Control-N 27/39 N1-N9  */
end_comment

begin_function
specifier|static
name|void
name|unx_drop_party_ack_request
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|msg
parameter_list|,
name|uint32_t
name|cookie
parameter_list|)
block|{
name|struct
name|uniapi_drop_party_ack_request
modifier|*
name|ack
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_drop_party_ack_request
operator|*
argument_list|)
decl_stmt|;
name|struct
name|party
modifier|*
name|p
decl_stmt|;
if|if
condition|(
operator|!
name|IE_ISGOOD
argument_list|(
name|ack
operator|->
name|ack
operator|.
name|epref
argument_list|)
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_IE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|p
operator|=
name|uni_find_partyx
argument_list|(
name|c
argument_list|,
name|ack
operator|->
name|ack
operator|.
name|epref
operator|.
name|epref
argument_list|,
operator|!
name|ack
operator|->
name|ack
operator|.
name|epref
operator|.
name|flag
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_PARTY
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
return|return;
block|}
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_DROP_PARTY_ACK_request
argument_list|,
name|cookie
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * ADD PARTY in U7/U8/U10  *  * Q.2971:Call-Control-U 14/39  U7  * Q.2971:Call-Control-U 15/39  U8  * Q.2971:Call-Control-U 21/39  U10  * Q.2971:Call-Control-N 8/39   N4  * Q.2971:Call-Control-N 21/39  N10  *  * Body already decoded  * XXX check EPREF flag  */
end_comment

begin_function
specifier|static
name|void
name|unx_add_party
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|,
name|int
name|legal
parameter_list|)
block|{
name|struct
name|uni_all
modifier|*
name|resp
decl_stmt|;
name|struct
name|uni_ierr
modifier|*
name|e1
decl_stmt|;
name|struct
name|party
modifier|*
name|p
init|=
name|NULL
decl_stmt|;
name|enum
name|verify
name|vfy
decl_stmt|;
name|uni_mandate_epref
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|add_party
operator|.
name|epref
argument_list|)
expr_stmt|;
name|MANDATE_IE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|add_party
operator|.
name|called
argument_list|,
name|UNI_IE_CALLED
argument_list|)
expr_stmt|;
comment|/* 	 * Do part of the verify handish: according to 9.5.7.2 we must send 	 * an ADD_PARTY_REJ if mandatory IEs are bad or missing instead of 	 * clearing the call. But we must send a STATUS, if it is the EPREF! 	 */
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|add_party
operator|.
name|epref
argument_list|)
condition|)
block|{
name|c
operator|->
name|uni
operator|->
name|cause
operator|.
name|u
operator|.
name|ie
operator|.
name|len
operator|=
literal|0
expr_stmt|;
name|FOREACH_ERR
argument_list|(
argument|e1
argument_list|,
argument|c->uni
argument_list|)
block|{
if|if
condition|(
name|e1
operator|->
name|err
operator|==
name|UNI_IERR_MIS
condition|)
block|{
name|MK_IE_CAUSE
argument_list|(
name|c
operator|->
name|uni
operator|->
name|cause
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|UNI_CAUSE_MANDAT
argument_list|)
expr_stmt|;
goto|goto
name|rej
goto|;
block|}
block|}
name|FOREACH_ERR
argument_list|(
argument|e1
argument_list|,
argument|c->uni
argument_list|)
block|{
if|if
condition|(
name|e1
operator|->
name|man
operator|&&
name|e1
operator|->
name|ie
operator|!=
name|UNI_IE_EPREF
operator|&&
name|e1
operator|->
name|act
operator|==
name|UNI_IEACT_DEFAULT
condition|)
block|{
name|MK_IE_CAUSE
argument_list|(
name|c
operator|->
name|uni
operator|->
name|cause
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|UNI_CAUSE_IE_INV
argument_list|)
expr_stmt|;
name|rej
label|:
name|uni_vfy_collect_ies
argument_list|(
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|resp
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|!=
name|NULL
condition|)
block|{
name|MK_MSG_RESP
argument_list|(
name|resp
argument_list|,
name|UNI_ADD_PARTY_REJ
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|)
expr_stmt|;
name|MK_IE_EPREF
argument_list|(
name|resp
operator|->
name|u
operator|.
name|add_party_rej
operator|.
name|epref
argument_list|,
name|u
operator|->
name|u
operator|.
name|add_party
operator|.
name|epref
operator|.
name|epref
argument_list|,
operator|!
name|u
operator|->
name|u
operator|.
name|add_party
operator|.
name|epref
operator|.
name|flag
argument_list|)
expr_stmt|;
name|resp
operator|->
name|u
operator|.
name|add_party_rej
operator|.
name|cause
operator|=
name|c
operator|->
name|uni
operator|->
name|cause
expr_stmt|;
name|unx_send_add_party_rej
argument_list|(
name|c
argument_list|,
name|resp
argument_list|)
expr_stmt|;
block|}
goto|goto
name|ignore
goto|;
block|}
block|}
name|p
operator|=
name|uni_find_partyx
argument_list|(
name|c
argument_list|,
name|u
operator|->
name|u
operator|.
name|add_party
operator|.
name|epref
operator|.
name|epref
argument_list|,
name|u
operator|->
name|u
operator|.
name|add_party
operator|.
name|epref
operator|.
name|flag
argument_list|)
expr_stmt|;
block|}
name|vfy
operator|=
name|uni_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|vfy
condition|)
block|{
case|case
name|VFY_CLR
case|:
name|uni_vfy_collect_ies
argument_list|(
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
goto|goto
name|ignore
goto|;
case|case
name|VFY_RAIM
case|:
case|case
name|VFY_RAI
case|:
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|c
operator|->
name|cstate
argument_list|)
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|add_party
operator|.
name|epref
argument_list|,
name|p
condition|?
name|p
operator|->
name|state
else|:
name|UNI_EPSTATE_NULL
argument_list|)
expr_stmt|;
comment|/* FALLTHRU */
case|case
name|VFY_I
case|:
goto|goto
name|ignore
goto|;
case|case
name|VFY_RAP
case|:
case|case
name|VFY_RAPU
case|:
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|c
operator|->
name|cstate
argument_list|)
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|add_party
operator|.
name|epref
argument_list|,
name|UNI_EPSTATE_ADD_RCVD
argument_list|)
expr_stmt|;
case|case
name|VFY_OK
case|:
comment|/* FALLTHRU */
break|break;
block|}
if|if
condition|(
operator|!
name|legal
condition|)
block|{
name|uni_bad_message
argument_list|(
name|c
argument_list|,
name|u
argument_list|,
name|UNI_CAUSE_MSG_INCOMP
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|add_party
operator|.
name|epref
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|add_party
operator|.
name|epref
argument_list|)
operator|&&
name|p
operator|==
name|NULL
operator|&&
name|u
operator|->
name|u
operator|.
name|add_party
operator|.
name|epref
operator|.
name|flag
condition|)
block|{
name|IE_SETERROR
argument_list|(
name|u
operator|->
name|u
operator|.
name|add_party
operator|.
name|epref
argument_list|)
expr_stmt|;
name|UNI_SAVE_IERR
argument_list|(
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|,
name|UNI_IE_EPREF
argument_list|,
name|u
operator|->
name|u
operator|.
name|add_party
operator|.
name|epref
operator|.
name|h
operator|.
name|act
argument_list|,
name|UNI_IERR_BAD
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|add_party
operator|.
name|epref
argument_list|)
condition|)
block|{
comment|/* 9.5.3.2.2 */
if|if
condition|(
name|vfy
operator|==
name|VFY_OK
condition|)
block|{
name|MK_IE_CAUSE
argument_list|(
name|c
operator|->
name|uni
operator|->
name|cause
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|UNI_CAUSE_IE_INV
argument_list|)
expr_stmt|;
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|c
operator|->
name|cstate
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
goto|goto
name|ignore
goto|;
block|}
if|if
condition|(
name|p
operator|==
name|NULL
operator|&&
operator|(
name|p
operator|=
name|uni_create_party
argument_list|(
name|c
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|add_party
operator|.
name|epref
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|ignore
goto|;
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_ADD_PARTY
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
name|ignore
label|:
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * ADD PARTY ACKNOWLEDGE  *  * Q.2971:Call-Control-U 21/39 U10  * Q.2971:Call-Control-N 15/39 N8  * Q.2971:Call-Control-N 22/39 N10  */
end_comment

begin_function
specifier|static
name|void
name|un10n8_add_party_ack
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|,
name|int
name|legal
parameter_list|)
block|{
name|struct
name|party
modifier|*
name|p
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|add_party_ack
operator|.
name|epref
argument_list|)
condition|)
block|{
if|if
condition|(
name|u
operator|->
name|u
operator|.
name|add_party_ack
operator|.
name|epref
operator|.
name|flag
operator|==
literal|0
condition|)
block|{
name|IE_SETERROR
argument_list|(
name|u
operator|->
name|u
operator|.
name|add_party_ack
operator|.
name|epref
argument_list|)
expr_stmt|;
name|UNI_SAVE_IERR
argument_list|(
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|,
name|UNI_IE_EPREF
argument_list|,
name|u
operator|->
name|u
operator|.
name|add_party_ack
operator|.
name|epref
operator|.
name|h
operator|.
name|act
argument_list|,
name|UNI_IERR_BAD
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|p
operator|=
name|uni_find_partyx
argument_list|(
name|c
argument_list|,
name|u
operator|->
name|u
operator|.
name|add_party_ack
operator|.
name|epref
operator|.
name|epref
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|respond_drop_party_ack
argument_list|(
name|c
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|add_party_ack
operator|.
name|epref
argument_list|,
name|UNI_CAUSE_ENDP_INV
argument_list|)
expr_stmt|;
goto|goto
name|ignore
goto|;
block|}
block|}
block|}
name|uni_mandate_epref
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|add_party_ack
operator|.
name|epref
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|uni_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
argument_list|)
condition|)
block|{
case|case
name|VFY_CLR
case|:
name|uni_vfy_collect_ies
argument_list|(
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
goto|goto
name|ignore
goto|;
case|case
name|VFY_RAIM
case|:
case|case
name|VFY_RAI
case|:
name|report
label|:
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|c
operator|->
name|cstate
argument_list|)
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|add_party_ack
operator|.
name|epref
argument_list|,
name|p
condition|?
name|p
operator|->
name|state
else|:
name|UNI_EPSTATE_NULL
argument_list|)
expr_stmt|;
case|case
name|VFY_I
case|:
goto|goto
name|ignore
goto|;
case|case
name|VFY_RAP
case|:
case|case
name|VFY_RAPU
case|:
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|c
operator|->
name|cstate
argument_list|)
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|add_party_ack
operator|.
name|epref
argument_list|,
name|p
condition|?
name|UNI_EPSTATE_ACTIVE
else|:
name|UNI_EPSTATE_NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|party_alerting
operator|.
name|epref
argument_list|)
condition|)
comment|/* See below */
goto|goto
name|ignore
goto|;
break|break;
case|case
name|VFY_OK
case|:
if|if
condition|(
operator|!
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|party_alerting
operator|.
name|epref
argument_list|)
condition|)
comment|/* this happens when the EPREF has bad format. 			 * The rules require us the message to be ignored 			 * (9.5.3.2.2e) and to report status. 			 */
goto|goto
name|report
goto|;
break|break;
block|}
if|if
condition|(
name|legal
condition|)
block|{
comment|/* p is != NULL here */
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_ADD_PARTY_ACK
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
comment|/* Q.2971 9.5.3.2.3a) */
name|respond_drop_party_ack
argument_list|(
name|c
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|add_party_ack
operator|.
name|epref
argument_list|,
name|UNI_CAUSE_ENDP_INV
argument_list|)
expr_stmt|;
else|else
name|uni_bad_message
argument_list|(
name|c
argument_list|,
name|u
argument_list|,
name|UNI_CAUSE_MSG_INCOMP
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|add_party_ack
operator|.
name|epref
argument_list|,
name|p
operator|->
name|state
argument_list|)
expr_stmt|;
name|ignore
label|:
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Make the EPREF action default  */
end_comment

begin_function
specifier|static
name|void
name|default_act_epref
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|struct
name|uni_ie_epref
modifier|*
name|epref
parameter_list|)
block|{
name|struct
name|uni_ierr
modifier|*
name|e
decl_stmt|;
name|FOREACH_ERR
argument_list|(
argument|e
argument_list|,
argument|uni
argument_list|)
if|if
condition|(
name|e
operator|->
name|ie
operator|==
name|UNI_IE_EPREF
condition|)
block|{
name|e
operator|->
name|act
operator|=
name|UNI_IEACT_DEFAULT
expr_stmt|;
break|break;
block|}
name|epref
operator|->
name|h
operator|.
name|act
operator|=
name|UNI_IEACT_DEFAULT
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * PARTY ALERTING message  *  * Q.2971:Call-Control-U 9/39   U4  * Q.2971:Call-Control-U 21/39  U10  * Q.2971:Call-Control-N 12/39  N7  * Q.2971:Call-Control-N 15/39  N8  * Q.2971:Call-Control-N 22/39  N10  */
end_comment

begin_function
specifier|static
name|void
name|unx_party_alerting
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|,
name|int
name|legal
parameter_list|)
block|{
name|struct
name|party
modifier|*
name|p
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|party_alerting
operator|.
name|epref
argument_list|)
condition|)
block|{
if|if
condition|(
name|u
operator|->
name|u
operator|.
name|party_alerting
operator|.
name|epref
operator|.
name|flag
operator|==
literal|0
condition|)
block|{
name|IE_SETERROR
argument_list|(
name|u
operator|->
name|u
operator|.
name|party_alerting
operator|.
name|epref
argument_list|)
expr_stmt|;
name|UNI_SAVE_IERR
argument_list|(
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|,
name|UNI_IE_EPREF
argument_list|,
name|u
operator|->
name|u
operator|.
name|party_alerting
operator|.
name|epref
operator|.
name|h
operator|.
name|act
argument_list|,
name|UNI_IERR_BAD
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|p
operator|=
name|uni_find_partyx
argument_list|(
name|c
argument_list|,
name|u
operator|->
name|u
operator|.
name|party_alerting
operator|.
name|epref
operator|.
name|epref
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|respond_drop_party_ack
argument_list|(
name|c
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|party_alerting
operator|.
name|epref
argument_list|,
name|UNI_CAUSE_ENDP_INV
argument_list|)
expr_stmt|;
goto|goto
name|ignore
goto|;
block|}
block|}
block|}
name|uni_mandate_epref
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|party_alerting
operator|.
name|epref
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|uni_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
argument_list|)
condition|)
block|{
case|case
name|VFY_CLR
case|:
name|uni_vfy_collect_ies
argument_list|(
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
goto|goto
name|ignore
goto|;
case|case
name|VFY_RAIM
case|:
case|case
name|VFY_RAI
case|:
name|report
label|:
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|c
operator|->
name|cstate
argument_list|)
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|party_alerting
operator|.
name|epref
argument_list|,
name|p
condition|?
name|p
operator|->
name|state
else|:
name|UNI_EPSTATE_NULL
argument_list|)
expr_stmt|;
case|case
name|VFY_I
case|:
goto|goto
name|ignore
goto|;
case|case
name|VFY_RAP
case|:
case|case
name|VFY_RAPU
case|:
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|c
operator|->
name|cstate
argument_list|)
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|party_alerting
operator|.
name|epref
argument_list|,
name|p
condition|?
name|UNI_EPSTATE_ALERT_RCVD
else|:
name|UNI_EPSTATE_NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|party_alerting
operator|.
name|epref
argument_list|)
condition|)
comment|/* See below */
goto|goto
name|ignore
goto|;
break|break;
case|case
name|VFY_OK
case|:
if|if
condition|(
operator|!
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|party_alerting
operator|.
name|epref
argument_list|)
condition|)
comment|/* The rules require us the message to be ignored 			 * (9.5.3.2.2e) and to report status. 			 */
goto|goto
name|report
goto|;
break|break;
block|}
if|if
condition|(
name|legal
condition|)
block|{
comment|/* p is != NULL here */
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_PARTY_ALERTING
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
comment|/* Q.2971 9.5.3.2.3a) */
name|respond_drop_party_ack
argument_list|(
name|c
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|party_alerting
operator|.
name|epref
argument_list|,
name|UNI_CAUSE_ENDP_INV
argument_list|)
expr_stmt|;
else|else
name|uni_bad_message
argument_list|(
name|c
argument_list|,
name|u
argument_list|,
name|UNI_CAUSE_MSG_INCOMP
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|party_alerting
operator|.
name|epref
argument_list|,
name|p
operator|->
name|state
argument_list|)
expr_stmt|;
name|ignore
label|:
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Handle a bad/missing cause in a DROP_PARTY_ACK or ADD_PARTY_REJ  *  * If the IE is missing or bad and the action is defaulted handle as  * cause #1 according to 9.5.7.1/2.  * Otherwise keep the IE.  */
end_comment

begin_function
specifier|static
name|void
name|handle_bad_drop_cause
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_ie_cause
modifier|*
name|cause
parameter_list|,
name|int
name|mkcause
parameter_list|)
block|{
if|if
condition|(
name|IE_ISGOOD
argument_list|(
operator|*
name|cause
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|IE_ISPRESENT
argument_list|(
operator|*
name|cause
argument_list|)
condition|)
block|{
comment|/* 9.5.7.1 */
comment|/* cannot make cause here because we need the 96 error */
name|uni_vfy_remove_cause
argument_list|(
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|cause
operator|->
name|h
operator|.
name|act
operator|!=
name|UNI_IEACT_DEFAULT
condition|)
return|return;
comment|/* 9.5.7.2 */
name|uni_vfy_remove_cause
argument_list|(
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
if|if
condition|(
name|mkcause
condition|)
name|MK_IE_CAUSE
argument_list|(
operator|*
name|cause
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|UNI_CAUSE_UNSPEC
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * ADD PARTY REJ from party control  * Q.2971:Call-Control-U 21/39  * Q.2971:Call-Control-U 24/39  */
end_comment

begin_function
specifier|static
name|void
name|unx_send_add_party_rej
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
block|{
if|if
condition|(
name|uni_party_act_count
argument_list|(
name|c
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|cstate
operator|!=
name|CALLST_U11
operator|&&
name|c
operator|->
name|cstate
operator|!=
name|CALLST_N12
condition|)
block|{
name|c
operator|->
name|uni
operator|->
name|cause
operator|=
name|u
operator|->
name|u
operator|.
name|add_party_rej
operator|.
name|cause
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
block|}
else|else
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|u
argument_list|,
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * ADD_PARTY_REJECT in U4/U10  *  * Q.2971:Call-Control-U 9/39 U4  * Q.2971:Call-Control-U 21/39 U10  * Q.2971:Call-Control-N 12/39 N7  * Q.2971:Call-Control-N 15/39 N8  * Q.2971:Call-Control-N 22/39 N10  */
end_comment

begin_function
specifier|static
name|void
name|unx_add_party_rej
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|,
name|int
name|legal
parameter_list|)
block|{
name|struct
name|uni_add_party_rej
modifier|*
name|ar
init|=
operator|&
name|u
operator|->
name|u
operator|.
name|add_party_rej
decl_stmt|;
name|struct
name|party
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|ar
operator|->
name|epref
argument_list|)
condition|)
block|{
name|p
operator|=
name|uni_find_partyx
argument_list|(
name|c
argument_list|,
name|ar
operator|->
name|epref
operator|.
name|epref
argument_list|,
name|ar
operator|->
name|epref
operator|.
name|flag
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
goto|goto
name|ignore
goto|;
if|if
condition|(
name|legal
condition|)
block|{
name|handle_bad_drop_cause
argument_list|(
name|c
argument_list|,
operator|&
name|ar
operator|->
name|cause
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|uni_vfy_remove_unknown
argument_list|(
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|uni_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
argument_list|)
condition|)
block|{
case|case
name|VFY_CLR
case|:
goto|goto
name|clear
goto|;
case|case
name|VFY_RAIM
case|:
case|case
name|VFY_RAI
case|:
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|c
operator|->
name|cstate
argument_list|)
argument_list|,
operator|&
name|ar
operator|->
name|epref
argument_list|,
name|p
operator|->
name|state
argument_list|)
expr_stmt|;
case|case
name|VFY_I
case|:
goto|goto
name|ignore
goto|;
case|case
name|VFY_RAPU
case|:
name|uni_vfy_collect_ies
argument_list|(
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
break|break;
case|case
name|VFY_RAP
case|:
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|c
operator|->
name|cstate
argument_list|)
argument_list|,
operator|&
name|ar
operator|->
name|epref
argument_list|,
name|p
operator|->
name|state
argument_list|)
expr_stmt|;
case|case
name|VFY_OK
case|:
break|break;
block|}
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_ADD_PARTY_REJ
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
block|}
name|uni_bad_message
argument_list|(
name|c
argument_list|,
name|u
argument_list|,
name|UNI_CAUSE_MSG_INCOMP
argument_list|,
operator|&
name|ar
operator|->
name|epref
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Q.2971: 9.5.3.2.1 last paragraph 	 *         9.5.3.2.2 second to last paragraph 	 * Make the action indicator default. 	 */
name|default_act_epref
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|ar
operator|->
name|epref
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IE_ISPRESENT
argument_list|(
name|ar
operator|->
name|epref
argument_list|)
condition|)
name|uni_mandate_ie
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_IE_EPREF
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|uni_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
argument_list|)
expr_stmt|;
name|clear
label|:
name|uni_vfy_collect_ies
argument_list|(
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|ignore
label|:
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * DROP_PARTY  *  * Q.2971:Call-Control-U 26/39 Ux  * Q.2971:Call-Control-U 21/39 U10  * Q.2971:Call-Control-N 27/39 Nx  * Q.2971:Call-Control-N 22/39 N10  */
end_comment

begin_function
specifier|static
name|void
name|unx_drop_party
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|,
name|int
name|legal
parameter_list|)
block|{
name|struct
name|uni_drop_party
modifier|*
name|dp
init|=
operator|&
name|u
operator|->
name|u
operator|.
name|drop_party
decl_stmt|;
name|struct
name|party
modifier|*
name|p
decl_stmt|;
name|struct
name|uni_ierr
modifier|*
name|e
decl_stmt|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|dp
operator|->
name|epref
argument_list|)
condition|)
block|{
name|p
operator|=
name|uni_find_partyx
argument_list|(
name|c
argument_list|,
name|dp
operator|->
name|epref
operator|.
name|epref
argument_list|,
name|dp
operator|->
name|epref
operator|.
name|flag
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|respond_drop_party_ack
argument_list|(
name|c
argument_list|,
operator|&
name|dp
operator|->
name|epref
argument_list|,
name|UNI_CAUSE_ENDP_INV
argument_list|)
expr_stmt|;
goto|goto
name|ignore
goto|;
block|}
name|handle_bad_drop_cause
argument_list|(
name|c
argument_list|,
operator|&
name|dp
operator|->
name|cause
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|uni_vfy_remove_unknown
argument_list|(
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|uni_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
argument_list|)
condition|)
block|{
case|case
name|VFY_CLR
case|:
goto|goto
name|clear
goto|;
case|case
name|VFY_RAIM
case|:
case|case
name|VFY_RAI
case|:
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|c
operator|->
name|cstate
argument_list|)
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|drop_party
operator|.
name|epref
argument_list|,
name|p
operator|->
name|state
argument_list|)
expr_stmt|;
case|case
name|VFY_I
case|:
goto|goto
name|ignore
goto|;
case|case
name|VFY_RAPU
case|:
name|uni_vfy_collect_ies
argument_list|(
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
break|break;
case|case
name|VFY_RAP
case|:
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|c
operator|->
name|cstate
argument_list|)
argument_list|,
operator|&
name|dp
operator|->
name|epref
argument_list|,
name|UNI_EPSTATE_DROP_RCVD
argument_list|)
expr_stmt|;
case|case
name|VFY_OK
case|:
break|break;
block|}
if|if
condition|(
name|legal
condition|)
block|{
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_DROP_PARTY
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
block|}
name|uni_bad_message
argument_list|(
name|c
argument_list|,
name|u
argument_list|,
name|UNI_CAUSE_MSG_INCOMP
argument_list|,
operator|&
name|dp
operator|->
name|epref
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|ignore
goto|;
block|}
comment|/* Q.2971: 9.5.3.2.1 last paragraph 	 *         9.5.3.2.2 second to last paragraph 	 * Make the action indicator default. 	 */
name|FOREACH_ERR
argument_list|(
argument|e
argument_list|,
argument|c->uni
argument_list|)
if|if
condition|(
name|e
operator|->
name|ie
operator|==
name|UNI_IE_EPREF
condition|)
block|{
name|e
operator|->
name|act
operator|=
name|UNI_IEACT_DEFAULT
expr_stmt|;
break|break;
block|}
name|dp
operator|->
name|epref
operator|.
name|h
operator|.
name|act
operator|=
name|UNI_IEACT_DEFAULT
expr_stmt|;
if|if
condition|(
operator|!
name|IE_ISPRESENT
argument_list|(
name|dp
operator|->
name|epref
argument_list|)
condition|)
name|uni_mandate_ie
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_IE_EPREF
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|uni_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
argument_list|)
expr_stmt|;
name|clear
label|:
name|uni_vfy_collect_ies
argument_list|(
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
return|return;
name|ignore
label|:
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * DROP_PARTY_ACK  *  * Q.2971:Call-Control-U 26/39 Ux  * Q.2971:Call-Control-U 21/39 U10  * Q.2971:Call-Control-N 27/39 Nx  * Q.2971:Call-Control-N 22/39 N10  */
end_comment

begin_function
specifier|static
name|void
name|unx_drop_party_ack
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|,
name|int
name|legal
parameter_list|)
block|{
name|struct
name|party
modifier|*
name|p
decl_stmt|;
name|struct
name|uni_drop_party_ack
modifier|*
name|ack
init|=
operator|&
name|u
operator|->
name|u
operator|.
name|drop_party_ack
decl_stmt|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|drop_party_ack
operator|.
name|epref
argument_list|)
condition|)
block|{
name|p
operator|=
name|uni_find_partyx
argument_list|(
name|c
argument_list|,
name|ack
operator|->
name|epref
operator|.
name|epref
argument_list|,
name|ack
operator|->
name|epref
operator|.
name|flag
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|!=
name|NULL
condition|)
block|{
name|handle_bad_drop_cause
argument_list|(
name|c
argument_list|,
operator|&
name|ack
operator|->
name|cause
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|uni_vfy_remove_unknown
argument_list|(
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|uni_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
argument_list|)
condition|)
block|{
case|case
name|VFY_CLR
case|:
goto|goto
name|clear
goto|;
case|case
name|VFY_RAIM
case|:
case|case
name|VFY_RAI
case|:
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|c
operator|->
name|cstate
argument_list|)
argument_list|,
operator|&
name|ack
operator|->
name|epref
argument_list|,
name|p
operator|->
name|state
argument_list|)
expr_stmt|;
case|case
name|VFY_I
case|:
goto|goto
name|ignore
goto|;
case|case
name|VFY_RAP
case|:
name|uni_respond_status_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|map_callstate
argument_list|(
name|c
operator|->
name|cstate
argument_list|)
argument_list|,
operator|&
name|ack
operator|->
name|epref
argument_list|,
name|UNI_EPSTATE_NULL
argument_list|)
expr_stmt|;
case|case
name|VFY_RAPU
case|:
case|case
name|VFY_OK
case|:
break|break;
block|}
if|if
condition|(
name|legal
condition|)
block|{
name|uni_enq_party
argument_list|(
name|p
argument_list|,
name|SIGP_DROP_PARTY_ACK
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
block|}
name|uni_bad_message
argument_list|(
name|c
argument_list|,
name|u
argument_list|,
name|UNI_CAUSE_MSG_INCOMP
argument_list|,
operator|&
name|ack
operator|->
name|epref
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
goto|goto
name|ignore
goto|;
block|}
comment|/* Q.2971: 9.5.3.2.1 last paragraph 	 *         9.5.3.2.2 second to last paragraph 	 */
operator|(
name|void
operator|)
name|uni_verify
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
argument_list|)
expr_stmt|;
name|MK_IE_CAUSE
argument_list|(
name|c
operator|->
name|uni
operator|->
name|cause
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|UNI_CAUSE_IE_INV
argument_list|)
expr_stmt|;
name|clear
label|:
name|uni_vfy_collect_ies
argument_list|(
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
return|return;
name|ignore
label|:
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************/
end_comment

begin_comment
comment|/*  * Bad or unrecognized message.  *  * Q.2971:Call-Control-U 35/39  */
end_comment

begin_function
name|void
name|uni_bad_message
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|,
name|u_int
name|cause
parameter_list|,
name|struct
name|uni_ie_epref
modifier|*
name|epref
parameter_list|,
name|int
name|ps
parameter_list|)
block|{
name|struct
name|uni_all
modifier|*
name|resp
decl_stmt|;
name|struct
name|party
modifier|*
name|p
decl_stmt|;
if|if
condition|(
operator|(
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
operator|==
name|UNI_MSGACT_CLEAR
operator|&&
operator|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U11
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_U12
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N11
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N12
operator|)
operator|)
operator|||
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
operator|==
name|UNI_MSGACT_IGNORE
condition|)
return|return;
name|MK_IE_CAUSE
argument_list|(
name|c
operator|->
name|uni
operator|->
name|cause
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|cause
argument_list|)
expr_stmt|;
name|ADD_CAUSE_MTYPE
argument_list|(
name|c
operator|->
name|uni
operator|->
name|cause
argument_list|,
name|u
operator|->
name|mtype
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
operator|==
name|UNI_MSGACT_CLEAR
condition|)
block|{
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Send STATUS 	 */
if|if
condition|(
operator|(
name|resp
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|!=
name|NULL
condition|)
block|{
name|MK_MSG_RESP
argument_list|(
name|resp
argument_list|,
name|UNI_STATUS
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|)
expr_stmt|;
name|MK_IE_CALLSTATE
argument_list|(
name|resp
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
argument_list|,
name|map_callstate
argument_list|(
name|c
operator|->
name|cstate
argument_list|)
argument_list|)
expr_stmt|;
name|resp
operator|->
name|u
operator|.
name|status
operator|.
name|cause
operator|=
name|c
operator|->
name|uni
operator|->
name|cause
expr_stmt|;
if|if
condition|(
name|epref
operator|!=
name|NULL
operator|&&
name|IE_ISGOOD
argument_list|(
operator|*
name|epref
argument_list|)
condition|)
block|{
name|MK_IE_EPREF
argument_list|(
name|resp
operator|->
name|u
operator|.
name|status
operator|.
name|epref
argument_list|,
name|epref
operator|->
name|epref
argument_list|,
operator|!
name|epref
operator|->
name|flag
argument_list|)
expr_stmt|;
if|if
condition|(
name|ps
operator|==
operator|-
literal|1
condition|)
block|{
name|p
operator|=
name|uni_find_party
argument_list|(
name|c
argument_list|,
name|epref
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
name|ps
operator|=
name|UNI_EPSTATE_NULL
expr_stmt|;
else|else
name|ps
operator|=
name|p
operator|->
name|state
expr_stmt|;
block|}
name|MK_IE_EPSTATE
argument_list|(
name|resp
operator|->
name|u
operator|.
name|status
operator|.
name|epstate
argument_list|,
name|ps
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|resp
argument_list|,
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|resp
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**********************************************************************/
end_comment

begin_comment
comment|/*  * Unknown message in any state.  *  * Q.2971:Call-Control 35/39  * Q.2971:Call-Control 36/39  */
end_comment

begin_function
specifier|static
name|void
name|unx_unknown
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
block|{
comment|/* 	 * Unrecognized message. Cannot call verify here, because 	 * it doesn't know about unrecognized messages. 	 */
if|if
condition|(
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
operator|==
name|UNI_MSGACT_CLEAR
condition|)
block|{
name|MK_IE_CAUSE
argument_list|(
name|c
operator|->
name|uni
operator|->
name|cause
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|UNI_CAUSE_MTYPE_NIMPL
argument_list|)
expr_stmt|;
name|ADD_CAUSE_MTYPE
argument_list|(
name|c
operator|->
name|uni
operator|->
name|cause
argument_list|,
name|u
operator|->
name|mtype
argument_list|)
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
operator|==
name|UNI_MSGACT_IGNORE
condition|)
block|{
empty_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|m
argument_list|,
name|u
argument_list|,
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
name|uni_bad_message
argument_list|(
name|c
argument_list|,
name|u
argument_list|,
name|UNI_CAUSE_MTYPE_NIMPL
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|unknown
operator|.
name|epref
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************/
end_comment

begin_function
name|void
name|uni_sig_call
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|enum
name|call_sig
name|sig
parameter_list|,
name|uint32_t
name|cookie
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|msg
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
block|{
if|if
condition|(
name|sig
operator|>=
name|SIGC_END
condition|)
block|{
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|1
argument_list|,
literal|"Signal %d outside of range to Call-Control"
argument_list|,
name|sig
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
condition|)
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
condition|)
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
return|return;
block|}
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_CALL
argument_list|,
literal|1
argument_list|,
literal|"Signal %s in state %s of call %u/%s"
literal|"; cookie %u"
argument_list|,
name|call_sigs
index|[
name|sig
index|]
argument_list|,
name|callstates
index|[
name|c
operator|->
name|cstate
index|]
operator|.
name|name
argument_list|,
name|c
operator|->
name|cref
argument_list|,
name|c
operator|->
name|mine
condition|?
literal|"mine"
else|:
literal|"his"
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sig
condition|)
block|{
case|case
name|SIGC_LINK_RELEASE_indication
case|:
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U10
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N10
condition|)
comment|/* Q.2971:Call-Control-U 36/39 */
comment|/* Q.2971:Call-Control-N 20/39 */
name|un10_link_release_indication
argument_list|(
name|c
argument_list|)
expr_stmt|;
else|else
comment|/* Q.2971:Call-Control-U 36/39 */
comment|/* Q.2971:Call-Control-N 37/39 */
name|unx_link_release_indication
argument_list|(
name|c
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_LINK_ESTABLISH_ERROR_indication
case|:
if|if
condition|(
name|c
operator|->
name|cstate
operator|!=
name|CALLST_U10
operator|&&
name|c
operator|->
name|cstate
operator|!=
name|CALLST_N10
condition|)
block|{
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|1
argument_list|,
literal|"link-establish-error.indication in cs=%s"
argument_list|,
name|callstates
index|[
name|c
operator|->
name|cstate
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Q.2971:Call-Control-U 19/39 */
comment|/* Q.2971:Call-Control-N 20/39 */
name|un10_link_establish_error_indication
argument_list|(
name|c
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_LINK_ESTABLISH_indication
case|:
switch|switch
condition|(
name|c
operator|->
name|cstate
condition|)
block|{
case|case
name|CALLST_U1
case|:
case|case
name|CALLST_N1
case|:
case|case
name|CALLST_U3
case|:
case|case
name|CALLST_N3
case|:
case|case
name|CALLST_U4
case|:
case|case
name|CALLST_N4
case|:
case|case
name|CALLST_U6
case|:
case|case
name|CALLST_N6
case|:
case|case
name|CALLST_U7
case|:
case|case
name|CALLST_N7
case|:
case|case
name|CALLST_U8
case|:
case|case
name|CALLST_N8
case|:
case|case
name|CALLST_U9
case|:
case|case
name|CALLST_N9
case|:
comment|/* Q.2971:Call-Control-U 36/39 */
comment|/* Q.2971:Call-Control-N 37/39 */
name|unx_link_establish_indication
argument_list|(
name|c
argument_list|)
expr_stmt|;
break|break;
case|case
name|CALLST_U10
case|:
case|case
name|CALLST_N10
case|:
comment|/* Q.2971:Call-Control-U 19/39 */
comment|/* Q.2971:Call-Control-N 20/39 */
name|un10_link_establish_indication
argument_list|(
name|c
argument_list|)
expr_stmt|;
break|break;
case|case
name|CALLST_U11
case|:
case|case
name|CALLST_N11
case|:
case|case
name|CALLST_U12
case|:
case|case
name|CALLST_N12
case|:
comment|/* Q.2971:Call-Control-U 36/39 */
comment|/* Q.2971:Call-Control-N 37/39 */
break|break;
default|default:
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|1
argument_list|,
literal|"link-establish.indication in cs=%s"
argument_list|,
name|callstates
index|[
name|c
operator|->
name|cstate
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SIGC_LINK_ESTABLISH_confirm
case|:
if|if
condition|(
name|c
operator|->
name|cstate
operator|!=
name|CALLST_U10
operator|&&
name|c
operator|->
name|cstate
operator|!=
name|CALLST_N10
condition|)
block|{
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|1
argument_list|,
literal|"link-establish.confirm in cs=%s"
argument_list|,
name|callstates
index|[
name|c
operator|->
name|cstate
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Q.2971:Call-Control-U 19/39 */
comment|/* Q.2971:Call-Control-N 20/39 */
name|un10_link_establish_confirm
argument_list|(
name|c
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_UNKNOWN
case|:
comment|/* Q.2971:Call-Control 35/39 */
comment|/* Q.2971:Call-Control 36/39 */
name|unx_unknown
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_SETUP
case|:
if|if
condition|(
name|c
operator|->
name|cstate
operator|!=
name|CALLST_NULL
condition|)
block|{
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|msg
argument_list|,
name|u
argument_list|,
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
name|uni_bad_message
argument_list|(
name|c
argument_list|,
name|u
argument_list|,
name|UNI_CAUSE_MSG_INCOMP
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|setup
operator|.
name|epref
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
if|if
condition|(
name|c
operator|->
name|uni
operator|->
name|proto
operator|==
name|UNIPROTO_UNI40N
condition|)
comment|/* Q.2971:Call-Control-N 4/39 */
name|un0_setup
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|,
name|CALLST_N1
argument_list|)
expr_stmt|;
else|else
comment|/* Q.2971:Call-Control-U 4/39 */
name|un0_setup
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|,
name|CALLST_U6
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_CALL_PROC
case|:
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U1
condition|)
block|{
comment|/* Q.2971:Call-Control-U 6/39 */
name|u1n6_call_proc
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|,
name|CALLST_U3
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_N6
condition|)
block|{
comment|/* Q.2971:Call-Control-N 11/39 */
name|u1n6_call_proc
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|,
name|CALLST_N9
argument_list|)
expr_stmt|;
break|break;
block|}
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|msg
argument_list|,
name|u
argument_list|,
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
name|uni_bad_message
argument_list|(
name|c
argument_list|,
name|u
argument_list|,
name|UNI_CAUSE_MSG_INCOMP
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|call_proc
operator|.
name|epref
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|drop
goto|;
case|case
name|SIGC_ALERTING
case|:
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U1
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_U3
condition|)
block|{
comment|/* Q.2971:Call-Control-U 37/39 (U1) */
comment|/* Q.2971:Call-Control-U 7/39 (U3) */
name|unx_alerting
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|,
name|CALLST_U4
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_N6
condition|)
block|{
comment|/* Q.2971:Call-Control-N 9/39 (N6) */
comment|/* Q.2971:Call-Control-N 17/39 (N9) */
name|unx_alerting
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|,
name|CALLST_N7
argument_list|)
expr_stmt|;
break|break;
block|}
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|msg
argument_list|,
name|u
argument_list|,
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
name|uni_bad_message
argument_list|(
name|c
argument_list|,
name|u
argument_list|,
name|UNI_CAUSE_MSG_INCOMP
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|alerting
operator|.
name|epref
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|drop
goto|;
case|case
name|SIGC_CONNECT
case|:
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U1
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_U3
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_U4
condition|)
block|{
comment|/* Q.2971:Call-Control-U 7-8/39  (U3) */
comment|/* Q.2971:Call-Control-U 11/39   (U4) */
comment|/* Q.2971:Call-Control-U 37/39   (U1) */
name|unx_connect
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|,
name|CALLST_U10
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_N6
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N7
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N9
condition|)
block|{
comment|/* Q.2971:Call-Control-N 9-10/39 (N6) */
comment|/* Q.2971:Call-Control-N 14/39   (N7) */
comment|/* Q.2971:Call-Control-N 17/39   (N9) */
name|unx_connect
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|,
name|CALLST_N8
argument_list|)
expr_stmt|;
break|break;
block|}
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|msg
argument_list|,
name|u
argument_list|,
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
name|uni_bad_message
argument_list|(
name|c
argument_list|,
name|u
argument_list|,
name|UNI_CAUSE_MSG_INCOMP
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|connect
operator|.
name|epref
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|drop
goto|;
case|case
name|SIGC_CONNECT_ACK
case|:
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U8
condition|)
block|{
comment|/* Q.2971:Call-Control-U 15-16/39 */
name|u8_connect_ack
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|,
name|CALLST_U10
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_N10
condition|)
block|{
comment|/* Q.2971:Call-Control-N 18/39 */
name|n10_connect_ack
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|)
expr_stmt|;
break|break;
block|}
name|uni_bad_message
argument_list|(
name|c
argument_list|,
name|u
argument_list|,
name|UNI_CAUSE_MSG_INCOMP
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
goto|goto
name|drop
goto|;
case|case
name|SIGC_RELEASE
case|:
switch|switch
condition|(
name|c
operator|->
name|cstate
condition|)
block|{
default|default:
name|uni_bad_message
argument_list|(
name|c
argument_list|,
name|u
argument_list|,
name|UNI_CAUSE_MSG_INCOMP
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
goto|goto
name|drop
goto|;
case|case
name|CALLST_U11
case|:
case|case
name|CALLST_N12
case|:
comment|/* Q.2971:Call-Control-U 28/39 */
comment|/* Q.2971:Call-Control-N 30/39 */
name|u11n12_release
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|)
expr_stmt|;
break|break;
case|case
name|CALLST_U1
case|:
case|case
name|CALLST_U3
case|:
case|case
name|CALLST_U4
case|:
case|case
name|CALLST_U6
case|:
case|case
name|CALLST_U7
case|:
case|case
name|CALLST_U8
case|:
case|case
name|CALLST_U9
case|:
case|case
name|CALLST_U10
case|:
case|case
name|CALLST_U12
case|:
comment|/* Q.2971:Call-Control-U 25/39 */
name|unx_release
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|,
name|CALLST_U12
argument_list|)
expr_stmt|;
break|break;
case|case
name|CALLST_N1
case|:
case|case
name|CALLST_N3
case|:
case|case
name|CALLST_N4
case|:
case|case
name|CALLST_N6
case|:
case|case
name|CALLST_N7
case|:
case|case
name|CALLST_N8
case|:
case|case
name|CALLST_N9
case|:
case|case
name|CALLST_N10
case|:
case|case
name|CALLST_N11
case|:
comment|/* Q.2971:Call-Control-N 26/39 */
name|unx_release
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|,
name|CALLST_N11
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|SIGC_RELEASE_COMPL
case|:
comment|/* Q.2971:Call-Control-U 25/39 */
comment|/* Q.2971:Call-Control-N 26/39 */
name|unx_release_compl
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_NOTIFY
case|:
comment|/* Q.2971:Call-Control-U 18/39 */
comment|/* Q.2971:Call-Control-N 19/39 */
name|unx_notify
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_STATUS
case|:
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U11
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_U12
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N11
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N12
condition|)
block|{
comment|/* Q.2971:Call-Control-U 29/39 (U11) */
comment|/* Q.2971:Call-Control-U 30/39 (U12) */
comment|/* Q.2971:Call-Control-N 29/39 (N11) */
comment|/* Q.2971:Call-Control-N 31/39 (N12) */
name|un11un12_status
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Q.2971:Call-Control-U 32/39 */
comment|/* Q.2971:Call-Control-N 33/39 */
name|unx_status
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_STATUS_ENQ
case|:
comment|/* Q.2971:Call-Control-U 31/39 */
comment|/* Q.2971:Call-Control-N 32/39 */
name|unx_status_enq
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_ADD_PARTY
case|:
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|msg
argument_list|,
name|u
argument_list|,
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|type
operator|!=
name|CALL_LEAF
operator|&&
name|c
operator|->
name|type
operator|!=
name|CALL_ROOT
condition|)
block|{
name|uni_bad_message
argument_list|(
name|c
argument_list|,
name|u
argument_list|,
name|UNI_CAUSE_MSG_INCOMP
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|add_party
operator|.
name|epref
argument_list|,
name|UNI_EPSTATE_NULL
argument_list|)
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
switch|switch
condition|(
name|c
operator|->
name|cstate
condition|)
block|{
case|case
name|CALLST_U7
case|:
case|case
name|CALLST_U8
case|:
case|case
name|CALLST_U10
case|:
case|case
name|CALLST_N4
case|:
case|case
name|CALLST_N10
case|:
comment|/* Q.2971:Call-Control-U 14/39  U7 */
comment|/* Q.2971:Call-Control-U 15/39  U8 */
comment|/* Q.2971:Call-Control-U 21/39  U10 */
comment|/* Q.2971:Call-Control-N 8/39   N4 */
comment|/* Q.2971:Call-Control-N 21/39  N10 */
name|unx_add_party
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
default|default:
name|unx_add_party
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
break|break;
case|case
name|SIGC_PARTY_ALERTING
case|:
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|msg
argument_list|,
name|u
argument_list|,
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|type
operator|!=
name|CALL_ROOT
condition|)
block|{
name|uni_bad_message
argument_list|(
name|c
argument_list|,
name|u
argument_list|,
name|UNI_CAUSE_MSG_INCOMP
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|party_alerting
operator|.
name|epref
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
switch|switch
condition|(
name|c
operator|->
name|cstate
condition|)
block|{
default|default:
comment|/* Q.2971 9.5.3.2.3a) */
name|unx_party_alerting
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|CALLST_U4
case|:
case|case
name|CALLST_U10
case|:
comment|/* Q.2971:Call-Control-U 9/39   U4 */
comment|/* Q.2971:Call-Control-U 21/39  U10 */
comment|/* Q.2971:Call-Control-N 12/39  N7 */
comment|/* Q.2971:Call-Control-N 15/39  N8 */
comment|/* Q.2971:Call-Control-N 22/39  N10 */
name|unx_party_alerting
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|SIGC_ADD_PARTY_ACK
case|:
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|msg
argument_list|,
name|u
argument_list|,
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|type
operator|!=
name|CALL_ROOT
condition|)
block|{
name|uni_bad_message
argument_list|(
name|c
argument_list|,
name|u
argument_list|,
name|UNI_CAUSE_MSG_INCOMP
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|add_party_rej
operator|.
name|epref
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
switch|switch
condition|(
name|c
operator|->
name|cstate
condition|)
block|{
case|case
name|CALLST_U10
case|:
comment|/* Q.2971:Call-Control-U 21/39 U10 */
comment|/* Q.2971:Call-Control-N 15/39 N8 */
comment|/* Q.2971:Call-Control-N 22/39 N10 */
name|un10n8_add_party_ack
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* Q.2971 9.5.3.2.3a) */
name|un10n8_add_party_ack
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|SIGC_ADD_PARTY_REJ
case|:
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|msg
argument_list|,
name|u
argument_list|,
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|type
operator|!=
name|CALL_ROOT
condition|)
block|{
name|uni_bad_message
argument_list|(
name|c
argument_list|,
name|u
argument_list|,
name|UNI_CAUSE_MSG_INCOMP
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|add_party_rej
operator|.
name|epref
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
switch|switch
condition|(
name|c
operator|->
name|cstate
condition|)
block|{
case|case
name|CALLST_U4
case|:
case|case
name|CALLST_U10
case|:
case|case
name|CALLST_N7
case|:
case|case
name|CALLST_N8
case|:
case|case
name|CALLST_N10
case|:
comment|/* Q.2971:Call-Control-U 9/39 U4 */
comment|/* Q.2971:Call-Control-U 21/39 U10 */
comment|/* Q.2971:Call-Control-N 12/39 N7 */
comment|/* Q.2971:Call-Control-N 15/39 N8 */
comment|/* Q.2971:Call-Control-N 22/39 N10 */
name|unx_add_party_rej
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* Q.2971: 9.5.3.2.3b */
name|unx_add_party_rej
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|SIGC_DROP_PARTY
case|:
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|msg
argument_list|,
name|u
argument_list|,
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|type
operator|!=
name|CALL_ROOT
operator|&&
name|c
operator|->
name|type
operator|!=
name|CALL_LEAF
condition|)
block|{
name|uni_bad_message
argument_list|(
name|c
argument_list|,
name|u
argument_list|,
name|UNI_CAUSE_MSG_INCOMP
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|drop_party
operator|.
name|epref
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
switch|switch
condition|(
name|c
operator|->
name|cstate
condition|)
block|{
case|case
name|CALLST_U11
case|:
case|case
name|CALLST_U12
case|:
case|case
name|CALLST_N11
case|:
case|case
name|CALLST_N12
case|:
comment|/* Q.2971:Call-Control-U 28/39 U11 */
comment|/* Q.2971:Call-Control-U 30/39 U12 */
comment|/* Q.2971:Call-Control-N 29/39 N11 */
comment|/* Q.2971:Call-Control-N 30/39 N12 */
goto|goto
name|drop
goto|;
case|case
name|CALLST_NULL
case|:
name|uni_bad_message
argument_list|(
name|c
argument_list|,
name|u
argument_list|,
name|UNI_CAUSE_MSG_INCOMP
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|drop_party
operator|.
name|epref
argument_list|,
name|UNI_EPSTATE_NULL
argument_list|)
expr_stmt|;
goto|goto
name|drop
goto|;
case|case
name|CALLST_U3
case|:
case|case
name|CALLST_N3
case|:
comment|/* L3MU_17_38 */
name|unx_drop_party
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|CALLST_U8
case|:
if|if
condition|(
name|c
operator|->
name|uni
operator|->
name|sb_tb
condition|)
block|{
comment|/* L3MU_06_0[3-6] */
name|unx_drop_party
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* FALLTHRU */
default|default:
comment|/* Q.2971:Call-Control-U 26/39 Ux */
comment|/* Q.2971:Call-Control-U 21/39 U10 */
comment|/* Q.2971:Call-Control-N 27/39 Nx */
comment|/* Q.2971:Call-Control-N 21/39 N10 */
name|unx_drop_party
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|SIGC_DROP_PARTY_ACK
case|:
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|msg
argument_list|,
name|u
argument_list|,
operator|&
name|c
operator|->
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|type
operator|!=
name|CALL_ROOT
operator|&&
name|c
operator|->
name|type
operator|!=
name|CALL_LEAF
condition|)
block|{
name|uni_bad_message
argument_list|(
name|c
argument_list|,
name|u
argument_list|,
name|UNI_CAUSE_MSG_INCOMP
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|drop_party_ack
operator|.
name|epref
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|drop
goto|;
block|}
switch|switch
condition|(
name|c
operator|->
name|cstate
condition|)
block|{
case|case
name|CALLST_U11
case|:
case|case
name|CALLST_U12
case|:
comment|/* Q.2971:Call-Control-U 28/39 U11 */
comment|/* Q.2971:Call-Control-U 30/39 U12 */
comment|/* Q.2971:Call-Control-N 29/39 N11 */
comment|/* Q.2971:Call-Control-N 30/39 N12 */
goto|goto
name|drop
goto|;
case|case
name|CALLST_NULL
case|:
name|uni_bad_message
argument_list|(
name|c
argument_list|,
name|u
argument_list|,
name|UNI_CAUSE_MSG_INCOMP
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|drop_party
operator|.
name|epref
argument_list|,
name|UNI_EPSTATE_NULL
argument_list|)
expr_stmt|;
goto|goto
name|drop
goto|;
case|case
name|CALLST_U4
case|:
case|case
name|CALLST_N4
case|:
case|case
name|CALLST_U7
case|:
case|case
name|CALLST_N7
case|:
case|case
name|CALLST_U8
case|:
case|case
name|CALLST_N8
case|:
case|case
name|CALLST_U10
case|:
case|case
name|CALLST_N10
case|:
comment|/* Q.2971:Call-Control-U 26/39 Ux */
comment|/* Q.2971:Call-Control-U 21/39 U10 */
comment|/* Q.2971:Call-Control-N 27/39 Nx */
comment|/* Q.2971:Call-Control-N 22/39 N10 */
name|unx_drop_party_ack
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* Q.2971 10.5 4th paragraph */
name|unx_drop_party_ack
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|SIGC_COBISETUP
case|:
comment|/* XXX */
name|unx_unknown
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|u
argument_list|)
expr_stmt|;
break|break;
comment|/* 	   * User signals 	   */
case|case
name|SIGC_SETUP_request
case|:
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_NULL
condition|)
block|{
comment|/* Q.2971:Call-Control-U 4/39 (U0) */
comment|/* Q.2971:Call-Control-N 4/39 (N0) */
if|if
condition|(
name|c
operator|->
name|uni
operator|->
name|proto
operator|==
name|UNIPROTO_UNI40N
condition|)
name|un0_setup_request
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|cookie
argument_list|,
name|CALLST_N6
argument_list|)
expr_stmt|;
else|else
name|un0_setup_request
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|cookie
argument_list|,
name|CALLST_U1
argument_list|)
expr_stmt|;
break|break;
block|}
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|1
argument_list|,
literal|"setup.request in cs=%s"
argument_list|,
name|callstates
index|[
name|c
operator|->
name|cstate
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_CALLSTATE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_SETUP_response
case|:
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U6
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_U9
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_U7
condition|)
block|{
comment|/* Q.2971:Call-Control-U 13/39	(U6) */
comment|/* Q.2971:Call-Control-U 14/39	(U7) */
comment|/* Q.2971:Call-Control-U 17/39	(U9) */
name|unx_setup_response
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|cookie
argument_list|,
name|CALLST_U8
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_N1
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N3
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N4
condition|)
block|{
comment|/* Q.2971:Call-Control-N 39/39  (N1) */
comment|/* Q.2971:Call-Control-N 7/39   (N3) */
comment|/* Q.2971:Call-Control-N 8/39   (N4) */
name|unx_setup_response
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|cookie
argument_list|,
name|CALLST_N10
argument_list|)
expr_stmt|;
break|break;
block|}
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|1
argument_list|,
literal|"setup.response in cs=%s"
argument_list|,
name|callstates
index|[
name|c
operator|->
name|cstate
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_CALLSTATE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_SETUP_COMPLETE_request
case|:
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_N8
condition|)
block|{
comment|/* Q.2971:Call-Control-N 15/39 (N8) */
name|n8_setup_compl_request
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|cookie
argument_list|,
name|CALLST_N10
argument_list|)
expr_stmt|;
break|break;
block|}
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|1
argument_list|,
literal|"setup_compl.request in cs=%s"
argument_list|,
name|callstates
index|[
name|c
operator|->
name|cstate
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_CALLSTATE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_PROCEEDING_request
case|:
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U6
condition|)
block|{
comment|/* Q.2971:Call-Control-U 12/39 (U6) */
name|u6n1_proceeding_request
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|cookie
argument_list|,
name|CALLST_U9
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_N1
condition|)
block|{
comment|/* Q.2971:Call-Control-N 6/39 (N1) */
name|u6n1_proceeding_request
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|cookie
argument_list|,
name|CALLST_N3
argument_list|)
expr_stmt|;
break|break;
block|}
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|1
argument_list|,
literal|"proceeding.request in cs=%s"
argument_list|,
name|callstates
index|[
name|c
operator|->
name|cstate
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_CALLSTATE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_ALERTING_request
case|:
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U6
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_U9
condition|)
block|{
comment|/* Q.2971:Call-Control-U 13/39 (U6) */
comment|/* Q.2971:Call-Control-U 17/39 (U9) */
name|unx_alerting_request
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|cookie
argument_list|,
name|CALLST_U7
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_N1
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N3
condition|)
block|{
comment|/* Q.2971:Call-Control-N 38/39 (N1) */
comment|/* Q.2971:Call-Control-N 7/39  (N3) */
name|unx_alerting_request
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|cookie
argument_list|,
name|CALLST_N4
argument_list|)
expr_stmt|;
break|break;
block|}
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|1
argument_list|,
literal|"alerting.request in cs=%s"
argument_list|,
name|callstates
index|[
name|c
operator|->
name|cstate
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_CALLSTATE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_RELEASE_request
case|:
switch|switch
condition|(
name|c
operator|->
name|cstate
condition|)
block|{
case|case
name|CALLST_U1
case|:
case|case
name|CALLST_U3
case|:
case|case
name|CALLST_U4
case|:
case|case
name|CALLST_U6
case|:
case|case
name|CALLST_U7
case|:
case|case
name|CALLST_U8
case|:
case|case
name|CALLST_U9
case|:
case|case
name|CALLST_U10
case|:
comment|/* Q.2971:Call-Control-U 27/39 */
name|unx_release_request
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|cookie
argument_list|,
name|CALLST_U11
argument_list|)
expr_stmt|;
break|break;
case|case
name|CALLST_N1
case|:
case|case
name|CALLST_N3
case|:
case|case
name|CALLST_N4
case|:
case|case
name|CALLST_N6
case|:
case|case
name|CALLST_N7
case|:
case|case
name|CALLST_N8
case|:
case|case
name|CALLST_N9
case|:
case|case
name|CALLST_N10
case|:
comment|/* Q.2971:Call-Control-N 28/39 */
name|unx_release_request
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|cookie
argument_list|,
name|CALLST_N12
argument_list|)
expr_stmt|;
break|break;
case|case
name|CALLST_U11
case|:
case|case
name|CALLST_U12
case|:
case|case
name|CALLST_N11
case|:
case|case
name|CALLST_N12
case|:
case|case
name|CALLST_NULL
case|:
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|1
argument_list|,
literal|"release.request in cs=%s"
argument_list|,
name|callstates
index|[
name|c
operator|->
name|cstate
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_CALLSTATE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|SIGC_RELEASE_response
case|:
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U6
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_U12
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N1
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N11
condition|)
block|{
comment|/* Q.2971:Call-Control-U 12/39 (U6) */
comment|/* Q.2971:Call-Control-U 30/39 (U12) */
comment|/* Q.2971:Call-Control-N 6/39  (N1) */
comment|/* Q.2971:Call-Control-N 29/39 (N11) */
name|unx_release_response
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
break|break;
block|}
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|1
argument_list|,
literal|"release.response in cs=%s"
argument_list|,
name|callstates
index|[
name|c
operator|->
name|cstate
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_CALLSTATE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_NOTIFY_request
case|:
comment|/* Q.2971:Call-Control-U 18/39 */
comment|/* Q.2971:Call-Control-N 19/39 */
name|unx_notify_request
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_STATUS_ENQUIRY_request
case|:
comment|/* Q.2971:Call-Control-U 31/39 */
comment|/* Q.2971:Call-Control-N 32/39 */
name|unx_status_enquiry_request
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_ADD_PARTY_request
case|:
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U4
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_U10
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N7
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N10
condition|)
block|{
comment|/* Q.2971:Call-Control-U 9-10/39 (U4) */
comment|/* Q.2971:Call-Control-U 21/39 (U10) */
comment|/* Q.2971:Call-Control-N 12/39 (N7) */
comment|/* Q.2971:Call-Control-N 22/39 (N10) */
name|unx_add_party_request
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
break|break;
block|}
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|1
argument_list|,
literal|"add-party.request in cs=%s"
argument_list|,
name|callstates
index|[
name|c
operator|->
name|cstate
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_CALLSTATE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_PARTY_ALERTING_request
case|:
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U7
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_U8
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_U10
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N4
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N10
condition|)
block|{
comment|/* Q.2971:Call-Control-U 14/39 U7 */
comment|/* Q.2971:Call-Control-U 15/39 U8 */
comment|/* Q.2971:Call-Control-U 21/39 U10 */
comment|/* Q.2971:Call-Control-N 8/39  N4 */
comment|/* Q.2971:Call-Control-N 22/39 N10 */
name|unx_party_alerting_request
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
break|break;
block|}
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|1
argument_list|,
literal|"party-alerting.request in cs=%s"
argument_list|,
name|callstates
index|[
name|c
operator|->
name|cstate
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_CALLSTATE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_ADD_PARTY_ACK_request
case|:
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U10
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N10
condition|)
block|{
comment|/* Q.2971:Call-Control-U 21/39 (U10) */
comment|/* Q.2971:Call-Control-N 22/39 (N10)*/
name|un10_add_party_ack_request
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
break|break;
block|}
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|1
argument_list|,
literal|"add-party-ack.request in cs=%s"
argument_list|,
name|callstates
index|[
name|c
operator|->
name|cstate
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_CALLSTATE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_ADD_PARTY_REJ_request
case|:
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U7
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_U8
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_U10
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N4
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N10
condition|)
block|{
comment|/* Q.2971:Call-Control-U 14/39 U7 */
comment|/* Q.2971:Call-Control-U 15/39 U8 */
comment|/* Q.2971:Call-Control-U 21/39 U10 */
comment|/* Q.2971:Call-Control-N 8/39  N4 */
comment|/* Q.2971:Call-Control-N 22/39 N10 */
name|unx_add_party_rej_request
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
break|break;
block|}
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|1
argument_list|,
literal|"add-party-rej.request in cs=%s"
argument_list|,
name|callstates
index|[
name|c
operator|->
name|cstate
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_CALLSTATE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_DROP_PARTY_request
case|:
if|if
condition|(
name|c
operator|->
name|cstate
operator|!=
name|CALLST_U11
operator|&&
name|c
operator|->
name|cstate
operator|!=
name|CALLST_U12
operator|&&
name|c
operator|->
name|cstate
operator|!=
name|CALLST_N11
operator|&&
name|c
operator|->
name|cstate
operator|!=
name|CALLST_N12
operator|&&
name|c
operator|->
name|cstate
operator|!=
name|CALLST_NULL
condition|)
block|{
comment|/* Q.2971:Call-Control-U 21/39 U10 */
comment|/* Q.2971:Call-Control-U 26/39 U1-U9 */
comment|/* Q.2971:Call-Control-N 22/39 N10 */
comment|/* Q.2971:Call-Control-N 27/39 N1-N9 */
name|unx_drop_party_request
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
break|break;
block|}
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|1
argument_list|,
literal|"drop-party.request in cs=%s"
argument_list|,
name|callstates
index|[
name|c
operator|->
name|cstate
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_CALLSTATE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_DROP_PARTY_ACK_request
case|:
if|if
condition|(
name|c
operator|->
name|cstate
operator|!=
name|CALLST_U11
operator|&&
name|c
operator|->
name|cstate
operator|!=
name|CALLST_U12
operator|&&
name|c
operator|->
name|cstate
operator|!=
name|CALLST_N11
operator|&&
name|c
operator|->
name|cstate
operator|!=
name|CALLST_N12
operator|&&
name|c
operator|->
name|cstate
operator|!=
name|CALLST_NULL
condition|)
block|{
comment|/* Q.2971:Call-Control-U 21/39 U10 */
comment|/* Q.2971:Call-Control-U 26/39 U1-U9 */
comment|/* Q.2971:Call-Control-N 22/39 N10 */
comment|/* Q.2971:Call-Control-N 27/39 N1-N9 */
name|unx_drop_party_ack_request
argument_list|(
name|c
argument_list|,
name|msg
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
break|break;
block|}
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|1
argument_list|,
literal|"drop-party-ack.request in cs=%s"
argument_list|,
name|callstates
index|[
name|c
operator|->
name|cstate
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_CALLSTATE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_ABORT_CALL_request
case|:
block|{
name|struct
name|uni
modifier|*
name|uni
init|=
name|c
operator|->
name|uni
decl_stmt|;
name|uni_destroy_call
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_OK
argument_list|,
name|cookie
argument_list|,
name|UNI_CALLSTATE_U0
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* 	   * Timers 	   */
case|case
name|SIGC_T301
case|:
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U4
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N7
condition|)
block|{
comment|/* Q.2971:Call-Control-U Missing */
comment|/* Q.2971:Call-Control-N 14/39 */
name|u4n7_t301
argument_list|(
name|c
argument_list|)
expr_stmt|;
break|break;
block|}
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|1
argument_list|,
literal|"T301 in cs=%s"
argument_list|,
name|callstates
index|[
name|c
operator|->
name|cstate
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_T303
case|:
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U1
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N6
condition|)
block|{
comment|/* Q.2971:Call-Control-U 6/39 */
comment|/* Q.2971:Call-Control-N 11/39 */
name|u1n6_t303
argument_list|(
name|c
argument_list|)
expr_stmt|;
break|break;
block|}
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|1
argument_list|,
literal|"T303 in cs=%s"
argument_list|,
name|callstates
index|[
name|c
operator|->
name|cstate
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_T308
case|:
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U11
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N12
condition|)
block|{
comment|/* Q.2971:Call-Control-U 28/39 */
comment|/* Q.2971:Call-Control-N 30/39 */
name|u11n12_t308
argument_list|(
name|c
argument_list|)
expr_stmt|;
break|break;
block|}
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|1
argument_list|,
literal|"T308 in cs=%s"
argument_list|,
name|callstates
index|[
name|c
operator|->
name|cstate
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_T310
case|:
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U3
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N9
condition|)
block|{
comment|/* Q.2971:Call-Control-U 7/39 */
comment|/* Q.2971:Call-Control-N 17/39 */
name|u3n9_t310
argument_list|(
name|c
argument_list|)
expr_stmt|;
break|break;
block|}
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|1
argument_list|,
literal|"T310 in cs=%s"
argument_list|,
name|callstates
index|[
name|c
operator|->
name|cstate
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_T313
case|:
if|if
condition|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U8
condition|)
block|{
comment|/* Q.2971:Call-Control-U 15/39 */
name|u8_t313
argument_list|(
name|c
argument_list|)
expr_stmt|;
break|break;
block|}
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|1
argument_list|,
literal|"T313 in cs=%s"
argument_list|,
name|callstates
index|[
name|c
operator|->
name|cstate
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_T322
case|:
comment|/* Q.2971:Call-Control-U 34/39 */
comment|/* Q.2971:Call-Control-N 35/39 */
name|unx_t322
argument_list|(
name|c
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_CALL_DELETE
case|:
name|CALL_FREE
argument_list|(
name|c
argument_list|)
expr_stmt|;
break|break;
comment|/* 	   * Party-Control 	   */
case|case
name|SIGC_DROP_PARTY_indication
case|:
if|if
condition|(
name|c
operator|->
name|uni
operator|->
name|proto
operator|==
name|UNIPROTO_UNI40U
condition|)
comment|/* Q.2971:Call-Control-U 23/39 */
name|ux_drop_party_indication
argument_list|(
name|c
argument_list|,
name|msg
argument_list|)
expr_stmt|;
else|else
comment|/* Q.2971:Call-Control-N 23/39 */
name|nx_drop_party_indication
argument_list|(
name|c
argument_list|,
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_DROP_PARTY_ACK_indication
case|:
if|if
condition|(
name|c
operator|->
name|uni
operator|->
name|proto
operator|==
name|UNIPROTO_UNI40U
condition|)
comment|/* Q.2971:Call-Control-U 23/39 */
name|ux_drop_party_ack_indication
argument_list|(
name|c
argument_list|,
name|msg
argument_list|)
expr_stmt|;
else|else
comment|/* Q.2971:Call-Control-N 23/39 */
name|nx_drop_party_ack_indication
argument_list|(
name|c
argument_list|,
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_ADD_PARTY_REJ_indication
case|:
if|if
condition|(
name|c
operator|->
name|uni
operator|->
name|proto
operator|==
name|UNIPROTO_UNI40U
condition|)
comment|/* Q.2971:Call-Control-U 23/39 */
name|ux_add_party_rej_indication
argument_list|(
name|c
argument_list|,
name|msg
argument_list|)
expr_stmt|;
else|else
comment|/* Q.2971:Call-Control-N 23/39 */
name|nx_add_party_rej_indication
argument_list|(
name|c
argument_list|,
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_SEND_DROP_PARTY
case|:
comment|/* Q.2971:Call-Control-U 21/39 */
comment|/* Q.2971:Call-Control-U 25/39 */
if|if
condition|(
name|uni_party_act_count
argument_list|(
name|c
argument_list|,
literal|2
argument_list|)
operator|!=
literal|0
condition|)
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|u
argument_list|,
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|->
name|cstate
operator|!=
name|CALLST_U11
condition|)
block|{
name|c
operator|->
name|uni
operator|->
name|cause
operator|=
name|u
operator|->
name|u
operator|.
name|drop_party
operator|.
name|cause
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_SEND_DROP_PARTY_ACK
case|:
comment|/* Q.2971:Call-Control-U 21/39 */
comment|/* Q.2971:Call-Control-U 25/39 */
if|if
condition|(
name|uni_party_act_count
argument_list|(
name|c
argument_list|,
literal|2
argument_list|)
operator|!=
literal|0
condition|)
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|u
argument_list|,
name|c
operator|->
name|uni
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|->
name|cstate
operator|!=
name|CALLST_U11
condition|)
block|{
name|c
operator|->
name|uni
operator|->
name|cause
operator|=
name|u
operator|->
name|u
operator|.
name|drop_party_ack
operator|.
name|cause
expr_stmt|;
name|clear_callD
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_SEND_ADD_PARTY_REJ
case|:
comment|/* Q.2971:Call-Control-U 21/39 */
comment|/* Q.2971:Call-Control-U 24/39 */
name|unx_send_add_party_rej
argument_list|(
name|c
argument_list|,
name|u
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_SEND_STATUS_ENQ
case|:
comment|/* Q.2971:Call-Control-U 21/39 */
comment|/* Q.2971:Call-Control-U 25/39 */
name|unx_send_party_status_enq
argument_list|(
name|c
argument_list|,
name|u
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_PARTY_DESTROYED
case|:
name|c
operator|->
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|c
operator|->
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_PARTY_DESTROYED
argument_list|,
name|cookie
argument_list|,
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGC_END
case|:
break|break;
block|}
return|return;
name|drop
label|:
comment|/* 	 * This is for SAAL message signals that should be dropped. 	 */
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************/
end_comment

begin_comment
comment|/*  * Timeout functions  */
end_comment

begin_function
specifier|static
name|void
name|t308_func
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|)
block|{
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_T308
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|t303_func
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|)
block|{
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_T303
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|t301_func
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|)
block|{
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_T301
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|t310_func
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|)
block|{
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_T310
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|t313_func
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|)
block|{
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_T313
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|t322_func
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|)
block|{
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_T322
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************/
end_comment

begin_comment
comment|/*  * Check whether the peer state is compatible with our state.  * Return the new callstate we should go to (either U0 or the current  * state).  * None of the state is U0 here. My state is not U11 or U12.  *  * Well, this turns out to be not so easy: the status enquiry could have  * been sent before we changed into the current state - the status will  * report a previous state without anything been lost.  *  * Incoming states are incompatible with outgoing states. Everything is ok.  */
end_comment

begin_function
specifier|static
name|enum
name|call_state
name|state_compat
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|enum
name|uni_callstate
name|peer
parameter_list|)
block|{
if|if
condition|(
operator|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U1
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_U3
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_U4
operator|)
operator|&&
operator|(
name|peer
operator|==
name|UNI_CALLSTATE_N6
operator|||
name|peer
operator|==
name|UNI_CALLSTATE_N7
operator|||
name|peer
operator|==
name|UNI_CALLSTATE_N8
operator|||
name|peer
operator|==
name|UNI_CALLSTATE_N9
operator|)
condition|)
return|return
operator|(
name|CALLST_NULL
operator|)
return|;
if|if
condition|(
operator|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_N6
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N7
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N8
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N9
operator|)
operator|&&
operator|(
name|peer
operator|==
name|UNI_CALLSTATE_U1
operator|||
name|peer
operator|==
name|UNI_CALLSTATE_U3
operator|||
name|peer
operator|==
name|UNI_CALLSTATE_U4
operator|)
condition|)
return|return
operator|(
name|CALLST_NULL
operator|)
return|;
if|if
condition|(
operator|(
name|peer
operator|==
name|UNI_CALLSTATE_N1
operator|||
name|peer
operator|==
name|UNI_CALLSTATE_N3
operator|||
name|peer
operator|==
name|UNI_CALLSTATE_N4
operator|)
operator|&&
operator|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_U6
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_U7
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_U8
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N9
operator|)
condition|)
return|return
operator|(
name|CALLST_NULL
operator|)
return|;
if|if
condition|(
operator|(
name|peer
operator|==
name|UNI_CALLSTATE_U6
operator|||
name|peer
operator|==
name|UNI_CALLSTATE_U7
operator|||
name|peer
operator|==
name|UNI_CALLSTATE_U8
operator|||
name|peer
operator|==
name|UNI_CALLSTATE_U9
operator|)
operator|&&
operator|(
name|c
operator|->
name|cstate
operator|==
name|CALLST_N1
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N3
operator|||
name|c
operator|->
name|cstate
operator|==
name|CALLST_N4
operator|)
condition|)
return|return
operator|(
name|CALLST_NULL
operator|)
return|;
return|return
operator|(
name|c
operator|->
name|cstate
operator|)
return|;
block|}
end_function

end_unit


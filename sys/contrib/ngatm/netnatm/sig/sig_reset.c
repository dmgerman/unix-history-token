begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1996-2003  *	Fraunhofer Institute for Open Communication Systems (FhG Fokus).  * 	All rights reserved.  *  * Author: Hartmut Brandt<harti@freebsd.org>  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * $Begemot: libunimsg/netnatm/sig/sig_reset.c,v 1.11 2004/08/05 07:11:03 brandt Exp $  *  * Reset-start and reset-respond  */
end_comment

begin_include
include|#
directive|include
file|<netnatm/unimsg.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/saal/sscfudef.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/msg/unistruct.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/msg/unimsglib.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/sig/uni.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/sig/unipriv.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/sig/unimkmsg.h>
end_include

begin_function_decl
specifier|static
name|void
name|response_restart
parameter_list|(
name|struct
name|uni
modifier|*
parameter_list|,
name|struct
name|uni_msg
modifier|*
parameter_list|,
name|struct
name|uni_all
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|response_status
parameter_list|(
name|struct
name|uni
modifier|*
parameter_list|,
name|struct
name|uni_msg
modifier|*
parameter_list|,
name|struct
name|uni_all
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|response_t317
parameter_list|(
name|struct
name|uni
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|response_error
parameter_list|(
name|struct
name|uni
modifier|*
parameter_list|,
name|struct
name|uniapi_reset_error_response
modifier|*
parameter_list|,
name|uint32_t
name|cookie
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|response_response
parameter_list|(
name|struct
name|uni
modifier|*
parameter_list|,
name|struct
name|uniapi_reset_response
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|start_request
parameter_list|(
name|struct
name|uni
modifier|*
parameter_list|,
name|struct
name|uniapi_reset_request
modifier|*
parameter_list|,
name|uint32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|start_t316
parameter_list|(
name|struct
name|uni
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|start_restart_ack
parameter_list|(
name|struct
name|uni
modifier|*
parameter_list|,
name|struct
name|uni_msg
modifier|*
parameter_list|,
name|struct
name|uni_all
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|start_status
parameter_list|(
name|struct
name|uni
modifier|*
parameter_list|,
name|struct
name|uni_msg
modifier|*
parameter_list|,
name|struct
name|uni_all
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|restart_forward
parameter_list|(
name|struct
name|uni
modifier|*
parameter_list|,
specifier|const
name|struct
name|uni_all
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|DEF_PRIV_SIG
parameter_list|(
name|NAME
parameter_list|,
name|FROM
parameter_list|)
value|[SIG##NAME] =	"SIG"#NAME,
end_define

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|start_sigs
index|[]
init|=
block|{
name|DEF_START_SIGS
block|}
decl_stmt|;
end_decl_stmt

begin_undef
undef|#
directive|undef
name|DEF_PRIV_SIG
end_undef

begin_define
define|#
directive|define
name|DEF_PRIV_SIG
parameter_list|(
name|NAME
parameter_list|,
name|FROM
parameter_list|)
value|[SIG##NAME] =	"SIG"#NAME,
end_define

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|respond_sigs
index|[]
init|=
block|{
name|DEF_RESPOND_SIGS
block|}
decl_stmt|;
end_decl_stmt

begin_undef
undef|#
directive|undef
name|DEF_PRIV_SIG
end_undef

begin_macro
name|TIMER_FUNC_UNI
argument_list|(
argument|t317
argument_list|,
argument|t317_func
argument_list|)
end_macro

begin_macro
name|TIMER_FUNC_UNI
argument_list|(
argument|t316
argument_list|,
argument|t316_func
argument_list|)
end_macro

begin_comment
comment|/*  * Reset-Start process.  */
end_comment

begin_function
name|void
name|uni_sig_start
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|u_int
name|sig
parameter_list|,
name|uint32_t
name|cookie
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
block|{
if|if
condition|(
name|sig
operator|>=
name|SIGS_END
condition|)
block|{
name|VERBOSE
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|1
argument_list|,
literal|"Signal %d outside of range to "
literal|"Reset-Start"
argument_list|,
name|sig
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
condition|)
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
condition|)
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
return|return;
block|}
name|VERBOSE
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_RESTART
argument_list|,
literal|1
argument_list|,
literal|"Signal %s in state %u of Reset-Start; cookie %u"
argument_list|,
name|start_sigs
index|[
name|sig
index|]
argument_list|,
name|uni
operator|->
name|glob_start
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sig
condition|)
block|{
comment|/* 	 * User requests 	 */
case|case
name|SIGS_RESET_request
case|:
name|start_request
argument_list|(
name|uni
argument_list|,
name|uni_msg_rptr
argument_list|(
name|m
argument_list|,
expr|struct
name|uniapi_reset_request
operator|*
argument_list|)
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
break|break;
comment|/* 	 * Timers 	 */
case|case
name|SIGS_T316
case|:
name|start_t316
argument_list|(
name|uni
argument_list|)
expr_stmt|;
break|break;
comment|/* 	 * SAAL 	 */
case|case
name|SIGS_RESTART_ACK
case|:
name|start_restart_ack
argument_list|(
name|uni
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGS_STATUS
case|:
name|start_status
argument_list|(
name|uni
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGS_END
case|:
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * Reset-request from USER.  *  * Q.2931:Reset-Start 1/2  */
end_comment

begin_function
specifier|static
name|void
name|start_request
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|struct
name|uniapi_reset_request
modifier|*
name|req
parameter_list|,
name|uint32_t
name|cookie
parameter_list|)
block|{
name|struct
name|uni_all
modifier|*
name|resp
decl_stmt|;
name|int
name|err
decl_stmt|;
if|if
condition|(
name|uni
operator|->
name|glob_start
operator|!=
name|UNI_CALLSTATE_REST0
condition|)
block|{
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_BAD_CALLSTATE
argument_list|,
name|cookie
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|resp
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|==
name|NULL
condition|)
block|{
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_NOMEM
argument_list|,
name|cookie
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|MK_MSG_ORIG
argument_list|(
name|resp
argument_list|,
name|UNI_RESTART
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|resp
operator|->
name|u
operator|.
name|restart
operator|.
name|restart
operator|=
name|req
operator|->
name|restart
expr_stmt|;
name|resp
operator|->
name|u
operator|.
name|restart
operator|.
name|connid
operator|=
name|req
operator|->
name|connid
expr_stmt|;
if|if
condition|(
name|restart_forward
argument_list|(
name|uni
argument_list|,
name|resp
argument_list|)
condition|)
return|return;
name|uni
operator|->
name|connid_start
operator|=
name|req
operator|->
name|connid
expr_stmt|;
name|uni
operator|->
name|restart_start
operator|=
name|req
operator|->
name|restart
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|uni_send_output
argument_list|(
name|resp
argument_list|,
name|uni
argument_list|)
operator|)
operator|!=
literal|0
condition|)
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_ENCODING
argument_list|,
name|cookie
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|resp
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return;
name|uni
operator|->
name|cnt316
operator|=
literal|0
expr_stmt|;
name|TIMER_START_UNI
argument_list|(
name|uni
argument_list|,
name|t316
argument_list|,
name|uni
operator|->
name|timer316
argument_list|)
expr_stmt|;
name|uni
operator|->
name|glob_start
operator|=
name|UNI_CALLSTATE_REST1
expr_stmt|;
name|VERBOSE
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_RESTART
argument_list|,
literal|1
argument_list|,
literal|"Reset-Start state := 1"
argument_list|)
expr_stmt|;
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_OK
argument_list|,
name|cookie
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * T316 timeout function  */
end_comment

begin_function
specifier|static
name|void
name|t316_func
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|)
block|{
name|uni_enq_start
argument_list|(
name|uni
argument_list|,
name|SIGS_T316
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Q.2931:Reset-Start 1/2  */
end_comment

begin_function
specifier|static
name|void
name|start_t316
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|)
block|{
if|if
condition|(
name|uni
operator|->
name|glob_start
operator|!=
name|UNI_CALLSTATE_REST1
condition|)
block|{
name|VERBOSE0
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|"T316 in state %d"
argument_list|,
name|uni
operator|->
name|glob_start
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|++
name|uni
operator|->
name|cnt316
operator|==
name|uni
operator|->
name|init316
condition|)
block|{
name|struct
name|uni_msg
modifier|*
name|app
decl_stmt|;
name|struct
name|uniapi_reset_error_indication
modifier|*
name|resp
decl_stmt|;
name|VERBOSE
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_RESTART
argument_list|,
literal|1
argument_list|,
literal|"Reset-Start error"
argument_list|)
expr_stmt|;
name|resp
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_reset_error_indication
argument_list|,
name|app
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|!=
name|NULL
condition|)
block|{
name|resp
operator|->
name|source
operator|=
literal|0
expr_stmt|;
name|resp
operator|->
name|reason
operator|=
name|UNIAPI_RESET_ERROR_NO_RESPONSE
operator|,
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|uni
argument_list|,
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_RESET_ERROR_indication
argument_list|,
literal|0
argument_list|,
name|app
argument_list|)
expr_stmt|;
block|}
name|uni
operator|->
name|glob_start
operator|=
name|UNI_CALLSTATE_REST0
expr_stmt|;
name|VERBOSE
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_RESTART
argument_list|,
literal|1
argument_list|,
literal|"Reset-Start state := 0"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|uni_all
modifier|*
name|resp
decl_stmt|;
if|if
condition|(
operator|(
name|resp
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|==
name|NULL
condition|)
return|return;
name|MK_MSG_ORIG
argument_list|(
name|resp
argument_list|,
name|UNI_RESTART
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|resp
operator|->
name|u
operator|.
name|restart
operator|.
name|restart
operator|=
name|uni
operator|->
name|restart_start
expr_stmt|;
name|resp
operator|->
name|u
operator|.
name|restart
operator|.
name|connid
operator|=
name|uni
operator|->
name|connid_start
expr_stmt|;
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|resp
argument_list|,
name|uni
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|resp
argument_list|)
expr_stmt|;
name|TIMER_START_UNI
argument_list|(
name|uni
argument_list|,
name|t316
argument_list|,
name|uni
operator|->
name|timer316
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Got RESTART_ACK.  */
end_comment

begin_function
specifier|static
name|void
name|start_restart_ack
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
block|{
name|enum
name|uni_callstate
name|new_state
decl_stmt|;
name|struct
name|uniapi_reset_confirm
modifier|*
name|conf
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|app
decl_stmt|;
if|if
condition|(
name|uni
operator|->
name|glob_start
operator|==
name|UNI_CALLSTATE_REST0
condition|)
block|{
name|uni_respond_status_mtype
argument_list|(
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|uni
operator|->
name|glob_start
argument_list|,
name|UNI_CAUSE_MSG_INCOMP
argument_list|,
name|UNI_RESTART_ACK
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|uni
operator|->
name|glob_start
operator|!=
name|UNI_CALLSTATE_REST1
condition|)
block|{
name|ASSERT
argument_list|(
literal|0
argument_list|,
operator|(
literal|"bad global call state in Reset-Start"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * If body decoding fails, this is because IEs are wrong. 	 */
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|m
argument_list|,
name|u
argument_list|,
operator|&
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
name|MANDATE_IE
argument_list|(
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|restart_ack
operator|.
name|restart
argument_list|,
name|UNI_IE_RESTART
argument_list|)
expr_stmt|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|restart_ack
operator|.
name|restart
argument_list|)
condition|)
block|{
comment|/* 		 * Q.2931: 5.5.2.2 		 */
if|if
condition|(
name|u
operator|->
name|u
operator|.
name|restart_ack
operator|.
name|restart
operator|.
name|rclass
operator|==
name|UNI_RESTART_ALL
operator|&&
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|restart_ack
operator|.
name|connid
argument_list|)
condition|)
block|{
name|UNI_SAVE_IERR
argument_list|(
operator|&
name|uni
operator|->
name|cx
argument_list|,
name|UNI_IE_CONNID
argument_list|,
name|u
operator|->
name|u
operator|.
name|restart_ack
operator|.
name|connid
operator|.
name|h
operator|.
name|act
argument_list|,
name|UNI_IERR_UNK
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|u
operator|->
name|u
operator|.
name|restart_ack
operator|.
name|restart
operator|.
name|rclass
operator|==
name|UNI_RESTART_PATH
operator|||
name|u
operator|->
name|u
operator|.
name|restart_ack
operator|.
name|restart
operator|.
name|rclass
operator|==
name|UNI_RESTART_CHANNEL
operator|)
condition|)
block|{
name|MANDATE_IE
argument_list|(
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|restart_ack
operator|.
name|connid
argument_list|,
name|UNI_IE_CONNID
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * Compare the information elements now, because 	 * we may need the new callstate for the status message 	 * below. 	 */
name|new_state
operator|=
name|UNI_CALLSTATE_REST1
expr_stmt|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|restart_ack
operator|.
name|restart
argument_list|)
operator|&&
name|IE_ISGOOD
argument_list|(
name|uni
operator|->
name|restart_start
argument_list|)
operator|&&
name|u
operator|->
name|u
operator|.
name|restart_ack
operator|.
name|restart
operator|.
name|rclass
operator|==
name|uni
operator|->
name|restart_start
operator|.
name|rclass
operator|&&
operator|!
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|restart_ack
operator|.
name|connid
argument_list|)
operator|==
operator|!
name|IE_ISGOOD
argument_list|(
name|uni
operator|->
name|connid_start
argument_list|)
operator|&&
operator|(
operator|!
name|IE_ISGOOD
argument_list|(
name|uni
operator|->
name|connid_start
argument_list|)
operator|||
operator|(
name|u
operator|->
name|u
operator|.
name|restart_ack
operator|.
name|connid
operator|.
name|vpci
operator|==
name|uni
operator|->
name|connid_start
operator|.
name|vpci
operator|&&
name|u
operator|->
name|u
operator|.
name|restart_ack
operator|.
name|connid
operator|.
name|vci
operator|==
name|uni
operator|->
name|connid_start
operator|.
name|vci
operator|)
operator|)
condition|)
name|new_state
operator|=
name|UNI_CALLSTATE_REST0
expr_stmt|;
switch|switch
condition|(
name|uni_verify
argument_list|(
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
argument_list|)
condition|)
block|{
case|case
name|VFY_RAIM
case|:
case|case
name|VFY_RAI
case|:
name|uni_respond_status_verify
argument_list|(
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|UNI_CALLSTATE_REST1
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
case|case
name|VFY_I
case|:
return|return;
case|case
name|VFY_CLR
case|:
name|uni
operator|->
name|glob_start
operator|=
name|UNI_CALLSTATE_REST0
expr_stmt|;
name|VERBOSE
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_RESTART
argument_list|,
literal|1
argument_list|,
literal|"Reset-Start state := 0"
argument_list|)
expr_stmt|;
return|return;
case|case
name|VFY_RAP
case|:
case|case
name|VFY_RAPU
case|:
name|uni_respond_status_verify
argument_list|(
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|new_state
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
case|case
name|VFY_OK
case|:
break|break;
block|}
if|if
condition|(
name|new_state
operator|==
name|UNI_CALLSTATE_REST1
condition|)
comment|/* 		 * Q.2931: 5.5.1.2/2 		 */
return|return;
comment|/* 	 * Build restart.confirm signal for application 	 */
if|if
condition|(
operator|!
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|restart_ack
operator|.
name|connid
argument_list|)
condition|)
name|u
operator|->
name|u
operator|.
name|restart
operator|.
name|connid
operator|.
name|h
operator|.
name|present
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|conf
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_reset_confirm
argument_list|,
name|app
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
name|conf
operator|->
name|restart
operator|=
name|u
operator|->
name|u
operator|.
name|restart
operator|.
name|restart
expr_stmt|;
name|conf
operator|->
name|connid
operator|=
name|u
operator|->
name|u
operator|.
name|restart
operator|.
name|connid
expr_stmt|;
name|TIMER_STOP_UNI
argument_list|(
name|uni
argument_list|,
name|t316
argument_list|)
expr_stmt|;
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|uni
argument_list|,
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_RESET_confirm
argument_list|,
literal|0
argument_list|,
name|app
argument_list|)
expr_stmt|;
name|uni
operator|->
name|glob_start
operator|=
name|UNI_CALLSTATE_REST0
expr_stmt|;
name|VERBOSE
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_RESTART
argument_list|,
literal|1
argument_list|,
literal|"Reset-Start state := 0"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Reset-Start got a STATUS message.  *  * Q.2931: Reset-Start 2/2  *  * In Q.2931 only CALLSTATE_REST1 is allowed, this seems silly and to contradict  * 5.6.12. So allow it in any state.  *  * The following states are considered compatible:  *  *  Sender   Receiver(we)  *  ------   --------  *  Rest0     Rest0	this is the normal state OK!  *  Rest2     Rest0	this may be the result of no answer from the API  *			on the remote end and the us finally timing out. ERROR!  *  Rest2     Rest1	this is normal. OK!  *  Rest0     Rest1	RESTART_ACK was probably lost. OK!  *  * All others are wrong.  */
end_comment

begin_function
specifier|static
name|void
name|start_status
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
block|{
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|m
argument_list|,
name|u
argument_list|,
operator|&
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
name|MANDATE_IE
argument_list|(
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
argument_list|,
name|UNI_IE_CALLSTATE
argument_list|)
expr_stmt|;
name|MANDATE_IE
argument_list|(
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|cause
argument_list|,
name|UNI_IE_CAUSE
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|uni_verify
argument_list|(
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
argument_list|)
condition|)
block|{
case|case
name|VFY_CLR
case|:
name|uni
operator|->
name|glob_start
operator|=
name|UNI_CALLSTATE_REST0
expr_stmt|;
name|VERBOSE
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_RESTART
argument_list|,
literal|1
argument_list|,
literal|"Reset-Start state := 0"
argument_list|)
expr_stmt|;
return|return;
case|case
name|VFY_RAIM
case|:
case|case
name|VFY_RAI
case|:
case|case
name|VFY_RAP
case|:
case|case
name|VFY_RAPU
case|:
name|uni_respond_status_verify
argument_list|(
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|uni
operator|->
name|glob_start
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
case|case
name|VFY_I
case|:
case|case
name|VFY_OK
case|:
break|break;
block|}
if|if
condition|(
operator|!
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
argument_list|)
condition|)
block|{
comment|/* 		 * As a result of the strange handling above, we must 		 * process a STATUS with an invalid or missing callstate! 		 */
return|return;
block|}
if|if
condition|(
operator|(
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
operator|.
name|state
operator|==
name|UNI_CALLSTATE_REST0
operator|&&
name|uni
operator|->
name|glob_start
operator|==
name|UNI_CALLSTATE_REST0
operator|)
operator|||
operator|(
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
operator|.
name|state
operator|==
name|UNI_CALLSTATE_REST0
operator|&&
name|uni
operator|->
name|glob_start
operator|==
name|UNI_CALLSTATE_REST1
operator|)
operator|||
operator|(
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
operator|.
name|state
operator|==
name|UNI_CALLSTATE_REST2
operator|&&
name|uni
operator|->
name|glob_start
operator|==
name|UNI_CALLSTATE_REST1
operator|)
condition|)
block|{
comment|/* 		 * Implementation dependend procedure: 		 * Inform the API 		 */
name|struct
name|uniapi_reset_status_indication
modifier|*
name|resp
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|app
decl_stmt|;
name|resp
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_reset_status_indication
argument_list|,
name|app
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
return|return;
name|resp
operator|->
name|cref
operator|=
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
expr_stmt|;
name|resp
operator|->
name|callstate
operator|=
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
expr_stmt|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|cause
argument_list|)
condition|)
name|resp
operator|->
name|cause
operator|=
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|cause
expr_stmt|;
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|uni
argument_list|,
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_RESET_STATUS_indication
argument_list|,
literal|0
argument_list|,
name|app
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|uniapi_reset_error_indication
modifier|*
name|resp
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|app
decl_stmt|;
name|resp
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_reset_error_indication
argument_list|,
name|app
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|!=
name|NULL
condition|)
block|{
name|resp
operator|->
name|source
operator|=
literal|0
expr_stmt|;
name|resp
operator|->
name|reason
operator|=
name|UNIAPI_RESET_ERROR_PEER_INCOMP_STATE
operator|,
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|uni
argument_list|,
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_RESET_ERROR_indication
argument_list|,
literal|0
argument_list|,
name|app
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/************************************************************/
end_comment

begin_comment
comment|/*  * Reset-Respond process.  */
end_comment

begin_function
name|void
name|uni_sig_respond
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|u_int
name|sig
parameter_list|,
name|uint32_t
name|cookie
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
block|{
if|if
condition|(
name|sig
operator|>=
name|SIGR_END
condition|)
block|{
name|VERBOSE
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|1
argument_list|,
literal|"Signal %d outside of range to "
literal|"Reset-Respond"
argument_list|,
name|sig
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
condition|)
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
condition|)
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
return|return;
block|}
name|VERBOSE
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_RESTART
argument_list|,
literal|1
argument_list|,
literal|"Signal %s in state %u of Reset-Respond; cookie %u"
argument_list|,
name|respond_sigs
index|[
name|sig
index|]
argument_list|,
name|uni
operator|->
name|glob_respond
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sig
condition|)
block|{
comment|/* 	 * SAAL 	 */
case|case
name|SIGR_RESTART
case|:
name|response_restart
argument_list|(
name|uni
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGR_STATUS
case|:
name|response_status
argument_list|(
name|uni
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
break|break;
comment|/* 	 * User 	 */
case|case
name|SIGR_RESET_ERROR_response
case|:
name|response_error
argument_list|(
name|uni
argument_list|,
name|uni_msg_rptr
argument_list|(
name|m
argument_list|,
expr|struct
name|uniapi_reset_error_response
operator|*
argument_list|)
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGR_RESET_response
case|:
name|response_response
argument_list|(
name|uni
argument_list|,
name|uni_msg_rptr
argument_list|(
name|m
argument_list|,
expr|struct
name|uniapi_reset_response
operator|*
argument_list|)
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
break|break;
comment|/* 	 * Timers 	 */
case|case
name|SIGR_T317
case|:
name|response_t317
argument_list|(
name|uni
argument_list|)
expr_stmt|;
return|return;
case|case
name|SIGR_END
case|:
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * Send a RELEASE_COMPLETE to all affected calls as per  * F.2.3(3)  */
end_comment

begin_function
specifier|static
name|int
name|restart_forward
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
specifier|const
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
block|{
name|struct
name|call
modifier|*
name|c
decl_stmt|;
name|struct
name|uni_all
modifier|*
name|resp
decl_stmt|;
if|if
condition|(
operator|(
name|resp
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|TAILQ_FOREACH
argument_list|(
argument|c
argument_list|,
argument|&uni->calls
argument_list|,
argument|link
argument_list|)
block|{
if|if
condition|(
name|u
operator|->
name|u
operator|.
name|restart
operator|.
name|restart
operator|.
name|rclass
operator|==
name|UNI_RESTART_ALL
operator|||
operator|(
name|IE_ISPRESENT
argument_list|(
name|c
operator|->
name|connid
argument_list|)
operator|&&
name|u
operator|->
name|u
operator|.
name|restart
operator|.
name|connid
operator|.
name|vpci
operator|==
name|c
operator|->
name|connid
operator|.
name|vpci
operator|&&
operator|(
name|u
operator|->
name|u
operator|.
name|restart
operator|.
name|restart
operator|.
name|rclass
operator|==
name|UNI_RESTART_PATH
operator|||
name|u
operator|->
name|u
operator|.
name|restart
operator|.
name|connid
operator|.
name|vci
operator|==
name|c
operator|->
name|connid
operator|.
name|vci
operator|)
operator|)
condition|)
block|{
name|MK_MSG_ORIG
argument_list|(
name|resp
argument_list|,
name|UNI_RELEASE_COMPL
argument_list|,
name|c
operator|->
name|cref
argument_list|,
name|c
operator|->
name|mine
argument_list|)
expr_stmt|;
name|uni_release_compl
argument_list|(
name|c
argument_list|,
name|resp
argument_list|)
expr_stmt|;
block|}
block|}
name|UNI_FREE
argument_list|(
name|resp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Respond process got a restart message.  * Doesn't free the messages.  */
end_comment

begin_function
specifier|static
name|void
name|response_restart
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
block|{
name|struct
name|uni_msg
modifier|*
name|app
decl_stmt|;
name|struct
name|uniapi_reset_indication
modifier|*
name|ind
decl_stmt|;
if|if
condition|(
name|uni
operator|->
name|glob_respond
operator|==
name|UNI_CALLSTATE_REST0
condition|)
block|{
comment|/* 		 * If body decoding fails, this is because IEs are wrong. 		 */
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|m
argument_list|,
name|u
argument_list|,
operator|&
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
name|MANDATE_IE
argument_list|(
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|restart
operator|.
name|restart
argument_list|,
name|UNI_IE_RESTART
argument_list|)
expr_stmt|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|restart
operator|.
name|restart
argument_list|)
condition|)
block|{
comment|/* 			 * Q.2931: 5.5.2.2 			 */
if|if
condition|(
name|u
operator|->
name|u
operator|.
name|restart
operator|.
name|restart
operator|.
name|rclass
operator|==
name|UNI_RESTART_ALL
operator|&&
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|restart
operator|.
name|connid
argument_list|)
condition|)
block|{
name|UNI_SAVE_IERR
argument_list|(
operator|&
name|uni
operator|->
name|cx
argument_list|,
name|UNI_IE_CONNID
argument_list|,
name|u
operator|->
name|u
operator|.
name|restart
operator|.
name|connid
operator|.
name|h
operator|.
name|act
argument_list|,
name|UNI_IERR_UNK
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|u
operator|->
name|u
operator|.
name|restart
operator|.
name|restart
operator|.
name|rclass
operator|==
name|UNI_RESTART_PATH
operator|||
name|u
operator|->
name|u
operator|.
name|restart
operator|.
name|restart
operator|.
name|rclass
operator|==
name|UNI_RESTART_CHANNEL
operator|)
condition|)
block|{
name|MANDATE_IE
argument_list|(
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|restart
operator|.
name|connid
argument_list|,
name|UNI_IE_CONNID
argument_list|)
expr_stmt|;
block|}
block|}
switch|switch
condition|(
name|uni_verify
argument_list|(
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
argument_list|)
condition|)
block|{
case|case
name|VFY_RAIM
case|:
case|case
name|VFY_RAI
case|:
name|uni_respond_status_verify
argument_list|(
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|UNI_CALLSTATE_REST0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
case|case
name|VFY_CLR
case|:
case|case
name|VFY_I
case|:
return|return;
case|case
name|VFY_RAP
case|:
case|case
name|VFY_RAPU
case|:
name|uni_respond_status_verify
argument_list|(
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|UNI_CALLSTATE_REST2
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
case|case
name|VFY_OK
case|:
break|break;
block|}
if|if
condition|(
operator|!
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|restart
operator|.
name|connid
argument_list|)
condition|)
name|u
operator|->
name|u
operator|.
name|restart
operator|.
name|connid
operator|.
name|h
operator|.
name|present
operator|=
literal|0
expr_stmt|;
comment|/* 		 * Send a RELEASE_COMPLETE to all affected calls as per 		 * F.2.3(3) 		 */
if|if
condition|(
name|restart_forward
argument_list|(
name|uni
argument_list|,
name|u
argument_list|)
condition|)
return|return;
comment|/* 		 * Build restart signal for application 		 */
if|if
condition|(
operator|(
name|ind
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_reset_indication
argument_list|,
name|app
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
name|ind
operator|->
name|restart
operator|=
name|u
operator|->
name|u
operator|.
name|restart
operator|.
name|restart
expr_stmt|;
name|ind
operator|->
name|connid
operator|=
name|u
operator|->
name|u
operator|.
name|restart
operator|.
name|connid
expr_stmt|;
name|uni_enq_coord
argument_list|(
name|uni
argument_list|,
name|SIGO_RESET_indication
argument_list|,
literal|0
argument_list|,
name|app
argument_list|)
expr_stmt|;
name|TIMER_START_UNI
argument_list|(
name|uni
argument_list|,
name|t317
argument_list|,
name|uni
operator|->
name|timer317
argument_list|)
expr_stmt|;
name|uni
operator|->
name|glob_respond
operator|=
name|UNI_CALLSTATE_REST2
expr_stmt|;
name|VERBOSE
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_RESTART
argument_list|,
literal|1
argument_list|,
literal|"Reset-Respond state := 2"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|uni
operator|->
name|glob_respond
operator|==
name|UNI_CALLSTATE_REST2
condition|)
block|{
comment|/* 		 * No need to decode the message. It is unexpected in this 		 * state so return a status. 		 */
name|uni_respond_status_mtype
argument_list|(
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|uni
operator|->
name|glob_respond
argument_list|,
name|UNI_CAUSE_MSG_INCOMP
argument_list|,
name|UNI_RESTART
argument_list|)
expr_stmt|;
block|}
else|else
name|ASSERT
argument_list|(
literal|0
argument_list|,
operator|(
literal|"bad global call state in responder"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|response_t317
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|)
block|{
name|struct
name|uniapi_reset_error_indication
modifier|*
name|resp
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|app
decl_stmt|;
if|if
condition|(
name|uni
operator|->
name|glob_respond
operator|!=
name|UNI_CALLSTATE_REST2
condition|)
block|{
name|VERBOSE0
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|"T317 in state %d"
argument_list|,
name|uni
operator|->
name|glob_respond
argument_list|)
expr_stmt|;
return|return;
block|}
name|VERBOSE
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_RESTART
argument_list|,
literal|1
argument_list|,
literal|"Reset-Respond error"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|resp
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_reset_error_indication
argument_list|,
name|app
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|resp
operator|->
name|source
operator|=
literal|1
expr_stmt|;
name|resp
operator|->
name|reason
operator|=
name|UNIAPI_RESET_ERROR_NO_CONFIRM
expr_stmt|;
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|uni
argument_list|,
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_RESET_ERROR_indication
argument_list|,
literal|0
argument_list|,
name|app
argument_list|)
expr_stmt|;
block|}
name|uni
operator|->
name|glob_respond
operator|=
name|UNI_CALLSTATE_REST0
expr_stmt|;
name|VERBOSE
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_RESTART
argument_list|,
literal|1
argument_list|,
literal|"Reset-Respond state := 0"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Error response from USER  */
end_comment

begin_function
specifier|static
name|void
name|response_error
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|struct
name|uniapi_reset_error_response
modifier|*
name|c
parameter_list|,
name|uint32_t
name|cookie
parameter_list|)
block|{
name|struct
name|uni_all
modifier|*
name|resp
decl_stmt|;
if|if
condition|(
name|uni
operator|->
name|glob_respond
operator|!=
name|UNI_CALLSTATE_REST2
condition|)
block|{
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_BAD_CALLSTATE
argument_list|,
name|cookie
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|resp
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|==
name|NULL
condition|)
block|{
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_NOMEM
argument_list|,
name|cookie
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|MK_MSG_ORIG
argument_list|(
name|resp
argument_list|,
name|UNI_STATUS
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|MK_IE_CALLSTATE
argument_list|(
name|resp
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
argument_list|,
name|UNI_CALLSTATE_REST2
argument_list|)
expr_stmt|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|c
operator|->
name|cause
argument_list|)
condition|)
name|resp
operator|->
name|u
operator|.
name|status
operator|.
name|cause
operator|=
name|c
operator|->
name|cause
expr_stmt|;
else|else
block|{
name|MK_IE_CAUSE
argument_list|(
name|resp
operator|->
name|u
operator|.
name|status
operator|.
name|cause
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|UNI_CAUSE_CHANNEL_NEX
argument_list|)
expr_stmt|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|uni
operator|->
name|connid_respond
argument_list|)
condition|)
name|ADD_CAUSE_CHANNID
argument_list|(
name|resp
operator|->
name|u
operator|.
name|status
operator|.
name|cause
argument_list|,
name|uni
operator|->
name|connid_respond
operator|.
name|vpci
argument_list|,
name|uni
operator|->
name|connid_respond
operator|.
name|vci
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|uni_send_output
argument_list|(
name|resp
argument_list|,
name|uni
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_ENCODING
argument_list|,
name|cookie
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|resp
argument_list|)
expr_stmt|;
return|return;
block|}
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_OK
argument_list|,
name|cookie
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Reset-response from user.  */
end_comment

begin_function
specifier|static
name|void
name|response_response
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|struct
name|uniapi_reset_response
modifier|*
name|arg
parameter_list|,
name|uint32_t
name|cookie
parameter_list|)
block|{
name|struct
name|uni_all
modifier|*
name|resp
decl_stmt|;
if|if
condition|(
name|uni
operator|->
name|glob_respond
operator|!=
name|UNI_CALLSTATE_REST2
condition|)
block|{
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_BAD_CALLSTATE
argument_list|,
name|cookie
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|IE_ISGOOD
argument_list|(
name|arg
operator|->
name|restart
argument_list|)
condition|)
block|{
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_MISSING_IE
argument_list|,
name|cookie
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|resp
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|==
name|NULL
condition|)
block|{
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_NOMEM
argument_list|,
name|cookie
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|TIMER_STOP_UNI
argument_list|(
name|uni
argument_list|,
name|t317
argument_list|)
expr_stmt|;
name|MK_MSG_ORIG
argument_list|(
name|resp
argument_list|,
name|UNI_RESTART_ACK
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|resp
operator|->
name|u
operator|.
name|restart
operator|.
name|restart
operator|=
name|arg
operator|->
name|restart
expr_stmt|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|arg
operator|->
name|connid
argument_list|)
condition|)
name|resp
operator|->
name|u
operator|.
name|restart
operator|.
name|connid
operator|=
name|arg
operator|->
name|connid
expr_stmt|;
if|if
condition|(
name|uni_send_output
argument_list|(
name|resp
argument_list|,
name|uni
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_ENCODING
argument_list|,
name|cookie
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|resp
argument_list|)
expr_stmt|;
return|return;
block|}
name|UNI_FREE
argument_list|(
name|resp
argument_list|)
expr_stmt|;
name|uni
operator|->
name|glob_respond
operator|=
name|UNI_CALLSTATE_REST0
expr_stmt|;
name|VERBOSE
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_RESTART
argument_list|,
literal|1
argument_list|,
literal|"Reset-Respond state := 0"
argument_list|)
expr_stmt|;
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_OK
argument_list|,
name|cookie
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Reset-Response got a STATUS message.  *  * Q.2931: Reset-Response 2/2  *  * In Q.2931 only CALLSTATE_REST2 is allowed, this seems silly and to contradict  * 5.6.12. So allow it in any state.  *  * The following states are considered compatible:  *  *  Sender   Receiver  *  ------   --------  *  Rest0     Rest0	this is the normal state OK!  *  Rest0     Rest2	this may be the result of no answer from the API  *			and the Sender finally timing out. ERROR!  *  Rest1     Rest2	this is normal. OK!  *  Rest1     Rest0	RESTART_ACK was probably lost. OK!  *  * All others are wrong.  */
end_comment

begin_function
specifier|static
name|void
name|response_status
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
block|{
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|m
argument_list|,
name|u
argument_list|,
operator|&
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
name|MANDATE_IE
argument_list|(
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
argument_list|,
name|UNI_IE_CALLSTATE
argument_list|)
expr_stmt|;
name|MANDATE_IE
argument_list|(
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|cause
argument_list|,
name|UNI_IE_CAUSE
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|uni_verify
argument_list|(
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|act
argument_list|)
condition|)
block|{
case|case
name|VFY_CLR
case|:
if|if
condition|(
name|uni
operator|->
name|proto
operator|==
name|UNIPROTO_UNI40U
condition|)
block|{
name|uni
operator|->
name|glob_respond
operator|=
name|UNI_CALLSTATE_REST0
expr_stmt|;
name|VERBOSE
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_RESTART
argument_list|,
literal|1
argument_list|,
literal|"Reset-Respond state := 0"
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
case|case
name|VFY_RAIM
case|:
case|case
name|VFY_RAI
case|:
case|case
name|VFY_RAP
case|:
case|case
name|VFY_RAPU
case|:
name|uni_respond_status_verify
argument_list|(
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|uni
operator|->
name|glob_respond
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
case|case
name|VFY_I
case|:
case|case
name|VFY_OK
case|:
break|break;
block|}
if|if
condition|(
operator|!
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
argument_list|)
condition|)
block|{
comment|/* 		 * As a result of the strange handling above, we must 		 * process a STATUS with an invalid or missing callstate! 		 */
return|return;
block|}
if|if
condition|(
operator|(
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
operator|.
name|state
operator|==
name|UNI_CALLSTATE_REST0
operator|&&
name|uni
operator|->
name|glob_respond
operator|==
name|UNI_CALLSTATE_REST0
operator|)
operator|||
operator|(
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
operator|.
name|state
operator|==
name|UNI_CALLSTATE_REST1
operator|&&
name|uni
operator|->
name|glob_respond
operator|==
name|UNI_CALLSTATE_REST0
operator|)
operator|||
operator|(
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
operator|.
name|state
operator|==
name|UNI_CALLSTATE_REST1
operator|&&
name|uni
operator|->
name|glob_respond
operator|==
name|UNI_CALLSTATE_REST2
operator|)
condition|)
block|{
comment|/* 		 * Implementation dependend procedure: 		 * Inform the API 		 */
name|struct
name|uniapi_reset_status_indication
modifier|*
name|resp
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|app
decl_stmt|;
name|resp
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_reset_status_indication
argument_list|,
name|app
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
return|return;
name|resp
operator|->
name|cref
operator|=
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
expr_stmt|;
name|resp
operator|->
name|callstate
operator|=
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
expr_stmt|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|cause
argument_list|)
condition|)
name|resp
operator|->
name|cause
operator|=
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|cause
expr_stmt|;
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|uni
argument_list|,
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_RESET_STATUS_indication
argument_list|,
literal|0
argument_list|,
name|app
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|uniapi_reset_error_indication
modifier|*
name|resp
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|app
decl_stmt|;
name|resp
operator|=
name|ALLOC_API
argument_list|(
expr|struct
name|uniapi_reset_error_indication
argument_list|,
name|app
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|!=
name|NULL
condition|)
block|{
name|resp
operator|->
name|source
operator|=
literal|1
expr_stmt|;
name|resp
operator|->
name|reason
operator|=
name|UNIAPI_RESET_ERROR_PEER_INCOMP_STATE
operator|,
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|uni
argument_list|,
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_RESET_ERROR_indication
argument_list|,
literal|0
argument_list|,
name|app
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * T317 timeout function  */
end_comment

begin_function
specifier|static
name|void
name|t317_func
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|)
block|{
name|uni_enq_resp
argument_list|(
name|uni
argument_list|,
name|SIGR_T317
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1996-2003  *	Fraunhofer Institute for Open Communication Systems (FhG Fokus).  * 	All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  *  * Author: Hartmut Brandt<harti@freebsd.org>  *  * $Begemot: libunimsg/netnatm/sig/sig_coord.c,v 1.12 2004/08/05 07:11:01 brandt Exp $  *  * Coordinator  */
end_comment

begin_include
include|#
directive|include
file|<netnatm/unimsg.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/saal/sscfudef.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/msg/unistruct.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/msg/unimsglib.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/sig/uni.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/sig/unipriv.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/sig/unimkmsg.h>
end_include

begin_define
define|#
directive|define
name|STR
parameter_list|(
name|S
parameter_list|)
value|[S] = #S
end_define

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|cunames
index|[]
init|=
block|{
name|STR
argument_list|(
name|CU_STAT0
argument_list|)
block|,
name|STR
argument_list|(
name|CU_STAT1
argument_list|)
block|,
name|STR
argument_list|(
name|CU_STAT2
argument_list|)
block|,
name|STR
argument_list|(
name|CU_STAT3
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|DEF_PRIV_SIG
parameter_list|(
name|NAME
parameter_list|,
name|FROM
parameter_list|)
value|[SIG##NAME] =	"SIG"#NAME,
end_define

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|coord_sigs
index|[]
init|=
block|{
name|DEF_COORD_SIGS
block|}
decl_stmt|;
end_decl_stmt

begin_undef
undef|#
directive|undef
name|DEF_PRIV_SIG
end_undef

begin_function_decl
specifier|static
name|void
name|sig_all_calls
parameter_list|(
name|struct
name|uni
modifier|*
parameter_list|,
name|u_int
name|sig
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|set_custat
parameter_list|(
name|struct
name|uni
modifier|*
parameter_list|,
name|enum
name|cu_stat
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|input_dummy
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|input_global
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|input_unknown
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|input_cobi
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|input_call
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
function_decl|;
end_function_decl

begin_macro
name|TIMER_FUNC_UNI
argument_list|(
argument|t309
argument_list|,
argument|t309_func
argument_list|)
end_macro

begin_comment
comment|/*  * All those 'bogus signal' printouts are not specified in the SDLs.  */
end_comment

begin_comment
comment|/*  * SAAL-ESTABLISH.indication  *  * This means either a resynchronisation or error-recovery or  * an incoming SSCOP connection.  */
end_comment

begin_function
specifier|static
name|void
name|coord_saal_establish_indication
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|)
block|{
switch|switch
condition|(
name|uni
operator|->
name|custat
condition|)
block|{
case|case
name|CU_STAT0
case|:
comment|/* Q.2931:Coord-U 4/10 */
case|case
name|CU_STAT3
case|:
comment|/* Q.2931:Coord-U 5/10 */
name|sig_all_calls
argument_list|(
name|uni
argument_list|,
name|SIGC_LINK_ESTABLISH_indication
argument_list|)
expr_stmt|;
name|set_custat
argument_list|(
name|uni
argument_list|,
name|CU_STAT3
argument_list|)
expr_stmt|;
break|break;
case|case
name|CU_STAT1
case|:
case|case
name|CU_STAT2
case|:
name|VERBOSE0
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_COORD
argument_list|,
literal|"signal saal_establish.indication in CU%u"
argument_list|,
name|uni
operator|->
name|custat
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ASSERT
argument_list|(
literal|0
argument_list|,
operator|(
literal|"CU_STAT*"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * SAAL-ESTABLISH.confirm  */
end_comment

begin_function
specifier|static
name|void
name|coord_saal_establish_confirm
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|)
block|{
switch|switch
condition|(
name|uni
operator|->
name|custat
condition|)
block|{
case|case
name|CU_STAT0
case|:
case|case
name|CU_STAT2
case|:
name|VERBOSE0
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_COORD
argument_list|,
literal|"signal saal_establish.confirm in CU%u"
argument_list|,
name|uni
operator|->
name|custat
argument_list|)
expr_stmt|;
break|break;
case|case
name|CU_STAT1
case|:
comment|/* 		 * Q.2931:Co-ord-U 4/10 		 */
name|TIMER_STOP_UNI
argument_list|(
name|uni
argument_list|,
name|t309
argument_list|)
expr_stmt|;
name|sig_all_calls
argument_list|(
name|uni
argument_list|,
name|SIGC_LINK_ESTABLISH_confirm
argument_list|)
expr_stmt|;
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|uni
argument_list|,
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_LINK_ESTABLISH_confirm
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|set_custat
argument_list|(
name|uni
argument_list|,
name|CU_STAT3
argument_list|)
expr_stmt|;
break|break;
case|case
name|CU_STAT3
case|:
comment|/* 		 * Q.2931:Coord-U 5/10 		 */
name|sig_all_calls
argument_list|(
name|uni
argument_list|,
name|SIGC_LINK_ESTABLISH_confirm
argument_list|)
expr_stmt|;
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|uni
argument_list|,
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_LINK_ESTABLISH_confirm
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ASSERT
argument_list|(
literal|0
argument_list|,
operator|(
literal|"CU_STAT*"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * SAAL-RELEASE.confirm  */
end_comment

begin_function
specifier|static
name|void
name|coord_saal_release_confirm
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|)
block|{
switch|switch
condition|(
name|uni
operator|->
name|custat
condition|)
block|{
case|case
name|CU_STAT0
case|:
case|case
name|CU_STAT1
case|:
case|case
name|CU_STAT3
case|:
name|VERBOSE0
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_COORD
argument_list|,
literal|"signal saal_release.confirm in CU%u"
argument_list|,
name|uni
operator|->
name|custat
argument_list|)
expr_stmt|;
break|break;
case|case
name|CU_STAT2
case|:
comment|/* 		 * Q.2931:Coord-U 5/10 		 */
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|uni
argument_list|,
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_LINK_RELEASE_confirm
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|set_custat
argument_list|(
name|uni
argument_list|,
name|CU_STAT0
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ASSERT
argument_list|(
literal|0
argument_list|,
operator|(
literal|"CU_STAT*"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * SAAL failure.  */
end_comment

begin_function
specifier|static
name|void
name|coord_saal_release_indication
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|)
block|{
switch|switch
condition|(
name|uni
operator|->
name|custat
condition|)
block|{
case|case
name|CU_STAT0
case|:
case|case
name|CU_STAT2
case|:
name|VERBOSE0
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_COORD
argument_list|,
literal|"signal saal_release.indication in CU%u"
argument_list|,
name|uni
operator|->
name|custat
argument_list|)
expr_stmt|;
break|break;
case|case
name|CU_STAT1
case|:
case|case
name|CU_STAT3
case|:
comment|/* 		 * Q.2931:Coord-U 4/10 		 * Q.2931:Coord-U 5/10 		 */
name|sig_all_calls
argument_list|(
name|uni
argument_list|,
name|SIGC_LINK_RELEASE_indication
argument_list|)
expr_stmt|;
name|set_custat
argument_list|(
name|uni
argument_list|,
name|CU_STAT0
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ASSERT
argument_list|(
literal|0
argument_list|,
operator|(
literal|"CU_STAT*"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Link-establish.request from USER. This can also come from  * a call instance. In this case 'cookie' is zero.  */
end_comment

begin_function
specifier|static
name|void
name|coord_link_establish_request
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|uint32_t
name|cookie
parameter_list|)
block|{
switch|switch
condition|(
name|uni
operator|->
name|custat
condition|)
block|{
case|case
name|CU_STAT0
case|:
comment|/* 		 * Q.2931:Coord-U 4/10 		 */
name|uni
operator|->
name|funcs
operator|->
name|saal_output
argument_list|(
name|uni
argument_list|,
name|uni
operator|->
name|arg
argument_list|,
name|SAAL_ESTABLISH_request
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TIMER_ISACT
argument_list|(
name|uni
argument_list|,
name|t309
argument_list|)
condition|)
name|TIMER_START_UNI
argument_list|(
name|uni
argument_list|,
name|t309
argument_list|,
name|uni
operator|->
name|timer309
argument_list|)
expr_stmt|;
name|set_custat
argument_list|(
name|uni
argument_list|,
name|CU_STAT1
argument_list|)
expr_stmt|;
if|if
condition|(
name|cookie
condition|)
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_OK
argument_list|,
name|cookie
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|CU_STAT1
case|:
comment|/* 		 * Q.2931:Coord-U 4/10 		 * This is probably missing from the delay field. 		 */
name|uni_delenq_coord
argument_list|(
name|uni
argument_list|,
name|SIGO_LINK_ESTABLISH_request
argument_list|,
name|cookie
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|CU_STAT2
case|:
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_BAD_CALLSTATE
argument_list|,
name|cookie
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cookie
operator|==
literal|0
condition|)
name|VERBOSE0
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_COORD
argument_list|,
literal|"signal link-establish.request in CU%u"
argument_list|,
name|uni
operator|->
name|custat
argument_list|)
expr_stmt|;
break|break;
case|case
name|CU_STAT3
case|:
comment|/* 		 * Q.2931:Coord-U 5/10 		 */
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|uni
argument_list|,
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_LINK_ESTABLISH_confirm
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_OK
argument_list|,
name|cookie
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ASSERT
argument_list|(
literal|0
argument_list|,
operator|(
literal|"CU_STAT*"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Link-release.request from user  */
end_comment

begin_function
specifier|static
name|void
name|coord_link_release_request
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|u_int
name|cookie
parameter_list|)
block|{
switch|switch
condition|(
name|uni
operator|->
name|custat
condition|)
block|{
case|case
name|CU_STAT0
case|:
case|case
name|CU_STAT1
case|:
case|case
name|CU_STAT2
case|:
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_BAD_CALLSTATE
argument_list|,
name|cookie
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|CU_STAT3
case|:
comment|/* 		 * Q.2931:Coord-U 5/10 		 */
name|uni
operator|->
name|funcs
operator|->
name|saal_output
argument_list|(
name|uni
argument_list|,
name|uni
operator|->
name|arg
argument_list|,
name|SAAL_RELEASE_request
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|set_custat
argument_list|(
name|uni
argument_list|,
name|CU_STAT2
argument_list|)
expr_stmt|;
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_OK
argument_list|,
name|cookie
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ASSERT
argument_list|(
literal|0
argument_list|,
operator|(
literal|"CU_STAT*"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * T309 timeout signal  */
end_comment

begin_function
specifier|static
name|void
name|coord_t309
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|)
block|{
switch|switch
condition|(
name|uni
operator|->
name|custat
condition|)
block|{
case|case
name|CU_STAT0
case|:
case|case
name|CU_STAT1
case|:
comment|/* 		 * Q.2931:Coord-U 4/10 		 */
name|sig_all_calls
argument_list|(
name|uni
argument_list|,
name|SIGC_LINK_ESTABLISH_ERROR_indication
argument_list|)
expr_stmt|;
name|set_custat
argument_list|(
name|uni
argument_list|,
name|CU_STAT0
argument_list|)
expr_stmt|;
comment|/* this is not in the SDLs, but how will the call control 		 * know, that starting the LINK has failed otherwise? */
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|uni
argument_list|,
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_LINK_RELEASE_confirm
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|CU_STAT2
case|:
case|case
name|CU_STAT3
case|:
name|VERBOSE0
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_COORD
argument_list|,
literal|"signal T309 in CU%u"
argument_list|,
name|uni
operator|->
name|custat
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ASSERT
argument_list|(
literal|0
argument_list|,
operator|(
literal|"CU_STAT*"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Message from SAAL  */
end_comment

begin_function
specifier|static
name|void
name|coord_saal_data_indication
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|uni_all
modifier|*
name|u
decl_stmt|;
name|struct
name|call
modifier|*
name|c
decl_stmt|;
name|memset
argument_list|(
operator|&
name|uni
operator|->
name|cause
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|uni
operator|->
name|cause
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|u
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|==
name|NULL
condition|)
block|{
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|uni_decode_head
argument_list|(
name|m
argument_list|,
name|u
argument_list|,
operator|&
name|uni
operator|->
name|cx
argument_list|)
condition|)
block|{
name|VERBOSE
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_COORD
argument_list|,
literal|2
argument_list|,
literal|"bogus message - ignored"
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
operator|.
name|cref
operator|==
name|CREF_DUMMY
condition|)
block|{
if|if
condition|(
name|uni
operator|->
name|cx
operator|.
name|q2932
condition|)
block|{
name|input_dummy
argument_list|(
name|uni
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|VERBOSE
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_COORD
argument_list|,
literal|2
argument_list|,
literal|"dummy cref - ignored"
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
if|if
condition|(
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
operator|.
name|cref
operator|==
name|CREF_GLOBAL
condition|)
name|input_global
argument_list|(
name|uni
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|c
operator|=
name|uni_find_call
argument_list|(
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|input_unknown
argument_list|(
name|uni
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|->
name|type
operator|==
name|CALL_COBI
condition|)
name|input_cobi
argument_list|(
name|c
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
else|else
name|input_call
argument_list|(
name|c
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Message with global call reference  *  * Q.2931:Coord-U (X) 7/10  */
end_comment

begin_function
specifier|static
name|void
name|input_global
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
block|{
name|VERBOSE
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_COORD
argument_list|,
literal|2
argument_list|,
literal|"GLOB MTYPE = %x"
argument_list|,
name|u
operator|->
name|mtype
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|u
operator|->
name|mtype
condition|)
block|{
default|default:
comment|/* 		 * Q.2931:Coord-U 7/10 		 * Q.2931: 5.6.3.2e 		 * Amd4:   29e 		 */
name|uni_respond_status
argument_list|(
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
operator|.
name|flag
condition|?
name|uni
operator|->
name|glob_start
else|:
name|uni
operator|->
name|glob_respond
argument_list|,
name|UNI_CAUSE_CREF_INV
argument_list|)
expr_stmt|;
break|break;
case|case
name|UNI_RESTART
case|:
if|if
condition|(
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
operator|.
name|flag
condition|)
block|{
comment|/* 			 * Q.2931:Coord-U 7/10 (5.6.3.2h) 			 */
name|uni_respond_status
argument_list|(
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|uni
operator|->
name|glob_start
argument_list|,
name|UNI_CAUSE_CREF_INV
argument_list|)
expr_stmt|;
break|break;
block|}
name|uni_enq_resp
argument_list|(
name|uni
argument_list|,
name|SIGR_RESTART
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
case|case
name|UNI_RESTART_ACK
case|:
if|if
condition|(
operator|!
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
operator|.
name|flag
condition|)
block|{
comment|/* 			 * Q.2931:Coord-U 7/10 (5.6.3.2h) 			 * Note, that the SDL diagram contains an error. 			 * The error with the 'YES' label should go to the 			 * box below 'OTHER'. 			 */
name|uni_respond_status
argument_list|(
name|uni
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|,
name|uni
operator|->
name|glob_respond
argument_list|,
name|UNI_CAUSE_CREF_INV
argument_list|)
expr_stmt|;
break|break;
block|}
name|uni_enq_start
argument_list|(
name|uni
argument_list|,
name|SIGS_RESTART_ACK
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
case|case
name|UNI_STATUS
case|:
if|if
condition|(
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
operator|.
name|flag
condition|)
name|uni_enq_start
argument_list|(
name|uni
argument_list|,
name|SIGS_STATUS
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
else|else
name|uni_enq_resp
argument_list|(
name|uni
argument_list|,
name|SIGR_STATUS
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
block|}
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Q.2931:Coord-U 8/10  *  * Message for an unknown call reference  */
end_comment

begin_function
specifier|static
name|void
name|input_unknown
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
block|{
name|struct
name|uni_all
modifier|*
name|resp
decl_stmt|;
name|struct
name|call
modifier|*
name|c
decl_stmt|;
name|u_int
name|cause
init|=
name|UNI_CAUSE_CREF_INV
decl_stmt|;
name|VERBOSE
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_COORD
argument_list|,
literal|2
argument_list|,
literal|"UNKNOWN MTYPE = %x"
argument_list|,
name|u
operator|->
name|mtype
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|u
operator|->
name|mtype
condition|)
block|{
default|default:
comment|/* 		 * This message type is entirly unknown 		 * 		 * 5.6.4 and 5.7.1 are only when the call is not in the 		 * NULL state. This means, 5.6.3.2a takes over. 		 */
break|break;
case|case
name|UNI_SETUP
case|:
if|if
condition|(
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
operator|.
name|flag
condition|)
comment|/* 			 * 5.6.3.2c 			 */
goto|goto
name|drop
goto|;
if|if
condition|(
operator|(
name|c
operator|=
name|uni_create_call
argument_list|(
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
operator|.
name|cref
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_SETUP
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
block|}
goto|goto
name|drop
goto|;
case|case
name|UNI_RELEASE_COMPL
case|:
comment|/* 		 * 5.6.3.2c 		 */
goto|goto
name|drop
goto|;
case|case
name|UNI_STATUS
case|:
comment|/* 		 * 5.6.12 		 * 		 * The SDLs don't use the verify procedure and don't 		 * handle the case of an invalid callstate - we 		 * ignore the message, if the callstate is not good. 		 */
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|m
argument_list|,
name|u
argument_list|,
operator|&
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
argument_list|)
condition|)
goto|goto
name|drop
goto|;
if|if
condition|(
name|u
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
operator|.
name|state
operator|==
name|UNI_CALLSTATE_U0
condition|)
goto|goto
name|drop
goto|;
name|cause
operator|=
name|UNI_CAUSE_MSG_INCOMP
expr_stmt|;
break|break;
case|case
name|UNI_STATUS_ENQ
case|:
if|if
condition|(
operator|(
name|resp
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|drop
goto|;
operator|(
name|void
operator|)
name|uni_decode_body
argument_list|(
name|m
argument_list|,
name|u
argument_list|,
operator|&
name|uni
operator|->
name|cx
argument_list|)
expr_stmt|;
name|MK_MSG_RESP
argument_list|(
name|resp
argument_list|,
name|UNI_STATUS
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|)
expr_stmt|;
name|MK_IE_CALLSTATE
argument_list|(
name|resp
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
argument_list|,
name|UNI_CALLSTATE_U0
argument_list|)
expr_stmt|;
name|MK_IE_CAUSE
argument_list|(
name|resp
operator|->
name|u
operator|.
name|status
operator|.
name|cause
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|UNI_CAUSE_STATUS
argument_list|)
expr_stmt|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|u
operator|->
name|u
operator|.
name|status_enq
operator|.
name|epref
argument_list|)
condition|)
block|{
comment|/* reflect epref as required by L3MU_PO */
name|resp
operator|->
name|u
operator|.
name|status
operator|.
name|epref
operator|=
name|u
operator|->
name|u
operator|.
name|status_enq
operator|.
name|epref
expr_stmt|;
name|MK_IE_EPREF
argument_list|(
name|resp
operator|->
name|u
operator|.
name|status
operator|.
name|epref
argument_list|,
name|u
operator|->
name|u
operator|.
name|status_enq
operator|.
name|epref
operator|.
name|epref
argument_list|,
operator|!
name|u
operator|->
name|u
operator|.
name|status_enq
operator|.
name|epref
operator|.
name|flag
argument_list|)
expr_stmt|;
name|MK_IE_EPSTATE
argument_list|(
name|resp
operator|->
name|u
operator|.
name|status
operator|.
name|epstate
argument_list|,
name|UNI_EPSTATE_NULL
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|resp
argument_list|,
name|uni
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|resp
argument_list|)
expr_stmt|;
goto|goto
name|drop
goto|;
case|case
name|UNI_COBISETUP
case|:
if|if
condition|(
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
operator|.
name|flag
condition|)
comment|/* 			 * 5.6.3.2c (probably) 			 */
goto|goto
name|drop
goto|;
if|if
condition|(
operator|(
name|c
operator|=
name|uni_create_call
argument_list|(
name|uni
argument_list|,
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
operator|.
name|cref
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_COBISETUP
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
block|}
goto|goto
name|drop
goto|;
block|}
comment|/* 	 * 5.6.3.2a) 	 * 	 * Respond with a RELEASE COMPLETE 	 */
if|if
condition|(
operator|(
name|resp
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|drop
goto|;
name|MK_MSG_RESP
argument_list|(
name|resp
argument_list|,
name|UNI_RELEASE_COMPL
argument_list|,
operator|&
name|u
operator|->
name|u
operator|.
name|hdr
operator|.
name|cref
argument_list|)
expr_stmt|;
name|MK_IE_CAUSE
argument_list|(
name|resp
operator|->
name|u
operator|.
name|release_compl
operator|.
name|cause
index|[
literal|0
index|]
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|cause
argument_list|)
expr_stmt|;
if|if
condition|(
name|uni_diag
argument_list|(
name|cause
argument_list|,
name|UNI_CODING_ITU
argument_list|)
operator|==
name|UNI_DIAG_MTYPE
condition|)
name|ADD_CAUSE_MTYPE
argument_list|(
name|resp
operator|->
name|u
operator|.
name|release_compl
operator|.
name|cause
index|[
literal|0
index|]
argument_list|,
name|u
operator|->
name|mtype
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|resp
argument_list|,
name|uni
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|resp
argument_list|)
expr_stmt|;
name|drop
label|:
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|input_cobi
parameter_list|(
name|struct
name|call
modifier|*
name|c
name|__unused
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
block|{
comment|/* XXX */
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|input_dummy
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
name|__unused
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
block|{
comment|/* XXX */
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|input_call
parameter_list|(
name|struct
name|call
modifier|*
name|c
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|m
parameter_list|,
name|struct
name|uni_all
modifier|*
name|u
parameter_list|)
block|{
name|VERBOSE
argument_list|(
name|c
operator|->
name|uni
argument_list|,
name|UNI_FAC_COORD
argument_list|,
literal|2
argument_list|,
literal|"CALL MTYPE = %x %d/%s"
argument_list|,
name|u
operator|->
name|mtype
argument_list|,
name|c
operator|->
name|cref
argument_list|,
name|c
operator|->
name|mine
condition|?
literal|"mine"
else|:
literal|"his"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|u
operator|->
name|mtype
condition|)
block|{
case|case
name|UNI_SETUP
case|:
comment|/* 		 * Ignored 		 */
break|break;
case|case
name|UNI_CALL_PROC
case|:
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_CALL_PROC
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
case|case
name|UNI_ALERTING
case|:
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_ALERTING
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
case|case
name|UNI_RELEASE
case|:
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_RELEASE
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
case|case
name|UNI_RELEASE_COMPL
case|:
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_RELEASE_COMPL
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
case|case
name|UNI_CONNECT
case|:
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_CONNECT
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
case|case
name|UNI_CONNECT_ACK
case|:
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_CONNECT_ACK
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
case|case
name|UNI_NOTIFY
case|:
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_NOTIFY
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
case|case
name|UNI_STATUS
case|:
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_STATUS
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
case|case
name|UNI_STATUS_ENQ
case|:
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_STATUS_ENQ
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
case|case
name|UNI_ADD_PARTY
case|:
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_ADD_PARTY
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
case|case
name|UNI_PARTY_ALERTING
case|:
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_PARTY_ALERTING
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
case|case
name|UNI_ADD_PARTY_ACK
case|:
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_ADD_PARTY_ACK
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
case|case
name|UNI_ADD_PARTY_REJ
case|:
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_ADD_PARTY_REJ
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
case|case
name|UNI_DROP_PARTY
case|:
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_DROP_PARTY
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
case|case
name|UNI_DROP_PARTY_ACK
case|:
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_DROP_PARTY_ACK
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
default|default:
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_UNKNOWN
argument_list|,
literal|0
argument_list|,
name|m
argument_list|,
name|u
argument_list|)
expr_stmt|;
return|return;
block|}
name|UNI_FREE
argument_list|(
name|u
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * This macro tries to implement the delaying behaviour for  * message from the API when we are in the Awaiting-Establish state.  * In this state, the message is delayed. If we drop back to CU 0,  * everything gets unqueued and errors are returned for all that stuff.  * If we progess to CUSTAT2 we process the requests.  */
end_comment

begin_define
define|#
directive|define
name|COMMON_DELAY
parameter_list|(
name|SIG
parameter_list|,
name|COOKIE
parameter_list|)
define|\
value|if (uni->custat == CU_STAT0 || uni->custat == CU_STAT2) {\ 			uniapi_uni_error(uni, UNIAPI_ERROR_BADCU,	\ 			    COOKIE, 0);					\ 			break;						\ 		}							\ 		if (uni->custat == CU_STAT1) {				\ 			uni_delenq_coord(uni, SIG, COOKIE, msg);	\ 			break;						\ 		}
end_define

begin_comment
comment|/*  * Signal handler of the coordinator  */
end_comment

begin_function
name|void
name|uni_sig_coord
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|enum
name|coord_sig
name|sig
parameter_list|,
name|uint32_t
name|cookie
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|call
modifier|*
name|c
decl_stmt|;
if|if
condition|(
name|sig
operator|>=
name|SIGO_END
condition|)
block|{
name|VERBOSE
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|1
argument_list|,
literal|"Signal %d outside of range to "
literal|"Coord"
argument_list|,
name|sig
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
condition|)
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
name|VERBOSE
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_COORD
argument_list|,
literal|1
argument_list|,
literal|"Signal %s in state %s"
argument_list|,
name|coord_sigs
index|[
name|sig
index|]
argument_list|,
name|cunames
index|[
name|uni
operator|->
name|custat
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sig
condition|)
block|{
case|case
name|SIGO_END
case|:
break|break;
case|case
name|SIGO_DATA
case|:
comment|/* delayed output */
if|if
condition|(
name|uni
operator|->
name|custat
operator|==
name|CU_STAT0
operator|||
name|uni
operator|->
name|custat
operator|==
name|CU_STAT1
condition|)
break|break;
comment|/* drop */
if|if
condition|(
name|uni
operator|->
name|custat
operator|==
name|CU_STAT1
condition|)
name|uni_delenq_coord
argument_list|(
name|uni
argument_list|,
name|SIGO_DATA
argument_list|,
name|cookie
argument_list|,
name|msg
argument_list|)
expr_stmt|;
comment|/* ??? */
else|else
name|uni
operator|->
name|funcs
operator|->
name|saal_output
argument_list|(
name|uni
argument_list|,
name|uni
operator|->
name|arg
argument_list|,
name|SAAL_DATA_request
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
break|break;
comment|/* 	   * SAAL signals 	   */
case|case
name|SIGO_SAAL_ESTABLISH_indication
case|:
name|coord_saal_establish_indication
argument_list|(
name|uni
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGO_SAAL_ESTABLISH_confirm
case|:
name|coord_saal_establish_confirm
argument_list|(
name|uni
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGO_SAAL_RELEASE_confirm
case|:
name|coord_saal_release_confirm
argument_list|(
name|uni
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGO_SAAL_RELEASE_indication
case|:
name|coord_saal_release_indication
argument_list|(
name|uni
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGO_SAAL_DATA_indication
case|:
name|coord_saal_data_indication
argument_list|(
name|uni
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
break|break;
case|case
name|SIGO_SAAL_UDATA_indication
case|:
name|VERBOSE0
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|"SAAL_UDATA_indication"
argument_list|)
expr_stmt|;
break|break;
comment|/* 	   * Signals from USER 	   */
case|case
name|SIGO_LINK_ESTABLISH_request
case|:
name|coord_link_establish_request
argument_list|(
name|uni
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGO_LINK_RELEASE_request
case|:
name|coord_link_release_request
argument_list|(
name|uni
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
break|break;
case|case
name|SIGO_RESET_request
case|:
name|uni_enq_start
argument_list|(
name|uni
argument_list|,
name|SIGS_RESET_request
argument_list|,
name|cookie
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|uni
operator|->
name|custat
operator|==
name|CU_STAT0
condition|)
block|{
name|uni
operator|->
name|funcs
operator|->
name|saal_output
argument_list|(
name|uni
argument_list|,
name|uni
operator|->
name|arg
argument_list|,
name|SAAL_ESTABLISH_request
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TIMER_ISACT
argument_list|(
name|uni
argument_list|,
name|t309
argument_list|)
condition|)
name|TIMER_START_UNI
argument_list|(
name|uni
argument_list|,
name|t309
argument_list|,
name|uni
operator|->
name|timer309
argument_list|)
expr_stmt|;
name|set_custat
argument_list|(
name|uni
argument_list|,
name|CU_STAT1
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SIGO_RESET_ERROR_response
case|:
name|COMMON_DELAY
argument_list|(
name|SIGO_RESET_ERROR_response
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_enq_resp
argument_list|(
name|uni
argument_list|,
name|SIGR_RESET_ERROR_response
argument_list|,
name|cookie
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
break|break;
case|case
name|SIGO_RESET_response
case|:
name|COMMON_DELAY
argument_list|(
name|SIGO_RESET_response
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|uni_enq_resp
argument_list|(
name|uni
argument_list|,
name|SIGR_RESET_response
argument_list|,
name|cookie
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
break|break;
case|case
name|SIGO_SETUP_request
case|:
if|if
condition|(
operator|(
name|c
operator|=
name|uni_create_new_call
argument_list|(
name|uni
argument_list|,
name|cookie
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_SETUP_request
argument_list|,
name|cookie
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|uni
operator|->
name|custat
operator|==
name|CU_STAT0
condition|)
block|{
name|uni
operator|->
name|funcs
operator|->
name|saal_output
argument_list|(
name|uni
argument_list|,
name|uni
operator|->
name|arg
argument_list|,
name|SAAL_ESTABLISH_request
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|TIMER_ISACT
argument_list|(
name|uni
argument_list|,
name|t309
argument_list|)
condition|)
name|TIMER_START_UNI
argument_list|(
name|uni
argument_list|,
name|t309
argument_list|,
name|uni
operator|->
name|timer309
argument_list|)
expr_stmt|;
name|set_custat
argument_list|(
name|uni
argument_list|,
name|CU_STAT1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_NOMEM
argument_list|,
name|cookie
argument_list|,
name|UNI_CALLSTATE_U0
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SIGO_PROCEEDING_request
case|:
block|{
name|struct
name|uniapi_proceeding_request
modifier|*
name|arg
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_proceeding_request
operator|*
argument_list|)
decl_stmt|;
name|COMMON_DELAY
argument_list|(
name|SIGO_PROCEEDING_request
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|uni_find_call
argument_list|(
name|uni
argument_list|,
operator|&
name|arg
operator|->
name|call_proc
operator|.
name|hdr
operator|.
name|cref
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_PROCEEDING_request
argument_list|,
name|cookie
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_BAD_CALL
argument_list|,
name|cookie
argument_list|,
name|UNI_CALLSTATE_U0
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|SIGO_ALERTING_request
case|:
block|{
name|struct
name|uniapi_alerting_request
modifier|*
name|arg
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_alerting_request
operator|*
argument_list|)
decl_stmt|;
name|COMMON_DELAY
argument_list|(
name|SIGO_ALERTING_request
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|uni_find_call
argument_list|(
name|uni
argument_list|,
operator|&
name|arg
operator|->
name|alerting
operator|.
name|hdr
operator|.
name|cref
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_ALERTING_request
argument_list|,
name|cookie
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_BAD_CALL
argument_list|,
name|cookie
argument_list|,
name|UNI_CALLSTATE_U0
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|SIGO_SETUP_response
case|:
block|{
name|struct
name|uniapi_setup_response
modifier|*
name|arg
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_setup_response
operator|*
argument_list|)
decl_stmt|;
name|COMMON_DELAY
argument_list|(
name|SIGO_SETUP_response
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|uni_find_call
argument_list|(
name|uni
argument_list|,
operator|&
name|arg
operator|->
name|connect
operator|.
name|hdr
operator|.
name|cref
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_SETUP_response
argument_list|,
name|cookie
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_BAD_CALL
argument_list|,
name|cookie
argument_list|,
name|UNI_CALLSTATE_U0
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|SIGO_SETUP_COMPLETE_request
case|:
block|{
name|struct
name|uniapi_setup_complete_request
modifier|*
name|arg
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_setup_complete_request
operator|*
argument_list|)
decl_stmt|;
name|COMMON_DELAY
argument_list|(
name|SIGO_SETUP_COMPLETE_request
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|uni_find_call
argument_list|(
name|uni
argument_list|,
operator|&
name|arg
operator|->
name|connect_ack
operator|.
name|hdr
operator|.
name|cref
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_SETUP_COMPLETE_request
argument_list|,
name|cookie
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_BAD_CALL
argument_list|,
name|cookie
argument_list|,
name|UNI_CALLSTATE_U0
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|SIGO_RELEASE_request
case|:
block|{
name|struct
name|uniapi_release_request
modifier|*
name|arg
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_release_request
operator|*
argument_list|)
decl_stmt|;
name|COMMON_DELAY
argument_list|(
name|SIGO_RELEASE_request
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|uni_find_call
argument_list|(
name|uni
argument_list|,
operator|&
name|arg
operator|->
name|release
operator|.
name|hdr
operator|.
name|cref
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_RELEASE_request
argument_list|,
name|cookie
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_BAD_CALL
argument_list|,
name|cookie
argument_list|,
name|UNI_CALLSTATE_U0
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|SIGO_RELEASE_response
case|:
block|{
name|struct
name|uniapi_release_response
modifier|*
name|arg
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_release_response
operator|*
argument_list|)
decl_stmt|;
name|COMMON_DELAY
argument_list|(
name|SIGO_RELEASE_response
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|uni_find_call
argument_list|(
name|uni
argument_list|,
operator|&
name|arg
operator|->
name|release_compl
operator|.
name|hdr
operator|.
name|cref
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_RELEASE_response
argument_list|,
name|cookie
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_BAD_CALL
argument_list|,
name|cookie
argument_list|,
name|UNI_CALLSTATE_U0
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|SIGO_NOTIFY_request
case|:
block|{
name|struct
name|uniapi_notify_request
modifier|*
name|arg
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_notify_request
operator|*
argument_list|)
decl_stmt|;
name|COMMON_DELAY
argument_list|(
name|SIGO_NOTIFY_request
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|uni_find_call
argument_list|(
name|uni
argument_list|,
operator|&
name|arg
operator|->
name|notify
operator|.
name|hdr
operator|.
name|cref
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_NOTIFY_request
argument_list|,
name|cookie
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_BAD_CALL
argument_list|,
name|cookie
argument_list|,
name|UNI_CALLSTATE_U0
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|SIGO_STATUS_ENQUIRY_request
case|:
block|{
name|struct
name|uniapi_status_enquiry_request
modifier|*
name|arg
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_status_enquiry_request
operator|*
argument_list|)
decl_stmt|;
name|COMMON_DELAY
argument_list|(
name|SIGO_STATUS_ENQUIRY_request
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|uni_find_call
argument_list|(
name|uni
argument_list|,
operator|&
name|arg
operator|->
name|cref
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_STATUS_ENQUIRY_request
argument_list|,
name|cookie
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_BAD_CALL
argument_list|,
name|cookie
argument_list|,
name|UNI_CALLSTATE_U0
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|SIGO_ADD_PARTY_request
case|:
block|{
name|struct
name|uniapi_add_party_request
modifier|*
name|arg
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_add_party_request
operator|*
argument_list|)
decl_stmt|;
name|COMMON_DELAY
argument_list|(
name|SIGO_ADD_PARTY_request
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|uni_find_call
argument_list|(
name|uni
argument_list|,
operator|&
name|arg
operator|->
name|add
operator|.
name|hdr
operator|.
name|cref
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|type
operator|!=
name|CALL_ROOT
condition|)
block|{
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_CTYPE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
break|break;
block|}
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_ADD_PARTY_request
argument_list|,
name|cookie
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_BAD_CALL
argument_list|,
name|cookie
argument_list|,
name|UNI_CALLSTATE_U0
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|SIGO_PARTY_ALERTING_request
case|:
block|{
name|struct
name|uniapi_party_alerting_request
modifier|*
name|arg
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_party_alerting_request
operator|*
argument_list|)
decl_stmt|;
name|COMMON_DELAY
argument_list|(
name|SIGO_PARTY_ALERTING_request
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|uni_find_call
argument_list|(
name|uni
argument_list|,
operator|&
name|arg
operator|->
name|alert
operator|.
name|hdr
operator|.
name|cref
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|type
operator|!=
name|CALL_LEAF
condition|)
block|{
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_CTYPE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
break|break;
block|}
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_PARTY_ALERTING_request
argument_list|,
name|cookie
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_BAD_CALL
argument_list|,
name|cookie
argument_list|,
name|UNI_CALLSTATE_U0
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|SIGO_ADD_PARTY_ACK_request
case|:
block|{
name|struct
name|uniapi_add_party_ack_request
modifier|*
name|arg
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_add_party_ack_request
operator|*
argument_list|)
decl_stmt|;
name|COMMON_DELAY
argument_list|(
name|SIGO_ADD_PARTY_ACK_request
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|uni_find_call
argument_list|(
name|uni
argument_list|,
operator|&
name|arg
operator|->
name|ack
operator|.
name|hdr
operator|.
name|cref
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|type
operator|!=
name|CALL_LEAF
condition|)
block|{
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_CTYPE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
break|break;
block|}
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_ADD_PARTY_ACK_request
argument_list|,
name|cookie
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_BAD_CALL
argument_list|,
name|cookie
argument_list|,
name|UNI_CALLSTATE_U0
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|SIGO_ADD_PARTY_REJ_request
case|:
block|{
name|struct
name|uniapi_add_party_rej_request
modifier|*
name|arg
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_add_party_rej_request
operator|*
argument_list|)
decl_stmt|;
name|COMMON_DELAY
argument_list|(
name|SIGO_ADD_PARTY_REJ_request
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|uni_find_call
argument_list|(
name|uni
argument_list|,
operator|&
name|arg
operator|->
name|rej
operator|.
name|hdr
operator|.
name|cref
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|type
operator|!=
name|CALL_LEAF
condition|)
block|{
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_CTYPE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
break|break;
block|}
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_ADD_PARTY_REJ_request
argument_list|,
name|cookie
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_BAD_CALL
argument_list|,
name|cookie
argument_list|,
name|UNI_CALLSTATE_U0
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|SIGO_DROP_PARTY_request
case|:
block|{
name|struct
name|uniapi_drop_party_request
modifier|*
name|arg
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_drop_party_request
operator|*
argument_list|)
decl_stmt|;
name|COMMON_DELAY
argument_list|(
name|SIGO_DROP_PARTY_request
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|uni_find_call
argument_list|(
name|uni
argument_list|,
operator|&
name|arg
operator|->
name|drop
operator|.
name|hdr
operator|.
name|cref
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|type
operator|!=
name|CALL_ROOT
operator|&&
name|c
operator|->
name|type
operator|!=
name|CALL_LEAF
condition|)
block|{
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_CTYPE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
break|break;
block|}
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_DROP_PARTY_request
argument_list|,
name|cookie
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_BAD_CALL
argument_list|,
name|cookie
argument_list|,
name|UNI_CALLSTATE_U0
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|SIGO_DROP_PARTY_ACK_request
case|:
block|{
name|struct
name|uniapi_drop_party_ack_request
modifier|*
name|arg
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_drop_party_ack_request
operator|*
argument_list|)
decl_stmt|;
name|COMMON_DELAY
argument_list|(
name|SIGO_DROP_PARTY_ACK_request
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|uni_find_call
argument_list|(
name|uni
argument_list|,
operator|&
name|arg
operator|->
name|ack
operator|.
name|hdr
operator|.
name|cref
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|c
operator|->
name|type
operator|!=
name|CALL_ROOT
operator|&&
name|c
operator|->
name|type
operator|!=
name|CALL_LEAF
condition|)
block|{
name|uniapi_call_error
argument_list|(
name|c
argument_list|,
name|UNIAPI_ERROR_BAD_CTYPE
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
break|break;
block|}
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_DROP_PARTY_ACK_request
argument_list|,
name|cookie
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_BAD_CALL
argument_list|,
name|cookie
argument_list|,
name|UNI_CALLSTATE_U0
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|SIGO_ABORT_CALL_request
case|:
block|{
name|struct
name|uniapi_abort_call_request
modifier|*
name|arg
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_abort_call_request
operator|*
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|uni_find_call
argument_list|(
name|uni
argument_list|,
operator|&
name|arg
operator|->
name|cref
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|uni_enq_call
argument_list|(
name|c
argument_list|,
name|SIGC_ABORT_CALL_request
argument_list|,
name|cookie
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|uniapi_uni_error
argument_list|(
name|uni
argument_list|,
name|UNIAPI_ERROR_BAD_CALL
argument_list|,
name|cookie
argument_list|,
name|UNI_CALLSTATE_U0
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
comment|/* 	   * Call-Control 	   */
case|case
name|SIGO_CALL_DESTROYED
case|:
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|uni
argument_list|,
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_CALL_DESTROYED
argument_list|,
literal|0
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
break|break;
comment|/* 	   * ResetRespond 	   */
case|case
name|SIGO_RESET_indication
case|:
name|uni
operator|->
name|funcs
operator|->
name|uni_output
argument_list|(
name|uni
argument_list|,
name|uni
operator|->
name|arg
argument_list|,
name|UNIAPI_RESET_indication
argument_list|,
literal|0
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
break|break;
comment|/* 	   * Timeouts 	   */
case|case
name|SIGO_T309
case|:
name|coord_t309
argument_list|(
name|uni
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|msg
operator|!=
name|NULL
condition|)
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Send a signal to all call instances  */
end_comment

begin_function
specifier|static
name|void
name|sig_all_calls
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|u_int
name|sig
parameter_list|)
block|{
name|struct
name|call
modifier|*
name|call
decl_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|call
argument_list|,
argument|&uni->calls
argument_list|,
argument|link
argument_list|)
name|uni_enq_call
argument_list|(
name|call
argument_list|,
name|sig
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Set a new coordinator state - this moves all delayed coordinator  * signals from the delayed queue to the signal queue.  */
end_comment

begin_function
specifier|static
name|int
name|cufilt
parameter_list|(
name|struct
name|sig
modifier|*
name|s
parameter_list|,
name|void
modifier|*
name|arg
name|__unused
parameter_list|)
block|{
return|return
operator|(
name|s
operator|->
name|type
operator|==
name|SIG_COORD
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_custat
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|enum
name|cu_stat
name|nstate
parameter_list|)
block|{
if|if
condition|(
name|uni
operator|->
name|custat
operator|!=
name|nstate
condition|)
block|{
name|uni
operator|->
name|custat
operator|=
name|nstate
expr_stmt|;
name|uni_undel
argument_list|(
name|uni
argument_list|,
name|cufilt
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * T309 timeout function  */
end_comment

begin_function
specifier|static
name|void
name|t309_func
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|)
block|{
name|uni_enq_coord
argument_list|(
name|uni
argument_list|,
name|SIGO_T309
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Respond with a status message  */
end_comment

begin_function
name|void
name|uni_respond_status
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|struct
name|uni_cref
modifier|*
name|cref
parameter_list|,
name|enum
name|uni_callstate
name|cs
parameter_list|,
name|enum
name|uni_cause
name|c1
parameter_list|)
block|{
name|struct
name|uni_all
modifier|*
name|resp
decl_stmt|;
if|if
condition|(
operator|(
name|resp
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|==
name|NULL
condition|)
return|return;
name|MK_MSG_RESP
argument_list|(
name|resp
argument_list|,
name|UNI_STATUS
argument_list|,
name|cref
argument_list|)
expr_stmt|;
name|MK_IE_CALLSTATE
argument_list|(
name|resp
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
argument_list|,
name|cs
argument_list|)
expr_stmt|;
name|MK_IE_CAUSE
argument_list|(
name|resp
operator|->
name|u
operator|.
name|status
operator|.
name|cause
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|c1
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|resp
argument_list|,
name|uni
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|resp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Respond with a status message  */
end_comment

begin_function
name|void
name|uni_respond_status_mtype
parameter_list|(
name|struct
name|uni
modifier|*
name|uni
parameter_list|,
name|struct
name|uni_cref
modifier|*
name|cref
parameter_list|,
name|enum
name|uni_callstate
name|cs
parameter_list|,
name|enum
name|uni_cause
name|c1
parameter_list|,
name|u_int
name|mtype
parameter_list|)
block|{
name|struct
name|uni_all
modifier|*
name|resp
decl_stmt|;
if|if
condition|(
operator|(
name|resp
operator|=
name|UNI_ALLOC
argument_list|()
operator|)
operator|==
name|NULL
condition|)
return|return;
name|MK_MSG_RESP
argument_list|(
name|resp
argument_list|,
name|UNI_STATUS
argument_list|,
name|cref
argument_list|)
expr_stmt|;
name|MK_IE_CALLSTATE
argument_list|(
name|resp
operator|->
name|u
operator|.
name|status
operator|.
name|callstate
argument_list|,
name|cs
argument_list|)
expr_stmt|;
name|MK_IE_CAUSE
argument_list|(
name|resp
operator|->
name|u
operator|.
name|status
operator|.
name|cause
argument_list|,
name|UNI_CAUSE_LOC_USER
argument_list|,
name|c1
argument_list|)
expr_stmt|;
name|ADD_CAUSE_MTYPE
argument_list|(
name|resp
operator|->
name|u
operator|.
name|status
operator|.
name|cause
argument_list|,
name|mtype
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|uni_send_output
argument_list|(
name|resp
argument_list|,
name|uni
argument_list|)
expr_stmt|;
name|UNI_FREE
argument_list|(
name|resp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Send a message. If we are in CUSTAT1, delay the message if we  * are in CUSTAT3 send it, else drop it.  */
end_comment

begin_function
name|int
name|uni_send_output
parameter_list|(
name|struct
name|uni_all
modifier|*
name|u
parameter_list|,
name|struct
name|uni
modifier|*
name|uni
parameter_list|)
block|{
name|struct
name|uni_msg
modifier|*
name|m
decl_stmt|;
name|int
name|err
decl_stmt|;
if|if
condition|(
name|uni
operator|->
name|custat
operator|==
name|CU_STAT0
operator|||
name|uni
operator|->
name|custat
operator|==
name|CU_STAT2
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|m
operator|=
name|uni_msg_alloc
argument_list|(
literal|1024
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|uni_encode
argument_list|(
name|m
argument_list|,
name|u
argument_list|,
operator|&
name|uni
operator|->
name|cx
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|VERBOSE0
argument_list|(
name|uni
argument_list|,
name|UNI_FAC_ERR
argument_list|,
literal|"uni_encode failed: %08x"
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|uni_msg_destroy
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|uni
operator|->
name|custat
operator|==
name|CU_STAT1
condition|)
name|uni_delenq_coord
argument_list|(
name|uni
argument_list|,
name|SIGO_DATA
argument_list|,
literal|0
argument_list|,
name|m
argument_list|)
expr_stmt|;
else|else
name|uni
operator|->
name|funcs
operator|->
name|saal_output
argument_list|(
name|uni
argument_list|,
name|uni
operator|->
name|arg
argument_list|,
name|SAAL_DATA_request
argument_list|,
name|m
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2003-2004  *	Hartmut Brandt  *	All rights reserved.  *  * Copyright (c) 2001-2002  *	Fraunhofer Institute for Open Communication Systems (FhG Fokus).  *	All rights reserved.  *  * Author: Harti Brandt<harti@freebsd.org>  *  * Redistribution of this software and documentation and use in source and  * binary forms, with or without modification, are permitted provided that  * the following conditions are met:  *  * 1. Redistributions of source code or documentation must retain the above  *    copyright notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE AND DOCUMENTATION IS PROVIDED BY THE AUTHOR  * AND ITS CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES,  * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND  * FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL  * THE AUTHOR OR ITS CONTRIBUTORS  BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,  * OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF  * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING  * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,  * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * $Begemot: libunimsg/netnatm/api/cc_port.c,v 1.1 2004/07/08 08:21:53 brandt Exp $  *  * ATM API as defined per af-saa-0108  *  * Port-global stuff (ILMI and Co.)  */
end_comment

begin_include
include|#
directive|include
file|<netnatm/unimsg.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/msg/unistruct.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/api/unisap.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/sig/unidef.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/api/atmapi.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/api/ccatm.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/api/ccpriv.h>
end_include

begin_comment
comment|/*  * Find a port with a given number  */
end_comment

begin_function
specifier|static
name|struct
name|ccport
modifier|*
name|find_port
parameter_list|(
name|struct
name|ccdata
modifier|*
name|cc
parameter_list|,
name|u_int
name|portno
parameter_list|)
block|{
name|struct
name|ccport
modifier|*
name|port
decl_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|port
argument_list|,
argument|&cc->port_list
argument_list|,
argument|node_link
argument_list|)
if|if
condition|(
name|port
operator|->
name|param
operator|.
name|port
operator|==
name|portno
condition|)
return|return
operator|(
name|port
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Create a new port structure, initialize it and link it to the node.  * Returns 0 on success, an errno otherwise.  */
end_comment

begin_function
name|struct
name|ccport
modifier|*
name|cc_port_create
parameter_list|(
name|struct
name|ccdata
modifier|*
name|cc
parameter_list|,
name|void
modifier|*
name|uarg
parameter_list|,
name|u_int
name|portno
parameter_list|)
block|{
name|struct
name|ccport
modifier|*
name|port
decl_stmt|,
modifier|*
name|p1
decl_stmt|;
if|if
condition|(
name|portno
operator|==
literal|0
operator|||
name|portno
operator|>
literal|0xffffffff
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|TAILQ_FOREACH
argument_list|(
argument|port
argument_list|,
argument|&cc->port_list
argument_list|,
argument|node_link
argument_list|)
if|if
condition|(
name|port
operator|->
name|param
operator|.
name|port
operator|==
name|portno
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|port
operator|=
name|CCZALLOC
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|port
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|port
operator|->
name|uarg
operator|=
name|uarg
expr_stmt|;
name|port
operator|->
name|cc
operator|=
name|cc
expr_stmt|;
name|port
operator|->
name|admin
operator|=
name|CCPORT_STOPPED
expr_stmt|;
name|LIST_INIT
argument_list|(
operator|&
name|port
operator|->
name|conn_list
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|port
operator|->
name|addr_list
argument_list|)
expr_stmt|;
name|port
operator|->
name|param
operator|.
name|port
operator|=
name|portno
expr_stmt|;
name|port
operator|->
name|param
operator|.
name|pcr
operator|=
literal|350053
expr_stmt|;
name|port
operator|->
name|param
operator|.
name|max_vpi_bits
operator|=
literal|0
expr_stmt|;
name|port
operator|->
name|param
operator|.
name|max_vci_bits
operator|=
literal|8
expr_stmt|;
name|port
operator|->
name|param
operator|.
name|max_svpc_vpi
operator|=
literal|0
expr_stmt|;
name|port
operator|->
name|param
operator|.
name|max_svcc_vpi
operator|=
literal|0
expr_stmt|;
name|port
operator|->
name|param
operator|.
name|min_svcc_vci
operator|=
literal|32
expr_stmt|;
name|port
operator|->
name|param
operator|.
name|num_addrs
operator|=
literal|0
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|port
operator|->
name|cookies
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|p1
argument_list|,
argument|&cc->port_list
argument_list|,
argument|node_link
argument_list|)
if|if
condition|(
name|p1
operator|->
name|param
operator|.
name|port
operator|>
name|portno
condition|)
block|{
name|TAILQ_INSERT_BEFORE
argument_list|(
name|p1
argument_list|,
name|port
argument_list|,
name|node_link
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|p1
operator|==
name|NULL
condition|)
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|cc
operator|->
name|port_list
argument_list|,
name|port
argument_list|,
name|node_link
argument_list|)
expr_stmt|;
return|return
operator|(
name|port
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Destroy a port. This closes all connections and aborts all the users of  * these connections.  * This should be called only after work has returned so that no signals  * are pending.  */
end_comment

begin_function
name|void
name|cc_port_destroy
parameter_list|(
name|struct
name|ccport
modifier|*
name|port
parameter_list|,
name|int
name|shutdown
parameter_list|)
block|{
name|struct
name|ccaddr
modifier|*
name|addr
decl_stmt|;
name|struct
name|ccreq
modifier|*
name|r
decl_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|port
operator|->
name|cc
operator|->
name|port_list
argument_list|,
name|port
argument_list|,
name|node_link
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|r
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|port
operator|->
name|cookies
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|port
operator|->
name|cookies
argument_list|,
name|r
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|CCFREE
argument_list|(
name|r
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Abort all connections. 	 */
while|while
condition|(
operator|!
name|LIST_EMPTY
argument_list|(
operator|&
name|port
operator|->
name|conn_list
argument_list|)
condition|)
name|cc_conn_abort
argument_list|(
name|LIST_FIRST
argument_list|(
operator|&
name|port
operator|->
name|conn_list
argument_list|)
argument_list|,
name|shutdown
argument_list|)
expr_stmt|;
comment|/* 	 * Free addresses. 	 */
while|while
condition|(
operator|(
name|addr
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|port
operator|->
name|addr_list
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|port
operator|->
name|addr_list
argument_list|,
name|addr
argument_list|,
name|port_link
argument_list|)
expr_stmt|;
name|CCFREE
argument_list|(
name|addr
argument_list|)
expr_stmt|;
block|}
name|CCFREE
argument_list|(
name|port
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Management is given up on this node. Remove all addresses from the port.  */
end_comment

begin_function
name|void
name|cc_unmanage
parameter_list|(
name|struct
name|ccdata
modifier|*
name|cc
parameter_list|)
block|{
name|struct
name|ccport
modifier|*
name|port
decl_stmt|;
name|struct
name|ccaddr
modifier|*
name|addr
decl_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|port
argument_list|,
argument|&cc->port_list
argument_list|,
argument|node_link
argument_list|)
block|{
while|while
condition|(
operator|(
name|addr
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|port
operator|->
name|addr_list
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|port
operator|->
name|addr_list
argument_list|,
name|addr
argument_list|,
name|port_link
argument_list|)
expr_stmt|;
name|CCFREE
argument_list|(
name|addr
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * Compare two addresses  */
end_comment

begin_function
specifier|static
name|__inline
name|int
name|addr_eq
parameter_list|(
specifier|const
name|struct
name|uni_addr
modifier|*
name|a1
parameter_list|,
specifier|const
name|struct
name|uni_addr
modifier|*
name|a2
parameter_list|)
block|{
return|return
operator|(
name|a1
operator|->
name|type
operator|==
name|a2
operator|->
name|type
operator|&&
name|a1
operator|->
name|plan
operator|==
name|a2
operator|->
name|plan
operator|&&
name|a1
operator|->
name|len
operator|==
name|a2
operator|->
name|len
operator|&&
name|memcmp
argument_list|(
name|a1
operator|->
name|addr
argument_list|,
name|a2
operator|->
name|addr
argument_list|,
name|a1
operator|->
name|len
argument_list|)
operator|==
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * retrieve addresses  */
end_comment

begin_function
name|int
name|cc_get_addrs
parameter_list|(
name|struct
name|ccdata
modifier|*
name|cc
parameter_list|,
name|u_int
name|portno
parameter_list|,
name|struct
name|uni_addr
modifier|*
modifier|*
name|pa
parameter_list|,
name|u_int
modifier|*
modifier|*
name|ports
parameter_list|,
name|u_int
modifier|*
name|count
parameter_list|)
block|{
name|struct
name|ccport
modifier|*
name|port
init|=
name|NULL
decl_stmt|;
name|struct
name|ccaddr
modifier|*
name|addr
decl_stmt|;
name|struct
name|uni_addr
modifier|*
name|buf
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
name|u_int
modifier|*
name|pports
decl_stmt|;
comment|/* 	 * If a port number is specified and the port does not exist, 	 * return an error. 	 */
if|if
condition|(
name|portno
operator|!=
literal|0
condition|)
if|if
condition|(
operator|(
name|port
operator|=
name|find_port
argument_list|(
name|cc
argument_list|,
name|portno
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOENT
operator|)
return|;
comment|/* 	 * Count the addresses 	 */
operator|*
name|count
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|portno
operator|!=
literal|0
condition|)
block|{
name|TAILQ_FOREACH
argument_list|(
name|addr
argument_list|,
operator|&
name|port
operator|->
name|addr_list
argument_list|,
name|port_link
argument_list|)
argument_list|(
operator|*
name|count
argument_list|)
operator|++
expr_stmt|;
block|}
else|else
block|{
name|TAILQ_FOREACH
argument_list|(
argument|port
argument_list|,
argument|&cc->port_list
argument_list|,
argument|node_link
argument_list|)
name|TAILQ_FOREACH
argument_list|(
name|addr
argument_list|,
operator|&
name|port
operator|->
name|addr_list
argument_list|,
name|port_link
argument_list|)
argument_list|(
operator|*
name|count
argument_list|)
operator|++
expr_stmt|;
block|}
name|buf
operator|=
name|CCMALLOC
argument_list|(
operator|*
name|count
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|uni_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|ptr
operator|=
name|buf
expr_stmt|;
operator|*
name|ports
operator|=
name|CCMALLOC
argument_list|(
operator|*
name|count
operator|*
sizeof|sizeof
argument_list|(
name|u_int
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|ports
operator|==
name|NULL
condition|)
block|{
name|CCFREE
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOMEM
operator|)
return|;
block|}
name|pports
operator|=
operator|*
name|ports
expr_stmt|;
if|if
condition|(
name|portno
operator|!=
literal|0
condition|)
block|{
name|TAILQ_FOREACH
argument_list|(
argument|addr
argument_list|,
argument|&port->addr_list
argument_list|,
argument|port_link
argument_list|)
block|{
operator|*
name|ptr
operator|++
operator|=
name|addr
operator|->
name|addr
expr_stmt|;
operator|*
name|pports
operator|++
operator|=
name|portno
expr_stmt|;
block|}
block|}
else|else
block|{
name|TAILQ_FOREACH
argument_list|(
argument|port
argument_list|,
argument|&cc->port_list
argument_list|,
argument|node_link
argument_list|)
name|TAILQ_FOREACH
argument_list|(
argument|addr
argument_list|,
argument|&port->addr_list
argument_list|,
argument|port_link
argument_list|)
block|{
operator|*
name|ptr
operator|++
operator|=
name|addr
operator|->
name|addr
expr_stmt|;
operator|*
name|pports
operator|++
operator|=
name|port
operator|->
name|param
operator|.
name|port
expr_stmt|;
block|}
block|}
operator|*
name|pa
operator|=
name|buf
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * return port number  */
end_comment

begin_function
name|u_int
name|cc_port_no
parameter_list|(
name|struct
name|ccport
modifier|*
name|port
parameter_list|)
block|{
return|return
operator|(
name|port
operator|->
name|param
operator|.
name|port
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Address unregisterd.  */
end_comment

begin_function
name|int
name|cc_addr_unregister
parameter_list|(
name|struct
name|ccdata
modifier|*
name|cc
parameter_list|,
name|u_int
name|portno
parameter_list|,
specifier|const
name|struct
name|uni_addr
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ccport
modifier|*
name|port
decl_stmt|;
name|struct
name|ccaddr
modifier|*
name|a
decl_stmt|;
if|if
condition|(
operator|(
name|port
operator|=
name|find_port
argument_list|(
name|cc
argument_list|,
name|portno
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOENT
operator|)
return|;
comment|/* Find the address */
name|TAILQ_FOREACH
argument_list|(
argument|a
argument_list|,
argument|&port->addr_list
argument_list|,
argument|port_link
argument_list|)
if|if
condition|(
name|addr_eq
argument_list|(
name|arg
argument_list|,
operator|&
name|a
operator|->
name|addr
argument_list|)
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|port
operator|->
name|addr_list
argument_list|,
name|a
argument_list|,
name|port_link
argument_list|)
expr_stmt|;
name|CCFREE
argument_list|(
name|a
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Address registerd.  */
end_comment

begin_function
name|int
name|cc_addr_register
parameter_list|(
name|struct
name|ccdata
modifier|*
name|cc
parameter_list|,
name|u_int
name|portno
parameter_list|,
specifier|const
name|struct
name|uni_addr
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ccport
modifier|*
name|port
decl_stmt|,
modifier|*
name|p1
decl_stmt|;
name|struct
name|ccaddr
modifier|*
name|a
decl_stmt|;
if|if
condition|(
operator|(
name|port
operator|=
name|find_port
argument_list|(
name|cc
argument_list|,
name|portno
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOENT
operator|)
return|;
comment|/* maybe we know it already? */
name|TAILQ_FOREACH
argument_list|(
argument|p1
argument_list|,
argument|&port->cc->port_list
argument_list|,
argument|node_link
argument_list|)
name|TAILQ_FOREACH
argument_list|(
argument|a
argument_list|,
argument|&p1->addr_list
argument_list|,
argument|port_link
argument_list|)
if|if
condition|(
name|addr_eq
argument_list|(
name|arg
argument_list|,
operator|&
name|a
operator|->
name|addr
argument_list|)
condition|)
return|return
operator|(
name|EISCONN
operator|)
return|;
name|a
operator|=
name|CCZALLOC
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|a
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|a
operator|->
name|addr
operator|=
operator|*
name|arg
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|port
operator|->
name|addr_list
argument_list|,
name|a
argument_list|,
name|port_link
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Set/get port parameters.  */
end_comment

begin_function
name|int
name|cc_port_get_param
parameter_list|(
name|struct
name|ccdata
modifier|*
name|cc
parameter_list|,
name|u_int
name|portno
parameter_list|,
name|struct
name|atm_port_info
modifier|*
name|param
parameter_list|)
block|{
name|struct
name|ccport
modifier|*
name|port
decl_stmt|;
if|if
condition|(
operator|(
name|port
operator|=
name|find_port
argument_list|(
name|cc
argument_list|,
name|portno
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOENT
operator|)
return|;
operator|*
name|param
operator|=
name|port
operator|->
name|param
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/* XXX maybe allow only in stopped. */
end_comment

begin_function
name|int
name|cc_port_set_param
parameter_list|(
name|struct
name|ccdata
modifier|*
name|cc
parameter_list|,
specifier|const
name|struct
name|atm_port_info
modifier|*
name|param
parameter_list|)
block|{
name|struct
name|ccport
modifier|*
name|port
decl_stmt|;
name|struct
name|ccaddr
modifier|*
name|addr
decl_stmt|;
if|if
condition|(
operator|(
name|port
operator|=
name|find_port
argument_list|(
name|cc
argument_list|,
name|param
operator|->
name|port
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOENT
operator|)
return|;
name|port
operator|->
name|param
operator|=
operator|*
name|param
expr_stmt|;
name|port
operator|->
name|param
operator|.
name|num_addrs
operator|=
literal|0
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|addr
argument_list|,
argument|&port->addr_list
argument_list|,
argument|port_link
argument_list|)
name|port
operator|->
name|param
operator|.
name|num_addrs
operator|++
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * get port list  */
end_comment

begin_function
name|int
name|cc_port_getlist
parameter_list|(
name|struct
name|ccdata
modifier|*
name|cc
parameter_list|,
name|u_int
modifier|*
name|cnt
parameter_list|,
name|u_int
modifier|*
modifier|*
name|ports
parameter_list|)
block|{
name|struct
name|ccport
modifier|*
name|p
decl_stmt|;
name|u_int
name|n
decl_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|p
argument_list|,
argument|&cc->port_list
argument_list|,
argument|node_link
argument_list|)
name|n
operator|++
expr_stmt|;
operator|*
name|ports
operator|=
name|CCMALLOC
argument_list|(
name|n
operator|*
sizeof|sizeof
argument_list|(
name|u_int
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|ports
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|n
operator|=
literal|0
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
name|p
argument_list|,
operator|&
name|cc
operator|->
name|port_list
argument_list|,
name|node_link
argument_list|)
argument_list|(
operator|*
name|ports
argument_list|)
index|[
name|n
operator|++
index|]
operator|=
name|p
operator|->
name|param
operator|.
name|port
expr_stmt|;
operator|*
name|cnt
operator|=
name|n
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * START and STOP signalling  */
end_comment

begin_function
name|int
name|cc_port_start
parameter_list|(
name|struct
name|ccdata
modifier|*
name|cc
parameter_list|,
name|u_int
name|portno
parameter_list|)
block|{
name|struct
name|ccport
modifier|*
name|port
decl_stmt|;
if|if
condition|(
operator|(
name|port
operator|=
name|find_port
argument_list|(
name|cc
argument_list|,
name|portno
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOENT
operator|)
return|;
if|if
condition|(
name|port
operator|->
name|admin
operator|!=
name|CCPORT_STOPPED
condition|)
return|return
operator|(
name|EISCONN
operator|)
return|;
name|cc
operator|->
name|funcs
operator|->
name|send_uni_glob
argument_list|(
name|port
argument_list|,
name|port
operator|->
name|uarg
argument_list|,
name|UNIAPI_LINK_ESTABLISH_request
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|port
operator|->
name|admin
operator|=
name|CCPORT_RUNNING
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|cc_port_stop
parameter_list|(
name|struct
name|ccdata
modifier|*
name|cc
parameter_list|,
name|u_int
name|portno
parameter_list|)
block|{
name|struct
name|ccport
modifier|*
name|port
decl_stmt|;
if|if
condition|(
operator|(
name|port
operator|=
name|find_port
argument_list|(
name|cc
argument_list|,
name|portno
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOENT
operator|)
return|;
if|if
condition|(
name|port
operator|->
name|admin
operator|!=
name|CCPORT_RUNNING
condition|)
return|return
operator|(
name|ENOTCONN
operator|)
return|;
name|port
operator|->
name|admin
operator|=
name|CCPORT_STOPPED
expr_stmt|;
comment|/* 	 * Abort all connections. 	 */
while|while
condition|(
operator|!
name|LIST_EMPTY
argument_list|(
operator|&
name|port
operator|->
name|conn_list
argument_list|)
condition|)
name|cc_conn_destroy
argument_list|(
name|LIST_FIRST
argument_list|(
operator|&
name|port
operator|->
name|conn_list
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * is port running?  */
end_comment

begin_function
name|int
name|cc_port_isrunning
parameter_list|(
name|struct
name|ccdata
modifier|*
name|cc
parameter_list|,
name|u_int
name|portno
parameter_list|,
name|int
modifier|*
name|state
parameter_list|)
block|{
name|struct
name|ccport
modifier|*
name|port
decl_stmt|;
if|if
condition|(
operator|(
name|port
operator|=
name|find_port
argument_list|(
name|cc
argument_list|,
name|portno
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOENT
operator|)
return|;
if|if
condition|(
name|port
operator|->
name|admin
operator|==
name|CCPORT_RUNNING
condition|)
operator|*
name|state
operator|=
literal|1
expr_stmt|;
else|else
operator|*
name|state
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Clear address and prefix information from the named port.  */
end_comment

begin_function
name|int
name|cc_port_clear
parameter_list|(
name|struct
name|ccdata
modifier|*
name|cc
parameter_list|,
name|u_int
name|portno
parameter_list|)
block|{
name|struct
name|ccaddr
modifier|*
name|addr
decl_stmt|;
name|struct
name|ccport
modifier|*
name|port
decl_stmt|;
if|if
condition|(
operator|(
name|port
operator|=
name|find_port
argument_list|(
name|cc
argument_list|,
name|portno
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOENT
operator|)
return|;
while|while
condition|(
operator|(
name|addr
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|port
operator|->
name|addr_list
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|port
operator|->
name|addr_list
argument_list|,
name|addr
argument_list|,
name|port_link
argument_list|)
expr_stmt|;
name|CCFREE
argument_list|(
name|addr
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * retrieve info on local ports  */
end_comment

begin_function
name|struct
name|atm_port_list
modifier|*
name|cc_get_local_port_info
parameter_list|(
name|struct
name|ccdata
modifier|*
name|cc
parameter_list|,
name|u_int
name|portno
parameter_list|,
name|size_t
modifier|*
name|lenp
parameter_list|)
block|{
name|struct
name|atm_port_list
modifier|*
name|list
decl_stmt|;
name|struct
name|atm_port_info
modifier|*
name|pp
decl_stmt|;
name|struct
name|uni_addr
modifier|*
name|aa
decl_stmt|;
name|struct
name|ccaddr
modifier|*
name|addr
decl_stmt|;
name|struct
name|ccport
modifier|*
name|port
decl_stmt|;
name|u_int
name|nports
decl_stmt|,
name|naddrs
decl_stmt|;
comment|/* 	 * Count ports and addresses. 	 */
name|nports
operator|=
literal|0
expr_stmt|;
name|naddrs
operator|=
literal|0
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|port
argument_list|,
argument|&cc->port_list
argument_list|,
argument|node_link
argument_list|)
block|{
if|if
condition|(
name|portno
operator|==
literal|0
operator|||
name|port
operator|->
name|param
operator|.
name|port
operator|==
name|portno
condition|)
block|{
name|nports
operator|++
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|addr
argument_list|,
argument|&port->addr_list
argument_list|,
argument|port_link
argument_list|)
name|naddrs
operator|++
expr_stmt|;
block|}
block|}
comment|/* 	 * Size and allocate message 	 */
operator|*
name|lenp
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|list
argument_list|)
operator|+
name|nports
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|pp
argument_list|)
operator|+
name|naddrs
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|aa
argument_list|)
expr_stmt|;
name|list
operator|=
name|CCZALLOC
argument_list|(
operator|*
name|lenp
argument_list|)
expr_stmt|;
if|if
condition|(
name|list
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
comment|/* 	 * Fill the message. 	 */
name|list
operator|->
name|num_ports
operator|=
name|nports
expr_stmt|;
name|list
operator|->
name|num_addrs
operator|=
name|naddrs
expr_stmt|;
name|pp
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|u_char
operator|*
operator|)
name|list
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|list
argument_list|)
operator|)
expr_stmt|;
name|aa
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|u_char
operator|*
operator|)
name|list
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|list
argument_list|)
operator|+
name|nports
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|pp
argument_list|)
operator|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|port
argument_list|,
argument|&cc->port_list
argument_list|,
argument|node_link
argument_list|)
block|{
if|if
condition|(
name|portno
operator|==
literal|0
operator|||
name|port
operator|->
name|param
operator|.
name|port
operator|==
name|portno
condition|)
block|{
operator|*
name|pp
operator|=
name|port
operator|->
name|param
expr_stmt|;
name|pp
operator|->
name|num_addrs
operator|=
literal|0
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|addr
argument_list|,
argument|&port->addr_list
argument_list|,
argument|port_link
argument_list|)
block|{
operator|*
name|aa
operator|++
operator|=
name|addr
operator|->
name|addr
expr_stmt|;
name|pp
operator|->
name|num_addrs
operator|++
expr_stmt|;
block|}
name|pp
operator|++
expr_stmt|;
block|}
block|}
return|return
operator|(
name|list
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ccreq
modifier|*
name|find_cookie
parameter_list|(
name|struct
name|ccport
modifier|*
name|port
parameter_list|,
name|u_int
name|cookie
parameter_list|)
block|{
name|struct
name|ccreq
modifier|*
name|r
decl_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|r
argument_list|,
argument|&port->cookies
argument_list|,
argument|link
argument_list|)
if|if
condition|(
name|r
operator|->
name|cookie
operator|==
name|cookie
condition|)
return|return
operator|(
name|r
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * input a response from the UNI layer to CC  */
end_comment

begin_function
name|int
name|cc_uni_response
parameter_list|(
name|struct
name|ccport
modifier|*
name|port
parameter_list|,
name|u_int
name|cookie
parameter_list|,
name|u_int
name|reason
parameter_list|,
name|u_int
name|state
parameter_list|)
block|{
name|struct
name|ccconn
modifier|*
name|conn
decl_stmt|;
name|struct
name|ccreq
modifier|*
name|req
decl_stmt|;
if|if
condition|(
name|cookie
operator|==
literal|0
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
if|if
condition|(
name|port
operator|->
name|admin
operator|!=
name|CCPORT_RUNNING
condition|)
return|return
operator|(
name|ENOTCONN
operator|)
return|;
if|if
condition|(
operator|(
name|req
operator|=
name|find_cookie
argument_list|(
name|port
argument_list|,
name|cookie
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|cc_port_log
argument_list|(
name|port
argument_list|,
literal|"UNI response for unknown cookie %u"
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|conn
operator|=
name|req
operator|->
name|conn
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|port
operator|->
name|cookies
argument_list|,
name|req
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|CCFREE
argument_list|(
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|reason
operator|==
name|UNIAPI_OK
condition|)
return|return
operator|(
name|cc_conn_resp
argument_list|(
name|conn
argument_list|,
name|CONN_SIG_OK
argument_list|,
name|cookie
argument_list|,
name|reason
argument_list|,
name|state
argument_list|)
operator|)
return|;
else|else
return|return
operator|(
name|cc_conn_resp
argument_list|(
name|conn
argument_list|,
name|CONN_SIG_ERROR
argument_list|,
name|cookie
argument_list|,
name|reason
argument_list|,
name|state
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ccconn
modifier|*
name|find_cref
parameter_list|(
specifier|const
name|struct
name|ccport
modifier|*
name|port
parameter_list|,
specifier|const
name|struct
name|uni_cref
modifier|*
name|cref
parameter_list|)
block|{
name|struct
name|ccconn
modifier|*
name|conn
decl_stmt|;
name|LIST_FOREACH
argument_list|(
argument|conn
argument_list|,
argument|&port->conn_list
argument_list|,
argument|port_link
argument_list|)
if|if
condition|(
name|conn
operator|->
name|cref
operator|.
name|cref
operator|==
name|cref
operator|->
name|cref
operator|&&
name|conn
operator|->
name|cref
operator|.
name|flag
operator|==
name|cref
operator|->
name|flag
condition|)
return|return
operator|(
name|conn
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Signal from UNI on this port  */
end_comment

begin_function
name|int
name|cc_uni_signal
parameter_list|(
name|struct
name|ccport
modifier|*
name|port
parameter_list|,
name|u_int
name|cookie
parameter_list|,
name|u_int
name|sig
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|msg
parameter_list|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|ilen
init|=
literal|0
decl_stmt|;
name|struct
name|uni_cref
modifier|*
name|cref
decl_stmt|;
name|struct
name|ccconn
modifier|*
name|conn
decl_stmt|;
if|if
condition|(
name|port
operator|->
name|admin
operator|!=
name|CCPORT_RUNNING
condition|)
block|{
name|error
operator|=
name|ENOTCONN
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|len
operator|=
operator|(
name|msg
operator|!=
name|NULL
operator|)
condition|?
name|uni_msg_len
argument_list|(
name|msg
argument_list|)
else|:
literal|0
expr_stmt|;
switch|switch
condition|(
operator|(
expr|enum
name|uni_sig
operator|)
name|sig
condition|)
block|{
case|case
name|UNIAPI_ERROR
case|:
comment|/* handled above */
name|cc_port_log
argument_list|(
name|port
argument_list|,
literal|"bad UNIAPI_ERROR cookie=%u"
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
case|case
name|UNIAPI_CALL_CREATED
case|:
name|ilen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|uniapi_call_created
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
name|ilen
condition|)
goto|goto
name|bad_len
goto|;
if|if
condition|(
name|cookie
operator|!=
literal|0
condition|)
block|{
comment|/* outgoing call */
name|struct
name|ccreq
modifier|*
name|req
decl_stmt|;
if|if
condition|(
operator|(
name|req
operator|=
name|find_cookie
argument_list|(
name|port
argument_list|,
name|cookie
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|cc_port_log
argument_list|(
name|port
argument_list|,
literal|"bad cookie %u in CREATE"
argument_list|,
name|cookie
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|conn
operator|=
name|req
operator|->
name|conn
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|conn
operator|=
name|cc_conn_create
argument_list|(
name|port
operator|->
name|cc
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|error
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|cc_conn_ins_port
argument_list|(
name|conn
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
name|cc_conn_sig_msg_nodef
argument_list|(
name|conn
argument_list|,
name|CONN_SIG_CREATED
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
goto|goto
name|out
goto|;
case|case
name|UNIAPI_CALL_DESTROYED
case|:
name|ilen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|uniapi_call_destroyed
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
name|ilen
condition|)
goto|goto
name|bad_len
goto|;
name|cref
operator|=
operator|&
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_call_destroyed
operator|*
argument_list|)
operator|->
name|cref
expr_stmt|;
if|if
condition|(
operator|(
name|conn
operator|=
name|find_cref
argument_list|(
name|port
argument_list|,
name|cref
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|unk_call
goto|;
name|error
operator|=
name|cc_conn_sig
argument_list|(
name|conn
argument_list|,
name|CONN_SIG_DESTROYED
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
case|case
name|UNIAPI_LINK_ESTABLISH_confirm
case|:
goto|goto
name|out
goto|;
case|case
name|UNIAPI_LINK_RELEASE_confirm
case|:
comment|/* Ups. If we administratively up, restart the link */
if|if
condition|(
name|port
operator|->
name|admin
operator|==
name|CCPORT_RUNNING
condition|)
name|port
operator|->
name|cc
operator|->
name|funcs
operator|->
name|send_uni_glob
argument_list|(
name|port
argument_list|,
name|port
operator|->
name|uarg
argument_list|,
name|UNIAPI_LINK_ESTABLISH_request
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
case|case
name|UNIAPI_PARTY_CREATED
case|:
name|ilen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|uniapi_party_created
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
name|ilen
condition|)
goto|goto
name|bad_len
goto|;
name|cref
operator|=
operator|&
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_party_created
operator|*
argument_list|)
operator|->
name|cref
expr_stmt|;
if|if
condition|(
operator|(
name|conn
operator|=
name|find_cref
argument_list|(
name|port
argument_list|,
name|cref
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|unk_call
goto|;
name|error
operator|=
name|cc_conn_sig_msg_nodef
argument_list|(
name|conn
argument_list|,
name|CONN_SIG_PARTY_CREATED
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
goto|goto
name|out
goto|;
case|case
name|UNIAPI_PARTY_DESTROYED
case|:
name|ilen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|uniapi_party_destroyed
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
name|ilen
condition|)
goto|goto
name|bad_len
goto|;
name|cref
operator|=
operator|&
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_party_destroyed
operator|*
argument_list|)
operator|->
name|cref
expr_stmt|;
if|if
condition|(
operator|(
name|conn
operator|=
name|find_cref
argument_list|(
name|port
argument_list|,
name|cref
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|unk_call
goto|;
name|error
operator|=
name|cc_conn_sig_msg
argument_list|(
name|conn
argument_list|,
name|CONN_SIG_PARTY_DESTROYED
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
goto|goto
name|out
goto|;
case|case
name|UNIAPI_DROP_PARTY_ACK_indication
case|:
comment|/* UNI -> API */
name|ilen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|uniapi_drop_party_ack_indication
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
name|ilen
condition|)
goto|goto
name|bad_len
goto|;
name|cref
operator|=
operator|&
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_drop_party_ack_indication
operator|*
argument_list|)
operator|->
name|drop
operator|.
name|hdr
operator|.
name|cref
expr_stmt|;
if|if
condition|(
operator|(
name|conn
operator|=
name|find_cref
argument_list|(
name|port
argument_list|,
name|cref
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|unk_call
goto|;
name|error
operator|=
name|cc_conn_sig_msg
argument_list|(
name|conn
argument_list|,
name|CONN_SIG_DROP_PARTY_ACK_IND
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
goto|goto
name|out
goto|;
case|case
name|UNIAPI_RESET_indication
case|:
comment|/* UNI -> API */
block|{
comment|/* 		 * XXX - do the right thing 		 */
name|struct
name|uniapi_reset_indication
modifier|*
name|ind
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_reset_indication
operator|*
argument_list|)
decl_stmt|;
name|struct
name|uniapi_reset_response
modifier|*
name|resp
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|u
decl_stmt|;
comment|/* 		 * Construct message to UNI. 		 */
if|if
condition|(
operator|(
name|u
operator|=
name|uni_msg_alloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|resp
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
name|resp
operator|=
name|uni_msg_wptr
argument_list|(
name|u
argument_list|,
expr|struct
name|uniapi_reset_response
operator|*
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|resp
argument_list|)
argument_list|)
expr_stmt|;
name|u
operator|->
name|b_wptr
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|resp
argument_list|)
expr_stmt|;
name|resp
operator|->
name|restart
operator|=
name|ind
operator|->
name|restart
expr_stmt|;
name|resp
operator|->
name|connid
operator|=
name|ind
operator|->
name|connid
expr_stmt|;
name|port
operator|->
name|cc
operator|->
name|funcs
operator|->
name|send_uni_glob
argument_list|(
name|port
argument_list|,
name|port
operator|->
name|uarg
argument_list|,
name|UNIAPI_RESET_response
argument_list|,
literal|0
argument_list|,
name|u
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
case|case
name|UNIAPI_RELEASE_indication
case|:
comment|/* UNI -> API */
name|ilen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|uniapi_release_indication
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
name|ilen
condition|)
goto|goto
name|bad_len
goto|;
name|cref
operator|=
operator|&
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_release_indication
operator|*
argument_list|)
operator|->
name|release
operator|.
name|hdr
operator|.
name|cref
expr_stmt|;
if|if
condition|(
operator|(
name|conn
operator|=
name|find_cref
argument_list|(
name|port
argument_list|,
name|cref
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|unk_call
goto|;
name|error
operator|=
name|cc_conn_sig_msg
argument_list|(
name|conn
argument_list|,
name|CONN_SIG_REL_IND
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
goto|goto
name|out
goto|;
case|case
name|UNIAPI_RELEASE_confirm
case|:
comment|/* UNI -> API */
name|ilen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|uniapi_release_confirm
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
name|ilen
condition|)
goto|goto
name|bad_len
goto|;
name|cref
operator|=
operator|&
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_release_confirm
operator|*
argument_list|)
operator|->
name|release
operator|.
name|hdr
operator|.
name|cref
expr_stmt|;
if|if
condition|(
operator|(
name|conn
operator|=
name|find_cref
argument_list|(
name|port
argument_list|,
name|cref
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|unk_call
goto|;
name|error
operator|=
name|cc_conn_sig_msg
argument_list|(
name|conn
argument_list|,
name|CONN_SIG_REL_CONF
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
goto|goto
name|out
goto|;
case|case
name|UNIAPI_SETUP_confirm
case|:
comment|/* UNI -> API */
name|ilen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|uniapi_setup_confirm
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
name|ilen
condition|)
goto|goto
name|bad_len
goto|;
name|cref
operator|=
operator|&
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_setup_confirm
operator|*
argument_list|)
operator|->
name|connect
operator|.
name|hdr
operator|.
name|cref
expr_stmt|;
if|if
condition|(
operator|(
name|conn
operator|=
name|find_cref
argument_list|(
name|port
argument_list|,
name|cref
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|unk_call
goto|;
name|error
operator|=
name|cc_conn_sig_msg
argument_list|(
name|conn
argument_list|,
name|CONN_SIG_SETUP_CONFIRM
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
goto|goto
name|out
goto|;
case|case
name|UNIAPI_ALERTING_indication
case|:
comment|/* UNI -> API */
name|ilen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|uniapi_alerting_indication
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
name|ilen
condition|)
goto|goto
name|bad_len
goto|;
name|cref
operator|=
operator|&
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_alerting_indication
operator|*
argument_list|)
operator|->
name|alerting
operator|.
name|hdr
operator|.
name|cref
expr_stmt|;
if|if
condition|(
operator|(
name|conn
operator|=
name|find_cref
argument_list|(
name|port
argument_list|,
name|cref
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|unk_call
goto|;
name|error
operator|=
name|cc_conn_sig_msg
argument_list|(
name|conn
argument_list|,
name|CONN_SIG_ALERTING_IND
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
goto|goto
name|out
goto|;
case|case
name|UNIAPI_PROCEEDING_indication
case|:
comment|/* UNI -> API */
name|ilen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|uniapi_proceeding_indication
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
name|ilen
condition|)
goto|goto
name|bad_len
goto|;
name|cref
operator|=
operator|&
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_proceeding_indication
operator|*
argument_list|)
operator|->
name|call_proc
operator|.
name|hdr
operator|.
name|cref
expr_stmt|;
if|if
condition|(
operator|(
name|conn
operator|=
name|find_cref
argument_list|(
name|port
argument_list|,
name|cref
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|unk_call
goto|;
name|error
operator|=
name|cc_conn_sig_msg
argument_list|(
name|conn
argument_list|,
name|CONN_SIG_PROC_IND
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
goto|goto
name|out
goto|;
case|case
name|UNIAPI_SETUP_indication
case|:
comment|/* UNI -> API */
name|ilen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|uniapi_setup_indication
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
name|ilen
condition|)
goto|goto
name|bad_len
goto|;
name|cref
operator|=
operator|&
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_setup_indication
operator|*
argument_list|)
operator|->
name|setup
operator|.
name|hdr
operator|.
name|cref
expr_stmt|;
if|if
condition|(
operator|(
name|conn
operator|=
name|find_cref
argument_list|(
name|port
argument_list|,
name|cref
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|unk_call
goto|;
name|error
operator|=
name|cc_conn_sig_msg
argument_list|(
name|conn
argument_list|,
name|CONN_SIG_SETUP_IND
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
goto|goto
name|out
goto|;
case|case
name|UNIAPI_SETUP_COMPLETE_indication
case|:
comment|/* UNI -> API */
name|ilen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|uniapi_setup_complete_indication
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
name|ilen
condition|)
goto|goto
name|bad_len
goto|;
name|cref
operator|=
operator|&
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_setup_complete_indication
operator|*
argument_list|)
operator|->
name|connect_ack
operator|.
name|hdr
operator|.
name|cref
expr_stmt|;
if|if
condition|(
operator|(
name|conn
operator|=
name|find_cref
argument_list|(
name|port
argument_list|,
name|cref
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|unk_call
goto|;
name|error
operator|=
name|cc_conn_sig_msg
argument_list|(
name|conn
argument_list|,
name|CONN_SIG_SETUP_COMPL
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
goto|goto
name|out
goto|;
case|case
name|UNIAPI_PARTY_ALERTING_indication
case|:
comment|/* UNI -> API */
name|ilen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|uniapi_party_alerting_indication
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
name|ilen
condition|)
goto|goto
name|bad_len
goto|;
name|cref
operator|=
operator|&
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_party_alerting_indication
operator|*
argument_list|)
operator|->
name|alert
operator|.
name|hdr
operator|.
name|cref
expr_stmt|;
if|if
condition|(
operator|(
name|conn
operator|=
name|find_cref
argument_list|(
name|port
argument_list|,
name|cref
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|unk_call
goto|;
name|error
operator|=
name|cc_conn_sig_msg
argument_list|(
name|conn
argument_list|,
name|CONN_SIG_PARTY_ALERTING_IND
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
goto|goto
name|out
goto|;
case|case
name|UNIAPI_ADD_PARTY_ACK_indication
case|:
comment|/* UNI -> API */
name|ilen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|uniapi_add_party_ack_indication
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
name|ilen
condition|)
goto|goto
name|bad_len
goto|;
name|cref
operator|=
operator|&
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_add_party_ack_indication
operator|*
argument_list|)
operator|->
name|ack
operator|.
name|hdr
operator|.
name|cref
expr_stmt|;
if|if
condition|(
operator|(
name|conn
operator|=
name|find_cref
argument_list|(
name|port
argument_list|,
name|cref
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|unk_call
goto|;
name|error
operator|=
name|cc_conn_sig_msg
argument_list|(
name|conn
argument_list|,
name|CONN_SIG_PARTY_ADD_ACK_IND
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
goto|goto
name|out
goto|;
case|case
name|UNIAPI_ADD_PARTY_REJ_indication
case|:
comment|/* UNI -> API */
name|ilen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|uniapi_add_party_rej_indication
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
name|ilen
condition|)
goto|goto
name|bad_len
goto|;
name|cref
operator|=
operator|&
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_add_party_rej_indication
operator|*
argument_list|)
operator|->
name|rej
operator|.
name|hdr
operator|.
name|cref
expr_stmt|;
if|if
condition|(
operator|(
name|conn
operator|=
name|find_cref
argument_list|(
name|port
argument_list|,
name|cref
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|unk_call
goto|;
name|error
operator|=
name|cc_conn_sig_msg
argument_list|(
name|conn
argument_list|,
name|CONN_SIG_PARTY_ADD_REJ_IND
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
goto|goto
name|out
goto|;
case|case
name|UNIAPI_DROP_PARTY_indication
case|:
comment|/* UNI -> API */
name|ilen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|uniapi_drop_party_indication
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
name|ilen
condition|)
goto|goto
name|bad_len
goto|;
name|cref
operator|=
operator|&
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_drop_party_indication
operator|*
argument_list|)
operator|->
name|drop
operator|.
name|hdr
operator|.
name|cref
expr_stmt|;
if|if
condition|(
operator|(
name|conn
operator|=
name|find_cref
argument_list|(
name|port
argument_list|,
name|cref
argument_list|)
operator|)
operator|==
name|NULL
condition|)
goto|goto
name|unk_call
goto|;
name|error
operator|=
name|cc_conn_sig_msg
argument_list|(
name|conn
argument_list|,
name|CONN_SIG_DROP_PARTY_IND
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
goto|goto
name|out
goto|;
case|case
name|UNIAPI_RESET_confirm
case|:
comment|/* UNI -> API */
case|case
name|UNIAPI_RESET_ERROR_indication
case|:
comment|/* UNI -> API */
case|case
name|UNIAPI_RESET_STATUS_indication
case|:
comment|/* UNI -> API */
comment|/* XXX */
goto|goto
name|out
goto|;
case|case
name|UNIAPI_NOTIFY_indication
case|:
comment|/* UNI -> API */
case|case
name|UNIAPI_STATUS_indication
case|:
comment|/* UNI -> API */
break|break;
case|case
name|UNIAPI_ADD_PARTY_indication
case|:
comment|/* UNI -> API */
comment|/* not supported by the API */
break|break;
comment|/* 	 * All these are illegal in this direction 	 */
case|case
name|UNIAPI_LINK_ESTABLISH_request
case|:
comment|/* API -> UNI */
case|case
name|UNIAPI_LINK_RELEASE_request
case|:
comment|/* API -> UNI */
case|case
name|UNIAPI_RESET_request
case|:
comment|/* API -> UNI */
case|case
name|UNIAPI_RESET_response
case|:
comment|/* API -> UNI */
case|case
name|UNIAPI_RESET_ERROR_response
case|:
comment|/* API -> UNI */
case|case
name|UNIAPI_SETUP_request
case|:
comment|/* API -> UNI */
case|case
name|UNIAPI_SETUP_response
case|:
comment|/* API -> UNI */
case|case
name|UNIAPI_ALERTING_request
case|:
comment|/* API -> UNI */
case|case
name|UNIAPI_PROCEEDING_request
case|:
comment|/* API -> UNI */
case|case
name|UNIAPI_RELEASE_request
case|:
comment|/* API -> UNI */
case|case
name|UNIAPI_RELEASE_response
case|:
comment|/* API -> UNI */
case|case
name|UNIAPI_NOTIFY_request
case|:
comment|/* API -> UNI */
case|case
name|UNIAPI_STATUS_ENQUIRY_request
case|:
comment|/* API -> UNI */
case|case
name|UNIAPI_ADD_PARTY_request
case|:
comment|/* API -> UNI */
case|case
name|UNIAPI_PARTY_ALERTING_request
case|:
comment|/* API -> UNI */
case|case
name|UNIAPI_ADD_PARTY_ACK_request
case|:
comment|/* API -> UNI */
case|case
name|UNIAPI_ADD_PARTY_REJ_request
case|:
comment|/* API -> UNI */
case|case
name|UNIAPI_DROP_PARTY_request
case|:
comment|/* API -> UNI */
case|case
name|UNIAPI_DROP_PARTY_ACK_request
case|:
comment|/* API -> UNI */
case|case
name|UNIAPI_ABORT_CALL_request
case|:
comment|/* API -> UNI */
case|case
name|UNIAPI_SETUP_COMPLETE_request
case|:
comment|/* API -> UNI */
case|case
name|UNIAPI_MAXSIG
case|:
break|break;
block|}
name|cc_port_log
argument_list|(
name|port
argument_list|,
literal|"bad signal %u"
argument_list|,
name|sig
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
name|bad_len
label|:
name|cc_port_log
argument_list|(
name|port
argument_list|,
literal|"signal %u bad length: %zu, need %zu"
argument_list|,
name|len
argument_list|,
name|ilen
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
name|unk_call
label|:
name|cc_port_log
argument_list|(
name|port
argument_list|,
literal|"unknown call %u/%u"
argument_list|,
name|cref
operator|->
name|cref
argument_list|,
name|cref
operator|->
name|flag
argument_list|)
expr_stmt|;
name|error
operator|=
name|EINVAL
expr_stmt|;
name|out
label|:
if|if
condition|(
name|msg
operator|!=
name|NULL
condition|)
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

end_unit


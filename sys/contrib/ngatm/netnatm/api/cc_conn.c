begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2003-2007  *	Hartmut Brandt  *	All rights reserved.  *  * Copyright (c) 2001-2002  *	Fraunhofer Institute for Open Communication Systems (FhG Fokus).  *	All rights reserved.  *  * Author: Harti Brandt<harti@freebsd.org>  *  * Redistribution of this software and documentation and use in source and  * binary forms, with or without modification, are permitted provided that  * the following conditions are met:  *  * 1. Redistributions of source code or documentation must retain the above  *    copyright notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  *  * THIS SOFTWARE AND DOCUMENTATION IS PROVIDED BY THE AUTHOR  * AND ITS CONTRIBUTORS ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES,  * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND  * FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL  * THE AUTHOR OR ITS CONTRIBUTORS  BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT  * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,  * OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF  * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING  * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,  * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *  * $Id: cc_conn.c 1291 2007-07-10 10:35:38Z brandt_h $  *  * ATM API as defined per af-saa-0108  *  * Lower half - connection handling  */
end_comment

begin_include
include|#
directive|include
file|<netnatm/unimsg.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/msg/unistruct.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/msg/unimsglib.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/api/unisap.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/sig/unidef.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/api/atmapi.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/api/ccatm.h>
end_include

begin_include
include|#
directive|include
file|<netnatm/api/ccpriv.h>
end_include

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|stab
index|[]
init|=
block|{
define|#
directive|define
name|DEF
parameter_list|(
name|N
parameter_list|)
value|[N] = #N,
name|CONN_STATES
undef|#
directive|undef
name|DEF
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|ptab
index|[]
init|=
block|{
define|#
directive|define
name|DEF
parameter_list|(
name|N
parameter_list|)
value|[PARTY_##N] = #N,
name|PARTY_STATES
undef|#
directive|undef
name|DEF
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|const
name|char
modifier|*
name|cc_conn_state2str
parameter_list|(
name|u_int
name|s
parameter_list|)
block|{
if|if
condition|(
name|s
operator|>=
sizeof|sizeof
argument_list|(
name|stab
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|stab
index|[
literal|0
index|]
argument_list|)
operator|||
name|stab
index|[
name|s
index|]
operator|==
name|NULL
condition|)
return|return
operator|(
literal|"?"
operator|)
return|;
return|return
operator|(
name|stab
index|[
name|s
index|]
operator|)
return|;
block|}
end_function

begin_function
name|void
name|cc_conn_set_state
parameter_list|(
name|struct
name|ccconn
modifier|*
name|conn
parameter_list|,
name|enum
name|conn_state
name|ns
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|->
name|state
operator|!=
name|ns
condition|)
block|{
if|if
condition|(
name|conn
operator|->
name|cc
operator|->
name|log
operator|&
name|CCLOG_CONN_STATE
condition|)
name|cc_conn_log
argument_list|(
name|conn
argument_list|,
literal|"%s -> %s"
argument_list|,
name|stab
index|[
name|conn
operator|->
name|state
index|]
argument_list|,
name|stab
index|[
name|ns
index|]
argument_list|)
expr_stmt|;
name|conn
operator|->
name|state
operator|=
name|ns
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|cc_party_state2str
parameter_list|(
name|u_int
name|s
parameter_list|)
block|{
if|if
condition|(
name|s
operator|>=
sizeof|sizeof
argument_list|(
name|ptab
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|ptab
index|[
literal|0
index|]
argument_list|)
operator|||
name|ptab
index|[
name|s
index|]
operator|==
name|NULL
condition|)
return|return
operator|(
literal|"?"
operator|)
return|;
return|return
operator|(
name|ptab
index|[
name|s
index|]
operator|)
return|;
block|}
end_function

begin_function
name|void
name|cc_party_set_state
parameter_list|(
name|struct
name|ccparty
modifier|*
name|party
parameter_list|,
name|enum
name|party_state
name|ns
parameter_list|)
block|{
if|if
condition|(
name|party
operator|->
name|state
operator|!=
name|ns
condition|)
block|{
if|if
condition|(
name|party
operator|->
name|conn
operator|->
name|cc
operator|->
name|log
operator|&
name|CCLOG_PARTY_STATE
condition|)
name|cc_party_log
argument_list|(
name|party
argument_list|,
literal|"%s -> %s"
argument_list|,
name|ptab
index|[
name|party
operator|->
name|state
index|]
argument_list|,
name|ptab
index|[
name|ns
index|]
argument_list|)
expr_stmt|;
name|party
operator|->
name|state
operator|=
name|ns
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Remove connection from its user's queue  */
end_comment

begin_function
name|void
name|cc_disconnect_from_user
parameter_list|(
name|struct
name|ccconn
modifier|*
name|conn
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|->
name|user
operator|==
name|NULL
condition|)
name|cc_conn_log
argument_list|(
name|conn
argument_list|,
literal|"no %s"
argument_list|,
literal|"user"
argument_list|)
expr_stmt|;
else|else
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|conn
operator|->
name|user
operator|->
name|connq
argument_list|,
name|conn
argument_list|,
name|connq_link
argument_list|)
expr_stmt|;
name|conn
operator|->
name|user
operator|->
name|queue_act
operator|--
expr_stmt|;
name|conn
operator|->
name|user
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Put connection on user queue  */
end_comment

begin_function
name|void
name|cc_connect_to_user
parameter_list|(
name|struct
name|ccconn
modifier|*
name|conn
parameter_list|,
name|struct
name|ccuser
modifier|*
name|user
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|->
name|user
operator|!=
name|NULL
condition|)
name|cc_conn_log
argument_list|(
name|conn
argument_list|,
literal|"still connected to %p"
argument_list|,
name|conn
operator|->
name|user
argument_list|)
expr_stmt|;
name|conn
operator|->
name|user
operator|=
name|user
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|user
operator|->
name|connq
argument_list|,
name|conn
argument_list|,
name|connq_link
argument_list|)
expr_stmt|;
name|conn
operator|->
name|user
operator|->
name|queue_act
operator|++
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Send a signal to the UNI stack for this connection  */
end_comment

begin_function
specifier|static
name|void
name|cc_send_uni
parameter_list|(
name|struct
name|ccconn
modifier|*
name|conn
parameter_list|,
name|u_int
name|op
parameter_list|,
name|struct
name|uni_msg
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|ccreq
modifier|*
name|r
decl_stmt|;
name|r
operator|=
name|CCZALLOC
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|r
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|msg
operator|!=
name|NULL
condition|)
name|uni_msg_destroy
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|cc_conn_log
argument_list|(
name|conn
argument_list|,
literal|"no memory for cookie op=%u"
argument_list|,
name|op
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|r
operator|->
name|cookie
operator|=
operator|++
name|conn
operator|->
name|port
operator|->
name|cc
operator|->
name|cookie
operator|)
operator|==
literal|0
condition|)
name|r
operator|->
name|cookie
operator|=
operator|++
name|conn
operator|->
name|port
operator|->
name|cc
operator|->
name|cookie
expr_stmt|;
name|r
operator|->
name|req
operator|=
name|op
expr_stmt|;
name|r
operator|->
name|conn
operator|=
name|conn
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|conn
operator|->
name|port
operator|->
name|cookies
argument_list|,
name|r
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|conn
operator|->
name|port
operator|->
name|cc
operator|->
name|funcs
operator|->
name|send_uni
argument_list|(
name|conn
argument_list|,
name|conn
operator|->
name|port
operator|->
name|uarg
argument_list|,
name|op
argument_list|,
name|r
operator|->
name|cookie
argument_list|,
name|msg
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Send a RELEASE.request for this connection.  */
end_comment

begin_function
specifier|static
name|void
name|do_release_request
parameter_list|(
name|struct
name|ccconn
modifier|*
name|conn
parameter_list|,
specifier|const
name|struct
name|uni_ie_cause
name|cause
index|[
literal|2
index|]
parameter_list|)
block|{
name|struct
name|uni_msg
modifier|*
name|u
decl_stmt|;
name|struct
name|uniapi_release_request
modifier|*
name|req
decl_stmt|;
if|if
condition|(
operator|(
name|u
operator|=
name|uni_msg_alloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
name|req
operator|=
name|uni_msg_wptr
argument_list|(
name|u
argument_list|,
expr|struct
name|uniapi_release_request
operator|*
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|u
operator|->
name|b_wptr
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|uniapi_release_request
argument_list|)
expr_stmt|;
name|req
operator|->
name|release
operator|.
name|hdr
operator|.
name|cref
operator|=
name|conn
operator|->
name|cref
expr_stmt|;
name|req
operator|->
name|release
operator|.
name|hdr
operator|.
name|act
operator|=
name|UNI_MSGACT_DEFAULT
expr_stmt|;
if|if
condition|(
name|cause
operator|==
name|NULL
condition|)
block|{
name|IE_SETPRESENT
argument_list|(
name|req
operator|->
name|release
operator|.
name|cause
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|req
operator|->
name|release
operator|.
name|cause
index|[
literal|0
index|]
operator|.
name|h
operator|.
name|act
operator|=
name|UNI_IEACT_DEFAULT
expr_stmt|;
name|req
operator|->
name|release
operator|.
name|cause
index|[
literal|0
index|]
operator|.
name|loc
operator|=
name|UNI_CAUSE_LOC_USER
expr_stmt|;
name|req
operator|->
name|release
operator|.
name|cause
index|[
literal|0
index|]
operator|.
name|cause
operator|=
name|UNI_CAUSE_UNSPEC
expr_stmt|;
block|}
else|else
block|{
name|req
operator|->
name|release
operator|.
name|cause
index|[
literal|0
index|]
operator|=
name|cause
index|[
literal|0
index|]
expr_stmt|;
name|req
operator|->
name|release
operator|.
name|cause
index|[
literal|1
index|]
operator|=
name|cause
index|[
literal|1
index|]
expr_stmt|;
block|}
name|cc_send_uni
argument_list|(
name|conn
argument_list|,
name|UNIAPI_RELEASE_request
argument_list|,
name|u
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Make a RELEASE.response for this connection  */
end_comment

begin_function
specifier|static
name|void
name|do_release_response
parameter_list|(
name|struct
name|ccconn
modifier|*
name|conn
parameter_list|,
name|uint8_t
name|cause
parameter_list|,
name|struct
name|uni_ie_cause
modifier|*
name|ie
parameter_list|)
block|{
name|struct
name|uni_msg
modifier|*
name|u
decl_stmt|;
name|struct
name|uniapi_release_response
modifier|*
name|resp
decl_stmt|;
if|if
condition|(
operator|(
name|u
operator|=
name|uni_msg_alloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|resp
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
name|resp
operator|=
name|uni_msg_wptr
argument_list|(
name|u
argument_list|,
expr|struct
name|uniapi_release_response
operator|*
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|resp
argument_list|)
argument_list|)
expr_stmt|;
name|u
operator|->
name|b_wptr
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|uniapi_release_response
argument_list|)
expr_stmt|;
name|resp
operator|->
name|release_compl
operator|.
name|hdr
operator|.
name|cref
operator|=
name|conn
operator|->
name|cref
expr_stmt|;
name|resp
operator|->
name|release_compl
operator|.
name|hdr
operator|.
name|act
operator|=
name|UNI_MSGACT_DEFAULT
expr_stmt|;
if|if
condition|(
name|ie
operator|!=
name|NULL
condition|)
name|resp
operator|->
name|release_compl
operator|.
name|cause
index|[
literal|0
index|]
operator|=
operator|*
name|ie
expr_stmt|;
if|if
condition|(
name|cause
operator|!=
literal|0
condition|)
block|{
name|IE_SETPRESENT
argument_list|(
name|resp
operator|->
name|release_compl
operator|.
name|cause
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|resp
operator|->
name|release_compl
operator|.
name|cause
index|[
literal|0
index|]
operator|.
name|h
operator|.
name|act
operator|=
name|UNI_IEACT_DEFAULT
expr_stmt|;
name|resp
operator|->
name|release_compl
operator|.
name|cause
index|[
literal|0
index|]
operator|.
name|loc
operator|=
name|UNI_CAUSE_LOC_USER
expr_stmt|;
name|resp
operator|->
name|release_compl
operator|.
name|cause
index|[
literal|0
index|]
operator|.
name|cause
operator|=
name|cause
expr_stmt|;
block|}
name|cc_send_uni
argument_list|(
name|conn
argument_list|,
name|UNIAPI_RELEASE_response
argument_list|,
name|u
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**********************************************************************  *  * INSTANCE handling  */
end_comment

begin_function
name|struct
name|ccconn
modifier|*
name|cc_conn_create
parameter_list|(
name|struct
name|ccdata
modifier|*
name|cc
parameter_list|)
block|{
name|struct
name|ccconn
modifier|*
name|conn
decl_stmt|;
name|conn
operator|=
name|CCZALLOC
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|conn
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|conn
operator|->
name|state
operator|=
name|CONN_NULL
expr_stmt|;
name|conn
operator|->
name|port
operator|=
name|NULL
expr_stmt|;
name|conn
operator|->
name|cc
operator|=
name|cc
expr_stmt|;
name|LIST_INIT
argument_list|(
operator|&
name|conn
operator|->
name|parties
argument_list|)
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|cc
operator|->
name|orphaned_conns
argument_list|,
name|conn
argument_list|,
name|port_link
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|cc
operator|->
name|log
operator|&
name|CCLOG_CONN_INST
condition|)
name|cc_conn_log
argument_list|(
name|conn
argument_list|,
literal|"created %s"
argument_list|,
literal|"orphaned"
argument_list|)
expr_stmt|;
return|return
operator|(
name|conn
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * assign to port  */
end_comment

begin_function
name|void
name|cc_conn_ins_port
parameter_list|(
name|struct
name|ccconn
modifier|*
name|conn
parameter_list|,
name|struct
name|ccport
modifier|*
name|port
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|->
name|port
operator|!=
name|NULL
condition|)
block|{
name|cc_conn_log
argument_list|(
name|conn
argument_list|,
literal|"conn is already on port %u"
argument_list|,
name|conn
operator|->
name|port
operator|->
name|param
operator|.
name|port
argument_list|)
expr_stmt|;
name|cc_conn_rem_port
argument_list|(
name|conn
argument_list|)
expr_stmt|;
block|}
name|LIST_REMOVE
argument_list|(
name|conn
argument_list|,
name|port_link
argument_list|)
expr_stmt|;
name|conn
operator|->
name|port
operator|=
name|port
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|port
operator|->
name|conn_list
argument_list|,
name|conn
argument_list|,
name|port_link
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * remove from port  */
end_comment

begin_function
name|void
name|cc_conn_rem_port
parameter_list|(
name|struct
name|ccconn
modifier|*
name|conn
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|->
name|port
operator|==
name|NULL
condition|)
block|{
name|cc_conn_log
argument_list|(
name|conn
argument_list|,
literal|"conn not on any %s"
argument_list|,
literal|"port"
argument_list|)
expr_stmt|;
return|return;
block|}
name|LIST_REMOVE
argument_list|(
name|conn
argument_list|,
name|port_link
argument_list|)
expr_stmt|;
name|conn
operator|->
name|port
operator|=
name|NULL
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|conn
operator|->
name|cc
operator|->
name|orphaned_conns
argument_list|,
name|conn
argument_list|,
name|port_link
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cc_conn_flush_cookies
parameter_list|(
name|struct
name|ccconn
modifier|*
name|conn
parameter_list|)
block|{
name|struct
name|ccreq
modifier|*
name|r
decl_stmt|,
modifier|*
name|r1
decl_stmt|;
if|if
condition|(
name|conn
operator|->
name|port
operator|==
name|NULL
condition|)
return|return;
name|TAILQ_FOREACH_SAFE
argument_list|(
argument|r
argument_list|,
argument|&conn->port->cookies
argument_list|,
argument|link
argument_list|,
argument|r1
argument_list|)
block|{
if|if
condition|(
name|r
operator|->
name|conn
operator|==
name|conn
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|conn
operator|->
name|port
operator|->
name|cookies
argument_list|,
name|r
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|CCFREE
argument_list|(
name|r
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|cc_conn_reset_acceptor
parameter_list|(
name|struct
name|ccconn
modifier|*
name|conn
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|->
name|acceptor
operator|!=
name|NULL
condition|)
block|{
name|conn
operator|->
name|acceptor
operator|->
name|accepted
operator|=
name|NULL
expr_stmt|;
name|conn
operator|->
name|acceptor
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * Destroy a connection  */
end_comment

begin_function
name|void
name|cc_conn_destroy
parameter_list|(
name|struct
name|ccconn
modifier|*
name|conn
parameter_list|)
block|{
name|struct
name|ccparty
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|conn
operator|->
name|cc
operator|->
name|log
operator|&
name|CCLOG_CONN_INST
condition|)
name|cc_conn_log
argument_list|(
name|conn
argument_list|,
literal|"destroy%s"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|user
operator|!=
name|NULL
condition|)
block|{
name|cc_conn_log
argument_list|(
name|conn
argument_list|,
literal|"still connected to user %p\n"
argument_list|,
name|conn
operator|->
name|user
argument_list|)
expr_stmt|;
name|conn
operator|->
name|user
operator|->
name|queue_act
operator|--
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|conn
operator|->
name|user
operator|->
name|connq
argument_list|,
name|conn
argument_list|,
name|connq_link
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|conn
operator|->
name|acceptor
operator|!=
name|NULL
condition|)
name|conn
operator|->
name|acceptor
operator|->
name|accepted
operator|=
name|NULL
expr_stmt|;
name|cc_conn_flush_cookies
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|cc_conn_sig_flush
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|LIST_REMOVE
argument_list|(
name|conn
argument_list|,
name|port_link
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|p
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|conn
operator|->
name|parties
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|LIST_REMOVE
argument_list|(
name|p
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|CCFREE
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
name|CCFREE
argument_list|(
name|conn
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|struct
name|ccparty
modifier|*
name|cc_party_create
parameter_list|(
name|struct
name|ccconn
modifier|*
name|conn
parameter_list|,
name|u_int
name|ident
parameter_list|,
name|u_int
name|flag
parameter_list|)
block|{
name|struct
name|ccparty
modifier|*
name|party
decl_stmt|;
name|party
operator|=
name|CCZALLOC
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|party
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|party
operator|==
name|NULL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|party
operator|->
name|conn
operator|=
name|conn
expr_stmt|;
name|party
operator|->
name|state
operator|=
name|PARTY_NULL
expr_stmt|;
name|IE_SETPRESENT
argument_list|(
name|party
operator|->
name|epref
argument_list|)
expr_stmt|;
name|party
operator|->
name|epref
operator|.
name|flag
operator|=
name|flag
expr_stmt|;
name|party
operator|->
name|epref
operator|.
name|epref
operator|=
name|ident
expr_stmt|;
name|LIST_INSERT_HEAD
argument_list|(
operator|&
name|conn
operator|->
name|parties
argument_list|,
name|party
argument_list|,
name|link
argument_list|)
expr_stmt|;
if|if
condition|(
name|party
operator|->
name|conn
operator|->
name|cc
operator|->
name|log
operator|&
name|CCLOG_PARTY_INST
condition|)
name|cc_party_log
argument_list|(
name|party
argument_list|,
literal|"created %u.%u"
argument_list|,
name|flag
argument_list|,
name|ident
argument_list|)
expr_stmt|;
return|return
operator|(
name|party
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cc_party_destroy
parameter_list|(
name|struct
name|ccparty
modifier|*
name|party
parameter_list|)
block|{
if|if
condition|(
name|party
operator|->
name|conn
operator|->
name|cc
operator|->
name|log
operator|&
name|CCLOG_PARTY_INST
condition|)
name|cc_party_log
argument_list|(
name|party
argument_list|,
literal|"destroyed %u.%u"
argument_list|,
name|party
operator|->
name|epref
operator|.
name|flag
argument_list|,
name|party
operator|->
name|epref
operator|.
name|epref
argument_list|)
expr_stmt|;
name|LIST_REMOVE
argument_list|(
name|party
argument_list|,
name|link
argument_list|)
expr_stmt|;
name|CCFREE
argument_list|(
name|party
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ccparty
modifier|*
name|cc_party_find
parameter_list|(
name|struct
name|ccconn
modifier|*
name|conn
parameter_list|,
name|u_int
name|ident
parameter_list|)
block|{
name|struct
name|ccparty
modifier|*
name|party
decl_stmt|;
name|LIST_FOREACH
argument_list|(
argument|party
argument_list|,
argument|&conn->parties
argument_list|,
argument|link
argument_list|)
if|if
condition|(
name|party
operator|->
name|epref
operator|.
name|epref
operator|==
name|ident
condition|)
return|return
operator|(
name|party
operator|)
return|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Abort connection from down stream (because of the UNI hook beeing  * disconnected). This is called from two places:  *  1) the shutdown code.  *	In this case the connections should be already dissociated from  *	users and be only in states waiting for the UNI stack.  *  2) from the disconnect code.  */
end_comment

begin_function
name|void
name|cc_conn_abort
parameter_list|(
name|struct
name|ccconn
modifier|*
name|conn
parameter_list|,
name|int
name|shutdown
parameter_list|)
block|{
name|struct
name|ccuser
modifier|*
name|u
init|=
name|conn
operator|->
name|user
decl_stmt|;
name|struct
name|ccparty
modifier|*
name|p
decl_stmt|,
modifier|*
name|p1
decl_stmt|;
if|if
condition|(
name|shutdown
condition|)
block|{
name|CCASSERT
argument_list|(
name|u
operator|==
name|NULL
argument_list|,
operator|(
literal|"still in use"
operator|)
argument_list|)
expr_stmt|;
name|CCASSERT
argument_list|(
name|conn
operator|->
name|acceptor
operator|==
name|NULL
argument_list|,
operator|(
literal|"still in use"
operator|)
argument_list|)
expr_stmt|;
name|cc_conn_destroy
argument_list|(
name|conn
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Look whether any parties are blocked waiting for a response 	 * from the stack. We don't use extra party states to handle 	 * user aborts, so check that there is a user before using it. 	 */
if|if
condition|(
name|u
operator|==
name|NULL
condition|)
block|{
while|while
condition|(
operator|(
name|p
operator|=
name|LIST_FIRST
argument_list|(
operator|&
name|conn
operator|->
name|parties
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|cc_party_destroy
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LIST_FOREACH_SAFE
argument_list|(
argument|p
argument_list|,
argument|&conn->parties
argument_list|,
argument|link
argument_list|,
argument|p1
argument_list|)
block|{
switch|switch
condition|(
name|p
operator|->
name|state
condition|)
block|{
case|case
name|PARTY_NULL
case|:
comment|/* P0 */
comment|/* should not happen */
goto|goto
name|dpty
goto|;
case|case
name|PARTY_ACTIVE
case|:
comment|/* P1 */
comment|/* don't send a drop - user'll get a rel */
goto|goto
name|dpty
goto|;
case|case
name|PARTY_ADD_WAIT_CREATE
case|:
comment|/* P2 */
case|case
name|PARTY_ADD_WAIT_OK
case|:
comment|/* P3 */
comment|/* we're adding - synthesise an error */
name|cc_user_sig
argument_list|(
name|u
argument_list|,
name|USER_SIG_ADD_PARTY_ERR
argument_list|,
name|NULL
argument_list|,
name|ATMERR_BAD_PORT
argument_list|)
expr_stmt|;
goto|goto
name|dpty
goto|;
case|case
name|PARTY_ADD_WAIT_ACK
case|:
comment|/* P4 */
comment|/* don't send a drop - user'll get a rel */
goto|goto
name|dpty
goto|;
case|case
name|PARTY_DROP_WAIT_OK
case|:
comment|/* P5 */
case|case
name|PARTY_DROP_WAIT_ACK
case|:
comment|/* P6 */
case|case
name|PARTY_ADD_DROP_WAIT_OK
case|:
comment|/* P11 */
comment|/* we're dropping - synthesis an ok */
name|cc_user_sig
argument_list|(
name|u
argument_list|,
name|USER_SIG_DROP_PARTY_OK
argument_list|,
name|NULL
argument_list|,
name|p
operator|->
name|epref
operator|.
name|epref
argument_list|)
expr_stmt|;
goto|goto
name|dpty
goto|;
case|case
name|PARTY_WAIT_DESTROY
case|:
comment|/* P7 */
goto|goto
name|dpty
goto|;
case|case
name|PARTY_WAIT_SETUP_COMPL
case|:
comment|/* P8 */
case|case
name|PARTY_WAIT_SETUP_CONF
case|:
comment|/* P10 */
comment|/* first party - nothing to do */
goto|goto
name|dpty
goto|;
case|case
name|PARTY_WAIT_DROP_ACK_OK
case|:
comment|/* P9 */
case|case
name|PARTY_ADD_DROPACK_WAIT_OK
case|:
comment|/* P12 */
comment|/* we're dropping - nothing to do */
goto|goto
name|dpty
goto|;
block|}
name|cc_party_log
argument_list|(
name|p
argument_list|,
literal|"bad uabort for party in state %s"
argument_list|,
name|ptab
index|[
name|p
operator|->
name|state
index|]
argument_list|)
expr_stmt|;
name|dpty
label|:
name|cc_party_destroy
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * Now do what the connection needs 	 */
switch|switch
condition|(
name|conn
operator|->
name|state
condition|)
block|{
case|case
name|CONN_NULL
case|:
comment|/* 0 */
case|case
name|CONN_OUT_PREPARING
case|:
comment|/* 1 */
comment|/* may not happen because we're not associated with 		 * aport yet */
break|break;
case|case
name|CONN_OUT_WAIT_CREATE
case|:
comment|/* 2 */
case|case
name|CONN_OUT_WAIT_OK
case|:
comment|/* 3 */
case|case
name|CONN_OUT_WAIT_DESTROY
case|:
comment|/* 37 */
comment|/* return an error to the user, go back to C1/U1 		 * reset cref (for C37, C3) and cookie */
name|conn
operator|->
name|cref
operator|.
name|flag
operator|=
literal|0
expr_stmt|;
name|conn
operator|->
name|cref
operator|.
name|cref
operator|=
literal|0
expr_stmt|;
name|cc_conn_flush_cookies
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_OUT_PREPARING
argument_list|)
expr_stmt|;
name|cc_conn_rem_port
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|u
argument_list|,
name|USER_SIG_CONNECT_OUTGOING_ERR
argument_list|,
name|NULL
argument_list|,
name|ATMERR_BAD_PORT
argument_list|)
expr_stmt|;
return|return;
case|case
name|CONN_OUT_WAIT_CONF
case|:
comment|/* 4 */
case|case
name|CONN_ACTIVE
case|:
comment|/* 5 */
case|case
name|CONN_IN_WAIT_COMPL
case|:
comment|/* 13 */
comment|/* emulate a RELEASE.confirm */
name|memset
argument_list|(
operator|&
name|u
operator|->
name|cause
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|u
operator|->
name|cause
argument_list|)
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|u
argument_list|,
name|USER_SIG_RELEASE_CONFIRM
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cc_disconnect_from_user
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|cc_conn_destroy
argument_list|(
name|conn
argument_list|)
expr_stmt|;
return|return;
case|case
name|CONN_IN_PREPARING
case|:
comment|/* 10 */
case|case
name|CONN_AB_WAIT_REQ_OK
case|:
comment|/* 33 */
case|case
name|CONN_AB_WAIT_RESP_OK
case|:
comment|/* 34 */
case|case
name|CONN_AB_FLUSH_IND
case|:
comment|/* 35 */
comment|/* no user - destroy */
name|cc_conn_destroy
argument_list|(
name|conn
argument_list|)
expr_stmt|;
return|return;
case|case
name|CONN_IN_ARRIVED
case|:
comment|/* 11 */
name|u
operator|->
name|aborted
operator|=
literal|1
expr_stmt|;
name|cc_disconnect_from_user
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|cc_conn_destroy
argument_list|(
name|conn
argument_list|)
expr_stmt|;
return|return;
case|case
name|CONN_IN_WAIT_ACCEPT_OK
case|:
comment|/* 12 */
comment|/* return ACCEPT error */
name|cc_disconnect_from_user
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|cc_conn_reset_acceptor
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|u
argument_list|,
name|USER_SIG_ACCEPT_ERR
argument_list|,
name|u
argument_list|,
name|ATMERR_PREVIOUSLY_ABORTED
argument_list|)
expr_stmt|;
name|cc_conn_destroy
argument_list|(
name|conn
argument_list|)
expr_stmt|;
return|return;
case|case
name|CONN_REJ_WAIT_OK
case|:
comment|/* 14 */
comment|/* return REJECT ok */
name|cc_disconnect_from_user
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|cc_conn_destroy
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|u
argument_list|,
name|USER_SIG_REJECT_OK
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
case|case
name|CONN_REL_IN_WAIT_OK
case|:
comment|/* 15 */
case|case
name|CONN_REL_WAIT_OK
case|:
comment|/* 20 */
comment|/* confirm destroy */
if|if
condition|(
name|u
operator|!=
name|NULL
condition|)
block|{
comment|/* connection not aborted */
name|memset
argument_list|(
operator|&
name|u
operator|->
name|cause
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|u
operator|->
name|cause
argument_list|)
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|u
argument_list|,
name|USER_SIG_RELEASE_CONFIRM
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cc_disconnect_from_user
argument_list|(
name|conn
argument_list|)
expr_stmt|;
block|}
name|cc_conn_destroy
argument_list|(
name|conn
argument_list|)
expr_stmt|;
return|return;
case|case
name|CONN_IN_WAITING
case|:
comment|/* 21 */
comment|/* user has not seen the connection - destroy */
name|cc_disconnect_from_user
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|cc_conn_destroy
argument_list|(
name|conn
argument_list|)
expr_stmt|;
return|return;
block|}
name|cc_conn_log
argument_list|(
name|conn
argument_list|,
literal|"bad state %s"
argument_list|,
name|stab
index|[
name|conn
operator|->
name|state
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG_MATCH
end_ifdef

begin_function
specifier|static
name|void
name|print_sap
parameter_list|(
specifier|const
name|struct
name|uni_sap
modifier|*
name|sap
parameter_list|)
block|{
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|tags
index|[]
init|=
block|{
index|[
name|UNISVE_ABSENT
index|]
literal|"absent"
block|,
index|[
name|UNISVE_PRESENT
index|]
literal|"present"
block|,
index|[
name|UNISVE_ANY
index|]
literal|"any"
block|, 	}
decl_stmt|;
name|u_int
name|i
decl_stmt|;
name|printf
argument_list|(
literal|"addr={%s"
argument_list|,
name|tags
index|[
name|sap
operator|->
name|addr
operator|.
name|tag
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sap
operator|->
name|addr
operator|.
name|tag
operator|==
name|UNISVE_PRESENT
condition|)
block|{
name|printf
argument_list|(
literal|",%d-%d"
argument_list|,
name|sap
operator|->
name|addr
operator|.
name|type
argument_list|,
name|sap
operator|->
name|addr
operator|.
name|plan
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sap
operator|->
name|addr
operator|.
name|len
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%c%02x"
argument_list|,
literal|",:"
index|[
name|i
operator|!=
literal|0
index|]
argument_list|,
name|sap
operator|->
name|addr
operator|.
name|addr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"}\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"selector={%s"
argument_list|,
name|tags
index|[
name|sap
operator|->
name|selector
operator|.
name|tag
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sap
operator|->
name|selector
operator|.
name|tag
operator|==
name|UNISVE_PRESENT
condition|)
name|printf
argument_list|(
literal|",%02x"
argument_list|,
name|sap
operator|->
name|selector
operator|.
name|selector
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"}\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"blli_id2={%s"
argument_list|,
name|tags
index|[
name|sap
operator|->
name|blli_id2
operator|.
name|tag
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sap
operator|->
name|blli_id2
operator|.
name|tag
operator|==
name|UNISVE_PRESENT
condition|)
name|printf
argument_list|(
literal|",%02x,%02x"
argument_list|,
name|sap
operator|->
name|blli_id2
operator|.
name|proto
argument_list|,
name|sap
operator|->
name|blli_id2
operator|.
name|user
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"}\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"blli_id3={%s"
argument_list|,
name|tags
index|[
name|sap
operator|->
name|blli_id3
operator|.
name|tag
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sap
operator|->
name|blli_id3
operator|.
name|tag
operator|==
name|UNISVE_PRESENT
condition|)
name|printf
argument_list|(
literal|",%02x,%02x,%02x,%06x,%04x,%d"
argument_list|,
name|sap
operator|->
name|blli_id3
operator|.
name|proto
argument_list|,
name|sap
operator|->
name|blli_id3
operator|.
name|user
argument_list|,
name|sap
operator|->
name|blli_id3
operator|.
name|ipi
argument_list|,
name|sap
operator|->
name|blli_id3
operator|.
name|oui
argument_list|,
name|sap
operator|->
name|blli_id3
operator|.
name|pid
argument_list|,
name|sap
operator|->
name|blli_id3
operator|.
name|noipi
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"}\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"bhli={%s"
argument_list|,
name|tags
index|[
name|sap
operator|->
name|bhli
operator|.
name|tag
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sap
operator|->
name|bhli
operator|.
name|tag
operator|==
name|UNISVE_PRESENT
condition|)
block|{
name|printf
argument_list|(
literal|",%d"
argument_list|,
name|sap
operator|->
name|bhli
operator|.
name|type
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sap
operator|->
name|bhli
operator|.
name|len
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%c%02x"
argument_list|,
literal|",:"
index|[
name|i
operator|!=
literal|0
index|]
argument_list|,
name|sap
operator|->
name|bhli
operator|.
name|info
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"}\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*********************************************************************  *  * DISPATCH incoming call  */
end_comment

begin_function
name|void
name|cc_conn_dispatch
parameter_list|(
name|struct
name|ccconn
modifier|*
name|conn
parameter_list|)
block|{
name|struct
name|ccdata
modifier|*
name|priv
init|=
name|conn
operator|->
name|port
operator|->
name|cc
decl_stmt|;
name|struct
name|ccuser
modifier|*
name|user
decl_stmt|;
name|u_int
name|blli_index
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG_MATCH
specifier|static
name|char
name|buf
index|[
literal|1000
index|]
decl_stmt|;
specifier|static
name|struct
name|unicx
name|cx
decl_stmt|;
specifier|static
name|int
name|init
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|init
condition|)
block|{
name|uni_initcx
argument_list|(
operator|&
name|cx
argument_list|)
expr_stmt|;
name|init
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* 	 * Do call dispatching according to 4.6 	 */
ifdef|#
directive|ifdef
name|DEBUG_MATCH
name|printf
argument_list|(
literal|"+++++ DISPATCH++++++\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
for|for
control|(
name|blli_index
operator|=
literal|0
init|;
name|blli_index
operator|<
name|UNI_NUM_IE_BLLI
condition|;
name|blli_index
operator|++
control|)
block|{
if|if
condition|(
name|blli_index
operator|>
literal|0
operator|&&
operator|!
name|IE_ISGOOD
argument_list|(
name|conn
operator|->
name|blli
index|[
name|blli_index
index|]
argument_list|)
condition|)
break|break;
ifdef|#
directive|ifdef
name|DEBUG_MATCH
if|if
condition|(
name|IE_ISPRESENT
argument_list|(
name|conn
operator|->
name|called
argument_list|)
condition|)
block|{
name|uni_print_ie
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|UNI_IE_CALLED
argument_list|,
operator|(
expr|union
name|uni_ieall
operator|*
operator|)
operator|&
name|conn
operator|->
name|called
argument_list|,
operator|&
name|cx
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"called=%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|IE_ISPRESENT
argument_list|(
name|conn
operator|->
name|bhli
argument_list|)
condition|)
block|{
name|uni_print_ie
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|UNI_IE_BHLI
argument_list|,
operator|(
expr|union
name|uni_ieall
operator|*
operator|)
operator|&
name|conn
operator|->
name|bhli
argument_list|,
operator|&
name|cx
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"bhli=%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|IE_ISPRESENT
argument_list|(
name|conn
operator|->
name|blli
index|[
name|blli_index
index|]
argument_list|)
condition|)
block|{
name|uni_print_ie
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|UNI_IE_BLLI
argument_list|,
operator|(
expr|union
name|uni_ieall
operator|*
operator|)
operator|&
name|conn
operator|->
name|blli
index|[
name|blli_index
index|]
argument_list|,
operator|&
name|cx
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|LIST_FOREACH
argument_list|(
argument|user
argument_list|,
argument|&priv->user_list
argument_list|,
argument|node_link
argument_list|)
block|{
if|if
condition|(
operator|(
name|user
operator|->
name|state
operator|==
name|USER_IN_WAITING
operator|||
name|user
operator|->
name|state
operator|==
name|USER_IN_ARRIVED
operator|||
name|user
operator|->
name|state
operator|==
name|USER_IN_WAIT_ACC
operator|||
name|user
operator|->
name|state
operator|==
name|USER_IN_WAIT_REJ
operator|)
operator|&&
operator|!
name|unisve_is_catchall
argument_list|(
name|user
operator|->
name|sap
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG_MATCH
name|printf
argument_list|(
literal|"TRYING user=%p\n"
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|print_sap
argument_list|(
name|user
operator|->
name|sap
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|unisve_match
argument_list|(
name|user
operator|->
name|sap
argument_list|,
operator|&
name|conn
operator|->
name|called
argument_list|,
operator|&
name|conn
operator|->
name|blli
index|[
name|blli_index
index|]
argument_list|,
operator|&
name|conn
operator|->
name|bhli
argument_list|)
condition|)
goto|goto
name|found
goto|;
block|}
block|}
block|}
ifdef|#
directive|ifdef
name|DEBUG_MATCH
name|printf
argument_list|(
literal|"TRYING CATCHALL\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|blli_index
operator|=
literal|0
expr_stmt|;
name|LIST_FOREACH
argument_list|(
argument|user
argument_list|,
argument|&priv->user_list
argument_list|,
argument|node_link
argument_list|)
block|{
if|if
condition|(
operator|(
name|user
operator|->
name|state
operator|==
name|USER_IN_WAITING
operator|||
name|user
operator|->
name|state
operator|==
name|USER_IN_ARRIVED
operator|||
name|user
operator|->
name|state
operator|==
name|USER_IN_WAIT_ACC
operator|||
name|user
operator|->
name|state
operator|==
name|USER_IN_WAIT_REJ
operator|)
operator|&&
name|unisve_is_catchall
argument_list|(
name|user
operator|->
name|sap
argument_list|)
condition|)
goto|goto
name|found
goto|;
block|}
ifdef|#
directive|ifdef
name|DEBUG_MATCH
name|printf
argument_list|(
literal|"SORRY\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* 	 * No application found - reject call. 	 */
name|do_release_response
argument_list|(
name|conn
argument_list|,
name|UNI_CAUSE_INCOMP
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_WAIT_RESP_OK
argument_list|)
expr_stmt|;
return|return;
name|found
label|:
ifdef|#
directive|ifdef
name|DEBUG_MATCH
name|printf
argument_list|(
literal|"MATCH\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|user
operator|->
name|queue_max
operator|==
name|user
operator|->
name|queue_act
condition|)
block|{
name|do_release_response
argument_list|(
name|conn
argument_list|,
name|UNI_CAUSE_BUSY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_WAIT_RESP_OK
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|blli_index
operator|==
literal|0
operator|&&
operator|!
name|IE_ISGOOD
argument_list|(
name|conn
operator|->
name|blli
index|[
name|blli_index
index|]
argument_list|)
condition|)
name|conn
operator|->
name|blli_selector
operator|=
literal|0
expr_stmt|;
else|else
name|conn
operator|->
name|blli_selector
operator|=
name|blli_index
operator|+
literal|1
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_IN_WAITING
argument_list|)
expr_stmt|;
name|cc_connect_to_user
argument_list|(
name|conn
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|user
argument_list|,
name|USER_SIG_SETUP_IND
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cc_party_setup_conf
parameter_list|(
name|struct
name|ccconn
modifier|*
name|conn
parameter_list|)
block|{
name|struct
name|ccparty
modifier|*
name|party
decl_stmt|;
name|party
operator|=
name|cc_party_find
argument_list|(
name|conn
argument_list|,
name|conn
operator|->
name|epref
operator|.
name|epref
argument_list|)
expr_stmt|;
if|if
condition|(
name|party
operator|==
name|NULL
condition|)
block|{
name|cc_party_log
argument_list|(
name|party
argument_list|,
literal|"no party for %s"
argument_list|,
name|cc_conn_sigtab
index|[
name|CONN_SIG_SETUP_CONFIRM
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|party
operator|->
name|state
operator|!=
name|PARTY_WAIT_SETUP_CONF
condition|)
block|{
name|cc_party_log
argument_list|(
name|party
argument_list|,
literal|"bad state=%s for signal=%s"
argument_list|,
name|ptab
index|[
name|party
operator|->
name|state
index|]
argument_list|,
name|cc_conn_sigtab
index|[
name|CONN_SIG_SETUP_CONFIRM
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_ACTIVE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cc_party_add_ack_ind
parameter_list|(
name|struct
name|ccconn
modifier|*
name|conn
parameter_list|,
specifier|const
name|struct
name|uni_ie_epref
modifier|*
name|epref
parameter_list|)
block|{
name|struct
name|ccparty
modifier|*
name|party
decl_stmt|;
name|party
operator|=
name|cc_party_find
argument_list|(
name|conn
argument_list|,
name|epref
operator|->
name|epref
argument_list|)
expr_stmt|;
if|if
condition|(
name|party
operator|==
name|NULL
condition|)
block|{
name|cc_party_log
argument_list|(
name|party
argument_list|,
literal|"no party for %s"
argument_list|,
name|cc_conn_sigtab
index|[
name|CONN_SIG_PARTY_ADD_ACK_IND
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|party
operator|->
name|state
operator|!=
name|PARTY_ADD_WAIT_ACK
condition|)
block|{
name|cc_party_log
argument_list|(
name|party
argument_list|,
literal|"bad state=%s for signal=%s"
argument_list|,
name|ptab
index|[
name|party
operator|->
name|state
index|]
argument_list|,
name|cc_conn_sigtab
index|[
name|CONN_SIG_PARTY_ADD_ACK_IND
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_ACTIVE
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_ADD_PARTY_ACK
argument_list|,
name|NULL
argument_list|,
name|epref
operator|->
name|epref
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cc_party_add_rej_ind
parameter_list|(
name|struct
name|ccconn
modifier|*
name|conn
parameter_list|,
specifier|const
name|struct
name|uni_ie_epref
modifier|*
name|epref
parameter_list|)
block|{
name|struct
name|ccparty
modifier|*
name|party
decl_stmt|;
name|party
operator|=
name|cc_party_find
argument_list|(
name|conn
argument_list|,
name|epref
operator|->
name|epref
argument_list|)
expr_stmt|;
if|if
condition|(
name|party
operator|==
name|NULL
condition|)
block|{
name|cc_party_log
argument_list|(
name|party
argument_list|,
literal|"no party for %s"
argument_list|,
name|cc_conn_sigtab
index|[
name|CONN_SIG_PARTY_ADD_REJ_IND
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|party
operator|->
name|state
operator|!=
name|PARTY_ADD_WAIT_ACK
condition|)
block|{
name|cc_party_log
argument_list|(
name|party
argument_list|,
literal|"bad state=%s for signal=%s"
argument_list|,
name|ptab
index|[
name|party
operator|->
name|state
index|]
argument_list|,
name|cc_conn_sigtab
index|[
name|CONN_SIG_PARTY_ADD_REJ_IND
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_WAIT_DESTROY
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_ADD_PARTY_REJ
argument_list|,
name|NULL
argument_list|,
name|epref
operator|->
name|epref
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cc_party_drop_ack_ind
parameter_list|(
name|struct
name|ccconn
modifier|*
name|conn
parameter_list|,
specifier|const
name|struct
name|uni_drop_party
modifier|*
name|drop
parameter_list|)
block|{
name|struct
name|ccparty
modifier|*
name|party
decl_stmt|;
name|party
operator|=
name|cc_party_find
argument_list|(
name|conn
argument_list|,
name|drop
operator|->
name|epref
operator|.
name|epref
argument_list|)
expr_stmt|;
if|if
condition|(
name|party
operator|==
name|NULL
condition|)
block|{
name|cc_party_log
argument_list|(
name|party
argument_list|,
literal|"no party for %s"
argument_list|,
name|cc_conn_sigtab
index|[
name|CONN_SIG_DROP_PARTY_ACK_IND
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|party
operator|->
name|state
condition|)
block|{
case|case
name|PARTY_ACTIVE
case|:
comment|/* P1 */
name|memset
argument_list|(
operator|&
name|conn
operator|->
name|user
operator|->
name|cause
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|user
operator|->
name|cause
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|conn
operator|->
name|user
operator|->
name|cause
index|[
literal|0
index|]
operator|=
name|drop
operator|->
name|cause
expr_stmt|;
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_WAIT_DESTROY
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_DROP_PARTY_IND
argument_list|,
name|NULL
argument_list|,
name|party
operator|->
name|epref
operator|.
name|epref
argument_list|)
expr_stmt|;
break|break;
case|case
name|PARTY_ADD_WAIT_ACK
case|:
comment|/* P4 */
name|memset
argument_list|(
operator|&
name|conn
operator|->
name|user
operator|->
name|cause
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|user
operator|->
name|cause
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|conn
operator|->
name|user
operator|->
name|cause
index|[
literal|0
index|]
operator|=
name|drop
operator|->
name|cause
expr_stmt|;
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_WAIT_DESTROY
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_ADD_PARTY_REJ
argument_list|,
name|NULL
argument_list|,
name|party
operator|->
name|epref
operator|.
name|epref
argument_list|)
expr_stmt|;
break|break;
case|case
name|PARTY_DROP_WAIT_ACK
case|:
comment|/* P6 */
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_WAIT_DESTROY
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_DROP_PARTY_OK
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|PARTY_WAIT_SETUP_COMPL
case|:
comment|/* P8 */
case|case
name|PARTY_WAIT_SETUP_CONF
case|:
comment|/* P10 */
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_WAIT_DESTROY
argument_list|)
expr_stmt|;
break|break;
default|default:
name|cc_party_log
argument_list|(
name|party
argument_list|,
literal|"bad state=%s for signal=%s"
argument_list|,
name|ptab
index|[
name|party
operator|->
name|state
index|]
argument_list|,
name|cc_conn_sigtab
index|[
name|CONN_SIG_DROP_PARTY_ACK_IND
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * Handle a signal to this connection  */
end_comment

begin_function
name|void
name|cc_conn_sig_handle
parameter_list|(
name|struct
name|ccconn
modifier|*
name|conn
parameter_list|,
name|enum
name|conn_sig
name|sig
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|,
name|u_int
name|iarg
parameter_list|)
block|{
name|struct
name|ccparty
modifier|*
name|party
decl_stmt|;
if|if
condition|(
name|conn
operator|->
name|cc
operator|->
name|log
operator|&
name|CCLOG_CONN_SIG
condition|)
name|cc_conn_log
argument_list|(
name|conn
argument_list|,
literal|"signal %s in state %s"
argument_list|,
name|cc_conn_sigtab
index|[
name|sig
index|]
argument_list|,
name|stab
index|[
name|conn
operator|->
name|state
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sig
condition|)
block|{
case|case
name|CONN_SIG_CONNECT_OUTGOING
case|:
comment|/* Do SETUP */
block|{
name|struct
name|uni_msg
modifier|*
name|u
decl_stmt|;
name|struct
name|uniapi_setup_request
modifier|*
name|setup
decl_stmt|;
if|if
condition|(
name|conn
operator|->
name|state
operator|!=
name|CONN_OUT_PREPARING
condition|)
goto|goto
name|bad_state
goto|;
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|conn
operator|->
name|bearer
argument_list|)
operator|&&
name|conn
operator|->
name|bearer
operator|.
name|cfg
operator|==
name|UNI_BEARER_MP
condition|)
block|{
name|IE_SETPRESENT
argument_list|(
name|conn
operator|->
name|epref
argument_list|)
expr_stmt|;
name|conn
operator|->
name|epref
operator|.
name|flag
operator|=
literal|0
expr_stmt|;
name|conn
operator|->
name|epref
operator|.
name|epref
operator|=
literal|0
expr_stmt|;
block|}
comment|/* 		 * Construct message to UNI. 		 */
name|u
operator|=
name|uni_msg_alloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|uniapi_setup_request
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
operator|==
name|NULL
condition|)
block|{
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_CONNECT_OUTGOING_ERR
argument_list|,
name|NULL
argument_list|,
name|ATMERR_NOMEM
argument_list|)
expr_stmt|;
return|return;
block|}
name|setup
operator|=
name|uni_msg_wptr
argument_list|(
name|u
argument_list|,
expr|struct
name|uniapi_setup_request
operator|*
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|setup
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|setup
argument_list|)
argument_list|)
expr_stmt|;
name|u
operator|->
name|b_wptr
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|uniapi_setup_request
argument_list|)
expr_stmt|;
name|setup
operator|->
name|setup
operator|.
name|hdr
operator|.
name|act
operator|=
name|UNI_MSGACT_DEFAULT
expr_stmt|;
name|memcpy
argument_list|(
name|setup
operator|->
name|setup
operator|.
name|blli
argument_list|,
name|conn
operator|->
name|blli
argument_list|,
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|blli
argument_list|)
argument_list|)
expr_stmt|;
name|setup
operator|->
name|setup
operator|.
name|bearer
operator|=
name|conn
operator|->
name|bearer
expr_stmt|;
name|setup
operator|->
name|setup
operator|.
name|traffic
operator|=
name|conn
operator|->
name|traffic
expr_stmt|;
name|setup
operator|->
name|setup
operator|.
name|qos
operator|=
name|conn
operator|->
name|qos
expr_stmt|;
name|setup
operator|->
name|setup
operator|.
name|exqos
operator|=
name|conn
operator|->
name|exqos
expr_stmt|;
name|setup
operator|->
name|setup
operator|.
name|called
operator|=
name|conn
operator|->
name|called
expr_stmt|;
name|setup
operator|->
name|setup
operator|.
name|calledsub
index|[
literal|0
index|]
operator|=
name|conn
operator|->
name|calledsub
expr_stmt|;
name|setup
operator|->
name|setup
operator|.
name|aal
operator|=
name|conn
operator|->
name|aal
expr_stmt|;
name|setup
operator|->
name|setup
operator|.
name|epref
operator|=
name|conn
operator|->
name|epref
expr_stmt|;
name|setup
operator|->
name|setup
operator|.
name|eetd
operator|=
name|conn
operator|->
name|eetd
expr_stmt|;
name|setup
operator|->
name|setup
operator|.
name|abrsetup
operator|=
name|conn
operator|->
name|abrsetup
expr_stmt|;
name|setup
operator|->
name|setup
operator|.
name|abradd
operator|=
name|conn
operator|->
name|abradd
expr_stmt|;
name|setup
operator|->
name|setup
operator|.
name|calling
operator|=
name|conn
operator|->
name|calling
expr_stmt|;
name|setup
operator|->
name|setup
operator|.
name|callingsub
index|[
literal|0
index|]
operator|=
name|conn
operator|->
name|callingsub
expr_stmt|;
name|setup
operator|->
name|setup
operator|.
name|connid
operator|=
name|conn
operator|->
name|connid
expr_stmt|;
name|memcpy
argument_list|(
name|setup
operator|->
name|setup
operator|.
name|tns
argument_list|,
name|conn
operator|->
name|tns
argument_list|,
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|tns
argument_list|)
argument_list|)
expr_stmt|;
name|setup
operator|->
name|setup
operator|.
name|atraffic
operator|=
name|conn
operator|->
name|atraffic
expr_stmt|;
name|setup
operator|->
name|setup
operator|.
name|mintraffic
operator|=
name|conn
operator|->
name|mintraffic
expr_stmt|;
name|setup
operator|->
name|setup
operator|.
name|cscope
operator|=
name|conn
operator|->
name|cscope
expr_stmt|;
name|setup
operator|->
name|setup
operator|.
name|bhli
operator|=
name|conn
operator|->
name|bhli
expr_stmt|;
name|setup
operator|->
name|setup
operator|.
name|mdcr
operator|=
name|conn
operator|->
name|mdcr
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_OUT_WAIT_CREATE
argument_list|)
expr_stmt|;
name|cc_send_uni
argument_list|(
name|conn
argument_list|,
name|UNIAPI_SETUP_request
argument_list|,
name|u
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|CONN_SIG_ARRIVAL
case|:
comment|/* user informed of arrival of this call */
if|if
condition|(
name|conn
operator|->
name|state
operator|!=
name|CONN_IN_WAITING
condition|)
goto|goto
name|bad_state
goto|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_IN_ARRIVED
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONN_SIG_RELEASE
case|:
block|{
comment|/* Release this call */
name|struct
name|uni_msg
modifier|*
name|u
decl_stmt|;
name|struct
name|uniapi_release_request
modifier|*
name|req
decl_stmt|;
if|if
condition|(
name|conn
operator|->
name|state
operator|!=
name|CONN_ACTIVE
operator|&&
name|conn
operator|->
name|state
operator|!=
name|CONN_IN_WAIT_COMPL
condition|)
goto|goto
name|bad_state
goto|;
if|if
condition|(
operator|(
name|u
operator|=
name|uni_msg_alloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return;
name|req
operator|=
name|uni_msg_wptr
argument_list|(
name|u
argument_list|,
expr|struct
name|uniapi_release_request
operator|*
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|u
operator|->
name|b_wptr
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|uniapi_release_request
argument_list|)
expr_stmt|;
name|req
operator|->
name|release
operator|.
name|hdr
operator|.
name|cref
operator|=
name|conn
operator|->
name|cref
expr_stmt|;
name|req
operator|->
name|release
operator|.
name|hdr
operator|.
name|act
operator|=
name|UNI_MSGACT_DEFAULT
expr_stmt|;
name|req
operator|->
name|release
operator|.
name|cause
index|[
literal|0
index|]
operator|=
name|conn
operator|->
name|cause
index|[
literal|0
index|]
expr_stmt|;
name|req
operator|->
name|release
operator|.
name|cause
index|[
literal|1
index|]
operator|=
name|conn
operator|->
name|cause
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|state
operator|==
name|CONN_ACTIVE
condition|)
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_REL_WAIT_OK
argument_list|)
expr_stmt|;
else|else
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_REL_IN_WAIT_OK
argument_list|)
expr_stmt|;
name|cc_send_uni
argument_list|(
name|conn
argument_list|,
name|UNIAPI_RELEASE_request
argument_list|,
name|u
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|CONN_SIG_REJECT
case|:
block|{
comment|/* reject from user */
name|struct
name|ccuser
modifier|*
name|user
init|=
name|conn
operator|->
name|user
decl_stmt|;
if|if
condition|(
name|conn
operator|->
name|state
operator|!=
name|CONN_IN_ARRIVED
condition|)
block|{
name|cc_user_sig
argument_list|(
name|user
argument_list|,
name|USER_SIG_REJECT_ERR
argument_list|,
name|NULL
argument_list|,
name|ATMERR_BAD_STATE
argument_list|)
expr_stmt|;
break|break;
block|}
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_REJ_WAIT_OK
argument_list|)
expr_stmt|;
name|do_release_response
argument_list|(
name|conn
argument_list|,
literal|0
argument_list|,
name|conn
operator|->
name|cause
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|CONN_SIG_ACCEPT
case|:
block|{
comment|/* User accepts. */
name|struct
name|ccuser
modifier|*
name|newep
init|=
name|arg
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|u
decl_stmt|;
name|struct
name|uniapi_setup_response
modifier|*
name|resp
decl_stmt|;
name|struct
name|ccuser
modifier|*
name|user
init|=
name|conn
operator|->
name|user
decl_stmt|;
if|if
condition|(
name|conn
operator|->
name|state
operator|!=
name|CONN_IN_ARRIVED
condition|)
block|{
name|cc_user_sig
argument_list|(
name|user
argument_list|,
name|USER_SIG_ACCEPT_ERR
argument_list|,
name|NULL
argument_list|,
name|ATMERR_PREVIOUSLY_ABORTED
argument_list|)
expr_stmt|;
break|break;
block|}
name|u
operator|=
name|uni_msg_alloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|uniapi_setup_response
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
operator|==
name|NULL
condition|)
block|{
name|cc_user_sig
argument_list|(
name|user
argument_list|,
name|USER_SIG_ACCEPT_ERR
argument_list|,
name|NULL
argument_list|,
name|ATMERR_NOMEM
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 		 * Link to the new endpoint 		 */
name|conn
operator|->
name|acceptor
operator|=
name|newep
expr_stmt|;
name|newep
operator|->
name|accepted
operator|=
name|conn
expr_stmt|;
comment|/* 		 * Construct connect message 		 */
name|resp
operator|=
name|uni_msg_wptr
argument_list|(
name|u
argument_list|,
expr|struct
name|uniapi_setup_response
operator|*
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|resp
argument_list|)
argument_list|)
expr_stmt|;
name|u
operator|->
name|b_wptr
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|resp
argument_list|)
expr_stmt|;
name|resp
operator|->
name|connect
operator|.
name|hdr
operator|.
name|act
operator|=
name|UNI_MSGACT_DEFAULT
expr_stmt|;
name|resp
operator|->
name|connect
operator|.
name|hdr
operator|.
name|cref
operator|=
name|conn
operator|->
name|cref
expr_stmt|;
comment|/* 		 * attributes 		 */
if|if
condition|(
name|conn
operator|->
name|dirty_attr
operator|&&
name|CCDIRTY_AAL
condition|)
name|resp
operator|->
name|connect
operator|.
name|aal
operator|=
name|conn
operator|->
name|aal
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|dirty_attr
operator|&&
name|CCDIRTY_BLLI
condition|)
name|resp
operator|->
name|connect
operator|.
name|blli
operator|=
name|conn
operator|->
name|blli
index|[
name|conn
operator|->
name|blli_selector
operator|-
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|dirty_attr
operator|&&
name|CCDIRTY_CONNID
condition|)
name|resp
operator|->
name|connect
operator|.
name|connid
operator|=
name|conn
operator|->
name|connid
expr_stmt|;
comment|/* XXX NOTIFY */
if|if
condition|(
name|conn
operator|->
name|dirty_attr
operator|&&
name|CCDIRTY_EETD
condition|)
name|resp
operator|->
name|connect
operator|.
name|eetd
operator|=
name|conn
operator|->
name|eetd
expr_stmt|;
comment|/* XXX GIT */
comment|/* XXX UU */
if|if
condition|(
name|conn
operator|->
name|dirty_attr
operator|&&
name|CCDIRTY_TRAFFIC
condition|)
name|resp
operator|->
name|connect
operator|.
name|traffic
operator|=
name|conn
operator|->
name|traffic
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|dirty_attr
operator|&&
name|CCDIRTY_EXQOS
condition|)
name|resp
operator|->
name|connect
operator|.
name|exqos
operator|=
name|conn
operator|->
name|exqos
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|dirty_attr
operator|&&
name|CCDIRTY_ABRSETUP
condition|)
name|resp
operator|->
name|connect
operator|.
name|abrsetup
operator|=
name|conn
operator|->
name|abrsetup
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|dirty_attr
operator|&&
name|CCDIRTY_ABRADD
condition|)
name|resp
operator|->
name|connect
operator|.
name|abradd
operator|=
name|conn
operator|->
name|abradd
expr_stmt|;
comment|/* 		 * If the SETUP had an endpoint reference - echo it back 		 */
if|if
condition|(
name|IE_ISPRESENT
argument_list|(
name|conn
operator|->
name|epref
argument_list|)
condition|)
block|{
name|resp
operator|->
name|connect
operator|.
name|epref
operator|=
name|conn
operator|->
name|epref
expr_stmt|;
name|resp
operator|->
name|connect
operator|.
name|epref
operator|.
name|flag
operator|=
operator|!
name|resp
operator|->
name|connect
operator|.
name|epref
operator|.
name|flag
expr_stmt|;
block|}
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_IN_WAIT_ACCEPT_OK
argument_list|)
expr_stmt|;
name|cc_send_uni
argument_list|(
name|conn
argument_list|,
name|UNIAPI_SETUP_response
argument_list|,
name|u
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|CONN_SIG_ADD_PARTY
case|:
block|{
comment|/* request to add party from user */
name|struct
name|uni_msg
modifier|*
name|u
decl_stmt|;
name|struct
name|uniapi_add_party_request
modifier|*
name|req
decl_stmt|;
if|if
condition|(
name|conn
operator|->
name|state
operator|!=
name|CONN_ACTIVE
condition|)
goto|goto
name|bad_state
goto|;
comment|/* create the party */
name|party
operator|=
name|cc_party_create
argument_list|(
name|conn
argument_list|,
operator|(
name|u_int
operator|)
operator|(
name|uintptr_t
operator|)
name|arg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|party
operator|==
name|NULL
condition|)
block|{
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_ADD_PARTY_ERR
argument_list|,
name|NULL
argument_list|,
name|ATMERR_NOMEM
argument_list|)
expr_stmt|;
return|return;
block|}
name|party
operator|->
name|called
operator|=
name|conn
operator|->
name|called
expr_stmt|;
comment|/* Construct message to UNI. */
name|u
operator|=
name|uni_msg_alloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|uniapi_setup_request
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
operator|==
name|NULL
condition|)
block|{
name|cc_party_destroy
argument_list|(
name|party
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_ADD_PARTY_ERR
argument_list|,
name|NULL
argument_list|,
name|ATMERR_NOMEM
argument_list|)
expr_stmt|;
return|return;
block|}
name|req
operator|=
name|uni_msg_wptr
argument_list|(
name|u
argument_list|,
expr|struct
name|uniapi_add_party_request
operator|*
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|u
operator|->
name|b_wptr
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|uniapi_add_party_request
argument_list|)
expr_stmt|;
name|req
operator|->
name|add
operator|.
name|hdr
operator|.
name|act
operator|=
name|UNI_MSGACT_DEFAULT
expr_stmt|;
name|req
operator|->
name|add
operator|.
name|hdr
operator|.
name|cref
operator|=
name|conn
operator|->
name|cref
expr_stmt|;
name|req
operator|->
name|add
operator|.
name|epref
operator|=
name|party
operator|->
name|epref
expr_stmt|;
name|req
operator|->
name|add
operator|.
name|called
operator|=
name|party
operator|->
name|called
expr_stmt|;
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_ADD_WAIT_CREATE
argument_list|)
expr_stmt|;
name|cc_send_uni
argument_list|(
name|conn
argument_list|,
name|UNIAPI_ADD_PARTY_request
argument_list|,
name|u
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|CONN_SIG_DROP_PARTY
case|:
block|{
comment|/* user request to drop a party */
name|struct
name|uni_msg
modifier|*
name|u
decl_stmt|;
name|struct
name|uniapi_drop_party_request
modifier|*
name|req
decl_stmt|;
if|if
condition|(
name|conn
operator|->
name|state
operator|!=
name|CONN_ACTIVE
condition|)
goto|goto
name|bad_state
goto|;
name|party
operator|=
name|cc_party_find
argument_list|(
name|conn
argument_list|,
operator|(
name|u_int
operator|)
operator|(
name|uintptr_t
operator|)
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|party
operator|==
name|NULL
condition|)
block|{
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_DROP_PARTY_ERR
argument_list|,
name|NULL
argument_list|,
name|ATMERR_BAD_PARTY
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|party
operator|->
name|state
condition|)
block|{
case|case
name|PARTY_ACTIVE
case|:
case|case
name|PARTY_ADD_WAIT_ACK
case|:
break|break;
default|default:
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_DROP_PARTY_ERR
argument_list|,
name|NULL
argument_list|,
name|ATMERR_BAD_STATE
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 		 * Construct message to UNI. 		 */
name|u
operator|=
name|uni_msg_alloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
operator|==
name|NULL
condition|)
block|{
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_DROP_PARTY_ERR
argument_list|,
name|NULL
argument_list|,
name|ATMERR_NOMEM
argument_list|)
expr_stmt|;
return|return;
block|}
name|req
operator|=
name|uni_msg_wptr
argument_list|(
name|u
argument_list|,
expr|struct
name|uniapi_drop_party_request
operator|*
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|u
operator|->
name|b_wptr
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|uniapi_drop_party_request
argument_list|)
expr_stmt|;
name|req
operator|->
name|drop
operator|.
name|hdr
operator|.
name|act
operator|=
name|UNI_MSGACT_DEFAULT
expr_stmt|;
name|req
operator|->
name|drop
operator|.
name|hdr
operator|.
name|cref
operator|=
name|conn
operator|->
name|cref
expr_stmt|;
name|req
operator|->
name|drop
operator|.
name|epref
operator|=
name|party
operator|->
name|epref
expr_stmt|;
name|req
operator|->
name|drop
operator|.
name|cause
operator|=
name|conn
operator|->
name|cause
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|party
operator|->
name|state
operator|==
name|PARTY_ACTIVE
condition|)
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_DROP_WAIT_OK
argument_list|)
expr_stmt|;
else|else
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_ADD_DROP_WAIT_OK
argument_list|)
expr_stmt|;
name|cc_send_uni
argument_list|(
name|conn
argument_list|,
name|UNIAPI_DROP_PARTY_request
argument_list|,
name|u
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|CONN_SIG_DROP_PARTY_ACK_IND
case|:
block|{
name|struct
name|uni_msg
modifier|*
name|msg
init|=
name|arg
decl_stmt|;
name|struct
name|uniapi_drop_party_ack_indication
modifier|*
name|ind
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_drop_party_ack_indication
operator|*
argument_list|)
decl_stmt|;
name|cc_party_drop_ack_ind
argument_list|(
name|conn
argument_list|,
operator|&
name|ind
operator|->
name|drop
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|CONN_SIG_USER_ABORT
case|:
comment|/* 		 * Aborting a connection. This is callable in all states. 		 * The connection is already disconnected from the user. 		 * The cause is in cause[]. 		 */
switch|switch
condition|(
name|conn
operator|->
name|state
condition|)
block|{
case|case
name|CONN_NULL
case|:
comment|/* C0 */
case|case
name|CONN_OUT_PREPARING
case|:
comment|/* C1 */
name|cc_conn_destroy
argument_list|(
name|conn
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONN_OUT_WAIT_CONF
case|:
comment|/* C4 */
case|case
name|CONN_ACTIVE
case|:
comment|/* C5 */
name|do_release_request
argument_list|(
name|conn
argument_list|,
name|conn
operator|->
name|cause
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_WAIT_REQ_OK
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONN_IN_WAITING
case|:
comment|/* C21 */
comment|/* that should not happen */
goto|goto
name|bad_state
goto|;
break|break;
case|case
name|CONN_IN_ARRIVED
case|:
comment|/* C11 */
comment|/* 			 * This is called only for the first connection 			 * of the user - the others are re-dispatched. 			 */
name|do_release_response
argument_list|(
name|conn
argument_list|,
literal|0
argument_list|,
name|conn
operator|->
name|cause
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_WAIT_RESP_OK
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONN_IN_WAIT_COMPL
case|:
comment|/* C13 */
name|do_release_request
argument_list|(
name|conn
argument_list|,
name|conn
operator|->
name|cause
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_WAIT_REQ_OK
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONN_OUT_WAIT_DESTROY
case|:
comment|/* C20 */
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_FLUSH_IND
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONN_IN_WAIT_ACCEPT_OK
case|:
comment|/* C12 */
case|case
name|CONN_AB_WAIT_REQ_OK
case|:
comment|/* C33 */
case|case
name|CONN_AB_WAIT_RESP_OK
case|:
comment|/* C34 */
case|case
name|CONN_AB_FLUSH_IND
case|:
comment|/* C35 */
comment|/* just ignore */
break|break;
comment|/* 		 * The following states may not happen, because 		 * we're waiting for a response from the UNI stack. 		 * As soon as the response comes the ABORT is undefered 		 * and will hit us (but in another state). 		 */
case|case
name|CONN_OUT_WAIT_CREATE
case|:
comment|/* C2 */
case|case
name|CONN_OUT_WAIT_OK
case|:
comment|/* C3 */
case|case
name|CONN_IN_PREPARING
case|:
comment|/* C10 */
case|case
name|CONN_REJ_WAIT_OK
case|:
comment|/* C14 */
case|case
name|CONN_REL_IN_WAIT_OK
case|:
comment|/* C15 */
case|case
name|CONN_REL_WAIT_OK
case|:
comment|/* C20 */
goto|goto
name|bad_state
goto|;
block|}
break|break;
case|case
name|CONN_SIG_CREATED
case|:
block|{
comment|/* 		 * CALL_CREATED message from UNI. This can happen for either 		 * incoming or outgoing connections. 		 */
name|struct
name|uni_msg
modifier|*
name|msg
init|=
name|arg
decl_stmt|;
name|struct
name|uniapi_call_created
modifier|*
name|cr
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_call_created
operator|*
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|conn
operator|->
name|state
condition|)
block|{
case|case
name|CONN_OUT_WAIT_CREATE
case|:
name|conn
operator|->
name|cref
operator|=
name|cr
operator|->
name|cref
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_OUT_WAIT_OK
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONN_NULL
case|:
name|conn
operator|->
name|cref
operator|=
name|cr
operator|->
name|cref
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_IN_PREPARING
argument_list|)
expr_stmt|;
break|break;
default|default:
goto|goto
name|bad_state
goto|;
block|}
break|break;
block|}
case|case
name|CONN_SIG_DESTROYED
case|:
comment|/* 		 * CALL_DESTROYED message from UNI. 		 */
switch|switch
condition|(
name|conn
operator|->
name|state
condition|)
block|{
case|case
name|CONN_OUT_WAIT_DESTROY
case|:
name|cc_conn_rem_port
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_OUT_PREPARING
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|user
operator|!=
name|NULL
condition|)
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_CONNECT_OUTGOING_ERR
argument_list|,
name|NULL
argument_list|,
name|ATM_MKUNIERR
argument_list|(
name|conn
operator|->
name|reason
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONN_AB_FLUSH_IND
case|:
name|cc_conn_destroy
argument_list|(
name|conn
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONN_IN_PREPARING
case|:
name|cc_conn_destroy
argument_list|(
name|conn
argument_list|)
expr_stmt|;
break|break;
default|default:
goto|goto
name|bad_state
goto|;
block|}
break|break;
case|case
name|CONN_SIG_SETUP_CONFIRM
case|:
comment|/* Setup confirm from the UNI. */
block|{
name|struct
name|uni_msg
modifier|*
name|msg
init|=
name|arg
decl_stmt|;
name|struct
name|uniapi_setup_confirm
modifier|*
name|conf
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_setup_confirm
operator|*
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|conn
operator|->
name|state
condition|)
block|{
case|case
name|CONN_OUT_WAIT_CONF
case|:
comment|/* 			 * Shuffle attributes and inform the user. 			 * Negotiable attributes are condititionally shuffled, 			 * because not returning it means accepting it 			 * (in case of blli the first instance of it). 			 * All others are shuffled unconditionally. 			 * Here we should also open the VCI in the driver. (XXX) 			 */
define|#
directive|define
name|SHUFFLE
parameter_list|(
name|ATTR
parameter_list|)
value|conn->ATTR = conf->connect.ATTR
define|#
directive|define
name|COND_SHUFFLE
parameter_list|(
name|ATTR
parameter_list|)
value|if (IE_ISPRESENT(conf->connect.ATTR)) SHUFFLE(ATTR)
name|COND_SHUFFLE
argument_list|(
name|aal
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|memset
argument_list|(
name|conn
operator|->
name|blli
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|blli
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|blli
index|[
literal|0
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|IE_ISPRESENT
argument_list|(
name|conf
operator|->
name|connect
operator|.
name|blli
argument_list|)
condition|)
name|conn
operator|->
name|blli
index|[
literal|0
index|]
operator|=
name|conf
operator|->
name|connect
operator|.
name|blli
expr_stmt|;
name|conn
operator|->
name|blli_selector
operator|=
literal|1
expr_stmt|;
name|COND_SHUFFLE
argument_list|(
name|epref
argument_list|)
expr_stmt|;
name|SHUFFLE
argument_list|(
name|conned
argument_list|)
expr_stmt|;
name|SHUFFLE
argument_list|(
name|connedsub
argument_list|)
expr_stmt|;
name|SHUFFLE
argument_list|(
name|eetd
argument_list|)
expr_stmt|;
name|COND_SHUFFLE
argument_list|(
name|traffic
argument_list|)
expr_stmt|;
name|COND_SHUFFLE
argument_list|(
name|exqos
argument_list|)
expr_stmt|;
name|COND_SHUFFLE
argument_list|(
name|abrsetup
argument_list|)
expr_stmt|;
name|COND_SHUFFLE
argument_list|(
name|abradd
argument_list|)
expr_stmt|;
name|COND_SHUFFLE
argument_list|(
name|connid
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|SHUFFLE
undef|#
directive|undef
name|COND_SHUFFLE
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|conn
operator|->
name|epref
argument_list|)
condition|)
name|cc_party_setup_conf
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_ACTIVE
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_SETUP_CONFIRM
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONN_AB_FLUSH_IND
case|:
case|case
name|CONN_AB_WAIT_RESP_OK
case|:
break|break;
default|default:
goto|goto
name|bad_state
goto|;
block|}
break|break;
block|}
case|case
name|CONN_SIG_SETUP_IND
case|:
block|{
comment|/* SETUP indication */
name|struct
name|uni_msg
modifier|*
name|msg
init|=
name|arg
decl_stmt|;
name|struct
name|uniapi_setup_indication
modifier|*
name|ind
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_setup_indication
operator|*
argument_list|)
decl_stmt|;
name|u_int
name|i
decl_stmt|;
if|if
condition|(
name|conn
operator|->
name|state
operator|!=
name|CONN_IN_PREPARING
condition|)
goto|goto
name|bad_state
goto|;
comment|/* 		 * Shuffle information elements. 		 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|UNI_NUM_IE_BLLI
condition|;
name|i
operator|++
control|)
name|conn
operator|->
name|blli
index|[
name|i
index|]
operator|=
name|ind
operator|->
name|setup
operator|.
name|blli
index|[
name|i
index|]
expr_stmt|;
name|conn
operator|->
name|bearer
operator|=
name|ind
operator|->
name|setup
operator|.
name|bearer
expr_stmt|;
name|conn
operator|->
name|traffic
operator|=
name|ind
operator|->
name|setup
operator|.
name|traffic
expr_stmt|;
name|conn
operator|->
name|qos
operator|=
name|ind
operator|->
name|setup
operator|.
name|qos
expr_stmt|;
name|conn
operator|->
name|exqos
operator|=
name|ind
operator|->
name|setup
operator|.
name|exqos
expr_stmt|;
name|conn
operator|->
name|called
operator|=
name|ind
operator|->
name|setup
operator|.
name|called
expr_stmt|;
name|conn
operator|->
name|calledsub
operator|=
name|ind
operator|->
name|setup
operator|.
name|calledsub
index|[
literal|0
index|]
expr_stmt|;
name|conn
operator|->
name|aal
operator|=
name|ind
operator|->
name|setup
operator|.
name|aal
expr_stmt|;
name|conn
operator|->
name|epref
operator|=
name|ind
operator|->
name|setup
operator|.
name|epref
expr_stmt|;
name|conn
operator|->
name|eetd
operator|=
name|ind
operator|->
name|setup
operator|.
name|eetd
expr_stmt|;
name|conn
operator|->
name|abrsetup
operator|=
name|ind
operator|->
name|setup
operator|.
name|abrsetup
expr_stmt|;
name|conn
operator|->
name|abradd
operator|=
name|ind
operator|->
name|setup
operator|.
name|abradd
expr_stmt|;
name|conn
operator|->
name|calling
operator|=
name|ind
operator|->
name|setup
operator|.
name|calling
expr_stmt|;
name|conn
operator|->
name|callingsub
operator|=
name|ind
operator|->
name|setup
operator|.
name|callingsub
index|[
literal|0
index|]
expr_stmt|;
name|conn
operator|->
name|connid
operator|=
name|ind
operator|->
name|setup
operator|.
name|connid
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|UNI_NUM_IE_TNS
condition|;
name|i
operator|++
control|)
name|conn
operator|->
name|tns
index|[
name|i
index|]
operator|=
name|ind
operator|->
name|setup
operator|.
name|tns
index|[
name|i
index|]
expr_stmt|;
name|conn
operator|->
name|atraffic
operator|=
name|ind
operator|->
name|setup
operator|.
name|atraffic
expr_stmt|;
name|conn
operator|->
name|mintraffic
operator|=
name|ind
operator|->
name|setup
operator|.
name|mintraffic
expr_stmt|;
name|conn
operator|->
name|cscope
operator|=
name|ind
operator|->
name|setup
operator|.
name|cscope
expr_stmt|;
name|conn
operator|->
name|bhli
operator|=
name|ind
operator|->
name|setup
operator|.
name|bhli
expr_stmt|;
name|conn
operator|->
name|mdcr
operator|=
name|ind
operator|->
name|setup
operator|.
name|mdcr
expr_stmt|;
name|cc_conn_dispatch
argument_list|(
name|conn
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|CONN_SIG_SETUP_COMPL
case|:
block|{
name|struct
name|uni_msg
modifier|*
name|msg
init|=
name|arg
decl_stmt|;
name|struct
name|uniapi_setup_indication
modifier|*
name|ind
name|__unused
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_setup_indication
operator|*
argument_list|)
decl_stmt|;
comment|/* SETUP_COMPLETE.indication from UNI */
if|if
condition|(
name|conn
operator|->
name|state
operator|==
name|CONN_AB_FLUSH_IND
operator|||
name|conn
operator|->
name|state
operator|==
name|CONN_AB_WAIT_RESP_OK
condition|)
break|break;
if|if
condition|(
name|conn
operator|->
name|state
operator|!=
name|CONN_IN_WAIT_COMPL
condition|)
goto|goto
name|bad_state
goto|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_ACTIVE
argument_list|)
expr_stmt|;
name|LIST_FOREACH
argument_list|(
argument|party
argument_list|,
argument|&conn->parties
argument_list|,
argument|link
argument_list|)
block|{
if|if
condition|(
name|party
operator|->
name|state
operator|==
name|PARTY_WAIT_SETUP_COMPL
condition|)
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_ACTIVE
argument_list|)
expr_stmt|;
else|else
name|cc_party_log
argument_list|(
name|party
argument_list|,
literal|"bad state=%s for sig=%s"
argument_list|,
name|ptab
index|[
name|party
operator|->
name|state
index|]
argument_list|,
name|cc_conn_sigtab
index|[
name|CONN_SIG_SETUP_COMPL
index|]
argument_list|)
expr_stmt|;
block|}
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_SETUP_COMPL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|CONN_SIG_PROC_IND
case|:
block|{
comment|/* 		 * ALERTING.indication and PROCEEDING.indication are entirly 		 * ignored by the specification. We need to at least save the 		 * connid information element. 		 */
name|struct
name|uni_msg
modifier|*
name|msg
init|=
name|arg
decl_stmt|;
name|struct
name|uniapi_proceeding_indication
modifier|*
name|ind
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_proceeding_indication
operator|*
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|conn
operator|->
name|state
condition|)
block|{
case|case
name|CONN_OUT_WAIT_CONF
case|:
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|ind
operator|->
name|call_proc
operator|.
name|connid
argument_list|)
condition|)
name|conn
operator|->
name|connid
operator|=
name|ind
operator|->
name|call_proc
operator|.
name|connid
expr_stmt|;
break|break;
case|case
name|CONN_AB_FLUSH_IND
case|:
case|case
name|CONN_AB_WAIT_RESP_OK
case|:
break|break;
default|default:
goto|goto
name|bad_state
goto|;
block|}
break|break;
block|}
case|case
name|CONN_SIG_ALERTING_IND
case|:
block|{
name|struct
name|uni_msg
modifier|*
name|msg
init|=
name|arg
decl_stmt|;
name|struct
name|uniapi_alerting_indication
modifier|*
name|ind
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_alerting_indication
operator|*
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|conn
operator|->
name|state
condition|)
block|{
case|case
name|CONN_OUT_WAIT_CONF
case|:
if|if
condition|(
name|IE_ISGOOD
argument_list|(
name|ind
operator|->
name|alerting
operator|.
name|connid
argument_list|)
condition|)
name|conn
operator|->
name|connid
operator|=
name|ind
operator|->
name|alerting
operator|.
name|connid
expr_stmt|;
break|break;
case|case
name|CONN_AB_FLUSH_IND
case|:
case|case
name|CONN_AB_WAIT_RESP_OK
case|:
break|break;
default|default:
goto|goto
name|bad_state
goto|;
block|}
break|break;
block|}
case|case
name|CONN_SIG_REL_CONF
case|:
block|{
comment|/* RELEASE.confirm from UNI */
name|struct
name|uni_msg
modifier|*
name|msg
init|=
name|arg
decl_stmt|;
name|struct
name|uniapi_release_confirm
modifier|*
name|conf
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_release_confirm
operator|*
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|conn
operator|->
name|state
condition|)
block|{
case|case
name|CONN_OUT_WAIT_CONF
case|:
case|case
name|CONN_ACTIVE
case|:
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_FLUSH_IND
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|conn
operator|->
name|user
operator|->
name|cause
argument_list|,
name|conf
operator|->
name|release
operator|.
name|cause
argument_list|,
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|user
operator|->
name|cause
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 			 * If any party is in P6, ok the user 			 */
name|LIST_FOREACH
argument_list|(
argument|party
argument_list|,
argument|&conn->parties
argument_list|,
argument|link
argument_list|)
block|{
if|if
condition|(
name|party
operator|->
name|state
operator|==
name|PARTY_DROP_WAIT_ACK
condition|)
block|{
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_WAIT_DESTROY
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_DROP_PARTY_OK
argument_list|,
name|NULL
argument_list|,
name|party
operator|->
name|epref
operator|.
name|epref
argument_list|)
expr_stmt|;
block|}
block|}
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_RELEASE_CONFIRM
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cc_disconnect_from_user
argument_list|(
name|conn
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONN_AB_FLUSH_IND
case|:
case|case
name|CONN_AB_WAIT_RESP_OK
case|:
break|break;
case|case
name|CONN_IN_WAITING
case|:
name|cc_disconnect_from_user
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_FLUSH_IND
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONN_IN_ARRIVED
case|:
name|conn
operator|->
name|user
operator|->
name|aborted
operator|=
literal|1
expr_stmt|;
name|memcpy
argument_list|(
name|conn
operator|->
name|user
operator|->
name|cause
argument_list|,
name|conf
operator|->
name|release
operator|.
name|cause
argument_list|,
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|user
operator|->
name|cause
argument_list|)
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_FLUSH_IND
argument_list|)
expr_stmt|;
name|cc_disconnect_from_user
argument_list|(
name|conn
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONN_IN_WAIT_COMPL
case|:
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_FLUSH_IND
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|conn
operator|->
name|user
operator|->
name|cause
argument_list|,
name|conf
operator|->
name|release
operator|.
name|cause
argument_list|,
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|user
operator|->
name|cause
argument_list|)
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_RELEASE_CONFIRM
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cc_disconnect_from_user
argument_list|(
name|conn
argument_list|)
expr_stmt|;
break|break;
default|default:
goto|goto
name|bad_state
goto|;
block|}
break|break;
block|}
case|case
name|CONN_SIG_REL_IND
case|:
block|{
comment|/* RELEASE.ind from UNI */
name|struct
name|uni_msg
modifier|*
name|msg
init|=
name|arg
decl_stmt|;
name|struct
name|uniapi_release_indication
modifier|*
name|conf
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_release_indication
operator|*
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|conn
operator|->
name|state
condition|)
block|{
case|case
name|CONN_OUT_WAIT_CONF
case|:
case|case
name|CONN_ACTIVE
case|:
name|do_release_response
argument_list|(
name|conn
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_WAIT_RESP_OK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|conn
operator|->
name|user
operator|->
name|cause
argument_list|,
name|conf
operator|->
name|release
operator|.
name|cause
argument_list|,
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|user
operator|->
name|cause
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 			 * If any party is in P6, ok the user 			 */
name|LIST_FOREACH
argument_list|(
argument|party
argument_list|,
argument|&conn->parties
argument_list|,
argument|link
argument_list|)
block|{
if|if
condition|(
name|party
operator|->
name|state
operator|==
name|PARTY_DROP_WAIT_ACK
condition|)
block|{
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_WAIT_DESTROY
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_DROP_PARTY_OK
argument_list|,
name|NULL
argument_list|,
name|party
operator|->
name|epref
operator|.
name|epref
argument_list|)
expr_stmt|;
block|}
block|}
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_RELEASE_CONFIRM
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cc_disconnect_from_user
argument_list|(
name|conn
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONN_AB_FLUSH_IND
case|:
case|case
name|CONN_AB_WAIT_RESP_OK
case|:
break|break;
case|case
name|CONN_IN_WAITING
case|:
name|cc_disconnect_from_user
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|do_release_response
argument_list|(
name|conn
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_WAIT_RESP_OK
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONN_IN_ARRIVED
case|:
name|conn
operator|->
name|user
operator|->
name|aborted
operator|=
literal|1
expr_stmt|;
name|cc_disconnect_from_user
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|do_release_response
argument_list|(
name|conn
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_WAIT_RESP_OK
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONN_IN_WAIT_COMPL
case|:
name|do_release_response
argument_list|(
name|conn
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_WAIT_RESP_OK
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|conn
operator|->
name|user
operator|->
name|cause
argument_list|,
name|conf
operator|->
name|release
operator|.
name|cause
argument_list|,
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|user
operator|->
name|cause
argument_list|)
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_RELEASE_CONFIRM
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cc_disconnect_from_user
argument_list|(
name|conn
argument_list|)
expr_stmt|;
break|break;
default|default:
goto|goto
name|bad_state
goto|;
break|break;
block|}
break|break;
block|}
case|case
name|CONN_SIG_PARTY_ALERTING_IND
case|:
comment|/* party alerting from UNI */
if|if
condition|(
name|conn
operator|->
name|state
operator|==
name|CONN_AB_FLUSH_IND
condition|)
break|break;
if|if
condition|(
name|conn
operator|->
name|state
operator|!=
name|CONN_ACTIVE
condition|)
goto|goto
name|bad_state
goto|;
comment|/* ignore */
break|break;
case|case
name|CONN_SIG_PARTY_ADD_ACK_IND
case|:
block|{
comment|/* ADD PARTY ACKNOWLEDGE from UNI */
name|struct
name|uni_msg
modifier|*
name|msg
init|=
name|arg
decl_stmt|;
name|struct
name|uniapi_add_party_ack_indication
modifier|*
name|ind
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_add_party_ack_indication
operator|*
argument_list|)
decl_stmt|;
if|if
condition|(
name|conn
operator|->
name|state
operator|==
name|CONN_AB_FLUSH_IND
condition|)
break|break;
if|if
condition|(
name|conn
operator|->
name|state
operator|!=
name|CONN_ACTIVE
condition|)
goto|goto
name|bad_state
goto|;
name|cc_party_add_ack_ind
argument_list|(
name|conn
argument_list|,
operator|&
name|ind
operator|->
name|ack
operator|.
name|epref
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|CONN_SIG_PARTY_ADD_REJ_IND
case|:
block|{
comment|/* ADD PARTY REJECT indication */
name|struct
name|uni_msg
modifier|*
name|msg
init|=
name|arg
decl_stmt|;
name|struct
name|uniapi_add_party_rej_indication
modifier|*
name|ind
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_add_party_rej_indication
operator|*
argument_list|)
decl_stmt|;
if|if
condition|(
name|conn
operator|->
name|state
operator|==
name|CONN_AB_FLUSH_IND
condition|)
break|break;
if|if
condition|(
name|conn
operator|->
name|state
operator|!=
name|CONN_ACTIVE
condition|)
goto|goto
name|bad_state
goto|;
name|memset
argument_list|(
operator|&
name|conn
operator|->
name|user
operator|->
name|cause
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|user
operator|->
name|cause
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|conn
operator|->
name|user
operator|->
name|cause
index|[
literal|0
index|]
operator|=
name|ind
operator|->
name|rej
operator|.
name|cause
expr_stmt|;
name|cc_party_add_rej_ind
argument_list|(
name|conn
argument_list|,
operator|&
name|ind
operator|->
name|rej
operator|.
name|epref
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|CONN_SIG_DROP_PARTY_IND
case|:
block|{
comment|/* DROP_PARTY.indication from UNI */
name|struct
name|uni_msg
modifier|*
name|msg
init|=
name|arg
decl_stmt|;
name|struct
name|uniapi_drop_party_indication
modifier|*
name|ind
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_drop_party_indication
operator|*
argument_list|)
decl_stmt|;
name|struct
name|uniapi_drop_party_ack_request
modifier|*
name|req
decl_stmt|;
name|struct
name|uni_msg
modifier|*
name|u
decl_stmt|;
if|if
condition|(
name|conn
operator|->
name|state
operator|==
name|CONN_AB_FLUSH_IND
condition|)
break|break;
if|if
condition|(
name|conn
operator|->
name|state
operator|!=
name|CONN_ACTIVE
condition|)
goto|goto
name|bad_state
goto|;
name|party
operator|=
name|cc_party_find
argument_list|(
name|conn
argument_list|,
name|ind
operator|->
name|drop
operator|.
name|epref
operator|.
name|epref
argument_list|)
expr_stmt|;
if|if
condition|(
name|party
operator|==
name|NULL
condition|)
block|{
name|cc_party_log
argument_list|(
name|party
argument_list|,
literal|"no party for %s"
argument_list|,
name|cc_conn_sigtab
index|[
name|sig
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
name|u
operator|=
name|uni_msg_alloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
operator|==
name|NULL
condition|)
return|return;
name|memset
argument_list|(
operator|&
name|conn
operator|->
name|user
operator|->
name|cause
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|user
operator|->
name|cause
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|conn
operator|->
name|user
operator|->
name|cause
index|[
literal|0
index|]
operator|=
name|ind
operator|->
name|drop
operator|.
name|cause
expr_stmt|;
switch|switch
condition|(
name|party
operator|->
name|state
condition|)
block|{
default|default:
name|cc_party_log
argument_list|(
name|party
argument_list|,
literal|"bad state %s for DROP.ind"
argument_list|,
name|ptab
index|[
name|party
operator|->
name|state
index|]
argument_list|)
expr_stmt|;
comment|/* FALLTHRU */
case|case
name|PARTY_ACTIVE
case|:
comment|/* P1 -> P9 */
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_WAIT_DROP_ACK_OK
argument_list|)
expr_stmt|;
break|break;
case|case
name|PARTY_ADD_WAIT_ACK
case|:
comment|/* P4 -> P12 */
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_ADD_DROPACK_WAIT_OK
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* 		 * Construct message to UNI. 		 */
name|req
operator|=
name|uni_msg_wptr
argument_list|(
name|u
argument_list|,
expr|struct
name|uniapi_drop_party_ack_request
operator|*
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|req
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|u
operator|->
name|b_wptr
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
expr_stmt|;
name|IE_SETPRESENT
argument_list|(
name|req
operator|->
name|ack
operator|.
name|epref
argument_list|)
expr_stmt|;
name|req
operator|->
name|ack
operator|.
name|hdr
operator|.
name|act
operator|=
name|UNI_MSGACT_DEFAULT
expr_stmt|;
name|req
operator|->
name|ack
operator|.
name|hdr
operator|.
name|cref
operator|=
name|conn
operator|->
name|cref
expr_stmt|;
name|req
operator|->
name|ack
operator|.
name|epref
operator|.
name|flag
operator|=
literal|0
expr_stmt|;
name|req
operator|->
name|ack
operator|.
name|epref
operator|.
name|epref
operator|=
name|ind
operator|->
name|drop
operator|.
name|epref
operator|.
name|epref
expr_stmt|;
name|cc_send_uni
argument_list|(
name|conn
argument_list|,
name|UNIAPI_DROP_PARTY_ACK_request
argument_list|,
name|u
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|CONN_SIG_OK
case|:
block|{
comment|/* OK response from UNI */
name|struct
name|ccuser
modifier|*
name|user
init|=
name|conn
operator|->
name|user
decl_stmt|;
switch|switch
condition|(
name|conn
operator|->
name|state
condition|)
block|{
case|case
name|CONN_OUT_WAIT_OK
case|:
comment|/* C3 */
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_OUT_WAIT_CONF
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|user
operator|!=
name|NULL
condition|)
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_CONNECT_OUTGOING_OK
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONN_AB_WAIT_RESP_OK
case|:
comment|/* C33 */
case|case
name|CONN_AB_WAIT_REQ_OK
case|:
comment|/* C34 */
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_FLUSH_IND
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONN_REL_WAIT_OK
case|:
comment|/* C20 */
case|case
name|CONN_REL_IN_WAIT_OK
case|:
comment|/* C15 */
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_FLUSH_IND
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|user
operator|!=
name|NULL
condition|)
block|{
comment|/* connection has not been aborted */
name|memset
argument_list|(
operator|&
name|conn
operator|->
name|user
operator|->
name|cause
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|user
operator|->
name|cause
argument_list|)
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_RELEASE_CONFIRM
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cc_disconnect_from_user
argument_list|(
name|conn
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|CONN_IN_WAIT_ACCEPT_OK
case|:
comment|/* C12 */
if|if
condition|(
name|user
operator|==
name|NULL
condition|)
block|{
comment|/* has been aborted */
name|do_release_request
argument_list|(
name|conn
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_WAIT_REQ_OK
argument_list|)
expr_stmt|;
break|break;
block|}
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_IN_WAIT_COMPL
argument_list|)
expr_stmt|;
name|cc_disconnect_from_user
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|user
argument_list|,
name|USER_SIG_ACCEPT_OK
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|acceptor
operator|==
name|NULL
condition|)
block|{
name|do_release_request
argument_list|(
name|conn
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_WAIT_REQ_OK
argument_list|)
expr_stmt|;
break|break;
block|}
name|cc_connect_to_user
argument_list|(
name|conn
argument_list|,
name|conn
operator|->
name|acceptor
argument_list|)
expr_stmt|;
name|cc_conn_reset_acceptor
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_ACCEPTING
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONN_REJ_WAIT_OK
case|:
comment|/* C14 */
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_FLUSH_IND
argument_list|)
expr_stmt|;
if|if
condition|(
name|user
operator|!=
name|NULL
condition|)
block|{
name|cc_disconnect_from_user
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|user
argument_list|,
name|USER_SIG_REJECT_OK
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
comment|/* maybe it's for a party */
name|LIST_FOREACH
argument_list|(
argument|party
argument_list|,
argument|&conn->parties
argument_list|,
argument|link
argument_list|)
block|{
switch|switch
condition|(
name|party
operator|->
name|state
condition|)
block|{
case|case
name|PARTY_ADD_WAIT_OK
case|:
comment|/* P3 */
if|if
condition|(
name|user
operator|!=
name|NULL
condition|)
name|cc_user_sig
argument_list|(
name|user
argument_list|,
name|USER_SIG_ADD_PARTY_OK
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_ADD_WAIT_ACK
argument_list|)
expr_stmt|;
goto|goto
name|ex_party_ok
goto|;
case|case
name|PARTY_DROP_WAIT_OK
case|:
comment|/* P5 */
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_DROP_WAIT_ACK
argument_list|)
expr_stmt|;
goto|goto
name|ex_party_ok
goto|;
case|case
name|PARTY_WAIT_DROP_ACK_OK
case|:
comment|/* P9 */
case|case
name|PARTY_ADD_DROPACK_WAIT_OK
case|:
comment|/* P12 */
block|{
name|struct
name|ccparty
modifier|*
name|p1
decl_stmt|;
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_WAIT_DESTROY
argument_list|)
expr_stmt|;
comment|/* signal to user only if there are any other parties */
name|LIST_FOREACH
argument_list|(
argument|p1
argument_list|,
argument|&conn->parties
argument_list|,
argument|link
argument_list|)
if|if
condition|(
name|p1
operator|!=
name|party
condition|)
break|break;
if|if
condition|(
name|p1
operator|!=
name|NULL
operator|&&
name|user
operator|!=
name|NULL
condition|)
name|cc_user_sig
argument_list|(
name|user
argument_list|,
name|USER_SIG_DROP_PARTY_IND
argument_list|,
name|NULL
argument_list|,
name|party
operator|->
name|epref
operator|.
name|epref
argument_list|)
expr_stmt|;
goto|goto
name|ex_party_ok
goto|;
block|}
case|case
name|PARTY_ADD_DROP_WAIT_OK
case|:
comment|/* P11 */
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_DROP_WAIT_ACK
argument_list|)
expr_stmt|;
goto|goto
name|ex_party_ok
goto|;
default|default:
break|break;
block|}
block|}
goto|goto
name|bad_state
goto|;
name|ex_party_ok
label|:
break|break;
block|}
break|break;
block|}
case|case
name|CONN_SIG_ERROR
case|:
block|{
comment|/* error response from UNI */
name|u_int
name|reason
init|=
operator|(
name|iarg
operator|>>
literal|16
operator|)
operator|&
literal|0xffff
decl_stmt|;
name|u_int
name|state
init|=
name|iarg
operator|&
literal|0xffff
decl_stmt|;
name|struct
name|ccuser
modifier|*
name|user
init|=
name|conn
operator|->
name|user
decl_stmt|;
switch|switch
condition|(
name|conn
operator|->
name|state
condition|)
block|{
case|case
name|CONN_OUT_WAIT_CREATE
case|:
comment|/* C2 */
name|cc_conn_rem_port
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_OUT_PREPARING
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|user
operator|!=
name|NULL
condition|)
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_CONNECT_OUTGOING_ERR
argument_list|,
name|NULL
argument_list|,
name|ATM_MKUNIERR
argument_list|(
name|reason
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONN_OUT_WAIT_OK
case|:
comment|/* C3 */
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_OUT_WAIT_DESTROY
argument_list|)
expr_stmt|;
name|conn
operator|->
name|reason
operator|=
name|reason
expr_stmt|;
break|break;
case|case
name|CONN_AB_WAIT_REQ_OK
case|:
comment|/* C33 */
if|if
condition|(
name|state
operator|==
name|UNI_CALLSTATE_U12
condition|)
block|{
name|do_release_response
argument_list|(
name|conn
argument_list|,
literal|0
argument_list|,
name|conn
operator|->
name|cause
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_WAIT_RESP_OK
argument_list|)
expr_stmt|;
break|break;
block|}
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_FLUSH_IND
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONN_AB_WAIT_RESP_OK
case|:
comment|/* C34 */
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_FLUSH_IND
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONN_REL_WAIT_OK
case|:
comment|/* C20 */
if|if
condition|(
name|user
operator|==
name|NULL
condition|)
block|{
comment|/* connection has been aborted. */
if|if
condition|(
name|state
operator|==
name|UNI_CALLSTATE_U10
condition|)
block|{
comment|/* do what we can */
name|do_release_request
argument_list|(
name|conn
argument_list|,
name|conn
operator|->
name|cause
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_WAIT_REQ_OK
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|state
operator|==
name|UNI_CALLSTATE_U12
condition|)
block|{
name|do_release_response
argument_list|(
name|conn
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_WAIT_RESP_OK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_FLUSH_IND
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|state
operator|==
name|UNI_CALLSTATE_U10
condition|)
block|{
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_ACTIVE
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_RELEASE_ERR
argument_list|,
name|NULL
argument_list|,
name|reason
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|state
operator|==
name|UNI_CALLSTATE_U12
condition|)
block|{
name|do_release_response
argument_list|(
name|conn
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_WAIT_RESP_OK
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|conn
operator|->
name|user
operator|->
name|cause
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|user
operator|->
name|cause
argument_list|)
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_RELEASE_CONFIRM
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cc_disconnect_from_user
argument_list|(
name|conn
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_FLUSH_IND
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|conn
operator|->
name|user
operator|->
name|cause
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|user
operator|->
name|cause
argument_list|)
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_RELEASE_CONFIRM
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cc_disconnect_from_user
argument_list|(
name|conn
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|CONN_IN_WAIT_ACCEPT_OK
case|:
comment|/* C12 */
if|if
condition|(
name|user
operator|==
name|NULL
condition|)
block|{
comment|/* connection was aborted */
if|if
condition|(
name|state
operator|==
name|UNI_CALLSTATE_U6
operator|||
name|state
operator|==
name|UNI_CALLSTATE_U7
operator|||
name|state
operator|==
name|UNI_CALLSTATE_U9
operator|||
name|state
operator|==
name|UNI_CALLSTATE_U12
condition|)
block|{
name|do_release_response
argument_list|(
name|conn
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_WAIT_RESP_OK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_FLUSH_IND
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
name|cc_conn_reset_acceptor
argument_list|(
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|UNI_CALLSTATE_U6
operator|||
name|state
operator|==
name|UNI_CALLSTATE_U9
operator|||
name|state
operator|==
name|UNI_CALLSTATE_U7
condition|)
block|{
name|cc_user_sig
argument_list|(
name|user
argument_list|,
name|USER_SIG_ACCEPT_ERR
argument_list|,
name|NULL
argument_list|,
name|ATM_MKUNIERR
argument_list|(
name|reason
argument_list|)
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_IN_ARRIVED
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|state
operator|==
name|UNI_CALLSTATE_U12
condition|)
block|{
name|do_release_response
argument_list|(
name|conn
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|cc_disconnect_from_user
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|user
argument_list|,
name|USER_SIG_ACCEPT_ERR
argument_list|,
name|user
argument_list|,
name|ATMERR_PREVIOUSLY_ABORTED
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_WAIT_RESP_OK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cc_disconnect_from_user
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|user
argument_list|,
name|USER_SIG_ACCEPT_ERR
argument_list|,
name|user
argument_list|,
name|ATMERR_PREVIOUSLY_ABORTED
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_FLUSH_IND
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|CONN_REJ_WAIT_OK
case|:
comment|/* C14 */
if|if
condition|(
name|user
operator|==
name|NULL
condition|)
block|{
comment|/* connection has been aborted. */
if|if
condition|(
name|state
operator|==
name|UNI_CALLSTATE_U6
operator|||
name|state
operator|==
name|UNI_CALLSTATE_U7
operator|||
name|state
operator|==
name|UNI_CALLSTATE_U9
operator|||
name|state
operator|==
name|UNI_CALLSTATE_U12
condition|)
block|{
comment|/* do what we can */
name|do_release_response
argument_list|(
name|conn
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_WAIT_RESP_OK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_FLUSH_IND
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|state
operator|==
name|UNI_CALLSTATE_U6
operator|||
name|state
operator|==
name|UNI_CALLSTATE_U9
operator|||
name|state
operator|==
name|UNI_CALLSTATE_U7
condition|)
block|{
name|cc_user_sig
argument_list|(
name|user
argument_list|,
name|USER_SIG_REJECT_ERR
argument_list|,
name|NULL
argument_list|,
name|ATM_MKUNIERR
argument_list|(
name|reason
argument_list|)
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_IN_ARRIVED
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cc_disconnect_from_user
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|user
argument_list|,
name|USER_SIG_REJECT_OK
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_FLUSH_IND
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|CONN_REL_IN_WAIT_OK
case|:
comment|/* C15 */
if|if
condition|(
name|user
operator|==
name|NULL
condition|)
block|{
comment|/* connection has been aborted. */
if|if
condition|(
name|state
operator|==
name|UNI_CALLSTATE_U8
condition|)
block|{
comment|/* do what we can */
name|do_release_request
argument_list|(
name|conn
argument_list|,
name|conn
operator|->
name|cause
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_WAIT_REQ_OK
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|state
operator|==
name|UNI_CALLSTATE_U12
condition|)
block|{
name|do_release_response
argument_list|(
name|conn
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_WAIT_RESP_OK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_FLUSH_IND
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|state
operator|==
name|UNI_CALLSTATE_U8
condition|)
block|{
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_IN_WAIT_COMPL
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_RELEASE_ERR
argument_list|,
name|NULL
argument_list|,
name|reason
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|state
operator|==
name|UNI_CALLSTATE_U12
condition|)
block|{
name|do_release_response
argument_list|(
name|conn
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_WAIT_RESP_OK
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|conn
operator|->
name|user
operator|->
name|cause
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|user
operator|->
name|cause
argument_list|)
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_RELEASE_CONFIRM
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cc_disconnect_from_user
argument_list|(
name|conn
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cc_conn_set_state
argument_list|(
name|conn
argument_list|,
name|CONN_AB_FLUSH_IND
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|conn
operator|->
name|user
operator|->
name|cause
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|user
operator|->
name|cause
argument_list|)
argument_list|)
expr_stmt|;
name|cc_user_sig
argument_list|(
name|conn
operator|->
name|user
argument_list|,
name|USER_SIG_RELEASE_CONFIRM
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|cc_disconnect_from_user
argument_list|(
name|conn
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
comment|/* maybe it's for a party */
name|LIST_FOREACH
argument_list|(
argument|party
argument_list|,
argument|&conn->parties
argument_list|,
argument|link
argument_list|)
block|{
switch|switch
condition|(
name|party
operator|->
name|state
condition|)
block|{
case|case
name|PARTY_ADD_WAIT_CREATE
case|:
comment|/* P2 */
name|cc_party_destroy
argument_list|(
name|party
argument_list|)
expr_stmt|;
if|if
condition|(
name|user
operator|!=
name|NULL
condition|)
name|cc_user_sig
argument_list|(
name|user
argument_list|,
name|USER_SIG_ADD_PARTY_ERR
argument_list|,
name|NULL
argument_list|,
name|ATM_MKUNIERR
argument_list|(
name|reason
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|ex_party_err
goto|;
case|case
name|PARTY_ADD_WAIT_OK
case|:
comment|/* P3 */
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_WAIT_DESTROY
argument_list|)
expr_stmt|;
if|if
condition|(
name|user
operator|!=
name|NULL
condition|)
name|cc_user_sig
argument_list|(
name|user
argument_list|,
name|USER_SIG_ADD_PARTY_ERR
argument_list|,
name|NULL
argument_list|,
name|ATM_MKUNIERR
argument_list|(
name|reason
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|ex_party_err
goto|;
case|case
name|PARTY_DROP_WAIT_OK
case|:
comment|/* P5 */
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_ACTIVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|user
operator|!=
name|NULL
condition|)
name|cc_user_sig
argument_list|(
name|user
argument_list|,
name|USER_SIG_DROP_PARTY_ERR
argument_list|,
name|NULL
argument_list|,
name|ATM_MKUNIERR
argument_list|(
name|reason
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|ex_party_err
goto|;
case|case
name|PARTY_WAIT_DROP_ACK_OK
case|:
comment|/* P9 */
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_ACTIVE
argument_list|)
expr_stmt|;
goto|goto
name|ex_party_err
goto|;
case|case
name|PARTY_ADD_DROP_WAIT_OK
case|:
comment|/* P11 */
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_ADD_WAIT_ACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|user
operator|!=
name|NULL
condition|)
name|cc_user_sig
argument_list|(
name|user
argument_list|,
name|USER_SIG_DROP_PARTY_ERR
argument_list|,
name|NULL
argument_list|,
name|ATM_MKUNIERR
argument_list|(
name|reason
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|ex_party_err
goto|;
case|case
name|PARTY_ADD_DROPACK_WAIT_OK
case|:
comment|/* P12 */
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_ADD_WAIT_ACK
argument_list|)
expr_stmt|;
goto|goto
name|ex_party_err
goto|;
default|default:
break|break;
block|}
block|}
name|cc_conn_log
argument_list|(
name|conn
argument_list|,
literal|"unexpected reason=%u ustate=%u "
literal|"state=%s\n"
argument_list|,
name|reason
argument_list|,
name|state
argument_list|,
name|stab
index|[
name|conn
operator|->
name|state
index|]
argument_list|)
expr_stmt|;
name|ex_party_err
label|:
break|break;
block|}
break|break;
block|}
case|case
name|CONN_SIG_PARTY_CREATED
case|:
block|{
name|struct
name|uni_msg
modifier|*
name|msg
init|=
name|arg
decl_stmt|;
name|struct
name|uniapi_party_created
modifier|*
name|pcr
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_party_created
operator|*
argument_list|)
decl_stmt|;
name|party
operator|=
name|cc_party_find
argument_list|(
name|conn
argument_list|,
name|pcr
operator|->
name|epref
operator|.
name|epref
argument_list|)
expr_stmt|;
if|if
condition|(
name|party
operator|==
name|NULL
condition|)
block|{
comment|/* for incoming connections we see the party-created 			 * immediately after the call-create so that we 			 * must be in C10 */
switch|switch
condition|(
name|conn
operator|->
name|state
condition|)
block|{
case|case
name|CONN_IN_PREPARING
case|:
name|party
operator|=
name|cc_party_create
argument_list|(
name|conn
argument_list|,
name|pcr
operator|->
name|epref
operator|.
name|epref
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|party
operator|==
name|NULL
condition|)
break|break;
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_WAIT_SETUP_COMPL
argument_list|)
expr_stmt|;
break|break;
case|case
name|CONN_OUT_WAIT_OK
case|:
name|party
operator|=
name|cc_party_create
argument_list|(
name|conn
argument_list|,
name|pcr
operator|->
name|epref
operator|.
name|epref
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|party
operator|==
name|NULL
condition|)
break|break;
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_WAIT_SETUP_CONF
argument_list|)
expr_stmt|;
break|break;
default|default:
goto|goto
name|bad_state
goto|;
block|}
break|break;
block|}
comment|/* this is for an ADD-PARTY */
if|if
condition|(
name|conn
operator|->
name|state
operator|!=
name|CONN_ACTIVE
condition|)
goto|goto
name|bad_state
goto|;
if|if
condition|(
name|party
operator|->
name|state
operator|!=
name|PARTY_ADD_WAIT_CREATE
condition|)
goto|goto
name|bad_party_state
goto|;
name|cc_party_set_state
argument_list|(
name|party
argument_list|,
name|PARTY_ADD_WAIT_OK
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|CONN_SIG_PARTY_DESTROYED
case|:
block|{
name|struct
name|uni_msg
modifier|*
name|msg
init|=
name|arg
decl_stmt|;
name|struct
name|uniapi_party_destroyed
modifier|*
name|pcr
init|=
name|uni_msg_rptr
argument_list|(
name|msg
argument_list|,
expr|struct
name|uniapi_party_destroyed
operator|*
argument_list|)
decl_stmt|;
name|party
operator|=
name|cc_party_find
argument_list|(
name|conn
argument_list|,
name|pcr
operator|->
name|epref
operator|.
name|epref
argument_list|)
expr_stmt|;
if|if
condition|(
name|party
operator|==
name|NULL
condition|)
block|{
name|cc_conn_log
argument_list|(
name|conn
argument_list|,
literal|"no party to destroy %u/%u"
argument_list|,
name|pcr
operator|->
name|epref
operator|.
name|flag
argument_list|,
name|pcr
operator|->
name|epref
operator|.
name|epref
argument_list|)
expr_stmt|;
break|break;
block|}
name|cc_party_destroy
argument_list|(
name|party
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return;
name|bad_state
label|:
name|cc_conn_log
argument_list|(
name|conn
argument_list|,
literal|"bad state=%s for signal=%s"
argument_list|,
name|stab
index|[
name|conn
operator|->
name|state
index|]
argument_list|,
name|cc_conn_sigtab
index|[
name|sig
index|]
argument_list|)
expr_stmt|;
return|return;
name|bad_party_state
label|:
name|cc_conn_log
argument_list|(
name|conn
argument_list|,
literal|"bad party state=%s for signal=%s"
argument_list|,
name|ptab
index|[
name|party
operator|->
name|state
index|]
argument_list|,
name|cc_conn_sigtab
index|[
name|sig
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

end_unit


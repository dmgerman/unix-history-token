begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2008-2012 Freescale Semiconductor Inc.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are met:  *     * Redistributions of source code must retain the above copyright  *       notice, this list of conditions and the following disclaimer.  *     * Redistributions in binary form must reproduce the above copyright  *       notice, this list of conditions and the following disclaimer in the  *       documentation and/or other materials provided with the distribution.  *     * Neither the name of Freescale Semiconductor nor the  *       names of its contributors may be used to endorse or promote products  *       derived from this software without specific prior written permission.  *  *  * ALTERNATIVELY, this software may be distributed under the terms of the  * GNU General Public License ("GPL") as published by the Free Software  * Foundation, either version 2 of that License or (at your option) any  * later version.  *  * THIS SOFTWARE IS PROVIDED BY Freescale Semiconductor ``AS IS'' AND ANY  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED. IN NO EVENT SHALL Freescale Semiconductor BE LIABLE FOR ANY  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/******************************************************************************  @File          fm_port_im.c   @Description   FM Port Independent-Mode ... */
end_comment

begin_comment
comment|/***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|"std_ext.h"
end_include

begin_include
include|#
directive|include
file|"string_ext.h"
end_include

begin_include
include|#
directive|include
file|"error_ext.h"
end_include

begin_include
include|#
directive|include
file|"memcpy_ext.h"
end_include

begin_include
include|#
directive|include
file|"fm_muram_ext.h"
end_include

begin_include
include|#
directive|include
file|"fm_port.h"
end_include

begin_define
define|#
directive|define
name|TX_CONF_STATUS_UNSENT
value|0x1
end_define

begin_typedef
typedef|typedef
enum|enum
name|e_TxConfType
block|{
name|e_TX_CONF_TYPE_CHECK
init|=
literal|0
comment|/**< check if all the buffers were touched by the muxator, no confirmation callback */
block|,
name|e_TX_CONF_TYPE_CALLBACK
init|=
literal|1
comment|/**< confirm to user all the available sent buffers */
block|,
name|e_TX_CONF_TYPE_FLUSH
init|=
literal|3
comment|/**< confirm all buffers plus the unsent one with an appropriate status */
block|}
name|e_TxConfType
typedef|;
end_typedef

begin_function
specifier|static
name|void
name|ImException
parameter_list|(
name|t_Handle
name|h_FmPort
parameter_list|,
name|uint32_t
name|event
parameter_list|)
block|{
name|t_FmPort
modifier|*
name|p_FmPort
init|=
operator|(
name|t_FmPort
operator|*
operator|)
name|h_FmPort
decl_stmt|;
name|ASSERT_COND
argument_list|(
operator|(
operator|(
name|event
operator|&
operator|(
name|IM_EV_RX
operator||
name|IM_EV_BSY
operator|)
operator|)
operator|&&
name|FmIsMaster
argument_list|(
name|p_FmPort
operator|->
name|h_Fm
argument_list|)
operator|)
operator|||
operator|!
name|FmIsMaster
argument_list|(
name|p_FmPort
operator|->
name|h_Fm
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IM_EV_RX
condition|)
name|FmPortImRx
argument_list|(
name|p_FmPort
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|event
operator|&
name|IM_EV_BSY
operator|)
operator|&&
name|p_FmPort
operator|->
name|f_Exception
condition|)
name|p_FmPort
operator|->
name|f_Exception
argument_list|(
name|p_FmPort
operator|->
name|h_App
argument_list|,
name|e_FM_PORT_EXCEPTION_IM_BUSY
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|TxConf
parameter_list|(
name|t_FmPort
modifier|*
name|p_FmPort
parameter_list|,
name|e_TxConfType
name|confType
parameter_list|)
block|{
name|t_Error
name|retVal
init|=
name|E_BUSY
decl_stmt|;
name|uint32_t
name|bdStatus
decl_stmt|;
name|uint16_t
name|savedStartBdId
decl_stmt|,
name|confBdId
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_FmPort
argument_list|)
expr_stmt|;
comment|/*     if (confType==e_TX_CONF_TYPE_CHECK)         return (WfqEntryIsQueueEmpty(p_FmPort->im.h_WfqEntry) ? E_OK : E_BUSY);     */
name|confBdId
operator|=
name|savedStartBdId
operator|=
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
expr_stmt|;
name|bdStatus
operator|=
name|BD_STATUS_AND_LENGTH
argument_list|(
name|BD_GET
argument_list|(
name|confBdId
argument_list|)
argument_list|)
expr_stmt|;
comment|/* If R bit is set, we don't enter, or we break.        we run till we get to R, or complete the loop */
while|while
condition|(
operator|(
operator|!
operator|(
name|bdStatus
operator|&
name|BD_R_E
operator|)
operator|||
operator|(
name|confType
operator|==
name|e_TX_CONF_TYPE_FLUSH
operator|)
operator|)
operator|&&
operator|(
name|retVal
operator|!=
name|E_OK
operator|)
condition|)
block|{
if|if
condition|(
name|confType
operator|&
name|e_TX_CONF_TYPE_CALLBACK
condition|)
comment|/* if it is confirmation with user callbacks */
name|BD_STATUS_AND_LENGTH_SET
argument_list|(
name|BD_GET
argument_list|(
name|confBdId
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* case 1: R bit is 0 and Length is set -> confirm! */
if|if
condition|(
operator|(
name|confType
operator|&
name|e_TX_CONF_TYPE_CALLBACK
operator|)
operator|&&
operator|(
name|bdStatus
operator|&
name|BD_LENGTH_MASK
operator|)
condition|)
block|{
if|if
condition|(
name|p_FmPort
operator|->
name|im
operator|.
name|f_TxConf
condition|)
block|{
if|if
condition|(
operator|(
name|confType
operator|==
name|e_TX_CONF_TYPE_FLUSH
operator|)
operator|&&
operator|(
name|bdStatus
operator|&
name|BD_R_E
operator|)
condition|)
name|p_FmPort
operator|->
name|im
operator|.
name|f_TxConf
argument_list|(
name|p_FmPort
operator|->
name|h_App
argument_list|,
name|BdBufferGet
argument_list|(
name|XX_PhysToVirt
argument_list|,
name|BD_GET
argument_list|(
name|confBdId
argument_list|)
argument_list|)
argument_list|,
name|TX_CONF_STATUS_UNSENT
argument_list|,
name|p_FmPort
operator|->
name|im
operator|.
name|p_BdShadow
index|[
name|confBdId
index|]
argument_list|)
expr_stmt|;
else|else
name|p_FmPort
operator|->
name|im
operator|.
name|f_TxConf
argument_list|(
name|p_FmPort
operator|->
name|h_App
argument_list|,
name|BdBufferGet
argument_list|(
name|XX_PhysToVirt
argument_list|,
name|BD_GET
argument_list|(
name|confBdId
argument_list|)
argument_list|)
argument_list|,
literal|0
argument_list|,
name|p_FmPort
operator|->
name|im
operator|.
name|p_BdShadow
index|[
name|confBdId
index|]
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* case 2: R bit is 0 and Length is 0 -> not used yet, nop! */
name|confBdId
operator|=
name|GetNextBdId
argument_list|(
name|p_FmPort
argument_list|,
name|confBdId
argument_list|)
expr_stmt|;
if|if
condition|(
name|confBdId
operator|==
name|savedStartBdId
condition|)
name|retVal
operator|=
name|E_OK
expr_stmt|;
name|bdStatus
operator|=
name|BD_STATUS_AND_LENGTH
argument_list|(
name|BD_GET
argument_list|(
name|confBdId
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|retVal
return|;
block|}
end_function

begin_function
name|t_Error
name|FmPortImEnable
parameter_list|(
name|t_FmPort
modifier|*
name|p_FmPort
parameter_list|)
block|{
name|uint32_t
name|tmpReg
init|=
name|GET_UINT32
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
operator|->
name|mode
argument_list|)
decl_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
operator|->
name|mode
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|tmpReg
operator|&
operator|~
name|IM_MODE_GRC_STP
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FmPortImDisable
parameter_list|(
name|t_FmPort
modifier|*
name|p_FmPort
parameter_list|)
block|{
name|uint32_t
name|tmpReg
init|=
name|GET_UINT32
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
operator|->
name|mode
argument_list|)
decl_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
operator|->
name|mode
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|tmpReg
operator||
name|IM_MODE_GRC_STP
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FmPortImRx
parameter_list|(
name|t_FmPort
modifier|*
name|p_FmPort
parameter_list|)
block|{
name|t_Handle
name|h_CurrUserPriv
decl_stmt|,
name|h_NewUserPriv
decl_stmt|;
name|uint32_t
name|bdStatus
decl_stmt|;
specifier|volatile
name|uint8_t
name|buffPos
decl_stmt|;
name|uint16_t
name|length
decl_stmt|;
name|uint16_t
name|errors
decl_stmt|;
name|uint8_t
modifier|*
name|p_CurData
decl_stmt|,
modifier|*
name|p_Data
decl_stmt|;
name|uint32_t
name|flags
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_FmPort
argument_list|)
expr_stmt|;
name|flags
operator|=
name|XX_LockIntrSpinlock
argument_list|(
name|p_FmPort
operator|->
name|h_Spinlock
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_FmPort
operator|->
name|lock
condition|)
block|{
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_FmPort
operator|->
name|h_Spinlock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
name|p_FmPort
operator|->
name|lock
operator|=
name|TRUE
expr_stmt|;
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_FmPort
operator|->
name|h_Spinlock
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|bdStatus
operator|=
name|BD_STATUS_AND_LENGTH
argument_list|(
name|BD_GET
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|bdStatus
operator|&
name|BD_R_E
operator|)
condition|)
comment|/* while there is data in the Rx BD */
block|{
if|if
condition|(
operator|(
name|p_Data
operator|=
name|p_FmPort
operator|->
name|im
operator|.
name|rxPool
operator|.
name|f_GetBuf
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|rxPool
operator|.
name|h_BufferPool
argument_list|,
operator|&
name|h_NewUserPriv
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|p_FmPort
operator|->
name|lock
operator|=
name|FALSE
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_AVAILABLE
argument_list|,
operator|(
literal|"Data buffer"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p_FmPort
operator|->
name|im
operator|.
name|firstBdOfFrameId
operator|==
name|IM_ILEGAL_BD_ID
condition|)
name|p_FmPort
operator|->
name|im
operator|.
name|firstBdOfFrameId
operator|=
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
expr_stmt|;
name|p_CurData
operator|=
name|BdBufferGet
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|rxPool
operator|.
name|f_PhysToVirt
argument_list|,
name|BD_GET
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
argument_list|)
argument_list|)
expr_stmt|;
name|h_CurrUserPriv
operator|=
name|p_FmPort
operator|->
name|im
operator|.
name|p_BdShadow
index|[
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
index|]
expr_stmt|;
name|length
operator|=
call|(
name|uint16_t
call|)
argument_list|(
operator|(
name|bdStatus
operator|&
name|BD_L
operator|)
condition|?
operator|(
operator|(
name|bdStatus
operator|&
name|BD_LENGTH_MASK
operator|)
operator|-
name|p_FmPort
operator|->
name|im
operator|.
name|rxFrameAccumLength
operator|)
else|:
operator|(
name|bdStatus
operator|&
name|BD_LENGTH_MASK
operator|)
argument_list|)
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|rxFrameAccumLength
operator|+=
name|length
expr_stmt|;
comment|/* determine whether buffer is first, last, first and last (single  */
comment|/* buffer frame) or middle (not first and not last)                 */
name|buffPos
operator|=
call|(
name|uint8_t
call|)
argument_list|(
operator|(
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
operator|==
name|p_FmPort
operator|->
name|im
operator|.
name|firstBdOfFrameId
operator|)
condition|?
operator|(
operator|(
name|bdStatus
operator|&
name|BD_L
operator|)
condition|?
name|SINGLE_BUF
else|:
name|FIRST_BUF
operator|)
else|:
operator|(
operator|(
name|bdStatus
operator|&
name|BD_L
operator|)
condition|?
name|LAST_BUF
else|:
name|MIDDLE_BUF
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bdStatus
operator|&
name|BD_L
condition|)
block|{
name|p_FmPort
operator|->
name|im
operator|.
name|rxFrameAccumLength
operator|=
literal|0
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|firstBdOfFrameId
operator|=
name|IM_ILEGAL_BD_ID
expr_stmt|;
block|}
name|BdBufferSet
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|rxPool
operator|.
name|f_VirtToPhys
argument_list|,
name|BD_GET
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
argument_list|)
argument_list|,
name|p_Data
argument_list|)
expr_stmt|;
name|BD_STATUS_AND_LENGTH_SET
argument_list|(
name|BD_GET
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
argument_list|)
argument_list|,
name|BD_R_E
argument_list|)
expr_stmt|;
name|errors
operator|=
call|(
name|uint16_t
call|)
argument_list|(
operator|(
name|bdStatus
operator|&
name|BD_RX_ERRORS
operator|)
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|p_BdShadow
index|[
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
index|]
operator|=
name|h_NewUserPriv
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
operator|=
name|GetNextBdId
argument_list|(
name|p_FmPort
argument_list|,
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
argument_list|)
expr_stmt|;
name|WRITE_UINT16
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
operator|->
name|rxQd
operator|.
name|offsetOut
argument_list|,
call|(
name|uint16_t
call|)
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
operator|<<
literal|4
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Pass the buffer if one of the conditions is true:         - There are no errors         - This is a part of a larger frame ( the application has already received some buffers ) */
if|if
condition|(
operator|(
name|buffPos
operator|!=
name|SINGLE_BUF
operator|)
operator|||
operator|!
name|errors
condition|)
block|{
if|if
condition|(
name|p_FmPort
operator|->
name|im
operator|.
name|f_RxStore
argument_list|(
name|p_FmPort
operator|->
name|h_App
argument_list|,
name|p_CurData
argument_list|,
name|length
argument_list|,
name|errors
argument_list|,
name|buffPos
argument_list|,
name|h_CurrUserPriv
argument_list|)
operator|==
name|e_RX_STORE_RESPONSE_PAUSE
condition|)
break|break;
block|}
elseif|else
if|if
condition|(
name|p_FmPort
operator|->
name|im
operator|.
name|rxPool
operator|.
name|f_PutBuf
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|rxPool
operator|.
name|h_BufferPool
argument_list|,
name|p_CurData
argument_list|,
name|h_CurrUserPriv
argument_list|)
condition|)
block|{
name|p_FmPort
operator|->
name|lock
operator|=
name|FALSE
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Failed freeing data buffer"
operator|)
argument_list|)
expr_stmt|;
block|}
name|bdStatus
operator|=
name|BD_STATUS_AND_LENGTH
argument_list|(
name|BD_GET
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|p_FmPort
operator|->
name|lock
operator|=
name|FALSE
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|void
name|FmPortConfigIM
parameter_list|(
name|t_FmPort
modifier|*
name|p_FmPort
parameter_list|,
name|t_FmPortParams
modifier|*
name|p_FmPortParams
parameter_list|)
block|{
name|ASSERT_COND
argument_list|(
name|p_FmPort
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN
argument_list|(
name|p_FmPort
operator|->
name|p_FmPortDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|h_FmMuram
operator|=
name|p_FmPortParams
operator|->
name|specificParams
operator|.
name|imRxTxParams
operator|.
name|h_FmMuram
expr_stmt|;
name|p_FmPort
operator|->
name|p_FmPortDriverParam
operator|->
name|liodnOffset
operator|=
name|p_FmPortParams
operator|->
name|specificParams
operator|.
name|imRxTxParams
operator|.
name|liodnOffset
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|dataMemId
operator|=
name|p_FmPortParams
operator|->
name|specificParams
operator|.
name|imRxTxParams
operator|.
name|dataMemId
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|dataMemAttributes
operator|=
name|p_FmPortParams
operator|->
name|specificParams
operator|.
name|imRxTxParams
operator|.
name|dataMemAttributes
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|fwExtStructsMemId
operator|=
name|DEFAULT_PORT_ImfwExtStructsMemId
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|fwExtStructsMemAttr
operator|=
name|DEFAULT_PORT_ImfwExtStructsMemAttr
expr_stmt|;
if|if
condition|(
operator|(
name|p_FmPort
operator|->
name|portType
operator|==
name|e_FM_PORT_TYPE_RX
operator|)
operator|||
operator|(
name|p_FmPort
operator|->
name|portType
operator|==
name|e_FM_PORT_TYPE_RX_10G
operator|)
condition|)
block|{
name|p_FmPort
operator|->
name|im
operator|.
name|rxPool
operator|.
name|h_BufferPool
operator|=
name|p_FmPortParams
operator|->
name|specificParams
operator|.
name|imRxTxParams
operator|.
name|rxPoolParams
operator|.
name|h_BufferPool
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|rxPool
operator|.
name|f_GetBuf
operator|=
name|p_FmPortParams
operator|->
name|specificParams
operator|.
name|imRxTxParams
operator|.
name|rxPoolParams
operator|.
name|f_GetBuf
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|rxPool
operator|.
name|f_PutBuf
operator|=
name|p_FmPortParams
operator|->
name|specificParams
operator|.
name|imRxTxParams
operator|.
name|rxPoolParams
operator|.
name|f_PutBuf
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|rxPool
operator|.
name|bufferSize
operator|=
name|p_FmPortParams
operator|->
name|specificParams
operator|.
name|imRxTxParams
operator|.
name|rxPoolParams
operator|.
name|bufferSize
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|rxPool
operator|.
name|f_PhysToVirt
operator|=
name|p_FmPortParams
operator|->
name|specificParams
operator|.
name|imRxTxParams
operator|.
name|rxPoolParams
operator|.
name|f_PhysToVirt
expr_stmt|;
if|if
condition|(
operator|!
name|p_FmPort
operator|->
name|im
operator|.
name|rxPool
operator|.
name|f_PhysToVirt
condition|)
name|p_FmPort
operator|->
name|im
operator|.
name|rxPool
operator|.
name|f_PhysToVirt
operator|=
name|XX_PhysToVirt
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|rxPool
operator|.
name|f_VirtToPhys
operator|=
name|p_FmPortParams
operator|->
name|specificParams
operator|.
name|imRxTxParams
operator|.
name|rxPoolParams
operator|.
name|f_VirtToPhys
expr_stmt|;
if|if
condition|(
operator|!
name|p_FmPort
operator|->
name|im
operator|.
name|rxPool
operator|.
name|f_VirtToPhys
condition|)
name|p_FmPort
operator|->
name|im
operator|.
name|rxPool
operator|.
name|f_VirtToPhys
operator|=
name|XX_VirtToPhys
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|f_RxStore
operator|=
name|p_FmPortParams
operator|->
name|specificParams
operator|.
name|imRxTxParams
operator|.
name|f_RxStore
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|mrblr
operator|=
literal|0x8000
expr_stmt|;
while|while
condition|(
name|p_FmPort
operator|->
name|im
operator|.
name|mrblr
condition|)
block|{
if|if
condition|(
name|p_FmPort
operator|->
name|im
operator|.
name|rxPool
operator|.
name|bufferSize
operator|&
name|p_FmPort
operator|->
name|im
operator|.
name|mrblr
condition|)
break|break;
name|p_FmPort
operator|->
name|im
operator|.
name|mrblr
operator|>>=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|p_FmPort
operator|->
name|im
operator|.
name|mrblr
operator|!=
name|p_FmPort
operator|->
name|im
operator|.
name|rxPool
operator|.
name|bufferSize
condition|)
name|DBG
argument_list|(
name|WARNING
argument_list|,
operator|(
literal|"Max-Rx-Buffer-Length set to %d"
operator|,
name|p_FmPort
operator|->
name|im
operator|.
name|mrblr
operator|)
argument_list|)
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|bdRingSize
operator|=
name|DEFAULT_PORT_rxBdRingLength
expr_stmt|;
name|p_FmPort
operator|->
name|exceptions
operator|=
name|DEFAULT_PORT_exception
expr_stmt|;
if|if
condition|(
name|FmIsMaster
argument_list|(
name|p_FmPort
operator|->
name|h_Fm
argument_list|)
condition|)
name|p_FmPort
operator|->
name|polling
operator|=
name|FALSE
expr_stmt|;
else|else
name|p_FmPort
operator|->
name|polling
operator|=
name|TRUE
expr_stmt|;
name|p_FmPort
operator|->
name|fmanCtrlEventId
operator|=
operator|(
name|uint8_t
operator|)
name|NO_IRQ
expr_stmt|;
block|}
else|else
block|{
name|p_FmPort
operator|->
name|im
operator|.
name|f_TxConf
operator|=
name|p_FmPortParams
operator|->
name|specificParams
operator|.
name|imRxTxParams
operator|.
name|f_TxConf
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|bdRingSize
operator|=
name|DEFAULT_PORT_txBdRingLength
expr_stmt|;
block|}
block|}
end_function

begin_function
name|t_Error
name|FmPortImCheckInitParameters
parameter_list|(
name|t_FmPort
modifier|*
name|p_FmPort
parameter_list|)
block|{
if|if
condition|(
operator|(
name|p_FmPort
operator|->
name|portType
operator|!=
name|e_FM_PORT_TYPE_RX
operator|)
operator|&&
operator|(
name|p_FmPort
operator|->
name|portType
operator|!=
name|e_FM_PORT_TYPE_RX_10G
operator|)
operator|&&
operator|(
name|p_FmPort
operator|->
name|portType
operator|!=
name|e_FM_PORT_TYPE_TX
operator|)
operator|&&
operator|(
name|p_FmPort
operator|->
name|portType
operator|!=
name|e_FM_PORT_TYPE_TX_10G
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_FmPort
operator|->
name|portType
operator|==
name|e_FM_PORT_TYPE_RX
operator|)
operator|||
operator|(
name|p_FmPort
operator|->
name|portType
operator|==
name|e_FM_PORT_TYPE_RX_10G
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|POWER_OF_2
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|mrblr
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"max Rx buffer length must be power of 2!!!"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_FmPort
operator|->
name|im
operator|.
name|mrblr
operator|<
literal|256
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"max Rx buffer length must at least 256!!!"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_FmPort
operator|->
name|p_FmPortDriverParam
operator|->
name|liodnOffset
operator|&
operator|~
name|FM_LIODN_OFFSET_MASK
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"liodnOffset is larger than %d"
operator|,
name|FM_LIODN_OFFSET_MASK
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FmPortImInit
parameter_list|(
name|t_FmPort
modifier|*
name|p_FmPort
parameter_list|)
block|{
name|t_FmImBd
modifier|*
name|p_Bd
init|=
name|NULL
decl_stmt|;
name|t_Handle
name|h_BufContext
decl_stmt|;
name|uint64_t
name|tmpPhysBase
decl_stmt|;
name|uint16_t
name|log2Num
decl_stmt|;
name|uint8_t
modifier|*
name|p_Data
comment|/*, *p_Tmp*/
decl_stmt|;
name|int
name|i
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|uint16_t
name|tmpReg16
decl_stmt|;
name|uint32_t
name|tmpReg32
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_FmPort
argument_list|)
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
operator|=
operator|(
name|t_FmPortImPram
operator|*
operator|)
name|FM_MURAM_AllocMem
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|h_FmMuram
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmPortImPram
argument_list|)
argument_list|,
name|IM_PRAM_ALIGN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"Independent-Mode Parameter-RAM!!!"
operator|)
argument_list|)
expr_stmt|;
name|WRITE_BLOCK
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmPortImPram
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_FmPort
operator|->
name|portType
operator|==
name|e_FM_PORT_TYPE_RX
operator|)
operator|||
operator|(
name|p_FmPort
operator|->
name|portType
operator|==
name|e_FM_PORT_TYPE_RX_10G
operator|)
condition|)
block|{
name|p_FmPort
operator|->
name|im
operator|.
name|p_BdRing
operator|=
operator|(
name|t_FmImBd
operator|*
operator|)
name|XX_MallocSmart
argument_list|(
call|(
name|uint32_t
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|t_FmImBd
argument_list|)
operator|*
name|p_FmPort
operator|->
name|im
operator|.
name|bdRingSize
argument_list|)
argument_list|,
name|p_FmPort
operator|->
name|im
operator|.
name|fwExtStructsMemId
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_FmPort
operator|->
name|im
operator|.
name|p_BdRing
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"Independent-Mode Rx BD ring!!!"
operator|)
argument_list|)
expr_stmt|;
name|IOMemSet32
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_BdRing
argument_list|,
literal|0
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|t_FmImBd
argument_list|)
operator|*
name|p_FmPort
operator|->
name|im
operator|.
name|bdRingSize
argument_list|)
argument_list|)
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|p_BdShadow
operator|=
operator|(
name|t_Handle
operator|*
operator|)
name|XX_Malloc
argument_list|(
call|(
name|uint32_t
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|t_Handle
argument_list|)
operator|*
name|p_FmPort
operator|->
name|im
operator|.
name|bdRingSize
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_FmPort
operator|->
name|im
operator|.
name|p_BdShadow
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"Independent-Mode Rx BD shadow!!!"
operator|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_BdShadow
argument_list|,
literal|0
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|t_Handle
argument_list|)
operator|*
name|p_FmPort
operator|->
name|im
operator|.
name|bdRingSize
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Initialize the Rx-BD ring */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p_FmPort
operator|->
name|im
operator|.
name|bdRingSize
condition|;
name|i
operator|++
control|)
block|{
name|p_Bd
operator|=
name|BD_GET
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|BD_STATUS_AND_LENGTH_SET
argument_list|(
name|p_Bd
argument_list|,
name|BD_R_E
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Data
operator|=
name|p_FmPort
operator|->
name|im
operator|.
name|rxPool
operator|.
name|f_GetBuf
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|rxPool
operator|.
name|h_BufferPool
argument_list|,
operator|&
name|h_BufContext
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_AVAILABLE
argument_list|,
operator|(
literal|"Data buffer"
operator|)
argument_list|)
expr_stmt|;
name|BdBufferSet
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|rxPool
operator|.
name|f_VirtToPhys
argument_list|,
name|p_Bd
argument_list|,
name|p_Data
argument_list|)
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|p_BdShadow
index|[
name|i
index|]
operator|=
name|h_BufContext
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|p_FmPort
operator|->
name|im
operator|.
name|dataMemAttributes
operator|&
name|MEMORY_ATTR_CACHEABLE
operator|)
operator|||
operator|(
name|p_FmPort
operator|->
name|im
operator|.
name|fwExtStructsMemAttr
operator|&
name|MEMORY_ATTR_CACHEABLE
operator|)
condition|)
name|WRITE_UINT32
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
operator|->
name|mode
argument_list|,
name|IM_MODE_GBL
operator||
name|IM_MODE_SET_BO
argument_list|(
literal|2
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|WRITE_UINT32
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
operator|->
name|mode
argument_list|,
name|IM_MODE_SET_BO
argument_list|(
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
operator|->
name|rxQdPtr
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
call|(
name|uint64_t
call|)
argument_list|(
name|XX_VirtToPhys
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
argument_list|)
argument_list|)
operator|-
name|p_FmPort
operator|->
name|fmMuramPhysBaseAddr
operator|+
literal|0x20
argument_list|)
argument_list|)
expr_stmt|;
name|LOG2
argument_list|(
operator|(
name|uint64_t
operator|)
name|p_FmPort
operator|->
name|im
operator|.
name|mrblr
argument_list|,
name|log2Num
argument_list|)
expr_stmt|;
name|WRITE_UINT16
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
operator|->
name|mrblr
argument_list|,
name|log2Num
argument_list|)
expr_stmt|;
comment|/* Initialize Rx QD */
name|tmpPhysBase
operator|=
call|(
name|uint64_t
call|)
argument_list|(
name|XX_VirtToPhys
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_BdRing
argument_list|)
argument_list|)
expr_stmt|;
name|SET_ADDR
argument_list|(
operator|&
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
operator|->
name|rxQd
operator|.
name|bdRingBase
argument_list|,
name|tmpPhysBase
argument_list|)
expr_stmt|;
name|WRITE_UINT16
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
operator|->
name|rxQd
operator|.
name|bdRingSize
argument_list|,
call|(
name|uint16_t
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|t_FmImBd
argument_list|)
operator|*
name|p_FmPort
operator|->
name|im
operator|.
name|bdRingSize
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Update the IM PRAM address in the BMI */
name|WRITE_UINT32
argument_list|(
name|p_FmPort
operator|->
name|p_FmPortBmiRegs
operator|->
name|rxPortBmiRegs
operator|.
name|fmbm_rfqid
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
call|(
name|uint64_t
call|)
argument_list|(
name|XX_VirtToPhys
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
argument_list|)
argument_list|)
operator|-
name|p_FmPort
operator|->
name|fmMuramPhysBaseAddr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_FmPort
operator|->
name|polling
operator|||
name|p_FmPort
operator|->
name|exceptions
condition|)
block|{
comment|/* Allocate, configure and register interrupts */
name|err
operator|=
name|FmAllocFmanCtrlEventReg
argument_list|(
name|p_FmPort
operator|->
name|h_Fm
argument_list|,
operator|&
name|p_FmPort
operator|->
name|fmanCtrlEventId
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
operator|!
operator|(
name|p_FmPort
operator|->
name|fmanCtrlEventId
operator|&
operator|~
name|IM_RXQD_FPMEVT_SEL_MASK
operator|)
argument_list|)
expr_stmt|;
name|tmpReg16
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|p_FmPort
operator|->
name|fmanCtrlEventId
operator|&
name|IM_RXQD_FPMEVT_SEL_MASK
argument_list|)
expr_stmt|;
name|tmpReg32
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|p_FmPort
operator|->
name|exceptions
operator|&
name|IM_EV_BSY
condition|)
block|{
name|tmpReg16
operator||=
name|IM_RXQD_BSYINTM
expr_stmt|;
name|tmpReg32
operator||=
name|IM_EV_BSY
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|p_FmPort
operator|->
name|polling
condition|)
block|{
name|tmpReg16
operator||=
name|IM_RXQD_RXFINTM
expr_stmt|;
name|tmpReg32
operator||=
name|IM_EV_RX
expr_stmt|;
block|}
name|WRITE_UINT16
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
operator|->
name|rxQd
operator|.
name|gen
argument_list|,
name|tmpReg16
argument_list|)
expr_stmt|;
name|FmRegisterFmanCtrlIntr
argument_list|(
name|p_FmPort
operator|->
name|h_Fm
argument_list|,
name|p_FmPort
operator|->
name|fmanCtrlEventId
argument_list|,
name|ImException
argument_list|,
operator|(
name|t_Handle
operator|)
name|p_FmPort
argument_list|)
expr_stmt|;
name|FmSetFmanCtrlIntr
argument_list|(
name|p_FmPort
operator|->
name|h_Fm
argument_list|,
name|p_FmPort
operator|->
name|fmanCtrlEventId
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
block|}
else|else
name|p_FmPort
operator|->
name|fmanCtrlEventId
operator|=
operator|(
name|uint8_t
operator|)
name|NO_IRQ
expr_stmt|;
block|}
else|else
block|{
name|p_FmPort
operator|->
name|im
operator|.
name|p_BdRing
operator|=
operator|(
name|t_FmImBd
operator|*
operator|)
name|XX_MallocSmart
argument_list|(
call|(
name|uint32_t
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|t_FmImBd
argument_list|)
operator|*
name|p_FmPort
operator|->
name|im
operator|.
name|bdRingSize
argument_list|)
argument_list|,
name|p_FmPort
operator|->
name|im
operator|.
name|fwExtStructsMemId
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_FmPort
operator|->
name|im
operator|.
name|p_BdRing
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"Independent-Mode Tx BD ring!!!"
operator|)
argument_list|)
expr_stmt|;
name|IOMemSet32
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_BdRing
argument_list|,
literal|0
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|t_FmImBd
argument_list|)
operator|*
name|p_FmPort
operator|->
name|im
operator|.
name|bdRingSize
argument_list|)
argument_list|)
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|p_BdShadow
operator|=
operator|(
name|t_Handle
operator|*
operator|)
name|XX_Malloc
argument_list|(
call|(
name|uint32_t
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|t_Handle
argument_list|)
operator|*
name|p_FmPort
operator|->
name|im
operator|.
name|bdRingSize
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_FmPort
operator|->
name|im
operator|.
name|p_BdShadow
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"Independent-Mode Rx BD shadow!!!"
operator|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_BdShadow
argument_list|,
literal|0
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|t_Handle
argument_list|)
operator|*
name|p_FmPort
operator|->
name|im
operator|.
name|bdRingSize
argument_list|)
argument_list|)
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|firstBdOfFrameId
operator|=
name|IM_ILEGAL_BD_ID
expr_stmt|;
if|if
condition|(
operator|(
name|p_FmPort
operator|->
name|im
operator|.
name|dataMemAttributes
operator|&
name|MEMORY_ATTR_CACHEABLE
operator|)
operator|||
operator|(
name|p_FmPort
operator|->
name|im
operator|.
name|fwExtStructsMemAttr
operator|&
name|MEMORY_ATTR_CACHEABLE
operator|)
condition|)
name|WRITE_UINT32
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
operator|->
name|mode
argument_list|,
name|IM_MODE_GBL
operator||
name|IM_MODE_SET_BO
argument_list|(
literal|2
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|WRITE_UINT32
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
operator|->
name|mode
argument_list|,
name|IM_MODE_SET_BO
argument_list|(
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
operator|->
name|txQdPtr
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
call|(
name|uint64_t
call|)
argument_list|(
name|XX_VirtToPhys
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
argument_list|)
argument_list|)
operator|-
name|p_FmPort
operator|->
name|fmMuramPhysBaseAddr
operator|+
literal|0x40
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Initialize Tx QD */
name|tmpPhysBase
operator|=
call|(
name|uint64_t
call|)
argument_list|(
name|XX_VirtToPhys
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_BdRing
argument_list|)
argument_list|)
expr_stmt|;
name|SET_ADDR
argument_list|(
operator|&
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
operator|->
name|txQd
operator|.
name|bdRingBase
argument_list|,
name|tmpPhysBase
argument_list|)
expr_stmt|;
name|WRITE_UINT16
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
operator|->
name|txQd
operator|.
name|bdRingSize
argument_list|,
call|(
name|uint16_t
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|t_FmImBd
argument_list|)
operator|*
name|p_FmPort
operator|->
name|im
operator|.
name|bdRingSize
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Update the IM PRAM address in the BMI */
name|WRITE_UINT32
argument_list|(
name|p_FmPort
operator|->
name|p_FmPortBmiRegs
operator|->
name|txPortBmiRegs
operator|.
name|fmbm_tcfqid
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
call|(
name|uint64_t
call|)
argument_list|(
name|XX_VirtToPhys
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
argument_list|)
argument_list|)
operator|-
name|p_FmPort
operator|->
name|fmMuramPhysBaseAddr
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|void
name|FmPortImFree
parameter_list|(
name|t_FmPort
modifier|*
name|p_FmPort
parameter_list|)
block|{
name|uint32_t
name|bdStatus
decl_stmt|;
name|uint8_t
modifier|*
name|p_CurData
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_FmPort
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_FmPort
operator|->
name|portType
operator|==
name|e_FM_PORT_TYPE_RX
operator|)
operator|||
operator|(
name|p_FmPort
operator|->
name|portType
operator|==
name|e_FM_PORT_TYPE_RX_10G
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|p_FmPort
operator|->
name|polling
operator|||
name|p_FmPort
operator|->
name|exceptions
condition|)
block|{
comment|/* Deallocate and unregister interrupts */
name|FmSetFmanCtrlIntr
argument_list|(
name|p_FmPort
operator|->
name|h_Fm
argument_list|,
name|p_FmPort
operator|->
name|fmanCtrlEventId
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|FmFreeFmanCtrlEventReg
argument_list|(
name|p_FmPort
operator|->
name|h_Fm
argument_list|,
name|p_FmPort
operator|->
name|fmanCtrlEventId
argument_list|)
expr_stmt|;
name|WRITE_UINT16
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
operator|->
name|rxQd
operator|.
name|gen
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|FmUnregisterFmanCtrlIntr
argument_list|(
name|p_FmPort
operator|->
name|h_Fm
argument_list|,
name|p_FmPort
operator|->
name|fmanCtrlEventId
argument_list|)
expr_stmt|;
block|}
comment|/* Try first clean what has received */
name|FmPortImRx
argument_list|(
name|p_FmPort
argument_list|)
expr_stmt|;
comment|/* Now, get rid of the the empty buffer! */
name|bdStatus
operator|=
name|BD_STATUS_AND_LENGTH
argument_list|(
name|BD_GET
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|bdStatus
operator|&
name|BD_R_E
condition|)
comment|/* while there is data in the Rx BD */
block|{
name|p_CurData
operator|=
name|BdBufferGet
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|rxPool
operator|.
name|f_PhysToVirt
argument_list|,
name|BD_GET
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
argument_list|)
argument_list|)
expr_stmt|;
name|BdBufferSet
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|rxPool
operator|.
name|f_VirtToPhys
argument_list|,
name|BD_GET
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|BD_STATUS_AND_LENGTH_SET
argument_list|(
name|BD_GET
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|rxPool
operator|.
name|f_PutBuf
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|rxPool
operator|.
name|h_BufferPool
argument_list|,
name|p_CurData
argument_list|,
name|p_FmPort
operator|->
name|im
operator|.
name|p_BdShadow
index|[
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
index|]
argument_list|)
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
operator|=
name|GetNextBdId
argument_list|(
name|p_FmPort
argument_list|,
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
argument_list|)
expr_stmt|;
name|bdStatus
operator|=
name|BD_STATUS_AND_LENGTH
argument_list|(
name|BD_GET
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|TxConf
argument_list|(
name|p_FmPort
argument_list|,
name|e_TX_CONF_TYPE_FLUSH
argument_list|)
expr_stmt|;
name|FM_MURAM_FreeMem
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|h_FmMuram
argument_list|,
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_BdShadow
condition|)
name|XX_Free
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_BdShadow
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_BdRing
condition|)
name|XX_FreeSmart
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_BdRing
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|t_Error
name|FM_PORT_ConfigIMMaxRxBufLength
parameter_list|(
name|t_Handle
name|h_FmPort
parameter_list|,
name|uint16_t
name|newVal
parameter_list|)
block|{
name|t_FmPort
modifier|*
name|p_FmPort
init|=
operator|(
name|t_FmPort
operator|*
operator|)
name|h_FmPort
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPort
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPort
operator|->
name|imEn
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPort
operator|->
name|p_FmPortDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|mrblr
operator|=
name|newVal
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_PORT_ConfigIMRxBdRingLength
parameter_list|(
name|t_Handle
name|h_FmPort
parameter_list|,
name|uint16_t
name|newVal
parameter_list|)
block|{
name|t_FmPort
modifier|*
name|p_FmPort
init|=
operator|(
name|t_FmPort
operator|*
operator|)
name|h_FmPort
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPort
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPort
operator|->
name|imEn
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPort
operator|->
name|p_FmPortDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|bdRingSize
operator|=
name|newVal
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_PORT_ConfigIMTxBdRingLength
parameter_list|(
name|t_Handle
name|h_FmPort
parameter_list|,
name|uint16_t
name|newVal
parameter_list|)
block|{
name|t_FmPort
modifier|*
name|p_FmPort
init|=
operator|(
name|t_FmPort
operator|*
operator|)
name|h_FmPort
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPort
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPort
operator|->
name|imEn
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPort
operator|->
name|p_FmPortDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|bdRingSize
operator|=
name|newVal
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_PORT_ConfigIMFmanCtrlExternalStructsMemory
parameter_list|(
name|t_Handle
name|h_FmPort
parameter_list|,
name|uint8_t
name|memId
parameter_list|,
name|uint32_t
name|memAttributes
parameter_list|)
block|{
name|t_FmPort
modifier|*
name|p_FmPort
init|=
operator|(
name|t_FmPort
operator|*
operator|)
name|h_FmPort
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPort
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPort
operator|->
name|imEn
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPort
operator|->
name|p_FmPortDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|fwExtStructsMemId
operator|=
name|memId
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|fwExtStructsMemAttr
operator|=
name|memAttributes
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_PORT_ConfigIMPolling
parameter_list|(
name|t_Handle
name|h_FmPort
parameter_list|)
block|{
name|t_FmPort
modifier|*
name|p_FmPort
init|=
operator|(
name|t_FmPort
operator|*
operator|)
name|h_FmPort
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPort
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPort
operator|->
name|imEn
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPort
operator|->
name|p_FmPortDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_FmPort
operator|->
name|portType
operator|!=
name|e_FM_PORT_TYPE_RX_10G
operator|)
operator|&&
operator|(
name|p_FmPort
operator|->
name|portType
operator|!=
name|e_FM_PORT_TYPE_RX
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_OPERATION
argument_list|,
operator|(
literal|"Available for Rx ports only"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|FmIsMaster
argument_list|(
name|p_FmPort
operator|->
name|h_Fm
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_OPERATION
argument_list|,
operator|(
literal|"Available on master-partition only;"
literal|"in guest-partitions, IM is always in polling!"
operator|)
argument_list|)
expr_stmt|;
name|p_FmPort
operator|->
name|polling
operator|=
name|TRUE
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_PORT_SetIMExceptions
parameter_list|(
name|t_Handle
name|h_FmPort
parameter_list|,
name|e_FmPortExceptions
name|exception
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_FmPort
modifier|*
name|p_FmPort
init|=
operator|(
name|t_FmPort
operator|*
operator|)
name|h_FmPort
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|uint16_t
name|tmpReg16
decl_stmt|;
name|uint32_t
name|tmpReg32
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPort
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPort
operator|->
name|imEn
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_FmPort
operator|->
name|p_FmPortDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|exception
operator|==
name|e_FM_PORT_EXCEPTION_IM_BUSY
condition|)
block|{
if|if
condition|(
name|enable
condition|)
block|{
name|p_FmPort
operator|->
name|exceptions
operator||=
name|IM_EV_BSY
expr_stmt|;
if|if
condition|(
name|p_FmPort
operator|->
name|fmanCtrlEventId
operator|==
operator|(
name|uint8_t
operator|)
name|NO_IRQ
condition|)
block|{
comment|/* Allocate, configure and register interrupts */
name|err
operator|=
name|FmAllocFmanCtrlEventReg
argument_list|(
name|p_FmPort
operator|->
name|h_Fm
argument_list|,
operator|&
name|p_FmPort
operator|->
name|fmanCtrlEventId
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
operator|!
operator|(
name|p_FmPort
operator|->
name|fmanCtrlEventId
operator|&
operator|~
name|IM_RXQD_FPMEVT_SEL_MASK
operator|)
argument_list|)
expr_stmt|;
name|FmRegisterFmanCtrlIntr
argument_list|(
name|p_FmPort
operator|->
name|h_Fm
argument_list|,
name|p_FmPort
operator|->
name|fmanCtrlEventId
argument_list|,
name|ImException
argument_list|,
operator|(
name|t_Handle
operator|)
name|p_FmPort
argument_list|)
expr_stmt|;
name|tmpReg16
operator|=
call|(
name|uint16_t
call|)
argument_list|(
operator|(
name|p_FmPort
operator|->
name|fmanCtrlEventId
operator|&
name|IM_RXQD_FPMEVT_SEL_MASK
operator|)
operator||
name|IM_RXQD_BSYINTM
argument_list|)
expr_stmt|;
name|tmpReg32
operator|=
name|IM_EV_BSY
expr_stmt|;
block|}
else|else
block|{
name|tmpReg16
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|GET_UINT16
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
operator|->
name|rxQd
operator|.
name|gen
argument_list|)
operator||
name|IM_RXQD_BSYINTM
argument_list|)
expr_stmt|;
name|tmpReg32
operator|=
name|FmGetFmanCtrlIntr
argument_list|(
name|p_FmPort
operator|->
name|h_Fm
argument_list|,
name|p_FmPort
operator|->
name|fmanCtrlEventId
argument_list|)
operator||
name|IM_EV_BSY
expr_stmt|;
block|}
name|WRITE_UINT16
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
operator|->
name|rxQd
operator|.
name|gen
argument_list|,
name|tmpReg16
argument_list|)
expr_stmt|;
name|FmSetFmanCtrlIntr
argument_list|(
name|p_FmPort
operator|->
name|h_Fm
argument_list|,
name|p_FmPort
operator|->
name|fmanCtrlEventId
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|p_FmPort
operator|->
name|exceptions
operator|&=
operator|~
name|IM_EV_BSY
expr_stmt|;
if|if
condition|(
operator|!
name|p_FmPort
operator|->
name|exceptions
operator|&&
name|p_FmPort
operator|->
name|polling
condition|)
block|{
name|FmFreeFmanCtrlEventReg
argument_list|(
name|p_FmPort
operator|->
name|h_Fm
argument_list|,
name|p_FmPort
operator|->
name|fmanCtrlEventId
argument_list|)
expr_stmt|;
name|FmUnregisterFmanCtrlIntr
argument_list|(
name|p_FmPort
operator|->
name|h_Fm
argument_list|,
name|p_FmPort
operator|->
name|fmanCtrlEventId
argument_list|)
expr_stmt|;
name|FmSetFmanCtrlIntr
argument_list|(
name|p_FmPort
operator|->
name|h_Fm
argument_list|,
name|p_FmPort
operator|->
name|fmanCtrlEventId
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WRITE_UINT16
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
operator|->
name|rxQd
operator|.
name|gen
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|p_FmPort
operator|->
name|fmanCtrlEventId
operator|=
operator|(
name|uint8_t
operator|)
name|NO_IRQ
expr_stmt|;
block|}
else|else
block|{
name|tmpReg16
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|GET_UINT16
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
operator|->
name|rxQd
operator|.
name|gen
argument_list|)
operator|&
operator|~
name|IM_RXQD_BSYINTM
argument_list|)
expr_stmt|;
name|WRITE_UINT16
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
operator|->
name|rxQd
operator|.
name|gen
argument_list|,
name|tmpReg16
argument_list|)
expr_stmt|;
name|tmpReg32
operator|=
name|FmGetFmanCtrlIntr
argument_list|(
name|p_FmPort
operator|->
name|h_Fm
argument_list|,
name|p_FmPort
operator|->
name|fmanCtrlEventId
argument_list|)
operator|&
operator|~
name|IM_EV_BSY
expr_stmt|;
name|FmSetFmanCtrlIntr
argument_list|(
name|p_FmPort
operator|->
name|h_Fm
argument_list|,
name|p_FmPort
operator|->
name|fmanCtrlEventId
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
operator|(
literal|"Invalid exception."
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_PORT_ImTx
parameter_list|(
name|t_Handle
name|h_FmPort
parameter_list|,
name|uint8_t
modifier|*
name|p_Data
parameter_list|,
name|uint16_t
name|length
parameter_list|,
name|bool
name|lastBuffer
parameter_list|,
name|t_Handle
name|h_BufContext
parameter_list|)
block|{
name|t_FmPort
modifier|*
name|p_FmPort
init|=
operator|(
name|t_FmPort
operator|*
operator|)
name|h_FmPort
decl_stmt|;
name|uint16_t
name|nextBdId
decl_stmt|;
name|uint32_t
name|bdStatus
decl_stmt|,
name|nextBdStatus
decl_stmt|;
name|bool
name|firstBuffer
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPort
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPort
operator|->
name|imEn
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_FmPort
operator|->
name|p_FmPortDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|bdStatus
operator|=
name|BD_STATUS_AND_LENGTH
argument_list|(
name|BD_GET
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
argument_list|)
argument_list|)
expr_stmt|;
name|nextBdId
operator|=
name|GetNextBdId
argument_list|(
name|p_FmPort
argument_list|,
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
argument_list|)
expr_stmt|;
name|nextBdStatus
operator|=
name|BD_STATUS_AND_LENGTH
argument_list|(
name|BD_GET
argument_list|(
name|nextBdId
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|bdStatus
operator|&
name|BD_R_E
operator|)
operator|&&
operator|!
operator|(
name|nextBdStatus
operator|&
name|BD_R_E
operator|)
condition|)
block|{
comment|/* Confirm the current BD - BD is available */
if|if
condition|(
operator|(
name|bdStatus
operator|&
name|BD_LENGTH_MASK
operator|)
operator|&&
operator|(
name|p_FmPort
operator|->
name|im
operator|.
name|f_TxConf
operator|)
condition|)
name|p_FmPort
operator|->
name|im
operator|.
name|f_TxConf
argument_list|(
name|p_FmPort
operator|->
name|h_App
argument_list|,
name|BdBufferGet
argument_list|(
name|XX_PhysToVirt
argument_list|,
name|BD_GET
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
argument_list|)
argument_list|)
argument_list|,
literal|0
argument_list|,
name|p_FmPort
operator|->
name|im
operator|.
name|p_BdShadow
index|[
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
index|]
argument_list|)
expr_stmt|;
name|bdStatus
operator|=
name|length
expr_stmt|;
comment|/* if this is the first BD of a frame */
if|if
condition|(
name|p_FmPort
operator|->
name|im
operator|.
name|firstBdOfFrameId
operator|==
name|IM_ILEGAL_BD_ID
condition|)
block|{
name|firstBuffer
operator|=
name|TRUE
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|txFirstBdStatus
operator|=
operator|(
name|bdStatus
operator||
name|BD_R_E
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|lastBuffer
condition|)
name|p_FmPort
operator|->
name|im
operator|.
name|firstBdOfFrameId
operator|=
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
expr_stmt|;
block|}
else|else
name|firstBuffer
operator|=
name|FALSE
expr_stmt|;
name|BdBufferSet
argument_list|(
name|XX_VirtToPhys
argument_list|,
name|BD_GET
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
argument_list|)
argument_list|,
name|p_Data
argument_list|)
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|p_BdShadow
index|[
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
index|]
operator|=
name|h_BufContext
expr_stmt|;
comment|/* deal with last */
if|if
condition|(
name|lastBuffer
condition|)
block|{
comment|/* if single buffer frame */
if|if
condition|(
name|firstBuffer
condition|)
name|BD_STATUS_AND_LENGTH_SET
argument_list|(
name|BD_GET
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
argument_list|)
argument_list|,
name|p_FmPort
operator|->
name|im
operator|.
name|txFirstBdStatus
operator||
name|BD_L
argument_list|)
expr_stmt|;
else|else
block|{
comment|/* Set the last BD of the frame */
name|BD_STATUS_AND_LENGTH_SET
argument_list|(
name|BD_GET
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
argument_list|)
argument_list|,
operator|(
name|bdStatus
operator||
name|BD_R_E
operator||
name|BD_L
operator|)
argument_list|)
expr_stmt|;
comment|/* Set the first BD of the frame */
name|BD_STATUS_AND_LENGTH_SET
argument_list|(
name|BD_GET
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|firstBdOfFrameId
argument_list|)
argument_list|,
name|p_FmPort
operator|->
name|im
operator|.
name|txFirstBdStatus
argument_list|)
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|firstBdOfFrameId
operator|=
name|IM_ILEGAL_BD_ID
expr_stmt|;
block|}
name|WRITE_UINT16
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|p_FmPortImPram
operator|->
name|txQd
operator|.
name|offsetIn
argument_list|,
call|(
name|uint16_t
call|)
argument_list|(
name|GetNextBdId
argument_list|(
name|p_FmPort
argument_list|,
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
argument_list|)
operator|<<
literal|4
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|firstBuffer
condition|)
comment|/* mid frame buffer */
name|BD_STATUS_AND_LENGTH_SET
argument_list|(
name|BD_GET
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
argument_list|)
argument_list|,
name|bdStatus
operator||
name|BD_R_E
argument_list|)
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
operator|=
name|GetNextBdId
argument_list|(
name|p_FmPort
argument_list|,
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Discard current frame. Return error.   */
if|if
condition|(
name|p_FmPort
operator|->
name|im
operator|.
name|firstBdOfFrameId
operator|!=
name|IM_ILEGAL_BD_ID
condition|)
block|{
comment|/* Error:    No free BD */
comment|/* Response: Discard current frame. Return error.   */
name|uint16_t
name|cleanBdId
init|=
name|p_FmPort
operator|->
name|im
operator|.
name|firstBdOfFrameId
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_FmPort
operator|->
name|im
operator|.
name|firstBdOfFrameId
operator|!=
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
argument_list|)
expr_stmt|;
comment|/* Since firstInFrame is not NULL, one buffer at least has already been                inserted into the BD ring. Using do-while covers the situation of a                frame spanned throughout the whole Tx BD ring (p_CleanBd is incremented                prior to testing whether or not it's equal to TxBd). */
do|do
block|{
name|BD_STATUS_AND_LENGTH_SET
argument_list|(
name|BD_GET
argument_list|(
name|cleanBdId
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Advance BD pointer */
name|cleanBdId
operator|=
name|GetNextBdId
argument_list|(
name|p_FmPort
argument_list|,
name|cleanBdId
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|cleanBdId
operator|!=
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
condition|)
do|;
name|p_FmPort
operator|->
name|im
operator|.
name|currBdId
operator|=
name|cleanBdId
expr_stmt|;
name|p_FmPort
operator|->
name|im
operator|.
name|firstBdOfFrameId
operator|=
name|IM_ILEGAL_BD_ID
expr_stmt|;
block|}
return|return
name|ERROR_CODE
argument_list|(
name|E_FULL
argument_list|)
return|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|void
name|FM_PORT_ImTxConf
parameter_list|(
name|t_Handle
name|h_FmPort
parameter_list|)
block|{
name|t_FmPort
modifier|*
name|p_FmPort
init|=
operator|(
name|t_FmPort
operator|*
operator|)
name|h_FmPort
decl_stmt|;
name|SANITY_CHECK_RETURN
argument_list|(
name|p_FmPort
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN
argument_list|(
name|p_FmPort
operator|->
name|imEn
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN
argument_list|(
operator|!
name|p_FmPort
operator|->
name|p_FmPortDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|TxConf
argument_list|(
name|p_FmPort
argument_list|,
name|e_TX_CONF_TYPE_CALLBACK
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|t_Error
name|FM_PORT_ImRx
parameter_list|(
name|t_Handle
name|h_FmPort
parameter_list|)
block|{
name|t_FmPort
modifier|*
name|p_FmPort
init|=
operator|(
name|t_FmPort
operator|*
operator|)
name|h_FmPort
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPort
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPort
operator|->
name|imEn
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_FmPort
operator|->
name|p_FmPortDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
return|return
name|FmPortImRx
argument_list|(
name|p_FmPort
argument_list|)
return|;
block|}
end_function

end_unit


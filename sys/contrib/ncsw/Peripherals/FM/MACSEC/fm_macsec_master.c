begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2008-2015 Freescale Semiconductor Inc.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are met:  *     * Redistributions of source code must retain the above copyright  *       notice, this list of conditions and the following disclaimer.  *     * Redistributions in binary form must reproduce the above copyright  *       notice, this list of conditions and the following disclaimer in the  *       documentation and/or other materials provided with the distribution.  *     * Neither the name of Freescale Semiconductor nor the  *       names of its contributors may be used to endorse or promote products  *       derived from this software without specific prior written permission.  *  *  * ALTERNATIVELY, this software may be distributed under the terms of the  * GNU General Public License ("GPL") as published by the Free Software  * Foundation, either version 2 of that License or (at your option) any  * later version.  *  * THIS SOFTWARE IS PROVIDED BY Freescale Semiconductor ``AS IS'' AND ANY  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED. IN NO EVENT SHALL Freescale Semiconductor BE LIABLE FOR ANY  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/******************************************************************************  @File          fm_macsec.c   @Description   FM MACSEC driver routines implementation. */
end_comment

begin_comment
comment|/***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|"std_ext.h"
end_include

begin_include
include|#
directive|include
file|"error_ext.h"
end_include

begin_include
include|#
directive|include
file|"xx_ext.h"
end_include

begin_include
include|#
directive|include
file|"string_ext.h"
end_include

begin_include
include|#
directive|include
file|"sprint_ext.h"
end_include

begin_include
include|#
directive|include
file|"fm_mac_ext.h"
end_include

begin_include
include|#
directive|include
file|"fm_macsec_master.h"
end_include

begin_function_decl
specifier|extern
name|uint16_t
name|FM_MAC_GetMaxFrameLength
parameter_list|(
name|t_Handle
name|FmMac
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/****************************************/
end_comment

begin_comment
comment|/*       static functions               */
end_comment

begin_comment
comment|/****************************************/
end_comment

begin_function
specifier|static
name|t_Error
name|CheckFmMacsecParameters
parameter_list|(
name|t_FmMacsec
modifier|*
name|p_FmMacsec
parameter_list|)
block|{
if|if
condition|(
operator|!
name|p_FmMacsec
operator|->
name|f_Exception
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Exceptions callback not provided"
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|UnimplementedIsr
parameter_list|(
name|t_Handle
name|h_Arg
parameter_list|,
name|uint32_t
name|id
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|h_Arg
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|id
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"Unimplemented Isr!"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|MacsecEventIsr
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|uint32_t
name|events
decl_stmt|,
name|event
decl_stmt|,
name|i
decl_stmt|;
name|SANITY_CHECK_RETURN
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|events
operator|=
name|GET_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|evr
argument_list|)
expr_stmt|;
name|events
operator||=
name|GET_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|ever
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|evr
argument_list|,
name|events
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_OF_TX_SC
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|events
operator|&
name|FM_MACSEC_EV_TX_SC_NEXT_PN
argument_list|(
name|i
argument_list|)
condition|)
block|{
name|GET_MACSEC_MODULE_EVENT
argument_list|(
name|e_FM_MACSEC_MOD_SC_TX
argument_list|,
name|i
argument_list|,
name|e_FM_INTR_TYPE_NORMAL
argument_list|,
name|event
argument_list|)
expr_stmt|;
name|p_FmMacsec
operator|->
name|intrMng
index|[
name|event
index|]
operator|.
name|f_Isr
argument_list|(
name|p_FmMacsec
operator|->
name|intrMng
index|[
name|event
index|]
operator|.
name|h_SrcHandle
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|MacsecErrorIsr
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|uint32_t
name|errors
decl_stmt|,
name|error
decl_stmt|,
name|i
decl_stmt|;
name|SANITY_CHECK_RETURN
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|errors
operator|=
name|GET_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|err
argument_list|)
expr_stmt|;
name|errors
operator||=
name|GET_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|erer
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|err
argument_list|,
name|errors
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_OF_TX_SC
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|errors
operator|&
name|FM_MACSEC_EX_TX_SC
argument_list|(
name|i
argument_list|)
condition|)
block|{
name|GET_MACSEC_MODULE_EVENT
argument_list|(
name|e_FM_MACSEC_MOD_SC_TX
argument_list|,
name|i
argument_list|,
name|e_FM_INTR_TYPE_ERR
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|p_FmMacsec
operator|->
name|intrMng
index|[
name|error
index|]
operator|.
name|f_Isr
argument_list|(
name|p_FmMacsec
operator|->
name|intrMng
index|[
name|error
index|]
operator|.
name|h_SrcHandle
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|errors
operator|&
name|FM_MACSEC_EX_ECC
condition|)
block|{
name|uint8_t
name|eccType
decl_stmt|;
name|uint32_t
name|tmpReg
decl_stmt|;
name|tmpReg
operator|=
name|GET_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|meec
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|tmpReg
operator|&
name|MECC_CAP
argument_list|)
expr_stmt|;
name|eccType
operator|=
call|(
name|uint8_t
call|)
argument_list|(
operator|(
name|tmpReg
operator|&
name|MECC_CET
operator|)
operator|>>
name|MECC_CET_SHIFT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|eccType
operator|&&
operator|(
name|p_FmMacsec
operator|->
name|userExceptions
operator|&
name|FM_MACSEC_USER_EX_SINGLE_BIT_ECC
operator|)
condition|)
name|p_FmMacsec
operator|->
name|f_Exception
argument_list|(
name|p_FmMacsec
operator|->
name|h_App
argument_list|,
name|e_FM_MACSEC_EX_SINGLE_BIT_ECC
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|eccType
operator|&&
operator|(
name|p_FmMacsec
operator|->
name|userExceptions
operator|&
name|FM_MACSEC_USER_EX_MULTI_BIT_ECC
operator|)
condition|)
name|p_FmMacsec
operator|->
name|f_Exception
argument_list|(
name|p_FmMacsec
operator|->
name|h_App
argument_list|,
name|e_FM_MACSEC_EX_MULTI_BIT_ECC
argument_list|)
expr_stmt|;
else|else
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|meec
argument_list|,
name|tmpReg
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|t_Error
name|MacsecInit
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|t_FmMacsecDriverParam
modifier|*
name|p_FmMacsecDriverParam
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|tmpReg
decl_stmt|,
name|i
decl_stmt|,
name|macId
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|CHECK_INIT_PARAMETERS
argument_list|(
name|p_FmMacsec
argument_list|,
name|CheckFmMacsecParameters
argument_list|)
expr_stmt|;
name|p_FmMacsecDriverParam
operator|=
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|e_FM_MACSEC_EV_DUMMY_LAST
condition|;
name|i
operator|++
control|)
name|p_FmMacsec
operator|->
name|intrMng
index|[
name|i
index|]
operator|.
name|f_Isr
operator|=
name|UnimplementedIsr
expr_stmt|;
name|tmpReg
operator|=
literal|0
expr_stmt|;
name|tmpReg
operator||=
operator|(
name|p_FmMacsecDriverParam
operator|->
name|changedTextWithNoEncryptDeliverUncontrolled
operator|<<
name|CFG_UECT_SHIFT
operator|)
operator||
operator|(
name|p_FmMacsecDriverParam
operator|->
name|onlyScbIsSetDeliverUncontrolled
operator|<<
name|CFG_ESCBT_SHIFT
operator|)
operator||
operator|(
name|p_FmMacsecDriverParam
operator|->
name|unknownSciTreatMode
operator|<<
name|CFG_USFT_SHIFT
operator|)
operator||
operator|(
name|p_FmMacsecDriverParam
operator|->
name|invalidTagsDeliverUncontrolled
operator|<<
name|CFG_ITT_SHIFT
operator|)
operator||
operator|(
name|p_FmMacsecDriverParam
operator|->
name|encryptWithNoChangedTextDiscardUncontrolled
operator|<<
name|CFG_KFT_SHIFT
operator|)
operator||
operator|(
name|p_FmMacsecDriverParam
operator|->
name|untagTreatMode
operator|<<
name|CFG_UFT_SHIFT
operator|)
operator||
operator|(
name|p_FmMacsecDriverParam
operator|->
name|keysUnreadable
operator|<<
name|CFG_KSS_SHIFT
operator|)
operator||
operator|(
name|p_FmMacsecDriverParam
operator|->
name|reservedSc0
operator|<<
name|CFG_S0I_SHIFT
operator|)
operator||
operator|(
name|p_FmMacsecDriverParam
operator|->
name|byPassMode
operator|<<
name|CFG_BYPN_SHIFT
operator|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|cfg
argument_list|,
name|tmpReg
argument_list|)
expr_stmt|;
name|tmpReg
operator|=
name|FM_MAC_GetMaxFrameLength
argument_list|(
name|p_FmMacsec
operator|->
name|h_FmMac
argument_list|)
expr_stmt|;
comment|/* At least Ethernet FCS (4 bytes) overhead must be subtracted from MFL.      * In addition, the SCI (8 bytes) overhead might be subtracted as well. */
name|tmpReg
operator|-=
name|p_FmMacsecDriverParam
operator|->
name|mflSubtract
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|mfl
argument_list|,
name|tmpReg
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|tpnet
argument_list|,
name|p_FmMacsecDriverParam
operator|->
name|pnExhThr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_FmMacsec
operator|->
name|userExceptions
condition|)
name|p_FmMacsec
operator|->
name|exceptions
operator|&=
operator|~
name|FM_MACSEC_EX_ECC
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|erer
argument_list|,
name|p_FmMacsec
operator|->
name|exceptions
argument_list|)
expr_stmt|;
name|p_FmMacsec
operator|->
name|numRxScAvailable
operator|=
name|NUM_OF_RX_SC
expr_stmt|;
if|if
condition|(
name|p_FmMacsecDriverParam
operator|->
name|reservedSc0
condition|)
name|p_FmMacsec
operator|->
name|numRxScAvailable
operator|--
expr_stmt|;
name|p_FmMacsec
operator|->
name|numTxScAvailable
operator|=
name|NUM_OF_TX_SC
expr_stmt|;
name|XX_Free
argument_list|(
name|p_FmMacsecDriverParam
argument_list|)
expr_stmt|;
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
operator|=
name|NULL
expr_stmt|;
name|FM_MAC_GetId
argument_list|(
name|p_FmMacsec
operator|->
name|h_FmMac
argument_list|,
operator|&
name|macId
argument_list|)
expr_stmt|;
name|FmRegisterIntr
argument_list|(
name|p_FmMacsec
operator|->
name|h_Fm
argument_list|,
name|e_FM_MOD_MACSEC
argument_list|,
operator|(
name|uint8_t
operator|)
name|macId
argument_list|,
name|e_FM_INTR_TYPE_NORMAL
argument_list|,
name|MacsecEventIsr
argument_list|,
name|p_FmMacsec
argument_list|)
expr_stmt|;
name|FmRegisterIntr
argument_list|(
name|p_FmMacsec
operator|->
name|h_Fm
argument_list|,
name|e_FM_MOD_MACSEC
argument_list|,
literal|0
argument_list|,
name|e_FM_INTR_TYPE_ERR
argument_list|,
name|MacsecErrorIsr
argument_list|,
name|p_FmMacsec
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|MacsecFree
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|uint32_t
name|macId
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|FM_MAC_GetId
argument_list|(
name|p_FmMacsec
operator|->
name|h_FmMac
argument_list|,
operator|&
name|macId
argument_list|)
expr_stmt|;
name|FmUnregisterIntr
argument_list|(
name|p_FmMacsec
operator|->
name|h_Fm
argument_list|,
name|e_FM_MOD_MACSEC
argument_list|,
operator|(
name|uint8_t
operator|)
name|macId
argument_list|,
name|e_FM_INTR_TYPE_NORMAL
argument_list|)
expr_stmt|;
name|FmUnregisterIntr
argument_list|(
name|p_FmMacsec
operator|->
name|h_Fm
argument_list|,
name|e_FM_MOD_MACSEC
argument_list|,
literal|0
argument_list|,
name|e_FM_INTR_TYPE_ERR
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_FmMacsec
operator|->
name|rxScSpinLock
condition|)
name|XX_FreeSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|rxScSpinLock
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_FmMacsec
operator|->
name|txScSpinLock
condition|)
name|XX_FreeSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|txScSpinLock
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_FmMacsec
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|MacsecConfigUnknownSciFrameTreatment
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|e_FmMacsecUnknownSciFrameTreatment
name|treatMode
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
operator|->
name|unknownSciTreatMode
operator|=
name|treatMode
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|MacsecConfigInvalidTagsFrameTreatment
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|bool
name|deliverUncontrolled
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
operator|->
name|invalidTagsDeliverUncontrolled
operator|=
name|deliverUncontrolled
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|MacsecConfigChangedTextWithNoEncryptFrameTreatment
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|bool
name|deliverUncontrolled
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
operator|->
name|changedTextWithNoEncryptDeliverUncontrolled
operator|=
name|deliverUncontrolled
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|MacsecConfigOnlyScbIsSetFrameTreatment
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|bool
name|deliverUncontrolled
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
operator|->
name|onlyScbIsSetDeliverUncontrolled
operator|=
name|deliverUncontrolled
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|MacsecConfigEncryptWithNoChangedTextFrameTreatment
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|bool
name|discardUncontrolled
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
operator|->
name|encryptWithNoChangedTextDiscardUncontrolled
operator|=
name|discardUncontrolled
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|MacsecConfigUntagFrameTreatment
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|e_FmMacsecUntagFrameTreatment
name|treatMode
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
operator|->
name|untagTreatMode
operator|=
name|treatMode
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|MacsecConfigPnExhaustionThreshold
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|uint32_t
name|pnExhThr
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
operator|->
name|pnExhThr
operator|=
name|pnExhThr
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|MacsecConfigKeysUnreadable
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
operator|->
name|keysUnreadable
operator|=
name|TRUE
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|MacsecConfigSectagWithoutSCI
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
operator|->
name|sectagOverhead
operator|-=
name|MACSEC_SCI_SIZE
expr_stmt|;
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
operator|->
name|mflSubtract
operator|+=
name|MACSEC_SCI_SIZE
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|MacsecConfigException
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|e_FmMacsecExceptions
name|exception
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|uint32_t
name|bitMask
init|=
literal|0
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|GET_USER_EXCEPTION_FLAG
argument_list|(
name|bitMask
argument_list|,
name|exception
argument_list|)
expr_stmt|;
if|if
condition|(
name|bitMask
condition|)
block|{
if|if
condition|(
name|enable
condition|)
name|p_FmMacsec
operator|->
name|userExceptions
operator||=
name|bitMask
expr_stmt|;
else|else
name|p_FmMacsec
operator|->
name|userExceptions
operator|&=
operator|~
name|bitMask
expr_stmt|;
block|}
else|else
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Undefined exception"
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|MacsecGetRevision
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|uint32_t
modifier|*
name|p_MacsecRevision
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
operator|*
name|p_MacsecRevision
operator|=
name|GET_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|ip_rev1
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|MacsecEnable
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|uint32_t
name|tmpReg
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|tmpReg
operator|=
name|GET_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|cfg
argument_list|)
expr_stmt|;
name|tmpReg
operator||=
name|CFG_BYPN
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|cfg
argument_list|,
name|tmpReg
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|MacsecDisable
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|uint32_t
name|tmpReg
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|tmpReg
operator|=
name|GET_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|cfg
argument_list|)
expr_stmt|;
name|tmpReg
operator|&=
operator|~
name|CFG_BYPN
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|cfg
argument_list|,
name|tmpReg
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|MacsecSetException
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|e_FmMacsecExceptions
name|exception
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|uint32_t
name|bitMask
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|GET_USER_EXCEPTION_FLAG
argument_list|(
name|bitMask
argument_list|,
name|exception
argument_list|)
expr_stmt|;
if|if
condition|(
name|bitMask
condition|)
block|{
if|if
condition|(
name|enable
condition|)
name|p_FmMacsec
operator|->
name|userExceptions
operator||=
name|bitMask
expr_stmt|;
else|else
name|p_FmMacsec
operator|->
name|userExceptions
operator|&=
operator|~
name|bitMask
expr_stmt|;
block|}
else|else
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Undefined exception"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_FmMacsec
operator|->
name|userExceptions
condition|)
name|p_FmMacsec
operator|->
name|exceptions
operator|&=
operator|~
name|FM_MACSEC_EX_ECC
expr_stmt|;
else|else
name|p_FmMacsec
operator|->
name|exceptions
operator||=
name|FM_MACSEC_EX_ECC
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|erer
argument_list|,
name|p_FmMacsec
operator|->
name|exceptions
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|InitFmMacsecControllerDriver
parameter_list|(
name|t_FmMacsecControllerDriver
modifier|*
name|p_FmMacsecControllerDriver
parameter_list|)
block|{
name|p_FmMacsecControllerDriver
operator|->
name|f_FM_MACSEC_Init
operator|=
name|MacsecInit
expr_stmt|;
name|p_FmMacsecControllerDriver
operator|->
name|f_FM_MACSEC_Free
operator|=
name|MacsecFree
expr_stmt|;
name|p_FmMacsecControllerDriver
operator|->
name|f_FM_MACSEC_ConfigUnknownSciFrameTreatment
operator|=
name|MacsecConfigUnknownSciFrameTreatment
expr_stmt|;
name|p_FmMacsecControllerDriver
operator|->
name|f_FM_MACSEC_ConfigInvalidTagsFrameTreatment
operator|=
name|MacsecConfigInvalidTagsFrameTreatment
expr_stmt|;
name|p_FmMacsecControllerDriver
operator|->
name|f_FM_MACSEC_ConfigEncryptWithNoChangedTextFrameTreatment
operator|=
name|MacsecConfigEncryptWithNoChangedTextFrameTreatment
expr_stmt|;
name|p_FmMacsecControllerDriver
operator|->
name|f_FM_MACSEC_ConfigUntagFrameTreatment
operator|=
name|MacsecConfigUntagFrameTreatment
expr_stmt|;
name|p_FmMacsecControllerDriver
operator|->
name|f_FM_MACSEC_ConfigChangedTextWithNoEncryptFrameTreatment
operator|=
name|MacsecConfigChangedTextWithNoEncryptFrameTreatment
expr_stmt|;
name|p_FmMacsecControllerDriver
operator|->
name|f_FM_MACSEC_ConfigOnlyScbIsSetFrameTreatment
operator|=
name|MacsecConfigOnlyScbIsSetFrameTreatment
expr_stmt|;
name|p_FmMacsecControllerDriver
operator|->
name|f_FM_MACSEC_ConfigPnExhaustionThreshold
operator|=
name|MacsecConfigPnExhaustionThreshold
expr_stmt|;
name|p_FmMacsecControllerDriver
operator|->
name|f_FM_MACSEC_ConfigKeysUnreadable
operator|=
name|MacsecConfigKeysUnreadable
expr_stmt|;
name|p_FmMacsecControllerDriver
operator|->
name|f_FM_MACSEC_ConfigSectagWithoutSCI
operator|=
name|MacsecConfigSectagWithoutSCI
expr_stmt|;
name|p_FmMacsecControllerDriver
operator|->
name|f_FM_MACSEC_ConfigException
operator|=
name|MacsecConfigException
expr_stmt|;
name|p_FmMacsecControllerDriver
operator|->
name|f_FM_MACSEC_GetRevision
operator|=
name|MacsecGetRevision
expr_stmt|;
name|p_FmMacsecControllerDriver
operator|->
name|f_FM_MACSEC_Enable
operator|=
name|MacsecEnable
expr_stmt|;
name|p_FmMacsecControllerDriver
operator|->
name|f_FM_MACSEC_Disable
operator|=
name|MacsecDisable
expr_stmt|;
name|p_FmMacsecControllerDriver
operator|->
name|f_FM_MACSEC_SetException
operator|=
name|MacsecSetException
expr_stmt|;
block|}
end_function

begin_comment
comment|/****************************************/
end_comment

begin_comment
comment|/*       Inter-Module functions         */
end_comment

begin_comment
comment|/****************************************/
end_comment

begin_function
name|void
name|FmMacsecRegisterIntr
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|e_FmMacsecEventModules
name|module
parameter_list|,
name|uint8_t
name|modId
parameter_list|,
name|e_FmIntrType
name|intrType
parameter_list|,
name|void
function_decl|(
modifier|*
name|f_Isr
function_decl|)
parameter_list|(
name|t_Handle
name|h_Arg
parameter_list|,
name|uint32_t
name|id
parameter_list|)
parameter_list|,
name|t_Handle
name|h_Arg
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|uint8_t
name|event
init|=
literal|0
decl_stmt|;
name|SANITY_CHECK_RETURN
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|GET_MACSEC_MODULE_EVENT
argument_list|(
name|module
argument_list|,
name|modId
argument_list|,
name|intrType
argument_list|,
name|event
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|event
operator|!=
name|e_FM_MACSEC_EV_DUMMY_LAST
argument_list|)
expr_stmt|;
name|p_FmMacsec
operator|->
name|intrMng
index|[
name|event
index|]
operator|.
name|f_Isr
operator|=
name|f_Isr
expr_stmt|;
name|p_FmMacsec
operator|->
name|intrMng
index|[
name|event
index|]
operator|.
name|h_SrcHandle
operator|=
name|h_Arg
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FmMacsecUnregisterIntr
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|e_FmMacsecEventModules
name|module
parameter_list|,
name|uint8_t
name|modId
parameter_list|,
name|e_FmIntrType
name|intrType
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|uint8_t
name|event
init|=
literal|0
decl_stmt|;
name|SANITY_CHECK_RETURN
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|GET_MACSEC_MODULE_EVENT
argument_list|(
name|module
argument_list|,
name|modId
argument_list|,
name|intrType
argument_list|,
name|event
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|event
operator|!=
name|e_FM_MACSEC_EV_DUMMY_LAST
argument_list|)
expr_stmt|;
name|p_FmMacsec
operator|->
name|intrMng
index|[
name|event
index|]
operator|.
name|f_Isr
operator|=
name|NULL
expr_stmt|;
name|p_FmMacsec
operator|->
name|intrMng
index|[
name|event
index|]
operator|.
name|h_SrcHandle
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|t_Error
name|FmMacsecAllocScs
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|e_ScType
name|type
parameter_list|,
name|bool
name|isPtp
parameter_list|,
name|uint32_t
name|numOfScs
parameter_list|,
name|uint32_t
modifier|*
name|p_ScIds
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|bool
modifier|*
name|p_ScTable
decl_stmt|;
name|uint32_t
modifier|*
name|p_ScAvailable
decl_stmt|,
name|i
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_ScIds
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|numOfScs
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|e_SC_RX
condition|)
block|{
name|p_ScTable
operator|=
operator|(
name|bool
operator|*
operator|)
name|p_FmMacsec
operator|->
name|rxScTable
expr_stmt|;
name|p_ScAvailable
operator|=
operator|&
name|p_FmMacsec
operator|->
name|numRxScAvailable
expr_stmt|;
name|i
operator|=
operator|(
name|NUM_OF_RX_SC
operator|-
literal|1
operator|)
expr_stmt|;
block|}
else|else
block|{
name|p_ScTable
operator|=
operator|(
name|bool
operator|*
operator|)
name|p_FmMacsec
operator|->
name|txScTable
expr_stmt|;
name|p_ScAvailable
operator|=
operator|&
name|p_FmMacsec
operator|->
name|numTxScAvailable
expr_stmt|;
name|i
operator|=
operator|(
name|NUM_OF_TX_SC
operator|-
literal|1
operator|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|p_ScAvailable
operator|<
name|numOfScs
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_AVAILABLE
argument_list|,
operator|(
literal|"Not enough SCs available"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|isPtp
condition|)
block|{
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|p_ScTable
index|[
name|i
index|]
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_AVAILABLE
argument_list|,
operator|(
literal|"Sc 0 Not available"
operator|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
init|;
name|numOfScs
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
name|p_ScTable
index|[
name|i
index|]
condition|)
continue|continue;
name|numOfScs
operator|--
expr_stmt|;
operator|(
operator|*
name|p_ScAvailable
operator|)
operator|--
expr_stmt|;
name|p_ScIds
index|[
name|numOfScs
index|]
operator|=
name|i
expr_stmt|;
name|p_ScTable
index|[
name|i
index|]
operator|=
name|TRUE
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_function
name|t_Error
name|FmMacsecFreeScs
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|e_ScType
name|type
parameter_list|,
name|uint32_t
name|numOfScs
parameter_list|,
name|uint32_t
modifier|*
name|p_ScIds
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|bool
modifier|*
name|p_ScTable
decl_stmt|;
name|uint32_t
modifier|*
name|p_ScAvailable
decl_stmt|,
name|maxNumOfSc
decl_stmt|,
name|i
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_ScIds
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|numOfScs
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|e_SC_RX
condition|)
block|{
name|p_ScTable
operator|=
operator|(
name|bool
operator|*
operator|)
name|p_FmMacsec
operator|->
name|rxScTable
expr_stmt|;
name|p_ScAvailable
operator|=
operator|&
name|p_FmMacsec
operator|->
name|numRxScAvailable
expr_stmt|;
name|maxNumOfSc
operator|=
name|NUM_OF_RX_SC
expr_stmt|;
block|}
else|else
block|{
name|p_ScTable
operator|=
operator|(
name|bool
operator|*
operator|)
name|p_FmMacsec
operator|->
name|txScTable
expr_stmt|;
name|p_ScAvailable
operator|=
operator|&
name|p_FmMacsec
operator|->
name|numTxScAvailable
expr_stmt|;
name|maxNumOfSc
operator|=
name|NUM_OF_TX_SC
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|*
name|p_ScAvailable
operator|+
name|numOfScs
operator|)
operator|>
name|maxNumOfSc
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_FULL
argument_list|,
operator|(
literal|"Too much SCs"
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|numOfScs
condition|;
name|i
operator|++
control|)
block|{
name|p_ScTable
index|[
name|p_ScIds
index|[
name|i
index|]
index|]
operator|=
name|FALSE
expr_stmt|;
operator|(
operator|*
name|p_ScAvailable
operator|)
operator|++
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_function
name|t_Error
name|FmMacsecSetPTP
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|uint32_t
name|tmpReg
init|=
literal|0
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|tmpReg
operator|=
name|GET_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|cfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
operator|&&
operator|(
name|tmpReg
operator|&
name|CFG_S0I
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"MACSEC already in point-to-point mode"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
condition|)
name|tmpReg
operator||=
name|CFG_S0I
expr_stmt|;
else|else
name|tmpReg
operator|&=
operator|~
name|CFG_S0I
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|cfg
argument_list|,
name|tmpReg
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FmMacsecCreateRxSc
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|t_RxScParams
modifier|*
name|p_RxScParams
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|uint32_t
name|tmpReg
init|=
literal|0
decl_stmt|,
name|intFlags
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_RxScParams
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_RxScParams
operator|->
name|scId
operator|<
name|NUM_OF_RX_SC
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|XX_LockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|rxScSpinLock
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|rxsca
argument_list|,
name|p_RxScParams
operator|->
name|scId
argument_list|)
expr_stmt|;
name|tmpReg
operator|=
name|GET_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|rxsccfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpReg
operator|&
name|RX_SCCFG_SCI_EN_MASK
condition|)
block|{
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|rxScSpinLock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Rx Sc %d must be disable"
operator|,
name|p_RxScParams
operator|->
name|scId
operator|)
argument_list|)
expr_stmt|;
block|}
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|rxsci1h
argument_list|,
name|GET_SCI_FIRST_HALF
argument_list|(
name|p_RxScParams
operator|->
name|sci
argument_list|)
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|rxsci2h
argument_list|,
name|GET_SCI_SECOND_HALF
argument_list|(
name|p_RxScParams
operator|->
name|sci
argument_list|)
argument_list|)
expr_stmt|;
name|tmpReg
operator||=
operator|(
operator|(
name|p_RxScParams
operator|->
name|replayProtect
operator|<<
name|RX_SCCFG_RP_SHIFT
operator|)
operator|&
name|RX_SCCFG_RP_MASK
operator|)
expr_stmt|;
name|tmpReg
operator||=
operator|(
operator|(
name|p_RxScParams
operator|->
name|validateFrames
operator|<<
name|RX_SCCFG_VF_SHIFT
operator|)
operator|&
name|RX_SCCFG_VF_MASK
operator|)
expr_stmt|;
name|tmpReg
operator||=
operator|(
operator|(
name|p_RxScParams
operator|->
name|confidentialityOffset
operator|<<
name|RX_SCCFG_CO_SHIFT
operator|)
operator|&
name|RX_SCCFG_CO_MASK
operator|)
expr_stmt|;
name|tmpReg
operator||=
name|RX_SCCFG_SCI_EN_MASK
expr_stmt|;
name|tmpReg
operator||=
operator|(
name|p_RxScParams
operator|->
name|cipherSuite
operator|<<
name|RX_SCCFG_CS_SHIFT
operator|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|rxsccfg
argument_list|,
name|tmpReg
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|rpw
argument_list|,
name|p_RxScParams
operator|->
name|replayWindow
argument_list|)
expr_stmt|;
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|rxScSpinLock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|t_Error
name|FmMacsecDeleteRxSc
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|uint32_t
name|scId
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|uint32_t
name|tmpReg
init|=
literal|0
decl_stmt|,
name|intFlags
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|scId
operator|<
name|NUM_OF_RX_SC
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|XX_LockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|rxScSpinLock
argument_list|)
expr_stmt|;
name|tmpReg
operator|&=
operator|~
name|RX_SCCFG_SCI_EN_MASK
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|rxsca
argument_list|,
name|scId
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|rxsccfg
argument_list|,
name|tmpReg
argument_list|)
expr_stmt|;
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|rxScSpinLock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|t_Error
name|FmMacsecCreateTxSc
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|t_TxScParams
modifier|*
name|p_TxScParams
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|uint32_t
name|tmpReg
init|=
literal|0
decl_stmt|,
name|intFlags
decl_stmt|;
name|bool
name|alwaysIncludeSCI
init|=
name|FALSE
decl_stmt|,
name|useES
init|=
name|FALSE
decl_stmt|,
name|useSCB
init|=
name|FALSE
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_TxScParams
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_TxScParams
operator|->
name|scId
operator|<
name|NUM_OF_TX_SC
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|XX_LockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|txScSpinLock
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|txsca
argument_list|,
name|p_TxScParams
operator|->
name|scId
argument_list|)
expr_stmt|;
name|tmpReg
operator|=
name|GET_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|txsccfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpReg
operator|&
name|TX_SCCFG_SCE_MASK
condition|)
block|{
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|txScSpinLock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Tx Sc %d must be disable"
operator|,
name|p_TxScParams
operator|->
name|scId
operator|)
argument_list|)
expr_stmt|;
block|}
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|txsci1h
argument_list|,
name|GET_SCI_FIRST_HALF
argument_list|(
name|p_TxScParams
operator|->
name|sci
argument_list|)
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|txsci2h
argument_list|,
name|GET_SCI_SECOND_HALF
argument_list|(
name|p_TxScParams
operator|->
name|sci
argument_list|)
argument_list|)
expr_stmt|;
name|alwaysIncludeSCI
operator|=
operator|(
name|p_TxScParams
operator|->
name|sciInsertionMode
operator|==
name|e_FM_MACSEC_SCI_INSERTION_MODE_EXPLICIT_SECTAG
operator|)
expr_stmt|;
name|useES
operator|=
operator|(
name|p_TxScParams
operator|->
name|sciInsertionMode
operator|==
name|e_FM_MACSEC_SCI_INSERTION_MODE_EXPLICIT_MAC_SA
operator|)
expr_stmt|;
name|tmpReg
operator||=
operator|(
operator|(
name|p_TxScParams
operator|->
name|protectFrames
operator|<<
name|TX_SCCFG_PF_SHIFT
operator|)
operator|&
name|TX_SCCFG_PF_MASK
operator|)
expr_stmt|;
name|tmpReg
operator||=
operator|(
operator|(
name|alwaysIncludeSCI
operator|<<
name|TX_SCCFG_AIS_SHIFT
operator|)
operator|&
name|TX_SCCFG_AIS_MASK
operator|)
expr_stmt|;
name|tmpReg
operator||=
operator|(
operator|(
name|useES
operator|<<
name|TX_SCCFG_UES_SHIFT
operator|)
operator|&
name|TX_SCCFG_UES_MASK
operator|)
expr_stmt|;
name|tmpReg
operator||=
operator|(
operator|(
name|useSCB
operator|<<
name|TX_SCCFG_USCB_SHIFT
operator|)
operator|&
name|TX_SCCFG_USCB_MASK
operator|)
expr_stmt|;
name|tmpReg
operator||=
operator|(
operator|(
name|p_TxScParams
operator|->
name|confidentialityEnable
operator|<<
name|TX_SCCFG_CE_SHIFT
operator|)
operator|&
name|TX_SCCFG_CE_MASK
operator|)
expr_stmt|;
name|tmpReg
operator||=
operator|(
operator|(
name|p_TxScParams
operator|->
name|confidentialityOffset
operator|<<
name|TX_SCCFG_CO_SHIFT
operator|)
operator|&
name|TX_SCCFG_CO_MASK
operator|)
expr_stmt|;
name|tmpReg
operator||=
name|TX_SCCFG_SCE_MASK
expr_stmt|;
name|tmpReg
operator||=
operator|(
name|p_TxScParams
operator|->
name|cipherSuite
operator|<<
name|TX_SCCFG_CS_SHIFT
operator|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|txsccfg
argument_list|,
name|tmpReg
argument_list|)
expr_stmt|;
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|txScSpinLock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|t_Error
name|FmMacsecDeleteTxSc
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|uint32_t
name|scId
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|uint32_t
name|tmpReg
init|=
literal|0
decl_stmt|,
name|intFlags
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|scId
operator|<
name|NUM_OF_TX_SC
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|XX_LockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|txScSpinLock
argument_list|)
expr_stmt|;
name|tmpReg
operator|&=
operator|~
name|TX_SCCFG_SCE_MASK
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|txsca
argument_list|,
name|scId
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|txsccfg
argument_list|,
name|tmpReg
argument_list|)
expr_stmt|;
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|txScSpinLock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|t_Error
name|FmMacsecCreateRxSa
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|uint32_t
name|scId
parameter_list|,
name|e_ScSaId
name|saId
parameter_list|,
name|macsecAN_t
name|an
parameter_list|,
name|uint32_t
name|lowestPn
parameter_list|,
name|macsecSAKey_t
name|key
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|uint32_t
name|tmpReg
init|=
literal|0
decl_stmt|,
name|intFlags
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|scId
operator|<
name|NUM_OF_RX_SC
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|saId
operator|<
name|NUM_OF_SA_PER_RX_SC
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|XX_LockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|rxScSpinLock
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|rxsca
argument_list|,
name|scId
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|fmMacsecRxScSa
index|[
name|saId
index|]
operator|.
name|rxsanpn
argument_list|,
name|DEFAULT_initNextPn
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|fmMacsecRxScSa
index|[
name|saId
index|]
operator|.
name|rxsalpn
argument_list|,
name|lowestPn
argument_list|)
expr_stmt|;
name|MemCpy8
argument_list|(
operator|(
name|void
operator|*
operator|)
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|fmMacsecRxScSa
index|[
name|saId
index|]
operator|.
name|rxsak
argument_list|,
name|key
argument_list|,
sizeof|sizeof
argument_list|(
name|macsecSAKey_t
argument_list|)
argument_list|)
expr_stmt|;
name|tmpReg
operator||=
name|RX_SACFG_ACTIVE
expr_stmt|;
name|tmpReg
operator||=
operator|(
operator|(
name|an
operator|<<
name|RX_SACFG_AN_SHIFT
operator|)
operator|&
name|RX_SACFG_AN_MASK
operator|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|fmMacsecRxScSa
index|[
name|saId
index|]
operator|.
name|rxsacs
argument_list|,
name|tmpReg
argument_list|)
expr_stmt|;
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|rxScSpinLock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|t_Error
name|FmMacsecCreateTxSa
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|uint32_t
name|scId
parameter_list|,
name|e_ScSaId
name|saId
parameter_list|,
name|macsecSAKey_t
name|key
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|uint32_t
name|tmpReg
init|=
literal|0
decl_stmt|,
name|intFlags
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|scId
operator|<
name|NUM_OF_RX_SC
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|saId
operator|<
name|NUM_OF_SA_PER_TX_SC
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|XX_LockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|txScSpinLock
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|txsca
argument_list|,
name|scId
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|fmMacsecTxScSa
index|[
name|saId
index|]
operator|.
name|txsanpn
argument_list|,
name|DEFAULT_initNextPn
argument_list|)
expr_stmt|;
name|MemCpy8
argument_list|(
operator|(
name|void
operator|*
operator|)
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|fmMacsecTxScSa
index|[
name|saId
index|]
operator|.
name|txsak
argument_list|,
name|key
argument_list|,
sizeof|sizeof
argument_list|(
name|macsecSAKey_t
argument_list|)
argument_list|)
expr_stmt|;
name|tmpReg
operator||=
name|TX_SACFG_ACTIVE
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|fmMacsecTxScSa
index|[
name|saId
index|]
operator|.
name|txsacs
argument_list|,
name|tmpReg
argument_list|)
expr_stmt|;
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|txScSpinLock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|t_Error
name|FmMacsecDeleteRxSa
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|uint32_t
name|scId
parameter_list|,
name|e_ScSaId
name|saId
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|uint32_t
name|tmpReg
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|,
name|intFlags
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|scId
operator|<
name|NUM_OF_RX_SC
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|saId
operator|<
name|NUM_OF_SA_PER_RX_SC
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|XX_LockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|rxScSpinLock
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|rxsca
argument_list|,
name|scId
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|fmMacsecRxScSa
index|[
name|saId
index|]
operator|.
name|rxsanpn
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|fmMacsecRxScSa
index|[
name|saId
index|]
operator|.
name|rxsalpn
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|fmMacsecRxScSa
index|[
name|saId
index|]
operator|.
name|rxsak
index|[
name|i
index|]
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|tmpReg
operator||=
name|RX_SACFG_ACTIVE
expr_stmt|;
name|tmpReg
operator|&=
operator|~
name|RX_SACFG_EN_MASK
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|fmMacsecRxScSa
index|[
name|saId
index|]
operator|.
name|rxsacs
argument_list|,
name|tmpReg
argument_list|)
expr_stmt|;
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|rxScSpinLock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|t_Error
name|FmMacsecDeleteTxSa
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|uint32_t
name|scId
parameter_list|,
name|e_ScSaId
name|saId
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|uint32_t
name|tmpReg
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|,
name|intFlags
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|scId
operator|<
name|NUM_OF_RX_SC
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|saId
operator|<
name|NUM_OF_SA_PER_TX_SC
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|XX_LockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|txScSpinLock
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|txsca
argument_list|,
name|scId
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|fmMacsecTxScSa
index|[
name|saId
index|]
operator|.
name|txsanpn
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|fmMacsecTxScSa
index|[
name|saId
index|]
operator|.
name|txsak
index|[
name|i
index|]
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|tmpReg
operator||=
name|TX_SACFG_ACTIVE
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|fmMacsecTxScSa
index|[
name|saId
index|]
operator|.
name|txsacs
argument_list|,
name|tmpReg
argument_list|)
expr_stmt|;
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|txScSpinLock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|t_Error
name|FmMacsecRxSaSetReceive
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|uint32_t
name|scId
parameter_list|,
name|e_ScSaId
name|saId
parameter_list|,
name|bool
name|enableReceive
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|uint32_t
name|tmpReg
init|=
literal|0
decl_stmt|,
name|intFlags
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|scId
operator|<
name|NUM_OF_RX_SC
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|saId
operator|<
name|NUM_OF_SA_PER_RX_SC
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|XX_LockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|rxScSpinLock
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|rxsca
argument_list|,
name|scId
argument_list|)
expr_stmt|;
name|tmpReg
operator|=
name|GET_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|fmMacsecRxScSa
index|[
name|saId
index|]
operator|.
name|rxsacs
argument_list|)
expr_stmt|;
if|if
condition|(
name|enableReceive
condition|)
name|tmpReg
operator||=
name|RX_SACFG_EN_MASK
expr_stmt|;
else|else
name|tmpReg
operator|&=
operator|~
name|RX_SACFG_EN_MASK
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|fmMacsecRxScSa
index|[
name|saId
index|]
operator|.
name|rxsacs
argument_list|,
name|tmpReg
argument_list|)
expr_stmt|;
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|rxScSpinLock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|t_Error
name|FmMacsecRxSaUpdateNextPn
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|uint32_t
name|scId
parameter_list|,
name|e_ScSaId
name|saId
parameter_list|,
name|uint32_t
name|updtNextPN
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|uint32_t
name|intFlags
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|scId
operator|<
name|NUM_OF_RX_SC
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|saId
operator|<
name|NUM_OF_SA_PER_RX_SC
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|XX_LockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|rxScSpinLock
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|rxsca
argument_list|,
name|scId
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|fmMacsecRxScSa
index|[
name|saId
index|]
operator|.
name|rxsanpn
argument_list|,
name|updtNextPN
argument_list|)
expr_stmt|;
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|rxScSpinLock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|t_Error
name|FmMacsecRxSaUpdateLowestPn
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|uint32_t
name|scId
parameter_list|,
name|e_ScSaId
name|saId
parameter_list|,
name|uint32_t
name|updtLowestPN
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|uint32_t
name|intFlags
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|scId
operator|<
name|NUM_OF_RX_SC
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|saId
operator|<
name|NUM_OF_SA_PER_RX_SC
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|XX_LockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|rxScSpinLock
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|rxsca
argument_list|,
name|scId
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|fmMacsecRxScSa
index|[
name|saId
index|]
operator|.
name|rxsalpn
argument_list|,
name|updtLowestPN
argument_list|)
expr_stmt|;
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|rxScSpinLock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|t_Error
name|FmMacsecTxSaSetActive
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|uint32_t
name|scId
parameter_list|,
name|e_ScSaId
name|saId
parameter_list|,
name|macsecAN_t
name|an
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|uint32_t
name|tmpReg
init|=
literal|0
decl_stmt|,
name|intFlags
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|scId
operator|<
name|NUM_OF_RX_SC
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|saId
operator|<
name|NUM_OF_SA_PER_TX_SC
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|XX_LockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|txScSpinLock
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|txsca
argument_list|,
name|scId
argument_list|)
expr_stmt|;
name|tmpReg
operator|=
name|GET_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|txsccfg
argument_list|)
expr_stmt|;
name|tmpReg
operator||=
operator|(
operator|(
name|an
operator|<<
name|TX_SCCFG_AN_SHIFT
operator|)
operator|&
name|TX_SCCFG_AN_MASK
operator|)
expr_stmt|;
name|tmpReg
operator||=
operator|(
operator|(
name|saId
operator|<<
name|TX_SCCFG_ASA_SHIFT
operator|)
operator|&
name|TX_SCCFG_ASA_MASK
operator|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|txsccfg
argument_list|,
name|tmpReg
argument_list|)
expr_stmt|;
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|txScSpinLock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|t_Error
name|FmMacsecTxSaGetActive
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|uint32_t
name|scId
parameter_list|,
name|macsecAN_t
modifier|*
name|p_An
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|uint32_t
name|tmpReg
init|=
literal|0
decl_stmt|,
name|intFlags
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|scId
operator|<
name|NUM_OF_RX_SC
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_An
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|XX_LockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|txScSpinLock
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|txsca
argument_list|,
name|scId
argument_list|)
expr_stmt|;
name|tmpReg
operator|=
name|GET_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|txsccfg
argument_list|)
expr_stmt|;
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_FmMacsec
operator|->
name|txScSpinLock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
operator|*
name|p_An
operator|=
call|(
name|macsecAN_t
call|)
argument_list|(
operator|(
name|tmpReg
operator|&
name|TX_SCCFG_AN_MASK
operator|)
operator|>>
name|TX_SCCFG_AN_SHIFT
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|t_Error
name|FmMacsecSetException
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|e_FmMacsecGlobalExceptions
name|exception
parameter_list|,
name|uint32_t
name|scId
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|uint32_t
name|bitMask
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|GET_EXCEPTION_FLAG
argument_list|(
name|bitMask
argument_list|,
name|exception
argument_list|,
name|scId
argument_list|)
expr_stmt|;
if|if
condition|(
name|bitMask
condition|)
block|{
if|if
condition|(
name|enable
condition|)
name|p_FmMacsec
operator|->
name|exceptions
operator||=
name|bitMask
expr_stmt|;
else|else
name|p_FmMacsec
operator|->
name|exceptions
operator|&=
operator|~
name|bitMask
expr_stmt|;
block|}
else|else
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Undefined exception"
operator|)
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|erer
argument_list|,
name|p_FmMacsec
operator|->
name|exceptions
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FmMacsecSetEvent
parameter_list|(
name|t_Handle
name|h_FmMacsec
parameter_list|,
name|e_FmMacsecGlobalEvents
name|event
parameter_list|,
name|uint32_t
name|scId
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
init|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|h_FmMacsec
decl_stmt|;
name|uint32_t
name|bitMask
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmMacsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|GET_EVENT_FLAG
argument_list|(
name|bitMask
argument_list|,
name|event
argument_list|,
name|scId
argument_list|)
expr_stmt|;
if|if
condition|(
name|bitMask
condition|)
block|{
if|if
condition|(
name|enable
condition|)
name|p_FmMacsec
operator|->
name|events
operator||=
name|bitMask
expr_stmt|;
else|else
name|p_FmMacsec
operator|->
name|events
operator|&=
operator|~
name|bitMask
expr_stmt|;
block|}
else|else
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Undefined event"
operator|)
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|->
name|ever
argument_list|,
name|p_FmMacsec
operator|->
name|events
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/****************************************/
end_comment

begin_comment
comment|/*       API Init unit functions        */
end_comment

begin_comment
comment|/****************************************/
end_comment

begin_function
name|t_Handle
name|FM_MACSEC_MASTER_Config
parameter_list|(
name|t_FmMacsecParams
modifier|*
name|p_FmMacsecParam
parameter_list|)
block|{
name|t_FmMacsec
modifier|*
name|p_FmMacsec
decl_stmt|;
name|uint32_t
name|macId
decl_stmt|;
comment|/* Allocate FM MACSEC structure */
name|p_FmMacsec
operator|=
operator|(
name|t_FmMacsec
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|t_FmMacsec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_FmMacsec
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"FM MACSEC driver structure"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_FmMacsec
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmMacsec
argument_list|)
argument_list|)
expr_stmt|;
name|InitFmMacsecControllerDriver
argument_list|(
operator|&
name|p_FmMacsec
operator|->
name|fmMacsecControllerDriver
argument_list|)
expr_stmt|;
comment|/* Allocate the FM MACSEC driver's parameters structure */
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
operator|=
operator|(
name|t_FmMacsecDriverParam
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|t_FmMacsecDriverParam
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
condition|)
block|{
name|XX_Free
argument_list|(
name|p_FmMacsec
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"FM MACSEC driver parameters"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmMacsecDriverParam
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Initialize FM MACSEC parameters which will be kept by the driver */
name|p_FmMacsec
operator|->
name|h_Fm
operator|=
name|p_FmMacsecParam
operator|->
name|h_Fm
expr_stmt|;
name|p_FmMacsec
operator|->
name|h_FmMac
operator|=
name|p_FmMacsecParam
operator|->
name|nonGuestParams
operator|.
name|h_FmMac
expr_stmt|;
name|p_FmMacsec
operator|->
name|p_FmMacsecRegs
operator|=
operator|(
name|t_FmMacsecRegs
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|p_FmMacsecParam
operator|->
name|nonGuestParams
operator|.
name|baseAddr
argument_list|)
expr_stmt|;
name|p_FmMacsec
operator|->
name|f_Exception
operator|=
name|p_FmMacsecParam
operator|->
name|nonGuestParams
operator|.
name|f_Exception
expr_stmt|;
name|p_FmMacsec
operator|->
name|h_App
operator|=
name|p_FmMacsecParam
operator|->
name|nonGuestParams
operator|.
name|h_App
expr_stmt|;
name|p_FmMacsec
operator|->
name|userExceptions
operator|=
name|DEFAULT_userExceptions
expr_stmt|;
name|p_FmMacsec
operator|->
name|exceptions
operator|=
name|DEFAULT_exceptions
expr_stmt|;
name|p_FmMacsec
operator|->
name|events
operator|=
name|DEFAULT_events
expr_stmt|;
name|p_FmMacsec
operator|->
name|rxScSpinLock
operator|=
name|XX_InitSpinlock
argument_list|()
expr_stmt|;
name|p_FmMacsec
operator|->
name|txScSpinLock
operator|=
name|XX_InitSpinlock
argument_list|()
expr_stmt|;
comment|/* Initialize FM MACSEC driver parameters parameters (for initialization phase only) */
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
operator|->
name|unknownSciTreatMode
operator|=
name|DEFAULT_unknownSciFrameTreatment
expr_stmt|;
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
operator|->
name|invalidTagsDeliverUncontrolled
operator|=
name|DEFAULT_invalidTagsFrameTreatment
expr_stmt|;
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
operator|->
name|encryptWithNoChangedTextDiscardUncontrolled
operator|=
name|DEFAULT_encryptWithNoChangedTextFrameTreatment
expr_stmt|;
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
operator|->
name|untagTreatMode
operator|=
name|DEFAULT_untagFrameTreatment
expr_stmt|;
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
operator|->
name|keysUnreadable
operator|=
name|DEFAULT_keysUnreadable
expr_stmt|;
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
operator|->
name|reservedSc0
operator|=
name|DEFAULT_sc0ReservedForPTP
expr_stmt|;
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
operator|->
name|byPassMode
operator|=
operator|!
name|DEFAULT_normalMode
expr_stmt|;
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
operator|->
name|pnExhThr
operator|=
name|DEFAULT_pnExhThr
expr_stmt|;
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
operator|->
name|sectagOverhead
operator|=
name|DEFAULT_sectagOverhead
expr_stmt|;
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
operator|->
name|mflSubtract
operator|=
name|DEFAULT_mflSubtract
expr_stmt|;
comment|/* build the FM MACSEC master IPC address */
name|memset
argument_list|(
name|p_FmMacsec
operator|->
name|fmMacsecModuleName
argument_list|,
literal|0
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|char
argument_list|)
operator|)
operator|*
name|MODULE_NAME_SIZE
argument_list|)
expr_stmt|;
name|FM_MAC_GetId
argument_list|(
name|p_FmMacsec
operator|->
name|h_FmMac
argument_list|,
operator|&
name|macId
argument_list|)
expr_stmt|;
if|if
condition|(
name|Sprint
argument_list|(
name|p_FmMacsec
operator|->
name|fmMacsecModuleName
argument_list|,
literal|"FM-%d-MAC-%d-MACSEC-Master"
argument_list|,
name|FmGetId
argument_list|(
name|p_FmMacsec
operator|->
name|h_Fm
argument_list|)
argument_list|,
name|macId
argument_list|)
operator|!=
literal|24
condition|)
block|{
name|XX_Free
argument_list|(
name|p_FmMacsec
operator|->
name|p_FmMacsecDriverParam
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_FmMacsec
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Sprint failed"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|p_FmMacsec
return|;
block|}
end_function

end_unit


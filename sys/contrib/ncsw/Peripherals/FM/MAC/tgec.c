begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (c) 2008-2011 Freescale Semiconductor, Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are met:  *     * Redistributions of source code must retain the above copyright  *       notice, this list of conditions and the following disclaimer.  *     * Redistributions in binary form must reproduce the above copyright  *       notice, this list of conditions and the following disclaimer in the  *       documentation and/or other materials provided with the distribution.  *     * Neither the name of Freescale Semiconductor nor the  *       names of its contributors may be used to endorse or promote products  *       derived from this software without specific prior written permission.  *  *  * ALTERNATIVELY, this software may be distributed under the terms of the  * GNU General Public License ("GPL") as published by the Free Software  * Foundation, either version 2 of that License or (at your option) any  * later version.  *  * THIS SOFTWARE IS PROVIDED BY Freescale Semiconductor ``AS IS'' AND ANY  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED. IN NO EVENT SHALL Freescale Semiconductor BE LIABLE FOR ANY  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/******************************************************************************  @File          tgec.c   @Description   FM 10G MAC ... */
end_comment

begin_comment
comment|/***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|"std_ext.h"
end_include

begin_include
include|#
directive|include
file|"string_ext.h"
end_include

begin_include
include|#
directive|include
file|"error_ext.h"
end_include

begin_include
include|#
directive|include
file|"xx_ext.h"
end_include

begin_include
include|#
directive|include
file|"endian_ext.h"
end_include

begin_include
include|#
directive|include
file|"crc_mac_addr_ext.h"
end_include

begin_include
include|#
directive|include
file|"debug_ext.h"
end_include

begin_include
include|#
directive|include
file|"fm_common.h"
end_include

begin_include
include|#
directive|include
file|"tgec.h"
end_include

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*                      Internal routines                                    */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
specifier|static
name|t_Error
name|CheckInitParameters
parameter_list|(
name|t_Tgec
modifier|*
name|p_Tgec
parameter_list|)
block|{
if|if
condition|(
name|ENET_SPEED_FROM_MODE
argument_list|(
name|p_Tgec
operator|->
name|enetMode
argument_list|)
operator|<
name|e_ENET_SPEED_10000
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Ethernet 10G MAC driver only support 10G speed"
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|FM_MAX_NUM_OF_10G_MACS
operator|>
literal|0
operator|)
if|if
condition|(
name|p_Tgec
operator|->
name|macId
operator|>=
name|FM_MAX_NUM_OF_10G_MACS
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"macId of 10G can not be greater than 0"
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|p_Tgec
operator|->
name|addr
operator|==
literal|0
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Ethernet 10G MAC Must have a valid MAC Address"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Tgec
operator|->
name|f_Exception
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"uninitialized f_Exception"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Tgec
operator|->
name|f_Event
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"uninitialized f_Event"
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|void
name|SetDefaultParam
parameter_list|(
name|t_TgecDriverParam
modifier|*
name|p_TgecDriverParam
parameter_list|)
block|{
name|p_TgecDriverParam
operator|->
name|wanModeEnable
operator|=
name|DEFAULT_wanModeEnable
expr_stmt|;
name|p_TgecDriverParam
operator|->
name|promiscuousModeEnable
operator|=
name|DEFAULT_promiscuousModeEnable
expr_stmt|;
name|p_TgecDriverParam
operator|->
name|pauseForwardEnable
operator|=
name|DEFAULT_pauseForwardEnable
expr_stmt|;
name|p_TgecDriverParam
operator|->
name|pauseIgnore
operator|=
name|DEFAULT_pauseIgnore
expr_stmt|;
name|p_TgecDriverParam
operator|->
name|txAddrInsEnable
operator|=
name|DEFAULT_txAddrInsEnable
expr_stmt|;
name|p_TgecDriverParam
operator|->
name|loopbackEnable
operator|=
name|DEFAULT_loopbackEnable
expr_stmt|;
name|p_TgecDriverParam
operator|->
name|cmdFrameEnable
operator|=
name|DEFAULT_cmdFrameEnable
expr_stmt|;
name|p_TgecDriverParam
operator|->
name|rxErrorDiscard
operator|=
name|DEFAULT_rxErrorDiscard
expr_stmt|;
name|p_TgecDriverParam
operator|->
name|phyTxenaOn
operator|=
name|DEFAULT_phyTxenaOn
expr_stmt|;
name|p_TgecDriverParam
operator|->
name|sendIdleEnable
operator|=
name|DEFAULT_sendIdleEnable
expr_stmt|;
name|p_TgecDriverParam
operator|->
name|noLengthCheckEnable
operator|=
name|DEFAULT_noLengthCheckEnable
expr_stmt|;
name|p_TgecDriverParam
operator|->
name|lgthCheckNostdr
operator|=
name|DEFAULT_lgthCheckNostdr
expr_stmt|;
name|p_TgecDriverParam
operator|->
name|timeStampEnable
operator|=
name|DEFAULT_timeStampEnable
expr_stmt|;
name|p_TgecDriverParam
operator|->
name|rxSfdAny
operator|=
name|DEFAULT_rxSfdAny
expr_stmt|;
name|p_TgecDriverParam
operator|->
name|rxPblFwd
operator|=
name|DEFAULT_rxPblFwd
expr_stmt|;
name|p_TgecDriverParam
operator|->
name|txPblFwd
operator|=
name|DEFAULT_txPblFwd
expr_stmt|;
name|p_TgecDriverParam
operator|->
name|txIpgLength
operator|=
name|DEFAULT_txIpgLength
expr_stmt|;
name|p_TgecDriverParam
operator|->
name|maxFrameLength
operator|=
name|DEFAULT_maxFrameLength
expr_stmt|;
name|p_TgecDriverParam
operator|->
name|debugMode
operator|=
name|DEFAULT_debugMode
expr_stmt|;
name|p_TgecDriverParam
operator|->
name|pauseTime
operator|=
name|DEFAULT_pauseTime
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_TX_ECC_FRMS_ERRATA_10GMAC_A004
name|p_TgecDriverParam
operator|->
name|skipFman11Workaround
operator|=
name|DEFAULT_skipFman11Workaround
expr_stmt|;
endif|#
directive|endif
comment|/* FM_TX_ECC_FRMS_ERRATA_10GMAC_A004 */
block|}
end_function

begin_comment
comment|/* ........................................................................... */
end_comment

begin_function
specifier|static
name|void
name|TgecErrException
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|uint32_t
name|event
decl_stmt|;
name|t_TgecMemMap
modifier|*
name|p_TgecMemMap
init|=
name|p_Tgec
operator|->
name|p_MemMap
decl_stmt|;
name|event
operator|=
name|GET_UINT32
argument_list|(
name|p_TgecMemMap
operator|->
name|ievent
argument_list|)
expr_stmt|;
comment|/* do not handle MDIO events */
name|event
operator|&=
operator|~
operator|(
name|IMASK_MDIO_SCAN_EVENTMDIO
operator||
name|IMASK_MDIO_CMD_CMPL
operator|)
expr_stmt|;
name|event
operator|&=
name|GET_UINT32
argument_list|(
name|p_TgecMemMap
operator|->
name|imask
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_TgecMemMap
operator|->
name|ievent
argument_list|,
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_REM_FAULT
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_REM_FAULT
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_LOC_FAULT
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_LOC_FAULT
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_1TX_ECC_ER
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_1TX_ECC_ER
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_TX_FIFO_UNFL
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_TX_FIFO_UNFL
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_TX_FIFO_OVFL
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_TX_FIFO_OVFL
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_TX_ER
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_TX_ER
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_RX_FIFO_OVFL
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_RX_FIFO_OVFL
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_RX_ECC_ER
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_RX_ECC_ER
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_RX_JAB_FRM
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_RX_JAB_FRM
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_RX_OVRSZ_FRM
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_RX_OVRSZ_FRM
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_RX_RUNT_FRM
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_RX_RUNT_FRM
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_RX_FRAG_FRM
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_RX_FRAG_FRM
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_RX_LEN_ER
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_RX_LEN_ER
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_RX_CRC_ER
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_RX_CRC_ER
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_RX_ALIGN_ER
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_RX_ALIGN_ER
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|TgecException
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|uint32_t
name|event
decl_stmt|;
name|t_TgecMemMap
modifier|*
name|p_TgecMemMap
init|=
name|p_Tgec
operator|->
name|p_MemMap
decl_stmt|;
name|event
operator|=
name|GET_UINT32
argument_list|(
name|p_TgecMemMap
operator|->
name|ievent
argument_list|)
expr_stmt|;
comment|/* handle only MDIO events */
name|event
operator|&=
operator|(
name|IMASK_MDIO_SCAN_EVENTMDIO
operator||
name|IMASK_MDIO_CMD_CMPL
operator|)
expr_stmt|;
name|event
operator|&=
name|GET_UINT32
argument_list|(
name|p_TgecMemMap
operator|->
name|imask
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_TgecMemMap
operator|->
name|ievent
argument_list|,
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_MDIO_SCAN_EVENTMDIO
condition|)
name|p_Tgec
operator|->
name|f_Event
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_MDIO_SCAN_EVENTMDIO
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_MDIO_CMD_CMPL
condition|)
name|p_Tgec
operator|->
name|f_Event
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_MDIO_CMD_CMPL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|FreeInitResources
parameter_list|(
name|t_Tgec
modifier|*
name|p_Tgec
parameter_list|)
block|{
if|if
condition|(
operator|(
name|p_Tgec
operator|->
name|mdioIrq
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|p_Tgec
operator|->
name|mdioIrq
operator|!=
name|NO_IRQ
operator|)
condition|)
block|{
name|XX_DisableIntr
argument_list|(
name|p_Tgec
operator|->
name|mdioIrq
argument_list|)
expr_stmt|;
name|XX_FreeIntr
argument_list|(
name|p_Tgec
operator|->
name|mdioIrq
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p_Tgec
operator|->
name|mdioIrq
operator|==
literal|0
condition|)
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
name|NO_MSG
operator|)
argument_list|)
expr_stmt|;
name|FmUnregisterIntr
argument_list|(
name|p_Tgec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
name|e_FM_MOD_10G_MAC
argument_list|,
name|p_Tgec
operator|->
name|macId
argument_list|,
name|e_FM_INTR_TYPE_ERR
argument_list|)
expr_stmt|;
comment|/* release the driver's group hash table */
name|FreeHashTable
argument_list|(
name|p_Tgec
operator|->
name|p_MulticastAddrHash
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|p_MulticastAddrHash
operator|=
name|NULL
expr_stmt|;
comment|/* release the driver's individual hash table */
name|FreeHashTable
argument_list|(
name|p_Tgec
operator|->
name|p_UnicastAddrHash
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|p_UnicastAddrHash
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|void
name|HardwareClearAddrInPaddr
parameter_list|(
name|t_Tgec
modifier|*
name|p_Tgec
parameter_list|,
name|uint8_t
name|paddrNum
parameter_list|)
block|{
if|if
condition|(
name|paddrNum
operator|!=
literal|0
condition|)
return|return;
comment|/* At this time MAC has only one address */
name|WRITE_UINT32
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
operator|->
name|mac_addr_2
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
operator|->
name|mac_addr_3
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ........................................................................... */
end_comment

begin_function
specifier|static
name|void
name|HardwareAddAddrInPaddr
parameter_list|(
name|t_Tgec
modifier|*
name|p_Tgec
parameter_list|,
name|uint64_t
modifier|*
name|p_Addr
parameter_list|,
name|uint8_t
name|paddrNum
parameter_list|)
block|{
name|uint32_t
name|tmpReg32
init|=
literal|0
decl_stmt|;
name|uint64_t
name|addr
init|=
operator|*
name|p_Addr
decl_stmt|;
name|t_TgecMemMap
modifier|*
name|p_TgecMemMap
init|=
name|p_Tgec
operator|->
name|p_MemMap
decl_stmt|;
if|if
condition|(
name|paddrNum
operator|!=
literal|0
condition|)
return|return;
comment|/* At this time MAC has only one address */
name|tmpReg32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|addr
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|SwapUint32P
argument_list|(
operator|&
name|tmpReg32
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_TgecMemMap
operator|->
name|mac_addr_2
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
name|tmpReg32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|SwapUint32P
argument_list|(
operator|&
name|tmpReg32
argument_list|)
expr_stmt|;
name|tmpReg32
operator|>>=
literal|16
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_TgecMemMap
operator|->
name|mac_addr_3
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*                     10G MAC API routines                                  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecEnable
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|e_CommMode
name|mode
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|t_TgecMemMap
modifier|*
name|p_MemMap
decl_stmt|;
name|uint32_t
name|tmpReg32
init|=
literal|0
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_MemMap
operator|=
operator|(
name|t_TgecMemMap
operator|*
operator|)
operator|(
name|p_Tgec
operator|->
name|p_MemMap
operator|)
expr_stmt|;
name|tmpReg32
operator|=
name|GET_UINT32
argument_list|(
name|p_MemMap
operator|->
name|cmd_conf_ctrl
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|e_COMM_MODE_NONE
case|:
name|tmpReg32
operator|&=
operator|~
operator|(
name|CMD_CFG_TX_EN
operator||
name|CMD_CFG_RX_EN
operator|)
expr_stmt|;
break|break;
case|case
name|e_COMM_MODE_RX
case|:
name|tmpReg32
operator||=
name|CMD_CFG_RX_EN
expr_stmt|;
break|break;
case|case
name|e_COMM_MODE_TX
case|:
name|tmpReg32
operator||=
name|CMD_CFG_TX_EN
expr_stmt|;
break|break;
case|case
name|e_COMM_MODE_RX_AND_TX
case|:
name|tmpReg32
operator||=
operator|(
name|CMD_CFG_TX_EN
operator||
name|CMD_CFG_RX_EN
operator|)
expr_stmt|;
break|break;
block|}
name|WRITE_UINT32
argument_list|(
name|p_MemMap
operator|->
name|cmd_conf_ctrl
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecDisable
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|e_CommMode
name|mode
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|t_TgecMemMap
modifier|*
name|p_MemMap
decl_stmt|;
name|uint32_t
name|tmpReg32
init|=
literal|0
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_MemMap
operator|=
operator|(
name|t_TgecMemMap
operator|*
operator|)
operator|(
name|p_Tgec
operator|->
name|p_MemMap
operator|)
expr_stmt|;
name|tmpReg32
operator|=
name|GET_UINT32
argument_list|(
name|p_MemMap
operator|->
name|cmd_conf_ctrl
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|e_COMM_MODE_RX
case|:
name|tmpReg32
operator|&=
operator|~
name|CMD_CFG_RX_EN
expr_stmt|;
break|break;
case|case
name|e_COMM_MODE_TX
case|:
name|tmpReg32
operator|&=
operator|~
name|CMD_CFG_TX_EN
expr_stmt|;
break|break;
case|case
name|e_COMM_MODE_RX_AND_TX
case|:
name|tmpReg32
operator|&=
operator|~
operator|(
name|CMD_CFG_TX_EN
operator||
name|CMD_CFG_RX_EN
operator|)
expr_stmt|;
break|break;
default|default:
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|WRITE_UINT32
argument_list|(
name|p_MemMap
operator|->
name|cmd_conf_ctrl
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecSetPromiscuous
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|bool
name|newVal
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|t_TgecMemMap
modifier|*
name|p_TgecMemMap
decl_stmt|;
name|uint32_t
name|tmpReg32
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|p_TgecMemMap
operator|=
name|p_Tgec
operator|->
name|p_MemMap
expr_stmt|;
name|tmpReg32
operator|=
name|GET_UINT32
argument_list|(
name|p_TgecMemMap
operator|->
name|cmd_conf_ctrl
argument_list|)
expr_stmt|;
if|if
condition|(
name|newVal
condition|)
name|tmpReg32
operator||=
name|CMD_CFG_PROMIS_EN
expr_stmt|;
else|else
name|tmpReg32
operator|&=
operator|~
name|CMD_CFG_PROMIS_EN
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_TgecMemMap
operator|->
name|cmd_conf_ctrl
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*                      Tgec Configs modification functions                 */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecConfigLoopback
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|bool
name|newVal
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_NO_TGEC_LOOPBACK
block|{
name|t_FmRevisionInfo
name|revInfo
decl_stmt|;
name|FM_GetRevision
argument_list|(
name|p_Tgec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
operator|&
name|revInfo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|revInfo
operator|.
name|majorRev
operator|==
literal|1
operator|)
operator|&&
operator|(
name|revInfo
operator|.
name|minorRev
operator|==
literal|0
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"no loopback in this chip rev!"
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* FM_NO_TGEC_LOOPBACK */
name|p_Tgec
operator|->
name|p_TgecDriverParam
operator|->
name|loopbackEnable
operator|=
name|newVal
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecConfigWan
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|bool
name|newVal
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|p_TgecDriverParam
operator|->
name|wanModeEnable
operator|=
name|newVal
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecConfigMaxFrameLength
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|uint16_t
name|newVal
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|p_TgecDriverParam
operator|->
name|maxFrameLength
operator|=
name|newVal
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecConfigLengthCheck
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|bool
name|newVal
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|FM_LEN_CHECK_ERRATA_FMAN_SW002
name|UNUSED
argument_list|(
name|h_Tgec
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"LengthCheck!"
operator|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|UNUSED
argument_list|(
name|newVal
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|p_TgecDriverParam
operator|->
name|noLengthCheckEnable
operator|=
operator|!
name|newVal
expr_stmt|;
return|return
name|E_OK
return|;
endif|#
directive|endif
comment|/* FM_LEN_CHECK_ERRATA_FMAN_SW002 */
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecConfigException
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|e_FmMacExceptions
name|exception
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|uint32_t
name|bitMask
init|=
literal|0
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_10G_REM_N_LCL_FLT_EX_ERRATA_10GMAC001
block|{
name|t_FmRevisionInfo
name|revInfo
decl_stmt|;
name|FM_GetRevision
argument_list|(
name|p_Tgec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
operator|&
name|revInfo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|revInfo
operator|.
name|majorRev
operator|<=
literal|2
operator|)
operator|&&
name|enable
operator|&&
operator|(
operator|(
name|exception
operator|==
name|e_FM_MAC_EX_10G_LOC_FAULT
operator|)
operator|||
operator|(
name|exception
operator|==
name|e_FM_MAC_EX_10G_REM_FAULT
operator|)
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"e_FM_MAC_EX_10G_LOC_FAULT and e_FM_MAC_EX_10G_REM_FAULT !"
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* FM_10G_REM_N_LCL_FLT_EX_ERRATA_10GMAC001 */
name|GET_EXCEPTION_FLAG
argument_list|(
name|bitMask
argument_list|,
name|exception
argument_list|)
expr_stmt|;
if|if
condition|(
name|bitMask
condition|)
block|{
if|if
condition|(
name|enable
condition|)
name|p_Tgec
operator|->
name|exceptions
operator||=
name|bitMask
expr_stmt|;
else|else
name|p_Tgec
operator|->
name|exceptions
operator|&=
operator|~
name|bitMask
expr_stmt|;
block|}
else|else
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Undefined exception"
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|FM_TX_ECC_FRMS_ERRATA_10GMAC_A004
end_ifdef

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecConfigSkipFman11Workaround
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|p_TgecDriverParam
operator|->
name|skipFman11Workaround
operator|=
name|TRUE
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* FM_TX_ECC_FRMS_ERRATA_10GMAC_A004 */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*                      Tgec Run Time API functions                         */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecTxMacPause
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|uint16_t
name|pauseTime
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|uint32_t
name|ptv
init|=
literal|0
decl_stmt|;
name|t_TgecMemMap
modifier|*
name|p_MemMap
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_MemMap
operator|=
operator|(
name|t_TgecMemMap
operator|*
operator|)
operator|(
name|p_Tgec
operator|->
name|p_MemMap
operator|)
expr_stmt|;
name|ptv
operator|=
operator|(
name|uint32_t
operator|)
name|pauseTime
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_MemMap
operator|->
name|pause_quant
argument_list|,
name|ptv
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecRxIgnoreMacPause
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|bool
name|en
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|t_TgecMemMap
modifier|*
name|p_MemMap
decl_stmt|;
name|uint32_t
name|tmpReg32
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_MemMap
operator|=
operator|(
name|t_TgecMemMap
operator|*
operator|)
operator|(
name|p_Tgec
operator|->
name|p_MemMap
operator|)
expr_stmt|;
name|tmpReg32
operator|=
name|GET_UINT32
argument_list|(
name|p_MemMap
operator|->
name|cmd_conf_ctrl
argument_list|)
expr_stmt|;
if|if
condition|(
name|en
condition|)
name|tmpReg32
operator||=
name|CMD_CFG_PAUSE_IGNORE
expr_stmt|;
else|else
name|tmpReg32
operator|&=
operator|~
name|CMD_CFG_PAUSE_IGNORE
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_MemMap
operator|->
name|cmd_conf_ctrl
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* Counters handling */
end_comment

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecGetStatistics
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|t_FmMacStatistics
modifier|*
name|p_Statistics
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|t_TgecMemMap
modifier|*
name|p_TgecMemMap
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Statistics
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|p_TgecMemMap
operator|=
name|p_Tgec
operator|->
name|p_MemMap
expr_stmt|;
name|p_Statistics
operator|->
name|eStatPkts64
operator|=
name|GET_UINT64
argument_list|(
name|p_TgecMemMap
operator|->
name|R64
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|eStatPkts65to127
operator|=
name|GET_UINT64
argument_list|(
name|p_TgecMemMap
operator|->
name|R127
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|eStatPkts128to255
operator|=
name|GET_UINT64
argument_list|(
name|p_TgecMemMap
operator|->
name|R255
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|eStatPkts256to511
operator|=
name|GET_UINT64
argument_list|(
name|p_TgecMemMap
operator|->
name|R511
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|eStatPkts512to1023
operator|=
name|GET_UINT64
argument_list|(
name|p_TgecMemMap
operator|->
name|R1023
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|eStatPkts1024to1518
operator|=
name|GET_UINT64
argument_list|(
name|p_TgecMemMap
operator|->
name|R1518
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|eStatPkts1519to1522
operator|=
name|GET_UINT64
argument_list|(
name|p_TgecMemMap
operator|->
name|R1519X
argument_list|)
expr_stmt|;
comment|/* */
name|p_Statistics
operator|->
name|eStatFragments
operator|=
name|GET_UINT64
argument_list|(
name|p_TgecMemMap
operator|->
name|TRFRG
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|eStatJabbers
operator|=
name|GET_UINT64
argument_list|(
name|p_TgecMemMap
operator|->
name|TRJBR
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|eStatsDropEvents
operator|=
name|GET_UINT64
argument_list|(
name|p_TgecMemMap
operator|->
name|RDRP
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|eStatCRCAlignErrors
operator|=
name|GET_UINT64
argument_list|(
name|p_TgecMemMap
operator|->
name|RALN
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|eStatUndersizePkts
operator|=
name|GET_UINT64
argument_list|(
name|p_TgecMemMap
operator|->
name|TRUND
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|eStatOversizePkts
operator|=
name|GET_UINT64
argument_list|(
name|p_TgecMemMap
operator|->
name|TROVR
argument_list|)
expr_stmt|;
comment|/* Pause */
name|p_Statistics
operator|->
name|reStatPause
operator|=
name|GET_UINT64
argument_list|(
name|p_TgecMemMap
operator|->
name|RXPF
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|teStatPause
operator|=
name|GET_UINT64
argument_list|(
name|p_TgecMemMap
operator|->
name|TXPF
argument_list|)
expr_stmt|;
comment|/* MIB II */
name|p_Statistics
operator|->
name|ifInOctets
operator|=
name|GET_UINT64
argument_list|(
name|p_TgecMemMap
operator|->
name|ROCT
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|ifInMcastPkts
operator|=
name|GET_UINT64
argument_list|(
name|p_TgecMemMap
operator|->
name|RMCA
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|ifInBcastPkts
operator|=
name|GET_UINT64
argument_list|(
name|p_TgecMemMap
operator|->
name|RBCA
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|ifInPkts
operator|=
name|GET_UINT64
argument_list|(
name|p_TgecMemMap
operator|->
name|RUCA
argument_list|)
operator|+
name|p_Statistics
operator|->
name|ifInMcastPkts
operator|+
name|p_Statistics
operator|->
name|ifInBcastPkts
expr_stmt|;
name|p_Statistics
operator|->
name|ifInDiscards
operator|=
literal|0
expr_stmt|;
name|p_Statistics
operator|->
name|ifInErrors
operator|=
name|GET_UINT64
argument_list|(
name|p_TgecMemMap
operator|->
name|RERR
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|ifOutOctets
operator|=
name|GET_UINT64
argument_list|(
name|p_TgecMemMap
operator|->
name|TOCT
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|ifOutMcastPkts
operator|=
name|GET_UINT64
argument_list|(
name|p_TgecMemMap
operator|->
name|TMCA
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|ifOutBcastPkts
operator|=
name|GET_UINT64
argument_list|(
name|p_TgecMemMap
operator|->
name|TBCA
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|ifOutPkts
operator|=
name|GET_UINT64
argument_list|(
name|p_TgecMemMap
operator|->
name|TUCA
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|ifOutDiscards
operator|=
literal|0
expr_stmt|;
name|p_Statistics
operator|->
name|ifOutErrors
operator|=
name|GET_UINT64
argument_list|(
name|p_TgecMemMap
operator|->
name|TERR
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecEnable1588TimeStamp
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|t_TgecMemMap
modifier|*
name|p_TgecMemMap
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_TgecMemMap
operator|=
name|p_Tgec
operator|->
name|p_MemMap
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_TgecMemMap
operator|->
name|cmd_conf_ctrl
argument_list|,
name|GET_UINT32
argument_list|(
name|p_TgecMemMap
operator|->
name|cmd_conf_ctrl
argument_list|)
operator||
name|CMD_CFG_EN_TIMESTAMP
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecDisable1588TimeStamp
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|t_TgecMemMap
modifier|*
name|p_TgecMemMap
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_TgecMemMap
operator|=
name|p_Tgec
operator|->
name|p_MemMap
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_TgecMemMap
operator|->
name|cmd_conf_ctrl
argument_list|,
name|GET_UINT32
argument_list|(
name|p_TgecMemMap
operator|->
name|cmd_conf_ctrl
argument_list|)
operator|&
operator|~
name|CMD_CFG_EN_TIMESTAMP
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecModifyMacAddress
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|t_EnetAddr
modifier|*
name|p_EnetAddr
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|t_TgecMemMap
modifier|*
name|p_TgecMemMap
decl_stmt|;
name|uint32_t
name|tmpReg32
init|=
literal|0
decl_stmt|;
name|uint64_t
name|addr
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|p_TgecMemMap
operator|=
name|p_Tgec
operator|->
name|p_MemMap
expr_stmt|;
comment|/*  Initialize MAC Station Address registers (1& 2)    */
comment|/*  Station address have to be swapped (big endian to little endian */
name|addr
operator|=
operator|(
operator|(
operator|*
operator|(
name|uint64_t
operator|*
operator|)
name|p_EnetAddr
operator|)
operator|>>
literal|16
operator|)
expr_stmt|;
name|p_Tgec
operator|->
name|addr
operator|=
name|addr
expr_stmt|;
name|tmpReg32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|addr
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|SwapUint32P
argument_list|(
operator|&
name|tmpReg32
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_TgecMemMap
operator|->
name|mac_addr_0
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
name|tmpReg32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|SwapUint32P
argument_list|(
operator|&
name|tmpReg32
argument_list|)
expr_stmt|;
name|tmpReg32
operator|>>=
literal|16
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_TgecMemMap
operator|->
name|mac_addr_1
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecResetCounters
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|t_TgecMemMap
modifier|*
name|p_MemMap
decl_stmt|;
name|uint32_t
name|tmpReg32
decl_stmt|,
name|cmdConfCtrl
decl_stmt|;
name|int
name|i
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_MemMap
operator|=
operator|(
name|t_TgecMemMap
operator|*
operator|)
operator|(
name|p_Tgec
operator|->
name|p_MemMap
operator|)
expr_stmt|;
name|cmdConfCtrl
operator|=
name|GET_UINT32
argument_list|(
name|p_MemMap
operator|->
name|cmd_conf_ctrl
argument_list|)
expr_stmt|;
name|cmdConfCtrl
operator||=
name|CMD_CFG_STAT_CLR
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_MemMap
operator|->
name|cmd_conf_ctrl
argument_list|,
name|cmdConfCtrl
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|1000
condition|;
name|i
operator|++
control|)
block|{
name|tmpReg32
operator|=
name|GET_UINT32
argument_list|(
name|p_MemMap
operator|->
name|cmd_conf_ctrl
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tmpReg32
operator|&
name|CMD_CFG_STAT_CLR
operator|)
condition|)
break|break;
block|}
name|cmdConfCtrl
operator|&=
operator|~
name|CMD_CFG_STAT_CLR
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_MemMap
operator|->
name|cmd_conf_ctrl
argument_list|,
name|cmdConfCtrl
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecAddExactMatchMacAddress
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|t_EnetAddr
modifier|*
name|p_EthAddr
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|uint64_t
name|ethAddr
decl_stmt|;
name|uint8_t
name|paddrNum
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|ethAddr
operator|=
operator|(
operator|(
operator|*
operator|(
name|uint64_t
operator|*
operator|)
name|p_EthAddr
operator|)
operator|>>
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|ethAddr
operator|&
name|GROUP_ADDRESS
condition|)
comment|/* Multicast address has no effect in PADDR */
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Multicast address"
operator|)
argument_list|)
expr_stmt|;
comment|/* Make sure no PADDR contains this address */
for|for
control|(
name|paddrNum
operator|=
literal|0
init|;
name|paddrNum
operator|<
name|TGEC_NUM_OF_PADDRS
condition|;
name|paddrNum
operator|++
control|)
block|{
if|if
condition|(
name|p_Tgec
operator|->
name|indAddrRegUsed
index|[
name|paddrNum
index|]
condition|)
block|{
if|if
condition|(
name|p_Tgec
operator|->
name|paddr
index|[
name|paddrNum
index|]
operator|==
name|ethAddr
condition|)
block|{
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_ALREADY_EXISTS
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* Find first unused PADDR */
for|for
control|(
name|paddrNum
operator|=
literal|0
init|;
name|paddrNum
operator|<
name|TGEC_NUM_OF_PADDRS
condition|;
name|paddrNum
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|p_Tgec
operator|->
name|indAddrRegUsed
index|[
name|paddrNum
index|]
operator|)
condition|)
block|{
comment|/* mark this PADDR as used */
name|p_Tgec
operator|->
name|indAddrRegUsed
index|[
name|paddrNum
index|]
operator|=
name|TRUE
expr_stmt|;
comment|/* store address */
name|p_Tgec
operator|->
name|paddr
index|[
name|paddrNum
index|]
operator|=
name|ethAddr
expr_stmt|;
comment|/* put in hardware */
name|HardwareAddAddrInPaddr
argument_list|(
name|p_Tgec
argument_list|,
operator|&
name|ethAddr
argument_list|,
name|paddrNum
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|numOfIndAddrInRegs
operator|++
expr_stmt|;
return|return
name|E_OK
return|;
block|}
block|}
comment|/* No free PADDR */
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_FULL
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecDelExactMatchMacAddress
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|t_EnetAddr
modifier|*
name|p_EthAddr
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|uint64_t
name|ethAddr
decl_stmt|;
name|uint8_t
name|paddrNum
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|ethAddr
operator|=
operator|(
operator|(
operator|*
operator|(
name|uint64_t
operator|*
operator|)
name|p_EthAddr
operator|)
operator|>>
literal|16
operator|)
expr_stmt|;
comment|/* Find used PADDR containing this address */
for|for
control|(
name|paddrNum
operator|=
literal|0
init|;
name|paddrNum
operator|<
name|TGEC_NUM_OF_PADDRS
condition|;
name|paddrNum
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|p_Tgec
operator|->
name|indAddrRegUsed
index|[
name|paddrNum
index|]
operator|)
operator|&&
operator|(
name|p_Tgec
operator|->
name|paddr
index|[
name|paddrNum
index|]
operator|==
name|ethAddr
operator|)
condition|)
block|{
comment|/* mark this PADDR as not used */
name|p_Tgec
operator|->
name|indAddrRegUsed
index|[
name|paddrNum
index|]
operator|=
name|FALSE
expr_stmt|;
comment|/* clear in hardware */
name|HardwareClearAddrInPaddr
argument_list|(
name|p_Tgec
argument_list|,
name|paddrNum
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|numOfIndAddrInRegs
operator|--
expr_stmt|;
return|return
name|E_OK
return|;
block|}
block|}
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_FOUND
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecAddHashMacAddress
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|t_EnetAddr
modifier|*
name|p_EthAddr
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|t_TgecMemMap
modifier|*
name|p_TgecMemMap
decl_stmt|;
name|t_EthHashEntry
modifier|*
name|p_HashEntry
decl_stmt|;
name|uint32_t
name|crc
decl_stmt|;
name|uint32_t
name|hash
decl_stmt|;
name|uint64_t
name|ethAddr
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|p_TgecMemMap
operator|=
name|p_Tgec
operator|->
name|p_MemMap
expr_stmt|;
name|ethAddr
operator|=
operator|(
operator|(
operator|*
operator|(
name|uint64_t
operator|*
operator|)
name|p_EthAddr
operator|)
operator|>>
literal|16
operator|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ethAddr
operator|&
name|GROUP_ADDRESS
operator|)
condition|)
comment|/* Unicast addresses not supported in hash */
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"Unicast Address"
operator|)
argument_list|)
expr_stmt|;
comment|/* CRC calculation */
name|GET_MAC_ADDR_CRC
argument_list|(
name|ethAddr
argument_list|,
name|crc
argument_list|)
expr_stmt|;
name|crc
operator|=
name|MIRROR_32
argument_list|(
name|crc
argument_list|)
expr_stmt|;
name|hash
operator|=
operator|(
name|crc
operator|>>
name|HASH_CTRL_MCAST_SHIFT
operator|)
operator|&
name|HASH_ADDR_MASK
expr_stmt|;
comment|/* Take 9 MSB bits */
comment|/* Create element to be added to the driver hash table */
name|p_HashEntry
operator|=
operator|(
name|t_EthHashEntry
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|t_EthHashEntry
argument_list|)
argument_list|)
expr_stmt|;
name|p_HashEntry
operator|->
name|addr
operator|=
name|ethAddr
expr_stmt|;
name|INIT_LIST
argument_list|(
operator|&
name|p_HashEntry
operator|->
name|node
argument_list|)
expr_stmt|;
name|LIST_AddToTail
argument_list|(
operator|&
operator|(
name|p_HashEntry
operator|->
name|node
operator|)
argument_list|,
operator|&
operator|(
name|p_Tgec
operator|->
name|p_MulticastAddrHash
operator|->
name|p_Lsts
index|[
name|hash
index|]
operator|)
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_TgecMemMap
operator|->
name|hashtable_ctrl
argument_list|,
operator|(
name|hash
operator||
name|HASH_CTRL_MCAST_EN
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecDelHashMacAddress
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|t_EnetAddr
modifier|*
name|p_EthAddr
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|t_TgecMemMap
modifier|*
name|p_TgecMemMap
decl_stmt|;
name|t_EthHashEntry
modifier|*
name|p_HashEntry
init|=
name|NULL
decl_stmt|;
name|t_List
modifier|*
name|p_Pos
decl_stmt|;
name|uint32_t
name|crc
decl_stmt|;
name|uint32_t
name|hash
decl_stmt|;
name|uint64_t
name|ethAddr
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|p_TgecMemMap
operator|=
name|p_Tgec
operator|->
name|p_MemMap
expr_stmt|;
name|ethAddr
operator|=
operator|(
operator|(
operator|*
operator|(
name|uint64_t
operator|*
operator|)
name|p_EthAddr
operator|)
operator|>>
literal|16
operator|)
expr_stmt|;
comment|/* CRC calculation */
name|GET_MAC_ADDR_CRC
argument_list|(
name|ethAddr
argument_list|,
name|crc
argument_list|)
expr_stmt|;
name|crc
operator|=
name|MIRROR_32
argument_list|(
name|crc
argument_list|)
expr_stmt|;
name|hash
operator|=
operator|(
name|crc
operator|>>
name|HASH_CTRL_MCAST_SHIFT
operator|)
operator|&
name|HASH_ADDR_MASK
expr_stmt|;
comment|/* Take 9 MSB bits */
name|LIST_FOR_EACH
argument_list|(
argument|p_Pos
argument_list|,
argument|&(p_Tgec->p_MulticastAddrHash->p_Lsts[hash])
argument_list|)
block|{
name|p_HashEntry
operator|=
name|ETH_HASH_ENTRY_OBJ
argument_list|(
name|p_Pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_HashEntry
operator|->
name|addr
operator|==
name|ethAddr
condition|)
block|{
name|LIST_DelAndInit
argument_list|(
operator|&
name|p_HashEntry
operator|->
name|node
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_HashEntry
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|LIST_IsEmpty
argument_list|(
operator|&
name|p_Tgec
operator|->
name|p_MulticastAddrHash
operator|->
name|p_Lsts
index|[
name|hash
index|]
argument_list|)
condition|)
name|WRITE_UINT32
argument_list|(
name|p_TgecMemMap
operator|->
name|hashtable_ctrl
argument_list|,
operator|(
name|hash
operator|&
operator|~
name|HASH_CTRL_MCAST_EN
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecGetId
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|uint32_t
modifier|*
name|macId
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|p_Tgec
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|macId
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"TgecGetId Not Supported"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecGetVersion
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|uint32_t
modifier|*
name|macVersion
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|t_TgecMemMap
modifier|*
name|p_TgecMemMap
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|p_TgecMemMap
operator|=
name|p_Tgec
operator|->
name|p_MemMap
expr_stmt|;
operator|*
name|macVersion
operator|=
name|GET_UINT32
argument_list|(
name|p_TgecMemMap
operator|->
name|tgec_id
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecSetExcpetion
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|e_FmMacExceptions
name|exception
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|uint32_t
name|bitMask
init|=
literal|0
decl_stmt|,
name|tmpReg
decl_stmt|;
name|t_TgecMemMap
modifier|*
name|p_TgecMemMap
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|p_TgecMemMap
operator|=
name|p_Tgec
operator|->
name|p_MemMap
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_10G_REM_N_LCL_FLT_EX_ERRATA_10GMAC001
block|{
name|t_FmRevisionInfo
name|revInfo
decl_stmt|;
name|FM_GetRevision
argument_list|(
name|p_Tgec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
operator|&
name|revInfo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|revInfo
operator|.
name|majorRev
operator|<=
literal|2
operator|)
operator|&&
name|enable
operator|&&
operator|(
operator|(
name|exception
operator|==
name|e_FM_MAC_EX_10G_LOC_FAULT
operator|)
operator|||
operator|(
name|exception
operator|==
name|e_FM_MAC_EX_10G_REM_FAULT
operator|)
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"e_FM_MAC_EX_10G_LOC_FAULT and e_FM_MAC_EX_10G_REM_FAULT !"
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* FM_10G_REM_N_LCL_FLT_EX_ERRATA_10GMAC001 */
name|GET_EXCEPTION_FLAG
argument_list|(
name|bitMask
argument_list|,
name|exception
argument_list|)
expr_stmt|;
if|if
condition|(
name|bitMask
condition|)
block|{
if|if
condition|(
name|enable
condition|)
name|p_Tgec
operator|->
name|exceptions
operator||=
name|bitMask
expr_stmt|;
else|else
name|p_Tgec
operator|->
name|exceptions
operator|&=
operator|~
name|bitMask
expr_stmt|;
block|}
else|else
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Undefined exception"
operator|)
argument_list|)
expr_stmt|;
name|tmpReg
operator|=
name|GET_UINT32
argument_list|(
name|p_TgecMemMap
operator|->
name|imask
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
condition|)
name|tmpReg
operator||=
name|bitMask
expr_stmt|;
else|else
name|tmpReg
operator|&=
operator|~
name|bitMask
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_TgecMemMap
operator|->
name|imask
argument_list|,
name|tmpReg
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|uint16_t
name|TgecGetMaxFrameLength
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|uint16_t
operator|)
name|GET_UINT32
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
operator|->
name|maxfrm
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|FM_TX_ECC_FRMS_ERRATA_10GMAC_A004
end_ifdef

begin_function
specifier|static
name|t_Error
name|TgecTxEccWorkaround
parameter_list|(
name|t_Tgec
modifier|*
name|p_Tgec
parameter_list|)
block|{
name|t_Error
name|err
decl_stmt|;
name|XX_Print
argument_list|(
literal|"Applying 10G tx-ecc error workaround (10GMAC-A004) ..."
argument_list|)
expr_stmt|;
comment|/* enable and set promiscuous */
name|WRITE_UINT32
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
operator|->
name|cmd_conf_ctrl
argument_list|,
name|CMD_CFG_PROMIS_EN
operator||
name|CMD_CFG_TX_EN
operator||
name|CMD_CFG_RX_EN
argument_list|)
expr_stmt|;
name|err
operator|=
name|Fm10GTxEccWorkaround
argument_list|(
name|p_Tgec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
name|p_Tgec
operator|->
name|macId
argument_list|)
expr_stmt|;
comment|/* disable */
name|WRITE_UINT32
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
operator|->
name|cmd_conf_ctrl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|XX_Print
argument_list|(
literal|"FAILED!\n"
argument_list|)
expr_stmt|;
else|else
name|XX_Print
argument_list|(
literal|"done.\n"
argument_list|)
expr_stmt|;
name|TgecResetCounters
argument_list|(
name|p_Tgec
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* FM_TX_ECC_FRMS_ERRATA_10GMAC_A004 */
end_comment

begin_comment
comment|/* .............................................................................. */
end_comment

begin_if
if|#
directive|if
operator|(
name|defined
argument_list|(
name|DEBUG_ERRORS
argument_list|)
operator|&&
operator|(
name|DEBUG_ERRORS
operator|>
literal|0
operator|)
operator|)
end_if

begin_function
specifier|static
name|t_Error
name|TgecDumpRegs
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|DECLARE_DUMP
expr_stmt|;
if|if
condition|(
name|p_Tgec
operator|->
name|p_MemMap
condition|)
block|{
name|DUMP_TITLE
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
operator|(
literal|"10G MAC %d: "
operator|,
name|p_Tgec
operator|->
name|macId
operator|)
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|tgec_id
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|scratch
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|cmd_conf_ctrl
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|mac_addr_0
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|mac_addr_1
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|maxfrm
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|pause_quant
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|rx_fifo_sections
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|tx_fifo_sections
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|rx_fifo_almost_f_e
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|tx_fifo_almost_f_e
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|hashtable_ctrl
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|mdio_cfg_status
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|mdio_command
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|mdio_data
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|mdio_regaddr
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|tx_ipg_len
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|mac_addr_2
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|mac_addr_3
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|rx_fifo_ptr_rd
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|rx_fifo_ptr_wr
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|tx_fifo_ptr_rd
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|tx_fifo_ptr_wr
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|imask
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|ievent
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|udp_port
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|type_1588v2
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* (defined(DEBUG_ERRORS)&& ... */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*                      FM Init& Free API                                   */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecInit
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|t_TgecDriverParam
modifier|*
name|p_TgecDriverParam
decl_stmt|;
name|t_TgecMemMap
modifier|*
name|p_MemMap
decl_stmt|;
name|uint64_t
name|addr
decl_stmt|;
name|uint32_t
name|tmpReg32
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_TX_ECC_FRMS_ERRATA_10GMAC_A004
if|if
condition|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
operator|->
name|skipFman11Workaround
operator|&&
operator|(
operator|(
name|err
operator|=
name|TgecTxEccWorkaround
argument_list|(
name|p_Tgec
argument_list|)
operator|)
operator|!=
name|E_OK
operator|)
condition|)
ifdef|#
directive|ifdef
name|NCSW_LINUX
block|{
comment|/* the workaround fails in simics, just report and continue initialization */
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
operator|(
literal|"TgecTxEccWorkaround FAILED, skipping workaround"
operator|)
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
block|{
name|FreeInitResources
argument_list|(
name|p_Tgec
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
operator|(
literal|"TgecTxEccWorkaround FAILED"
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|#
directive|endif
comment|/* FM_TX_ECC_FRMS_ERRATA_10GMAC_A004 */
name|CHECK_INIT_PARAMETERS
argument_list|(
name|p_Tgec
argument_list|,
name|CheckInitParameters
argument_list|)
expr_stmt|;
name|p_TgecDriverParam
operator|=
name|p_Tgec
operator|->
name|p_TgecDriverParam
expr_stmt|;
name|p_MemMap
operator|=
name|p_Tgec
operator|->
name|p_MemMap
expr_stmt|;
comment|/* MAC Address */
name|addr
operator|=
name|p_Tgec
operator|->
name|addr
expr_stmt|;
name|tmpReg32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|addr
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|SwapUint32P
argument_list|(
operator|&
name|tmpReg32
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_MemMap
operator|->
name|mac_addr_0
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
name|tmpReg32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|SwapUint32P
argument_list|(
operator|&
name|tmpReg32
argument_list|)
expr_stmt|;
name|tmpReg32
operator|>>=
literal|16
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_MemMap
operator|->
name|mac_addr_1
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
comment|/* Config */
name|tmpReg32
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|p_TgecDriverParam
operator|->
name|wanModeEnable
condition|)
name|tmpReg32
operator||=
name|CMD_CFG_WAN_MODE
expr_stmt|;
if|if
condition|(
name|p_TgecDriverParam
operator|->
name|promiscuousModeEnable
condition|)
name|tmpReg32
operator||=
name|CMD_CFG_PROMIS_EN
expr_stmt|;
if|if
condition|(
name|p_TgecDriverParam
operator|->
name|pauseForwardEnable
condition|)
name|tmpReg32
operator||=
name|CMD_CFG_PAUSE_FWD
expr_stmt|;
if|if
condition|(
name|p_TgecDriverParam
operator|->
name|pauseIgnore
condition|)
name|tmpReg32
operator||=
name|CMD_CFG_PAUSE_IGNORE
expr_stmt|;
if|if
condition|(
name|p_TgecDriverParam
operator|->
name|txAddrInsEnable
condition|)
name|tmpReg32
operator||=
name|CMD_CFG_TX_ADDR_INS
expr_stmt|;
if|if
condition|(
name|p_TgecDriverParam
operator|->
name|loopbackEnable
condition|)
name|tmpReg32
operator||=
name|CMD_CFG_LOOPBACK_EN
expr_stmt|;
if|if
condition|(
name|p_TgecDriverParam
operator|->
name|cmdFrameEnable
condition|)
name|tmpReg32
operator||=
name|CMD_CFG_CMD_FRM_EN
expr_stmt|;
if|if
condition|(
name|p_TgecDriverParam
operator|->
name|rxErrorDiscard
condition|)
name|tmpReg32
operator||=
name|CMD_CFG_RX_ER_DISC
expr_stmt|;
if|if
condition|(
name|p_TgecDriverParam
operator|->
name|phyTxenaOn
condition|)
name|tmpReg32
operator||=
name|CMD_CFG_PHY_TX_EN
expr_stmt|;
if|if
condition|(
name|p_TgecDriverParam
operator|->
name|sendIdleEnable
condition|)
name|tmpReg32
operator||=
name|CMD_CFG_SEND_IDLE
expr_stmt|;
if|if
condition|(
name|p_TgecDriverParam
operator|->
name|noLengthCheckEnable
condition|)
name|tmpReg32
operator||=
name|CMD_CFG_NO_LEN_CHK
expr_stmt|;
if|if
condition|(
name|p_TgecDriverParam
operator|->
name|lgthCheckNostdr
condition|)
name|tmpReg32
operator||=
name|CMD_CFG_LEN_CHK_NOSTDR
expr_stmt|;
if|if
condition|(
name|p_TgecDriverParam
operator|->
name|timeStampEnable
condition|)
name|tmpReg32
operator||=
name|CMD_CFG_EN_TIMESTAMP
expr_stmt|;
if|if
condition|(
name|p_TgecDriverParam
operator|->
name|rxSfdAny
condition|)
name|tmpReg32
operator||=
name|RX_SFD_ANY
expr_stmt|;
if|if
condition|(
name|p_TgecDriverParam
operator|->
name|rxPblFwd
condition|)
name|tmpReg32
operator||=
name|CMD_CFG_RX_PBL_FWD
expr_stmt|;
if|if
condition|(
name|p_TgecDriverParam
operator|->
name|txPblFwd
condition|)
name|tmpReg32
operator||=
name|CMD_CFG_TX_PBL_FWD
expr_stmt|;
name|tmpReg32
operator||=
literal|0x40
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_MemMap
operator|->
name|cmd_conf_ctrl
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
comment|/* Max Frame Length */
name|WRITE_UINT32
argument_list|(
name|p_MemMap
operator|->
name|maxfrm
argument_list|,
operator|(
name|uint32_t
operator|)
name|p_TgecDriverParam
operator|->
name|maxFrameLength
argument_list|)
expr_stmt|;
name|err
operator|=
name|FmSetMacMaxFrame
argument_list|(
name|p_Tgec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
name|e_FM_MAC_10G
argument_list|,
name|p_Tgec
operator|->
name|fmMacControllerDriver
operator|.
name|macId
argument_list|,
name|p_TgecDriverParam
operator|->
name|maxFrameLength
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|FreeInitResources
argument_list|(
name|p_Tgec
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
comment|/* Pause Time */
name|WRITE_UINT32
argument_list|(
name|p_MemMap
operator|->
name|pause_quant
argument_list|,
name|p_TgecDriverParam
operator|->
name|pauseTime
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_TX_FIFO_CORRUPTION_ERRATA_10GMAC_A007
name|WRITE_UINT32
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
operator|->
name|tx_ipg_len
argument_list|,
operator|(
name|GET_UINT32
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
operator|->
name|tx_ipg_len
argument_list|)
operator|&
operator|~
name|TX_IPG_LENGTH_MASK
operator|)
operator||
name|DEFAULT_txIpgLength
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* FM_TX_FIFO_CORRUPTION_ERRATA_10GMAC_A007 */
comment|/* Configure MII */
name|tmpReg32
operator|=
name|GET_UINT32
argument_list|(
name|p_Tgec
operator|->
name|p_MiiMemMap
operator|->
name|mdio_cfg_status
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_10G_MDIO_HOLD_ERRATA_XAUI3
block|{
name|t_FmRevisionInfo
name|revInfo
decl_stmt|;
name|FM_GetRevision
argument_list|(
name|p_Tgec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
operator|&
name|revInfo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|revInfo
operator|.
name|majorRev
operator|==
literal|1
operator|)
operator|&&
operator|(
name|revInfo
operator|.
name|minorRev
operator|==
literal|0
operator|)
condition|)
name|tmpReg32
operator||=
operator|(
name|MIIMCOM_MDIO_HOLD_4_REG_CLK
operator|<<
literal|2
operator|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* FM_10G_MDIO_HOLD_ERRATA_XAUI3 */
name|tmpReg32
operator|&=
operator|~
name|MIIMCOM_DIV_MASK
expr_stmt|;
comment|/* (one half of fm clock => 2.5Mhz) */
name|tmpReg32
operator||=
operator|(
operator|(
operator|(
operator|(
name|p_Tgec
operator|->
name|fmMacControllerDriver
operator|.
name|clkFreq
operator|*
literal|10
operator|)
operator|/
literal|2
operator|)
operator|/
literal|25
operator|)
operator|<<
name|MIIMCOM_DIV_SHIFT
operator|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Tgec
operator|->
name|p_MiiMemMap
operator|->
name|mdio_cfg_status
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|p_MulticastAddrHash
operator|=
name|AllocHashTable
argument_list|(
name|HASH_TABLE_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Tgec
operator|->
name|p_MulticastAddrHash
condition|)
block|{
name|FreeInitResources
argument_list|(
name|p_Tgec
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"allocation hash table is FAILED"
operator|)
argument_list|)
expr_stmt|;
block|}
name|p_Tgec
operator|->
name|p_UnicastAddrHash
operator|=
name|AllocHashTable
argument_list|(
name|HASH_TABLE_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Tgec
operator|->
name|p_UnicastAddrHash
condition|)
block|{
name|FreeInitResources
argument_list|(
name|p_Tgec
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"allocation hash table is FAILED"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* interrupts */
ifdef|#
directive|ifdef
name|FM_10G_REM_N_LCL_FLT_EX_ERRATA_10GMAC001
block|{
name|t_FmRevisionInfo
name|revInfo
decl_stmt|;
name|FM_GetRevision
argument_list|(
name|p_Tgec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
operator|&
name|revInfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|revInfo
operator|.
name|majorRev
operator|<=
literal|2
condition|)
name|p_Tgec
operator|->
name|exceptions
operator|&=
operator|~
operator|(
name|IMASK_REM_FAULT
operator||
name|IMASK_LOC_FAULT
operator|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* FM_10G_REM_N_LCL_FLT_EX_ERRATA_10GMAC001 */
name|WRITE_UINT32
argument_list|(
name|p_MemMap
operator|->
name|ievent
argument_list|,
name|EVENTS_MASK
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_MemMap
operator|->
name|imask
argument_list|,
name|p_Tgec
operator|->
name|exceptions
argument_list|)
expr_stmt|;
name|FmRegisterIntr
argument_list|(
name|p_Tgec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
name|e_FM_MOD_10G_MAC
argument_list|,
name|p_Tgec
operator|->
name|macId
argument_list|,
name|e_FM_INTR_TYPE_ERR
argument_list|,
name|TgecErrException
argument_list|,
name|p_Tgec
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Tgec
operator|->
name|mdioIrq
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|p_Tgec
operator|->
name|mdioIrq
operator|!=
name|NO_IRQ
operator|)
condition|)
block|{
name|XX_SetIntr
argument_list|(
name|p_Tgec
operator|->
name|mdioIrq
argument_list|,
name|TgecException
argument_list|,
name|p_Tgec
argument_list|)
expr_stmt|;
name|XX_EnableIntr
argument_list|(
name|p_Tgec
operator|->
name|mdioIrq
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p_Tgec
operator|->
name|mdioIrq
operator|==
literal|0
condition|)
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
name|NO_MSG
operator|)
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_TgecDriverParam
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|p_TgecDriverParam
operator|=
name|NULL
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecFree
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|FreeInitResources
argument_list|(
name|p_Tgec
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Tgec
operator|->
name|p_TgecDriverParam
condition|)
block|{
name|XX_Free
argument_list|(
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|p_TgecDriverParam
operator|=
name|NULL
expr_stmt|;
block|}
name|XX_Free
argument_list|(
name|p_Tgec
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|void
name|InitFmMacControllerDriver
parameter_list|(
name|t_FmMacControllerDriver
modifier|*
name|p_FmMacControllerDriver
parameter_list|)
block|{
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_Init
operator|=
name|TgecInit
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_Free
operator|=
name|TgecFree
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigLoopback
operator|=
name|TgecConfigLoopback
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigMaxFrameLength
operator|=
name|TgecConfigMaxFrameLength
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigWan
operator|=
name|TgecConfigWan
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigPadAndCrc
operator|=
name|NULL
expr_stmt|;
comment|/* TGEC always works with pad+crc */
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigHalfDuplex
operator|=
name|NULL
expr_stmt|;
comment|/* half-duplex is not supported in xgec */
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigLengthCheck
operator|=
name|TgecConfigLengthCheck
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigException
operator|=
name|TgecConfigException
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_TX_ECC_FRMS_ERRATA_10GMAC_A004
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigSkipFman11Workaround
operator|=
name|TgecConfigSkipFman11Workaround
expr_stmt|;
endif|#
directive|endif
comment|/* FM_TX_ECC_FRMS_ERRATA_10GMAC_A004 */
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_SetException
operator|=
name|TgecSetExcpetion
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_Enable1588TimeStamp
operator|=
name|TgecEnable1588TimeStamp
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_Disable1588TimeStamp
operator|=
name|TgecDisable1588TimeStamp
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_SetPromiscuous
operator|=
name|TgecSetPromiscuous
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_AdjustLink
operator|=
name|NULL
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_Enable
operator|=
name|TgecEnable
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_Disable
operator|=
name|TgecDisable
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_SetTxAutoPauseFrames
operator|=
name|TgecTxMacPause
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_SetRxIgnorePauseFrames
operator|=
name|TgecRxIgnoreMacPause
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ResetCounters
operator|=
name|TgecResetCounters
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_GetStatistics
operator|=
name|TgecGetStatistics
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ModifyMacAddr
operator|=
name|TgecModifyMacAddress
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_AddHashMacAddr
operator|=
name|TgecAddHashMacAddress
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_RemoveHashMacAddr
operator|=
name|TgecDelHashMacAddress
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_AddExactMatchMacAddr
operator|=
name|TgecAddExactMatchMacAddress
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_RemovelExactMatchMacAddr
operator|=
name|TgecDelExactMatchMacAddress
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_GetId
operator|=
name|TgecGetId
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_GetVersion
operator|=
name|TgecGetVersion
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_GetMaxFrameLength
operator|=
name|TgecGetMaxFrameLength
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_MII_WritePhyReg
operator|=
name|TGEC_MII_WritePhyReg
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_MII_ReadPhyReg
operator|=
name|TGEC_MII_ReadPhyReg
expr_stmt|;
if|#
directive|if
operator|(
name|defined
argument_list|(
name|DEBUG_ERRORS
argument_list|)
operator|&&
operator|(
name|DEBUG_ERRORS
operator|>
literal|0
operator|)
operator|)
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_DumpRegs
operator|=
name|TgecDumpRegs
expr_stmt|;
endif|#
directive|endif
comment|/* (defined(DEBUG_ERRORS)&& ... */
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*                      Tgec Config  Main Entry                             */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
name|t_Handle
name|TGEC_Config
parameter_list|(
name|t_FmMacParams
modifier|*
name|p_FmMacParam
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
decl_stmt|;
name|t_TgecDriverParam
modifier|*
name|p_TgecDriverParam
decl_stmt|;
name|uintptr_t
name|baseAddr
decl_stmt|;
name|uint8_t
name|i
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_FmMacParam
argument_list|,
name|E_NULL_POINTER
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|baseAddr
operator|=
name|p_FmMacParam
operator|->
name|baseAddr
expr_stmt|;
comment|/* allocate memory for the UCC GETH data structure. */
name|p_Tgec
operator|=
operator|(
name|t_Tgec
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|t_Tgec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Tgec
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"10G MAC driver structure"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* Zero out * p_Tgec */
name|memset
argument_list|(
name|p_Tgec
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_Tgec
argument_list|)
argument_list|)
expr_stmt|;
name|InitFmMacControllerDriver
argument_list|(
operator|&
name|p_Tgec
operator|->
name|fmMacControllerDriver
argument_list|)
expr_stmt|;
comment|/* allocate memory for the 10G MAC driver parameters data structure. */
name|p_TgecDriverParam
operator|=
operator|(
name|t_TgecDriverParam
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|t_TgecDriverParam
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_TgecDriverParam
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"10G MAC driver parameters"
operator|)
argument_list|)
expr_stmt|;
name|TgecFree
argument_list|(
name|p_Tgec
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* Zero out */
name|memset
argument_list|(
name|p_TgecDriverParam
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_TgecDriverParam
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Plant parameter structure pointer */
name|p_Tgec
operator|->
name|p_TgecDriverParam
operator|=
name|p_TgecDriverParam
expr_stmt|;
name|SetDefaultParam
argument_list|(
name|p_TgecDriverParam
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|p_FmMacParam
operator|->
name|addr
argument_list|)
condition|;
name|i
operator|++
control|)
name|p_Tgec
operator|->
name|addr
operator||=
operator|(
operator|(
name|uint64_t
operator|)
name|p_FmMacParam
operator|->
name|addr
index|[
name|i
index|]
operator|<<
operator|(
operator|(
literal|5
operator|-
name|i
operator|)
operator|*
literal|8
operator|)
operator|)
expr_stmt|;
name|p_Tgec
operator|->
name|p_MemMap
operator|=
operator|(
name|t_TgecMemMap
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|baseAddr
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|p_MiiMemMap
operator|=
operator|(
name|t_TgecMiiAccessMemMap
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|baseAddr
operator|+
name|TGEC_TO_MII_OFFSET
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|enetMode
operator|=
name|p_FmMacParam
operator|->
name|enetMode
expr_stmt|;
name|p_Tgec
operator|->
name|macId
operator|=
name|p_FmMacParam
operator|->
name|macId
expr_stmt|;
name|p_Tgec
operator|->
name|exceptions
operator|=
name|DEFAULT_exceptions
expr_stmt|;
name|p_Tgec
operator|->
name|mdioIrq
operator|=
name|p_FmMacParam
operator|->
name|mdioIrq
expr_stmt|;
name|p_Tgec
operator|->
name|f_Exception
operator|=
name|p_FmMacParam
operator|->
name|f_Exception
expr_stmt|;
name|p_Tgec
operator|->
name|f_Event
operator|=
name|p_FmMacParam
operator|->
name|f_Event
expr_stmt|;
name|p_Tgec
operator|->
name|h_App
operator|=
name|p_FmMacParam
operator|->
name|h_App
expr_stmt|;
return|return
name|p_Tgec
return|;
block|}
end_function

end_unit


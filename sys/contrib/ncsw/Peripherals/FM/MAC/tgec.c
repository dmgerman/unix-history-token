begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2008-2012 Freescale Semiconductor Inc.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are met:  *     * Redistributions of source code must retain the above copyright  *       notice, this list of conditions and the following disclaimer.  *     * Redistributions in binary form must reproduce the above copyright  *       notice, this list of conditions and the following disclaimer in the  *       documentation and/or other materials provided with the distribution.  *     * Neither the name of Freescale Semiconductor nor the  *       names of its contributors may be used to endorse or promote products  *       derived from this software without specific prior written permission.  *  *  * ALTERNATIVELY, this software may be distributed under the terms of the  * GNU General Public License ("GPL") as published by the Free Software  * Foundation, either version 2 of that License or (at your option) any  * later version.  *  * THIS SOFTWARE IS PROVIDED BY Freescale Semiconductor ``AS IS'' AND ANY  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED. IN NO EVENT SHALL Freescale Semiconductor BE LIABLE FOR ANY  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/******************************************************************************  @File          tgec.c   @Description   FM 10G MAC ... */
end_comment

begin_comment
comment|/***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|"std_ext.h"
end_include

begin_include
include|#
directive|include
file|"string_ext.h"
end_include

begin_include
include|#
directive|include
file|"error_ext.h"
end_include

begin_include
include|#
directive|include
file|"xx_ext.h"
end_include

begin_include
include|#
directive|include
file|"endian_ext.h"
end_include

begin_include
include|#
directive|include
file|"debug_ext.h"
end_include

begin_include
include|#
directive|include
file|"crc_mac_addr_ext.h"
end_include

begin_include
include|#
directive|include
file|"fm_common.h"
end_include

begin_include
include|#
directive|include
file|"fsl_fman_tgec.h"
end_include

begin_include
include|#
directive|include
file|"tgec.h"
end_include

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*                      Internal routines                                    */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
specifier|static
name|t_Error
name|CheckInitParameters
parameter_list|(
name|t_Tgec
modifier|*
name|p_Tgec
parameter_list|)
block|{
if|if
condition|(
name|ENET_SPEED_FROM_MODE
argument_list|(
name|p_Tgec
operator|->
name|enetMode
argument_list|)
operator|<
name|e_ENET_SPEED_10000
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Ethernet 10G MAC driver only support 10G speed"
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|FM_MAX_NUM_OF_10G_MACS
operator|>
literal|0
operator|)
if|if
condition|(
name|p_Tgec
operator|->
name|macId
operator|>=
name|FM_MAX_NUM_OF_10G_MACS
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"macId of 10G can not be greater than 0"
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* (FM_MAX_NUM_OF_10G_MACS> 0) */
if|if
condition|(
name|p_Tgec
operator|->
name|addr
operator|==
literal|0
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Ethernet 10G MAC Must have a valid MAC Address"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Tgec
operator|->
name|f_Exception
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"uninitialized f_Exception"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Tgec
operator|->
name|f_Event
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"uninitialized f_Event"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_LEN_CHECK_ERRATA_FMAN_SW002
if|if
condition|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
operator|->
name|no_length_check_enable
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"LengthCheck!"
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* FM_LEN_CHECK_ERRATA_FMAN_SW002 */
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|uint32_t
name|GetMacAddrHashCode
parameter_list|(
name|uint64_t
name|ethAddr
parameter_list|)
block|{
name|uint32_t
name|crc
decl_stmt|;
comment|/* CRC calculation */
name|GET_MAC_ADDR_CRC
argument_list|(
name|ethAddr
argument_list|,
name|crc
argument_list|)
expr_stmt|;
name|crc
operator|=
name|GetMirror32
argument_list|(
name|crc
argument_list|)
expr_stmt|;
return|return
name|crc
return|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|void
name|TgecErrException
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|uint32_t
name|event
decl_stmt|;
name|struct
name|tgec_regs
modifier|*
name|p_TgecMemMap
init|=
name|p_Tgec
operator|->
name|p_MemMap
decl_stmt|;
comment|/* do not handle MDIO events */
name|event
operator|=
name|fman_tgec_get_event
argument_list|(
name|p_TgecMemMap
argument_list|,
operator|~
operator|(
name|TGEC_IMASK_MDIO_SCAN_EVENT
operator||
name|TGEC_IMASK_MDIO_CMD_CMPL
operator|)
argument_list|)
expr_stmt|;
name|event
operator|&=
name|fman_tgec_get_interrupt_mask
argument_list|(
name|p_TgecMemMap
argument_list|)
expr_stmt|;
name|fman_tgec_ack_event
argument_list|(
name|p_TgecMemMap
argument_list|,
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|TGEC_IMASK_REM_FAULT
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_REM_FAULT
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|TGEC_IMASK_LOC_FAULT
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_LOC_FAULT
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|TGEC_IMASK_TX_ECC_ER
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_1TX_ECC_ER
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|TGEC_IMASK_TX_FIFO_UNFL
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_TX_FIFO_UNFL
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|TGEC_IMASK_TX_FIFO_OVFL
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_TX_FIFO_OVFL
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|TGEC_IMASK_TX_ER
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_TX_ER
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|TGEC_IMASK_RX_FIFO_OVFL
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_RX_FIFO_OVFL
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|TGEC_IMASK_RX_ECC_ER
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_RX_ECC_ER
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|TGEC_IMASK_RX_JAB_FRM
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_RX_JAB_FRM
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|TGEC_IMASK_RX_OVRSZ_FRM
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_RX_OVRSZ_FRM
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|TGEC_IMASK_RX_RUNT_FRM
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_RX_RUNT_FRM
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|TGEC_IMASK_RX_FRAG_FRM
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_RX_FRAG_FRM
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|TGEC_IMASK_RX_LEN_ER
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_RX_LEN_ER
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|TGEC_IMASK_RX_CRC_ER
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_RX_CRC_ER
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|TGEC_IMASK_RX_ALIGN_ER
condition|)
name|p_Tgec
operator|->
name|f_Exception
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_RX_ALIGN_ER
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|void
name|TgecException
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|uint32_t
name|event
decl_stmt|;
name|struct
name|tgec_regs
modifier|*
name|p_TgecMemMap
init|=
name|p_Tgec
operator|->
name|p_MemMap
decl_stmt|;
comment|/* handle only MDIO events */
name|event
operator|=
name|fman_tgec_get_event
argument_list|(
name|p_TgecMemMap
argument_list|,
operator|(
name|TGEC_IMASK_MDIO_SCAN_EVENT
operator||
name|TGEC_IMASK_MDIO_CMD_CMPL
operator|)
argument_list|)
expr_stmt|;
name|event
operator|&=
name|fman_tgec_get_interrupt_mask
argument_list|(
name|p_TgecMemMap
argument_list|)
expr_stmt|;
name|fman_tgec_ack_event
argument_list|(
name|p_TgecMemMap
argument_list|,
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|TGEC_IMASK_MDIO_SCAN_EVENT
condition|)
name|p_Tgec
operator|->
name|f_Event
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_MDIO_SCAN_EVENTMDIO
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|TGEC_IMASK_MDIO_CMD_CMPL
condition|)
name|p_Tgec
operator|->
name|f_Event
argument_list|(
name|p_Tgec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_10G_MDIO_CMD_CMPL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|void
name|FreeInitResources
parameter_list|(
name|t_Tgec
modifier|*
name|p_Tgec
parameter_list|)
block|{
if|if
condition|(
name|p_Tgec
operator|->
name|mdioIrq
operator|!=
name|NO_IRQ
condition|)
block|{
name|XX_DisableIntr
argument_list|(
name|p_Tgec
operator|->
name|mdioIrq
argument_list|)
expr_stmt|;
name|XX_FreeIntr
argument_list|(
name|p_Tgec
operator|->
name|mdioIrq
argument_list|)
expr_stmt|;
block|}
name|FmUnregisterIntr
argument_list|(
name|p_Tgec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
name|e_FM_MOD_10G_MAC
argument_list|,
name|p_Tgec
operator|->
name|macId
argument_list|,
name|e_FM_INTR_TYPE_ERR
argument_list|)
expr_stmt|;
comment|/* release the driver's group hash table */
name|FreeHashTable
argument_list|(
name|p_Tgec
operator|->
name|p_MulticastAddrHash
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|p_MulticastAddrHash
operator|=
name|NULL
expr_stmt|;
comment|/* release the driver's individual hash table */
name|FreeHashTable
argument_list|(
name|p_Tgec
operator|->
name|p_UnicastAddrHash
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|p_UnicastAddrHash
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*                     10G MAC API routines                                  */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecEnable
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|e_CommMode
name|mode
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|fman_tgec_enable
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
operator|(
name|mode
operator|&
name|e_COMM_MODE_RX
operator|)
argument_list|,
operator|(
name|mode
operator|&
name|e_COMM_MODE_TX
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecDisable
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|e_CommMode
name|mode
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|fman_tgec_disable
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
operator|(
name|mode
operator|&
name|e_COMM_MODE_RX
operator|)
argument_list|,
operator|(
name|mode
operator|&
name|e_COMM_MODE_TX
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecSetPromiscuous
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|bool
name|newVal
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|fman_tgec_set_promiscuous
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|newVal
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*                      Tgec Configs modification functions                 */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecConfigLoopback
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|bool
name|newVal
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|p_TgecDriverParam
operator|->
name|loopback_enable
operator|=
name|newVal
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecConfigWan
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|bool
name|newVal
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|p_TgecDriverParam
operator|->
name|wan_mode_enable
operator|=
name|newVal
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecConfigMaxFrameLength
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|uint16_t
name|newVal
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|p_TgecDriverParam
operator|->
name|max_frame_length
operator|=
name|newVal
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecConfigLengthCheck
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|bool
name|newVal
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|UNUSED
argument_list|(
name|newVal
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|p_TgecDriverParam
operator|->
name|no_length_check_enable
operator|=
operator|!
name|newVal
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecConfigException
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|e_FmMacExceptions
name|exception
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|uint32_t
name|bitMask
init|=
literal|0
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|GET_EXCEPTION_FLAG
argument_list|(
name|bitMask
argument_list|,
name|exception
argument_list|)
expr_stmt|;
if|if
condition|(
name|bitMask
condition|)
block|{
if|if
condition|(
name|enable
condition|)
name|p_Tgec
operator|->
name|exceptions
operator||=
name|bitMask
expr_stmt|;
else|else
name|p_Tgec
operator|->
name|exceptions
operator|&=
operator|~
name|bitMask
expr_stmt|;
block|}
else|else
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Undefined exception"
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|FM_TX_ECC_FRMS_ERRATA_10GMAC_A004
end_ifdef

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecConfigSkipFman11Workaround
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|p_TgecDriverParam
operator|->
name|skip_fman11_workaround
operator|=
name|TRUE
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* FM_TX_ECC_FRMS_ERRATA_10GMAC_A004 */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*                      Tgec Run Time API functions                         */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/* ......................................................................... */
end_comment

begin_comment
comment|/* backward compatibility. will be removed in the future. */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecTxMacPause
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|uint16_t
name|pauseTime
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|fman_tgec_set_tx_pause_frames
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|pauseTime
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecSetTxPauseFrames
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|uint8_t
name|priority
parameter_list|,
name|uint16_t
name|pauseTime
parameter_list|,
name|uint16_t
name|threshTime
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|priority
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|threshTime
argument_list|)
expr_stmt|;
name|fman_tgec_set_tx_pause_frames
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|pauseTime
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecRxIgnoreMacPause
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|bool
name|en
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|fman_tgec_set_rx_ignore_pause_frames
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|en
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecGetStatistics
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|t_FmMacStatistics
modifier|*
name|p_Statistics
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|struct
name|tgec_regs
modifier|*
name|p_TgecMemMap
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Statistics
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|p_TgecMemMap
operator|=
name|p_Tgec
operator|->
name|p_MemMap
expr_stmt|;
name|p_Statistics
operator|->
name|eStatPkts64
operator|=
name|fman_tgec_get_counter
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_TGEC_COUNTER_R64
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|eStatPkts65to127
operator|=
name|fman_tgec_get_counter
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_TGEC_COUNTER_R127
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|eStatPkts128to255
operator|=
name|fman_tgec_get_counter
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_TGEC_COUNTER_R255
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|eStatPkts256to511
operator|=
name|fman_tgec_get_counter
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_TGEC_COUNTER_R511
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|eStatPkts512to1023
operator|=
name|fman_tgec_get_counter
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_TGEC_COUNTER_R1023
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|eStatPkts1024to1518
operator|=
name|fman_tgec_get_counter
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_TGEC_COUNTER_R1518
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|eStatPkts1519to1522
operator|=
name|fman_tgec_get_counter
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_TGEC_COUNTER_R1519X
argument_list|)
expr_stmt|;
comment|/* */
name|p_Statistics
operator|->
name|eStatFragments
operator|=
name|fman_tgec_get_counter
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_TGEC_COUNTER_TRFRG
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|eStatJabbers
operator|=
name|fman_tgec_get_counter
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_TGEC_COUNTER_TRJBR
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|eStatsDropEvents
operator|=
name|fman_tgec_get_counter
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_TGEC_COUNTER_RDRP
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|eStatCRCAlignErrors
operator|=
name|fman_tgec_get_counter
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_TGEC_COUNTER_RALN
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|eStatUndersizePkts
operator|=
name|fman_tgec_get_counter
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_TGEC_COUNTER_TRUND
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|eStatOversizePkts
operator|=
name|fman_tgec_get_counter
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_TGEC_COUNTER_TROVR
argument_list|)
expr_stmt|;
comment|/* Pause */
name|p_Statistics
operator|->
name|reStatPause
operator|=
name|fman_tgec_get_counter
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_TGEC_COUNTER_RXPF
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|teStatPause
operator|=
name|fman_tgec_get_counter
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_TGEC_COUNTER_TXPF
argument_list|)
expr_stmt|;
comment|/* MIB II */
name|p_Statistics
operator|->
name|ifInOctets
operator|=
name|fman_tgec_get_counter
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_TGEC_COUNTER_ROCT
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|ifInUcastPkts
operator|=
name|fman_tgec_get_counter
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_TGEC_COUNTER_RUCA
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|ifInMcastPkts
operator|=
name|fman_tgec_get_counter
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_TGEC_COUNTER_RMCA
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|ifInBcastPkts
operator|=
name|fman_tgec_get_counter
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_TGEC_COUNTER_RBCA
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|ifInPkts
operator|=
name|p_Statistics
operator|->
name|ifInUcastPkts
operator|+
name|p_Statistics
operator|->
name|ifInMcastPkts
operator|+
name|p_Statistics
operator|->
name|ifInBcastPkts
expr_stmt|;
name|p_Statistics
operator|->
name|ifInDiscards
operator|=
literal|0
expr_stmt|;
name|p_Statistics
operator|->
name|ifInErrors
operator|=
name|fman_tgec_get_counter
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_TGEC_COUNTER_RERR
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|ifOutOctets
operator|=
name|fman_tgec_get_counter
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_TGEC_COUNTER_TOCT
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|ifOutUcastPkts
operator|=
name|fman_tgec_get_counter
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_TGEC_COUNTER_TUCA
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|ifOutMcastPkts
operator|=
name|fman_tgec_get_counter
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_TGEC_COUNTER_TMCA
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|ifOutBcastPkts
operator|=
name|fman_tgec_get_counter
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_TGEC_COUNTER_TBCA
argument_list|)
expr_stmt|;
name|p_Statistics
operator|->
name|ifOutPkts
operator|=
name|p_Statistics
operator|->
name|ifOutUcastPkts
operator|+
name|p_Statistics
operator|->
name|ifOutMcastPkts
operator|+
name|p_Statistics
operator|->
name|ifOutBcastPkts
expr_stmt|;
name|p_Statistics
operator|->
name|ifOutDiscards
operator|=
literal|0
expr_stmt|;
name|p_Statistics
operator|->
name|ifOutErrors
operator|=
name|fman_tgec_get_counter
argument_list|(
name|p_TgecMemMap
argument_list|,
name|E_TGEC_COUNTER_TERR
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecEnable1588TimeStamp
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|fman_tgec_enable_1588_time_stamp
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecDisable1588TimeStamp
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|fman_tgec_enable_1588_time_stamp
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecModifyMacAddress
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|t_EnetAddr
modifier|*
name|p_EnetAddr
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|addr
operator|=
name|ENET_ADDR_TO_UINT64
argument_list|(
operator|*
name|p_EnetAddr
argument_list|)
expr_stmt|;
name|fman_tgec_set_mac_address
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|(
operator|*
name|p_EnetAddr
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecResetCounters
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|fman_tgec_reset_stat
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecAddExactMatchMacAddress
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|t_EnetAddr
modifier|*
name|p_EthAddr
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|uint64_t
name|ethAddr
decl_stmt|;
name|uint8_t
name|paddrNum
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|ethAddr
operator|=
name|ENET_ADDR_TO_UINT64
argument_list|(
operator|*
name|p_EthAddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ethAddr
operator|&
name|GROUP_ADDRESS
condition|)
comment|/* Multicast address has no effect in PADDR */
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Multicast address"
operator|)
argument_list|)
expr_stmt|;
comment|/* Make sure no PADDR contains this address */
for|for
control|(
name|paddrNum
operator|=
literal|0
init|;
name|paddrNum
operator|<
name|TGEC_NUM_OF_PADDRS
condition|;
name|paddrNum
operator|++
control|)
if|if
condition|(
name|p_Tgec
operator|->
name|indAddrRegUsed
index|[
name|paddrNum
index|]
condition|)
if|if
condition|(
name|p_Tgec
operator|->
name|paddr
index|[
name|paddrNum
index|]
operator|==
name|ethAddr
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_ALREADY_EXISTS
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
comment|/* Find first unused PADDR */
for|for
control|(
name|paddrNum
operator|=
literal|0
init|;
name|paddrNum
operator|<
name|TGEC_NUM_OF_PADDRS
condition|;
name|paddrNum
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|p_Tgec
operator|->
name|indAddrRegUsed
index|[
name|paddrNum
index|]
operator|)
condition|)
block|{
comment|/* mark this PADDR as used */
name|p_Tgec
operator|->
name|indAddrRegUsed
index|[
name|paddrNum
index|]
operator|=
name|TRUE
expr_stmt|;
comment|/* store address */
name|p_Tgec
operator|->
name|paddr
index|[
name|paddrNum
index|]
operator|=
name|ethAddr
expr_stmt|;
comment|/* put in hardware */
name|fman_tgec_add_addr_in_paddr
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|(
operator|*
name|p_EthAddr
operator|)
comment|/* , paddrNum */
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|numOfIndAddrInRegs
operator|++
expr_stmt|;
return|return
name|E_OK
return|;
block|}
block|}
comment|/* No free PADDR */
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_FULL
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecDelExactMatchMacAddress
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|t_EnetAddr
modifier|*
name|p_EthAddr
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|uint64_t
name|ethAddr
decl_stmt|;
name|uint8_t
name|paddrNum
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|ethAddr
operator|=
name|ENET_ADDR_TO_UINT64
argument_list|(
operator|*
name|p_EthAddr
argument_list|)
expr_stmt|;
comment|/* Find used PADDR containing this address */
for|for
control|(
name|paddrNum
operator|=
literal|0
init|;
name|paddrNum
operator|<
name|TGEC_NUM_OF_PADDRS
condition|;
name|paddrNum
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|p_Tgec
operator|->
name|indAddrRegUsed
index|[
name|paddrNum
index|]
operator|)
operator|&&
operator|(
name|p_Tgec
operator|->
name|paddr
index|[
name|paddrNum
index|]
operator|==
name|ethAddr
operator|)
condition|)
block|{
comment|/* mark this PADDR as not used */
name|p_Tgec
operator|->
name|indAddrRegUsed
index|[
name|paddrNum
index|]
operator|=
name|FALSE
expr_stmt|;
comment|/* clear in hardware */
name|fman_tgec_clear_addr_in_paddr
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
comment|/*, paddrNum */
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|numOfIndAddrInRegs
operator|--
expr_stmt|;
return|return
name|E_OK
return|;
block|}
block|}
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_FOUND
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecAddHashMacAddress
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|t_EnetAddr
modifier|*
name|p_EthAddr
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|t_EthHashEntry
modifier|*
name|p_HashEntry
decl_stmt|;
name|uint32_t
name|crc
decl_stmt|;
name|uint32_t
name|hash
decl_stmt|;
name|uint64_t
name|ethAddr
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|ethAddr
operator|=
name|ENET_ADDR_TO_UINT64
argument_list|(
operator|*
name|p_EthAddr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ethAddr
operator|&
name|GROUP_ADDRESS
operator|)
condition|)
comment|/* Unicast addresses not supported in hash */
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"Unicast Address"
operator|)
argument_list|)
expr_stmt|;
comment|/* CRC calculation */
name|crc
operator|=
name|GetMacAddrHashCode
argument_list|(
name|ethAddr
argument_list|)
expr_stmt|;
name|hash
operator|=
operator|(
name|crc
operator|>>
name|TGEC_HASH_MCAST_SHIFT
operator|)
operator|&
name|TGEC_HASH_ADR_MSK
expr_stmt|;
comment|/* Take 9 MSB bits */
comment|/* Create element to be added to the driver hash table */
name|p_HashEntry
operator|=
operator|(
name|t_EthHashEntry
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|t_EthHashEntry
argument_list|)
argument_list|)
expr_stmt|;
name|p_HashEntry
operator|->
name|addr
operator|=
name|ethAddr
expr_stmt|;
name|INIT_LIST
argument_list|(
operator|&
name|p_HashEntry
operator|->
name|node
argument_list|)
expr_stmt|;
name|NCSW_LIST_AddToTail
argument_list|(
operator|&
operator|(
name|p_HashEntry
operator|->
name|node
operator|)
argument_list|,
operator|&
operator|(
name|p_Tgec
operator|->
name|p_MulticastAddrHash
operator|->
name|p_Lsts
index|[
name|hash
index|]
operator|)
argument_list|)
expr_stmt|;
name|fman_tgec_set_hash_table
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
operator|(
name|hash
operator||
name|TGEC_HASH_MCAST_EN
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecDelHashMacAddress
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|t_EnetAddr
modifier|*
name|p_EthAddr
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|t_EthHashEntry
modifier|*
name|p_HashEntry
init|=
name|NULL
decl_stmt|;
name|t_List
modifier|*
name|p_Pos
decl_stmt|;
name|uint32_t
name|crc
decl_stmt|;
name|uint32_t
name|hash
decl_stmt|;
name|uint64_t
name|ethAddr
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|ethAddr
operator|=
operator|(
operator|(
operator|*
operator|(
name|uint64_t
operator|*
operator|)
name|p_EthAddr
operator|)
operator|>>
literal|16
operator|)
expr_stmt|;
comment|/* CRC calculation */
name|crc
operator|=
name|GetMacAddrHashCode
argument_list|(
name|ethAddr
argument_list|)
expr_stmt|;
name|hash
operator|=
operator|(
name|crc
operator|>>
name|TGEC_HASH_MCAST_SHIFT
operator|)
operator|&
name|TGEC_HASH_ADR_MSK
expr_stmt|;
comment|/* Take 9 MSB bits */
name|NCSW_LIST_FOR_EACH
argument_list|(
argument|p_Pos
argument_list|,
argument|&(p_Tgec->p_MulticastAddrHash->p_Lsts[hash])
argument_list|)
block|{
name|p_HashEntry
operator|=
name|ETH_HASH_ENTRY_OBJ
argument_list|(
name|p_Pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_HashEntry
operator|->
name|addr
operator|==
name|ethAddr
condition|)
block|{
name|NCSW_LIST_DelAndInit
argument_list|(
operator|&
name|p_HashEntry
operator|->
name|node
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_HashEntry
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|NCSW_LIST_IsEmpty
argument_list|(
operator|&
name|p_Tgec
operator|->
name|p_MulticastAddrHash
operator|->
name|p_Lsts
index|[
name|hash
index|]
argument_list|)
condition|)
name|fman_tgec_set_hash_table
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
operator|(
name|hash
operator|&
operator|~
name|TGEC_HASH_MCAST_EN
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecGetId
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|uint32_t
modifier|*
name|macId
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|p_Tgec
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|macId
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"TgecGetId Not Supported"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecGetVersion
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|uint32_t
modifier|*
name|macVersion
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
operator|*
name|macVersion
operator|=
name|fman_tgec_get_revision
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecSetExcpetion
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|,
name|e_FmMacExceptions
name|exception
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|uint32_t
name|bitMask
init|=
literal|0
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|GET_EXCEPTION_FLAG
argument_list|(
name|bitMask
argument_list|,
name|exception
argument_list|)
expr_stmt|;
if|if
condition|(
name|bitMask
condition|)
block|{
if|if
condition|(
name|enable
condition|)
name|p_Tgec
operator|->
name|exceptions
operator||=
name|bitMask
expr_stmt|;
else|else
name|p_Tgec
operator|->
name|exceptions
operator|&=
operator|~
name|bitMask
expr_stmt|;
block|}
else|else
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Undefined exception"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
condition|)
name|fman_tgec_enable_interrupt
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|bitMask
argument_list|)
expr_stmt|;
else|else
name|fman_tgec_disable_interrupt
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|bitMask
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|uint16_t
name|TgecGetMaxFrameLength
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|fman_tgec_get_max_frame_len
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|FM_TX_ECC_FRMS_ERRATA_10GMAC_A004
end_ifdef

begin_function
specifier|static
name|t_Error
name|TgecTxEccWorkaround
parameter_list|(
name|t_Tgec
modifier|*
name|p_Tgec
parameter_list|)
block|{
name|t_Error
name|err
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|DEBUG_ERRORS
argument_list|)
operator|&&
operator|(
name|DEBUG_ERRORS
operator|>
literal|0
operator|)
name|XX_Print
argument_list|(
literal|"Applying 10G TX ECC workaround (10GMAC-A004) ... "
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* (DEBUG_ERRORS> 0) */
comment|/* enable and set promiscuous */
name|fman_tgec_enable
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|TRUE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|fman_tgec_set_promiscuous
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|err
operator|=
name|Fm10GTxEccWorkaround
argument_list|(
name|p_Tgec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
name|p_Tgec
operator|->
name|macId
argument_list|)
expr_stmt|;
comment|/* disable */
name|fman_tgec_set_promiscuous
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|fman_tgec_enable
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|fman_tgec_reset_stat
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|)
expr_stmt|;
name|fman_tgec_ack_event
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|DEBUG_ERRORS
argument_list|)
operator|&&
operator|(
name|DEBUG_ERRORS
operator|>
literal|0
operator|)
if|if
condition|(
name|err
condition|)
name|XX_Print
argument_list|(
literal|"FAILED!\n"
argument_list|)
expr_stmt|;
else|else
name|XX_Print
argument_list|(
literal|"done.\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* (DEBUG_ERRORS> 0) */
return|return
name|err
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* FM_TX_ECC_FRMS_ERRATA_10GMAC_A004 */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*                      FM Init& Free API                                   */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecInit
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|struct
name|tgec_cfg
modifier|*
name|p_TgecDriverParam
decl_stmt|;
name|t_EnetAddr
name|ethAddr
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|FM_GetRevision
argument_list|(
name|p_Tgec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
operator|&
name|p_Tgec
operator|->
name|fmMacControllerDriver
operator|.
name|fmRevInfo
argument_list|)
expr_stmt|;
name|CHECK_INIT_PARAMETERS
argument_list|(
name|p_Tgec
argument_list|,
name|CheckInitParameters
argument_list|)
expr_stmt|;
name|p_TgecDriverParam
operator|=
name|p_Tgec
operator|->
name|p_TgecDriverParam
expr_stmt|;
name|MAKE_ENET_ADDR_FROM_UINT64
argument_list|(
name|p_Tgec
operator|->
name|addr
argument_list|,
name|ethAddr
argument_list|)
expr_stmt|;
name|fman_tgec_set_mac_address
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|ethAddr
argument_list|)
expr_stmt|;
comment|/* interrupts */
ifdef|#
directive|ifdef
name|FM_10G_REM_N_LCL_FLT_EX_10GMAC_ERRATA_SW005
block|{
if|if
condition|(
name|p_Tgec
operator|->
name|fmMacControllerDriver
operator|.
name|fmRevInfo
operator|.
name|majorRev
operator|<=
literal|2
condition|)
name|p_Tgec
operator|->
name|exceptions
operator|&=
operator|~
operator|(
name|TGEC_IMASK_REM_FAULT
operator||
name|TGEC_IMASK_LOC_FAULT
operator|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* FM_10G_REM_N_LCL_FLT_EX_10GMAC_ERRATA_SW005 */
ifdef|#
directive|ifdef
name|FM_TX_ECC_FRMS_ERRATA_10GMAC_A004
if|if
condition|(
operator|!
name|p_Tgec
operator|->
name|p_TgecDriverParam
operator|->
name|skip_fman11_workaround
operator|&&
operator|(
operator|(
name|err
operator|=
name|TgecTxEccWorkaround
argument_list|(
name|p_Tgec
argument_list|)
operator|)
operator|!=
name|E_OK
operator|)
condition|)
block|{
name|FreeInitResources
argument_list|(
name|p_Tgec
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
operator|(
literal|"TgecTxEccWorkaround FAILED"
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* FM_TX_ECC_FRMS_ERRATA_10GMAC_A004 */
name|err
operator|=
name|fman_tgec_init
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|,
name|p_TgecDriverParam
argument_list|,
name|p_Tgec
operator|->
name|exceptions
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|FreeInitResources
argument_list|(
name|p_Tgec
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
operator|(
literal|"This TGEC version does not support the required i/f mode"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Max Frame Length */
name|err
operator|=
name|FmSetMacMaxFrame
argument_list|(
name|p_Tgec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
name|e_FM_MAC_10G
argument_list|,
name|p_Tgec
operator|->
name|fmMacControllerDriver
operator|.
name|macId
argument_list|,
name|p_TgecDriverParam
operator|->
name|max_frame_length
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
block|{
name|FreeInitResources
argument_list|(
name|p_Tgec
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
comment|/* we consider having no IPC a non crasher... */
ifdef|#
directive|ifdef
name|FM_TX_FIFO_CORRUPTION_ERRATA_10GMAC_A007
if|if
condition|(
name|p_Tgec
operator|->
name|fmMacControllerDriver
operator|.
name|fmRevInfo
operator|.
name|majorRev
operator|==
literal|2
condition|)
name|fman_tgec_set_erratum_tx_fifo_corruption_10gmac_a007
argument_list|(
name|p_Tgec
operator|->
name|p_MemMap
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* FM_TX_FIFO_CORRUPTION_ERRATA_10GMAC_A007 */
name|p_Tgec
operator|->
name|p_MulticastAddrHash
operator|=
name|AllocHashTable
argument_list|(
name|HASH_TABLE_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Tgec
operator|->
name|p_MulticastAddrHash
condition|)
block|{
name|FreeInitResources
argument_list|(
name|p_Tgec
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"allocation hash table is FAILED"
operator|)
argument_list|)
expr_stmt|;
block|}
name|p_Tgec
operator|->
name|p_UnicastAddrHash
operator|=
name|AllocHashTable
argument_list|(
name|HASH_TABLE_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Tgec
operator|->
name|p_UnicastAddrHash
condition|)
block|{
name|FreeInitResources
argument_list|(
name|p_Tgec
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"allocation hash table is FAILED"
operator|)
argument_list|)
expr_stmt|;
block|}
name|FmRegisterIntr
argument_list|(
name|p_Tgec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
name|e_FM_MOD_10G_MAC
argument_list|,
name|p_Tgec
operator|->
name|macId
argument_list|,
name|e_FM_INTR_TYPE_ERR
argument_list|,
name|TgecErrException
argument_list|,
name|p_Tgec
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Tgec
operator|->
name|mdioIrq
operator|!=
name|NO_IRQ
condition|)
block|{
name|XX_SetIntr
argument_list|(
name|p_Tgec
operator|->
name|mdioIrq
argument_list|,
name|TgecException
argument_list|,
name|p_Tgec
argument_list|)
expr_stmt|;
name|XX_EnableIntr
argument_list|(
name|p_Tgec
operator|->
name|mdioIrq
argument_list|)
expr_stmt|;
block|}
name|XX_Free
argument_list|(
name|p_TgecDriverParam
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|p_TgecDriverParam
operator|=
name|NULL
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|TgecFree
parameter_list|(
name|t_Handle
name|h_Tgec
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
init|=
operator|(
name|t_Tgec
operator|*
operator|)
name|h_Tgec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Tgec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Tgec
operator|->
name|p_TgecDriverParam
condition|)
block|{
comment|/* Called after config */
name|XX_Free
argument_list|(
name|p_Tgec
operator|->
name|p_TgecDriverParam
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|p_TgecDriverParam
operator|=
name|NULL
expr_stmt|;
block|}
else|else
comment|/* Called after init */
name|FreeInitResources
argument_list|(
name|p_Tgec
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_Tgec
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|void
name|InitFmMacControllerDriver
parameter_list|(
name|t_FmMacControllerDriver
modifier|*
name|p_FmMacControllerDriver
parameter_list|)
block|{
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_Init
operator|=
name|TgecInit
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_Free
operator|=
name|TgecFree
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_SetStatistics
operator|=
name|NULL
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigLoopback
operator|=
name|TgecConfigLoopback
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigMaxFrameLength
operator|=
name|TgecConfigMaxFrameLength
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigWan
operator|=
name|TgecConfigWan
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigPadAndCrc
operator|=
name|NULL
expr_stmt|;
comment|/* TGEC always works with pad+crc */
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigHalfDuplex
operator|=
name|NULL
expr_stmt|;
comment|/* half-duplex is not supported in xgec */
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigLengthCheck
operator|=
name|TgecConfigLengthCheck
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigException
operator|=
name|TgecConfigException
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigResetOnInit
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_TX_ECC_FRMS_ERRATA_10GMAC_A004
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigSkipFman11Workaround
operator|=
name|TgecConfigSkipFman11Workaround
expr_stmt|;
endif|#
directive|endif
comment|/* FM_TX_ECC_FRMS_ERRATA_10GMAC_A004 */
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_SetException
operator|=
name|TgecSetExcpetion
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_Enable1588TimeStamp
operator|=
name|TgecEnable1588TimeStamp
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_Disable1588TimeStamp
operator|=
name|TgecDisable1588TimeStamp
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_SetPromiscuous
operator|=
name|TgecSetPromiscuous
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_AdjustLink
operator|=
name|NULL
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_SetWakeOnLan
operator|=
name|NULL
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_RestartAutoneg
operator|=
name|NULL
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_Enable
operator|=
name|TgecEnable
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_Disable
operator|=
name|TgecDisable
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_Resume
operator|=
name|NULL
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_SetTxAutoPauseFrames
operator|=
name|TgecTxMacPause
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_SetTxPauseFrames
operator|=
name|TgecSetTxPauseFrames
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_SetRxIgnorePauseFrames
operator|=
name|TgecRxIgnoreMacPause
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ResetCounters
operator|=
name|TgecResetCounters
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_GetStatistics
operator|=
name|TgecGetStatistics
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ModifyMacAddr
operator|=
name|TgecModifyMacAddress
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_AddHashMacAddr
operator|=
name|TgecAddHashMacAddress
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_RemoveHashMacAddr
operator|=
name|TgecDelHashMacAddress
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_AddExactMatchMacAddr
operator|=
name|TgecAddExactMatchMacAddress
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_RemovelExactMatchMacAddr
operator|=
name|TgecDelExactMatchMacAddress
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_GetId
operator|=
name|TgecGetId
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_GetVersion
operator|=
name|TgecGetVersion
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_GetMaxFrameLength
operator|=
name|TgecGetMaxFrameLength
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_MII_WritePhyReg
operator|=
name|TGEC_MII_WritePhyReg
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_MII_ReadPhyReg
operator|=
name|TGEC_MII_ReadPhyReg
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*                      Tgec Config  Main Entry                             */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
name|t_Handle
name|TGEC_Config
parameter_list|(
name|t_FmMacParams
modifier|*
name|p_FmMacParam
parameter_list|)
block|{
name|t_Tgec
modifier|*
name|p_Tgec
decl_stmt|;
name|struct
name|tgec_cfg
modifier|*
name|p_TgecDriverParam
decl_stmt|;
name|uintptr_t
name|baseAddr
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_FmMacParam
argument_list|,
name|E_NULL_POINTER
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|baseAddr
operator|=
name|p_FmMacParam
operator|->
name|baseAddr
expr_stmt|;
comment|/* allocate memory for the UCC GETH data structure. */
name|p_Tgec
operator|=
operator|(
name|t_Tgec
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|t_Tgec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Tgec
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"10G MAC driver structure"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_Tgec
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_Tgec
argument_list|)
argument_list|)
expr_stmt|;
name|InitFmMacControllerDriver
argument_list|(
operator|&
name|p_Tgec
operator|->
name|fmMacControllerDriver
argument_list|)
expr_stmt|;
comment|/* allocate memory for the 10G MAC driver parameters data structure. */
name|p_TgecDriverParam
operator|=
operator|(
expr|struct
name|tgec_cfg
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|tgec_cfg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_TgecDriverParam
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"10G MAC driver parameters"
operator|)
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_Tgec
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_TgecDriverParam
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|tgec_cfg
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Plant parameter structure pointer */
name|p_Tgec
operator|->
name|p_TgecDriverParam
operator|=
name|p_TgecDriverParam
expr_stmt|;
name|fman_tgec_defconfig
argument_list|(
name|p_TgecDriverParam
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|p_MemMap
operator|=
operator|(
expr|struct
name|tgec_regs
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|baseAddr
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|p_MiiMemMap
operator|=
operator|(
name|t_TgecMiiAccessMemMap
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|baseAddr
operator|+
name|TGEC_TO_MII_OFFSET
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|addr
operator|=
name|ENET_ADDR_TO_UINT64
argument_list|(
name|p_FmMacParam
operator|->
name|addr
argument_list|)
expr_stmt|;
name|p_Tgec
operator|->
name|enetMode
operator|=
name|p_FmMacParam
operator|->
name|enetMode
expr_stmt|;
name|p_Tgec
operator|->
name|macId
operator|=
name|p_FmMacParam
operator|->
name|macId
expr_stmt|;
name|p_Tgec
operator|->
name|exceptions
operator|=
name|DEFAULT_exceptions
expr_stmt|;
name|p_Tgec
operator|->
name|mdioIrq
operator|=
name|p_FmMacParam
operator|->
name|mdioIrq
expr_stmt|;
name|p_Tgec
operator|->
name|f_Exception
operator|=
name|p_FmMacParam
operator|->
name|f_Exception
expr_stmt|;
name|p_Tgec
operator|->
name|f_Event
operator|=
name|p_FmMacParam
operator|->
name|f_Event
expr_stmt|;
name|p_Tgec
operator|->
name|h_App
operator|=
name|p_FmMacParam
operator|->
name|h_App
expr_stmt|;
return|return
name|p_Tgec
return|;
block|}
end_function

end_unit


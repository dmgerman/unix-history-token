begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2008-2012 Freescale Semiconductor Inc.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are met:  *     * Redistributions of source code must retain the above copyright  *       notice, this list of conditions and the following disclaimer.  *     * Redistributions in binary form must reproduce the above copyright  *       notice, this list of conditions and the following disclaimer in the  *       documentation and/or other materials provided with the distribution.  *     * Neither the name of Freescale Semiconductor nor the  *       names of its contributors may be used to endorse or promote products  *       derived from this software without specific prior written permission.  *  *  * ALTERNATIVELY, this software may be distributed under the terms of the  * GNU General Public License ("GPL") as published by the Free Software  * Foundation, either version 2 of that License or (at your option) any  * later version.  *  * THIS SOFTWARE IS PROVIDED BY Freescale Semiconductor ``AS IS'' AND ANY  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED. IN NO EVENT SHALL Freescale Semiconductor BE LIABLE FOR ANY  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"fsl_fman_dtsec.h"
end_include

begin_function
name|void
name|fman_dtsec_stop_rx
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|)
block|{
comment|/* Assert the graceful stop bit */
name|iowrite32be
argument_list|(
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|rctrl
argument_list|)
operator||
name|RCTRL_GRS
argument_list|,
operator|&
name|regs
operator|->
name|rctrl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_dtsec_stop_tx
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|)
block|{
comment|/* Assert the graceful stop bit */
name|iowrite32be
argument_list|(
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|tctrl
argument_list|)
operator||
name|DTSEC_TCTRL_GTS
argument_list|,
operator|&
name|regs
operator|->
name|tctrl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_dtsec_start_tx
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|)
block|{
comment|/* clear the graceful stop bit */
name|iowrite32be
argument_list|(
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|tctrl
argument_list|)
operator|&
operator|~
name|DTSEC_TCTRL_GTS
argument_list|,
operator|&
name|regs
operator|->
name|tctrl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_dtsec_start_rx
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|)
block|{
comment|/* clear the graceful stop bit */
name|iowrite32be
argument_list|(
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|rctrl
argument_list|)
operator|&
operator|~
name|RCTRL_GRS
argument_list|,
operator|&
name|regs
operator|->
name|rctrl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_dtsec_defconfig
parameter_list|(
name|struct
name|dtsec_cfg
modifier|*
name|cfg
parameter_list|)
block|{
name|cfg
operator|->
name|halfdup_on
operator|=
name|DEFAULT_HALFDUP_ON
expr_stmt|;
name|cfg
operator|->
name|halfdup_retransmit
operator|=
name|DEFAULT_HALFDUP_RETRANSMIT
expr_stmt|;
name|cfg
operator|->
name|halfdup_coll_window
operator|=
name|DEFAULT_HALFDUP_COLL_WINDOW
expr_stmt|;
name|cfg
operator|->
name|halfdup_excess_defer
operator|=
name|DEFAULT_HALFDUP_EXCESS_DEFER
expr_stmt|;
name|cfg
operator|->
name|halfdup_no_backoff
operator|=
name|DEFAULT_HALFDUP_NO_BACKOFF
expr_stmt|;
name|cfg
operator|->
name|halfdup_bp_no_backoff
operator|=
name|DEFAULT_HALFDUP_BP_NO_BACKOFF
expr_stmt|;
name|cfg
operator|->
name|halfdup_alt_backoff_val
operator|=
name|DEFAULT_HALFDUP_ALT_BACKOFF_VAL
expr_stmt|;
name|cfg
operator|->
name|halfdup_alt_backoff_en
operator|=
name|DEFAULT_HALFDUP_ALT_BACKOFF_EN
expr_stmt|;
name|cfg
operator|->
name|rx_drop_bcast
operator|=
name|DEFAULT_RX_DROP_BCAST
expr_stmt|;
name|cfg
operator|->
name|rx_short_frm
operator|=
name|DEFAULT_RX_SHORT_FRM
expr_stmt|;
name|cfg
operator|->
name|rx_len_check
operator|=
name|DEFAULT_RX_LEN_CHECK
expr_stmt|;
name|cfg
operator|->
name|tx_pad_crc
operator|=
name|DEFAULT_TX_PAD_CRC
expr_stmt|;
name|cfg
operator|->
name|tx_crc
operator|=
name|DEFAULT_TX_CRC
expr_stmt|;
name|cfg
operator|->
name|rx_ctrl_acc
operator|=
name|DEFAULT_RX_CTRL_ACC
expr_stmt|;
name|cfg
operator|->
name|tx_pause_time
operator|=
name|DEFAULT_TX_PAUSE_TIME
expr_stmt|;
name|cfg
operator|->
name|tbipa
operator|=
name|DEFAULT_TBIPA
expr_stmt|;
comment|/* PHY address 0 is reserved (DPAA RM)*/
name|cfg
operator|->
name|rx_prepend
operator|=
name|DEFAULT_RX_PREPEND
expr_stmt|;
name|cfg
operator|->
name|ptp_tsu_en
operator|=
name|DEFAULT_PTP_TSU_EN
expr_stmt|;
name|cfg
operator|->
name|ptp_exception_en
operator|=
name|DEFAULT_PTP_EXCEPTION_EN
expr_stmt|;
name|cfg
operator|->
name|preamble_len
operator|=
name|DEFAULT_PREAMBLE_LEN
expr_stmt|;
name|cfg
operator|->
name|rx_preamble
operator|=
name|DEFAULT_RX_PREAMBLE
expr_stmt|;
name|cfg
operator|->
name|tx_preamble
operator|=
name|DEFAULT_TX_PREAMBLE
expr_stmt|;
name|cfg
operator|->
name|loopback
operator|=
name|DEFAULT_LOOPBACK
expr_stmt|;
name|cfg
operator|->
name|rx_time_stamp_en
operator|=
name|DEFAULT_RX_TIME_STAMP_EN
expr_stmt|;
name|cfg
operator|->
name|tx_time_stamp_en
operator|=
name|DEFAULT_TX_TIME_STAMP_EN
expr_stmt|;
name|cfg
operator|->
name|rx_flow
operator|=
name|DEFAULT_RX_FLOW
expr_stmt|;
name|cfg
operator|->
name|tx_flow
operator|=
name|DEFAULT_TX_FLOW
expr_stmt|;
name|cfg
operator|->
name|rx_group_hash_exd
operator|=
name|DEFAULT_RX_GROUP_HASH_EXD
expr_stmt|;
name|cfg
operator|->
name|tx_pause_time_extd
operator|=
name|DEFAULT_TX_PAUSE_TIME_EXTD
expr_stmt|;
name|cfg
operator|->
name|rx_promisc
operator|=
name|DEFAULT_RX_PROMISC
expr_stmt|;
name|cfg
operator|->
name|non_back_to_back_ipg1
operator|=
name|DEFAULT_NON_BACK_TO_BACK_IPG1
expr_stmt|;
name|cfg
operator|->
name|non_back_to_back_ipg2
operator|=
name|DEFAULT_NON_BACK_TO_BACK_IPG2
expr_stmt|;
name|cfg
operator|->
name|min_ifg_enforcement
operator|=
name|DEFAULT_MIN_IFG_ENFORCEMENT
expr_stmt|;
name|cfg
operator|->
name|back_to_back_ipg
operator|=
name|DEFAULT_BACK_TO_BACK_IPG
expr_stmt|;
name|cfg
operator|->
name|maximum_frame
operator|=
name|DEFAULT_MAXIMUM_FRAME
expr_stmt|;
name|cfg
operator|->
name|tbi_phy_addr
operator|=
name|DEFAULT_TBI_PHY_ADDR
expr_stmt|;
name|cfg
operator|->
name|wake_on_lan
operator|=
name|DEFAULT_WAKE_ON_LAN
expr_stmt|;
block|}
end_function

begin_function
name|int
name|fman_dtsec_init
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|,
name|struct
name|dtsec_cfg
modifier|*
name|cfg
parameter_list|,
name|enum
name|enet_interface
name|iface_mode
parameter_list|,
name|enum
name|enet_speed
name|iface_speed
parameter_list|,
name|uint8_t
modifier|*
name|macaddr
parameter_list|,
name|uint8_t
name|fm_rev_maj
parameter_list|,
name|uint8_t
name|fm_rev_min
parameter_list|,
name|uint32_t
name|exception_mask
parameter_list|)
block|{
name|bool
name|is_rgmii
init|=
name|FALSE
decl_stmt|;
name|bool
name|is_sgmii
init|=
name|FALSE
decl_stmt|;
name|bool
name|is_qsgmii
init|=
name|FALSE
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|UNUSED
argument_list|(
name|fm_rev_maj
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|fm_rev_min
argument_list|)
expr_stmt|;
comment|/* let's start with a soft reset */
name|iowrite32be
argument_list|(
name|MACCFG1_SOFT_RESET
argument_list|,
operator|&
name|regs
operator|->
name|maccfg1
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
literal|0
argument_list|,
operator|&
name|regs
operator|->
name|maccfg1
argument_list|)
expr_stmt|;
comment|/*************dtsec_id2******************/
name|tmp
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|tsec_id2
argument_list|)
expr_stmt|;
comment|/* check RGMII support */
if|if
condition|(
name|iface_mode
operator|==
name|E_ENET_IF_RGMII
operator|||
name|iface_mode
operator|==
name|E_ENET_IF_RMII
condition|)
if|if
condition|(
name|tmp
operator|&
name|DTSEC_ID2_INT_REDUCED_OFF
condition|)
return|return
operator|-
name|EINVAL
return|;
if|if
condition|(
name|iface_mode
operator|==
name|E_ENET_IF_SGMII
operator|||
name|iface_mode
operator|==
name|E_ENET_IF_MII
condition|)
if|if
condition|(
name|tmp
operator|&
name|DTSEC_ID2_INT_REDUCED_OFF
condition|)
return|return
operator|-
name|EINVAL
return|;
comment|/***************ECNTRL************************/
name|is_rgmii
operator|=
call|(
name|bool
call|)
argument_list|(
operator|(
name|iface_mode
operator|==
name|E_ENET_IF_RGMII
operator|)
condition|?
name|TRUE
else|:
name|FALSE
argument_list|)
expr_stmt|;
name|is_sgmii
operator|=
call|(
name|bool
call|)
argument_list|(
operator|(
name|iface_mode
operator|==
name|E_ENET_IF_SGMII
operator|)
condition|?
name|TRUE
else|:
name|FALSE
argument_list|)
expr_stmt|;
name|is_qsgmii
operator|=
call|(
name|bool
call|)
argument_list|(
operator|(
name|iface_mode
operator|==
name|E_ENET_IF_QSGMII
operator|)
condition|?
name|TRUE
else|:
name|FALSE
argument_list|)
expr_stmt|;
name|tmp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|is_rgmii
operator|||
name|iface_mode
operator|==
name|E_ENET_IF_GMII
condition|)
name|tmp
operator||=
name|DTSEC_ECNTRL_GMIIM
expr_stmt|;
if|if
condition|(
name|is_sgmii
condition|)
name|tmp
operator||=
operator|(
name|DTSEC_ECNTRL_SGMIIM
operator||
name|DTSEC_ECNTRL_TBIM
operator|)
expr_stmt|;
if|if
condition|(
name|is_qsgmii
condition|)
name|tmp
operator||=
operator|(
name|DTSEC_ECNTRL_SGMIIM
operator||
name|DTSEC_ECNTRL_TBIM
operator||
name|DTSEC_ECNTRL_QSGMIIM
operator|)
expr_stmt|;
if|if
condition|(
name|is_rgmii
condition|)
name|tmp
operator||=
name|DTSEC_ECNTRL_RPM
expr_stmt|;
if|if
condition|(
name|iface_speed
operator|==
name|E_ENET_SPEED_100
condition|)
name|tmp
operator||=
name|DTSEC_ECNTRL_R100M
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|ecntrl
argument_list|)
expr_stmt|;
comment|/***************ECNTRL************************/
comment|/***************TCTRL************************/
name|tmp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|halfdup_on
condition|)
name|tmp
operator||=
name|DTSEC_TCTRL_THDF
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|tx_time_stamp_en
condition|)
name|tmp
operator||=
name|DTSEC_TCTRL_TTSE
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|tctrl
argument_list|)
expr_stmt|;
comment|/***************TCTRL************************/
comment|/***************PTV************************/
name|tmp
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_SHORT_PAUSE_TIME_ERRATA_DTSEC1
if|if
condition|(
operator|(
name|fm_rev_maj
operator|==
literal|1
operator|)
operator|&&
operator|(
name|fm_rev_min
operator|==
literal|0
operator|)
condition|)
name|cfg
operator|->
name|tx_pause_time
operator|+=
literal|2
expr_stmt|;
endif|#
directive|endif
comment|/* FM_SHORT_PAUSE_TIME_ERRATA_DTSEC1 */
if|if
condition|(
name|cfg
operator|->
name|tx_pause_time
condition|)
name|tmp
operator||=
name|cfg
operator|->
name|tx_pause_time
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|tx_pause_time_extd
condition|)
name|tmp
operator||=
name|cfg
operator|->
name|tx_pause_time_extd
operator|<<
name|PTV_PTE_OFST
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|ptv
argument_list|)
expr_stmt|;
comment|/***************RCTRL************************/
name|tmp
operator|=
literal|0
expr_stmt|;
name|tmp
operator||=
operator|(
call|(
name|uint32_t
call|)
argument_list|(
name|cfg
operator|->
name|rx_prepend
operator|&
literal|0x0000001f
argument_list|)
operator|)
operator|<<
literal|16
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|rx_ctrl_acc
condition|)
name|tmp
operator||=
name|RCTRL_CFA
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|rx_group_hash_exd
condition|)
name|tmp
operator||=
name|RCTRL_GHTX
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|rx_time_stamp_en
condition|)
name|tmp
operator||=
name|RCTRL_RTSE
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|rx_drop_bcast
condition|)
name|tmp
operator||=
name|RCTRL_BC_REJ
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|rx_short_frm
condition|)
name|tmp
operator||=
name|RCTRL_RSF
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|rx_promisc
condition|)
name|tmp
operator||=
name|RCTRL_PROM
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|rctrl
argument_list|)
expr_stmt|;
comment|/***************RCTRL************************/
comment|/* 	 * Assign a Phy Address to the TBI (TBIPA). 	 * Done also in cases where TBI is not selected to avoid conflict with 	 * the external PHY's Physical address 	 */
name|iowrite32be
argument_list|(
name|cfg
operator|->
name|tbipa
argument_list|,
operator|&
name|regs
operator|->
name|tbipa
argument_list|)
expr_stmt|;
comment|/***************TMR_CTL************************/
name|iowrite32be
argument_list|(
literal|0
argument_list|,
operator|&
name|regs
operator|->
name|tmr_ctrl
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|ptp_tsu_en
condition|)
block|{
name|tmp
operator|=
literal|0
expr_stmt|;
name|tmp
operator||=
name|TMR_PEVENT_TSRE
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|tmr_pevent
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|ptp_exception_en
condition|)
block|{
name|tmp
operator|=
literal|0
expr_stmt|;
name|tmp
operator||=
name|TMR_PEMASK_TSREEN
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|tmr_pemask
argument_list|)
expr_stmt|;
block|}
block|}
comment|/***************MACCFG1***********************/
name|tmp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|loopback
condition|)
name|tmp
operator||=
name|MACCFG1_LOOPBACK
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|rx_flow
condition|)
name|tmp
operator||=
name|MACCFG1_RX_FLOW
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|tx_flow
condition|)
name|tmp
operator||=
name|MACCFG1_TX_FLOW
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|maccfg1
argument_list|)
expr_stmt|;
comment|/***************MACCFG1***********************/
comment|/***************MACCFG2***********************/
name|tmp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|iface_speed
operator|<
name|E_ENET_SPEED_1000
condition|)
name|tmp
operator||=
name|MACCFG2_NIBBLE_MODE
expr_stmt|;
elseif|else
if|if
condition|(
name|iface_speed
operator|==
name|E_ENET_SPEED_1000
condition|)
name|tmp
operator||=
name|MACCFG2_BYTE_MODE
expr_stmt|;
name|tmp
operator||=
operator|(
operator|(
name|uint32_t
operator|)
name|cfg
operator|->
name|preamble_len
operator|&
literal|0x0000000f
operator|)
operator|<<
name|PREAMBLE_LENGTH_SHIFT
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|rx_preamble
condition|)
name|tmp
operator||=
name|MACCFG2_PRE_AM_Rx_EN
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|tx_preamble
condition|)
name|tmp
operator||=
name|MACCFG2_PRE_AM_Tx_EN
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|rx_len_check
condition|)
name|tmp
operator||=
name|MACCFG2_LENGTH_CHECK
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|tx_pad_crc
condition|)
name|tmp
operator||=
name|MACCFG2_PAD_CRC_EN
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|tx_crc
condition|)
name|tmp
operator||=
name|MACCFG2_CRC_EN
expr_stmt|;
if|if
condition|(
operator|!
name|cfg
operator|->
name|halfdup_on
condition|)
name|tmp
operator||=
name|MACCFG2_FULL_DUPLEX
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|maccfg2
argument_list|)
expr_stmt|;
comment|/***************MACCFG2***********************/
comment|/***************IPGIFG************************/
name|tmp
operator|=
operator|(
operator|(
operator|(
name|cfg
operator|->
name|non_back_to_back_ipg1
operator|<<
name|IPGIFG_NON_BACK_TO_BACK_IPG_1_SHIFT
operator|)
operator|&
name|IPGIFG_NON_BACK_TO_BACK_IPG_1
operator|)
operator||
operator|(
operator|(
name|cfg
operator|->
name|non_back_to_back_ipg2
operator|<<
name|IPGIFG_NON_BACK_TO_BACK_IPG_2_SHIFT
operator|)
operator|&
name|IPGIFG_NON_BACK_TO_BACK_IPG_2
operator|)
operator||
operator|(
operator|(
name|cfg
operator|->
name|min_ifg_enforcement
operator|<<
name|IPGIFG_MIN_IFG_ENFORCEMENT_SHIFT
operator|)
operator|&
name|IPGIFG_MIN_IFG_ENFORCEMENT
operator|)
operator||
operator|(
name|cfg
operator|->
name|back_to_back_ipg
operator|&
name|IPGIFG_BACK_TO_BACK_IPG
operator|)
operator|)
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|ipgifg
argument_list|)
expr_stmt|;
comment|/***************IPGIFG************************/
comment|/***************HAFDUP************************/
name|tmp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|halfdup_alt_backoff_en
condition|)
name|tmp
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|HAFDUP_ALT_BEB
operator||
operator|(
operator|(
name|cfg
operator|->
name|halfdup_alt_backoff_val
operator|&
literal|0x0000000f
operator|)
operator|<<
name|HAFDUP_ALTERNATE_BEB_TRUNCATION_SHIFT
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|halfdup_bp_no_backoff
condition|)
name|tmp
operator||=
name|HAFDUP_BP_NO_BACKOFF
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|halfdup_no_backoff
condition|)
name|tmp
operator||=
name|HAFDUP_NO_BACKOFF
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|halfdup_excess_defer
condition|)
name|tmp
operator||=
name|HAFDUP_EXCESS_DEFER
expr_stmt|;
name|tmp
operator||=
operator|(
operator|(
name|cfg
operator|->
name|halfdup_retransmit
operator|<<
name|HAFDUP_RETRANSMISSION_MAX_SHIFT
operator|)
operator|&
name|HAFDUP_RETRANSMISSION_MAX
operator|)
expr_stmt|;
name|tmp
operator||=
operator|(
name|cfg
operator|->
name|halfdup_coll_window
operator|&
name|HAFDUP_COLLISION_WINDOW
operator|)
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|hafdup
argument_list|)
expr_stmt|;
comment|/***************HAFDUP************************/
comment|/***************MAXFRM************************/
comment|/* Initialize MAXFRM */
name|iowrite32be
argument_list|(
name|cfg
operator|->
name|maximum_frame
argument_list|,
operator|&
name|regs
operator|->
name|maxfrm
argument_list|)
expr_stmt|;
comment|/***************MAXFRM************************/
comment|/***************CAM1************************/
name|iowrite32be
argument_list|(
literal|0xffffffff
argument_list|,
operator|&
name|regs
operator|->
name|cam1
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
literal|0xffffffff
argument_list|,
operator|&
name|regs
operator|->
name|cam2
argument_list|)
expr_stmt|;
comment|/***************IMASK************************/
name|iowrite32be
argument_list|(
name|exception_mask
argument_list|,
operator|&
name|regs
operator|->
name|imask
argument_list|)
expr_stmt|;
comment|/***************IMASK************************/
comment|/***************IEVENT************************/
name|iowrite32be
argument_list|(
literal|0xffffffff
argument_list|,
operator|&
name|regs
operator|->
name|ievent
argument_list|)
expr_stmt|;
comment|/***************MACSTNADDR1/2*****************/
name|tmp
operator|=
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|macaddr
index|[
literal|5
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|macaddr
index|[
literal|4
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|macaddr
index|[
literal|3
index|]
operator|<<
literal|8
operator|)
operator||
name|macaddr
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|macstnaddr1
argument_list|)
expr_stmt|;
name|tmp
operator|=
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|macaddr
index|[
literal|1
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|macaddr
index|[
literal|0
index|]
operator|<<
literal|16
operator|)
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|macstnaddr2
argument_list|)
expr_stmt|;
comment|/***************MACSTNADDR1/2*****************/
comment|/*****************HASH************************/
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_OF_HASH_REGS
condition|;
name|i
operator|++
control|)
block|{
comment|/* Initialize IADDRx */
name|iowrite32be
argument_list|(
literal|0
argument_list|,
operator|&
name|regs
operator|->
name|igaddr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* Initialize GADDRx */
name|iowrite32be
argument_list|(
literal|0
argument_list|,
operator|&
name|regs
operator|->
name|gaddr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|fman_dtsec_reset_stat
argument_list|(
name|regs
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|uint16_t
name|fman_dtsec_get_max_frame_len
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|)
block|{
return|return
operator|(
name|uint16_t
operator|)
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|maxfrm
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|fman_dtsec_set_max_frame_len
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|,
name|uint16_t
name|length
parameter_list|)
block|{
name|iowrite32be
argument_list|(
name|length
argument_list|,
operator|&
name|regs
operator|->
name|maxfrm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_dtsec_set_mac_address
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|,
name|uint8_t
modifier|*
name|adr
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|adr
index|[
literal|5
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|adr
index|[
literal|4
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|adr
index|[
literal|3
index|]
operator|<<
literal|8
operator|)
operator||
name|adr
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|macstnaddr1
argument_list|)
expr_stmt|;
name|tmp
operator|=
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|adr
index|[
literal|1
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|adr
index|[
literal|0
index|]
operator|<<
literal|16
operator|)
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|macstnaddr2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_dtsec_get_mac_address
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|,
name|uint8_t
modifier|*
name|macaddr
parameter_list|)
block|{
name|uint32_t
name|tmp1
decl_stmt|,
name|tmp2
decl_stmt|;
name|tmp1
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|macstnaddr1
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|macstnaddr2
argument_list|)
expr_stmt|;
name|macaddr
index|[
literal|0
index|]
operator|=
call|(
name|uint8_t
call|)
argument_list|(
operator|(
name|tmp2
operator|&
literal|0x00ff0000
operator|)
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|macaddr
index|[
literal|1
index|]
operator|=
call|(
name|uint8_t
call|)
argument_list|(
operator|(
name|tmp2
operator|&
literal|0xff000000
operator|)
operator|>>
literal|24
argument_list|)
expr_stmt|;
name|macaddr
index|[
literal|2
index|]
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|tmp1
operator|&
literal|0x000000ff
argument_list|)
expr_stmt|;
name|macaddr
index|[
literal|3
index|]
operator|=
call|(
name|uint8_t
call|)
argument_list|(
operator|(
name|tmp1
operator|&
literal|0x0000ff00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|macaddr
index|[
literal|4
index|]
operator|=
call|(
name|uint8_t
call|)
argument_list|(
operator|(
name|tmp1
operator|&
literal|0x00ff0000
operator|)
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|macaddr
index|[
literal|5
index|]
operator|=
call|(
name|uint8_t
call|)
argument_list|(
operator|(
name|tmp1
operator|&
literal|0xff000000
operator|)
operator|>>
literal|24
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_dtsec_set_hash_table
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|,
name|uint32_t
name|crc
parameter_list|,
name|bool
name|mcast
parameter_list|,
name|bool
name|ghtx
parameter_list|)
block|{
name|int32_t
name|bucket
decl_stmt|;
if|if
condition|(
name|ghtx
condition|)
name|bucket
operator|=
call|(
name|int32_t
call|)
argument_list|(
operator|(
name|crc
operator|>>
literal|23
operator|)
operator|&
literal|0x1ff
argument_list|)
expr_stmt|;
else|else
block|{
name|bucket
operator|=
call|(
name|int32_t
call|)
argument_list|(
operator|(
name|crc
operator|>>
literal|24
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
comment|/* if !ghtx and mcast the bit must be set in gaddr instead of igaddr. */
if|if
condition|(
name|mcast
condition|)
name|bucket
operator|+=
literal|0x100
expr_stmt|;
block|}
name|fman_dtsec_set_bucket
argument_list|(
name|regs
argument_list|,
name|bucket
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_dtsec_set_bucket
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|,
name|int
name|bucket
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|int
name|reg_idx
init|=
operator|(
name|bucket
operator|>>
literal|5
operator|)
operator|&
literal|0xf
decl_stmt|;
name|int
name|bit_idx
init|=
name|bucket
operator|&
literal|0x1f
decl_stmt|;
name|uint32_t
name|bit_mask
init|=
literal|0x80000000
operator|>>
name|bit_idx
decl_stmt|;
name|uint32_t
modifier|*
name|reg
decl_stmt|;
if|if
condition|(
name|reg_idx
operator|>
literal|7
condition|)
name|reg
operator|=
operator|&
name|regs
operator|->
name|gaddr
index|[
name|reg_idx
operator|-
literal|8
index|]
expr_stmt|;
else|else
name|reg
operator|=
operator|&
name|regs
operator|->
name|igaddr
index|[
name|reg_idx
index|]
expr_stmt|;
if|if
condition|(
name|enable
condition|)
name|iowrite32be
argument_list|(
name|ioread32be
argument_list|(
name|reg
argument_list|)
operator||
name|bit_mask
argument_list|,
name|reg
argument_list|)
expr_stmt|;
else|else
name|iowrite32be
argument_list|(
name|ioread32be
argument_list|(
name|reg
argument_list|)
operator|&
operator|(
operator|~
name|bit_mask
operator|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_dtsec_reset_filter_table
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|,
name|bool
name|mcast
parameter_list|,
name|bool
name|ucast
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|bool
name|ghtx
decl_stmt|;
name|ghtx
operator|=
call|(
name|bool
call|)
argument_list|(
operator|(
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|rctrl
argument_list|)
operator|&
name|RCTRL_GHTX
operator|)
condition|?
name|TRUE
else|:
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ucast
operator|||
operator|(
name|ghtx
operator|&&
name|mcast
operator|)
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_OF_HASH_REGS
condition|;
name|i
operator|++
control|)
name|iowrite32be
argument_list|(
literal|0
argument_list|,
operator|&
name|regs
operator|->
name|igaddr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mcast
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_OF_HASH_REGS
condition|;
name|i
operator|++
control|)
name|iowrite32be
argument_list|(
literal|0
argument_list|,
operator|&
name|regs
operator|->
name|gaddr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|fman_dtsec_set_tbi_phy_addr
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|,
name|uint8_t
name|addr
parameter_list|)
block|{
if|if
condition|(
name|addr
operator|>
literal|0
operator|&&
name|addr
operator|<
literal|32
condition|)
name|iowrite32be
argument_list|(
name|addr
argument_list|,
operator|&
name|regs
operator|->
name|tbipa
argument_list|)
expr_stmt|;
else|else
return|return
operator|-
name|EINVAL
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|fman_dtsec_set_wol
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|,
name|bool
name|en
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|maccfg2
argument_list|)
expr_stmt|;
if|if
condition|(
name|en
condition|)
name|tmp
operator||=
name|MACCFG2_MAGIC_PACKET_EN
expr_stmt|;
else|else
name|tmp
operator|&=
operator|~
name|MACCFG2_MAGIC_PACKET_EN
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|maccfg2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|fman_dtsec_adjust_link
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|,
name|enum
name|enet_interface
name|iface_mode
parameter_list|,
name|enum
name|enet_speed
name|speed
parameter_list|,
name|bool
name|full_dx
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|UNUSED
argument_list|(
name|iface_mode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|speed
operator|==
name|E_ENET_SPEED_1000
operator|)
operator|&&
operator|!
name|full_dx
condition|)
return|return
operator|-
name|EINVAL
return|;
name|tmp
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|maccfg2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|full_dx
condition|)
name|tmp
operator|&=
operator|~
name|MACCFG2_FULL_DUPLEX
expr_stmt|;
else|else
name|tmp
operator||=
name|MACCFG2_FULL_DUPLEX
expr_stmt|;
name|tmp
operator|&=
operator|~
operator|(
name|MACCFG2_NIBBLE_MODE
operator||
name|MACCFG2_BYTE_MODE
operator|)
expr_stmt|;
if|if
condition|(
name|speed
operator|<
name|E_ENET_SPEED_1000
condition|)
name|tmp
operator||=
name|MACCFG2_NIBBLE_MODE
expr_stmt|;
elseif|else
if|if
condition|(
name|speed
operator|==
name|E_ENET_SPEED_1000
condition|)
name|tmp
operator||=
name|MACCFG2_BYTE_MODE
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|maccfg2
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|ecntrl
argument_list|)
expr_stmt|;
if|if
condition|(
name|speed
operator|==
name|E_ENET_SPEED_100
condition|)
name|tmp
operator||=
name|DTSEC_ECNTRL_R100M
expr_stmt|;
else|else
name|tmp
operator|&=
operator|~
name|DTSEC_ECNTRL_R100M
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|ecntrl
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|fman_dtsec_set_uc_promisc
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|rctrl
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
condition|)
name|tmp
operator||=
name|RCTRL_UPROM
expr_stmt|;
else|else
name|tmp
operator|&=
operator|~
name|RCTRL_UPROM
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|rctrl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_dtsec_set_mc_promisc
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|rctrl
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
condition|)
name|tmp
operator||=
name|RCTRL_MPROM
expr_stmt|;
else|else
name|tmp
operator|&=
operator|~
name|RCTRL_MPROM
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|rctrl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|bool
name|fman_dtsec_get_clear_carry_regs
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|,
name|uint32_t
modifier|*
name|car1
parameter_list|,
name|uint32_t
modifier|*
name|car2
parameter_list|)
block|{
comment|/* read carry registers */
operator|*
name|car1
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|car1
argument_list|)
expr_stmt|;
operator|*
name|car2
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|car2
argument_list|)
expr_stmt|;
comment|/* clear carry registers */
if|if
condition|(
operator|*
name|car1
condition|)
name|iowrite32be
argument_list|(
operator|*
name|car1
argument_list|,
operator|&
name|regs
operator|->
name|car1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|car2
condition|)
name|iowrite32be
argument_list|(
operator|*
name|car2
argument_list|,
operator|&
name|regs
operator|->
name|car2
argument_list|)
expr_stmt|;
return|return
call|(
name|bool
call|)
argument_list|(
operator|(
operator|*
name|car1
operator||
operator|*
name|car2
operator|)
condition|?
name|TRUE
else|:
name|FALSE
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|fman_dtsec_reset_stat
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|)
block|{
comment|/* clear HW counters */
name|iowrite32be
argument_list|(
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|ecntrl
argument_list|)
operator||
name|DTSEC_ECNTRL_CLRCNT
argument_list|,
operator|&
name|regs
operator|->
name|ecntrl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|fman_dtsec_set_stat_level
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|,
name|enum
name|dtsec_stat_level
name|level
parameter_list|)
block|{
switch|switch
condition|(
name|level
condition|)
block|{
case|case
name|E_MAC_STAT_NONE
case|:
name|iowrite32be
argument_list|(
literal|0xffffffff
argument_list|,
operator|&
name|regs
operator|->
name|cam1
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
literal|0xffffffff
argument_list|,
operator|&
name|regs
operator|->
name|cam2
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|ecntrl
argument_list|)
operator|&
operator|~
name|DTSEC_ECNTRL_STEN
argument_list|,
operator|&
name|regs
operator|->
name|ecntrl
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|imask
argument_list|)
operator|&
operator|~
name|DTSEC_IMASK_MSROEN
argument_list|,
operator|&
name|regs
operator|->
name|imask
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MAC_STAT_PARTIAL
case|:
name|iowrite32be
argument_list|(
name|CAM1_ERRORS_ONLY
argument_list|,
operator|&
name|regs
operator|->
name|cam1
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
name|CAM2_ERRORS_ONLY
argument_list|,
operator|&
name|regs
operator|->
name|cam2
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|ecntrl
argument_list|)
operator||
name|DTSEC_ECNTRL_STEN
argument_list|,
operator|&
name|regs
operator|->
name|ecntrl
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|imask
argument_list|)
operator||
name|DTSEC_IMASK_MSROEN
argument_list|,
operator|&
name|regs
operator|->
name|imask
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MAC_STAT_MIB_GRP1
case|:
name|iowrite32be
argument_list|(
operator|(
name|uint32_t
operator|)
operator|~
name|CAM1_MIB_GRP_1
argument_list|,
operator|&
name|regs
operator|->
name|cam1
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
operator|(
name|uint32_t
operator|)
operator|~
name|CAM2_MIB_GRP_1
argument_list|,
operator|&
name|regs
operator|->
name|cam2
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|ecntrl
argument_list|)
operator||
name|DTSEC_ECNTRL_STEN
argument_list|,
operator|&
name|regs
operator|->
name|ecntrl
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|imask
argument_list|)
operator||
name|DTSEC_IMASK_MSROEN
argument_list|,
operator|&
name|regs
operator|->
name|imask
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MAC_STAT_FULL
case|:
name|iowrite32be
argument_list|(
literal|0
argument_list|,
operator|&
name|regs
operator|->
name|cam1
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
literal|0
argument_list|,
operator|&
name|regs
operator|->
name|cam2
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|ecntrl
argument_list|)
operator||
name|DTSEC_ECNTRL_STEN
argument_list|,
operator|&
name|regs
operator|->
name|ecntrl
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|imask
argument_list|)
operator||
name|DTSEC_IMASK_MSROEN
argument_list|,
operator|&
name|regs
operator|->
name|imask
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|fman_dtsec_set_ts
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|,
name|bool
name|en
parameter_list|)
block|{
if|if
condition|(
name|en
condition|)
block|{
name|iowrite32be
argument_list|(
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|rctrl
argument_list|)
operator||
name|RCTRL_RTSE
argument_list|,
operator|&
name|regs
operator|->
name|rctrl
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|tctrl
argument_list|)
operator||
name|DTSEC_TCTRL_TTSE
argument_list|,
operator|&
name|regs
operator|->
name|tctrl
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|iowrite32be
argument_list|(
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|rctrl
argument_list|)
operator|&
operator|~
name|RCTRL_RTSE
argument_list|,
operator|&
name|regs
operator|->
name|rctrl
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|tctrl
argument_list|)
operator|&
operator|~
name|DTSEC_TCTRL_TTSE
argument_list|,
operator|&
name|regs
operator|->
name|tctrl
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|fman_dtsec_enable
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|,
name|bool
name|apply_rx
parameter_list|,
name|bool
name|apply_tx
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|maccfg1
argument_list|)
expr_stmt|;
if|if
condition|(
name|apply_rx
condition|)
name|tmp
operator||=
name|MACCFG1_RX_EN
expr_stmt|;
if|if
condition|(
name|apply_tx
condition|)
name|tmp
operator||=
name|MACCFG1_TX_EN
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|maccfg1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_dtsec_clear_addr_in_paddr
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|,
name|uint8_t
name|paddr_num
parameter_list|)
block|{
name|iowrite32be
argument_list|(
literal|0
argument_list|,
operator|&
name|regs
operator|->
name|macaddr
index|[
name|paddr_num
index|]
operator|.
name|exact_match1
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
literal|0
argument_list|,
operator|&
name|regs
operator|->
name|macaddr
index|[
name|paddr_num
index|]
operator|.
name|exact_match2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_dtsec_add_addr_in_paddr
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|,
name|uint64_t
name|addr
parameter_list|,
name|uint8_t
name|paddr_num
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|addr
argument_list|)
expr_stmt|;
comment|/* swap */
name|tmp
operator|=
operator|(
operator|(
operator|(
name|tmp
operator|&
literal|0x000000FF
operator|)
operator|<<
literal|24
operator|)
operator||
operator|(
operator|(
name|tmp
operator|&
literal|0x0000FF00
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
name|tmp
operator|&
literal|0x00FF0000
operator|)
operator|>>
literal|8
operator|)
operator||
operator|(
operator|(
name|tmp
operator|&
literal|0xFF000000
operator|)
operator|>>
literal|24
operator|)
operator|)
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|macaddr
index|[
name|paddr_num
index|]
operator|.
name|exact_match1
argument_list|)
expr_stmt|;
name|tmp
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|addr
operator|>>
literal|32
argument_list|)
expr_stmt|;
comment|/* swap */
name|tmp
operator|=
operator|(
operator|(
operator|(
name|tmp
operator|&
literal|0x000000FF
operator|)
operator|<<
literal|24
operator|)
operator||
operator|(
operator|(
name|tmp
operator|&
literal|0x0000FF00
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
name|tmp
operator|&
literal|0x00FF0000
operator|)
operator|>>
literal|8
operator|)
operator||
operator|(
operator|(
name|tmp
operator|&
literal|0xFF000000
operator|)
operator|>>
literal|24
operator|)
operator|)
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|macaddr
index|[
name|paddr_num
index|]
operator|.
name|exact_match2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_dtsec_disable
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|,
name|bool
name|apply_rx
parameter_list|,
name|bool
name|apply_tx
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|maccfg1
argument_list|)
expr_stmt|;
if|if
condition|(
name|apply_rx
condition|)
name|tmp
operator|&=
operator|~
name|MACCFG1_RX_EN
expr_stmt|;
if|if
condition|(
name|apply_tx
condition|)
name|tmp
operator|&=
operator|~
name|MACCFG1_TX_EN
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|maccfg1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_dtsec_set_tx_pause_frames
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|,
name|uint16_t
name|time
parameter_list|)
block|{
name|uint32_t
name|ptv
init|=
literal|0
decl_stmt|;
comment|/* fixme: don't enable tx pause for half-duplex */
if|if
condition|(
name|time
condition|)
block|{
name|ptv
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|ptv
argument_list|)
expr_stmt|;
name|ptv
operator|&=
literal|0xffff0000
expr_stmt|;
name|ptv
operator||=
name|time
operator|&
literal|0x0000ffff
expr_stmt|;
name|iowrite32be
argument_list|(
name|ptv
argument_list|,
operator|&
name|regs
operator|->
name|ptv
argument_list|)
expr_stmt|;
comment|/* trigger the transmission of a flow-control pause frame */
name|iowrite32be
argument_list|(
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|maccfg1
argument_list|)
operator||
name|MACCFG1_TX_FLOW
argument_list|,
operator|&
name|regs
operator|->
name|maccfg1
argument_list|)
expr_stmt|;
block|}
else|else
name|iowrite32be
argument_list|(
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|maccfg1
argument_list|)
operator|&
operator|~
name|MACCFG1_TX_FLOW
argument_list|,
operator|&
name|regs
operator|->
name|maccfg1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_dtsec_handle_rx_pause
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|,
name|bool
name|en
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
comment|/* todo: check if mac is set to full-duplex */
name|tmp
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|maccfg1
argument_list|)
expr_stmt|;
if|if
condition|(
name|en
condition|)
name|tmp
operator||=
name|MACCFG1_RX_FLOW
expr_stmt|;
else|else
name|tmp
operator|&=
operator|~
name|MACCFG1_RX_FLOW
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|maccfg1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|uint32_t
name|fman_dtsec_get_rctrl
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|)
block|{
return|return
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|rctrl
argument_list|)
return|;
block|}
end_function

begin_function
name|uint32_t
name|fman_dtsec_get_revision
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|)
block|{
return|return
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|tsec_id
argument_list|)
return|;
block|}
end_function

begin_function
name|uint32_t
name|fman_dtsec_get_event
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|,
name|uint32_t
name|ev_mask
parameter_list|)
block|{
return|return
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|ievent
argument_list|)
operator|&
name|ev_mask
return|;
block|}
end_function

begin_function
name|void
name|fman_dtsec_ack_event
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|,
name|uint32_t
name|ev_mask
parameter_list|)
block|{
name|iowrite32be
argument_list|(
name|ev_mask
argument_list|,
operator|&
name|regs
operator|->
name|ievent
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|uint32_t
name|fman_dtsec_get_interrupt_mask
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|)
block|{
return|return
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|imask
argument_list|)
return|;
block|}
end_function

begin_function
name|uint32_t
name|fman_dtsec_check_and_clear_tmr_event
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|)
block|{
name|uint32_t
name|event
decl_stmt|;
name|event
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|tmr_pevent
argument_list|)
expr_stmt|;
name|event
operator|&=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|tmr_pemask
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
condition|)
name|iowrite32be
argument_list|(
name|event
argument_list|,
operator|&
name|regs
operator|->
name|tmr_pevent
argument_list|)
expr_stmt|;
return|return
name|event
return|;
block|}
end_function

begin_function
name|void
name|fman_dtsec_enable_tmr_interrupt
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|)
block|{
name|iowrite32be
argument_list|(
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|tmr_pemask
argument_list|)
operator||
name|TMR_PEMASK_TSREEN
argument_list|,
operator|&
name|regs
operator|->
name|tmr_pemask
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_dtsec_disable_tmr_interrupt
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|)
block|{
name|iowrite32be
argument_list|(
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|tmr_pemask
argument_list|)
operator|&
operator|~
name|TMR_PEMASK_TSREEN
argument_list|,
operator|&
name|regs
operator|->
name|tmr_pemask
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_dtsec_enable_interrupt
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|,
name|uint32_t
name|ev_mask
parameter_list|)
block|{
name|iowrite32be
argument_list|(
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|imask
argument_list|)
operator||
name|ev_mask
argument_list|,
operator|&
name|regs
operator|->
name|imask
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_dtsec_disable_interrupt
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|,
name|uint32_t
name|ev_mask
parameter_list|)
block|{
name|iowrite32be
argument_list|(
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|imask
argument_list|)
operator|&
operator|~
name|ev_mask
argument_list|,
operator|&
name|regs
operator|->
name|imask
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|uint32_t
name|fman_dtsec_get_stat_counter
parameter_list|(
name|struct
name|dtsec_regs
modifier|*
name|regs
parameter_list|,
name|enum
name|dtsec_stat_counters
name|reg_name
parameter_list|)
block|{
name|uint32_t
name|ret_val
decl_stmt|;
switch|switch
condition|(
name|reg_name
condition|)
block|{
case|case
name|E_DTSEC_STAT_TR64
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|tr64
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_TR127
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|tr127
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_TR255
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|tr255
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_TR511
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|tr511
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_TR1K
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|tr1k
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_TRMAX
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|trmax
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_TRMGV
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|trmgv
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_RBYT
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|rbyt
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_RPKT
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|rpkt
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_RMCA
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|rmca
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_RBCA
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|rbca
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_RXPF
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|rxpf
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_RALN
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|raln
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_RFLR
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|rflr
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_RCDE
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|rcde
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_RCSE
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|rcse
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_RUND
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|rund
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_ROVR
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|rovr
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_RFRG
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|rfrg
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_RJBR
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|rjbr
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_RDRP
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|rdrp
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_TFCS
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|tfcs
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_TBYT
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|tbyt
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_TPKT
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|tpkt
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_TMCA
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|tmca
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_TBCA
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|tbca
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_TXPF
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|txpf
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_TNCL
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|tncl
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_DTSEC_STAT_TDRP
case|:
name|ret_val
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|tdrp
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ret_val
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|ret_val
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2008-2012 Freescale Semiconductor Inc.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are met:  *     * Redistributions of source code must retain the above copyright  *       notice, this list of conditions and the following disclaimer.  *     * Redistributions in binary form must reproduce the above copyright  *       notice, this list of conditions and the following disclaimer in the  *       documentation and/or other materials provided with the distribution.  *     * Neither the name of Freescale Semiconductor nor the  *       names of its contributors may be used to endorse or promote products  *       derived from this software without specific prior written permission.  *  *  * ALTERNATIVELY, this software may be distributed under the terms of the  * GNU General Public License ("GPL") as published by the Free Software  * Foundation, either version 2 of that License or (at your option) any  * later version.  *  * THIS SOFTWARE IS PROVIDED BY Freescale Semiconductor ``AS IS'' AND ANY  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED. IN NO EVENT SHALL Freescale Semiconductor BE LIABLE FOR ANY  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"fsl_fman_memac.h"
end_include

begin_function
name|uint32_t
name|fman_memac_get_event
parameter_list|(
name|struct
name|memac_regs
modifier|*
name|regs
parameter_list|,
name|uint32_t
name|ev_mask
parameter_list|)
block|{
return|return
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|ievent
argument_list|)
operator|&
name|ev_mask
return|;
block|}
end_function

begin_function
name|uint32_t
name|fman_memac_get_interrupt_mask
parameter_list|(
name|struct
name|memac_regs
modifier|*
name|regs
parameter_list|)
block|{
return|return
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|imask
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|fman_memac_ack_event
parameter_list|(
name|struct
name|memac_regs
modifier|*
name|regs
parameter_list|,
name|uint32_t
name|ev_mask
parameter_list|)
block|{
name|iowrite32be
argument_list|(
name|ev_mask
argument_list|,
operator|&
name|regs
operator|->
name|ievent
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_memac_set_promiscuous
parameter_list|(
name|struct
name|memac_regs
modifier|*
name|regs
parameter_list|,
name|bool
name|val
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|command_config
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
condition|)
name|tmp
operator||=
name|CMD_CFG_PROMIS_EN
expr_stmt|;
else|else
name|tmp
operator|&=
operator|~
name|CMD_CFG_PROMIS_EN
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|command_config
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_memac_clear_addr_in_paddr
parameter_list|(
name|struct
name|memac_regs
modifier|*
name|regs
parameter_list|,
name|uint8_t
name|paddr_num
parameter_list|)
block|{
if|if
condition|(
name|paddr_num
operator|==
literal|0
condition|)
block|{
name|iowrite32be
argument_list|(
literal|0
argument_list|,
operator|&
name|regs
operator|->
name|mac_addr0
operator|.
name|mac_addr_l
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
literal|0
argument_list|,
operator|&
name|regs
operator|->
name|mac_addr0
operator|.
name|mac_addr_u
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|iowrite32be
argument_list|(
literal|0x0
argument_list|,
operator|&
name|regs
operator|->
name|mac_addr
index|[
name|paddr_num
operator|-
literal|1
index|]
operator|.
name|mac_addr_l
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
literal|0x0
argument_list|,
operator|&
name|regs
operator|->
name|mac_addr
index|[
name|paddr_num
operator|-
literal|1
index|]
operator|.
name|mac_addr_u
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|fman_memac_add_addr_in_paddr
parameter_list|(
name|struct
name|memac_regs
modifier|*
name|regs
parameter_list|,
name|uint8_t
modifier|*
name|adr
parameter_list|,
name|uint8_t
name|paddr_num
parameter_list|)
block|{
name|uint32_t
name|tmp0
decl_stmt|,
name|tmp1
decl_stmt|;
name|tmp0
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|adr
index|[
literal|0
index|]
operator||
name|adr
index|[
literal|1
index|]
operator|<<
literal|8
operator||
name|adr
index|[
literal|2
index|]
operator|<<
literal|16
operator||
name|adr
index|[
literal|3
index|]
operator|<<
literal|24
argument_list|)
expr_stmt|;
name|tmp1
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|adr
index|[
literal|4
index|]
operator||
name|adr
index|[
literal|5
index|]
operator|<<
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|paddr_num
operator|==
literal|0
condition|)
block|{
name|iowrite32be
argument_list|(
name|tmp0
argument_list|,
operator|&
name|regs
operator|->
name|mac_addr0
operator|.
name|mac_addr_l
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp1
argument_list|,
operator|&
name|regs
operator|->
name|mac_addr0
operator|.
name|mac_addr_u
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|iowrite32be
argument_list|(
name|tmp0
argument_list|,
operator|&
name|regs
operator|->
name|mac_addr
index|[
name|paddr_num
operator|-
literal|1
index|]
operator|.
name|mac_addr_l
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp1
argument_list|,
operator|&
name|regs
operator|->
name|mac_addr
index|[
name|paddr_num
operator|-
literal|1
index|]
operator|.
name|mac_addr_u
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|fman_memac_enable
parameter_list|(
name|struct
name|memac_regs
modifier|*
name|regs
parameter_list|,
name|bool
name|apply_rx
parameter_list|,
name|bool
name|apply_tx
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|command_config
argument_list|)
expr_stmt|;
if|if
condition|(
name|apply_rx
condition|)
name|tmp
operator||=
name|CMD_CFG_RX_EN
expr_stmt|;
if|if
condition|(
name|apply_tx
condition|)
name|tmp
operator||=
name|CMD_CFG_TX_EN
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|command_config
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_memac_disable
parameter_list|(
name|struct
name|memac_regs
modifier|*
name|regs
parameter_list|,
name|bool
name|apply_rx
parameter_list|,
name|bool
name|apply_tx
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|command_config
argument_list|)
expr_stmt|;
if|if
condition|(
name|apply_rx
condition|)
name|tmp
operator|&=
operator|~
name|CMD_CFG_RX_EN
expr_stmt|;
if|if
condition|(
name|apply_tx
condition|)
name|tmp
operator|&=
operator|~
name|CMD_CFG_TX_EN
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|command_config
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_memac_reset_stat
parameter_list|(
name|struct
name|memac_regs
modifier|*
name|regs
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|statn_config
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|STATS_CFG_CLR
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|statn_config
argument_list|)
expr_stmt|;
while|while
condition|(
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|statn_config
argument_list|)
operator|&
name|STATS_CFG_CLR
condition|)
empty_stmt|;
block|}
end_function

begin_function
name|void
name|fman_memac_reset
parameter_list|(
name|struct
name|memac_regs
modifier|*
name|regs
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|command_config
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|CMD_CFG_SW_RESET
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|command_config
argument_list|)
expr_stmt|;
while|while
condition|(
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|command_config
argument_list|)
operator|&
name|CMD_CFG_SW_RESET
condition|)
empty_stmt|;
block|}
end_function

begin_function
name|int
name|fman_memac_init
parameter_list|(
name|struct
name|memac_regs
modifier|*
name|regs
parameter_list|,
name|struct
name|memac_cfg
modifier|*
name|cfg
parameter_list|,
name|enum
name|enet_interface
name|enet_interface
parameter_list|,
name|enum
name|enet_speed
name|enet_speed
parameter_list|,
name|bool
name|slow_10g_if
parameter_list|,
name|uint32_t
name|exceptions
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
comment|/* Config */
name|tmp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|wan_mode_enable
condition|)
name|tmp
operator||=
name|CMD_CFG_WAN_MODE
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|promiscuous_mode_enable
condition|)
name|tmp
operator||=
name|CMD_CFG_PROMIS_EN
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|pause_forward_enable
condition|)
name|tmp
operator||=
name|CMD_CFG_PAUSE_FWD
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|pause_ignore
condition|)
name|tmp
operator||=
name|CMD_CFG_PAUSE_IGNORE
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|tx_addr_ins_enable
condition|)
name|tmp
operator||=
name|CMD_CFG_TX_ADDR_INS
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|loopback_enable
condition|)
name|tmp
operator||=
name|CMD_CFG_LOOPBACK_EN
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|cmd_frame_enable
condition|)
name|tmp
operator||=
name|CMD_CFG_CNT_FRM_EN
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|send_idle_enable
condition|)
name|tmp
operator||=
name|CMD_CFG_SEND_IDLE
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|no_length_check_enable
condition|)
name|tmp
operator||=
name|CMD_CFG_NO_LEN_CHK
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|rx_sfd_any
condition|)
name|tmp
operator||=
name|CMD_CFG_SFD_ANY
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|pad_enable
condition|)
name|tmp
operator||=
name|CMD_CFG_TX_PAD_EN
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|wake_on_lan
condition|)
name|tmp
operator||=
name|CMD_CFG_MG
expr_stmt|;
name|tmp
operator||=
name|CMD_CFG_CRC_FWD
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|command_config
argument_list|)
expr_stmt|;
comment|/* Max Frame Length */
name|iowrite32be
argument_list|(
operator|(
name|uint32_t
operator|)
name|cfg
operator|->
name|max_frame_length
argument_list|,
operator|&
name|regs
operator|->
name|maxfrm
argument_list|)
expr_stmt|;
comment|/* Pause Time */
name|iowrite32be
argument_list|(
operator|(
name|uint32_t
operator|)
name|cfg
operator|->
name|pause_quanta
argument_list|,
operator|&
name|regs
operator|->
name|pause_quanta
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
operator|(
name|uint32_t
operator|)
literal|0
argument_list|,
operator|&
name|regs
operator|->
name|pause_thresh
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
comment|/* IF_MODE */
name|tmp
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|enet_interface
condition|)
block|{
case|case
name|E_ENET_IF_XGMII
case|:
case|case
name|E_ENET_IF_XFI
case|:
name|tmp
operator||=
name|IF_MODE_XGMII
expr_stmt|;
break|break;
default|default:
name|tmp
operator||=
name|IF_MODE_GMII
expr_stmt|;
if|if
condition|(
name|enet_interface
operator|==
name|E_ENET_IF_RGMII
operator|&&
operator|!
name|cfg
operator|->
name|loopback_enable
condition|)
name|tmp
operator||=
name|IF_MODE_RGMII
operator||
name|IF_MODE_RGMII_AUTO
expr_stmt|;
block|}
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|if_mode
argument_list|)
expr_stmt|;
comment|/* TX_FIFO_SECTIONS */
name|tmp
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|enet_interface
operator|==
name|E_ENET_IF_XGMII
operator|||
name|enet_interface
operator|==
name|E_ENET_IF_XFI
condition|)
block|{
if|if
condition|(
name|slow_10g_if
condition|)
block|{
name|tmp
operator||=
operator|(
name|TX_FIFO_SECTIONS_TX_AVAIL_SLOW_10G
operator||
name|TX_FIFO_SECTIONS_TX_EMPTY_DEFAULT_10G
operator|)
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator||=
operator|(
name|TX_FIFO_SECTIONS_TX_AVAIL_10G
operator||
name|TX_FIFO_SECTIONS_TX_EMPTY_DEFAULT_10G
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|tmp
operator||=
operator|(
name|TX_FIFO_SECTIONS_TX_AVAIL_1G
operator||
name|TX_FIFO_SECTIONS_TX_EMPTY_DEFAULT_1G
operator|)
expr_stmt|;
block|}
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|tx_fifo_sections
argument_list|)
expr_stmt|;
comment|/* clear all pending events and set-up interrupts */
name|fman_memac_ack_event
argument_list|(
name|regs
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|fman_memac_set_exception
argument_list|(
name|regs
argument_list|,
name|exceptions
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|fman_memac_set_exception
parameter_list|(
name|struct
name|memac_regs
modifier|*
name|regs
parameter_list|,
name|uint32_t
name|val
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|imask
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
condition|)
name|tmp
operator||=
name|val
expr_stmt|;
else|else
name|tmp
operator|&=
operator|~
name|val
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|imask
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_memac_reset_filter_table
parameter_list|(
name|struct
name|memac_regs
modifier|*
name|regs
parameter_list|)
block|{
name|uint32_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|64
condition|;
name|i
operator|++
control|)
name|iowrite32be
argument_list|(
name|i
operator|&
operator|~
name|HASH_CTRL_MCAST_EN
argument_list|,
operator|&
name|regs
operator|->
name|hashtable_ctrl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_memac_set_hash_table_entry
parameter_list|(
name|struct
name|memac_regs
modifier|*
name|regs
parameter_list|,
name|uint32_t
name|crc
parameter_list|)
block|{
name|iowrite32be
argument_list|(
name|crc
operator||
name|HASH_CTRL_MCAST_EN
argument_list|,
operator|&
name|regs
operator|->
name|hashtable_ctrl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_memac_set_hash_table
parameter_list|(
name|struct
name|memac_regs
modifier|*
name|regs
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|iowrite32be
argument_list|(
name|val
argument_list|,
operator|&
name|regs
operator|->
name|hashtable_ctrl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|uint16_t
name|fman_memac_get_max_frame_len
parameter_list|(
name|struct
name|memac_regs
modifier|*
name|regs
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|maxfrm
argument_list|)
expr_stmt|;
return|return
operator|(
name|uint16_t
operator|)
name|tmp
return|;
block|}
end_function

begin_function
name|void
name|fman_memac_set_tx_pause_frames
parameter_list|(
name|struct
name|memac_regs
modifier|*
name|regs
parameter_list|,
name|uint8_t
name|priority
parameter_list|,
name|uint16_t
name|pause_time
parameter_list|,
name|uint16_t
name|thresh_time
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|tx_fifo_sections
argument_list|)
expr_stmt|;
if|if
condition|(
name|priority
operator|==
literal|0xff
condition|)
block|{
name|GET_TX_EMPTY_DEFAULT_VALUE
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|tx_fifo_sections
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|command_config
argument_list|)
expr_stmt|;
name|tmp
operator|&=
operator|~
name|CMD_CFG_PFC_MODE
expr_stmt|;
name|priority
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|GET_TX_EMPTY_PFC_VALUE
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|tx_fifo_sections
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|command_config
argument_list|)
expr_stmt|;
name|tmp
operator||=
name|CMD_CFG_PFC_MODE
expr_stmt|;
block|}
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|command_config
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|pause_quanta
index|[
name|priority
operator|/
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|priority
operator|%
literal|2
condition|)
name|tmp
operator|&=
literal|0x0000FFFF
expr_stmt|;
else|else
name|tmp
operator|&=
literal|0xFFFF0000
expr_stmt|;
name|tmp
operator||=
operator|(
operator|(
name|uint32_t
operator|)
name|pause_time
operator|<<
operator|(
literal|16
operator|*
operator|(
name|priority
operator|%
literal|2
operator|)
operator|)
operator|)
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|pause_quanta
index|[
name|priority
operator|/
literal|2
index|]
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|pause_thresh
index|[
name|priority
operator|/
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|priority
operator|%
literal|2
condition|)
name|tmp
operator|&=
literal|0x0000FFFF
expr_stmt|;
else|else
name|tmp
operator|&=
literal|0xFFFF0000
expr_stmt|;
name|tmp
operator||=
operator|(
operator|(
name|uint32_t
operator|)
name|thresh_time
operator|<<
operator|(
literal|16
operator|*
operator|(
name|priority
operator|%
literal|2
operator|)
operator|)
operator|)
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|pause_thresh
index|[
name|priority
operator|/
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_memac_set_rx_ignore_pause_frames
parameter_list|(
name|struct
name|memac_regs
modifier|*
name|regs
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|command_config
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
condition|)
name|tmp
operator||=
name|CMD_CFG_PAUSE_IGNORE
expr_stmt|;
else|else
name|tmp
operator|&=
operator|~
name|CMD_CFG_PAUSE_IGNORE
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|command_config
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_memac_set_wol
parameter_list|(
name|struct
name|memac_regs
modifier|*
name|regs
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|command_config
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
condition|)
name|tmp
operator||=
name|CMD_CFG_MG
expr_stmt|;
else|else
name|tmp
operator|&=
operator|~
name|CMD_CFG_MG
expr_stmt|;
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|command_config
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|GET_MEMAC_CNTR_64
parameter_list|(
name|bn
parameter_list|)
define|\
value|(ioread32be(&regs->bn ## _l) | \         ((uint64_t)ioread32be(&regs->bn ## _u)<< 32))
end_define

begin_function
name|uint64_t
name|fman_memac_get_counter
parameter_list|(
name|struct
name|memac_regs
modifier|*
name|regs
parameter_list|,
name|enum
name|memac_counters
name|reg_name
parameter_list|)
block|{
name|uint64_t
name|ret_val
decl_stmt|;
switch|switch
condition|(
name|reg_name
condition|)
block|{
case|case
name|E_MEMAC_COUNTER_R64
case|:
name|ret_val
operator|=
name|GET_MEMAC_CNTR_64
argument_list|(
name|r64
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MEMAC_COUNTER_R127
case|:
name|ret_val
operator|=
name|GET_MEMAC_CNTR_64
argument_list|(
name|r127
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MEMAC_COUNTER_R255
case|:
name|ret_val
operator|=
name|GET_MEMAC_CNTR_64
argument_list|(
name|r255
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MEMAC_COUNTER_R511
case|:
name|ret_val
operator|=
name|GET_MEMAC_CNTR_64
argument_list|(
name|r511
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MEMAC_COUNTER_R1023
case|:
name|ret_val
operator|=
name|GET_MEMAC_CNTR_64
argument_list|(
name|r1023
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MEMAC_COUNTER_R1518
case|:
name|ret_val
operator|=
name|GET_MEMAC_CNTR_64
argument_list|(
name|r1518
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MEMAC_COUNTER_R1519X
case|:
name|ret_val
operator|=
name|GET_MEMAC_CNTR_64
argument_list|(
name|r1519x
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MEMAC_COUNTER_RFRG
case|:
name|ret_val
operator|=
name|GET_MEMAC_CNTR_64
argument_list|(
name|rfrg
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MEMAC_COUNTER_RJBR
case|:
name|ret_val
operator|=
name|GET_MEMAC_CNTR_64
argument_list|(
name|rjbr
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MEMAC_COUNTER_RDRP
case|:
name|ret_val
operator|=
name|GET_MEMAC_CNTR_64
argument_list|(
name|rdrp
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MEMAC_COUNTER_RALN
case|:
name|ret_val
operator|=
name|GET_MEMAC_CNTR_64
argument_list|(
name|raln
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MEMAC_COUNTER_TUND
case|:
name|ret_val
operator|=
name|GET_MEMAC_CNTR_64
argument_list|(
name|tund
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MEMAC_COUNTER_ROVR
case|:
name|ret_val
operator|=
name|GET_MEMAC_CNTR_64
argument_list|(
name|rovr
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MEMAC_COUNTER_RXPF
case|:
name|ret_val
operator|=
name|GET_MEMAC_CNTR_64
argument_list|(
name|rxpf
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MEMAC_COUNTER_TXPF
case|:
name|ret_val
operator|=
name|GET_MEMAC_CNTR_64
argument_list|(
name|txpf
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MEMAC_COUNTER_ROCT
case|:
name|ret_val
operator|=
name|GET_MEMAC_CNTR_64
argument_list|(
name|roct
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MEMAC_COUNTER_RMCA
case|:
name|ret_val
operator|=
name|GET_MEMAC_CNTR_64
argument_list|(
name|rmca
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MEMAC_COUNTER_RBCA
case|:
name|ret_val
operator|=
name|GET_MEMAC_CNTR_64
argument_list|(
name|rbca
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MEMAC_COUNTER_RPKT
case|:
name|ret_val
operator|=
name|GET_MEMAC_CNTR_64
argument_list|(
name|rpkt
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MEMAC_COUNTER_RUCA
case|:
name|ret_val
operator|=
name|GET_MEMAC_CNTR_64
argument_list|(
name|ruca
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MEMAC_COUNTER_RERR
case|:
name|ret_val
operator|=
name|GET_MEMAC_CNTR_64
argument_list|(
name|rerr
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MEMAC_COUNTER_TOCT
case|:
name|ret_val
operator|=
name|GET_MEMAC_CNTR_64
argument_list|(
name|toct
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MEMAC_COUNTER_TMCA
case|:
name|ret_val
operator|=
name|GET_MEMAC_CNTR_64
argument_list|(
name|tmca
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MEMAC_COUNTER_TBCA
case|:
name|ret_val
operator|=
name|GET_MEMAC_CNTR_64
argument_list|(
name|tbca
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MEMAC_COUNTER_TUCA
case|:
name|ret_val
operator|=
name|GET_MEMAC_CNTR_64
argument_list|(
name|tuca
argument_list|)
expr_stmt|;
break|break;
case|case
name|E_MEMAC_COUNTER_TERR
case|:
name|ret_val
operator|=
name|GET_MEMAC_CNTR_64
argument_list|(
name|terr
argument_list|)
expr_stmt|;
break|break;
default|default:
name|ret_val
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|ret_val
return|;
block|}
end_function

begin_function
name|void
name|fman_memac_adjust_link
parameter_list|(
name|struct
name|memac_regs
modifier|*
name|regs
parameter_list|,
name|enum
name|enet_interface
name|iface_mode
parameter_list|,
name|enum
name|enet_speed
name|speed
parameter_list|,
name|bool
name|full_dx
parameter_list|)
block|{
name|uint32_t
name|tmp
decl_stmt|;
name|tmp
operator|=
name|ioread32be
argument_list|(
operator|&
name|regs
operator|->
name|if_mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|full_dx
condition|)
name|tmp
operator|&=
operator|~
name|IF_MODE_HD
expr_stmt|;
else|else
name|tmp
operator||=
name|IF_MODE_HD
expr_stmt|;
if|if
condition|(
name|iface_mode
operator|==
name|E_ENET_IF_RGMII
condition|)
block|{
comment|/* Configure RGMII in manual mode */
name|tmp
operator|&=
operator|~
name|IF_MODE_RGMII_AUTO
expr_stmt|;
name|tmp
operator|&=
operator|~
name|IF_MODE_RGMII_SP_MASK
expr_stmt|;
if|if
condition|(
name|full_dx
condition|)
name|tmp
operator||=
name|IF_MODE_RGMII_FD
expr_stmt|;
else|else
name|tmp
operator|&=
operator|~
name|IF_MODE_RGMII_FD
expr_stmt|;
switch|switch
condition|(
name|speed
condition|)
block|{
case|case
name|E_ENET_SPEED_1000
case|:
name|tmp
operator||=
name|IF_MODE_RGMII_1000
expr_stmt|;
break|break;
case|case
name|E_ENET_SPEED_100
case|:
name|tmp
operator||=
name|IF_MODE_RGMII_100
expr_stmt|;
break|break;
case|case
name|E_ENET_SPEED_10
case|:
name|tmp
operator||=
name|IF_MODE_RGMII_10
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
name|iowrite32be
argument_list|(
name|tmp
argument_list|,
operator|&
name|regs
operator|->
name|if_mode
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|fman_memac_defconfig
parameter_list|(
name|struct
name|memac_cfg
modifier|*
name|cfg
parameter_list|)
block|{
name|cfg
operator|->
name|reset_on_init
operator|=
name|FALSE
expr_stmt|;
name|cfg
operator|->
name|wan_mode_enable
operator|=
name|FALSE
expr_stmt|;
name|cfg
operator|->
name|promiscuous_mode_enable
operator|=
name|FALSE
expr_stmt|;
name|cfg
operator|->
name|pause_forward_enable
operator|=
name|FALSE
expr_stmt|;
name|cfg
operator|->
name|pause_ignore
operator|=
name|FALSE
expr_stmt|;
name|cfg
operator|->
name|tx_addr_ins_enable
operator|=
name|FALSE
expr_stmt|;
name|cfg
operator|->
name|loopback_enable
operator|=
name|FALSE
expr_stmt|;
name|cfg
operator|->
name|cmd_frame_enable
operator|=
name|FALSE
expr_stmt|;
name|cfg
operator|->
name|rx_error_discard
operator|=
name|FALSE
expr_stmt|;
name|cfg
operator|->
name|send_idle_enable
operator|=
name|FALSE
expr_stmt|;
name|cfg
operator|->
name|no_length_check_enable
operator|=
name|TRUE
expr_stmt|;
name|cfg
operator|->
name|lgth_check_nostdr
operator|=
name|FALSE
expr_stmt|;
name|cfg
operator|->
name|time_stamp_enable
operator|=
name|FALSE
expr_stmt|;
name|cfg
operator|->
name|tx_ipg_length
operator|=
name|DEFAULT_TX_IPG_LENGTH
expr_stmt|;
name|cfg
operator|->
name|max_frame_length
operator|=
name|DEFAULT_FRAME_LENGTH
expr_stmt|;
name|cfg
operator|->
name|pause_quanta
operator|=
name|DEFAULT_PAUSE_QUANTA
expr_stmt|;
name|cfg
operator|->
name|pad_enable
operator|=
name|TRUE
expr_stmt|;
name|cfg
operator|->
name|phy_tx_ena_on
operator|=
name|FALSE
expr_stmt|;
name|cfg
operator|->
name|rx_sfd_any
operator|=
name|FALSE
expr_stmt|;
name|cfg
operator|->
name|rx_pbl_fwd
operator|=
name|FALSE
expr_stmt|;
name|cfg
operator|->
name|tx_pbl_fwd
operator|=
name|FALSE
expr_stmt|;
name|cfg
operator|->
name|debug_mode
operator|=
name|FALSE
expr_stmt|;
name|cfg
operator|->
name|wake_on_lan
operator|=
name|FALSE
expr_stmt|;
block|}
end_function

end_unit


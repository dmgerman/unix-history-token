begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2008-2013 Freescale Semiconductor Inc.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are met:  *     * Redistributions of source code must retain the above copyright  *       notice, this list of conditions and the following disclaimer.  *     * Redistributions in binary form must reproduce the above copyright  *       notice, this list of conditions and the following disclaimer in the  *       documentation and/or other materials provided with the distribution.  *     * Neither the name of Freescale Semiconductor nor the  *       names of its contributors may be used to endorse or promote products  *       derived from this software without specific prior written permission.  *  *  * ALTERNATIVELY, this software may be distributed under the terms of the  * GNU General Public License ("GPL") as published by the Free Software  * Foundation, either version 2 of that License or (at your option) any  * later version.  *  * THIS SOFTWARE IS PROVIDED BY Freescale Semiconductor ``AS IS'' AND ANY  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED. IN NO EVENT SHALL Freescale Semiconductor BE LIABLE FOR ANY  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/******************************************************************************  @File          dtsec.c   @Description   FMan dTSEC driver */
end_comment

begin_comment
comment|/***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|"std_ext.h"
end_include

begin_include
include|#
directive|include
file|"error_ext.h"
end_include

begin_include
include|#
directive|include
file|"string_ext.h"
end_include

begin_include
include|#
directive|include
file|"xx_ext.h"
end_include

begin_include
include|#
directive|include
file|"endian_ext.h"
end_include

begin_include
include|#
directive|include
file|"debug_ext.h"
end_include

begin_include
include|#
directive|include
file|"crc_mac_addr_ext.h"
end_include

begin_include
include|#
directive|include
file|"fm_common.h"
end_include

begin_include
include|#
directive|include
file|"dtsec.h"
end_include

begin_include
include|#
directive|include
file|"fsl_fman_dtsec.h"
end_include

begin_include
include|#
directive|include
file|"fsl_fman_dtsec_mii_acc.h"
end_include

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*                      Internal routines                                    */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
specifier|static
name|t_Error
name|CheckInitParameters
parameter_list|(
name|t_Dtsec
modifier|*
name|p_Dtsec
parameter_list|)
block|{
if|if
condition|(
name|ENET_SPEED_FROM_MODE
argument_list|(
name|p_Dtsec
operator|->
name|enetMode
argument_list|)
operator|>=
name|e_ENET_SPEED_10000
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Ethernet 1G MAC driver only supports 1G or lower speeds"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Dtsec
operator|->
name|macId
operator|>=
name|FM_MAX_NUM_OF_1G_MACS
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"macId can not be greater than the number of 1G MACs"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Dtsec
operator|->
name|addr
operator|==
literal|0
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Ethernet MAC Must have a valid MAC Address"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ENET_SPEED_FROM_MODE
argument_list|(
name|p_Dtsec
operator|->
name|enetMode
argument_list|)
operator|>=
name|e_ENET_SPEED_1000
operator|)
operator|&&
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|halfdup_on
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Ethernet MAC 1G can't work in half duplex"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|halfdup_on
operator|&&
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|loopback
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"LoopBack is not supported in halfDuplex mode"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_RX_PREAM_4_ERRATA_DTSEC_A001
if|if
condition|(
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|fmRevInfo
operator|.
name|majorRev
operator|<=
literal|6
condition|)
comment|/* fixed for rev3 */
if|if
condition|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|rx_preamble
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"preambleRxEn"
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* FM_RX_PREAM_4_ERRATA_DTSEC_A001 */
if|if
condition|(
operator|(
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|tx_preamble
operator|||
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|rx_preamble
operator|)
operator|&&
operator|(
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|preamble_len
operator|!=
literal|0x7
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Preamble length should be 0x7 bytes"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|halfdup_on
operator|&&
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|tx_time_stamp_en
operator|||
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|rx_time_stamp_en
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"dTSEC in half duplex mode has to be with 1588 timeStamping diable"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|rx_flow
operator|&&
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|rx_ctrl_acc
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Receive control frame are not passed to the system memory so it can not be accept "
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|rx_prepend
operator|>
name|MAX_PACKET_ALIGNMENT
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"packetAlignmentPadding can't be greater than %d "
operator|,
name|MAX_PACKET_ALIGNMENT
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|non_back_to_back_ipg1
operator|>
name|MAX_INTER_PACKET_GAP
operator|)
operator|||
operator|(
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|non_back_to_back_ipg2
operator|>
name|MAX_INTER_PACKET_GAP
operator|)
operator|||
operator|(
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|back_to_back_ipg
operator|>
name|MAX_INTER_PACKET_GAP
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Inter packet gap can't be greater than %d "
operator|,
name|MAX_INTER_PACKET_GAP
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|halfdup_alt_backoff_val
operator|>
name|MAX_INTER_PALTERNATE_BEB
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"alternateBackoffVal can't be greater than %d "
operator|,
name|MAX_INTER_PALTERNATE_BEB
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|halfdup_retransmit
operator|>
name|MAX_RETRANSMISSION
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"maxRetransmission can't be greater than %d "
operator|,
name|MAX_RETRANSMISSION
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|halfdup_coll_window
operator|>
name|MAX_COLLISION_WINDOW
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"collisionWindow can't be greater than %d "
operator|,
name|MAX_COLLISION_WINDOW
operator|)
argument_list|)
expr_stmt|;
comment|/*  If Auto negotiation process is disabled, need to */
comment|/*  Set up the PHY using the MII Management Interface */
if|if
condition|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|tbipa
operator|>
name|MAX_PHYS
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_IN_RANGE
argument_list|,
operator|(
literal|"PHY address (should be 0-%d)"
operator|,
name|MAX_PHYS
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Dtsec
operator|->
name|f_Exception
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
operator|(
literal|"uninitialized f_Exception"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Dtsec
operator|->
name|f_Event
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
operator|(
literal|"uninitialized f_Event"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_LEN_CHECK_ERRATA_FMAN_SW002
if|if
condition|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|rx_len_check
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"LengthCheck!"
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* FM_LEN_CHECK_ERRATA_FMAN_SW002 */
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|uint32_t
name|GetMacAddrHashCode
parameter_list|(
name|uint64_t
name|ethAddr
parameter_list|)
block|{
name|uint32_t
name|crc
decl_stmt|;
comment|/* CRC calculation */
name|GET_MAC_ADDR_CRC
argument_list|(
name|ethAddr
argument_list|,
name|crc
argument_list|)
expr_stmt|;
name|crc
operator|=
name|GetMirror32
argument_list|(
name|crc
argument_list|)
expr_stmt|;
return|return
name|crc
return|;
block|}
end_function

begin_comment
comment|/* ......................................................................... */
end_comment

begin_function
specifier|static
name|void
name|UpdateStatistics
parameter_list|(
name|t_Dtsec
modifier|*
name|p_Dtsec
parameter_list|)
block|{
name|uint32_t
name|car1
decl_stmt|,
name|car2
decl_stmt|;
name|fman_dtsec_get_clear_carry_regs
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
operator|&
name|car1
argument_list|,
operator|&
name|car2
argument_list|)
expr_stmt|;
if|if
condition|(
name|car1
condition|)
block|{
if|if
condition|(
name|car1
operator|&
name|CAR1_TR64
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tr64
operator|+=
name|VAL22BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_TR127
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tr127
operator|+=
name|VAL22BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_TR255
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tr255
operator|+=
name|VAL22BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_TR511
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tr511
operator|+=
name|VAL22BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_TRK1
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tr1k
operator|+=
name|VAL22BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_TRMAX
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|trmax
operator|+=
name|VAL22BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_TRMGV
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|trmgv
operator|+=
name|VAL22BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_RBYT
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rbyt
operator|+=
operator|(
name|uint64_t
operator|)
name|VAL32BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_RPKT
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rpkt
operator|+=
name|VAL22BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_RMCA
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rmca
operator|+=
name|VAL22BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_RBCA
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rbca
operator|+=
name|VAL22BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_RXPF
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rxpf
operator|+=
name|VAL16BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_RALN
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|raln
operator|+=
name|VAL16BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_RFLR
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rflr
operator|+=
name|VAL16BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_RCDE
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rcde
operator|+=
name|VAL16BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_RCSE
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rcse
operator|+=
name|VAL16BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_RUND
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rund
operator|+=
name|VAL16BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_ROVR
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rovr
operator|+=
name|VAL16BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_RFRG
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rfrg
operator|+=
name|VAL16BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_RJBR
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rjbr
operator|+=
name|VAL16BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_RDRP
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rdrp
operator|+=
name|VAL16BIT
expr_stmt|;
block|}
if|if
condition|(
name|car2
condition|)
block|{
if|if
condition|(
name|car2
operator|&
name|CAR2_TFCS
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tfcs
operator|+=
name|VAL12BIT
expr_stmt|;
if|if
condition|(
name|car2
operator|&
name|CAR2_TBYT
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tbyt
operator|+=
operator|(
name|uint64_t
operator|)
name|VAL32BIT
expr_stmt|;
if|if
condition|(
name|car2
operator|&
name|CAR2_TPKT
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tpkt
operator|+=
name|VAL22BIT
expr_stmt|;
if|if
condition|(
name|car2
operator|&
name|CAR2_TMCA
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tmca
operator|+=
name|VAL22BIT
expr_stmt|;
if|if
condition|(
name|car2
operator|&
name|CAR2_TBCA
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tbca
operator|+=
name|VAL22BIT
expr_stmt|;
if|if
condition|(
name|car2
operator|&
name|CAR2_TXPF
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|txpf
operator|+=
name|VAL16BIT
expr_stmt|;
if|if
condition|(
name|car2
operator|&
name|CAR2_TDRP
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tdrp
operator|+=
name|VAL16BIT
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|uint16_t
name|DtsecGetMaxFrameLength
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|fman_dtsec_get_max_frame_len
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|void
name|DtsecIsr
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|uint32_t
name|event
decl_stmt|;
name|struct
name|dtsec_regs
modifier|*
name|p_DtsecMemMap
init|=
name|p_Dtsec
operator|->
name|p_MemMap
decl_stmt|;
comment|/* do not handle MDIO events */
name|event
operator|=
name|fman_dtsec_get_event
argument_list|(
name|p_DtsecMemMap
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
operator|~
operator|(
name|DTSEC_IMASK_MMRDEN
operator||
name|DTSEC_IMASK_MMWREN
operator|)
argument_list|)
argument_list|)
expr_stmt|;
name|event
operator|&=
name|fman_dtsec_get_interrupt_mask
argument_list|(
name|p_DtsecMemMap
argument_list|)
expr_stmt|;
name|fman_dtsec_ack_event
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|DTSEC_IMASK_BREN
condition|)
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_BAB_RX
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|DTSEC_IMASK_RXCEN
condition|)
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_RX_CTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|DTSEC_IMASK_MSROEN
condition|)
name|UpdateStatistics
argument_list|(
name|p_Dtsec
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|DTSEC_IMASK_GTSCEN
condition|)
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_GRATEFUL_TX_STP_COMPLET
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|DTSEC_IMASK_BTEN
condition|)
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_BAB_TX
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|DTSEC_IMASK_TXCEN
condition|)
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_TX_CTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|DTSEC_IMASK_TXEEN
condition|)
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_TX_ERR
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|DTSEC_IMASK_LCEN
condition|)
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_LATE_COL
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|DTSEC_IMASK_CRLEN
condition|)
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_COL_RET_LMT
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|DTSEC_IMASK_XFUNEN
condition|)
block|{
ifdef|#
directive|ifdef
name|FM_TX_LOCKUP_ERRATA_DTSEC6
if|if
condition|(
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|fmRevInfo
operator|.
name|majorRev
operator|==
literal|2
condition|)
block|{
name|uint32_t
name|tpkt1
decl_stmt|,
name|tmpReg1
decl_stmt|,
name|tpkt2
decl_stmt|,
name|tmpReg2
decl_stmt|,
name|i
decl_stmt|;
comment|/* a. Write 0x00E0_0C00 to DTSEC_ID */
comment|/* This is a read only regidter */
comment|/* b. Read and save the value of TPKT */
name|tpkt1
operator|=
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tpkt
argument_list|)
expr_stmt|;
comment|/* c. Read the register at dTSEC address offset 0x32C */
name|tmpReg1
operator|=
name|GET_UINT32
argument_list|(
operator|*
operator|(
name|uint32_t
operator|*
operator|)
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|p_DtsecMemMap
operator|+
literal|0x32c
operator|)
argument_list|)
expr_stmt|;
comment|/* d. Compare bits [9:15] to bits [25:31] of the register at address offset 0x32C. */
if|if
condition|(
operator|(
name|tmpReg1
operator|&
literal|0x007F0000
operator|)
operator|!=
operator|(
name|tmpReg1
operator|&
literal|0x0000007F
operator|)
condition|)
block|{
comment|/* If they are not equal, save the value of this register and wait for at least                  * MAXFRM*16 ns */
name|XX_UDelay
argument_list|(
call|(
name|uint32_t
call|)
argument_list|(
name|MIN
argument_list|(
name|DtsecGetMaxFrameLength
argument_list|(
name|p_Dtsec
argument_list|)
operator|*
literal|16
operator|/
literal|1000
argument_list|,
literal|1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* e. Read and save TPKT again and read the register at dTSEC address offset                 0x32C again*/
name|tpkt2
operator|=
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tpkt
argument_list|)
expr_stmt|;
name|tmpReg2
operator|=
name|GET_UINT32
argument_list|(
operator|*
operator|(
name|uint32_t
operator|*
operator|)
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|p_DtsecMemMap
operator|+
literal|0x32c
operator|)
argument_list|)
expr_stmt|;
comment|/* f. Compare the value of TPKT saved in step b to value read in step e. Also                 compare bits [9:15] of the register at offset 0x32C saved in step d to the value                 of bits [9:15] saved in step e. If the two registers values are unchanged, then                 the transmit portion of the dTSEC controller is locked up and the user should                 proceed to the recover sequence. */
if|if
condition|(
operator|(
name|tpkt1
operator|==
name|tpkt2
operator|)
operator|&&
operator|(
operator|(
name|tmpReg1
operator|&
literal|0x007F0000
operator|)
operator|==
operator|(
name|tmpReg2
operator|&
literal|0x007F0000
operator|)
operator|)
condition|)
block|{
comment|/* recover sequence */
comment|/* a.Write a 1 to RCTRL[GRS]*/
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|rctrl
argument_list|,
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|rctrl
argument_list|)
operator||
name|RCTRL_GRS
argument_list|)
expr_stmt|;
comment|/* b.Wait until IEVENT[GRSC]=1, or at least 100 us has elapsed. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|100
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|ievent
argument_list|)
operator|&
name|DTSEC_IMASK_GRSCEN
condition|)
break|break;
name|XX_UDelay
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|ievent
argument_list|)
operator|&
name|DTSEC_IMASK_GRSCEN
condition|)
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|ievent
argument_list|,
name|DTSEC_IMASK_GRSCEN
argument_list|)
expr_stmt|;
else|else
name|DBG
argument_list|(
name|INFO
argument_list|,
operator|(
literal|"Rx lockup due to dTSEC Tx lockup"
operator|)
argument_list|)
expr_stmt|;
comment|/* c.Write a 1 to bit n of FM_RSTC (offset 0x0CC of FPM)*/
name|FmResetMac
argument_list|(
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
name|e_FM_MAC_1G
argument_list|,
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|macId
argument_list|)
expr_stmt|;
comment|/* d.Wait 4 Tx clocks (32 ns) */
name|XX_UDelay
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* e.Write a 0 to bit n of FM_RSTC. */
comment|/* cleared by FMAN */
block|}
block|}
endif|#
directive|endif
comment|/* FM_TX_LOCKUP_ERRATA_DTSEC6 */
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_TX_FIFO_UNDRN
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|event
operator|&
name|DTSEC_IMASK_MAGEN
condition|)
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_MAG_PCKT
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|DTSEC_IMASK_GRSCEN
condition|)
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_GRATEFUL_RX_STP_COMPLET
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|DTSEC_IMASK_TDPEEN
condition|)
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_TX_DATA_ERR
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|DTSEC_IMASK_RDPEEN
condition|)
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_RX_DATA_ERR
argument_list|)
expr_stmt|;
comment|/*  - masked interrupts */
name|ASSERT_COND
argument_list|(
operator|!
operator|(
name|event
operator|&
name|DTSEC_IMASK_ABRTEN
operator|)
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
operator|!
operator|(
name|event
operator|&
name|DTSEC_IMASK_IFERREN
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DtsecMdioIsr
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|uint32_t
name|event
decl_stmt|;
name|struct
name|dtsec_regs
modifier|*
name|p_DtsecMemMap
init|=
name|p_Dtsec
operator|->
name|p_MemMap
decl_stmt|;
name|event
operator|=
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|ievent
argument_list|)
expr_stmt|;
comment|/* handle only MDIO events */
name|event
operator|&=
operator|(
name|DTSEC_IMASK_MMRDEN
operator||
name|DTSEC_IMASK_MMWREN
operator|)
expr_stmt|;
if|if
condition|(
name|event
condition|)
block|{
name|event
operator|&=
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|imask
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|ievent
argument_list|,
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|DTSEC_IMASK_MMRDEN
condition|)
name|p_Dtsec
operator|->
name|f_Event
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_MII_MNG_RD_COMPLET
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|DTSEC_IMASK_MMWREN
condition|)
name|p_Dtsec
operator|->
name|f_Event
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_MII_MNG_WR_COMPLET
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|Dtsec1588Isr
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|uint32_t
name|event
decl_stmt|;
name|struct
name|dtsec_regs
modifier|*
name|p_DtsecMemMap
init|=
name|p_Dtsec
operator|->
name|p_MemMap
decl_stmt|;
if|if
condition|(
name|p_Dtsec
operator|->
name|ptpTsuEnabled
condition|)
block|{
name|event
operator|=
name|fman_dtsec_check_and_clear_tmr_event
argument_list|(
name|p_DtsecMemMap
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
condition|)
block|{
name|ASSERT_COND
argument_list|(
name|event
operator|&
name|TMR_PEVENT_TSRE
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_1588_TS_RX_ERR
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* ........................................................................... */
end_comment

begin_function
specifier|static
name|void
name|FreeInitResources
parameter_list|(
name|t_Dtsec
modifier|*
name|p_Dtsec
parameter_list|)
block|{
if|if
condition|(
name|p_Dtsec
operator|->
name|mdioIrq
operator|!=
name|NO_IRQ
condition|)
block|{
name|XX_DisableIntr
argument_list|(
name|p_Dtsec
operator|->
name|mdioIrq
argument_list|)
expr_stmt|;
name|XX_FreeIntr
argument_list|(
name|p_Dtsec
operator|->
name|mdioIrq
argument_list|)
expr_stmt|;
block|}
name|FmUnregisterIntr
argument_list|(
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
name|e_FM_MOD_1G_MAC
argument_list|,
name|p_Dtsec
operator|->
name|macId
argument_list|,
name|e_FM_INTR_TYPE_ERR
argument_list|)
expr_stmt|;
name|FmUnregisterIntr
argument_list|(
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
name|e_FM_MOD_1G_MAC
argument_list|,
name|p_Dtsec
operator|->
name|macId
argument_list|,
name|e_FM_INTR_TYPE_NORMAL
argument_list|)
expr_stmt|;
comment|/* release the driver's group hash table */
name|FreeHashTable
argument_list|(
name|p_Dtsec
operator|->
name|p_MulticastAddrHash
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|p_MulticastAddrHash
operator|=
name|NULL
expr_stmt|;
comment|/* release the driver's individual hash table */
name|FreeHashTable
argument_list|(
name|p_Dtsec
operator|->
name|p_UnicastAddrHash
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|p_UnicastAddrHash
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ........................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|GracefulStop
parameter_list|(
name|t_Dtsec
modifier|*
name|p_Dtsec
parameter_list|,
name|e_CommMode
name|mode
parameter_list|)
block|{
name|struct
name|dtsec_regs
modifier|*
name|p_MemMap
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Dtsec
argument_list|)
expr_stmt|;
name|p_MemMap
operator|=
name|p_Dtsec
operator|->
name|p_MemMap
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|p_MemMap
argument_list|)
expr_stmt|;
comment|/* Assert the graceful transmit stop bit */
if|if
condition|(
name|mode
operator|&
name|e_COMM_MODE_RX
condition|)
block|{
name|fman_dtsec_stop_rx
argument_list|(
name|p_MemMap
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_GRS_ERRATA_DTSEC_A002
if|if
condition|(
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|fmRevInfo
operator|.
name|majorRev
operator|==
literal|2
condition|)
name|XX_UDelay
argument_list|(
literal|100
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* FM_GRS_ERRATA_DTSEC_A002 */
ifdef|#
directive|ifdef
name|FM_GTS_AFTER_DROPPED_FRAME_ERRATA_DTSEC_A004839
name|XX_UDelay
argument_list|(
literal|10
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* FM_GTS_AFTER_DROPPED_FRAME_ERRATA_DTSEC_A004839 */
endif|#
directive|endif
comment|/* FM_GRS_ERRATA_DTSEC_A002 */
block|}
if|if
condition|(
name|mode
operator|&
name|e_COMM_MODE_TX
condition|)
if|#
directive|if
name|defined
argument_list|(
name|FM_GTS_ERRATA_DTSEC_A004
argument_list|)
operator|||
name|defined
argument_list|(
name|FM_GTS_AFTER_MAC_ABORTED_FRAME_ERRATA_DTSEC_A0012
argument_list|)
if|if
condition|(
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|fmRevInfo
operator|.
name|majorRev
operator|==
literal|2
condition|)
name|DBG
argument_list|(
name|INFO
argument_list|,
operator|(
literal|"GTS not supported due to DTSEC_A004 errata."
operator|)
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* not defined(FM_GTS_ERRATA_DTSEC_A004) ||... */
ifdef|#
directive|ifdef
name|FM_GTS_UNDERRUN_ERRATA_DTSEC_A0014
name|DBG
argument_list|(
name|INFO
argument_list|,
operator|(
literal|"GTS not supported due to DTSEC_A0014 errata."
operator|)
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* FM_GTS_UNDERRUN_ERRATA_DTSEC_A0014 */
name|fman_dtsec_stop_tx
argument_list|(
name|p_MemMap
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* FM_GTS_UNDERRUN_ERRATA_DTSEC_A0014 */
endif|#
directive|endif
comment|/* defined(FM_GTS_ERRATA_DTSEC_A004) ||...  */
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|GracefulRestart
parameter_list|(
name|t_Dtsec
modifier|*
name|p_Dtsec
parameter_list|,
name|e_CommMode
name|mode
parameter_list|)
block|{
name|struct
name|dtsec_regs
modifier|*
name|p_MemMap
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Dtsec
argument_list|)
expr_stmt|;
name|p_MemMap
operator|=
name|p_Dtsec
operator|->
name|p_MemMap
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|p_MemMap
argument_list|)
expr_stmt|;
comment|/* clear the graceful receive stop bit */
if|if
condition|(
name|mode
operator|&
name|e_COMM_MODE_TX
condition|)
name|fman_dtsec_start_tx
argument_list|(
name|p_MemMap
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|e_COMM_MODE_RX
condition|)
name|fman_dtsec_start_rx
argument_list|(
name|p_MemMap
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*                      dTSEC Configs modification functions                 */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecConfigLoopback
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|bool
name|newVal
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|loopback
operator|=
name|newVal
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecConfigMaxFrameLength
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|uint16_t
name|newVal
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|maximum_frame
operator|=
name|newVal
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecConfigPadAndCrc
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|bool
name|newVal
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|tx_pad_crc
operator|=
name|newVal
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecConfigHalfDuplex
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|bool
name|newVal
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|halfdup_on
operator|=
name|newVal
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecConfigTbiPhyAddr
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|uint8_t
name|newVal
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|tbi_phy_addr
operator|=
name|newVal
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecConfigLengthCheck
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|bool
name|newVal
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|rx_len_check
operator|=
name|newVal
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecConfigException
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|e_FmMacExceptions
name|exception
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|uint32_t
name|bitMask
init|=
literal|0
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|exception
operator|!=
name|e_FM_MAC_EX_1G_1588_TS_RX_ERR
condition|)
block|{
name|GET_EXCEPTION_FLAG
argument_list|(
name|bitMask
argument_list|,
name|exception
argument_list|)
expr_stmt|;
if|if
condition|(
name|bitMask
condition|)
block|{
if|if
condition|(
name|enable
condition|)
name|p_Dtsec
operator|->
name|exceptions
operator||=
name|bitMask
expr_stmt|;
else|else
name|p_Dtsec
operator|->
name|exceptions
operator|&=
operator|~
name|bitMask
expr_stmt|;
block|}
else|else
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Undefined exception"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|p_Dtsec
operator|->
name|ptpTsuEnabled
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Exception valid for 1588 only"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
condition|)
name|p_Dtsec
operator|->
name|enTsuErrExeption
operator|=
name|TRUE
expr_stmt|;
else|else
name|p_Dtsec
operator|->
name|enTsuErrExeption
operator|=
name|FALSE
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*                      dTSEC Run Time API functions                         */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecEnable
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|e_CommMode
name|mode
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|fman_dtsec_enable
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
operator|(
name|bool
operator|)
operator|!
operator|!
operator|(
name|mode
operator|&
name|e_COMM_MODE_RX
operator|)
argument_list|,
operator|(
name|bool
operator|)
operator|!
operator|!
operator|(
name|mode
operator|&
name|e_COMM_MODE_TX
operator|)
argument_list|)
expr_stmt|;
name|GracefulRestart
argument_list|(
name|p_Dtsec
argument_list|,
name|mode
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecDisable
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|e_CommMode
name|mode
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|GracefulStop
argument_list|(
name|p_Dtsec
argument_list|,
name|mode
argument_list|)
expr_stmt|;
name|fman_dtsec_disable
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
operator|(
name|bool
operator|)
operator|!
operator|!
operator|(
name|mode
operator|&
name|e_COMM_MODE_RX
operator|)
argument_list|,
operator|(
name|bool
operator|)
operator|!
operator|!
operator|(
name|mode
operator|&
name|e_COMM_MODE_TX
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecSetTxPauseFrames
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|uint8_t
name|priority
parameter_list|,
name|uint16_t
name|pauseTime
parameter_list|,
name|uint16_t
name|threshTime
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|UNUSED
argument_list|(
name|priority
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|threshTime
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_BAD_TX_TS_IN_B_2_B_ERRATA_DTSEC_A003
if|if
condition|(
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|fmRevInfo
operator|.
name|majorRev
operator|==
literal|2
condition|)
if|if
condition|(
literal|0
operator|<
name|pauseTime
operator|&&
name|pauseTime
operator|<=
literal|320
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"This pause-time value of %d is illegal due to errata dTSEC-A003!"
literal|" value should be greater than 320."
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* FM_BAD_TX_TS_IN_B_2_B_ERRATA_DTSEC_A003 */
name|fman_dtsec_set_tx_pause_frames
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|pauseTime
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_comment
comment|/* backward compatibility. will be removed in the future. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecTxMacPause
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|uint16_t
name|pauseTime
parameter_list|)
block|{
return|return
name|DtsecSetTxPauseFrames
argument_list|(
name|h_Dtsec
argument_list|,
literal|0
argument_list|,
name|pauseTime
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecRxIgnoreMacPause
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|bool
name|en
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|bool
name|accept_pause
init|=
operator|!
name|en
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|fman_dtsec_handle_rx_pause
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|accept_pause
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecEnable1588TimeStamp
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|ptpTsuEnabled
operator|=
name|TRUE
expr_stmt|;
name|fman_dtsec_set_ts
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecDisable1588TimeStamp
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|ptpTsuEnabled
operator|=
name|FALSE
expr_stmt|;
name|fman_dtsec_set_ts
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecGetStatistics
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|t_FmMacStatistics
modifier|*
name|p_Statistics
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|struct
name|dtsec_regs
modifier|*
name|p_DtsecMemMap
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Statistics
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|p_DtsecMemMap
operator|=
name|p_Dtsec
operator|->
name|p_MemMap
expr_stmt|;
if|if
condition|(
name|p_Dtsec
operator|->
name|statisticsLevel
operator|==
name|e_FM_MAC_NONE_STATISTICS
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Statistics disabled"
operator|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p_Statistics
argument_list|,
literal|0xff
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmMacStatistics
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Dtsec
operator|->
name|statisticsLevel
operator|==
name|e_FM_MAC_FULL_STATISTICS
condition|)
block|{
name|p_Statistics
operator|->
name|eStatPkts64
operator|=
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_TR64
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tr64
expr_stmt|;
name|p_Statistics
operator|->
name|eStatPkts65to127
operator|=
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_TR127
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tr127
expr_stmt|;
name|p_Statistics
operator|->
name|eStatPkts128to255
operator|=
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_TR255
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tr255
expr_stmt|;
name|p_Statistics
operator|->
name|eStatPkts256to511
operator|=
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_TR511
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tr511
expr_stmt|;
name|p_Statistics
operator|->
name|eStatPkts512to1023
operator|=
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_TR1K
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tr1k
expr_stmt|;
name|p_Statistics
operator|->
name|eStatPkts1024to1518
operator|=
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_TRMAX
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|trmax
expr_stmt|;
name|p_Statistics
operator|->
name|eStatPkts1519to1522
operator|=
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_TRMGV
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|trmgv
expr_stmt|;
comment|/* MIB II */
name|p_Statistics
operator|->
name|ifInOctets
operator|=
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_RBYT
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rbyt
expr_stmt|;
name|p_Statistics
operator|->
name|ifInPkts
operator|=
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_RPKT
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rpkt
expr_stmt|;
name|p_Statistics
operator|->
name|ifInUcastPkts
operator|=
literal|0
expr_stmt|;
name|p_Statistics
operator|->
name|ifInMcastPkts
operator|=
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_RMCA
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rmca
expr_stmt|;
name|p_Statistics
operator|->
name|ifInBcastPkts
operator|=
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_RBCA
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rbca
expr_stmt|;
name|p_Statistics
operator|->
name|ifOutOctets
operator|=
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_TBYT
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tbyt
expr_stmt|;
name|p_Statistics
operator|->
name|ifOutPkts
operator|=
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_TPKT
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tpkt
expr_stmt|;
name|p_Statistics
operator|->
name|ifOutUcastPkts
operator|=
literal|0
expr_stmt|;
name|p_Statistics
operator|->
name|ifOutMcastPkts
operator|=
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_TMCA
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tmca
expr_stmt|;
name|p_Statistics
operator|->
name|ifOutBcastPkts
operator|=
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_TBCA
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tbca
expr_stmt|;
block|}
name|p_Statistics
operator|->
name|eStatFragments
operator|=
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_RFRG
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rfrg
expr_stmt|;
name|p_Statistics
operator|->
name|eStatJabbers
operator|=
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_RJBR
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rjbr
expr_stmt|;
name|p_Statistics
operator|->
name|eStatsDropEvents
operator|=
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_RDRP
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rdrp
expr_stmt|;
name|p_Statistics
operator|->
name|eStatCRCAlignErrors
operator|=
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_RALN
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|raln
expr_stmt|;
name|p_Statistics
operator|->
name|eStatUndersizePkts
operator|=
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_RUND
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rund
expr_stmt|;
name|p_Statistics
operator|->
name|eStatOversizePkts
operator|=
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_ROVR
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rovr
expr_stmt|;
name|p_Statistics
operator|->
name|reStatPause
operator|=
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_RXPF
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rxpf
expr_stmt|;
name|p_Statistics
operator|->
name|teStatPause
operator|=
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_TXPF
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|txpf
expr_stmt|;
name|p_Statistics
operator|->
name|ifInDiscards
operator|=
name|p_Statistics
operator|->
name|eStatsDropEvents
expr_stmt|;
name|p_Statistics
operator|->
name|ifInErrors
operator|=
name|p_Statistics
operator|->
name|eStatsDropEvents
operator|+
name|p_Statistics
operator|->
name|eStatCRCAlignErrors
operator|+
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_RFLR
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rflr
operator|+
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_RCDE
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rcde
operator|+
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_RCSE
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rcse
expr_stmt|;
name|p_Statistics
operator|->
name|ifOutDiscards
operator|=
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_TDRP
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tdrp
expr_stmt|;
name|p_Statistics
operator|->
name|ifOutErrors
operator|=
name|p_Statistics
operator|->
name|ifOutDiscards
comment|/**< Number of frames transmitted with error: */
operator|+
name|fman_dtsec_get_stat_counter
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_DTSEC_STAT_TFCS
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tfcs
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecModifyMacAddress
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|t_EnetAddr
modifier|*
name|p_EnetAddr
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
comment|/* Initialize MAC Station Address registers (1& 2)    */
comment|/* Station address have to be swapped (big endian to little endian */
name|p_Dtsec
operator|->
name|addr
operator|=
name|ENET_ADDR_TO_UINT64
argument_list|(
operator|*
name|p_EnetAddr
argument_list|)
expr_stmt|;
name|fman_dtsec_set_mac_address
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|(
operator|*
name|p_EnetAddr
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecResetCounters
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
comment|/* clear HW counters */
name|fman_dtsec_reset_stat
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|)
expr_stmt|;
comment|/* clear SW counters holding carries */
name|memset
argument_list|(
operator|&
name|p_Dtsec
operator|->
name|internalStatistics
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_InternalStatistics
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecAddExactMatchMacAddress
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|t_EnetAddr
modifier|*
name|p_EthAddr
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|uint64_t
name|ethAddr
decl_stmt|;
name|uint8_t
name|paddrNum
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|ethAddr
operator|=
name|ENET_ADDR_TO_UINT64
argument_list|(
operator|*
name|p_EthAddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ethAddr
operator|&
name|GROUP_ADDRESS
condition|)
comment|/* Multicast address has no effect in PADDR */
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Multicast address"
operator|)
argument_list|)
expr_stmt|;
comment|/* Make sure no PADDR contains this address */
for|for
control|(
name|paddrNum
operator|=
literal|0
init|;
name|paddrNum
operator|<
name|DTSEC_NUM_OF_PADDRS
condition|;
name|paddrNum
operator|++
control|)
if|if
condition|(
name|p_Dtsec
operator|->
name|indAddrRegUsed
index|[
name|paddrNum
index|]
condition|)
if|if
condition|(
name|p_Dtsec
operator|->
name|paddr
index|[
name|paddrNum
index|]
operator|==
name|ethAddr
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_ALREADY_EXISTS
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
comment|/* Find first unused PADDR */
for|for
control|(
name|paddrNum
operator|=
literal|0
init|;
name|paddrNum
operator|<
name|DTSEC_NUM_OF_PADDRS
condition|;
name|paddrNum
operator|++
control|)
if|if
condition|(
operator|!
operator|(
name|p_Dtsec
operator|->
name|indAddrRegUsed
index|[
name|paddrNum
index|]
operator|)
condition|)
block|{
comment|/* mark this PADDR as used */
name|p_Dtsec
operator|->
name|indAddrRegUsed
index|[
name|paddrNum
index|]
operator|=
name|TRUE
expr_stmt|;
comment|/* store address */
name|p_Dtsec
operator|->
name|paddr
index|[
name|paddrNum
index|]
operator|=
name|ethAddr
expr_stmt|;
comment|/* put in hardware */
name|fman_dtsec_add_addr_in_paddr
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
operator|(
name|uint64_t
operator|)
name|PTR_TO_UINT
argument_list|(
operator|&
name|ethAddr
argument_list|)
argument_list|,
name|paddrNum
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|numOfIndAddrInRegs
operator|++
expr_stmt|;
return|return
name|E_OK
return|;
block|}
comment|/* No free PADDR */
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_FULL
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecDelExactMatchMacAddress
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|t_EnetAddr
modifier|*
name|p_EthAddr
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|uint64_t
name|ethAddr
decl_stmt|;
name|uint8_t
name|paddrNum
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|ethAddr
operator|=
name|ENET_ADDR_TO_UINT64
argument_list|(
operator|*
name|p_EthAddr
argument_list|)
expr_stmt|;
comment|/* Find used PADDR containing this address */
for|for
control|(
name|paddrNum
operator|=
literal|0
init|;
name|paddrNum
operator|<
name|DTSEC_NUM_OF_PADDRS
condition|;
name|paddrNum
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|indAddrRegUsed
index|[
name|paddrNum
index|]
operator|)
operator|&&
operator|(
name|p_Dtsec
operator|->
name|paddr
index|[
name|paddrNum
index|]
operator|==
name|ethAddr
operator|)
condition|)
block|{
comment|/* mark this PADDR as not used */
name|p_Dtsec
operator|->
name|indAddrRegUsed
index|[
name|paddrNum
index|]
operator|=
name|FALSE
expr_stmt|;
comment|/* clear in hardware */
name|fman_dtsec_clear_addr_in_paddr
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|paddrNum
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|numOfIndAddrInRegs
operator|--
expr_stmt|;
return|return
name|E_OK
return|;
block|}
block|}
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_FOUND
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecAddHashMacAddress
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|t_EnetAddr
modifier|*
name|p_EthAddr
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|t_EthHashEntry
modifier|*
name|p_HashEntry
decl_stmt|;
name|uint64_t
name|ethAddr
decl_stmt|;
name|int32_t
name|bucket
decl_stmt|;
name|uint32_t
name|crc
decl_stmt|;
name|bool
name|mcast
decl_stmt|,
name|ghtx
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|ethAddr
operator|=
name|ENET_ADDR_TO_UINT64
argument_list|(
operator|*
name|p_EthAddr
argument_list|)
expr_stmt|;
name|ghtx
operator|=
call|(
name|bool
call|)
argument_list|(
operator|(
name|fman_dtsec_get_rctrl
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|)
operator|&
name|RCTRL_GHTX
operator|)
condition|?
name|TRUE
else|:
name|FALSE
argument_list|)
expr_stmt|;
name|mcast
operator|=
call|(
name|bool
call|)
argument_list|(
operator|(
name|ethAddr
operator|&
name|MAC_GROUP_ADDRESS
operator|)
condition|?
name|TRUE
else|:
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ghtx
operator|&&
operator|!
name|mcast
condition|)
comment|/* Cannot handle unicast mac addr when GHTX is on */
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Could not compute hash bucket"
operator|)
argument_list|)
expr_stmt|;
name|crc
operator|=
name|GetMacAddrHashCode
argument_list|(
name|ethAddr
argument_list|)
expr_stmt|;
comment|/* considering the 9 highest order bits in crc H[8:0]:      * if ghtx = 0 H[8:6] (highest order 3 bits) identify the hash register      * and H[5:1] (next 5 bits) identify the hash bit      * if ghts = 1 H[8:5] (highest order 4 bits) identify the hash register      * and H[4:0] (next 5 bits) identify the hash bit.      *      * In bucket index output the low 5 bits identify the hash register bit,      * while the higher 4 bits identify the hash register      */
if|if
condition|(
name|ghtx
condition|)
name|bucket
operator|=
call|(
name|int32_t
call|)
argument_list|(
operator|(
name|crc
operator|>>
literal|23
operator|)
operator|&
literal|0x1ff
argument_list|)
expr_stmt|;
else|else
block|{
name|bucket
operator|=
call|(
name|int32_t
call|)
argument_list|(
operator|(
name|crc
operator|>>
literal|24
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
comment|/* if !ghtx and mcast the bit must be set in gaddr instead of igaddr. */
if|if
condition|(
name|mcast
condition|)
name|bucket
operator|+=
literal|0x100
expr_stmt|;
block|}
name|fman_dtsec_set_bucket
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|bucket
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
comment|/* Create element to be added to the driver hash table */
name|p_HashEntry
operator|=
operator|(
name|t_EthHashEntry
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|t_EthHashEntry
argument_list|)
argument_list|)
expr_stmt|;
name|p_HashEntry
operator|->
name|addr
operator|=
name|ethAddr
expr_stmt|;
name|INIT_LIST
argument_list|(
operator|&
name|p_HashEntry
operator|->
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|ethAddr
operator|&
name|MAC_GROUP_ADDRESS
condition|)
comment|/* Group Address */
name|NCSW_LIST_AddToTail
argument_list|(
operator|&
operator|(
name|p_HashEntry
operator|->
name|node
operator|)
argument_list|,
operator|&
operator|(
name|p_Dtsec
operator|->
name|p_MulticastAddrHash
operator|->
name|p_Lsts
index|[
name|bucket
index|]
operator|)
argument_list|)
expr_stmt|;
else|else
name|NCSW_LIST_AddToTail
argument_list|(
operator|&
operator|(
name|p_HashEntry
operator|->
name|node
operator|)
argument_list|,
operator|&
operator|(
name|p_Dtsec
operator|->
name|p_UnicastAddrHash
operator|->
name|p_Lsts
index|[
name|bucket
index|]
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecDelHashMacAddress
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|t_EnetAddr
modifier|*
name|p_EthAddr
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|t_List
modifier|*
name|p_Pos
decl_stmt|;
name|t_EthHashEntry
modifier|*
name|p_HashEntry
init|=
name|NULL
decl_stmt|;
name|uint64_t
name|ethAddr
decl_stmt|;
name|int32_t
name|bucket
decl_stmt|;
name|uint32_t
name|crc
decl_stmt|;
name|bool
name|mcast
decl_stmt|,
name|ghtx
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|ethAddr
operator|=
name|ENET_ADDR_TO_UINT64
argument_list|(
operator|*
name|p_EthAddr
argument_list|)
expr_stmt|;
name|ghtx
operator|=
call|(
name|bool
call|)
argument_list|(
operator|(
name|fman_dtsec_get_rctrl
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|)
operator|&
name|RCTRL_GHTX
operator|)
condition|?
name|TRUE
else|:
name|FALSE
argument_list|)
expr_stmt|;
name|mcast
operator|=
call|(
name|bool
call|)
argument_list|(
operator|(
name|ethAddr
operator|&
name|MAC_GROUP_ADDRESS
operator|)
condition|?
name|TRUE
else|:
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ghtx
operator|&&
operator|!
name|mcast
condition|)
comment|/* Cannot handle unicast mac addr when GHTX is on */
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Could not compute hash bucket"
operator|)
argument_list|)
expr_stmt|;
name|crc
operator|=
name|GetMacAddrHashCode
argument_list|(
name|ethAddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ghtx
condition|)
name|bucket
operator|=
call|(
name|int32_t
call|)
argument_list|(
operator|(
name|crc
operator|>>
literal|23
operator|)
operator|&
literal|0x1ff
argument_list|)
expr_stmt|;
else|else
block|{
name|bucket
operator|=
call|(
name|int32_t
call|)
argument_list|(
operator|(
name|crc
operator|>>
literal|24
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
comment|/* if !ghtx and mcast the bit must be set in gaddr instead of igaddr. */
if|if
condition|(
name|mcast
condition|)
name|bucket
operator|+=
literal|0x100
expr_stmt|;
block|}
if|if
condition|(
name|ethAddr
operator|&
name|MAC_GROUP_ADDRESS
condition|)
block|{
comment|/* Group Address */
name|NCSW_LIST_FOR_EACH
argument_list|(
argument|p_Pos
argument_list|,
argument|&(p_Dtsec->p_MulticastAddrHash->p_Lsts[bucket])
argument_list|)
block|{
name|p_HashEntry
operator|=
name|ETH_HASH_ENTRY_OBJ
argument_list|(
name|p_Pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_HashEntry
operator|->
name|addr
operator|==
name|ethAddr
condition|)
block|{
name|NCSW_LIST_DelAndInit
argument_list|(
operator|&
name|p_HashEntry
operator|->
name|node
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_HashEntry
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|NCSW_LIST_IsEmpty
argument_list|(
operator|&
name|p_Dtsec
operator|->
name|p_MulticastAddrHash
operator|->
name|p_Lsts
index|[
name|bucket
index|]
argument_list|)
condition|)
name|fman_dtsec_set_bucket
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|bucket
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Individual Address */
name|NCSW_LIST_FOR_EACH
argument_list|(
argument|p_Pos
argument_list|,
argument|&(p_Dtsec->p_UnicastAddrHash->p_Lsts[bucket])
argument_list|)
block|{
name|p_HashEntry
operator|=
name|ETH_HASH_ENTRY_OBJ
argument_list|(
name|p_Pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_HashEntry
operator|->
name|addr
operator|==
name|ethAddr
condition|)
block|{
name|NCSW_LIST_DelAndInit
argument_list|(
operator|&
name|p_HashEntry
operator|->
name|node
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_HashEntry
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|NCSW_LIST_IsEmpty
argument_list|(
operator|&
name|p_Dtsec
operator|->
name|p_UnicastAddrHash
operator|->
name|p_Lsts
index|[
name|bucket
index|]
argument_list|)
condition|)
name|fman_dtsec_set_bucket
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|bucket
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
comment|/* address does not exist */
name|ASSERT_COND
argument_list|(
name|p_HashEntry
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecSetPromiscuous
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|bool
name|newVal
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|fman_dtsec_set_uc_promisc
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|newVal
argument_list|)
expr_stmt|;
name|fman_dtsec_set_mc_promisc
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|newVal
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecSetStatistics
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|e_FmMacStatisticsLevel
name|statisticsLevel
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|statisticsLevel
operator|=
name|statisticsLevel
expr_stmt|;
name|err
operator|=
operator|(
name|t_Error
operator|)
name|fman_dtsec_set_stat_level
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
operator|(
expr|enum
name|dtsec_stat_level
operator|)
name|statisticsLevel
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
return|return
name|err
return|;
switch|switch
condition|(
name|statisticsLevel
condition|)
block|{
case|case
operator|(
name|e_FM_MAC_NONE_STATISTICS
operator|)
case|:
name|p_Dtsec
operator|->
name|exceptions
operator|&=
operator|~
name|DTSEC_IMASK_MSROEN
expr_stmt|;
break|break;
case|case
operator|(
name|e_FM_MAC_PARTIAL_STATISTICS
operator|)
case|:
name|p_Dtsec
operator|->
name|exceptions
operator||=
name|DTSEC_IMASK_MSROEN
expr_stmt|;
break|break;
case|case
operator|(
name|e_FM_MAC_FULL_STATISTICS
operator|)
case|:
name|p_Dtsec
operator|->
name|exceptions
operator||=
name|DTSEC_IMASK_MSROEN
expr_stmt|;
break|break;
default|default:
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecSetWakeOnLan
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|bool
name|en
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|fman_dtsec_set_wol
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|en
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecAdjustLink
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|e_EnetSpeed
name|speed
parameter_list|,
name|bool
name|fullDuplex
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|int
name|err
decl_stmt|;
name|enum
name|enet_interface
name|enet_interface
decl_stmt|;
name|enum
name|enet_speed
name|enet_speed
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|enetMode
operator|=
name|MAKE_ENET_MODE
argument_list|(
name|ENET_INTERFACE_FROM_MODE
argument_list|(
name|p_Dtsec
operator|->
name|enetMode
argument_list|)
argument_list|,
name|speed
argument_list|)
expr_stmt|;
name|enet_interface
operator|=
operator|(
expr|enum
name|enet_interface
operator|)
name|ENET_INTERFACE_FROM_MODE
argument_list|(
name|p_Dtsec
operator|->
name|enetMode
argument_list|)
expr_stmt|;
name|enet_speed
operator|=
operator|(
expr|enum
name|enet_speed
operator|)
name|ENET_SPEED_FROM_MODE
argument_list|(
name|p_Dtsec
operator|->
name|enetMode
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|halfDuplex
operator|=
operator|!
name|fullDuplex
expr_stmt|;
name|err
operator|=
name|fman_dtsec_adjust_link
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|enet_interface
argument_list|,
name|enet_speed
argument_list|,
name|fullDuplex
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
operator|-
name|EINVAL
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_CONFLICT
argument_list|,
operator|(
literal|"Ethernet interface does not support Half Duplex mode"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|t_Error
operator|)
name|err
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecRestartAutoneg
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|uint16_t
name|tmpReg16
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|DTSEC_MII_ReadPhyReg
argument_list|(
name|p_Dtsec
argument_list|,
name|p_Dtsec
operator|->
name|tbi_phy_addr
argument_list|,
literal|0
argument_list|,
operator|&
name|tmpReg16
argument_list|)
expr_stmt|;
name|tmpReg16
operator|&=
operator|~
operator|(
name|PHY_CR_SPEED0
operator||
name|PHY_CR_SPEED1
operator|)
expr_stmt|;
name|tmpReg16
operator||=
operator|(
name|PHY_CR_ANE
operator||
name|PHY_CR_RESET_AN
operator||
name|PHY_CR_FULLDUPLEX
operator||
name|PHY_CR_SPEED1
operator|)
expr_stmt|;
name|DTSEC_MII_WritePhyReg
argument_list|(
name|p_Dtsec
argument_list|,
name|p_Dtsec
operator|->
name|tbi_phy_addr
argument_list|,
literal|0
argument_list|,
name|tmpReg16
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecGetId
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|uint32_t
modifier|*
name|macId
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
operator|*
name|macId
operator|=
name|p_Dtsec
operator|->
name|macId
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecGetVersion
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|uint32_t
modifier|*
name|macVersion
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
operator|*
name|macVersion
operator|=
name|fman_dtsec_get_revision
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecSetException
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|e_FmMacExceptions
name|exception
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|uint32_t
name|bitMask
init|=
literal|0
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|exception
operator|!=
name|e_FM_MAC_EX_1G_1588_TS_RX_ERR
condition|)
block|{
name|GET_EXCEPTION_FLAG
argument_list|(
name|bitMask
argument_list|,
name|exception
argument_list|)
expr_stmt|;
if|if
condition|(
name|bitMask
condition|)
block|{
if|if
condition|(
name|enable
condition|)
name|p_Dtsec
operator|->
name|exceptions
operator||=
name|bitMask
expr_stmt|;
else|else
name|p_Dtsec
operator|->
name|exceptions
operator|&=
operator|~
name|bitMask
expr_stmt|;
block|}
else|else
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Undefined exception"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
condition|)
name|fman_dtsec_enable_interrupt
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|bitMask
argument_list|)
expr_stmt|;
else|else
name|fman_dtsec_disable_interrupt
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|bitMask
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|p_Dtsec
operator|->
name|ptpTsuEnabled
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Exception valid for 1588 only"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
condition|)
block|{
name|p_Dtsec
operator|->
name|enTsuErrExeption
operator|=
name|TRUE
expr_stmt|;
name|fman_dtsec_enable_tmr_interrupt
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|p_Dtsec
operator|->
name|enTsuErrExeption
operator|=
name|FALSE
expr_stmt|;
name|fman_dtsec_disable_tmr_interrupt
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*                      dTSEC Init& Free API                                   */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecInit
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|struct
name|dtsec_cfg
modifier|*
name|p_DtsecDriverParam
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|uint16_t
name|maxFrmLn
decl_stmt|;
name|enum
name|enet_interface
name|enet_interface
decl_stmt|;
name|enum
name|enet_speed
name|enet_speed
decl_stmt|;
name|t_EnetAddr
name|ethAddr
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|FM_GetRevision
argument_list|(
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
operator|&
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|fmRevInfo
argument_list|)
expr_stmt|;
name|CHECK_INIT_PARAMETERS
argument_list|(
name|p_Dtsec
argument_list|,
name|CheckInitParameters
argument_list|)
expr_stmt|;
name|p_DtsecDriverParam
operator|=
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
expr_stmt|;
name|p_Dtsec
operator|->
name|halfDuplex
operator|=
name|p_DtsecDriverParam
operator|->
name|halfdup_on
expr_stmt|;
name|enet_interface
operator|=
operator|(
expr|enum
name|enet_interface
operator|)
name|ENET_INTERFACE_FROM_MODE
argument_list|(
name|p_Dtsec
operator|->
name|enetMode
argument_list|)
expr_stmt|;
name|enet_speed
operator|=
operator|(
expr|enum
name|enet_speed
operator|)
name|ENET_SPEED_FROM_MODE
argument_list|(
name|p_Dtsec
operator|->
name|enetMode
argument_list|)
expr_stmt|;
name|MAKE_ENET_ADDR_FROM_UINT64
argument_list|(
name|p_Dtsec
operator|->
name|addr
argument_list|,
name|ethAddr
argument_list|)
expr_stmt|;
name|err
operator|=
operator|(
name|t_Error
operator|)
name|fman_dtsec_init
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|p_DtsecDriverParam
argument_list|,
name|enet_interface
argument_list|,
name|enet_speed
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|ethAddr
argument_list|,
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|fmRevInfo
operator|.
name|majorRev
argument_list|,
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|fmRevInfo
operator|.
name|minorRev
argument_list|,
name|p_Dtsec
operator|->
name|exceptions
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|FreeInitResources
argument_list|(
name|p_Dtsec
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
operator|(
literal|"This DTSEC version does not support the required i/f mode"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ENET_INTERFACE_FROM_MODE
argument_list|(
name|p_Dtsec
operator|->
name|enetMode
argument_list|)
operator|==
name|e_ENET_IF_SGMII
condition|)
block|{
name|uint16_t
name|tmpReg16
decl_stmt|;
comment|/* Configure the TBI PHY Control Register */
name|tmpReg16
operator|=
name|PHY_TBICON_CLK_SEL
operator||
name|PHY_TBICON_SRESET
expr_stmt|;
name|DTSEC_MII_WritePhyReg
argument_list|(
name|p_Dtsec
argument_list|,
operator|(
name|uint8_t
operator|)
name|p_DtsecDriverParam
operator|->
name|tbipa
argument_list|,
literal|17
argument_list|,
name|tmpReg16
argument_list|)
expr_stmt|;
name|tmpReg16
operator|=
name|PHY_TBICON_CLK_SEL
expr_stmt|;
name|DTSEC_MII_WritePhyReg
argument_list|(
name|p_Dtsec
argument_list|,
operator|(
name|uint8_t
operator|)
name|p_DtsecDriverParam
operator|->
name|tbipa
argument_list|,
literal|17
argument_list|,
name|tmpReg16
argument_list|)
expr_stmt|;
name|tmpReg16
operator|=
operator|(
name|PHY_CR_PHY_RESET
operator||
name|PHY_CR_ANE
operator||
name|PHY_CR_FULLDUPLEX
operator||
name|PHY_CR_SPEED1
operator|)
expr_stmt|;
name|DTSEC_MII_WritePhyReg
argument_list|(
name|p_Dtsec
argument_list|,
operator|(
name|uint8_t
operator|)
name|p_DtsecDriverParam
operator|->
name|tbipa
argument_list|,
literal|0
argument_list|,
name|tmpReg16
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Dtsec
operator|->
name|enetMode
operator|&
name|ENET_IF_SGMII_BASEX
condition|)
name|tmpReg16
operator|=
name|PHY_TBIANA_1000X
expr_stmt|;
else|else
name|tmpReg16
operator|=
name|PHY_TBIANA_SGMII
expr_stmt|;
name|DTSEC_MII_WritePhyReg
argument_list|(
name|p_Dtsec
argument_list|,
operator|(
name|uint8_t
operator|)
name|p_DtsecDriverParam
operator|->
name|tbipa
argument_list|,
literal|4
argument_list|,
name|tmpReg16
argument_list|)
expr_stmt|;
name|tmpReg16
operator|=
operator|(
name|PHY_CR_ANE
operator||
name|PHY_CR_RESET_AN
operator||
name|PHY_CR_FULLDUPLEX
operator||
name|PHY_CR_SPEED1
operator|)
expr_stmt|;
name|DTSEC_MII_WritePhyReg
argument_list|(
name|p_Dtsec
argument_list|,
operator|(
name|uint8_t
operator|)
name|p_DtsecDriverParam
operator|->
name|tbipa
argument_list|,
literal|0
argument_list|,
name|tmpReg16
argument_list|)
expr_stmt|;
block|}
comment|/* Max Frame Length */
name|maxFrmLn
operator|=
name|fman_dtsec_get_max_frame_len
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|)
expr_stmt|;
name|err
operator|=
name|FmSetMacMaxFrame
argument_list|(
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
name|e_FM_MAC_1G
argument_list|,
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|macId
argument_list|,
name|maxFrmLn
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|p_MulticastAddrHash
operator|=
name|AllocHashTable
argument_list|(
name|EXTENDED_HASH_TABLE_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Dtsec
operator|->
name|p_MulticastAddrHash
condition|)
block|{
name|FreeInitResources
argument_list|(
name|p_Dtsec
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"MC hash table is FAILED"
operator|)
argument_list|)
expr_stmt|;
block|}
name|p_Dtsec
operator|->
name|p_UnicastAddrHash
operator|=
name|AllocHashTable
argument_list|(
name|HASH_TABLE_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Dtsec
operator|->
name|p_UnicastAddrHash
condition|)
block|{
name|FreeInitResources
argument_list|(
name|p_Dtsec
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"UC hash table is FAILED"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* register err intr handler for dtsec to FPM (err)*/
name|FmRegisterIntr
argument_list|(
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
name|e_FM_MOD_1G_MAC
argument_list|,
name|p_Dtsec
operator|->
name|macId
argument_list|,
name|e_FM_INTR_TYPE_ERR
argument_list|,
name|DtsecIsr
argument_list|,
name|p_Dtsec
argument_list|)
expr_stmt|;
comment|/* register 1588 intr handler for TMR to FPM (normal)*/
name|FmRegisterIntr
argument_list|(
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
name|e_FM_MOD_1G_MAC
argument_list|,
name|p_Dtsec
operator|->
name|macId
argument_list|,
name|e_FM_INTR_TYPE_NORMAL
argument_list|,
name|Dtsec1588Isr
argument_list|,
name|p_Dtsec
argument_list|)
expr_stmt|;
comment|/* register normal intr handler for dtsec to main interrupt controller. */
if|if
condition|(
name|p_Dtsec
operator|->
name|mdioIrq
operator|!=
name|NO_IRQ
condition|)
block|{
name|XX_SetIntr
argument_list|(
name|p_Dtsec
operator|->
name|mdioIrq
argument_list|,
name|DtsecMdioIsr
argument_list|,
name|p_Dtsec
argument_list|)
expr_stmt|;
name|XX_EnableIntr
argument_list|(
name|p_Dtsec
operator|->
name|mdioIrq
argument_list|)
expr_stmt|;
block|}
name|XX_Free
argument_list|(
name|p_DtsecDriverParam
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|=
name|NULL
expr_stmt|;
name|err
operator|=
name|DtsecSetStatistics
argument_list|(
name|h_Dtsec
argument_list|,
name|e_FM_MAC_FULL_STATISTICS
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|FreeInitResources
argument_list|(
name|p_Dtsec
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
operator|(
literal|"Undefined statistics level"
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ........................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecFree
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
condition|)
block|{
comment|/* Called after config */
name|XX_Free
argument_list|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|=
name|NULL
expr_stmt|;
block|}
else|else
comment|/* Called after init */
name|FreeInitResources
argument_list|(
name|p_Dtsec
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_Dtsec
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|void
name|InitFmMacControllerDriver
parameter_list|(
name|t_FmMacControllerDriver
modifier|*
name|p_FmMacControllerDriver
parameter_list|)
block|{
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_Init
operator|=
name|DtsecInit
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_Free
operator|=
name|DtsecFree
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_SetStatistics
operator|=
name|DtsecSetStatistics
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigLoopback
operator|=
name|DtsecConfigLoopback
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigMaxFrameLength
operator|=
name|DtsecConfigMaxFrameLength
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigWan
operator|=
name|NULL
expr_stmt|;
comment|/* Not supported on dTSEC */
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigPadAndCrc
operator|=
name|DtsecConfigPadAndCrc
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigHalfDuplex
operator|=
name|DtsecConfigHalfDuplex
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigLengthCheck
operator|=
name|DtsecConfigLengthCheck
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigTbiPhyAddr
operator|=
name|DtsecConfigTbiPhyAddr
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigException
operator|=
name|DtsecConfigException
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigResetOnInit
operator|=
name|NULL
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_Enable
operator|=
name|DtsecEnable
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_Disable
operator|=
name|DtsecDisable
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_Resume
operator|=
name|NULL
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_SetException
operator|=
name|DtsecSetException
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_SetPromiscuous
operator|=
name|DtsecSetPromiscuous
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_AdjustLink
operator|=
name|DtsecAdjustLink
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_SetWakeOnLan
operator|=
name|DtsecSetWakeOnLan
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_RestartAutoneg
operator|=
name|DtsecRestartAutoneg
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_Enable1588TimeStamp
operator|=
name|DtsecEnable1588TimeStamp
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_Disable1588TimeStamp
operator|=
name|DtsecDisable1588TimeStamp
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_SetTxAutoPauseFrames
operator|=
name|DtsecTxMacPause
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_SetTxPauseFrames
operator|=
name|DtsecSetTxPauseFrames
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_SetRxIgnorePauseFrames
operator|=
name|DtsecRxIgnoreMacPause
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ResetCounters
operator|=
name|DtsecResetCounters
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_GetStatistics
operator|=
name|DtsecGetStatistics
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ModifyMacAddr
operator|=
name|DtsecModifyMacAddress
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_AddHashMacAddr
operator|=
name|DtsecAddHashMacAddress
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_RemoveHashMacAddr
operator|=
name|DtsecDelHashMacAddress
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_AddExactMatchMacAddr
operator|=
name|DtsecAddExactMatchMacAddress
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_RemovelExactMatchMacAddr
operator|=
name|DtsecDelExactMatchMacAddress
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_GetId
operator|=
name|DtsecGetId
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_GetVersion
operator|=
name|DtsecGetVersion
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_GetMaxFrameLength
operator|=
name|DtsecGetMaxFrameLength
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_MII_WritePhyReg
operator|=
name|DTSEC_MII_WritePhyReg
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_MII_ReadPhyReg
operator|=
name|DTSEC_MII_ReadPhyReg
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*                      dTSEC Config Main Entry                             */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
name|t_Handle
name|DTSEC_Config
parameter_list|(
name|t_FmMacParams
modifier|*
name|p_FmMacParam
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
decl_stmt|;
name|struct
name|dtsec_cfg
modifier|*
name|p_DtsecDriverParam
decl_stmt|;
name|uintptr_t
name|baseAddr
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_FmMacParam
argument_list|,
name|E_NULL_POINTER
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|baseAddr
operator|=
name|p_FmMacParam
operator|->
name|baseAddr
expr_stmt|;
comment|/* allocate memory for the UCC GETH data structure. */
name|p_Dtsec
operator|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|t_Dtsec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Dtsec
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"dTSEC driver structure"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_Dtsec
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_Dtsec
argument_list|)
argument_list|)
expr_stmt|;
name|InitFmMacControllerDriver
argument_list|(
operator|&
name|p_Dtsec
operator|->
name|fmMacControllerDriver
argument_list|)
expr_stmt|;
comment|/* allocate memory for the dTSEC driver parameters data structure. */
name|p_DtsecDriverParam
operator|=
operator|(
expr|struct
name|dtsec_cfg
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|dtsec_cfg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_DtsecDriverParam
condition|)
block|{
name|XX_Free
argument_list|(
name|p_Dtsec
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"dTSEC driver parameters"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_DtsecDriverParam
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|dtsec_cfg
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Plant parameter structure pointer */
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|=
name|p_DtsecDriverParam
expr_stmt|;
name|fman_dtsec_defconfig
argument_list|(
name|p_DtsecDriverParam
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|p_MemMap
operator|=
operator|(
expr|struct
name|dtsec_regs
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|baseAddr
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|p_MiiMemMap
operator|=
operator|(
expr|struct
name|dtsec_mii_reg
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|baseAddr
operator|+
name|DTSEC_TO_MII_OFFSET
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|addr
operator|=
name|ENET_ADDR_TO_UINT64
argument_list|(
name|p_FmMacParam
operator|->
name|addr
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|enetMode
operator|=
name|p_FmMacParam
operator|->
name|enetMode
expr_stmt|;
name|p_Dtsec
operator|->
name|macId
operator|=
name|p_FmMacParam
operator|->
name|macId
expr_stmt|;
name|p_Dtsec
operator|->
name|exceptions
operator|=
name|DEFAULT_exceptions
expr_stmt|;
name|p_Dtsec
operator|->
name|mdioIrq
operator|=
name|p_FmMacParam
operator|->
name|mdioIrq
expr_stmt|;
name|p_Dtsec
operator|->
name|f_Exception
operator|=
name|p_FmMacParam
operator|->
name|f_Exception
expr_stmt|;
name|p_Dtsec
operator|->
name|f_Event
operator|=
name|p_FmMacParam
operator|->
name|f_Event
expr_stmt|;
name|p_Dtsec
operator|->
name|h_App
operator|=
name|p_FmMacParam
operator|->
name|h_App
expr_stmt|;
name|p_Dtsec
operator|->
name|ptpTsuEnabled
operator|=
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|ptp_tsu_en
expr_stmt|;
name|p_Dtsec
operator|->
name|enTsuErrExeption
operator|=
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|ptp_exception_en
expr_stmt|;
name|p_Dtsec
operator|->
name|tbi_phy_addr
operator|=
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|tbi_phy_addr
expr_stmt|;
return|return
name|p_Dtsec
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (c) 2008-2011 Freescale Semiconductor, Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are met:  *     * Redistributions of source code must retain the above copyright  *       notice, this list of conditions and the following disclaimer.  *     * Redistributions in binary form must reproduce the above copyright  *       notice, this list of conditions and the following disclaimer in the  *       documentation and/or other materials provided with the distribution.  *     * Neither the name of Freescale Semiconductor nor the  *       names of its contributors may be used to endorse or promote products  *       derived from this software without specific prior written permission.  *  *  * ALTERNATIVELY, this software may be distributed under the terms of the  * GNU General Public License ("GPL") as published by the Free Software  * Foundation, either version 2 of that License or (at your option) any  * later version.  *  * THIS SOFTWARE IS PROVIDED BY Freescale Semiconductor ``AS IS'' AND ANY  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED. IN NO EVENT SHALL Freescale Semiconductor BE LIABLE FOR ANY  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/******************************************************************************  @File          dtsec.c   @Description   FM dTSEC ... */
end_comment

begin_comment
comment|/***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|"std_ext.h"
end_include

begin_include
include|#
directive|include
file|"error_ext.h"
end_include

begin_include
include|#
directive|include
file|"string_ext.h"
end_include

begin_include
include|#
directive|include
file|"xx_ext.h"
end_include

begin_include
include|#
directive|include
file|"endian_ext.h"
end_include

begin_include
include|#
directive|include
file|"crc_mac_addr_ext.h"
end_include

begin_include
include|#
directive|include
file|"debug_ext.h"
end_include

begin_include
include|#
directive|include
file|"fm_common.h"
end_include

begin_include
include|#
directive|include
file|"dtsec.h"
end_include

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*                      Internal routines                                    */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
specifier|static
name|t_Error
name|CheckInitParameters
parameter_list|(
name|t_Dtsec
modifier|*
name|p_Dtsec
parameter_list|)
block|{
if|if
condition|(
name|ENET_SPEED_FROM_MODE
argument_list|(
name|p_Dtsec
operator|->
name|enetMode
argument_list|)
operator|>=
name|e_ENET_SPEED_10000
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Ethernet 1G MAC driver only supports 1G or lower speeds"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Dtsec
operator|->
name|macId
operator|>=
name|FM_MAX_NUM_OF_1G_MACS
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"macId can not be greater than the number of 1G MACs"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Dtsec
operator|->
name|addr
operator|==
literal|0
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Ethernet MAC Must have a valid MAC Address"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_SGMII_1000
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_RGMII_1000
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_QSGMII_1000
operator|)
operator|)
operator|&&
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|halfDuplex
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Ethernet MAC 1G can't work in half duplex"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|halfDuplex
operator|&&
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|loopback
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"LoopBack is not supported in halfDuplex mode"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_NO_RX_PREAM_ERRATA_DTSECx1
if|if
condition|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|preambleRxEn
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"preambleRxEn"
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* FM_NO_RX_PREAM_ERRATA_DTSECx1 */
if|if
condition|(
operator|(
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|preambleTxEn
operator|||
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|preambleRxEn
operator|)
operator|&&
operator|(
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|preambleLength
operator|!=
literal|0x7
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Preamble length should be 0x7 bytes"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|fifoTxWatermarkH
operator|<
operator|(
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|fifoTxThr
operator|+
literal|8
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"fifoTxWatermarkH has to be at least 8 larger than fifoTxThr"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|halfDuplex
operator|&&
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|txTimeStampEn
operator|||
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|rxTimeStampEn
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"dTSEC in half duplex mode has to be with 1588 timeStamping diable"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|actOnRxPauseFrame
operator|&&
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|controlFrameAccept
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Receive control frame are not passed to the system memory so it can not be accept "
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|packetAlignmentPadding
operator|>
name|MAX_PACKET_ALIGNMENT
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"packetAlignmentPadding can't be greater than %d "
operator|,
name|MAX_PACKET_ALIGNMENT
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|nonBackToBackIpg1
operator|>
name|MAX_INTER_PACKET_GAP
operator|)
operator|||
operator|(
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|nonBackToBackIpg2
operator|>
name|MAX_INTER_PACKET_GAP
operator|)
operator|||
operator|(
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|backToBackIpg
operator|>
name|MAX_INTER_PACKET_GAP
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Inter packet gap can't be greater than %d "
operator|,
name|MAX_INTER_PACKET_GAP
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|alternateBackoffVal
operator|>
name|MAX_INTER_PALTERNATE_BEB
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"alternateBackoffVal can't be greater than %d "
operator|,
name|MAX_INTER_PALTERNATE_BEB
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|maxRetransmission
operator|>
name|MAX_RETRANSMISSION
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"maxRetransmission can't be greater than %d "
operator|,
name|MAX_RETRANSMISSION
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|)
operator|->
name|collisionWindow
operator|>
name|MAX_COLLISION_WINDOW
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"collisionWindow can't be greater than %d "
operator|,
name|MAX_COLLISION_WINDOW
operator|)
argument_list|)
expr_stmt|;
comment|/*  If Auto negotiation process is disabled, need to */
comment|/*  Set up the PHY using the MII Management Interface */
if|if
condition|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|tbiPhyAddr
operator|>
name|MAX_PHYS
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_IN_RANGE
argument_list|,
operator|(
literal|"PHY address (should be 0-%d)"
operator|,
name|MAX_PHYS
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Dtsec
operator|->
name|f_Exception
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
operator|(
literal|"uninitialized f_Exception"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Dtsec
operator|->
name|f_Event
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
operator|(
literal|"uninitialized f_Event"
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|GetMiiDiv
parameter_list|(
name|int32_t
name|refClk
parameter_list|)
block|{
name|uint32_t
name|div
decl_stmt|,
name|tmpClk
decl_stmt|;
name|int
name|minRange
decl_stmt|;
name|div
operator|=
literal|1
expr_stmt|;
name|minRange
operator|=
call|(
name|int
call|)
argument_list|(
name|refClk
operator|/
literal|40
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tmpClk
operator|=
operator|(
name|uint32_t
operator|)
name|ABS
argument_list|(
name|refClk
operator|/
literal|60
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpClk
operator|<
name|minRange
condition|)
block|{
name|div
operator|=
literal|2
expr_stmt|;
name|minRange
operator|=
operator|(
name|int
operator|)
name|tmpClk
expr_stmt|;
block|}
name|tmpClk
operator|=
operator|(
name|uint32_t
operator|)
name|ABS
argument_list|(
name|refClk
operator|/
literal|60
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpClk
operator|<
name|minRange
condition|)
block|{
name|div
operator|=
literal|3
expr_stmt|;
name|minRange
operator|=
operator|(
name|int
operator|)
name|tmpClk
expr_stmt|;
block|}
name|tmpClk
operator|=
operator|(
name|uint32_t
operator|)
name|ABS
argument_list|(
name|refClk
operator|/
literal|80
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpClk
operator|<
name|minRange
condition|)
block|{
name|div
operator|=
literal|4
expr_stmt|;
name|minRange
operator|=
operator|(
name|int
operator|)
name|tmpClk
expr_stmt|;
block|}
name|tmpClk
operator|=
operator|(
name|uint32_t
operator|)
name|ABS
argument_list|(
name|refClk
operator|/
literal|100
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpClk
operator|<
name|minRange
condition|)
block|{
name|div
operator|=
literal|5
expr_stmt|;
name|minRange
operator|=
operator|(
name|int
operator|)
name|tmpClk
expr_stmt|;
block|}
name|tmpClk
operator|=
operator|(
name|uint32_t
operator|)
name|ABS
argument_list|(
name|refClk
operator|/
literal|140
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpClk
operator|<
name|minRange
condition|)
block|{
name|div
operator|=
literal|6
expr_stmt|;
name|minRange
operator|=
operator|(
name|int
operator|)
name|tmpClk
expr_stmt|;
block|}
name|tmpClk
operator|=
operator|(
name|uint32_t
operator|)
name|ABS
argument_list|(
name|refClk
operator|/
literal|280
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpClk
operator|<
name|minRange
condition|)
block|{
name|div
operator|=
literal|7
expr_stmt|;
name|minRange
operator|=
operator|(
name|int
operator|)
name|tmpClk
expr_stmt|;
block|}
return|return
operator|(
name|uint8_t
operator|)
name|div
return|;
block|}
end_function

begin_comment
comment|/* ........................................................................... */
end_comment

begin_function
specifier|static
name|void
name|SetDefaultParam
parameter_list|(
name|t_DtsecDriverParam
modifier|*
name|p_DtsecDriverParam
parameter_list|)
block|{
name|p_DtsecDriverParam
operator|->
name|errorDisabled
operator|=
name|DEFAULT_errorDisabled
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|promiscuousEnable
operator|=
name|DEFAULT_promiscuousEnable
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|pauseExtended
operator|=
name|DEFAULT_pauseExtended
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|pauseTime
operator|=
name|DEFAULT_pauseTime
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|halfDuplex
operator|=
name|DEFAULT_halfDuplex
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|halfDulexFlowControlEn
operator|=
name|DEFAULT_halfDulexFlowControlEn
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|txTimeStampEn
operator|=
name|DEFAULT_txTimeStampEn
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|rxTimeStampEn
operator|=
name|DEFAULT_rxTimeStampEn
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|packetAlignmentPadding
operator|=
name|DEFAULT_packetAlignment
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|controlFrameAccept
operator|=
name|DEFAULT_controlFrameAccept
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|groupHashExtend
operator|=
name|DEFAULT_groupHashExtend
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|broadcReject
operator|=
name|DEFAULT_broadcReject
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|rxShortFrame
operator|=
name|DEFAULT_rxShortFrame
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|exactMatch
operator|=
name|DEFAULT_exactMatch
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|debugMode
operator|=
name|DEFAULT_debugMode
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|loopback
operator|=
name|DEFAULT_loopback
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|tbiPhyAddr
operator|=
name|DEFAULT_tbiPhyAddr
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|actOnRxPauseFrame
operator|=
name|DEFAULT_actOnRxPauseFrame
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|actOnTxPauseFrame
operator|=
name|DEFAULT_actOnTxPauseFrame
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|preambleLength
operator|=
name|DEFAULT_PreAmLength
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|preambleRxEn
operator|=
name|DEFAULT_PreAmRxEn
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|preambleTxEn
operator|=
name|DEFAULT_PreAmTxEn
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|lengthCheckEnable
operator|=
name|DEFAULT_lengthCheckEnable
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|padAndCrcEnable
operator|=
name|DEFAULT_padAndCrcEnable
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|crcEnable
operator|=
name|DEFAULT_crcEnable
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|nonBackToBackIpg1
operator|=
name|DEFAULT_nonBackToBackIpg1
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|nonBackToBackIpg2
operator|=
name|DEFAULT_nonBackToBackIpg2
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|minIfgEnforcement
operator|=
name|DEFAULT_minIfgEnforcement
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|backToBackIpg
operator|=
name|DEFAULT_backToBackIpg
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|alternateBackoffVal
operator|=
name|DEFAULT_altBackoffVal
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|alternateBackoffEnable
operator|=
name|DEFAULT_altBackoffEnable
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|backPressureNoBackoff
operator|=
name|DEFAULT_backPressureNoBackoff
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|noBackoff
operator|=
name|DEFAULT_noBackoff
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|excessDefer
operator|=
name|DEFAULT_excessDefer
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|maxRetransmission
operator|=
name|DEFAULT_maxRetransmission
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|collisionWindow
operator|=
name|DEFAULT_collisionWindow
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|maxFrameLength
operator|=
name|DEFAULT_maxFrameLength
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|fifoTxThr
operator|=
name|DEFAULT_fifoTxThr
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|fifoTxWatermarkH
operator|=
name|DEFAULT_fifoTxWatermarkH
expr_stmt|;
name|p_DtsecDriverParam
operator|->
name|fifoRxWatermarkL
operator|=
name|DEFAULT_fifoRxWatermarkL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DtsecException
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|uint32_t
name|event
decl_stmt|;
name|t_DtsecMemMap
modifier|*
name|p_DtsecMemMap
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Dtsec
argument_list|)
expr_stmt|;
name|p_DtsecMemMap
operator|=
name|p_Dtsec
operator|->
name|p_MemMap
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|p_DtsecMemMap
argument_list|)
expr_stmt|;
name|event
operator|=
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|ievent
argument_list|)
expr_stmt|;
comment|/* handle only MDIO events */
name|event
operator|&=
operator|(
name|IMASK_MMRDEN
operator||
name|IMASK_MMWREN
operator|)
expr_stmt|;
if|if
condition|(
name|event
condition|)
block|{
name|event
operator|&=
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|imask
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|ievent
argument_list|,
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_MMRDEN
condition|)
name|p_Dtsec
operator|->
name|f_Event
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_MII_MNG_RD_COMPLET
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_MMWREN
condition|)
name|p_Dtsec
operator|->
name|f_Event
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_MII_MNG_WR_COMPLET
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|UpdateStatistics
parameter_list|(
name|t_Dtsec
modifier|*
name|p_Dtsec
parameter_list|)
block|{
name|t_DtsecMemMap
modifier|*
name|p_DtsecMemMap
init|=
name|p_Dtsec
operator|->
name|p_MemMap
decl_stmt|;
name|uint32_t
name|car1
init|=
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|car1
argument_list|)
decl_stmt|;
name|uint32_t
name|car2
init|=
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|car2
argument_list|)
decl_stmt|;
if|if
condition|(
name|car1
condition|)
block|{
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|car1
argument_list|,
name|car1
argument_list|)
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_TR64
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tr64
operator|+=
name|VAL22BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_TR127
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tr127
operator|+=
name|VAL22BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_TR255
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tr255
operator|+=
name|VAL22BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_TR511
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tr511
operator|+=
name|VAL22BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_TRK1
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tr1k
operator|+=
name|VAL22BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_TRMAX
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|trmax
operator|+=
name|VAL22BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_TRMGV
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|trmgv
operator|+=
name|VAL22BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_RBYT
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rbyt
operator|+=
operator|(
name|uint64_t
operator|)
name|VAL32BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_RPKT
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rpkt
operator|+=
name|VAL22BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_RMCA
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rmca
operator|+=
name|VAL22BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_RBCA
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rbca
operator|+=
name|VAL22BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_RXPF
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rxpf
operator|+=
name|VAL16BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_RALN
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|raln
operator|+=
name|VAL16BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_RFLR
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rflr
operator|+=
name|VAL16BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_RCDE
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rcde
operator|+=
name|VAL16BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_RCSE
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rcse
operator|+=
name|VAL16BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_RUND
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rund
operator|+=
name|VAL16BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_ROVR
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rovr
operator|+=
name|VAL16BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_RFRG
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rfrg
operator|+=
name|VAL16BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_RJBR
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rjbr
operator|+=
name|VAL16BIT
expr_stmt|;
if|if
condition|(
name|car1
operator|&
name|CAR1_RDRP
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rdrp
operator|+=
name|VAL16BIT
expr_stmt|;
block|}
if|if
condition|(
name|car2
condition|)
block|{
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|car2
argument_list|,
name|car2
argument_list|)
expr_stmt|;
if|if
condition|(
name|car2
operator|&
name|CAR2_TFCS
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tfcs
operator|+=
name|VAL12BIT
expr_stmt|;
if|if
condition|(
name|car2
operator|&
name|CAR2_TBYT
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tbyt
operator|+=
operator|(
name|uint64_t
operator|)
name|VAL32BIT
expr_stmt|;
if|if
condition|(
name|car2
operator|&
name|CAR2_TPKT
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tpkt
operator|+=
name|VAL22BIT
expr_stmt|;
if|if
condition|(
name|car2
operator|&
name|CAR2_TMCA
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tmca
operator|+=
name|VAL22BIT
expr_stmt|;
if|if
condition|(
name|car2
operator|&
name|CAR2_TBCA
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tbca
operator|+=
name|VAL22BIT
expr_stmt|;
if|if
condition|(
name|car2
operator|&
name|CAR2_TXPF
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|txpf
operator|+=
name|VAL16BIT
expr_stmt|;
if|if
condition|(
name|car2
operator|&
name|CAR2_TDRP
condition|)
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tdrp
operator|+=
name|VAL16BIT
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|uint16_t
name|DtsecGetMaxFrameLength
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|uint16_t
operator|)
name|GET_UINT32
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
operator|->
name|maxfrm
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|DtsecErrException
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|uint32_t
name|event
decl_stmt|;
name|t_DtsecMemMap
modifier|*
name|p_DtsecMemMap
init|=
name|p_Dtsec
operator|->
name|p_MemMap
decl_stmt|;
name|event
operator|=
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|ievent
argument_list|)
expr_stmt|;
comment|/* do not handle MDIO events */
name|event
operator|&=
operator|~
operator|(
name|IMASK_MMRDEN
operator||
name|IMASK_MMWREN
operator|)
expr_stmt|;
name|event
operator|&=
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|imask
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|ievent
argument_list|,
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_BREN
condition|)
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_BAB_RX
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_RXCEN
condition|)
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_RX_CTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_MSROEN
condition|)
name|UpdateStatistics
argument_list|(
name|p_Dtsec
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_GTSCEN
condition|)
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_GRATEFUL_TX_STP_COMPLET
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_BTEN
condition|)
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_BAB_TX
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_TXCEN
condition|)
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_TX_CTL
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_TXEEN
condition|)
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_TX_ERR
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_LCEN
condition|)
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_LATE_COL
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_CRLEN
condition|)
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_COL_RET_LMT
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_XFUNEN
condition|)
block|{
ifdef|#
directive|ifdef
name|FM_TX_LOCKUP_ERRATA_DTSEC6
name|uint32_t
name|tpkt1
decl_stmt|,
name|tmpReg1
decl_stmt|,
name|tpkt2
decl_stmt|,
name|tmpReg2
decl_stmt|,
name|i
decl_stmt|;
comment|/* a. Write 0x00E0_0C00 to DTSEC_ID */
comment|/* This is a read only regidter */
comment|/* b. Read and save the value of TPKT */
name|tpkt1
operator|=
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tpkt
argument_list|)
expr_stmt|;
comment|/* c. Read the register at dTSEC address offset 0x32C */
name|tmpReg1
operator|=
name|GET_UINT32
argument_list|(
operator|*
operator|(
name|uint32_t
operator|*
operator|)
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|p_DtsecMemMap
operator|+
literal|0x32c
operator|)
argument_list|)
expr_stmt|;
comment|/* d. Compare bits [9:15] to bits [25:31] of the register at address offset 0x32C. */
if|if
condition|(
operator|(
name|tmpReg1
operator|&
literal|0x007F0000
operator|)
operator|!=
operator|(
name|tmpReg1
operator|&
literal|0x0000007F
operator|)
condition|)
block|{
comment|/* If they are not equal, save the value of this register and wait for at least              * MAXFRM*16 ns */
name|XX_UDelay
argument_list|(
call|(
name|uint32_t
call|)
argument_list|(
name|NCSW_MIN
argument_list|(
name|DtsecGetMaxFrameLength
argument_list|(
name|p_Dtsec
argument_list|)
operator|*
literal|16
operator|/
literal|1000
argument_list|,
literal|1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* e. Read and save TPKT again and read the register at dTSEC address offset             0x32C again*/
name|tpkt2
operator|=
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tpkt
argument_list|)
expr_stmt|;
name|tmpReg2
operator|=
name|GET_UINT32
argument_list|(
operator|*
operator|(
name|uint32_t
operator|*
operator|)
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|p_DtsecMemMap
operator|+
literal|0x32c
operator|)
argument_list|)
expr_stmt|;
comment|/* f. Compare the value of TPKT saved in step b to value read in step e. Also             compare bits [9:15] of the register at offset 0x32C saved in step d to the value             of bits [9:15] saved in step e. If the two registers values are unchanged, then             the transmit portion of the dTSEC controller is locked up and the user should             proceed to the recover sequence. */
if|if
condition|(
operator|(
name|tpkt1
operator|==
name|tpkt2
operator|)
operator|&&
operator|(
operator|(
name|tmpReg1
operator|&
literal|0x007F0000
operator|)
operator|==
operator|(
name|tmpReg2
operator|&
literal|0x007F0000
operator|)
operator|)
condition|)
block|{
comment|/* recover sequence */
comment|/* a.Write a 1 to RCTRL[GRS]*/
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|rctrl
argument_list|,
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|rctrl
argument_list|)
operator||
name|RCTRL_GRS
argument_list|)
expr_stmt|;
comment|/* b.Wait until IEVENT[GRSC]=1, or at least 100 us has elapsed. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|100
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|ievent
argument_list|)
operator|&
name|IMASK_GRSCEN
condition|)
break|break;
name|XX_UDelay
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|ievent
argument_list|)
operator|&
name|IMASK_GRSCEN
condition|)
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|ievent
argument_list|,
name|IMASK_GRSCEN
argument_list|)
expr_stmt|;
else|else
name|DBG
argument_list|(
name|INFO
argument_list|,
operator|(
literal|"Rx lockup due to dTSEC Tx lockup"
operator|)
argument_list|)
expr_stmt|;
comment|/* c.Write a 1 to bit n of FM_RSTC (offset 0x0CC of FPM)*/
name|FmResetMac
argument_list|(
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
name|e_FM_MAC_1G
argument_list|,
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|macId
argument_list|)
expr_stmt|;
comment|/* d.Wait 4 Tx clocks (32 ns) */
name|XX_UDelay
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* e.Write a 0 to bit n of FM_RSTC. */
comment|/* cleared by FMAN */
block|}
else|else
block|{
comment|/* If either value has changed, the dTSEC controller is not locked up and the                controller should be allowed to proceed normally by writing the reset value                of 0x0824_0101 to DTSEC_ID. */
comment|/* Register is read only */
block|}
endif|#
directive|endif
comment|/* FM_TX_LOCKUP_ERRATA_DTSEC6 */
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_TX_FIFO_UNDRN
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|event
operator|&
name|IMASK_MAGEN
condition|)
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_MAG_PCKT
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_GRSCEN
condition|)
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_GRATEFUL_RX_STP_COMPLET
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_TDPEEN
condition|)
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_TX_DATA_ERR
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|IMASK_RDPEEN
condition|)
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_RX_DATA_ERR
argument_list|)
expr_stmt|;
comment|/*  - masked interrupts */
name|ASSERT_COND
argument_list|(
operator|!
operator|(
name|event
operator|&
name|IMASK_ABRTEN
operator|)
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
operator|!
operator|(
name|event
operator|&
name|IMASK_IFERREN
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|Dtsec1588Exception
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|uint32_t
name|event
decl_stmt|;
name|t_DtsecMemMap
modifier|*
name|p_DtsecMemMap
init|=
name|p_Dtsec
operator|->
name|p_MemMap
decl_stmt|;
if|if
condition|(
name|p_Dtsec
operator|->
name|ptpTsuEnabled
condition|)
block|{
name|event
operator|=
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tmr_pevent
argument_list|)
expr_stmt|;
name|event
operator|&=
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tmr_pemask
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
condition|)
block|{
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tmr_pevent
argument_list|,
name|event
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|event
operator|&
name|PEMASK_TSRE
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|f_Exception
argument_list|(
name|p_Dtsec
operator|->
name|h_App
argument_list|,
name|e_FM_MAC_EX_1G_1588_TS_RX_ERR
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* ........................................................................... */
end_comment

begin_function
specifier|static
name|void
name|FreeInitResources
parameter_list|(
name|t_Dtsec
modifier|*
name|p_Dtsec
parameter_list|)
block|{
comment|/*TODO - need to ask why with mdioIrq != 0*/
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|mdioIrq
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|p_Dtsec
operator|->
name|mdioIrq
operator|!=
name|NO_IRQ
operator|)
condition|)
block|{
name|XX_DisableIntr
argument_list|(
name|p_Dtsec
operator|->
name|mdioIrq
argument_list|)
expr_stmt|;
name|XX_FreeIntr
argument_list|(
name|p_Dtsec
operator|->
name|mdioIrq
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p_Dtsec
operator|->
name|mdioIrq
operator|==
literal|0
condition|)
name|FmUnregisterIntr
argument_list|(
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
name|e_FM_MOD_1G_MAC
argument_list|,
name|p_Dtsec
operator|->
name|macId
argument_list|,
name|e_FM_INTR_TYPE_NORMAL
argument_list|)
expr_stmt|;
name|FmUnregisterIntr
argument_list|(
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
name|e_FM_MOD_1G_MAC
argument_list|,
name|p_Dtsec
operator|->
name|macId
argument_list|,
name|e_FM_INTR_TYPE_ERR
argument_list|)
expr_stmt|;
name|FmUnregisterIntr
argument_list|(
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
name|e_FM_MOD_1G_MAC_TMR
argument_list|,
name|p_Dtsec
operator|->
name|macId
argument_list|,
name|e_FM_INTR_TYPE_NORMAL
argument_list|)
expr_stmt|;
comment|/* release the driver's group hash table */
name|FreeHashTable
argument_list|(
name|p_Dtsec
operator|->
name|p_MulticastAddrHash
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|p_MulticastAddrHash
operator|=
name|NULL
expr_stmt|;
comment|/* release the driver's individual hash table */
name|FreeHashTable
argument_list|(
name|p_Dtsec
operator|->
name|p_UnicastAddrHash
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|p_UnicastAddrHash
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ........................................................................... */
end_comment

begin_function
specifier|static
name|void
name|HardwareClearAddrInPaddr
parameter_list|(
name|t_Dtsec
modifier|*
name|p_Dtsec
parameter_list|,
name|uint8_t
name|paddrNum
parameter_list|)
block|{
name|WRITE_UINT32
argument_list|(
operator|(
operator|(
name|t_DtsecMemMap
operator|*
operator|)
name|p_Dtsec
operator|->
name|p_MemMap
operator|)
operator|->
name|macaddr
index|[
name|paddrNum
index|]
operator|.
name|exact_match1
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
operator|(
operator|(
name|t_DtsecMemMap
operator|*
operator|)
name|p_Dtsec
operator|->
name|p_MemMap
operator|)
operator|->
name|macaddr
index|[
name|paddrNum
index|]
operator|.
name|exact_match2
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ........................................................................... */
end_comment

begin_function
specifier|static
name|void
name|HardwareAddAddrInPaddr
parameter_list|(
name|t_Dtsec
modifier|*
name|p_Dtsec
parameter_list|,
name|uint64_t
modifier|*
name|p_Addr
parameter_list|,
name|uint8_t
name|paddrNum
parameter_list|)
block|{
name|uint32_t
name|tmpReg32
init|=
literal|0
decl_stmt|;
name|uint64_t
name|addr
init|=
operator|*
name|p_Addr
decl_stmt|;
name|t_DtsecMemMap
modifier|*
name|p_DtsecMemMap
init|=
operator|(
name|t_DtsecMemMap
operator|*
operator|)
name|p_Dtsec
operator|->
name|p_MemMap
decl_stmt|;
name|tmpReg32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|SwapUint32P
argument_list|(
operator|&
name|tmpReg32
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|macaddr
index|[
name|paddrNum
index|]
operator|.
name|exact_match1
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
name|tmpReg32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|addr
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|SwapUint32P
argument_list|(
operator|&
name|tmpReg32
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|macaddr
index|[
name|paddrNum
index|]
operator|.
name|exact_match2
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ........................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|GracefulStop
parameter_list|(
name|t_Dtsec
modifier|*
name|p_Dtsec
parameter_list|,
name|e_CommMode
name|mode
parameter_list|)
block|{
name|t_DtsecMemMap
modifier|*
name|p_MemMap
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Dtsec
argument_list|)
expr_stmt|;
name|p_MemMap
operator|=
operator|(
name|t_DtsecMemMap
operator|*
operator|)
operator|(
name|p_Dtsec
operator|->
name|p_MemMap
operator|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|p_MemMap
argument_list|)
expr_stmt|;
comment|/* Assert the graceful transmit stop bit */
if|if
condition|(
name|mode
operator|&
name|e_COMM_MODE_RX
condition|)
name|WRITE_UINT32
argument_list|(
name|p_MemMap
operator|->
name|rctrl
argument_list|,
name|GET_UINT32
argument_list|(
name|p_MemMap
operator|->
name|rctrl
argument_list|)
operator||
name|RCTRL_GRS
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_GRS_ERRATA_DTSEC_A002
name|XX_UDelay
argument_list|(
literal|100
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* FM_GRS_ERRATA_DTSEC_A002 */
ifdef|#
directive|ifdef
name|FM_GTS_ERRATA_DTSEC_A004
name|DBG
argument_list|(
name|INFO
argument_list|,
operator|(
literal|"GTS not supported due to DTSEC_A004 errata."
operator|)
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* not FM_GTS_ERRATA_DTSEC_A004 */
if|if
condition|(
name|mode
operator|&
name|e_COMM_MODE_TX
condition|)
name|WRITE_UINT32
argument_list|(
name|p_MemMap
operator|->
name|tctrl
argument_list|,
name|GET_UINT32
argument_list|(
name|p_MemMap
operator|->
name|tctrl
argument_list|)
operator||
name|TCTRL_GTS
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* not FM_GTS_ERRATA_DTSEC_A004 */
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|GracefulRestart
parameter_list|(
name|t_Dtsec
modifier|*
name|p_Dtsec
parameter_list|,
name|e_CommMode
name|mode
parameter_list|)
block|{
name|t_DtsecMemMap
modifier|*
name|p_MemMap
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Dtsec
argument_list|)
expr_stmt|;
name|p_MemMap
operator|=
operator|(
name|t_DtsecMemMap
operator|*
operator|)
operator|(
name|p_Dtsec
operator|->
name|p_MemMap
operator|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|p_MemMap
argument_list|)
expr_stmt|;
comment|/* clear the graceful receive stop bit */
if|if
condition|(
name|mode
operator|&
name|e_COMM_MODE_TX
condition|)
name|WRITE_UINT32
argument_list|(
name|p_MemMap
operator|->
name|tctrl
argument_list|,
name|GET_UINT32
argument_list|(
name|p_MemMap
operator|->
name|tctrl
argument_list|)
operator|&
operator|~
name|TCTRL_GTS
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|e_COMM_MODE_RX
condition|)
name|WRITE_UINT32
argument_list|(
name|p_MemMap
operator|->
name|rctrl
argument_list|,
name|GET_UINT32
argument_list|(
name|p_MemMap
operator|->
name|rctrl
argument_list|)
operator|&
operator|~
name|RCTRL_GRS
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*                      dTSEC Configs modification functions                 */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecConfigLoopback
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|bool
name|newVal
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|loopback
operator|=
name|newVal
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecConfigMaxFrameLength
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|uint16_t
name|newVal
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|maxFrameLength
operator|=
name|newVal
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecConfigPadAndCrc
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|bool
name|newVal
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|padAndCrcEnable
operator|=
name|newVal
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecConfigHalfDuplex
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|bool
name|newVal
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|halfDuplex
operator|=
name|newVal
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecConfigLengthCheck
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|bool
name|newVal
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|FM_LEN_CHECK_ERRATA_FMAN_SW002
name|UNUSED
argument_list|(
name|h_Dtsec
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"LengthCheck!"
operator|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|->
name|lengthCheckEnable
operator|=
name|newVal
expr_stmt|;
return|return
name|E_OK
return|;
endif|#
directive|endif
comment|/* FM_LEN_CHECK_ERRATA_FMAN_SW002 */
block|}
end_function

begin_function
specifier|static
name|t_Error
name|DtsecConfigException
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|e_FmMacExceptions
name|exception
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|uint32_t
name|bitMask
init|=
literal|0
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|exception
operator|!=
name|e_FM_MAC_EX_1G_1588_TS_RX_ERR
condition|)
block|{
name|GET_EXCEPTION_FLAG
argument_list|(
name|bitMask
argument_list|,
name|exception
argument_list|)
expr_stmt|;
if|if
condition|(
name|bitMask
condition|)
block|{
if|if
condition|(
name|enable
condition|)
name|p_Dtsec
operator|->
name|exceptions
operator||=
name|bitMask
expr_stmt|;
else|else
name|p_Dtsec
operator|->
name|exceptions
operator|&=
operator|~
name|bitMask
expr_stmt|;
block|}
else|else
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Undefined exception"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|p_Dtsec
operator|->
name|ptpTsuEnabled
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Exception valid for 1588 only"
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|exception
condition|)
block|{
case|case
operator|(
name|e_FM_MAC_EX_1G_1588_TS_RX_ERR
operator|)
case|:
if|if
condition|(
name|enable
condition|)
name|p_Dtsec
operator|->
name|enTsuErrExeption
operator|=
name|TRUE
expr_stmt|;
else|else
name|p_Dtsec
operator|->
name|enTsuErrExeption
operator|=
name|FALSE
expr_stmt|;
break|break;
default|default:
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Undefined exception"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*                      dTSEC Run Time API functions                         */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecEnable
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|e_CommMode
name|mode
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|t_DtsecMemMap
modifier|*
name|p_MemMap
decl_stmt|;
name|uint32_t
name|tmpReg32
init|=
literal|0
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_MemMap
operator|=
operator|(
name|t_DtsecMemMap
operator|*
operator|)
operator|(
name|p_Dtsec
operator|->
name|p_MemMap
operator|)
expr_stmt|;
name|tmpReg32
operator|=
name|GET_UINT32
argument_list|(
name|p_MemMap
operator|->
name|maccfg1
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|e_COMM_MODE_RX
condition|)
name|tmpReg32
operator||=
name|MACCFG1_RX_EN
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|e_COMM_MODE_TX
condition|)
name|tmpReg32
operator||=
name|MACCFG1_TX_EN
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_MemMap
operator|->
name|maccfg1
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
name|GracefulRestart
argument_list|(
name|p_Dtsec
argument_list|,
name|mode
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecDisable
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|e_CommMode
name|mode
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|t_DtsecMemMap
modifier|*
name|p_MemMap
decl_stmt|;
name|uint32_t
name|tmpReg32
init|=
literal|0
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_MemMap
operator|=
operator|(
name|t_DtsecMemMap
operator|*
operator|)
operator|(
name|p_Dtsec
operator|->
name|p_MemMap
operator|)
expr_stmt|;
name|GracefulStop
argument_list|(
name|p_Dtsec
argument_list|,
name|mode
argument_list|)
expr_stmt|;
name|tmpReg32
operator|=
name|GET_UINT32
argument_list|(
name|p_MemMap
operator|->
name|maccfg1
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|e_COMM_MODE_RX
condition|)
name|tmpReg32
operator|&=
operator|~
name|MACCFG1_RX_EN
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|e_COMM_MODE_TX
condition|)
name|tmpReg32
operator|&=
operator|~
name|MACCFG1_TX_EN
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_MemMap
operator|->
name|maccfg1
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecTxMacPause
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|uint16_t
name|pauseTime
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|uint32_t
name|ptv
init|=
literal|0
decl_stmt|;
name|t_DtsecMemMap
modifier|*
name|p_MemMap
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_MemMap
operator|=
operator|(
name|t_DtsecMemMap
operator|*
operator|)
operator|(
name|p_Dtsec
operator|->
name|p_MemMap
operator|)
expr_stmt|;
if|if
condition|(
name|pauseTime
condition|)
block|{
ifdef|#
directive|ifdef
name|FM_BAD_TX_TS_IN_B_2_B_ERRATA_DTSEC_A003
block|{
if|if
condition|(
name|pauseTime
operator|<=
literal|320
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"This pause-time value of %d is illegal due to errata dTSEC-A003!"
literal|" value should be greater than 320."
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* FM_BAD_TX_TS_IN_B_2_B_ERRATA_DTSEC_A003 */
ifdef|#
directive|ifdef
name|FM_SHORT_PAUSE_TIME_ERRATA_DTSEC1
block|{
name|t_FmRevisionInfo
name|revInfo
decl_stmt|;
name|FM_GetRevision
argument_list|(
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
operator|&
name|revInfo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|revInfo
operator|.
name|majorRev
operator|==
literal|1
operator|)
operator|&&
operator|(
name|revInfo
operator|.
name|minorRev
operator|==
literal|0
operator|)
condition|)
name|pauseTime
operator|+=
literal|2
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* FM_SHORT_PAUSE_TIME_ERRATA_DTSEC1 */
name|ptv
operator|=
name|GET_UINT32
argument_list|(
name|p_MemMap
operator|->
name|ptv
argument_list|)
expr_stmt|;
name|ptv
operator||=
name|pauseTime
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_MemMap
operator|->
name|ptv
argument_list|,
name|ptv
argument_list|)
expr_stmt|;
comment|/* trigger the transmission of a flow-control pause frame */
name|WRITE_UINT32
argument_list|(
name|p_MemMap
operator|->
name|maccfg1
argument_list|,
name|GET_UINT32
argument_list|(
name|p_MemMap
operator|->
name|maccfg1
argument_list|)
operator||
name|MACCFG1_TX_FLOW
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|WRITE_UINT32
argument_list|(
name|p_MemMap
operator|->
name|maccfg1
argument_list|,
name|GET_UINT32
argument_list|(
name|p_MemMap
operator|->
name|maccfg1
argument_list|)
operator|&
operator|~
name|MACCFG1_TX_FLOW
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecRxIgnoreMacPause
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|bool
name|en
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|t_DtsecMemMap
modifier|*
name|p_MemMap
decl_stmt|;
name|uint32_t
name|tmpReg32
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_MemMap
operator|=
operator|(
name|t_DtsecMemMap
operator|*
operator|)
operator|(
name|p_Dtsec
operator|->
name|p_MemMap
operator|)
expr_stmt|;
name|tmpReg32
operator|=
name|GET_UINT32
argument_list|(
name|p_MemMap
operator|->
name|maccfg1
argument_list|)
expr_stmt|;
if|if
condition|(
name|en
condition|)
name|tmpReg32
operator|&=
operator|~
name|MACCFG1_RX_FLOW
expr_stmt|;
else|else
name|tmpReg32
operator||=
name|MACCFG1_RX_FLOW
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_MemMap
operator|->
name|maccfg1
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecEnable1588TimeStamp
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_10_100_SGMII_NO_TS_ERRATA_DTSEC3
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_SGMII_10
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_SGMII_100
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"1588TimeStamp in 10/100 SGMII"
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* FM_10_100_SGMII_NO_TS_ERRATA_DTSEC3 */
name|p_Dtsec
operator|->
name|ptpTsuEnabled
operator|=
name|TRUE
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
operator|->
name|rctrl
argument_list|,
name|GET_UINT32
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
operator|->
name|rctrl
argument_list|)
operator||
name|RCTRL_RTSE
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
operator|->
name|tctrl
argument_list|,
name|GET_UINT32
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
operator|->
name|tctrl
argument_list|)
operator||
name|TCTRL_TTSE
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|DtsecDisable1588TimeStamp
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|ptpTsuEnabled
operator|=
name|FALSE
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
operator|->
name|rctrl
argument_list|,
name|GET_UINT32
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
operator|->
name|rctrl
argument_list|)
operator|&
operator|~
name|RCTRL_RTSE
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
operator|->
name|tctrl
argument_list|,
name|GET_UINT32
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
operator|->
name|tctrl
argument_list|)
operator|&
operator|~
name|TCTRL_TTSE
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecGetStatistics
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|t_FmMacStatistics
modifier|*
name|p_Statistics
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|t_DtsecMemMap
modifier|*
name|p_DtsecMemMap
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Statistics
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Dtsec
operator|->
name|statisticsLevel
operator|==
name|e_FM_MAC_NONE_STATISTICS
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Statistics disabled"
operator|)
argument_list|)
expr_stmt|;
name|p_DtsecMemMap
operator|=
name|p_Dtsec
operator|->
name|p_MemMap
expr_stmt|;
name|memset
argument_list|(
name|p_Statistics
argument_list|,
literal|0xff
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmMacStatistics
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Dtsec
operator|->
name|statisticsLevel
operator|==
name|e_FM_MAC_FULL_STATISTICS
condition|)
block|{
name|p_Statistics
operator|->
name|eStatPkts64
operator|=
operator|(
name|MASK22BIT
operator|&
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tr64
argument_list|)
operator|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tr64
expr_stmt|;
comment|/**< r-10G tr-DT 64 byte frame counter */
name|p_Statistics
operator|->
name|eStatPkts65to127
operator|=
operator|(
name|MASK22BIT
operator|&
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tr127
argument_list|)
operator|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tr127
expr_stmt|;
comment|/**< r-10G 65 to 127 byte frame counter */
name|p_Statistics
operator|->
name|eStatPkts128to255
operator|=
operator|(
name|MASK22BIT
operator|&
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tr255
argument_list|)
operator|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tr255
expr_stmt|;
comment|/**< r-10G 128 to 255 byte frame counter */
name|p_Statistics
operator|->
name|eStatPkts256to511
operator|=
operator|(
name|MASK22BIT
operator|&
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tr511
argument_list|)
operator|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tr511
expr_stmt|;
comment|/**< r-10G 256 to 511 byte frame counter */
name|p_Statistics
operator|->
name|eStatPkts512to1023
operator|=
operator|(
name|MASK22BIT
operator|&
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tr1k
argument_list|)
operator|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tr1k
expr_stmt|;
comment|/**< r-10G 512 to 1023 byte frame counter */
name|p_Statistics
operator|->
name|eStatPkts1024to1518
operator|=
operator|(
name|MASK22BIT
operator|&
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|trmax
argument_list|)
operator|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|trmax
expr_stmt|;
comment|/**< r-10G 1024 to 1518 byte frame counter */
name|p_Statistics
operator|->
name|eStatPkts1519to1522
operator|=
operator|(
name|MASK22BIT
operator|&
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|trmgv
argument_list|)
operator|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|trmgv
expr_stmt|;
comment|/**< r-10G 1519 to 1522 byte good frame count */
comment|/* MIB II */
name|p_Statistics
operator|->
name|ifInOctets
operator|=
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|rbyt
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rbyt
expr_stmt|;
comment|/**< Total number of byte received. */
name|p_Statistics
operator|->
name|ifInPkts
operator|=
operator|(
name|MASK22BIT
operator|&
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|rpkt
argument_list|)
operator|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rpkt
expr_stmt|;
comment|/**< Total number of packets received.*/
name|p_Statistics
operator|->
name|ifInMcastPkts
operator|=
operator|(
name|MASK22BIT
operator|&
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|rmca
argument_list|)
operator|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rmca
expr_stmt|;
comment|/**< Total number of multicast frame received*/
name|p_Statistics
operator|->
name|ifInBcastPkts
operator|=
operator|(
name|MASK22BIT
operator|&
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|rbca
argument_list|)
operator|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rbca
expr_stmt|;
comment|/**< Total number of broadcast frame received */
name|p_Statistics
operator|->
name|ifOutOctets
operator|=
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tbyt
argument_list|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tbyt
expr_stmt|;
comment|/**< Total number of byte sent. */
name|p_Statistics
operator|->
name|ifOutPkts
operator|=
operator|(
name|MASK22BIT
operator|&
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tpkt
argument_list|)
operator|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tpkt
expr_stmt|;
comment|/**< Total number of packets sent .*/
name|p_Statistics
operator|->
name|ifOutMcastPkts
operator|=
operator|(
name|MASK22BIT
operator|&
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tmca
argument_list|)
operator|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tmca
expr_stmt|;
comment|/**< Total number of multicast frame sent */
name|p_Statistics
operator|->
name|ifOutBcastPkts
operator|=
operator|(
name|MASK22BIT
operator|&
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tbca
argument_list|)
operator|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tbca
expr_stmt|;
comment|/**< Total number of multicast frame sent */
block|}
comment|/* */
name|p_Statistics
operator|->
name|eStatFragments
operator|=
operator|(
name|MASK16BIT
operator|&
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|rfrg
argument_list|)
operator|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rfrg
expr_stmt|;
comment|/**< Total number of packets that were less than 64 octets long with a wrong CRC.*/
name|p_Statistics
operator|->
name|eStatJabbers
operator|=
operator|(
name|MASK16BIT
operator|&
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|rjbr
argument_list|)
operator|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rjbr
expr_stmt|;
comment|/**< Total number of packets longer than valid maximum length octets */
name|p_Statistics
operator|->
name|eStatsDropEvents
operator|=
operator|(
name|MASK16BIT
operator|&
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|rdrp
argument_list|)
operator|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rdrp
expr_stmt|;
comment|/**< number of dropped packets due to internal errors of the MAC Client. */
name|p_Statistics
operator|->
name|eStatCRCAlignErrors
operator|=
operator|(
name|MASK16BIT
operator|&
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|raln
argument_list|)
operator|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|raln
expr_stmt|;
comment|/**< Incremented when frames of correct length but with CRC error are received.*/
name|p_Statistics
operator|->
name|eStatUndersizePkts
operator|=
operator|(
name|MASK16BIT
operator|&
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|rund
argument_list|)
operator|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rund
expr_stmt|;
comment|/**< Total number of packets that were less than 64 octets long with a good CRC.*/
name|p_Statistics
operator|->
name|eStatOversizePkts
operator|=
operator|(
name|MASK16BIT
operator|&
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|rovr
argument_list|)
operator|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rovr
expr_stmt|;
comment|/**< T,B.D*/
comment|/* Pause */
name|p_Statistics
operator|->
name|reStatPause
operator|=
operator|(
name|MASK16BIT
operator|&
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|rxpf
argument_list|)
operator|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rxpf
expr_stmt|;
comment|/**< Pause MAC Control received */
name|p_Statistics
operator|->
name|teStatPause
operator|=
operator|(
name|MASK16BIT
operator|&
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|txpf
argument_list|)
operator|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|txpf
expr_stmt|;
comment|/**< Pause MAC Control sent */
name|p_Statistics
operator|->
name|ifInDiscards
operator|=
name|p_Statistics
operator|->
name|eStatsDropEvents
expr_stmt|;
comment|/**< Frames received, but discarded due to problems within the MAC RX. */
name|p_Statistics
operator|->
name|ifInErrors
operator|=
name|p_Statistics
operator|->
name|eStatsDropEvents
operator|+
name|p_Statistics
operator|->
name|eStatCRCAlignErrors
operator|+
operator|(
name|MASK16BIT
operator|&
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|rflr
argument_list|)
operator|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rflr
operator|+
operator|(
name|MASK16BIT
operator|&
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|rcde
argument_list|)
operator|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rcde
operator|+
operator|(
name|MASK16BIT
operator|&
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|rcse
argument_list|)
operator|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|rcse
expr_stmt|;
name|p_Statistics
operator|->
name|ifOutDiscards
operator|=
operator|(
name|MASK16BIT
operator|&
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tdrp
argument_list|)
operator|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tdrp
expr_stmt|;
comment|/**< Frames received, but discarded due to problems within the MAC TX N/A!.*/
name|p_Statistics
operator|->
name|ifOutErrors
operator|=
name|p_Statistics
operator|->
name|ifOutDiscards
comment|/**< Number of frames transmitted with error: */
operator|+
operator|(
name|MASK12BIT
operator|&
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tfcs
argument_list|)
operator|)
operator|+
name|p_Dtsec
operator|->
name|internalStatistics
operator|.
name|tfcs
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecModifyMacAddress
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|t_EnetAddr
modifier|*
name|p_EnetAddr
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|t_DtsecMemMap
modifier|*
name|p_DtsecMemMap
decl_stmt|;
name|uint32_t
name|tmpReg32
init|=
literal|0
decl_stmt|;
name|uint64_t
name|addr
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|p_DtsecMemMap
operator|=
name|p_Dtsec
operator|->
name|p_MemMap
expr_stmt|;
comment|/* Initialize MAC Station Address registers (1& 2)    */
comment|/* Station address have to be swapped (big endian to little endian */
name|addr
operator|=
operator|(
operator|(
operator|*
operator|(
name|uint64_t
operator|*
operator|)
name|p_EnetAddr
operator|)
operator|>>
literal|16
operator|)
expr_stmt|;
name|p_Dtsec
operator|->
name|addr
operator|=
name|addr
expr_stmt|;
name|tmpReg32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|SwapUint32P
argument_list|(
operator|&
name|tmpReg32
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|macstnaddr1
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
name|tmpReg32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|addr
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|SwapUint32P
argument_list|(
operator|&
name|tmpReg32
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|macstnaddr2
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecResetCounters
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
comment|/* clear HW counters */
name|WRITE_UINT32
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
operator|->
name|ecntrl
argument_list|,
name|GET_UINT32
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
operator|->
name|ecntrl
argument_list|)
operator||
name|ECNTRL_CLRCNT
argument_list|)
expr_stmt|;
comment|/* clear SW counters holding carries */
name|memset
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|p_Dtsec
operator|->
name|internalStatistics
argument_list|,
operator|(
name|char
operator|)
literal|0x0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_InternalStatistics
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecAddExactMatchMacAddress
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|t_EnetAddr
modifier|*
name|p_EthAddr
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|uint64_t
name|ethAddr
decl_stmt|;
name|uint8_t
name|paddrNum
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|ethAddr
operator|=
operator|(
operator|(
operator|*
operator|(
name|uint64_t
operator|*
operator|)
name|p_EthAddr
operator|)
operator|>>
literal|16
operator|)
expr_stmt|;
if|if
condition|(
name|ethAddr
operator|&
name|GROUP_ADDRESS
condition|)
comment|/* Multicast address has no effect in PADDR */
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Multicast address"
operator|)
argument_list|)
expr_stmt|;
comment|/* Make sure no PADDR contains this address */
for|for
control|(
name|paddrNum
operator|=
literal|0
init|;
name|paddrNum
operator|<
name|DTSEC_NUM_OF_PADDRS
condition|;
name|paddrNum
operator|++
control|)
if|if
condition|(
name|p_Dtsec
operator|->
name|indAddrRegUsed
index|[
name|paddrNum
index|]
condition|)
if|if
condition|(
name|p_Dtsec
operator|->
name|paddr
index|[
name|paddrNum
index|]
operator|==
name|ethAddr
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_ALREADY_EXISTS
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
comment|/* Find first unused PADDR */
for|for
control|(
name|paddrNum
operator|=
literal|0
init|;
name|paddrNum
operator|<
name|DTSEC_NUM_OF_PADDRS
condition|;
name|paddrNum
operator|++
control|)
if|if
condition|(
operator|!
operator|(
name|p_Dtsec
operator|->
name|indAddrRegUsed
index|[
name|paddrNum
index|]
operator|)
condition|)
block|{
comment|/* mark this PADDR as used */
name|p_Dtsec
operator|->
name|indAddrRegUsed
index|[
name|paddrNum
index|]
operator|=
name|TRUE
expr_stmt|;
comment|/* store address */
name|p_Dtsec
operator|->
name|paddr
index|[
name|paddrNum
index|]
operator|=
name|ethAddr
expr_stmt|;
comment|/* put in hardware */
name|HardwareAddAddrInPaddr
argument_list|(
name|p_Dtsec
argument_list|,
operator|&
name|ethAddr
argument_list|,
name|paddrNum
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|numOfIndAddrInRegs
operator|++
expr_stmt|;
return|return
name|E_OK
return|;
block|}
comment|/* No free PADDR */
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_FULL
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecDelExactMatchMacAddress
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|t_EnetAddr
modifier|*
name|p_EthAddr
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|uint64_t
name|ethAddr
decl_stmt|;
name|uint8_t
name|paddrNum
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|ethAddr
operator|=
operator|(
operator|(
operator|*
operator|(
name|uint64_t
operator|*
operator|)
name|p_EthAddr
operator|)
operator|>>
literal|16
operator|)
expr_stmt|;
comment|/* Find used PADDR containing this address */
for|for
control|(
name|paddrNum
operator|=
literal|0
init|;
name|paddrNum
operator|<
name|DTSEC_NUM_OF_PADDRS
condition|;
name|paddrNum
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|indAddrRegUsed
index|[
name|paddrNum
index|]
operator|)
operator|&&
operator|(
name|p_Dtsec
operator|->
name|paddr
index|[
name|paddrNum
index|]
operator|==
name|ethAddr
operator|)
condition|)
block|{
comment|/* mark this PADDR as not used */
name|p_Dtsec
operator|->
name|indAddrRegUsed
index|[
name|paddrNum
index|]
operator|=
name|FALSE
expr_stmt|;
comment|/* clear in hardware */
name|HardwareClearAddrInPaddr
argument_list|(
name|p_Dtsec
argument_list|,
name|paddrNum
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|numOfIndAddrInRegs
operator|--
expr_stmt|;
return|return
name|E_OK
return|;
block|}
block|}
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_FOUND
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecAddHashMacAddress
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|t_EnetAddr
modifier|*
name|p_EthAddr
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|t_DtsecMemMap
modifier|*
name|p_DtsecMemMap
decl_stmt|;
name|uint32_t
name|crc
decl_stmt|;
name|uint8_t
name|crcMirror
decl_stmt|,
name|reg
decl_stmt|;
name|uint32_t
name|bitMask
decl_stmt|;
name|t_EthHashEntry
modifier|*
name|p_HashEntry
decl_stmt|;
name|uint64_t
name|ethAddr
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|p_DtsecMemMap
operator|=
name|p_Dtsec
operator|->
name|p_MemMap
expr_stmt|;
name|ethAddr
operator|=
operator|(
operator|(
operator|*
operator|(
name|uint64_t
operator|*
operator|)
name|p_EthAddr
operator|)
operator|>>
literal|16
operator|)
expr_stmt|;
comment|/* CRC calculation */
name|GET_MAC_ADDR_CRC
argument_list|(
name|ethAddr
argument_list|,
name|crc
argument_list|)
expr_stmt|;
comment|/* calculate the "crc mirror" */
name|crcMirror
operator|=
name|MIRROR
argument_list|(
operator|(
name|uint8_t
operator|)
name|crc
argument_list|)
expr_stmt|;
comment|/* 3 MSB bits define the register */
name|reg
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|crcMirror
operator|>>
literal|5
argument_list|)
expr_stmt|;
comment|/* 5 LSB bits define the bit within the register */
name|bitMask
operator|=
literal|0x80000000
operator|>>
operator|(
name|crcMirror
operator|&
literal|0x1f
operator|)
expr_stmt|;
comment|/* Create element to be added to the driver hash table */
name|p_HashEntry
operator|=
operator|(
name|t_EthHashEntry
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|t_EthHashEntry
argument_list|)
argument_list|)
expr_stmt|;
name|p_HashEntry
operator|->
name|addr
operator|=
name|ethAddr
expr_stmt|;
name|INIT_LIST
argument_list|(
operator|&
name|p_HashEntry
operator|->
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|ethAddr
operator|&
name|GROUP_ADDRESS
condition|)
block|{
comment|/* Group Address */
name|LIST_AddToTail
argument_list|(
operator|&
operator|(
name|p_HashEntry
operator|->
name|node
operator|)
argument_list|,
operator|&
operator|(
name|p_Dtsec
operator|->
name|p_MulticastAddrHash
operator|->
name|p_Lsts
index|[
name|crcMirror
index|]
operator|)
argument_list|)
expr_stmt|;
comment|/* Set the appropriate bit in GADDR0-7 */
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|gaddr
index|[
name|reg
index|]
argument_list|,
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|gaddr
index|[
name|reg
index|]
argument_list|)
operator||
name|bitMask
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|LIST_AddToTail
argument_list|(
operator|&
operator|(
name|p_HashEntry
operator|->
name|node
operator|)
argument_list|,
operator|&
operator|(
name|p_Dtsec
operator|->
name|p_UnicastAddrHash
operator|->
name|p_Lsts
index|[
name|crcMirror
index|]
operator|)
argument_list|)
expr_stmt|;
comment|/* Set the appropriate bit in IADDR0-7 */
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|igaddr
index|[
name|reg
index|]
argument_list|,
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|igaddr
index|[
name|reg
index|]
argument_list|)
operator||
name|bitMask
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecDelHashMacAddress
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|t_EnetAddr
modifier|*
name|p_EthAddr
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|t_DtsecMemMap
modifier|*
name|p_DtsecMemMap
decl_stmt|;
name|t_List
modifier|*
name|p_Pos
decl_stmt|;
name|uint32_t
name|crc
decl_stmt|;
name|uint8_t
name|crcMirror
decl_stmt|,
name|reg
decl_stmt|;
name|uint32_t
name|bitMask
decl_stmt|;
name|t_EthHashEntry
modifier|*
name|p_HashEntry
init|=
name|NULL
decl_stmt|;
name|uint64_t
name|ethAddr
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|p_DtsecMemMap
operator|=
name|p_Dtsec
operator|->
name|p_MemMap
expr_stmt|;
name|ethAddr
operator|=
operator|(
operator|(
operator|*
operator|(
name|uint64_t
operator|*
operator|)
name|p_EthAddr
operator|)
operator|>>
literal|16
operator|)
expr_stmt|;
comment|/* CRC calculation */
name|GET_MAC_ADDR_CRC
argument_list|(
name|ethAddr
argument_list|,
name|crc
argument_list|)
expr_stmt|;
comment|/* calculate the "crc mirror" */
name|crcMirror
operator|=
name|MIRROR
argument_list|(
operator|(
name|uint8_t
operator|)
name|crc
argument_list|)
expr_stmt|;
comment|/* 3 MSB bits define the register */
name|reg
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|crcMirror
operator|>>
literal|5
argument_list|)
expr_stmt|;
comment|/* 5 LSB bits define the bit within the register */
name|bitMask
operator|=
literal|0x80000000
operator|>>
operator|(
name|crcMirror
operator|&
literal|0x1f
operator|)
expr_stmt|;
if|if
condition|(
name|ethAddr
operator|&
name|GROUP_ADDRESS
condition|)
block|{
comment|/* Group Address */
name|LIST_FOR_EACH
argument_list|(
argument|p_Pos
argument_list|,
argument|&(p_Dtsec->p_MulticastAddrHash->p_Lsts[crcMirror])
argument_list|)
block|{
name|p_HashEntry
operator|=
name|ETH_HASH_ENTRY_OBJ
argument_list|(
name|p_Pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_HashEntry
operator|->
name|addr
operator|==
name|ethAddr
condition|)
block|{
name|LIST_DelAndInit
argument_list|(
operator|&
name|p_HashEntry
operator|->
name|node
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_HashEntry
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|LIST_IsEmpty
argument_list|(
operator|&
name|p_Dtsec
operator|->
name|p_MulticastAddrHash
operator|->
name|p_Lsts
index|[
name|crcMirror
index|]
argument_list|)
condition|)
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|gaddr
index|[
name|reg
index|]
argument_list|,
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|gaddr
index|[
name|reg
index|]
argument_list|)
operator|&
operator|~
name|bitMask
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Individual Address */
name|LIST_FOR_EACH
argument_list|(
argument|p_Pos
argument_list|,
argument|&(p_Dtsec->p_UnicastAddrHash->p_Lsts[crcMirror])
argument_list|)
block|{
name|p_HashEntry
operator|=
name|ETH_HASH_ENTRY_OBJ
argument_list|(
name|p_Pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_HashEntry
operator|->
name|addr
operator|==
name|ethAddr
condition|)
block|{
name|LIST_DelAndInit
argument_list|(
operator|&
name|p_HashEntry
operator|->
name|node
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_HashEntry
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|LIST_IsEmpty
argument_list|(
operator|&
name|p_Dtsec
operator|->
name|p_UnicastAddrHash
operator|->
name|p_Lsts
index|[
name|crcMirror
index|]
argument_list|)
condition|)
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|igaddr
index|[
name|reg
index|]
argument_list|,
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|igaddr
index|[
name|reg
index|]
argument_list|)
operator|&
operator|~
name|bitMask
argument_list|)
expr_stmt|;
block|}
comment|/* address does not exist */
name|ASSERT_COND
argument_list|(
name|p_HashEntry
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecSetPromiscuous
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|bool
name|newVal
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|t_DtsecMemMap
modifier|*
name|p_DtsecMemMap
decl_stmt|;
name|uint32_t
name|tmpReg32
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|p_DtsecMemMap
operator|=
name|p_Dtsec
operator|->
name|p_MemMap
expr_stmt|;
name|tmpReg32
operator|=
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|rctrl
argument_list|)
expr_stmt|;
if|if
condition|(
name|newVal
condition|)
name|tmpReg32
operator||=
name|RCTRL_PROM
expr_stmt|;
else|else
name|tmpReg32
operator|&=
operator|~
name|RCTRL_PROM
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|rctrl
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecSetStatistics
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|e_FmMacStatisticsLevel
name|statisticsLevel
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|t_DtsecMemMap
modifier|*
name|p_DtsecMemMap
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|p_DtsecMemMap
operator|=
name|p_Dtsec
operator|->
name|p_MemMap
expr_stmt|;
name|p_Dtsec
operator|->
name|statisticsLevel
operator|=
name|statisticsLevel
expr_stmt|;
switch|switch
condition|(
name|p_Dtsec
operator|->
name|statisticsLevel
condition|)
block|{
case|case
operator|(
name|e_FM_MAC_NONE_STATISTICS
operator|)
case|:
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|cam1
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|cam2
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|ecntrl
argument_list|,
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|ecntrl
argument_list|)
operator|&
operator|~
name|ECNTRL_STEN
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|imask
argument_list|,
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|imask
argument_list|)
operator|&
operator|~
name|IMASK_MSROEN
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|exceptions
operator|&=
operator|~
name|IMASK_MSROEN
expr_stmt|;
break|break;
case|case
operator|(
name|e_FM_MAC_PARTIAL_STATISTICS
operator|)
case|:
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|cam1
argument_list|,
name|CAM1_ERRORS_ONLY
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|cam2
argument_list|,
name|CAM2_ERRORS_ONLY
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|ecntrl
argument_list|,
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|ecntrl
argument_list|)
operator||
name|ECNTRL_STEN
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|imask
argument_list|,
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|imask
argument_list|)
operator||
name|IMASK_MSROEN
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|exceptions
operator||=
name|IMASK_MSROEN
expr_stmt|;
break|break;
case|case
operator|(
name|e_FM_MAC_FULL_STATISTICS
operator|)
case|:
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|cam1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|cam2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|ecntrl
argument_list|,
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|ecntrl
argument_list|)
operator||
name|ECNTRL_STEN
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|imask
argument_list|,
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|imask
argument_list|)
operator||
name|IMASK_MSROEN
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|exceptions
operator||=
name|IMASK_MSROEN
expr_stmt|;
break|break;
default|default:
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecAdjustLink
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|e_EnetSpeed
name|speed
parameter_list|,
name|bool
name|fullDuplex
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|t_DtsecMemMap
modifier|*
name|p_DtsecMemMap
decl_stmt|;
name|uint32_t
name|tmpReg32
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_DtsecMemMap
operator|=
name|p_Dtsec
operator|->
name|p_MemMap
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_DtsecMemMap
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|fullDuplex
operator|)
operator|&&
operator|(
name|speed
operator|>=
name|e_ENET_SPEED_1000
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_CONFLICT
argument_list|,
operator|(
literal|"Ethernet interface does not support Half Duplex mode"
operator|)
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|enetMode
operator|=
name|MAKE_ENET_MODE
argument_list|(
name|ENET_INTERFACE_FROM_MODE
argument_list|(
name|p_Dtsec
operator|->
name|enetMode
argument_list|)
argument_list|,
name|speed
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|halfDuplex
operator|=
operator|!
name|fullDuplex
expr_stmt|;
name|tmpReg32
operator|=
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|maccfg2
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Dtsec
operator|->
name|halfDuplex
condition|)
name|tmpReg32
operator|&=
operator|~
name|MACCFG2_FULL_DUPLEX
expr_stmt|;
else|else
name|tmpReg32
operator||=
name|MACCFG2_FULL_DUPLEX
expr_stmt|;
name|tmpReg32
operator|&=
operator|~
operator|(
name|MACCFG2_NIBBLE_MODE
operator||
name|MACCFG2_BYTE_MODE
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_RGMII_10
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_RGMII_100
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_SGMII_10
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_SGMII_100
operator|)
condition|)
name|tmpReg32
operator||=
name|MACCFG2_NIBBLE_MODE
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_RGMII_1000
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_SGMII_1000
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_GMII_1000
operator|)
condition|)
name|tmpReg32
operator||=
name|MACCFG2_BYTE_MODE
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|maccfg2
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
name|tmpReg32
operator|=
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|ecntrl
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tmpReg32
operator|&
name|ECNTRL_CFG_RO
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_RGMII_100
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_SGMII_100
operator|)
condition|)
name|tmpReg32
operator||=
name|ECNTRL_R100M
expr_stmt|;
else|else
name|tmpReg32
operator|&=
operator|~
name|ECNTRL_R100M
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|ecntrl
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecGetId
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|uint32_t
modifier|*
name|macId
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
operator|*
name|macId
operator|=
name|p_Dtsec
operator|->
name|macId
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecGetVersion
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|uint32_t
modifier|*
name|macVersion
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|t_DtsecMemMap
modifier|*
name|p_DtsecMemMap
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|p_DtsecMemMap
operator|=
name|p_Dtsec
operator|->
name|p_MemMap
expr_stmt|;
operator|*
name|macVersion
operator|=
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tsec_id1
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecSetException
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|,
name|e_FmMacExceptions
name|exception
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|uint32_t
name|tmpReg
decl_stmt|,
name|bitMask
init|=
literal|0
decl_stmt|;
name|t_DtsecMemMap
modifier|*
name|p_DtsecMemMap
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|p_DtsecMemMap
operator|=
name|p_Dtsec
operator|->
name|p_MemMap
expr_stmt|;
if|if
condition|(
name|exception
operator|!=
name|e_FM_MAC_EX_1G_1588_TS_RX_ERR
condition|)
block|{
name|GET_EXCEPTION_FLAG
argument_list|(
name|bitMask
argument_list|,
name|exception
argument_list|)
expr_stmt|;
if|if
condition|(
name|bitMask
condition|)
block|{
if|if
condition|(
name|enable
condition|)
name|p_Dtsec
operator|->
name|exceptions
operator||=
name|bitMask
expr_stmt|;
else|else
name|p_Dtsec
operator|->
name|exceptions
operator|&=
operator|~
name|bitMask
expr_stmt|;
block|}
else|else
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Undefined exception"
operator|)
argument_list|)
expr_stmt|;
name|tmpReg
operator|=
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|imask
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
condition|)
name|tmpReg
operator||=
name|bitMask
expr_stmt|;
else|else
name|tmpReg
operator|&=
operator|~
name|bitMask
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|imask
argument_list|,
name|tmpReg
argument_list|)
expr_stmt|;
comment|/* warn if MIB OVFL is disabled and statistic gathering is enabled */
if|if
condition|(
operator|(
name|exception
operator|==
name|e_FM_MAC_EX_1G_RX_MIB_CNT_OVFL
operator|)
operator|&&
operator|!
name|enable
operator|&&
operator|(
name|p_Dtsec
operator|->
name|statisticsLevel
operator|!=
name|e_FM_MAC_NONE_STATISTICS
operator|)
condition|)
name|DBG
argument_list|(
name|WARNING
argument_list|,
operator|(
literal|"Disabled MIB counters overflow exceptions. Counters value may be inaccurate due to unregistered overflow"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|p_Dtsec
operator|->
name|ptpTsuEnabled
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Exception valid for 1588 only"
operator|)
argument_list|)
expr_stmt|;
name|tmpReg
operator|=
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tmr_pemask
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|exception
condition|)
block|{
case|case
operator|(
name|e_FM_MAC_EX_1G_1588_TS_RX_ERR
operator|)
case|:
if|if
condition|(
name|enable
condition|)
block|{
name|p_Dtsec
operator|->
name|enTsuErrExeption
operator|=
name|TRUE
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tmr_pemask
argument_list|,
name|tmpReg
operator||
name|PEMASK_TSRE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|p_Dtsec
operator|->
name|enTsuErrExeption
operator|=
name|FALSE
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tmr_pemask
argument_list|,
name|tmpReg
operator|&
operator|~
name|PEMASK_TSRE
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Undefined exception"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ........................................................................... */
end_comment

begin_if
if|#
directive|if
operator|(
name|defined
argument_list|(
name|DEBUG_ERRORS
argument_list|)
operator|&&
operator|(
name|DEBUG_ERRORS
operator|>
literal|0
operator|)
operator|)
end_if

begin_function
specifier|static
name|t_Error
name|DtsecDumpRegs
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|DECLARE_DUMP
expr_stmt|;
if|if
condition|(
name|p_Dtsec
operator|->
name|p_MemMap
condition|)
block|{
name|DUMP_TITLE
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
operator|(
literal|"MAC %d: "
operator|,
name|p_Dtsec
operator|->
name|macId
operator|)
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|tsec_id1
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|tsec_id2
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|ievent
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|imask
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|edis
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|ecntrl
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|ptv
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|tmr_ctrl
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|tmr_pevent
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|tmr_pemask
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|tctrl
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|rctrl
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|maccfg1
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|maccfg2
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|ipgifg
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|hafdup
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|maxfrm
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|macstnaddr1
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|macstnaddr2
argument_list|)
expr_stmt|;
name|DUMP_SUBSTRUCT_ARRAY
argument_list|(
argument|i
argument_list|,
literal|8
argument_list|)
block|{
name|DUMP_VAR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|macaddr
index|[
name|i
index|]
operator|.
name|exact_match1
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|macaddr
index|[
name|i
index|]
operator|.
name|exact_match2
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* (defined(DEBUG_ERRORS)&& ... */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*                      FM Init& Free API                                   */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecInit
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|t_DtsecDriverParam
modifier|*
name|p_DtsecDriverParam
decl_stmt|;
name|t_DtsecMemMap
modifier|*
name|p_DtsecMemMap
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint32_t
name|tmpReg32
decl_stmt|;
name|uint64_t
name|addr
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
operator|->
name|p_MemMap
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|CHECK_INIT_PARAMETERS
argument_list|(
name|p_Dtsec
argument_list|,
name|CheckInitParameters
argument_list|)
expr_stmt|;
name|p_DtsecDriverParam
operator|=
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
expr_stmt|;
name|p_Dtsec
operator|->
name|halfDuplex
operator|=
name|p_DtsecDriverParam
operator|->
name|halfDuplex
expr_stmt|;
name|p_Dtsec
operator|->
name|debugMode
operator|=
name|p_DtsecDriverParam
operator|->
name|debugMode
expr_stmt|;
name|p_DtsecMemMap
operator|=
name|p_Dtsec
operator|->
name|p_MemMap
expr_stmt|;
comment|/*************dtsec_id2******************/
name|tmpReg32
operator|=
name|GET_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tsec_id2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_RGMII_10
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_RGMII_100
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_RGMII_1000
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_RMII_10
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_RMII_100
operator|)
condition|)
if|if
condition|(
name|tmpReg32
operator|&
name|ID2_INT_REDUCED_OFF
condition|)
block|{
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"no support for reduced interface in current DTSEC version"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_SGMII_10
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_SGMII_100
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_SGMII_1000
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_MII_10
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_MII_100
operator|)
condition|)
if|if
condition|(
name|tmpReg32
operator|&
name|ID2_INT_NORMAL_OFF
condition|)
block|{
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"no support for normal interface in current DTSEC version"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/*************dtsec_id2******************/
comment|/***************EDIS************************/
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|edis
argument_list|,
name|p_DtsecDriverParam
operator|->
name|errorDisabled
argument_list|)
expr_stmt|;
comment|/***************EDIS************************/
comment|/***************ECNTRL************************/
name|tmpReg32
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_RGMII_10
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_RGMII_100
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_RGMII_1000
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_GMII_1000
operator|)
condition|)
name|tmpReg32
operator||=
name|ECNTRL_GMIIM
expr_stmt|;
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_SGMII_10
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_SGMII_100
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_SGMII_1000
operator|)
condition|)
name|tmpReg32
operator||=
operator|(
name|ECNTRL_SGMIIM
operator||
name|ECNTRL_TBIM
operator|)
expr_stmt|;
if|if
condition|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_QSGMII_1000
condition|)
name|tmpReg32
operator||=
operator|(
name|ECNTRL_SGMIIM
operator||
name|ECNTRL_TBIM
operator||
name|ECNTRL_QSGMIIM
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_RGMII_1000
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_RGMII_10
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_RGMII_100
operator|)
condition|)
name|tmpReg32
operator||=
name|ECNTRL_RPM
expr_stmt|;
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_RGMII_100
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_SGMII_100
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_RMII_100
operator|)
condition|)
name|tmpReg32
operator||=
name|ECNTRL_R100M
expr_stmt|;
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_RMII_10
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_RMII_100
operator|)
condition|)
name|tmpReg32
operator||=
name|ECNTRL_RMM
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|ecntrl
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
comment|/***************ECNTRL************************/
comment|/***************PTV************************/
name|tmpReg32
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_SHORT_PAUSE_TIME_ERRATA_DTSEC1
block|{
name|t_FmRevisionInfo
name|revInfo
decl_stmt|;
name|FM_GetRevision
argument_list|(
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
operator|&
name|revInfo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|revInfo
operator|.
name|majorRev
operator|==
literal|1
operator|)
operator|&&
operator|(
name|revInfo
operator|.
name|minorRev
operator|==
literal|0
operator|)
condition|)
name|p_DtsecDriverParam
operator|->
name|pauseTime
operator|+=
literal|2
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* FM_SHORT_PAUSE_TIME_ERRATA_DTSEC1 */
if|if
condition|(
name|p_DtsecDriverParam
operator|->
name|pauseTime
condition|)
name|tmpReg32
operator||=
operator|(
name|uint32_t
operator|)
name|p_DtsecDriverParam
operator|->
name|pauseTime
expr_stmt|;
if|if
condition|(
name|p_DtsecDriverParam
operator|->
name|pauseExtended
condition|)
name|tmpReg32
operator||=
operator|(
operator|(
name|uint32_t
operator|)
name|p_DtsecDriverParam
operator|->
name|pauseExtended
operator|)
operator|<<
name|PTV_PTE_OFST
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|ptv
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
comment|/***************PTV************************/
comment|/***************TCTRL************************/
name|tmpReg32
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|p_DtsecDriverParam
operator|->
name|halfDuplex
condition|)
block|{
if|if
condition|(
name|p_DtsecDriverParam
operator|->
name|halfDulexFlowControlEn
condition|)
name|tmpReg32
operator||=
name|TCTRL_THDF
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|p_DtsecDriverParam
operator|->
name|txTimeStampEn
condition|)
name|tmpReg32
operator||=
name|TCTRL_TTSE
expr_stmt|;
block|}
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tctrl
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
comment|/***************TCTRL************************/
comment|/***************RCTRL************************/
name|tmpReg32
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|p_DtsecDriverParam
operator|->
name|packetAlignmentPadding
condition|)
name|tmpReg32
operator||=
operator|(
call|(
name|uint32_t
call|)
argument_list|(
literal|0x0000001f
operator|&
name|p_DtsecDriverParam
operator|->
name|packetAlignmentPadding
argument_list|)
operator|)
operator|<<
literal|16
expr_stmt|;
if|if
condition|(
name|p_DtsecDriverParam
operator|->
name|controlFrameAccept
condition|)
name|tmpReg32
operator||=
name|RCTRL_CFA
expr_stmt|;
if|if
condition|(
name|p_DtsecDriverParam
operator|->
name|groupHashExtend
condition|)
name|tmpReg32
operator||=
name|RCTRL_GHTX
expr_stmt|;
if|if
condition|(
name|p_DtsecDriverParam
operator|->
name|rxTimeStampEn
condition|)
name|tmpReg32
operator||=
name|RCTRL_RTSE
expr_stmt|;
if|if
condition|(
name|p_DtsecDriverParam
operator|->
name|broadcReject
condition|)
name|tmpReg32
operator||=
name|RCTRL_BC_REJ
expr_stmt|;
if|if
condition|(
name|p_DtsecDriverParam
operator|->
name|rxShortFrame
condition|)
name|tmpReg32
operator||=
name|RCTRL_RSF
expr_stmt|;
if|if
condition|(
name|p_DtsecDriverParam
operator|->
name|promiscuousEnable
condition|)
name|tmpReg32
operator||=
name|RCTRL_PROM
expr_stmt|;
if|if
condition|(
name|p_DtsecDriverParam
operator|->
name|exactMatch
condition|)
name|tmpReg32
operator||=
name|RCTRL_EMEN
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|rctrl
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
comment|/***************RCTRL************************/
comment|/* Assign a Phy Address to the TBI (TBIPA).            */
comment|/* Done also in case that TBI is not selected to avoid */
comment|/* conflict with the external PHYs Physical address   */
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tbipa
argument_list|,
name|p_DtsecDriverParam
operator|->
name|tbiPhyAddr
argument_list|)
expr_stmt|;
comment|/* Reset the management interface */
name|WRITE_UINT32
argument_list|(
name|p_Dtsec
operator|->
name|p_MiiMemMap
operator|->
name|miimcfg
argument_list|,
name|MIIMCFG_RESET_MGMT
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Dtsec
operator|->
name|p_MiiMemMap
operator|->
name|miimcfg
argument_list|,
operator|~
name|MIIMCFG_RESET_MGMT
argument_list|)
expr_stmt|;
comment|/* Setup the MII Mgmt clock speed */
name|WRITE_UINT32
argument_list|(
name|p_Dtsec
operator|->
name|p_MiiMemMap
operator|->
name|miimcfg
argument_list|,
operator|(
name|uint32_t
operator|)
name|GetMiiDiv
argument_list|(
call|(
name|int32_t
call|)
argument_list|(
operator|(
operator|(
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|clkFreq
operator|*
literal|10
operator|)
operator|/
literal|2
operator|)
operator|/
literal|8
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_SGMII_1000
condition|)
block|{
name|uint16_t
name|tmpReg16
decl_stmt|;
comment|/* Configure the TBI PHY Control Register */
name|tmpReg16
operator|=
name|PHY_TBICON_SPEED2
operator||
name|PHY_TBICON_SRESET
expr_stmt|;
name|DTSEC_MII_WritePhyReg
argument_list|(
name|p_Dtsec
argument_list|,
name|p_DtsecDriverParam
operator|->
name|tbiPhyAddr
argument_list|,
literal|17
argument_list|,
name|tmpReg16
argument_list|)
expr_stmt|;
name|tmpReg16
operator|=
name|PHY_TBICON_SPEED2
expr_stmt|;
name|DTSEC_MII_WritePhyReg
argument_list|(
name|p_Dtsec
argument_list|,
name|p_DtsecDriverParam
operator|->
name|tbiPhyAddr
argument_list|,
literal|17
argument_list|,
name|tmpReg16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_DtsecDriverParam
operator|->
name|halfDuplex
condition|)
name|tmpReg16
operator||=
name|PHY_CR_FULLDUPLEX
operator||
literal|0x8000
operator||
name|PHY_CR_ANE
expr_stmt|;
name|DTSEC_MII_WritePhyReg
argument_list|(
name|p_Dtsec
argument_list|,
name|p_DtsecDriverParam
operator|->
name|tbiPhyAddr
argument_list|,
literal|0
argument_list|,
name|tmpReg16
argument_list|)
expr_stmt|;
name|tmpReg16
operator|=
literal|0x01a0
expr_stmt|;
name|DTSEC_MII_WritePhyReg
argument_list|(
name|p_Dtsec
argument_list|,
name|p_DtsecDriverParam
operator|->
name|tbiPhyAddr
argument_list|,
literal|4
argument_list|,
name|tmpReg16
argument_list|)
expr_stmt|;
name|tmpReg16
operator|=
literal|0x1340
expr_stmt|;
name|DTSEC_MII_WritePhyReg
argument_list|(
name|p_Dtsec
argument_list|,
name|p_DtsecDriverParam
operator|->
name|tbiPhyAddr
argument_list|,
literal|0
argument_list|,
name|tmpReg16
argument_list|)
expr_stmt|;
block|}
comment|/***************TMR_CTL************************/
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tmr_ctrl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Dtsec
operator|->
name|ptpTsuEnabled
condition|)
block|{
name|tmpReg32
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|p_Dtsec
operator|->
name|enTsuErrExeption
condition|)
name|tmpReg32
operator||=
name|PEMASK_TSRE
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tmr_pemask
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tmr_pevent
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
block|}
comment|/***************DEBUG************************/
name|tmpReg32
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|p_DtsecDriverParam
operator|->
name|debugMode
condition|)
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tsec_id1
argument_list|,
name|TSEC_ID1_DEBUG
argument_list|)
expr_stmt|;
comment|/***************DEBUG************************/
comment|/***************MACCFG1***********************/
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|maccfg1
argument_list|,
name|MACCFG1_SOFT_RESET
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|maccfg1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tmpReg32
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|p_DtsecDriverParam
operator|->
name|loopback
condition|)
name|tmpReg32
operator||=
name|MACCFG1_LOOPBACK
expr_stmt|;
if|if
condition|(
name|p_DtsecDriverParam
operator|->
name|actOnRxPauseFrame
condition|)
name|tmpReg32
operator||=
name|MACCFG1_RX_FLOW
expr_stmt|;
if|if
condition|(
name|p_DtsecDriverParam
operator|->
name|actOnTxPauseFrame
condition|)
name|tmpReg32
operator||=
name|MACCFG1_TX_FLOW
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|maccfg1
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
comment|/***************MACCFG1***********************/
comment|/***************MACCFG2***********************/
name|tmpReg32
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_RMII_10
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_RMII_100
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_MII_10
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_MII_100
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_RGMII_10
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_RGMII_100
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_SGMII_10
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_SGMII_100
operator|)
condition|)
name|tmpReg32
operator||=
name|MACCFG2_NIBBLE_MODE
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_RGMII_1000
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_SGMII_1000
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_GMII_1000
operator|)
operator|||
operator|(
name|p_Dtsec
operator|->
name|enetMode
operator|==
name|e_ENET_MODE_QSGMII_1000
operator|)
condition|)
name|tmpReg32
operator||=
name|MACCFG2_BYTE_MODE
expr_stmt|;
name|tmpReg32
operator||=
operator|(
operator|(
operator|(
name|uint32_t
operator|)
name|p_DtsecDriverParam
operator|->
name|preambleLength
operator|)
operator|&
literal|0x0000000f
operator|)
operator|<<
name|PREAMBLE_LENGTH_SHIFT
expr_stmt|;
if|if
condition|(
name|p_DtsecDriverParam
operator|->
name|preambleRxEn
condition|)
name|tmpReg32
operator||=
name|MACCFG2_PRE_AM_Rx_EN
expr_stmt|;
if|if
condition|(
name|p_DtsecDriverParam
operator|->
name|preambleTxEn
condition|)
name|tmpReg32
operator||=
name|MACCFG2_PRE_AM_Tx_EN
expr_stmt|;
if|if
condition|(
name|p_DtsecDriverParam
operator|->
name|lengthCheckEnable
condition|)
name|tmpReg32
operator||=
name|MACCFG2_LENGTH_CHECK
expr_stmt|;
if|if
condition|(
name|p_DtsecDriverParam
operator|->
name|padAndCrcEnable
condition|)
name|tmpReg32
operator||=
name|MACCFG2_PAD_CRC_EN
expr_stmt|;
if|if
condition|(
name|p_DtsecDriverParam
operator|->
name|crcEnable
condition|)
name|tmpReg32
operator||=
name|MACCFG2_CRC_EN
expr_stmt|;
if|if
condition|(
operator|!
name|p_DtsecDriverParam
operator|->
name|halfDuplex
condition|)
name|tmpReg32
operator||=
name|MACCFG2_FULL_DUPLEX
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|maccfg2
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
comment|/***************MACCFG2***********************/
comment|/***************IPGIFG************************/
name|tmpReg32
operator|=
literal|0
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|p_DtsecDriverParam
operator|->
name|nonBackToBackIpg1
operator|<=
name|p_DtsecDriverParam
operator|->
name|nonBackToBackIpg2
argument_list|)
expr_stmt|;
name|tmpReg32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
operator|(
operator|(
operator|(
name|uint32_t
operator|)
name|p_DtsecDriverParam
operator|->
name|nonBackToBackIpg1
operator|<<
name|IPGIFG_NON_BACK_TO_BACK_IPG_1_SHIFT
operator|)
operator|&
name|IPGIFG_NON_BACK_TO_BACK_IPG_1
operator|)
operator||
operator|(
operator|(
operator|(
name|uint32_t
operator|)
name|p_DtsecDriverParam
operator|->
name|nonBackToBackIpg2
operator|<<
name|IPGIFG_NON_BACK_TO_BACK_IPG_2_SHIFT
operator|)
operator|&
name|IPGIFG_NON_BACK_TO_BACK_IPG_2
operator|)
operator||
operator|(
operator|(
operator|(
name|uint32_t
operator|)
name|p_DtsecDriverParam
operator|->
name|minIfgEnforcement
operator|<<
name|IPGIFG_MIN_IFG_ENFORCEMENT_SHIFT
operator|)
operator|&
name|IPGIFG_MIN_IFG_ENFORCEMENT
operator|)
operator||
operator|(
operator|(
name|uint32_t
operator|)
name|p_DtsecDriverParam
operator|->
name|backToBackIpg
operator|&
name|IPGIFG_BACK_TO_BACK_IPG
operator|)
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|ipgifg
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
comment|/***************IPGIFG************************/
comment|/***************HAFDUP************************/
name|tmpReg32
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|p_DtsecDriverParam
operator|->
name|alternateBackoffEnable
condition|)
block|{
name|tmpReg32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|HAFDUP_ALT_BEB
operator||
operator|(
operator|(
operator|(
name|uint32_t
operator|)
name|p_DtsecDriverParam
operator|->
name|alternateBackoffVal
operator|&
literal|0x0000000f
operator|)
operator|<<
name|HAFDUP_ALTERNATE_BEB_TRUNCATION_SHIFT
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p_DtsecDriverParam
operator|->
name|backPressureNoBackoff
condition|)
name|tmpReg32
operator||=
name|HAFDUP_BP_NO_BACKOFF
expr_stmt|;
if|if
condition|(
name|p_DtsecDriverParam
operator|->
name|noBackoff
condition|)
name|tmpReg32
operator||=
name|HAFDUP_NO_BACKOFF
expr_stmt|;
if|if
condition|(
name|p_DtsecDriverParam
operator|->
name|excessDefer
condition|)
name|tmpReg32
operator||=
name|HAFDUP_EXCESS_DEFER
expr_stmt|;
name|tmpReg32
operator||=
operator|(
operator|(
operator|(
name|uint32_t
operator|)
name|p_DtsecDriverParam
operator|->
name|maxRetransmission
operator|<<
name|HAFDUP_RETRANSMISSION_MAX_SHIFT
operator|)
operator|&
name|HAFDUP_RETRANSMISSION_MAX
operator|)
expr_stmt|;
name|tmpReg32
operator||=
operator|(
operator|(
name|uint32_t
operator|)
name|p_DtsecDriverParam
operator|->
name|collisionWindow
operator|&
name|HAFDUP_COLLISION_WINDOW
operator|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|hafdup
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
comment|/***************HAFDUP************************/
comment|/***************MAXFRM************************/
comment|/* Initialize MAXFRM */
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|maxfrm
argument_list|,
name|p_DtsecDriverParam
operator|->
name|maxFrameLength
argument_list|)
expr_stmt|;
name|err
operator|=
name|FmSetMacMaxFrame
argument_list|(
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
name|e_FM_MAC_1G
argument_list|,
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|macId
argument_list|,
name|p_DtsecDriverParam
operator|->
name|maxFrameLength
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
comment|/***************MAXFRM************************/
comment|/***************CAM1************************/
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|cam1
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|cam2
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
comment|/***************IMASK************************/
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|imask
argument_list|,
name|p_Dtsec
operator|->
name|exceptions
argument_list|)
expr_stmt|;
comment|/***************IMASK************************/
comment|/***************IEVENT************************/
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|ievent
argument_list|,
name|EVENTS_MASK
argument_list|)
expr_stmt|;
comment|/***************MACSTNADDR1/2*****************/
comment|/*  Initialize MAC Station Address registers (1& 2)    */
comment|/*  Station address have to be swapped (big endian to little endian */
name|addr
operator|=
name|p_Dtsec
operator|->
name|addr
expr_stmt|;
name|tmpReg32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|addr
argument_list|)
expr_stmt|;
name|SwapUint32P
argument_list|(
operator|&
name|tmpReg32
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|macstnaddr1
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
name|tmpReg32
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|addr
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|SwapUint32P
argument_list|(
operator|&
name|tmpReg32
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|macstnaddr2
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
comment|/***************MACSTNADDR1/2*****************/
comment|/***************DEBUG*****************/
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tx_threshold
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|p_DtsecDriverParam
operator|->
name|fifoTxThr
operator|&
literal|0x7f
argument_list|)
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|tx_watermark_high
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|p_DtsecDriverParam
operator|->
name|fifoTxWatermarkH
operator|&
literal|0x7f
argument_list|)
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|rx_watermark_low
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|p_DtsecDriverParam
operator|->
name|fifoRxWatermarkL
operator|&
literal|0x7f
argument_list|)
argument_list|)
expr_stmt|;
comment|/***************DEBUG*****************/
comment|/*****************HASH************************/
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_OF_HASH_REGS
condition|;
name|i
operator|++
control|)
block|{
comment|/* Initialize IADDRx */
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|igaddr
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Initialize GADDRx */
name|WRITE_UINT32
argument_list|(
name|p_DtsecMemMap
operator|->
name|gaddr
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|p_Dtsec
operator|->
name|p_MulticastAddrHash
operator|=
name|AllocHashTable
argument_list|(
name|HASH_TABLE_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Dtsec
operator|->
name|p_MulticastAddrHash
condition|)
block|{
name|FreeInitResources
argument_list|(
name|p_Dtsec
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"MC hash table is FAILED"
operator|)
argument_list|)
expr_stmt|;
block|}
name|p_Dtsec
operator|->
name|p_UnicastAddrHash
operator|=
name|AllocHashTable
argument_list|(
name|HASH_TABLE_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Dtsec
operator|->
name|p_UnicastAddrHash
condition|)
block|{
name|FreeInitResources
argument_list|(
name|p_Dtsec
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"UC hash table is FAILED"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* register err intr handler for dtsec to FPM (err)*/
name|FmRegisterIntr
argument_list|(
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
name|e_FM_MOD_1G_MAC
argument_list|,
name|p_Dtsec
operator|->
name|macId
argument_list|,
name|e_FM_INTR_TYPE_ERR
argument_list|,
name|DtsecErrException
argument_list|,
name|p_Dtsec
argument_list|)
expr_stmt|;
comment|/* register 1588 intr handler for TMR to FPM (normal)*/
name|FmRegisterIntr
argument_list|(
name|p_Dtsec
operator|->
name|fmMacControllerDriver
operator|.
name|h_Fm
argument_list|,
name|e_FM_MOD_1G_MAC_TMR
argument_list|,
name|p_Dtsec
operator|->
name|macId
argument_list|,
name|e_FM_INTR_TYPE_NORMAL
argument_list|,
name|Dtsec1588Exception
argument_list|,
name|p_Dtsec
argument_list|)
expr_stmt|;
comment|/* register normal intr handler for dtsec to main interrupt controller. */
if|if
condition|(
name|p_Dtsec
operator|->
name|mdioIrq
operator|!=
name|NO_IRQ
condition|)
block|{
name|XX_SetIntr
argument_list|(
name|p_Dtsec
operator|->
name|mdioIrq
argument_list|,
name|DtsecException
argument_list|,
name|p_Dtsec
argument_list|)
expr_stmt|;
name|XX_EnableIntr
argument_list|(
name|p_Dtsec
operator|->
name|mdioIrq
argument_list|)
expr_stmt|;
block|}
name|XX_Free
argument_list|(
name|p_DtsecDriverParam
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|=
name|NULL
expr_stmt|;
name|err
operator|=
name|DtsecSetStatistics
argument_list|(
name|p_Dtsec
argument_list|,
name|e_FM_MAC_FULL_STATISTICS
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|FreeInitResources
argument_list|(
name|p_Dtsec
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ........................................................................... */
end_comment

begin_function
specifier|static
name|t_Error
name|DtsecFree
parameter_list|(
name|t_Handle
name|h_Dtsec
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
init|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|h_Dtsec
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Dtsec
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|FreeInitResources
argument_list|(
name|p_Dtsec
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
condition|)
block|{
name|XX_Free
argument_list|(
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|=
name|NULL
expr_stmt|;
block|}
name|XX_Free
argument_list|(
name|h_Dtsec
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
specifier|static
name|void
name|InitFmMacControllerDriver
parameter_list|(
name|t_FmMacControllerDriver
modifier|*
name|p_FmMacControllerDriver
parameter_list|)
block|{
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_Init
operator|=
name|DtsecInit
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_Free
operator|=
name|DtsecFree
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_SetStatistics
operator|=
name|DtsecSetStatistics
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigLoopback
operator|=
name|DtsecConfigLoopback
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigMaxFrameLength
operator|=
name|DtsecConfigMaxFrameLength
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigWan
operator|=
name|NULL
expr_stmt|;
comment|/* Not supported on dTSEC */
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigPadAndCrc
operator|=
name|DtsecConfigPadAndCrc
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigHalfDuplex
operator|=
name|DtsecConfigHalfDuplex
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigLengthCheck
operator|=
name|DtsecConfigLengthCheck
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ConfigException
operator|=
name|DtsecConfigException
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_Enable
operator|=
name|DtsecEnable
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_Disable
operator|=
name|DtsecDisable
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_SetException
operator|=
name|DtsecSetException
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_SetPromiscuous
operator|=
name|DtsecSetPromiscuous
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_AdjustLink
operator|=
name|DtsecAdjustLink
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_Enable1588TimeStamp
operator|=
name|DtsecEnable1588TimeStamp
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_Disable1588TimeStamp
operator|=
name|DtsecDisable1588TimeStamp
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_SetTxAutoPauseFrames
operator|=
name|DtsecTxMacPause
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_SetRxIgnorePauseFrames
operator|=
name|DtsecRxIgnoreMacPause
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ResetCounters
operator|=
name|DtsecResetCounters
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_GetStatistics
operator|=
name|DtsecGetStatistics
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_ModifyMacAddr
operator|=
name|DtsecModifyMacAddress
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_AddHashMacAddr
operator|=
name|DtsecAddHashMacAddress
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_RemoveHashMacAddr
operator|=
name|DtsecDelHashMacAddress
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_AddExactMatchMacAddr
operator|=
name|DtsecAddExactMatchMacAddress
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_RemovelExactMatchMacAddr
operator|=
name|DtsecDelExactMatchMacAddress
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_GetId
operator|=
name|DtsecGetId
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_GetVersion
operator|=
name|DtsecGetVersion
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_GetMaxFrameLength
operator|=
name|DtsecGetMaxFrameLength
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_MII_WritePhyReg
operator|=
name|DTSEC_MII_WritePhyReg
expr_stmt|;
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_MII_ReadPhyReg
operator|=
name|DTSEC_MII_ReadPhyReg
expr_stmt|;
if|#
directive|if
operator|(
name|defined
argument_list|(
name|DEBUG_ERRORS
argument_list|)
operator|&&
operator|(
name|DEBUG_ERRORS
operator|>
literal|0
operator|)
operator|)
name|p_FmMacControllerDriver
operator|->
name|f_FM_MAC_DumpRegs
operator|=
name|DtsecDumpRegs
expr_stmt|;
endif|#
directive|endif
comment|/* (defined(DEBUG_ERRORS)&& ... */
block|}
end_function

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*                      dTSEC Config  Main Entry                             */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/* .............................................................................. */
end_comment

begin_function
name|t_Handle
name|DTSEC_Config
parameter_list|(
name|t_FmMacParams
modifier|*
name|p_FmMacParam
parameter_list|)
block|{
name|t_Dtsec
modifier|*
name|p_Dtsec
decl_stmt|;
name|t_DtsecDriverParam
modifier|*
name|p_DtsecDriverParam
decl_stmt|;
name|uintptr_t
name|baseAddr
decl_stmt|;
name|uint8_t
name|i
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_FmMacParam
argument_list|,
name|E_NULL_POINTER
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|baseAddr
operator|=
name|p_FmMacParam
operator|->
name|baseAddr
expr_stmt|;
comment|/* allocate memory for the UCC GETH data structure. */
name|p_Dtsec
operator|=
operator|(
name|t_Dtsec
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|t_Dtsec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Dtsec
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"dTSEC driver structure"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* Zero out * p_Dtsec */
name|memset
argument_list|(
name|p_Dtsec
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_Dtsec
argument_list|)
argument_list|)
expr_stmt|;
name|InitFmMacControllerDriver
argument_list|(
operator|&
name|p_Dtsec
operator|->
name|fmMacControllerDriver
argument_list|)
expr_stmt|;
comment|/* allocate memory for the dTSEC driver parameters data structure. */
name|p_DtsecDriverParam
operator|=
operator|(
name|t_DtsecDriverParam
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|t_DtsecDriverParam
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_DtsecDriverParam
condition|)
block|{
name|XX_Free
argument_list|(
name|p_Dtsec
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"dTSEC driver parameters"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* Zero out */
name|memset
argument_list|(
name|p_DtsecDriverParam
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_DtsecDriverParam
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Plant parameter structure pointer */
name|p_Dtsec
operator|->
name|p_DtsecDriverParam
operator|=
name|p_DtsecDriverParam
expr_stmt|;
name|SetDefaultParam
argument_list|(
name|p_DtsecDriverParam
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|p_FmMacParam
operator|->
name|addr
argument_list|)
condition|;
name|i
operator|++
control|)
name|p_Dtsec
operator|->
name|addr
operator||=
operator|(
operator|(
name|uint64_t
operator|)
name|p_FmMacParam
operator|->
name|addr
index|[
name|i
index|]
operator|<<
operator|(
operator|(
literal|5
operator|-
name|i
operator|)
operator|*
literal|8
operator|)
operator|)
expr_stmt|;
name|p_Dtsec
operator|->
name|p_MemMap
operator|=
operator|(
name|t_DtsecMemMap
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|baseAddr
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|p_MiiMemMap
operator|=
operator|(
name|t_MiiAccessMemMap
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|baseAddr
operator|+
name|DTSEC_TO_MII_OFFSET
argument_list|)
expr_stmt|;
name|p_Dtsec
operator|->
name|enetMode
operator|=
name|p_FmMacParam
operator|->
name|enetMode
expr_stmt|;
name|p_Dtsec
operator|->
name|macId
operator|=
name|p_FmMacParam
operator|->
name|macId
expr_stmt|;
name|p_Dtsec
operator|->
name|exceptions
operator|=
name|DEFAULT_exceptions
expr_stmt|;
name|p_Dtsec
operator|->
name|mdioIrq
operator|=
name|p_FmMacParam
operator|->
name|mdioIrq
expr_stmt|;
name|p_Dtsec
operator|->
name|f_Exception
operator|=
name|p_FmMacParam
operator|->
name|f_Exception
expr_stmt|;
name|p_Dtsec
operator|->
name|f_Event
operator|=
name|p_FmMacParam
operator|->
name|f_Event
expr_stmt|;
name|p_Dtsec
operator|->
name|h_App
operator|=
name|p_FmMacParam
operator|->
name|h_App
expr_stmt|;
return|return
name|p_Dtsec
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (c) 2008-2011 Freescale Semiconductor, Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are met:  *     * Redistributions of source code must retain the above copyright  *       notice, this list of conditions and the following disclaimer.  *     * Redistributions in binary form must reproduce the above copyright  *       notice, this list of conditions and the following disclaimer in the  *       documentation and/or other materials provided with the distribution.  *     * Neither the name of Freescale Semiconductor nor the  *       names of its contributors may be used to endorse or promote products  *       derived from this software without specific prior written permission.  *  *  * ALTERNATIVELY, this software may be distributed under the terms of the  * GNU General Public License ("GPL") as published by the Free Software  * Foundation, either version 2 of that License or (at your option) any  * later version.  *  * THIS SOFTWARE IS PROVIDED BY Freescale Semiconductor ``AS IS'' AND ANY  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED. IN NO EVENT SHALL Freescale Semiconductor BE LIABLE FOR ANY  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"std_ext.h"
end_include

begin_include
include|#
directive|include
file|"error_ext.h"
end_include

begin_include
include|#
directive|include
file|"sprint_ext.h"
end_include

begin_include
include|#
directive|include
file|"string_ext.h"
end_include

begin_include
include|#
directive|include
file|"fm_common.h"
end_include

begin_include
include|#
directive|include
file|"fm_hc.h"
end_include

begin_define
define|#
directive|define
name|HC_HCOR_OPCODE_PLCR_PRFL
value|0x0
end_define

begin_define
define|#
directive|define
name|HC_HCOR_OPCODE_KG_SCM
value|0x1
end_define

begin_define
define|#
directive|define
name|HC_HCOR_OPCODE_SYNC
value|0x2
end_define

begin_define
define|#
directive|define
name|HC_HCOR_OPCODE_CC
value|0x3
end_define

begin_define
define|#
directive|define
name|HC_HCOR_OPCODE_CC_CAPWAP_REASSM_TIMEOUT
value|0x5
end_define

begin_define
define|#
directive|define
name|HC_HCOR_GBL
value|0x20000000
end_define

begin_define
define|#
directive|define
name|SIZE_OF_HC_FRAME_PORT_REGS
value|(sizeof(t_HcFrame)-sizeof(t_FmPcdKgInterModuleSchemeRegs)+sizeof(t_FmPcdKgPortRegs))
end_define

begin_define
define|#
directive|define
name|SIZE_OF_HC_FRAME_SCHEME_REGS
value|sizeof(t_HcFrame)
end_define

begin_define
define|#
directive|define
name|SIZE_OF_HC_FRAME_PROFILES_REGS
value|(sizeof(t_HcFrame)-sizeof(t_FmPcdKgInterModuleSchemeRegs)+sizeof(t_FmPcdPlcrInterModuleProfileRegs))
end_define

begin_define
define|#
directive|define
name|SIZE_OF_HC_FRAME_PROFILE_CNT
value|(sizeof(t_HcFrame)-sizeof(t_FmPcdPlcrInterModuleProfileRegs)+sizeof(uint32_t))
end_define

begin_define
define|#
directive|define
name|SIZE_OF_HC_FRAME_READ_OR_CC_DYNAMIC
value|16
end_define

begin_define
define|#
directive|define
name|BUILD_FD
parameter_list|(
name|len
parameter_list|)
define|\
value|do {                                      \     memset(&fmFd, 0, sizeof(t_DpaaFD));   \     DPAA_FD_SET_ADDR(&fmFd, p_HcFrame);    \     DPAA_FD_SET_OFFSET(&fmFd, 0);         \     DPAA_FD_SET_LENGTH(&fmFd, len);       \ } while (0)
end_define

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__MWERKS__
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__GNUC__
argument_list|)
end_if

begin_pragma
pragma|#
directive|pragma
name|pack
name|(
name|push
name|,
name|1
name|)
end_pragma

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* defined(__MWERKS__)&& ... */
end_comment

begin_define
define|#
directive|define
name|MEM_MAP_START
end_define

begin_comment
comment|/**************************************************************************/
end_comment

begin_comment
comment|/**  @Description   PCD KG scheme registers */
end_comment

begin_comment
comment|/***************************************************************************/
end_comment

begin_typedef
typedef|typedef
name|_Packed
struct|struct
name|t_FmPcdKgSchemeRegsWithoutCounter
block|{
specifier|volatile
name|uint32_t
name|kgse_mode
decl_stmt|;
comment|/**< MODE */
specifier|volatile
name|uint32_t
name|kgse_ekfc
decl_stmt|;
comment|/**< Extract Known Fields Command */
specifier|volatile
name|uint32_t
name|kgse_ekdv
decl_stmt|;
comment|/**< Extract Known Default Value */
specifier|volatile
name|uint32_t
name|kgse_bmch
decl_stmt|;
comment|/**< Bit Mask Command High */
specifier|volatile
name|uint32_t
name|kgse_bmcl
decl_stmt|;
comment|/**< Bit Mask Command Low */
specifier|volatile
name|uint32_t
name|kgse_fqb
decl_stmt|;
comment|/**< Frame Queue Base */
specifier|volatile
name|uint32_t
name|kgse_hc
decl_stmt|;
comment|/**< Hash Command */
specifier|volatile
name|uint32_t
name|kgse_ppc
decl_stmt|;
comment|/**< Policer Profile Command */
specifier|volatile
name|uint32_t
name|kgse_gec
index|[
name|FM_PCD_KG_NUM_OF_GENERIC_REGS
index|]
decl_stmt|;
comment|/**< Generic Extract Command */
specifier|volatile
name|uint32_t
name|kgse_dv0
decl_stmt|;
comment|/**< KeyGen Scheme Entry Default Value 0 */
specifier|volatile
name|uint32_t
name|kgse_dv1
decl_stmt|;
comment|/**< KeyGen Scheme Entry Default Value 1 */
specifier|volatile
name|uint32_t
name|kgse_ccbs
decl_stmt|;
comment|/**< KeyGen Scheme Entry Coarse Classification Bit*/
specifier|volatile
name|uint32_t
name|kgse_mv
decl_stmt|;
comment|/**< KeyGen Scheme Entry Match vector */
block|}
name|_PackedType
name|t_FmPcdKgSchemeRegsWithoutCounter
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|_Packed
struct|struct
name|t_FmPcdKgPortRegs
block|{
specifier|volatile
name|uint32_t
name|spReg
decl_stmt|;
specifier|volatile
name|uint32_t
name|cppReg
decl_stmt|;
block|}
name|_PackedType
name|t_FmPcdKgPortRegs
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|_Packed
struct|struct
name|t_HcFrame
block|{
specifier|volatile
name|uint32_t
name|opcode
decl_stmt|;
specifier|volatile
name|uint32_t
name|actionReg
decl_stmt|;
specifier|volatile
name|uint32_t
name|extraReg
decl_stmt|;
specifier|volatile
name|uint32_t
name|commandSequence
decl_stmt|;
union|union
block|{
name|t_FmPcdKgInterModuleSchemeRegs
name|schemeRegs
decl_stmt|;
name|t_FmPcdKgInterModuleSchemeRegs
name|schemeRegsWithoutCounter
decl_stmt|;
name|t_FmPcdPlcrInterModuleProfileRegs
name|profileRegs
decl_stmt|;
specifier|volatile
name|uint32_t
name|singleRegForWrite
decl_stmt|;
comment|/* for writing SP, CPP, profile counter */
name|t_FmPcdKgPortRegs
name|portRegsForRead
decl_stmt|;
specifier|volatile
name|uint32_t
name|clsPlanEntries
index|[
name|CLS_PLAN_NUM_PER_GRP
index|]
decl_stmt|;
name|t_FmPcdCcCapwapReassmTimeoutParams
name|ccCapwapReassmTimeout
decl_stmt|;
block|}
name|hcSpecificData
union|;
block|}
name|_PackedType
name|t_HcFrame
typedef|;
end_typedef

begin_define
define|#
directive|define
name|MEM_MAP_END
end_define

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__MWERKS__
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__GNUC__
argument_list|)
end_if

begin_pragma
pragma|#
directive|pragma
name|pack
name|(
name|pop
name|)
end_pragma

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* defined(__MWERKS__)&& ... */
end_comment

begin_typedef
typedef|typedef
struct|struct
name|t_FmHc
block|{
name|t_Handle
name|h_FmPcd
decl_stmt|;
name|t_Handle
name|h_HcPortDev
decl_stmt|;
name|t_FmPcdQmEnqueueCallback
modifier|*
name|f_QmEnqueue
decl_stmt|;
comment|/**< A callback for enqueuing frames to the QM */
name|t_Handle
name|h_QmArg
decl_stmt|;
comment|/**< A handle to the QM module */
name|uint8_t
name|padTill16
decl_stmt|;
name|uint32_t
name|seqNum
decl_stmt|;
specifier|volatile
name|bool
name|wait
index|[
literal|32
index|]
decl_stmt|;
block|}
name|t_FmHc
typedef|;
end_typedef

begin_function
specifier|static
name|__inline__
name|t_Error
name|EnQFrm
parameter_list|(
name|t_FmHc
modifier|*
name|p_FmHc
parameter_list|,
name|t_DpaaFD
modifier|*
name|p_FmFd
parameter_list|,
specifier|volatile
name|uint32_t
modifier|*
name|p_SeqNum
parameter_list|)
block|{
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|uint32_t
name|savedSeqNum
decl_stmt|;
name|uint32_t
name|intFlags
decl_stmt|;
name|uint32_t
name|timeout
init|=
literal|100
decl_stmt|;
name|intFlags
operator|=
name|FmPcdLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|)
expr_stmt|;
operator|*
name|p_SeqNum
operator|=
name|p_FmHc
operator|->
name|seqNum
expr_stmt|;
name|savedSeqNum
operator|=
name|p_FmHc
operator|->
name|seqNum
expr_stmt|;
name|p_FmHc
operator|->
name|seqNum
operator|=
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|p_FmHc
operator|->
name|seqNum
operator|+
literal|1
operator|)
operator|%
literal|32
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
operator|!
name|p_FmHc
operator|->
name|wait
index|[
name|savedSeqNum
index|]
argument_list|)
expr_stmt|;
name|p_FmHc
operator|->
name|wait
index|[
name|savedSeqNum
index|]
operator|=
name|TRUE
expr_stmt|;
name|FmPcdUnlock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|DBG
argument_list|(
name|TRACE
argument_list|,
operator|(
literal|"Send Hc, SeqNum %d, FD@0x%x, fd offset 0x%x"
operator|,
name|savedSeqNum
operator|,
name|DPAA_FD_GET_ADDR
argument_list|(
name|p_FmFd
argument_list|)
operator|,
name|DPAA_FD_GET_OFFSET
argument_list|(
name|p_FmFd
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|p_FmHc
operator|->
name|f_QmEnqueue
argument_list|(
name|p_FmHc
operator|->
name|h_QmArg
argument_list|,
operator|(
name|void
operator|*
operator|)
name|p_FmFd
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
operator|(
literal|"HC enqueue failed"
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|p_FmHc
operator|->
name|wait
index|[
name|savedSeqNum
index|]
operator|&&
operator|--
name|timeout
condition|)
name|XX_UDelay
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|timeout
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_TIMEOUT
argument_list|,
operator|(
literal|"HC Callback, timeout exceeded"
operator|)
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|CcHcDoDynamicChange
parameter_list|(
name|t_FmHc
modifier|*
name|p_FmHc
parameter_list|,
name|t_Handle
name|p_OldPointer
parameter_list|,
name|t_Handle
name|p_NewPointer
parameter_list|)
block|{
name|t_HcFrame
modifier|*
name|p_HcFrame
decl_stmt|;
name|t_DpaaFD
name|fmFd
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_FmHc
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|=
operator|(
name|t_HcFrame
operator|*
operator|)
name|XX_MallocSmart
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
operator|+
name|p_FmHc
operator|->
name|padTill16
operator|)
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_HcFrame
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"HC Frame obj"
operator|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p_HcFrame
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|opcode
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|HC_HCOR_GBL
operator||
name|HC_HCOR_OPCODE_CC
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator|=
name|FmPcdCcGetNodeAddrOffsetFromNodeInfo
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|p_NewPointer
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_HcFrame
operator|->
name|actionReg
operator|==
operator|(
name|uint32_t
operator|)
name|ILLEGAL_BASE
condition|)
block|{
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Something wrong with base address"
operator|)
argument_list|)
expr_stmt|;
block|}
name|p_HcFrame
operator|->
name|actionReg
operator||=
literal|0xc0000000
expr_stmt|;
name|p_HcFrame
operator|->
name|extraReg
operator|=
name|FmPcdCcGetNodeAddrOffsetFromNodeInfo
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|p_OldPointer
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_HcFrame
operator|->
name|extraReg
operator|==
operator|(
name|uint32_t
operator|)
name|ILLEGAL_BASE
condition|)
block|{
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Something wrong with base address"
operator|)
argument_list|)
expr_stmt|;
block|}
name|BUILD_FD
argument_list|(
name|SIZE_OF_HC_FRAME_READ_OR_CC_DYNAMIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|EnQFrm
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|fmFd
argument_list|,
operator|&
name|p_HcFrame
operator|->
name|commandSequence
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|HcDynamicChange
parameter_list|(
name|t_FmHc
modifier|*
name|p_FmHc
parameter_list|,
name|t_List
modifier|*
name|h_OldPointersLst
parameter_list|,
name|t_List
modifier|*
name|h_NewPointersLst
parameter_list|,
name|t_Handle
modifier|*
name|h_Params
parameter_list|)
block|{
name|t_List
modifier|*
name|p_PosOld
decl_stmt|,
modifier|*
name|p_PosNew
decl_stmt|;
name|uint16_t
name|i
init|=
literal|0
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|uint8_t
name|numOfModifiedPtr
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|LIST_NumOfObjs
argument_list|(
name|h_NewPointersLst
argument_list|)
operator|==
name|LIST_NumOfObjs
argument_list|(
name|h_OldPointersLst
argument_list|)
operator|)
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|numOfModifiedPtr
operator|=
operator|(
name|uint8_t
operator|)
name|LIST_NumOfObjs
argument_list|(
name|h_NewPointersLst
argument_list|)
expr_stmt|;
name|p_PosNew
operator|=
name|NCSW_LIST_FIRST
argument_list|(
name|h_NewPointersLst
argument_list|)
expr_stmt|;
name|p_PosOld
operator|=
name|NCSW_LIST_FIRST
argument_list|(
name|h_OldPointersLst
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|numOfModifiedPtr
condition|;
name|i
operator|++
control|)
block|{
name|err
operator|=
name|CcHcDoDynamicChange
argument_list|(
name|p_FmHc
argument_list|,
name|p_PosOld
argument_list|,
name|p_PosNew
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|FmPcdCcReleaseModifiedDataStructure
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|h_OldPointersLst
argument_list|,
name|h_NewPointersLst
argument_list|,
name|i
argument_list|,
name|h_Params
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
operator|(
literal|"For part of nodes changes are done - situation is danger"
operator|)
argument_list|)
expr_stmt|;
block|}
name|p_PosNew
operator|=
name|NCSW_LIST_NEXT
argument_list|(
name|p_PosNew
argument_list|)
expr_stmt|;
name|p_PosOld
operator|=
name|NCSW_LIST_NEXT
argument_list|(
name|p_PosOld
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|FmPcdCcReleaseModifiedDataStructure
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|h_OldPointersLst
argument_list|,
name|h_NewPointersLst
argument_list|,
name|i
argument_list|,
name|h_Params
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Handle
name|FmHcConfigAndInit
parameter_list|(
name|t_FmHcParams
modifier|*
name|p_FmHcParams
parameter_list|)
block|{
name|t_FmHc
modifier|*
name|p_FmHc
decl_stmt|;
name|t_FmPortParams
name|fmPortParam
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|p_FmHc
operator|=
operator|(
name|t_FmHc
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|t_FmHc
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_FmHc
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"HC obj"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_FmHc
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmHc
argument_list|)
argument_list|)
expr_stmt|;
name|p_FmHc
operator|->
name|h_FmPcd
operator|=
name|p_FmHcParams
operator|->
name|h_FmPcd
expr_stmt|;
name|p_FmHc
operator|->
name|f_QmEnqueue
operator|=
name|p_FmHcParams
operator|->
name|params
operator|.
name|f_QmEnqueue
expr_stmt|;
name|p_FmHc
operator|->
name|h_QmArg
operator|=
name|p_FmHcParams
operator|->
name|params
operator|.
name|h_QmArg
expr_stmt|;
if|if
condition|(
operator|!
name|FmIsMaster
argument_list|(
name|p_FmHcParams
operator|->
name|h_Fm
argument_list|)
condition|)
return|return
operator|(
name|t_Handle
operator|)
name|p_FmHc
return|;
comment|/* TKT056919 - axi12axi0 can hang if read request follows the single byte write on the very next cycle TKT038900 - FM dma lockup occur due to AXI slave protocol violation */
ifdef|#
directive|ifdef
name|FM_LOCKUP_ALIGNMENT_ERRATA_FMAN_SW004
name|p_FmHc
operator|->
name|padTill16
operator|=
literal|16
operator|-
operator|(
sizeof|sizeof
argument_list|(
name|t_FmHc
argument_list|)
operator|%
literal|16
operator|)
expr_stmt|;
endif|#
directive|endif
comment|/* FM_LOCKUP_ALIGNMENT_ERRATA_FMAN_SW004 */
name|memset
argument_list|(
operator|&
name|fmPortParam
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|fmPortParam
argument_list|)
argument_list|)
expr_stmt|;
name|fmPortParam
operator|.
name|baseAddr
operator|=
name|p_FmHcParams
operator|->
name|params
operator|.
name|portBaseAddr
expr_stmt|;
name|fmPortParam
operator|.
name|portType
operator|=
name|e_FM_PORT_TYPE_OH_HOST_COMMAND
expr_stmt|;
name|fmPortParam
operator|.
name|portId
operator|=
name|p_FmHcParams
operator|->
name|params
operator|.
name|portId
expr_stmt|;
name|fmPortParam
operator|.
name|liodnBase
operator|=
name|p_FmHcParams
operator|->
name|params
operator|.
name|liodnBase
expr_stmt|;
name|fmPortParam
operator|.
name|h_Fm
operator|=
name|p_FmHcParams
operator|->
name|h_Fm
expr_stmt|;
name|fmPortParam
operator|.
name|specificParams
operator|.
name|nonRxParams
operator|.
name|errFqid
operator|=
name|p_FmHcParams
operator|->
name|params
operator|.
name|errFqid
expr_stmt|;
name|fmPortParam
operator|.
name|specificParams
operator|.
name|nonRxParams
operator|.
name|dfltFqid
operator|=
name|p_FmHcParams
operator|->
name|params
operator|.
name|confFqid
expr_stmt|;
name|fmPortParam
operator|.
name|specificParams
operator|.
name|nonRxParams
operator|.
name|qmChannel
operator|=
name|p_FmHcParams
operator|->
name|params
operator|.
name|qmChannel
expr_stmt|;
name|p_FmHc
operator|->
name|h_HcPortDev
operator|=
name|FM_PORT_Config
argument_list|(
operator|&
name|fmPortParam
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_FmHc
operator|->
name|h_HcPortDev
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
operator|(
literal|"FM HC port!"
operator|)
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_FmHc
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* final init */
if|if
condition|(
operator|(
name|err
operator|=
name|FM_PORT_Init
argument_list|(
name|p_FmHc
operator|->
name|h_HcPortDev
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
operator|(
literal|"FM HC port!"
operator|)
argument_list|)
expr_stmt|;
name|FmHcFree
argument_list|(
name|p_FmHc
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|(
name|err
operator|=
name|FM_PORT_Enable
argument_list|(
name|p_FmHc
operator|->
name|h_HcPortDev
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
operator|(
literal|"FM HC port!"
operator|)
argument_list|)
expr_stmt|;
name|FmHcFree
argument_list|(
name|p_FmHc
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
operator|(
name|t_Handle
operator|)
name|p_FmHc
return|;
block|}
end_function

begin_function
name|void
name|FmHcFree
parameter_list|(
name|t_Handle
name|h_FmHc
parameter_list|)
block|{
name|t_FmHc
modifier|*
name|p_FmHc
init|=
operator|(
name|t_FmHc
operator|*
operator|)
name|h_FmHc
decl_stmt|;
if|if
condition|(
operator|!
name|p_FmHc
condition|)
return|return;
if|if
condition|(
name|p_FmHc
operator|->
name|h_HcPortDev
condition|)
name|FM_PORT_Free
argument_list|(
name|p_FmHc
operator|->
name|h_HcPortDev
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_FmHc
argument_list|)
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
operator|(
name|defined
argument_list|(
name|DEBUG_ERRORS
argument_list|)
operator|&&
operator|(
name|DEBUG_ERRORS
operator|>
literal|0
operator|)
operator|)
end_if

begin_function
name|t_Error
name|FmHcDumpRegs
parameter_list|(
name|t_Handle
name|h_FmHc
parameter_list|)
block|{
name|t_FmHc
modifier|*
name|p_FmHc
init|=
operator|(
name|t_FmHc
operator|*
operator|)
name|h_FmHc
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmHc
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmHc
operator|->
name|h_HcPortDev
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
return|return
name|FM_PORT_DumpRegs
argument_list|(
name|p_FmHc
operator|->
name|h_HcPortDev
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* (defined(DEBUG_ERRORS)&& ... */
end_comment

begin_function
name|void
name|FmHcTxConf
parameter_list|(
name|t_Handle
name|h_FmHc
parameter_list|,
name|t_DpaaFD
modifier|*
name|p_Fd
parameter_list|)
block|{
name|t_FmHc
modifier|*
name|p_FmHc
init|=
operator|(
name|t_FmHc
operator|*
operator|)
name|h_FmHc
decl_stmt|;
name|t_HcFrame
modifier|*
name|p_HcFrame
decl_stmt|;
name|uint32_t
name|intFlags
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_FmHc
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|FmPcdLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|=
operator|(
name|t_HcFrame
operator|*
operator|)
name|PTR_MOVE
argument_list|(
name|DPAA_FD_GET_ADDR
argument_list|(
name|p_Fd
argument_list|)
argument_list|,
name|DPAA_FD_GET_OFFSET
argument_list|(
name|p_Fd
argument_list|)
argument_list|)
expr_stmt|;
name|DBG
argument_list|(
name|TRACE
argument_list|,
operator|(
literal|"Hc Conf, SeqNum %d, FD@0x%x, fd offset 0x%x"
operator|,
name|p_HcFrame
operator|->
name|commandSequence
operator|,
name|DPAA_FD_GET_ADDR
argument_list|(
name|p_Fd
argument_list|)
operator|,
name|DPAA_FD_GET_OFFSET
argument_list|(
name|p_Fd
argument_list|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|p_FmHc
operator|->
name|wait
index|[
name|p_HcFrame
operator|->
name|commandSequence
index|]
operator|)
condition|)
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_FRAME
argument_list|,
operator|(
literal|"Not an Host-Command frame received!"
operator|)
argument_list|)
expr_stmt|;
else|else
name|p_FmHc
operator|->
name|wait
index|[
name|p_HcFrame
operator|->
name|commandSequence
index|]
operator|=
name|FALSE
expr_stmt|;
name|FmPcdUnlock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|t_Handle
name|FmHcPcdKgSetScheme
parameter_list|(
name|t_Handle
name|h_FmHc
parameter_list|,
name|t_FmPcdKgSchemeParams
modifier|*
name|p_Scheme
parameter_list|)
block|{
name|t_FmHc
modifier|*
name|p_FmHc
init|=
operator|(
name|t_FmHc
operator|*
operator|)
name|h_FmHc
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|t_FmPcdKgInterModuleSchemeRegs
name|schemeRegs
decl_stmt|;
name|t_HcFrame
modifier|*
name|p_HcFrame
decl_stmt|;
name|t_DpaaFD
name|fmFd
decl_stmt|;
name|uint32_t
name|intFlags
decl_stmt|;
name|uint8_t
name|physicalSchemeId
decl_stmt|,
name|relativeSchemeId
decl_stmt|;
name|p_HcFrame
operator|=
operator|(
name|t_HcFrame
operator|*
operator|)
name|XX_MallocSmart
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
operator|+
name|p_FmHc
operator|->
name|padTill16
operator|)
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_HcFrame
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"HC Frame obj"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|p_Scheme
operator|->
name|modify
condition|)
block|{
comment|/* check that schemeId is in range */
if|if
condition|(
name|p_Scheme
operator|->
name|id
operator|.
name|relativeSchemeId
operator|>=
name|FmPcdKgGetNumOfPartitionSchemes
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|)
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_IN_RANGE
argument_list|,
operator|(
literal|"Scheme is out of range"
operator|)
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|relativeSchemeId
operator|=
name|p_Scheme
operator|->
name|id
operator|.
name|relativeSchemeId
expr_stmt|;
if|if
condition|(
name|FmPcdKgSchemeTryLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|,
name|FALSE
argument_list|)
condition|)
block|{
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|physicalSchemeId
operator|=
name|FmPcdKgGetPhysicalSchemeId
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p_HcFrame
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|opcode
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|HC_HCOR_GBL
operator||
name|HC_HCOR_OPCODE_KG_SCM
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator|=
name|FmPcdKgBuildReadSchemeActionReg
argument_list|(
name|physicalSchemeId
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|extraReg
operator|=
literal|0xFFFFF800
expr_stmt|;
name|BUILD_FD
argument_list|(
name|SIZE_OF_HC_FRAME_READ_OR_CC_DYNAMIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|EnQFrm
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|fmFd
argument_list|,
operator|&
name|p_HcFrame
operator|->
name|commandSequence
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|FmPcdKgReleaseSchemeLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* check if this scheme is already used */
if|if
condition|(
name|FmPcdKgHwSchemeIsValid
argument_list|(
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|schemeRegs
operator|.
name|kgse_mode
argument_list|)
condition|)
block|{
name|FmPcdKgReleaseSchemeLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_ALREADY_EXISTS
argument_list|,
operator|(
literal|"Scheme is already used"
operator|)
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
else|else
block|{
name|intFlags
operator|=
name|FmPcdLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|)
expr_stmt|;
name|physicalSchemeId
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|PTR_TO_UINT
argument_list|(
name|p_Scheme
operator|->
name|id
operator|.
name|h_Scheme
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|relativeSchemeId
operator|=
name|FmPcdKgGetRelativeSchemeId
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|physicalSchemeId
argument_list|)
expr_stmt|;
if|if
condition|(
name|relativeSchemeId
operator|==
name|FM_PCD_KG_NUM_OF_SCHEMES
condition|)
block|{
name|FmPcdUnlock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_IN_RANGE
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|err
operator|=
name|FmPcdKgSchemeTryLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|FmPcdUnlock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
name|err
operator|=
name|FmPcdKgBuildScheme
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|p_Scheme
argument_list|,
operator|&
name|schemeRegs
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|FmPcdKgReleaseSchemeLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_HcFrame
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|opcode
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|HC_HCOR_GBL
operator||
name|HC_HCOR_OPCODE_KG_SCM
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator|=
name|FmPcdKgBuildWriteSchemeActionReg
argument_list|(
name|physicalSchemeId
argument_list|,
name|p_Scheme
operator|->
name|schemeCounter
operator|.
name|update
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|extraReg
operator|=
literal|0xFFFFF800
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|schemeRegs
argument_list|,
operator|&
name|schemeRegs
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmPcdKgInterModuleSchemeRegs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Scheme
operator|->
name|schemeCounter
operator|.
name|update
condition|)
block|{
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|schemeRegs
operator|.
name|kgse_dv0
operator|=
name|schemeRegs
operator|.
name|kgse_dv0
expr_stmt|;
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|schemeRegs
operator|.
name|kgse_dv1
operator|=
name|schemeRegs
operator|.
name|kgse_dv1
expr_stmt|;
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|schemeRegs
operator|.
name|kgse_ccbs
operator|=
name|schemeRegs
operator|.
name|kgse_ccbs
expr_stmt|;
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|schemeRegs
operator|.
name|kgse_mv
operator|=
name|schemeRegs
operator|.
name|kgse_mv
expr_stmt|;
block|}
name|BUILD_FD
argument_list|(
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|EnQFrm
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|fmFd
argument_list|,
operator|&
name|p_HcFrame
operator|->
name|commandSequence
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|FmPcdKgReleaseSchemeLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|FmPcdKgValidateSchemeSw
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
expr_stmt|;
name|FmPcdKgReleaseSchemeLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
call|(
name|t_Handle
call|)
argument_list|(
name|UINT_TO_PTR
argument_list|(
name|physicalSchemeId
operator|+
literal|1
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|t_Error
name|FmHcPcdKgDeleteScheme
parameter_list|(
name|t_Handle
name|h_FmHc
parameter_list|,
name|t_Handle
name|h_Scheme
parameter_list|)
block|{
name|t_FmHc
modifier|*
name|p_FmHc
init|=
operator|(
name|t_FmHc
operator|*
operator|)
name|h_FmHc
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|t_HcFrame
modifier|*
name|p_HcFrame
decl_stmt|;
name|t_DpaaFD
name|fmFd
decl_stmt|;
name|uint8_t
name|relativeSchemeId
decl_stmt|;
name|uint8_t
name|physicalSchemeId
init|=
call|(
name|uint8_t
call|)
argument_list|(
name|PTR_TO_UINT
argument_list|(
name|h_Scheme
argument_list|)
operator|-
literal|1
argument_list|)
decl_stmt|;
name|relativeSchemeId
operator|=
name|FmPcdKgGetRelativeSchemeId
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|physicalSchemeId
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|FmPcdKgSchemeTryLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|,
name|FALSE
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|relativeSchemeId
operator|==
name|FM_PCD_KG_NUM_OF_SCHEMES
condition|)
block|{
name|FmPcdKgReleaseSchemeLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_IN_RANGE
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|FmPcdKgCheckInvalidateSchemeSw
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|FmPcdKgReleaseSchemeLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|p_HcFrame
operator|=
operator|(
name|t_HcFrame
operator|*
operator|)
name|XX_MallocSmart
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
operator|+
name|p_FmHc
operator|->
name|padTill16
operator|)
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_HcFrame
condition|)
block|{
name|FmPcdKgReleaseSchemeLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"HC Frame obj"
operator|)
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
name|p_HcFrame
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|opcode
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|HC_HCOR_GBL
operator||
name|HC_HCOR_OPCODE_KG_SCM
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator|=
name|FmPcdKgBuildWriteSchemeActionReg
argument_list|(
name|physicalSchemeId
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|extraReg
operator|=
literal|0xFFFFF800
expr_stmt|;
name|memset
argument_list|(
operator|&
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|schemeRegs
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmPcdKgInterModuleSchemeRegs
argument_list|)
argument_list|)
expr_stmt|;
name|BUILD_FD
argument_list|(
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|EnQFrm
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|fmFd
argument_list|,
operator|&
name|p_HcFrame
operator|->
name|commandSequence
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|FmPcdKgReleaseSchemeLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|FmPcdKgInvalidateSchemeSw
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
expr_stmt|;
name|FmPcdKgReleaseSchemeLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FmHcPcdKgCcGetSetParams
parameter_list|(
name|t_Handle
name|h_FmHc
parameter_list|,
name|t_Handle
name|h_Scheme
parameter_list|,
name|uint32_t
name|requiredAction
parameter_list|)
block|{
name|t_FmHc
modifier|*
name|p_FmHc
init|=
operator|(
name|t_FmHc
operator|*
operator|)
name|h_FmHc
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|t_HcFrame
modifier|*
name|p_HcFrame
decl_stmt|;
name|t_DpaaFD
name|fmFd
decl_stmt|;
name|uint8_t
name|relativeSchemeId
decl_stmt|;
name|uint8_t
name|physicalSchemeId
init|=
call|(
name|uint8_t
call|)
argument_list|(
name|PTR_TO_UINT
argument_list|(
name|h_Scheme
argument_list|)
operator|-
literal|1
argument_list|)
decl_stmt|;
name|uint32_t
name|tmpReg32
init|=
literal|0
decl_stmt|;
name|relativeSchemeId
operator|=
name|FmPcdKgGetRelativeSchemeId
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|physicalSchemeId
argument_list|)
expr_stmt|;
if|if
condition|(
name|relativeSchemeId
operator|==
name|FM_PCD_KG_NUM_OF_SCHEMES
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_IN_RANGE
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|FmPcdKgSchemeTryLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|,
name|FALSE
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Lock of the scheme FAILED"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|FmPcdKgGetPointedOwners
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
operator|||
operator|!
operator|(
name|FmPcdKgGetRequiredAction
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
operator|&
name|requiredAction
operator|)
condition|)
block|{
if|if
condition|(
name|requiredAction
operator|&
name|UPDATE_NIA_ENQ_WITHOUT_DMA
condition|)
block|{
if|if
condition|(
operator|(
name|FmPcdKgGetNextEngine
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
operator|==
name|e_FM_PCD_DONE
operator|)
operator|&&
operator|(
name|FmPcdKgGetDoneAction
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
operator|==
name|e_FM_PCD_ENQ_FRAME
operator|)
condition|)
block|{
name|p_HcFrame
operator|=
operator|(
name|t_HcFrame
operator|*
operator|)
name|XX_MallocSmart
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
operator|+
name|p_FmHc
operator|->
name|padTill16
operator|)
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_HcFrame
condition|)
block|{
name|FmPcdKgReleaseSchemeLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"HC Frame obj"
operator|)
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
name|p_HcFrame
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|opcode
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|HC_HCOR_GBL
operator||
name|HC_HCOR_OPCODE_KG_SCM
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator|=
name|FmPcdKgBuildReadSchemeActionReg
argument_list|(
name|physicalSchemeId
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|extraReg
operator|=
literal|0xFFFFF800
expr_stmt|;
name|BUILD_FD
argument_list|(
name|SIZE_OF_HC_FRAME_READ_OR_CC_DYNAMIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|EnQFrm
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|fmFd
argument_list|,
operator|&
name|p_HcFrame
operator|->
name|commandSequence
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|FmPcdKgReleaseSchemeLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
comment|/* check if this scheme is already used */
if|if
condition|(
operator|!
name|FmPcdKgHwSchemeIsValid
argument_list|(
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|schemeRegs
operator|.
name|kgse_mode
argument_list|)
condition|)
block|{
name|FmPcdKgReleaseSchemeLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_ALREADY_EXISTS
argument_list|,
operator|(
literal|"Scheme is already used"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tmpReg32
operator|=
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|schemeRegs
operator|.
name|kgse_mode
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|tmpReg32
operator|&
operator|(
name|NIA_ENG_BMI
operator||
name|NIA_BMI_AC_ENQ_FRAME
operator|)
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|schemeRegs
operator|.
name|kgse_mode
operator|=
name|tmpReg32
operator||
name|NIA_BMI_AC_ENQ_FRAME_WITHOUT_DMA
expr_stmt|;
name|p_HcFrame
operator|->
name|opcode
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|HC_HCOR_GBL
operator||
name|HC_HCOR_OPCODE_KG_SCM
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator|=
name|FmPcdKgBuildWriteSchemeActionReg
argument_list|(
name|physicalSchemeId
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|extraReg
operator|=
literal|0x80000000
expr_stmt|;
name|BUILD_FD
argument_list|(
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|EnQFrm
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|fmFd
argument_list|,
operator|&
name|p_HcFrame
operator|->
name|commandSequence
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|FmPcdKgReleaseSchemeLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|FmPcdKgGetNextEngine
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
operator|==
name|e_FM_PCD_PLCR
condition|)
block|{
if|if
condition|(
operator|(
name|FmPcdKgIsDirectPlcr
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
operator|==
name|FALSE
operator|)
operator|||
operator|(
name|FmPcdKgIsDistrOnPlcrProfile
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
operator|==
name|TRUE
operator|)
condition|)
block|{
name|FmPcdKgReleaseSchemeLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"In this situation PP can not be with distribution and has to be shared"
operator|)
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|FmPcdPlcrCcGetSetParams
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|FmPcdKgGetRelativeProfileId
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
argument_list|,
name|requiredAction
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|FmPcdKgReleaseSchemeLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
name|FmPcdKgUpatePointedOwner
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|FmPcdKgUpdateRequiredAction
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|,
name|requiredAction
argument_list|)
expr_stmt|;
name|FmPcdKgReleaseSchemeLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|uint32_t
name|FmHcPcdKgGetSchemeCounter
parameter_list|(
name|t_Handle
name|h_FmHc
parameter_list|,
name|t_Handle
name|h_Scheme
parameter_list|)
block|{
name|t_FmHc
modifier|*
name|p_FmHc
init|=
operator|(
name|t_FmHc
operator|*
operator|)
name|h_FmHc
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|t_HcFrame
modifier|*
name|p_HcFrame
decl_stmt|;
name|t_DpaaFD
name|fmFd
decl_stmt|;
name|uint32_t
name|retVal
decl_stmt|;
name|uint8_t
name|relativeSchemeId
decl_stmt|;
name|uint8_t
name|physicalSchemeId
init|=
call|(
name|uint8_t
call|)
argument_list|(
name|PTR_TO_UINT
argument_list|(
name|h_Scheme
argument_list|)
operator|-
literal|1
argument_list|)
decl_stmt|;
name|relativeSchemeId
operator|=
name|FmPcdKgGetRelativeSchemeId
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|physicalSchemeId
argument_list|)
expr_stmt|;
if|if
condition|(
name|relativeSchemeId
operator|==
name|FM_PCD_KG_NUM_OF_SCHEMES
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_IN_RANGE
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|(
name|err
operator|=
name|FmPcdKgSchemeTryLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|,
name|FALSE
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
operator|(
literal|"Scheme lock"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* first read scheme and check that it is valid */
name|p_HcFrame
operator|=
operator|(
name|t_HcFrame
operator|*
operator|)
name|XX_MallocSmart
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
operator|+
name|p_FmHc
operator|->
name|padTill16
operator|)
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_HcFrame
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"HC Frame obj"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|memset
argument_list|(
name|p_HcFrame
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|opcode
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|HC_HCOR_GBL
operator||
name|HC_HCOR_OPCODE_KG_SCM
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator|=
name|FmPcdKgBuildReadSchemeActionReg
argument_list|(
name|physicalSchemeId
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|extraReg
operator|=
literal|0xFFFFF800
expr_stmt|;
name|BUILD_FD
argument_list|(
name|SIZE_OF_HC_FRAME_READ_OR_CC_DYNAMIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|EnQFrm
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|fmFd
argument_list|,
operator|&
name|p_HcFrame
operator|->
name|commandSequence
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|FmPcdKgReleaseSchemeLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|FmPcdKgHwSchemeIsValid
argument_list|(
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|schemeRegs
operator|.
name|kgse_mode
argument_list|)
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_ALREADY_EXISTS
argument_list|,
operator|(
literal|"Scheme is invalid"
operator|)
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|retVal
operator|=
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|schemeRegs
operator|.
name|kgse_spc
expr_stmt|;
name|FmPcdKgReleaseSchemeLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
name|retVal
return|;
block|}
end_function

begin_function
name|t_Error
name|FmHcPcdKgSetSchemeCounter
parameter_list|(
name|t_Handle
name|h_FmHc
parameter_list|,
name|t_Handle
name|h_Scheme
parameter_list|,
name|uint32_t
name|value
parameter_list|)
block|{
name|t_FmHc
modifier|*
name|p_FmHc
init|=
operator|(
name|t_FmHc
operator|*
operator|)
name|h_FmHc
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|t_HcFrame
modifier|*
name|p_HcFrame
decl_stmt|;
name|t_DpaaFD
name|fmFd
decl_stmt|;
name|uint8_t
name|relativeSchemeId
decl_stmt|,
name|physicalSchemeId
init|=
call|(
name|uint8_t
call|)
argument_list|(
name|PTR_TO_UINT
argument_list|(
name|h_Scheme
argument_list|)
operator|-
literal|1
argument_list|)
decl_stmt|;
name|relativeSchemeId
operator|=
name|FmPcdKgGetRelativeSchemeId
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|physicalSchemeId
argument_list|)
expr_stmt|;
if|if
condition|(
name|relativeSchemeId
operator|==
name|FM_PCD_KG_NUM_OF_SCHEMES
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_IN_RANGE
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|FmPcdKgSchemeTryLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|,
name|FALSE
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
comment|/* first read scheme and check that it is valid */
name|p_HcFrame
operator|=
operator|(
name|t_HcFrame
operator|*
operator|)
name|XX_MallocSmart
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
operator|+
name|p_FmHc
operator|->
name|padTill16
operator|)
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_HcFrame
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"HC Frame obj"
operator|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p_HcFrame
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|opcode
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|HC_HCOR_GBL
operator||
name|HC_HCOR_OPCODE_KG_SCM
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator|=
name|FmPcdKgBuildReadSchemeActionReg
argument_list|(
name|physicalSchemeId
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|extraReg
operator|=
literal|0xFFFFF800
expr_stmt|;
name|BUILD_FD
argument_list|(
name|SIZE_OF_HC_FRAME_READ_OR_CC_DYNAMIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|EnQFrm
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|fmFd
argument_list|,
operator|&
name|p_HcFrame
operator|->
name|commandSequence
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|FmPcdKgReleaseSchemeLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
comment|/* check that scheme is valid */
if|if
condition|(
operator|!
name|FmPcdKgHwSchemeIsValid
argument_list|(
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|schemeRegs
operator|.
name|kgse_mode
argument_list|)
condition|)
block|{
name|FmPcdKgReleaseSchemeLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_ALREADY_EXISTS
argument_list|,
operator|(
literal|"Scheme is invalid"
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* Write scheme back, with modified counter */
name|p_HcFrame
operator|->
name|opcode
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|HC_HCOR_GBL
operator||
name|HC_HCOR_OPCODE_KG_SCM
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator|=
name|FmPcdKgBuildWriteSchemeActionReg
argument_list|(
name|physicalSchemeId
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|extraReg
operator|=
literal|0xFFFFF800
expr_stmt|;
comment|/* write counter */
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|schemeRegs
operator|.
name|kgse_spc
operator|=
name|value
expr_stmt|;
name|BUILD_FD
argument_list|(
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|EnQFrm
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|fmFd
argument_list|,
operator|&
name|p_HcFrame
operator|->
name|commandSequence
argument_list|)
expr_stmt|;
name|FmPcdKgReleaseSchemeLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|t_Error
name|FmHcPcdKgSetClsPlan
parameter_list|(
name|t_Handle
name|h_FmHc
parameter_list|,
name|t_FmPcdKgInterModuleClsPlanSet
modifier|*
name|p_Set
parameter_list|)
block|{
name|t_FmHc
modifier|*
name|p_FmHc
init|=
operator|(
name|t_FmHc
operator|*
operator|)
name|h_FmHc
decl_stmt|;
name|t_HcFrame
modifier|*
name|p_HcFrame
decl_stmt|;
name|t_DpaaFD
name|fmFd
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_FmHc
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|=
operator|(
name|t_HcFrame
operator|*
operator|)
name|XX_MallocSmart
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
operator|+
name|p_FmHc
operator|->
name|padTill16
operator|)
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_HcFrame
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"HC Frame obj"
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|p_Set
operator|->
name|baseEntry
init|;
name|i
operator|<
name|p_Set
operator|->
name|baseEntry
operator|+
name|p_Set
operator|->
name|numOfClsPlanEntries
condition|;
name|i
operator|+=
literal|8
control|)
block|{
name|memset
argument_list|(
name|p_HcFrame
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|opcode
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|HC_HCOR_GBL
operator||
name|HC_HCOR_OPCODE_KG_SCM
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator|=
name|FmPcdKgBuildWriteClsPlanBlockActionReg
argument_list|(
call|(
name|uint8_t
call|)
argument_list|(
name|i
operator|/
name|CLS_PLAN_NUM_PER_GRP
argument_list|)
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|extraReg
operator|=
literal|0xFFFFF800
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|&
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|clsPlanEntries
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|p_Set
operator|->
name|vectors
index|[
name|i
operator|-
name|p_Set
operator|->
name|baseEntry
index|]
argument_list|,
name|CLS_PLAN_NUM_PER_GRP
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
name|BUILD_FD
argument_list|(
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|EnQFrm
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|fmFd
argument_list|,
operator|&
name|p_HcFrame
operator|->
name|commandSequence
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
block|}
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|t_Error
name|FmHcPcdKgDeleteClsPlan
parameter_list|(
name|t_Handle
name|h_FmHc
parameter_list|,
name|uint8_t
name|grpId
parameter_list|)
block|{
name|t_FmHc
modifier|*
name|p_FmHc
init|=
operator|(
name|t_FmHc
operator|*
operator|)
name|h_FmHc
decl_stmt|;
name|t_FmPcdKgInterModuleClsPlanSet
modifier|*
name|p_ClsPlanSet
decl_stmt|;
comment|/* clear clsPlan entries in memory */
name|p_ClsPlanSet
operator|=
operator|(
name|t_FmPcdKgInterModuleClsPlanSet
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|t_FmPcdKgInterModuleClsPlanSet
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_ClsPlanSet
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"memory allocation failed for p_ClsPlanSetd"
operator|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p_ClsPlanSet
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmPcdKgInterModuleClsPlanSet
argument_list|)
argument_list|)
expr_stmt|;
name|p_ClsPlanSet
operator|->
name|baseEntry
operator|=
name|FmPcdKgGetClsPlanGrpBase
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|grpId
argument_list|)
expr_stmt|;
name|p_ClsPlanSet
operator|->
name|numOfClsPlanEntries
operator|=
name|FmPcdKgGetClsPlanGrpSize
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|grpId
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|p_ClsPlanSet
operator|->
name|numOfClsPlanEntries
operator|<=
name|FM_PCD_MAX_NUM_OF_CLS_PLANS
argument_list|)
expr_stmt|;
if|if
condition|(
name|FmHcPcdKgSetClsPlan
argument_list|(
name|p_FmHc
argument_list|,
name|p_ClsPlanSet
argument_list|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_ClsPlanSet
argument_list|)
expr_stmt|;
name|FmPcdKgDestroyClsPlanGrp
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|grpId
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FmHcPcdCcCapwapTimeoutReassm
parameter_list|(
name|t_Handle
name|h_FmHc
parameter_list|,
name|t_FmPcdCcCapwapReassmTimeoutParams
modifier|*
name|p_CcCapwapReassmTimeoutParams
parameter_list|)
block|{
name|t_FmHc
modifier|*
name|p_FmHc
init|=
operator|(
name|t_FmHc
operator|*
operator|)
name|h_FmHc
decl_stmt|;
name|t_HcFrame
modifier|*
name|p_HcFrame
decl_stmt|;
name|uint32_t
name|intFlags
decl_stmt|;
name|t_DpaaFD
name|fmFd
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|h_FmHc
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|FmPcdLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|=
operator|(
name|t_HcFrame
operator|*
operator|)
name|XX_MallocSmart
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
operator|+
name|p_FmHc
operator|->
name|padTill16
operator|)
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_HcFrame
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"HC Frame obj"
operator|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p_HcFrame
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|opcode
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|HC_HCOR_GBL
operator||
name|HC_HCOR_OPCODE_CC_CAPWAP_REASSM_TIMEOUT
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|ccCapwapReassmTimeout
argument_list|,
name|p_CcCapwapReassmTimeoutParams
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmPcdCcCapwapReassmTimeoutParams
argument_list|)
argument_list|)
expr_stmt|;
name|BUILD_FD
argument_list|(
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|EnQFrm
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|fmFd
argument_list|,
operator|&
name|p_HcFrame
operator|->
name|commandSequence
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|FmPcdUnlock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|t_Error
name|FmHcPcdPlcrCcGetSetParams
parameter_list|(
name|t_Handle
name|h_FmHc
parameter_list|,
name|uint16_t
name|absoluteProfileId
parameter_list|,
name|uint32_t
name|requiredAction
parameter_list|)
block|{
name|t_FmHc
modifier|*
name|p_FmHc
init|=
operator|(
name|t_FmHc
operator|*
operator|)
name|h_FmHc
decl_stmt|;
name|t_HcFrame
modifier|*
name|p_HcFrame
decl_stmt|;
name|t_DpaaFD
name|fmFd
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|uint32_t
name|tmpReg32
init|=
literal|0
decl_stmt|;
name|uint32_t
name|requiredActionTmp
decl_stmt|,
name|pointedOwnersTmp
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|h_FmHc
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|absoluteProfileId
operator|>=
name|FM_PCD_PLCR_NUM_ENTRIES
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Policer profile out of range"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|FmPcdPlcrProfileTryLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|,
name|FALSE
argument_list|)
condition|)
return|return
name|ERROR_CODE
argument_list|(
name|E_BUSY
argument_list|)
return|;
name|requiredActionTmp
operator|=
name|FmPcdPlcrGetRequiredAction
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|pointedOwnersTmp
operator|=
name|FmPcdPlcrGetPointedOwners
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pointedOwnersTmp
operator|||
operator|!
operator|(
name|requiredActionTmp
operator|&
name|requiredAction
operator|)
condition|)
block|{
if|if
condition|(
name|requiredAction
operator|&
name|UPDATE_NIA_ENQ_WITHOUT_DMA
condition|)
block|{
name|p_HcFrame
operator|=
operator|(
name|t_HcFrame
operator|*
operator|)
name|XX_MallocSmart
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
operator|+
name|p_FmHc
operator|->
name|padTill16
operator|)
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_HcFrame
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"HC Frame obj"
operator|)
argument_list|)
expr_stmt|;
comment|/* first read scheme and check that it is valid */
name|memset
argument_list|(
name|p_HcFrame
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|opcode
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|HC_HCOR_GBL
operator||
name|HC_HCOR_OPCODE_PLCR_PRFL
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator|=
name|FmPcdPlcrBuildReadPlcrActionReg
argument_list|(
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|extraReg
operator|=
literal|0x00008000
expr_stmt|;
name|BUILD_FD
argument_list|(
name|SIZE_OF_HC_FRAME_READ_OR_CC_DYNAMIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|EnQFrm
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|fmFd
argument_list|,
operator|&
name|p_HcFrame
operator|->
name|commandSequence
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|FmPcdPlcrReleaseProfileLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
comment|/* check that profile is valid */
if|if
condition|(
operator|!
name|FmPcdPlcrHwProfileIsValid
argument_list|(
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|profileRegs
operator|.
name|fmpl_pemode
argument_list|)
condition|)
block|{
name|FmPcdPlcrReleaseProfileLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_ALREADY_EXISTS
argument_list|,
operator|(
literal|"Policer is already used"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tmpReg32
operator|=
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|profileRegs
operator|.
name|fmpl_pegnia
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tmpReg32
operator|&
operator|(
name|NIA_ENG_BMI
operator||
name|NIA_BMI_AC_ENQ_FRAME
operator|)
operator|)
condition|)
block|{
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Next engine of this policer profile has to be assigned to FM_PCD_DONE"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tmpReg32
operator||=
name|NIA_BMI_AC_ENQ_FRAME_WITHOUT_DMA
expr_stmt|;
name|p_HcFrame
operator|->
name|opcode
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|HC_HCOR_GBL
operator||
name|HC_HCOR_OPCODE_PLCR_PRFL
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator|=
name|FmPcdPlcrBuildWritePlcrActionReg
argument_list|(
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator||=
name|FmPcdPlcrBuildNiaProfileReg
argument_list|(
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|extraReg
operator|=
literal|0x00008000
expr_stmt|;
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|singleRegForWrite
operator|=
name|tmpReg32
expr_stmt|;
name|BUILD_FD
argument_list|(
name|SIZE_OF_HC_FRAME_PROFILE_CNT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|EnQFrm
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|fmFd
argument_list|,
operator|&
name|p_HcFrame
operator|->
name|commandSequence
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|FmPcdPlcrReleaseProfileLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|tmpReg32
operator|=
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|profileRegs
operator|.
name|fmpl_peynia
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tmpReg32
operator|&
operator|(
name|NIA_ENG_BMI
operator||
name|NIA_BMI_AC_ENQ_FRAME
operator|)
operator|)
condition|)
block|{
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Next engine of this policer profile has to be assigned to FM_PCD_DONE"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tmpReg32
operator||=
name|NIA_BMI_AC_ENQ_FRAME_WITHOUT_DMA
expr_stmt|;
name|p_HcFrame
operator|->
name|opcode
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|HC_HCOR_GBL
operator||
name|HC_HCOR_OPCODE_PLCR_PRFL
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator|=
name|FmPcdPlcrBuildWritePlcrActionReg
argument_list|(
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator||=
name|FmPcdPlcrBuildNiaProfileReg
argument_list|(
name|FALSE
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|extraReg
operator|=
literal|0x00008000
expr_stmt|;
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|singleRegForWrite
operator|=
name|tmpReg32
expr_stmt|;
name|BUILD_FD
argument_list|(
name|SIZE_OF_HC_FRAME_PROFILE_CNT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|EnQFrm
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|fmFd
argument_list|,
operator|&
name|p_HcFrame
operator|->
name|commandSequence
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|FmPcdPlcrReleaseProfileLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|tmpReg32
operator|=
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|profileRegs
operator|.
name|fmpl_pernia
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tmpReg32
operator|&
operator|(
name|NIA_ENG_BMI
operator||
name|NIA_BMI_AC_ENQ_FRAME
operator|)
operator|)
condition|)
block|{
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Next engine of this policer profile has to be assigned to FM_PCD_DONE"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tmpReg32
operator||=
name|NIA_BMI_AC_ENQ_FRAME_WITHOUT_DMA
expr_stmt|;
name|p_HcFrame
operator|->
name|opcode
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|HC_HCOR_GBL
operator||
name|HC_HCOR_OPCODE_PLCR_PRFL
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator|=
name|FmPcdPlcrBuildWritePlcrActionReg
argument_list|(
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator||=
name|FmPcdPlcrBuildNiaProfileReg
argument_list|(
name|FALSE
argument_list|,
name|FALSE
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|extraReg
operator|=
literal|0x00008000
expr_stmt|;
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|singleRegForWrite
operator|=
name|tmpReg32
expr_stmt|;
name|BUILD_FD
argument_list|(
name|SIZE_OF_HC_FRAME_PROFILE_CNT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|EnQFrm
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|fmFd
argument_list|,
operator|&
name|p_HcFrame
operator|->
name|commandSequence
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|FmPcdPlcrReleaseProfileLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
block|}
block|}
name|FmPcdPlcrUpatePointedOwner
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|FmPcdPlcrUpdateRequiredAction
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|,
name|requiredAction
argument_list|)
expr_stmt|;
name|FmPcdPlcrReleaseProfileLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Handle
name|FmHcPcdPlcrSetProfile
parameter_list|(
name|t_Handle
name|h_FmHc
parameter_list|,
name|t_FmPcdPlcrProfileParams
modifier|*
name|p_Profile
parameter_list|)
block|{
name|t_FmHc
modifier|*
name|p_FmHc
init|=
operator|(
name|t_FmHc
operator|*
operator|)
name|h_FmHc
decl_stmt|;
name|t_FmPcdPlcrInterModuleProfileRegs
name|profileRegs
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|uint32_t
name|intFlags
decl_stmt|;
name|uint16_t
name|profileIndx
decl_stmt|;
name|t_HcFrame
modifier|*
name|p_HcFrame
decl_stmt|;
name|t_DpaaFD
name|fmFd
decl_stmt|;
if|if
condition|(
name|p_Profile
operator|->
name|modify
condition|)
block|{
name|profileIndx
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|PTR_TO_UINT
argument_list|(
name|p_Profile
operator|->
name|id
operator|.
name|h_Profile
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|FmPcdPlcrProfileTryLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|profileIndx
argument_list|,
name|FALSE
argument_list|)
condition|)
return|return
name|NULL
return|;
block|}
else|else
block|{
name|intFlags
operator|=
name|FmPcdLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|)
expr_stmt|;
name|err
operator|=
name|FmPcdPlcrGetAbsoluteProfileId
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|p_Profile
operator|->
name|id
operator|.
name|newParams
operator|.
name|profileType
argument_list|,
name|p_Profile
operator|->
name|id
operator|.
name|newParams
operator|.
name|h_FmPort
argument_list|,
name|p_Profile
operator|->
name|id
operator|.
name|newParams
operator|.
name|relativeProfileId
argument_list|,
operator|&
name|profileIndx
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|err
operator|=
name|FmPcdPlcrProfileTryLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|profileIndx
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|FmPcdUnlock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|NULL
return|;
block|}
name|p_HcFrame
operator|=
operator|(
name|t_HcFrame
operator|*
operator|)
name|XX_MallocSmart
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
operator|+
name|p_FmHc
operator|->
name|padTill16
operator|)
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_HcFrame
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"HC Frame obj"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|p_Profile
operator|->
name|modify
condition|)
block|{
name|memset
argument_list|(
name|p_HcFrame
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|opcode
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|HC_HCOR_GBL
operator||
name|HC_HCOR_OPCODE_PLCR_PRFL
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator|=
name|FmPcdPlcrBuildReadPlcrActionReg
argument_list|(
name|profileIndx
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|extraReg
operator|=
literal|0x00008000
expr_stmt|;
name|BUILD_FD
argument_list|(
name|SIZE_OF_HC_FRAME_READ_OR_CC_DYNAMIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|EnQFrm
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|fmFd
argument_list|,
operator|&
name|p_HcFrame
operator|->
name|commandSequence
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|FmPcdPlcrReleaseProfileLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|profileIndx
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* check if this scheme is already used */
if|if
condition|(
name|FmPcdPlcrHwProfileIsValid
argument_list|(
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|profileRegs
operator|.
name|fmpl_pemode
argument_list|)
condition|)
block|{
name|FmPcdPlcrReleaseProfileLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|profileIndx
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_ALREADY_EXISTS
argument_list|,
operator|(
literal|"Policer is already used"
operator|)
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
name|memset
argument_list|(
operator|&
name|profileRegs
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmPcdPlcrInterModuleProfileRegs
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|FmPcdPlcrBuildProfile
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|p_Profile
argument_list|,
operator|&
name|profileRegs
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|FmPcdPlcrReleaseProfileLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|profileIndx
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_HcFrame
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|opcode
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|HC_HCOR_GBL
operator||
name|HC_HCOR_OPCODE_PLCR_PRFL
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator|=
name|FmPcdPlcrBuildWritePlcrActionRegs
argument_list|(
name|profileIndx
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|extraReg
operator|=
literal|0x00008000
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|profileRegs
argument_list|,
operator|&
name|profileRegs
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmPcdPlcrInterModuleProfileRegs
argument_list|)
argument_list|)
expr_stmt|;
name|BUILD_FD
argument_list|(
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|EnQFrm
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|fmFd
argument_list|,
operator|&
name|p_HcFrame
operator|->
name|commandSequence
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|FmPcdPlcrReleaseProfileLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|profileIndx
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|FmPcdPlcrValidateProfileSw
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|profileIndx
argument_list|)
expr_stmt|;
name|FmPcdPlcrReleaseProfileLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|profileIndx
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
name|UINT_TO_PTR
argument_list|(
operator|(
name|uint64_t
operator|)
name|profileIndx
operator|+
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
name|t_Error
name|FmHcPcdPlcrDeleteProfile
parameter_list|(
name|t_Handle
name|h_FmHc
parameter_list|,
name|t_Handle
name|h_Profile
parameter_list|)
block|{
name|t_FmHc
modifier|*
name|p_FmHc
init|=
operator|(
name|t_FmHc
operator|*
operator|)
name|h_FmHc
decl_stmt|;
name|uint16_t
name|absoluteProfileId
init|=
call|(
name|uint16_t
call|)
argument_list|(
name|PTR_TO_UINT
argument_list|(
name|h_Profile
argument_list|)
operator|-
literal|1
argument_list|)
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|t_HcFrame
modifier|*
name|p_HcFrame
decl_stmt|;
name|t_DpaaFD
name|fmFd
decl_stmt|;
if|if
condition|(
name|FmPcdPlcrProfileTryLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|,
name|FALSE
argument_list|)
condition|)
return|return
name|ERROR_CODE
argument_list|(
name|E_BUSY
argument_list|)
return|;
name|FmPcdPlcrInvalidateProfileSw
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|=
operator|(
name|t_HcFrame
operator|*
operator|)
name|XX_MallocSmart
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
operator|+
name|p_FmHc
operator|->
name|padTill16
operator|)
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_HcFrame
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"HC Frame obj"
operator|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p_HcFrame
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|opcode
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|HC_HCOR_GBL
operator||
name|HC_HCOR_OPCODE_PLCR_PRFL
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator|=
name|FmPcdPlcrBuildWritePlcrActionReg
argument_list|(
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator||=
literal|0x00008000
expr_stmt|;
name|p_HcFrame
operator|->
name|extraReg
operator|=
literal|0x00008000
expr_stmt|;
name|memset
argument_list|(
operator|&
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|profileRegs
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmPcdPlcrInterModuleProfileRegs
argument_list|)
argument_list|)
expr_stmt|;
name|BUILD_FD
argument_list|(
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|EnQFrm
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|fmFd
argument_list|,
operator|&
name|p_HcFrame
operator|->
name|commandSequence
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|FmPcdPlcrReleaseProfileLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|FmPcdPlcrReleaseProfileLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FmHcPcdPlcrSetProfileCounter
parameter_list|(
name|t_Handle
name|h_FmHc
parameter_list|,
name|t_Handle
name|h_Profile
parameter_list|,
name|e_FmPcdPlcrProfileCounters
name|counter
parameter_list|,
name|uint32_t
name|value
parameter_list|)
block|{
name|t_FmHc
modifier|*
name|p_FmHc
init|=
operator|(
name|t_FmHc
operator|*
operator|)
name|h_FmHc
decl_stmt|;
name|uint16_t
name|absoluteProfileId
init|=
call|(
name|uint16_t
call|)
argument_list|(
name|PTR_TO_UINT
argument_list|(
name|h_Profile
argument_list|)
operator|-
literal|1
argument_list|)
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|t_HcFrame
modifier|*
name|p_HcFrame
decl_stmt|;
name|t_DpaaFD
name|fmFd
decl_stmt|;
if|if
condition|(
name|FmPcdPlcrProfileTryLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|,
name|FALSE
argument_list|)
condition|)
return|return
name|ERROR_CODE
argument_list|(
name|E_BUSY
argument_list|)
return|;
comment|/* first read scheme and check that it is valid */
name|p_HcFrame
operator|=
operator|(
name|t_HcFrame
operator|*
operator|)
name|XX_MallocSmart
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
operator|+
name|p_FmHc
operator|->
name|padTill16
operator|)
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_HcFrame
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"HC Frame obj"
operator|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p_HcFrame
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|opcode
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|HC_HCOR_GBL
operator||
name|HC_HCOR_OPCODE_PLCR_PRFL
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator|=
name|FmPcdPlcrBuildReadPlcrActionReg
argument_list|(
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|extraReg
operator|=
literal|0x00008000
expr_stmt|;
name|BUILD_FD
argument_list|(
name|SIZE_OF_HC_FRAME_READ_OR_CC_DYNAMIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|EnQFrm
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|fmFd
argument_list|,
operator|&
name|p_HcFrame
operator|->
name|commandSequence
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|FmPcdPlcrReleaseProfileLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
comment|/* check that profile is valid */
if|if
condition|(
operator|!
name|FmPcdPlcrHwProfileIsValid
argument_list|(
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|profileRegs
operator|.
name|fmpl_pemode
argument_list|)
condition|)
block|{
name|FmPcdPlcrReleaseProfileLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_ALREADY_EXISTS
argument_list|,
operator|(
literal|"Policer is already used"
operator|)
argument_list|)
expr_stmt|;
block|}
name|p_HcFrame
operator|->
name|opcode
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|HC_HCOR_GBL
operator||
name|HC_HCOR_OPCODE_PLCR_PRFL
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator|=
name|FmPcdPlcrBuildWritePlcrActionReg
argument_list|(
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator||=
name|FmPcdPlcrBuildCounterProfileReg
argument_list|(
name|counter
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|extraReg
operator|=
literal|0x00008000
expr_stmt|;
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|singleRegForWrite
operator|=
name|value
expr_stmt|;
name|BUILD_FD
argument_list|(
name|SIZE_OF_HC_FRAME_PROFILE_CNT
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|EnQFrm
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|fmFd
argument_list|,
operator|&
name|p_HcFrame
operator|->
name|commandSequence
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|FmPcdPlcrReleaseProfileLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|FmPcdPlcrReleaseProfileLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|uint32_t
name|FmHcPcdPlcrGetProfileCounter
parameter_list|(
name|t_Handle
name|h_FmHc
parameter_list|,
name|t_Handle
name|h_Profile
parameter_list|,
name|e_FmPcdPlcrProfileCounters
name|counter
parameter_list|)
block|{
name|t_FmHc
modifier|*
name|p_FmHc
init|=
operator|(
name|t_FmHc
operator|*
operator|)
name|h_FmHc
decl_stmt|;
name|uint16_t
name|absoluteProfileId
init|=
call|(
name|uint16_t
call|)
argument_list|(
name|PTR_TO_UINT
argument_list|(
name|h_Profile
argument_list|)
operator|-
literal|1
argument_list|)
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|t_HcFrame
modifier|*
name|p_HcFrame
decl_stmt|;
name|t_DpaaFD
name|fmFd
decl_stmt|;
name|uint32_t
name|retVal
init|=
literal|0
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|h_FmHc
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|FmPcdPlcrProfileTryLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|,
name|FALSE
argument_list|)
condition|)
return|return
literal|0
return|;
comment|/* first read scheme and check that it is valid */
name|p_HcFrame
operator|=
operator|(
name|t_HcFrame
operator|*
operator|)
name|XX_MallocSmart
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
operator|+
name|p_FmHc
operator|->
name|padTill16
operator|)
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_HcFrame
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"HC Frame obj"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|memset
argument_list|(
name|p_HcFrame
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|opcode
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|HC_HCOR_GBL
operator||
name|HC_HCOR_OPCODE_PLCR_PRFL
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator|=
name|FmPcdPlcrBuildReadPlcrActionReg
argument_list|(
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|extraReg
operator|=
literal|0x00008000
expr_stmt|;
name|BUILD_FD
argument_list|(
name|SIZE_OF_HC_FRAME_READ_OR_CC_DYNAMIC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|EnQFrm
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|fmFd
argument_list|,
operator|&
name|p_HcFrame
operator|->
name|commandSequence
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|FmPcdPlcrReleaseProfileLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* check that profile is valid */
if|if
condition|(
operator|!
name|FmPcdPlcrHwProfileIsValid
argument_list|(
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|profileRegs
operator|.
name|fmpl_pemode
argument_list|)
condition|)
block|{
name|FmPcdPlcrReleaseProfileLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_ALREADY_EXISTS
argument_list|,
operator|(
literal|"invalid Policer profile"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
switch|switch
condition|(
name|counter
condition|)
block|{
case|case
name|e_FM_PCD_PLCR_PROFILE_GREEN_PACKET_TOTAL_COUNTER
case|:
name|retVal
operator|=
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|profileRegs
operator|.
name|fmpl_pegpc
expr_stmt|;
break|break;
case|case
name|e_FM_PCD_PLCR_PROFILE_YELLOW_PACKET_TOTAL_COUNTER
case|:
name|retVal
operator|=
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|profileRegs
operator|.
name|fmpl_peypc
expr_stmt|;
break|break;
case|case
name|e_FM_PCD_PLCR_PROFILE_RED_PACKET_TOTAL_COUNTER
case|:
name|retVal
operator|=
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|profileRegs
operator|.
name|fmpl_perpc
expr_stmt|;
break|break;
case|case
name|e_FM_PCD_PLCR_PROFILE_RECOLOURED_YELLOW_PACKET_TOTAL_COUNTER
case|:
name|retVal
operator|=
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|profileRegs
operator|.
name|fmpl_perypc
expr_stmt|;
break|break;
case|case
name|e_FM_PCD_PLCR_PROFILE_RECOLOURED_RED_PACKET_TOTAL_COUNTER
case|:
name|retVal
operator|=
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|profileRegs
operator|.
name|fmpl_perrpc
expr_stmt|;
break|break;
default|default:
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|FmPcdPlcrReleaseProfileLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
name|retVal
return|;
block|}
end_function

begin_function
name|t_Error
name|FmHcPcdCcModifyTreeNextEngine
parameter_list|(
name|t_Handle
name|h_FmHc
parameter_list|,
name|t_Handle
name|h_CcTree
parameter_list|,
name|uint8_t
name|grpId
parameter_list|,
name|uint8_t
name|index
parameter_list|,
name|t_FmPcdCcNextEngineParams
modifier|*
name|p_FmPcdCcNextEngineParams
parameter_list|)
block|{
name|t_FmHc
modifier|*
name|p_FmHc
init|=
operator|(
name|t_FmHc
operator|*
operator|)
name|h_FmHc
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|uint32_t
name|intFlags
decl_stmt|;
name|t_List
name|h_OldPointersLst
decl_stmt|,
name|h_NewPointersLst
decl_stmt|;
name|t_Handle
name|h_Params
decl_stmt|;
name|intFlags
operator|=
name|FmPcdLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|)
expr_stmt|;
name|err
operator|=
name|FmPcdCcTreeTryLock
argument_list|(
name|h_CcTree
argument_list|)
expr_stmt|;
name|FmPcdUnlock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|err
return|;
name|INIT_LIST
argument_list|(
operator|&
name|h_OldPointersLst
argument_list|)
expr_stmt|;
name|INIT_LIST
argument_list|(
operator|&
name|h_NewPointersLst
argument_list|)
expr_stmt|;
name|err
operator|=
name|FmPcdCcModifyNextEngineParamTree
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|h_CcTree
argument_list|,
name|grpId
argument_list|,
name|index
argument_list|,
name|p_FmPcdCcNextEngineParams
argument_list|,
operator|&
name|h_OldPointersLst
argument_list|,
operator|&
name|h_NewPointersLst
argument_list|,
operator|&
name|h_Params
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|FmPcdCcTreeReleaseLock
argument_list|(
name|h_CcTree
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|HcDynamicChange
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|h_OldPointersLst
argument_list|,
operator|&
name|h_NewPointersLst
argument_list|,
operator|&
name|h_Params
argument_list|)
expr_stmt|;
name|FmPcdCcTreeReleaseLock
argument_list|(
name|h_CcTree
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|t_Error
name|FmHcPcdCcModifyNodeMissNextEngine
parameter_list|(
name|t_Handle
name|h_FmHc
parameter_list|,
name|t_Handle
name|h_CcNode
parameter_list|,
name|t_FmPcdCcNextEngineParams
modifier|*
name|p_FmPcdCcNextEngineParams
parameter_list|)
block|{
name|t_FmHc
modifier|*
name|p_FmHc
init|=
operator|(
name|t_FmHc
operator|*
operator|)
name|h_FmHc
decl_stmt|;
name|t_Handle
name|h_Params
decl_stmt|;
name|t_List
name|h_OldPointersLst
decl_stmt|,
name|h_NewPointersLst
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|t_List
name|h_List
decl_stmt|;
name|uint32_t
name|intFlags
decl_stmt|;
name|INIT_LIST
argument_list|(
operator|&
name|h_List
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|FmPcdLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|FmPcdCcNodeTreeTryLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|h_CcNode
argument_list|,
operator|&
name|h_List
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|FmPcdUnlock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
name|FmPcdUnlock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|INIT_LIST
argument_list|(
operator|&
name|h_OldPointersLst
argument_list|)
expr_stmt|;
name|INIT_LIST
argument_list|(
operator|&
name|h_NewPointersLst
argument_list|)
expr_stmt|;
name|err
operator|=
name|FmPcdCcModifyMissNextEngineParamNode
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|h_CcNode
argument_list|,
name|p_FmPcdCcNextEngineParams
argument_list|,
operator|&
name|h_OldPointersLst
argument_list|,
operator|&
name|h_NewPointersLst
argument_list|,
operator|&
name|h_Params
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|FmPcdCcNodeTreeReleaseLock
argument_list|(
operator|&
name|h_List
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|HcDynamicChange
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|h_OldPointersLst
argument_list|,
operator|&
name|h_NewPointersLst
argument_list|,
operator|&
name|h_Params
argument_list|)
expr_stmt|;
name|FmPcdCcNodeTreeReleaseLock
argument_list|(
operator|&
name|h_List
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FmHcPcdCcRemoveKey
parameter_list|(
name|t_Handle
name|h_FmHc
parameter_list|,
name|t_Handle
name|h_CcNode
parameter_list|,
name|uint8_t
name|keyIndex
parameter_list|)
block|{
name|t_FmHc
modifier|*
name|p_FmHc
init|=
operator|(
name|t_FmHc
operator|*
operator|)
name|h_FmHc
decl_stmt|;
name|t_Handle
name|h_Params
decl_stmt|;
name|t_List
name|h_OldPointersLst
decl_stmt|,
name|h_NewPointersLst
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|t_List
name|h_List
decl_stmt|;
name|uint32_t
name|intFlags
decl_stmt|;
name|INIT_LIST
argument_list|(
operator|&
name|h_List
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|FmPcdLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|FmPcdCcNodeTreeTryLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|h_CcNode
argument_list|,
operator|&
name|h_List
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|FmPcdUnlock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
name|FmPcdUnlock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|INIT_LIST
argument_list|(
operator|&
name|h_OldPointersLst
argument_list|)
expr_stmt|;
name|INIT_LIST
argument_list|(
operator|&
name|h_NewPointersLst
argument_list|)
expr_stmt|;
name|err
operator|=
name|FmPcdCcRemoveKey
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|h_CcNode
argument_list|,
name|keyIndex
argument_list|,
operator|&
name|h_OldPointersLst
argument_list|,
operator|&
name|h_NewPointersLst
argument_list|,
operator|&
name|h_Params
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|FmPcdCcNodeTreeReleaseLock
argument_list|(
operator|&
name|h_List
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|HcDynamicChange
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|h_OldPointersLst
argument_list|,
operator|&
name|h_NewPointersLst
argument_list|,
operator|&
name|h_Params
argument_list|)
expr_stmt|;
name|FmPcdCcNodeTreeReleaseLock
argument_list|(
operator|&
name|h_List
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|t_Error
name|FmHcPcdCcAddKey
parameter_list|(
name|t_Handle
name|h_FmHc
parameter_list|,
name|t_Handle
name|h_CcNode
parameter_list|,
name|uint8_t
name|keyIndex
parameter_list|,
name|uint8_t
name|keySize
parameter_list|,
name|t_FmPcdCcKeyParams
modifier|*
name|p_KeyParams
parameter_list|)
block|{
name|t_FmHc
modifier|*
name|p_FmHc
init|=
operator|(
name|t_FmHc
operator|*
operator|)
name|h_FmHc
decl_stmt|;
name|t_Handle
name|h_Params
decl_stmt|;
name|t_List
name|h_OldPointersLst
decl_stmt|,
name|h_NewPointersLst
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|t_List
name|h_List
decl_stmt|;
name|uint32_t
name|intFlags
decl_stmt|;
name|INIT_LIST
argument_list|(
operator|&
name|h_List
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|FmPcdLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|FmPcdCcNodeTreeTryLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|h_CcNode
argument_list|,
operator|&
name|h_List
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|FmPcdUnlock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
name|FmPcdUnlock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|INIT_LIST
argument_list|(
operator|&
name|h_OldPointersLst
argument_list|)
expr_stmt|;
name|INIT_LIST
argument_list|(
operator|&
name|h_NewPointersLst
argument_list|)
expr_stmt|;
name|err
operator|=
name|FmPcdCcAddKey
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|h_CcNode
argument_list|,
name|keyIndex
argument_list|,
name|keySize
argument_list|,
name|p_KeyParams
argument_list|,
operator|&
name|h_OldPointersLst
argument_list|,
operator|&
name|h_NewPointersLst
argument_list|,
operator|&
name|h_Params
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|FmPcdCcNodeTreeReleaseLock
argument_list|(
operator|&
name|h_List
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|HcDynamicChange
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|h_OldPointersLst
argument_list|,
operator|&
name|h_NewPointersLst
argument_list|,
operator|&
name|h_Params
argument_list|)
expr_stmt|;
name|FmPcdCcNodeTreeReleaseLock
argument_list|(
operator|&
name|h_List
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|t_Error
name|FmHcPcdCcModifyKey
parameter_list|(
name|t_Handle
name|h_FmHc
parameter_list|,
name|t_Handle
name|h_CcNode
parameter_list|,
name|uint8_t
name|keyIndex
parameter_list|,
name|uint8_t
name|keySize
parameter_list|,
name|uint8_t
modifier|*
name|p_Key
parameter_list|,
name|uint8_t
modifier|*
name|p_Mask
parameter_list|)
block|{
name|t_FmHc
modifier|*
name|p_FmHc
init|=
operator|(
name|t_FmHc
operator|*
operator|)
name|h_FmHc
decl_stmt|;
name|t_List
name|h_OldPointersLst
decl_stmt|,
name|h_NewPointersLst
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|t_List
name|h_List
decl_stmt|;
name|uint32_t
name|intFlags
decl_stmt|;
name|t_Handle
name|h_Params
decl_stmt|;
name|UNUSED
argument_list|(
name|keySize
argument_list|)
expr_stmt|;
name|INIT_LIST
argument_list|(
operator|&
name|h_List
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|FmPcdLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|FmPcdCcNodeTreeTryLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|h_CcNode
argument_list|,
operator|&
name|h_List
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|FmPcdUnlock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
name|FmPcdUnlock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|INIT_LIST
argument_list|(
operator|&
name|h_OldPointersLst
argument_list|)
expr_stmt|;
name|INIT_LIST
argument_list|(
operator|&
name|h_NewPointersLst
argument_list|)
expr_stmt|;
name|err
operator|=
name|FmPcdCcModifyKey
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|h_CcNode
argument_list|,
name|keyIndex
argument_list|,
name|keySize
argument_list|,
name|p_Key
argument_list|,
name|p_Mask
argument_list|,
operator|&
name|h_OldPointersLst
argument_list|,
operator|&
name|h_NewPointersLst
argument_list|,
operator|&
name|h_Params
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|FmPcdCcNodeTreeReleaseLock
argument_list|(
operator|&
name|h_List
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|HcDynamicChange
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|h_OldPointersLst
argument_list|,
operator|&
name|h_NewPointersLst
argument_list|,
operator|&
name|h_Params
argument_list|)
expr_stmt|;
name|FmPcdCcNodeTreeReleaseLock
argument_list|(
operator|&
name|h_List
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|t_Error
name|FmHcPcdCcModifyNodeNextEngine
parameter_list|(
name|t_Handle
name|h_FmHc
parameter_list|,
name|t_Handle
name|h_CcNode
parameter_list|,
name|uint8_t
name|keyIndex
parameter_list|,
name|t_FmPcdCcNextEngineParams
modifier|*
name|p_FmPcdCcNextEngineParams
parameter_list|)
block|{
name|t_FmHc
modifier|*
name|p_FmHc
init|=
operator|(
name|t_FmHc
operator|*
operator|)
name|h_FmHc
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|t_List
name|h_OldPointersLst
decl_stmt|,
name|h_NewPointersLst
decl_stmt|;
name|t_List
name|h_List
decl_stmt|;
name|uint32_t
name|intFlags
decl_stmt|;
name|t_Handle
name|h_Params
decl_stmt|;
name|INIT_LIST
argument_list|(
operator|&
name|h_List
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|FmPcdLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|FmPcdCcNodeTreeTryLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|h_CcNode
argument_list|,
operator|&
name|h_List
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|FmPcdUnlock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
name|FmPcdUnlock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|INIT_LIST
argument_list|(
operator|&
name|h_OldPointersLst
argument_list|)
expr_stmt|;
name|INIT_LIST
argument_list|(
operator|&
name|h_NewPointersLst
argument_list|)
expr_stmt|;
name|err
operator|=
name|FmPcdCcModiyNextEngineParamNode
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|h_CcNode
argument_list|,
name|keyIndex
argument_list|,
name|p_FmPcdCcNextEngineParams
argument_list|,
operator|&
name|h_OldPointersLst
argument_list|,
operator|&
name|h_NewPointersLst
argument_list|,
operator|&
name|h_Params
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|FmPcdCcNodeTreeReleaseLock
argument_list|(
operator|&
name|h_List
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|HcDynamicChange
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|h_OldPointersLst
argument_list|,
operator|&
name|h_NewPointersLst
argument_list|,
operator|&
name|h_Params
argument_list|)
expr_stmt|;
name|FmPcdCcNodeTreeReleaseLock
argument_list|(
operator|&
name|h_List
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|t_Error
name|FmHcPcdCcModifyKeyAndNextEngine
parameter_list|(
name|t_Handle
name|h_FmHc
parameter_list|,
name|t_Handle
name|h_CcNode
parameter_list|,
name|uint8_t
name|keyIndex
parameter_list|,
name|uint8_t
name|keySize
parameter_list|,
name|t_FmPcdCcKeyParams
modifier|*
name|p_KeyParams
parameter_list|)
block|{
name|t_FmHc
modifier|*
name|p_FmHc
init|=
operator|(
name|t_FmHc
operator|*
operator|)
name|h_FmHc
decl_stmt|;
name|t_List
name|h_OldPointersLst
decl_stmt|,
name|h_NewPointersLst
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|t_List
name|h_List
decl_stmt|;
name|uint32_t
name|intFlags
decl_stmt|;
name|t_Handle
name|h_Params
decl_stmt|;
name|INIT_LIST
argument_list|(
operator|&
name|h_OldPointersLst
argument_list|)
expr_stmt|;
name|INIT_LIST
argument_list|(
operator|&
name|h_NewPointersLst
argument_list|)
expr_stmt|;
name|INIT_LIST
argument_list|(
operator|&
name|h_List
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|FmPcdLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|FmPcdCcNodeTreeTryLock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|h_CcNode
argument_list|,
operator|&
name|h_List
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|FmPcdUnlock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
name|FmPcdUnlock
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|err
operator|=
name|FmPcdCcModifyKeyAndNextEngine
argument_list|(
name|p_FmHc
operator|->
name|h_FmPcd
argument_list|,
name|h_CcNode
argument_list|,
name|keyIndex
argument_list|,
name|keySize
argument_list|,
name|p_KeyParams
argument_list|,
operator|&
name|h_OldPointersLst
argument_list|,
operator|&
name|h_NewPointersLst
argument_list|,
operator|&
name|h_Params
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|FmPcdCcNodeTreeReleaseLock
argument_list|(
operator|&
name|h_List
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|HcDynamicChange
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|h_OldPointersLst
argument_list|,
operator|&
name|h_NewPointersLst
argument_list|,
operator|&
name|h_Params
argument_list|)
expr_stmt|;
name|FmPcdCcNodeTreeReleaseLock
argument_list|(
operator|&
name|h_List
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|t_Error
name|FmHcKgWriteSp
parameter_list|(
name|t_Handle
name|h_FmHc
parameter_list|,
name|uint8_t
name|hardwarePortId
parameter_list|,
name|uint32_t
name|spReg
parameter_list|,
name|bool
name|add
parameter_list|)
block|{
name|t_FmHc
modifier|*
name|p_FmHc
init|=
operator|(
name|t_FmHc
operator|*
operator|)
name|h_FmHc
decl_stmt|;
name|t_HcFrame
modifier|*
name|p_HcFrame
decl_stmt|;
name|t_DpaaFD
name|fmFd
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_FmHc
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|=
operator|(
name|t_HcFrame
operator|*
operator|)
name|XX_MallocSmart
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
operator|+
name|p_FmHc
operator|->
name|padTill16
operator|)
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_HcFrame
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"HC Frame obj"
operator|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p_HcFrame
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
comment|/* first read SP register */
name|p_HcFrame
operator|->
name|opcode
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|HC_HCOR_GBL
operator||
name|HC_HCOR_OPCODE_KG_SCM
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator|=
name|FmPcdKgBuildReadPortSchemeBindActionReg
argument_list|(
name|hardwarePortId
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|extraReg
operator|=
literal|0xFFFFF800
expr_stmt|;
name|BUILD_FD
argument_list|(
name|SIZE_OF_HC_FRAME_PORT_REGS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|EnQFrm
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|fmFd
argument_list|,
operator|&
name|p_HcFrame
operator|->
name|commandSequence
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
comment|/* spReg is the first reg, so we can use it both for read and for write */
if|if
condition|(
name|add
condition|)
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|portRegsForRead
operator|.
name|spReg
operator||=
name|spReg
expr_stmt|;
else|else
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|portRegsForRead
operator|.
name|spReg
operator|&=
operator|~
name|spReg
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator|=
name|FmPcdKgBuildWritePortSchemeBindActionReg
argument_list|(
name|hardwarePortId
argument_list|)
expr_stmt|;
name|BUILD_FD
argument_list|(
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|EnQFrm
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|fmFd
argument_list|,
operator|&
name|p_HcFrame
operator|->
name|commandSequence
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FmHcKgWriteCpp
parameter_list|(
name|t_Handle
name|h_FmHc
parameter_list|,
name|uint8_t
name|hardwarePortId
parameter_list|,
name|uint32_t
name|cppReg
parameter_list|)
block|{
name|t_FmHc
modifier|*
name|p_FmHc
init|=
operator|(
name|t_FmHc
operator|*
operator|)
name|h_FmHc
decl_stmt|;
name|t_HcFrame
modifier|*
name|p_HcFrame
decl_stmt|;
name|t_DpaaFD
name|fmFd
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_FmHc
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|=
operator|(
name|t_HcFrame
operator|*
operator|)
name|XX_MallocSmart
argument_list|(
operator|(
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
operator|+
name|p_FmHc
operator|->
name|padTill16
operator|)
argument_list|,
literal|0
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_HcFrame
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"HC Frame obj"
operator|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p_HcFrame
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
comment|/* first read SP register */
name|p_HcFrame
operator|->
name|opcode
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|HC_HCOR_GBL
operator||
name|HC_HCOR_OPCODE_KG_SCM
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|actionReg
operator|=
name|FmPcdKgBuildWritePortClsPlanBindActionReg
argument_list|(
name|hardwarePortId
argument_list|)
expr_stmt|;
name|p_HcFrame
operator|->
name|extraReg
operator|=
literal|0xFFFFF800
expr_stmt|;
name|p_HcFrame
operator|->
name|hcSpecificData
operator|.
name|singleRegForWrite
operator|=
name|cppReg
expr_stmt|;
name|BUILD_FD
argument_list|(
sizeof|sizeof
argument_list|(
name|t_HcFrame
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|EnQFrm
argument_list|(
name|p_FmHc
argument_list|,
operator|&
name|fmFd
argument_list|,
operator|&
name|p_HcFrame
operator|->
name|commandSequence
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|XX_FreeSmart
argument_list|(
name|p_HcFrame
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

end_unit


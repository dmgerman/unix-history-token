begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2008-2012 Freescale Semiconductor Inc.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are met:  *     * Redistributions of source code must retain the above copyright  *       notice, this list of conditions and the following disclaimer.  *     * Redistributions in binary form must reproduce the above copyright  *       notice, this list of conditions and the following disclaimer in the  *       documentation and/or other materials provided with the distribution.  *     * Neither the name of Freescale Semiconductor nor the  *       names of its contributors may be used to endorse or promote products  *       derived from this software without specific prior written permission.  *  *  * ALTERNATIVELY, this software may be distributed under the terms of the  * GNU General Public License ("GPL") as published by the Free Software  * Foundation, either version 2 of that License or (at your option) any  * later version.  *  * THIS SOFTWARE IS PROVIDED BY Freescale Semiconductor ``AS IS'' AND ANY  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED. IN NO EVENT SHALL Freescale Semiconductor BE LIABLE FOR ANY  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/******************************************************************************  @File          fm.c   @Description   FM driver routines implementation. */
end_comment

begin_comment
comment|/***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|"std_ext.h"
end_include

begin_include
include|#
directive|include
file|"error_ext.h"
end_include

begin_include
include|#
directive|include
file|"xx_ext.h"
end_include

begin_include
include|#
directive|include
file|"string_ext.h"
end_include

begin_include
include|#
directive|include
file|"sprint_ext.h"
end_include

begin_include
include|#
directive|include
file|"debug_ext.h"
end_include

begin_include
include|#
directive|include
file|"fm_muram_ext.h"
end_include

begin_include
include|#
directive|include
file|<linux/math64.h>
end_include

begin_include
include|#
directive|include
file|"fm_common.h"
end_include

begin_include
include|#
directive|include
file|"fm_ipc.h"
end_include

begin_include
include|#
directive|include
file|"fm.h"
end_include

begin_include
include|#
directive|include
file|"fsl_fman.h"
end_include

begin_comment
comment|/****************************************/
end_comment

begin_comment
comment|/*       static functions               */
end_comment

begin_comment
comment|/****************************************/
end_comment

begin_decl_stmt
specifier|static
specifier|volatile
name|bool
name|blockingFlag
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|IpcMsgCompletionCB
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint8_t
modifier|*
name|p_Msg
parameter_list|,
name|uint8_t
modifier|*
name|p_Reply
parameter_list|,
name|uint32_t
name|replyLength
parameter_list|,
name|t_Error
name|status
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|h_Fm
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|p_Msg
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|p_Reply
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|replyLength
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|status
argument_list|)
expr_stmt|;
name|blockingFlag
operator|=
name|FALSE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|FreeInitResources
parameter_list|(
name|t_Fm
modifier|*
name|p_Fm
parameter_list|)
block|{
if|if
condition|(
name|p_Fm
operator|->
name|camBaseAddr
condition|)
name|FM_MURAM_FreeMem
argument_list|(
name|p_Fm
operator|->
name|h_FmMuram
argument_list|,
name|UINT_TO_PTR
argument_list|(
name|p_Fm
operator|->
name|camBaseAddr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|fifoBaseAddr
condition|)
name|FM_MURAM_FreeMem
argument_list|(
name|p_Fm
operator|->
name|h_FmMuram
argument_list|,
name|UINT_TO_PTR
argument_list|(
name|p_Fm
operator|->
name|fifoBaseAddr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|resAddr
condition|)
name|FM_MURAM_FreeMem
argument_list|(
name|p_Fm
operator|->
name|h_FmMuram
argument_list|,
name|UINT_TO_PTR
argument_list|(
name|p_Fm
operator|->
name|resAddr
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|bool
name|IsFmanCtrlCodeLoaded
parameter_list|(
name|t_Fm
modifier|*
name|p_Fm
parameter_list|)
block|{
name|t_FMIramRegs
modifier|*
name|p_Iram
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
name|p_Iram
operator|=
operator|(
name|t_FMIramRegs
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|p_Fm
operator|->
name|baseAddr
operator|+
name|FM_MM_IMEM
argument_list|)
expr_stmt|;
return|return
operator|(
name|bool
operator|)
operator|!
operator|!
operator|(
name|GET_UINT32
argument_list|(
name|p_Iram
operator|->
name|iready
argument_list|)
operator|&
name|IRAM_READY
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|CheckFmParameters
parameter_list|(
name|t_Fm
modifier|*
name|p_Fm
parameter_list|)
block|{
if|if
condition|(
name|IsFmanCtrlCodeLoaded
argument_list|(
name|p_Fm
argument_list|)
operator|&&
operator|!
name|p_Fm
operator|->
name|resetOnInit
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Old FMan CTRL code is loaded; FM must be reset!"
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|DPAA_VERSION
operator|<
literal|11
operator|)
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_axi_dbg_num_of_beats
operator|||
operator|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_axi_dbg_num_of_beats
operator|>
name|DMA_MODE_MAX_AXI_DBG_NUM_OF_BEATS
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"axiDbgNumOfBeats has to be in the range 1 - %d"
operator|,
name|DMA_MODE_MAX_AXI_DBG_NUM_OF_BEATS
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* (DPAA_VERSION< 11) */
if|if
condition|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_cam_num_of_entries
operator|%
name|DMA_CAM_UNITS
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"dma_cam_num_of_entries has to be divisble by %d"
operator|,
name|DMA_CAM_UNITS
operator|)
argument_list|)
expr_stmt|;
comment|//    if (!p_Fm->p_FmDriverParam->dma_cam_num_of_entries || (p_Fm->p_FmDriverParam->dma_cam_num_of_entries> DMA_MODE_MAX_CAM_NUM_OF_ENTRIES))
comment|//        RETURN_ERROR(MAJOR, E_INVALID_VALUE, ("dma_cam_num_of_entries has to be in the range 1 - %d", DMA_MODE_MAX_CAM_NUM_OF_ENTRIES));
if|if
condition|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_comm_qtsh_asrt_emer
operator|>
name|DMA_THRESH_MAX_COMMQ
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"dma_comm_qtsh_asrt_emer can not be larger than %d"
operator|,
name|DMA_THRESH_MAX_COMMQ
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_comm_qtsh_clr_emer
operator|>
name|DMA_THRESH_MAX_COMMQ
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"dma_comm_qtsh_clr_emer can not be larger than %d"
operator|,
name|DMA_THRESH_MAX_COMMQ
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_comm_qtsh_clr_emer
operator|>=
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_comm_qtsh_asrt_emer
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"dma_comm_qtsh_clr_emer must be smaller than dma_comm_qtsh_asrt_emer"
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|DPAA_VERSION
operator|<
literal|11
operator|)
if|if
condition|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_read_buf_tsh_asrt_emer
operator|>
name|DMA_THRESH_MAX_BUF
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"dma_read_buf_tsh_asrt_emer can not be larger than %d"
operator|,
name|DMA_THRESH_MAX_BUF
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_read_buf_tsh_clr_emer
operator|>
name|DMA_THRESH_MAX_BUF
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"dma_read_buf_tsh_clr_emer can not be larger than %d"
operator|,
name|DMA_THRESH_MAX_BUF
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_read_buf_tsh_clr_emer
operator|>=
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_read_buf_tsh_asrt_emer
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"dma_read_buf_tsh_clr_emer must be smaller than dma_read_buf_tsh_asrt_emer"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_write_buf_tsh_asrt_emer
operator|>
name|DMA_THRESH_MAX_BUF
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"dma_write_buf_tsh_asrt_emer can not be larger than %d"
operator|,
name|DMA_THRESH_MAX_BUF
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_write_buf_tsh_clr_emer
operator|>
name|DMA_THRESH_MAX_BUF
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"dma_write_buf_tsh_clr_emer can not be larger than %d"
operator|,
name|DMA_THRESH_MAX_BUF
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_write_buf_tsh_clr_emer
operator|>=
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_write_buf_tsh_asrt_emer
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"dma_write_buf_tsh_clr_emer must be smaller than dma_write_buf_tsh_asrt_emer"
operator|)
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* (DPAA_VERSION>= 11) */
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_dbg_cnt_mode
operator|==
name|E_FMAN_DMA_DBG_CNT_INT_READ_EM
operator|)
operator|||
operator|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_dbg_cnt_mode
operator|==
name|E_FMAN_DMA_DBG_CNT_INT_WRITE_EM
operator|)
operator|||
operator|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_dbg_cnt_mode
operator|==
name|E_FMAN_DMA_DBG_CNT_RAW_WAR_PROT
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"dma_dbg_cnt_mode value not supported by this integration."
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_emergency_bus_select
operator|==
name|FM_DMA_MURAM_READ_EMERGENCY
operator|)
operator|||
operator|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_emergency_bus_select
operator|==
name|FM_DMA_MURAM_WRITE_EMERGENCY
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"emergencyBusSelect value not supported by this integration."
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_stop_on_bus_error
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"dma_stop_on_bus_error not supported by this integration."
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_AID_MODE_NO_TNUM_SW005
if|if
condition|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_aid_mode
operator|!=
name|E_FMAN_DMA_AID_OUT_PORT_ID
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"dma_aid_mode not supported by this integration."
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* FM_AID_MODE_NO_TNUM_SW005 */
if|if
condition|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_axi_dbg_num_of_beats
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"dma_axi_dbg_num_of_beats not supported by this integration."
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* (DPAA_VERSION< 11) */
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|fmClkFreq
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"fmClkFreq must be set."
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|USEC_TO_CLK
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_watchdog
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|fmClkFreq
argument_list|)
operator|>
name|DMA_MAX_WATCHDOG
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"dma_watchdog depends on FM clock. dma_watchdog(in microseconds) * clk (in Mhz), may not exceed 0x08x"
operator|,
name|DMA_MAX_WATCHDOG
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|DPAA_VERSION
operator|>=
literal|11
operator|)
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|partVSPBase
operator|+
name|p_Fm
operator|->
name|partNumOfVSPs
operator|)
operator|>
name|FM_VSP_MAX_NUM_OF_ENTRIES
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"partVSPBase+partNumOfVSPs out of range!!!"
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* (DPAA_VERSION>= 11) */
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|totalFifoSize
operator|%
name|BMI_FIFO_UNITS
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"totalFifoSize number has to be divisible by %d"
operator|,
name|BMI_FIFO_UNITS
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|totalFifoSize
operator|||
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|totalFifoSize
operator|>
name|BMI_MAX_FIFO_SIZE
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"totalFifoSize (currently defined as %d) has to be in the range of 256 to %d"
operator|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|totalFifoSize
operator|,
name|BMI_MAX_FIFO_SIZE
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|totalNumOfTasks
operator|||
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|totalNumOfTasks
operator|>
name|BMI_MAX_NUM_OF_TASKS
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"totalNumOfTasks number has to be in the range 1 - %d"
operator|,
name|BMI_MAX_NUM_OF_TASKS
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_HAS_TOTAL_DMAS
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|maxNumOfOpenDmas
operator|||
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|maxNumOfOpenDmas
operator|>
name|BMI_MAX_NUM_OF_DMAS
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"maxNumOfOpenDmas number has to be in the range 1 - %d"
operator|,
name|BMI_MAX_NUM_OF_DMAS
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* FM_HAS_TOTAL_DMAS */
if|if
condition|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|disp_limit_tsh
operator|>
name|FPM_MAX_DISP_LIMIT
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"disp_limit_tsh can't be greater than %d"
operator|,
name|FPM_MAX_DISP_LIMIT
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|f_Exception
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Exceptions callback not provided"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|f_BusError
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Exceptions callback not provided"
operator|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_NO_WATCHDOG
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|==
literal|2
operator|)
operator|&&
operator|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_watchdog
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"watchdog!"
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* FM_NO_WATCHDOG */
ifdef|#
directive|ifdef
name|FM_ECC_HALT_NO_SYNC_ERRATA_10GMAC_A008
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|<
literal|6
operator|)
operator|&&
operator|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|halt_on_unrecov_ecc_err
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"HaltOnEccError!"
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* FM_ECC_HALT_NO_SYNC_ERRATA_10GMAC_A008 */
ifdef|#
directive|ifdef
name|FM_NO_TNUM_AGING
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|!=
literal|4
operator|)
operator|&&
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|<
literal|6
operator|)
condition|)
if|if
condition|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|tnum_aging_period
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"Tnum aging!"
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* FM_NO_TNUM_AGING */
comment|/* check that user did not set revision-dependent exceptions */
ifdef|#
directive|ifdef
name|FM_NO_DISPATCH_RAM_ECC
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|!=
literal|4
operator|)
operator|&&
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|<
literal|6
operator|)
condition|)
if|if
condition|(
name|p_Fm
operator|->
name|userSetExceptions
operator|&
name|FM_EX_BMI_DISPATCH_RAM_ECC
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"exception e_FM_EX_BMI_DISPATCH_RAM_ECC!"
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* FM_NO_DISPATCH_RAM_ECC */
ifdef|#
directive|ifdef
name|FM_QMI_NO_ECC_EXCEPTIONS
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|==
literal|4
condition|)
if|if
condition|(
name|p_Fm
operator|->
name|userSetExceptions
operator|&
operator|(
name|FM_EX_QMI_SINGLE_ECC
operator||
name|FM_EX_QMI_DOUBLE_ECC
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"exception e_FM_EX_QMI_SINGLE_ECC/e_FM_EX_QMI_DOUBLE_ECC!"
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* FM_QMI_NO_ECC_EXCEPTIONS */
ifdef|#
directive|ifdef
name|FM_QMI_NO_SINGLE_ECC_EXCEPTION
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|>=
literal|6
condition|)
if|if
condition|(
name|p_Fm
operator|->
name|userSetExceptions
operator|&
name|FM_EX_QMI_SINGLE_ECC
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"exception e_FM_EX_QMI_SINGLE_ECC!"
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* FM_QMI_NO_SINGLE_ECC_EXCEPTION */
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|SendIpcIsr
parameter_list|(
name|t_Fm
modifier|*
name|p_Fm
parameter_list|,
name|uint32_t
name|macEvent
parameter_list|,
name|uint32_t
name|pendingReg
parameter_list|)
block|{
name|ASSERT_COND
argument_list|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|intrMng
index|[
name|macEvent
index|]
operator|.
name|guestId
operator|==
name|NCSW_MASTER_ID
condition|)
name|p_Fm
operator|->
name|intrMng
index|[
name|macEvent
index|]
operator|.
name|f_Isr
argument_list|(
name|p_Fm
operator|->
name|intrMng
index|[
name|macEvent
index|]
operator|.
name|h_SrcHandle
argument_list|)
expr_stmt|;
comment|/* If the MAC is running on guest-partition and we have IPC session with it,        we inform him about the event through IPC; otherwise, we ignore the event. */
elseif|else
if|if
condition|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
name|p_Fm
operator|->
name|intrMng
index|[
name|macEvent
index|]
operator|.
name|guestId
index|]
condition|)
block|{
name|t_Error
name|err
decl_stmt|;
name|t_FmIpcIsr
name|fmIpcIsr
decl_stmt|;
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_GUEST_ISR
expr_stmt|;
name|fmIpcIsr
operator|.
name|pendingReg
operator|=
name|pendingReg
expr_stmt|;
name|fmIpcIsr
operator|.
name|boolErr
operator|=
name|FALSE
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|&
name|fmIpcIsr
argument_list|,
sizeof|sizeof
argument_list|(
name|fmIpcIsr
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
name|p_Fm
operator|->
name|intrMng
index|[
name|macEvent
index|]
operator|.
name|guestId
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|fmIpcIsr
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
else|else
name|DBG
argument_list|(
name|TRACE
argument_list|,
operator|(
literal|"FM Guest mode, without IPC - can't call ISR!"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|BmiErrEvent
parameter_list|(
name|t_Fm
modifier|*
name|p_Fm
parameter_list|)
block|{
name|uint32_t
name|event
decl_stmt|;
name|struct
name|fman_bmi_regs
modifier|*
name|bmi_rg
init|=
name|p_Fm
operator|->
name|p_FmBmiRegs
decl_stmt|;
name|event
operator|=
name|fman_get_bmi_err_event
argument_list|(
name|bmi_rg
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|BMI_ERR_INTR_EN_STORAGE_PROFILE_ECC
condition|)
name|p_Fm
operator|->
name|f_Exception
argument_list|(
name|p_Fm
operator|->
name|h_App
argument_list|,
name|e_FM_EX_BMI_STORAGE_PROFILE_ECC
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|BMI_ERR_INTR_EN_LIST_RAM_ECC
condition|)
name|p_Fm
operator|->
name|f_Exception
argument_list|(
name|p_Fm
operator|->
name|h_App
argument_list|,
name|e_FM_EX_BMI_LIST_RAM_ECC
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|BMI_ERR_INTR_EN_STATISTICS_RAM_ECC
condition|)
name|p_Fm
operator|->
name|f_Exception
argument_list|(
name|p_Fm
operator|->
name|h_App
argument_list|,
name|e_FM_EX_BMI_STATISTICS_RAM_ECC
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|BMI_ERR_INTR_EN_DISPATCH_RAM_ECC
condition|)
name|p_Fm
operator|->
name|f_Exception
argument_list|(
name|p_Fm
operator|->
name|h_App
argument_list|,
name|e_FM_EX_BMI_DISPATCH_RAM_ECC
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|QmiErrEvent
parameter_list|(
name|t_Fm
modifier|*
name|p_Fm
parameter_list|)
block|{
name|uint32_t
name|event
decl_stmt|;
name|struct
name|fman_qmi_regs
modifier|*
name|qmi_rg
init|=
name|p_Fm
operator|->
name|p_FmQmiRegs
decl_stmt|;
name|event
operator|=
name|fman_get_qmi_err_event
argument_list|(
name|qmi_rg
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|QMI_ERR_INTR_EN_DOUBLE_ECC
condition|)
name|p_Fm
operator|->
name|f_Exception
argument_list|(
name|p_Fm
operator|->
name|h_App
argument_list|,
name|e_FM_EX_QMI_DOUBLE_ECC
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|QMI_ERR_INTR_EN_DEQ_FROM_DEF
condition|)
name|p_Fm
operator|->
name|f_Exception
argument_list|(
name|p_Fm
operator|->
name|h_App
argument_list|,
name|e_FM_EX_QMI_DEQ_FROM_UNKNOWN_PORTID
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DmaErrEvent
parameter_list|(
name|t_Fm
modifier|*
name|p_Fm
parameter_list|)
block|{
name|uint32_t
name|status
decl_stmt|,
name|com_id
decl_stmt|;
name|uint8_t
name|tnum
decl_stmt|;
name|uint8_t
name|hardwarePortId
decl_stmt|;
name|uint8_t
name|relativePortId
decl_stmt|;
name|uint16_t
name|liodn
decl_stmt|;
name|struct
name|fman_dma_regs
modifier|*
name|dma_rg
init|=
name|p_Fm
operator|->
name|p_FmDmaRegs
decl_stmt|;
name|status
operator|=
name|fman_get_dma_err_event
argument_list|(
name|dma_rg
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|DMA_STATUS_BUS_ERR
condition|)
block|{
name|com_id
operator|=
name|fman_get_dma_com_id
argument_list|(
name|dma_rg
argument_list|)
expr_stmt|;
name|hardwarePortId
operator|=
call|(
name|uint8_t
call|)
argument_list|(
operator|(
operator|(
name|com_id
operator|&
name|DMA_TRANSFER_PORTID_MASK
operator|)
operator|>>
name|DMA_TRANSFER_PORTID_SHIFT
operator|)
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|IN_RANGE
argument_list|(
literal|1
argument_list|,
name|hardwarePortId
argument_list|,
literal|63
argument_list|)
argument_list|)
expr_stmt|;
name|HW_PORT_ID_TO_SW_PORT_ID
argument_list|(
name|relativePortId
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
name|tnum
operator|=
call|(
name|uint8_t
call|)
argument_list|(
operator|(
name|com_id
operator|&
name|DMA_TRANSFER_TNUM_MASK
operator|)
operator|>>
name|DMA_TRANSFER_TNUM_SHIFT
argument_list|)
expr_stmt|;
name|liodn
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|com_id
operator|&
name|DMA_TRANSFER_LIODN_MASK
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|portsTypes
index|[
name|hardwarePortId
index|]
operator|!=
name|e_FM_PORT_TYPE_DUMMY
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|f_BusError
argument_list|(
name|p_Fm
operator|->
name|h_App
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|portsTypes
index|[
name|hardwarePortId
index|]
argument_list|,
name|relativePortId
argument_list|,
name|fman_get_dma_addr
argument_list|(
name|dma_rg
argument_list|)
argument_list|,
name|tnum
argument_list|,
name|liodn
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|&
name|DMA_STATUS_FM_SPDAT_ECC
condition|)
name|p_Fm
operator|->
name|f_Exception
argument_list|(
name|p_Fm
operator|->
name|h_App
argument_list|,
name|e_FM_EX_DMA_SINGLE_PORT_ECC
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|DMA_STATUS_READ_ECC
condition|)
name|p_Fm
operator|->
name|f_Exception
argument_list|(
name|p_Fm
operator|->
name|h_App
argument_list|,
name|e_FM_EX_DMA_READ_ECC
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|DMA_STATUS_SYSTEM_WRITE_ECC
condition|)
name|p_Fm
operator|->
name|f_Exception
argument_list|(
name|p_Fm
operator|->
name|h_App
argument_list|,
name|e_FM_EX_DMA_SYSTEM_WRITE_ECC
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&
name|DMA_STATUS_FM_WRITE_ECC
condition|)
name|p_Fm
operator|->
name|f_Exception
argument_list|(
name|p_Fm
operator|->
name|h_App
argument_list|,
name|e_FM_EX_DMA_FM_WRITE_ECC
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|FpmErrEvent
parameter_list|(
name|t_Fm
modifier|*
name|p_Fm
parameter_list|)
block|{
name|uint32_t
name|event
decl_stmt|;
name|struct
name|fman_fpm_regs
modifier|*
name|fpm_rg
init|=
name|p_Fm
operator|->
name|p_FmFpmRegs
decl_stmt|;
name|event
operator|=
name|fman_get_fpm_err_event
argument_list|(
name|fpm_rg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|event
operator|&
name|FPM_EV_MASK_DOUBLE_ECC
operator|)
operator|&&
operator|(
name|event
operator|&
name|FPM_EV_MASK_DOUBLE_ECC_EN
operator|)
condition|)
name|p_Fm
operator|->
name|f_Exception
argument_list|(
name|p_Fm
operator|->
name|h_App
argument_list|,
name|e_FM_EX_FPM_DOUBLE_ECC
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|event
operator|&
name|FPM_EV_MASK_STALL
operator|)
operator|&&
operator|(
name|event
operator|&
name|FPM_EV_MASK_STALL_EN
operator|)
condition|)
name|p_Fm
operator|->
name|f_Exception
argument_list|(
name|p_Fm
operator|->
name|h_App
argument_list|,
name|e_FM_EX_FPM_STALL_ON_TASKS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|event
operator|&
name|FPM_EV_MASK_SINGLE_ECC
operator|)
operator|&&
operator|(
name|event
operator|&
name|FPM_EV_MASK_SINGLE_ECC_EN
operator|)
condition|)
name|p_Fm
operator|->
name|f_Exception
argument_list|(
name|p_Fm
operator|->
name|h_App
argument_list|,
name|e_FM_EX_FPM_SINGLE_ECC
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|MuramErrIntr
parameter_list|(
name|t_Fm
modifier|*
name|p_Fm
parameter_list|)
block|{
name|uint32_t
name|event
decl_stmt|;
name|struct
name|fman_fpm_regs
modifier|*
name|fpm_rg
init|=
name|p_Fm
operator|->
name|p_FmFpmRegs
decl_stmt|;
name|event
operator|=
name|fman_get_muram_err_event
argument_list|(
name|fpm_rg
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|FPM_RAM_MURAM_ECC
condition|)
name|p_Fm
operator|->
name|f_Exception
argument_list|(
name|p_Fm
operator|->
name|h_App
argument_list|,
name|e_FM_EX_MURAM_ECC
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|IramErrIntr
parameter_list|(
name|t_Fm
modifier|*
name|p_Fm
parameter_list|)
block|{
name|uint32_t
name|event
decl_stmt|;
name|struct
name|fman_fpm_regs
modifier|*
name|fpm_rg
init|=
name|p_Fm
operator|->
name|p_FmFpmRegs
decl_stmt|;
name|event
operator|=
name|fman_get_iram_err_event
argument_list|(
name|fpm_rg
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|FPM_RAM_IRAM_ECC
condition|)
name|p_Fm
operator|->
name|f_Exception
argument_list|(
name|p_Fm
operator|->
name|h_App
argument_list|,
name|e_FM_EX_IRAM_ECC
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|QmiEvent
parameter_list|(
name|t_Fm
modifier|*
name|p_Fm
parameter_list|)
block|{
name|uint32_t
name|event
decl_stmt|;
name|struct
name|fman_qmi_regs
modifier|*
name|qmi_rg
init|=
name|p_Fm
operator|->
name|p_FmQmiRegs
decl_stmt|;
name|event
operator|=
name|fman_get_qmi_event
argument_list|(
name|qmi_rg
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|QMI_INTR_EN_SINGLE_ECC
condition|)
name|p_Fm
operator|->
name|f_Exception
argument_list|(
name|p_Fm
operator|->
name|h_App
argument_list|,
name|e_FM_EX_QMI_SINGLE_ECC
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|UnimplementedIsr
parameter_list|(
name|t_Handle
name|h_Arg
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|h_Arg
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"Unimplemented ISR!"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|UnimplementedFmanCtrlIsr
parameter_list|(
name|t_Handle
name|h_Arg
parameter_list|,
name|uint32_t
name|event
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|h_Arg
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|event
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"Unimplemented FmCtl ISR!"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|EnableTimeStamp
parameter_list|(
name|t_Fm
modifier|*
name|p_Fm
parameter_list|)
block|{
name|struct
name|fman_fpm_regs
modifier|*
name|fpm_rg
init|=
name|p_Fm
operator|->
name|p_FmFpmRegs
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|count1MicroBit
argument_list|)
expr_stmt|;
name|fman_enable_time_stamp
argument_list|(
name|fpm_rg
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|count1MicroBit
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|fmClkFreq
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|enabledTimeStamp
operator|=
name|TRUE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|ClearIRam
parameter_list|(
name|t_Fm
modifier|*
name|p_Fm
parameter_list|)
block|{
name|t_FMIramRegs
modifier|*
name|p_Iram
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|iram_size
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
name|p_Iram
operator|=
operator|(
name|t_FMIramRegs
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|p_Fm
operator|->
name|baseAddr
operator|+
name|FM_MM_IMEM
argument_list|)
expr_stmt|;
name|iram_size
operator|=
name|FM_IRAM_SIZE
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|minorRev
argument_list|)
expr_stmt|;
comment|/* Enable the auto-increment */
name|WRITE_UINT32
argument_list|(
name|p_Iram
operator|->
name|iadd
argument_list|,
name|IRAM_IADD_AIE
argument_list|)
expr_stmt|;
while|while
condition|(
name|GET_UINT32
argument_list|(
name|p_Iram
operator|->
name|iadd
argument_list|)
operator|!=
name|IRAM_IADD_AIE
condition|)
empty_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|iram_size
operator|/
literal|4
operator|)
condition|;
name|i
operator|++
control|)
name|WRITE_UINT32
argument_list|(
name|p_Iram
operator|->
name|idata
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Iram
operator|->
name|iadd
argument_list|,
name|iram_size
operator|-
literal|4
argument_list|)
expr_stmt|;
name|CORE_MemoryBarrier
argument_list|()
expr_stmt|;
while|while
condition|(
name|GET_UINT32
argument_list|(
name|p_Iram
operator|->
name|idata
argument_list|)
operator|!=
literal|0xffffffff
condition|)
empty_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|LoadFmanCtrlCode
parameter_list|(
name|t_Fm
modifier|*
name|p_Fm
parameter_list|)
block|{
name|t_FMIramRegs
modifier|*
name|p_Iram
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint32_t
name|tmp
decl_stmt|;
name|uint8_t
name|compTo16
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
name|p_Iram
operator|=
operator|(
name|t_FMIramRegs
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|p_Fm
operator|->
name|baseAddr
operator|+
name|FM_MM_IMEM
argument_list|)
expr_stmt|;
comment|/* Enable the auto-increment */
name|WRITE_UINT32
argument_list|(
name|p_Iram
operator|->
name|iadd
argument_list|,
name|IRAM_IADD_AIE
argument_list|)
expr_stmt|;
while|while
condition|(
name|GET_UINT32
argument_list|(
name|p_Iram
operator|->
name|iadd
argument_list|)
operator|!=
name|IRAM_IADD_AIE
condition|)
empty_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|p_Fm
operator|->
name|firmware
operator|.
name|size
operator|/
literal|4
operator|)
condition|;
name|i
operator|++
control|)
name|WRITE_UINT32
argument_list|(
name|p_Iram
operator|->
name|idata
argument_list|,
name|p_Fm
operator|->
name|firmware
operator|.
name|p_Code
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|compTo16
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|p_Fm
operator|->
name|firmware
operator|.
name|size
operator|%
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|compTo16
condition|)
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
operator|(
literal|16
operator|-
name|compTo16
operator|)
operator|/
literal|4
operator|)
condition|;
name|i
operator|++
control|)
name|WRITE_UINT32
argument_list|(
name|p_Iram
operator|->
name|idata
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Iram
operator|->
name|iadd
argument_list|,
name|p_Fm
operator|->
name|firmware
operator|.
name|size
operator|-
literal|4
argument_list|)
expr_stmt|;
while|while
condition|(
name|GET_UINT32
argument_list|(
name|p_Iram
operator|->
name|iadd
argument_list|)
operator|!=
operator|(
name|p_Fm
operator|->
name|firmware
operator|.
name|size
operator|-
literal|4
operator|)
condition|)
empty_stmt|;
comment|/* verify that writing has completed */
while|while
condition|(
name|GET_UINT32
argument_list|(
name|p_Iram
operator|->
name|idata
argument_list|)
operator|!=
name|p_Fm
operator|->
name|firmware
operator|.
name|p_Code
index|[
operator|(
name|p_Fm
operator|->
name|firmware
operator|.
name|size
operator|/
literal|4
operator|)
operator|-
literal|1
index|]
condition|)
empty_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|fwVerify
condition|)
block|{
name|WRITE_UINT32
argument_list|(
name|p_Iram
operator|->
name|iadd
argument_list|,
name|IRAM_IADD_AIE
argument_list|)
expr_stmt|;
while|while
condition|(
name|GET_UINT32
argument_list|(
name|p_Iram
operator|->
name|iadd
argument_list|)
operator|!=
name|IRAM_IADD_AIE
condition|)
empty_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|p_Fm
operator|->
name|firmware
operator|.
name|size
operator|/
literal|4
operator|)
condition|;
name|i
operator|++
control|)
block|{
name|tmp
operator|=
name|GET_UINT32
argument_list|(
name|p_Iram
operator|->
name|idata
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|!=
name|p_Fm
operator|->
name|firmware
operator|.
name|p_Code
index|[
name|i
index|]
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_WRITE_FAILED
argument_list|,
operator|(
literal|"UCode write error : write 0x%x, read 0x%x"
operator|,
name|p_Fm
operator|->
name|firmware
operator|.
name|p_Code
index|[
name|i
index|]
operator|,
name|tmp
operator|)
argument_list|)
expr_stmt|;
block|}
name|WRITE_UINT32
argument_list|(
name|p_Iram
operator|->
name|iadd
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
block|}
comment|/* Enable patch from IRAM */
name|WRITE_UINT32
argument_list|(
name|p_Iram
operator|->
name|iready
argument_list|,
name|IRAM_READY
argument_list|)
expr_stmt|;
name|XX_UDelay
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|DBG
argument_list|(
name|INFO
argument_list|,
operator|(
literal|"FMan-Controller code (ver %d.%d.%d) loaded to IRAM."
operator|,
operator|(
operator|(
name|uint16_t
operator|*
operator|)
name|p_Fm
operator|->
name|firmware
operator|.
name|p_Code
operator|)
index|[
literal|2
index|]
operator|,
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|p_Fm
operator|->
name|firmware
operator|.
name|p_Code
operator|)
index|[
literal|6
index|]
operator|,
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|p_Fm
operator|->
name|firmware
operator|.
name|p_Code
operator|)
index|[
literal|7
index|]
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|FM_UCODE_NOT_RESET_ERRATA_BUGZILLA6173
end_ifdef

begin_function
specifier|static
name|t_Error
name|FwNotResetErratumBugzilla6173WA
parameter_list|(
name|t_Fm
modifier|*
name|p_Fm
parameter_list|)
block|{
name|t_FMIramRegs
modifier|*
name|p_Iram
init|=
operator|(
name|t_FMIramRegs
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|p_Fm
operator|->
name|baseAddr
operator|+
name|FM_MM_IMEM
argument_list|)
decl_stmt|;
name|uint32_t
name|tmpReg
decl_stmt|;
name|uint32_t
name|savedSpliodn
index|[
literal|63
index|]
decl_stmt|;
comment|/* write to IRAM first location the debug instruction */
name|WRITE_UINT32
argument_list|(
name|p_Iram
operator|->
name|iadd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|GET_UINT32
argument_list|(
name|p_Iram
operator|->
name|iadd
argument_list|)
operator|!=
literal|0
condition|)
empty_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Iram
operator|->
name|idata
argument_list|,
name|FM_FW_DEBUG_INSTRUCTION
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Iram
operator|->
name|iadd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|GET_UINT32
argument_list|(
name|p_Iram
operator|->
name|iadd
argument_list|)
operator|!=
literal|0
condition|)
empty_stmt|;
while|while
condition|(
name|GET_UINT32
argument_list|(
name|p_Iram
operator|->
name|idata
argument_list|)
operator|!=
name|FM_FW_DEBUG_INSTRUCTION
condition|)
empty_stmt|;
comment|/* Enable patch from IRAM */
name|WRITE_UINT32
argument_list|(
name|p_Iram
operator|->
name|iready
argument_list|,
name|IRAM_READY
argument_list|)
expr_stmt|;
name|CORE_MemoryBarrier
argument_list|()
expr_stmt|;
name|XX_UDelay
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|IO2MemCpy32
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
name|savedSpliodn
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|p_Fm
operator|->
name|p_FmBmiRegs
operator|->
name|fmbm_spliodn
argument_list|,
literal|63
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
comment|/* reset FMAN */
name|WRITE_UINT32
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|->
name|fm_rstc
argument_list|,
name|FPM_RSTC_FM_RESET
argument_list|)
expr_stmt|;
name|CORE_MemoryBarrier
argument_list|()
expr_stmt|;
name|XX_UDelay
argument_list|(
literal|100
argument_list|)
expr_stmt|;
comment|/* verify breakpoint debug status register */
name|tmpReg
operator|=
name|GET_UINT32
argument_list|(
operator|*
operator|(
name|uint32_t
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|p_Fm
operator|->
name|baseAddr
operator|+
name|FM_DEBUG_STATUS_REGISTER_OFFSET
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tmpReg
condition|)
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Invalid debug status register value is '0'"
operator|)
argument_list|)
expr_stmt|;
comment|/*************************************/
comment|/* Load FMan-Controller code to IRAM */
comment|/*************************************/
name|ClearIRam
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|firmware
operator|.
name|p_Code
operator|&&
operator|(
name|LoadFmanCtrlCode
argument_list|(
name|p_Fm
argument_list|)
operator|!=
name|E_OK
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
name|XX_UDelay
argument_list|(
literal|100
argument_list|)
expr_stmt|;
comment|/* reset FMAN again to start the microcode */
name|WRITE_UINT32
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|->
name|fm_rstc
argument_list|,
name|FPM_RSTC_FM_RESET
argument_list|)
expr_stmt|;
name|CORE_MemoryBarrier
argument_list|()
expr_stmt|;
name|XX_UDelay
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|Mem2IOCpy32
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
name|p_Fm
operator|->
name|p_FmBmiRegs
operator|->
name|fmbm_spliodn
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|savedSpliodn
argument_list|,
literal|63
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fman_is_qmi_halt_not_busy_state
argument_list|(
name|p_Fm
operator|->
name|p_FmQmiRegs
argument_list|)
condition|)
block|{
name|fman_resume
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
argument_list|)
expr_stmt|;
name|CORE_MemoryBarrier
argument_list|()
expr_stmt|;
name|XX_UDelay
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* FM_UCODE_NOT_RESET_ERRATA_BUGZILLA6173 */
end_comment

begin_function
specifier|static
name|void
name|GuestErrorIsr
parameter_list|(
name|t_Fm
modifier|*
name|p_Fm
parameter_list|,
name|uint32_t
name|pending
parameter_list|)
block|{
define|#
directive|define
name|FM_G_CALL_1G_MAC_ERR_ISR
parameter_list|(
name|_id
parameter_list|)
define|\
value|do {                                    \     p_Fm->intrMng[(e_FmInterModuleEvent)(e_FM_EV_ERR_1G_MAC0+_id)].f_Isr(p_Fm->intrMng[(e_FmInterModuleEvent)(e_FM_EV_ERR_1G_MAC0+_id)].h_SrcHandle);\ } while (0)
define|#
directive|define
name|FM_G_CALL_10G_MAC_ERR_ISR
parameter_list|(
name|_id
parameter_list|)
define|\
value|do {                                    \     p_Fm->intrMng[(e_FmInterModuleEvent)(e_FM_EV_ERR_10G_MAC0+_id)].f_Isr(p_Fm->intrMng[(e_FmInterModuleEvent)(e_FM_EV_ERR_10G_MAC0+_id)].h_SrcHandle);\ } while (0)
comment|/* error interrupts */
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_1G_MAC0
condition|)
name|FM_G_CALL_1G_MAC_ERR_ISR
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_1G_MAC1
condition|)
name|FM_G_CALL_1G_MAC_ERR_ISR
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_1G_MAC2
condition|)
name|FM_G_CALL_1G_MAC_ERR_ISR
argument_list|(
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_1G_MAC3
condition|)
name|FM_G_CALL_1G_MAC_ERR_ISR
argument_list|(
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_1G_MAC4
condition|)
name|FM_G_CALL_1G_MAC_ERR_ISR
argument_list|(
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_1G_MAC5
condition|)
name|FM_G_CALL_1G_MAC_ERR_ISR
argument_list|(
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_1G_MAC6
condition|)
name|FM_G_CALL_1G_MAC_ERR_ISR
argument_list|(
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_1G_MAC7
condition|)
name|FM_G_CALL_1G_MAC_ERR_ISR
argument_list|(
literal|7
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_10G_MAC0
condition|)
name|FM_G_CALL_10G_MAC_ERR_ISR
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_10G_MAC1
condition|)
name|FM_G_CALL_10G_MAC_ERR_ISR
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|GuestEventIsr
parameter_list|(
name|t_Fm
modifier|*
name|p_Fm
parameter_list|,
name|uint32_t
name|pending
parameter_list|)
block|{
define|#
directive|define
name|FM_G_CALL_1G_MAC_ISR
parameter_list|(
name|_id
parameter_list|)
define|\
value|do {                                    \     p_Fm->intrMng[(e_FmInterModuleEvent)(e_FM_EV_1G_MAC0+_id)].f_Isr(p_Fm->intrMng[(e_FmInterModuleEvent)(e_FM_EV_1G_MAC0+_id)].h_SrcHandle);\ } while (0)
define|#
directive|define
name|FM_G_CALL_10G_MAC_ISR
parameter_list|(
name|_id
parameter_list|)
define|\
value|do {                                    \     p_Fm->intrMng[(e_FmInterModuleEvent)(e_FM_EV_10G_MAC0+_id)].f_Isr(p_Fm->intrMng[(e_FmInterModuleEvent)(e_FM_EV_10G_MAC0+_id)].h_SrcHandle);\ } while (0)
if|if
condition|(
name|pending
operator|&
name|INTR_EN_1G_MAC0
condition|)
name|FM_G_CALL_1G_MAC_ISR
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|INTR_EN_1G_MAC1
condition|)
name|FM_G_CALL_1G_MAC_ISR
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|INTR_EN_1G_MAC2
condition|)
name|FM_G_CALL_1G_MAC_ISR
argument_list|(
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|INTR_EN_1G_MAC3
condition|)
name|FM_G_CALL_1G_MAC_ISR
argument_list|(
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|INTR_EN_1G_MAC4
condition|)
name|FM_G_CALL_1G_MAC_ISR
argument_list|(
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|INTR_EN_1G_MAC5
condition|)
name|FM_G_CALL_1G_MAC_ISR
argument_list|(
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|INTR_EN_1G_MAC6
condition|)
name|FM_G_CALL_1G_MAC_ISR
argument_list|(
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|INTR_EN_1G_MAC7
condition|)
name|FM_G_CALL_1G_MAC_ISR
argument_list|(
literal|7
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|INTR_EN_10G_MAC0
condition|)
name|FM_G_CALL_10G_MAC_ISR
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|INTR_EN_10G_MAC1
condition|)
name|FM_G_CALL_10G_MAC_ISR
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|INTR_EN_TMR
condition|)
name|p_Fm
operator|->
name|intrMng
index|[
name|e_FM_EV_TMR
index|]
operator|.
name|f_Isr
argument_list|(
name|p_Fm
operator|->
name|intrMng
index|[
name|e_FM_EV_TMR
index|]
operator|.
name|h_SrcHandle
argument_list|)
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
operator|(
name|DPAA_VERSION
operator|>=
literal|11
operator|)
end_if

begin_function
specifier|static
name|t_Error
name|SetVSPWindow
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint8_t
name|hardwarePortId
parameter_list|,
name|uint8_t
name|baseStorageProfile
parameter_list|,
name|uint8_t
name|log2NumOfProfiles
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|h_Fm
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|IN_RANGE
argument_list|(
literal|1
argument_list|,
name|hardwarePortId
argument_list|,
literal|63
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|&&
operator|!
name|p_Fm
operator|->
name|p_FmBmiRegs
operator|&&
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
condition|)
block|{
name|t_FmIpcVspSetPortWindow
name|fmIpcVspSetPortWindow
decl_stmt|;
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|fmIpcVspSetPortWindow
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcVspSetPortWindow
argument_list|)
argument_list|)
expr_stmt|;
name|fmIpcVspSetPortWindow
operator|.
name|hardwarePortId
operator|=
name|hardwarePortId
expr_stmt|;
name|fmIpcVspSetPortWindow
operator|.
name|baseStorageProfile
operator|=
name|baseStorageProfile
expr_stmt|;
name|fmIpcVspSetPortWindow
operator|.
name|log2NumOfProfiles
operator|=
name|log2NumOfProfiles
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_VSP_SET_PORT_WINDOW
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|&
name|fmIpcVspSetPortWindow
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcVspSetPortWindow
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
elseif|else
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|p_FmBmiRegs
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"Either IPC or 'baseAddress' is required!"
operator|)
argument_list|)
expr_stmt|;
name|fman_set_vsp_window
argument_list|(
name|p_Fm
operator|->
name|p_FmBmiRegs
argument_list|,
name|hardwarePortId
argument_list|,
name|baseStorageProfile
argument_list|,
name|log2NumOfProfiles
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|AllocVSPsForPartition
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint8_t
name|base
parameter_list|,
name|uint8_t
name|numOfProfiles
parameter_list|,
name|uint8_t
name|guestId
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|uint8_t
name|profilesFound
init|=
literal|0
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|uint32_t
name|intFlags
decl_stmt|;
if|if
condition|(
operator|!
name|numOfProfiles
condition|)
return|return
name|E_OK
return|;
if|if
condition|(
operator|(
name|numOfProfiles
operator|>
name|FM_VSP_MAX_NUM_OF_ENTRIES
operator|)
operator|||
operator|(
name|base
operator|+
name|numOfProfiles
operator|>
name|FM_VSP_MAX_NUM_OF_ENTRIES
operator|)
condition|)
return|return
operator|(
name|uint8_t
operator|)
name|ILLEGAL_BASE
return|;
if|if
condition|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
condition|)
block|{
name|t_FmIpcResourceAllocParams
name|ipcAllocParams
decl_stmt|;
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|t_FmIpcReply
name|reply
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|uint32_t
name|replyLength
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|ipcAllocParams
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcResourceAllocParams
argument_list|)
argument_list|)
expr_stmt|;
name|ipcAllocParams
operator|.
name|guestId
operator|=
name|p_Fm
operator|->
name|guestId
expr_stmt|;
name|ipcAllocParams
operator|.
name|num
operator|=
name|p_Fm
operator|->
name|partNumOfVSPs
expr_stmt|;
name|ipcAllocParams
operator|.
name|base
operator|=
name|p_Fm
operator|->
name|partVSPBase
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_VSP_ALLOC
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|&
name|ipcAllocParams
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcResourceAllocParams
argument_list|)
argument_list|)
expr_stmt|;
name|replyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
expr_stmt|;
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|t_FmIpcResourceAllocParams
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|!=
name|E_OK
operator|)
operator|||
operator|(
name|replyLength
operator|!=
operator|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
operator|)
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
else|else
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|p_Fm
operator|->
name|partVSPBase
argument_list|,
name|reply
operator|.
name|replyBody
argument_list|,
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|partVSPBase
operator|==
call|(
name|uint8_t
call|)
argument_list|(
name|ILLEGAL_BASE
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
block|{
name|DBG
argument_list|(
name|WARNING
argument_list|,
operator|(
literal|"FM Guest mode, without IPC - can't validate VSP range!"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|uint8_t
operator|)
name|ILLEGAL_BASE
return|;
block|}
name|intFlags
operator|=
name|XX_LockIntrSpinlock
argument_list|(
name|p_Fm
operator|->
name|h_Spinlock
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|base
init|;
name|i
operator|<
name|base
operator|+
name|numOfProfiles
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|p_Fm
operator|->
name|p_FmSp
operator|->
name|profiles
index|[
name|i
index|]
operator|.
name|profilesMng
operator|.
name|ownerId
operator|==
operator|(
name|uint8_t
operator|)
name|ILLEGAL_BASE
condition|)
name|profilesFound
operator|++
expr_stmt|;
else|else
break|break;
if|if
condition|(
name|profilesFound
operator|==
name|numOfProfiles
condition|)
for|for
control|(
name|i
operator|=
name|base
init|;
name|i
operator|<
name|base
operator|+
name|numOfProfiles
condition|;
name|i
operator|++
control|)
name|p_Fm
operator|->
name|p_FmSp
operator|->
name|profiles
index|[
name|i
index|]
operator|.
name|profilesMng
operator|.
name|ownerId
operator|=
name|guestId
expr_stmt|;
else|else
block|{
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_Fm
operator|->
name|h_Spinlock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
operator|(
name|uint8_t
operator|)
name|ILLEGAL_BASE
return|;
block|}
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_Fm
operator|->
name|h_Spinlock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|base
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|FreeVSPsForPartition
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint8_t
name|base
parameter_list|,
name|uint8_t
name|numOfProfiles
parameter_list|,
name|uint8_t
name|guestId
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
condition|)
block|{
name|t_FmIpcResourceAllocParams
name|ipcAllocParams
decl_stmt|;
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|t_FmIpcReply
name|reply
decl_stmt|;
name|uint32_t
name|replyLength
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|ipcAllocParams
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcResourceAllocParams
argument_list|)
argument_list|)
expr_stmt|;
name|ipcAllocParams
operator|.
name|guestId
operator|=
name|p_Fm
operator|->
name|guestId
expr_stmt|;
name|ipcAllocParams
operator|.
name|num
operator|=
name|p_Fm
operator|->
name|partNumOfVSPs
expr_stmt|;
name|ipcAllocParams
operator|.
name|base
operator|=
name|p_Fm
operator|->
name|partVSPBase
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_VSP_FREE
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|&
name|ipcAllocParams
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcResourceAllocParams
argument_list|)
argument_list|)
expr_stmt|;
name|replyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
expr_stmt|;
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|t_FmIpcResourceAllocParams
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
block|{
name|DBG
argument_list|(
name|WARNING
argument_list|,
operator|(
literal|"FM Guest mode, without IPC - can't validate VSP range!"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|ASSERT_COND
argument_list|(
name|p_Fm
operator|->
name|p_FmSp
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|base
init|;
name|i
operator|<
name|numOfProfiles
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|p_Fm
operator|->
name|p_FmSp
operator|->
name|profiles
index|[
name|i
index|]
operator|.
name|profilesMng
operator|.
name|ownerId
operator|==
name|guestId
condition|)
name|p_Fm
operator|->
name|p_FmSp
operator|->
name|profiles
index|[
name|i
index|]
operator|.
name|profilesMng
operator|.
name|ownerId
operator|=
operator|(
name|uint8_t
operator|)
name|ILLEGAL_BASE
expr_stmt|;
else|else
name|DBG
argument_list|(
name|WARNING
argument_list|,
operator|(
literal|"Request for freeing storage profile window which wasn't allocated to this partition"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* (DPAA_VERSION>= 11) */
end_comment

begin_function
specifier|static
name|t_Error
name|FmGuestHandleIpcMsgCB
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint8_t
modifier|*
name|p_Msg
parameter_list|,
name|uint32_t
name|msgLength
parameter_list|,
name|uint8_t
modifier|*
name|p_Reply
parameter_list|,
name|uint32_t
modifier|*
name|p_ReplyLength
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|t_FmIpcMsg
modifier|*
name|p_IpcMsg
init|=
operator|(
name|t_FmIpcMsg
operator|*
operator|)
name|p_Msg
decl_stmt|;
name|UNUSED
argument_list|(
name|p_Reply
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|msgLength
operator|>
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|)
argument_list|,
name|E_INVALID_VALUE
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DISABLE_SANITY_CHECKS
name|UNUSED
argument_list|(
name|msgLength
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DISABLE_SANITY_CHECKS */
name|ASSERT_COND
argument_list|(
name|p_Msg
argument_list|)
expr_stmt|;
operator|*
name|p_ReplyLength
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|p_IpcMsg
operator|->
name|msgId
condition|)
block|{
case|case
operator|(
name|FM_GUEST_ISR
operator|)
case|:
block|{
name|t_FmIpcIsr
name|ipcIsr
decl_stmt|;
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcIsr
argument_list|,
name|p_IpcMsg
operator|->
name|msgBody
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcIsr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ipcIsr
operator|.
name|boolErr
condition|)
name|GuestErrorIsr
argument_list|(
name|p_Fm
argument_list|,
name|ipcIsr
operator|.
name|pendingReg
argument_list|)
expr_stmt|;
else|else
name|GuestEventIsr
argument_list|(
name|p_Fm
argument_list|,
name|ipcIsr
operator|.
name|pendingReg
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
operator|*
name|p_ReplyLength
operator|=
literal|0
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
operator|(
literal|"command not found!!!"
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|FmHandleIpcMsgCB
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint8_t
modifier|*
name|p_Msg
parameter_list|,
name|uint32_t
name|msgLength
parameter_list|,
name|uint8_t
modifier|*
name|p_Reply
parameter_list|,
name|uint32_t
modifier|*
name|p_ReplyLength
parameter_list|)
block|{
name|t_Error
name|err
decl_stmt|;
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|t_FmIpcMsg
modifier|*
name|p_IpcMsg
init|=
operator|(
name|t_FmIpcMsg
operator|*
operator|)
name|p_Msg
decl_stmt|;
name|t_FmIpcReply
modifier|*
name|p_IpcReply
init|=
operator|(
name|t_FmIpcReply
operator|*
operator|)
name|p_Reply
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|msgLength
operator|>=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|)
argument_list|,
name|E_INVALID_VALUE
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DISABLE_SANITY_CHECKS
name|UNUSED
argument_list|(
name|msgLength
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DISABLE_SANITY_CHECKS */
name|ASSERT_COND
argument_list|(
name|p_IpcMsg
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p_IpcReply
argument_list|,
literal|0
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
operator|*
name|FM_IPC_MAX_REPLY_SIZE
operator|)
argument_list|)
expr_stmt|;
operator|*
name|p_ReplyLength
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|p_IpcMsg
operator|->
name|msgId
condition|)
block|{
case|case
operator|(
name|FM_GET_SET_PORT_PARAMS
operator|)
case|:
block|{
name|t_FmIpcPortInInitParams
name|ipcInitParams
decl_stmt|;
name|t_FmInterModulePortInitParams
name|initParams
decl_stmt|;
name|t_FmIpcPortOutInitParams
name|ipcOutInitParams
decl_stmt|;
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcInitParams
argument_list|,
name|p_IpcMsg
operator|->
name|msgBody
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcPortInInitParams
argument_list|)
argument_list|)
expr_stmt|;
name|initParams
operator|.
name|hardwarePortId
operator|=
name|ipcInitParams
operator|.
name|hardwarePortId
expr_stmt|;
name|initParams
operator|.
name|portType
operator|=
operator|(
name|e_FmPortType
operator|)
name|ipcInitParams
operator|.
name|enumPortType
expr_stmt|;
name|initParams
operator|.
name|independentMode
operator|=
call|(
name|bool
call|)
argument_list|(
name|ipcInitParams
operator|.
name|boolIndependentMode
argument_list|)
expr_stmt|;
name|initParams
operator|.
name|liodnOffset
operator|=
name|ipcInitParams
operator|.
name|liodnOffset
expr_stmt|;
name|initParams
operator|.
name|numOfTasks
operator|=
name|ipcInitParams
operator|.
name|numOfTasks
expr_stmt|;
name|initParams
operator|.
name|numOfExtraTasks
operator|=
name|ipcInitParams
operator|.
name|numOfExtraTasks
expr_stmt|;
name|initParams
operator|.
name|numOfOpenDmas
operator|=
name|ipcInitParams
operator|.
name|numOfOpenDmas
expr_stmt|;
name|initParams
operator|.
name|numOfExtraOpenDmas
operator|=
name|ipcInitParams
operator|.
name|numOfExtraOpenDmas
expr_stmt|;
name|initParams
operator|.
name|sizeOfFifo
operator|=
name|ipcInitParams
operator|.
name|sizeOfFifo
expr_stmt|;
name|initParams
operator|.
name|extraSizeOfFifo
operator|=
name|ipcInitParams
operator|.
name|extraSizeOfFifo
expr_stmt|;
name|initParams
operator|.
name|deqPipelineDepth
operator|=
name|ipcInitParams
operator|.
name|deqPipelineDepth
expr_stmt|;
name|initParams
operator|.
name|maxFrameLength
operator|=
name|ipcInitParams
operator|.
name|maxFrameLength
expr_stmt|;
name|initParams
operator|.
name|liodnBase
operator|=
name|ipcInitParams
operator|.
name|liodnBase
expr_stmt|;
name|p_IpcReply
operator|->
name|error
operator|=
operator|(
name|uint32_t
operator|)
name|FmGetSetPortParams
argument_list|(
name|h_Fm
argument_list|,
operator|&
name|initParams
argument_list|)
expr_stmt|;
name|ipcOutInitParams
operator|.
name|ipcPhysAddr
operator|.
name|high
operator|=
name|initParams
operator|.
name|fmMuramPhysBaseAddr
operator|.
name|high
expr_stmt|;
name|ipcOutInitParams
operator|.
name|ipcPhysAddr
operator|.
name|low
operator|=
name|initParams
operator|.
name|fmMuramPhysBaseAddr
operator|.
name|low
expr_stmt|;
name|ipcOutInitParams
operator|.
name|sizeOfFifo
operator|=
name|initParams
operator|.
name|sizeOfFifo
expr_stmt|;
name|ipcOutInitParams
operator|.
name|extraSizeOfFifo
operator|=
name|initParams
operator|.
name|extraSizeOfFifo
expr_stmt|;
name|ipcOutInitParams
operator|.
name|numOfTasks
operator|=
name|initParams
operator|.
name|numOfTasks
expr_stmt|;
name|ipcOutInitParams
operator|.
name|numOfExtraTasks
operator|=
name|initParams
operator|.
name|numOfExtraTasks
expr_stmt|;
name|ipcOutInitParams
operator|.
name|numOfOpenDmas
operator|=
name|initParams
operator|.
name|numOfOpenDmas
expr_stmt|;
name|ipcOutInitParams
operator|.
name|numOfExtraOpenDmas
operator|=
name|initParams
operator|.
name|numOfExtraOpenDmas
expr_stmt|;
name|memcpy
argument_list|(
name|p_IpcReply
operator|->
name|replyBody
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcOutInitParams
argument_list|,
sizeof|sizeof
argument_list|(
name|ipcOutInitParams
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|p_ReplyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|t_FmIpcPortOutInitParams
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
operator|(
name|FM_SET_SIZE_OF_FIFO
operator|)
case|:
block|{
name|t_FmIpcPortRsrcParams
name|ipcPortRsrcParams
decl_stmt|;
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcPortRsrcParams
argument_list|,
name|p_IpcMsg
operator|->
name|msgBody
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcPortRsrcParams
argument_list|)
argument_list|)
expr_stmt|;
name|p_IpcReply
operator|->
name|error
operator|=
operator|(
name|uint32_t
operator|)
name|FmSetSizeOfFifo
argument_list|(
name|h_Fm
argument_list|,
name|ipcPortRsrcParams
operator|.
name|hardwarePortId
argument_list|,
operator|&
name|ipcPortRsrcParams
operator|.
name|val
argument_list|,
operator|&
name|ipcPortRsrcParams
operator|.
name|extra
argument_list|,
operator|(
name|bool
operator|)
name|ipcPortRsrcParams
operator|.
name|boolInitialConfig
argument_list|)
expr_stmt|;
operator|*
name|p_ReplyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
operator|(
name|FM_SET_NUM_OF_TASKS
operator|)
case|:
block|{
name|t_FmIpcPortRsrcParams
name|ipcPortRsrcParams
decl_stmt|;
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcPortRsrcParams
argument_list|,
name|p_IpcMsg
operator|->
name|msgBody
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcPortRsrcParams
argument_list|)
argument_list|)
expr_stmt|;
name|p_IpcReply
operator|->
name|error
operator|=
operator|(
name|uint32_t
operator|)
name|FmSetNumOfTasks
argument_list|(
name|h_Fm
argument_list|,
name|ipcPortRsrcParams
operator|.
name|hardwarePortId
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcPortRsrcParams
operator|.
name|val
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcPortRsrcParams
operator|.
name|extra
argument_list|,
operator|(
name|bool
operator|)
name|ipcPortRsrcParams
operator|.
name|boolInitialConfig
argument_list|)
expr_stmt|;
operator|*
name|p_ReplyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
operator|(
name|FM_SET_NUM_OF_OPEN_DMAS
operator|)
case|:
block|{
name|t_FmIpcPortRsrcParams
name|ipcPortRsrcParams
decl_stmt|;
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcPortRsrcParams
argument_list|,
name|p_IpcMsg
operator|->
name|msgBody
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcPortRsrcParams
argument_list|)
argument_list|)
expr_stmt|;
name|p_IpcReply
operator|->
name|error
operator|=
operator|(
name|uint32_t
operator|)
name|FmSetNumOfOpenDmas
argument_list|(
name|h_Fm
argument_list|,
name|ipcPortRsrcParams
operator|.
name|hardwarePortId
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcPortRsrcParams
operator|.
name|val
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcPortRsrcParams
operator|.
name|extra
argument_list|,
operator|(
name|bool
operator|)
name|ipcPortRsrcParams
operator|.
name|boolInitialConfig
argument_list|)
expr_stmt|;
operator|*
name|p_ReplyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
operator|(
name|FM_RESUME_STALLED_PORT
operator|)
case|:
operator|*
name|p_ReplyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|p_IpcReply
operator|->
name|error
operator|=
operator|(
name|uint32_t
operator|)
name|FmResumeStalledPort
argument_list|(
name|h_Fm
argument_list|,
name|p_IpcMsg
operator|->
name|msgBody
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|FM_MASTER_IS_ALIVE
operator|)
case|:
block|{
name|uint8_t
name|guestId
init|=
name|p_IpcMsg
operator|->
name|msgBody
index|[
literal|0
index|]
decl_stmt|;
comment|/* build the FM master partition IPC address */
name|memset
argument_list|(
name|p_Fm
operator|->
name|fmIpcHandlerModuleName
index|[
name|guestId
index|]
argument_list|,
literal|0
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|char
argument_list|)
operator|)
operator|*
name|MODULE_NAME_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|Sprint
argument_list|(
name|p_Fm
operator|->
name|fmIpcHandlerModuleName
index|[
name|guestId
index|]
argument_list|,
literal|"FM_%d_%d"
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|fmId
argument_list|,
name|guestId
argument_list|)
operator|!=
operator|(
name|guestId
operator|<
literal|10
condition|?
literal|6
else|:
literal|7
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Sprint failed"
operator|)
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|h_IpcSessions
index|[
name|guestId
index|]
operator|=
name|XX_IpcInitSession
argument_list|(
name|p_Fm
operator|->
name|fmIpcHandlerModuleName
index|[
name|guestId
index|]
argument_list|,
name|p_Fm
operator|->
name|fmModuleName
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
name|guestId
index|]
operator|==
name|NULL
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_AVAILABLE
argument_list|,
operator|(
literal|"FM Master IPC session for guest %d"
operator|,
name|guestId
operator|)
argument_list|)
expr_stmt|;
operator|*
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|p_IpcReply
operator|->
name|replyBody
operator|)
operator|=
literal|1
expr_stmt|;
operator|*
name|p_ReplyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
operator|(
name|FM_IS_PORT_STALLED
operator|)
case|:
block|{
name|bool
name|tmp
decl_stmt|;
name|p_IpcReply
operator|->
name|error
operator|=
operator|(
name|uint32_t
operator|)
name|FmIsPortStalled
argument_list|(
name|h_Fm
argument_list|,
name|p_IpcMsg
operator|->
name|msgBody
index|[
literal|0
index|]
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
operator|*
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|p_IpcReply
operator|->
name|replyBody
operator|)
operator|=
operator|(
name|uint8_t
operator|)
name|tmp
expr_stmt|;
operator|*
name|p_ReplyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
operator|(
name|FM_RESET_MAC
operator|)
case|:
block|{
name|t_FmIpcMacParams
name|ipcMacParams
decl_stmt|;
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcMacParams
argument_list|,
name|p_IpcMsg
operator|->
name|msgBody
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcMacParams
argument_list|)
argument_list|)
expr_stmt|;
name|p_IpcReply
operator|->
name|error
operator|=
operator|(
name|uint32_t
operator|)
name|FmResetMac
argument_list|(
name|p_Fm
argument_list|,
call|(
name|e_FmMacType
call|)
argument_list|(
name|ipcMacParams
operator|.
name|enumType
argument_list|)
argument_list|,
name|ipcMacParams
operator|.
name|id
argument_list|)
expr_stmt|;
operator|*
name|p_ReplyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
operator|(
name|FM_SET_MAC_MAX_FRAME
operator|)
case|:
block|{
name|t_FmIpcMacMaxFrameParams
name|ipcMacMaxFrameParams
decl_stmt|;
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcMacMaxFrameParams
argument_list|,
name|p_IpcMsg
operator|->
name|msgBody
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcMacMaxFrameParams
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|FmSetMacMaxFrame
argument_list|(
name|p_Fm
argument_list|,
call|(
name|e_FmMacType
call|)
argument_list|(
name|ipcMacMaxFrameParams
operator|.
name|macParams
operator|.
name|enumType
argument_list|)
argument_list|,
name|ipcMacMaxFrameParams
operator|.
name|macParams
operator|.
name|id
argument_list|,
name|ipcMacMaxFrameParams
operator|.
name|maxFrameLength
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
break|break;
block|}
if|#
directive|if
operator|(
name|DPAA_VERSION
operator|>=
literal|11
operator|)
case|case
operator|(
name|FM_VSP_ALLOC
operator|)
case|:
block|{
name|t_FmIpcResourceAllocParams
name|ipcAllocParams
decl_stmt|;
name|uint8_t
name|vspBase
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|ipcAllocParams
argument_list|,
name|p_IpcMsg
operator|->
name|msgBody
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcResourceAllocParams
argument_list|)
argument_list|)
expr_stmt|;
name|vspBase
operator|=
name|AllocVSPsForPartition
argument_list|(
name|h_Fm
argument_list|,
operator|(
name|uint8_t
operator|)
name|ipcAllocParams
operator|.
name|base
argument_list|,
operator|(
name|uint8_t
operator|)
name|ipcAllocParams
operator|.
name|num
argument_list|,
name|ipcAllocParams
operator|.
name|guestId
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|p_IpcReply
operator|->
name|replyBody
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|vspBase
argument_list|,
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|p_ReplyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
operator|(
name|FM_VSP_FREE
operator|)
case|:
block|{
name|t_FmIpcResourceAllocParams
name|ipcAllocParams
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|ipcAllocParams
argument_list|,
name|p_IpcMsg
operator|->
name|msgBody
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcResourceAllocParams
argument_list|)
argument_list|)
expr_stmt|;
name|FreeVSPsForPartition
argument_list|(
name|h_Fm
argument_list|,
operator|(
name|uint8_t
operator|)
name|ipcAllocParams
operator|.
name|base
argument_list|,
operator|(
name|uint8_t
operator|)
name|ipcAllocParams
operator|.
name|num
argument_list|,
name|ipcAllocParams
operator|.
name|guestId
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
operator|(
name|FM_VSP_SET_PORT_WINDOW
operator|)
case|:
block|{
name|t_FmIpcVspSetPortWindow
name|ipcVspSetPortWindow
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|ipcVspSetPortWindow
argument_list|,
name|p_IpcMsg
operator|->
name|msgBody
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcVspSetPortWindow
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|SetVSPWindow
argument_list|(
name|h_Fm
argument_list|,
name|ipcVspSetPortWindow
operator|.
name|hardwarePortId
argument_list|,
name|ipcVspSetPortWindow
operator|.
name|baseStorageProfile
argument_list|,
name|ipcVspSetPortWindow
operator|.
name|log2NumOfProfiles
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
case|case
operator|(
name|FM_SET_CONG_GRP_PFC_PRIO
operator|)
case|:
block|{
name|t_FmIpcSetCongestionGroupPfcPriority
name|fmIpcSetCongestionGroupPfcPriority
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|fmIpcSetCongestionGroupPfcPriority
argument_list|,
name|p_IpcMsg
operator|->
name|msgBody
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcSetCongestionGroupPfcPriority
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|FmSetCongestionGroupPFCpriority
argument_list|(
name|h_Fm
argument_list|,
name|fmIpcSetCongestionGroupPfcPriority
operator|.
name|congestionGroupId
argument_list|,
name|fmIpcSetCongestionGroupPfcPriority
operator|.
name|priorityBitMap
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
endif|#
directive|endif
comment|/* (DPAA_VERSION>= 11) */
case|case
operator|(
name|FM_FREE_PORT
operator|)
case|:
block|{
name|t_FmInterModulePortFreeParams
name|portParams
decl_stmt|;
name|t_FmIpcPortFreeParams
name|ipcPortParams
decl_stmt|;
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcPortParams
argument_list|,
name|p_IpcMsg
operator|->
name|msgBody
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcPortFreeParams
argument_list|)
argument_list|)
expr_stmt|;
name|portParams
operator|.
name|hardwarePortId
operator|=
name|ipcPortParams
operator|.
name|hardwarePortId
expr_stmt|;
name|portParams
operator|.
name|portType
operator|=
call|(
name|e_FmPortType
call|)
argument_list|(
name|ipcPortParams
operator|.
name|enumPortType
argument_list|)
expr_stmt|;
name|portParams
operator|.
name|deqPipelineDepth
operator|=
name|ipcPortParams
operator|.
name|deqPipelineDepth
expr_stmt|;
name|FmFreePortParams
argument_list|(
name|h_Fm
argument_list|,
operator|&
name|portParams
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
operator|(
name|FM_REGISTER_INTR
operator|)
case|:
block|{
name|t_FmIpcRegisterIntr
name|ipcRegIntr
decl_stmt|;
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcRegIntr
argument_list|,
name|p_IpcMsg
operator|->
name|msgBody
argument_list|,
sizeof|sizeof
argument_list|(
name|ipcRegIntr
argument_list|)
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|intrMng
index|[
name|ipcRegIntr
operator|.
name|event
index|]
operator|.
name|guestId
operator|=
name|ipcRegIntr
operator|.
name|guestId
expr_stmt|;
break|break;
block|}
case|case
operator|(
name|FM_GET_PARAMS
operator|)
case|:
block|{
name|t_FmIpcParams
name|ipcParams
decl_stmt|;
comment|/* Get clock frequency */
name|ipcParams
operator|.
name|fmClkFreq
operator|=
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|fmClkFreq
expr_stmt|;
name|ipcParams
operator|.
name|fmMacClkFreq
operator|=
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|fmMacClkFreq
expr_stmt|;
name|fman_get_revision
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
argument_list|,
operator|&
name|ipcParams
operator|.
name|majorRev
argument_list|,
operator|&
name|ipcParams
operator|.
name|minorRev
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|p_IpcReply
operator|->
name|replyBody
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcParams
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcParams
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|p_ReplyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|t_FmIpcParams
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
operator|(
name|FM_GET_FMAN_CTRL_CODE_REV
operator|)
case|:
block|{
name|t_FmCtrlCodeRevisionInfo
name|fmanCtrlRevInfo
decl_stmt|;
name|t_FmIpcFmanCtrlCodeRevisionInfo
name|ipcRevInfo
decl_stmt|;
name|p_IpcReply
operator|->
name|error
operator|=
operator|(
name|uint32_t
operator|)
name|FM_GetFmanCtrlCodeRevision
argument_list|(
name|h_Fm
argument_list|,
operator|&
name|fmanCtrlRevInfo
argument_list|)
expr_stmt|;
name|ipcRevInfo
operator|.
name|packageRev
operator|=
name|fmanCtrlRevInfo
operator|.
name|packageRev
expr_stmt|;
name|ipcRevInfo
operator|.
name|majorRev
operator|=
name|fmanCtrlRevInfo
operator|.
name|majorRev
expr_stmt|;
name|ipcRevInfo
operator|.
name|minorRev
operator|=
name|fmanCtrlRevInfo
operator|.
name|minorRev
expr_stmt|;
name|memcpy
argument_list|(
name|p_IpcReply
operator|->
name|replyBody
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcRevInfo
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcFmanCtrlCodeRevisionInfo
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|p_ReplyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|t_FmIpcFmanCtrlCodeRevisionInfo
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
operator|(
name|FM_DMA_STAT
operator|)
case|:
block|{
name|t_FmDmaStatus
name|dmaStatus
decl_stmt|;
name|t_FmIpcDmaStatus
name|ipcDmaStatus
decl_stmt|;
name|FM_GetDmaStatus
argument_list|(
name|h_Fm
argument_list|,
operator|&
name|dmaStatus
argument_list|)
expr_stmt|;
name|ipcDmaStatus
operator|.
name|boolCmqNotEmpty
operator|=
operator|(
name|uint8_t
operator|)
name|dmaStatus
operator|.
name|cmqNotEmpty
expr_stmt|;
name|ipcDmaStatus
operator|.
name|boolBusError
operator|=
operator|(
name|uint8_t
operator|)
name|dmaStatus
operator|.
name|busError
expr_stmt|;
name|ipcDmaStatus
operator|.
name|boolReadBufEccError
operator|=
operator|(
name|uint8_t
operator|)
name|dmaStatus
operator|.
name|readBufEccError
expr_stmt|;
name|ipcDmaStatus
operator|.
name|boolWriteBufEccSysError
operator|=
operator|(
name|uint8_t
operator|)
name|dmaStatus
operator|.
name|writeBufEccSysError
expr_stmt|;
name|ipcDmaStatus
operator|.
name|boolWriteBufEccFmError
operator|=
operator|(
name|uint8_t
operator|)
name|dmaStatus
operator|.
name|writeBufEccFmError
expr_stmt|;
name|ipcDmaStatus
operator|.
name|boolSinglePortEccError
operator|=
operator|(
name|uint8_t
operator|)
name|dmaStatus
operator|.
name|singlePortEccError
expr_stmt|;
name|memcpy
argument_list|(
name|p_IpcReply
operator|->
name|replyBody
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcDmaStatus
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcDmaStatus
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|p_ReplyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|t_FmIpcDmaStatus
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
operator|(
name|FM_ALLOC_FMAN_CTRL_EVENT_REG
operator|)
case|:
name|p_IpcReply
operator|->
name|error
operator|=
operator|(
name|uint32_t
operator|)
name|FmAllocFmanCtrlEventReg
argument_list|(
name|h_Fm
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|p_IpcReply
operator|->
name|replyBody
argument_list|)
expr_stmt|;
operator|*
name|p_ReplyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|FM_FREE_FMAN_CTRL_EVENT_REG
operator|)
case|:
name|FmFreeFmanCtrlEventReg
argument_list|(
name|h_Fm
argument_list|,
name|p_IpcMsg
operator|->
name|msgBody
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|FM_GET_TIMESTAMP_SCALE
operator|)
case|:
block|{
name|uint32_t
name|timeStamp
init|=
name|FmGetTimeStampScale
argument_list|(
name|h_Fm
argument_list|)
decl_stmt|;
name|memcpy
argument_list|(
name|p_IpcReply
operator|->
name|replyBody
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|timeStamp
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|p_ReplyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
operator|(
name|FM_GET_COUNTER
operator|)
case|:
block|{
name|e_FmCounters
name|inCounter
decl_stmt|;
name|uint32_t
name|outCounter
decl_stmt|;
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|inCounter
argument_list|,
name|p_IpcMsg
operator|->
name|msgBody
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
name|outCounter
operator|=
name|FM_GetCounter
argument_list|(
name|h_Fm
argument_list|,
name|inCounter
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|p_IpcReply
operator|->
name|replyBody
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|outCounter
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|p_ReplyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
operator|(
name|FM_SET_FMAN_CTRL_EVENTS_ENABLE
operator|)
case|:
block|{
name|t_FmIpcFmanEvents
name|ipcFmanEvents
decl_stmt|;
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcFmanEvents
argument_list|,
name|p_IpcMsg
operator|->
name|msgBody
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcFmanEvents
argument_list|)
argument_list|)
expr_stmt|;
name|FmSetFmanCtrlIntr
argument_list|(
name|h_Fm
argument_list|,
name|ipcFmanEvents
operator|.
name|eventRegId
argument_list|,
name|ipcFmanEvents
operator|.
name|enableEvents
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
operator|(
name|FM_GET_FMAN_CTRL_EVENTS_ENABLE
operator|)
case|:
block|{
name|uint32_t
name|tmp
init|=
name|FmGetFmanCtrlIntr
argument_list|(
name|h_Fm
argument_list|,
name|p_IpcMsg
operator|->
name|msgBody
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|memcpy
argument_list|(
name|p_IpcReply
operator|->
name|replyBody
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|tmp
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|p_ReplyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
operator|(
name|FM_GET_PHYS_MURAM_BASE
operator|)
case|:
block|{
name|t_FmPhysAddr
name|physAddr
decl_stmt|;
name|t_FmIpcPhysAddr
name|ipcPhysAddr
decl_stmt|;
name|FmGetPhysicalMuramBase
argument_list|(
name|h_Fm
argument_list|,
operator|&
name|physAddr
argument_list|)
expr_stmt|;
name|ipcPhysAddr
operator|.
name|high
operator|=
name|physAddr
operator|.
name|high
expr_stmt|;
name|ipcPhysAddr
operator|.
name|low
operator|=
name|physAddr
operator|.
name|low
expr_stmt|;
name|memcpy
argument_list|(
name|p_IpcReply
operator|->
name|replyBody
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcPhysAddr
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcPhysAddr
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|p_ReplyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|t_FmIpcPhysAddr
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
operator|(
name|FM_ENABLE_RAM_ECC
operator|)
case|:
block|{
if|if
condition|(
operator|(
operator|(
name|err
operator|=
name|FM_EnableRamsEcc
argument_list|(
name|h_Fm
argument_list|)
operator|)
operator|!=
name|E_OK
operator|)
operator|||
operator|(
operator|(
name|err
operator|=
name|FM_SetException
argument_list|(
name|h_Fm
argument_list|,
name|e_FM_EX_IRAM_ECC
argument_list|,
name|TRUE
argument_list|)
operator|)
operator|!=
name|E_OK
operator|)
operator|||
operator|(
operator|(
name|err
operator|=
name|FM_SetException
argument_list|(
name|h_Fm
argument_list|,
name|e_FM_EX_MURAM_ECC
argument_list|,
name|TRUE
argument_list|)
operator|)
operator|!=
name|E_OK
operator|)
condition|)
if|#
directive|if
operator|(
operator|!
operator|(
name|defined
argument_list|(
name|DEBUG_ERRORS
argument_list|)
operator|)
operator|||
operator|(
name|DEBUG_ERRORS
operator|==
literal|0
operator|)
operator|)
name|UNUSED
argument_list|(
name|err
argument_list|)
expr_stmt|;
else|#
directive|else
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* (!(defined(DEBUG_ERRORS)) || (DEBUG_ERRORS == 0)) */
break|break;
block|}
case|case
operator|(
name|FM_DISABLE_RAM_ECC
operator|)
case|:
block|{
if|if
condition|(
operator|(
operator|(
name|err
operator|=
name|FM_SetException
argument_list|(
name|h_Fm
argument_list|,
name|e_FM_EX_IRAM_ECC
argument_list|,
name|FALSE
argument_list|)
operator|)
operator|!=
name|E_OK
operator|)
operator|||
operator|(
operator|(
name|err
operator|=
name|FM_SetException
argument_list|(
name|h_Fm
argument_list|,
name|e_FM_EX_MURAM_ECC
argument_list|,
name|FALSE
argument_list|)
operator|)
operator|!=
name|E_OK
operator|)
operator|||
operator|(
operator|(
name|err
operator|=
name|FM_DisableRamsEcc
argument_list|(
name|h_Fm
argument_list|)
operator|)
operator|!=
name|E_OK
operator|)
condition|)
if|#
directive|if
operator|(
operator|!
operator|(
name|defined
argument_list|(
name|DEBUG_ERRORS
argument_list|)
operator|)
operator|||
operator|(
name|DEBUG_ERRORS
operator|==
literal|0
operator|)
operator|)
name|UNUSED
argument_list|(
name|err
argument_list|)
expr_stmt|;
else|#
directive|else
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* (!(defined(DEBUG_ERRORS)) || (DEBUG_ERRORS == 0)) */
break|break;
block|}
case|case
operator|(
name|FM_SET_NUM_OF_FMAN_CTRL
operator|)
case|:
block|{
name|t_FmIpcPortNumOfFmanCtrls
name|ipcPortNumOfFmanCtrls
decl_stmt|;
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcPortNumOfFmanCtrls
argument_list|,
name|p_IpcMsg
operator|->
name|msgBody
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcPortNumOfFmanCtrls
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|FmSetNumOfRiscsPerPort
argument_list|(
name|h_Fm
argument_list|,
name|ipcPortNumOfFmanCtrls
operator|.
name|hardwarePortId
argument_list|,
name|ipcPortNumOfFmanCtrls
operator|.
name|numOfFmanCtrls
argument_list|,
name|ipcPortNumOfFmanCtrls
operator|.
name|orFmanCtrl
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
break|break;
block|}
ifdef|#
directive|ifdef
name|FM_TX_ECC_FRMS_ERRATA_10GMAC_A004
case|case
operator|(
name|FM_10G_TX_ECC_WA
operator|)
case|:
name|p_IpcReply
operator|->
name|error
operator|=
operator|(
name|uint32_t
operator|)
name|Fm10GTxEccWorkaround
argument_list|(
name|h_Fm
argument_list|,
name|p_IpcMsg
operator|->
name|msgBody
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
operator|*
name|p_ReplyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* FM_TX_ECC_FRMS_ERRATA_10GMAC_A004 */
default|default:
operator|*
name|p_ReplyLength
operator|=
literal|0
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
operator|(
literal|"command not found!!!"
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/****************************************/
end_comment

begin_comment
comment|/*       Inter-Module functions         */
end_comment

begin_comment
comment|/****************************************/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|FM_TX_ECC_FRMS_ERRATA_10GMAC_A004
end_ifdef

begin_function
name|t_Error
name|Fm10GTxEccWorkaround
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint8_t
name|macId
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|t_FmIpcReply
name|reply
decl_stmt|;
name|uint32_t
name|replyLength
decl_stmt|;
name|uint8_t
name|rxHardwarePortId
decl_stmt|,
name|txHardwarePortId
decl_stmt|;
name|struct
name|fman_fpm_regs
modifier|*
name|fpm_rg
init|=
name|p_Fm
operator|->
name|p_FmFpmRegs
decl_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
block|{
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_10G_TX_ECC_WA
expr_stmt|;
name|msg
operator|.
name|msgBody
index|[
literal|0
index|]
operator|=
name|macId
expr_stmt|;
name|replyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|macId
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|replyLength
operator|!=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"IPC reply length mismatch"
operator|)
argument_list|)
expr_stmt|;
return|return
call|(
name|t_Error
call|)
argument_list|(
name|reply
operator|.
name|error
argument_list|)
return|;
block|}
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|macId
operator|==
literal|0
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|IsFmanCtrlCodeLoaded
argument_list|(
name|p_Fm
argument_list|)
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|rxHardwarePortId
operator|=
name|SwPortIdToHwPortId
argument_list|(
name|e_FM_PORT_TYPE_RX_10G
argument_list|,
name|macId
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|minorRev
argument_list|)
expr_stmt|;
name|txHardwarePortId
operator|=
name|SwPortIdToHwPortId
argument_list|(
name|e_FM_PORT_TYPE_TX_10G
argument_list|,
name|macId
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|minorRev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|portsTypes
index|[
name|rxHardwarePortId
index|]
operator|!=
name|e_FM_PORT_TYPE_DUMMY
operator|)
operator|||
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|portsTypes
index|[
name|txHardwarePortId
index|]
operator|!=
name|e_FM_PORT_TYPE_DUMMY
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"MAC should be initialized prior to Rx and Tx ports!"
operator|)
argument_list|)
expr_stmt|;
return|return
name|fman_set_erratum_10gmac_a004_wa
argument_list|(
name|fpm_rg
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* FM_TX_ECC_FRMS_ERRATA_10GMAC_A004 */
end_comment

begin_function
name|uint16_t
name|FmGetTnumAgingPeriod
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
operator|!
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|p_Fm
operator|->
name|tnumAgingPeriod
return|;
block|}
end_function

begin_function
name|t_Error
name|FmSetPortPreFetchConfiguration
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint8_t
name|portNum
parameter_list|,
name|bool
name|preFetchConfigured
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|portsPreFetchConfigured
index|[
name|portNum
index|]
operator|=
name|TRUE
expr_stmt|;
name|p_Fm
operator|->
name|portsPreFetchValue
index|[
name|portNum
index|]
operator|=
name|preFetchConfigured
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FmGetPortPreFetchConfiguration
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint8_t
name|portNum
parameter_list|,
name|bool
modifier|*
name|p_PortConfigured
parameter_list|,
name|bool
modifier|*
name|p_PreFetchConfigured
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
comment|/* If the prefetch wasn't configured yet (not enable or disabled)        we return the value TRUE as it was already configured */
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|portsPreFetchConfigured
index|[
name|portNum
index|]
condition|)
block|{
operator|*
name|p_PortConfigured
operator|=
name|FALSE
expr_stmt|;
operator|*
name|p_PreFetchConfigured
operator|=
name|FALSE
expr_stmt|;
block|}
else|else
block|{
operator|*
name|p_PortConfigured
operator|=
name|TRUE
expr_stmt|;
operator|*
name|p_PreFetchConfigured
operator|=
operator|(
name|p_Fm
operator|->
name|portsPreFetchConfigured
index|[
name|portNum
index|]
operator|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FmSetCongestionGroupPFCpriority
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint32_t
name|congestionGroupId
parameter_list|,
name|uint8_t
name|priorityBitMap
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|uint32_t
name|regNum
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|h_Fm
argument_list|)
expr_stmt|;
if|if
condition|(
name|congestionGroupId
operator|>
name|FM_PORT_NUM_OF_CONGESTION_GRPS
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Congestion group ID bigger than %d"
operator|,
name|FM_PORT_NUM_OF_CONGESTION_GRPS
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
condition|)
block|{
name|ASSERT_COND
argument_list|(
name|p_Fm
operator|->
name|baseAddr
argument_list|)
expr_stmt|;
name|regNum
operator|=
operator|(
name|FM_PORT_NUM_OF_CONGESTION_GRPS
operator|-
literal|1
operator|-
name|congestionGroupId
operator|)
operator|/
literal|4
expr_stmt|;
name|fman_set_congestion_group_pfc_priority
argument_list|(
operator|(
name|uint32_t
operator|*
operator|)
operator|(
operator|(
name|p_Fm
operator|->
name|baseAddr
operator|+
name|FM_MM_CGP
operator|)
operator|)
argument_list|,
name|congestionGroupId
argument_list|,
name|priorityBitMap
argument_list|,
name|regNum
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
condition|)
block|{
name|t_Error
name|err
decl_stmt|;
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|t_FmIpcSetCongestionGroupPfcPriority
name|fmIpcSetCongestionGroupPfcPriority
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|fmIpcSetCongestionGroupPfcPriority
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcSetCongestionGroupPfcPriority
argument_list|)
argument_list|)
expr_stmt|;
name|fmIpcSetCongestionGroupPfcPriority
operator|.
name|congestionGroupId
operator|=
name|congestionGroupId
expr_stmt|;
name|fmIpcSetCongestionGroupPfcPriority
operator|.
name|priorityBitMap
operator|=
name|priorityBitMap
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_SET_CONG_GRP_PFC_PRIO
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|&
name|fmIpcSetCongestionGroupPfcPriority
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcSetCongestionGroupPfcPriority
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
else|else
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"guest without IPC!"
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|uintptr_t
name|FmGetPcdPrsBaseAddr
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|baseAddr
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"No base-addr; probably Guest with IPC!"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
operator|(
name|p_Fm
operator|->
name|baseAddr
operator|+
name|FM_MM_PRS
operator|)
return|;
block|}
end_function

begin_function
name|uintptr_t
name|FmGetPcdKgBaseAddr
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|baseAddr
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"No base-addr; probably Guest with IPC!"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
operator|(
name|p_Fm
operator|->
name|baseAddr
operator|+
name|FM_MM_KG
operator|)
return|;
block|}
end_function

begin_function
name|uintptr_t
name|FmGetPcdPlcrBaseAddr
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|baseAddr
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"No base-addr; probably Guest with IPC!"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
operator|(
name|p_Fm
operator|->
name|baseAddr
operator|+
name|FM_MM_PLCR
operator|)
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|(
name|DPAA_VERSION
operator|>=
literal|11
operator|)
end_if

begin_function
name|uintptr_t
name|FmGetVSPBaseAddr
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|p_Fm
operator|->
name|vspBaseAddr
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* (DPAA_VERSION>= 11) */
end_comment

begin_function
name|t_Handle
name|FmGetMuramHandle
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|p_Fm
operator|->
name|h_FmMuram
operator|)
return|;
block|}
end_function

begin_function
name|void
name|FmGetPhysicalMuramBase
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|t_FmPhysAddr
modifier|*
name|p_FmPhysAddr
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|fmMuramPhysBaseAddr
condition|)
block|{
comment|/* General FM driver initialization */
name|p_FmPhysAddr
operator|->
name|low
operator|=
operator|(
name|uint32_t
operator|)
name|p_Fm
operator|->
name|fmMuramPhysBaseAddr
expr_stmt|;
name|p_FmPhysAddr
operator|->
name|high
operator|=
call|(
name|uint8_t
call|)
argument_list|(
operator|(
name|p_Fm
operator|->
name|fmMuramPhysBaseAddr
operator|&
literal|0x000000ff00000000LL
operator|)
operator|>>
literal|32
argument_list|)
expr_stmt|;
return|return;
block|}
name|ASSERT_COND
argument_list|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
condition|)
block|{
name|t_Error
name|err
decl_stmt|;
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|t_FmIpcReply
name|reply
decl_stmt|;
name|uint32_t
name|replyLength
decl_stmt|;
name|t_FmIpcPhysAddr
name|ipcPhysAddr
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_GET_PHYS_MURAM_BASE
expr_stmt|;
name|replyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|t_FmPhysAddr
argument_list|)
expr_stmt|;
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|replyLength
operator|!=
operator|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|t_FmPhysAddr
argument_list|)
operator|)
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"IPC reply length mismatch"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcPhysAddr
argument_list|,
name|reply
operator|.
name|replyBody
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcPhysAddr
argument_list|)
argument_list|)
expr_stmt|;
name|p_FmPhysAddr
operator|->
name|high
operator|=
name|ipcPhysAddr
operator|.
name|high
expr_stmt|;
name|p_FmPhysAddr
operator|->
name|low
operator|=
name|ipcPhysAddr
operator|.
name|low
expr_stmt|;
block|}
else|else
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"running in guest-mode without neither IPC nor mapped register!"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_if
if|#
directive|if
operator|(
name|DPAA_VERSION
operator|>=
literal|11
operator|)
end_if

begin_function
name|t_Error
name|FmVSPAllocForPort
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|e_FmPortType
name|portType
parameter_list|,
name|uint8_t
name|portId
parameter_list|,
name|uint8_t
name|numOfVSPs
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|uint32_t
name|profilesFound
decl_stmt|,
name|intFlags
decl_stmt|;
name|uint8_t
name|first
decl_stmt|,
name|i
decl_stmt|;
name|uint8_t
name|log2Num
decl_stmt|;
name|uint8_t
name|swPortIndex
init|=
literal|0
decl_stmt|,
name|hardwarePortId
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|numOfVSPs
condition|)
return|return
name|E_OK
return|;
if|if
condition|(
name|numOfVSPs
operator|>
name|FM_VSP_MAX_NUM_OF_ENTRIES
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"numProfiles can not be bigger than %d."
operator|,
name|FM_VSP_MAX_NUM_OF_ENTRIES
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|POWER_OF_2
argument_list|(
name|numOfVSPs
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"numProfiles must be a power of 2."
operator|)
argument_list|)
expr_stmt|;
name|LOG2
argument_list|(
operator|(
name|uint64_t
operator|)
name|numOfVSPs
argument_list|,
name|log2Num
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|log2Num
operator|==
literal|0
operator|)
operator|||
operator|(
name|p_Fm
operator|->
name|partVSPBase
operator|==
literal|0
operator|)
condition|)
name|first
operator|=
literal|0
expr_stmt|;
else|else
name|first
operator|=
literal|1
operator|<<
name|log2Num
expr_stmt|;
if|if
condition|(
name|first
operator|>
operator|(
name|p_Fm
operator|->
name|partVSPBase
operator|+
name|p_Fm
operator|->
name|partNumOfVSPs
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"can not allocate storage profile port window"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|first
operator|<
name|p_Fm
operator|->
name|partVSPBase
condition|)
while|while
condition|(
name|first
operator|<
name|p_Fm
operator|->
name|partVSPBase
condition|)
name|first
operator|=
name|first
operator|+
name|numOfVSPs
expr_stmt|;
if|if
condition|(
operator|(
name|first
operator|+
name|numOfVSPs
operator|)
operator|>
operator|(
name|p_Fm
operator|->
name|partVSPBase
operator|+
name|p_Fm
operator|->
name|partNumOfVSPs
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"can not allocate storage profile port window"
operator|)
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|XX_LockIntrSpinlock
argument_list|(
name|p_Fm
operator|->
name|h_Spinlock
argument_list|)
expr_stmt|;
name|profilesFound
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
name|first
init|;
name|i
operator|<
name|p_Fm
operator|->
name|partVSPBase
operator|+
name|p_Fm
operator|->
name|partNumOfVSPs
condition|;
control|)
block|{
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|p_FmSp
operator|->
name|profiles
index|[
name|i
index|]
operator|.
name|profilesMng
operator|.
name|allocated
condition|)
block|{
name|profilesFound
operator|++
expr_stmt|;
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|profilesFound
operator|==
name|numOfVSPs
condition|)
break|break;
block|}
else|else
block|{
name|profilesFound
operator|=
literal|0
expr_stmt|;
comment|/* advance i to the next aligned address */
name|first
operator|=
name|i
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|first
operator|+
name|numOfVSPs
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|profilesFound
operator|==
name|numOfVSPs
condition|)
for|for
control|(
name|i
operator|=
name|first
init|;
name|i
operator|<
name|first
operator|+
name|numOfVSPs
condition|;
name|i
operator|++
control|)
name|p_Fm
operator|->
name|p_FmSp
operator|->
name|profiles
index|[
name|i
index|]
operator|.
name|profilesMng
operator|.
name|allocated
operator|=
name|TRUE
expr_stmt|;
else|else
block|{
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_Fm
operator|->
name|h_Spinlock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_FULL
argument_list|,
operator|(
literal|"No profiles."
operator|)
argument_list|)
expr_stmt|;
block|}
name|hardwarePortId
operator|=
name|SwPortIdToHwPortId
argument_list|(
name|portType
argument_list|,
name|portId
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|minorRev
argument_list|)
expr_stmt|;
name|HW_PORT_ID_TO_SW_PORT_INDX
argument_list|(
name|swPortIndex
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmSp
operator|->
name|portsMapping
index|[
name|swPortIndex
index|]
operator|.
name|numOfProfiles
operator|=
name|numOfVSPs
expr_stmt|;
name|p_Fm
operator|->
name|p_FmSp
operator|->
name|portsMapping
index|[
name|swPortIndex
index|]
operator|.
name|profilesBase
operator|=
name|first
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|SetVSPWindow
argument_list|(
name|h_Fm
argument_list|,
name|hardwarePortId
argument_list|,
name|first
argument_list|,
name|log2Num
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
for|for
control|(
name|i
operator|=
name|first
init|;
name|i
operator|<
name|first
operator|+
name|numOfVSPs
condition|;
name|i
operator|++
control|)
name|p_Fm
operator|->
name|p_FmSp
operator|->
name|profiles
index|[
name|i
index|]
operator|.
name|profilesMng
operator|.
name|allocated
operator|=
name|FALSE
expr_stmt|;
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_Fm
operator|->
name|h_Spinlock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
name|t_Error
name|FmVSPFreeForPort
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|e_FmPortType
name|portType
parameter_list|,
name|uint8_t
name|portId
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|uint8_t
name|swPortIndex
init|=
literal|0
decl_stmt|,
name|hardwarePortId
decl_stmt|,
name|first
decl_stmt|,
name|numOfVSPs
decl_stmt|,
name|i
decl_stmt|;
name|uint32_t
name|intFlags
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|hardwarePortId
operator|=
name|SwPortIdToHwPortId
argument_list|(
name|portType
argument_list|,
name|portId
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|minorRev
argument_list|)
expr_stmt|;
name|HW_PORT_ID_TO_SW_PORT_INDX
argument_list|(
name|swPortIndex
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
name|numOfVSPs
operator|=
operator|(
name|uint8_t
operator|)
name|p_Fm
operator|->
name|p_FmSp
operator|->
name|portsMapping
index|[
name|swPortIndex
index|]
operator|.
name|numOfProfiles
expr_stmt|;
name|first
operator|=
operator|(
name|uint8_t
operator|)
name|p_Fm
operator|->
name|p_FmSp
operator|->
name|portsMapping
index|[
name|swPortIndex
index|]
operator|.
name|profilesBase
expr_stmt|;
name|intFlags
operator|=
name|XX_LockIntrSpinlock
argument_list|(
name|p_Fm
operator|->
name|h_Spinlock
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|first
init|;
name|i
operator|<
name|first
operator|+
name|numOfVSPs
condition|;
name|i
operator|++
control|)
name|p_Fm
operator|->
name|p_FmSp
operator|->
name|profiles
index|[
name|i
index|]
operator|.
name|profilesMng
operator|.
name|allocated
operator|=
name|FALSE
expr_stmt|;
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_Fm
operator|->
name|h_Spinlock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmSp
operator|->
name|portsMapping
index|[
name|swPortIndex
index|]
operator|.
name|numOfProfiles
operator|=
literal|0
expr_stmt|;
name|p_Fm
operator|->
name|p_FmSp
operator|->
name|portsMapping
index|[
name|swPortIndex
index|]
operator|.
name|profilesBase
operator|=
literal|0
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* (DPAA_VERSION>= 11) */
end_comment

begin_function
name|t_Error
name|FmAllocFmanCtrlEventReg
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint8_t
modifier|*
name|p_EventId
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|uint8_t
name|i
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|&&
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
condition|)
block|{
name|t_Error
name|err
decl_stmt|;
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|t_FmIpcReply
name|reply
decl_stmt|;
name|uint32_t
name|replyLength
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_ALLOC_FMAN_CTRL_EVENT_REG
expr_stmt|;
name|replyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|replyLength
operator|!=
operator|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"IPC reply length mismatch"
operator|)
argument_list|)
expr_stmt|;
operator|*
name|p_EventId
operator|=
operator|*
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|reply
operator|.
name|replyBody
operator|)
expr_stmt|;
return|return
call|(
name|t_Error
call|)
argument_list|(
name|reply
operator|.
name|error
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"running in guest-mode without IPC!"
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|FM_NUM_OF_FMAN_CTRL_EVENT_REGS
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|usedEventRegs
index|[
name|i
index|]
condition|)
block|{
name|p_Fm
operator|->
name|usedEventRegs
index|[
name|i
index|]
operator|=
name|TRUE
expr_stmt|;
operator|*
name|p_EventId
operator|=
name|i
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|i
operator|==
name|FM_NUM_OF_FMAN_CTRL_EVENT_REGS
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_BUSY
argument_list|,
operator|(
literal|"No resource - FMan controller event register."
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|void
name|FmFreeFmanCtrlEventReg
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint8_t
name|eventId
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|&&
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
condition|)
block|{
name|t_Error
name|err
decl_stmt|;
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_FREE_FMAN_CTRL_EVENT_REG
expr_stmt|;
name|msg
operator|.
name|msgBody
index|[
literal|0
index|]
operator|=
name|eventId
expr_stmt|;
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|eventId
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"running in guest-mode without IPC!"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
operator|(
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
operator|)
operator|->
name|usedEventRegs
index|[
name|eventId
index|]
operator|=
name|FALSE
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FmSetFmanCtrlIntr
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint8_t
name|eventRegId
parameter_list|,
name|uint32_t
name|enableEvents
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|struct
name|fman_fpm_regs
modifier|*
name|fpm_rg
init|=
name|p_Fm
operator|->
name|p_FmFpmRegs
decl_stmt|;
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|&&
operator|!
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|&&
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
condition|)
block|{
name|t_FmIpcFmanEvents
name|fmanCtrl
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|fmanCtrl
operator|.
name|eventRegId
operator|=
name|eventRegId
expr_stmt|;
name|fmanCtrl
operator|.
name|enableEvents
operator|=
name|enableEvents
expr_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_SET_FMAN_CTRL_EVENTS_ENABLE
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|&
name|fmanCtrl
argument_list|,
sizeof|sizeof
argument_list|(
name|fmanCtrl
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|fmanCtrl
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|p_FmFpmRegs
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"Either IPC or 'baseAddress' is required!"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|ASSERT_COND
argument_list|(
name|eventRegId
operator|<
name|FM_NUM_OF_FMAN_CTRL_EVENT_REGS
argument_list|)
expr_stmt|;
name|fman_set_ctrl_intr
argument_list|(
name|fpm_rg
argument_list|,
name|eventRegId
argument_list|,
name|enableEvents
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|uint32_t
name|FmGetFmanCtrlIntr
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint8_t
name|eventRegId
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|struct
name|fman_fpm_regs
modifier|*
name|fpm_rg
init|=
name|p_Fm
operator|->
name|p_FmFpmRegs
decl_stmt|;
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|&&
operator|!
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|&&
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
condition|)
block|{
name|t_Error
name|err
decl_stmt|;
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|t_FmIpcReply
name|reply
decl_stmt|;
name|uint32_t
name|replyLength
decl_stmt|,
name|ctrlIntr
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_GET_FMAN_CTRL_EVENTS_ENABLE
expr_stmt|;
name|msg
operator|.
name|msgBody
index|[
literal|0
index|]
operator|=
name|eventRegId
expr_stmt|;
name|replyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|eventRegId
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|replyLength
operator|!=
operator|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|)
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"IPC reply length mismatch"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ctrlIntr
argument_list|,
name|reply
operator|.
name|replyBody
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ctrlIntr
return|;
block|}
elseif|else
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|p_FmFpmRegs
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"Either IPC or 'baseAddress' is required!"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|fman_get_ctrl_intr
argument_list|(
name|fpm_rg
argument_list|,
name|eventRegId
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|FmRegisterIntr
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|e_FmEventModules
name|module
parameter_list|,
name|uint8_t
name|modId
parameter_list|,
name|e_FmIntrType
name|intrType
parameter_list|,
name|void
function_decl|(
modifier|*
name|f_Isr
function_decl|)
parameter_list|(
name|t_Handle
name|h_Arg
parameter_list|)
parameter_list|,
name|t_Handle
name|h_Arg
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|int
name|event
init|=
literal|0
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|h_Fm
argument_list|)
expr_stmt|;
name|GET_FM_MODULE_EVENT
argument_list|(
name|module
argument_list|,
name|modId
argument_list|,
name|intrType
argument_list|,
name|event
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|event
operator|<
name|e_FM_EV_DUMMY_LAST
argument_list|)
expr_stmt|;
comment|/* register in local FM structure */
name|p_Fm
operator|->
name|intrMng
index|[
name|event
index|]
operator|.
name|f_Isr
operator|=
name|f_Isr
expr_stmt|;
name|p_Fm
operator|->
name|intrMng
index|[
name|event
index|]
operator|.
name|h_SrcHandle
operator|=
name|h_Arg
expr_stmt|;
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|&&
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
condition|)
block|{
name|t_FmIpcRegisterIntr
name|fmIpcRegisterIntr
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|t_FmIpcMsg
name|msg
decl_stmt|;
comment|/* register in Master FM structure */
name|fmIpcRegisterIntr
operator|.
name|event
operator|=
operator|(
name|uint32_t
operator|)
name|event
expr_stmt|;
name|fmIpcRegisterIntr
operator|.
name|guestId
operator|=
name|p_Fm
operator|->
name|guestId
expr_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_REGISTER_INTR
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|&
name|fmIpcRegisterIntr
argument_list|,
sizeof|sizeof
argument_list|(
name|fmIpcRegisterIntr
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|fmIpcRegisterIntr
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"running in guest-mode without IPC!"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FmUnregisterIntr
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|e_FmEventModules
name|module
parameter_list|,
name|uint8_t
name|modId
parameter_list|,
name|e_FmIntrType
name|intrType
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|int
name|event
init|=
literal|0
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|h_Fm
argument_list|)
expr_stmt|;
name|GET_FM_MODULE_EVENT
argument_list|(
name|module
argument_list|,
name|modId
argument_list|,
name|intrType
argument_list|,
name|event
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|event
operator|<
name|e_FM_EV_DUMMY_LAST
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|intrMng
index|[
name|event
index|]
operator|.
name|f_Isr
operator|=
name|UnimplementedIsr
expr_stmt|;
name|p_Fm
operator|->
name|intrMng
index|[
name|event
index|]
operator|.
name|h_SrcHandle
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FmRegisterFmanCtrlIntr
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint8_t
name|eventRegId
parameter_list|,
name|void
function_decl|(
modifier|*
name|f_Isr
function_decl|)
parameter_list|(
name|t_Handle
name|h_Arg
parameter_list|,
name|uint32_t
name|event
parameter_list|)
parameter_list|,
name|t_Handle
name|h_Arg
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|eventRegId
operator|<
name|FM_NUM_OF_FMAN_CTRL_EVENT_REGS
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"FM in guest-mode"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|p_Fm
operator|->
name|fmanCtrlIntr
index|[
name|eventRegId
index|]
operator|.
name|f_Isr
operator|=
name|f_Isr
expr_stmt|;
name|p_Fm
operator|->
name|fmanCtrlIntr
index|[
name|eventRegId
index|]
operator|.
name|h_SrcHandle
operator|=
name|h_Arg
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FmUnregisterFmanCtrlIntr
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint8_t
name|eventRegId
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|eventRegId
operator|<
name|FM_NUM_OF_FMAN_CTRL_EVENT_REGS
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"FM in guest-mode"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|p_Fm
operator|->
name|fmanCtrlIntr
index|[
name|eventRegId
index|]
operator|.
name|f_Isr
operator|=
name|UnimplementedFmanCtrlIsr
expr_stmt|;
name|p_Fm
operator|->
name|fmanCtrlIntr
index|[
name|eventRegId
index|]
operator|.
name|h_SrcHandle
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FmRegisterPcd
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|t_Handle
name|h_FmPcd
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|h_Pcd
condition|)
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_ALREADY_EXISTS
argument_list|,
operator|(
literal|"PCD already set"
operator|)
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|h_Pcd
operator|=
name|h_FmPcd
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FmUnregisterPcd
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|h_Pcd
condition|)
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_FOUND
argument_list|,
operator|(
literal|"PCD handle!"
operator|)
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|h_Pcd
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|t_Handle
name|FmGetPcdHandle
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
return|return
name|p_Fm
operator|->
name|h_Pcd
return|;
block|}
end_function

begin_function
name|uint8_t
name|FmGetId
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0xff
argument_list|)
expr_stmt|;
return|return
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|fmId
return|;
block|}
end_function

begin_function
name|t_Error
name|FmReset
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|->
name|fm_rstc
argument_list|,
name|FPM_RSTC_FM_RESET
argument_list|)
expr_stmt|;
name|CORE_MemoryBarrier
argument_list|()
expr_stmt|;
name|XX_UDelay
argument_list|(
literal|100
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FmSetNumOfRiscsPerPort
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint8_t
name|hardwarePortId
parameter_list|,
name|uint8_t
name|numOfFmanCtrls
parameter_list|,
name|t_FmFmanCtrl
name|orFmanCtrl
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|struct
name|fman_fpm_regs
modifier|*
name|fpm_rg
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
operator|(
name|numOfFmanCtrls
operator|>
literal|0
operator|)
operator|&&
operator|(
name|numOfFmanCtrls
operator|<
literal|3
operator|)
operator|)
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|fpm_rg
operator|=
name|p_Fm
operator|->
name|p_FmFpmRegs
expr_stmt|;
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|&&
operator|!
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|&&
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
condition|)
block|{
name|t_Error
name|err
decl_stmt|;
name|t_FmIpcPortNumOfFmanCtrls
name|params
decl_stmt|;
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|hardwarePortId
operator|=
name|hardwarePortId
expr_stmt|;
name|params
operator|.
name|numOfFmanCtrls
operator|=
name|numOfFmanCtrls
expr_stmt|;
name|params
operator|.
name|orFmanCtrl
operator|=
name|orFmanCtrl
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_SET_NUM_OF_FMAN_CTRL
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|&
name|params
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
elseif|else
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|p_FmFpmRegs
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"Either IPC or 'baseAddress' is required!"
operator|)
argument_list|)
expr_stmt|;
name|fman_set_num_of_riscs_per_port
argument_list|(
name|fpm_rg
argument_list|,
name|hardwarePortId
argument_list|,
name|numOfFmanCtrls
argument_list|,
name|orFmanCtrl
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FmGetSetPortParams
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|t_FmInterModulePortInitParams
modifier|*
name|p_PortParams
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|uint32_t
name|intFlags
decl_stmt|;
name|uint8_t
name|hardwarePortId
init|=
name|p_PortParams
operator|->
name|hardwarePortId
decl_stmt|,
name|macId
decl_stmt|;
name|struct
name|fman_rg
name|fman_rg
decl_stmt|;
name|fman_rg
operator|.
name|bmi_rg
operator|=
name|p_Fm
operator|->
name|p_FmBmiRegs
expr_stmt|;
name|fman_rg
operator|.
name|qmi_rg
operator|=
name|p_Fm
operator|->
name|p_FmQmiRegs
expr_stmt|;
name|fman_rg
operator|.
name|fpm_rg
operator|=
name|p_Fm
operator|->
name|p_FmFpmRegs
expr_stmt|;
name|fman_rg
operator|.
name|dma_rg
operator|=
name|p_Fm
operator|->
name|p_FmDmaRegs
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
block|{
name|t_FmIpcPortInInitParams
name|portInParams
decl_stmt|;
name|t_FmIpcPortOutInitParams
name|portOutParams
decl_stmt|;
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|t_FmIpcReply
name|reply
decl_stmt|;
name|uint32_t
name|replyLength
decl_stmt|;
name|portInParams
operator|.
name|hardwarePortId
operator|=
name|p_PortParams
operator|->
name|hardwarePortId
expr_stmt|;
name|portInParams
operator|.
name|enumPortType
operator|=
operator|(
name|uint32_t
operator|)
name|p_PortParams
operator|->
name|portType
expr_stmt|;
name|portInParams
operator|.
name|boolIndependentMode
operator|=
operator|(
name|uint8_t
operator|)
name|p_PortParams
operator|->
name|independentMode
expr_stmt|;
name|portInParams
operator|.
name|liodnOffset
operator|=
name|p_PortParams
operator|->
name|liodnOffset
expr_stmt|;
name|portInParams
operator|.
name|numOfTasks
operator|=
name|p_PortParams
operator|->
name|numOfTasks
expr_stmt|;
name|portInParams
operator|.
name|numOfExtraTasks
operator|=
name|p_PortParams
operator|->
name|numOfExtraTasks
expr_stmt|;
name|portInParams
operator|.
name|numOfOpenDmas
operator|=
name|p_PortParams
operator|->
name|numOfOpenDmas
expr_stmt|;
name|portInParams
operator|.
name|numOfExtraOpenDmas
operator|=
name|p_PortParams
operator|->
name|numOfExtraOpenDmas
expr_stmt|;
name|portInParams
operator|.
name|sizeOfFifo
operator|=
name|p_PortParams
operator|->
name|sizeOfFifo
expr_stmt|;
name|portInParams
operator|.
name|extraSizeOfFifo
operator|=
name|p_PortParams
operator|->
name|extraSizeOfFifo
expr_stmt|;
name|portInParams
operator|.
name|deqPipelineDepth
operator|=
name|p_PortParams
operator|->
name|deqPipelineDepth
expr_stmt|;
name|portInParams
operator|.
name|maxFrameLength
operator|=
name|p_PortParams
operator|->
name|maxFrameLength
expr_stmt|;
name|portInParams
operator|.
name|liodnBase
operator|=
name|p_PortParams
operator|->
name|liodnBase
expr_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_GET_SET_PORT_PARAMS
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|&
name|portInParams
argument_list|,
sizeof|sizeof
argument_list|(
name|portInParams
argument_list|)
argument_list|)
expr_stmt|;
name|replyLength
operator|=
operator|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|t_FmIpcPortOutInitParams
argument_list|)
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|portInParams
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|replyLength
operator|!=
operator|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|t_FmIpcPortOutInitParams
argument_list|)
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"IPC reply length mismatch"
operator|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|portOutParams
argument_list|,
name|reply
operator|.
name|replyBody
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcPortOutInitParams
argument_list|)
argument_list|)
expr_stmt|;
name|p_PortParams
operator|->
name|fmMuramPhysBaseAddr
operator|.
name|high
operator|=
name|portOutParams
operator|.
name|ipcPhysAddr
operator|.
name|high
expr_stmt|;
name|p_PortParams
operator|->
name|fmMuramPhysBaseAddr
operator|.
name|low
operator|=
name|portOutParams
operator|.
name|ipcPhysAddr
operator|.
name|low
expr_stmt|;
name|p_PortParams
operator|->
name|numOfTasks
operator|=
name|portOutParams
operator|.
name|numOfTasks
expr_stmt|;
name|p_PortParams
operator|->
name|numOfExtraTasks
operator|=
name|portOutParams
operator|.
name|numOfExtraTasks
expr_stmt|;
name|p_PortParams
operator|->
name|numOfOpenDmas
operator|=
name|portOutParams
operator|.
name|numOfOpenDmas
expr_stmt|;
name|p_PortParams
operator|->
name|numOfExtraOpenDmas
operator|=
name|portOutParams
operator|.
name|numOfExtraOpenDmas
expr_stmt|;
name|p_PortParams
operator|->
name|sizeOfFifo
operator|=
name|portOutParams
operator|.
name|sizeOfFifo
expr_stmt|;
name|p_PortParams
operator|->
name|extraSizeOfFifo
operator|=
name|portOutParams
operator|.
name|extraSizeOfFifo
expr_stmt|;
return|return
call|(
name|t_Error
call|)
argument_list|(
name|reply
operator|.
name|error
argument_list|)
return|;
block|}
name|ASSERT_COND
argument_list|(
name|IN_RANGE
argument_list|(
literal|1
argument_list|,
name|hardwarePortId
argument_list|,
literal|63
argument_list|)
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|XX_LockIntrSpinlock
argument_list|(
name|p_Fm
operator|->
name|h_Spinlock
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_PortParams
operator|->
name|independentMode
condition|)
block|{
comment|/* set port parameters */
name|p_Fm
operator|->
name|independentMode
operator|=
name|p_PortParams
operator|->
name|independentMode
expr_stmt|;
comment|/* disable dispatch limit */
name|fman_qmi_disable_dispatch_limit
argument_list|(
name|fman_rg
operator|.
name|fpm_rg
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p_PortParams
operator|->
name|portType
operator|==
name|e_FM_PORT_TYPE_OH_HOST_COMMAND
condition|)
block|{
if|if
condition|(
name|p_Fm
operator|->
name|hcPortInitialized
condition|)
block|{
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_Fm
operator|->
name|h_Spinlock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Only one host command port is allowed."
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
name|p_Fm
operator|->
name|hcPortInitialized
operator|=
name|TRUE
expr_stmt|;
block|}
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|portsTypes
index|[
name|hardwarePortId
index|]
operator|=
name|p_PortParams
operator|->
name|portType
expr_stmt|;
name|err
operator|=
name|FmSetNumOfTasks
argument_list|(
name|p_Fm
argument_list|,
name|hardwarePortId
argument_list|,
operator|&
name|p_PortParams
operator|->
name|numOfTasks
argument_list|,
operator|&
name|p_PortParams
operator|->
name|numOfExtraTasks
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_Fm
operator|->
name|h_Spinlock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|FM_QMI_NO_DEQ_OPTIONS_SUPPORT
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|!=
literal|4
condition|)
endif|#
directive|endif
comment|/* FM_QMI_NO_DEQ_OPTIONS_SUPPORT */
if|if
condition|(
operator|(
name|p_PortParams
operator|->
name|portType
operator|!=
name|e_FM_PORT_TYPE_RX
operator|)
operator|&&
operator|(
name|p_PortParams
operator|->
name|portType
operator|!=
name|e_FM_PORT_TYPE_RX_10G
operator|)
condition|)
comment|/* for transmit& O/H ports */
block|{
name|uint8_t
name|enqTh
decl_stmt|;
name|uint8_t
name|deqTh
decl_stmt|;
comment|/* update qmi ENQ/DEQ threshold */
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedNumOfDeqTnums
operator|+=
name|p_PortParams
operator|->
name|deqPipelineDepth
expr_stmt|;
name|enqTh
operator|=
name|fman_get_qmi_enq_th
argument_list|(
name|fman_rg
operator|.
name|qmi_rg
argument_list|)
expr_stmt|;
comment|/* if enqTh is too big, we reduce it to the max value that is still OK */
if|if
condition|(
name|enqTh
operator|>=
operator|(
name|QMI_MAX_NUM_OF_TNUMS
operator|-
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedNumOfDeqTnums
operator|)
condition|)
block|{
name|enqTh
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|QMI_MAX_NUM_OF_TNUMS
operator|-
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedNumOfDeqTnums
operator|-
literal|1
argument_list|)
expr_stmt|;
name|fman_set_qmi_enq_th
argument_list|(
name|fman_rg
operator|.
name|qmi_rg
argument_list|,
name|enqTh
argument_list|)
expr_stmt|;
block|}
name|deqTh
operator|=
name|fman_get_qmi_deq_th
argument_list|(
name|fman_rg
operator|.
name|qmi_rg
argument_list|)
expr_stmt|;
comment|/* if deqTh is too small, we enlarge it to the min value that is still OK.          deqTh may not be larger than 63 (QMI_MAX_NUM_OF_TNUMS-1). */
if|if
condition|(
operator|(
name|deqTh
operator|<=
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedNumOfDeqTnums
operator|)
operator|&&
operator|(
name|deqTh
operator|<
name|QMI_MAX_NUM_OF_TNUMS
operator|-
literal|1
operator|)
condition|)
block|{
name|deqTh
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedNumOfDeqTnums
operator|+
literal|1
argument_list|)
expr_stmt|;
name|fman_set_qmi_deq_th
argument_list|(
name|fman_rg
operator|.
name|qmi_rg
argument_list|,
name|deqTh
argument_list|)
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|FM_LOW_END_RESTRICTION
if|if
condition|(
operator|(
name|hardwarePortId
operator|==
literal|0x1
operator|)
operator|||
operator|(
name|hardwarePortId
operator|==
literal|0x29
operator|)
condition|)
block|{
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|lowEndRestriction
condition|)
block|{
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_Fm
operator|->
name|h_Spinlock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_AVAILABLE
argument_list|,
operator|(
literal|"OP #0 cannot work with Tx Port #1."
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|lowEndRestriction
operator|=
name|TRUE
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* FM_LOW_END_RESTRICTION */
name|err
operator|=
name|FmSetSizeOfFifo
argument_list|(
name|p_Fm
argument_list|,
name|hardwarePortId
argument_list|,
operator|&
name|p_PortParams
operator|->
name|sizeOfFifo
argument_list|,
operator|&
name|p_PortParams
operator|->
name|extraSizeOfFifo
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_Fm
operator|->
name|h_Spinlock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|FmSetNumOfOpenDmas
argument_list|(
name|p_Fm
argument_list|,
name|hardwarePortId
argument_list|,
operator|&
name|p_PortParams
operator|->
name|numOfOpenDmas
argument_list|,
operator|&
name|p_PortParams
operator|->
name|numOfExtraOpenDmas
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_Fm
operator|->
name|h_Spinlock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|fman_set_liodn_per_port
argument_list|(
operator|&
name|fman_rg
argument_list|,
name|hardwarePortId
argument_list|,
name|p_PortParams
operator|->
name|liodnBase
argument_list|,
name|p_PortParams
operator|->
name|liodnOffset
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|<
literal|6
condition|)
name|fman_set_order_restoration_per_port
argument_list|(
name|fman_rg
operator|.
name|fpm_rg
argument_list|,
name|hardwarePortId
argument_list|,
name|p_PortParams
operator|->
name|independentMode
argument_list|,
operator|!
operator|!
operator|(
operator|(
name|p_PortParams
operator|->
name|portType
operator|==
name|e_FM_PORT_TYPE_RX
operator|)
operator|||
operator|(
name|p_PortParams
operator|->
name|portType
operator|==
name|e_FM_PORT_TYPE_RX_10G
operator|)
operator|)
argument_list|)
expr_stmt|;
name|HW_PORT_ID_TO_SW_PORT_ID
argument_list|(
name|macId
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|FM_MAX_NUM_OF_10G_MACS
argument_list|)
operator|&&
operator|(
name|FM_MAX_NUM_OF_10G_MACS
operator|)
if|if
condition|(
operator|(
name|p_PortParams
operator|->
name|portType
operator|==
name|e_FM_PORT_TYPE_TX_10G
operator|)
operator|||
operator|(
name|p_PortParams
operator|->
name|portType
operator|==
name|e_FM_PORT_TYPE_RX_10G
operator|)
condition|)
block|{
name|ASSERT_COND
argument_list|(
name|macId
operator|<
name|FM_MAX_NUM_OF_10G_MACS
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_PortParams
operator|->
name|maxFrameLength
operator|>=
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|macMaxFrameLengths10G
index|[
name|macId
index|]
condition|)
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|portMaxFrameLengths10G
index|[
name|macId
index|]
operator|=
name|p_PortParams
operator|->
name|maxFrameLength
expr_stmt|;
else|else
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Port maxFrameLength is smaller than MAC current MTU"
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
endif|#
directive|endif
comment|/* defined(FM_MAX_NUM_OF_10G_MACS)&& ... */
if|if
condition|(
operator|(
name|p_PortParams
operator|->
name|portType
operator|==
name|e_FM_PORT_TYPE_TX
operator|)
operator|||
operator|(
name|p_PortParams
operator|->
name|portType
operator|==
name|e_FM_PORT_TYPE_RX
operator|)
condition|)
block|{
name|ASSERT_COND
argument_list|(
name|macId
operator|<
name|FM_MAX_NUM_OF_1G_MACS
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_PortParams
operator|->
name|maxFrameLength
operator|>=
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|macMaxFrameLengths1G
index|[
name|macId
index|]
condition|)
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|portMaxFrameLengths1G
index|[
name|macId
index|]
operator|=
name|p_PortParams
operator|->
name|maxFrameLength
expr_stmt|;
else|else
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Port maxFrameLength is smaller than MAC current MTU"
operator|)
argument_list|)
expr_stmt|;
block|}
name|FmGetPhysicalMuramBase
argument_list|(
name|p_Fm
argument_list|,
operator|&
name|p_PortParams
operator|->
name|fmMuramPhysBaseAddr
argument_list|)
expr_stmt|;
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_Fm
operator|->
name|h_Spinlock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|void
name|FmFreePortParams
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|t_FmInterModulePortFreeParams
modifier|*
name|p_PortParams
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|uint32_t
name|intFlags
decl_stmt|;
name|uint8_t
name|hardwarePortId
init|=
name|p_PortParams
operator|->
name|hardwarePortId
decl_stmt|;
name|uint8_t
name|numOfTasks
decl_stmt|,
name|numOfDmas
decl_stmt|,
name|macId
decl_stmt|;
name|uint16_t
name|sizeOfFifo
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|t_FmIpcPortFreeParams
name|portParams
decl_stmt|;
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|struct
name|fman_qmi_regs
modifier|*
name|qmi_rg
init|=
name|p_Fm
operator|->
name|p_FmQmiRegs
decl_stmt|;
name|struct
name|fman_bmi_regs
modifier|*
name|bmi_rg
init|=
name|p_Fm
operator|->
name|p_FmBmiRegs
decl_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
block|{
name|portParams
operator|.
name|hardwarePortId
operator|=
name|p_PortParams
operator|->
name|hardwarePortId
expr_stmt|;
name|portParams
operator|.
name|enumPortType
operator|=
operator|(
name|uint32_t
operator|)
name|p_PortParams
operator|->
name|portType
expr_stmt|;
name|portParams
operator|.
name|deqPipelineDepth
operator|=
name|p_PortParams
operator|->
name|deqPipelineDepth
expr_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_FREE_PORT
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|&
name|portParams
argument_list|,
sizeof|sizeof
argument_list|(
name|portParams
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|portParams
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
return|return;
block|}
name|ASSERT_COND
argument_list|(
name|IN_RANGE
argument_list|(
literal|1
argument_list|,
name|hardwarePortId
argument_list|,
literal|63
argument_list|)
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|XX_LockIntrSpinlock
argument_list|(
name|p_Fm
operator|->
name|h_Spinlock
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_PortParams
operator|->
name|portType
operator|==
name|e_FM_PORT_TYPE_OH_HOST_COMMAND
condition|)
block|{
name|ASSERT_COND
argument_list|(
name|p_Fm
operator|->
name|hcPortInitialized
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|hcPortInitialized
operator|=
name|FALSE
expr_stmt|;
block|}
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|portsTypes
index|[
name|hardwarePortId
index|]
operator|=
name|e_FM_PORT_TYPE_DUMMY
expr_stmt|;
comment|/* free numOfTasks */
name|numOfTasks
operator|=
name|fman_get_num_of_tasks
argument_list|(
name|bmi_rg
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedNumOfTasks
operator|>=
name|numOfTasks
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedNumOfTasks
operator|-=
name|numOfTasks
expr_stmt|;
comment|/* free numOfOpenDmas */
name|numOfDmas
operator|=
name|fman_get_num_of_dmas
argument_list|(
name|bmi_rg
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedNumOfOpenDmas
operator|>=
name|numOfDmas
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedNumOfOpenDmas
operator|-=
name|numOfDmas
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_HAS_TOTAL_DMAS
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|<
literal|6
condition|)
block|{
comment|/* update total num of DMA's with committed number of open DMAS, and max uncommitted pool. */
name|fman_set_num_of_open_dmas
argument_list|(
name|bmi_rg
argument_list|,
name|hardwarePortId
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
call|(
name|uint8_t
call|)
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedNumOfOpenDmas
operator|+
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|extraOpenDmasPoolSize
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* FM_HAS_TOTAL_DMAS */
comment|/* free sizeOfFifo */
name|sizeOfFifo
operator|=
name|fman_get_size_of_fifo
argument_list|(
name|bmi_rg
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedFifoSize
operator|>=
operator|(
name|sizeOfFifo
operator|*
name|BMI_FIFO_UNITS
operator|)
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedFifoSize
operator|-=
operator|(
name|sizeOfFifo
operator|*
name|BMI_FIFO_UNITS
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_QMI_NO_DEQ_OPTIONS_SUPPORT
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|!=
literal|4
condition|)
endif|#
directive|endif
comment|/* FM_QMI_NO_DEQ_OPTIONS_SUPPORT */
if|if
condition|(
operator|(
name|p_PortParams
operator|->
name|portType
operator|!=
name|e_FM_PORT_TYPE_RX
operator|)
operator|&&
operator|(
name|p_PortParams
operator|->
name|portType
operator|!=
name|e_FM_PORT_TYPE_RX_10G
operator|)
condition|)
comment|/* for transmit& O/H ports */
block|{
name|uint8_t
name|enqTh
decl_stmt|;
name|uint8_t
name|deqTh
decl_stmt|;
comment|/* update qmi ENQ/DEQ threshold */
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedNumOfDeqTnums
operator|-=
name|p_PortParams
operator|->
name|deqPipelineDepth
expr_stmt|;
comment|/* p_Fm->p_FmStateStruct->accumulatedNumOfDeqTnums is now smaller,            so we can enlarge enqTh */
name|enqTh
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|QMI_MAX_NUM_OF_TNUMS
operator|-
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedNumOfDeqTnums
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* p_Fm->p_FmStateStruct->accumulatedNumOfDeqTnums is now smaller,             so we can reduce deqTh */
name|deqTh
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedNumOfDeqTnums
operator|+
literal|1
argument_list|)
expr_stmt|;
name|fman_set_qmi_enq_th
argument_list|(
name|qmi_rg
argument_list|,
name|enqTh
argument_list|)
expr_stmt|;
name|fman_set_qmi_deq_th
argument_list|(
name|qmi_rg
argument_list|,
name|deqTh
argument_list|)
expr_stmt|;
block|}
name|HW_PORT_ID_TO_SW_PORT_ID
argument_list|(
name|macId
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|FM_MAX_NUM_OF_10G_MACS
argument_list|)
operator|&&
operator|(
name|FM_MAX_NUM_OF_10G_MACS
operator|)
if|if
condition|(
operator|(
name|p_PortParams
operator|->
name|portType
operator|==
name|e_FM_PORT_TYPE_TX_10G
operator|)
operator|||
operator|(
name|p_PortParams
operator|->
name|portType
operator|==
name|e_FM_PORT_TYPE_RX_10G
operator|)
condition|)
block|{
name|ASSERT_COND
argument_list|(
name|macId
operator|<
name|FM_MAX_NUM_OF_10G_MACS
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|portMaxFrameLengths10G
index|[
name|macId
index|]
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
endif|#
directive|endif
comment|/* defined(FM_MAX_NUM_OF_10G_MACS)&& ... */
if|if
condition|(
operator|(
name|p_PortParams
operator|->
name|portType
operator|==
name|e_FM_PORT_TYPE_TX
operator|)
operator|||
operator|(
name|p_PortParams
operator|->
name|portType
operator|==
name|e_FM_PORT_TYPE_RX
operator|)
condition|)
block|{
name|ASSERT_COND
argument_list|(
name|macId
operator|<
name|FM_MAX_NUM_OF_1G_MACS
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|portMaxFrameLengths1G
index|[
name|macId
index|]
operator|=
literal|0
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|FM_LOW_END_RESTRICTION
if|if
condition|(
operator|(
name|hardwarePortId
operator|==
literal|0x1
operator|)
operator|||
operator|(
name|hardwarePortId
operator|==
literal|0x29
operator|)
condition|)
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|lowEndRestriction
operator|=
name|FALSE
expr_stmt|;
endif|#
directive|endif
comment|/* FM_LOW_END_RESTRICTION */
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_Fm
operator|->
name|h_Spinlock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|t_Error
name|FmIsPortStalled
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint8_t
name|hardwarePortId
parameter_list|,
name|bool
modifier|*
name|p_IsStalled
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|t_FmIpcReply
name|reply
decl_stmt|;
name|uint32_t
name|replyLength
decl_stmt|;
name|struct
name|fman_fpm_regs
modifier|*
name|fpm_rg
init|=
name|p_Fm
operator|->
name|p_FmFpmRegs
decl_stmt|;
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|&&
operator|!
name|p_Fm
operator|->
name|baseAddr
operator|&&
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
condition|)
block|{
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_IS_PORT_STALLED
expr_stmt|;
name|msg
operator|.
name|msgBody
index|[
literal|0
index|]
operator|=
name|hardwarePortId
expr_stmt|;
name|replyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
expr_stmt|;
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|hardwarePortId
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|replyLength
operator|!=
operator|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"IPC reply length mismatch"
operator|)
argument_list|)
expr_stmt|;
operator|*
name|p_IsStalled
operator|=
operator|(
name|bool
operator|)
operator|!
operator|!
operator|(
operator|*
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|reply
operator|.
name|replyBody
operator|)
operator|)
expr_stmt|;
return|return
call|(
name|t_Error
call|)
argument_list|(
name|reply
operator|.
name|error
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|baseAddr
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"Either IPC or 'baseAddress' is required!"
operator|)
argument_list|)
expr_stmt|;
operator|*
name|p_IsStalled
operator|=
name|fman_is_port_stalled
argument_list|(
name|fpm_rg
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FmResumeStalledPort
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint8_t
name|hardwarePortId
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|bool
name|isStalled
decl_stmt|;
name|struct
name|fman_fpm_regs
modifier|*
name|fpm_rg
init|=
name|p_Fm
operator|->
name|p_FmFpmRegs
decl_stmt|;
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|&&
operator|!
name|p_Fm
operator|->
name|baseAddr
operator|&&
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
condition|)
block|{
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|t_FmIpcReply
name|reply
decl_stmt|;
name|uint32_t
name|replyLength
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_RESUME_STALLED_PORT
expr_stmt|;
name|msg
operator|.
name|msgBody
index|[
literal|0
index|]
operator|=
name|hardwarePortId
expr_stmt|;
name|replyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|hardwarePortId
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|replyLength
operator|!=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"IPC reply length mismatch"
operator|)
argument_list|)
expr_stmt|;
return|return
call|(
name|t_Error
call|)
argument_list|(
name|reply
operator|.
name|error
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|baseAddr
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"Either IPC or 'baseAddress' is required!"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|>=
literal|6
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_AVAILABLE
argument_list|,
operator|(
literal|"Not available for this FM revision!"
operator|)
argument_list|)
expr_stmt|;
comment|/* Get port status */
name|err
operator|=
name|FmIsPortStalled
argument_list|(
name|h_Fm
argument_list|,
name|hardwarePortId
argument_list|,
operator|&
name|isStalled
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Can't get port status"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|isStalled
condition|)
return|return
name|E_OK
return|;
name|fman_resume_stalled_port
argument_list|(
name|fpm_rg
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FmResetMac
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|e_FmMacType
name|type
parameter_list|,
name|uint8_t
name|macId
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|struct
name|fman_fpm_regs
modifier|*
name|fpm_rg
init|=
name|p_Fm
operator|->
name|p_FmFpmRegs
decl_stmt|;
if|#
directive|if
operator|(
name|DPAA_VERSION
operator|>=
literal|11
operator|)
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|>=
literal|6
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"FMan MAC reset!"
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/*(DPAA_VERSION>= 11)*/
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|&&
operator|!
name|p_Fm
operator|->
name|baseAddr
operator|&&
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
condition|)
block|{
name|t_FmIpcMacParams
name|macParams
decl_stmt|;
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|t_FmIpcReply
name|reply
decl_stmt|;
name|uint32_t
name|replyLength
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|macParams
operator|.
name|id
operator|=
name|macId
expr_stmt|;
name|macParams
operator|.
name|enumType
operator|=
operator|(
name|uint32_t
operator|)
name|type
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_RESET_MAC
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|&
name|macParams
argument_list|,
sizeof|sizeof
argument_list|(
name|macParams
argument_list|)
argument_list|)
expr_stmt|;
name|replyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|macParams
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|replyLength
operator|!=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"IPC reply length mismatch"
operator|)
argument_list|)
expr_stmt|;
return|return
call|(
name|t_Error
call|)
argument_list|(
name|reply
operator|.
name|error
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|baseAddr
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"Either IPC or 'baseAddress' is required!"
operator|)
argument_list|)
expr_stmt|;
name|err
operator|=
operator|(
name|t_Error
operator|)
name|fman_reset_mac
argument_list|(
name|fpm_rg
argument_list|,
name|macId
argument_list|,
operator|!
operator|!
operator|(
name|type
operator|==
name|e_FM_MAC_10G
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|==
operator|-
name|EBUSY
condition|)
return|return
name|ERROR_CODE
argument_list|(
name|E_TIMEOUT
argument_list|)
return|;
elseif|else
if|if
condition|(
name|err
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Illegal MAC ID"
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FmSetMacMaxFrame
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|e_FmMacType
name|type
parameter_list|,
name|uint8_t
name|macId
parameter_list|,
name|uint16_t
name|mtu
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|&&
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
condition|)
block|{
name|t_FmIpcMacMaxFrameParams
name|macMaxFrameLengthParams
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|macMaxFrameLengthParams
operator|.
name|macParams
operator|.
name|id
operator|=
name|macId
expr_stmt|;
name|macMaxFrameLengthParams
operator|.
name|macParams
operator|.
name|enumType
operator|=
operator|(
name|uint32_t
operator|)
name|type
expr_stmt|;
name|macMaxFrameLengthParams
operator|.
name|maxFrameLength
operator|=
operator|(
name|uint16_t
operator|)
name|mtu
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_SET_MAC_MAX_FRAME
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|&
name|macMaxFrameLengthParams
argument_list|,
sizeof|sizeof
argument_list|(
name|macMaxFrameLengthParams
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|macMaxFrameLengthParams
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
elseif|else
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"running in guest-mode without IPC!"
operator|)
argument_list|)
expr_stmt|;
comment|/* if port is already initialized, check that MaxFrameLength is smaller      * or equal to the port's max */
if|#
directive|if
operator|(
name|defined
argument_list|(
name|FM_MAX_NUM_OF_10G_MACS
argument_list|)
operator|&&
operator|(
name|FM_MAX_NUM_OF_10G_MACS
operator|)
operator|)
if|if
condition|(
name|type
operator|==
name|e_FM_MAC_10G
condition|)
block|{
if|if
condition|(
operator|(
operator|!
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|portMaxFrameLengths10G
index|[
name|macId
index|]
operator|)
operator|||
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|portMaxFrameLengths10G
index|[
name|macId
index|]
operator|&&
operator|(
name|mtu
operator|<=
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|portMaxFrameLengths10G
index|[
name|macId
index|]
operator|)
operator|)
condition|)
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|macMaxFrameLengths10G
index|[
name|macId
index|]
operator|=
name|mtu
expr_stmt|;
else|else
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"MAC maxFrameLength is larger than Port maxFrameLength"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
else|#
directive|else
name|UNUSED
argument_list|(
name|type
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* (defined(FM_MAX_NUM_OF_10G_MACS)&& ... */
if|if
condition|(
operator|(
operator|!
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|portMaxFrameLengths1G
index|[
name|macId
index|]
operator|)
operator|||
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|portMaxFrameLengths1G
index|[
name|macId
index|]
operator|&&
operator|(
name|mtu
operator|<=
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|portMaxFrameLengths1G
index|[
name|macId
index|]
operator|)
operator|)
condition|)
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|macMaxFrameLengths1G
index|[
name|macId
index|]
operator|=
name|mtu
expr_stmt|;
else|else
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"MAC maxFrameLength is larger than Port maxFrameLength"
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|uint16_t
name|FmGetClockFreq
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
comment|/* for multicore environment: this depends on the      * fact that fmClkFreq was properly initialized at "init". */
return|return
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|fmClkFreq
return|;
block|}
end_function

begin_function
name|uint16_t
name|FmGetMacClockFreq
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
return|return
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|fmMacClkFreq
return|;
block|}
end_function

begin_function
name|uint32_t
name|FmGetTimeStampScale
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|&&
operator|!
name|p_Fm
operator|->
name|baseAddr
operator|&&
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
condition|)
block|{
name|t_Error
name|err
decl_stmt|;
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|t_FmIpcReply
name|reply
decl_stmt|;
name|uint32_t
name|replyLength
decl_stmt|,
name|timeStamp
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_GET_TIMESTAMP_SCALE
expr_stmt|;
name|replyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|replyLength
operator|!=
operator|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|)
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"IPC reply length mismatch"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|timeStamp
argument_list|,
name|reply
operator|.
name|replyBody
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|timeStamp
return|;
block|}
elseif|else
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|&&
name|p_Fm
operator|->
name|baseAddr
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|GET_UINT32
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|->
name|fmfp_tsc1
argument_list|)
operator|&
name|FPM_TS_CTL_EN
operator|)
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"timestamp is not enabled!"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
name|DBG
argument_list|(
name|WARNING
argument_list|,
operator|(
literal|"No IPC - can't validate FM if timestamp enabled."
operator|)
argument_list|)
expr_stmt|;
return|return
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|count1MicroBit
return|;
block|}
end_function

begin_function
name|t_Error
name|FmEnableRamsEcc
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|ramsEccOwners
operator|++
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|internalCall
operator|=
name|TRUE
expr_stmt|;
return|return
name|FM_EnableRamsEcc
argument_list|(
name|p_Fm
argument_list|)
return|;
block|}
end_function

begin_function
name|t_Error
name|FmDisableRamsEcc
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|ramsEccOwners
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|ramsEccOwners
operator|--
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|ramsEccOwners
operator|==
literal|0
condition|)
block|{
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|internalCall
operator|=
name|TRUE
expr_stmt|;
return|return
name|FM_DisableRamsEcc
argument_list|(
name|p_Fm
argument_list|)
return|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|uint8_t
name|FmGetGuestId
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
return|return
name|p_Fm
operator|->
name|guestId
return|;
block|}
end_function

begin_function
name|bool
name|FmIsMaster
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
return|return
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
return|;
block|}
end_function

begin_function
name|t_Error
name|FmSetSizeOfFifo
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint8_t
name|hardwarePortId
parameter_list|,
name|uint32_t
modifier|*
name|p_SizeOfFifo
parameter_list|,
name|uint32_t
modifier|*
name|p_ExtraSizeOfFifo
parameter_list|,
name|bool
name|initialConfig
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|t_FmIpcPortRsrcParams
name|rsrcParams
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|struct
name|fman_bmi_regs
modifier|*
name|bmi_rg
init|=
name|p_Fm
operator|->
name|p_FmBmiRegs
decl_stmt|;
name|uint32_t
name|sizeOfFifo
init|=
operator|*
name|p_SizeOfFifo
decl_stmt|,
name|extraSizeOfFifo
init|=
operator|*
name|p_ExtraSizeOfFifo
decl_stmt|;
name|uint16_t
name|currentVal
init|=
literal|0
decl_stmt|,
name|currentExtraVal
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|&&
operator|!
name|p_Fm
operator|->
name|baseAddr
operator|&&
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
condition|)
block|{
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|t_FmIpcReply
name|reply
decl_stmt|;
name|uint32_t
name|replyLength
decl_stmt|;
name|rsrcParams
operator|.
name|hardwarePortId
operator|=
name|hardwarePortId
expr_stmt|;
name|rsrcParams
operator|.
name|val
operator|=
name|sizeOfFifo
expr_stmt|;
name|rsrcParams
operator|.
name|extra
operator|=
name|extraSizeOfFifo
expr_stmt|;
name|rsrcParams
operator|.
name|boolInitialConfig
operator|=
operator|(
name|uint8_t
operator|)
name|initialConfig
expr_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_SET_SIZE_OF_FIFO
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|&
name|rsrcParams
argument_list|,
sizeof|sizeof
argument_list|(
name|rsrcParams
argument_list|)
argument_list|)
expr_stmt|;
name|replyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|rsrcParams
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|replyLength
operator|!=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"IPC reply length mismatch"
operator|)
argument_list|)
expr_stmt|;
return|return
call|(
name|t_Error
call|)
argument_list|(
name|reply
operator|.
name|error
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|&&
name|p_Fm
operator|->
name|baseAddr
condition|)
block|{
name|DBG
argument_list|(
name|WARNING
argument_list|,
operator|(
literal|"No IPC - can't validate FM total-fifo size."
operator|)
argument_list|)
expr_stmt|;
name|fman_set_size_of_fifo
argument_list|(
name|bmi_rg
argument_list|,
name|hardwarePortId
argument_list|,
name|sizeOfFifo
argument_list|,
name|extraSizeOfFifo
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"running in guest-mode without neither IPC nor mapped register!"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|initialConfig
condition|)
block|{
comment|/* !initialConfig - runtime change of existing value.          * - read the current FIFO and extra FIFO size */
name|currentExtraVal
operator|=
name|fman_get_size_of_extra_fifo
argument_list|(
name|bmi_rg
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
name|currentVal
operator|=
name|fman_get_size_of_fifo
argument_list|(
name|bmi_rg
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|extraSizeOfFifo
operator|>
name|currentExtraVal
condition|)
block|{
if|if
condition|(
name|extraSizeOfFifo
operator|&&
operator|!
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|extraFifoPoolSize
condition|)
comment|/* if this is the first time a port requires extraFifoPoolSize, the total extraFifoPoolSize              * must be initialized to 1 buffer per port              */
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|extraFifoPoolSize
operator|=
name|FM_MAX_NUM_OF_RX_PORTS
operator|*
name|BMI_FIFO_UNITS
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|extraFifoPoolSize
operator|=
name|MAX
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|extraFifoPoolSize
argument_list|,
name|extraSizeOfFifo
argument_list|)
expr_stmt|;
block|}
comment|/* check that there are enough uncommitted fifo size */
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedFifoSize
operator|-
name|currentVal
operator|+
name|sizeOfFifo
operator|)
operator|>
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|totalFifoSize
operator|-
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|extraFifoPoolSize
operator|)
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Port request fifo size + accumulated size> total FIFO size:"
operator|)
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"port 0x%x requested %d bytes, extra size = %d, accumulated size = %d total size = %d"
operator|,
name|hardwarePortId
operator|,
name|sizeOfFifo
operator|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|extraFifoPoolSize
operator|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedFifoSize
operator|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|totalFifoSize
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* update accumulated */
name|ASSERT_COND
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedFifoSize
operator|>=
name|currentVal
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedFifoSize
operator|-=
name|currentVal
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedFifoSize
operator|+=
name|sizeOfFifo
expr_stmt|;
name|fman_set_size_of_fifo
argument_list|(
name|bmi_rg
argument_list|,
name|hardwarePortId
argument_list|,
name|sizeOfFifo
argument_list|,
name|extraSizeOfFifo
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FmSetNumOfTasks
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint8_t
name|hardwarePortId
parameter_list|,
name|uint8_t
modifier|*
name|p_NumOfTasks
parameter_list|,
name|uint8_t
modifier|*
name|p_NumOfExtraTasks
parameter_list|,
name|bool
name|initialConfig
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|struct
name|fman_bmi_regs
modifier|*
name|bmi_rg
init|=
name|p_Fm
operator|->
name|p_FmBmiRegs
decl_stmt|;
name|uint8_t
name|currentVal
init|=
literal|0
decl_stmt|,
name|currentExtraVal
init|=
literal|0
decl_stmt|,
name|numOfTasks
init|=
operator|*
name|p_NumOfTasks
decl_stmt|,
name|numOfExtraTasks
init|=
operator|*
name|p_NumOfExtraTasks
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|IN_RANGE
argument_list|(
literal|1
argument_list|,
name|hardwarePortId
argument_list|,
literal|63
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|&&
operator|!
name|p_Fm
operator|->
name|baseAddr
operator|&&
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
condition|)
block|{
name|t_FmIpcPortRsrcParams
name|rsrcParams
decl_stmt|;
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|t_FmIpcReply
name|reply
decl_stmt|;
name|uint32_t
name|replyLength
decl_stmt|;
name|rsrcParams
operator|.
name|hardwarePortId
operator|=
name|hardwarePortId
expr_stmt|;
name|rsrcParams
operator|.
name|val
operator|=
name|numOfTasks
expr_stmt|;
name|rsrcParams
operator|.
name|extra
operator|=
name|numOfExtraTasks
expr_stmt|;
name|rsrcParams
operator|.
name|boolInitialConfig
operator|=
operator|(
name|uint8_t
operator|)
name|initialConfig
expr_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_SET_NUM_OF_TASKS
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|&
name|rsrcParams
argument_list|,
sizeof|sizeof
argument_list|(
name|rsrcParams
argument_list|)
argument_list|)
expr_stmt|;
name|replyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|rsrcParams
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|replyLength
operator|!=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"IPC reply length mismatch"
operator|)
argument_list|)
expr_stmt|;
return|return
call|(
name|t_Error
call|)
argument_list|(
name|reply
operator|.
name|error
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|&&
name|p_Fm
operator|->
name|baseAddr
condition|)
block|{
name|DBG
argument_list|(
name|WARNING
argument_list|,
operator|(
literal|"No IPC - can't validate FM total-num-of-tasks."
operator|)
argument_list|)
expr_stmt|;
name|fman_set_num_of_tasks
argument_list|(
name|bmi_rg
argument_list|,
name|hardwarePortId
argument_list|,
name|numOfTasks
argument_list|,
name|numOfExtraTasks
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"running in guest-mode without neither IPC nor mapped register!"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|initialConfig
condition|)
block|{
comment|/* !initialConfig - runtime change of existing value.          * - read the current number of tasks */
name|currentVal
operator|=
name|fman_get_num_of_tasks
argument_list|(
name|bmi_rg
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
name|currentExtraVal
operator|=
name|fman_get_num_extra_tasks
argument_list|(
name|bmi_rg
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|numOfExtraTasks
operator|>
name|currentExtraVal
condition|)
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|extraTasksPoolSize
operator|=
operator|(
name|uint8_t
operator|)
name|MAX
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|extraTasksPoolSize
argument_list|,
name|numOfExtraTasks
argument_list|)
expr_stmt|;
comment|/* check that there are enough uncommitted tasks */
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedNumOfTasks
operator|-
name|currentVal
operator|+
name|numOfTasks
operator|)
operator|>
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|totalNumOfTasks
operator|-
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|extraTasksPoolSize
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_AVAILABLE
argument_list|,
operator|(
literal|"Requested numOfTasks and extra tasks pool for fm%d exceed total numOfTasks."
operator|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|fmId
operator|)
argument_list|)
expr_stmt|;
else|else
block|{
name|ASSERT_COND
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedNumOfTasks
operator|>=
name|currentVal
argument_list|)
expr_stmt|;
comment|/* update accumulated */
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedNumOfTasks
operator|-=
name|currentVal
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedNumOfTasks
operator|+=
name|numOfTasks
expr_stmt|;
name|fman_set_num_of_tasks
argument_list|(
name|bmi_rg
argument_list|,
name|hardwarePortId
argument_list|,
name|numOfTasks
argument_list|,
name|numOfExtraTasks
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FmSetNumOfOpenDmas
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint8_t
name|hardwarePortId
parameter_list|,
name|uint8_t
modifier|*
name|p_NumOfOpenDmas
parameter_list|,
name|uint8_t
modifier|*
name|p_NumOfExtraOpenDmas
parameter_list|,
name|bool
name|initialConfig
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|struct
name|fman_bmi_regs
modifier|*
name|bmi_rg
init|=
name|p_Fm
operator|->
name|p_FmBmiRegs
decl_stmt|;
name|uint8_t
name|numOfOpenDmas
init|=
operator|*
name|p_NumOfOpenDmas
decl_stmt|,
name|numOfExtraOpenDmas
init|=
operator|*
name|p_NumOfExtraOpenDmas
decl_stmt|;
name|uint8_t
name|totalNumDmas
init|=
literal|0
decl_stmt|,
name|currentVal
init|=
literal|0
decl_stmt|,
name|currentExtraVal
init|=
literal|0
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|IN_RANGE
argument_list|(
literal|1
argument_list|,
name|hardwarePortId
argument_list|,
literal|63
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|&&
operator|!
name|p_Fm
operator|->
name|baseAddr
operator|&&
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
condition|)
block|{
name|t_FmIpcPortRsrcParams
name|rsrcParams
decl_stmt|;
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|t_FmIpcReply
name|reply
decl_stmt|;
name|uint32_t
name|replyLength
decl_stmt|;
name|rsrcParams
operator|.
name|hardwarePortId
operator|=
name|hardwarePortId
expr_stmt|;
name|rsrcParams
operator|.
name|val
operator|=
name|numOfOpenDmas
expr_stmt|;
name|rsrcParams
operator|.
name|extra
operator|=
name|numOfExtraOpenDmas
expr_stmt|;
name|rsrcParams
operator|.
name|boolInitialConfig
operator|=
operator|(
name|uint8_t
operator|)
name|initialConfig
expr_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_SET_NUM_OF_OPEN_DMAS
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|&
name|rsrcParams
argument_list|,
sizeof|sizeof
argument_list|(
name|rsrcParams
argument_list|)
argument_list|)
expr_stmt|;
name|replyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|rsrcParams
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|replyLength
operator|!=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"IPC reply length mismatch"
operator|)
argument_list|)
expr_stmt|;
return|return
call|(
name|t_Error
call|)
argument_list|(
name|reply
operator|.
name|error
argument_list|)
return|;
block|}
ifdef|#
directive|ifdef
name|FM_HAS_TOTAL_DMAS
elseif|else
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"running in guest-mode without IPC!"
operator|)
argument_list|)
expr_stmt|;
else|#
directive|else
elseif|else
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|&&
name|p_Fm
operator|->
name|baseAddr
operator|&&
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|>=
literal|6
operator|)
condition|)
block|{
comment|/*DBG(WARNING, ("No IPC - can't validate FM total-num-of-dmas."));*/
if|if
condition|(
operator|!
name|numOfOpenDmas
condition|)
block|{
comment|/* first config without explic it value: Do Nothing - reset value shouldn't be                 changed, read register for port save */
operator|*
name|p_NumOfOpenDmas
operator|=
name|fman_get_num_of_dmas
argument_list|(
name|bmi_rg
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
operator|*
name|p_NumOfExtraOpenDmas
operator|=
name|fman_get_num_extra_dmas
argument_list|(
name|bmi_rg
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* whether it is the first time with explicit value, or runtime "set" - write register */
name|fman_set_num_of_open_dmas
argument_list|(
name|bmi_rg
argument_list|,
name|hardwarePortId
argument_list|,
name|numOfOpenDmas
argument_list|,
name|numOfExtraOpenDmas
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedNumOfOpenDmas
operator|+
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|extraOpenDmasPoolSize
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"running in guest-mode without neither IPC nor mapped register!"
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* FM_HAS_TOTAL_DMAS */
if|if
condition|(
operator|!
name|initialConfig
condition|)
block|{
comment|/* !initialConfig - runtime change of existing value.          * - read the current number of open Dma's */
name|currentExtraVal
operator|=
name|fman_get_num_extra_dmas
argument_list|(
name|bmi_rg
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
name|currentVal
operator|=
name|fman_get_num_of_dmas
argument_list|(
name|bmi_rg
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|FM_NO_GUARANTEED_RESET_VALUES
comment|/* it's illegal to be in a state where this is not the first set and no value is specified */
name|ASSERT_COND
argument_list|(
name|initialConfig
operator|||
name|numOfOpenDmas
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|numOfOpenDmas
condition|)
block|{
comment|/* !numOfOpenDmas - first configuration according to values in regs.          * - read the current number of open Dma's */
name|currentExtraVal
operator|=
name|fman_get_num_extra_dmas
argument_list|(
name|bmi_rg
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
name|currentVal
operator|=
name|fman_get_num_of_dmas
argument_list|(
name|bmi_rg
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
comment|/* This is the first configuration and user did not specify value (!numOfOpenDmas),          * reset values will be used and we just save these values for resource management */
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|extraOpenDmasPoolSize
operator|=
operator|(
name|uint8_t
operator|)
name|MAX
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|extraOpenDmasPoolSize
argument_list|,
name|currentExtraVal
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedNumOfOpenDmas
operator|+=
name|currentVal
expr_stmt|;
operator|*
name|p_NumOfOpenDmas
operator|=
name|currentVal
expr_stmt|;
operator|*
name|p_NumOfExtraOpenDmas
operator|=
name|currentExtraVal
expr_stmt|;
return|return
name|E_OK
return|;
block|}
endif|#
directive|endif
comment|/* FM_NO_GUARANTEED_RESET_VALUES */
if|if
condition|(
name|numOfExtraOpenDmas
operator|>
name|currentExtraVal
condition|)
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|extraOpenDmasPoolSize
operator|=
operator|(
name|uint8_t
operator|)
name|MAX
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|extraOpenDmasPoolSize
argument_list|,
name|numOfExtraOpenDmas
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_HAS_TOTAL_DMAS
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|<
literal|6
operator|)
operator|&&
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedNumOfOpenDmas
operator|-
name|currentVal
operator|+
name|numOfOpenDmas
operator|>
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|maxNumOfOpenDmas
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_AVAILABLE
argument_list|,
operator|(
literal|"Requested numOfOpenDmas for fm%d exceeds total numOfOpenDmas."
operator|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|fmId
operator|)
argument_list|)
expr_stmt|;
else|#
directive|else
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|>=
literal|6
operator|)
operator|&&
ifdef|#
directive|ifdef
name|FM_HEAVY_TRAFFIC_SEQUENCER_HANG_ERRATA_FMAN_A006981
operator|!
operator|(
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|==
literal|6
operator|)
operator|&&
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|minorRev
operator|==
literal|0
operator|)
operator|)
operator|&&
endif|#
directive|endif
comment|/* FM_HEAVY_TRAFFIC_SEQUENCER_HANG_ERRATA_FMAN_A006981 */
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedNumOfOpenDmas
operator|-
name|currentVal
operator|+
name|numOfOpenDmas
operator|>
name|DMA_THRESH_MAX_COMMQ
operator|+
literal|1
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_AVAILABLE
argument_list|,
operator|(
literal|"Requested numOfOpenDmas for fm%d exceeds DMA Command queue (%d)"
operator|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|fmId
operator|,
name|DMA_THRESH_MAX_COMMQ
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* FM_HAS_TOTAL_DMAS */
else|else
block|{
name|ASSERT_COND
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedNumOfOpenDmas
operator|>=
name|currentVal
argument_list|)
expr_stmt|;
comment|/* update acummulated */
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedNumOfOpenDmas
operator|-=
name|currentVal
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedNumOfOpenDmas
operator|+=
name|numOfOpenDmas
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_HAS_TOTAL_DMAS
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|<
literal|6
condition|)
name|totalNumDmas
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|accumulatedNumOfOpenDmas
operator|+
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|extraOpenDmasPoolSize
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* FM_HAS_TOTAL_DMAS */
name|fman_set_num_of_open_dmas
argument_list|(
name|bmi_rg
argument_list|,
name|hardwarePortId
argument_list|,
name|numOfOpenDmas
argument_list|,
name|numOfExtraOpenDmas
argument_list|,
name|totalNumDmas
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|(
name|DPAA_VERSION
operator|>=
literal|11
operator|)
end_if

begin_function
name|t_Error
name|FmVSPCheckRelativeProfile
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|e_FmPortType
name|portType
parameter_list|,
name|uint8_t
name|portId
parameter_list|,
name|uint16_t
name|relativeProfile
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
decl_stmt|;
name|t_FmSp
modifier|*
name|p_FmPcdSp
decl_stmt|;
name|uint8_t
name|swPortIndex
init|=
literal|0
decl_stmt|,
name|hardwarePortId
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|h_Fm
argument_list|)
expr_stmt|;
name|p_Fm
operator|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
expr_stmt|;
name|hardwarePortId
operator|=
name|SwPortIdToHwPortId
argument_list|(
name|portType
argument_list|,
name|portId
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|minorRev
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|hardwarePortId
argument_list|)
expr_stmt|;
name|HW_PORT_ID_TO_SW_PORT_INDX
argument_list|(
name|swPortIndex
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
name|p_FmPcdSp
operator|=
name|p_Fm
operator|->
name|p_FmSp
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|p_FmPcdSp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_FmPcdSp
operator|->
name|portsMapping
index|[
name|swPortIndex
index|]
operator|.
name|numOfProfiles
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Port has no allocated profiles"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|relativeProfile
operator|>=
name|p_FmPcdSp
operator|->
name|portsMapping
index|[
name|swPortIndex
index|]
operator|.
name|numOfProfiles
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_IN_RANGE
argument_list|,
operator|(
literal|"Profile id is out of range"
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FmVSPGetAbsoluteProfileId
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|e_FmPortType
name|portType
parameter_list|,
name|uint8_t
name|portId
parameter_list|,
name|uint16_t
name|relativeProfile
parameter_list|,
name|uint16_t
modifier|*
name|p_AbsoluteId
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
decl_stmt|;
name|t_FmSp
modifier|*
name|p_FmPcdSp
decl_stmt|;
name|uint8_t
name|swPortIndex
init|=
literal|0
decl_stmt|,
name|hardwarePortId
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|h_Fm
argument_list|)
expr_stmt|;
name|p_Fm
operator|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
expr_stmt|;
name|err
operator|=
name|FmVSPCheckRelativeProfile
argument_list|(
name|h_Fm
argument_list|,
name|portType
argument_list|,
name|portId
argument_list|,
name|relativeProfile
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
return|return
name|err
return|;
name|hardwarePortId
operator|=
name|SwPortIdToHwPortId
argument_list|(
name|portType
argument_list|,
name|portId
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|minorRev
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|hardwarePortId
argument_list|)
expr_stmt|;
name|HW_PORT_ID_TO_SW_PORT_INDX
argument_list|(
name|swPortIndex
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
name|p_FmPcdSp
operator|=
name|p_Fm
operator|->
name|p_FmSp
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|p_FmPcdSp
argument_list|)
expr_stmt|;
operator|*
name|p_AbsoluteId
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|p_FmPcdSp
operator|->
name|portsMapping
index|[
name|swPortIndex
index|]
operator|.
name|profilesBase
operator|+
name|relativeProfile
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* (DPAA_VERSION>= 11) */
end_comment

begin_function
specifier|static
name|t_Error
name|InitFmDma
parameter_list|(
name|t_Fm
modifier|*
name|p_Fm
parameter_list|)
block|{
name|t_Error
name|err
decl_stmt|;
name|err
operator|=
operator|(
name|t_Error
operator|)
name|fman_dma_init
argument_list|(
name|p_Fm
operator|->
name|p_FmDmaRegs
argument_list|,
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
return|return
name|err
return|;
comment|/* Allocate MURAM for CAM */
name|p_Fm
operator|->
name|camBaseAddr
operator|=
name|PTR_TO_UINT
argument_list|(
name|FM_MURAM_AllocMem
argument_list|(
name|p_Fm
operator|->
name|h_FmMuram
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_cam_num_of_entries
operator|*
name|DMA_CAM_SIZEOF_ENTRY
argument_list|)
argument_list|,
name|DMA_CAM_ALIGN
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|camBaseAddr
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"MURAM alloc for DMA CAM failed"
operator|)
argument_list|)
expr_stmt|;
name|WRITE_BLOCK
argument_list|(
name|UINT_TO_PTR
argument_list|(
name|p_Fm
operator|->
name|camBaseAddr
argument_list|)
argument_list|,
literal|0
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_cam_num_of_entries
operator|*
name|DMA_CAM_SIZEOF_ENTRY
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|==
literal|2
condition|)
block|{
name|FM_MURAM_FreeMem
argument_list|(
name|p_Fm
operator|->
name|h_FmMuram
argument_list|,
name|UINT_TO_PTR
argument_list|(
name|p_Fm
operator|->
name|camBaseAddr
argument_list|)
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|camBaseAddr
operator|=
name|PTR_TO_UINT
argument_list|(
name|FM_MURAM_AllocMem
argument_list|(
name|p_Fm
operator|->
name|h_FmMuram
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_cam_num_of_entries
operator|*
literal|72
operator|+
literal|128
argument_list|)
argument_list|,
literal|64
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|camBaseAddr
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"MURAM alloc for DMA CAM failed"
operator|)
argument_list|)
expr_stmt|;
name|WRITE_BLOCK
argument_list|(
name|UINT_TO_PTR
argument_list|(
name|p_Fm
operator|->
name|camBaseAddr
argument_list|)
argument_list|,
literal|0
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_cam_num_of_entries
operator|*
literal|72
operator|+
literal|128
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_cam_num_of_entries
condition|)
block|{
case|case
operator|(
literal|8
operator|)
case|:
name|WRITE_UINT32
argument_list|(
operator|*
operator|(
name|uint32_t
operator|*
operator|)
name|p_Fm
operator|->
name|camBaseAddr
argument_list|,
literal|0xff000000
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
literal|16
operator|)
case|:
name|WRITE_UINT32
argument_list|(
operator|*
operator|(
name|uint32_t
operator|*
operator|)
name|p_Fm
operator|->
name|camBaseAddr
argument_list|,
literal|0xffff0000
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
literal|24
operator|)
case|:
name|WRITE_UINT32
argument_list|(
operator|*
operator|(
name|uint32_t
operator|*
operator|)
name|p_Fm
operator|->
name|camBaseAddr
argument_list|,
literal|0xffffff00
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
literal|32
operator|)
case|:
name|WRITE_UINT32
argument_list|(
operator|*
operator|(
name|uint32_t
operator|*
operator|)
name|p_Fm
operator|->
name|camBaseAddr
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
break|break;
default|default:
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"wrong dma_cam_num_of_entries"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|cam_base_addr
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|XX_VirtToPhys
argument_list|(
name|UINT_TO_PTR
argument_list|(
name|p_Fm
operator|->
name|camBaseAddr
argument_list|)
argument_list|)
operator|-
name|p_Fm
operator|->
name|fmMuramPhysBaseAddr
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|InitFmFpm
parameter_list|(
name|t_Fm
modifier|*
name|p_Fm
parameter_list|)
block|{
return|return
operator|(
name|t_Error
operator|)
name|fman_fpm_init
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
argument_list|,
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|InitFmBmi
parameter_list|(
name|t_Fm
modifier|*
name|p_Fm
parameter_list|)
block|{
return|return
operator|(
name|t_Error
operator|)
name|fman_bmi_init
argument_list|(
name|p_Fm
operator|->
name|p_FmBmiRegs
argument_list|,
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|InitFmQmi
parameter_list|(
name|t_Fm
modifier|*
name|p_Fm
parameter_list|)
block|{
return|return
operator|(
name|t_Error
operator|)
name|fman_qmi_init
argument_list|(
name|p_Fm
operator|->
name|p_FmQmiRegs
argument_list|,
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|InitGuestMode
parameter_list|(
name|t_Fm
modifier|*
name|p_Fm
parameter_list|)
block|{
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|int
name|i
decl_stmt|;
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|t_FmIpcReply
name|reply
decl_stmt|;
name|uint32_t
name|replyLength
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
argument_list|)
expr_stmt|;
comment|/* build the FM guest partition IPC address */
if|if
condition|(
name|Sprint
argument_list|(
name|p_Fm
operator|->
name|fmModuleName
argument_list|,
literal|"FM_%d_%d"
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|fmId
argument_list|,
name|p_Fm
operator|->
name|guestId
argument_list|)
operator|!=
operator|(
name|p_Fm
operator|->
name|guestId
operator|<
literal|10
condition|?
literal|6
else|:
literal|7
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Sprint failed"
operator|)
argument_list|)
expr_stmt|;
comment|/* build the FM master partition IPC address */
name|memset
argument_list|(
name|p_Fm
operator|->
name|fmIpcHandlerModuleName
argument_list|,
literal|0
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|char
argument_list|)
operator|)
operator|*
name|MODULE_NAME_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|Sprint
argument_list|(
name|p_Fm
operator|->
name|fmIpcHandlerModuleName
index|[
literal|0
index|]
argument_list|,
literal|"FM_%d_%d"
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|fmId
argument_list|,
name|NCSW_MASTER_ID
argument_list|)
operator|!=
literal|6
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Sprint failed"
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|e_FM_EV_DUMMY_LAST
condition|;
name|i
operator|++
control|)
name|p_Fm
operator|->
name|intrMng
index|[
name|i
index|]
operator|.
name|f_Isr
operator|=
name|UnimplementedIsr
expr_stmt|;
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
operator|=
name|XX_IpcInitSession
argument_list|(
name|p_Fm
operator|->
name|fmIpcHandlerModuleName
index|[
literal|0
index|]
argument_list|,
name|p_Fm
operator|->
name|fmModuleName
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
condition|)
block|{
name|uint8_t
name|isMasterAlive
decl_stmt|;
name|t_FmIpcParams
name|ipcParams
decl_stmt|;
name|err
operator|=
name|XX_IpcRegisterMsgHandler
argument_list|(
name|p_Fm
operator|->
name|fmModuleName
argument_list|,
name|FmGuestHandleIpcMsgCB
argument_list|,
name|p_Fm
argument_list|,
name|FM_IPC_MAX_REPLY_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_MASTER_IS_ALIVE
expr_stmt|;
name|msg
operator|.
name|msgBody
index|[
literal|0
index|]
operator|=
name|p_Fm
operator|->
name|guestId
expr_stmt|;
name|replyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
expr_stmt|;
do|do
block|{
name|blockingFlag
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|p_Fm
operator|->
name|guestId
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|IpcMsgCompletionCB
argument_list|,
name|p_Fm
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
while|while
condition|(
name|blockingFlag
condition|)
empty_stmt|;
if|if
condition|(
name|replyLength
operator|!=
operator|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
operator|)
condition|)
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"IPC reply length mismatch"
operator|)
argument_list|)
expr_stmt|;
name|isMasterAlive
operator|=
operator|*
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|reply
operator|.
name|replyBody
operator|)
expr_stmt|;
block|}
do|while
condition|(
operator|!
name|isMasterAlive
condition|)
do|;
comment|/* read FM parameters and save */
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_GET_PARAMS
expr_stmt|;
name|replyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|t_FmIpcParams
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|replyLength
operator|!=
operator|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|t_FmIpcParams
argument_list|)
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"IPC reply length mismatch"
operator|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcParams
argument_list|,
name|reply
operator|.
name|replyBody
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcParams
argument_list|)
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|fmClkFreq
operator|=
name|ipcParams
operator|.
name|fmClkFreq
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|fmMacClkFreq
operator|=
name|ipcParams
operator|.
name|fmMacClkFreq
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|=
name|ipcParams
operator|.
name|majorRev
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|minorRev
operator|=
name|ipcParams
operator|.
name|minorRev
expr_stmt|;
block|}
else|else
block|{
name|DBG
argument_list|(
name|WARNING
argument_list|,
operator|(
literal|"FM Guest mode - without IPC"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|fmClkFreq
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"No fmClkFreq configured for guest without IPC"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|baseAddr
condition|)
block|{
name|fman_get_revision
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
argument_list|,
operator|&
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
argument_list|,
operator|&
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|minorRev
argument_list|)
expr_stmt|;
block|}
block|}
if|#
directive|if
operator|(
name|DPAA_VERSION
operator|>=
literal|11
operator|)
name|p_Fm
operator|->
name|partVSPBase
operator|=
name|AllocVSPsForPartition
argument_list|(
name|p_Fm
argument_list|,
name|p_Fm
operator|->
name|partVSPBase
argument_list|,
name|p_Fm
operator|->
name|partNumOfVSPs
argument_list|,
name|p_Fm
operator|->
name|guestId
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|partVSPBase
operator|==
call|(
name|uint8_t
call|)
argument_list|(
name|ILLEGAL_BASE
argument_list|)
condition|)
name|DBG
argument_list|(
name|WARNING
argument_list|,
operator|(
literal|"partition VSPs allocation is FAILED"
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* (DPAA_VERSION>= 11) */
comment|/* General FM driver initialization */
if|if
condition|(
name|p_Fm
operator|->
name|baseAddr
condition|)
name|p_Fm
operator|->
name|fmMuramPhysBaseAddr
operator|=
call|(
name|uint64_t
call|)
argument_list|(
name|XX_VirtToPhys
argument_list|(
name|UINT_TO_PTR
argument_list|(
name|p_Fm
operator|->
name|baseAddr
operator|+
name|FM_MM_MURAM
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
operator|||
operator|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
operator|)
condition|)
block|{
name|FM_DisableRamsEcc
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
name|FmMuramClear
argument_list|(
name|p_Fm
operator|->
name|h_FmMuram
argument_list|)
expr_stmt|;
name|FM_EnableRamsEcc
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|enum
name|fman_exceptions
name|FmanExceptionTrans
parameter_list|(
name|e_FmExceptions
name|exception
parameter_list|)
block|{
switch|switch
condition|(
name|exception
condition|)
block|{
case|case
name|e_FM_EX_DMA_BUS_ERROR
case|:
return|return
name|E_FMAN_EX_DMA_BUS_ERROR
return|;
case|case
name|e_FM_EX_DMA_READ_ECC
case|:
return|return
name|E_FMAN_EX_DMA_READ_ECC
return|;
case|case
name|e_FM_EX_DMA_SYSTEM_WRITE_ECC
case|:
return|return
name|E_FMAN_EX_DMA_SYSTEM_WRITE_ECC
return|;
case|case
name|e_FM_EX_DMA_FM_WRITE_ECC
case|:
return|return
name|E_FMAN_EX_DMA_FM_WRITE_ECC
return|;
case|case
name|e_FM_EX_FPM_STALL_ON_TASKS
case|:
return|return
name|E_FMAN_EX_FPM_STALL_ON_TASKS
return|;
case|case
name|e_FM_EX_FPM_SINGLE_ECC
case|:
return|return
name|E_FMAN_EX_FPM_SINGLE_ECC
return|;
case|case
name|e_FM_EX_FPM_DOUBLE_ECC
case|:
return|return
name|E_FMAN_EX_FPM_DOUBLE_ECC
return|;
case|case
name|e_FM_EX_QMI_SINGLE_ECC
case|:
return|return
name|E_FMAN_EX_QMI_SINGLE_ECC
return|;
case|case
name|e_FM_EX_QMI_DOUBLE_ECC
case|:
return|return
name|E_FMAN_EX_QMI_DOUBLE_ECC
return|;
case|case
name|e_FM_EX_QMI_DEQ_FROM_UNKNOWN_PORTID
case|:
return|return
name|E_FMAN_EX_QMI_DEQ_FROM_UNKNOWN_PORTID
return|;
case|case
name|e_FM_EX_BMI_LIST_RAM_ECC
case|:
return|return
name|E_FMAN_EX_BMI_LIST_RAM_ECC
return|;
case|case
name|e_FM_EX_BMI_STORAGE_PROFILE_ECC
case|:
return|return
name|E_FMAN_EX_BMI_STORAGE_PROFILE_ECC
return|;
case|case
name|e_FM_EX_BMI_STATISTICS_RAM_ECC
case|:
return|return
name|E_FMAN_EX_BMI_STATISTICS_RAM_ECC
return|;
case|case
name|e_FM_EX_BMI_DISPATCH_RAM_ECC
case|:
return|return
name|E_FMAN_EX_BMI_DISPATCH_RAM_ECC
return|;
case|case
name|e_FM_EX_IRAM_ECC
case|:
return|return
name|E_FMAN_EX_IRAM_ECC
return|;
case|case
name|e_FM_EX_MURAM_ECC
case|:
return|return
name|E_FMAN_EX_MURAM_ECC
return|;
default|default:
return|return
name|E_FMAN_EX_DMA_BUS_ERROR
return|;
block|}
block|}
end_function

begin_function
name|uint8_t
name|SwPortIdToHwPortId
parameter_list|(
name|e_FmPortType
name|type
parameter_list|,
name|uint8_t
name|relativePortId
parameter_list|,
name|uint8_t
name|majorRev
parameter_list|,
name|uint8_t
name|minorRev
parameter_list|)
block|{
switch|switch
condition|(
name|type
condition|)
block|{
case|case
operator|(
name|e_FM_PORT_TYPE_OH_OFFLINE_PARSING
operator|)
case|:
case|case
operator|(
name|e_FM_PORT_TYPE_OH_HOST_COMMAND
operator|)
case|:
name|CHECK_PORT_ID_OH_PORTS
argument_list|(
name|relativePortId
argument_list|)
expr_stmt|;
return|return
call|(
name|uint8_t
call|)
argument_list|(
name|BASE_OH_PORTID
operator|+
operator|(
name|relativePortId
operator|)
argument_list|)
return|;
case|case
operator|(
name|e_FM_PORT_TYPE_RX
operator|)
case|:
name|CHECK_PORT_ID_1G_RX_PORTS
argument_list|(
name|relativePortId
argument_list|)
expr_stmt|;
return|return
call|(
name|uint8_t
call|)
argument_list|(
name|BASE_1G_RX_PORTID
operator|+
operator|(
name|relativePortId
operator|)
argument_list|)
return|;
case|case
operator|(
name|e_FM_PORT_TYPE_RX_10G
operator|)
case|:
comment|/* The 10G port in T1024 (FMan Version 6.4) is the first port.                         * This is the reason why the 1G port offset is used.                         */
if|if
condition|(
name|majorRev
operator|==
literal|6
operator|&&
name|minorRev
operator|==
literal|4
condition|)
block|{
name|CHECK_PORT_ID_1G_RX_PORTS
argument_list|(
name|relativePortId
argument_list|)
expr_stmt|;
return|return
call|(
name|uint8_t
call|)
argument_list|(
name|BASE_1G_RX_PORTID
operator|+
operator|(
name|relativePortId
operator|)
argument_list|)
return|;
block|}
else|else
block|{
name|CHECK_PORT_ID_10G_RX_PORTS
argument_list|(
name|relativePortId
argument_list|)
expr_stmt|;
return|return
call|(
name|uint8_t
call|)
argument_list|(
name|BASE_10G_RX_PORTID
operator|+
operator|(
name|relativePortId
operator|)
argument_list|)
return|;
block|}
case|case
operator|(
name|e_FM_PORT_TYPE_TX
operator|)
case|:
name|CHECK_PORT_ID_1G_TX_PORTS
argument_list|(
name|relativePortId
argument_list|)
expr_stmt|;
return|return
call|(
name|uint8_t
call|)
argument_list|(
name|BASE_1G_TX_PORTID
operator|+
operator|(
name|relativePortId
operator|)
argument_list|)
return|;
case|case
operator|(
name|e_FM_PORT_TYPE_TX_10G
operator|)
case|:
comment|/* The 10G port in T1024 (FMan Version 6.4) is the first port.                         * This is the reason why the 1G port offset is used.                         */
if|if
condition|(
name|majorRev
operator|==
literal|6
operator|&&
name|minorRev
operator|==
literal|4
condition|)
block|{
name|CHECK_PORT_ID_1G_TX_PORTS
argument_list|(
name|relativePortId
argument_list|)
expr_stmt|;
return|return
call|(
name|uint8_t
call|)
argument_list|(
name|BASE_1G_TX_PORTID
operator|+
operator|(
name|relativePortId
operator|)
argument_list|)
return|;
block|}
else|else
block|{
name|CHECK_PORT_ID_10G_TX_PORTS
argument_list|(
name|relativePortId
argument_list|)
expr_stmt|;
return|return
call|(
name|uint8_t
call|)
argument_list|(
name|BASE_10G_TX_PORTID
operator|+
operator|(
name|relativePortId
operator|)
argument_list|)
return|;
block|}
default|default:
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Illegal port type"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
end_function

begin_if
if|#
directive|if
operator|(
name|defined
argument_list|(
name|DEBUG_ERRORS
argument_list|)
operator|&&
operator|(
name|DEBUG_ERRORS
operator|>
literal|0
operator|)
operator|)
end_if

begin_function
name|t_Error
name|FmDumpPortRegs
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint8_t
name|hardwarePortId
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|DECLARE_DUMP
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|IN_RANGE
argument_list|(
literal|1
argument_list|,
name|hardwarePortId
argument_list|,
literal|63
argument_list|)
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
operator|||
name|p_Fm
operator|->
name|baseAddr
operator|)
argument_list|,
name|E_INVALID_OPERATION
argument_list|)
expr_stmt|;
name|DUMP_TITLE
argument_list|(
operator|&
name|p_Fm
operator|->
name|p_FmBmiRegs
operator|->
name|fmbm_pp
index|[
name|hardwarePortId
operator|-
literal|1
index|]
argument_list|,
operator|(
literal|"fmbm_pp for port %u"
operator|,
operator|(
name|hardwarePortId
operator|)
operator|)
argument_list|)
expr_stmt|;
name|DUMP_MEMORY
argument_list|(
operator|&
name|p_Fm
operator|->
name|p_FmBmiRegs
operator|->
name|fmbm_pp
index|[
name|hardwarePortId
operator|-
literal|1
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
name|DUMP_TITLE
argument_list|(
operator|&
name|p_Fm
operator|->
name|p_FmBmiRegs
operator|->
name|fmbm_pfs
index|[
name|hardwarePortId
operator|-
literal|1
index|]
argument_list|,
operator|(
literal|"fmbm_pfs for port %u"
operator|,
operator|(
name|hardwarePortId
operator|)
operator|)
argument_list|)
expr_stmt|;
name|DUMP_MEMORY
argument_list|(
operator|&
name|p_Fm
operator|->
name|p_FmBmiRegs
operator|->
name|fmbm_pfs
index|[
name|hardwarePortId
operator|-
literal|1
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
name|DUMP_TITLE
argument_list|(
operator|&
name|p_Fm
operator|->
name|p_FmBmiRegs
operator|->
name|fmbm_spliodn
index|[
name|hardwarePortId
operator|-
literal|1
index|]
argument_list|,
operator|(
literal|"fmbm_spliodn for port %u"
operator|,
operator|(
name|hardwarePortId
operator|)
operator|)
argument_list|)
expr_stmt|;
name|DUMP_MEMORY
argument_list|(
operator|&
name|p_Fm
operator|->
name|p_FmBmiRegs
operator|->
name|fmbm_spliodn
index|[
name|hardwarePortId
operator|-
literal|1
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
name|DUMP_TITLE
argument_list|(
operator|&
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|->
name|fmfp_ps
index|[
name|hardwarePortId
index|]
argument_list|,
operator|(
literal|"fmfp_ps for port %u"
operator|,
operator|(
name|hardwarePortId
operator|)
operator|)
argument_list|)
expr_stmt|;
name|DUMP_MEMORY
argument_list|(
operator|&
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|->
name|fmfp_ps
index|[
name|hardwarePortId
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
name|DUMP_TITLE
argument_list|(
operator|&
name|p_Fm
operator|->
name|p_FmDmaRegs
operator|->
name|fmdmplr
index|[
name|hardwarePortId
operator|/
literal|2
index|]
argument_list|,
operator|(
literal|"fmdmplr for port %u"
operator|,
operator|(
name|hardwarePortId
operator|)
operator|)
argument_list|)
expr_stmt|;
name|DUMP_MEMORY
argument_list|(
operator|&
name|p_Fm
operator|->
name|p_FmDmaRegs
operator|->
name|fmdmplr
index|[
name|hardwarePortId
operator|/
literal|2
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* (defined(DEBUG_ERRORS)&& (DEBUG_ERRORS> 0)) */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_comment
comment|/*                      API Init unit functions                              */
end_comment

begin_comment
comment|/*****************************************************************************/
end_comment

begin_function
name|t_Handle
name|FM_Config
parameter_list|(
name|t_FmParams
modifier|*
name|p_FmParam
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
decl_stmt|;
name|uint8_t
name|i
decl_stmt|;
name|uintptr_t
name|baseAddr
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_FmParam
argument_list|,
name|E_NULL_POINTER
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
operator|(
operator|(
name|p_FmParam
operator|->
name|firmware
operator|.
name|p_Code
operator|&&
name|p_FmParam
operator|->
name|firmware
operator|.
name|size
operator|)
operator|||
operator|(
operator|!
name|p_FmParam
operator|->
name|firmware
operator|.
name|p_Code
operator|&&
operator|!
name|p_FmParam
operator|->
name|firmware
operator|.
name|size
operator|)
operator|)
argument_list|,
name|E_INVALID_VALUE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|baseAddr
operator|=
name|p_FmParam
operator|->
name|baseAddr
expr_stmt|;
comment|/* Allocate FM structure */
name|p_Fm
operator|=
operator|(
name|t_Fm
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|t_Fm
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Fm
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"FM driver structure"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_Fm
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_Fm
argument_list|)
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|=
operator|(
name|t_FmStateStruct
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|t_FmStateStruct
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|p_FmStateStruct
condition|)
block|{
name|XX_Free
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"FM Status structure"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmStateStruct
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Initialize FM parameters which will be kept by the driver */
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|fmId
operator|=
name|p_FmParam
operator|->
name|fmId
expr_stmt|;
name|p_Fm
operator|->
name|guestId
operator|=
name|p_FmParam
operator|->
name|guestId
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|FM_MAX_NUM_OF_HW_PORT_IDS
condition|;
name|i
operator|++
control|)
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|portsTypes
index|[
name|i
index|]
operator|=
name|e_FM_PORT_TYPE_DUMMY
expr_stmt|;
comment|/* Allocate the FM driver's parameters structure */
name|p_Fm
operator|->
name|p_FmDriverParam
operator|=
operator|(
expr|struct
name|fman_cfg
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|fman_cfg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|p_FmDriverParam
condition|)
block|{
name|XX_Free
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"FM driver parameters"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|fman_cfg
argument_list|)
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|DPAA_VERSION
operator|>=
literal|11
operator|)
name|p_Fm
operator|->
name|p_FmSp
operator|=
operator|(
name|t_FmSp
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|t_FmSp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|p_FmSp
condition|)
block|{
name|XX_Free
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"allocation for internal data structure failed"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_Fm
operator|->
name|p_FmSp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmSp
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|FM_VSP_MAX_NUM_OF_ENTRIES
condition|;
name|i
operator|++
control|)
name|p_Fm
operator|->
name|p_FmSp
operator|->
name|profiles
index|[
name|i
index|]
operator|.
name|profilesMng
operator|.
name|ownerId
operator|=
operator|(
name|uint8_t
operator|)
name|ILLEGAL_BASE
expr_stmt|;
endif|#
directive|endif
comment|/* (DPAA_VERSION>= 11) */
comment|/* Initialize FM parameters which will be kept by the driver */
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|fmId
operator|=
name|p_FmParam
operator|->
name|fmId
expr_stmt|;
name|p_Fm
operator|->
name|h_FmMuram
operator|=
name|p_FmParam
operator|->
name|h_FmMuram
expr_stmt|;
name|p_Fm
operator|->
name|h_App
operator|=
name|p_FmParam
operator|->
name|h_App
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|fmClkFreq
operator|=
name|p_FmParam
operator|->
name|fmClkFreq
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|fmMacClkFreq
operator|=
name|p_FmParam
operator|->
name|fmClkFreq
operator|/
operator|(
operator|(
operator|!
name|p_FmParam
operator|->
name|fmMacClkRatio
operator|)
condition|?
literal|2
else|:
name|p_FmParam
operator|->
name|fmMacClkRatio
operator|)
expr_stmt|;
name|p_Fm
operator|->
name|f_Exception
operator|=
name|p_FmParam
operator|->
name|f_Exception
expr_stmt|;
name|p_Fm
operator|->
name|f_BusError
operator|=
name|p_FmParam
operator|->
name|f_BusError
expr_stmt|;
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|=
operator|(
expr|struct
name|fman_fpm_regs
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|baseAddr
operator|+
name|FM_MM_FPM
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmBmiRegs
operator|=
operator|(
expr|struct
name|fman_bmi_regs
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|baseAddr
operator|+
name|FM_MM_BMI
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmQmiRegs
operator|=
operator|(
expr|struct
name|fman_qmi_regs
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|baseAddr
operator|+
name|FM_MM_QMI
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDmaRegs
operator|=
operator|(
expr|struct
name|fman_dma_regs
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|baseAddr
operator|+
name|FM_MM_DMA
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmRegs
operator|=
operator|(
expr|struct
name|fman_regs
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|baseAddr
operator|+
name|FM_MM_BMI
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|baseAddr
operator|=
name|baseAddr
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|irq
operator|=
name|p_FmParam
operator|->
name|irq
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|errIrq
operator|=
name|p_FmParam
operator|->
name|errIrq
expr_stmt|;
name|p_Fm
operator|->
name|hcPortInitialized
operator|=
name|FALSE
expr_stmt|;
name|p_Fm
operator|->
name|independentMode
operator|=
name|FALSE
expr_stmt|;
name|p_Fm
operator|->
name|h_Spinlock
operator|=
name|XX_InitSpinlock
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|h_Spinlock
condition|)
block|{
name|XX_Free
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"can't allocate spinlock!"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|#
directive|if
operator|(
name|DPAA_VERSION
operator|>=
literal|11
operator|)
name|p_Fm
operator|->
name|partVSPBase
operator|=
name|p_FmParam
operator|->
name|partVSPBase
expr_stmt|;
name|p_Fm
operator|->
name|partNumOfVSPs
operator|=
name|p_FmParam
operator|->
name|partNumOfVSPs
expr_stmt|;
name|p_Fm
operator|->
name|vspBaseAddr
operator|=
name|p_FmParam
operator|->
name|vspBaseAddr
expr_stmt|;
endif|#
directive|endif
comment|/* (DPAA_VERSION>= 11) */
name|fman_defconfig
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
operator|!
operator|!
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|)
expr_stmt|;
comment|/* overide macros dependent parameters */
ifdef|#
directive|ifdef
name|FM_PEDANTIC_DMA
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|pedantic_dma
operator|=
name|TRUE
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_aid_override
operator|=
name|TRUE
expr_stmt|;
endif|#
directive|endif
comment|/* FM_PEDANTIC_DMA */
ifndef|#
directive|ifndef
name|FM_QMI_NO_DEQ_OPTIONS_SUPPORT
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|qmi_deq_option_support
operator|=
name|TRUE
expr_stmt|;
endif|#
directive|endif
comment|/* !FM_QMI_NO_DEQ_OPTIONS_SUPPORT */
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|ramsEccEnable
operator|=
name|FALSE
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|extraFifoPoolSize
operator|=
literal|0
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|exceptions
operator|=
name|DEFAULT_exceptions
expr_stmt|;
name|p_Fm
operator|->
name|resetOnInit
operator|=
name|DEFAULT_resetOnInit
expr_stmt|;
name|p_Fm
operator|->
name|f_ResetOnInitOverride
operator|=
name|DEFAULT_resetOnInitOverrideCallback
expr_stmt|;
name|p_Fm
operator|->
name|fwVerify
operator|=
name|DEFAULT_VerifyUcode
expr_stmt|;
name|p_Fm
operator|->
name|firmware
operator|.
name|size
operator|=
name|p_FmParam
operator|->
name|firmware
operator|.
name|size
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|firmware
operator|.
name|size
condition|)
block|{
name|p_Fm
operator|->
name|firmware
operator|.
name|p_Code
operator|=
operator|(
name|uint32_t
operator|*
operator|)
name|XX_Malloc
argument_list|(
name|p_Fm
operator|->
name|firmware
operator|.
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|firmware
operator|.
name|p_Code
condition|)
block|{
name|XX_FreeSpinlock
argument_list|(
name|p_Fm
operator|->
name|h_Spinlock
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"FM firmware code"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memcpy
argument_list|(
name|p_Fm
operator|->
name|firmware
operator|.
name|p_Code
argument_list|,
name|p_FmParam
operator|->
name|firmware
operator|.
name|p_Code
argument_list|,
name|p_Fm
operator|->
name|firmware
operator|.
name|size
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
return|return
name|p_Fm
return|;
comment|/* read revision */
comment|/* Chip dependent, will be configured in Init */
name|fman_get_revision
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
argument_list|,
operator|&
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
argument_list|,
operator|&
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|minorRev
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_AID_MODE_NO_TNUM_SW005
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|>=
literal|6
condition|)
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_aid_mode
operator|=
name|e_FM_DMA_AID_OUT_PORT_ID
expr_stmt|;
endif|#
directive|endif
comment|/* FM_AID_MODE_NO_TNUM_SW005 */
ifndef|#
directive|ifndef
name|FM_QMI_NO_DEQ_OPTIONS_SUPPORT
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|!=
literal|4
condition|)
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|qmi_def_tnums_thresh
operator|=
name|QMI_DEF_TNUMS_THRESH
expr_stmt|;
endif|#
directive|endif
comment|/* FM_QMI_NO_DEQ_OPTIONS_SUPPORT */
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|totalFifoSize
operator|=
literal|0
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|totalNumOfTasks
operator|=
name|DEFAULT_totalNumOfTasks
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|minorRev
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_HAS_TOTAL_DMAS
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|maxNumOfOpenDmas
operator|=
name|BMI_MAX_NUM_OF_DMAS
expr_stmt|;
endif|#
directive|endif
comment|/* FM_HAS_TOTAL_DMAS */
if|#
directive|if
operator|(
name|DPAA_VERSION
operator|<
literal|11
operator|)
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_comm_qtsh_clr_emer
operator|=
name|DEFAULT_dmaCommQLow
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_comm_qtsh_asrt_emer
operator|=
name|DEFAULT_dmaCommQHigh
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_cam_num_of_entries
operator|=
name|DEFAULT_dmaCamNumOfEntries
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_read_buf_tsh_clr_emer
operator|=
name|DEFAULT_dmaReadIntBufLow
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_read_buf_tsh_asrt_emer
operator|=
name|DEFAULT_dmaReadIntBufHigh
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_write_buf_tsh_clr_emer
operator|=
name|DEFAULT_dmaWriteIntBufLow
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_write_buf_tsh_asrt_emer
operator|=
name|DEFAULT_dmaWriteIntBufHigh
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_axi_dbg_num_of_beats
operator|=
name|DEFAULT_axiDbgNumOfBeats
expr_stmt|;
endif|#
directive|endif
comment|/* (DPAA_VERSION< 11) */
ifdef|#
directive|ifdef
name|FM_NO_TNUM_AGING
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|tnum_aging_period
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
name|p_Fm
operator|->
name|tnumAgingPeriod
operator|=
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|tnum_aging_period
expr_stmt|;
return|return
name|p_Fm
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************/
end_comment

begin_comment
comment|/**  @Function      FM_Init   @Description   Initializes the FM module   @Param[in]     h_Fm - FM module descriptor   @Return        E_OK on success; Error code otherwise. */
end_comment

begin_comment
comment|/***************************************************************************/
end_comment

begin_function
name|t_Error
name|FM_Init
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|struct
name|fman_cfg
modifier|*
name|p_FmDriverParam
init|=
name|NULL
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|int
name|i
decl_stmt|;
name|t_FmRevisionInfo
name|revInfo
decl_stmt|;
name|struct
name|fman_rg
name|fman_rg
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|fman_rg
operator|.
name|bmi_rg
operator|=
name|p_Fm
operator|->
name|p_FmBmiRegs
expr_stmt|;
name|fman_rg
operator|.
name|qmi_rg
operator|=
name|p_Fm
operator|->
name|p_FmQmiRegs
expr_stmt|;
name|fman_rg
operator|.
name|fpm_rg
operator|=
name|p_Fm
operator|->
name|p_FmFpmRegs
expr_stmt|;
name|fman_rg
operator|.
name|dma_rg
operator|=
name|p_Fm
operator|->
name|p_FmDmaRegs
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|count1MicroBit
operator|=
name|FM_TIMESTAMP_1_USEC_BIT
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|num_of_fman_ctrl_evnt_regs
operator|=
name|FM_NUM_OF_FMAN_CTRL_EVENT_REGS
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
return|return
name|InitGuestMode
argument_list|(
name|p_Fm
argument_list|)
return|;
comment|/* if user didn't configured totalFifoSize - (totalFifoSize=0) we configure default     * according to chip. otherwise, we use user's configuration.     */
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|totalFifoSize
operator|==
literal|0
condition|)
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|totalFifoSize
operator|=
name|DEFAULT_totalFifoSize
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|minorRev
argument_list|)
expr_stmt|;
name|CHECK_INIT_PARAMETERS
argument_list|(
name|p_Fm
argument_list|,
name|CheckFmParameters
argument_list|)
expr_stmt|;
name|p_FmDriverParam
operator|=
name|p_Fm
operator|->
name|p_FmDriverParam
expr_stmt|;
name|FM_GetRevision
argument_list|(
name|p_Fm
argument_list|,
operator|&
name|revInfo
argument_list|)
expr_stmt|;
comment|/* clear revision-dependent non existing exception */
ifdef|#
directive|ifdef
name|FM_NO_DISPATCH_RAM_ECC
if|if
condition|(
operator|(
name|revInfo
operator|.
name|majorRev
operator|!=
literal|4
operator|)
operator|&&
operator|(
name|revInfo
operator|.
name|majorRev
operator|<
literal|6
operator|)
condition|)
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|exceptions
operator|&=
operator|~
name|FM_EX_BMI_DISPATCH_RAM_ECC
expr_stmt|;
endif|#
directive|endif
comment|/* FM_NO_DISPATCH_RAM_ECC */
ifdef|#
directive|ifdef
name|FM_QMI_NO_ECC_EXCEPTIONS
if|if
condition|(
name|revInfo
operator|.
name|majorRev
operator|==
literal|4
condition|)
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|exceptions
operator|&=
operator|~
operator|(
name|FM_EX_QMI_SINGLE_ECC
operator||
name|FM_EX_QMI_DOUBLE_ECC
operator|)
expr_stmt|;
endif|#
directive|endif
comment|/* FM_QMI_NO_ECC_EXCEPTIONS */
ifdef|#
directive|ifdef
name|FM_QMI_NO_SINGLE_ECC_EXCEPTION
if|if
condition|(
name|revInfo
operator|.
name|majorRev
operator|>=
literal|6
condition|)
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|exceptions
operator|&=
operator|~
name|FM_EX_QMI_SINGLE_ECC
expr_stmt|;
endif|#
directive|endif
comment|/* FM_QMI_NO_SINGLE_ECC_EXCEPTION */
name|FmMuramClear
argument_list|(
name|p_Fm
operator|->
name|h_FmMuram
argument_list|)
expr_stmt|;
comment|/* clear CPG */
name|IOMemSet32
argument_list|(
name|UINT_TO_PTR
argument_list|(
name|p_Fm
operator|->
name|baseAddr
operator|+
name|FM_MM_CGP
argument_list|)
argument_list|,
literal|0
argument_list|,
name|FM_PORT_NUM_OF_CONGESTION_GRPS
argument_list|)
expr_stmt|;
comment|/* add to the default exceptions the user's definitions */
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|exceptions
operator||=
name|p_Fm
operator|->
name|userSetExceptions
expr_stmt|;
comment|/* Reset the FM if required */
if|if
condition|(
name|p_Fm
operator|->
name|resetOnInit
condition|)
block|{
ifdef|#
directive|ifdef
name|FM_UCODE_NOT_RESET_ERRATA_BUGZILLA6173
if|if
condition|(
operator|(
name|err
operator|=
name|FwNotResetErratumBugzilla6173WA
argument_list|(
name|p_Fm
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* not FM_UCODE_NOT_RESET_ERRATA_BUGZILLA6173 */
if|if
condition|(
name|p_Fm
operator|->
name|f_ResetOnInitOverride
condition|)
block|{
comment|/* Perform user specific FMan reset */
name|p_Fm
operator|->
name|f_ResetOnInitOverride
argument_list|(
name|h_Fm
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Perform FMan reset */
name|FmReset
argument_list|(
name|h_Fm
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fman_is_qmi_halt_not_busy_state
argument_list|(
name|p_Fm
operator|->
name|p_FmQmiRegs
argument_list|)
condition|)
block|{
name|fman_resume
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
argument_list|)
expr_stmt|;
name|XX_UDelay
argument_list|(
literal|100
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* not FM_UCODE_NOT_RESET_ERRATA_BUGZILLA6173 */
block|}
ifdef|#
directive|ifdef
name|FM_UCODE_NOT_RESET_ERRATA_BUGZILLA6173
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|resetOnInit
condition|)
comment|/* Skip operations done in errata workaround */
block|{
endif|#
directive|endif
comment|/* FM_UCODE_NOT_RESET_ERRATA_BUGZILLA6173 */
comment|/* Load FMan-Controller code to IRAM */
name|ClearIRam
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|firmware
operator|.
name|p_Code
operator|&&
operator|(
name|LoadFmanCtrlCode
argument_list|(
name|p_Fm
argument_list|)
operator|!=
name|E_OK
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_UCODE_NOT_RESET_ERRATA_BUGZILLA6173
block|}
endif|#
directive|endif
comment|/* FM_UCODE_NOT_RESET_ERRATA_BUGZILLA6173 */
ifdef|#
directive|ifdef
name|FM_CAPWAP_SUPPORT
comment|/* save first 256 byte in MURAM */
name|p_Fm
operator|->
name|resAddr
operator|=
name|PTR_TO_UINT
argument_list|(
name|FM_MURAM_AllocMem
argument_list|(
name|p_Fm
operator|->
name|h_FmMuram
argument_list|,
literal|256
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|resAddr
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"MURAM alloc for reserved Area failed"
operator|)
argument_list|)
expr_stmt|;
name|WRITE_BLOCK
argument_list|(
name|UINT_TO_PTR
argument_list|(
name|p_Fm
operator|->
name|resAddr
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|256
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* FM_CAPWAP_SUPPORT */
if|#
directive|if
operator|(
name|DPAA_VERSION
operator|>=
literal|11
operator|)
name|p_Fm
operator|->
name|partVSPBase
operator|=
name|AllocVSPsForPartition
argument_list|(
name|h_Fm
argument_list|,
name|p_Fm
operator|->
name|partVSPBase
argument_list|,
name|p_Fm
operator|->
name|partNumOfVSPs
argument_list|,
name|p_Fm
operator|->
name|guestId
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|partVSPBase
operator|==
call|(
name|uint8_t
call|)
argument_list|(
name|ILLEGAL_BASE
argument_list|)
condition|)
name|DBG
argument_list|(
name|WARNING
argument_list|,
operator|(
literal|"partition VSPs allocation is FAILED"
operator|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* (DPAA_VERSION>= 11) */
comment|/* General FM driver initialization */
name|p_Fm
operator|->
name|fmMuramPhysBaseAddr
operator|=
call|(
name|uint64_t
call|)
argument_list|(
name|XX_VirtToPhys
argument_list|(
name|UINT_TO_PTR
argument_list|(
name|p_Fm
operator|->
name|baseAddr
operator|+
name|FM_MM_MURAM
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|e_FM_EV_DUMMY_LAST
condition|;
name|i
operator|++
control|)
name|p_Fm
operator|->
name|intrMng
index|[
name|i
index|]
operator|.
name|f_Isr
operator|=
name|UnimplementedIsr
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|FM_NUM_OF_FMAN_CTRL_EVENT_REGS
condition|;
name|i
operator|++
control|)
name|p_Fm
operator|->
name|fmanCtrlIntr
index|[
name|i
index|]
operator|.
name|f_Isr
operator|=
name|UnimplementedFmanCtrlIsr
expr_stmt|;
name|p_FmDriverParam
operator|->
name|exceptions
operator|=
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|exceptions
expr_stmt|;
comment|/**********************/
comment|/* Init DMA Registers */
comment|/**********************/
name|err
operator|=
name|InitFmDma
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
block|{
name|FreeInitResources
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
comment|/**********************/
comment|/* Init FPM Registers */
comment|/**********************/
name|err
operator|=
name|InitFmFpm
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
block|{
name|FreeInitResources
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
comment|/* define common resources */
comment|/* allocate MURAM for FIFO according to total size */
name|p_Fm
operator|->
name|fifoBaseAddr
operator|=
name|PTR_TO_UINT
argument_list|(
name|FM_MURAM_AllocMem
argument_list|(
name|p_Fm
operator|->
name|h_FmMuram
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|totalFifoSize
argument_list|,
name|BMI_FIFO_ALIGN
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|fifoBaseAddr
condition|)
block|{
name|FreeInitResources
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"MURAM alloc for BMI FIFO failed"
operator|)
argument_list|)
expr_stmt|;
block|}
name|p_FmDriverParam
operator|->
name|fifo_base_addr
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|XX_VirtToPhys
argument_list|(
name|UINT_TO_PTR
argument_list|(
name|p_Fm
operator|->
name|fifoBaseAddr
argument_list|)
argument_list|)
operator|-
name|p_Fm
operator|->
name|fmMuramPhysBaseAddr
argument_list|)
expr_stmt|;
name|p_FmDriverParam
operator|->
name|total_fifo_size
operator|=
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|totalFifoSize
expr_stmt|;
name|p_FmDriverParam
operator|->
name|total_num_of_tasks
operator|=
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|totalNumOfTasks
expr_stmt|;
name|p_FmDriverParam
operator|->
name|clk_freq
operator|=
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|fmClkFreq
expr_stmt|;
comment|/**********************/
comment|/* Init BMI Registers */
comment|/**********************/
name|err
operator|=
name|InitFmBmi
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
block|{
name|FreeInitResources
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
comment|/**********************/
comment|/* Init QMI Registers */
comment|/**********************/
name|err
operator|=
name|InitFmQmi
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
block|{
name|FreeInitResources
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
comment|/* build the FM master partition IPC address */
if|if
condition|(
name|Sprint
argument_list|(
name|p_Fm
operator|->
name|fmModuleName
argument_list|,
literal|"FM_%d_%d"
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|fmId
argument_list|,
name|NCSW_MASTER_ID
argument_list|)
operator|!=
literal|6
condition|)
block|{
name|FreeInitResources
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Sprint failed"
operator|)
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|XX_IpcRegisterMsgHandler
argument_list|(
name|p_Fm
operator|->
name|fmModuleName
argument_list|,
name|FmHandleIpcMsgCB
argument_list|,
name|p_Fm
argument_list|,
name|FM_IPC_MAX_REPLY_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|FreeInitResources
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
comment|/* Register the FM interrupts handlers */
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|irq
operator|!=
name|NO_IRQ
condition|)
block|{
name|XX_SetIntr
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|irq
argument_list|,
name|FM_EventIsr
argument_list|,
name|p_Fm
argument_list|)
expr_stmt|;
name|XX_EnableIntr
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|irq
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|errIrq
operator|!=
name|NO_IRQ
condition|)
block|{
name|XX_SetIntr
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|errIrq
argument_list|,
operator|(
name|void
argument_list|(
operator|*
argument_list|)
argument_list|(
name|t_Handle
argument_list|)
operator|)
name|FM_ErrorIsr
argument_list|,
name|p_Fm
argument_list|)
expr_stmt|;
name|XX_EnableIntr
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|errIrq
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
operator|(
name|t_Error
operator|)
name|fman_enable
argument_list|(
operator|&
name|fman_rg
argument_list|,
name|p_FmDriverParam
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
return|return
name|err
return|;
comment|/* FIXME */
name|EnableTimeStamp
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|firmware
operator|.
name|p_Code
condition|)
block|{
name|XX_Free
argument_list|(
name|p_Fm
operator|->
name|firmware
operator|.
name|p_Code
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|firmware
operator|.
name|p_Code
operator|=
name|NULL
expr_stmt|;
block|}
name|XX_Free
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|=
name|NULL
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/**************************************************************************/
end_comment

begin_comment
comment|/**  @Function      FM_Free   @Description   Frees all resources that were assigned to FM module.                  Calling this routine invalidates the descriptor.   @Param[in]     h_Fm - FM module descriptor   @Return        E_OK on success; Error code otherwise. */
end_comment

begin_comment
comment|/***************************************************************************/
end_comment

begin_function
name|t_Error
name|FM_Free
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|struct
name|fman_rg
name|fman_rg
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|fman_rg
operator|.
name|bmi_rg
operator|=
name|p_Fm
operator|->
name|p_FmBmiRegs
expr_stmt|;
name|fman_rg
operator|.
name|qmi_rg
operator|=
name|p_Fm
operator|->
name|p_FmQmiRegs
expr_stmt|;
name|fman_rg
operator|.
name|fpm_rg
operator|=
name|p_Fm
operator|->
name|p_FmFpmRegs
expr_stmt|;
name|fman_rg
operator|.
name|dma_rg
operator|=
name|p_Fm
operator|->
name|p_FmDmaRegs
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
block|{
if|#
directive|if
operator|(
name|DPAA_VERSION
operator|>=
literal|11
operator|)
name|FreeVSPsForPartition
argument_list|(
name|h_Fm
argument_list|,
name|p_Fm
operator|->
name|partVSPBase
argument_list|,
name|p_Fm
operator|->
name|partNumOfVSPs
argument_list|,
name|p_Fm
operator|->
name|guestId
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|p_FmSp
condition|)
block|{
name|XX_Free
argument_list|(
name|p_Fm
operator|->
name|p_FmSp
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmSp
operator|=
name|NULL
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* (DPAA_VERSION>= 11) */
if|if
condition|(
name|p_Fm
operator|->
name|fmModuleName
index|[
literal|0
index|]
operator|!=
literal|0
condition|)
name|XX_IpcUnregisterMsgHandler
argument_list|(
name|p_Fm
operator|->
name|fmModuleName
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|recoveryMode
condition|)
name|XX_Free
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
name|fman_free_resources
argument_list|(
operator|&
name|fman_rg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
operator|&&
operator|(
name|p_Fm
operator|->
name|fmModuleName
index|[
literal|0
index|]
operator|!=
literal|0
operator|)
condition|)
name|XX_IpcUnregisterMsgHandler
argument_list|(
name|p_Fm
operator|->
name|fmModuleName
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
condition|)
block|{
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|irq
operator|!=
name|NO_IRQ
condition|)
block|{
name|XX_DisableIntr
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|irq
argument_list|)
expr_stmt|;
name|XX_FreeIntr
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|irq
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|errIrq
operator|!=
name|NO_IRQ
condition|)
block|{
name|XX_DisableIntr
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|errIrq
argument_list|)
expr_stmt|;
name|XX_FreeIntr
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|errIrq
argument_list|)
expr_stmt|;
block|}
block|}
if|#
directive|if
operator|(
name|DPAA_VERSION
operator|>=
literal|11
operator|)
name|FreeVSPsForPartition
argument_list|(
name|h_Fm
argument_list|,
name|p_Fm
operator|->
name|partVSPBase
argument_list|,
name|p_Fm
operator|->
name|partNumOfVSPs
argument_list|,
name|p_Fm
operator|->
name|guestId
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|p_FmSp
condition|)
block|{
name|XX_Free
argument_list|(
name|p_Fm
operator|->
name|p_FmSp
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmSp
operator|=
name|NULL
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* (DPAA_VERSION>= 11) */
if|if
condition|(
name|p_Fm
operator|->
name|h_Spinlock
condition|)
name|XX_FreeSpinlock
argument_list|(
name|p_Fm
operator|->
name|h_Spinlock
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|p_FmDriverParam
condition|)
block|{
if|if
condition|(
name|p_Fm
operator|->
name|firmware
operator|.
name|p_Code
condition|)
name|XX_Free
argument_list|(
name|p_Fm
operator|->
name|firmware
operator|.
name|p_Code
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|=
name|NULL
expr_stmt|;
block|}
name|FreeInitResources
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|recoveryMode
operator|&&
name|p_Fm
operator|->
name|p_FmStateStruct
condition|)
name|XX_Free
argument_list|(
name|p_Fm
operator|->
name|p_FmStateStruct
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/*************************************************/
end_comment

begin_comment
comment|/*       API Advanced Init unit functions        */
end_comment

begin_comment
comment|/*************************************************/
end_comment

begin_function
name|t_Error
name|FM_ConfigResetOnInit
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|resetOnInit
operator|=
name|enable
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_ConfigResetOnInitOverrideCallback
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|t_FmResetOnInitOverrideCallback
modifier|*
name|f_ResetOnInitOverride
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|f_ResetOnInitOverride
operator|=
name|f_ResetOnInitOverride
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_ConfigTotalFifoSize
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint32_t
name|totalFifoSize
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|totalFifoSize
operator|=
name|totalFifoSize
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_ConfigDmaCacheOverride
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|e_FmDmaCacheOverride
name|cacheOverride
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|enum
name|fman_dma_cache_override
name|fsl_cache_override
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|FMAN_CACHE_OVERRIDE_TRANS
argument_list|(
argument|fsl_cache_override
argument_list|,
argument|cacheOverride
argument_list|)
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_cache_override
operator|=
name|fsl_cache_override
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_ConfigDmaAidOverride
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|bool
name|aidOverride
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_aid_override
operator|=
name|aidOverride
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_ConfigDmaAidMode
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|e_FmDmaAidMode
name|aidMode
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|enum
name|fman_dma_aid_mode
name|fsl_aid_mode
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|FMAN_AID_MODE_TRANS
argument_list|(
name|fsl_aid_mode
argument_list|,
name|aidMode
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_aid_mode
operator|=
name|fsl_aid_mode
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_ConfigDmaAxiDbgNumOfBeats
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint8_t
name|axiDbgNumOfBeats
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|DPAA_VERSION
operator|>=
literal|11
operator|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"Not available for this FM revision!"
operator|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_axi_dbg_num_of_beats
operator|=
name|axiDbgNumOfBeats
expr_stmt|;
return|return
name|E_OK
return|;
endif|#
directive|endif
comment|/* (DPAA_VERSION>= 11) */
block|}
end_function

begin_function
name|t_Error
name|FM_ConfigDmaCamNumOfEntries
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint8_t
name|numOfEntries
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_cam_num_of_entries
operator|=
name|numOfEntries
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_ConfigDmaDbgCounter
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|e_FmDmaDbgCntMode
name|fmDmaDbgCntMode
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|enum
name|fman_dma_dbg_cnt_mode
name|fsl_dma_dbg_cnt
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|FMAN_DMA_DBG_CNT_TRANS
argument_list|(
name|fsl_dma_dbg_cnt
argument_list|,
name|fmDmaDbgCntMode
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_dbg_cnt_mode
operator|=
name|fsl_dma_dbg_cnt
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_ConfigDmaStopOnBusErr
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|bool
name|stop
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_stop_on_bus_error
operator|=
name|stop
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_ConfigDmaEmergency
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|t_FmDmaEmergency
modifier|*
name|p_Emergency
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|enum
name|fman_dma_emergency_level
name|fsl_dma_emer
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|FMAN_DMA_EMER_TRANS
argument_list|(
name|fsl_dma_emer
argument_list|,
name|p_Emergency
operator|->
name|emergencyLevel
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_en_emergency
operator|=
name|TRUE
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_emergency_bus_select
operator|=
operator|(
name|uint32_t
operator|)
name|p_Emergency
operator|->
name|emergencyBusSelect
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_emergency_level
operator|=
name|fsl_dma_emer
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_ConfigDmaEmergencySmoother
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint32_t
name|emergencyCnt
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_en_emergency_smoother
operator|=
name|TRUE
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_emergency_switch_counter
operator|=
name|emergencyCnt
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_ConfigDmaErr
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|e_FmDmaErr
name|dmaErr
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|enum
name|fman_dma_err
name|fsl_dma_err
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|FMAN_DMA_ERR_TRANS
argument_list|(
name|fsl_dma_err
argument_list|,
name|dmaErr
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_err
operator|=
name|fsl_dma_err
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_ConfigCatastrophicErr
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|e_FmCatastrophicErr
name|catastrophicErr
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|enum
name|fman_catastrophic_err
name|fsl_catastrophic_err
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|FMAN_CATASTROPHIC_ERR_TRANS
argument_list|(
name|fsl_catastrophic_err
argument_list|,
name|catastrophicErr
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|catastrophic_err
operator|=
name|fsl_catastrophic_err
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_ConfigEnableMuramTestMode
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|>=
literal|6
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"Not available for this FM revision!"
operator|)
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|en_muram_test_mode
operator|=
name|TRUE
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_ConfigEnableIramTestMode
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|>=
literal|6
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"Not available for this FM revision!"
operator|)
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|en_iram_test_mode
operator|=
name|TRUE
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_ConfigHaltOnExternalActivation
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|halt_on_external_activ
operator|=
name|enable
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_ConfigHaltOnUnrecoverableEccError
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|>=
literal|6
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"Not available for this FM revision!"
operator|)
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|halt_on_unrecov_ecc_err
operator|=
name|enable
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_ConfigException
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|e_FmExceptions
name|exception
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|uint32_t
name|bitMask
init|=
literal|0
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|GET_EXCEPTION_FLAG
argument_list|(
name|bitMask
argument_list|,
name|exception
argument_list|)
expr_stmt|;
if|if
condition|(
name|bitMask
condition|)
block|{
if|if
condition|(
name|enable
condition|)
name|p_Fm
operator|->
name|userSetExceptions
operator||=
name|bitMask
expr_stmt|;
else|else
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|exceptions
operator|&=
operator|~
name|bitMask
expr_stmt|;
block|}
else|else
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Undefined exception"
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_ConfigExternalEccRamsEnable
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|external_ecc_rams_enable
operator|=
name|enable
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_ConfigTnumAgingPeriod
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint16_t
name|tnumAgingPeriod
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|tnum_aging_period
operator|=
name|tnumAgingPeriod
expr_stmt|;
name|p_Fm
operator|->
name|tnumAgingPeriod
operator|=
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|tnum_aging_period
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/****************************************************/
end_comment

begin_comment
comment|/*       Hidden-DEBUG Only API                      */
end_comment

begin_comment
comment|/****************************************************/
end_comment

begin_function
name|t_Error
name|FM_ConfigThresholds
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|t_FmThresholds
modifier|*
name|p_FmThresholds
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|disp_limit_tsh
operator|=
name|p_FmThresholds
operator|->
name|dispLimit
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|prs_disp_tsh
operator|=
name|p_FmThresholds
operator|->
name|prsDispTh
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|plcr_disp_tsh
operator|=
name|p_FmThresholds
operator|->
name|plcrDispTh
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|kg_disp_tsh
operator|=
name|p_FmThresholds
operator|->
name|kgDispTh
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|bmi_disp_tsh
operator|=
name|p_FmThresholds
operator|->
name|bmiDispTh
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|qmi_enq_disp_tsh
operator|=
name|p_FmThresholds
operator|->
name|qmiEnqDispTh
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|qmi_deq_disp_tsh
operator|=
name|p_FmThresholds
operator|->
name|qmiDeqDispTh
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|fm_ctl1_disp_tsh
operator|=
name|p_FmThresholds
operator|->
name|fmCtl1DispTh
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|fm_ctl2_disp_tsh
operator|=
name|p_FmThresholds
operator|->
name|fmCtl2DispTh
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_ConfigDmaSosEmergencyThreshold
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint32_t
name|dmaSosEmergency
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_sos_emergency
operator|=
name|dmaSosEmergency
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_ConfigDmaWriteBufThresholds
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|t_FmDmaThresholds
modifier|*
name|p_FmDmaThresholds
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|DPAA_VERSION
operator|>=
literal|11
operator|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"Not available for this FM revision!"
operator|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_write_buf_tsh_asrt_emer
operator|=
name|p_FmDmaThresholds
operator|->
name|assertEmergency
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_write_buf_tsh_clr_emer
operator|=
name|p_FmDmaThresholds
operator|->
name|clearEmergency
expr_stmt|;
return|return
name|E_OK
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|t_Error
name|FM_ConfigDmaCommQThresholds
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|t_FmDmaThresholds
modifier|*
name|p_FmDmaThresholds
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_comm_qtsh_asrt_emer
operator|=
name|p_FmDmaThresholds
operator|->
name|assertEmergency
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_comm_qtsh_clr_emer
operator|=
name|p_FmDmaThresholds
operator|->
name|clearEmergency
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_ConfigDmaReadBufThresholds
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|t_FmDmaThresholds
modifier|*
name|p_FmDmaThresholds
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
if|#
directive|if
operator|(
name|DPAA_VERSION
operator|>=
literal|11
operator|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"Not available for this FM revision!"
operator|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_read_buf_tsh_clr_emer
operator|=
name|p_FmDmaThresholds
operator|->
name|clearEmergency
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_read_buf_tsh_asrt_emer
operator|=
name|p_FmDmaThresholds
operator|->
name|assertEmergency
expr_stmt|;
return|return
name|E_OK
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|t_Error
name|FM_ConfigDmaWatchdog
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint32_t
name|watchdogValue
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmDriverParam
operator|->
name|dma_watchdog
operator|=
name|watchdogValue
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_ConfigEnableCounters
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FmGetSetParams
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|t_FmGetSetParams
modifier|*
name|p_Params
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
if|if
condition|(
name|p_Params
operator|->
name|setParams
operator|.
name|type
operator|&
name|UPDATE_FM_CLD
condition|)
block|{
name|WRITE_UINT32
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|->
name|fm_cld
argument_list|,
name|GET_UINT32
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|->
name|fm_cld
argument_list|)
operator||
literal|0x00000800
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p_Params
operator|->
name|setParams
operator|.
name|type
operator|&
name|CLEAR_IRAM_READY
condition|)
block|{
name|t_FMIramRegs
modifier|*
name|p_Iram
init|=
operator|(
name|t_FMIramRegs
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|p_Fm
operator|->
name|baseAddr
operator|+
name|FM_MM_IMEM
argument_list|)
decl_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Iram
operator|->
name|iready
argument_list|,
name|GET_UINT32
argument_list|(
name|p_Iram
operator|->
name|iready
argument_list|)
operator|&
operator|~
name|IRAM_READY
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p_Params
operator|->
name|setParams
operator|.
name|type
operator|&
name|UPDATE_FPM_EXTC
condition|)
name|WRITE_UINT32
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|->
name|fmfp_extc
argument_list|,
literal|0x80000000
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Params
operator|->
name|setParams
operator|.
name|type
operator|&
name|UPDATE_FPM_EXTC_CLEAR
condition|)
name|WRITE_UINT32
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|->
name|fmfp_extc
argument_list|,
literal|0x00800000
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Params
operator|->
name|setParams
operator|.
name|type
operator|&
name|UPDATE_FPM_BRKC_SLP
condition|)
block|{
if|if
condition|(
name|p_Params
operator|->
name|setParams
operator|.
name|sleep
condition|)
name|WRITE_UINT32
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|->
name|fmfp_brkc
argument_list|,
name|GET_UINT32
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|->
name|fmfp_brkc
argument_list|)
operator||
name|FPM_BRKC_SLP
argument_list|)
expr_stmt|;
else|else
name|WRITE_UINT32
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|->
name|fmfp_brkc
argument_list|,
name|GET_UINT32
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|->
name|fmfp_brkc
argument_list|)
operator|&
operator|~
name|FPM_BRKC_SLP
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p_Params
operator|->
name|getParams
operator|.
name|type
operator|&
name|GET_FM_CLD
condition|)
name|p_Params
operator|->
name|getParams
operator|.
name|fm_cld
operator|=
name|GET_UINT32
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|->
name|fm_cld
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Params
operator|->
name|getParams
operator|.
name|type
operator|&
name|GET_FMQM_GS
condition|)
name|p_Params
operator|->
name|getParams
operator|.
name|fmqm_gs
operator|=
name|GET_UINT32
argument_list|(
name|p_Fm
operator|->
name|p_FmQmiRegs
operator|->
name|fmqm_gs
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Params
operator|->
name|getParams
operator|.
name|type
operator|&
name|GET_FM_NPI
condition|)
name|p_Params
operator|->
name|getParams
operator|.
name|fm_npi
operator|=
name|GET_UINT32
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|->
name|fm_npi
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Params
operator|->
name|getParams
operator|.
name|type
operator|&
name|GET_FMFP_EXTC
condition|)
name|p_Params
operator|->
name|getParams
operator|.
name|fmfp_extc
operator|=
name|GET_UINT32
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|->
name|fmfp_extc
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/****************************************************/
end_comment

begin_comment
comment|/*       API Run-time Control uint functions        */
end_comment

begin_comment
comment|/****************************************************/
end_comment

begin_function
name|void
name|FM_EventIsr
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
define|#
directive|define
name|FM_M_CALL_1G_MAC_ISR
parameter_list|(
name|_id
parameter_list|)
define|\
value|{                                \         if (p_Fm->guestId != p_Fm->intrMng[(e_FmInterModuleEvent)(e_FM_EV_1G_MAC0+_id)].guestId)    \             SendIpcIsr(p_Fm, (e_FmInterModuleEvent)(e_FM_EV_1G_MAC0+_id), pending);                 \         else                                                                                        \             p_Fm->intrMng[(e_FmInterModuleEvent)(e_FM_EV_1G_MAC0+_id)].f_Isr(p_Fm->intrMng[(e_FmInterModuleEvent)(e_FM_EV_1G_MAC0+_id)].h_SrcHandle);\     }
define|#
directive|define
name|FM_M_CALL_10G_MAC_ISR
parameter_list|(
name|_id
parameter_list|)
define|\
value|{                                \         if (p_Fm->guestId != p_Fm->intrMng[(e_FmInterModuleEvent)(e_FM_EV_10G_MAC0+_id)].guestId)    \             SendIpcIsr(p_Fm, (e_FmInterModuleEvent)(e_FM_EV_10G_MAC0+_id), pending);                 \         else                                                                                         \             p_Fm->intrMng[(e_FmInterModuleEvent)(e_FM_EV_10G_MAC0+_id)].f_Isr(p_Fm->intrMng[(e_FmInterModuleEvent)(e_FM_EV_10G_MAC0+_id)].h_SrcHandle);\     }
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|uint32_t
name|pending
decl_stmt|,
name|event
decl_stmt|;
name|struct
name|fman_fpm_regs
modifier|*
name|fpm_rg
decl_stmt|;
name|SANITY_CHECK_RETURN
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN
argument_list|(
operator|!
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|fpm_rg
operator|=
name|p_Fm
operator|->
name|p_FmFpmRegs
expr_stmt|;
comment|/* normal interrupts */
name|pending
operator|=
name|fman_get_normal_pending
argument_list|(
name|fpm_rg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pending
condition|)
return|return;
if|if
condition|(
name|pending
operator|&
name|INTR_EN_WAKEUP
condition|)
comment|// this is a wake up from sleep interrupt
block|{
name|t_FmGetSetParams
name|fmGetSetParams
decl_stmt|;
name|memset
argument_list|(
operator|&
name|fmGetSetParams
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmGetSetParams
argument_list|)
argument_list|)
expr_stmt|;
name|fmGetSetParams
operator|.
name|setParams
operator|.
name|type
operator|=
name|UPDATE_FPM_BRKC_SLP
expr_stmt|;
name|fmGetSetParams
operator|.
name|setParams
operator|.
name|sleep
operator|=
literal|0
expr_stmt|;
name|FmGetSetParams
argument_list|(
name|h_Fm
argument_list|,
operator|&
name|fmGetSetParams
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pending
operator|&
name|INTR_EN_QMI
condition|)
name|QmiEvent
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|INTR_EN_PRS
condition|)
name|p_Fm
operator|->
name|intrMng
index|[
name|e_FM_EV_PRS
index|]
operator|.
name|f_Isr
argument_list|(
name|p_Fm
operator|->
name|intrMng
index|[
name|e_FM_EV_PRS
index|]
operator|.
name|h_SrcHandle
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|INTR_EN_PLCR
condition|)
name|p_Fm
operator|->
name|intrMng
index|[
name|e_FM_EV_PLCR
index|]
operator|.
name|f_Isr
argument_list|(
name|p_Fm
operator|->
name|intrMng
index|[
name|e_FM_EV_PLCR
index|]
operator|.
name|h_SrcHandle
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|INTR_EN_TMR
condition|)
name|p_Fm
operator|->
name|intrMng
index|[
name|e_FM_EV_TMR
index|]
operator|.
name|f_Isr
argument_list|(
name|p_Fm
operator|->
name|intrMng
index|[
name|e_FM_EV_TMR
index|]
operator|.
name|h_SrcHandle
argument_list|)
expr_stmt|;
comment|/* MAC events may belong to different partitions */
if|if
condition|(
name|pending
operator|&
name|INTR_EN_1G_MAC0
condition|)
name|FM_M_CALL_1G_MAC_ISR
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|INTR_EN_1G_MAC1
condition|)
name|FM_M_CALL_1G_MAC_ISR
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|INTR_EN_1G_MAC2
condition|)
name|FM_M_CALL_1G_MAC_ISR
argument_list|(
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|INTR_EN_1G_MAC3
condition|)
name|FM_M_CALL_1G_MAC_ISR
argument_list|(
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|INTR_EN_1G_MAC4
condition|)
name|FM_M_CALL_1G_MAC_ISR
argument_list|(
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|INTR_EN_1G_MAC5
condition|)
name|FM_M_CALL_1G_MAC_ISR
argument_list|(
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|INTR_EN_1G_MAC6
condition|)
name|FM_M_CALL_1G_MAC_ISR
argument_list|(
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|INTR_EN_1G_MAC7
condition|)
name|FM_M_CALL_1G_MAC_ISR
argument_list|(
literal|7
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|INTR_EN_10G_MAC0
condition|)
name|FM_M_CALL_10G_MAC_ISR
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|INTR_EN_10G_MAC1
condition|)
name|FM_M_CALL_10G_MAC_ISR
argument_list|(
literal|1
argument_list|)
expr_stmt|;
comment|/* IM port events may belong to different partitions */
if|if
condition|(
name|pending
operator|&
name|INTR_EN_REV0
condition|)
block|{
name|event
operator|=
name|fman_get_controller_event
argument_list|(
name|fpm_rg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|p_Fm
operator|->
name|intrMng
index|[
name|e_FM_EV_FMAN_CTRL_0
index|]
operator|.
name|guestId
condition|)
comment|/*TODO IPC ISR For Fman Ctrl */
name|ASSERT_COND
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* SendIpcIsr(p_Fm, e_FM_EV_FMAN_CTRL_0, pending); */
else|else
name|p_Fm
operator|->
name|fmanCtrlIntr
index|[
literal|0
index|]
operator|.
name|f_Isr
argument_list|(
name|p_Fm
operator|->
name|fmanCtrlIntr
index|[
literal|0
index|]
operator|.
name|h_SrcHandle
argument_list|,
name|event
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pending
operator|&
name|INTR_EN_REV1
condition|)
block|{
name|event
operator|=
name|fman_get_controller_event
argument_list|(
name|fpm_rg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|p_Fm
operator|->
name|intrMng
index|[
name|e_FM_EV_FMAN_CTRL_1
index|]
operator|.
name|guestId
condition|)
comment|/*TODO IPC ISR For Fman Ctrl */
name|ASSERT_COND
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* SendIpcIsr(p_Fm, e_FM_EV_FMAN_CTRL_1, pending); */
else|else
name|p_Fm
operator|->
name|fmanCtrlIntr
index|[
literal|1
index|]
operator|.
name|f_Isr
argument_list|(
name|p_Fm
operator|->
name|fmanCtrlIntr
index|[
literal|1
index|]
operator|.
name|h_SrcHandle
argument_list|,
name|event
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pending
operator|&
name|INTR_EN_REV2
condition|)
block|{
name|event
operator|=
name|fman_get_controller_event
argument_list|(
name|fpm_rg
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|p_Fm
operator|->
name|intrMng
index|[
name|e_FM_EV_FMAN_CTRL_2
index|]
operator|.
name|guestId
condition|)
comment|/*TODO IPC ISR For Fman Ctrl */
name|ASSERT_COND
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* SendIpcIsr(p_Fm, e_FM_EV_FMAN_CTRL_2, pending); */
else|else
name|p_Fm
operator|->
name|fmanCtrlIntr
index|[
literal|2
index|]
operator|.
name|f_Isr
argument_list|(
name|p_Fm
operator|->
name|fmanCtrlIntr
index|[
literal|2
index|]
operator|.
name|h_SrcHandle
argument_list|,
name|event
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pending
operator|&
name|INTR_EN_REV3
condition|)
block|{
name|event
operator|=
name|fman_get_controller_event
argument_list|(
name|fpm_rg
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|p_Fm
operator|->
name|intrMng
index|[
name|e_FM_EV_FMAN_CTRL_3
index|]
operator|.
name|guestId
condition|)
comment|/*TODO IPC ISR For Fman Ctrl */
name|ASSERT_COND
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* SendIpcIsr(p_Fm, e_FM_EV_FMAN_CTRL_2, pendin3); */
else|else
name|p_Fm
operator|->
name|fmanCtrlIntr
index|[
literal|3
index|]
operator|.
name|f_Isr
argument_list|(
name|p_Fm
operator|->
name|fmanCtrlIntr
index|[
literal|3
index|]
operator|.
name|h_SrcHandle
argument_list|,
name|event
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|FM_MACSEC_SUPPORT
if|if
condition|(
name|pending
operator|&
name|INTR_EN_MACSEC_MAC0
condition|)
block|{
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|p_Fm
operator|->
name|intrMng
index|[
name|e_FM_EV_MACSEC_MAC0
index|]
operator|.
name|guestId
condition|)
name|SendIpcIsr
argument_list|(
name|p_Fm
argument_list|,
name|e_FM_EV_MACSEC_MAC0
argument_list|,
name|pending
argument_list|)
expr_stmt|;
else|else
name|p_Fm
operator|->
name|intrMng
index|[
name|e_FM_EV_MACSEC_MAC0
index|]
operator|.
name|f_Isr
argument_list|(
name|p_Fm
operator|->
name|intrMng
index|[
name|e_FM_EV_MACSEC_MAC0
index|]
operator|.
name|h_SrcHandle
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* FM_MACSEC_SUPPORT */
block|}
end_function

begin_function
name|t_Error
name|FM_ErrorIsr
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
define|#
directive|define
name|FM_M_CALL_1G_MAC_ERR_ISR
parameter_list|(
name|_id
parameter_list|)
define|\
value|{                                   \        if (p_Fm->guestId != p_Fm->intrMng[(e_FmInterModuleEvent)(e_FM_EV_ERR_1G_MAC0+_id)].guestId) \             SendIpcIsr(p_Fm, (e_FmInterModuleEvent)(e_FM_EV_ERR_1G_MAC0+_id), pending);             \        else                                                                                         \             p_Fm->intrMng[(e_FmInterModuleEvent)(e_FM_EV_ERR_1G_MAC0+_id)].f_Isr(p_Fm->intrMng[(e_FmInterModuleEvent)(e_FM_EV_ERR_1G_MAC0+_id)].h_SrcHandle);\     }
define|#
directive|define
name|FM_M_CALL_10G_MAC_ERR_ISR
parameter_list|(
name|_id
parameter_list|)
define|\
value|{                                    \        if (p_Fm->guestId != p_Fm->intrMng[(e_FmInterModuleEvent)(e_FM_EV_ERR_10G_MAC0+_id)].guestId) \             SendIpcIsr(p_Fm, (e_FmInterModuleEvent)(e_FM_EV_ERR_10G_MAC0+_id), pending);             \        else                                                                                          \             p_Fm->intrMng[(e_FmInterModuleEvent)(e_FM_EV_ERR_10G_MAC0+_id)].f_Isr(p_Fm->intrMng[(e_FmInterModuleEvent)(e_FM_EV_ERR_10G_MAC0+_id)].h_SrcHandle);\     }
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|uint32_t
name|pending
decl_stmt|;
name|struct
name|fman_fpm_regs
modifier|*
name|fpm_rg
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|h_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|fpm_rg
operator|=
name|p_Fm
operator|->
name|p_FmFpmRegs
expr_stmt|;
comment|/* error interrupts */
name|pending
operator|=
name|fman_get_fpm_error_interrupts
argument_list|(
name|fpm_rg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pending
condition|)
return|return
name|ERROR_CODE
argument_list|(
name|E_EMPTY
argument_list|)
return|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_BMI
condition|)
name|BmiErrEvent
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_QMI
condition|)
name|QmiErrEvent
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_FPM
condition|)
name|FpmErrEvent
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_DMA
condition|)
name|DmaErrEvent
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_IRAM
condition|)
name|IramErrIntr
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_MURAM
condition|)
name|MuramErrIntr
argument_list|(
name|p_Fm
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_PRS
condition|)
name|p_Fm
operator|->
name|intrMng
index|[
name|e_FM_EV_ERR_PRS
index|]
operator|.
name|f_Isr
argument_list|(
name|p_Fm
operator|->
name|intrMng
index|[
name|e_FM_EV_ERR_PRS
index|]
operator|.
name|h_SrcHandle
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_PLCR
condition|)
name|p_Fm
operator|->
name|intrMng
index|[
name|e_FM_EV_ERR_PLCR
index|]
operator|.
name|f_Isr
argument_list|(
name|p_Fm
operator|->
name|intrMng
index|[
name|e_FM_EV_ERR_PLCR
index|]
operator|.
name|h_SrcHandle
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_KG
condition|)
name|p_Fm
operator|->
name|intrMng
index|[
name|e_FM_EV_ERR_KG
index|]
operator|.
name|f_Isr
argument_list|(
name|p_Fm
operator|->
name|intrMng
index|[
name|e_FM_EV_ERR_KG
index|]
operator|.
name|h_SrcHandle
argument_list|)
expr_stmt|;
comment|/* MAC events may belong to different partitions */
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_1G_MAC0
condition|)
name|FM_M_CALL_1G_MAC_ERR_ISR
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_1G_MAC1
condition|)
name|FM_M_CALL_1G_MAC_ERR_ISR
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_1G_MAC2
condition|)
name|FM_M_CALL_1G_MAC_ERR_ISR
argument_list|(
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_1G_MAC3
condition|)
name|FM_M_CALL_1G_MAC_ERR_ISR
argument_list|(
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_1G_MAC4
condition|)
name|FM_M_CALL_1G_MAC_ERR_ISR
argument_list|(
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_1G_MAC5
condition|)
name|FM_M_CALL_1G_MAC_ERR_ISR
argument_list|(
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_1G_MAC6
condition|)
name|FM_M_CALL_1G_MAC_ERR_ISR
argument_list|(
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_1G_MAC7
condition|)
name|FM_M_CALL_1G_MAC_ERR_ISR
argument_list|(
literal|7
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_10G_MAC0
condition|)
name|FM_M_CALL_10G_MAC_ERR_ISR
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_10G_MAC1
condition|)
name|FM_M_CALL_10G_MAC_ERR_ISR
argument_list|(
literal|1
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|FM_MACSEC_SUPPORT
if|if
condition|(
name|pending
operator|&
name|ERR_INTR_EN_MACSEC_MAC0
condition|)
block|{
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|p_Fm
operator|->
name|intrMng
index|[
name|e_FM_EV_ERR_MACSEC_MAC0
index|]
operator|.
name|guestId
condition|)
name|SendIpcIsr
argument_list|(
name|p_Fm
argument_list|,
name|e_FM_EV_ERR_MACSEC_MAC0
argument_list|,
name|pending
argument_list|)
expr_stmt|;
else|else
name|p_Fm
operator|->
name|intrMng
index|[
name|e_FM_EV_ERR_MACSEC_MAC0
index|]
operator|.
name|f_Isr
argument_list|(
name|p_Fm
operator|->
name|intrMng
index|[
name|e_FM_EV_ERR_MACSEC_MAC0
index|]
operator|.
name|h_SrcHandle
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* FM_MACSEC_SUPPORT */
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_SetPortsBandwidth
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|t_FmPortsBandwidthParams
modifier|*
name|p_PortsBandwidth
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint8_t
name|sum
decl_stmt|;
name|uint8_t
name|hardwarePortId
decl_stmt|;
name|uint8_t
name|weights
index|[
literal|64
index|]
decl_stmt|;
name|uint8_t
name|weight
decl_stmt|,
name|maxPercent
init|=
literal|0
decl_stmt|;
name|struct
name|fman_bmi_regs
modifier|*
name|bmi_rg
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|bmi_rg
operator|=
name|p_Fm
operator|->
name|p_FmBmiRegs
expr_stmt|;
name|memset
argument_list|(
name|weights
argument_list|,
literal|0
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
operator|*
literal|64
operator|)
argument_list|)
expr_stmt|;
comment|/* check that all ports add up to 100% */
name|sum
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p_PortsBandwidth
operator|->
name|numOfPorts
condition|;
name|i
operator|++
control|)
name|sum
operator|+=
name|p_PortsBandwidth
operator|->
name|portsBandwidths
index|[
name|i
index|]
operator|.
name|bandwidth
expr_stmt|;
if|if
condition|(
name|sum
operator|!=
literal|100
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Sum of ports bandwidth differ from 100%"
operator|)
argument_list|)
expr_stmt|;
comment|/* find highest percent */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p_PortsBandwidth
operator|->
name|numOfPorts
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|p_PortsBandwidth
operator|->
name|portsBandwidths
index|[
name|i
index|]
operator|.
name|bandwidth
operator|>
name|maxPercent
condition|)
name|maxPercent
operator|=
name|p_PortsBandwidth
operator|->
name|portsBandwidths
index|[
name|i
index|]
operator|.
name|bandwidth
expr_stmt|;
block|}
name|ASSERT_COND
argument_list|(
name|maxPercent
operator|>
literal|0
argument_list|)
expr_stmt|;
comment|/* guaranteed by sum = 100 */
comment|/* calculate weight for each port */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p_PortsBandwidth
operator|->
name|numOfPorts
condition|;
name|i
operator|++
control|)
block|{
name|weight
operator|=
call|(
name|uint8_t
call|)
argument_list|(
operator|(
name|p_PortsBandwidth
operator|->
name|portsBandwidths
index|[
name|i
index|]
operator|.
name|bandwidth
operator|*
name|PORT_MAX_WEIGHT
operator|)
operator|/
name|maxPercent
argument_list|)
expr_stmt|;
comment|/* we want even division between 1-to-PORT_MAX_WEIGHT. so if exact division            is not reached, we round up so that:            0 until maxPercent/PORT_MAX_WEIGHT get "1"            maxPercent/PORT_MAX_WEIGHT+1 until (maxPercent/PORT_MAX_WEIGHT)*2 get "2"            ...            maxPercent - maxPercent/PORT_MAX_WEIGHT until maxPercent get "PORT_MAX_WEIGHT: */
if|if
condition|(
call|(
name|uint8_t
call|)
argument_list|(
operator|(
name|p_PortsBandwidth
operator|->
name|portsBandwidths
index|[
name|i
index|]
operator|.
name|bandwidth
operator|*
name|PORT_MAX_WEIGHT
operator|)
operator|%
name|maxPercent
argument_list|)
condition|)
name|weight
operator|++
expr_stmt|;
comment|/* find the location of this port within the register */
name|hardwarePortId
operator|=
name|SwPortIdToHwPortId
argument_list|(
name|p_PortsBandwidth
operator|->
name|portsBandwidths
index|[
name|i
index|]
operator|.
name|type
argument_list|,
name|p_PortsBandwidth
operator|->
name|portsBandwidths
index|[
name|i
index|]
operator|.
name|relativePortId
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
argument_list|,
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|minorRev
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|IN_RANGE
argument_list|(
literal|1
argument_list|,
name|hardwarePortId
argument_list|,
literal|63
argument_list|)
argument_list|)
expr_stmt|;
name|weights
index|[
name|hardwarePortId
index|]
operator|=
name|weight
expr_stmt|;
block|}
name|fman_set_ports_bandwidth
argument_list|(
name|bmi_rg
argument_list|,
name|weights
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_EnableRamsEcc
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|struct
name|fman_fpm_regs
modifier|*
name|fpm_rg
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|fpm_rg
operator|=
name|p_Fm
operator|->
name|p_FmFpmRegs
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
block|{
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_ENABLE_RAM_ECC
expr_stmt|;
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|internalCall
condition|)
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|explicitEnable
operator|=
name|TRUE
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|internalCall
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|ramsEccEnable
condition|)
return|return
name|E_OK
return|;
else|else
block|{
name|fman_enable_rams_ecc
argument_list|(
name|fpm_rg
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|ramsEccEnable
operator|=
name|TRUE
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_DisableRamsEcc
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|bool
name|explicitDisable
init|=
name|FALSE
decl_stmt|;
name|struct
name|fman_fpm_regs
modifier|*
name|fpm_rg
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|fpm_rg
operator|=
name|p_Fm
operator|->
name|p_FmFpmRegs
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
block|{
name|t_Error
name|err
decl_stmt|;
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_DISABLE_RAM_ECC
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|internalCall
condition|)
name|explicitDisable
operator|=
name|TRUE
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|internalCall
operator|=
name|FALSE
expr_stmt|;
comment|/* if rams are already disabled, or if rams were explicitly enabled and are        currently called indirectly (not explicitly), ignore this call. */
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|ramsEccEnable
operator|||
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|explicitEnable
operator|&&
operator|!
name|explicitDisable
operator|)
condition|)
return|return
name|E_OK
return|;
else|else
block|{
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|explicitEnable
condition|)
comment|/* This is the case were both explicit are TRUE.                Turn off this flag for cases were following ramsEnable                routines are called */
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|explicitEnable
operator|=
name|FALSE
expr_stmt|;
name|fman_enable_rams_ecc
argument_list|(
name|fpm_rg
argument_list|)
expr_stmt|;
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|ramsEccEnable
operator|=
name|FALSE
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_SetException
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|e_FmExceptions
name|exception
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|uint32_t
name|bitMask
init|=
literal|0
decl_stmt|;
name|enum
name|fman_exceptions
name|fslException
decl_stmt|;
name|struct
name|fman_rg
name|fman_rg
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|fman_rg
operator|.
name|bmi_rg
operator|=
name|p_Fm
operator|->
name|p_FmBmiRegs
expr_stmt|;
name|fman_rg
operator|.
name|qmi_rg
operator|=
name|p_Fm
operator|->
name|p_FmQmiRegs
expr_stmt|;
name|fman_rg
operator|.
name|fpm_rg
operator|=
name|p_Fm
operator|->
name|p_FmFpmRegs
expr_stmt|;
name|fman_rg
operator|.
name|dma_rg
operator|=
name|p_Fm
operator|->
name|p_FmDmaRegs
expr_stmt|;
name|GET_EXCEPTION_FLAG
argument_list|(
name|bitMask
argument_list|,
name|exception
argument_list|)
expr_stmt|;
if|if
condition|(
name|bitMask
condition|)
block|{
if|if
condition|(
name|enable
condition|)
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|exceptions
operator||=
name|bitMask
expr_stmt|;
else|else
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|exceptions
operator|&=
operator|~
name|bitMask
expr_stmt|;
name|fslException
operator|=
name|FmanExceptionTrans
argument_list|(
name|exception
argument_list|)
expr_stmt|;
return|return
operator|(
name|t_Error
operator|)
name|fman_set_exception
argument_list|(
operator|&
name|fman_rg
argument_list|,
name|fslException
argument_list|,
name|enable
argument_list|)
return|;
block|}
else|else
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Undefined exception"
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_GetRevision
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|t_FmRevisionInfo
modifier|*
name|p_FmRevisionInfo
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|p_FmRevisionInfo
operator|->
name|majorRev
operator|=
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
expr_stmt|;
name|p_FmRevisionInfo
operator|->
name|minorRev
operator|=
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|minorRev
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_GetFmanCtrlCodeRevision
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|t_FmCtrlCodeRevisionInfo
modifier|*
name|p_RevisionInfo
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|t_FMIramRegs
modifier|*
name|p_Iram
decl_stmt|;
name|uint32_t
name|revInfo
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_RevisionInfo
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|&&
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
condition|)
block|{
name|t_Error
name|err
decl_stmt|;
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|t_FmIpcReply
name|reply
decl_stmt|;
name|uint32_t
name|replyLength
decl_stmt|;
name|t_FmIpcFmanCtrlCodeRevisionInfo
name|ipcRevInfo
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_GET_FMAN_CTRL_CODE_REV
expr_stmt|;
name|replyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|t_FmCtrlCodeRevisionInfo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|replyLength
operator|!=
operator|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|t_FmCtrlCodeRevisionInfo
argument_list|)
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"IPC reply length mismatch"
operator|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcRevInfo
argument_list|,
name|reply
operator|.
name|replyBody
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmCtrlCodeRevisionInfo
argument_list|)
argument_list|)
expr_stmt|;
name|p_RevisionInfo
operator|->
name|packageRev
operator|=
name|ipcRevInfo
operator|.
name|packageRev
expr_stmt|;
name|p_RevisionInfo
operator|->
name|majorRev
operator|=
name|ipcRevInfo
operator|.
name|majorRev
expr_stmt|;
name|p_RevisionInfo
operator|->
name|minorRev
operator|=
name|ipcRevInfo
operator|.
name|minorRev
expr_stmt|;
return|return
call|(
name|t_Error
call|)
argument_list|(
name|reply
operator|.
name|error
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"running in guest-mode without IPC!"
operator|)
argument_list|)
expr_stmt|;
name|p_Iram
operator|=
operator|(
name|t_FMIramRegs
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|p_Fm
operator|->
name|baseAddr
operator|+
name|FM_MM_IMEM
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Iram
operator|->
name|iadd
argument_list|,
literal|0x4
argument_list|)
expr_stmt|;
while|while
condition|(
name|GET_UINT32
argument_list|(
name|p_Iram
operator|->
name|iadd
argument_list|)
operator|!=
literal|0x4
condition|)
empty_stmt|;
name|revInfo
operator|=
name|GET_UINT32
argument_list|(
name|p_Iram
operator|->
name|idata
argument_list|)
expr_stmt|;
name|p_RevisionInfo
operator|->
name|packageRev
operator|=
call|(
name|uint16_t
call|)
argument_list|(
operator|(
name|revInfo
operator|&
literal|0xFFFF0000
operator|)
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|p_RevisionInfo
operator|->
name|majorRev
operator|=
call|(
name|uint8_t
call|)
argument_list|(
operator|(
name|revInfo
operator|&
literal|0x0000FF00
operator|)
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|p_RevisionInfo
operator|->
name|minorRev
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|revInfo
operator|&
literal|0x000000FF
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|uint32_t
name|FM_GetCounter
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|e_FmCounters
name|counter
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|uint32_t
name|counterValue
decl_stmt|;
name|struct
name|fman_rg
name|fman_rg
decl_stmt|;
name|enum
name|fman_counters
name|fsl_counter
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
operator|!
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fman_rg
operator|.
name|bmi_rg
operator|=
name|p_Fm
operator|->
name|p_FmBmiRegs
expr_stmt|;
name|fman_rg
operator|.
name|qmi_rg
operator|=
name|p_Fm
operator|->
name|p_FmQmiRegs
expr_stmt|;
name|fman_rg
operator|.
name|fpm_rg
operator|=
name|p_Fm
operator|->
name|p_FmFpmRegs
expr_stmt|;
name|fman_rg
operator|.
name|dma_rg
operator|=
name|p_Fm
operator|->
name|p_FmDmaRegs
expr_stmt|;
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|&&
operator|!
name|p_Fm
operator|->
name|baseAddr
operator|&&
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
condition|)
block|{
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|t_FmIpcReply
name|reply
decl_stmt|;
name|uint32_t
name|replyLength
decl_stmt|,
name|outCounter
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_GET_COUNTER
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|counter
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
name|replyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|counterValue
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|replyLength
operator|!=
operator|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|)
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"IPC reply length mismatch"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|outCounter
argument_list|,
name|reply
operator|.
name|replyBody
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|outCounter
return|;
block|}
elseif|else
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|baseAddr
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"Either IPC or 'baseAddress' is required!"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* When applicable (when there is an 'enable counters' bit,     check that counters are enabled */
switch|switch
condition|(
name|counter
condition|)
block|{
case|case
operator|(
name|e_FM_COUNTERS_DEQ_1
operator|)
case|:
case|case
operator|(
name|e_FM_COUNTERS_DEQ_2
operator|)
case|:
case|case
operator|(
name|e_FM_COUNTERS_DEQ_3
operator|)
case|:
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|==
literal|4
operator|)
operator|||
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|>=
literal|6
operator|)
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"Requested counter not supported"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
case|case
operator|(
name|e_FM_COUNTERS_ENQ_TOTAL_FRAME
operator|)
case|:
case|case
operator|(
name|e_FM_COUNTERS_DEQ_TOTAL_FRAME
operator|)
case|:
case|case
operator|(
name|e_FM_COUNTERS_DEQ_0
operator|)
case|:
case|case
operator|(
name|e_FM_COUNTERS_DEQ_FROM_DEFAULT
operator|)
case|:
case|case
operator|(
name|e_FM_COUNTERS_DEQ_FROM_CONTEXT
operator|)
case|:
case|case
operator|(
name|e_FM_COUNTERS_DEQ_FROM_FD
operator|)
case|:
case|case
operator|(
name|e_FM_COUNTERS_DEQ_CONFIRM
operator|)
case|:
if|if
condition|(
operator|!
operator|(
name|GET_UINT32
argument_list|(
name|p_Fm
operator|->
name|p_FmQmiRegs
operator|->
name|fmqm_gc
argument_list|)
operator|&
name|QMI_CFG_EN_COUNTERS
operator|)
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Requested counter was not enabled"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
break|break;
default|default:
break|break;
block|}
name|FMAN_COUNTERS_TRANS
argument_list|(
name|fsl_counter
argument_list|,
name|counter
argument_list|)
expr_stmt|;
return|return
name|fman_get_counter
argument_list|(
operator|&
name|fman_rg
argument_list|,
name|fsl_counter
argument_list|)
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_ModifyCounter
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|e_FmCounters
name|counter
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|struct
name|fman_rg
name|fman_rg
decl_stmt|;
name|enum
name|fman_counters
name|fsl_counter
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|fman_rg
operator|.
name|bmi_rg
operator|=
name|p_Fm
operator|->
name|p_FmBmiRegs
expr_stmt|;
name|fman_rg
operator|.
name|qmi_rg
operator|=
name|p_Fm
operator|->
name|p_FmQmiRegs
expr_stmt|;
name|fman_rg
operator|.
name|fpm_rg
operator|=
name|p_Fm
operator|->
name|p_FmFpmRegs
expr_stmt|;
name|fman_rg
operator|.
name|dma_rg
operator|=
name|p_Fm
operator|->
name|p_FmDmaRegs
expr_stmt|;
name|FMAN_COUNTERS_TRANS
argument_list|(
name|fsl_counter
argument_list|,
name|counter
argument_list|)
expr_stmt|;
return|return
operator|(
name|t_Error
operator|)
name|fman_modify_counter
argument_list|(
operator|&
name|fman_rg
argument_list|,
name|fsl_counter
argument_list|,
name|val
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|FM_SetDmaEmergency
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|e_FmDmaMuramPort
name|muramPort
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|struct
name|fman_dma_regs
modifier|*
name|dma_rg
decl_stmt|;
name|SANITY_CHECK_RETURN
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN
argument_list|(
operator|!
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|dma_rg
operator|=
name|p_Fm
operator|->
name|p_FmDmaRegs
expr_stmt|;
name|fman_set_dma_emergency
argument_list|(
name|dma_rg
argument_list|,
operator|!
operator|!
operator|(
name|muramPort
operator|==
name|e_FM_DMA_MURAM_PORT_WRITE
operator|)
argument_list|,
name|enable
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FM_SetDmaExtBusPri
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|e_FmDmaExtBusPri
name|pri
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|struct
name|fman_dma_regs
modifier|*
name|dma_rg
decl_stmt|;
name|SANITY_CHECK_RETURN
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN
argument_list|(
operator|!
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|dma_rg
operator|=
name|p_Fm
operator|->
name|p_FmDmaRegs
expr_stmt|;
name|fman_set_dma_ext_bus_pri
argument_list|(
name|dma_rg
argument_list|,
name|pri
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FM_GetDmaStatus
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|t_FmDmaStatus
modifier|*
name|p_FmDmaStatus
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|uint32_t
name|dmaStatus
decl_stmt|;
name|struct
name|fman_dma_regs
modifier|*
name|dma_rg
decl_stmt|;
name|SANITY_CHECK_RETURN
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN
argument_list|(
operator|!
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|dma_rg
operator|=
name|p_Fm
operator|->
name|p_FmDmaRegs
expr_stmt|;
if|if
condition|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|&&
operator|!
name|p_Fm
operator|->
name|baseAddr
operator|&&
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
condition|)
block|{
name|t_FmIpcDmaStatus
name|ipcDmaStatus
decl_stmt|;
name|t_FmIpcMsg
name|msg
decl_stmt|;
name|t_FmIpcReply
name|reply
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|uint32_t
name|replyLength
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_DMA_STAT
expr_stmt|;
name|replyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|t_FmIpcDmaStatus
argument_list|)
expr_stmt|;
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Fm
operator|->
name|h_IpcSessions
index|[
literal|0
index|]
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|replyLength
operator|!=
operator|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|t_FmIpcDmaStatus
argument_list|)
operator|)
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"IPC reply length mismatch"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcDmaStatus
argument_list|,
name|reply
operator|.
name|replyBody
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmIpcDmaStatus
argument_list|)
argument_list|)
expr_stmt|;
name|p_FmDmaStatus
operator|->
name|cmqNotEmpty
operator|=
operator|(
name|bool
operator|)
name|ipcDmaStatus
operator|.
name|boolCmqNotEmpty
expr_stmt|;
comment|/**< Command queue is not empty */
name|p_FmDmaStatus
operator|->
name|busError
operator|=
operator|(
name|bool
operator|)
name|ipcDmaStatus
operator|.
name|boolBusError
expr_stmt|;
comment|/**< Bus error occurred */
name|p_FmDmaStatus
operator|->
name|readBufEccError
operator|=
operator|(
name|bool
operator|)
name|ipcDmaStatus
operator|.
name|boolReadBufEccError
expr_stmt|;
comment|/**< Double ECC error on buffer Read */
name|p_FmDmaStatus
operator|->
name|writeBufEccSysError
operator|=
operator|(
name|bool
operator|)
name|ipcDmaStatus
operator|.
name|boolWriteBufEccSysError
expr_stmt|;
comment|/**< Double ECC error on buffer write from system side */
name|p_FmDmaStatus
operator|->
name|writeBufEccFmError
operator|=
operator|(
name|bool
operator|)
name|ipcDmaStatus
operator|.
name|boolWriteBufEccFmError
expr_stmt|;
comment|/**< Double ECC error on buffer write from FM side */
name|p_FmDmaStatus
operator|->
name|singlePortEccError
operator|=
operator|(
name|bool
operator|)
name|ipcDmaStatus
operator|.
name|boolSinglePortEccError
expr_stmt|;
comment|/**< Double ECC error on buffer write from FM side */
return|return;
block|}
elseif|else
if|if
condition|(
operator|!
name|p_Fm
operator|->
name|baseAddr
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"Either IPC or 'baseAddress' is required!"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|dmaStatus
operator|=
name|fman_get_dma_status
argument_list|(
name|dma_rg
argument_list|)
expr_stmt|;
name|p_FmDmaStatus
operator|->
name|cmqNotEmpty
operator|=
call|(
name|bool
call|)
argument_list|(
name|dmaStatus
operator|&
name|DMA_STATUS_CMD_QUEUE_NOT_EMPTY
argument_list|)
expr_stmt|;
name|p_FmDmaStatus
operator|->
name|busError
operator|=
call|(
name|bool
call|)
argument_list|(
name|dmaStatus
operator|&
name|DMA_STATUS_BUS_ERR
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|>=
literal|6
condition|)
name|p_FmDmaStatus
operator|->
name|singlePortEccError
operator|=
call|(
name|bool
call|)
argument_list|(
name|dmaStatus
operator|&
name|DMA_STATUS_FM_SPDAT_ECC
argument_list|)
expr_stmt|;
else|else
block|{
name|p_FmDmaStatus
operator|->
name|readBufEccError
operator|=
call|(
name|bool
call|)
argument_list|(
name|dmaStatus
operator|&
name|DMA_STATUS_READ_ECC
argument_list|)
expr_stmt|;
name|p_FmDmaStatus
operator|->
name|writeBufEccSysError
operator|=
call|(
name|bool
call|)
argument_list|(
name|dmaStatus
operator|&
name|DMA_STATUS_SYSTEM_WRITE_ECC
argument_list|)
expr_stmt|;
name|p_FmDmaStatus
operator|->
name|writeBufEccFmError
operator|=
call|(
name|bool
call|)
argument_list|(
name|dmaStatus
operator|&
name|DMA_STATUS_FM_WRITE_ECC
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|FM_Resume
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|struct
name|fman_fpm_regs
modifier|*
name|fpm_rg
decl_stmt|;
name|SANITY_CHECK_RETURN
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN
argument_list|(
operator|!
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|fpm_rg
operator|=
name|p_Fm
operator|->
name|p_FmFpmRegs
expr_stmt|;
name|fman_resume
argument_list|(
name|fpm_rg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|t_Error
name|FM_GetSpecialOperationCoding
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|fmSpecialOperations_t
name|spOper
parameter_list|,
name|uint8_t
modifier|*
name|p_SpOperCoding
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|t_FmCtrlCodeRevisionInfo
name|revInfo
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_SpOperCoding
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|spOper
condition|)
block|{
operator|*
name|p_SpOperCoding
operator|=
literal|0
expr_stmt|;
return|return
name|E_OK
return|;
block|}
if|if
condition|(
operator|(
name|err
operator|=
name|FM_GetFmanCtrlCodeRevision
argument_list|(
name|p_Fm
argument_list|,
operator|&
name|revInfo
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|DBG
argument_list|(
name|WARNING
argument_list|,
operator|(
literal|"FM in guest-mode without IPC, can't validate firmware revision."
operator|)
argument_list|)
expr_stmt|;
name|revInfo
operator|.
name|packageRev
operator|=
name|IP_OFFLOAD_PACKAGE_NUMBER
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|IS_OFFLOAD_PACKAGE
argument_list|(
name|revInfo
operator|.
name|packageRev
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"Fman ctrl code package"
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|spOper
condition|)
block|{
case|case
operator|(
name|FM_SP_OP_CAPWAP_DTLS_DEC
operator|)
case|:
operator|*
name|p_SpOperCoding
operator|=
literal|9
expr_stmt|;
break|break;
case|case
operator|(
name|FM_SP_OP_CAPWAP_DTLS_ENC
operator|)
case|:
operator|*
name|p_SpOperCoding
operator|=
literal|10
expr_stmt|;
break|break;
case|case
operator|(
name|FM_SP_OP_IPSEC
operator||
name|FM_SP_OP_IPSEC_UPDATE_UDP_LEN
operator||
name|FM_SP_OP_IPSEC_MANIP
operator|)
case|:
case|case
operator|(
name|FM_SP_OP_IPSEC
operator||
name|FM_SP_OP_IPSEC_UPDATE_UDP_LEN
operator||
name|FM_SP_OP_IPSEC_MANIP
operator||
name|FM_SP_OP_RPD
operator|)
case|:
operator|*
name|p_SpOperCoding
operator|=
literal|5
expr_stmt|;
break|break;
case|case
operator|(
name|FM_SP_OP_IPSEC
operator||
name|FM_SP_OP_IPSEC_MANIP
operator|)
case|:
case|case
operator|(
name|FM_SP_OP_IPSEC
operator||
name|FM_SP_OP_IPSEC_MANIP
operator||
name|FM_SP_OP_RPD
operator|)
case|:
operator|*
name|p_SpOperCoding
operator|=
literal|6
expr_stmt|;
break|break;
case|case
operator|(
name|FM_SP_OP_IPSEC
operator||
name|FM_SP_OP_IPSEC_UPDATE_UDP_LEN
operator||
name|FM_SP_OP_RPD
operator|)
case|:
operator|*
name|p_SpOperCoding
operator|=
literal|3
expr_stmt|;
break|break;
case|case
operator|(
name|FM_SP_OP_IPSEC
operator||
name|FM_SP_OP_IPSEC_UPDATE_UDP_LEN
operator|)
case|:
operator|*
name|p_SpOperCoding
operator|=
literal|1
expr_stmt|;
break|break;
case|case
operator|(
name|FM_SP_OP_IPSEC
operator||
name|FM_SP_OP_IPSEC_UPDATE_UDP_LEN
operator||
name|FM_SP_OP_IPSEC_NO_ETH_HDR
operator|)
case|:
operator|*
name|p_SpOperCoding
operator|=
literal|12
expr_stmt|;
break|break;
case|case
operator|(
name|FM_SP_OP_IPSEC
operator||
name|FM_SP_OP_RPD
operator|)
case|:
operator|*
name|p_SpOperCoding
operator|=
literal|4
expr_stmt|;
break|break;
case|case
operator|(
name|FM_SP_OP_IPSEC
operator|)
case|:
operator|*
name|p_SpOperCoding
operator|=
literal|2
expr_stmt|;
break|break;
case|case
operator|(
name|FM_SP_OP_DCL4C
operator|)
case|:
operator|*
name|p_SpOperCoding
operator|=
literal|7
expr_stmt|;
break|break;
case|case
operator|(
name|FM_SP_OP_CLEAR_RPD
operator|)
case|:
operator|*
name|p_SpOperCoding
operator|=
literal|8
expr_stmt|;
break|break;
default|default:
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_CtrlMonStart
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|t_FmTrbRegs
modifier|*
name|p_MonRegs
decl_stmt|;
name|uint8_t
name|i
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|->
name|fmfp_brkc
argument_list|,
name|GET_UINT32
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|->
name|fmfp_brkc
argument_list|)
operator||
name|FPM_BRKC_RDBG
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|FM_NUM_OF_CTRL
condition|;
name|i
operator|++
control|)
block|{
name|p_MonRegs
operator|=
operator|(
name|t_FmTrbRegs
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|p_Fm
operator|->
name|baseAddr
operator|+
name|FM_MM_TRB
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Reset control registers */
name|WRITE_UINT32
argument_list|(
name|p_MonRegs
operator|->
name|tcrh
argument_list|,
name|TRB_TCRH_RESET
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_MonRegs
operator|->
name|tcrl
argument_list|,
name|TRB_TCRL_RESET
argument_list|)
expr_stmt|;
comment|/* Configure: counter #1 counts all stalls in risc - ldsched stall                       counter #2 counts all stalls in risc - other stall*/
name|WRITE_UINT32
argument_list|(
name|p_MonRegs
operator|->
name|tcrl
argument_list|,
name|TRB_TCRL_RESET
operator||
name|TRB_TCRL_UTIL
argument_list|)
expr_stmt|;
comment|/* Enable monitoring */
name|WRITE_UINT32
argument_list|(
name|p_MonRegs
operator|->
name|tcrh
argument_list|,
name|TRB_TCRH_ENABLE_COUNTERS
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_CtrlMonStop
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|t_FmTrbRegs
modifier|*
name|p_MonRegs
decl_stmt|;
name|uint8_t
name|i
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|FM_NUM_OF_CTRL
condition|;
name|i
operator|++
control|)
block|{
name|p_MonRegs
operator|=
operator|(
name|t_FmTrbRegs
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|p_Fm
operator|->
name|baseAddr
operator|+
name|FM_MM_TRB
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_MonRegs
operator|->
name|tcrh
argument_list|,
name|TRB_TCRH_DISABLE_COUNTERS
argument_list|)
expr_stmt|;
block|}
name|WRITE_UINT32
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|->
name|fmfp_brkc
argument_list|,
name|GET_UINT32
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|->
name|fmfp_brkc
argument_list|)
operator|&
operator|~
name|FPM_BRKC_RDBG
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_CtrlMonGetCounters
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|uint8_t
name|fmCtrlIndex
parameter_list|,
name|t_FmCtrlMon
modifier|*
name|p_Mon
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|t_FmTrbRegs
modifier|*
name|p_MonRegs
decl_stmt|;
name|uint64_t
name|clkCnt
decl_stmt|,
name|utilValue
decl_stmt|,
name|effValue
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
argument_list|,
name|E_NOT_SUPPORTED
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Mon
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
if|if
condition|(
name|fmCtrlIndex
operator|>=
name|FM_NUM_OF_CTRL
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"FM Controller index"
operator|)
argument_list|)
expr_stmt|;
name|p_MonRegs
operator|=
operator|(
name|t_FmTrbRegs
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|p_Fm
operator|->
name|baseAddr
operator|+
name|FM_MM_TRB
argument_list|(
name|fmCtrlIndex
argument_list|)
argument_list|)
expr_stmt|;
name|clkCnt
operator|=
call|(
name|uint64_t
call|)
argument_list|(
operator|(
name|uint64_t
operator|)
name|GET_UINT32
argument_list|(
name|p_MonRegs
operator|->
name|tpcch
argument_list|)
operator|<<
literal|32
operator||
name|GET_UINT32
argument_list|(
name|p_MonRegs
operator|->
name|tpccl
argument_list|)
argument_list|)
expr_stmt|;
name|utilValue
operator|=
call|(
name|uint64_t
call|)
argument_list|(
operator|(
name|uint64_t
operator|)
name|GET_UINT32
argument_list|(
name|p_MonRegs
operator|->
name|tpc1h
argument_list|)
operator|<<
literal|32
operator||
name|GET_UINT32
argument_list|(
name|p_MonRegs
operator|->
name|tpc1l
argument_list|)
argument_list|)
expr_stmt|;
name|effValue
operator|=
call|(
name|uint64_t
call|)
argument_list|(
operator|(
name|uint64_t
operator|)
name|GET_UINT32
argument_list|(
name|p_MonRegs
operator|->
name|tpc2h
argument_list|)
operator|<<
literal|32
operator||
name|GET_UINT32
argument_list|(
name|p_MonRegs
operator|->
name|tpc2l
argument_list|)
argument_list|)
expr_stmt|;
name|p_Mon
operator|->
name|percentCnt
index|[
literal|0
index|]
operator|=
call|(
name|uint8_t
call|)
argument_list|(
operator|(
operator|(
name|clkCnt
operator|-
name|utilValue
operator|)
operator|*
literal|100
operator|)
operator|/
name|clkCnt
argument_list|)
expr_stmt|;
if|if
condition|(
name|clkCnt
operator|!=
name|utilValue
condition|)
name|p_Mon
operator|->
name|percentCnt
index|[
literal|1
index|]
operator|=
call|(
name|uint8_t
call|)
argument_list|(
operator|(
operator|(
operator|(
name|clkCnt
operator|-
name|utilValue
operator|)
operator|-
name|effValue
operator|)
operator|*
literal|100
operator|)
operator|/
operator|(
name|clkCnt
operator|-
name|utilValue
operator|)
argument_list|)
expr_stmt|;
else|else
name|p_Mon
operator|->
name|percentCnt
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Handle
name|FM_GetMuramHandle
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|(
name|p_Fm
operator|->
name|h_FmMuram
operator|)
return|;
block|}
end_function

begin_comment
comment|/****************************************************/
end_comment

begin_comment
comment|/*       Hidden-DEBUG Only API                      */
end_comment

begin_comment
comment|/****************************************************/
end_comment

begin_function
name|t_Error
name|FM_ForceIntr
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|e_FmExceptions
name|exception
parameter_list|)
block|{
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|enum
name|fman_exceptions
name|fslException
decl_stmt|;
name|struct
name|fman_rg
name|fman_rg
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Fm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Fm
operator|->
name|p_FmDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|fman_rg
operator|.
name|bmi_rg
operator|=
name|p_Fm
operator|->
name|p_FmBmiRegs
expr_stmt|;
name|fman_rg
operator|.
name|qmi_rg
operator|=
name|p_Fm
operator|->
name|p_FmQmiRegs
expr_stmt|;
name|fman_rg
operator|.
name|fpm_rg
operator|=
name|p_Fm
operator|->
name|p_FmFpmRegs
expr_stmt|;
name|fman_rg
operator|.
name|dma_rg
operator|=
name|p_Fm
operator|->
name|p_FmDmaRegs
expr_stmt|;
switch|switch
condition|(
name|exception
condition|)
block|{
case|case
name|e_FM_EX_QMI_DEQ_FROM_UNKNOWN_PORTID
case|:
if|if
condition|(
operator|!
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|exceptions
operator|&
name|FM_EX_QMI_DEQ_FROM_UNKNOWN_PORTID
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"The selected exception is masked"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|e_FM_EX_QMI_SINGLE_ECC
case|:
if|if
condition|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|revInfo
operator|.
name|majorRev
operator|>=
literal|6
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"e_FM_EX_QMI_SINGLE_ECC not supported on this integration."
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|exceptions
operator|&
name|FM_EX_QMI_SINGLE_ECC
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"The selected exception is masked"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|e_FM_EX_QMI_DOUBLE_ECC
case|:
if|if
condition|(
operator|!
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|exceptions
operator|&
name|FM_EX_QMI_DOUBLE_ECC
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"The selected exception is masked"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|e_FM_EX_BMI_LIST_RAM_ECC
case|:
if|if
condition|(
operator|!
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|exceptions
operator|&
name|FM_EX_BMI_LIST_RAM_ECC
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"The selected exception is masked"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|e_FM_EX_BMI_STORAGE_PROFILE_ECC
case|:
if|if
condition|(
operator|!
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|exceptions
operator|&
name|FM_EX_BMI_STORAGE_PROFILE_ECC
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"The selected exception is masked"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|e_FM_EX_BMI_STATISTICS_RAM_ECC
case|:
if|if
condition|(
operator|!
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|exceptions
operator|&
name|FM_EX_BMI_STATISTICS_RAM_ECC
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"The selected exception is masked"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|e_FM_EX_BMI_DISPATCH_RAM_ECC
case|:
if|if
condition|(
operator|!
operator|(
name|p_Fm
operator|->
name|p_FmStateStruct
operator|->
name|exceptions
operator|&
name|FM_EX_BMI_DISPATCH_RAM_ECC
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"The selected exception is masked"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"The selected exception may not be forced"
operator|)
argument_list|)
expr_stmt|;
block|}
name|fslException
operator|=
name|FmanExceptionTrans
argument_list|(
name|exception
argument_list|)
expr_stmt|;
name|fman_force_intr
argument_list|(
operator|&
name|fman_rg
argument_list|,
name|fslException
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Handle
name|FmGetPcd
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|)
block|{
return|return
operator|(
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
operator|)
operator|->
name|h_Pcd
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|(
name|DPAA_VERSION
operator|>=
literal|11
operator|)
end_if

begin_decl_stmt
specifier|extern
name|void
modifier|*
name|g_MemacRegs
decl_stmt|;
end_decl_stmt

begin_function_decl
name|void
name|fm_clk_down
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|uint32_t
name|fman_memac_get_event
parameter_list|(
name|void
modifier|*
name|regs
parameter_list|,
name|uint32_t
name|ev_mask
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|FM_ChangeClock
parameter_list|(
name|t_Handle
name|h_Fm
parameter_list|,
name|int
name|hardwarePortId
parameter_list|)
block|{
name|int
name|macId
decl_stmt|;
name|uint32_t
name|event
decl_stmt|,
name|rcr
decl_stmt|;
name|t_Fm
modifier|*
name|p_Fm
init|=
operator|(
name|t_Fm
operator|*
operator|)
name|h_Fm
decl_stmt|;
name|rcr
operator|=
name|GET_UINT32
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|->
name|fm_rcr
argument_list|)
expr_stmt|;
name|rcr
operator||=
literal|0x04000000
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|->
name|fm_rcr
argument_list|,
name|rcr
argument_list|)
expr_stmt|;
name|HW_PORT_ID_TO_SW_PORT_ID
argument_list|(
name|macId
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
do|do
block|{
name|event
operator|=
name|fman_memac_get_event
argument_list|(
name|g_MemacRegs
argument_list|,
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|(
name|event
operator|&
literal|0x00000020
operator|)
operator|==
literal|0
condition|)
do|;
name|fm_clk_down
argument_list|()
expr_stmt|;
name|rcr
operator|=
name|GET_UINT32
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|->
name|fm_rcr
argument_list|)
expr_stmt|;
name|rcr
operator|&=
operator|~
literal|0x04000000
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Fm
operator|->
name|p_FmFpmRegs
operator|->
name|fm_rcr
argument_list|,
name|rcr
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


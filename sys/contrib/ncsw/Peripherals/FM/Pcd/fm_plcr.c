begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (c) 2008-2011 Freescale Semiconductor, Inc.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are met:  *     * Redistributions of source code must retain the above copyright  *       notice, this list of conditions and the following disclaimer.  *     * Redistributions in binary form must reproduce the above copyright  *       notice, this list of conditions and the following disclaimer in the  *       documentation and/or other materials provided with the distribution.  *     * Neither the name of Freescale Semiconductor nor the  *       names of its contributors may be used to endorse or promote products  *       derived from this software without specific prior written permission.  *  *  * ALTERNATIVELY, this software may be distributed under the terms of the  * GNU General Public License ("GPL") as published by the Free Software  * Foundation, either version 2 of that License or (at your option) any  * later version.  *  * THIS SOFTWARE IS PROVIDED BY Freescale Semiconductor ``AS IS'' AND ANY  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED. IN NO EVENT SHALL Freescale Semiconductor BE LIABLE FOR ANY  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/******************************************************************************  @File          fm_plcr.c   @Description   FM PCD POLICER... */
end_comment

begin_comment
comment|/***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|"std_ext.h"
end_include

begin_include
include|#
directive|include
file|"error_ext.h"
end_include

begin_include
include|#
directive|include
file|"string_ext.h"
end_include

begin_include
include|#
directive|include
file|"debug_ext.h"
end_include

begin_include
include|#
directive|include
file|"net_ext.h"
end_include

begin_include
include|#
directive|include
file|"fm_ext.h"
end_include

begin_include
include|#
directive|include
file|"fm_common.h"
end_include

begin_include
include|#
directive|include
file|"fm_pcd.h"
end_include

begin_include
include|#
directive|include
file|"fm_hc.h"
end_include

begin_include
include|#
directive|include
file|"fm_pcd_ipc.h"
end_include

begin_function
specifier|static
name|bool
name|FmPcdPlcrIsProfileShared
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|uint16_t
name|absoluteProfileId
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|uint16_t
name|i
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_FmPcd
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|numOfSharedProfiles
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|sharedProfilesIds
index|[
name|i
index|]
operator|==
name|absoluteProfileId
condition|)
return|return
name|TRUE
return|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|SetProfileNia
parameter_list|(
name|t_FmPcd
modifier|*
name|p_FmPcd
parameter_list|,
name|e_FmPcdEngine
name|nextEngine
parameter_list|,
name|u_FmPcdPlcrNextEngineParams
modifier|*
name|p_NextEngineParams
parameter_list|,
name|uint32_t
modifier|*
name|nextAction
parameter_list|)
block|{
name|uint32_t
name|nia
decl_stmt|;
name|uint16_t
name|absoluteProfileId
init|=
call|(
name|uint16_t
call|)
argument_list|(
name|PTR_TO_UINT
argument_list|(
name|p_NextEngineParams
operator|->
name|h_Profile
argument_list|)
operator|-
literal|1
argument_list|)
decl_stmt|;
name|uint8_t
name|relativeSchemeId
decl_stmt|,
name|physicatSchemeId
decl_stmt|;
name|nia
operator|=
name|FM_PCD_PLCR_NIA_VALID
expr_stmt|;
switch|switch
condition|(
name|nextEngine
condition|)
block|{
case|case
name|e_FM_PCD_DONE
case|:
switch|switch
condition|(
name|p_NextEngineParams
operator|->
name|action
condition|)
block|{
case|case
name|e_FM_PCD_DROP_FRAME
case|:
name|nia
operator||=
operator|(
name|NIA_ENG_BMI
operator||
name|NIA_BMI_AC_DISCARD
operator|)
expr_stmt|;
break|break;
case|case
name|e_FM_PCD_ENQ_FRAME
case|:
name|nia
operator||=
operator|(
name|NIA_ENG_BMI
operator||
name|NIA_BMI_AC_ENQ_FRAME
operator|)
expr_stmt|;
break|break;
default|default:
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|e_FM_PCD_KG
case|:
name|physicatSchemeId
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|PTR_TO_UINT
argument_list|(
name|p_NextEngineParams
operator|->
name|h_DirectScheme
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|relativeSchemeId
operator|=
name|FmPcdKgGetRelativeSchemeId
argument_list|(
name|p_FmPcd
argument_list|,
name|physicatSchemeId
argument_list|)
expr_stmt|;
if|if
condition|(
name|relativeSchemeId
operator|==
name|FM_PCD_KG_NUM_OF_SCHEMES
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_IN_RANGE
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|FmPcdKgIsSchemeValidSw
argument_list|(
name|p_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Invalid direct scheme."
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|KgIsSchemeAlwaysDirect
argument_list|(
name|p_FmPcd
argument_list|,
name|relativeSchemeId
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Policer Profile may point only to a scheme that is always direct."
operator|)
argument_list|)
expr_stmt|;
name|nia
operator||=
name|NIA_ENG_KG
operator||
name|NIA_KG_DIRECT
operator||
name|physicatSchemeId
expr_stmt|;
break|break;
case|case
name|e_FM_PCD_PLCR
case|:
if|if
condition|(
operator|!
name|FmPcdPlcrIsProfileShared
argument_list|(
name|p_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Next profile must be a shared profile"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|FmPcdPlcrIsProfileValid
argument_list|(
name|p_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Invalid profile "
operator|)
argument_list|)
expr_stmt|;
name|nia
operator||=
name|NIA_ENG_PLCR
operator||
name|NIA_PLCR_ABSOLUTE
operator||
name|absoluteProfileId
expr_stmt|;
break|break;
default|default:
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
operator|*
name|nextAction
operator|=
name|nia
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|FPP_Function
parameter_list|(
name|uint32_t
name|fpp
parameter_list|)
block|{
if|if
condition|(
name|fpp
operator|>
literal|15
condition|)
return|return
literal|15
operator|-
operator|(
literal|0x1f
operator|-
name|fpp
operator|)
return|;
else|else
return|return
literal|16
operator|+
name|fpp
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|GetInfoRateReg
parameter_list|(
name|e_FmPcdPlcrRateMode
name|rateMode
parameter_list|,
name|uint32_t
name|rate
parameter_list|,
name|uint64_t
name|tsuInTenthNano
parameter_list|,
name|uint32_t
name|fppShift
parameter_list|,
name|uint64_t
modifier|*
name|p_Integer
parameter_list|,
name|uint64_t
modifier|*
name|p_Fraction
parameter_list|)
block|{
name|uint64_t
name|tmp
decl_stmt|,
name|div
decl_stmt|;
if|if
condition|(
name|rateMode
operator|==
name|e_FM_PCD_PLCR_BYTE_MODE
condition|)
block|{
comment|/* now we calculate the initial integer for the bigger rate */
comment|/* from Kbps to Bytes/TSU */
name|tmp
operator|=
operator|(
name|uint64_t
operator|)
name|rate
expr_stmt|;
name|tmp
operator|*=
literal|1000
expr_stmt|;
comment|/* kb --> b */
name|tmp
operator|*=
name|tsuInTenthNano
expr_stmt|;
comment|/* bps --> bpTsu(in 10nano) */
name|div
operator|=
literal|1000000000
expr_stmt|;
comment|/* nano */
name|div
operator|*=
literal|10
expr_stmt|;
comment|/* 10 nano */
name|div
operator|*=
literal|8
expr_stmt|;
comment|/* bit to byte */
block|}
else|else
block|{
comment|/* now we calculate the initial integer for the bigger rate */
comment|/* from Kbps to Bytes/TSU */
name|tmp
operator|=
operator|(
name|uint64_t
operator|)
name|rate
expr_stmt|;
name|tmp
operator|*=
name|tsuInTenthNano
expr_stmt|;
comment|/* bps --> bpTsu(in 10nano) */
name|div
operator|=
literal|1000000000
expr_stmt|;
comment|/* nano */
name|div
operator|*=
literal|10
expr_stmt|;
comment|/* 10 nano */
block|}
operator|*
name|p_Integer
operator|=
operator|(
name|tmp
operator|<<
name|fppShift
operator|)
operator|/
name|div
expr_stmt|;
comment|/* for calculating the fraction, we will recalculate cir and deduct the integer.      * For precision, we will multiply by 2^16. we do not divid back, since we write      * this value as fraction - see spec.      */
operator|*
name|p_Fraction
operator|=
operator|(
operator|(
operator|(
name|tmp
operator|<<
name|fppShift
operator|)
operator|<<
literal|16
operator|)
operator|-
operator|(
operator|(
operator|*
name|p_Integer
operator|<<
literal|16
operator|)
operator|*
name|div
operator|)
operator|)
operator|/
name|div
expr_stmt|;
block|}
end_function

begin_comment
comment|/* .......... */
end_comment

begin_function
specifier|static
name|void
name|calcRates
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|t_FmPcdPlcrNonPassthroughAlgParams
modifier|*
name|p_NonPassthroughAlgParam
parameter_list|,
name|uint32_t
modifier|*
name|cir
parameter_list|,
name|uint32_t
modifier|*
name|cbs
parameter_list|,
name|uint32_t
modifier|*
name|pir_eir
parameter_list|,
name|uint32_t
modifier|*
name|pbs_ebs
parameter_list|,
name|uint32_t
modifier|*
name|fpp
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|uint64_t
name|integer
decl_stmt|,
name|fraction
decl_stmt|;
name|uint32_t
name|temp
decl_stmt|,
name|tsuInTenthNanos
decl_stmt|,
name|bitFor1Micro
decl_stmt|;
name|uint8_t
name|fppShift
init|=
literal|0
decl_stmt|;
name|bitFor1Micro
operator|=
name|FmGetTimeStampScale
argument_list|(
name|p_FmPcd
operator|->
name|h_Fm
argument_list|)
expr_stmt|;
comment|/* TimeStamp per nano seconds units */
comment|/* we want the tsu to count 10 nano for better precision normally tsu is 3.9 nano, now we will get 39 */
name|tsuInTenthNanos
operator|=
call|(
name|uint32_t
call|)
argument_list|(
literal|1000
operator|*
literal|10
operator|/
operator|(
literal|1
operator|<<
name|bitFor1Micro
operator|)
argument_list|)
expr_stmt|;
comment|/* we choose the faster rate to calibrate fpp */
if|if
condition|(
name|p_NonPassthroughAlgParam
operator|->
name|comittedInfoRate
operator|>
name|p_NonPassthroughAlgParam
operator|->
name|peakOrAccessiveInfoRate
condition|)
name|GetInfoRateReg
argument_list|(
name|p_NonPassthroughAlgParam
operator|->
name|rateMode
argument_list|,
name|p_NonPassthroughAlgParam
operator|->
name|comittedInfoRate
argument_list|,
name|tsuInTenthNanos
argument_list|,
literal|0
argument_list|,
operator|&
name|integer
argument_list|,
operator|&
name|fraction
argument_list|)
expr_stmt|;
else|else
name|GetInfoRateReg
argument_list|(
name|p_NonPassthroughAlgParam
operator|->
name|rateMode
argument_list|,
name|p_NonPassthroughAlgParam
operator|->
name|peakOrAccessiveInfoRate
argument_list|,
name|tsuInTenthNanos
argument_list|,
literal|0
argument_list|,
operator|&
name|integer
argument_list|,
operator|&
name|fraction
argument_list|)
expr_stmt|;
comment|/* we shift integer, as in cir/pir it is represented by the MSB 16 bits, and      * the LSB bits are for the fraction */
name|temp
operator|=
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|integer
operator|<<
literal|16
operator|)
operator|&
literal|0x00000000FFFFFFFF
argument_list|)
expr_stmt|;
comment|/* temp is effected by the rate. For low rates it may be as low as 0, and then we'll      * take max fpp=31.      * For high rates it will never exceed the 32 bit reg (after the 16 shift), as it is      * limited by the 10G physical port.      */
if|if
condition|(
name|temp
operator|!=
literal|0
condition|)
block|{
comment|/* count zeroes left of the higher used bit (in order to shift the value such that          * unused bits may be used for fraction).          */
while|while
condition|(
operator|(
name|temp
operator|&
literal|0x80000000
operator|)
operator|==
literal|0
condition|)
block|{
name|temp
operator|=
name|temp
operator|<<
literal|1
expr_stmt|;
name|fppShift
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|fppShift
operator|>
literal|15
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
operator|(
literal|"timeStampPeriod to Information rate ratio is too small"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
name|temp
operator|=
operator|(
name|uint32_t
operator|)
name|fraction
expr_stmt|;
comment|/* fraction will alyas be smaller than 2^16 */
if|if
condition|(
operator|!
name|temp
condition|)
comment|/* integer and fraction are 0, we set fpp to its max val */
name|fppShift
operator|=
literal|31
expr_stmt|;
else|else
block|{
comment|/* integer was 0 but fraction is not. fpp is 16 for the integer,              * + all left zeroes of the fraction. */
name|fppShift
operator|=
literal|16
expr_stmt|;
comment|/* count zeroes left of the higher used bit (in order to shift the value such that              * unused bits may be used for fraction).              */
while|while
condition|(
operator|(
name|temp
operator|&
literal|0x8000
operator|)
operator|==
literal|0
condition|)
block|{
name|temp
operator|=
name|temp
operator|<<
literal|1
expr_stmt|;
name|fppShift
operator|++
expr_stmt|;
block|}
block|}
block|}
comment|/*      * This means that the FM TS register will now be used so that 'count' bits are for      * fraction and the rest for integer */
comment|/* now we re-calculate cir */
name|GetInfoRateReg
argument_list|(
name|p_NonPassthroughAlgParam
operator|->
name|rateMode
argument_list|,
name|p_NonPassthroughAlgParam
operator|->
name|comittedInfoRate
argument_list|,
name|tsuInTenthNanos
argument_list|,
name|fppShift
argument_list|,
operator|&
name|integer
argument_list|,
operator|&
name|fraction
argument_list|)
expr_stmt|;
operator|*
name|cir
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|integer
operator|<<
literal|16
operator||
operator|(
name|fraction
operator|&
literal|0xFFFF
operator|)
argument_list|)
expr_stmt|;
name|GetInfoRateReg
argument_list|(
name|p_NonPassthroughAlgParam
operator|->
name|rateMode
argument_list|,
name|p_NonPassthroughAlgParam
operator|->
name|peakOrAccessiveInfoRate
argument_list|,
name|tsuInTenthNanos
argument_list|,
name|fppShift
argument_list|,
operator|&
name|integer
argument_list|,
operator|&
name|fraction
argument_list|)
expr_stmt|;
operator|*
name|pir_eir
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|integer
operator|<<
literal|16
operator||
operator|(
name|fraction
operator|&
literal|0xFFFF
operator|)
argument_list|)
expr_stmt|;
operator|*
name|cbs
operator|=
name|p_NonPassthroughAlgParam
operator|->
name|comittedBurstSize
expr_stmt|;
operator|*
name|pbs_ebs
operator|=
name|p_NonPassthroughAlgParam
operator|->
name|peakOrAccessiveBurstSize
expr_stmt|;
comment|/* get fpp as it should be written to reg.*/
operator|*
name|fpp
operator|=
name|FPP_Function
argument_list|(
name|fppShift
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|WritePar
parameter_list|(
name|t_FmPcd
modifier|*
name|p_FmPcd
parameter_list|,
name|uint32_t
name|par
parameter_list|)
block|{
name|t_FmPcdPlcrRegs
modifier|*
name|p_FmPcdPlcrRegs
init|=
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|FmIsMaster
argument_list|(
name|p_FmPcd
operator|->
name|h_Fm
argument_list|)
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|fmpl_par
argument_list|,
name|par
argument_list|)
expr_stmt|;
while|while
condition|(
name|GET_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|fmpl_par
argument_list|)
operator|&
name|FM_PCD_PLCR_PAR_GO
condition|)
empty_stmt|;
block|}
end_function

begin_comment
comment|/*********************************************/
end_comment

begin_comment
comment|/*............Policer Exception..............*/
end_comment

begin_comment
comment|/*********************************************/
end_comment

begin_function
specifier|static
name|void
name|PcdPlcrException
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|uint32_t
name|event
decl_stmt|,
name|mask
decl_stmt|,
name|force
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|FmIsMaster
argument_list|(
name|p_FmPcd
operator|->
name|h_Fm
argument_list|)
argument_list|)
expr_stmt|;
name|event
operator|=
name|GET_UINT32
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
operator|->
name|fmpl_evr
argument_list|)
expr_stmt|;
name|mask
operator|=
name|GET_UINT32
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
operator|->
name|fmpl_ier
argument_list|)
expr_stmt|;
name|event
operator|&=
name|mask
expr_stmt|;
comment|/* clear the forced events */
name|force
operator|=
name|GET_UINT32
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
operator|->
name|fmpl_ifr
argument_list|)
expr_stmt|;
if|if
condition|(
name|force
operator|&
name|event
condition|)
name|WRITE_UINT32
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
operator|->
name|fmpl_ifr
argument_list|,
name|force
operator|&
operator|~
name|event
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
operator|->
name|fmpl_evr
argument_list|,
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|FM_PCD_PLCR_PRAM_SELF_INIT_COMPLETE
condition|)
name|p_FmPcd
operator|->
name|f_Exception
argument_list|(
name|p_FmPcd
operator|->
name|h_App
argument_list|,
name|e_FM_PCD_PLCR_EXCEPTION_PRAM_SELF_INIT_COMPLETE
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|FM_PCD_PLCR_ATOMIC_ACTION_COMPLETE
condition|)
name|p_FmPcd
operator|->
name|f_Exception
argument_list|(
name|p_FmPcd
operator|->
name|h_App
argument_list|,
name|e_FM_PCD_PLCR_EXCEPTION_ATOMIC_ACTION_COMPLETE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* ..... */
end_comment

begin_function
specifier|static
name|void
name|PcdPlcrErrorException
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|uint32_t
name|event
decl_stmt|,
name|force
decl_stmt|,
name|captureReg
decl_stmt|,
name|mask
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|FmIsMaster
argument_list|(
name|p_FmPcd
operator|->
name|h_Fm
argument_list|)
argument_list|)
expr_stmt|;
name|event
operator|=
name|GET_UINT32
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
operator|->
name|fmpl_eevr
argument_list|)
expr_stmt|;
name|mask
operator|=
name|GET_UINT32
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
operator|->
name|fmpl_eier
argument_list|)
expr_stmt|;
name|event
operator|&=
name|mask
expr_stmt|;
comment|/* clear the forced events */
name|force
operator|=
name|GET_UINT32
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
operator|->
name|fmpl_eifr
argument_list|)
expr_stmt|;
if|if
condition|(
name|force
operator|&
name|event
condition|)
name|WRITE_UINT32
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
operator|->
name|fmpl_eifr
argument_list|,
name|force
operator|&
operator|~
name|event
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
operator|->
name|fmpl_eevr
argument_list|,
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|FM_PCD_PLCR_DOUBLE_ECC
condition|)
name|p_FmPcd
operator|->
name|f_Exception
argument_list|(
name|p_FmPcd
operator|->
name|h_App
argument_list|,
name|e_FM_PCD_PLCR_EXCEPTION_DOUBLE_ECC
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|FM_PCD_PLCR_INIT_ENTRY_ERROR
condition|)
block|{
name|captureReg
operator|=
name|GET_UINT32
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
operator|->
name|fmpl_upcr
argument_list|)
expr_stmt|;
comment|/*ASSERT_COND(captureReg& PLCR_ERR_UNINIT_CAP);         p_UnInitCapt->profileNum = (uint8_t)(captureReg& PLCR_ERR_UNINIT_NUM_MASK);         p_UnInitCapt->portId = (uint8_t)((captureReg& PLCR_ERR_UNINIT_PID_MASK)>>PLCR_ERR_UNINIT_PID_SHIFT) ;         p_UnInitCapt->absolute = (bool)(captureReg& PLCR_ERR_UNINIT_ABSOLUTE_MASK);*/
name|p_FmPcd
operator|->
name|f_FmPcdIndexedException
argument_list|(
name|p_FmPcd
operator|->
name|h_App
argument_list|,
name|e_FM_PCD_PLCR_EXCEPTION_INIT_ENTRY_ERROR
argument_list|,
call|(
name|uint16_t
call|)
argument_list|(
name|captureReg
operator|&
name|PLCR_ERR_UNINIT_NUM_MASK
argument_list|)
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
operator|->
name|fmpl_upcr
argument_list|,
name|PLCR_ERR_UNINIT_CAP
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|FmPcdPlcrUpatePointedOwner
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|uint16_t
name|absoluteProfileId
parameter_list|,
name|bool
name|add
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|absoluteProfileId
index|]
operator|.
name|valid
argument_list|)
expr_stmt|;
if|if
condition|(
name|add
condition|)
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|absoluteProfileId
index|]
operator|.
name|pointedOwners
operator|++
expr_stmt|;
else|else
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|absoluteProfileId
index|]
operator|.
name|pointedOwners
operator|--
expr_stmt|;
block|}
end_function

begin_function
name|uint32_t
name|FmPcdPlcrGetPointedOwners
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|uint16_t
name|absoluteProfileId
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|absoluteProfileId
index|]
operator|.
name|valid
argument_list|)
expr_stmt|;
return|return
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|absoluteProfileId
index|]
operator|.
name|pointedOwners
return|;
block|}
end_function

begin_function
name|uint32_t
name|FmPcdPlcrGetRequiredAction
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|uint16_t
name|absoluteProfileId
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|absoluteProfileId
index|]
operator|.
name|valid
argument_list|)
expr_stmt|;
return|return
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|absoluteProfileId
index|]
operator|.
name|requiredAction
return|;
block|}
end_function

begin_function
name|t_Error
name|FmPcdPlcrAllocProfiles
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|uint8_t
name|hardwarePortId
parameter_list|,
name|uint16_t
name|numOfProfiles
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|t_FmPcdIpcPlcrAllocParams
name|ipcPlcrParams
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|uint16_t
name|base
decl_stmt|;
name|uint16_t
name|swPortIndex
init|=
literal|0
decl_stmt|;
name|t_FmPcdIpcMsg
name|msg
decl_stmt|;
name|uint32_t
name|replyLength
decl_stmt|;
name|t_FmPcdIpcReply
name|reply
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|numOfProfiles
condition|)
return|return
name|E_OK
return|;
name|memset
argument_list|(
operator|&
name|ipcPlcrParams
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ipcPlcrParams
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_FmPcd
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
block|{
comment|/* Alloc resources using IPC messaging */
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|ipcPlcrParams
operator|.
name|num
operator|=
name|numOfProfiles
expr_stmt|;
name|ipcPlcrParams
operator|.
name|hardwarePortId
operator|=
name|hardwarePortId
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_PCD_ALLOC_PROFILES
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|&
name|ipcPlcrParams
argument_list|,
sizeof|sizeof
argument_list|(
name|ipcPlcrParams
argument_list|)
argument_list|)
expr_stmt|;
name|replyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_FmPcd
operator|->
name|h_IpcSession
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|ipcPlcrParams
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|replyLength
operator|!=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"IPC reply length mismatch"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|t_Error
operator|)
name|reply
operator|.
name|error
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
operator|(
name|t_Error
operator|)
name|reply
operator|.
name|error
argument_list|,
operator|(
literal|"PLCR profiles allocation failed"
operator|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|base
argument_list|,
name|reply
operator|.
name|replyBody
argument_list|,
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* master */
block|{
name|err
operator|=
name|PlcrAllocProfiles
argument_list|(
name|p_FmPcd
argument_list|,
name|hardwarePortId
argument_list|,
name|numOfProfiles
argument_list|,
operator|&
name|base
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|HW_PORT_ID_TO_SW_PORT_INDX
argument_list|(
name|swPortIndex
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|portsMapping
index|[
name|swPortIndex
index|]
operator|.
name|numOfProfiles
operator|=
name|numOfProfiles
expr_stmt|;
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|portsMapping
index|[
name|swPortIndex
index|]
operator|.
name|profilesBase
operator|=
name|base
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FmPcdPlcrFreeProfiles
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|uint8_t
name|hardwarePortId
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|t_FmPcdIpcPlcrAllocParams
name|ipcPlcrParams
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|uint16_t
name|swPortIndex
init|=
literal|0
decl_stmt|;
name|t_FmPcdIpcMsg
name|msg
decl_stmt|;
name|uint32_t
name|replyLength
decl_stmt|;
name|t_FmPcdIpcReply
name|reply
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|HW_PORT_ID_TO_SW_PORT_INDX
argument_list|(
name|swPortIndex
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_FmPcd
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
block|{
comment|/* Alloc resources using IPC messaging */
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|ipcPlcrParams
operator|.
name|num
operator|=
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|portsMapping
index|[
name|swPortIndex
index|]
operator|.
name|numOfProfiles
expr_stmt|;
name|ipcPlcrParams
operator|.
name|hardwarePortId
operator|=
name|hardwarePortId
expr_stmt|;
name|ipcPlcrParams
operator|.
name|plcrProfilesBase
operator|=
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|portsMapping
index|[
name|swPortIndex
index|]
operator|.
name|profilesBase
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_PCD_FREE_PROFILES
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|&
name|ipcPlcrParams
argument_list|,
sizeof|sizeof
argument_list|(
name|ipcPlcrParams
argument_list|)
argument_list|)
expr_stmt|;
name|replyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_FmPcd
operator|->
name|h_IpcSession
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|ipcPlcrParams
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|replyLength
operator|!=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"IPC reply length mismatch"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|t_Error
operator|)
name|reply
operator|.
name|error
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
operator|(
name|t_Error
operator|)
name|reply
operator|.
name|error
argument_list|,
operator|(
literal|"PLCR Free Profiles failed"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* master */
block|{
name|err
operator|=
name|PlcrFreeProfiles
argument_list|(
name|p_FmPcd
argument_list|,
name|hardwarePortId
argument_list|,
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|portsMapping
index|[
name|swPortIndex
index|]
operator|.
name|numOfProfiles
argument_list|,
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|portsMapping
index|[
name|swPortIndex
index|]
operator|.
name|profilesBase
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|portsMapping
index|[
name|swPortIndex
index|]
operator|.
name|numOfProfiles
operator|=
literal|0
expr_stmt|;
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|portsMapping
index|[
name|swPortIndex
index|]
operator|.
name|profilesBase
operator|=
literal|0
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|bool
name|FmPcdPlcrIsProfileValid
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|uint16_t
name|absoluteProfileId
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|t_FmPcdPlcr
modifier|*
name|p_FmPcdPlcr
init|=
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
decl_stmt|;
return|return
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|absoluteProfileId
index|]
operator|.
name|valid
return|;
block|}
end_function

begin_function
name|t_Error
name|PlcrAllocProfiles
parameter_list|(
name|t_FmPcd
modifier|*
name|p_FmPcd
parameter_list|,
name|uint8_t
name|hardwarePortId
parameter_list|,
name|uint16_t
name|numOfProfiles
parameter_list|,
name|uint16_t
modifier|*
name|p_Base
parameter_list|)
block|{
name|t_FmPcdPlcrRegs
modifier|*
name|p_Regs
init|=
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
decl_stmt|;
name|uint32_t
name|profilesFound
decl_stmt|,
name|log2Num
decl_stmt|,
name|tmpReg32
decl_stmt|;
name|uint32_t
name|intFlags
decl_stmt|;
name|uint16_t
name|first
decl_stmt|,
name|i
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|FmIsMaster
argument_list|(
name|p_FmPcd
operator|->
name|h_Fm
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|numOfProfiles
condition|)
return|return
name|E_OK
return|;
name|ASSERT_COND
argument_list|(
name|hardwarePortId
argument_list|)
expr_stmt|;
if|if
condition|(
name|numOfProfiles
operator|>
name|FM_PCD_PLCR_NUM_ENTRIES
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"numProfiles is too big."
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|POWER_OF_2
argument_list|(
name|numOfProfiles
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"numProfiles must be a power of 2."
operator|)
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|FmPcdLock
argument_list|(
name|p_FmPcd
argument_list|)
expr_stmt|;
if|if
condition|(
name|GET_UINT32
argument_list|(
name|p_Regs
operator|->
name|fmpl_pmr
index|[
name|hardwarePortId
operator|-
literal|1
index|]
argument_list|)
operator|&
name|FM_PCD_PLCR_PMR_V
condition|)
block|{
name|FmPcdUnlock
argument_list|(
name|p_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"The requesting port has already an allocated profiles window."
operator|)
argument_list|)
expr_stmt|;
block|}
name|first
operator|=
literal|0
expr_stmt|;
name|profilesFound
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|FM_PCD_PLCR_NUM_ENTRIES
condition|;
control|)
block|{
if|if
condition|(
operator|!
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|i
index|]
operator|.
name|profilesMng
operator|.
name|allocated
condition|)
block|{
name|profilesFound
operator|++
expr_stmt|;
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|profilesFound
operator|==
name|numOfProfiles
condition|)
break|break;
block|}
else|else
block|{
name|profilesFound
operator|=
literal|0
expr_stmt|;
comment|/* advance i to the next aligned address */
name|first
operator|=
name|i
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|first
operator|+
name|numOfProfiles
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|profilesFound
operator|==
name|numOfProfiles
condition|)
block|{
for|for
control|(
name|i
operator|=
name|first
init|;
name|i
operator|<
name|first
operator|+
name|numOfProfiles
condition|;
name|i
operator|++
control|)
block|{
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|i
index|]
operator|.
name|profilesMng
operator|.
name|allocated
operator|=
name|TRUE
expr_stmt|;
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|i
index|]
operator|.
name|profilesMng
operator|.
name|ownerId
operator|=
name|hardwarePortId
expr_stmt|;
block|}
block|}
else|else
block|{
name|FmPcdUnlock
argument_list|(
name|p_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_FULL
argument_list|,
operator|(
literal|"No profiles."
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/**********************FMPL_PMRx******************/
name|LOG2
argument_list|(
operator|(
name|uint64_t
operator|)
name|numOfProfiles
argument_list|,
name|log2Num
argument_list|)
expr_stmt|;
name|tmpReg32
operator|=
name|first
expr_stmt|;
name|tmpReg32
operator||=
name|log2Num
operator|<<
literal|16
expr_stmt|;
name|tmpReg32
operator||=
name|FM_PCD_PLCR_PMR_V
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Regs
operator|->
name|fmpl_pmr
index|[
name|hardwarePortId
operator|-
literal|1
index|]
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
operator|*
name|p_Base
operator|=
name|first
expr_stmt|;
name|FmPcdUnlock
argument_list|(
name|p_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|PlcrAllocSharedProfiles
parameter_list|(
name|t_FmPcd
modifier|*
name|p_FmPcd
parameter_list|,
name|uint16_t
name|numOfProfiles
parameter_list|,
name|uint16_t
modifier|*
name|profilesIds
parameter_list|)
block|{
name|uint32_t
name|profilesFound
decl_stmt|;
name|uint16_t
name|i
decl_stmt|,
name|k
init|=
literal|0
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|FmIsMaster
argument_list|(
name|p_FmPcd
operator|->
name|h_Fm
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|numOfProfiles
condition|)
return|return
name|E_OK
return|;
if|if
condition|(
name|numOfProfiles
operator|>
name|FM_PCD_PLCR_NUM_ENTRIES
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"numProfiles is too big."
operator|)
argument_list|)
expr_stmt|;
name|profilesFound
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|FM_PCD_PLCR_NUM_ENTRIES
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|i
index|]
operator|.
name|profilesMng
operator|.
name|allocated
condition|)
block|{
name|profilesFound
operator|++
expr_stmt|;
name|profilesIds
index|[
name|k
index|]
operator|=
name|i
expr_stmt|;
name|k
operator|++
expr_stmt|;
if|if
condition|(
name|profilesFound
operator|==
name|numOfProfiles
condition|)
break|break;
block|}
block|}
if|if
condition|(
name|profilesFound
operator|!=
name|numOfProfiles
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|k
condition|;
name|i
operator|++
control|)
block|{
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|profilesIds
index|[
name|i
index|]
index|]
operator|.
name|profilesMng
operator|.
name|allocated
operator|=
name|TRUE
expr_stmt|;
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|profilesIds
index|[
name|i
index|]
index|]
operator|.
name|profilesMng
operator|.
name|ownerId
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|PlcrFreeProfiles
parameter_list|(
name|t_FmPcd
modifier|*
name|p_FmPcd
parameter_list|,
name|uint8_t
name|hardwarePortId
parameter_list|,
name|uint16_t
name|numOfProfiles
parameter_list|,
name|uint16_t
name|base
parameter_list|)
block|{
name|t_FmPcdPlcrRegs
modifier|*
name|p_Regs
init|=
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
decl_stmt|;
name|uint16_t
name|i
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_FmPcd
operator|->
name|p_FmPcdDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|FmIsMaster
argument_list|(
name|p_FmPcd
operator|->
name|h_Fm
argument_list|)
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|IN_RANGE
argument_list|(
literal|1
argument_list|,
name|hardwarePortId
argument_list|,
literal|63
argument_list|)
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Regs
operator|->
name|fmpl_pmr
index|[
name|hardwarePortId
operator|-
literal|1
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|base
init|;
name|i
operator|<
name|base
operator|+
name|numOfProfiles
condition|;
name|i
operator|++
control|)
block|{
name|ASSERT_COND
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|i
index|]
operator|.
name|profilesMng
operator|.
name|ownerId
operator|==
name|hardwarePortId
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|i
index|]
operator|.
name|profilesMng
operator|.
name|allocated
argument_list|)
expr_stmt|;
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|i
index|]
operator|.
name|profilesMng
operator|.
name|allocated
operator|=
name|FALSE
expr_stmt|;
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|i
index|]
operator|.
name|profilesMng
operator|.
name|ownerId
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|void
name|PlcrFreeSharedProfiles
parameter_list|(
name|t_FmPcd
modifier|*
name|p_FmPcd
parameter_list|,
name|uint16_t
name|numOfProfiles
parameter_list|,
name|uint16_t
modifier|*
name|profilesIds
parameter_list|)
block|{
name|uint16_t
name|i
decl_stmt|;
name|SANITY_CHECK_RETURN
argument_list|(
name|p_FmPcd
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|FmIsMaster
argument_list|(
name|p_FmPcd
operator|->
name|h_Fm
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|numOfProfiles
condition|;
name|i
operator|++
control|)
block|{
name|ASSERT_COND
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|profilesIds
index|[
name|i
index|]
index|]
operator|.
name|profilesMng
operator|.
name|allocated
argument_list|)
expr_stmt|;
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|profilesIds
index|[
name|i
index|]
index|]
operator|.
name|profilesMng
operator|.
name|allocated
operator|=
name|FALSE
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|PlcrEnable
parameter_list|(
name|t_FmPcd
modifier|*
name|p_FmPcd
parameter_list|)
block|{
name|t_FmPcdPlcrRegs
modifier|*
name|p_Regs
init|=
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
decl_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Regs
operator|->
name|fmpl_gcr
argument_list|,
name|GET_UINT32
argument_list|(
name|p_Regs
operator|->
name|fmpl_gcr
argument_list|)
operator||
name|FM_PCD_PLCR_GCR_EN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|PlcrDisable
parameter_list|(
name|t_FmPcd
modifier|*
name|p_FmPcd
parameter_list|)
block|{
name|t_FmPcdPlcrRegs
modifier|*
name|p_Regs
init|=
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
decl_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Regs
operator|->
name|fmpl_gcr
argument_list|,
name|GET_UINT32
argument_list|(
name|p_Regs
operator|->
name|fmpl_gcr
argument_list|)
operator|&
operator|~
name|FM_PCD_PLCR_GCR_EN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|t_Error
name|FM_PCD_SetPlcrStatistics
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|uint32_t
name|tmpReg32
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_FmPcd
operator|->
name|p_FmPcdDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|FmIsMaster
argument_list|(
name|p_FmPcd
operator|->
name|h_Fm
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"FM_PCD_SetPlcrStatistics - guest mode!"
operator|)
argument_list|)
expr_stmt|;
name|tmpReg32
operator|=
name|GET_UINT32
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
operator|->
name|fmpl_gcr
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
condition|)
name|tmpReg32
operator||=
name|FM_PCD_PLCR_GCR_STEN
expr_stmt|;
else|else
name|tmpReg32
operator|&=
operator|~
name|FM_PCD_PLCR_GCR_STEN
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
operator|->
name|fmpl_gcr
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_PCD_ConfigPlcrAutoRefreshMode
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|FmIsMaster
argument_list|(
name|p_FmPcd
operator|->
name|h_Fm
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"FM_PCD_ConfigPlcrAutoRefreshMode - guest mode!"
operator|)
argument_list|)
expr_stmt|;
name|p_FmPcd
operator|->
name|p_FmPcdDriverParam
operator|->
name|plcrAutoRefresh
operator|=
name|enable
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FmPcdPlcrBuildProfile
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|t_FmPcdPlcrProfileParams
modifier|*
name|p_Profile
parameter_list|,
name|t_FmPcdPlcrInterModuleProfileRegs
modifier|*
name|p_PlcrRegs
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|uint32_t
name|pemode
decl_stmt|,
name|gnia
decl_stmt|,
name|ynia
decl_stmt|,
name|rnia
decl_stmt|;
comment|/* Set G, Y, R Nia */
name|err
operator|=
name|SetProfileNia
argument_list|(
name|p_FmPcd
argument_list|,
name|p_Profile
operator|->
name|nextEngineOnGreen
argument_list|,
operator|&
operator|(
name|p_Profile
operator|->
name|paramsOnGreen
operator|)
argument_list|,
operator|&
name|gnia
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
name|err
operator|=
name|SetProfileNia
argument_list|(
name|p_FmPcd
argument_list|,
name|p_Profile
operator|->
name|nextEngineOnYellow
argument_list|,
operator|&
operator|(
name|p_Profile
operator|->
name|paramsOnYellow
operator|)
argument_list|,
operator|&
name|ynia
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
name|err
operator|=
name|SetProfileNia
argument_list|(
name|p_FmPcd
argument_list|,
name|p_Profile
operator|->
name|nextEngineOnRed
argument_list|,
operator|&
operator|(
name|p_Profile
operator|->
name|paramsOnRed
operator|)
argument_list|,
operator|&
name|rnia
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
comment|/* Mode fmpl_pemode */
name|pemode
operator|=
name|FM_PCD_PLCR_PEMODE_PI
expr_stmt|;
switch|switch
condition|(
name|p_Profile
operator|->
name|algSelection
condition|)
block|{
case|case
name|e_FM_PCD_PLCR_PASS_THROUGH
case|:
name|p_PlcrRegs
operator|->
name|fmpl_pecir
operator|=
literal|0
expr_stmt|;
name|p_PlcrRegs
operator|->
name|fmpl_pecbs
operator|=
literal|0
expr_stmt|;
name|p_PlcrRegs
operator|->
name|fmpl_pepepir_eir
operator|=
literal|0
expr_stmt|;
name|p_PlcrRegs
operator|->
name|fmpl_pepbs_ebs
operator|=
literal|0
expr_stmt|;
name|p_PlcrRegs
operator|->
name|fmpl_pelts
operator|=
literal|0
expr_stmt|;
name|p_PlcrRegs
operator|->
name|fmpl_pects
operator|=
literal|0
expr_stmt|;
name|p_PlcrRegs
operator|->
name|fmpl_pepts_ets
operator|=
literal|0
expr_stmt|;
name|pemode
operator|&=
operator|~
name|FM_PCD_PLCR_PEMODE_ALG_MASK
expr_stmt|;
switch|switch
condition|(
name|p_Profile
operator|->
name|colorMode
condition|)
block|{
case|case
name|e_FM_PCD_PLCR_COLOR_BLIND
case|:
name|pemode
operator||=
name|FM_PCD_PLCR_PEMODE_CBLND
expr_stmt|;
switch|switch
condition|(
name|p_Profile
operator|->
name|color
operator|.
name|dfltColor
condition|)
block|{
case|case
name|e_FM_PCD_PLCR_GREEN
case|:
name|pemode
operator|&=
operator|~
name|FM_PCD_PLCR_PEMODE_DEFC_MASK
expr_stmt|;
break|break;
case|case
name|e_FM_PCD_PLCR_YELLOW
case|:
name|pemode
operator||=
name|FM_PCD_PLCR_PEMODE_DEFC_Y
expr_stmt|;
break|break;
case|case
name|e_FM_PCD_PLCR_RED
case|:
name|pemode
operator||=
name|FM_PCD_PLCR_PEMODE_DEFC_R
expr_stmt|;
break|break;
case|case
name|e_FM_PCD_PLCR_OVERRIDE
case|:
name|pemode
operator||=
name|FM_PCD_PLCR_PEMODE_DEFC_OVERRIDE
expr_stmt|;
break|break;
default|default:
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|e_FM_PCD_PLCR_COLOR_AWARE
case|:
name|pemode
operator|&=
operator|~
name|FM_PCD_PLCR_PEMODE_CBLND
expr_stmt|;
break|break;
default|default:
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|e_FM_PCD_PLCR_RFC_2698
case|:
comment|/* Select algorithm MODE[ALG] = "01" */
name|pemode
operator||=
name|FM_PCD_PLCR_PEMODE_ALG_RFC2698
expr_stmt|;
if|if
condition|(
name|p_Profile
operator|->
name|nonPassthroughAlgParams
operator|.
name|comittedInfoRate
operator|>
name|p_Profile
operator|->
name|nonPassthroughAlgParams
operator|.
name|peakOrAccessiveInfoRate
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
operator|(
literal|"in RFC2698 Peak rate must be equal or larger than comittedInfoRate."
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|cont_rfc
goto|;
case|case
name|e_FM_PCD_PLCR_RFC_4115
case|:
comment|/* Select algorithm MODE[ALG] = "10" */
name|pemode
operator||=
name|FM_PCD_PLCR_PEMODE_ALG_RFC4115
expr_stmt|;
name|cont_rfc
label|:
comment|/* Select Color-Blind / Color-Aware operation (MODE[CBLND]) */
switch|switch
condition|(
name|p_Profile
operator|->
name|colorMode
condition|)
block|{
case|case
name|e_FM_PCD_PLCR_COLOR_BLIND
case|:
name|pemode
operator||=
name|FM_PCD_PLCR_PEMODE_CBLND
expr_stmt|;
break|break;
case|case
name|e_FM_PCD_PLCR_COLOR_AWARE
case|:
name|pemode
operator|&=
operator|~
name|FM_PCD_PLCR_PEMODE_CBLND
expr_stmt|;
comment|/*In color aware more select override color interpretation (MODE[OVCLR]) */
switch|switch
condition|(
name|p_Profile
operator|->
name|color
operator|.
name|override
condition|)
block|{
case|case
name|e_FM_PCD_PLCR_GREEN
case|:
name|pemode
operator|&=
operator|~
name|FM_PCD_PLCR_PEMODE_OVCLR_MASK
expr_stmt|;
break|break;
case|case
name|e_FM_PCD_PLCR_YELLOW
case|:
name|pemode
operator||=
name|FM_PCD_PLCR_PEMODE_OVCLR_Y
expr_stmt|;
break|break;
case|case
name|e_FM_PCD_PLCR_RED
case|:
name|pemode
operator||=
name|FM_PCD_PLCR_PEMODE_OVCLR_R
expr_stmt|;
break|break;
case|case
name|e_FM_PCD_PLCR_OVERRIDE
case|:
name|pemode
operator||=
name|FM_PCD_PLCR_PEMODE_OVCLR_G_NC
expr_stmt|;
break|break;
default|default:
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
comment|/* Select Measurement Unit Mode to BYTE or PACKET (MODE[PKT]) */
switch|switch
condition|(
name|p_Profile
operator|->
name|nonPassthroughAlgParams
operator|.
name|rateMode
condition|)
block|{
case|case
name|e_FM_PCD_PLCR_BYTE_MODE
case|:
name|pemode
operator|&=
operator|~
name|FM_PCD_PLCR_PEMODE_PKT
expr_stmt|;
switch|switch
condition|(
name|p_Profile
operator|->
name|nonPassthroughAlgParams
operator|.
name|byteModeParams
operator|.
name|frameLengthSelection
condition|)
block|{
case|case
name|e_FM_PCD_PLCR_L2_FRM_LEN
case|:
name|pemode
operator||=
name|FM_PCD_PLCR_PEMODE_FLS_L2
expr_stmt|;
break|break;
case|case
name|e_FM_PCD_PLCR_L3_FRM_LEN
case|:
name|pemode
operator||=
name|FM_PCD_PLCR_PEMODE_FLS_L3
expr_stmt|;
break|break;
case|case
name|e_FM_PCD_PLCR_L4_FRM_LEN
case|:
name|pemode
operator||=
name|FM_PCD_PLCR_PEMODE_FLS_L4
expr_stmt|;
break|break;
case|case
name|e_FM_PCD_PLCR_FULL_FRM_LEN
case|:
name|pemode
operator||=
name|FM_PCD_PLCR_PEMODE_FLS_FULL
expr_stmt|;
break|break;
default|default:
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|p_Profile
operator|->
name|nonPassthroughAlgParams
operator|.
name|byteModeParams
operator|.
name|rollBackFrameSelection
condition|)
block|{
case|case
name|e_FM_PCD_PLCR_ROLLBACK_L2_FRM_LEN
case|:
name|pemode
operator|&=
operator|~
name|FM_PCD_PLCR_PEMODE_RBFLS
expr_stmt|;
break|break;
case|case
name|e_FM_PCD_PLCR_ROLLBACK_FULL_FRM_LEN
case|:
name|pemode
operator||=
name|FM_PCD_PLCR_PEMODE_RBFLS
expr_stmt|;
break|break;
default|default:
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|e_FM_PCD_PLCR_PACKET_MODE
case|:
name|pemode
operator||=
name|FM_PCD_PLCR_PEMODE_PKT
expr_stmt|;
break|break;
default|default:
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
comment|/* Select timeStamp floating point position (MODE[FPP]) to fit the actual traffic rates. For PACKET                mode with low traffic rates move the fixed point to the left to increase fraction accuracy. For BYTE                mode with high traffic rates move the fixed point to the right to increase integer accuracy. */
comment|/* Configure Traffic Parameters*/
block|{
name|uint32_t
name|cir
init|=
literal|0
decl_stmt|,
name|cbs
init|=
literal|0
decl_stmt|,
name|pir_eir
init|=
literal|0
decl_stmt|,
name|pbs_ebs
init|=
literal|0
decl_stmt|,
name|fpp
init|=
literal|0
decl_stmt|;
name|calcRates
argument_list|(
name|h_FmPcd
argument_list|,
operator|&
name|p_Profile
operator|->
name|nonPassthroughAlgParams
argument_list|,
operator|&
name|cir
argument_list|,
operator|&
name|cbs
argument_list|,
operator|&
name|pir_eir
argument_list|,
operator|&
name|pbs_ebs
argument_list|,
operator|&
name|fpp
argument_list|)
expr_stmt|;
comment|/*  Set Committed Information Rate (CIR) */
name|p_PlcrRegs
operator|->
name|fmpl_pecir
operator|=
name|cir
expr_stmt|;
comment|/*  Set Committed Burst Size (CBS). */
name|p_PlcrRegs
operator|->
name|fmpl_pecbs
operator|=
name|cbs
expr_stmt|;
comment|/*  Set Peak Information Rate (PIR_EIR used as PIR) */
name|p_PlcrRegs
operator|->
name|fmpl_pepepir_eir
operator|=
name|pir_eir
expr_stmt|;
comment|/*   Set Peak Burst Size (PBS_EBS used as PBS) */
name|p_PlcrRegs
operator|->
name|fmpl_pepbs_ebs
operator|=
name|pbs_ebs
expr_stmt|;
comment|/* Initialize the Metering Buckets to be full (write them with 0xFFFFFFFF. */
comment|/* Peak Rate Token Bucket Size (PTS_ETS used as PTS) */
name|p_PlcrRegs
operator|->
name|fmpl_pepts_ets
operator|=
literal|0xFFFFFFFF
expr_stmt|;
comment|/* Committed Rate Token Bucket Size (CTS) */
name|p_PlcrRegs
operator|->
name|fmpl_pects
operator|=
literal|0xFFFFFFFF
expr_stmt|;
comment|/* Set the FPP based on calculation */
name|pemode
operator||=
operator|(
name|fpp
operator|<<
name|FM_PCD_PLCR_PEMODE_FPP_SHIFT
operator|)
expr_stmt|;
block|}
break|break;
comment|/* FM_PCD_PLCR_PEMODE_ALG_RFC2698 , FM_PCD_PLCR_PEMODE_ALG_RFC4115 */
default|default:
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|p_PlcrRegs
operator|->
name|fmpl_pemode
operator|=
name|pemode
expr_stmt|;
name|p_PlcrRegs
operator|->
name|fmpl_pegnia
operator|=
name|gnia
expr_stmt|;
name|p_PlcrRegs
operator|->
name|fmpl_peynia
operator|=
name|ynia
expr_stmt|;
name|p_PlcrRegs
operator|->
name|fmpl_pernia
operator|=
name|rnia
expr_stmt|;
comment|/* Zero Counters */
name|p_PlcrRegs
operator|->
name|fmpl_pegpc
operator|=
literal|0
expr_stmt|;
name|p_PlcrRegs
operator|->
name|fmpl_peypc
operator|=
literal|0
expr_stmt|;
name|p_PlcrRegs
operator|->
name|fmpl_perpc
operator|=
literal|0
expr_stmt|;
name|p_PlcrRegs
operator|->
name|fmpl_perypc
operator|=
literal|0
expr_stmt|;
name|p_PlcrRegs
operator|->
name|fmpl_perrpc
operator|=
literal|0
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|void
name|FmPcdPlcrValidateProfileSw
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|uint16_t
name|absoluteProfileId
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|ASSERT_COND
argument_list|(
operator|!
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|absoluteProfileId
index|]
operator|.
name|valid
argument_list|)
expr_stmt|;
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|absoluteProfileId
index|]
operator|.
name|valid
operator|=
name|TRUE
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FmPcdPlcrInvalidateProfileSw
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|uint16_t
name|absoluteProfileId
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|absoluteProfileId
index|]
operator|.
name|valid
argument_list|)
expr_stmt|;
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|absoluteProfileId
index|]
operator|.
name|valid
operator|=
name|FALSE
expr_stmt|;
block|}
end_function

begin_function
name|t_Handle
name|PlcrConfig
parameter_list|(
name|t_FmPcd
modifier|*
name|p_FmPcd
parameter_list|,
name|t_FmPcdParams
modifier|*
name|p_FmPcdParams
parameter_list|)
block|{
name|t_FmPcdPlcr
modifier|*
name|p_FmPcdPlcr
decl_stmt|;
comment|/*uint8_t i=0;*/
name|UNUSED
argument_list|(
name|p_FmPcd
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|p_FmPcdParams
argument_list|)
expr_stmt|;
name|p_FmPcdPlcr
operator|=
operator|(
name|t_FmPcdPlcr
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|t_FmPcdPlcr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_FmPcdPlcr
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"FM Policer structure allocation FAILED"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_FmPcdPlcr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmPcdPlcr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_FmPcd
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
condition|)
block|{
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
operator|=
operator|(
name|t_FmPcdPlcrRegs
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|FmGetPcdPlcrBaseAddr
argument_list|(
name|p_FmPcdParams
operator|->
name|h_Fm
argument_list|)
argument_list|)
expr_stmt|;
name|p_FmPcd
operator|->
name|p_FmPcdDriverParam
operator|->
name|plcrAutoRefresh
operator|=
name|DEFAULT_plcrAutoRefresh
expr_stmt|;
name|p_FmPcd
operator|->
name|exceptions
operator||=
operator|(
name|DEFAULT_fmPcdPlcrExceptions
operator||
name|DEFAULT_fmPcdPlcrErrorExceptions
operator|)
expr_stmt|;
block|}
name|p_FmPcdPlcr
operator|->
name|numOfSharedProfiles
operator|=
name|DEFAULT_numOfSharedPlcrProfiles
expr_stmt|;
return|return
name|p_FmPcdPlcr
return|;
block|}
end_function

begin_function
name|t_Error
name|PlcrInit
parameter_list|(
name|t_FmPcd
modifier|*
name|p_FmPcd
parameter_list|)
block|{
name|t_FmPcdDriverParam
modifier|*
name|p_Param
init|=
name|p_FmPcd
operator|->
name|p_FmPcdDriverParam
decl_stmt|;
name|t_FmPcdPlcr
modifier|*
name|p_FmPcdPlcr
init|=
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
decl_stmt|;
name|uint32_t
name|tmpReg32
init|=
literal|0
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|t_FmPcdPlcrRegs
modifier|*
name|p_Regs
init|=
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
decl_stmt|;
name|t_FmPcdIpcMsg
name|msg
decl_stmt|;
name|uint32_t
name|replyLength
decl_stmt|;
name|t_FmPcdIpcReply
name|reply
decl_stmt|;
if|if
condition|(
operator|(
name|p_FmPcd
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|&&
operator|(
name|p_FmPcdPlcr
operator|->
name|numOfSharedProfiles
operator|)
condition|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|index
init|=
literal|0
decl_stmt|;
name|uint32_t
name|walking1Mask
init|=
literal|0x80000000
decl_stmt|;
name|uint32_t
name|sharedProfilesMask
index|[
name|FM_PCD_PLCR_NUM_ENTRIES
operator|/
literal|32
index|]
decl_stmt|;
name|memset
argument_list|(
name|sharedProfilesMask
argument_list|,
literal|0
argument_list|,
name|FM_PCD_PLCR_NUM_ENTRIES
operator|/
literal|32
operator|*
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_PCD_ALLOC_SHARED_PROFILES
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|p_FmPcdPlcr
operator|->
name|numOfSharedProfiles
argument_list|,
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
argument_list|)
expr_stmt|;
name|replyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|sharedProfilesMask
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_FmPcd
operator|->
name|h_IpcSession
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|p_FmPcdPlcr
operator|->
name|numOfSharedProfiles
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|replyLength
operator|!=
operator|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|sharedProfilesMask
argument_list|)
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"IPC reply length mismatch"
operator|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|sharedProfilesMask
argument_list|,
name|reply
operator|.
name|replyBody
argument_list|,
sizeof|sizeof
argument_list|(
name|sharedProfilesMask
argument_list|)
argument_list|)
expr_stmt|;
comment|/* translate 8 regs of 32 bits masks into an array of up to 256 indexes. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|FM_PCD_PLCR_NUM_ENTRIES
operator|/
literal|32
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|sharedProfilesMask
index|[
name|i
index|]
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
literal|32
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|sharedProfilesMask
index|[
name|i
index|]
operator|&
name|walking1Mask
condition|)
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|sharedProfilesIds
index|[
name|index
operator|++
index|]
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|i
operator|*
literal|32
operator|+
name|j
argument_list|)
expr_stmt|;
name|walking1Mask
operator|>>=
literal|1
expr_stmt|;
block|}
name|walking1Mask
operator|=
literal|0x80000000
expr_stmt|;
block|}
block|}
return|return
operator|(
name|t_Error
operator|)
name|reply
operator|.
name|error
return|;
block|}
if|if
condition|(
name|p_FmPcdPlcr
operator|->
name|numOfSharedProfiles
condition|)
block|{
name|err
operator|=
name|PlcrAllocSharedProfiles
argument_list|(
name|p_FmPcd
argument_list|,
name|p_FmPcdPlcr
operator|->
name|numOfSharedProfiles
argument_list|,
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|sharedProfilesIds
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
comment|/**********************FMPL_GCR******************/
name|tmpReg32
operator|=
literal|0
expr_stmt|;
name|tmpReg32
operator||=
name|FM_PCD_PLCR_GCR_STEN
expr_stmt|;
if|if
condition|(
name|p_Param
operator|->
name|plcrAutoRefresh
condition|)
name|tmpReg32
operator||=
name|FM_PCD_PLCR_GCR_DAR
expr_stmt|;
name|tmpReg32
operator||=
name|NIA_ENG_BMI
operator||
name|NIA_BMI_AC_ENQ_FRAME
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Regs
operator|->
name|fmpl_gcr
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
comment|/**********************FMPL_GCR******************/
comment|/**********************FMPL_EEVR******************/
name|WRITE_UINT32
argument_list|(
name|p_Regs
operator|->
name|fmpl_eevr
argument_list|,
operator|(
name|FM_PCD_PLCR_DOUBLE_ECC
operator||
name|FM_PCD_PLCR_INIT_ENTRY_ERROR
operator|)
argument_list|)
expr_stmt|;
comment|/**********************FMPL_EEVR******************/
comment|/**********************FMPL_EIER******************/
name|tmpReg32
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|p_FmPcd
operator|->
name|exceptions
operator|&
name|FM_PCD_EX_PLCR_DOUBLE_ECC
condition|)
block|{
name|FmEnableRamsEcc
argument_list|(
name|p_FmPcd
operator|->
name|h_Fm
argument_list|)
expr_stmt|;
name|tmpReg32
operator||=
name|FM_PCD_PLCR_DOUBLE_ECC
expr_stmt|;
block|}
if|if
condition|(
name|p_FmPcd
operator|->
name|exceptions
operator|&
name|FM_PCD_EX_PLCR_INIT_ENTRY_ERROR
condition|)
name|tmpReg32
operator||=
name|FM_PCD_PLCR_INIT_ENTRY_ERROR
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Regs
operator|->
name|fmpl_eier
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
comment|/**********************FMPL_EIER******************/
comment|/**********************FMPL_EVR******************/
name|WRITE_UINT32
argument_list|(
name|p_Regs
operator|->
name|fmpl_evr
argument_list|,
operator|(
name|FM_PCD_PLCR_PRAM_SELF_INIT_COMPLETE
operator||
name|FM_PCD_PLCR_ATOMIC_ACTION_COMPLETE
operator|)
argument_list|)
expr_stmt|;
comment|/**********************FMPL_EVR******************/
comment|/**********************FMPL_IER******************/
name|tmpReg32
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|p_FmPcd
operator|->
name|exceptions
operator|&
name|FM_PCD_EX_PLCR_PRAM_SELF_INIT_COMPLETE
condition|)
name|tmpReg32
operator||=
name|FM_PCD_PLCR_PRAM_SELF_INIT_COMPLETE
expr_stmt|;
if|if
condition|(
name|p_FmPcd
operator|->
name|exceptions
operator|&
name|FM_PCD_EX_PLCR_ATOMIC_ACTION_COMPLETE
condition|)
name|tmpReg32
operator||=
name|FM_PCD_PLCR_ATOMIC_ACTION_COMPLETE
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Regs
operator|->
name|fmpl_ier
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
comment|/**********************FMPL_IER******************/
comment|/* register even if no interrupts enabled, to allow future enablement */
name|FmRegisterIntr
argument_list|(
name|p_FmPcd
operator|->
name|h_Fm
argument_list|,
name|e_FM_MOD_PLCR
argument_list|,
literal|0
argument_list|,
name|e_FM_INTR_TYPE_ERR
argument_list|,
name|PcdPlcrErrorException
argument_list|,
name|p_FmPcd
argument_list|)
expr_stmt|;
name|FmRegisterIntr
argument_list|(
name|p_FmPcd
operator|->
name|h_Fm
argument_list|,
name|e_FM_MOD_PLCR
argument_list|,
literal|0
argument_list|,
name|e_FM_INTR_TYPE_NORMAL
argument_list|,
name|PcdPlcrException
argument_list|,
name|p_FmPcd
argument_list|)
expr_stmt|;
comment|/* driver initializes one DFLT profile at the last entry*/
comment|/**********************FMPL_DPMR******************/
name|tmpReg32
operator|=
literal|0
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Regs
operator|->
name|fmpl_dpmr
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
literal|0
index|]
operator|.
name|profilesMng
operator|.
name|allocated
operator|=
name|TRUE
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|PlcrFree
parameter_list|(
name|t_FmPcd
modifier|*
name|p_FmPcd
parameter_list|)
block|{
name|t_Error
name|err
decl_stmt|;
name|t_FmPcdIpcSharedPlcrAllocParams
name|ipcSharedPlcrParams
decl_stmt|;
name|t_FmPcdIpcMsg
name|msg
decl_stmt|;
name|FmUnregisterIntr
argument_list|(
name|p_FmPcd
operator|->
name|h_Fm
argument_list|,
name|e_FM_MOD_PLCR
argument_list|,
literal|0
argument_list|,
name|e_FM_INTR_TYPE_ERR
argument_list|)
expr_stmt|;
name|FmUnregisterIntr
argument_list|(
name|p_FmPcd
operator|->
name|h_Fm
argument_list|,
name|e_FM_MOD_PLCR
argument_list|,
literal|0
argument_list|,
name|e_FM_INTR_TYPE_NORMAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|numOfSharedProfiles
condition|)
block|{
if|if
condition|(
name|p_FmPcd
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
block|{
name|int
name|i
decl_stmt|;
name|memset
argument_list|(
name|ipcSharedPlcrParams
operator|.
name|sharedProfilesMask
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ipcSharedPlcrParams
operator|.
name|sharedProfilesMask
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Free resources using IPC messaging */
name|ipcSharedPlcrParams
operator|.
name|num
operator|=
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|numOfSharedProfiles
expr_stmt|;
comment|/* translate the allocated profile id's to a 32bit * 8regs mask */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|numOfSharedProfiles
condition|;
name|i
operator|++
control|)
name|ipcSharedPlcrParams
operator|.
name|sharedProfilesMask
index|[
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|sharedProfilesIds
index|[
name|i
index|]
operator|/
literal|32
index|]
operator||=
operator|(
literal|0x80000000
operator|>>
operator|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|sharedProfilesIds
index|[
name|i
index|]
operator|%
literal|32
operator|)
operator|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_PCD_FREE_SHARED_PROFILES
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|&
name|ipcSharedPlcrParams
argument_list|,
sizeof|sizeof
argument_list|(
name|ipcSharedPlcrParams
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_FmPcd
operator|->
name|h_IpcSession
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|ipcSharedPlcrParams
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
comment|/* else             PlcrFreeSharedProfiles(p_FmPcd, p_FmPcd->p_FmPcdPlcr->numOfSharedProfiles, p_FmPcd->p_FmPcdPlcr->sharedProfilesIds);*/
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FmPcdPlcrGetAbsoluteProfileId
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|e_FmPcdProfileTypeSelection
name|profileType
parameter_list|,
name|t_Handle
name|h_FmPort
parameter_list|,
name|uint16_t
name|relativeProfile
parameter_list|,
name|uint16_t
modifier|*
name|p_AbsoluteId
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|t_FmPcdPlcr
modifier|*
name|p_FmPcdPlcr
init|=
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
decl_stmt|;
name|uint8_t
name|i
decl_stmt|;
switch|switch
condition|(
name|profileType
condition|)
block|{
case|case
name|e_FM_PCD_PLCR_PORT_PRIVATE
case|:
comment|/* get port PCD id from port handle */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|FM_MAX_NUM_OF_PORTS
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|portsMapping
index|[
name|i
index|]
operator|.
name|h_FmPort
operator|==
name|h_FmPort
condition|)
break|break;
if|if
condition|(
name|i
operator|==
name|FM_MAX_NUM_OF_PORTS
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Invalid port handle."
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|portsMapping
index|[
name|i
index|]
operator|.
name|numOfProfiles
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
operator|(
literal|"Port has no allocated profiles"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|relativeProfile
operator|>=
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|portsMapping
index|[
name|i
index|]
operator|.
name|numOfProfiles
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
operator|(
literal|"Profile id is out of range"
operator|)
argument_list|)
expr_stmt|;
operator|*
name|p_AbsoluteId
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|portsMapping
index|[
name|i
index|]
operator|.
name|profilesBase
operator|+
name|relativeProfile
argument_list|)
expr_stmt|;
break|break;
case|case
name|e_FM_PCD_PLCR_SHARED
case|:
if|if
condition|(
name|relativeProfile
operator|>=
name|p_FmPcdPlcr
operator|->
name|numOfSharedProfiles
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
operator|(
literal|"Profile id is out of range"
operator|)
argument_list|)
expr_stmt|;
operator|*
name|p_AbsoluteId
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|p_FmPcdPlcr
operator|->
name|sharedProfilesIds
index|[
name|relativeProfile
index|]
argument_list|)
expr_stmt|;
break|break;
default|default:
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
operator|(
literal|"Invalid policer profile type"
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|uint16_t
name|FmPcdPlcrGetPortProfilesBase
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|uint8_t
name|hardwarePortId
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|uint16_t
name|swPortIndex
init|=
literal|0
decl_stmt|;
name|HW_PORT_ID_TO_SW_PORT_INDX
argument_list|(
name|swPortIndex
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
return|return
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|portsMapping
index|[
name|swPortIndex
index|]
operator|.
name|profilesBase
return|;
block|}
end_function

begin_function
name|uint16_t
name|FmPcdPlcrGetPortNumOfProfiles
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|uint8_t
name|hardwarePortId
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|uint16_t
name|swPortIndex
init|=
literal|0
decl_stmt|;
name|HW_PORT_ID_TO_SW_PORT_INDX
argument_list|(
name|swPortIndex
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
return|return
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|portsMapping
index|[
name|swPortIndex
index|]
operator|.
name|numOfProfiles
return|;
block|}
end_function

begin_function
name|uint32_t
name|FmPcdPlcrBuildWritePlcrActionReg
parameter_list|(
name|uint16_t
name|absoluteProfileId
parameter_list|)
block|{
return|return
call|(
name|uint32_t
call|)
argument_list|(
name|FM_PCD_PLCR_PAR_GO
operator||
operator|(
operator|(
name|uint32_t
operator|)
name|absoluteProfileId
operator|<<
name|FM_PCD_PLCR_PAR_PNUM_SHIFT
operator|)
argument_list|)
return|;
block|}
end_function

begin_function
name|uint32_t
name|FmPcdPlcrBuildWritePlcrActionRegs
parameter_list|(
name|uint16_t
name|absoluteProfileId
parameter_list|)
block|{
return|return
call|(
name|uint32_t
call|)
argument_list|(
name|FM_PCD_PLCR_PAR_GO
operator||
operator|(
operator|(
name|uint32_t
operator|)
name|absoluteProfileId
operator|<<
name|FM_PCD_PLCR_PAR_PNUM_SHIFT
operator|)
operator||
name|FM_PCD_PLCR_PAR_PWSEL_MASK
argument_list|)
return|;
block|}
end_function

begin_function
name|bool
name|FmPcdPlcrHwProfileIsValid
parameter_list|(
name|uint32_t
name|profileModeReg
parameter_list|)
block|{
if|if
condition|(
name|profileModeReg
operator|&
name|FM_PCD_PLCR_PEMODE_PI
condition|)
return|return
name|TRUE
return|;
else|else
return|return
name|FALSE
return|;
block|}
end_function

begin_function
name|uint32_t
name|FmPcdPlcrBuildReadPlcrActionReg
parameter_list|(
name|uint16_t
name|absoluteProfileId
parameter_list|)
block|{
return|return
call|(
name|uint32_t
call|)
argument_list|(
name|FM_PCD_PLCR_PAR_GO
operator||
name|FM_PCD_PLCR_PAR_R
operator||
operator|(
operator|(
name|uint32_t
operator|)
name|absoluteProfileId
operator|<<
name|FM_PCD_PLCR_PAR_PNUM_SHIFT
operator|)
operator||
name|FM_PCD_PLCR_PAR_PWSEL_MASK
argument_list|)
return|;
block|}
end_function

begin_function
name|uint32_t
name|FmPcdPlcrBuildCounterProfileReg
parameter_list|(
name|e_FmPcdPlcrProfileCounters
name|counter
parameter_list|)
block|{
switch|switch
condition|(
name|counter
condition|)
block|{
case|case
operator|(
name|e_FM_PCD_PLCR_PROFILE_GREEN_PACKET_TOTAL_COUNTER
operator|)
case|:
return|return
name|FM_PCD_PLCR_PAR_PWSEL_PEGPC
return|;
case|case
operator|(
name|e_FM_PCD_PLCR_PROFILE_YELLOW_PACKET_TOTAL_COUNTER
operator|)
case|:
return|return
name|FM_PCD_PLCR_PAR_PWSEL_PEYPC
return|;
case|case
operator|(
name|e_FM_PCD_PLCR_PROFILE_RED_PACKET_TOTAL_COUNTER
operator|)
case|:
return|return
name|FM_PCD_PLCR_PAR_PWSEL_PERPC
return|;
case|case
operator|(
name|e_FM_PCD_PLCR_PROFILE_RECOLOURED_YELLOW_PACKET_TOTAL_COUNTER
operator|)
case|:
return|return
name|FM_PCD_PLCR_PAR_PWSEL_PERYPC
return|;
case|case
operator|(
name|e_FM_PCD_PLCR_PROFILE_RECOLOURED_RED_PACKET_TOTAL_COUNTER
operator|)
case|:
return|return
name|FM_PCD_PLCR_PAR_PWSEL_PERRPC
return|;
default|default:
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
name|uint32_t
name|FmPcdPlcrBuildNiaProfileReg
parameter_list|(
name|bool
name|green
parameter_list|,
name|bool
name|yellow
parameter_list|,
name|bool
name|red
parameter_list|)
block|{
name|uint32_t
name|tmpReg32
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|green
condition|)
name|tmpReg32
operator||=
name|FM_PCD_PLCR_PAR_PWSEL_PEGNIA
expr_stmt|;
if|if
condition|(
name|yellow
condition|)
name|tmpReg32
operator||=
name|FM_PCD_PLCR_PAR_PWSEL_PEYNIA
expr_stmt|;
if|if
condition|(
name|red
condition|)
name|tmpReg32
operator||=
name|FM_PCD_PLCR_PAR_PWSEL_PERNIA
expr_stmt|;
return|return
name|tmpReg32
return|;
block|}
end_function

begin_function
name|void
name|FmPcdPlcrUpdateRequiredAction
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|uint16_t
name|absoluteProfileId
parameter_list|,
name|uint32_t
name|requiredAction
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|absoluteProfileId
index|]
operator|.
name|valid
argument_list|)
expr_stmt|;
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|absoluteProfileId
index|]
operator|.
name|requiredAction
operator|=
name|requiredAction
expr_stmt|;
block|}
end_function

begin_function
name|t_Error
name|FmPcdPlcrProfileTryLock
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|uint16_t
name|profileId
parameter_list|,
name|bool
name|intr
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|bool
name|ans
decl_stmt|;
if|if
condition|(
name|intr
condition|)
name|ans
operator|=
name|TRY_LOCK
argument_list|(
name|NULL
argument_list|,
operator|&
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|profileId
index|]
operator|.
name|lock
argument_list|)
expr_stmt|;
else|else
name|ans
operator|=
name|TRY_LOCK
argument_list|(
name|p_FmPcd
operator|->
name|h_Spinlock
argument_list|,
operator|&
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|profileId
index|]
operator|.
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|ans
condition|)
return|return
name|E_OK
return|;
return|return
name|ERROR_CODE
argument_list|(
name|E_BUSY
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|FmPcdPlcrReleaseProfileLock
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|uint16_t
name|profileId
parameter_list|)
block|{
name|RELEASE_LOCK
argument_list|(
operator|(
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
operator|)
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|profileId
index|]
operator|.
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**************************************************/
end_comment

begin_comment
comment|/*............Policer API.........................*/
end_comment

begin_comment
comment|/**************************************************/
end_comment

begin_function
name|t_Handle
name|FM_PCD_PlcrSetProfile
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|t_FmPcdPlcrProfileParams
modifier|*
name|p_Profile
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|t_FmPcdPlcrRegs
modifier|*
name|p_FmPcdPlcrRegs
decl_stmt|;
name|t_FmPcdPlcrInterModuleProfileRegs
name|plcrProfileReg
decl_stmt|;
name|uint32_t
name|intFlags
decl_stmt|;
name|uint16_t
name|absoluteProfileId
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|uint32_t
name|tmpReg32
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_FmPcd
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
operator|!
name|p_FmPcd
operator|->
name|p_FmPcdDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_FmPcd
operator|->
name|h_Hc
condition|)
return|return
name|FmHcPcdPlcrSetProfile
argument_list|(
name|p_FmPcd
operator|->
name|h_Hc
argument_list|,
name|p_Profile
argument_list|)
return|;
name|p_FmPcdPlcrRegs
operator|=
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_FmPcdPlcrRegs
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Profile
operator|->
name|modify
condition|)
block|{
name|absoluteProfileId
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|PTR_TO_UINT
argument_list|(
name|p_Profile
operator|->
name|id
operator|.
name|h_Profile
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|absoluteProfileId
operator|>=
name|FM_PCD_PLCR_NUM_ENTRIES
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"profileId too Big "
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|FmPcdPlcrProfileTryLock
argument_list|(
name|p_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|,
name|FALSE
argument_list|)
condition|)
return|return
name|NULL
return|;
block|}
else|else
block|{
name|intFlags
operator|=
name|FmPcdLock
argument_list|(
name|p_FmPcd
argument_list|)
expr_stmt|;
name|err
operator|=
name|FmPcdPlcrGetAbsoluteProfileId
argument_list|(
name|h_FmPcd
argument_list|,
name|p_Profile
operator|->
name|id
operator|.
name|newParams
operator|.
name|profileType
argument_list|,
name|p_Profile
operator|->
name|id
operator|.
name|newParams
operator|.
name|h_FmPort
argument_list|,
name|p_Profile
operator|->
name|id
operator|.
name|newParams
operator|.
name|relativeProfileId
argument_list|,
operator|&
name|absoluteProfileId
argument_list|)
expr_stmt|;
if|if
condition|(
name|absoluteProfileId
operator|>=
name|FM_PCD_PLCR_NUM_ENTRIES
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"profileId too Big "
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|err
condition|)
block|{
name|FmPcdUnlock
argument_list|(
name|p_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|err
operator|=
name|FmPcdPlcrProfileTryLock
argument_list|(
name|p_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|FmPcdUnlock
argument_list|(
name|p_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|NULL
return|;
block|}
comment|/* if no override, check first that this profile is unused */
if|if
condition|(
operator|!
name|p_Profile
operator|->
name|modify
condition|)
block|{
comment|/* read specified profile into profile registers */
name|tmpReg32
operator|=
name|FmPcdPlcrBuildReadPlcrActionReg
argument_list|(
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|FmPcdLock
argument_list|(
name|p_FmPcd
argument_list|)
expr_stmt|;
name|WritePar
argument_list|(
name|p_FmPcd
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
name|tmpReg32
operator|=
name|GET_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_pemode
argument_list|)
expr_stmt|;
name|FmPcdUnlock
argument_list|(
name|p_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpReg32
operator|&
name|FM_PCD_PLCR_PEMODE_PI
condition|)
block|{
name|RELEASE_LOCK
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|absoluteProfileId
index|]
operator|.
name|lock
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_ALREADY_EXISTS
argument_list|,
operator|(
literal|"Policer Profile is already used"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
name|memset
argument_list|(
operator|&
name|plcrProfileReg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmPcdPlcrInterModuleProfileRegs
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|FmPcdPlcrBuildProfile
argument_list|(
name|h_FmPcd
argument_list|,
name|p_Profile
argument_list|,
operator|&
name|plcrProfileReg
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|RELEASE_LOCK
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|absoluteProfileId
index|]
operator|.
name|lock
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|absoluteProfileId
index|]
operator|.
name|nextEngineOnGreen
operator|=
name|p_Profile
operator|->
name|nextEngineOnGreen
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|absoluteProfileId
index|]
operator|.
name|paramsOnGreen
argument_list|,
operator|&
operator|(
name|p_Profile
operator|->
name|paramsOnGreen
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|u_FmPcdPlcrNextEngineParams
argument_list|)
argument_list|)
expr_stmt|;
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|absoluteProfileId
index|]
operator|.
name|nextEngineOnYellow
operator|=
name|p_Profile
operator|->
name|nextEngineOnYellow
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|absoluteProfileId
index|]
operator|.
name|paramsOnYellow
argument_list|,
operator|&
operator|(
name|p_Profile
operator|->
name|paramsOnYellow
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|u_FmPcdPlcrNextEngineParams
argument_list|)
argument_list|)
expr_stmt|;
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|absoluteProfileId
index|]
operator|.
name|nextEngineOnRed
operator|=
name|p_Profile
operator|->
name|nextEngineOnRed
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|absoluteProfileId
index|]
operator|.
name|paramsOnRed
argument_list|,
operator|&
operator|(
name|p_Profile
operator|->
name|paramsOnRed
operator|)
argument_list|,
sizeof|sizeof
argument_list|(
name|u_FmPcdPlcrNextEngineParams
argument_list|)
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|FmPcdLock
argument_list|(
name|p_FmPcd
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_pemode
argument_list|,
name|plcrProfileReg
operator|.
name|fmpl_pemode
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_pegnia
argument_list|,
name|plcrProfileReg
operator|.
name|fmpl_pegnia
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_peynia
argument_list|,
name|plcrProfileReg
operator|.
name|fmpl_peynia
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_pernia
argument_list|,
name|plcrProfileReg
operator|.
name|fmpl_pernia
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_pecir
argument_list|,
name|plcrProfileReg
operator|.
name|fmpl_pecir
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_pecbs
argument_list|,
name|plcrProfileReg
operator|.
name|fmpl_pecbs
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_pepepir_eir
argument_list|,
name|plcrProfileReg
operator|.
name|fmpl_pepepir_eir
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_pepbs_ebs
argument_list|,
name|plcrProfileReg
operator|.
name|fmpl_pepbs_ebs
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_pelts
argument_list|,
name|plcrProfileReg
operator|.
name|fmpl_pelts
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_pects
argument_list|,
name|plcrProfileReg
operator|.
name|fmpl_pects
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_pepts_ets
argument_list|,
name|plcrProfileReg
operator|.
name|fmpl_pepts_ets
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_pegpc
argument_list|,
name|plcrProfileReg
operator|.
name|fmpl_pegpc
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_peypc
argument_list|,
name|plcrProfileReg
operator|.
name|fmpl_peypc
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_perpc
argument_list|,
name|plcrProfileReg
operator|.
name|fmpl_perpc
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_perypc
argument_list|,
name|plcrProfileReg
operator|.
name|fmpl_perypc
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_perrpc
argument_list|,
name|plcrProfileReg
operator|.
name|fmpl_perrpc
argument_list|)
expr_stmt|;
name|tmpReg32
operator|=
name|FmPcdPlcrBuildWritePlcrActionRegs
argument_list|(
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|WritePar
argument_list|(
name|p_FmPcd
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
name|FmPcdUnlock
argument_list|(
name|p_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Profile
operator|->
name|modify
condition|)
name|FmPcdPlcrValidateProfileSw
argument_list|(
name|p_FmPcd
argument_list|,
name|absoluteProfileId
argument_list|)
expr_stmt|;
name|RELEASE_LOCK
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|absoluteProfileId
index|]
operator|.
name|lock
argument_list|)
expr_stmt|;
return|return
name|UINT_TO_PTR
argument_list|(
operator|(
name|uint64_t
operator|)
name|absoluteProfileId
operator|+
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_PCD_PlcrDeleteProfile
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|t_Handle
name|h_Profile
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|uint16_t
name|profileIndx
init|=
call|(
name|uint16_t
call|)
argument_list|(
name|PTR_TO_UINT
argument_list|(
name|h_Profile
argument_list|)
operator|-
literal|1
argument_list|)
decl_stmt|;
name|uint32_t
name|tmpReg32
decl_stmt|,
name|intFlags
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|profileIndx
operator|<
name|FM_PCD_PLCR_NUM_ENTRIES
operator|)
argument_list|,
name|E_INVALID_SELECTION
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_FmPcd
operator|->
name|h_Hc
condition|)
return|return
name|FmHcPcdPlcrDeleteProfile
argument_list|(
name|p_FmPcd
operator|->
name|h_Hc
argument_list|,
name|h_Profile
argument_list|)
return|;
name|FmPcdPlcrInvalidateProfileSw
argument_list|(
name|p_FmPcd
argument_list|,
name|profileIndx
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|FmPcdLock
argument_list|(
name|p_FmPcd
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_pemode
argument_list|,
operator|~
name|FM_PCD_PLCR_PEMODE_PI
argument_list|)
expr_stmt|;
name|tmpReg32
operator|=
name|FmPcdPlcrBuildWritePlcrActionRegs
argument_list|(
name|profileIndx
argument_list|)
expr_stmt|;
name|WritePar
argument_list|(
name|p_FmPcd
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
name|FmPcdUnlock
argument_list|(
name|p_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ......... */
end_comment

begin_comment
comment|/***************************************************/
end_comment

begin_comment
comment|/*............Policer Profile Counter..............*/
end_comment

begin_comment
comment|/***************************************************/
end_comment

begin_function
name|uint32_t
name|FM_PCD_PlcrGetProfileCounter
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|t_Handle
name|h_Profile
parameter_list|,
name|e_FmPcdPlcrProfileCounters
name|counter
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|uint16_t
name|profileIndx
init|=
call|(
name|uint16_t
call|)
argument_list|(
name|PTR_TO_UINT
argument_list|(
name|h_Profile
argument_list|)
operator|-
literal|1
argument_list|)
decl_stmt|;
name|t_FmPcdPlcrRegs
modifier|*
name|p_FmPcdPlcrRegs
decl_stmt|;
name|uint32_t
name|intFlags
decl_stmt|,
name|counterVal
init|=
literal|0
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_FmPcd
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
operator|!
name|p_FmPcd
operator|->
name|p_FmPcdDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_FmPcd
operator|->
name|h_Hc
condition|)
return|return
name|FmHcPcdPlcrGetProfileCounter
argument_list|(
name|p_FmPcd
operator|->
name|h_Hc
argument_list|,
name|h_Profile
argument_list|,
name|counter
argument_list|)
return|;
name|p_FmPcdPlcrRegs
operator|=
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_FmPcdPlcrRegs
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|profileIndx
operator|>=
name|FM_PCD_PLCR_NUM_ENTRIES
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"profileId too Big "
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|intFlags
operator|=
name|FmPcdLock
argument_list|(
name|p_FmPcd
argument_list|)
expr_stmt|;
name|WritePar
argument_list|(
name|p_FmPcd
argument_list|,
name|FmPcdPlcrBuildReadPlcrActionReg
argument_list|(
name|profileIndx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|FmPcdPlcrHwProfileIsValid
argument_list|(
name|GET_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_pemode
argument_list|)
argument_list|)
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Uninitialized profile"
operator|)
argument_list|)
expr_stmt|;
name|FmPcdUnlock
argument_list|(
name|p_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
switch|switch
condition|(
name|counter
condition|)
block|{
case|case
name|e_FM_PCD_PLCR_PROFILE_GREEN_PACKET_TOTAL_COUNTER
case|:
name|counterVal
operator|=
operator|(
name|GET_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_pegpc
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|e_FM_PCD_PLCR_PROFILE_YELLOW_PACKET_TOTAL_COUNTER
case|:
name|counterVal
operator|=
name|GET_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_peypc
argument_list|)
expr_stmt|;
break|break;
case|case
name|e_FM_PCD_PLCR_PROFILE_RED_PACKET_TOTAL_COUNTER
case|:
name|counterVal
operator|=
name|GET_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_perpc
argument_list|)
expr_stmt|;
break|break;
case|case
name|e_FM_PCD_PLCR_PROFILE_RECOLOURED_YELLOW_PACKET_TOTAL_COUNTER
case|:
name|counterVal
operator|=
name|GET_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_perypc
argument_list|)
expr_stmt|;
break|break;
case|case
name|e_FM_PCD_PLCR_PROFILE_RECOLOURED_RED_PACKET_TOTAL_COUNTER
case|:
name|counterVal
operator|=
name|GET_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_perrpc
argument_list|)
expr_stmt|;
break|break;
default|default:
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
break|break;
block|}
name|FmPcdUnlock
argument_list|(
name|p_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|counterVal
return|;
block|}
end_function

begin_function
name|t_Error
name|FmPcdPlcrCcGetSetParams
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|uint16_t
name|profileIndx
parameter_list|,
name|uint32_t
name|requiredAction
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|t_FmPcdPlcr
modifier|*
name|p_FmPcdPlcr
init|=
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
decl_stmt|;
name|t_FmPcdPlcrRegs
modifier|*
name|p_FmPcdPlcrRegs
init|=
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
decl_stmt|;
name|uint32_t
name|tmpReg32
decl_stmt|,
name|intFlags
decl_stmt|;
if|if
condition|(
name|p_FmPcd
operator|->
name|h_Hc
condition|)
return|return
name|FmHcPcdPlcrCcGetSetParams
argument_list|(
name|p_FmPcd
operator|->
name|h_Hc
argument_list|,
name|profileIndx
argument_list|,
name|requiredAction
argument_list|)
return|;
if|if
condition|(
name|profileIndx
operator|>=
name|FM_PCD_PLCR_NUM_ENTRIES
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Policer profile out of range"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|FmPcdPlcrProfileTryLock
argument_list|(
name|p_FmPcd
argument_list|,
name|profileIndx
argument_list|,
name|FALSE
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Lock on PP FAILED"
operator|)
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|FmPcdLock
argument_list|(
name|p_FmPcd
argument_list|)
expr_stmt|;
name|WritePar
argument_list|(
name|p_FmPcd
argument_list|,
name|FmPcdPlcrBuildReadPlcrActionReg
argument_list|(
name|profileIndx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|FmPcdPlcrHwProfileIsValid
argument_list|(
name|GET_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_pemode
argument_list|)
argument_list|)
condition|)
block|{
name|FmPcdUnlock
argument_list|(
name|p_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|RELEASE_LOCK
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|profileIndx
index|]
operator|.
name|lock
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Policer profile is not valid"
operator|)
argument_list|)
expr_stmt|;
block|}
name|ASSERT_COND
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|profileIndx
index|]
operator|.
name|valid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|profileIndx
index|]
operator|.
name|pointedOwners
operator|||
operator|!
operator|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|profileIndx
index|]
operator|.
name|requiredAction
operator|&
name|requiredAction
operator|)
condition|)
block|{
if|if
condition|(
name|requiredAction
operator|&
name|UPDATE_NIA_ENQ_WITHOUT_DMA
condition|)
block|{
if|if
condition|(
operator|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|profileIndx
index|]
operator|.
name|nextEngineOnGreen
operator|!=
name|e_FM_PCD_DONE
operator|)
operator|||
operator|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|profileIndx
index|]
operator|.
name|nextEngineOnYellow
operator|!=
name|e_FM_PCD_DONE
operator|)
operator|||
operator|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|profileIndx
index|]
operator|.
name|nextEngineOnRed
operator|!=
name|e_FM_PCD_DONE
operator|)
condition|)
block|{
name|FmPcdUnlock
argument_list|(
name|p_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_OK
argument_list|,
operator|(
literal|"In this case the next engine can be e_FM_PCD_DONE"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|profileIndx
index|]
operator|.
name|paramsOnGreen
operator|.
name|action
operator|==
name|e_FM_PCD_ENQ_FRAME
condition|)
block|{
name|tmpReg32
operator|=
name|GET_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_pegnia
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tmpReg32
operator|&
operator|(
name|NIA_ENG_BMI
operator||
name|NIA_BMI_AC_ENQ_FRAME
operator|)
operator|)
condition|)
block|{
name|FmPcdUnlock
argument_list|(
name|p_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Next engine of this policer profile has to be assigned to FM_PCD_DONE"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tmpReg32
operator||=
name|NIA_BMI_AC_ENQ_FRAME_WITHOUT_DMA
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_pegnia
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
name|tmpReg32
operator|=
name|FmPcdPlcrBuildWritePlcrActionReg
argument_list|(
name|profileIndx
argument_list|)
expr_stmt|;
name|tmpReg32
operator||=
name|FM_PCD_PLCR_PAR_PWSEL_PEGNIA
expr_stmt|;
name|WritePar
argument_list|(
name|p_FmPcd
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|profileIndx
index|]
operator|.
name|paramsOnYellow
operator|.
name|action
operator|==
name|e_FM_PCD_ENQ_FRAME
condition|)
block|{
name|tmpReg32
operator|=
name|GET_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_peynia
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tmpReg32
operator|&
operator|(
name|NIA_ENG_BMI
operator||
name|NIA_BMI_AC_ENQ_FRAME
operator|)
operator|)
condition|)
block|{
name|FmPcdUnlock
argument_list|(
name|p_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Next engine of this policer profile has to be assigned to FM_PCD_DONE"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tmpReg32
operator||=
name|NIA_BMI_AC_ENQ_FRAME_WITHOUT_DMA
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_peynia
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
name|tmpReg32
operator|=
name|FmPcdPlcrBuildWritePlcrActionReg
argument_list|(
name|profileIndx
argument_list|)
expr_stmt|;
name|tmpReg32
operator||=
name|FM_PCD_PLCR_PAR_PWSEL_PEYNIA
expr_stmt|;
name|WritePar
argument_list|(
name|p_FmPcd
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|profileIndx
index|]
operator|.
name|paramsOnRed
operator|.
name|action
operator|==
name|e_FM_PCD_ENQ_FRAME
condition|)
block|{
name|tmpReg32
operator|=
name|GET_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_pernia
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|tmpReg32
operator|&
operator|(
name|NIA_ENG_BMI
operator||
name|NIA_BMI_AC_ENQ_FRAME
operator|)
operator|)
condition|)
block|{
name|FmPcdUnlock
argument_list|(
name|p_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Next engine of this policer profile has to be assigned to FM_PCD_DONE"
operator|)
argument_list|)
expr_stmt|;
block|}
name|tmpReg32
operator||=
name|NIA_BMI_AC_ENQ_FRAME_WITHOUT_DMA
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_pernia
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
name|tmpReg32
operator|=
name|FmPcdPlcrBuildWritePlcrActionReg
argument_list|(
name|profileIndx
argument_list|)
expr_stmt|;
name|tmpReg32
operator||=
name|FM_PCD_PLCR_PAR_PWSEL_PERNIA
expr_stmt|;
name|WritePar
argument_list|(
name|p_FmPcd
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|FmPcdUnlock
argument_list|(
name|p_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|profileIndx
index|]
operator|.
name|pointedOwners
operator|+=
literal|1
expr_stmt|;
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|profileIndx
index|]
operator|.
name|requiredAction
operator||=
name|requiredAction
expr_stmt|;
name|RELEASE_LOCK
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|profiles
index|[
name|profileIndx
index|]
operator|.
name|lock
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_PCD_PlcrSetProfileCounter
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|t_Handle
name|h_Profile
parameter_list|,
name|e_FmPcdPlcrProfileCounters
name|counter
parameter_list|,
name|uint32_t
name|value
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|uint16_t
name|profileIndx
init|=
call|(
name|uint16_t
call|)
argument_list|(
name|PTR_TO_UINT
argument_list|(
name|h_Profile
argument_list|)
operator|-
literal|1
argument_list|)
decl_stmt|;
name|t_FmPcdPlcrRegs
modifier|*
name|p_FmPcdPlcrRegs
decl_stmt|;
name|uint32_t
name|tmpReg32
decl_stmt|,
name|intFlags
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_FmPcd
operator|->
name|p_FmPcdDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_FmPcd
operator|->
name|h_Hc
condition|)
return|return
name|FmHcPcdPlcrSetProfileCounter
argument_list|(
name|p_FmPcd
operator|->
name|h_Hc
argument_list|,
name|h_Profile
argument_list|,
name|counter
argument_list|,
name|value
argument_list|)
return|;
name|p_FmPcdPlcrRegs
operator|=
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcdPlcrRegs
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|FmPcdLock
argument_list|(
name|p_FmPcd
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|counter
condition|)
block|{
case|case
name|e_FM_PCD_PLCR_PROFILE_GREEN_PACKET_TOTAL_COUNTER
case|:
name|WRITE_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_pegpc
argument_list|,
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|e_FM_PCD_PLCR_PROFILE_YELLOW_PACKET_TOTAL_COUNTER
case|:
name|WRITE_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_peypc
argument_list|,
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|e_FM_PCD_PLCR_PROFILE_RED_PACKET_TOTAL_COUNTER
case|:
name|WRITE_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_perpc
argument_list|,
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|e_FM_PCD_PLCR_PROFILE_RECOLOURED_YELLOW_PACKET_TOTAL_COUNTER
case|:
name|WRITE_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_perypc
argument_list|,
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|e_FM_PCD_PLCR_PROFILE_RECOLOURED_RED_PACKET_TOTAL_COUNTER
case|:
name|WRITE_UINT32
argument_list|(
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
operator|.
name|fmpl_perrpc
argument_list|,
name|value
argument_list|)
expr_stmt|;
break|break;
default|default:
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
comment|/*  Activate the atomic write action by writing FMPL_PAR with: GO=1, RW=1, PSI=0, PNUM =      *  Profile Number, PWSEL=0xFFFF (select all words).      */
name|tmpReg32
operator|=
name|FmPcdPlcrBuildWritePlcrActionReg
argument_list|(
name|profileIndx
argument_list|)
expr_stmt|;
name|tmpReg32
operator||=
name|FmPcdPlcrBuildCounterProfileReg
argument_list|(
name|counter
argument_list|)
expr_stmt|;
name|WritePar
argument_list|(
name|p_FmPcd
argument_list|,
name|tmpReg32
argument_list|)
expr_stmt|;
name|FmPcdUnlock
argument_list|(
name|p_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_PCD_ConfigPlcrNumOfSharedProfiles
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|uint16_t
name|numOfSharedPlcrProfiles
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|numOfSharedProfiles
operator|=
name|numOfSharedPlcrProfiles
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* ... */
end_comment

begin_if
if|#
directive|if
operator|(
name|defined
argument_list|(
name|DEBUG_ERRORS
argument_list|)
operator|&&
operator|(
name|DEBUG_ERRORS
operator|>
literal|0
operator|)
operator|)
end_if

begin_function
name|t_Error
name|FM_PCD_PlcrDumpRegs
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|t_FmPcdIpcMsg
name|msg
decl_stmt|;
name|DECLARE_DUMP
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_FmPcd
operator|->
name|p_FmPcdDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_FmPcd
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
block|{
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_PCD_PLCR_DUMP_REGS
expr_stmt|;
return|return
name|XX_IpcSendMessage
argument_list|(
name|p_FmPcd
operator|->
name|h_IpcSession
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
else|else
block|{
name|DUMP_SUBTITLE
argument_list|(
operator|(
literal|"\n"
operator|)
argument_list|)
expr_stmt|;
name|DUMP_TITLE
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
argument_list|,
operator|(
literal|"FmPcdPlcrRegs Regs"
operator|)
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
argument_list|,
name|fmpl_gcr
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
argument_list|,
name|fmpl_gsr
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
argument_list|,
name|fmpl_evr
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
argument_list|,
name|fmpl_ier
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
argument_list|,
name|fmpl_ifr
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
argument_list|,
name|fmpl_eevr
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
argument_list|,
name|fmpl_eier
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
argument_list|,
name|fmpl_eifr
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
argument_list|,
name|fmpl_rpcnt
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
argument_list|,
name|fmpl_ypcnt
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
argument_list|,
name|fmpl_rrpcnt
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
argument_list|,
name|fmpl_rypcnt
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
argument_list|,
name|fmpl_tpcnt
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
argument_list|,
name|fmpl_flmcnt
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
argument_list|,
name|fmpl_serc
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
argument_list|,
name|fmpl_upcr
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
argument_list|,
name|fmpl_dpmr
argument_list|)
expr_stmt|;
name|DUMP_TITLE
argument_list|(
operator|&
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
operator|->
name|fmpl_pmr
argument_list|,
operator|(
literal|"fmpl_pmr"
operator|)
argument_list|)
expr_stmt|;
name|DUMP_SUBSTRUCT_ARRAY
argument_list|(
argument|i
argument_list|,
literal|63
argument_list|)
block|{
name|DUMP_MEMORY
argument_list|(
operator|&
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
operator|->
name|fmpl_pmr
index|[
name|i
index|]
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
block|}
end_function

begin_function
name|t_Error
name|FM_PCD_PlcrProfileDumpRegs
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|t_Handle
name|h_Profile
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|t_FmPcdPlcrInterModuleProfileRegs
modifier|*
name|p_ProfilesRegs
decl_stmt|;
name|uint32_t
name|tmpReg
decl_stmt|,
name|intFlags
decl_stmt|;
name|uint16_t
name|profileIndx
init|=
call|(
name|uint16_t
call|)
argument_list|(
name|PTR_TO_UINT
argument_list|(
name|h_Profile
argument_list|)
operator|-
literal|1
argument_list|)
decl_stmt|;
name|t_FmPcdIpcMsg
name|msg
decl_stmt|;
name|DECLARE_DUMP
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_FmPcd
operator|->
name|p_FmPcdDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_FmPcd
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
block|{
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_PCD_PLCR_PROFILE_DUMP_REGS
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|h_Profile
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|XX_IpcSendMessage
argument_list|(
name|p_FmPcd
operator|->
name|h_IpcSession
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
else|else
block|{
name|DUMP_SUBTITLE
argument_list|(
operator|(
literal|"\n"
operator|)
argument_list|)
expr_stmt|;
name|DUMP_TITLE
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
argument_list|,
operator|(
literal|"FmPcdPlcrRegs Profile Regs"
operator|)
argument_list|)
expr_stmt|;
name|p_ProfilesRegs
operator|=
operator|&
name|p_FmPcd
operator|->
name|p_FmPcdPlcr
operator|->
name|p_FmPcdPlcrRegs
operator|->
name|profileRegs
expr_stmt|;
name|tmpReg
operator|=
name|FmPcdPlcrBuildReadPlcrActionReg
argument_list|(
operator|(
name|uint16_t
operator|)
name|profileIndx
argument_list|)
expr_stmt|;
name|intFlags
operator|=
name|FmPcdLock
argument_list|(
name|p_FmPcd
argument_list|)
expr_stmt|;
name|WritePar
argument_list|(
name|p_FmPcd
argument_list|,
name|tmpReg
argument_list|)
expr_stmt|;
name|DUMP_TITLE
argument_list|(
name|p_ProfilesRegs
argument_list|,
operator|(
literal|"Profile %d regs"
operator|,
name|profileIndx
operator|)
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_ProfilesRegs
argument_list|,
name|fmpl_pemode
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_ProfilesRegs
argument_list|,
name|fmpl_pegnia
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_ProfilesRegs
argument_list|,
name|fmpl_peynia
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_ProfilesRegs
argument_list|,
name|fmpl_pernia
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_ProfilesRegs
argument_list|,
name|fmpl_pecir
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_ProfilesRegs
argument_list|,
name|fmpl_pecbs
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_ProfilesRegs
argument_list|,
name|fmpl_pepepir_eir
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_ProfilesRegs
argument_list|,
name|fmpl_pepbs_ebs
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_ProfilesRegs
argument_list|,
name|fmpl_pelts
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_ProfilesRegs
argument_list|,
name|fmpl_pects
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_ProfilesRegs
argument_list|,
name|fmpl_pepts_ets
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_ProfilesRegs
argument_list|,
name|fmpl_pegpc
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_ProfilesRegs
argument_list|,
name|fmpl_peypc
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_ProfilesRegs
argument_list|,
name|fmpl_perpc
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_ProfilesRegs
argument_list|,
name|fmpl_perypc
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_ProfilesRegs
argument_list|,
name|fmpl_perrpc
argument_list|)
expr_stmt|;
name|FmPcdUnlock
argument_list|(
name|p_FmPcd
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* (defined(DEBUG_ERRORS)&& ... */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright 2008-2012 Freescale Semiconductor Inc.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are met:  *     * Redistributions of source code must retain the above copyright  *       notice, this list of conditions and the following disclaimer.  *     * Redistributions in binary form must reproduce the above copyright  *       notice, this list of conditions and the following disclaimer in the  *       documentation and/or other materials provided with the distribution.  *     * Neither the name of Freescale Semiconductor nor the  *       names of its contributors may be used to endorse or promote products  *       derived from this software without specific prior written permission.  *  *  * ALTERNATIVELY, this software may be distributed under the terms of the  * GNU General Public License ("GPL") as published by the Free Software  * Foundation, either version 2 of that License or (at your option) any  * later version.  *  * THIS SOFTWARE IS PROVIDED BY Freescale Semiconductor ``AS IS'' AND ANY  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  * DISCLAIMED. IN NO EVENT SHALL Freescale Semiconductor BE LIABLE FOR ANY  * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES  * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND  * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/******************************************************************************  @File          fm_pcd.c   @Description   FM PCD ... */
end_comment

begin_comment
comment|/***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<linux/math64.h>
end_include

begin_include
include|#
directive|include
file|"std_ext.h"
end_include

begin_include
include|#
directive|include
file|"error_ext.h"
end_include

begin_include
include|#
directive|include
file|"string_ext.h"
end_include

begin_include
include|#
directive|include
file|"debug_ext.h"
end_include

begin_include
include|#
directive|include
file|"net_ext.h"
end_include

begin_include
include|#
directive|include
file|"fm_common.h"
end_include

begin_include
include|#
directive|include
file|"fm_pcd.h"
end_include

begin_include
include|#
directive|include
file|"fm_pcd_ipc.h"
end_include

begin_include
include|#
directive|include
file|"fm_prs.h"
end_include

begin_include
include|#
directive|include
file|"fsl_fman_prs.h"
end_include

begin_function
specifier|static
name|void
name|PcdPrsErrorException
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|uint32_t
name|event
decl_stmt|,
name|ev_mask
decl_stmt|;
name|struct
name|fman_prs_regs
modifier|*
name|PrsRegs
init|=
operator|(
expr|struct
name|fman_prs_regs
operator|*
operator|)
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|p_FmPcdPrsRegs
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_FmPcd
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
argument_list|)
expr_stmt|;
name|ev_mask
operator|=
name|fman_prs_get_err_ev_mask
argument_list|(
name|PrsRegs
argument_list|)
expr_stmt|;
name|event
operator|=
name|fman_prs_get_err_event
argument_list|(
name|PrsRegs
argument_list|,
name|ev_mask
argument_list|)
expr_stmt|;
name|fman_prs_ack_err_event
argument_list|(
name|PrsRegs
argument_list|,
name|event
argument_list|)
expr_stmt|;
name|DBG
argument_list|(
name|TRACE
argument_list|,
operator|(
literal|"parser error - 0x%08x\n"
operator|,
name|event
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|&
name|FM_PCD_PRS_DOUBLE_ECC
condition|)
name|p_FmPcd
operator|->
name|f_Exception
argument_list|(
name|p_FmPcd
operator|->
name|h_App
argument_list|,
name|e_FM_PCD_PRS_EXCEPTION_DOUBLE_ECC
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|PcdPrsException
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|uint32_t
name|event
decl_stmt|,
name|ev_mask
decl_stmt|;
name|struct
name|fman_prs_regs
modifier|*
name|PrsRegs
init|=
operator|(
expr|struct
name|fman_prs_regs
operator|*
operator|)
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|p_FmPcdPrsRegs
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_FmPcd
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
argument_list|)
expr_stmt|;
name|ev_mask
operator|=
name|fman_prs_get_expt_ev_mask
argument_list|(
name|PrsRegs
argument_list|)
expr_stmt|;
name|event
operator|=
name|fman_prs_get_expt_event
argument_list|(
name|PrsRegs
argument_list|,
name|ev_mask
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|event
operator|&
name|FM_PCD_PRS_SINGLE_ECC
argument_list|)
expr_stmt|;
name|DBG
argument_list|(
name|TRACE
argument_list|,
operator|(
literal|"parser event - 0x%08x\n"
operator|,
name|event
operator|)
argument_list|)
expr_stmt|;
name|fman_prs_ack_expt_event
argument_list|(
name|PrsRegs
argument_list|,
name|event
argument_list|)
expr_stmt|;
name|p_FmPcd
operator|->
name|f_Exception
argument_list|(
name|p_FmPcd
operator|->
name|h_App
argument_list|,
name|e_FM_PCD_PRS_EXCEPTION_SINGLE_ECC
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|t_Handle
name|PrsConfig
parameter_list|(
name|t_FmPcd
modifier|*
name|p_FmPcd
parameter_list|,
name|t_FmPcdParams
modifier|*
name|p_FmPcdParams
parameter_list|)
block|{
name|t_FmPcdPrs
modifier|*
name|p_FmPcdPrs
decl_stmt|;
name|uintptr_t
name|baseAddr
decl_stmt|;
name|UNUSED
argument_list|(
name|p_FmPcd
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|p_FmPcdParams
argument_list|)
expr_stmt|;
name|p_FmPcdPrs
operator|=
operator|(
name|t_FmPcdPrs
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|t_FmPcdPrs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_FmPcdPrs
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"FM Parser structure allocation FAILED"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_FmPcdPrs
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_FmPcdPrs
argument_list|)
argument_list|)
expr_stmt|;
name|fman_prs_defconfig
argument_list|(
operator|&
name|p_FmPcd
operator|->
name|p_FmPcdDriverParam
operator|->
name|dfltCfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_FmPcd
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
condition|)
block|{
name|baseAddr
operator|=
name|FmGetPcdPrsBaseAddr
argument_list|(
name|p_FmPcdParams
operator|->
name|h_Fm
argument_list|)
expr_stmt|;
name|p_FmPcdPrs
operator|->
name|p_SwPrsCode
operator|=
operator|(
name|uint32_t
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|baseAddr
argument_list|)
expr_stmt|;
name|p_FmPcdPrs
operator|->
name|p_FmPcdPrsRegs
operator|=
operator|(
expr|struct
name|fman_prs_regs
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|baseAddr
operator|+
name|PRS_REGS_OFFSET
argument_list|)
expr_stmt|;
block|}
name|p_FmPcdPrs
operator|->
name|fmPcdPrsPortIdStatistics
operator|=
name|p_FmPcd
operator|->
name|p_FmPcdDriverParam
operator|->
name|dfltCfg
operator|.
name|port_id_stat
expr_stmt|;
name|p_FmPcd
operator|->
name|p_FmPcdDriverParam
operator|->
name|prsMaxParseCycleLimit
operator|=
name|p_FmPcd
operator|->
name|p_FmPcdDriverParam
operator|->
name|dfltCfg
operator|.
name|max_prs_cyc_lim
expr_stmt|;
name|p_FmPcd
operator|->
name|exceptions
operator||=
name|p_FmPcd
operator|->
name|p_FmPcdDriverParam
operator|->
name|dfltCfg
operator|.
name|prs_exceptions
expr_stmt|;
return|return
name|p_FmPcdPrs
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|(
operator|(
name|DPAA_VERSION
operator|==
literal|10
operator|)
operator|&&
name|defined
argument_list|(
name|FM_CAPWAP_SUPPORT
argument_list|)
operator|)
end_if

begin_decl_stmt
specifier|static
name|uint8_t
name|swPrsPatch
index|[]
init|=
name|SW_PRS_UDP_LITE_PATCH
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_decl_stmt
specifier|static
name|uint8_t
name|swPrsPatch
index|[]
init|=
name|SW_PRS_OFFLOAD_PATCH
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* FM_CAPWAP_SUPPORT */
end_comment

begin_function
name|t_Error
name|PrsInit
parameter_list|(
name|t_FmPcd
modifier|*
name|p_FmPcd
parameter_list|)
block|{
name|t_FmPcdDriverParam
modifier|*
name|p_Param
init|=
name|p_FmPcd
operator|->
name|p_FmPcdDriverParam
decl_stmt|;
name|uint32_t
modifier|*
name|p_TmpCode
decl_stmt|;
name|uint32_t
modifier|*
name|p_LoadTarget
init|=
operator|(
name|uint32_t
operator|*
operator|)
name|PTR_MOVE
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|p_SwPrsCode
argument_list|,
name|FM_PCD_SW_PRS_SIZE
operator|-
name|FM_PCD_PRS_SW_PATCHES_SIZE
argument_list|)
decl_stmt|;
name|struct
name|fman_prs_regs
modifier|*
name|PrsRegs
init|=
operator|(
expr|struct
name|fman_prs_regs
operator|*
operator|)
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|p_FmPcdPrsRegs
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|ASSERT_COND
argument_list|(
sizeof|sizeof
argument_list|(
name|swPrsPatch
argument_list|)
operator|<=
operator|(
name|FM_PCD_PRS_SW_PATCHES_SIZE
operator|-
name|FM_PCD_PRS_SW_TAIL_SIZE
operator|)
argument_list|)
expr_stmt|;
comment|/* nothing to do in guest-partition */
if|if
condition|(
name|p_FmPcd
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
return|return
name|E_OK
return|;
name|p_TmpCode
operator|=
operator|(
name|uint32_t
operator|*
operator|)
name|XX_MallocSmart
argument_list|(
name|ROUND_UP
argument_list|(
sizeof|sizeof
argument_list|(
name|swPrsPatch
argument_list|)
argument_list|,
literal|4
argument_list|)
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_TmpCode
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"Tmp Sw-Parser code allocation FAILED"
operator|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
name|p_TmpCode
argument_list|,
literal|0
argument_list|,
name|ROUND_UP
argument_list|(
sizeof|sizeof
argument_list|(
name|swPrsPatch
argument_list|)
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
name|p_TmpCode
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|swPrsPatch
argument_list|,
sizeof|sizeof
argument_list|(
name|swPrsPatch
argument_list|)
argument_list|)
expr_stmt|;
name|fman_prs_init
argument_list|(
name|PrsRegs
argument_list|,
operator|&
name|p_Param
operator|->
name|dfltCfg
argument_list|)
expr_stmt|;
comment|/* register even if no interrupts enabled, to allow future enablement */
name|FmRegisterIntr
argument_list|(
name|p_FmPcd
operator|->
name|h_Fm
argument_list|,
name|e_FM_MOD_PRS
argument_list|,
literal|0
argument_list|,
name|e_FM_INTR_TYPE_ERR
argument_list|,
name|PcdPrsErrorException
argument_list|,
name|p_FmPcd
argument_list|)
expr_stmt|;
comment|/* register even if no interrupts enabled, to allow future enablement */
name|FmRegisterIntr
argument_list|(
name|p_FmPcd
operator|->
name|h_Fm
argument_list|,
name|e_FM_MOD_PRS
argument_list|,
literal|0
argument_list|,
name|e_FM_INTR_TYPE_NORMAL
argument_list|,
name|PcdPrsException
argument_list|,
name|p_FmPcd
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_FmPcd
operator|->
name|exceptions
operator|&
name|FM_PCD_EX_PRS_SINGLE_ECC
condition|)
name|FmEnableRamsEcc
argument_list|(
name|p_FmPcd
operator|->
name|h_Fm
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_FmPcd
operator|->
name|exceptions
operator|&
name|FM_PCD_EX_PRS_DOUBLE_ECC
condition|)
name|FmEnableRamsEcc
argument_list|(
name|p_FmPcd
operator|->
name|h_Fm
argument_list|)
expr_stmt|;
comment|/* load sw parser Ip-Frag patch */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DIV_CEIL
argument_list|(
sizeof|sizeof
argument_list|(
name|swPrsPatch
argument_list|)
argument_list|,
literal|4
argument_list|)
condition|;
name|i
operator|++
control|)
name|WRITE_UINT32
argument_list|(
name|p_LoadTarget
index|[
name|i
index|]
argument_list|,
name|GET_UINT32
argument_list|(
name|p_TmpCode
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_TmpCode
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|void
name|PrsFree
parameter_list|(
name|t_FmPcd
modifier|*
name|p_FmPcd
parameter_list|)
block|{
name|ASSERT_COND
argument_list|(
name|p_FmPcd
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
argument_list|)
expr_stmt|;
name|FmUnregisterIntr
argument_list|(
name|p_FmPcd
operator|->
name|h_Fm
argument_list|,
name|e_FM_MOD_PRS
argument_list|,
literal|0
argument_list|,
name|e_FM_INTR_TYPE_ERR
argument_list|)
expr_stmt|;
comment|/* register even if no interrupts enabled, to allow future enablement */
name|FmUnregisterIntr
argument_list|(
name|p_FmPcd
operator|->
name|h_Fm
argument_list|,
name|e_FM_MOD_PRS
argument_list|,
literal|0
argument_list|,
name|e_FM_INTR_TYPE_NORMAL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|PrsEnable
parameter_list|(
name|t_FmPcd
modifier|*
name|p_FmPcd
parameter_list|)
block|{
name|struct
name|fman_prs_regs
modifier|*
name|PrsRegs
init|=
operator|(
expr|struct
name|fman_prs_regs
operator|*
operator|)
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|p_FmPcdPrsRegs
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_FmPcd
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
argument_list|)
expr_stmt|;
name|fman_prs_enable
argument_list|(
name|PrsRegs
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|PrsDisable
parameter_list|(
name|t_FmPcd
modifier|*
name|p_FmPcd
parameter_list|)
block|{
name|struct
name|fman_prs_regs
modifier|*
name|PrsRegs
init|=
operator|(
expr|struct
name|fman_prs_regs
operator|*
operator|)
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|p_FmPcdPrsRegs
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_FmPcd
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
argument_list|)
expr_stmt|;
name|fman_prs_disable
argument_list|(
name|PrsRegs
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|PrsIsEnabled
parameter_list|(
name|t_FmPcd
modifier|*
name|p_FmPcd
parameter_list|)
block|{
name|struct
name|fman_prs_regs
modifier|*
name|PrsRegs
init|=
operator|(
expr|struct
name|fman_prs_regs
operator|*
operator|)
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|p_FmPcdPrsRegs
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_FmPcd
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
argument_list|)
expr_stmt|;
return|return
name|fman_prs_is_enabled
argument_list|(
name|PrsRegs
argument_list|)
return|;
block|}
end_function

begin_function
name|t_Error
name|PrsIncludePortInStatistics
parameter_list|(
name|t_FmPcd
modifier|*
name|p_FmPcd
parameter_list|,
name|uint8_t
name|hardwarePortId
parameter_list|,
name|bool
name|include
parameter_list|)
block|{
name|struct
name|fman_prs_regs
modifier|*
name|PrsRegs
decl_stmt|;
name|uint32_t
name|bitMask
init|=
literal|0
decl_stmt|;
name|uint8_t
name|prsPortId
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|hardwarePortId
operator|>=
literal|1
operator|&&
name|hardwarePortId
operator|<=
literal|16
operator|)
argument_list|,
name|E_INVALID_VALUE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPrs
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|PrsRegs
operator|=
operator|(
expr|struct
name|fman_prs_regs
operator|*
operator|)
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|p_FmPcdPrsRegs
expr_stmt|;
name|GET_FM_PCD_PRS_PORT_ID
argument_list|(
name|prsPortId
argument_list|,
name|hardwarePortId
argument_list|)
expr_stmt|;
name|GET_FM_PCD_INDEX_FLAG
argument_list|(
name|bitMask
argument_list|,
name|prsPortId
argument_list|)
expr_stmt|;
if|if
condition|(
name|include
condition|)
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|fmPcdPrsPortIdStatistics
operator||=
name|bitMask
expr_stmt|;
else|else
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|fmPcdPrsPortIdStatistics
operator|&=
operator|~
name|bitMask
expr_stmt|;
name|fman_prs_set_stst_port_msk
argument_list|(
name|PrsRegs
argument_list|,
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|fmPcdPrsPortIdStatistics
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FmPcdPrsIncludePortInStatistics
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|uint8_t
name|hardwarePortId
parameter_list|,
name|bool
name|include
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|hardwarePortId
operator|>=
literal|1
operator|&&
name|hardwarePortId
operator|<=
literal|16
operator|)
argument_list|,
name|E_INVALID_VALUE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPrs
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_FmPcd
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|&&
name|p_FmPcd
operator|->
name|h_IpcSession
condition|)
block|{
name|t_FmPcdIpcPrsIncludePort
name|prsIncludePortParams
decl_stmt|;
name|t_FmPcdIpcMsg
name|msg
decl_stmt|;
name|prsIncludePortParams
operator|.
name|hardwarePortId
operator|=
name|hardwarePortId
expr_stmt|;
name|prsIncludePortParams
operator|.
name|include
operator|=
name|include
expr_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_PCD_PRS_INC_PORT_STATS
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|&
name|prsIncludePortParams
argument_list|,
sizeof|sizeof
argument_list|(
name|prsIncludePortParams
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_FmPcd
operator|->
name|h_IpcSession
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|prsIncludePortParams
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
elseif|else
if|if
condition|(
name|p_FmPcd
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"running in guest-mode without IPC!"
operator|)
argument_list|)
expr_stmt|;
return|return
name|PrsIncludePortInStatistics
argument_list|(
name|p_FmPcd
argument_list|,
name|hardwarePortId
argument_list|,
name|include
argument_list|)
return|;
block|}
end_function

begin_function
name|uint32_t
name|FmPcdGetSwPrsOffset
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|e_NetHeaderType
name|hdr
parameter_list|,
name|uint8_t
name|indexPerHdr
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|t_FmPcdPrsLabelParams
modifier|*
name|p_Label
decl_stmt|;
name|int
name|i
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_FmPcd
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
operator|!
name|p_FmPcd
operator|->
name|p_FmPcdDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_FmPcd
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|&&
name|p_FmPcd
operator|->
name|h_IpcSession
condition|)
block|{
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|t_FmPcdIpcSwPrsLable
name|labelParams
decl_stmt|;
name|t_FmPcdIpcMsg
name|msg
decl_stmt|;
name|uint32_t
name|prsOffset
init|=
literal|0
decl_stmt|;
name|t_FmPcdIpcReply
name|reply
decl_stmt|;
name|uint32_t
name|replyLength
decl_stmt|;
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|labelParams
operator|.
name|enumHdr
operator|=
operator|(
name|uint32_t
operator|)
name|hdr
expr_stmt|;
name|labelParams
operator|.
name|indexPerHdr
operator|=
name|indexPerHdr
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|FM_PCD_GET_SW_PRS_OFFSET
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|&
name|labelParams
argument_list|,
sizeof|sizeof
argument_list|(
name|labelParams
argument_list|)
argument_list|)
expr_stmt|;
name|replyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_FmPcd
operator|->
name|h_IpcSession
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|labelParams
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|replyLength
operator|!=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"IPC reply length mismatch"
operator|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|prsOffset
argument_list|,
name|reply
operator|.
name|replyBody
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|prsOffset
return|;
block|}
elseif|else
if|if
condition|(
name|p_FmPcd
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"running in guest-mode without IPC!"
operator|)
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|currLabel
operator|<
name|FM_PCD_PRS_NUM_OF_LABELS
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|currLabel
condition|;
name|i
operator|++
control|)
block|{
name|p_Label
operator|=
operator|&
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|labelsTable
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|(
name|hdr
operator|==
name|p_Label
operator|->
name|hdr
operator|)
operator|&&
operator|(
name|indexPerHdr
operator|==
name|p_Label
operator|->
name|indexPerHdr
operator|)
condition|)
return|return
name|p_Label
operator|->
name|instructionOffset
return|;
block|}
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_FOUND
argument_list|,
operator|(
literal|"Sw Parser attachment Not found"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|uint32_t
operator|)
name|ILLEGAL_BASE
return|;
block|}
end_function

begin_function
name|void
name|FM_PCD_SetPrsStatistics
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|struct
name|fman_prs_regs
modifier|*
name|PrsRegs
decl_stmt|;
name|SANITY_CHECK_RETURN
argument_list|(
name|p_FmPcd
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPrs
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|PrsRegs
operator|=
operator|(
expr|struct
name|fman_prs_regs
operator|*
operator|)
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|p_FmPcdPrsRegs
expr_stmt|;
if|if
condition|(
name|p_FmPcd
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"FM_PCD_SetPrsStatistics - guest mode!"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|fman_prs_set_stst
argument_list|(
name|PrsRegs
argument_list|,
name|enable
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|t_Error
name|FM_PCD_PrsLoadSw
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|t_FmPcdPrsSwParams
modifier|*
name|p_SwPrs
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|uint32_t
modifier|*
name|p_LoadTarget
decl_stmt|;
name|uint32_t
modifier|*
name|p_TmpCode
decl_stmt|;
name|int
name|i
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_FmPcd
operator|->
name|p_FmPcdDriverParam
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdPrs
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_SwPrs
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_FmPcd
operator|->
name|enabled
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_FmPcd
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"FM in guest-mode!"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_SwPrs
operator|->
name|override
condition|)
block|{
if|if
condition|(
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|p_CurrSwPrs
operator|>
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|p_SwPrsCode
operator|+
name|p_SwPrs
operator|->
name|base
operator|*
literal|2
operator|/
literal|4
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"SW parser base must be larger than current loaded code"
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|currLabel
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|p_SwPrs
operator|->
name|size
operator|>
name|FM_PCD_SW_PRS_SIZE
operator|-
name|FM_PCD_PRS_SW_TAIL_SIZE
operator|-
name|p_SwPrs
operator|->
name|base
operator|*
literal|2
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"p_SwPrs->size may not be larger than MAX_SW_PRS_CODE_SIZE"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|currLabel
operator|+
name|p_SwPrs
operator|->
name|numOfLabels
operator|>
name|FM_PCD_PRS_NUM_OF_LABELS
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Exceeded number of labels allowed "
operator|)
argument_list|)
expr_stmt|;
name|p_TmpCode
operator|=
operator|(
name|uint32_t
operator|*
operator|)
name|XX_MallocSmart
argument_list|(
name|ROUND_UP
argument_list|(
name|p_SwPrs
operator|->
name|size
argument_list|,
literal|4
argument_list|)
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_TmpCode
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"Tmp Sw-Parser code allocation FAILED"
operator|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
name|p_TmpCode
argument_list|,
literal|0
argument_list|,
name|ROUND_UP
argument_list|(
name|p_SwPrs
operator|->
name|size
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
name|p_TmpCode
argument_list|,
name|p_SwPrs
operator|->
name|p_Code
argument_list|,
name|p_SwPrs
operator|->
name|size
argument_list|)
expr_stmt|;
comment|/* save sw parser labels */
name|memcpy
argument_list|(
operator|&
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|labelsTable
index|[
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|currLabel
index|]
argument_list|,
name|p_SwPrs
operator|->
name|labelsTable
argument_list|,
name|p_SwPrs
operator|->
name|numOfLabels
operator|*
sizeof|sizeof
argument_list|(
name|t_FmPcdPrsLabelParams
argument_list|)
argument_list|)
expr_stmt|;
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|currLabel
operator|+=
name|p_SwPrs
operator|->
name|numOfLabels
expr_stmt|;
comment|/* load sw parser code */
name|p_LoadTarget
operator|=
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|p_SwPrsCode
operator|+
name|p_SwPrs
operator|->
name|base
operator|*
literal|2
operator|/
literal|4
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DIV_CEIL
argument_list|(
name|p_SwPrs
operator|->
name|size
argument_list|,
literal|4
argument_list|)
condition|;
name|i
operator|++
control|)
name|WRITE_UINT32
argument_list|(
name|p_LoadTarget
index|[
name|i
index|]
argument_list|,
name|GET_UINT32
argument_list|(
name|p_TmpCode
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|p_CurrSwPrs
operator|=
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|p_SwPrsCode
operator|+
name|p_SwPrs
operator|->
name|base
operator|*
literal|2
operator|/
literal|4
operator|+
name|ROUND_UP
argument_list|(
name|p_SwPrs
operator|->
name|size
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* copy data parameters */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|FM_PCD_PRS_NUM_OF_HDRS
condition|;
name|i
operator|++
control|)
name|WRITE_UINT32
argument_list|(
operator|*
operator|(
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|p_SwPrsCode
operator|+
name|PRS_SW_DATA
operator|/
literal|4
operator|+
name|i
operator|)
argument_list|,
name|p_SwPrs
operator|->
name|swPrsDataParams
index|[
name|i
index|]
argument_list|)
expr_stmt|;
comment|/* Clear last 4 bytes */
name|WRITE_UINT32
argument_list|(
operator|*
operator|(
name|p_FmPcd
operator|->
name|p_FmPcdPrs
operator|->
name|p_SwPrsCode
operator|+
operator|(
name|PRS_SW_DATA
operator|-
name|FM_PCD_PRS_SW_TAIL_SIZE
operator|)
operator|/
literal|4
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_TmpCode
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|FM_PCD_ConfigPrsMaxCycleLimit
parameter_list|(
name|t_Handle
name|h_FmPcd
parameter_list|,
name|uint16_t
name|value
parameter_list|)
block|{
name|t_FmPcd
modifier|*
name|p_FmPcd
init|=
operator|(
name|t_FmPcd
operator|*
operator|)
name|h_FmPcd
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_FmPcd
operator|->
name|p_FmPcdDriverParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_FmPcd
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"FM_PCD_ConfigPrsMaxCycleLimit - guest mode!"
operator|)
argument_list|)
expr_stmt|;
name|p_FmPcd
operator|->
name|p_FmPcdDriverParam
operator|->
name|prsMaxParseCycleLimit
operator|=
name|value
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

end_unit


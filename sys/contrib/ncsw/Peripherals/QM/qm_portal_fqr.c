begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************   Â© 1995-2003, 2004, 2005-2011 Freescale Semiconductor, Inc.  All rights reserved.   This is proprietary source code of Freescale Semiconductor Inc.,  and its use is subject to the NetComm Device Drivers EULA.  The copyright notice above does not evidence any actual or intended  publication of such source code.   ALTERNATIVELY, redistribution and use in source and binary forms, with  or without modification, are permitted provided that the following  conditions are met:      * Redistributions of source code must retain the above copyright        notice, this list of conditions and the following disclaimer.      * Redistributions in binary form must reproduce the above copyright        notice, this list of conditions and the following disclaimer in the        documentation and/or other materials provided with the distribution.      * Neither the name of Freescale Semiconductor nor the        names of its contributors may be used to endorse or promote products        derived from this software without specific prior written permission.   THIS SOFTWARE IS PROVIDED BY Freescale Semiconductor ``AS IS'' AND ANY  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  DISCLAIMED. IN NO EVENT SHALL Freescale Semiconductor BE LIABLE FOR ANY  DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES  (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND  ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *   **************************************************************************/
end_comment

begin_comment
comment|/******************************************************************************  @File          qm.c   @Description   QM& Portal implementation */
end_comment

begin_comment
comment|/***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<machine/atomic.h>
end_include

begin_include
include|#
directive|include
file|"error_ext.h"
end_include

begin_include
include|#
directive|include
file|"std_ext.h"
end_include

begin_include
include|#
directive|include
file|"string_ext.h"
end_include

begin_include
include|#
directive|include
file|"mm_ext.h"
end_include

begin_include
include|#
directive|include
file|"qm.h"
end_include

begin_include
include|#
directive|include
file|"qman_low.h"
end_include

begin_include
include|#
directive|include
file|<machine/vmparam.h>
end_include

begin_comment
comment|/****************************************/
end_comment

begin_comment
comment|/*       static functions               */
end_comment

begin_comment
comment|/****************************************/
end_comment

begin_define
define|#
directive|define
name|SLOW_POLL_IDLE
value|1000
end_define

begin_define
define|#
directive|define
name|SLOW_POLL_BUSY
value|10
end_define

begin_comment
comment|/*  * Context entries are 32-bit.  The qman driver uses the pointer to the queue as  * its context, and the pointer is 64-byte aligned, per the XX_MallocSmart()  * call.  Take advantage of this fact to shove a 64-bit kernel pointer into a  * 32-bit context integer, and back.  *  * XXX: This depends on the fact that VM_MAX_KERNEL_ADDRESS is less than 38-bit  * count from VM_MIN_KERNEL_ADDRESS.  If this ever changes, this needs to be  * updated.  */
end_comment

begin_expr_stmt
name|CTASSERT
argument_list|(
operator|(
name|VM_MAX_KERNEL_ADDRESS
operator|-
name|VM_MIN_KERNEL_ADDRESS
operator|)
operator|<
operator|(
literal|1ULL
operator|<<
literal|35
operator|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
specifier|inline
name|uint32_t
name|aligned_int_from_ptr
parameter_list|(
specifier|const
name|void
modifier|*
name|p
parameter_list|)
block|{
name|uintptr_t
name|ctx
decl_stmt|;
name|ctx
operator|=
operator|(
name|uintptr_t
operator|)
name|p
expr_stmt|;
name|KASSERT
argument_list|(
name|ctx
operator|>=
name|VM_MIN_KERNEL_ADDRESS
argument_list|,
operator|(
literal|"%p is too low!\n"
operator|,
name|p
operator|)
argument_list|)
expr_stmt|;
name|ctx
operator|-=
name|VM_MIN_KERNEL_ADDRESS
expr_stmt|;
name|KASSERT
argument_list|(
operator|(
name|ctx
operator|&
literal|0x07
operator|)
operator|==
literal|0
argument_list|,
operator|(
literal|"Pointer %p is not 8-byte aligned!\n"
operator|,
name|p
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ctx
operator|&
operator|(
literal|0x7
operator|)
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
name|ctx
operator|>>
literal|3
operator|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
modifier|*
name|ptr_from_aligned_int
parameter_list|(
name|uint32_t
name|ctx
parameter_list|)
block|{
name|uintptr_t
name|p
decl_stmt|;
name|p
operator|=
name|VM_MIN_KERNEL_ADDRESS
operator|+
operator|(
name|ctx
operator|<<
literal|3
operator|)
expr_stmt|;
return|return
operator|(
operator|(
name|void
operator|*
operator|)
name|p
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|qman_volatile_dequeue
parameter_list|(
name|t_QmPortal
modifier|*
name|p_QmPortal
parameter_list|,
name|struct
name|qman_fq
modifier|*
name|p_Fq
parameter_list|,
name|uint32_t
name|vdqcr
parameter_list|)
block|{
name|ASSERT_COND
argument_list|(
operator|(
name|p_Fq
operator|->
name|state
operator|==
name|qman_fq_state_parked
operator|)
operator|||
operator|(
name|p_Fq
operator|->
name|state
operator|==
name|qman_fq_state_retired
operator|)
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
operator|!
operator|(
name|vdqcr
operator|&
name|QM_VDQCR_FQID_MASK
operator|)
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
operator|!
operator|(
name|p_Fq
operator|->
name|flags
operator|&
name|QMAN_FQ_STATE_VDQCR
operator|)
argument_list|)
expr_stmt|;
name|vdqcr
operator|=
operator|(
name|vdqcr
operator|&
operator|~
name|QM_VDQCR_FQID_MASK
operator|)
operator||
name|p_Fq
operator|->
name|fqid
expr_stmt|;
name|NCSW_PLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|FQLOCK
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
name|p_Fq
operator|->
name|flags
operator||=
name|QMAN_FQ_STATE_VDQCR
expr_stmt|;
name|qm_dqrr_vdqcr_set
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|vdqcr
argument_list|)
expr_stmt|;
name|FQUNLOCK
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|mcr_result_str
parameter_list|(
name|uint8_t
name|result
parameter_list|)
block|{
switch|switch
condition|(
name|result
condition|)
block|{
case|case
name|QM_MCR_RESULT_NULL
case|:
return|return
literal|"QM_MCR_RESULT_NULL"
return|;
case|case
name|QM_MCR_RESULT_OK
case|:
return|return
literal|"QM_MCR_RESULT_OK"
return|;
case|case
name|QM_MCR_RESULT_ERR_FQID
case|:
return|return
literal|"QM_MCR_RESULT_ERR_FQID"
return|;
case|case
name|QM_MCR_RESULT_ERR_FQSTATE
case|:
return|return
literal|"QM_MCR_RESULT_ERR_FQSTATE"
return|;
case|case
name|QM_MCR_RESULT_ERR_NOTEMPTY
case|:
return|return
literal|"QM_MCR_RESULT_ERR_NOTEMPTY"
return|;
case|case
name|QM_MCR_RESULT_PENDING
case|:
return|return
literal|"QM_MCR_RESULT_PENDING"
return|;
block|}
return|return
literal|"<unknown MCR result>"
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|qman_create_fq
parameter_list|(
name|t_QmPortal
modifier|*
name|p_QmPortal
parameter_list|,
name|uint32_t
name|fqid
parameter_list|,
name|uint32_t
name|flags
parameter_list|,
name|struct
name|qman_fq
modifier|*
name|p_Fq
parameter_list|)
block|{
name|struct
name|qm_fqd
name|fqd
decl_stmt|;
name|struct
name|qm_mcr_queryfq_np
name|np
decl_stmt|;
name|struct
name|qm_mc_command
modifier|*
name|p_Mcc
decl_stmt|;
name|struct
name|qm_mc_result
modifier|*
name|p_Mcr
decl_stmt|;
name|p_Fq
operator|->
name|fqid
operator|=
name|fqid
expr_stmt|;
name|p_Fq
operator|->
name|flags
operator|=
name|flags
expr_stmt|;
name|p_Fq
operator|->
name|state
operator|=
name|qman_fq_state_oos
expr_stmt|;
name|p_Fq
operator|->
name|cgr_groupid
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|QMAN_FQ_FLAG_RECOVER
operator|)
operator|||
operator|(
name|flags
operator|&
name|QMAN_FQ_FLAG_NO_MODIFY
operator|)
condition|)
return|return
name|E_OK
return|;
comment|/* Everything else is RECOVER support */
name|NCSW_PLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|p_Mcc
operator|=
name|qm_mc_start
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|p_Mcc
operator|->
name|queryfq
operator|.
name|fqid
operator|=
name|fqid
expr_stmt|;
name|qm_mc_commit
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|QM_MCC_VERB_QUERYFQ
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|p_Mcr
operator|=
name|qm_mc_result
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
operator|)
condition|)
empty_stmt|;
name|ASSERT_COND
argument_list|(
operator|(
name|p_Mcr
operator|->
name|verb
operator|&
name|QM_MCR_VERB_MASK
operator|)
operator|==
name|QM_MCC_VERB_QUERYFQ
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Mcr
operator|->
name|result
operator|!=
name|QM_MCR_RESULT_OK
condition|)
block|{
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"QUERYFQ failed: %s"
operator|,
name|mcr_result_str
argument_list|(
name|p_Mcr
operator|->
name|result
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
name|fqd
operator|=
name|p_Mcr
operator|->
name|queryfq
operator|.
name|fqd
expr_stmt|;
name|p_Mcc
operator|=
name|qm_mc_start
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|p_Mcc
operator|->
name|queryfq_np
operator|.
name|fqid
operator|=
name|fqid
expr_stmt|;
name|qm_mc_commit
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|QM_MCC_VERB_QUERYFQ_NP
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|p_Mcr
operator|=
name|qm_mc_result
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
operator|)
condition|)
empty_stmt|;
name|ASSERT_COND
argument_list|(
operator|(
name|p_Mcr
operator|->
name|verb
operator|&
name|QM_MCR_VERB_MASK
operator|)
operator|==
name|QM_MCC_VERB_QUERYFQ_NP
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Mcr
operator|->
name|result
operator|!=
name|QM_MCR_RESULT_OK
condition|)
block|{
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"UERYFQ_NP failed: %s"
operator|,
name|mcr_result_str
argument_list|(
name|p_Mcr
operator|->
name|result
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
name|np
operator|=
name|p_Mcr
operator|->
name|queryfq_np
expr_stmt|;
comment|/* Phew, have queryfq and queryfq_np results, stitch together      * the FQ object from those. */
name|p_Fq
operator|->
name|cgr_groupid
operator|=
name|fqd
operator|.
name|cgid
expr_stmt|;
switch|switch
condition|(
name|np
operator|.
name|state
operator|&
name|QM_MCR_NP_STATE_MASK
condition|)
block|{
case|case
name|QM_MCR_NP_STATE_OOS
case|:
break|break;
case|case
name|QM_MCR_NP_STATE_RETIRED
case|:
name|p_Fq
operator|->
name|state
operator|=
name|qman_fq_state_retired
expr_stmt|;
if|if
condition|(
name|np
operator|.
name|frm_cnt
condition|)
name|p_Fq
operator|->
name|flags
operator||=
name|QMAN_FQ_STATE_NE
expr_stmt|;
break|break;
case|case
name|QM_MCR_NP_STATE_TEN_SCHED
case|:
case|case
name|QM_MCR_NP_STATE_TRU_SCHED
case|:
case|case
name|QM_MCR_NP_STATE_ACTIVE
case|:
name|p_Fq
operator|->
name|state
operator|=
name|qman_fq_state_sched
expr_stmt|;
if|if
condition|(
name|np
operator|.
name|state
operator|&
name|QM_MCR_NP_STATE_R
condition|)
name|p_Fq
operator|->
name|flags
operator||=
name|QMAN_FQ_STATE_CHANGING
expr_stmt|;
break|break;
case|case
name|QM_MCR_NP_STATE_PARKED
case|:
name|p_Fq
operator|->
name|state
operator|=
name|qman_fq_state_parked
expr_stmt|;
break|break;
default|default:
name|ASSERT_COND
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fqd
operator|.
name|fq_ctrl
operator|&
name|QM_FQCTRL_CGE
condition|)
name|p_Fq
operator|->
name|state
operator||=
name|QMAN_FQ_STATE_CGR_EN
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qman_destroy_fq
parameter_list|(
name|struct
name|qman_fq
modifier|*
name|p_Fq
parameter_list|,
name|uint32_t
name|flags
parameter_list|)
block|{
comment|/* We don't need to lock the FQ as it is a pre-condition that the FQ be      * quiesced. Instead, run some checks. */
name|UNUSED
argument_list|(
name|flags
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|p_Fq
operator|->
name|state
condition|)
block|{
case|case
name|qman_fq_state_parked
case|:
name|ASSERT_COND
argument_list|(
name|flags
operator|&
name|QMAN_FQ_DESTROY_PARKED
argument_list|)
expr_stmt|;
case|case
name|qman_fq_state_oos
case|:
return|return;
default|default:
break|break;
block|}
name|ASSERT_COND
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|qman_init_fq
parameter_list|(
name|t_QmPortal
modifier|*
name|p_QmPortal
parameter_list|,
name|struct
name|qman_fq
modifier|*
name|p_Fq
parameter_list|,
name|uint32_t
name|flags
parameter_list|,
name|struct
name|qm_mcc_initfq
modifier|*
name|p_Opts
parameter_list|)
block|{
name|struct
name|qm_mc_command
modifier|*
name|p_Mcc
decl_stmt|;
name|struct
name|qm_mc_result
modifier|*
name|p_Mcr
decl_stmt|;
name|uint8_t
name|res
decl_stmt|,
name|myverb
init|=
call|(
name|uint8_t
call|)
argument_list|(
operator|(
name|flags
operator|&
name|QMAN_INITFQ_FLAG_SCHED
operator|)
condition|?
name|QM_MCC_VERB_INITFQ_SCHED
else|:
name|QM_MCC_VERB_INITFQ_PARKED
argument_list|)
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fq
operator|->
name|state
operator|==
name|qman_fq_state_oos
operator|)
operator|||
operator|(
name|p_Fq
operator|->
name|state
operator|==
name|qman_fq_state_parked
operator|)
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fq
operator|->
name|flags
operator|&
name|QMAN_FQ_FLAG_NO_MODIFY
condition|)
return|return
name|ERROR_CODE
argument_list|(
name|E_INVALID_VALUE
argument_list|)
return|;
comment|/* Issue an INITFQ_[PARKED|SCHED] management command */
name|NCSW_PLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|FQLOCK
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Fq
operator|->
name|flags
operator|&
name|QMAN_FQ_STATE_CHANGING
operator|)
operator|||
operator|(
operator|(
name|p_Fq
operator|->
name|state
operator|!=
name|qman_fq_state_oos
operator|)
operator|&&
operator|(
name|p_Fq
operator|->
name|state
operator|!=
name|qman_fq_state_parked
operator|)
operator|)
condition|)
block|{
name|FQUNLOCK
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
return|return
name|ERROR_CODE
argument_list|(
name|E_BUSY
argument_list|)
return|;
block|}
name|p_Mcc
operator|=
name|qm_mc_start
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|Mem2IOCpy32
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|&
name|p_Mcc
operator|->
name|initfq
argument_list|,
name|p_Opts
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|qm_mcc_initfq
argument_list|)
argument_list|)
expr_stmt|;
name|qm_mc_commit
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|myverb
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|p_Mcr
operator|=
name|qm_mc_result
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
operator|)
condition|)
empty_stmt|;
name|ASSERT_COND
argument_list|(
operator|(
name|p_Mcr
operator|->
name|verb
operator|&
name|QM_MCR_VERB_MASK
operator|)
operator|==
name|myverb
argument_list|)
expr_stmt|;
name|res
operator|=
name|p_Mcr
operator|->
name|result
expr_stmt|;
if|if
condition|(
name|res
operator|!=
name|QM_MCR_RESULT_OK
condition|)
block|{
name|FQUNLOCK
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"INITFQ failed: %s"
operator|,
name|mcr_result_str
argument_list|(
name|res
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p_Mcc
operator|->
name|initfq
operator|.
name|we_mask
operator|&
name|QM_INITFQ_WE_FQCTRL
condition|)
block|{
if|if
condition|(
name|p_Mcc
operator|->
name|initfq
operator|.
name|fqd
operator|.
name|fq_ctrl
operator|&
name|QM_FQCTRL_CGE
condition|)
name|p_Fq
operator|->
name|flags
operator||=
name|QMAN_FQ_STATE_CGR_EN
expr_stmt|;
else|else
name|p_Fq
operator|->
name|flags
operator|&=
operator|~
name|QMAN_FQ_STATE_CGR_EN
expr_stmt|;
block|}
if|if
condition|(
name|p_Mcc
operator|->
name|initfq
operator|.
name|we_mask
operator|&
name|QM_INITFQ_WE_CGID
condition|)
name|p_Fq
operator|->
name|cgr_groupid
operator|=
name|p_Mcc
operator|->
name|initfq
operator|.
name|fqd
operator|.
name|cgid
expr_stmt|;
name|p_Fq
operator|->
name|state
operator|=
operator|(
name|flags
operator|&
name|QMAN_INITFQ_FLAG_SCHED
operator|)
condition|?
name|qman_fq_state_sched
else|:
name|qman_fq_state_parked
expr_stmt|;
name|FQUNLOCK
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|qman_retire_fq
parameter_list|(
name|t_QmPortal
modifier|*
name|p_QmPortal
parameter_list|,
name|struct
name|qman_fq
modifier|*
name|p_Fq
parameter_list|,
name|uint32_t
modifier|*
name|p_Flags
parameter_list|,
name|bool
name|drain
parameter_list|)
block|{
name|struct
name|qm_mc_command
modifier|*
name|p_Mcc
decl_stmt|;
name|struct
name|qm_mc_result
modifier|*
name|p_Mcr
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|uint8_t
name|res
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_Fq
operator|->
name|state
operator|==
name|qman_fq_state_parked
operator|)
operator|||
operator|(
name|p_Fq
operator|->
name|state
operator|==
name|qman_fq_state_sched
operator|)
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fq
operator|->
name|flags
operator|&
name|QMAN_FQ_FLAG_NO_MODIFY
condition|)
return|return
name|E_INVALID_VALUE
return|;
name|NCSW_PLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|FQLOCK
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Fq
operator|->
name|flags
operator|&
name|QMAN_FQ_STATE_CHANGING
operator|)
operator|||
operator|(
name|p_Fq
operator|->
name|state
operator|==
name|qman_fq_state_retired
operator|)
operator|||
operator|(
name|p_Fq
operator|->
name|state
operator|==
name|qman_fq_state_oos
operator|)
condition|)
block|{
name|err
operator|=
name|E_BUSY
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|p_Mcc
operator|=
name|qm_mc_start
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|p_Mcc
operator|->
name|alterfq
operator|.
name|fqid
operator|=
name|p_Fq
operator|->
name|fqid
expr_stmt|;
if|if
condition|(
name|drain
condition|)
name|p_Mcc
operator|->
name|alterfq
operator|.
name|context_b
operator|=
name|aligned_int_from_ptr
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
name|qm_mc_commit
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
call|(
name|uint8_t
call|)
argument_list|(
operator|(
name|drain
operator|)
condition|?
name|QM_MCC_VERB_ALTER_RETIRE_CTXB
else|:
name|QM_MCC_VERB_ALTER_RETIRE
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|p_Mcr
operator|=
name|qm_mc_result
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
operator|)
condition|)
empty_stmt|;
name|ASSERT_COND
argument_list|(
operator|(
name|p_Mcr
operator|->
name|verb
operator|&
name|QM_MCR_VERB_MASK
operator|)
operator|==
operator|(
name|drain
operator|)
condition|?
name|QM_MCR_VERB_ALTER_RETIRE_CTXB
else|:
name|QM_MCR_VERB_ALTER_RETIRE
argument_list|)
expr_stmt|;
name|res
operator|=
name|p_Mcr
operator|->
name|result
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|QM_MCR_RESULT_OK
condition|)
block|{
comment|/* Process 'fq' right away, we'll ignore FQRNI */
if|if
condition|(
name|p_Mcr
operator|->
name|alterfq
operator|.
name|fqs
operator|&
name|QM_MCR_FQS_NOTEMPTY
condition|)
name|p_Fq
operator|->
name|flags
operator||=
name|QMAN_FQ_STATE_NE
expr_stmt|;
if|if
condition|(
name|p_Mcr
operator|->
name|alterfq
operator|.
name|fqs
operator|&
name|QM_MCR_FQS_ORLPRESENT
condition|)
name|p_Fq
operator|->
name|flags
operator||=
name|QMAN_FQ_STATE_ORL
expr_stmt|;
name|p_Fq
operator|->
name|state
operator|=
name|qman_fq_state_retired
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|res
operator|==
name|QM_MCR_RESULT_PENDING
condition|)
name|p_Fq
operator|->
name|flags
operator||=
name|QMAN_FQ_STATE_CHANGING
expr_stmt|;
else|else
block|{
name|XX_Print
argument_list|(
literal|"ALTER_RETIRE failed: %s\n"
argument_list|,
name|mcr_result_str
argument_list|(
name|res
argument_list|)
argument_list|)
expr_stmt|;
name|err
operator|=
name|E_INVALID_STATE
expr_stmt|;
block|}
if|if
condition|(
name|p_Flags
condition|)
operator|*
name|p_Flags
operator|=
name|p_Fq
operator|->
name|flags
expr_stmt|;
name|out
label|:
name|FQUNLOCK
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|qman_oos_fq
parameter_list|(
name|t_QmPortal
modifier|*
name|p_QmPortal
parameter_list|,
name|struct
name|qman_fq
modifier|*
name|p_Fq
parameter_list|)
block|{
name|struct
name|qm_mc_command
modifier|*
name|p_Mcc
decl_stmt|;
name|struct
name|qm_mc_result
modifier|*
name|p_Mcr
decl_stmt|;
name|uint8_t
name|res
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Fq
operator|->
name|state
operator|==
name|qman_fq_state_retired
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fq
operator|->
name|flags
operator|&
name|QMAN_FQ_FLAG_NO_MODIFY
condition|)
return|return
name|ERROR_CODE
argument_list|(
name|E_INVALID_VALUE
argument_list|)
return|;
name|NCSW_PLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|FQLOCK
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Fq
operator|->
name|flags
operator|&
name|QMAN_FQ_STATE_BLOCKOOS
operator|)
operator|||
operator|(
name|p_Fq
operator|->
name|state
operator|!=
name|qman_fq_state_retired
operator|)
condition|)
block|{
name|FQUNLOCK
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
return|return
name|ERROR_CODE
argument_list|(
name|E_BUSY
argument_list|)
return|;
block|}
name|p_Mcc
operator|=
name|qm_mc_start
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|p_Mcc
operator|->
name|alterfq
operator|.
name|fqid
operator|=
name|p_Fq
operator|->
name|fqid
expr_stmt|;
name|qm_mc_commit
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|QM_MCC_VERB_ALTER_OOS
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|p_Mcr
operator|=
name|qm_mc_result
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
operator|)
condition|)
empty_stmt|;
name|ASSERT_COND
argument_list|(
operator|(
name|p_Mcr
operator|->
name|verb
operator|&
name|QM_MCR_VERB_MASK
operator|)
operator|==
name|QM_MCR_VERB_ALTER_OOS
argument_list|)
expr_stmt|;
name|res
operator|=
name|p_Mcr
operator|->
name|result
expr_stmt|;
if|if
condition|(
name|res
operator|!=
name|QM_MCR_RESULT_OK
condition|)
block|{
name|FQUNLOCK
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"ALTER_OOS failed: %s\n"
operator|,
name|mcr_result_str
argument_list|(
name|res
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
name|p_Fq
operator|->
name|state
operator|=
name|qman_fq_state_oos
expr_stmt|;
name|FQUNLOCK
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|qman_schedule_fq
parameter_list|(
name|t_QmPortal
modifier|*
name|p_QmPortal
parameter_list|,
name|struct
name|qman_fq
modifier|*
name|p_Fq
parameter_list|)
block|{
name|struct
name|qm_mc_command
modifier|*
name|p_Mcc
decl_stmt|;
name|struct
name|qm_mc_result
modifier|*
name|p_Mcr
decl_stmt|;
name|uint8_t
name|res
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Fq
operator|->
name|state
operator|==
name|qman_fq_state_parked
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fq
operator|->
name|flags
operator|&
name|QMAN_FQ_FLAG_NO_MODIFY
condition|)
return|return
name|ERROR_CODE
argument_list|(
name|E_INVALID_VALUE
argument_list|)
return|;
comment|/* Issue a ALTERFQ_SCHED management command */
name|NCSW_PLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|FQLOCK
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Fq
operator|->
name|flags
operator|&
name|QMAN_FQ_STATE_CHANGING
operator|)
operator|||
operator|(
name|p_Fq
operator|->
name|state
operator|!=
name|qman_fq_state_parked
operator|)
condition|)
block|{
name|FQUNLOCK
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
return|return
name|ERROR_CODE
argument_list|(
name|E_BUSY
argument_list|)
return|;
block|}
name|p_Mcc
operator|=
name|qm_mc_start
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|p_Mcc
operator|->
name|alterfq
operator|.
name|fqid
operator|=
name|p_Fq
operator|->
name|fqid
expr_stmt|;
name|qm_mc_commit
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|QM_MCC_VERB_ALTER_SCHED
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|p_Mcr
operator|=
name|qm_mc_result
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
operator|)
condition|)
empty_stmt|;
name|ASSERT_COND
argument_list|(
operator|(
name|p_Mcr
operator|->
name|verb
operator|&
name|QM_MCR_VERB_MASK
operator|)
operator|==
name|QM_MCR_VERB_ALTER_SCHED
argument_list|)
expr_stmt|;
name|res
operator|=
name|p_Mcr
operator|->
name|result
expr_stmt|;
if|if
condition|(
name|res
operator|!=
name|QM_MCR_RESULT_OK
condition|)
block|{
name|FQUNLOCK
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"ALTER_SCHED failed: %s\n"
operator|,
name|mcr_result_str
argument_list|(
name|res
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
name|p_Fq
operator|->
name|state
operator|=
name|qman_fq_state_sched
expr_stmt|;
name|FQUNLOCK
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/* Inline helper to reduce nesting in LoopMessageRing() */
end_comment

begin_function
specifier|static
name|__inline__
name|void
name|fq_state_change
parameter_list|(
name|struct
name|qman_fq
modifier|*
name|p_Fq
parameter_list|,
name|struct
name|qm_mr_entry
modifier|*
name|p_Msg
parameter_list|,
name|uint8_t
name|verb
parameter_list|)
block|{
name|FQLOCK
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|verb
condition|)
block|{
case|case
name|QM_MR_VERB_FQRL
case|:
name|ASSERT_COND
argument_list|(
name|p_Fq
operator|->
name|flags
operator|&
name|QMAN_FQ_STATE_ORL
argument_list|)
expr_stmt|;
name|p_Fq
operator|->
name|flags
operator|&=
operator|~
name|QMAN_FQ_STATE_ORL
expr_stmt|;
break|break;
case|case
name|QM_MR_VERB_FQRN
case|:
name|ASSERT_COND
argument_list|(
operator|(
name|p_Fq
operator|->
name|state
operator|==
name|qman_fq_state_parked
operator|)
operator|||
operator|(
name|p_Fq
operator|->
name|state
operator|==
name|qman_fq_state_sched
operator|)
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Fq
operator|->
name|flags
operator|&
name|QMAN_FQ_STATE_CHANGING
argument_list|)
expr_stmt|;
name|p_Fq
operator|->
name|flags
operator|&=
operator|~
name|QMAN_FQ_STATE_CHANGING
expr_stmt|;
if|if
condition|(
name|p_Msg
operator|->
name|fq
operator|.
name|fqs
operator|&
name|QM_MR_FQS_NOTEMPTY
condition|)
name|p_Fq
operator|->
name|flags
operator||=
name|QMAN_FQ_STATE_NE
expr_stmt|;
if|if
condition|(
name|p_Msg
operator|->
name|fq
operator|.
name|fqs
operator|&
name|QM_MR_FQS_ORLPRESENT
condition|)
name|p_Fq
operator|->
name|flags
operator||=
name|QMAN_FQ_STATE_ORL
expr_stmt|;
name|p_Fq
operator|->
name|state
operator|=
name|qman_fq_state_retired
expr_stmt|;
break|break;
case|case
name|QM_MR_VERB_FQPN
case|:
name|ASSERT_COND
argument_list|(
name|p_Fq
operator|->
name|state
operator|==
name|qman_fq_state_sched
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Fq
operator|->
name|flags
operator|&
name|QMAN_FQ_STATE_CHANGING
argument_list|)
expr_stmt|;
name|p_Fq
operator|->
name|state
operator|=
name|qman_fq_state_parked
expr_stmt|;
block|}
name|FQUNLOCK
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|freeDrainedFq
parameter_list|(
name|struct
name|qman_fq
modifier|*
name|p_Fq
parameter_list|)
block|{
name|t_QmFqr
modifier|*
name|p_QmFqr
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
name|p_QmFqr
operator|=
operator|(
name|t_QmFqr
operator|*
operator|)
name|p_Fq
operator|->
name|h_QmFqr
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|p_QmFqr
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
operator|!
name|p_QmFqr
operator|->
name|p_DrainedFqs
index|[
name|p_Fq
operator|->
name|fqidOffset
index|]
argument_list|)
expr_stmt|;
name|p_QmFqr
operator|->
name|p_DrainedFqs
index|[
name|p_Fq
operator|->
name|fqidOffset
index|]
operator|=
name|TRUE
expr_stmt|;
name|p_QmFqr
operator|->
name|numOfDrainedFqids
operator|++
expr_stmt|;
if|if
condition|(
name|p_QmFqr
operator|->
name|numOfDrainedFqids
operator|==
name|p_QmFqr
operator|->
name|numOfFqids
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p_QmFqr
operator|->
name|numOfFqids
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|p_QmFqr
operator|->
name|p_Fqs
index|[
name|i
index|]
operator|->
name|state
operator|==
name|qman_fq_state_retired
operator|)
operator|&&
operator|(
name|qman_oos_fq
argument_list|(
name|p_QmFqr
operator|->
name|h_QmPortal
argument_list|,
name|p_QmFqr
operator|->
name|p_Fqs
index|[
name|i
index|]
argument_list|)
operator|!=
name|E_OK
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"qman_oos_fq() failed!"
operator|)
argument_list|)
expr_stmt|;
name|qman_destroy_fq
argument_list|(
name|p_QmFqr
operator|->
name|p_Fqs
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_QmFqr
operator|->
name|p_Fqs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|XX_Free
argument_list|(
name|p_QmFqr
operator|->
name|p_DrainedFqs
argument_list|)
expr_stmt|;
name|p_QmFqr
operator|->
name|p_DrainedFqs
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|p_QmFqr
operator|->
name|f_CompletionCB
condition|)
block|{
name|p_QmFqr
operator|->
name|f_CompletionCB
argument_list|(
name|p_QmFqr
operator|->
name|h_App
argument_list|,
name|p_QmFqr
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_QmFqr
operator|->
name|p_Fqs
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_QmFqr
operator|->
name|fqidBase
condition|)
name|QmFqidPut
argument_list|(
name|p_QmFqr
operator|->
name|h_Qm
argument_list|,
name|p_QmFqr
operator|->
name|fqidBase
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_QmFqr
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|drainRetiredFq
parameter_list|(
name|struct
name|qman_fq
modifier|*
name|p_Fq
parameter_list|)
block|{
name|t_QmFqr
modifier|*
name|p_QmFqr
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
name|p_QmFqr
operator|=
operator|(
name|t_QmFqr
operator|*
operator|)
name|p_Fq
operator|->
name|h_QmFqr
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|p_QmFqr
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fq
operator|->
name|flags
operator|&
name|QMAN_FQ_STATE_NE
condition|)
block|{
if|if
condition|(
name|qman_volatile_dequeue
argument_list|(
name|p_QmFqr
operator|->
name|h_QmPortal
argument_list|,
name|p_Fq
argument_list|,
operator|(
name|QM_VDQCR_PRECEDENCE_VDQCR
operator||
name|QM_VDQCR_NUMFRAMES_TILLEMPTY
operator|)
argument_list|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"drain with volatile failed"
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
else|else
return|return
name|freeDrainedFq
argument_list|(
name|p_Fq
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|e_RxStoreResponse
name|drainCB
parameter_list|(
name|t_Handle
name|h_App
parameter_list|,
name|t_Handle
name|h_QmFqr
parameter_list|,
name|t_Handle
name|h_QmPortal
parameter_list|,
name|uint32_t
name|fqidOffset
parameter_list|,
name|t_DpaaFD
modifier|*
name|p_Frame
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|h_App
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|h_QmFqr
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|h_QmPortal
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|fqidOffset
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|p_Frame
argument_list|)
expr_stmt|;
name|DBG
argument_list|(
name|TRACE
argument_list|,
operator|(
literal|"got fd for fqid %d"
operator|,
operator|(
operator|(
name|t_QmFqr
operator|*
operator|)
name|h_QmFqr
operator|)
operator|->
name|fqidBase
operator|+
name|fqidOffset
operator|)
argument_list|)
expr_stmt|;
return|return
name|e_RX_STORE_RESPONSE_CONTINUE
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cb_ern_dcErn
parameter_list|(
name|t_Handle
name|h_App
parameter_list|,
name|t_Handle
name|h_QmPortal
parameter_list|,
name|struct
name|qman_fq
modifier|*
name|p_Fq
parameter_list|,
specifier|const
name|struct
name|qm_mr_entry
modifier|*
name|p_Msg
parameter_list|)
block|{
specifier|static
name|int
name|cnt
init|=
literal|0
decl_stmt|;
name|UNUSED
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|p_Msg
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|h_App
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|h_QmPortal
argument_list|)
expr_stmt|;
name|XX_Print
argument_list|(
literal|"cb_ern_dcErn_fqs() unimplemented %d\n"
argument_list|,
operator|++
name|cnt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cb_fqs
parameter_list|(
name|t_Handle
name|h_App
parameter_list|,
name|t_Handle
name|h_QmPortal
parameter_list|,
name|struct
name|qman_fq
modifier|*
name|p_Fq
parameter_list|,
specifier|const
name|struct
name|qm_mr_entry
modifier|*
name|p_Msg
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|p_Msg
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|h_App
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|h_QmPortal
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fq
operator|->
name|state
operator|==
name|qman_fq_state_retired
operator|&&
operator|!
operator|(
name|p_Fq
operator|->
name|flags
operator|&
name|QMAN_FQ_STATE_ORL
operator|)
condition|)
name|drainRetiredFq
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|null_cb_mr
parameter_list|(
name|t_Handle
name|h_App
parameter_list|,
name|t_Handle
name|h_QmPortal
parameter_list|,
name|struct
name|qman_fq
modifier|*
name|p_Fq
parameter_list|,
specifier|const
name|struct
name|qm_mr_entry
modifier|*
name|p_Msg
parameter_list|)
block|{
name|t_QmPortal
modifier|*
name|p_QmPortal
init|=
operator|(
name|t_QmPortal
operator|*
operator|)
name|h_QmPortal
decl_stmt|;
name|UNUSED
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|h_App
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Msg
operator|->
name|verb
operator|&
name|QM_MR_VERB_DC_ERN
operator|)
operator|==
name|QM_MR_VERB_DC_ERN
condition|)
name|XX_Print
argument_list|(
literal|"Ignoring unowned MR frame on cpu %d, dc-portal 0x%02x.\n"
argument_list|,
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|->
name|config
operator|.
name|cpu
argument_list|,
name|p_Msg
operator|->
name|dcern
operator|.
name|portal
argument_list|)
expr_stmt|;
else|else
name|XX_Print
argument_list|(
literal|"Ignoring unowned MR frame on cpu %d, verb 0x%02x.\n"
argument_list|,
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|->
name|config
operator|.
name|cpu
argument_list|,
name|p_Msg
operator|->
name|verb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|LoopMessageRing
parameter_list|(
name|t_QmPortal
modifier|*
name|p_QmPortal
parameter_list|,
name|uint32_t
name|is
parameter_list|)
block|{
name|struct
name|qm_mr_entry
modifier|*
name|p_Msg
decl_stmt|;
if|if
condition|(
name|is
operator|&
name|QM_PIRQ_CSCI
condition|)
block|{
name|struct
name|qm_mc_result
modifier|*
name|p_Mcr
decl_stmt|;
name|struct
name|qman_cgrs
name|tmp
decl_stmt|;
name|uint32_t
name|mask
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|NCSW_PLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|qm_mc_start
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|qm_mc_commit
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|QM_MCC_VERB_QUERYCONGESTION
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|p_Mcr
operator|=
name|qm_mc_result
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
operator|)
condition|)
empty_stmt|;
comment|/* cgrs[0] is the portal mask for its cg's, cgrs[1] is the            previous state of cg's */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|QM_MAX_NUM_OF_CGS
operator|/
literal|32
condition|;
name|i
operator|++
control|)
block|{
comment|/* get curent state */
name|tmp
operator|.
name|q
operator|.
name|__state
index|[
name|i
index|]
operator|=
name|p_Mcr
operator|->
name|querycongestion
operator|.
name|state
operator|.
name|__state
index|[
name|i
index|]
expr_stmt|;
comment|/* keep only cg's that are registered for this portal */
name|tmp
operator|.
name|q
operator|.
name|__state
index|[
name|i
index|]
operator|&=
name|p_QmPortal
operator|->
name|cgrs
index|[
literal|0
index|]
operator|.
name|q
operator|.
name|__state
index|[
name|i
index|]
expr_stmt|;
comment|/* handle only cg's that changed their state from previous exception */
name|tmp
operator|.
name|q
operator|.
name|__state
index|[
name|i
index|]
operator|^=
name|p_QmPortal
operator|->
name|cgrs
index|[
literal|1
index|]
operator|.
name|q
operator|.
name|__state
index|[
name|i
index|]
expr_stmt|;
comment|/* update previous */
name|p_QmPortal
operator|->
name|cgrs
index|[
literal|1
index|]
operator|.
name|q
operator|.
name|__state
index|[
name|i
index|]
operator|=
name|p_Mcr
operator|->
name|querycongestion
operator|.
name|state
operator|.
name|__state
index|[
name|i
index|]
expr_stmt|;
block|}
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
comment|/* if in interrupt */
comment|/* call the callback routines for any CG with a changed state */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|QM_MAX_NUM_OF_CGS
operator|/
literal|32
condition|;
name|i
operator|++
control|)
for|for
control|(
name|j
operator|=
literal|0
operator|,
name|mask
operator|=
literal|0x80000000
init|;
name|j
operator|<
literal|32
condition|;
name|j
operator|++
operator|,
name|mask
operator|>>=
literal|1
control|)
block|{
if|if
condition|(
name|tmp
operator|.
name|q
operator|.
name|__state
index|[
name|i
index|]
operator|&
name|mask
condition|)
block|{
name|t_QmCg
modifier|*
name|p_QmCg
init|=
operator|(
name|t_QmCg
operator|*
operator|)
operator|(
name|p_QmPortal
operator|->
name|cgsHandles
index|[
name|i
operator|*
literal|32
operator|+
name|j
index|]
operator|)
decl_stmt|;
if|if
condition|(
name|p_QmCg
operator|->
name|f_Exception
condition|)
name|p_QmCg
operator|->
name|f_Exception
argument_list|(
name|p_QmCg
operator|->
name|h_App
argument_list|,
name|e_QM_EX_CG_STATE_CHANGE
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|is
operator|&
name|QM_PIRQ_EQRI
condition|)
block|{
name|NCSW_PLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|qmPortalEqcrCceUpdate
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|qm_eqcr_set_ithresh
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|is
operator|&
name|QM_PIRQ_MRI
condition|)
block|{
name|mr_loop
label|:
name|qmPortalMrPvbUpdate
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|p_Msg
operator|=
name|qm_mr_current
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Msg
condition|)
block|{
name|struct
name|qman_fq
modifier|*
name|p_FqFqs
init|=
name|ptr_from_aligned_int
argument_list|(
name|p_Msg
operator|->
name|fq
operator|.
name|contextB
argument_list|)
decl_stmt|;
name|struct
name|qman_fq
modifier|*
name|p_FqErn
init|=
name|ptr_from_aligned_int
argument_list|(
name|p_Msg
operator|->
name|ern
operator|.
name|tag
argument_list|)
decl_stmt|;
name|uint8_t
name|verb
init|=
call|(
name|uint8_t
call|)
argument_list|(
name|p_Msg
operator|->
name|verb
operator|&
name|QM_MR_VERB_TYPE_MASK
argument_list|)
decl_stmt|;
name|t_QmRejectedFrameInfo
name|rejectedFrameInfo
decl_stmt|;
name|memset
argument_list|(
operator|&
name|rejectedFrameInfo
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmRejectedFrameInfo
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|verb
operator|&
name|QM_MR_VERB_DC_ERN
operator|)
condition|)
block|{
switch|switch
condition|(
name|p_Msg
operator|->
name|ern
operator|.
name|rc
condition|)
block|{
case|case
operator|(
name|QM_MR_RC_CGR_TAILDROP
operator|)
case|:
name|rejectedFrameInfo
operator|.
name|rejectionCode
operator|=
name|e_QM_RC_CG_TAILDROP
expr_stmt|;
name|rejectedFrameInfo
operator|.
name|cg
operator|.
name|cgId
operator|=
operator|(
name|uint8_t
operator|)
name|p_FqErn
operator|->
name|cgr_groupid
expr_stmt|;
break|break;
case|case
operator|(
name|QM_MR_RC_WRED
operator|)
case|:
name|rejectedFrameInfo
operator|.
name|rejectionCode
operator|=
name|e_QM_RC_CG_WRED
expr_stmt|;
name|rejectedFrameInfo
operator|.
name|cg
operator|.
name|cgId
operator|=
operator|(
name|uint8_t
operator|)
name|p_FqErn
operator|->
name|cgr_groupid
expr_stmt|;
break|break;
case|case
operator|(
name|QM_MR_RC_FQ_TAILDROP
operator|)
case|:
name|rejectedFrameInfo
operator|.
name|rejectionCode
operator|=
name|e_QM_RC_FQ_TAILDROP
expr_stmt|;
name|rejectedFrameInfo
operator|.
name|cg
operator|.
name|cgId
operator|=
operator|(
name|uint8_t
operator|)
name|p_FqErn
operator|->
name|cgr_groupid
expr_stmt|;
break|break;
case|case
operator|(
name|QM_MR_RC_ERROR
operator|)
case|:
break|break;
default|default:
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"Unknown rejection code"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|p_FqErn
condition|)
name|p_QmPortal
operator|->
name|p_NullCB
operator|->
name|ern
argument_list|(
name|p_QmPortal
operator|->
name|h_App
argument_list|,
name|NULL
argument_list|,
name|p_QmPortal
argument_list|,
literal|0
argument_list|,
operator|(
name|t_DpaaFD
operator|*
operator|)
operator|&
name|p_Msg
operator|->
name|ern
operator|.
name|fd
argument_list|,
operator|&
name|rejectedFrameInfo
argument_list|)
expr_stmt|;
else|else
name|p_FqErn
operator|->
name|cb
operator|.
name|ern
argument_list|(
name|p_FqErn
operator|->
name|h_App
argument_list|,
name|p_FqErn
operator|->
name|h_QmFqr
argument_list|,
name|p_QmPortal
argument_list|,
name|p_FqErn
operator|->
name|fqidOffset
argument_list|,
operator|(
name|t_DpaaFD
operator|*
operator|)
operator|&
name|p_Msg
operator|->
name|ern
operator|.
name|fd
argument_list|,
operator|&
name|rejectedFrameInfo
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|verb
operator|==
name|QM_MR_VERB_DC_ERN
condition|)
block|{
if|if
condition|(
operator|!
name|p_FqErn
condition|)
name|p_QmPortal
operator|->
name|p_NullCB
operator|->
name|dc_ern
argument_list|(
name|NULL
argument_list|,
name|p_QmPortal
argument_list|,
name|NULL
argument_list|,
name|p_Msg
argument_list|)
expr_stmt|;
else|else
name|p_FqErn
operator|->
name|cb
operator|.
name|dc_ern
argument_list|(
name|p_FqErn
operator|->
name|h_App
argument_list|,
name|p_QmPortal
argument_list|,
name|p_FqErn
argument_list|,
name|p_Msg
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|verb
operator|==
name|QM_MR_VERB_FQRNI
condition|)
empty_stmt|;
comment|/* we drop FQRNIs on the floor */
elseif|else
if|if
condition|(
operator|!
name|p_FqFqs
condition|)
name|p_QmPortal
operator|->
name|p_NullCB
operator|->
name|fqs
argument_list|(
name|NULL
argument_list|,
name|p_QmPortal
argument_list|,
name|NULL
argument_list|,
name|p_Msg
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|verb
operator|==
name|QM_MR_VERB_FQRN
operator|)
operator|||
operator|(
name|verb
operator|==
name|QM_MR_VERB_FQRL
operator|)
operator|||
operator|(
name|verb
operator|==
name|QM_MR_VERB_FQPN
operator|)
condition|)
block|{
name|fq_state_change
argument_list|(
name|p_FqFqs
argument_list|,
name|p_Msg
argument_list|,
name|verb
argument_list|)
expr_stmt|;
name|p_FqFqs
operator|->
name|cb
operator|.
name|fqs
argument_list|(
name|p_FqFqs
operator|->
name|h_App
argument_list|,
name|p_QmPortal
argument_list|,
name|p_FqFqs
argument_list|,
name|p_Msg
argument_list|)
expr_stmt|;
block|}
block|}
name|qm_mr_next
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|qmPortalMrCciConsume
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|mr_loop
goto|;
block|}
block|}
return|return
name|is
operator|&
operator|(
name|QM_PIRQ_CSCI
operator||
name|QM_PIRQ_EQCI
operator||
name|QM_PIRQ_EQRI
operator||
name|QM_PIRQ_MRI
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|LoopDequeueRing
parameter_list|(
name|t_Handle
name|h_QmPortal
parameter_list|)
block|{
name|struct
name|qm_dqrr_entry
modifier|*
name|p_Dq
decl_stmt|;
name|struct
name|qman_fq
modifier|*
name|p_Fq
decl_stmt|;
name|enum
name|qman_cb_dqrr_result
name|res
init|=
name|qman_cb_dqrr_consume
decl_stmt|;
name|e_RxStoreResponse
name|tmpRes
decl_stmt|;
name|t_QmPortal
modifier|*
name|p_QmPortal
init|=
operator|(
name|t_QmPortal
operator|*
operator|)
name|h_QmPortal
decl_stmt|;
name|int
name|prefetch
init|=
operator|!
operator|(
name|p_QmPortal
operator|->
name|options
operator|&
name|QMAN_PORTAL_FLAG_RSTASH
operator|)
decl_stmt|;
while|while
condition|(
name|res
operator|!=
name|qman_cb_dqrr_pause
condition|)
block|{
if|if
condition|(
name|prefetch
condition|)
name|qmPortalDqrrPvbPrefetch
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|qmPortalDqrrPvbUpdate
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|p_Dq
operator|=
name|qm_dqrr_current
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Dq
condition|)
break|break;
name|p_Fq
operator|=
name|ptr_from_aligned_int
argument_list|(
name|p_Dq
operator|->
name|contextB
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Dq
operator|->
name|stat
operator|&
name|QM_DQRR_STAT_UNSCHEDULED
condition|)
block|{
comment|/* We only set QMAN_FQ_STATE_NE when retiring, so we only need              * to check for clearing it when doing volatile dequeues. It's              * one less thing to check in the critical path (SDQCR). */
name|tmpRes
operator|=
name|p_Fq
operator|->
name|cb
operator|.
name|dqrr
argument_list|(
name|p_Fq
operator|->
name|h_App
argument_list|,
name|p_Fq
operator|->
name|h_QmFqr
argument_list|,
name|p_QmPortal
argument_list|,
name|p_Fq
operator|->
name|fqidOffset
argument_list|,
operator|(
name|t_DpaaFD
operator|*
operator|)
operator|&
name|p_Dq
operator|->
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpRes
operator|==
name|e_RX_STORE_RESPONSE_PAUSE
condition|)
name|res
operator|=
name|qman_cb_dqrr_pause
expr_stmt|;
comment|/* Check for VDQCR completion */
if|if
condition|(
name|p_Dq
operator|->
name|stat
operator|&
name|QM_DQRR_STAT_DQCR_EXPIRED
condition|)
name|p_Fq
operator|->
name|flags
operator|&=
operator|~
name|QMAN_FQ_STATE_VDQCR
expr_stmt|;
if|if
condition|(
name|p_Dq
operator|->
name|stat
operator|&
name|QM_DQRR_STAT_FQ_EMPTY
condition|)
block|{
name|p_Fq
operator|->
name|flags
operator|&=
operator|~
name|QMAN_FQ_STATE_NE
expr_stmt|;
name|freeDrainedFq
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Interpret 'dq' from the owner's perspective. */
comment|/* use portal default handlers */
name|ASSERT_COND
argument_list|(
name|p_Dq
operator|->
name|fqid
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fq
condition|)
block|{
name|tmpRes
operator|=
name|p_Fq
operator|->
name|cb
operator|.
name|dqrr
argument_list|(
name|p_Fq
operator|->
name|h_App
argument_list|,
name|p_Fq
operator|->
name|h_QmFqr
argument_list|,
name|p_QmPortal
argument_list|,
name|p_Fq
operator|->
name|fqidOffset
argument_list|,
operator|(
name|t_DpaaFD
operator|*
operator|)
operator|&
name|p_Dq
operator|->
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpRes
operator|==
name|e_RX_STORE_RESPONSE_PAUSE
condition|)
name|res
operator|=
name|qman_cb_dqrr_pause
expr_stmt|;
elseif|else
if|if
condition|(
name|p_Fq
operator|->
name|state
operator|==
name|qman_fq_state_waiting_parked
condition|)
name|res
operator|=
name|qman_cb_dqrr_park
expr_stmt|;
block|}
else|else
block|{
name|tmpRes
operator|=
name|p_QmPortal
operator|->
name|p_NullCB
operator|->
name|dqrr
argument_list|(
name|p_QmPortal
operator|->
name|h_App
argument_list|,
name|NULL
argument_list|,
name|p_QmPortal
argument_list|,
name|p_Dq
operator|->
name|fqid
argument_list|,
operator|(
name|t_DpaaFD
operator|*
operator|)
operator|&
name|p_Dq
operator|->
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpRes
operator|==
name|e_RX_STORE_RESPONSE_PAUSE
condition|)
name|res
operator|=
name|qman_cb_dqrr_pause
expr_stmt|;
block|}
block|}
comment|/* Parking isn't possible unless HELDACTIVE was set. NB,          * FORCEELIGIBLE implies HELDACTIVE, so we only need to          * check for HELDACTIVE to cover both. */
name|ASSERT_COND
argument_list|(
operator|(
name|p_Dq
operator|->
name|stat
operator|&
name|QM_DQRR_STAT_FQ_HELDACTIVE
operator|)
operator|||
operator|(
name|res
operator|!=
name|qman_cb_dqrr_park
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_QmPortal
operator|->
name|options
operator|&
name|QMAN_PORTAL_FLAG_DCA
condition|)
block|{
comment|/* Defer just means "skip it, I'll consume it myself later on" */
if|if
condition|(
name|res
operator|!=
name|qman_cb_dqrr_defer
condition|)
name|qmPortalDqrrDcaConsume1ptr
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|p_Dq
argument_list|,
operator|(
name|res
operator|==
name|qman_cb_dqrr_park
operator|)
argument_list|)
expr_stmt|;
name|qm_dqrr_next
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|res
operator|==
name|qman_cb_dqrr_park
condition|)
comment|/* The only thing to do for non-DCA is the park-request */
name|qm_dqrr_park_ci
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|qm_dqrr_next
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|qmPortalDqrrCciConsume
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|LoopDequeueRingDcaOptimized
parameter_list|(
name|t_Handle
name|h_QmPortal
parameter_list|)
block|{
name|struct
name|qm_dqrr_entry
modifier|*
name|p_Dq
decl_stmt|;
name|struct
name|qman_fq
modifier|*
name|p_Fq
decl_stmt|;
name|enum
name|qman_cb_dqrr_result
name|res
init|=
name|qman_cb_dqrr_consume
decl_stmt|;
name|e_RxStoreResponse
name|tmpRes
decl_stmt|;
name|t_QmPortal
modifier|*
name|p_QmPortal
init|=
operator|(
name|t_QmPortal
operator|*
operator|)
name|h_QmPortal
decl_stmt|;
while|while
condition|(
name|res
operator|!=
name|qman_cb_dqrr_pause
condition|)
block|{
name|qmPortalDqrrPvbUpdate
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|p_Dq
operator|=
name|qm_dqrr_current
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Dq
condition|)
break|break;
name|p_Fq
operator|=
name|ptr_from_aligned_int
argument_list|(
name|p_Dq
operator|->
name|contextB
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Dq
operator|->
name|stat
operator|&
name|QM_DQRR_STAT_UNSCHEDULED
condition|)
block|{
comment|/* We only set QMAN_FQ_STATE_NE when retiring, so we only need              * to check for clearing it when doing volatile dequeues. It's              * one less thing to check in the critical path (SDQCR). */
name|tmpRes
operator|=
name|p_Fq
operator|->
name|cb
operator|.
name|dqrr
argument_list|(
name|p_Fq
operator|->
name|h_App
argument_list|,
name|p_Fq
operator|->
name|h_QmFqr
argument_list|,
name|p_QmPortal
argument_list|,
name|p_Fq
operator|->
name|fqidOffset
argument_list|,
operator|(
name|t_DpaaFD
operator|*
operator|)
operator|&
name|p_Dq
operator|->
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpRes
operator|==
name|e_RX_STORE_RESPONSE_PAUSE
condition|)
name|res
operator|=
name|qman_cb_dqrr_pause
expr_stmt|;
comment|/* Check for VDQCR completion */
if|if
condition|(
name|p_Dq
operator|->
name|stat
operator|&
name|QM_DQRR_STAT_DQCR_EXPIRED
condition|)
name|p_Fq
operator|->
name|flags
operator|&=
operator|~
name|QMAN_FQ_STATE_VDQCR
expr_stmt|;
if|if
condition|(
name|p_Dq
operator|->
name|stat
operator|&
name|QM_DQRR_STAT_FQ_EMPTY
condition|)
block|{
name|p_Fq
operator|->
name|flags
operator|&=
operator|~
name|QMAN_FQ_STATE_NE
expr_stmt|;
name|freeDrainedFq
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Interpret 'dq' from the owner's perspective. */
comment|/* use portal default handlers */
name|ASSERT_COND
argument_list|(
name|p_Dq
operator|->
name|fqid
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fq
condition|)
block|{
name|tmpRes
operator|=
name|p_Fq
operator|->
name|cb
operator|.
name|dqrr
argument_list|(
name|p_Fq
operator|->
name|h_App
argument_list|,
name|p_Fq
operator|->
name|h_QmFqr
argument_list|,
name|p_QmPortal
argument_list|,
name|p_Fq
operator|->
name|fqidOffset
argument_list|,
operator|(
name|t_DpaaFD
operator|*
operator|)
operator|&
name|p_Dq
operator|->
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpRes
operator|==
name|e_RX_STORE_RESPONSE_PAUSE
condition|)
name|res
operator|=
name|qman_cb_dqrr_pause
expr_stmt|;
elseif|else
if|if
condition|(
name|p_Fq
operator|->
name|state
operator|==
name|qman_fq_state_waiting_parked
condition|)
name|res
operator|=
name|qman_cb_dqrr_park
expr_stmt|;
block|}
else|else
block|{
name|tmpRes
operator|=
name|p_QmPortal
operator|->
name|p_NullCB
operator|->
name|dqrr
argument_list|(
name|p_QmPortal
operator|->
name|h_App
argument_list|,
name|NULL
argument_list|,
name|p_QmPortal
argument_list|,
name|p_Dq
operator|->
name|fqid
argument_list|,
operator|(
name|t_DpaaFD
operator|*
operator|)
operator|&
name|p_Dq
operator|->
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpRes
operator|==
name|e_RX_STORE_RESPONSE_PAUSE
condition|)
name|res
operator|=
name|qman_cb_dqrr_pause
expr_stmt|;
block|}
block|}
comment|/* Parking isn't possible unless HELDACTIVE was set. NB,          * FORCEELIGIBLE implies HELDACTIVE, so we only need to          * check for HELDACTIVE to cover both. */
name|ASSERT_COND
argument_list|(
operator|(
name|p_Dq
operator|->
name|stat
operator|&
name|QM_DQRR_STAT_FQ_HELDACTIVE
operator|)
operator|||
operator|(
name|res
operator|!=
name|qman_cb_dqrr_park
operator|)
argument_list|)
expr_stmt|;
comment|/* Defer just means "skip it, I'll consume it myself later on" */
if|if
condition|(
name|res
operator|!=
name|qman_cb_dqrr_defer
condition|)
name|qmPortalDqrrDcaConsume1ptr
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|p_Dq
argument_list|,
operator|(
name|res
operator|==
name|qman_cb_dqrr_park
operator|)
argument_list|)
expr_stmt|;
name|qm_dqrr_next
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|LoopDequeueRingOptimized
parameter_list|(
name|t_Handle
name|h_QmPortal
parameter_list|)
block|{
name|struct
name|qm_dqrr_entry
modifier|*
name|p_Dq
decl_stmt|;
name|struct
name|qman_fq
modifier|*
name|p_Fq
decl_stmt|;
name|enum
name|qman_cb_dqrr_result
name|res
init|=
name|qman_cb_dqrr_consume
decl_stmt|;
name|e_RxStoreResponse
name|tmpRes
decl_stmt|;
name|t_QmPortal
modifier|*
name|p_QmPortal
init|=
operator|(
name|t_QmPortal
operator|*
operator|)
name|h_QmPortal
decl_stmt|;
while|while
condition|(
name|res
operator|!=
name|qman_cb_dqrr_pause
condition|)
block|{
name|qmPortalDqrrPvbUpdate
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|p_Dq
operator|=
name|qm_dqrr_current
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Dq
condition|)
break|break;
name|p_Fq
operator|=
name|ptr_from_aligned_int
argument_list|(
name|p_Dq
operator|->
name|contextB
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Dq
operator|->
name|stat
operator|&
name|QM_DQRR_STAT_UNSCHEDULED
condition|)
block|{
comment|/* We only set QMAN_FQ_STATE_NE when retiring, so we only need              * to check for clearing it when doing volatile dequeues. It's              * one less thing to check in the critical path (SDQCR). */
name|tmpRes
operator|=
name|p_Fq
operator|->
name|cb
operator|.
name|dqrr
argument_list|(
name|p_Fq
operator|->
name|h_App
argument_list|,
name|p_Fq
operator|->
name|h_QmFqr
argument_list|,
name|p_QmPortal
argument_list|,
name|p_Fq
operator|->
name|fqidOffset
argument_list|,
operator|(
name|t_DpaaFD
operator|*
operator|)
operator|&
name|p_Dq
operator|->
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpRes
operator|==
name|e_RX_STORE_RESPONSE_PAUSE
condition|)
name|res
operator|=
name|qman_cb_dqrr_pause
expr_stmt|;
comment|/* Check for VDQCR completion */
if|if
condition|(
name|p_Dq
operator|->
name|stat
operator|&
name|QM_DQRR_STAT_DQCR_EXPIRED
condition|)
name|p_Fq
operator|->
name|flags
operator|&=
operator|~
name|QMAN_FQ_STATE_VDQCR
expr_stmt|;
if|if
condition|(
name|p_Dq
operator|->
name|stat
operator|&
name|QM_DQRR_STAT_FQ_EMPTY
condition|)
block|{
name|p_Fq
operator|->
name|flags
operator|&=
operator|~
name|QMAN_FQ_STATE_NE
expr_stmt|;
name|freeDrainedFq
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Interpret 'dq' from the owner's perspective. */
comment|/* use portal default handlers */
name|ASSERT_COND
argument_list|(
name|p_Dq
operator|->
name|fqid
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fq
condition|)
block|{
name|tmpRes
operator|=
name|p_Fq
operator|->
name|cb
operator|.
name|dqrr
argument_list|(
name|p_Fq
operator|->
name|h_App
argument_list|,
name|p_Fq
operator|->
name|h_QmFqr
argument_list|,
name|p_QmPortal
argument_list|,
name|p_Fq
operator|->
name|fqidOffset
argument_list|,
operator|(
name|t_DpaaFD
operator|*
operator|)
operator|&
name|p_Dq
operator|->
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpRes
operator|==
name|e_RX_STORE_RESPONSE_PAUSE
condition|)
name|res
operator|=
name|qman_cb_dqrr_pause
expr_stmt|;
elseif|else
if|if
condition|(
name|p_Fq
operator|->
name|state
operator|==
name|qman_fq_state_waiting_parked
condition|)
name|res
operator|=
name|qman_cb_dqrr_park
expr_stmt|;
block|}
else|else
block|{
name|tmpRes
operator|=
name|p_QmPortal
operator|->
name|p_NullCB
operator|->
name|dqrr
argument_list|(
name|p_QmPortal
operator|->
name|h_App
argument_list|,
name|NULL
argument_list|,
name|p_QmPortal
argument_list|,
name|p_Dq
operator|->
name|fqid
argument_list|,
operator|(
name|t_DpaaFD
operator|*
operator|)
operator|&
name|p_Dq
operator|->
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpRes
operator|==
name|e_RX_STORE_RESPONSE_PAUSE
condition|)
name|res
operator|=
name|qman_cb_dqrr_pause
expr_stmt|;
block|}
block|}
comment|/* Parking isn't possible unless HELDACTIVE was set. NB,          * FORCEELIGIBLE implies HELDACTIVE, so we only need to          * check for HELDACTIVE to cover both. */
name|ASSERT_COND
argument_list|(
operator|(
name|p_Dq
operator|->
name|stat
operator|&
name|QM_DQRR_STAT_FQ_HELDACTIVE
operator|)
operator|||
operator|(
name|res
operator|!=
name|qman_cb_dqrr_park
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|qman_cb_dqrr_park
condition|)
comment|/* The only thing to do for non-DCA is the park-request */
name|qm_dqrr_park_ci
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|qm_dqrr_next
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|qmPortalDqrrCciConsume
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Portal interrupt handler */
end_comment

begin_function
specifier|static
name|void
name|portal_isr
parameter_list|(
name|void
modifier|*
name|ptr
parameter_list|)
block|{
name|t_QmPortal
modifier|*
name|p_QmPortal
init|=
name|ptr
decl_stmt|;
name|uint32_t
name|event
init|=
literal|0
decl_stmt|;
name|uint32_t
name|enableEvents
init|=
name|qm_isr_enable_read
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
decl_stmt|;
name|DBG
argument_list|(
name|TRACE
argument_list|,
operator|(
literal|"software-portal %d got interrupt"
operator|,
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|->
name|config
operator|.
name|cpu
operator|)
argument_list|)
expr_stmt|;
name|event
operator||=
operator|(
name|qm_isr_status_read
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
operator|&
name|enableEvents
operator|)
expr_stmt|;
name|qm_isr_status_clear
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|event
argument_list|)
expr_stmt|;
comment|/* Only do fast-path handling if it's required */
if|if
condition|(
comment|/*(event& QM_PIRQ_DQRI)&&*/
operator|(
name|p_QmPortal
operator|->
name|options
operator|&
name|QMAN_PORTAL_FLAG_IRQ_FAST
operator|)
condition|)
name|p_QmPortal
operator|->
name|f_LoopDequeueRingCB
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_QmPortal
operator|->
name|options
operator|&
name|QMAN_PORTAL_FLAG_IRQ_SLOW
condition|)
name|LoopMessageRing
argument_list|(
name|p_QmPortal
argument_list|,
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|qman_query_fq_np
parameter_list|(
name|t_QmPortal
modifier|*
name|p_QmPortal
parameter_list|,
name|struct
name|qman_fq
modifier|*
name|p_Fq
parameter_list|,
name|struct
name|qm_mcr_queryfq_np
modifier|*
name|p_Np
parameter_list|)
block|{
name|struct
name|qm_mc_command
modifier|*
name|p_Mcc
decl_stmt|;
name|struct
name|qm_mc_result
modifier|*
name|p_Mcr
decl_stmt|;
name|uint8_t
name|res
decl_stmt|;
name|NCSW_PLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|p_Mcc
operator|=
name|qm_mc_start
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|p_Mcc
operator|->
name|queryfq_np
operator|.
name|fqid
operator|=
name|p_Fq
operator|->
name|fqid
expr_stmt|;
name|qm_mc_commit
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|QM_MCC_VERB_QUERYFQ_NP
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|p_Mcr
operator|=
name|qm_mc_result
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
operator|)
condition|)
empty_stmt|;
name|ASSERT_COND
argument_list|(
operator|(
name|p_Mcr
operator|->
name|verb
operator|&
name|QM_MCR_VERB_MASK
operator|)
operator|==
name|QM_MCR_VERB_QUERYFQ_NP
argument_list|)
expr_stmt|;
name|res
operator|=
name|p_Mcr
operator|->
name|result
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|QM_MCR_RESULT_OK
condition|)
operator|*
name|p_Np
operator|=
name|p_Mcr
operator|->
name|queryfq_np
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
name|QM_MCR_RESULT_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"QUERYFQ_NP failed: %s\n"
operator|,
name|mcr_result_str
argument_list|(
name|res
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|uint8_t
name|QmCgGetCgId
parameter_list|(
name|t_Handle
name|h_QmCg
parameter_list|)
block|{
name|t_QmCg
modifier|*
name|p_QmCg
init|=
operator|(
name|t_QmCg
operator|*
operator|)
name|h_QmCg
decl_stmt|;
return|return
name|p_QmCg
operator|->
name|id
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|qm_new_fq
parameter_list|(
name|t_QmPortal
modifier|*
name|p_QmPortal
parameter_list|,
name|uint32_t
name|fqid
parameter_list|,
name|uint32_t
name|fqidOffset
parameter_list|,
name|uint32_t
name|channel
parameter_list|,
name|uint32_t
name|wqid
parameter_list|,
name|uint16_t
name|count
parameter_list|,
name|uint32_t
name|flags
parameter_list|,
name|t_QmFqrCongestionAvoidanceParams
modifier|*
name|p_CgParams
parameter_list|,
name|t_QmContextA
modifier|*
name|p_ContextA
parameter_list|,
name|t_QmContextB
modifier|*
name|p_ContextB
parameter_list|,
name|bool
name|initParked
parameter_list|,
name|t_Handle
name|h_QmFqr
parameter_list|,
name|struct
name|qman_fq
modifier|*
modifier|*
name|p_Fqs
parameter_list|)
block|{
name|struct
name|qman_fq
modifier|*
name|p_Fq
init|=
name|NULL
decl_stmt|;
name|struct
name|qm_mcc_initfq
name|fq_opts
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|int
name|gap
decl_stmt|,
name|tmp
decl_stmt|;
name|uint32_t
name|tmpA
decl_stmt|,
name|tmpN
decl_stmt|,
name|ta
init|=
literal|0
decl_stmt|,
name|tn
init|=
literal|0
decl_stmt|,
name|initFqFlag
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|count
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|p_Fq
operator|=
operator|(
expr|struct
name|qman_fq
operator|*
operator|)
name|XX_MallocSmart
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|qman_fq
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|64
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Fq
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"FQ obj!!!"
operator|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p_Fq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|qman_fq
argument_list|)
argument_list|)
expr_stmt|;
name|p_Fq
operator|->
name|cb
operator|.
name|dqrr
operator|=
name|p_QmPortal
operator|->
name|f_DfltFrame
expr_stmt|;
name|p_Fq
operator|->
name|cb
operator|.
name|ern
operator|=
name|p_QmPortal
operator|->
name|f_RejectedFrame
expr_stmt|;
name|p_Fq
operator|->
name|cb
operator|.
name|dc_ern
operator|=
name|cb_ern_dcErn
expr_stmt|;
name|p_Fq
operator|->
name|cb
operator|.
name|fqs
operator|=
name|cb_fqs
expr_stmt|;
name|p_Fq
operator|->
name|h_App
operator|=
name|p_QmPortal
operator|->
name|h_App
expr_stmt|;
name|p_Fq
operator|->
name|h_QmFqr
operator|=
name|h_QmFqr
expr_stmt|;
name|p_Fq
operator|->
name|fqidOffset
operator|=
name|fqidOffset
expr_stmt|;
name|p_Fqs
index|[
name|i
index|]
operator|=
name|p_Fq
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|qman_create_fq
argument_list|(
name|p_QmPortal
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|fqid
operator|+
name|i
argument_list|)
argument_list|,
literal|0
argument_list|,
name|p_Fqs
index|[
name|i
index|]
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
break|break;
block|}
if|if
condition|(
name|err
operator|!=
name|E_OK
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|p_Fqs
index|[
name|i
index|]
condition|)
block|{
name|XX_FreeSmart
argument_list|(
name|p_Fqs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|p_Fqs
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
operator|(
literal|"Failed to create Fqs"
operator|)
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
operator|&
name|fq_opts
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|fq_opts
argument_list|)
argument_list|)
expr_stmt|;
name|fq_opts
operator|.
name|fqid
operator|=
name|fqid
expr_stmt|;
name|fq_opts
operator|.
name|count
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|count
operator|-
literal|1
argument_list|)
expr_stmt|;
name|fq_opts
operator|.
name|we_mask
operator||=
name|QM_INITFQ_WE_DESTWQ
expr_stmt|;
name|fq_opts
operator|.
name|fqd
operator|.
name|dest
operator|.
name|channel
operator|=
name|channel
expr_stmt|;
name|fq_opts
operator|.
name|fqd
operator|.
name|dest
operator|.
name|wq
operator|=
name|wqid
expr_stmt|;
name|fq_opts
operator|.
name|we_mask
operator||=
name|QM_INITFQ_WE_FQCTRL
expr_stmt|;
name|fq_opts
operator|.
name|fqd
operator|.
name|fq_ctrl
operator|=
operator|(
name|uint16_t
operator|)
name|flags
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|QM_FQCTRL_CGE
operator|)
operator|||
operator|(
name|flags
operator|&
name|QM_FQCTRL_TDE
operator|)
condition|)
name|ASSERT_COND
argument_list|(
name|p_CgParams
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|QM_FQCTRL_CGE
condition|)
block|{
name|ASSERT_COND
argument_list|(
name|p_CgParams
operator|->
name|h_QmCg
argument_list|)
expr_stmt|;
comment|/* CG OAC and FQ TD may not be configured at the same time. if both are required,            than we configure CG first, and the FQ TD later - see below. */
name|fq_opts
operator|.
name|fqd
operator|.
name|cgid
operator|=
name|QmCgGetCgId
argument_list|(
name|p_CgParams
operator|->
name|h_QmCg
argument_list|)
expr_stmt|;
name|fq_opts
operator|.
name|we_mask
operator||=
name|QM_INITFQ_WE_CGID
expr_stmt|;
if|if
condition|(
name|p_CgParams
operator|->
name|overheadAccountingLength
condition|)
block|{
name|fq_opts
operator|.
name|we_mask
operator||=
name|QM_INITFQ_WE_OAC
expr_stmt|;
name|fq_opts
operator|.
name|we_mask
operator|&=
operator|~
name|QM_INITFQ_WE_TDTHRESH
expr_stmt|;
name|fq_opts
operator|.
name|fqd
operator|.
name|td_thresh
operator|=
call|(
name|uint16_t
call|)
argument_list|(
name|QM_FQD_TD_THRESH_OAC_EN
operator||
name|p_CgParams
operator|->
name|overheadAccountingLength
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|flags
operator|&
name|QM_FQCTRL_TDE
operator|)
operator|&&
operator|(
operator|!
name|p_CgParams
operator|->
name|overheadAccountingLength
operator|)
condition|)
block|{
name|ASSERT_COND
argument_list|(
name|p_CgParams
operator|->
name|fqTailDropThreshold
argument_list|)
expr_stmt|;
name|fq_opts
operator|.
name|we_mask
operator||=
name|QM_INITFQ_WE_TDTHRESH
expr_stmt|;
comment|/* express thresh as ta*2^tn */
name|gap
operator|=
operator|(
name|int
operator|)
name|p_CgParams
operator|->
name|fqTailDropThreshold
expr_stmt|;
for|for
control|(
name|tmpA
operator|=
literal|0
init|;
name|tmpA
operator|<
literal|256
condition|;
name|tmpA
operator|++
control|)
for|for
control|(
name|tmpN
operator|=
literal|0
init|;
name|tmpN
operator|<
literal|32
condition|;
name|tmpN
operator|++
control|)
block|{
name|tmp
operator|=
name|ABS
argument_list|(
call|(
name|int
call|)
argument_list|(
name|p_CgParams
operator|->
name|fqTailDropThreshold
operator|-
name|tmpA
operator|*
operator|(
literal|1
operator|<<
name|tmpN
operator|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|<
name|gap
condition|)
block|{
name|ta
operator|=
name|tmpA
expr_stmt|;
name|tn
operator|=
name|tmpN
expr_stmt|;
name|gap
operator|=
name|tmp
expr_stmt|;
block|}
block|}
name|fq_opts
operator|.
name|fqd
operator|.
name|td
operator|.
name|exp
operator|=
name|tn
expr_stmt|;
name|fq_opts
operator|.
name|fqd
operator|.
name|td
operator|.
name|mant
operator|=
name|ta
expr_stmt|;
block|}
if|if
condition|(
name|p_ContextA
condition|)
block|{
name|fq_opts
operator|.
name|we_mask
operator||=
name|QM_INITFQ_WE_CONTEXTA
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|&
name|fq_opts
operator|.
name|fqd
operator|.
name|context_a
argument_list|,
name|p_ContextA
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmContextA
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* If this FQ will not be used for tx, we can use contextB field */
if|if
condition|(
name|fq_opts
operator|.
name|fqd
operator|.
name|dest
operator|.
name|channel
operator|<
name|e_QM_FQ_CHANNEL_FMAN0_SP0
condition|)
block|{
name|fq_opts
operator|.
name|we_mask
operator||=
name|QM_INITFQ_WE_CONTEXTB
expr_stmt|;
name|fq_opts
operator|.
name|fqd
operator|.
name|context_b
operator|=
name|aligned_int_from_ptr
argument_list|(
name|p_Fqs
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p_ContextB
condition|)
comment|/* Tx-Queue */
block|{
name|fq_opts
operator|.
name|we_mask
operator||=
name|QM_INITFQ_WE_CONTEXTB
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|&
name|fq_opts
operator|.
name|fqd
operator|.
name|context_b
argument_list|,
name|p_ContextB
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmContextB
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|flags
operator|&
name|QM_FQCTRL_TDE
operator|)
operator|&&
operator|(
name|p_CgParams
operator|->
name|overheadAccountingLength
operator|)
condition|)
name|initFqFlag
operator|=
literal|0
expr_stmt|;
else|else
name|initFqFlag
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|initParked
condition|?
literal|0
else|:
name|QMAN_INITFQ_FLAG_SCHED
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|qman_init_fq
argument_list|(
name|p_QmPortal
argument_list|,
name|p_Fqs
index|[
literal|0
index|]
argument_list|,
name|initFqFlag
argument_list|,
operator|&
name|fq_opts
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|p_Fqs
index|[
name|i
index|]
condition|)
block|{
name|XX_FreeSmart
argument_list|(
name|p_Fqs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|p_Fqs
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
operator|(
literal|"Failed to init Fqs [%d-%d]"
operator|,
name|fqid
operator|,
name|fqid
operator|+
name|count
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* if both CG OAC and FQ TD are needed, we call qman_init_fq again, this time for the FQ TD only */
if|if
condition|(
operator|(
name|flags
operator|&
name|QM_FQCTRL_TDE
operator|)
operator|&&
operator|(
name|p_CgParams
operator|->
name|overheadAccountingLength
operator|)
condition|)
block|{
name|ASSERT_COND
argument_list|(
name|p_CgParams
operator|->
name|fqTailDropThreshold
argument_list|)
expr_stmt|;
name|fq_opts
operator|.
name|we_mask
operator|=
name|QM_INITFQ_WE_TDTHRESH
expr_stmt|;
comment|/* express thresh as ta*2^tn */
name|gap
operator|=
operator|(
name|int
operator|)
name|p_CgParams
operator|->
name|fqTailDropThreshold
expr_stmt|;
for|for
control|(
name|tmpA
operator|=
literal|0
init|;
name|tmpA
operator|<
literal|256
condition|;
name|tmpA
operator|++
control|)
for|for
control|(
name|tmpN
operator|=
literal|0
init|;
name|tmpN
operator|<
literal|32
condition|;
name|tmpN
operator|++
control|)
block|{
name|tmp
operator|=
name|ABS
argument_list|(
call|(
name|int
call|)
argument_list|(
name|p_CgParams
operator|->
name|fqTailDropThreshold
operator|-
name|tmpA
operator|*
operator|(
literal|1
operator|<<
name|tmpN
operator|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|<
name|gap
condition|)
block|{
name|ta
operator|=
name|tmpA
expr_stmt|;
name|tn
operator|=
name|tmpN
expr_stmt|;
name|gap
operator|=
name|tmp
expr_stmt|;
block|}
block|}
name|fq_opts
operator|.
name|fqd
operator|.
name|td
operator|.
name|exp
operator|=
name|tn
expr_stmt|;
name|fq_opts
operator|.
name|fqd
operator|.
name|td
operator|.
name|mant
operator|=
name|ta
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|qman_init_fq
argument_list|(
name|p_QmPortal
argument_list|,
name|p_Fqs
index|[
literal|0
index|]
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|initParked
condition|?
literal|0
else|:
name|QMAN_INITFQ_FLAG_SCHED
argument_list|)
argument_list|,
operator|&
name|fq_opts
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|p_Fqs
index|[
name|i
index|]
condition|)
block|{
name|XX_FreeSmart
argument_list|(
name|p_Fqs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|p_Fqs
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
operator|(
literal|"Failed to init Fqs"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|memcpy
argument_list|(
name|p_Fqs
index|[
name|i
index|]
argument_list|,
name|p_Fqs
index|[
literal|0
index|]
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|qman_fq
argument_list|)
argument_list|)
expr_stmt|;
name|p_Fqs
index|[
name|i
index|]
operator|->
name|fqid
operator|+=
name|i
expr_stmt|;
block|}
return|return
name|err
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|qm_free_fq
parameter_list|(
name|t_QmPortal
modifier|*
name|p_QmPortal
parameter_list|,
name|struct
name|qman_fq
modifier|*
name|p_Fq
parameter_list|)
block|{
name|uint32_t
name|flags
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|qman_retire_fq
argument_list|(
name|p_QmPortal
argument_list|,
name|p_Fq
argument_list|,
operator|&
name|flags
argument_list|,
name|false
argument_list|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"qman_retire_fq() failed!"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|QMAN_FQ_STATE_CHANGING
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"fq %d currently in use, will be retired"
operator|,
name|p_Fq
operator|->
name|fqid
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|QMAN_FQ_STATE_NE
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"qman_retire_fq() failed;"
expr|\
literal|"Frame Queue Not Empty, Need to dequeue"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|qman_oos_fq
argument_list|(
name|p_QmPortal
argument_list|,
name|p_Fq
argument_list|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"qman_oos_fq() failed!"
operator|)
argument_list|)
expr_stmt|;
name|qman_destroy_fq
argument_list|(
name|p_Fq
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qman_disable_portal
parameter_list|(
name|t_QmPortal
modifier|*
name|p_QmPortal
parameter_list|)
block|{
name|NCSW_PLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|p_QmPortal
operator|->
name|disable_count
operator|++
operator|)
condition|)
name|qm_dqrr_set_maxfill
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* quiesce SDQCR/VDQCR, then drain till h/w wraps up anything it  * was doing (5ms is more than enough to ensure it's done). */
end_comment

begin_function
specifier|static
name|void
name|clean_dqrr_mr
parameter_list|(
name|t_QmPortal
modifier|*
name|p_QmPortal
parameter_list|)
block|{
name|struct
name|qm_dqrr_entry
modifier|*
name|p_Dq
decl_stmt|;
name|struct
name|qm_mr_entry
modifier|*
name|p_Msg
decl_stmt|;
name|int
name|idle
init|=
literal|0
decl_stmt|;
name|qm_dqrr_sdqcr_set
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|qm_dqrr_vdqcr_set
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|drain_loop
label|:
name|qmPortalDqrrPvbPrefetch
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|qmPortalDqrrPvbUpdate
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|qmPortalMrPvbUpdate
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|p_Dq
operator|=
name|qm_dqrr_current
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|p_Msg
operator|=
name|qm_mr_current
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Dq
condition|)
block|{
name|qm_dqrr_next
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|qmPortalDqrrCciConsume
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p_Msg
condition|)
block|{
name|qm_mr_next
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|qmPortalMrCciConsume
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|p_Dq
operator|&&
operator|!
name|p_Msg
condition|)
block|{
if|if
condition|(
operator|++
name|idle
operator|<
literal|5
condition|)
block|{
name|XX_UDelay
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
goto|goto
name|drain_loop
goto|;
block|}
block|}
else|else
block|{
name|idle
operator|=
literal|0
expr_stmt|;
goto|goto
name|drain_loop
goto|;
block|}
block|}
end_function

begin_function
specifier|static
name|t_Error
name|qman_create_portal
parameter_list|(
name|t_QmPortal
modifier|*
name|p_QmPortal
parameter_list|,
name|uint32_t
name|flags
parameter_list|,
name|uint32_t
name|sdqcrFlags
parameter_list|,
name|uint8_t
name|dqrrSize
parameter_list|)
block|{
specifier|const
name|struct
name|qm_portal_config
modifier|*
name|p_Config
init|=
operator|&
operator|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|->
name|config
operator|)
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|uint32_t
name|isdr
decl_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|qm_eqcr_init
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|e_QmPortalPVB
argument_list|,
name|e_QmPortalEqcrCCE
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
operator|(
literal|"Qman EQCR initialization failed\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|qm_dqrr_init
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|sdqcrFlags
condition|?
name|e_QmPortalDequeuePushMode
else|:
name|e_QmPortalDequeuePullMode
argument_list|,
name|e_QmPortalPVB
argument_list|,
operator|(
name|flags
operator|&
name|QMAN_PORTAL_FLAG_DCA
operator|)
condition|?
name|e_QmPortalDqrrDCA
else|:
name|e_QmPortalDqrrCCI
argument_list|,
name|dqrrSize
argument_list|,
operator|(
name|flags
operator|&
name|QMAN_PORTAL_FLAG_RSTASH
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|,
operator|(
name|flags
operator|&
name|QMAN_PORTAL_FLAG_DSTASH
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|)
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"DQRR initialization failed"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|fail_dqrr
goto|;
block|}
if|if
condition|(
name|qm_mr_init
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|e_QmPortalPVB
argument_list|,
name|e_QmPortalMrCCI
argument_list|)
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"MR initialization failed"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|fail_mr
goto|;
block|}
if|if
condition|(
name|qm_mc_init
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"MC initialization failed"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|fail_mc
goto|;
block|}
if|if
condition|(
name|qm_isr_init
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"ISR initialization failed"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|fail_isr
goto|;
block|}
comment|/* static interrupt-gating controls */
name|qm_dqrr_set_ithresh
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|qm_mr_set_ithresh
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|qm_isr_set_iperiod
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
literal|100
argument_list|)
expr_stmt|;
name|p_QmPortal
operator|->
name|options
operator|=
name|flags
expr_stmt|;
name|isdr
operator|=
literal|0xffffffff
expr_stmt|;
name|qm_isr_status_clear
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|qm_isr_enable_write
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|DEFAULT_portalExceptions
argument_list|)
expr_stmt|;
name|qm_isr_disable_write
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|isdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|QMAN_PORTAL_FLAG_IRQ
condition|)
block|{
name|XX_SetIntr
argument_list|(
name|p_Config
operator|->
name|irq
argument_list|,
name|portal_isr
argument_list|,
name|p_QmPortal
argument_list|)
expr_stmt|;
name|XX_EnableIntr
argument_list|(
name|p_Config
operator|->
name|irq
argument_list|)
expr_stmt|;
name|qm_isr_uninhibit
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* without IRQ, we can't block */
name|flags
operator|&=
operator|~
name|QMAN_PORTAL_FLAG_WAIT
expr_stmt|;
comment|/* Need EQCR to be empty before continuing */
name|isdr
operator|^=
name|QM_PIRQ_EQCI
expr_stmt|;
name|qm_isr_disable_write
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|isdr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|qm_eqcr_get_fill
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"EQCR unclean"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|fail_eqcr_empty
goto|;
block|}
name|isdr
operator|^=
operator|(
name|QM_PIRQ_DQRI
operator||
name|QM_PIRQ_MRI
operator|)
expr_stmt|;
name|qm_isr_disable_write
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|isdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|qm_dqrr_current
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"DQRR unclean"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|fail_dqrr_mr_empty
goto|;
block|}
if|if
condition|(
name|qm_mr_current
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"MR unclean"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|fail_dqrr_mr_empty
goto|;
block|}
name|qm_isr_disable_write
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|qm_dqrr_sdqcr_set
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|sdqcrFlags
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
name|fail_dqrr_mr_empty
label|:
name|fail_eqcr_empty
label|:
name|qm_isr_finish
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|fail_isr
label|:
name|qm_mc_finish
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|fail_mc
label|:
name|qm_mr_finish
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|fail_mr
label|:
name|qm_dqrr_finish
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|fail_dqrr
label|:
name|qm_eqcr_finish
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
return|return
name|ERROR_CODE
argument_list|(
name|E_INVALID_STATE
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|qman_destroy_portal
parameter_list|(
name|t_QmPortal
modifier|*
name|p_QmPortal
parameter_list|)
block|{
comment|/* NB we do this to "quiesce" EQCR. If we add enqueue-completions or      * something related to QM_PIRQ_EQCI, this may need fixing. */
name|qmPortalEqcrCceUpdate
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_QmPortal
operator|->
name|options
operator|&
name|QMAN_PORTAL_FLAG_IRQ
condition|)
block|{
name|XX_DisableIntr
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|->
name|config
operator|.
name|irq
argument_list|)
expr_stmt|;
name|XX_FreeIntr
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|->
name|config
operator|.
name|irq
argument_list|)
expr_stmt|;
block|}
name|qm_isr_finish
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|qm_mc_finish
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|qm_mr_finish
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|qm_dqrr_finish
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|qm_eqcr_finish
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|struct
name|qm_eqcr_entry
modifier|*
name|try_eq_start
parameter_list|(
name|t_QmPortal
modifier|*
name|p_QmPortal
parameter_list|)
block|{
name|struct
name|qm_eqcr_entry
modifier|*
name|p_Eq
decl_stmt|;
name|uint8_t
name|avail
decl_stmt|;
name|avail
operator|=
name|qm_eqcr_get_avail
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
if|if
condition|(
name|avail
operator|==
name|EQCR_THRESH
condition|)
name|qmPortalEqcrCcePrefetch
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|avail
operator|<
name|EQCR_THRESH
condition|)
name|qmPortalEqcrCceUpdate
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|p_Eq
operator|=
name|qm_eqcr_start
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
return|return
name|p_Eq
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|qman_orp_update
parameter_list|(
name|t_QmPortal
modifier|*
name|p_QmPortal
parameter_list|,
name|uint32_t
name|orpId
parameter_list|,
name|uint16_t
name|orpSeqnum
parameter_list|,
name|uint32_t
name|flags
parameter_list|)
block|{
name|struct
name|qm_eqcr_entry
modifier|*
name|p_Eq
decl_stmt|;
name|NCSW_PLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|p_Eq
operator|=
name|try_eq_start
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Eq
condition|)
block|{
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
return|return
name|ERROR_CODE
argument_list|(
name|E_BUSY
argument_list|)
return|;
block|}
if|if
condition|(
name|flags
operator|&
name|QMAN_ENQUEUE_FLAG_NESN
condition|)
name|orpSeqnum
operator||=
name|QM_EQCR_SEQNUM_NESN
expr_stmt|;
else|else
comment|/* No need to check 4 QMAN_ENQUEUE_FLAG_HOLE */
name|orpSeqnum
operator|&=
operator|~
name|QM_EQCR_SEQNUM_NESN
expr_stmt|;
name|p_Eq
operator|->
name|seqnum
operator|=
name|orpSeqnum
expr_stmt|;
name|p_Eq
operator|->
name|orp
operator|=
name|orpId
expr_stmt|;
name|qmPortalEqcrPvbCommit
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
operator|(
name|uint8_t
operator|)
name|QM_EQCR_VERB_ORP
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|t_Error
name|CheckStashParams
parameter_list|(
name|t_QmFqrParams
modifier|*
name|p_QmFqrParams
parameter_list|)
block|{
name|ASSERT_COND
argument_list|(
name|p_QmFqrParams
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_QmFqrParams
operator|->
name|stashingParams
operator|.
name|frameAnnotationSize
operator|>
name|QM_CONTEXTA_MAX_STASH_SIZE
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Frame Annotation Size Exceeded Max Stash Size(%d)"
operator|,
name|QM_CONTEXTA_MAX_STASH_SIZE
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_QmFqrParams
operator|->
name|stashingParams
operator|.
name|frameDataSize
operator|>
name|QM_CONTEXTA_MAX_STASH_SIZE
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Frame Data Size Exceeded Max Stash Size(%d)"
operator|,
name|QM_CONTEXTA_MAX_STASH_SIZE
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_QmFqrParams
operator|->
name|stashingParams
operator|.
name|fqContextSize
operator|>
name|QM_CONTEXTA_MAX_STASH_SIZE
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Frame Context Size Exceeded Max Stash Size(%d)"
operator|,
name|QM_CONTEXTA_MAX_STASH_SIZE
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_QmFqrParams
operator|->
name|stashingParams
operator|.
name|fqContextSize
condition|)
block|{
if|if
condition|(
operator|!
name|p_QmFqrParams
operator|->
name|stashingParams
operator|.
name|fqContextAddr
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"FQ Context Address Must be givven"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|IS_ALIGNED
argument_list|(
name|p_QmFqrParams
operator|->
name|stashingParams
operator|.
name|fqContextAddr
argument_list|,
name|CACHELINE_SIZE
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"FQ Context Address Must be aligned to %d"
operator|,
name|CACHELINE_SIZE
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_QmFqrParams
operator|->
name|stashingParams
operator|.
name|fqContextAddr
operator|&
literal|0xffffff0000000000LL
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"FQ Context Address May be up to 40 bit"
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|QmPortalRegisterCg
parameter_list|(
name|t_Handle
name|h_QmPortal
parameter_list|,
name|t_Handle
name|h_QmCg
parameter_list|,
name|uint8_t
name|cgId
parameter_list|)
block|{
name|t_QmPortal
modifier|*
name|p_QmPortal
init|=
operator|(
name|t_QmPortal
operator|*
operator|)
name|h_QmPortal
decl_stmt|;
comment|/* cgrs[0] is the mask of registered CG's*/
if|if
condition|(
name|p_QmPortal
operator|->
name|cgrs
index|[
literal|0
index|]
operator|.
name|q
operator|.
name|__state
index|[
name|cgId
operator|/
literal|32
index|]
operator|&
operator|(
literal|0x80000000
operator|>>
operator|(
name|cgId
operator|%
literal|32
operator|)
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_BUSY
argument_list|,
operator|(
literal|"CG already used"
operator|)
argument_list|)
expr_stmt|;
name|p_QmPortal
operator|->
name|cgrs
index|[
literal|0
index|]
operator|.
name|q
operator|.
name|__state
index|[
name|cgId
operator|/
literal|32
index|]
operator||=
literal|0x80000000
operator|>>
operator|(
name|cgId
operator|%
literal|32
operator|)
expr_stmt|;
name|p_QmPortal
operator|->
name|cgsHandles
index|[
name|cgId
index|]
operator|=
name|h_QmCg
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|QmPortalUnregisterCg
parameter_list|(
name|t_Handle
name|h_QmPortal
parameter_list|,
name|uint8_t
name|cgId
parameter_list|)
block|{
name|t_QmPortal
modifier|*
name|p_QmPortal
init|=
operator|(
name|t_QmPortal
operator|*
operator|)
name|h_QmPortal
decl_stmt|;
comment|/* cgrs[0] is the mask of registered CG's*/
if|if
condition|(
operator|!
operator|(
name|p_QmPortal
operator|->
name|cgrs
index|[
literal|0
index|]
operator|.
name|q
operator|.
name|__state
index|[
name|cgId
operator|/
literal|32
index|]
operator|&
operator|(
literal|0x80000000
operator|>>
operator|(
name|cgId
operator|%
literal|32
operator|)
operator|)
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_BUSY
argument_list|,
operator|(
literal|"CG is not in use"
operator|)
argument_list|)
expr_stmt|;
name|p_QmPortal
operator|->
name|cgrs
index|[
literal|0
index|]
operator|.
name|q
operator|.
name|__state
index|[
name|cgId
operator|/
literal|32
index|]
operator|&=
operator|~
literal|0x80000000
operator|>>
operator|(
name|cgId
operator|%
literal|32
operator|)
expr_stmt|;
name|p_QmPortal
operator|->
name|cgsHandles
index|[
name|cgId
index|]
operator|=
name|NULL
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|e_DpaaSwPortal
name|QmPortalGetSwPortalId
parameter_list|(
name|t_Handle
name|h_QmPortal
parameter_list|)
block|{
name|t_QmPortal
modifier|*
name|p_QmPortal
init|=
operator|(
name|t_QmPortal
operator|*
operator|)
name|h_QmPortal
decl_stmt|;
return|return
operator|(
name|e_DpaaSwPortal
operator|)
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|->
name|config
operator|.
name|cpu
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|CalcWredCurve
parameter_list|(
name|t_QmCgWredCurve
modifier|*
name|p_WredCurve
parameter_list|,
name|uint32_t
modifier|*
name|p_CurveWord
parameter_list|)
block|{
name|uint32_t
name|maxP
decl_stmt|,
name|roundDown
decl_stmt|,
name|roundUp
decl_stmt|,
name|tmpA
decl_stmt|,
name|tmpN
decl_stmt|;
name|uint32_t
name|ma
init|=
literal|0
decl_stmt|,
name|mn
init|=
literal|0
decl_stmt|,
name|slope
decl_stmt|,
name|sa
init|=
literal|0
decl_stmt|,
name|sn
init|=
literal|0
decl_stmt|,
name|pn
decl_stmt|;
name|int
name|pres
init|=
literal|1000
decl_stmt|;
name|int
name|gap
decl_stmt|,
name|tmp
decl_stmt|;
comment|/*  TODO - change maxTh to uint64_t?    if(p_WredCurve->maxTh> (1<<39))         RETURN_ERROR(MINOR, E_INVALID_VALUE, ("maxTh is not in range"));*/
comment|/* express maxTh as ma*2^mn */
name|gap
operator|=
operator|(
name|int
operator|)
name|p_WredCurve
operator|->
name|maxTh
expr_stmt|;
for|for
control|(
name|tmpA
operator|=
literal|0
init|;
name|tmpA
operator|<
literal|256
condition|;
name|tmpA
operator|++
control|)
for|for
control|(
name|tmpN
operator|=
literal|0
init|;
name|tmpN
operator|<
literal|32
condition|;
name|tmpN
operator|++
control|)
block|{
name|tmp
operator|=
name|ABS
argument_list|(
call|(
name|int
call|)
argument_list|(
name|p_WredCurve
operator|->
name|maxTh
operator|-
name|tmpA
operator|*
operator|(
literal|1
operator|<<
name|tmpN
operator|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|<
name|gap
condition|)
block|{
name|ma
operator|=
name|tmpA
expr_stmt|;
name|mn
operator|=
name|tmpN
expr_stmt|;
name|gap
operator|=
name|tmp
expr_stmt|;
block|}
block|}
name|ASSERT_COND
argument_list|(
name|ma
operator|<
literal|256
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|mn
operator|<
literal|32
argument_list|)
expr_stmt|;
name|p_WredCurve
operator|->
name|maxTh
operator|=
name|ma
operator|*
operator|(
literal|1
operator|<<
name|mn
operator|)
expr_stmt|;
if|if
condition|(
name|p_WredCurve
operator|->
name|maxTh
operator|<=
name|p_WredCurve
operator|->
name|minTh
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"maxTh must be larger than minTh"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_WredCurve
operator|->
name|probabilityDenominator
operator|>
literal|64
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"probabilityDenominator mustn't be 1-64"
operator|)
argument_list|)
expr_stmt|;
comment|/* first we translate from Cisco probabilityDenominator        to 256 fixed denominator, result must be divisible by 4. */
comment|/* we multiply by a fixed value to get better accuracy (without        using floating point) */
name|maxP
operator|=
call|(
name|uint32_t
call|)
argument_list|(
literal|256
operator|*
literal|1000
operator|/
name|p_WredCurve
operator|->
name|probabilityDenominator
argument_list|)
expr_stmt|;
if|if
condition|(
name|maxP
operator|%
literal|4
operator|*
name|pres
condition|)
block|{
name|roundDown
operator|=
name|maxP
operator|+
operator|(
name|maxP
operator|%
operator|(
literal|4
operator|*
name|pres
operator|)
operator|)
expr_stmt|;
name|roundUp
operator|=
name|roundDown
operator|+
literal|4
operator|*
name|pres
expr_stmt|;
if|if
condition|(
operator|(
name|roundUp
operator|-
name|maxP
operator|)
operator|>
operator|(
name|maxP
operator|-
name|roundDown
operator|)
condition|)
name|maxP
operator|=
name|roundDown
expr_stmt|;
else|else
name|maxP
operator|=
name|roundUp
expr_stmt|;
block|}
name|maxP
operator|=
name|maxP
operator|/
name|pres
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|maxP
operator|<=
literal|256
argument_list|)
expr_stmt|;
name|pn
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|maxP
operator|/
literal|4
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|maxP
operator|>=
operator|(
name|p_WredCurve
operator|->
name|maxTh
operator|-
name|p_WredCurve
operator|->
name|minTh
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Due to probabilityDenominator selected, maxTh-minTh must be larger than %d"
operator|,
name|maxP
operator|)
argument_list|)
expr_stmt|;
name|pres
operator|=
literal|1000000
expr_stmt|;
name|slope
operator|=
name|maxP
operator|*
name|pres
operator|/
operator|(
name|p_WredCurve
operator|->
name|maxTh
operator|-
name|p_WredCurve
operator|->
name|minTh
operator|)
expr_stmt|;
comment|/* express slope as sa/2^sn */
name|gap
operator|=
operator|(
name|int
operator|)
name|slope
expr_stmt|;
for|for
control|(
name|tmpA
operator|=
call|(
name|uint32_t
call|)
argument_list|(
literal|64
operator|*
name|pres
argument_list|)
init|;
name|tmpA
operator|<
literal|128
operator|*
name|pres
condition|;
name|tmpA
operator|+=
name|pres
control|)
for|for
control|(
name|tmpN
operator|=
literal|7
init|;
name|tmpN
operator|<
literal|64
condition|;
name|tmpN
operator|++
control|)
block|{
name|tmp
operator|=
name|ABS
argument_list|(
call|(
name|int
call|)
argument_list|(
name|slope
operator|-
name|tmpA
operator|/
operator|(
literal|1
operator|<<
name|tmpN
operator|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|<
name|gap
condition|)
block|{
name|sa
operator|=
name|tmpA
expr_stmt|;
name|sn
operator|=
name|tmpN
expr_stmt|;
name|gap
operator|=
name|tmp
expr_stmt|;
block|}
block|}
name|sa
operator|=
name|sa
operator|/
name|pres
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|sa
operator|<
literal|128
operator|&&
name|sa
operator|>=
literal|64
argument_list|)
expr_stmt|;
name|sn
operator|=
name|sn
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|sn
operator|<
literal|64
operator|&&
name|sn
operator|>=
literal|7
argument_list|)
expr_stmt|;
operator|*
name|p_CurveWord
operator|=
operator|(
operator|(
name|ma
operator|<<
literal|24
operator|)
operator||
operator|(
name|mn
operator|<<
literal|19
operator|)
operator||
operator|(
name|sa
operator|<<
literal|12
operator|)
operator||
operator|(
name|sn
operator|<<
literal|6
operator|)
operator||
name|pn
operator|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|QmPortalPullFrame
parameter_list|(
name|t_Handle
name|h_QmPortal
parameter_list|,
name|uint32_t
name|pdqcr
parameter_list|,
name|t_DpaaFD
modifier|*
name|p_Frame
parameter_list|)
block|{
name|t_QmPortal
modifier|*
name|p_QmPortal
init|=
operator|(
name|t_QmPortal
operator|*
operator|)
name|h_QmPortal
decl_stmt|;
name|struct
name|qm_dqrr_entry
modifier|*
name|p_Dq
decl_stmt|;
name|struct
name|qman_fq
modifier|*
name|p_Fq
decl_stmt|;
name|int
name|prefetch
decl_stmt|;
name|uint32_t
modifier|*
name|p_Dst
decl_stmt|,
modifier|*
name|p_Src
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Frame
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmPortal
operator|->
name|pullMode
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|NCSW_PLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|qm_dqrr_pdqcr_set
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|pdqcr
argument_list|)
expr_stmt|;
name|mb
argument_list|()
expr_stmt|;
while|while
condition|(
name|qm_dqrr_pdqcr_get
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
condition|)
empty_stmt|;
name|prefetch
operator|=
operator|!
operator|(
name|p_QmPortal
operator|->
name|options
operator|&
name|QMAN_PORTAL_FLAG_RSTASH
operator|)
expr_stmt|;
while|while
condition|(
name|TRUE
condition|)
block|{
if|if
condition|(
name|prefetch
condition|)
name|qmPortalDqrrPvbPrefetch
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|qmPortalDqrrPvbUpdate
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|p_Dq
operator|=
name|qm_dqrr_current
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Dq
condition|)
continue|continue;
name|p_Fq
operator|=
name|ptr_from_aligned_int
argument_list|(
name|p_Dq
operator|->
name|contextB
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Dq
operator|->
name|fqid
argument_list|)
expr_stmt|;
name|p_Dst
operator|=
operator|(
name|uint32_t
operator|*
operator|)
name|p_Frame
expr_stmt|;
name|p_Src
operator|=
operator|(
name|uint32_t
operator|*
operator|)
operator|&
name|p_Dq
operator|->
name|fd
expr_stmt|;
name|p_Dst
index|[
literal|0
index|]
operator|=
name|p_Src
index|[
literal|0
index|]
expr_stmt|;
name|p_Dst
index|[
literal|1
index|]
operator|=
name|p_Src
index|[
literal|1
index|]
expr_stmt|;
name|p_Dst
index|[
literal|2
index|]
operator|=
name|p_Src
index|[
literal|2
index|]
expr_stmt|;
name|p_Dst
index|[
literal|3
index|]
operator|=
name|p_Src
index|[
literal|3
index|]
expr_stmt|;
if|if
condition|(
name|p_QmPortal
operator|->
name|options
operator|&
name|QMAN_PORTAL_FLAG_DCA
condition|)
block|{
name|qmPortalDqrrDcaConsume1ptr
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|p_Dq
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|qm_dqrr_next
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|qm_dqrr_next
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|qmPortalDqrrCciConsume
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|p_Dq
operator|->
name|stat
operator|&
name|QM_DQRR_STAT_FD_VALID
operator|)
condition|)
return|return
name|ERROR_CODE
argument_list|(
name|E_EMPTY
argument_list|)
return|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/****************************************/
end_comment

begin_comment
comment|/*       API Init unit functions        */
end_comment

begin_comment
comment|/****************************************/
end_comment

begin_function
name|t_Handle
name|QM_PORTAL_Config
parameter_list|(
name|t_QmPortalParam
modifier|*
name|p_QmPortalParam
parameter_list|)
block|{
name|t_QmPortal
modifier|*
name|p_QmPortal
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_QmPortalParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_QmPortalParam
operator|->
name|swPortalId
operator|<
name|DPAA_MAX_NUM_OF_SW_PORTALS
argument_list|,
name|E_INVALID_VALUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|p_QmPortal
operator|=
operator|(
name|t_QmPortal
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|t_QmPortal
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_QmPortal
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"Qm Portal obj!!!"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_QmPortal
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmPortal
argument_list|)
argument_list|)
expr_stmt|;
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|=
operator|(
expr|struct
name|qm_portal
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|qm_portal
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_QmPortal
operator|->
name|p_LowQmPortal
condition|)
block|{
name|XX_Free
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"Low qm p_QmPortal obj!!!"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|qm_portal
argument_list|)
argument_list|)
expr_stmt|;
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|=
operator|(
name|t_QmPortalDriverParams
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|t_QmPortalDriverParams
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
condition|)
block|{
name|XX_Free
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"Qm Portal driver parameters"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmPortalDriverParams
argument_list|)
argument_list|)
expr_stmt|;
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|->
name|addr
operator|.
name|addr_ce
operator|=
name|UINT_TO_PTR
argument_list|(
name|p_QmPortalParam
operator|->
name|ceBaseAddress
argument_list|)
expr_stmt|;
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|->
name|addr
operator|.
name|addr_ci
operator|=
name|UINT_TO_PTR
argument_list|(
name|p_QmPortalParam
operator|->
name|ciBaseAddress
argument_list|)
expr_stmt|;
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|->
name|config
operator|.
name|irq
operator|=
name|p_QmPortalParam
operator|->
name|irq
expr_stmt|;
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|->
name|config
operator|.
name|bound
operator|=
literal|0
expr_stmt|;
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|->
name|config
operator|.
name|cpu
operator|=
operator|(
name|int
operator|)
name|p_QmPortalParam
operator|->
name|swPortalId
expr_stmt|;
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|->
name|config
operator|.
name|channel
operator|=
call|(
name|e_QmFQChannel
call|)
argument_list|(
name|e_QM_FQ_CHANNEL_SWPORTAL0
operator|+
name|p_QmPortalParam
operator|->
name|swPortalId
argument_list|)
expr_stmt|;
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|->
name|bind_lock
operator|=
name|XX_InitSpinlock
argument_list|()
expr_stmt|;
name|p_QmPortal
operator|->
name|h_Qm
operator|=
name|p_QmPortalParam
operator|->
name|h_Qm
expr_stmt|;
name|p_QmPortal
operator|->
name|f_DfltFrame
operator|=
name|p_QmPortalParam
operator|->
name|f_DfltFrame
expr_stmt|;
name|p_QmPortal
operator|->
name|f_RejectedFrame
operator|=
name|p_QmPortalParam
operator|->
name|f_RejectedFrame
expr_stmt|;
name|p_QmPortal
operator|->
name|h_App
operator|=
name|p_QmPortalParam
operator|->
name|h_App
expr_stmt|;
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|fdLiodnOffset
operator|=
name|p_QmPortalParam
operator|->
name|fdLiodnOffset
expr_stmt|;
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|dequeueDcaMode
operator|=
name|DEFAULT_dequeueDcaMode
expr_stmt|;
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|dequeueUpToThreeFrames
operator|=
name|DEFAULT_dequeueUpToThreeFrames
expr_stmt|;
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|commandType
operator|=
name|DEFAULT_dequeueCommandType
expr_stmt|;
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|userToken
operator|=
name|DEFAULT_dequeueUserToken
expr_stmt|;
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|specifiedWq
operator|=
name|DEFAULT_dequeueSpecifiedWq
expr_stmt|;
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|dedicatedChannel
operator|=
name|DEFAULT_dequeueDedicatedChannel
expr_stmt|;
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|dedicatedChannelHasPrecedenceOverPoolChannels
operator|=
name|DEFAULT_dequeueDedicatedChannelHasPrecedenceOverPoolChannels
expr_stmt|;
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|poolChannelId
operator|=
name|DEFAULT_dequeuePoolChannelId
expr_stmt|;
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|wqId
operator|=
name|DEFAULT_dequeueWqId
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|QM_MAX_NUM_OF_POOL_CHANNELS
condition|;
name|i
operator|++
control|)
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|poolChannels
index|[
name|i
index|]
operator|=
name|FALSE
expr_stmt|;
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|dqrrSize
operator|=
name|DEFAULT_dqrrSize
expr_stmt|;
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|pullMode
operator|=
name|DEFAULT_pullMode
expr_stmt|;
return|return
name|p_QmPortal
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_PORTAL_Init
parameter_list|(
name|t_Handle
name|h_QmPortal
parameter_list|)
block|{
name|t_QmPortal
modifier|*
name|p_QmPortal
init|=
operator|(
name|t_QmPortal
operator|*
operator|)
name|h_QmPortal
decl_stmt|;
name|uint32_t
name|i
decl_stmt|,
name|flags
init|=
literal|0
decl_stmt|,
name|sdqcrFlags
init|=
literal|0
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|t_QmInterModulePortalInitParams
name|qmParams
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmPortal
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|qmParams
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|qmParams
argument_list|)
argument_list|)
expr_stmt|;
name|qmParams
operator|.
name|portalId
operator|=
operator|(
name|uint8_t
operator|)
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|->
name|config
operator|.
name|cpu
expr_stmt|;
name|qmParams
operator|.
name|liodn
operator|=
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|fdLiodnOffset
expr_stmt|;
name|qmParams
operator|.
name|dqrrLiodn
operator|=
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|dqrrLiodn
expr_stmt|;
name|qmParams
operator|.
name|fdFqLiodn
operator|=
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|fdFqLiodn
expr_stmt|;
name|qmParams
operator|.
name|stashDestQueue
operator|=
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|stashDestQueue
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|QmGetSetPortalParams
argument_list|(
name|p_QmPortal
operator|->
name|h_Qm
argument_list|,
operator|&
name|qmParams
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
name|flags
operator|=
call|(
name|uint32_t
call|)
argument_list|(
operator|(
operator|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|->
name|config
operator|.
name|irq
operator|==
name|NO_IRQ
operator|)
condition|?
literal|0
else|:
operator|(
name|QMAN_PORTAL_FLAG_IRQ
operator||
name|QMAN_PORTAL_FLAG_IRQ_FAST
operator||
name|QMAN_PORTAL_FLAG_IRQ_SLOW
operator|)
operator|)
argument_list|)
expr_stmt|;
name|flags
operator||=
operator|(
operator|(
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|dequeueDcaMode
operator|)
condition|?
name|QMAN_PORTAL_FLAG_DCA
else|:
literal|0
operator|)
expr_stmt|;
name|flags
operator||=
operator|(
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|dqrr
operator|)
condition|?
name|QMAN_PORTAL_FLAG_RSTASH
else|:
literal|0
expr_stmt|;
name|flags
operator||=
operator|(
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|fdFq
operator|)
condition|?
name|QMAN_PORTAL_FLAG_DSTASH
else|:
literal|0
expr_stmt|;
name|p_QmPortal
operator|->
name|pullMode
operator|=
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|pullMode
expr_stmt|;
if|if
condition|(
operator|!
name|p_QmPortal
operator|->
name|pullMode
condition|)
block|{
name|sdqcrFlags
operator||=
operator|(
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|dequeueUpToThreeFrames
operator|)
condition|?
name|QM_SDQCR_COUNT_UPTO3
else|:
name|QM_SDQCR_COUNT_EXACT1
expr_stmt|;
name|sdqcrFlags
operator||=
name|QM_SDQCR_TOKEN_SET
argument_list|(
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|userToken
argument_list|)
expr_stmt|;
name|sdqcrFlags
operator||=
name|QM_SDQCR_TYPE_SET
argument_list|(
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|commandType
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|specifiedWq
condition|)
block|{
comment|/* sdqcrFlags |= QM_SDQCR_SOURCE_CHANNELS;*/
comment|/* removed as the macro is '0' */
name|sdqcrFlags
operator||=
operator|(
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|dedicatedChannelHasPrecedenceOverPoolChannels
operator|)
condition|?
name|QM_SDQCR_DEDICATED_PRECEDENCE
else|:
literal|0
expr_stmt|;
name|sdqcrFlags
operator||=
operator|(
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|dedicatedChannel
operator|)
condition|?
name|QM_SDQCR_CHANNELS_DEDICATED
else|:
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|QM_MAX_NUM_OF_POOL_CHANNELS
condition|;
name|i
operator|++
control|)
name|sdqcrFlags
operator||=
operator|(
operator|(
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|poolChannels
index|[
name|i
index|]
operator|)
condition|?
name|QM_SDQCR_CHANNELS_POOL
argument_list|(
name|i
operator|+
literal|1
argument_list|)
else|:
literal|0
operator|)
expr_stmt|;
block|}
else|else
block|{
name|sdqcrFlags
operator||=
name|QM_SDQCR_SOURCE_SPECIFICWQ
expr_stmt|;
name|sdqcrFlags
operator||=
operator|(
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|dedicatedChannel
operator|)
condition|?
name|QM_SDQCR_SPECIFICWQ_DEDICATED
else|:
name|QM_SDQCR_SPECIFICWQ_POOL
argument_list|(
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|poolChannelId
argument_list|)
expr_stmt|;
name|sdqcrFlags
operator||=
name|QM_SDQCR_SPECIFICWQ_WQ
argument_list|(
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|wqId
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|flags
operator|&
name|QMAN_PORTAL_FLAG_RSTASH
operator|)
operator|&&
operator|(
name|flags
operator|&
name|QMAN_PORTAL_FLAG_DCA
operator|)
condition|)
name|p_QmPortal
operator|->
name|f_LoopDequeueRingCB
operator|=
name|LoopDequeueRingDcaOptimized
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|flags
operator|&
name|QMAN_PORTAL_FLAG_RSTASH
operator|)
operator|&&
operator|!
operator|(
name|flags
operator|&
name|QMAN_PORTAL_FLAG_DCA
operator|)
condition|)
name|p_QmPortal
operator|->
name|f_LoopDequeueRingCB
operator|=
name|LoopDequeueRingOptimized
expr_stmt|;
else|else
name|p_QmPortal
operator|->
name|f_LoopDequeueRingCB
operator|=
name|LoopDequeueRing
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|p_QmPortal
operator|->
name|f_RejectedFrame
operator|)
operator|||
operator|(
operator|!
name|p_QmPortal
operator|->
name|f_DfltFrame
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"f_RejectedFrame or f_DfltFrame callback not provided"
operator|)
argument_list|)
expr_stmt|;
name|p_QmPortal
operator|->
name|p_NullCB
operator|=
operator|(
expr|struct
name|qman_fq_cb
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|qman_fq_cb
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_QmPortal
operator|->
name|p_NullCB
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"FQ Null CB obj!!!"
operator|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p_QmPortal
operator|->
name|p_NullCB
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|qman_fq_cb
argument_list|)
argument_list|)
expr_stmt|;
name|p_QmPortal
operator|->
name|p_NullCB
operator|->
name|dqrr
operator|=
name|p_QmPortal
operator|->
name|f_DfltFrame
expr_stmt|;
name|p_QmPortal
operator|->
name|p_NullCB
operator|->
name|ern
operator|=
name|p_QmPortal
operator|->
name|f_RejectedFrame
expr_stmt|;
name|p_QmPortal
operator|->
name|p_NullCB
operator|->
name|dc_ern
operator|=
name|p_QmPortal
operator|->
name|p_NullCB
operator|->
name|fqs
operator|=
name|null_cb_mr
expr_stmt|;
if|if
condition|(
name|qman_create_portal
argument_list|(
name|p_QmPortal
argument_list|,
name|flags
argument_list|,
name|sdqcrFlags
argument_list|,
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|dqrrSize
argument_list|)
operator|!=
name|E_OK
condition|)
block|{
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"create portal failed"
operator|)
argument_list|)
expr_stmt|;
block|}
name|QmSetPortalHandle
argument_list|(
name|p_QmPortal
operator|->
name|h_Qm
argument_list|,
operator|(
name|t_Handle
operator|)
name|p_QmPortal
argument_list|,
operator|(
name|e_DpaaSwPortal
operator|)
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|->
name|config
operator|.
name|cpu
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
argument_list|)
expr_stmt|;
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|=
name|NULL
expr_stmt|;
name|DBG
argument_list|(
name|TRACE
argument_list|,
operator|(
literal|"Qman-Portal %d @ %p:%p"
operator|,
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|->
name|config
operator|.
name|cpu
operator|,
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|->
name|addr
operator|.
name|addr_ce
operator|,
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|->
name|addr
operator|.
name|addr_ci
operator|)
argument_list|)
expr_stmt|;
name|DBG
argument_list|(
name|TRACE
argument_list|,
operator|(
literal|"Qman-Portal %d phys @ 0x%016llx:0x%016llx"
operator|,
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|->
name|config
operator|.
name|cpu
operator|,
operator|(
name|uint64_t
operator|)
name|XX_VirtToPhys
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|->
name|addr
operator|.
name|addr_ce
argument_list|)
operator|,
operator|(
name|uint64_t
operator|)
name|XX_VirtToPhys
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|->
name|addr
operator|.
name|addr_ci
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_PORTAL_Free
parameter_list|(
name|t_Handle
name|h_QmPortal
parameter_list|)
block|{
name|t_QmPortal
modifier|*
name|p_QmPortal
init|=
operator|(
name|t_QmPortal
operator|*
operator|)
name|h_QmPortal
decl_stmt|;
if|if
condition|(
operator|!
name|p_QmPortal
condition|)
return|return
name|ERROR_CODE
argument_list|(
name|E_INVALID_HANDLE
argument_list|)
return|;
name|ASSERT_COND
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|QmSetPortalHandle
argument_list|(
name|p_QmPortal
operator|->
name|h_Qm
argument_list|,
name|NULL
argument_list|,
operator|(
name|e_DpaaSwPortal
operator|)
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|->
name|config
operator|.
name|cpu
argument_list|)
expr_stmt|;
name|qman_destroy_portal
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_QmPortal
operator|->
name|p_NullCB
condition|)
name|XX_Free
argument_list|(
name|p_QmPortal
operator|->
name|p_NullCB
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|->
name|bind_lock
condition|)
name|XX_FreeSpinlock
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
operator|->
name|bind_lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
condition|)
name|XX_Free
argument_list|(
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_PORTAL_ConfigDcaMode
parameter_list|(
name|t_Handle
name|h_QmPortal
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_QmPortal
modifier|*
name|p_QmPortal
init|=
operator|(
name|t_QmPortal
operator|*
operator|)
name|h_QmPortal
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmPortal
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|dequeueDcaMode
operator|=
name|enable
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_PORTAL_ConfigStash
parameter_list|(
name|t_Handle
name|h_QmPortal
parameter_list|,
name|t_QmPortalStashParam
modifier|*
name|p_StashParams
parameter_list|)
block|{
name|t_QmPortal
modifier|*
name|p_QmPortal
init|=
operator|(
name|t_QmPortal
operator|*
operator|)
name|h_QmPortal
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmPortal
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_StashParams
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|stashDestQueue
operator|=
name|p_StashParams
operator|->
name|stashDestQueue
expr_stmt|;
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|dqrrLiodn
operator|=
name|p_StashParams
operator|->
name|dqrrLiodn
expr_stmt|;
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|fdFqLiodn
operator|=
name|p_StashParams
operator|->
name|fdFqLiodn
expr_stmt|;
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|eqcr
operator|=
name|p_StashParams
operator|->
name|eqcr
expr_stmt|;
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|eqcrHighPri
operator|=
name|p_StashParams
operator|->
name|eqcrHighPri
expr_stmt|;
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|dqrr
operator|=
name|p_StashParams
operator|->
name|dqrr
expr_stmt|;
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|dqrrHighPri
operator|=
name|p_StashParams
operator|->
name|dqrrHighPri
expr_stmt|;
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|fdFq
operator|=
name|p_StashParams
operator|->
name|fdFq
expr_stmt|;
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|fdFqHighPri
operator|=
name|p_StashParams
operator|->
name|fdFqHighPri
expr_stmt|;
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|fdFqDrop
operator|=
name|p_StashParams
operator|->
name|fdFqDrop
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_PORTAL_ConfigPullMode
parameter_list|(
name|t_Handle
name|h_QmPortal
parameter_list|,
name|bool
name|pullMode
parameter_list|)
block|{
name|t_QmPortal
modifier|*
name|p_QmPortal
init|=
operator|(
name|t_QmPortal
operator|*
operator|)
name|h_QmPortal
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmPortal
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|p_QmPortal
operator|->
name|p_QmPortalDriverParams
operator|->
name|pullMode
operator|=
name|pullMode
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_PORTAL_AddPoolChannel
parameter_list|(
name|t_Handle
name|h_QmPortal
parameter_list|,
name|uint8_t
name|poolChannelId
parameter_list|)
block|{
name|t_QmPortal
modifier|*
name|p_QmPortal
init|=
operator|(
name|t_QmPortal
operator|*
operator|)
name|h_QmPortal
decl_stmt|;
name|uint32_t
name|sdqcrFlags
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmPortal
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|poolChannelId
operator|<
name|QM_MAX_NUM_OF_POOL_CHANNELS
operator|)
argument_list|,
name|E_INVALID_VALUE
argument_list|)
expr_stmt|;
name|sdqcrFlags
operator|=
name|qm_dqrr_sdqcr_get
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|sdqcrFlags
operator||=
name|QM_SDQCR_CHANNELS_POOL
argument_list|(
name|poolChannelId
operator|+
literal|1
argument_list|)
expr_stmt|;
name|qm_dqrr_sdqcr_set
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|sdqcrFlags
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_PORTAL_Poll
parameter_list|(
name|t_Handle
name|h_QmPortal
parameter_list|,
name|e_QmPortalPollSource
name|source
parameter_list|)
block|{
name|t_QmPortal
modifier|*
name|p_QmPortal
init|=
operator|(
name|t_QmPortal
operator|*
operator|)
name|h_QmPortal
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmPortal
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|NCSW_PLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|source
operator|==
name|e_QM_PORTAL_POLL_SOURCE_CONTROL_FRAMES
operator|)
operator|||
operator|(
name|source
operator|==
name|e_QM_PORTAL_POLL_SOURCE_BOTH
operator|)
condition|)
block|{
name|uint32_t
name|is
init|=
name|qm_isr_status_read
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
decl_stmt|;
name|uint32_t
name|active
init|=
name|LoopMessageRing
argument_list|(
name|p_QmPortal
argument_list|,
name|is
argument_list|)
decl_stmt|;
if|if
condition|(
name|active
condition|)
name|qm_isr_status_clear
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|active
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|source
operator|==
name|e_QM_PORTAL_POLL_SOURCE_DATA_FRAMES
operator|)
operator|||
operator|(
name|source
operator|==
name|e_QM_PORTAL_POLL_SOURCE_BOTH
operator|)
condition|)
name|p_QmPortal
operator|->
name|f_LoopDequeueRingCB
argument_list|(
operator|(
name|t_Handle
operator|)
name|p_QmPortal
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_PORTAL_PollFrame
parameter_list|(
name|t_Handle
name|h_QmPortal
parameter_list|,
name|t_QmPortalFrameInfo
modifier|*
name|p_frameInfo
parameter_list|)
block|{
name|t_QmPortal
modifier|*
name|p_QmPortal
init|=
operator|(
name|t_QmPortal
operator|*
operator|)
name|h_QmPortal
decl_stmt|;
name|struct
name|qm_dqrr_entry
modifier|*
name|p_Dq
decl_stmt|;
name|struct
name|qman_fq
modifier|*
name|p_Fq
decl_stmt|;
name|int
name|prefetch
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmPortal
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_frameInfo
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|NCSW_PLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|prefetch
operator|=
operator|!
operator|(
name|p_QmPortal
operator|->
name|options
operator|&
name|QMAN_PORTAL_FLAG_RSTASH
operator|)
expr_stmt|;
if|if
condition|(
name|prefetch
condition|)
name|qmPortalDqrrPvbPrefetch
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|qmPortalDqrrPvbUpdate
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|p_Dq
operator|=
name|qm_dqrr_current
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Dq
condition|)
block|{
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
return|return
name|ERROR_CODE
argument_list|(
name|E_EMPTY
argument_list|)
return|;
block|}
name|p_Fq
operator|=
name|ptr_from_aligned_int
argument_list|(
name|p_Dq
operator|->
name|contextB
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Dq
operator|->
name|fqid
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Fq
condition|)
block|{
name|p_frameInfo
operator|->
name|h_App
operator|=
name|p_Fq
operator|->
name|h_App
expr_stmt|;
name|p_frameInfo
operator|->
name|h_QmFqr
operator|=
name|p_Fq
operator|->
name|h_QmFqr
expr_stmt|;
name|p_frameInfo
operator|->
name|fqidOffset
operator|=
name|p_Fq
operator|->
name|fqidOffset
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|&
name|p_frameInfo
operator|->
name|frame
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|p_Dq
operator|->
name|fd
argument_list|,
sizeof|sizeof
argument_list|(
name|t_DpaaFD
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|p_frameInfo
operator|->
name|h_App
operator|=
name|p_QmPortal
operator|->
name|h_App
expr_stmt|;
name|p_frameInfo
operator|->
name|h_QmFqr
operator|=
name|NULL
expr_stmt|;
name|p_frameInfo
operator|->
name|fqidOffset
operator|=
name|p_Dq
operator|->
name|fqid
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|&
name|p_frameInfo
operator|->
name|frame
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|&
name|p_Dq
operator|->
name|fd
argument_list|,
sizeof|sizeof
argument_list|(
name|t_DpaaFD
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p_QmPortal
operator|->
name|options
operator|&
name|QMAN_PORTAL_FLAG_DCA
condition|)
block|{
name|qmPortalDqrrDcaConsume1ptr
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|p_Dq
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|qm_dqrr_next
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|qm_dqrr_next
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|qmPortalDqrrCciConsume
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Handle
name|QM_FQR_Create
parameter_list|(
name|t_QmFqrParams
modifier|*
name|p_QmFqrParams
parameter_list|)
block|{
name|t_QmFqr
modifier|*
name|p_QmFqr
decl_stmt|;
name|uint32_t
name|i
decl_stmt|,
name|flags
init|=
literal|0
decl_stmt|;
name|u_QmFqdContextA
name|cnxtA
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_QmFqrParams
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_QmFqrParams
operator|->
name|h_Qm
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_QmFqrParams
operator|->
name|shadowMode
operator|&&
operator|(
operator|!
name|p_QmFqrParams
operator|->
name|useForce
operator|||
name|p_QmFqrParams
operator|->
name|numOfFqids
operator|!=
literal|1
operator|)
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_CONFLICT
argument_list|,
operator|(
literal|"shadowMode must be use with useForce and numOfFqids==1!!!"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|p_QmFqr
operator|=
operator|(
name|t_QmFqr
operator|*
operator|)
name|XX_MallocSmart
argument_list|(
sizeof|sizeof
argument_list|(
name|t_QmFqr
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|64
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_QmFqr
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"QM FQR obj!!!"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_QmFqr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmFqr
argument_list|)
argument_list|)
expr_stmt|;
name|p_QmFqr
operator|->
name|h_Qm
operator|=
name|p_QmFqrParams
operator|->
name|h_Qm
expr_stmt|;
name|p_QmFqr
operator|->
name|h_QmPortal
operator|=
name|p_QmFqrParams
operator|->
name|h_QmPortal
expr_stmt|;
name|p_QmFqr
operator|->
name|shadowMode
operator|=
name|p_QmFqrParams
operator|->
name|shadowMode
expr_stmt|;
name|p_QmFqr
operator|->
name|numOfFqids
operator|=
operator|(
name|p_QmFqrParams
operator|->
name|useForce
operator|&&
operator|!
name|p_QmFqrParams
operator|->
name|numOfFqids
operator|)
condition|?
literal|1
else|:
name|p_QmFqrParams
operator|->
name|numOfFqids
expr_stmt|;
if|if
condition|(
operator|!
name|p_QmFqr
operator|->
name|h_QmPortal
condition|)
block|{
name|p_QmFqr
operator|->
name|h_QmPortal
operator|=
name|QmGetPortalHandle
argument_list|(
name|p_QmFqr
operator|->
name|h_Qm
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_QmFqr
operator|->
name|h_QmPortal
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|p_QmFqr
operator|->
name|p_Fqs
operator|=
operator|(
expr|struct
name|qman_fq
operator|*
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|qman_fq
operator|*
argument_list|)
operator|*
name|p_QmFqr
operator|->
name|numOfFqids
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_QmFqr
operator|->
name|p_Fqs
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"QM FQs obj!!!"
operator|)
argument_list|)
expr_stmt|;
name|QM_FQR_Free
argument_list|(
name|p_QmFqr
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_QmFqr
operator|->
name|p_Fqs
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|qman_fq
operator|*
argument_list|)
operator|*
name|p_QmFqr
operator|->
name|numOfFqids
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_QmFqr
operator|->
name|shadowMode
condition|)
block|{
name|struct
name|qman_fq
modifier|*
name|p_Fq
init|=
name|NULL
decl_stmt|;
name|p_QmFqr
operator|->
name|fqidBase
operator|=
name|p_QmFqrParams
operator|->
name|qs
operator|.
name|frcQ
operator|.
name|fqid
expr_stmt|;
name|p_Fq
operator|=
operator|(
expr|struct
name|qman_fq
operator|*
operator|)
name|XX_MallocSmart
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|qman_fq
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|64
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Fq
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"FQ obj!!!"
operator|)
argument_list|)
expr_stmt|;
name|QM_FQR_Free
argument_list|(
name|p_QmFqr
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_Fq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|qman_fq
argument_list|)
argument_list|)
expr_stmt|;
name|p_Fq
operator|->
name|cb
operator|.
name|dqrr
operator|=
operator|(
operator|(
name|t_QmPortal
operator|*
operator|)
name|p_QmFqr
operator|->
name|h_QmPortal
operator|)
operator|->
name|f_DfltFrame
expr_stmt|;
name|p_Fq
operator|->
name|cb
operator|.
name|ern
operator|=
operator|(
operator|(
name|t_QmPortal
operator|*
operator|)
name|p_QmFqr
operator|->
name|h_QmPortal
operator|)
operator|->
name|f_RejectedFrame
expr_stmt|;
name|p_Fq
operator|->
name|cb
operator|.
name|dc_ern
operator|=
name|cb_ern_dcErn
expr_stmt|;
name|p_Fq
operator|->
name|cb
operator|.
name|fqs
operator|=
name|cb_fqs
expr_stmt|;
name|p_Fq
operator|->
name|h_App
operator|=
operator|(
operator|(
name|t_QmPortal
operator|*
operator|)
name|p_QmFqr
operator|->
name|h_QmPortal
operator|)
operator|->
name|h_App
expr_stmt|;
name|p_Fq
operator|->
name|h_QmFqr
operator|=
name|p_QmFqr
expr_stmt|;
name|p_Fq
operator|->
name|state
operator|=
name|qman_fq_state_sched
expr_stmt|;
name|p_Fq
operator|->
name|fqid
operator|=
name|p_QmFqr
operator|->
name|fqidBase
expr_stmt|;
name|p_QmFqr
operator|->
name|p_Fqs
index|[
literal|0
index|]
operator|=
name|p_Fq
expr_stmt|;
block|}
else|else
block|{
name|p_QmFqr
operator|->
name|channel
operator|=
name|p_QmFqrParams
operator|->
name|channel
expr_stmt|;
name|p_QmFqr
operator|->
name|workQueue
operator|=
name|p_QmFqrParams
operator|->
name|wq
expr_stmt|;
name|p_QmFqr
operator|->
name|fqidBase
operator|=
name|QmFqidGet
argument_list|(
name|p_QmFqr
operator|->
name|h_Qm
argument_list|,
name|p_QmFqr
operator|->
name|numOfFqids
argument_list|,
name|p_QmFqrParams
operator|->
name|qs
operator|.
name|nonFrcQs
operator|.
name|align
argument_list|,
name|p_QmFqrParams
operator|->
name|useForce
argument_list|,
name|p_QmFqrParams
operator|->
name|qs
operator|.
name|frcQ
operator|.
name|fqid
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_QmFqr
operator|->
name|fqidBase
operator|==
operator|(
name|uint32_t
operator|)
name|ILLEGAL_BASE
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|CRITICAL
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"can't allocate a fqid"
operator|)
argument_list|)
expr_stmt|;
name|QM_FQR_Free
argument_list|(
name|p_QmFqr
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|p_QmFqrParams
operator|->
name|congestionAvoidanceEnable
operator|&&
operator|(
name|p_QmFqrParams
operator|->
name|congestionAvoidanceParams
operator|.
name|h_QmCg
operator|==
name|NULL
operator|)
operator|&&
operator|(
name|p_QmFqrParams
operator|->
name|congestionAvoidanceParams
operator|.
name|fqTailDropThreshold
operator|==
literal|0
operator|)
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|CRITICAL
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"NULL congestion group handle and no FQ Threshold"
operator|)
argument_list|)
expr_stmt|;
name|QM_FQR_Free
argument_list|(
name|p_QmFqr
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|p_QmFqrParams
operator|->
name|congestionAvoidanceEnable
condition|)
block|{
if|if
condition|(
name|p_QmFqrParams
operator|->
name|congestionAvoidanceParams
operator|.
name|h_QmCg
condition|)
name|flags
operator||=
name|QM_FQCTRL_CGE
expr_stmt|;
if|if
condition|(
name|p_QmFqrParams
operator|->
name|congestionAvoidanceParams
operator|.
name|fqTailDropThreshold
condition|)
name|flags
operator||=
name|QM_FQCTRL_TDE
expr_stmt|;
block|}
comment|/*         flags |= (p_QmFqrParams->holdActive)    ? QM_FQCTRL_ORP : 0;         flags |= (p_QmFqrParams->holdActive)    ? QM_FQCTRL_CPCSTASH : 0;         flags |= (p_QmFqrParams->holdActive)    ? QM_FQCTRL_FORCESFDR : 0;         flags |= (p_QmFqrParams->holdActive)    ? QM_FQCTRL_AVOIDBLOCK : 0;     */
name|flags
operator||=
operator|(
name|p_QmFqrParams
operator|->
name|holdActive
operator|)
condition|?
name|QM_FQCTRL_HOLDACTIVE
else|:
literal|0
expr_stmt|;
name|flags
operator||=
operator|(
name|p_QmFqrParams
operator|->
name|preferInCache
operator|)
condition|?
name|QM_FQCTRL_LOCKINCACHE
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|p_QmFqrParams
operator|->
name|useContextAForStash
condition|)
block|{
if|if
condition|(
name|CheckStashParams
argument_list|(
name|p_QmFqrParams
argument_list|)
operator|!=
name|E_OK
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|CRITICAL
argument_list|,
name|E_INVALID_STATE
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
name|QM_FQR_Free
argument_list|(
name|p_QmFqr
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
operator|&
name|cnxtA
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cnxtA
argument_list|)
argument_list|)
expr_stmt|;
name|cnxtA
operator|.
name|stashing
operator|.
name|annotation_cl
operator|=
name|DIV_CEIL
argument_list|(
name|p_QmFqrParams
operator|->
name|stashingParams
operator|.
name|frameAnnotationSize
argument_list|,
name|CACHELINE_SIZE
argument_list|)
expr_stmt|;
name|cnxtA
operator|.
name|stashing
operator|.
name|data_cl
operator|=
name|DIV_CEIL
argument_list|(
name|p_QmFqrParams
operator|->
name|stashingParams
operator|.
name|frameDataSize
argument_list|,
name|CACHELINE_SIZE
argument_list|)
expr_stmt|;
name|cnxtA
operator|.
name|stashing
operator|.
name|context_cl
operator|=
name|DIV_CEIL
argument_list|(
name|p_QmFqrParams
operator|->
name|stashingParams
operator|.
name|fqContextSize
argument_list|,
name|CACHELINE_SIZE
argument_list|)
expr_stmt|;
name|cnxtA
operator|.
name|context_hi
operator|=
call|(
name|uint8_t
call|)
argument_list|(
operator|(
name|p_QmFqrParams
operator|->
name|stashingParams
operator|.
name|fqContextAddr
operator|>>
literal|32
operator|)
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|cnxtA
operator|.
name|context_lo
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|p_QmFqrParams
operator|->
name|stashingParams
operator|.
name|fqContextAddr
argument_list|)
expr_stmt|;
name|flags
operator||=
name|QM_FQCTRL_CTXASTASHING
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p_QmFqr
operator|->
name|numOfFqids
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|qm_new_fq
argument_list|(
name|p_QmFqr
operator|->
name|h_QmPortal
argument_list|,
name|p_QmFqr
operator|->
name|fqidBase
operator|+
name|i
argument_list|,
name|i
argument_list|,
name|p_QmFqr
operator|->
name|channel
argument_list|,
name|p_QmFqr
operator|->
name|workQueue
argument_list|,
literal|1
comment|/*p_QmFqr->numOfFqids*/
argument_list|,
name|flags
argument_list|,
operator|(
name|p_QmFqrParams
operator|->
name|congestionAvoidanceEnable
condition|?
operator|&
name|p_QmFqrParams
operator|->
name|congestionAvoidanceParams
else|:
name|NULL
operator|)
argument_list|,
name|p_QmFqrParams
operator|->
name|useContextAForStash
condition|?
operator|(
name|t_QmContextA
operator|*
operator|)
operator|&
name|cnxtA
else|:
name|p_QmFqrParams
operator|->
name|p_ContextA
argument_list|,
name|p_QmFqrParams
operator|->
name|p_ContextB
argument_list|,
name|p_QmFqrParams
operator|->
name|initParked
argument_list|,
name|p_QmFqr
argument_list|,
operator|&
name|p_QmFqr
operator|->
name|p_Fqs
index|[
name|i
index|]
argument_list|)
operator|!=
name|E_OK
condition|)
block|{
name|QM_FQR_Free
argument_list|(
name|p_QmFqr
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
return|return
name|p_QmFqr
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_FQR_Free
parameter_list|(
name|t_Handle
name|h_QmFqr
parameter_list|)
block|{
name|t_QmFqr
modifier|*
name|p_QmFqr
init|=
operator|(
name|t_QmFqr
operator|*
operator|)
name|h_QmFqr
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|p_QmFqr
condition|)
return|return
name|ERROR_CODE
argument_list|(
name|E_INVALID_HANDLE
argument_list|)
return|;
if|if
condition|(
name|p_QmFqr
operator|->
name|p_Fqs
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p_QmFqr
operator|->
name|numOfFqids
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|p_QmFqr
operator|->
name|p_Fqs
index|[
name|i
index|]
condition|)
block|{
if|if
condition|(
operator|!
name|p_QmFqr
operator|->
name|shadowMode
condition|)
name|qm_free_fq
argument_list|(
name|p_QmFqr
operator|->
name|h_QmPortal
argument_list|,
name|p_QmFqr
operator|->
name|p_Fqs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_QmFqr
operator|->
name|p_Fqs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|XX_Free
argument_list|(
name|p_QmFqr
operator|->
name|p_Fqs
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|p_QmFqr
operator|->
name|shadowMode
operator|&&
name|p_QmFqr
operator|->
name|fqidBase
condition|)
name|QmFqidPut
argument_list|(
name|p_QmFqr
operator|->
name|h_Qm
argument_list|,
name|p_QmFqr
operator|->
name|fqidBase
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_QmFqr
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_FQR_FreeWDrain
parameter_list|(
name|t_Handle
name|h_QmFqr
parameter_list|,
name|t_QmFqrDrainedCompletionCB
modifier|*
name|f_CompletionCB
parameter_list|,
name|bool
name|deliverFrame
parameter_list|,
name|t_QmReceivedFrameCallback
modifier|*
name|f_CallBack
parameter_list|,
name|t_Handle
name|h_App
parameter_list|)
block|{
name|t_QmFqr
modifier|*
name|p_QmFqr
init|=
operator|(
name|t_QmFqr
operator|*
operator|)
name|h_QmFqr
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|p_QmFqr
condition|)
return|return
name|ERROR_CODE
argument_list|(
name|E_INVALID_HANDLE
argument_list|)
return|;
if|if
condition|(
name|p_QmFqr
operator|->
name|shadowMode
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_OPERATION
argument_list|,
operator|(
literal|"QM_FQR_FreeWDrain can't be called to shadow FQR!!!. call QM_FQR_Free"
operator|)
argument_list|)
expr_stmt|;
name|p_QmFqr
operator|->
name|p_DrainedFqs
operator|=
operator|(
name|bool
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|bool
argument_list|)
operator|*
name|p_QmFqr
operator|->
name|numOfFqids
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_QmFqr
operator|->
name|p_DrainedFqs
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"QM Drained-FQs obj!!!. Try to Free without draining"
operator|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p_QmFqr
operator|->
name|p_DrainedFqs
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|bool
argument_list|)
operator|*
name|p_QmFqr
operator|->
name|numOfFqids
argument_list|)
expr_stmt|;
if|if
condition|(
name|f_CompletionCB
condition|)
block|{
name|p_QmFqr
operator|->
name|f_CompletionCB
operator|=
name|f_CompletionCB
expr_stmt|;
name|p_QmFqr
operator|->
name|h_App
operator|=
name|h_App
expr_stmt|;
block|}
if|if
condition|(
name|deliverFrame
condition|)
block|{
if|if
condition|(
operator|!
name|f_CallBack
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NULL_POINTER
argument_list|,
operator|(
literal|"f_CallBack must be given."
operator|)
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_QmFqr
operator|->
name|p_DrainedFqs
argument_list|)
expr_stmt|;
return|return
name|ERROR_CODE
argument_list|(
name|E_NULL_POINTER
argument_list|)
return|;
block|}
name|QM_FQR_RegisterCB
argument_list|(
name|p_QmFqr
argument_list|,
name|f_CallBack
argument_list|,
name|h_App
argument_list|)
expr_stmt|;
block|}
else|else
name|QM_FQR_RegisterCB
argument_list|(
name|p_QmFqr
argument_list|,
name|drainCB
argument_list|,
name|h_App
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p_QmFqr
operator|->
name|numOfFqids
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|qman_retire_fq
argument_list|(
name|p_QmFqr
operator|->
name|h_QmPortal
argument_list|,
name|p_QmFqr
operator|->
name|p_Fqs
index|[
name|i
index|]
argument_list|,
literal|0
argument_list|,
name|true
argument_list|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"qman_retire_fq() failed!"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_QmFqr
operator|->
name|p_Fqs
index|[
name|i
index|]
operator|->
name|flags
operator|&
name|QMAN_FQ_STATE_CHANGING
condition|)
name|DBG
argument_list|(
name|INFO
argument_list|,
operator|(
literal|"fq %d currently in use, will be retired"
operator|,
name|p_QmFqr
operator|->
name|p_Fqs
index|[
name|i
index|]
operator|->
name|fqid
operator|)
argument_list|)
expr_stmt|;
else|else
name|drainRetiredFq
argument_list|(
name|p_QmFqr
operator|->
name|p_Fqs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|p_QmFqr
operator|->
name|f_CompletionCB
condition|)
block|{
while|while
condition|(
name|p_QmFqr
operator|->
name|p_DrainedFqs
condition|)
empty_stmt|;
name|DBG
argument_list|(
name|TRACE
argument_list|,
operator|(
literal|"QM-FQR with base %d completed"
operator|,
name|p_QmFqr
operator|->
name|fqidBase
operator|)
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_QmFqr
operator|->
name|p_Fqs
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_QmFqr
operator|->
name|fqidBase
condition|)
name|QmFqidPut
argument_list|(
name|p_QmFqr
operator|->
name|h_Qm
argument_list|,
name|p_QmFqr
operator|->
name|fqidBase
argument_list|)
expr_stmt|;
name|XX_FreeSmart
argument_list|(
name|p_QmFqr
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_FQR_RegisterCB
parameter_list|(
name|t_Handle
name|h_QmFqr
parameter_list|,
name|t_QmReceivedFrameCallback
modifier|*
name|f_CallBack
parameter_list|,
name|t_Handle
name|h_App
parameter_list|)
block|{
name|t_QmFqr
modifier|*
name|p_QmFqr
init|=
operator|(
name|t_QmFqr
operator|*
operator|)
name|h_QmFqr
decl_stmt|;
name|int
name|i
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmFqr
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p_QmFqr
operator|->
name|numOfFqids
condition|;
name|i
operator|++
control|)
block|{
name|p_QmFqr
operator|->
name|p_Fqs
index|[
name|i
index|]
operator|->
name|cb
operator|.
name|dqrr
operator|=
name|f_CallBack
expr_stmt|;
name|p_QmFqr
operator|->
name|p_Fqs
index|[
name|i
index|]
operator|->
name|h_App
operator|=
name|h_App
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_FQR_Enqueue
parameter_list|(
name|t_Handle
name|h_QmFqr
parameter_list|,
name|t_Handle
name|h_QmPortal
parameter_list|,
name|uint32_t
name|fqidOffset
parameter_list|,
name|t_DpaaFD
modifier|*
name|p_Frame
parameter_list|)
block|{
name|t_QmFqr
modifier|*
name|p_QmFqr
init|=
operator|(
name|t_QmFqr
operator|*
operator|)
name|h_QmFqr
decl_stmt|;
name|t_QmPortal
modifier|*
name|p_QmPortal
decl_stmt|;
name|struct
name|qm_eqcr_entry
modifier|*
name|p_Eq
decl_stmt|;
name|uint32_t
modifier|*
name|p_Dst
decl_stmt|,
modifier|*
name|p_Src
decl_stmt|;
specifier|const
name|struct
name|qman_fq
modifier|*
name|p_Fq
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmFqr
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|fqidOffset
operator|<
name|p_QmFqr
operator|->
name|numOfFqids
operator|)
argument_list|,
name|E_INVALID_VALUE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|h_QmPortal
condition|)
block|{
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmFqr
operator|->
name|h_Qm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|h_QmPortal
operator|=
name|QmGetPortalHandle
argument_list|(
name|p_QmFqr
operator|->
name|h_Qm
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|h_QmPortal
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
block|}
name|p_QmPortal
operator|=
operator|(
name|t_QmPortal
operator|*
operator|)
name|h_QmPortal
expr_stmt|;
name|p_Fq
operator|=
name|p_QmFqr
operator|->
name|p_Fqs
index|[
name|fqidOffset
index|]
expr_stmt|;
ifdef|#
directive|ifdef
name|QM_CHECKING
if|if
condition|(
name|p_Fq
operator|->
name|flags
operator|&
name|QMAN_FQ_FLAG_NO_ENQUEUE
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|!
operator|(
name|p_Fq
operator|->
name|flags
operator|&
name|QMAN_FQ_FLAG_NO_MODIFY
operator|)
operator|)
operator|&&
operator|(
operator|(
name|p_Fq
operator|->
name|state
operator|==
name|qman_fq_state_retired
operator|)
operator|||
operator|(
name|p_Fq
operator|->
name|state
operator|==
name|qman_fq_state_oos
operator|)
operator|)
condition|)
return|return
name|ERROR_CODE
argument_list|(
name|E_BUSY
argument_list|)
return|;
endif|#
directive|endif
comment|/* QM_CHECKING */
name|NCSW_PLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|p_Eq
operator|=
name|try_eq_start
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Eq
condition|)
block|{
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
return|return
name|ERROR_CODE
argument_list|(
name|E_BUSY
argument_list|)
return|;
block|}
name|p_Eq
operator|->
name|fqid
operator|=
name|p_Fq
operator|->
name|fqid
expr_stmt|;
name|p_Eq
operator|->
name|tag
operator|=
name|aligned_int_from_ptr
argument_list|(
name|p_Fq
argument_list|)
expr_stmt|;
comment|/* gcc does a dreadful job of the following;      *  eq->fd = *fd;      * It causes the entire function to save/restore a wider range of      * registers, and comes up with instruction-waste galore. This will do      * until we can rework the function for better code-generation. */
name|p_Dst
operator|=
operator|(
name|uint32_t
operator|*
operator|)
operator|&
name|p_Eq
operator|->
name|fd
expr_stmt|;
name|p_Src
operator|=
operator|(
name|uint32_t
operator|*
operator|)
name|p_Frame
expr_stmt|;
name|p_Dst
index|[
literal|0
index|]
operator|=
name|p_Src
index|[
literal|0
index|]
expr_stmt|;
name|p_Dst
index|[
literal|1
index|]
operator|=
name|p_Src
index|[
literal|1
index|]
expr_stmt|;
name|p_Dst
index|[
literal|2
index|]
operator|=
name|p_Src
index|[
literal|2
index|]
expr_stmt|;
name|p_Dst
index|[
literal|3
index|]
operator|=
name|p_Src
index|[
literal|3
index|]
expr_stmt|;
name|qmPortalEqcrPvbCommit
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
call|(
name|uint8_t
call|)
argument_list|(
name|QM_EQCR_VERB_CMD_ENQUEUE
comment|/* |                           (flags& (QM_EQCR_VERB_COLOUR_MASK | QM_EQCR_VERB_INTERRUPT))*/
argument_list|)
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_FQR_PullFrame
parameter_list|(
name|t_Handle
name|h_QmFqr
parameter_list|,
name|t_Handle
name|h_QmPortal
parameter_list|,
name|uint32_t
name|fqidOffset
parameter_list|,
name|t_DpaaFD
modifier|*
name|p_Frame
parameter_list|)
block|{
name|t_QmFqr
modifier|*
name|p_QmFqr
init|=
operator|(
name|t_QmFqr
operator|*
operator|)
name|h_QmFqr
decl_stmt|;
name|uint32_t
name|pdqcr
init|=
literal|0
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmFqr
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|fqidOffset
operator|<
name|p_QmFqr
operator|->
name|numOfFqids
operator|)
argument_list|,
name|E_INVALID_VALUE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Frame
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_QmFqr
operator|->
name|p_Fqs
index|[
name|fqidOffset
index|]
operator|->
name|state
operator|==
name|qman_fq_state_oos
operator|)
operator|||
operator|(
name|p_QmFqr
operator|->
name|p_Fqs
index|[
name|fqidOffset
index|]
operator|->
name|state
operator|==
name|qman_fq_state_parked
operator|)
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|h_QmPortal
condition|)
block|{
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmFqr
operator|->
name|h_Qm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|h_QmPortal
operator|=
name|QmGetPortalHandle
argument_list|(
name|p_QmFqr
operator|->
name|h_Qm
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|h_QmPortal
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
block|}
name|pdqcr
operator||=
name|QM_PDQCR_MODE_UNSCHEDULED
expr_stmt|;
name|pdqcr
operator||=
name|QM_PDQCR_FQID
argument_list|(
name|p_QmFqr
operator|->
name|p_Fqs
index|[
name|fqidOffset
index|]
operator|->
name|fqid
argument_list|)
expr_stmt|;
return|return
name|QmPortalPullFrame
argument_list|(
name|h_QmPortal
argument_list|,
name|pdqcr
argument_list|,
name|p_Frame
argument_list|)
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_FQR_Resume
parameter_list|(
name|t_Handle
name|h_QmFqr
parameter_list|,
name|t_Handle
name|h_QmPortal
parameter_list|,
name|uint32_t
name|fqidOffset
parameter_list|)
block|{
name|t_QmFqr
modifier|*
name|p_QmFqr
init|=
operator|(
name|t_QmFqr
operator|*
operator|)
name|h_QmFqr
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmFqr
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|fqidOffset
operator|<
name|p_QmFqr
operator|->
name|numOfFqids
operator|)
argument_list|,
name|E_INVALID_VALUE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|h_QmPortal
condition|)
block|{
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmFqr
operator|->
name|h_Qm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|h_QmPortal
operator|=
name|QmGetPortalHandle
argument_list|(
name|p_QmFqr
operator|->
name|h_Qm
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|h_QmPortal
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
block|}
return|return
name|qman_schedule_fq
argument_list|(
name|h_QmPortal
argument_list|,
name|p_QmFqr
operator|->
name|p_Fqs
index|[
name|fqidOffset
index|]
argument_list|)
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_FQR_Suspend
parameter_list|(
name|t_Handle
name|h_QmFqr
parameter_list|,
name|t_Handle
name|h_QmPortal
parameter_list|,
name|uint32_t
name|fqidOffset
parameter_list|)
block|{
name|t_QmFqr
modifier|*
name|p_QmFqr
init|=
operator|(
name|t_QmFqr
operator|*
operator|)
name|h_QmFqr
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmFqr
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|fqidOffset
operator|<
name|p_QmFqr
operator|->
name|numOfFqids
operator|)
argument_list|,
name|E_INVALID_VALUE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_QmFqr
operator|->
name|p_Fqs
index|[
name|fqidOffset
index|]
operator|->
name|flags
operator|&
name|QM_FQCTRL_HOLDACTIVE
operator|)
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|h_QmPortal
argument_list|)
expr_stmt|;
name|p_QmFqr
operator|->
name|p_Fqs
index|[
name|fqidOffset
index|]
operator|->
name|state
operator|=
name|qman_fq_state_waiting_parked
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|uint32_t
name|QM_FQR_GetFqid
parameter_list|(
name|t_Handle
name|h_QmFqr
parameter_list|)
block|{
name|t_QmFqr
modifier|*
name|p_QmFqr
init|=
operator|(
name|t_QmFqr
operator|*
operator|)
name|h_QmFqr
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_QmFqr
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|p_QmFqr
operator|->
name|fqidBase
return|;
block|}
end_function

begin_function
name|uint32_t
name|QM_FQR_GetCounter
parameter_list|(
name|t_Handle
name|h_QmFqr
parameter_list|,
name|t_Handle
name|h_QmPortal
parameter_list|,
name|uint32_t
name|fqidOffset
parameter_list|,
name|e_QmFqrCounters
name|counter
parameter_list|)
block|{
name|t_QmFqr
modifier|*
name|p_QmFqr
init|=
operator|(
name|t_QmFqr
operator|*
operator|)
name|h_QmFqr
decl_stmt|;
name|struct
name|qm_mcr_queryfq_np
name|queryfq_np
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_QmFqr
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
operator|(
name|fqidOffset
operator|<
name|p_QmFqr
operator|->
name|numOfFqids
operator|)
argument_list|,
name|E_INVALID_VALUE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|h_QmPortal
condition|)
block|{
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_QmFqr
operator|->
name|h_Qm
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|h_QmPortal
operator|=
name|QmGetPortalHandle
argument_list|(
name|p_QmFqr
operator|->
name|h_Qm
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|h_QmPortal
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|qman_query_fq_np
argument_list|(
name|h_QmPortal
argument_list|,
name|p_QmFqr
operator|->
name|p_Fqs
index|[
name|fqidOffset
index|]
argument_list|,
operator|&
name|queryfq_np
argument_list|)
operator|!=
name|E_OK
condition|)
return|return
literal|0
return|;
switch|switch
condition|(
name|counter
condition|)
block|{
case|case
name|e_QM_FQR_COUNTERS_FRAME
case|:
return|return
name|queryfq_np
operator|.
name|frm_cnt
return|;
case|case
name|e_QM_FQR_COUNTERS_BYTE
case|:
return|return
name|queryfq_np
operator|.
name|byte_cnt
return|;
default|default :
break|break;
block|}
comment|/* should never get here */
name|ASSERT_COND
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|t_Handle
name|QM_CG_Create
parameter_list|(
name|t_QmCgParams
modifier|*
name|p_CgParams
parameter_list|)
block|{
name|t_QmCg
modifier|*
name|p_QmCg
decl_stmt|;
name|t_QmPortal
modifier|*
name|p_QmPortal
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|uint32_t
name|wredParams
decl_stmt|;
name|uint32_t
name|tmpA
decl_stmt|,
name|tmpN
decl_stmt|,
name|ta
init|=
literal|0
decl_stmt|,
name|tn
init|=
literal|0
decl_stmt|;
name|int
name|gap
decl_stmt|,
name|tmp
decl_stmt|;
name|struct
name|qm_mc_command
modifier|*
name|p_Mcc
decl_stmt|;
name|struct
name|qm_mc_result
modifier|*
name|p_Mcr
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_CgParams
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_CgParams
operator|->
name|h_Qm
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_CgParams
operator|->
name|notifyDcPortal
operator|&&
operator|(
operator|(
name|p_CgParams
operator|->
name|dcPortalId
operator|==
name|e_DPAA_DCPORTAL2
operator|)
operator|||
operator|(
name|p_CgParams
operator|->
name|dcPortalId
operator|==
name|e_DPAA_DCPORTAL3
operator|)
operator|)
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"notifyDcPortal is invalid for this DC Portal"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|p_CgParams
operator|->
name|h_QmPortal
condition|)
block|{
name|p_QmPortal
operator|=
name|QmGetPortalHandle
argument_list|(
name|p_CgParams
operator|->
name|h_Qm
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_QmPortal
argument_list|,
name|E_INVALID_STATE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
name|p_QmPortal
operator|=
name|p_CgParams
operator|->
name|h_QmPortal
expr_stmt|;
name|p_QmCg
operator|=
operator|(
name|t_QmCg
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|t_QmCg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_QmCg
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"QM CG obj!!!"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_QmCg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmCg
argument_list|)
argument_list|)
expr_stmt|;
comment|/* build CG struct */
name|p_QmCg
operator|->
name|h_Qm
operator|=
name|p_CgParams
operator|->
name|h_Qm
expr_stmt|;
name|p_QmCg
operator|->
name|h_QmPortal
operator|=
name|p_QmPortal
expr_stmt|;
name|p_QmCg
operator|->
name|h_App
operator|=
name|p_CgParams
operator|->
name|h_App
expr_stmt|;
name|err
operator|=
name|QmGetCgId
argument_list|(
name|p_CgParams
operator|->
name|h_Qm
argument_list|,
operator|&
name|p_QmCg
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|XX_Free
argument_list|(
name|p_QmCg
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"QmGetCgId failed"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|NCSW_PLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|p_Mcc
operator|=
name|qm_mc_start
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgid
operator|=
name|p_QmCg
operator|->
name|id
expr_stmt|;
name|err
operator|=
name|QmPortalRegisterCg
argument_list|(
name|p_QmPortal
argument_list|,
name|p_QmCg
argument_list|,
name|p_QmCg
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|XX_Free
argument_list|(
name|p_QmCg
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"QmPortalRegisterCg failed"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/*  Build CGR command */
block|{
ifdef|#
directive|ifdef
name|QM_CGS_NO_FRAME_MODE
name|t_QmRevisionInfo
name|revInfo
decl_stmt|;
name|QmGetRevision
argument_list|(
name|p_QmCg
operator|->
name|h_Qm
argument_list|,
operator|&
name|revInfo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
operator|(
name|revInfo
operator|.
name|majorRev
operator|==
literal|1
operator|)
operator|&&
operator|(
name|revInfo
operator|.
name|minorRev
operator|==
literal|0
operator|)
operator|)
condition|)
endif|#
directive|endif
comment|/* QM_CGS_NO_FRAME_MODE */
if|if
condition|(
name|p_CgParams
operator|->
name|frameCount
condition|)
block|{
name|p_Mcc
operator|->
name|initcgr
operator|.
name|we_mask
operator||=
name|QM_CGR_WE_MODE
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgr
operator|.
name|frame_mode
operator|=
name|QM_CGR_EN
expr_stmt|;
block|}
block|}
if|if
condition|(
name|p_CgParams
operator|->
name|wredEnable
condition|)
block|{
if|if
condition|(
name|p_CgParams
operator|->
name|wredParams
operator|.
name|enableGreen
condition|)
block|{
name|err
operator|=
name|CalcWredCurve
argument_list|(
operator|&
name|p_CgParams
operator|->
name|wredParams
operator|.
name|greenCurve
argument_list|,
operator|&
name|wredParams
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|XX_Free
argument_list|(
name|p_QmCg
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|p_Mcc
operator|->
name|initcgr
operator|.
name|we_mask
operator||=
name|QM_CGR_WE_WR_EN_G
operator||
name|QM_CGR_WE_WR_PARM_G
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgr
operator|.
name|wr_en_g
operator|=
name|QM_CGR_EN
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgr
operator|.
name|wr_parm_g
operator|.
name|word
operator|=
name|wredParams
expr_stmt|;
block|}
if|if
condition|(
name|p_CgParams
operator|->
name|wredParams
operator|.
name|enableYellow
condition|)
block|{
name|err
operator|=
name|CalcWredCurve
argument_list|(
operator|&
name|p_CgParams
operator|->
name|wredParams
operator|.
name|yellowCurve
argument_list|,
operator|&
name|wredParams
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|XX_Free
argument_list|(
name|p_QmCg
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|p_Mcc
operator|->
name|initcgr
operator|.
name|we_mask
operator||=
name|QM_CGR_WE_WR_EN_Y
operator||
name|QM_CGR_WE_WR_PARM_Y
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgr
operator|.
name|wr_en_y
operator|=
name|QM_CGR_EN
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgr
operator|.
name|wr_parm_y
operator|.
name|word
operator|=
name|wredParams
expr_stmt|;
block|}
if|if
condition|(
name|p_CgParams
operator|->
name|wredParams
operator|.
name|enableRed
condition|)
block|{
name|err
operator|=
name|CalcWredCurve
argument_list|(
operator|&
name|p_CgParams
operator|->
name|wredParams
operator|.
name|redCurve
argument_list|,
operator|&
name|wredParams
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|XX_Free
argument_list|(
name|p_QmCg
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|p_Mcc
operator|->
name|initcgr
operator|.
name|we_mask
operator||=
name|QM_CGR_WE_WR_EN_R
operator||
name|QM_CGR_WE_WR_PARM_R
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgr
operator|.
name|wr_en_r
operator|=
name|QM_CGR_EN
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgr
operator|.
name|wr_parm_r
operator|.
name|word
operator|=
name|wredParams
expr_stmt|;
block|}
block|}
if|if
condition|(
name|p_CgParams
operator|->
name|tailDropEnable
condition|)
block|{
if|if
condition|(
operator|!
name|p_CgParams
operator|->
name|threshold
condition|)
block|{
name|XX_Free
argument_list|(
name|p_QmCg
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"tailDropThreshold must be configured if tailDropEnable "
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgr
operator|.
name|cstd_en
operator|=
name|QM_CGR_EN
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|we_mask
operator||=
name|QM_CGR_WE_CSTD_EN
expr_stmt|;
block|}
if|if
condition|(
name|p_CgParams
operator|->
name|threshold
condition|)
block|{
name|p_Mcc
operator|->
name|initcgr
operator|.
name|we_mask
operator||=
name|QM_CGR_WE_CS_THRES
expr_stmt|;
name|p_QmCg
operator|->
name|f_Exception
operator|=
name|p_CgParams
operator|->
name|f_Exception
expr_stmt|;
if|if
condition|(
name|p_QmCg
operator|->
name|f_Exception
operator|||
name|p_CgParams
operator|->
name|notifyDcPortal
condition|)
block|{
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgr
operator|.
name|cscn_en
operator|=
name|QM_CGR_EN
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|we_mask
operator||=
name|QM_CGR_WE_CSCN_EN
operator||
name|QM_CGR_WE_CSCN_TARG
expr_stmt|;
comment|/* if SW - set target, if HW - if FM, set HW target, otherwize, set SW target */
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgr
operator|.
name|cscn_targ
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|p_QmCg
operator|->
name|f_Exception
condition|)
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgr
operator|.
name|cscn_targ
operator|=
operator|(
name|uint32_t
operator|)
name|QM_CGR_TARGET_SWP
argument_list|(
name|QmPortalGetSwPortalId
argument_list|(
name|p_QmCg
operator|->
name|h_QmPortal
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_CgParams
operator|->
name|notifyDcPortal
condition|)
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgr
operator|.
name|cscn_targ
operator||=
operator|(
name|uint32_t
operator|)
name|QM_CGR_TARGET_DCP
argument_list|(
name|p_CgParams
operator|->
name|dcPortalId
argument_list|)
expr_stmt|;
block|}
comment|/* express thresh as ta*2^tn */
name|gap
operator|=
operator|(
name|int
operator|)
name|p_CgParams
operator|->
name|threshold
expr_stmt|;
for|for
control|(
name|tmpA
operator|=
literal|0
init|;
name|tmpA
operator|<
literal|256
condition|;
name|tmpA
operator|++
control|)
for|for
control|(
name|tmpN
operator|=
literal|0
init|;
name|tmpN
operator|<
literal|32
condition|;
name|tmpN
operator|++
control|)
block|{
name|tmp
operator|=
name|ABS
argument_list|(
call|(
name|int
call|)
argument_list|(
name|p_CgParams
operator|->
name|threshold
operator|-
name|tmpA
operator|*
operator|(
literal|1
operator|<<
name|tmpN
operator|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|<
name|gap
condition|)
block|{
name|ta
operator|=
name|tmpA
expr_stmt|;
name|tn
operator|=
name|tmpN
expr_stmt|;
name|gap
operator|=
name|tmp
expr_stmt|;
block|}
block|}
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgr
operator|.
name|cs_thres
operator|.
name|TA
operator|=
name|ta
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgr
operator|.
name|cs_thres
operator|.
name|Tn
operator|=
name|tn
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p_CgParams
operator|->
name|f_Exception
condition|)
block|{
name|XX_Free
argument_list|(
name|p_QmCg
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"No threshold configured, but f_Exception defined"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|qm_mc_commit
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|QM_MCC_VERB_INITCGR
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|p_Mcr
operator|=
name|qm_mc_result
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
operator|)
condition|)
empty_stmt|;
name|ASSERT_COND
argument_list|(
operator|(
name|p_Mcr
operator|->
name|verb
operator|&
name|QM_MCR_VERB_MASK
operator|)
operator|==
name|QM_MCC_VERB_INITCGR
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Mcr
operator|->
name|result
operator|!=
name|QM_MCR_RESULT_OK
condition|)
block|{
name|XX_Free
argument_list|(
name|p_QmCg
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"INITCGR failed: %s"
operator|,
name|mcr_result_str
argument_list|(
name|p_Mcr
operator|->
name|result
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
return|return
name|p_QmCg
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_CG_Free
parameter_list|(
name|t_Handle
name|h_QmCg
parameter_list|)
block|{
name|t_QmCg
modifier|*
name|p_QmCg
init|=
operator|(
name|t_QmCg
operator|*
operator|)
name|h_QmCg
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|struct
name|qm_mc_command
modifier|*
name|p_Mcc
decl_stmt|;
name|struct
name|qm_mc_result
modifier|*
name|p_Mcr
decl_stmt|;
name|t_QmPortal
modifier|*
name|p_QmPortal
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmCg
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_QmPortal
operator|=
operator|(
name|t_QmPortal
operator|*
operator|)
name|p_QmCg
operator|->
name|h_QmPortal
expr_stmt|;
name|NCSW_PLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|p_Mcc
operator|=
name|qm_mc_start
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgid
operator|=
name|p_QmCg
operator|->
name|id
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|we_mask
operator|=
name|QM_CGR_WE_MASK
expr_stmt|;
name|err
operator|=
name|QmFreeCgId
argument_list|(
name|p_QmCg
operator|->
name|h_Qm
argument_list|,
name|p_QmCg
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|XX_Free
argument_list|(
name|p_QmCg
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"QmFreeCgId failed"
operator|)
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|QmPortalUnregisterCg
argument_list|(
name|p_QmCg
operator|->
name|h_QmPortal
argument_list|,
name|p_QmCg
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|XX_Free
argument_list|(
name|p_QmCg
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"QmPortalUnregisterCg failed"
operator|)
argument_list|)
expr_stmt|;
block|}
name|qm_mc_commit
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|QM_MCC_VERB_MODIFYCGR
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|p_Mcr
operator|=
name|qm_mc_result
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
operator|)
condition|)
empty_stmt|;
name|ASSERT_COND
argument_list|(
operator|(
name|p_Mcr
operator|->
name|verb
operator|&
name|QM_MCR_VERB_MASK
operator|)
operator|==
name|QM_MCC_VERB_MODIFYCGR
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Mcr
operator|->
name|result
operator|!=
name|QM_MCR_RESULT_OK
condition|)
block|{
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"INITCGR failed: %s"
operator|,
name|mcr_result_str
argument_list|(
name|p_Mcr
operator|->
name|result
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_QmCg
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_CG_SetException
parameter_list|(
name|t_Handle
name|h_QmCg
parameter_list|,
name|e_QmExceptions
name|exception
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_QmCg
modifier|*
name|p_QmCg
init|=
operator|(
name|t_QmCg
operator|*
operator|)
name|h_QmCg
decl_stmt|;
name|struct
name|qm_mc_command
modifier|*
name|p_Mcc
decl_stmt|;
name|struct
name|qm_mc_result
modifier|*
name|p_Mcr
decl_stmt|;
name|t_QmPortal
modifier|*
name|p_QmPortal
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmCg
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_QmPortal
operator|=
operator|(
name|t_QmPortal
operator|*
operator|)
name|p_QmCg
operator|->
name|h_QmPortal
expr_stmt|;
if|if
condition|(
operator|!
name|p_QmCg
operator|->
name|f_Exception
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Either threshold or exception callback was not configured."
operator|)
argument_list|)
expr_stmt|;
name|NCSW_PLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|p_Mcc
operator|=
name|qm_mc_start
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgid
operator|=
name|p_QmCg
operator|->
name|id
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|we_mask
operator|=
name|QM_CGR_WE_CSCN_EN
expr_stmt|;
if|if
condition|(
name|exception
operator|==
name|e_QM_EX_CG_STATE_CHANGE
condition|)
block|{
if|if
condition|(
name|enable
condition|)
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgr
operator|.
name|cscn_en
operator|=
name|QM_CGR_EN
expr_stmt|;
block|}
else|else
block|{
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Illegal exception"
operator|)
argument_list|)
expr_stmt|;
block|}
name|qm_mc_commit
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|QM_MCC_VERB_MODIFYCGR
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|p_Mcr
operator|=
name|qm_mc_result
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
operator|)
condition|)
empty_stmt|;
name|ASSERT_COND
argument_list|(
operator|(
name|p_Mcr
operator|->
name|verb
operator|&
name|QM_MCR_VERB_MASK
operator|)
operator|==
name|QM_MCC_VERB_MODIFYCGR
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Mcr
operator|->
name|result
operator|!=
name|QM_MCR_RESULT_OK
condition|)
block|{
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"INITCGR failed: %s"
operator|,
name|mcr_result_str
argument_list|(
name|p_Mcr
operator|->
name|result
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_CG_ModifyWredCurve
parameter_list|(
name|t_Handle
name|h_QmCg
parameter_list|,
name|t_QmCgModifyWredParams
modifier|*
name|p_QmCgModifyParams
parameter_list|)
block|{
name|t_QmCg
modifier|*
name|p_QmCg
init|=
operator|(
name|t_QmCg
operator|*
operator|)
name|h_QmCg
decl_stmt|;
name|uint32_t
name|wredParams
decl_stmt|;
name|struct
name|qm_mc_command
modifier|*
name|p_Mcc
decl_stmt|;
name|struct
name|qm_mc_result
modifier|*
name|p_Mcr
decl_stmt|;
name|t_QmPortal
modifier|*
name|p_QmPortal
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmCg
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_QmPortal
operator|=
operator|(
name|t_QmPortal
operator|*
operator|)
name|p_QmCg
operator|->
name|h_QmPortal
expr_stmt|;
name|NCSW_PLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|p_Mcc
operator|=
name|qm_mc_start
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgid
operator|=
name|p_QmCg
operator|->
name|id
expr_stmt|;
name|qm_mc_commit
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|QM_MCC_VERB_QUERYCGR
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|p_Mcr
operator|=
name|qm_mc_result
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
operator|)
condition|)
empty_stmt|;
name|ASSERT_COND
argument_list|(
operator|(
name|p_Mcr
operator|->
name|verb
operator|&
name|QM_MCR_VERB_MASK
operator|)
operator|==
name|QM_MCC_VERB_QUERYCGR
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Mcr
operator|->
name|result
operator|!=
name|QM_MCR_RESULT_OK
condition|)
block|{
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"QM_MCC_VERB_QUERYCGR failed: %s"
operator|,
name|mcr_result_str
argument_list|(
name|p_Mcr
operator|->
name|result
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|p_QmCgModifyParams
operator|->
name|color
condition|)
block|{
case|case
operator|(
name|e_QM_CG_COLOR_GREEN
operator|)
case|:
if|if
condition|(
operator|!
name|p_Mcr
operator|->
name|querycgr
operator|.
name|cgr
operator|.
name|wr_en_g
condition|)
block|{
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"WRED is not enabled for green"
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
operator|(
name|e_QM_CG_COLOR_YELLOW
operator|)
case|:
if|if
condition|(
operator|!
name|p_Mcr
operator|->
name|querycgr
operator|.
name|cgr
operator|.
name|wr_en_y
condition|)
block|{
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"WRED is not enabled for yellow"
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
operator|(
name|e_QM_CG_COLOR_RED
operator|)
case|:
if|if
condition|(
operator|!
name|p_Mcr
operator|->
name|querycgr
operator|.
name|cgr
operator|.
name|wr_en_r
condition|)
block|{
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"WRED is not enabled for red"
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
name|p_Mcc
operator|=
name|qm_mc_start
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgid
operator|=
name|p_QmCg
operator|->
name|id
expr_stmt|;
switch|switch
condition|(
name|p_QmCgModifyParams
operator|->
name|color
condition|)
block|{
case|case
operator|(
name|e_QM_CG_COLOR_GREEN
operator|)
case|:
name|err
operator|=
name|CalcWredCurve
argument_list|(
operator|&
name|p_QmCgModifyParams
operator|->
name|wredParams
argument_list|,
operator|&
name|wredParams
argument_list|)
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|we_mask
operator||=
name|QM_CGR_WE_WR_EN_G
operator||
name|QM_CGR_WE_WR_PARM_G
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgr
operator|.
name|wr_en_g
operator|=
name|QM_CGR_EN
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgr
operator|.
name|wr_parm_g
operator|.
name|word
operator|=
name|wredParams
expr_stmt|;
break|break;
case|case
operator|(
name|e_QM_CG_COLOR_YELLOW
operator|)
case|:
name|err
operator|=
name|CalcWredCurve
argument_list|(
operator|&
name|p_QmCgModifyParams
operator|->
name|wredParams
argument_list|,
operator|&
name|wredParams
argument_list|)
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|we_mask
operator||=
name|QM_CGR_WE_WR_EN_Y
operator||
name|QM_CGR_WE_WR_PARM_Y
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgr
operator|.
name|wr_en_y
operator|=
name|QM_CGR_EN
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgr
operator|.
name|wr_parm_y
operator|.
name|word
operator|=
name|wredParams
expr_stmt|;
break|break;
case|case
operator|(
name|e_QM_CG_COLOR_RED
operator|)
case|:
name|err
operator|=
name|CalcWredCurve
argument_list|(
operator|&
name|p_QmCgModifyParams
operator|->
name|wredParams
argument_list|,
operator|&
name|wredParams
argument_list|)
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|we_mask
operator||=
name|QM_CGR_WE_WR_EN_R
operator||
name|QM_CGR_WE_WR_PARM_R
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgr
operator|.
name|wr_en_r
operator|=
name|QM_CGR_EN
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgr
operator|.
name|wr_parm_r
operator|.
name|word
operator|=
name|wredParams
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|err
condition|)
block|{
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|qm_mc_commit
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|QM_MCC_VERB_MODIFYCGR
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|p_Mcr
operator|=
name|qm_mc_result
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
operator|)
condition|)
empty_stmt|;
name|ASSERT_COND
argument_list|(
operator|(
name|p_Mcr
operator|->
name|verb
operator|&
name|QM_MCR_VERB_MASK
operator|)
operator|==
name|QM_MCC_VERB_MODIFYCGR
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Mcr
operator|->
name|result
operator|!=
name|QM_MCR_RESULT_OK
condition|)
block|{
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"INITCGR failed: %s"
operator|,
name|mcr_result_str
argument_list|(
name|p_Mcr
operator|->
name|result
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_CG_ModifyTailDropThreshold
parameter_list|(
name|t_Handle
name|h_QmCg
parameter_list|,
name|uint32_t
name|threshold
parameter_list|)
block|{
name|t_QmCg
modifier|*
name|p_QmCg
init|=
operator|(
name|t_QmCg
operator|*
operator|)
name|h_QmCg
decl_stmt|;
name|struct
name|qm_mc_command
modifier|*
name|p_Mcc
decl_stmt|;
name|struct
name|qm_mc_result
modifier|*
name|p_Mcr
decl_stmt|;
name|t_QmPortal
modifier|*
name|p_QmPortal
decl_stmt|;
name|uint32_t
name|tmpA
decl_stmt|,
name|tmpN
decl_stmt|,
name|ta
init|=
literal|0
decl_stmt|,
name|tn
init|=
literal|0
decl_stmt|;
name|int
name|gap
decl_stmt|,
name|tmp
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmCg
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_QmPortal
operator|=
operator|(
name|t_QmPortal
operator|*
operator|)
name|p_QmCg
operator|->
name|h_QmPortal
expr_stmt|;
name|NCSW_PLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|p_Mcc
operator|=
name|qm_mc_start
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgid
operator|=
name|p_QmCg
operator|->
name|id
expr_stmt|;
name|qm_mc_commit
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|QM_MCC_VERB_QUERYCGR
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|p_Mcr
operator|=
name|qm_mc_result
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
operator|)
condition|)
empty_stmt|;
name|ASSERT_COND
argument_list|(
operator|(
name|p_Mcr
operator|->
name|verb
operator|&
name|QM_MCR_VERB_MASK
operator|)
operator|==
name|QM_MCC_VERB_QUERYCGR
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Mcr
operator|->
name|result
operator|!=
name|QM_MCR_RESULT_OK
condition|)
block|{
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"QM_MCC_VERB_QUERYCGR failed: %s"
operator|,
name|mcr_result_str
argument_list|(
name|p_Mcr
operator|->
name|result
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|p_Mcr
operator|->
name|querycgr
operator|.
name|cgr
operator|.
name|cstd_en
condition|)
block|{
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Tail Drop is not enabled!"
operator|)
argument_list|)
expr_stmt|;
block|}
name|p_Mcc
operator|=
name|qm_mc_start
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgid
operator|=
name|p_QmCg
operator|->
name|id
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|we_mask
operator||=
name|QM_CGR_WE_CS_THRES
expr_stmt|;
comment|/* express thresh as ta*2^tn */
name|gap
operator|=
operator|(
name|int
operator|)
name|threshold
expr_stmt|;
for|for
control|(
name|tmpA
operator|=
literal|0
init|;
name|tmpA
operator|<
literal|256
condition|;
name|tmpA
operator|++
control|)
for|for
control|(
name|tmpN
operator|=
literal|0
init|;
name|tmpN
operator|<
literal|32
condition|;
name|tmpN
operator|++
control|)
block|{
name|tmp
operator|=
name|ABS
argument_list|(
call|(
name|int
call|)
argument_list|(
name|threshold
operator|-
name|tmpA
operator|*
operator|(
literal|1
operator|<<
name|tmpN
operator|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|<
name|gap
condition|)
block|{
name|ta
operator|=
name|tmpA
expr_stmt|;
name|tn
operator|=
name|tmpN
expr_stmt|;
name|gap
operator|=
name|tmp
expr_stmt|;
block|}
block|}
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgr
operator|.
name|cs_thres
operator|.
name|TA
operator|=
name|ta
expr_stmt|;
name|p_Mcc
operator|->
name|initcgr
operator|.
name|cgr
operator|.
name|cs_thres
operator|.
name|Tn
operator|=
name|tn
expr_stmt|;
name|qm_mc_commit
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|,
name|QM_MCC_VERB_MODIFYCGR
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
operator|(
name|p_Mcr
operator|=
name|qm_mc_result
argument_list|(
name|p_QmPortal
operator|->
name|p_LowQmPortal
argument_list|)
operator|)
condition|)
empty_stmt|;
name|ASSERT_COND
argument_list|(
operator|(
name|p_Mcr
operator|->
name|verb
operator|&
name|QM_MCR_VERB_MASK
operator|)
operator|==
name|QM_MCC_VERB_MODIFYCGR
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Mcr
operator|->
name|result
operator|!=
name|QM_MCR_RESULT_OK
condition|)
block|{
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"INITCGR failed: %s"
operator|,
name|mcr_result_str
argument_list|(
name|p_Mcr
operator|->
name|result
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
name|PUNLOCK
argument_list|(
name|p_QmPortal
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

end_unit


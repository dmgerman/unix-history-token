begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************   Â© 1995-2003, 2004, 2005-2011 Freescale Semiconductor, Inc.  All rights reserved.   This is proprietary source code of Freescale Semiconductor Inc.,  and its use is subject to the NetComm Device Drivers EULA.  The copyright notice above does not evidence any actual or intended  publication of such source code.   ALTERNATIVELY, redistribution and use in source and binary forms, with  or without modification, are permitted provided that the following  conditions are met:      * Redistributions of source code must retain the above copyright        notice, this list of conditions and the following disclaimer.      * Redistributions in binary form must reproduce the above copyright        notice, this list of conditions and the following disclaimer in the        documentation and/or other materials provided with the distribution.      * Neither the name of Freescale Semiconductor nor the        names of its contributors may be used to endorse or promote products        derived from this software without specific prior written permission.   THIS SOFTWARE IS PROVIDED BY Freescale Semiconductor ``AS IS'' AND ANY  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  DISCLAIMED. IN NO EVENT SHALL Freescale Semiconductor BE LIABLE FOR ANY  DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES  (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND  ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *   **************************************************************************/
end_comment

begin_comment
comment|/******************************************************************************  @File          qm.c   @Description   QM& Portal implementation */
end_comment

begin_comment
comment|/***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<machine/atomic.h>
end_include

begin_include
include|#
directive|include
file|"error_ext.h"
end_include

begin_include
include|#
directive|include
file|"std_ext.h"
end_include

begin_include
include|#
directive|include
file|"string_ext.h"
end_include

begin_include
include|#
directive|include
file|"sprint_ext.h"
end_include

begin_include
include|#
directive|include
file|"mm_ext.h"
end_include

begin_include
include|#
directive|include
file|"core_ext.h"
end_include

begin_include
include|#
directive|include
file|"debug_ext.h"
end_include

begin_include
include|#
directive|include
file|"qm.h"
end_include

begin_decl_stmt
specifier|static
specifier|volatile
name|bool
name|blockingFlag
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|QmIpcMsgCompletionCB
parameter_list|(
name|t_Handle
name|h_Module
parameter_list|,
name|uint8_t
modifier|*
name|p_Msg
parameter_list|,
name|uint8_t
modifier|*
name|p_Reply
parameter_list|,
name|uint32_t
name|replyLength
parameter_list|,
name|t_Error
name|status
parameter_list|)
block|{
name|SANITY_CHECK_RETURN
argument_list|(
name|h_Module
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|p_Msg
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|p_Reply
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|replyLength
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|status
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|h_Module
argument_list|)
expr_stmt|;
name|blockingFlag
operator|=
name|FALSE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|QmHandleIpcMsgCB
parameter_list|(
name|t_Handle
name|h_Qm
parameter_list|,
name|uint8_t
modifier|*
name|p_Msg
parameter_list|,
name|uint32_t
name|msgLength
parameter_list|,
name|uint8_t
modifier|*
name|p_Reply
parameter_list|,
name|uint32_t
modifier|*
name|p_ReplyLength
parameter_list|)
block|{
name|t_Qm
modifier|*
name|p_Qm
init|=
operator|(
name|t_Qm
operator|*
operator|)
name|h_Qm
decl_stmt|;
name|t_QmIpcMsg
modifier|*
name|p_IpcMsg
init|=
operator|(
name|t_QmIpcMsg
operator|*
operator|)
name|p_Msg
decl_stmt|;
name|t_QmIpcReply
modifier|*
name|p_IpcReply
init|=
operator|(
name|t_QmIpcReply
operator|*
operator|)
name|p_Reply
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Qm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|msgLength
operator|>=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|)
argument_list|,
name|E_INVALID_VALUE
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DISABLE_SANITY_CHECKS
name|UNUSED
argument_list|(
name|msgLength
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DISABLE_SANITY_CHECKS */
name|ASSERT_COND
argument_list|(
name|p_IpcMsg
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|p_IpcReply
argument_list|,
literal|0
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
operator|*
name|QM_IPC_MAX_REPLY_SIZE
operator|)
argument_list|)
expr_stmt|;
operator|*
name|p_ReplyLength
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|p_IpcMsg
operator|->
name|msgId
condition|)
block|{
case|case
operator|(
name|QM_MASTER_IS_ALIVE
operator|)
case|:
operator|*
operator|(
name|uint8_t
operator|*
operator|)
name|p_IpcReply
operator|->
name|replyBody
operator|=
literal|1
expr_stmt|;
operator|*
name|p_ReplyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
expr_stmt|;
break|break;
case|case
operator|(
name|QM_FORCE_FQID
operator|)
case|:
block|{
name|t_QmIpcFqidParams
name|ipcFqid
decl_stmt|;
name|uint32_t
name|fqid
decl_stmt|;
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcFqid
argument_list|,
name|p_IpcMsg
operator|->
name|msgBody
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmIpcFqidParams
argument_list|)
argument_list|)
expr_stmt|;
name|fqid
operator|=
name|QmFqidGet
argument_list|(
name|p_Qm
argument_list|,
name|ipcFqid
operator|.
name|size
argument_list|,
literal|1
argument_list|,
name|TRUE
argument_list|,
name|ipcFqid
operator|.
name|fqid
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|p_IpcReply
operator|->
name|replyBody
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|fqid
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|p_ReplyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
operator|(
name|QM_PUT_FQID
operator|)
case|:
block|{
name|t_Error
name|err
decl_stmt|;
name|t_QmIpcFqidParams
name|ipcFqid
decl_stmt|;
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcFqid
argument_list|,
name|p_IpcMsg
operator|->
name|msgBody
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmIpcFqidParams
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|QmFqidPut
argument_list|(
name|p_Qm
argument_list|,
name|ipcFqid
operator|.
name|fqid
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
operator|(
name|QM_GET_COUNTER
operator|)
case|:
block|{
name|t_QmIpcGetCounter
name|ipcCounter
decl_stmt|;
name|uint32_t
name|count
decl_stmt|;
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcCounter
argument_list|,
name|p_IpcMsg
operator|->
name|msgBody
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmIpcGetCounter
argument_list|)
argument_list|)
expr_stmt|;
name|count
operator|=
name|QmGetCounter
argument_list|(
name|p_Qm
argument_list|,
operator|(
name|e_QmInterModuleCounters
operator|)
name|ipcCounter
operator|.
name|enumId
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|p_IpcReply
operator|->
name|replyBody
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|count
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|p_ReplyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
operator|(
name|QM_GET_SET_PORTAL_PARAMS
operator|)
case|:
block|{
name|t_Error
name|err
decl_stmt|;
name|t_QmIpcPortalInitParams
name|ipcPortalInitParams
decl_stmt|;
name|t_QmInterModulePortalInitParams
name|portalInitParams
decl_stmt|;
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcPortalInitParams
argument_list|,
name|p_IpcMsg
operator|->
name|msgBody
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmIpcPortalInitParams
argument_list|)
argument_list|)
expr_stmt|;
name|portalInitParams
operator|.
name|portalId
operator|=
name|ipcPortalInitParams
operator|.
name|portalId
expr_stmt|;
name|portalInitParams
operator|.
name|stashDestQueue
operator|=
name|ipcPortalInitParams
operator|.
name|stashDestQueue
expr_stmt|;
name|portalInitParams
operator|.
name|liodn
operator|=
name|ipcPortalInitParams
operator|.
name|liodn
expr_stmt|;
name|portalInitParams
operator|.
name|dqrrLiodn
operator|=
name|ipcPortalInitParams
operator|.
name|dqrrLiodn
expr_stmt|;
name|portalInitParams
operator|.
name|fdFqLiodn
operator|=
name|ipcPortalInitParams
operator|.
name|fdFqLiodn
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|QmGetSetPortalParams
argument_list|(
name|p_Qm
argument_list|,
operator|&
name|portalInitParams
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|REPORT_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
operator|(
name|QM_GET_REVISION
operator|)
case|:
block|{
name|t_QmRevisionInfo
name|revInfo
decl_stmt|;
name|t_QmIpcRevisionInfo
name|ipcRevInfo
decl_stmt|;
name|p_IpcReply
operator|->
name|error
operator|=
operator|(
name|uint32_t
operator|)
name|QmGetRevision
argument_list|(
name|h_Qm
argument_list|,
operator|&
name|revInfo
argument_list|)
expr_stmt|;
name|ipcRevInfo
operator|.
name|majorRev
operator|=
name|revInfo
operator|.
name|majorRev
expr_stmt|;
name|ipcRevInfo
operator|.
name|minorRev
operator|=
name|revInfo
operator|.
name|minorRev
expr_stmt|;
name|memcpy
argument_list|(
name|p_IpcReply
operator|->
name|replyBody
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcRevInfo
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmIpcRevisionInfo
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|p_ReplyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|t_QmIpcRevisionInfo
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
operator|*
name|p_ReplyLength
operator|=
literal|0
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_SELECTION
argument_list|,
operator|(
literal|"command not found!!!"
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|CheckQmParameters
parameter_list|(
name|t_Qm
modifier|*
name|p_Qm
parameter_list|)
block|{
if|if
condition|(
operator|(
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|partFqidBase
operator|+
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|partNumOfFqids
operator|)
operator|>
name|QM_MAX_NUM_OF_FQIDS
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"partFqidBase+partNumOfFqids out of range!!!"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Qm
operator|->
name|partCgsBase
operator|+
name|p_Qm
operator|->
name|partNumOfCgs
operator|)
operator|>
name|QM_MAX_NUM_OF_CGS
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"partCgsBase+partNumOfCgs out of range!!!"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Qm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
condition|)
block|{
name|uint64_t
name|phyAddr
decl_stmt|;
name|phyAddr
operator|=
name|XX_VirtToPhys
argument_list|(
name|UINT_TO_PTR
argument_list|(
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|swPortalsBaseAddress
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|phyAddr
operator|&
literal|0x00000000001fffffLL
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"swPortalsBaseAddress isn't properly aligned"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|rtFramesDepth
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"rtFramesDepth must be larger than '0'!!!"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|rtFramesDepth
operator|>
operator|(
operator|(
literal|16
operator|*
name|MEGABYTE
operator|)
operator|*
literal|3
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"rtFramesDepth must be equal or smaller than 48MB!!!"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|totalNumOfFqids
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"totalNumOfFqids must be larger than '0'!!!"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|totalNumOfFqids
operator|>
operator|(
literal|16
operator|*
name|MEGABYTE
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"totalNumOfFqids must be equal or smaller than 16MB!!!"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Qm
operator|->
name|f_Exception
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"Exceptions callback not provided"
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|QmInitPfdr
parameter_list|(
name|t_Qm
modifier|*
name|p_Qm
parameter_list|,
name|uint32_t
name|pfdr_start
parameter_list|,
name|uint32_t
name|num
parameter_list|)
block|{
name|uint8_t
name|rslt
decl_stmt|;
name|uint32_t
name|timeout
init|=
literal|100000
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_Qm
argument_list|)
expr_stmt|;
name|ASSERT_COND
argument_list|(
name|pfdr_start
operator|&&
operator|!
operator|(
name|pfdr_start
operator|&
literal|7
operator|)
operator|&&
operator|!
operator|(
name|num
operator|&
literal|7
operator|)
operator|&&
name|num
argument_list|)
expr_stmt|;
comment|/* Make sure te command interface is 'idle' */
name|rslt
operator|=
name|MCR_get_rslt
argument_list|(
name|GET_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|mcr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|MCR_rslt_idle
argument_list|(
name|rslt
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|CRITICAL
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"QMAN_MCR isn't idle"
operator|)
argument_list|)
expr_stmt|;
comment|/* Write the MCR command params then the verb */
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|mcp0
argument_list|,
name|pfdr_start
argument_list|)
expr_stmt|;
comment|/* TODO: remove this - it's a workaround for a model bug that is      * corrected in more recent versions. We use the workaround until      * everyone has upgraded. */
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|mcp1
argument_list|,
operator|(
name|pfdr_start
operator|+
name|num
operator|-
literal|16
operator|)
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|mcp1
argument_list|,
operator|(
name|pfdr_start
operator|+
name|num
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|mb
argument_list|()
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|mcr
argument_list|,
name|MCR_INIT_PFDR
argument_list|)
expr_stmt|;
comment|/* Poll for the result */
do|do
block|{
name|XX_UDelay
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|rslt
operator|=
name|MCR_get_rslt
argument_list|(
name|GET_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|mcr
argument_list|)
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|!
name|MCR_rslt_idle
argument_list|(
name|rslt
argument_list|)
operator|&&
operator|--
name|timeout
condition|)
do|;
if|if
condition|(
name|MCR_rslt_ok
argument_list|(
name|rslt
argument_list|)
condition|)
return|return
name|E_OK
return|;
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|mcr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|timeout
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_TIMEOUT
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|MCR_rslt_eaccess
argument_list|(
name|rslt
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|MCR_rslt_inval
argument_list|(
name|rslt
argument_list|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Unexpected result from MCR_INIT_PFDR: %02x\n"
operator|,
name|rslt
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|__inline__
name|void
name|QmSetWqScheduling
parameter_list|(
name|t_Qm
modifier|*
name|p_Qm
parameter_list|,
name|e_QmWqClass
name|wqClass
parameter_list|,
name|uint8_t
name|csElev
parameter_list|,
name|uint8_t
name|csw2
parameter_list|,
name|uint8_t
name|csw3
parameter_list|,
name|uint8_t
name|csw4
parameter_list|,
name|uint8_t
name|csw5
parameter_list|,
name|uint8_t
name|csw6
parameter_list|,
name|uint8_t
name|csw7
parameter_list|)
block|{
name|ASSERT_COND
argument_list|(
name|p_Qm
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|wq_cs_cfg
index|[
name|wqClass
index|]
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
operator|(
operator|(
name|csElev
operator|&
literal|0xff
operator|)
operator|<<
literal|24
operator|)
operator||
operator|(
operator|(
name|csw2
operator|&
literal|0x7
operator|)
operator|<<
literal|20
operator|)
operator||
operator|(
operator|(
name|csw3
operator|&
literal|0x7
operator|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|csw4
operator|&
literal|0x7
operator|)
operator|<<
literal|12
operator|)
operator||
operator|(
operator|(
name|csw5
operator|&
literal|0x7
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|(
name|csw6
operator|&
literal|0x7
operator|)
operator|<<
literal|4
operator|)
operator||
operator|(
name|csw7
operator|&
literal|0x7
operator|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|ReserveFqids
parameter_list|(
name|t_Qm
modifier|*
name|p_Qm
parameter_list|,
name|uint32_t
name|size
parameter_list|,
name|uint32_t
name|alignment
parameter_list|,
name|bool
name|force
parameter_list|,
name|uint32_t
name|base
parameter_list|)
block|{
name|uint64_t
name|ans
decl_stmt|;
name|uint32_t
name|intFlags
decl_stmt|;
name|intFlags
operator|=
name|XX_LockIntrSpinlock
argument_list|(
name|p_Qm
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|force
condition|)
name|ans
operator|=
name|MM_GetForce
argument_list|(
name|p_Qm
operator|->
name|h_FqidMm
argument_list|,
operator|(
name|uint64_t
operator|)
name|base
argument_list|,
operator|(
name|uint64_t
operator|)
name|size
argument_list|,
literal|"QM FQID MEM"
argument_list|)
expr_stmt|;
else|else
name|ans
operator|=
name|MM_Get
argument_list|(
name|p_Qm
operator|->
name|h_FqidMm
argument_list|,
operator|(
name|uint64_t
operator|)
name|size
argument_list|,
name|alignment
argument_list|,
literal|"QM FQID MEM"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ans
operator|==
name|ILLEGAL_BASE
condition|)
block|{
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_Qm
operator|->
name|lock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
operator|(
name|uint32_t
operator|)
name|ans
return|;
block|}
name|base
operator|=
operator|(
name|uint32_t
operator|)
name|ans
expr_stmt|;
name|ans
operator|=
name|MM_GetForce
argument_list|(
name|p_Qm
operator|->
name|h_RsrvFqidMm
argument_list|,
operator|(
name|uint64_t
operator|)
name|base
argument_list|,
operator|(
name|uint64_t
operator|)
name|size
argument_list|,
literal|"QM rsrv FQID MEM"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ans
operator|==
name|ILLEGAL_BASE
condition|)
block|{
name|MM_Put
argument_list|(
name|p_Qm
operator|->
name|h_FqidMm
argument_list|,
operator|(
name|uint64_t
operator|)
name|base
argument_list|)
expr_stmt|;
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_Qm
operator|->
name|lock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
operator|(
name|uint32_t
operator|)
name|ans
return|;
block|}
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_Qm
operator|->
name|lock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
operator|(
name|uint32_t
operator|)
name|base
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|FreeInitResources
parameter_list|(
name|t_Qm
modifier|*
name|p_Qm
parameter_list|)
block|{
if|if
condition|(
name|p_Qm
operator|->
name|p_FqdBase
condition|)
name|XX_FreeSmart
argument_list|(
name|p_Qm
operator|->
name|p_FqdBase
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Qm
operator|->
name|p_PfdrBase
condition|)
name|XX_FreeSmart
argument_list|(
name|p_Qm
operator|->
name|p_PfdrBase
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Qm
operator|->
name|h_Session
condition|)
name|XX_IpcFreeSession
argument_list|(
name|p_Qm
operator|->
name|h_Session
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Qm
operator|->
name|h_RsrvFqidMm
condition|)
name|MM_Free
argument_list|(
name|p_Qm
operator|->
name|h_RsrvFqidMm
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Qm
operator|->
name|h_FqidMm
condition|)
name|MM_Free
argument_list|(
name|p_Qm
operator|->
name|h_FqidMm
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/****************************************/
end_comment

begin_comment
comment|/*       Inter-Module functions         */
end_comment

begin_comment
comment|/****************************************/
end_comment

begin_function
name|uint32_t
name|QmGetCounter
parameter_list|(
name|t_Handle
name|h_Qm
parameter_list|,
name|e_QmInterModuleCounters
name|counter
parameter_list|)
block|{
name|t_Qm
modifier|*
name|p_Qm
init|=
operator|(
name|t_Qm
operator|*
operator|)
name|h_Qm
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_Qm
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
operator|(
operator|(
operator|(
name|p_Qm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
operator|&&
name|p_Qm
operator|->
name|p_QmRegs
operator|)
operator|||
operator|(
name|p_Qm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|)
argument_list|,
name|E_INVALID_STATE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Qm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
operator|||
operator|(
operator|!
name|p_Qm
operator|->
name|h_Session
operator|&&
name|p_Qm
operator|->
name|p_QmRegs
operator|)
condition|)
block|{
switch|switch
condition|(
name|counter
condition|)
block|{
case|case
operator|(
name|e_QM_IM_COUNTERS_SFDR_IN_USE
operator|)
case|:
return|return
name|GET_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|sfdr_in_use
argument_list|)
return|;
case|case
operator|(
name|e_QM_IM_COUNTERS_PFDR_IN_USE
operator|)
case|:
return|return
operator|(
name|p_Qm
operator|->
name|numOfPfdr
operator|-
name|GET_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|pfdr_fpc
argument_list|)
operator|)
return|;
case|case
operator|(
name|e_QM_IM_COUNTERS_PFDR_FREE_POOL
operator|)
case|:
return|return
operator|(
name|GET_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|pfdr_fpc
argument_list|)
operator|-
name|GET_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|pfdr_cfg
argument_list|)
operator|)
return|;
default|default:
break|break;
block|}
comment|/* should never get here */
name|ASSERT_COND
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p_Qm
operator|->
name|h_Session
condition|)
block|{
name|t_QmIpcMsg
name|msg
decl_stmt|;
name|t_QmIpcReply
name|reply
decl_stmt|;
name|t_QmIpcGetCounter
name|ipcCounter
decl_stmt|;
name|uint32_t
name|replyLength
decl_stmt|,
name|count
decl_stmt|;
name|t_Error
name|errCode
init|=
name|E_OK
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmIpcMsg
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmIpcReply
argument_list|)
argument_list|)
expr_stmt|;
name|ipcCounter
operator|.
name|enumId
operator|=
operator|(
name|uint32_t
operator|)
name|counter
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|QM_GET_COUNTER
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|&
name|ipcCounter
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmIpcGetCounter
argument_list|)
argument_list|)
expr_stmt|;
name|replyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|errCode
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Qm
operator|->
name|h_Session
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|t_QmIpcGetCounter
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|errCode
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|replyLength
operator|!=
operator|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|)
condition|)
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"IPC reply length mismatch"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|errCode
operator|==
name|E_OK
operator|)
operator|&&
operator|(
name|replyLength
operator|==
operator|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|)
operator|)
condition|)
block|{
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|count
argument_list|,
name|reply
operator|.
name|replyBody
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|count
return|;
block|}
block|}
else|else
name|REPORT_ERROR
argument_list|(
name|WARNING
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"In 'guest', either IPC or 'baseAddress' is required!"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|t_Error
name|QmGetRevision
parameter_list|(
name|t_Handle
name|h_Qm
parameter_list|,
name|t_QmRevisionInfo
modifier|*
name|p_QmRevisionInfo
parameter_list|)
block|{
name|t_Qm
modifier|*
name|p_Qm
init|=
operator|(
name|t_Qm
operator|*
operator|)
name|h_Qm
decl_stmt|;
name|uint32_t
name|tmpReg
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Qm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmRevisionInfo
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
operator|(
operator|(
name|p_Qm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
operator|&&
name|p_Qm
operator|->
name|p_QmRegs
operator|)
operator|||
operator|(
name|p_Qm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
operator|)
operator|)
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|p_Qm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
operator|)
operator|||
operator|(
operator|!
name|p_Qm
operator|->
name|h_Session
operator|&&
name|p_Qm
operator|->
name|p_QmRegs
operator|)
condition|)
block|{
comment|/* read revision register 1 */
name|tmpReg
operator|=
name|GET_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|ip_rev_1
argument_list|)
expr_stmt|;
name|p_QmRevisionInfo
operator|->
name|majorRev
operator|=
call|(
name|uint8_t
call|)
argument_list|(
operator|(
name|tmpReg
operator|&
name|REV1_MAJOR_MASK
operator|)
operator|>>
name|REV1_MAJOR_SHIFT
argument_list|)
expr_stmt|;
name|p_QmRevisionInfo
operator|->
name|minorRev
operator|=
call|(
name|uint8_t
call|)
argument_list|(
operator|(
name|tmpReg
operator|&
name|REV1_MINOR_MASK
operator|)
operator|>>
name|REV1_MINOR_SHIFT
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p_Qm
operator|->
name|h_Session
condition|)
block|{
name|t_QmIpcMsg
name|msg
decl_stmt|;
name|t_QmIpcReply
name|reply
decl_stmt|;
name|t_QmIpcRevisionInfo
name|ipcRevInfo
decl_stmt|;
name|uint32_t
name|replyLength
decl_stmt|;
name|t_Error
name|errCode
init|=
name|E_OK
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmIpcMsg
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|QM_GET_REVISION
expr_stmt|;
name|replyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|t_QmIpcRevisionInfo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|errCode
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Qm
operator|->
name|h_Session
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|errCode
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|replyLength
operator|!=
operator|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|t_QmIpcRevisionInfo
argument_list|)
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"IPC reply length mismatch"
operator|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ipcRevInfo
argument_list|,
name|reply
operator|.
name|replyBody
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmIpcRevisionInfo
argument_list|)
argument_list|)
expr_stmt|;
name|p_QmRevisionInfo
operator|->
name|majorRev
operator|=
name|ipcRevInfo
operator|.
name|majorRev
expr_stmt|;
name|p_QmRevisionInfo
operator|->
name|minorRev
operator|=
name|ipcRevInfo
operator|.
name|minorRev
expr_stmt|;
return|return
call|(
name|t_Error
call|)
argument_list|(
name|reply
operator|.
name|error
argument_list|)
return|;
block|}
else|else
name|RETURN_ERROR
argument_list|(
name|WARNING
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"In 'guest', either IPC or 'baseAddress' is required!"
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|QmGetSetPortalParams
parameter_list|(
name|t_Handle
name|h_Qm
parameter_list|,
name|t_QmInterModulePortalInitParams
modifier|*
name|p_PortalParams
parameter_list|)
block|{
name|t_Qm
modifier|*
name|p_Qm
init|=
operator|(
name|t_Qm
operator|*
operator|)
name|h_Qm
decl_stmt|;
name|t_QmRevisionInfo
name|revInfo
decl_stmt|;
name|uint32_t
name|lioReg
decl_stmt|,
name|ioReg
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Qm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_PortalParams
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Qm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
condition|)
block|{
name|QmGetRevision
argument_list|(
name|p_Qm
argument_list|,
operator|&
name|revInfo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|revInfo
operator|.
name|majorRev
operator|==
literal|1
operator|)
operator|&&
operator|(
name|revInfo
operator|.
name|minorRev
operator|==
literal|0
operator|)
condition|)
block|{
name|lioReg
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|p_PortalParams
operator|->
name|stashDestQueue
operator|<<
literal|24
argument_list|)
operator||
operator|(
name|p_PortalParams
operator|->
name|liodn
operator|<<
literal|16
operator|)
operator||
operator|(
name|p_PortalParams
operator|->
name|dqrrLiodn
operator|)
expr_stmt|;
name|ioReg
operator|=
operator|(
name|p_PortalParams
operator|->
name|fdFqLiodn
operator|)
expr_stmt|;
block|}
else|else
block|{
name|lioReg
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|p_PortalParams
operator|->
name|liodn
operator|<<
literal|16
argument_list|)
operator||
operator|(
name|p_PortalParams
operator|->
name|dqrrLiodn
operator|)
expr_stmt|;
name|ioReg
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|p_PortalParams
operator|->
name|stashDestQueue
operator|<<
literal|16
argument_list|)
operator||
operator|(
name|p_PortalParams
operator|->
name|fdFqLiodn
operator|)
expr_stmt|;
block|}
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|swpConfRegs
index|[
name|p_PortalParams
operator|->
name|portalId
index|]
operator|.
name|lio_cfg
argument_list|,
name|lioReg
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|swpConfRegs
index|[
name|p_PortalParams
operator|->
name|portalId
index|]
operator|.
name|io_cfg
argument_list|,
name|ioReg
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p_Qm
operator|->
name|h_Session
condition|)
block|{
name|t_QmIpcMsg
name|msg
decl_stmt|;
name|t_QmIpcPortalInitParams
name|portalParams
decl_stmt|;
name|t_Error
name|errCode
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmIpcMsg
argument_list|)
argument_list|)
expr_stmt|;
name|portalParams
operator|.
name|portalId
operator|=
name|p_PortalParams
operator|->
name|portalId
expr_stmt|;
name|portalParams
operator|.
name|stashDestQueue
operator|=
name|p_PortalParams
operator|->
name|stashDestQueue
expr_stmt|;
name|portalParams
operator|.
name|liodn
operator|=
name|p_PortalParams
operator|->
name|liodn
expr_stmt|;
name|portalParams
operator|.
name|dqrrLiodn
operator|=
name|p_PortalParams
operator|->
name|dqrrLiodn
expr_stmt|;
name|portalParams
operator|.
name|fdFqLiodn
operator|=
name|p_PortalParams
operator|->
name|fdFqLiodn
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|QM_GET_SET_PORTAL_PARAMS
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|&
name|portalParams
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmIpcPortalInitParams
argument_list|)
argument_list|)
expr_stmt|;
name|XX_LockSpinlock
argument_list|(
name|p_Qm
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|errCode
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Qm
operator|->
name|h_Session
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|t_QmIpcPortalInitParams
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|XX_UnlockSpinlock
argument_list|(
name|p_Qm
operator|->
name|lock
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|errCode
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
name|XX_UnlockSpinlock
argument_list|(
name|p_Qm
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
else|else
name|DBG
argument_list|(
name|WARNING
argument_list|,
operator|(
literal|"Can't set portal parameters (e.g. liodns). "
expr|\
literal|"probably QM is running in guest-mode with no IPC!"
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|uint32_t
name|QmFqidGet
parameter_list|(
name|t_Qm
modifier|*
name|p_Qm
parameter_list|,
name|uint32_t
name|size
parameter_list|,
name|uint32_t
name|alignment
parameter_list|,
name|bool
name|force
parameter_list|,
name|uint32_t
name|base
parameter_list|)
block|{
name|uint64_t
name|ans
decl_stmt|;
name|uint32_t
name|intFlags
decl_stmt|;
name|intFlags
operator|=
name|XX_LockIntrSpinlock
argument_list|(
name|p_Qm
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|force
condition|)
block|{
name|ans
operator|=
name|MM_GetForce
argument_list|(
name|p_Qm
operator|->
name|h_FqidMm
argument_list|,
operator|(
name|uint64_t
operator|)
name|base
argument_list|,
operator|(
name|uint64_t
operator|)
name|size
argument_list|,
literal|"QM FQID MEM"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ans
operator|==
name|ILLEGAL_BASE
condition|)
block|{
name|ans
operator|=
name|MM_GetForce
argument_list|(
name|p_Qm
operator|->
name|h_RsrvFqidMm
argument_list|,
operator|(
name|uint64_t
operator|)
name|base
argument_list|,
operator|(
name|uint64_t
operator|)
name|size
argument_list|,
literal|"QM rsrv FQID MEM"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ans
operator|==
name|ILLEGAL_BASE
condition|)
name|ans
operator|=
name|base
expr_stmt|;
elseif|else
if|if
condition|(
name|p_Qm
operator|->
name|h_Session
condition|)
block|{
name|t_QmIpcMsg
name|msg
decl_stmt|;
name|t_QmIpcReply
name|reply
decl_stmt|;
name|uint32_t
name|replyLength
decl_stmt|;
name|t_QmIpcFqidParams
name|ipcFqid
decl_stmt|;
name|t_Error
name|errCode
init|=
name|E_OK
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmIpcMsg
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmIpcReply
argument_list|)
argument_list|)
expr_stmt|;
name|ipcFqid
operator|.
name|fqid
operator|=
name|base
expr_stmt|;
name|ipcFqid
operator|.
name|size
operator|=
name|size
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|QM_FORCE_FQID
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|&
name|ipcFqid
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmIpcFqidParams
argument_list|)
argument_list|)
expr_stmt|;
name|replyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|errCode
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Qm
operator|->
name|h_Session
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|t_QmIpcFqidParams
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|errCode
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
if|if
condition|(
name|replyLength
operator|!=
operator|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|)
condition|)
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"IPC reply length mismatch"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|errCode
operator|!=
name|E_OK
operator|)
operator|||
operator|(
name|replyLength
operator|!=
operator|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|)
operator|)
condition|)
name|ans
operator|=
name|ILLEGAL_BASE
expr_stmt|;
else|else
name|memcpy
argument_list|(
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|ans
argument_list|,
name|reply
operator|.
name|replyBody
argument_list|,
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|DBG
argument_list|(
name|WARNING
argument_list|,
operator|(
literal|"No Ipc - can't validate fqid."
operator|)
argument_list|)
expr_stmt|;
name|ans
operator|=
name|base
expr_stmt|;
block|}
block|}
block|}
else|else
name|ans
operator|=
name|MM_Get
argument_list|(
name|p_Qm
operator|->
name|h_FqidMm
argument_list|,
name|size
argument_list|,
name|alignment
argument_list|,
literal|"QM FQID MEM"
argument_list|)
expr_stmt|;
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_Qm
operator|->
name|lock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|ans
operator|<
name|UINT32_MAX
argument_list|,
operator|(
literal|"Oops, %lx> UINT32_MAX!\n"
operator|,
name|ans
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|uint32_t
operator|)
name|ans
return|;
block|}
end_function

begin_function
name|t_Error
name|QmFqidPut
parameter_list|(
name|t_Qm
modifier|*
name|p_Qm
parameter_list|,
name|uint32_t
name|base
parameter_list|)
block|{
name|uint32_t
name|intFlags
decl_stmt|;
name|intFlags
operator|=
name|XX_LockIntrSpinlock
argument_list|(
name|p_Qm
operator|->
name|lock
argument_list|)
expr_stmt|;
comment|/* Check maybe this fqid was reserved in the past */
if|if
condition|(
name|MM_GetForce
argument_list|(
name|p_Qm
operator|->
name|h_RsrvFqidMm
argument_list|,
operator|(
name|uint64_t
operator|)
name|base
argument_list|,
operator|(
name|uint64_t
operator|)
literal|1
argument_list|,
literal|"QM rsrv FQID MEM"
argument_list|)
operator|==
name|ILLEGAL_BASE
condition|)
block|{
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_Qm
operator|->
name|lock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
else|else
name|MM_PutForce
argument_list|(
name|p_Qm
operator|->
name|h_RsrvFqidMm
argument_list|,
operator|(
name|uint64_t
operator|)
name|base
argument_list|,
operator|(
name|uint64_t
operator|)
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|MM_InRange
argument_list|(
name|p_Qm
operator|->
name|h_FqidMm
argument_list|,
operator|(
name|uint64_t
operator|)
name|base
argument_list|)
condition|)
block|{
if|if
condition|(
name|MM_Put
argument_list|(
name|p_Qm
operator|->
name|h_FqidMm
argument_list|,
operator|(
name|uint64_t
operator|)
name|base
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_Qm
operator|->
name|lock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
else|else
block|{
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_Qm
operator|->
name|lock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|ERROR_CODE
argument_list|(
name|E_NOT_FOUND
argument_list|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|p_Qm
operator|->
name|h_Session
condition|)
block|{
name|t_QmIpcMsg
name|msg
decl_stmt|;
name|t_QmIpcFqidParams
name|ipcFqid
decl_stmt|;
name|t_Error
name|errCode
init|=
name|E_OK
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmIpcMsg
argument_list|)
argument_list|)
expr_stmt|;
name|ipcFqid
operator|.
name|fqid
operator|=
operator|(
name|uint8_t
operator|)
name|base
expr_stmt|;
name|ipcFqid
operator|.
name|size
operator|=
literal|0
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|QM_PUT_FQID
expr_stmt|;
name|memcpy
argument_list|(
name|msg
operator|.
name|msgBody
argument_list|,
operator|&
name|ipcFqid
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmIpcFqidParams
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|errCode
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Qm
operator|->
name|h_Session
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|t_QmIpcFqidParams
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_Qm
operator|->
name|lock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|errCode
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|DBG
argument_list|(
name|WARNING
argument_list|,
operator|(
literal|"No Ipc - can't validate fqid."
operator|)
argument_list|)
expr_stmt|;
name|XX_UnlockIntrSpinlock
argument_list|(
name|p_Qm
operator|->
name|lock
argument_list|,
name|intFlags
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|QmGetCgId
parameter_list|(
name|t_Handle
name|h_Qm
parameter_list|,
name|uint8_t
modifier|*
name|p_CgId
parameter_list|)
block|{
name|t_Qm
modifier|*
name|p_Qm
init|=
operator|(
name|t_Qm
operator|*
operator|)
name|h_Qm
decl_stmt|;
name|uint16_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
name|p_Qm
operator|->
name|partCgsBase
init|;
name|i
operator|<
name|p_Qm
operator|->
name|partCgsBase
operator|+
name|p_Qm
operator|->
name|partNumOfCgs
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|!
name|p_Qm
operator|->
name|cgsUsed
index|[
name|i
index|]
condition|)
block|{
name|p_Qm
operator|->
name|cgsUsed
index|[
name|i
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|TRUE
expr_stmt|;
operator|*
name|p_CgId
operator|=
operator|(
name|uint8_t
operator|)
name|i
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|i
operator|==
operator|(
name|p_Qm
operator|->
name|partCgsBase
operator|+
name|p_Qm
operator|->
name|partNumOfCgs
operator|)
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_BUSY
argument_list|,
operator|(
literal|"No available CG"
operator|)
argument_list|)
expr_stmt|;
else|else
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|QmFreeCgId
parameter_list|(
name|t_Handle
name|h_Qm
parameter_list|,
name|uint8_t
name|cgId
parameter_list|)
block|{
name|t_Qm
modifier|*
name|p_Qm
init|=
operator|(
name|t_Qm
operator|*
operator|)
name|h_Qm
decl_stmt|;
if|if
condition|(
operator|!
name|p_Qm
operator|->
name|cgsUsed
index|[
name|cgId
index|]
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"CG is not in use"
operator|)
argument_list|)
expr_stmt|;
else|else
name|p_Qm
operator|->
name|cgsUsed
index|[
name|cgId
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|FALSE
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/****************************************/
end_comment

begin_comment
comment|/*       API Init unit functions        */
end_comment

begin_comment
comment|/****************************************/
end_comment

begin_function
name|t_Handle
name|QM_Config
parameter_list|(
name|t_QmParam
modifier|*
name|p_QmParam
parameter_list|)
block|{
name|t_Qm
modifier|*
name|p_Qm
decl_stmt|;
name|uint8_t
name|i
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_QmParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|p_Qm
operator|=
operator|(
name|t_Qm
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|t_Qm
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Qm
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"QM obj!!!"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_Qm
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_Qm
argument_list|)
argument_list|)
expr_stmt|;
name|p_Qm
operator|->
name|p_QmDriverParams
operator|=
operator|(
name|t_QmDriverParams
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|t_QmDriverParams
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Qm
operator|->
name|p_QmDriverParams
condition|)
block|{
name|XX_Free
argument_list|(
name|p_Qm
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"Qm driver parameters"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_Qm
operator|->
name|p_QmDriverParams
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmDriverParams
argument_list|)
argument_list|)
expr_stmt|;
name|p_Qm
operator|->
name|guestId
operator|=
name|p_QmParam
operator|->
name|guestId
expr_stmt|;
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|partFqidBase
operator|=
name|p_QmParam
operator|->
name|partFqidBase
expr_stmt|;
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|partNumOfFqids
operator|=
name|p_QmParam
operator|->
name|partNumOfFqids
expr_stmt|;
name|p_Qm
operator|->
name|partCgsBase
operator|=
name|p_QmParam
operator|->
name|partCgsBase
expr_stmt|;
name|p_Qm
operator|->
name|partNumOfCgs
operator|=
name|p_QmParam
operator|->
name|partNumOfCgs
expr_stmt|;
name|p_Qm
operator|->
name|p_QmRegs
operator|=
operator|(
name|t_QmRegs
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|p_QmParam
operator|->
name|baseAddress
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Qm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
condition|)
block|{
name|p_Qm
operator|->
name|exceptions
operator|=
name|DEFAULT_exceptions
expr_stmt|;
name|p_Qm
operator|->
name|f_Exception
operator|=
name|p_QmParam
operator|->
name|f_Exception
expr_stmt|;
name|p_Qm
operator|->
name|h_App
operator|=
name|p_QmParam
operator|->
name|h_App
expr_stmt|;
name|p_Qm
operator|->
name|errIrq
operator|=
name|p_QmParam
operator|->
name|errIrq
expr_stmt|;
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|liodn
operator|=
name|p_QmParam
operator|->
name|liodn
expr_stmt|;
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|rtFramesDepth
operator|=
name|DEFAULT_rtFramesDepth
expr_stmt|;
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|fqdMemPartitionId
operator|=
name|p_QmParam
operator|->
name|fqdMemPartitionId
expr_stmt|;
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|pfdrMemPartitionId
operator|=
name|p_QmParam
operator|->
name|pfdrMemPartitionId
expr_stmt|;
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|swPortalsBaseAddress
operator|=
name|p_QmParam
operator|->
name|swPortalsBaseAddress
expr_stmt|;
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|totalNumOfFqids
operator|=
name|p_QmParam
operator|->
name|totalNumOfFqids
expr_stmt|;
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|pfdrThreshold
operator|=
name|DEFAULT_pfdrThreshold
expr_stmt|;
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|sfdrThreshold
operator|=
name|DEFAULT_sfdrThreshold
expr_stmt|;
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|pfdrBaseConstant
operator|=
name|DEFAULT_pfdrBaseConstant
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DPAA_MAX_NUM_OF_DC_PORTALS
condition|;
name|i
operator|++
control|)
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|dcPortalsParams
index|[
name|i
index|]
operator|.
name|sendToSw
operator|=
call|(
name|bool
call|)
argument_list|(
operator|(
name|i
operator|<
name|e_DPAA_DCPORTAL2
operator|)
condition|?
name|FALSE
else|:
name|TRUE
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|QMAN_SFDR_LEAK_ERRATA_QMAN5
block|{
define|#
directive|define
name|WORKAROUND_TMP_VAL
value|0x00000003
name|t_QmRevisionInfo
name|revInfo
decl_stmt|;
name|QmGetRevision
argument_list|(
name|p_Qm
argument_list|,
operator|&
name|revInfo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|revInfo
operator|.
name|majorRev
operator|==
literal|1
operator|)
operator|&&
operator|(
name|revInfo
operator|.
name|minorRev
operator|==
literal|0
operator|)
condition|)
block|{
name|uint32_t
modifier|*
name|tmp
init|=
operator|(
name|uint32_t
operator|*
operator|)
name|UINT_TO_PTR
argument_list|(
name|p_QmParam
operator|->
name|baseAddress
operator|+
literal|0xbf0
argument_list|)
decl_stmt|;
name|uint32_t
name|tmpReg
init|=
name|WORKAROUND_TMP_VAL
decl_stmt|;
name|WRITE_UINT32
argument_list|(
operator|*
name|tmp
argument_list|,
name|tmpReg
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|tmpReg
operator|=
name|GET_UINT32
argument_list|(
operator|*
name|tmp
argument_list|)
operator|)
operator|!=
name|WORKAROUND_TMP_VAL
condition|)
empty_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* QMAN_SFDR_LEAK_ERRATA_QMAN5 */
block|}
comment|/* build the QM partition IPC address */
name|memset
argument_list|(
name|p_Qm
operator|->
name|moduleName
argument_list|,
literal|0
argument_list|,
name|MODULE_NAME_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|Sprint
argument_list|(
name|p_Qm
operator|->
name|moduleName
argument_list|,
literal|"QM_0_%d"
argument_list|,
name|p_Qm
operator|->
name|guestId
argument_list|)
operator|!=
operator|(
name|p_Qm
operator|->
name|guestId
operator|<
literal|10
condition|?
literal|6
else|:
literal|7
operator|)
condition|)
block|{
name|XX_Free
argument_list|(
name|p_Qm
operator|->
name|p_QmDriverParams
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_Qm
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Sprint failed"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|p_Qm
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_Init
parameter_list|(
name|t_Handle
name|h_Qm
parameter_list|)
block|{
name|t_Qm
modifier|*
name|p_Qm
init|=
operator|(
name|t_Qm
operator|*
operator|)
name|h_Qm
decl_stmt|;
name|t_QmDriverParams
modifier|*
name|p_QmDriverParams
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Qm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Qm
operator|->
name|p_QmDriverParams
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|CHECK_INIT_PARAMETERS
argument_list|(
name|p_Qm
argument_list|,
name|CheckQmParameters
argument_list|)
expr_stmt|;
name|p_QmDriverParams
operator|=
name|p_Qm
operator|->
name|p_QmDriverParams
expr_stmt|;
if|if
condition|(
name|p_QmDriverParams
operator|->
name|partNumOfFqids
condition|)
block|{
if|if
condition|(
name|MM_Init
argument_list|(
operator|&
name|p_Qm
operator|->
name|h_FqidMm
argument_list|,
name|p_QmDriverParams
operator|->
name|partFqidBase
argument_list|,
name|p_QmDriverParams
operator|->
name|partNumOfFqids
argument_list|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
operator|(
literal|"QM-FQIDS-MEM partition!!!"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|MM_Init
argument_list|(
operator|&
name|p_Qm
operator|->
name|h_RsrvFqidMm
argument_list|,
name|p_QmDriverParams
operator|->
name|partFqidBase
argument_list|,
name|p_QmDriverParams
operator|->
name|partNumOfFqids
argument_list|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
operator|(
literal|"QM-Reserve-FQIDS-MEM partition!!!"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p_Qm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
condition|)
block|{
name|uint64_t
name|phyAddr
decl_stmt|;
name|t_QmRevisionInfo
name|revInfo
decl_stmt|;
name|uint32_t
name|dsSize
decl_stmt|,
name|exp
decl_stmt|,
name|i
decl_stmt|;
name|QmGetRevision
argument_list|(
name|p_Qm
argument_list|,
operator|&
name|revInfo
argument_list|)
expr_stmt|;
name|DBG
argument_list|(
name|TRACE
argument_list|,
operator|(
literal|"Qman ver:%02x,%02x"
operator|,
name|revInfo
operator|.
name|majorRev
operator|,
name|revInfo
operator|.
name|minorRev
operator|)
argument_list|)
expr_stmt|;
name|phyAddr
operator|=
name|XX_VirtToPhys
argument_list|(
name|UINT_TO_PTR
argument_list|(
name|p_QmDriverParams
operator|->
name|swPortalsBaseAddress
argument_list|)
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|qcsp_bare
argument_list|,
operator|(
call|(
name|uint32_t
call|)
argument_list|(
name|phyAddr
operator|>>
literal|32
argument_list|)
operator|&
literal|0x000000ff
operator|)
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|qcsp_bar
argument_list|,
operator|(
name|uint32_t
operator|)
name|phyAddr
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|liodnr
argument_list|,
operator|(
name|uint16_t
operator|)
name|p_QmDriverParams
operator|->
name|liodn
argument_list|)
expr_stmt|;
comment|/* FQD memory */
name|dsSize
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|p_QmDriverParams
operator|->
name|totalNumOfFqids
operator|*
name|FQD_ENTRY_SIZE
argument_list|)
expr_stmt|;
name|LOG2
argument_list|(
name|dsSize
argument_list|,
name|exp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|POWER_OF_2
argument_list|(
name|dsSize
argument_list|)
condition|)
operator|(
name|exp
operator|++
operator|)
expr_stmt|;
name|dsSize
operator|=
call|(
name|uint32_t
call|)
argument_list|(
literal|1
operator|<<
name|exp
argument_list|)
expr_stmt|;
if|if
condition|(
name|dsSize
operator|<
operator|(
literal|4
operator|*
name|KILOBYTE
operator|)
condition|)
block|{
name|dsSize
operator|=
operator|(
literal|4
operator|*
name|KILOBYTE
operator|)
expr_stmt|;
name|LOG2
argument_list|(
name|dsSize
argument_list|,
name|exp
argument_list|)
expr_stmt|;
block|}
name|p_Qm
operator|->
name|p_FqdBase
operator|=
name|XX_MallocSmart
argument_list|(
name|dsSize
argument_list|,
operator|(
name|int
operator|)
name|p_QmDriverParams
operator|->
name|fqdMemPartitionId
argument_list|,
name|dsSize
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Qm
operator|->
name|p_FqdBase
condition|)
block|{
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"FQD obj!!!"
operator|)
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
name|p_Qm
operator|->
name|p_FqdBase
argument_list|,
literal|0
argument_list|,
name|dsSize
argument_list|)
expr_stmt|;
name|mb
argument_list|()
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|dsSize
condition|;
name|i
operator|+=
literal|64
control|)
name|dcbf
argument_list|(
name|PTR_MOVE
argument_list|(
name|p_Qm
operator|->
name|p_FqdBase
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
name|mb
argument_list|()
expr_stmt|;
name|phyAddr
operator|=
name|XX_VirtToPhys
argument_list|(
name|p_Qm
operator|->
name|p_FqdBase
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|fqd_bare
argument_list|,
operator|(
call|(
name|uint32_t
call|)
argument_list|(
name|phyAddr
operator|>>
literal|32
argument_list|)
operator|&
literal|0x000000ff
operator|)
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|fqd_bar
argument_list|,
operator|(
name|uint32_t
operator|)
name|phyAddr
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|fqd_ar
argument_list|,
name|AR_ENABLE
operator||
operator|(
name|exp
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
comment|/* PFDR memory */
name|dsSize
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|p_QmDriverParams
operator|->
name|rtFramesDepth
operator|*
operator|(
name|PFDR_ENTRY_SIZE
operator|/
literal|3
operator|)
argument_list|)
expr_stmt|;
name|LOG2
argument_list|(
name|dsSize
argument_list|,
name|exp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|POWER_OF_2
argument_list|(
name|dsSize
argument_list|)
condition|)
operator|(
name|exp
operator|++
operator|)
expr_stmt|;
name|dsSize
operator|=
call|(
name|uint32_t
call|)
argument_list|(
literal|1
operator|<<
name|exp
argument_list|)
expr_stmt|;
if|if
condition|(
name|dsSize
operator|<
operator|(
literal|4
operator|*
name|KILOBYTE
operator|)
condition|)
block|{
name|dsSize
operator|=
operator|(
literal|4
operator|*
name|KILOBYTE
operator|)
expr_stmt|;
name|LOG2
argument_list|(
name|dsSize
argument_list|,
name|exp
argument_list|)
expr_stmt|;
block|}
name|p_Qm
operator|->
name|p_PfdrBase
operator|=
name|XX_MallocSmart
argument_list|(
name|dsSize
argument_list|,
operator|(
name|int
operator|)
name|p_QmDriverParams
operator|->
name|pfdrMemPartitionId
argument_list|,
name|dsSize
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Qm
operator|->
name|p_PfdrBase
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"PFDR obj!!!"
operator|)
argument_list|)
expr_stmt|;
name|phyAddr
operator|=
name|XX_VirtToPhys
argument_list|(
name|p_Qm
operator|->
name|p_PfdrBase
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|pfdr_bare
argument_list|,
operator|(
call|(
name|uint32_t
call|)
argument_list|(
name|phyAddr
operator|>>
literal|32
argument_list|)
operator|&
literal|0x000000ff
operator|)
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|pfdr_bar
argument_list|,
operator|(
name|uint32_t
operator|)
name|phyAddr
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|pfdr_ar
argument_list|,
name|AR_ENABLE
operator||
operator|(
name|exp
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|QmInitPfdr
argument_list|(
name|p_Qm
argument_list|,
literal|8
argument_list|,
name|dsSize
operator|/
literal|64
operator|-
literal|8
argument_list|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"PFDR init failed!!!"
operator|)
argument_list|)
expr_stmt|;
comment|/* thresholds */
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|pfdr_fp_lwit
argument_list|,
operator|(
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|pfdrThreshold
operator|&
literal|0xffffff
operator|)
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|pfdr_cfg
argument_list|,
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|pfdrBaseConstant
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|sfdr_cfg
argument_list|,
operator|(
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|sfdrThreshold
operator|&
literal|0x3ff
operator|)
argument_list|)
expr_stmt|;
name|p_Qm
operator|->
name|numOfPfdr
operator|=
name|GET_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|pfdr_fpc
argument_list|)
expr_stmt|;
comment|/* corenet initiator settings */
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|ci_sched_cfg
argument_list|,
operator|(
name|CI_SCHED_CFG_EN
operator||
operator|(
name|DEFAULT_initiatorSrcciv
operator|<<
name|CI_SCHED_CFG_SRCCIV_SHIFT
operator|)
operator||
operator|(
name|DEFAULT_initiatorSrqW
operator|<<
name|CI_SCHED_CFG_SRQ_W_SHIFT
operator|)
operator||
operator|(
name|DEFAULT_initiatorRwW
operator|<<
name|CI_SCHED_CFG_RW_W_SHIFT
operator|)
operator||
operator|(
name|DEFAULT_initiatorBmanW
operator|<<
name|CI_SCHED_CFG_BMAN_W_SHIFT
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|/* HID settings */
if|if
condition|(
operator|(
name|revInfo
operator|.
name|majorRev
operator|==
literal|1
operator|)
operator|&&
operator|(
name|revInfo
operator|.
name|minorRev
operator|==
literal|0
operator|)
condition|)
comment|/* offset 0x0bf0 */
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|res23
index|[
literal|144
index|]
argument_list|,
literal|0x3
argument_list|)
expr_stmt|;
else|else
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|res23
index|[
literal|144
index|]
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DPAA_MAX_NUM_OF_DC_PORTALS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|dcPortalsParams
index|[
name|i
index|]
operator|.
name|sendToSw
condition|)
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|dcpConfRegs
index|[
name|i
index|]
operator|.
name|cfg
argument_list|,
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|dcPortalsParams
index|[
name|i
index|]
operator|.
name|swPortalId
argument_list|)
expr_stmt|;
else|else
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|dcpConfRegs
index|[
name|i
index|]
operator|.
name|cfg
argument_list|,
name|QM_DCP_CFG_ED
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|QMAN_WQ_CS_CFG_ERRATA_QMAN4
block|{
name|t_QmRevisionInfo
name|revInfo
decl_stmt|;
name|QmGetRevision
argument_list|(
name|p_Qm
argument_list|,
operator|&
name|revInfo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|revInfo
operator|.
name|majorRev
operator|==
literal|1
operator|)
operator|&&
operator|(
name|revInfo
operator|.
name|minorRev
operator|==
literal|0
operator|)
condition|)
block|{
name|QmSetWqScheduling
argument_list|(
name|p_Qm
argument_list|,
name|e_QM_WQ_SW_PORTALS
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|QmSetWqScheduling
argument_list|(
name|p_Qm
argument_list|,
name|e_QM_WQ_POOLS
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|QmSetWqScheduling
argument_list|(
name|p_Qm
argument_list|,
name|e_QM_WQ_DCP0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|QmSetWqScheduling
argument_list|(
name|p_Qm
argument_list|,
name|e_QM_WQ_DCP1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|QmSetWqScheduling
argument_list|(
name|p_Qm
argument_list|,
name|e_QM_WQ_DCP2
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|QmSetWqScheduling
argument_list|(
name|p_Qm
argument_list|,
name|e_QM_WQ_DCP3
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* QMAN_WQ_CS_CFG_ERRATA_QMAN4 */
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|err_isr
argument_list|,
name|p_Qm
operator|->
name|exceptions
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|err_ier
argument_list|,
name|p_Qm
operator|->
name|exceptions
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|err_isdr
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Qm
operator|->
name|errIrq
operator|!=
name|NO_IRQ
condition|)
block|{
name|XX_SetIntr
argument_list|(
name|p_Qm
operator|->
name|errIrq
argument_list|,
name|QM_ErrorIsr
argument_list|,
name|p_Qm
argument_list|)
expr_stmt|;
name|XX_EnableIntr
argument_list|(
name|p_Qm
operator|->
name|errIrq
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|err
operator|=
name|XX_IpcRegisterMsgHandler
argument_list|(
name|p_Qm
operator|->
name|moduleName
argument_list|,
name|QmHandleIpcMsgCB
argument_list|,
name|p_Qm
argument_list|,
name|QM_IPC_MAX_REPLY_SIZE
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* guest mode */
block|{
name|char
name|masterModuleName
index|[
name|MODULE_NAME_SIZE
index|]
decl_stmt|;
name|memset
argument_list|(
name|masterModuleName
argument_list|,
literal|0
argument_list|,
name|MODULE_NAME_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|Sprint
argument_list|(
name|masterModuleName
argument_list|,
literal|"QM_0_%d"
argument_list|,
name|NCSW_MASTER_ID
argument_list|)
operator|!=
operator|(
name|NCSW_MASTER_ID
operator|<
literal|10
condition|?
literal|6
else|:
literal|7
operator|)
condition|)
block|{
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"Sprint failed"
operator|)
argument_list|)
expr_stmt|;
block|}
name|p_Qm
operator|->
name|h_Session
operator|=
name|XX_IpcInitSession
argument_list|(
name|masterModuleName
argument_list|,
name|p_Qm
operator|->
name|moduleName
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Qm
operator|->
name|h_Session
condition|)
block|{
name|t_QmIpcMsg
name|msg
decl_stmt|;
name|uint8_t
name|isMasterAlive
init|=
literal|0
decl_stmt|;
name|t_QmIpcReply
name|reply
decl_stmt|;
name|uint32_t
name|replyLength
decl_stmt|;
name|memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmIpcMsg
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|reply
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_QmIpcReply
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msgId
operator|=
name|QM_MASTER_IS_ALIVE
expr_stmt|;
do|do
block|{
name|blockingFlag
operator|=
name|TRUE
expr_stmt|;
name|replyLength
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|XX_IpcSendMessage
argument_list|(
name|p_Qm
operator|->
name|h_Session
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|msg
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
operator|.
name|msgId
argument_list|)
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
operator|&
name|reply
argument_list|,
operator|&
name|replyLength
argument_list|,
name|QmIpcMsgCompletionCB
argument_list|,
name|p_Qm
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
while|while
condition|(
name|blockingFlag
condition|)
empty_stmt|;
if|if
condition|(
name|replyLength
operator|!=
operator|(
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
operator|)
condition|)
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_VALUE
argument_list|,
operator|(
literal|"IPC reply length mismatch"
operator|)
argument_list|)
expr_stmt|;
name|isMasterAlive
operator|=
operator|*
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|reply
operator|.
name|replyBody
operator|)
expr_stmt|;
block|}
do|while
condition|(
operator|!
name|isMasterAlive
condition|)
do|;
block|}
block|}
name|p_Qm
operator|->
name|lock
operator|=
name|XX_InitSpinlock
argument_list|()
expr_stmt|;
name|XX_Free
argument_list|(
name|p_Qm
operator|->
name|p_QmDriverParams
argument_list|)
expr_stmt|;
name|p_Qm
operator|->
name|p_QmDriverParams
operator|=
name|NULL
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_Free
parameter_list|(
name|t_Handle
name|h_Qm
parameter_list|)
block|{
name|t_Qm
modifier|*
name|p_Qm
init|=
operator|(
name|t_Qm
operator|*
operator|)
name|h_Qm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Qm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Qm
operator|->
name|lock
condition|)
name|XX_FreeSpinlock
argument_list|(
name|p_Qm
operator|->
name|lock
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Qm
operator|->
name|guestId
operator|==
name|NCSW_MASTER_ID
condition|)
block|{
name|XX_IpcUnregisterMsgHandler
argument_list|(
name|p_Qm
operator|->
name|moduleName
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Qm
operator|->
name|errIrq
operator|!=
name|NO_IRQ
condition|)
block|{
name|XX_DisableIntr
argument_list|(
name|p_Qm
operator|->
name|errIrq
argument_list|)
expr_stmt|;
name|XX_FreeIntr
argument_list|(
name|p_Qm
operator|->
name|errIrq
argument_list|)
expr_stmt|;
block|}
block|}
name|FreeInitResources
argument_list|(
name|p_Qm
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Qm
operator|->
name|p_QmDriverParams
condition|)
name|XX_Free
argument_list|(
name|p_Qm
operator|->
name|p_QmDriverParams
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_Qm
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_ConfigRTFramesDepth
parameter_list|(
name|t_Handle
name|h_Qm
parameter_list|,
name|uint32_t
name|rtFramesDepth
parameter_list|)
block|{
name|t_Qm
modifier|*
name|p_Qm
init|=
operator|(
name|t_Qm
operator|*
operator|)
name|h_Qm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Qm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Qm
operator|->
name|p_QmDriverParams
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|rtFramesDepth
operator|=
name|rtFramesDepth
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_ConfigPfdrThreshold
parameter_list|(
name|t_Handle
name|h_Qm
parameter_list|,
name|uint32_t
name|threshold
parameter_list|)
block|{
name|t_Qm
modifier|*
name|p_Qm
init|=
operator|(
name|t_Qm
operator|*
operator|)
name|h_Qm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Qm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Qm
operator|->
name|p_QmDriverParams
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|pfdrThreshold
operator|=
name|threshold
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_ConfigSfdrReservationThreshold
parameter_list|(
name|t_Handle
name|h_Qm
parameter_list|,
name|uint32_t
name|threshold
parameter_list|)
block|{
name|t_Qm
modifier|*
name|p_Qm
init|=
operator|(
name|t_Qm
operator|*
operator|)
name|h_Qm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Qm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Qm
operator|->
name|p_QmDriverParams
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_Qm
operator|->
name|p_QmDriverParams
operator|->
name|sfdrThreshold
operator|=
name|threshold
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_ConfigErrorRejectionNotificationDest
parameter_list|(
name|t_Handle
name|h_Qm
parameter_list|,
name|e_DpaaDcPortal
name|id
parameter_list|,
name|t_QmDcPortalParams
modifier|*
name|p_Params
parameter_list|)
block|{
name|UNUSED
argument_list|(
name|h_Qm
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|id
argument_list|)
expr_stmt|;
name|UNUSED
argument_list|(
name|p_Params
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|INFO
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"Only default ERN destination available."
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|t_Error
name|QM_Poll
parameter_list|(
name|t_Handle
name|h_Qm
parameter_list|,
name|e_QmPortalPollSource
name|source
parameter_list|)
block|{
name|t_Qm
modifier|*
name|p_Qm
init|=
operator|(
name|t_Qm
operator|*
operator|)
name|h_Qm
decl_stmt|;
name|t_QmPortal
modifier|*
name|p_QmPortal
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Qm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_QmPortal
operator|=
name|QmGetPortalHandle
argument_list|(
name|p_Qm
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmPortal
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
return|return
name|QM_PORTAL_Poll
argument_list|(
name|p_QmPortal
argument_list|,
name|source
argument_list|)
return|;
block|}
end_function

begin_function
name|uint32_t
name|QM_GetCounter
parameter_list|(
name|t_Handle
name|h_Qm
parameter_list|,
name|e_QmCounters
name|counter
parameter_list|)
block|{
name|t_Qm
modifier|*
name|p_Qm
init|=
operator|(
name|t_Qm
operator|*
operator|)
name|h_Qm
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_Qm
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
operator|!
name|p_Qm
operator|->
name|p_QmDriverParams
argument_list|,
name|E_INVALID_STATE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|counter
condition|)
block|{
case|case
operator|(
name|e_QM_COUNTERS_SFDR_IN_USE
operator|)
case|:
return|return
name|QmGetCounter
argument_list|(
name|p_Qm
argument_list|,
name|e_QM_IM_COUNTERS_SFDR_IN_USE
argument_list|)
return|;
case|case
operator|(
name|e_QM_COUNTERS_PFDR_IN_USE
operator|)
case|:
return|return
name|QmGetCounter
argument_list|(
name|p_Qm
argument_list|,
name|e_QM_IM_COUNTERS_PFDR_IN_USE
argument_list|)
return|;
case|case
operator|(
name|e_QM_COUNTERS_PFDR_FREE_POOL
operator|)
case|:
return|return
name|QmGetCounter
argument_list|(
name|p_Qm
argument_list|,
name|e_QM_IM_COUNTERS_PFDR_FREE_POOL
argument_list|)
return|;
default|default:
break|break;
block|}
comment|/* should never get here */
name|ASSERT_COND
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|QM_ErrorIsr
parameter_list|(
name|t_Handle
name|h_Qm
parameter_list|)
block|{
name|t_Qm
modifier|*
name|p_Qm
init|=
operator|(
name|t_Qm
operator|*
operator|)
name|h_Qm
decl_stmt|;
name|uint32_t
name|tmpReg
decl_stmt|;
name|SANITY_CHECK_RETURN
argument_list|(
name|p_Qm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_Qm
operator|->
name|guestId
operator|!=
name|NCSW_MASTER_ID
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|WARNING
argument_list|,
name|E_INVALID_OPERATION
argument_list|,
operator|(
literal|"Master Only"
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tmpReg
operator|=
name|GET_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|err_isr
argument_list|)
expr_stmt|;
name|tmpReg
operator|&=
name|GET_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|err_ier
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|err_isr
argument_list|,
name|tmpReg
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpReg
operator|&
name|QM_EX_CORENET_INITIATOR_DATA
condition|)
name|p_Qm
operator|->
name|f_Exception
argument_list|(
name|p_Qm
operator|->
name|h_App
argument_list|,
name|e_QM_EX_CORENET_INITIATOR_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpReg
operator|&
name|QM_EX_CORENET_TARGET_DATA
condition|)
name|p_Qm
operator|->
name|f_Exception
argument_list|(
name|p_Qm
operator|->
name|h_App
argument_list|,
name|e_QM_EX_CORENET_TARGET_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpReg
operator|&
name|QM_EX_CORENET_INVALID_TARGET_TRANSACTION
condition|)
name|p_Qm
operator|->
name|f_Exception
argument_list|(
name|p_Qm
operator|->
name|h_App
argument_list|,
name|e_QM_EX_CORENET_INVALID_TARGET_TRANSACTION
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpReg
operator|&
name|QM_EX_PFDR_THRESHOLD
condition|)
name|p_Qm
operator|->
name|f_Exception
argument_list|(
name|p_Qm
operator|->
name|h_App
argument_list|,
name|e_QM_EX_PFDR_THRESHOLD
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpReg
operator|&
name|QM_EX_MULTI_ECC
condition|)
name|p_Qm
operator|->
name|f_Exception
argument_list|(
name|p_Qm
operator|->
name|h_App
argument_list|,
name|e_QM_EX_MULTI_ECC
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpReg
operator|&
name|QM_EX_SINGLE_ECC
condition|)
name|p_Qm
operator|->
name|f_Exception
argument_list|(
name|p_Qm
operator|->
name|h_App
argument_list|,
name|e_QM_EX_SINGLE_ECC
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpReg
operator|&
name|QM_EX_PFDR_ENQUEUE_BLOCKED
condition|)
name|p_Qm
operator|->
name|f_Exception
argument_list|(
name|p_Qm
operator|->
name|h_App
argument_list|,
name|e_QM_EX_PFDR_ENQUEUE_BLOCKED
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpReg
operator|&
name|QM_EX_INVALID_COMMAND
condition|)
name|p_Qm
operator|->
name|f_Exception
argument_list|(
name|p_Qm
operator|->
name|h_App
argument_list|,
name|e_QM_EX_INVALID_COMMAND
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpReg
operator|&
name|QM_EX_DEQUEUE_DCP
condition|)
name|p_Qm
operator|->
name|f_Exception
argument_list|(
name|p_Qm
operator|->
name|h_App
argument_list|,
name|e_QM_EX_DEQUEUE_DCP
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpReg
operator|&
name|QM_EX_DEQUEUE_FQ
condition|)
name|p_Qm
operator|->
name|f_Exception
argument_list|(
name|p_Qm
operator|->
name|h_App
argument_list|,
name|e_QM_EX_DEQUEUE_FQ
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpReg
operator|&
name|QM_EX_DEQUEUE_SOURCE
condition|)
name|p_Qm
operator|->
name|f_Exception
argument_list|(
name|p_Qm
operator|->
name|h_App
argument_list|,
name|e_QM_EX_DEQUEUE_SOURCE
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpReg
operator|&
name|QM_EX_DEQUEUE_QUEUE
condition|)
name|p_Qm
operator|->
name|f_Exception
argument_list|(
name|p_Qm
operator|->
name|h_App
argument_list|,
name|e_QM_EX_DEQUEUE_QUEUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpReg
operator|&
name|QM_EX_ENQUEUE_OVERFLOW
condition|)
name|p_Qm
operator|->
name|f_Exception
argument_list|(
name|p_Qm
operator|->
name|h_App
argument_list|,
name|e_QM_EX_ENQUEUE_OVERFLOW
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpReg
operator|&
name|QM_EX_ENQUEUE_STATE
condition|)
name|p_Qm
operator|->
name|f_Exception
argument_list|(
name|p_Qm
operator|->
name|h_App
argument_list|,
name|e_QM_EX_ENQUEUE_STATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpReg
operator|&
name|QM_EX_ENQUEUE_CHANNEL
condition|)
name|p_Qm
operator|->
name|f_Exception
argument_list|(
name|p_Qm
operator|->
name|h_App
argument_list|,
name|e_QM_EX_ENQUEUE_CHANNEL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmpReg
operator|&
name|QM_EX_ENQUEUE_QUEUE
condition|)
name|p_Qm
operator|->
name|f_Exception
argument_list|(
name|p_Qm
operator|->
name|h_App
argument_list|,
name|e_QM_EX_ENQUEUE_QUEUE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|t_Error
name|QM_SetException
parameter_list|(
name|t_Handle
name|h_Qm
parameter_list|,
name|e_QmExceptions
name|exception
parameter_list|,
name|bool
name|enable
parameter_list|)
block|{
name|t_Qm
modifier|*
name|p_Qm
init|=
operator|(
name|t_Qm
operator|*
operator|)
name|h_Qm
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Qm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Qm
operator|->
name|p_QmDriverParams
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|err
operator|=
name|SetException
argument_list|(
name|p_Qm
argument_list|,
name|exception
argument_list|,
name|enable
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|MINOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|err_ier
argument_list|,
name|p_Qm
operator|->
name|exceptions
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_GetRevision
parameter_list|(
name|t_Handle
name|h_Qm
parameter_list|,
name|t_QmRevisionInfo
modifier|*
name|p_QmRevisionInfo
parameter_list|)
block|{
name|t_Qm
modifier|*
name|p_Qm
init|=
operator|(
name|t_Qm
operator|*
operator|)
name|h_Qm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Qm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_QmRevisionInfo
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
return|return
name|QmGetRevision
argument_list|(
name|p_Qm
argument_list|,
name|p_QmRevisionInfo
argument_list|)
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_ReserveQueues
parameter_list|(
name|t_Handle
name|h_Qm
parameter_list|,
name|t_QmRsrvFqrParams
modifier|*
name|p_QmFqrParams
parameter_list|,
name|uint32_t
modifier|*
name|p_BaseFqid
parameter_list|)
block|{
name|t_Qm
modifier|*
name|p_Qm
init|=
operator|(
name|t_Qm
operator|*
operator|)
name|h_Qm
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Qm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Qm
operator|->
name|p_QmDriverParams
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
operator|*
name|p_BaseFqid
operator|=
name|ReserveFqids
argument_list|(
name|p_Qm
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|p_QmFqrParams
operator|->
name|useForce
operator|&&
operator|!
name|p_QmFqrParams
operator|->
name|numOfFqids
operator|)
condition|?
literal|1
else|:
name|p_QmFqrParams
operator|->
name|numOfFqids
argument_list|)
argument_list|,
name|p_QmFqrParams
operator|->
name|qs
operator|.
name|nonFrcQs
operator|.
name|align
argument_list|,
name|p_QmFqrParams
operator|->
name|useForce
argument_list|,
name|p_QmFqrParams
operator|->
name|qs
operator|.
name|frcQ
operator|.
name|fqid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p_BaseFqid
operator|==
name|ILLEGAL_BASE
condition|)
name|RETURN_ERROR
argument_list|(
name|CRITICAL
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"can't allocate a fqid"
operator|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|QM_GetErrorInformation
parameter_list|(
name|t_Handle
name|h_Qm
parameter_list|,
name|t_QmErrorInfo
modifier|*
name|p_errInfo
parameter_list|)
block|{
name|uint32_t
name|ecsr
decl_stmt|,
name|ecir
decl_stmt|;
name|t_Qm
modifier|*
name|p_Qm
init|=
operator|(
name|t_Qm
operator|*
operator|)
name|h_Qm
decl_stmt|;
name|t_Error
name|err
init|=
name|E_OK
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Qm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Qm
operator|->
name|p_QmDriverParams
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_errInfo
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|ecsr
operator|=
name|GET_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|ecsr
argument_list|)
expr_stmt|;
name|ecir
operator|=
name|GET_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|ecir
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ecsr
operator|&
name|QM_EX_MULTI_ECC
operator|)
operator|||
operator|(
name|ecsr
operator|&
name|QM_EX_SINGLE_ECC
operator|)
condition|)
block|{
name|err
operator|=
name|E_NOT_SUPPORTED
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|INFO
argument_list|,
name|E_NOT_SUPPORTED
argument_list|,
operator|(
literal|"single and multi ecc, use QM_DumpRegs"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ecsr
operator|&
name|QM_EX_ENQUEUE_QUEUE
operator|)
operator|||
operator|(
name|ecsr
operator|&
name|QM_EX_ENQUEUE_STATE
operator|)
operator|||
operator|(
name|ecsr
operator|&
name|QM_EX_ENQUEUE_OVERFLOW
operator|)
operator|||
operator|(
name|ecsr
operator|&
name|QM_EX_DEQUEUE_DCP
operator|)
operator|||
operator|(
name|ecsr
operator|&
name|QM_EX_DEQUEUE_FQ
operator|)
operator|||
operator|(
name|ecsr
operator|&
name|QM_EX_DEQUEUE_QUEUE
operator|)
operator|||
operator|(
name|ecsr
operator|&
name|QM_EX_DEQUEUE_SOURCE
operator|)
operator|||
operator|(
name|ecsr
operator|&
name|QM_EX_INVALID_COMMAND
operator|)
condition|)
block|{
name|p_errInfo
operator|->
name|portalValid
operator|=
name|TRUE
expr_stmt|;
name|p_errInfo
operator|->
name|hwPortal
operator|=
call|(
name|bool
call|)
argument_list|(
name|ecir
operator|&
name|ECIR_PORTAL_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_errInfo
operator|->
name|hwPortal
condition|)
name|p_errInfo
operator|->
name|dcpId
operator|=
call|(
name|e_DpaaDcPortal
call|)
argument_list|(
operator|(
name|ecir
operator|&
name|ECIR_PORTAL_MASK
operator|)
operator|>>
name|ECIR_PORTAL_SHIFT
argument_list|)
expr_stmt|;
else|else
name|p_errInfo
operator|->
name|swPortalId
operator|=
call|(
name|e_DpaaSwPortal
call|)
argument_list|(
operator|(
name|ecir
operator|&
name|ECIR_PORTAL_MASK
operator|)
operator|>>
name|ECIR_PORTAL_SHIFT
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ecsr
operator|&
name|QM_EX_ENQUEUE_QUEUE
operator|)
operator|||
operator|(
name|ecsr
operator|&
name|QM_EX_ENQUEUE_STATE
operator|)
operator|||
operator|(
name|ecsr
operator|&
name|QM_EX_ENQUEUE_OVERFLOW
operator|)
operator|||
operator|(
name|ecsr
operator|&
name|QM_EX_ENQUEUE_CHANNEL
operator|)
operator|||
operator|(
name|ecsr
operator|&
name|QM_EX_DEQUEUE_QUEUE
operator|)
operator|||
operator|(
name|ecsr
operator|&
name|QM_EX_DEQUEUE_FQ
operator|)
condition|)
block|{
name|p_errInfo
operator|->
name|fqidValid
operator|=
name|TRUE
expr_stmt|;
name|p_errInfo
operator|->
name|fqid
operator|=
operator|(
operator|(
name|ecir
operator|&
name|ECIR_FQID_MASK
operator|)
operator|>>
name|ECIR_FQID_SHIFT
operator|)
expr_stmt|;
block|}
name|WRITE_UINT32
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|ecsr
argument_list|,
name|ecsr
argument_list|)
expr_stmt|;
return|return
name|ERROR_CODE
argument_list|(
name|err
argument_list|)
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|(
name|defined
argument_list|(
name|DEBUG_ERRORS
argument_list|)
operator|&&
operator|(
name|DEBUG_ERRORS
operator|>
literal|0
operator|)
operator|)
end_if

begin_function
name|t_Error
name|QM_DumpRegs
parameter_list|(
name|t_Handle
name|h_Qm
parameter_list|)
block|{
name|t_Qm
modifier|*
name|p_Qm
init|=
operator|(
name|t_Qm
operator|*
operator|)
name|h_Qm
decl_stmt|;
name|uint8_t
name|i
init|=
literal|0
decl_stmt|;
name|DECLARE_DUMP
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Qm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_Qm
operator|->
name|p_QmDriverParams
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|DUMP_SUBTITLE
argument_list|(
operator|(
literal|"\n"
operator|)
argument_list|)
expr_stmt|;
name|DUMP_TITLE
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
operator|(
literal|"QmRegs Regs"
operator|)
argument_list|)
expr_stmt|;
name|DUMP_SUBSTRUCT_ARRAY
argument_list|(
argument|i
argument_list|,
argument|QM_NUM_OF_SWP
argument_list|)
block|{
name|DUMP_VAR
argument_list|(
operator|&
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|swpConfRegs
index|[
name|i
index|]
argument_list|,
name|lio_cfg
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
operator|&
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|swpConfRegs
index|[
name|i
index|]
argument_list|,
name|io_cfg
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
operator|&
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|swpConfRegs
index|[
name|i
index|]
argument_list|,
name|dd_cfg
argument_list|)
expr_stmt|;
block|}
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|qman_dd_cfg
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|qcsp_dd_ihrsr
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|qcsp_dd_ihrfr
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|qcsp_dd_hasr
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|dcp_dd_ihrsr
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|dcp_dd_ihrfr
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|dcp_dd_hasr
argument_list|)
expr_stmt|;
name|DUMP_SUBSTRUCT_ARRAY
argument_list|(
argument|i
argument_list|,
argument|QM_NUM_OF_DCP
argument_list|)
block|{
name|DUMP_VAR
argument_list|(
operator|&
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|dcpConfRegs
index|[
name|i
index|]
argument_list|,
name|cfg
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
operator|&
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|dcpConfRegs
index|[
name|i
index|]
argument_list|,
name|dd_cfg
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
operator|&
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|dcpConfRegs
index|[
name|i
index|]
argument_list|,
name|dlm_cfg
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
operator|&
name|p_Qm
operator|->
name|p_QmRegs
operator|->
name|dcpConfRegs
index|[
name|i
index|]
argument_list|,
name|dlm_avg
argument_list|)
expr_stmt|;
block|}
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|pfdr_fpc
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|pfdr_fp_head
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|pfdr_fp_tail
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|pfdr_fp_lwit
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|pfdr_cfg
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|sfdr_cfg
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|sfdr_in_use
argument_list|)
expr_stmt|;
name|DUMP_ARR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|wq_cs_cfg
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|wq_def_enq_wqid
argument_list|)
expr_stmt|;
name|DUMP_ARR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|wq_sc_dd_cfg
argument_list|)
expr_stmt|;
name|DUMP_ARR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|wq_pc_dd_cs_cfg
argument_list|)
expr_stmt|;
name|DUMP_ARR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|wq_dc0_dd_cs_cfg
argument_list|)
expr_stmt|;
name|DUMP_ARR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|wq_dc1_dd_cs_cfg
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|wq_dc2_dd_cs_cfg
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|wq_dc3_dd_cs_cfg
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|cm_cfg
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|ecsr
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|ecir
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|eadr
argument_list|)
expr_stmt|;
name|DUMP_ARR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|edata
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|sbet
argument_list|)
expr_stmt|;
name|DUMP_ARR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|sbec
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|mcr
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|mcp0
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|mcp1
argument_list|)
expr_stmt|;
name|DUMP_ARR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|mr
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|idle_stat
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|ip_rev_1
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|ip_rev_2
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|fqd_bare
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|fqd_bar
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|fqd_ar
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|pfdr_bare
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|pfdr_bar
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|pfdr_ar
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|qcsp_bare
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|qcsp_bar
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|ci_sched_cfg
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|srcidr
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|liodnr
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|ci_rlm_cfg
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|ci_rlm_avg
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|err_isr
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|err_ier
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|err_isdr
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|err_iir
argument_list|)
expr_stmt|;
name|DUMP_VAR
argument_list|(
name|p_Qm
operator|->
name|p_QmRegs
argument_list|,
name|err_her
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* (defined(DEBUG_ERRORS)&& ... */
end_comment

end_unit


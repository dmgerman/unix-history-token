begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/******************************************************************************   Â© 1995-2003, 2004, 2005-2011 Freescale Semiconductor, Inc.  All rights reserved.   This is proprietary source code of Freescale Semiconductor Inc.,  and its use is subject to the NetComm Device Drivers EULA.  The copyright notice above does not evidence any actual or intended  publication of such source code.   ALTERNATIVELY, redistribution and use in source and binary forms, with  or without modification, are permitted provided that the following  conditions are met:      * Redistributions of source code must retain the above copyright        notice, this list of conditions and the following disclaimer.      * Redistributions in binary form must reproduce the above copyright        notice, this list of conditions and the following disclaimer in the        documentation and/or other materials provided with the distribution.      * Neither the name of Freescale Semiconductor nor the        names of its contributors may be used to endorse or promote products        derived from this software without specific prior written permission.   THIS SOFTWARE IS PROVIDED BY Freescale Semiconductor ``AS IS'' AND ANY  EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE  DISCLAIMED. IN NO EVENT SHALL Freescale Semiconductor BE LIABLE FOR ANY  DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES  (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND  ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *   **************************************************************************/
end_comment

begin_comment
comment|/******************************************************************************  @File          bm.c   @Description   BM */
end_comment

begin_comment
comment|/***************************************************************************/
end_comment

begin_include
include|#
directive|include
file|"error_ext.h"
end_include

begin_include
include|#
directive|include
file|"std_ext.h"
end_include

begin_include
include|#
directive|include
file|"string_ext.h"
end_include

begin_include
include|#
directive|include
file|"mem_ext.h"
end_include

begin_include
include|#
directive|include
file|"core_ext.h"
end_include

begin_include
include|#
directive|include
file|"bm.h"
end_include

begin_define
define|#
directive|define
name|__ERR_MODULE__
value|MODULE_BM
end_define

begin_comment
comment|/****************************************/
end_comment

begin_comment
comment|/*       static functions               */
end_comment

begin_comment
comment|/****************************************/
end_comment

begin_comment
comment|/* (De)Registration of depletion notification callbacks */
end_comment

begin_function
specifier|static
name|void
name|depletion_link
parameter_list|(
name|t_BmPool
modifier|*
name|p_BmPool
parameter_list|)
block|{
name|t_BmPortal
modifier|*
name|p_Portal
init|=
operator|(
name|t_BmPortal
operator|*
operator|)
name|p_BmPool
operator|->
name|h_BmPortal
decl_stmt|;
name|NCSW_PLOCK
argument_list|(
name|p_Portal
argument_list|)
expr_stmt|;
name|p_Portal
operator|->
name|depletionPoolsTable
index|[
name|p_BmPool
operator|->
name|bpid
index|]
operator|=
name|p_BmPool
expr_stmt|;
name|bm_isr_bscn_mask
argument_list|(
name|p_Portal
operator|->
name|p_BmPortalLow
argument_list|,
operator|(
name|uint8_t
operator|)
name|p_BmPool
operator|->
name|bpid
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_Portal
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|depletion_unlink
parameter_list|(
name|t_BmPool
modifier|*
name|p_BmPool
parameter_list|)
block|{
name|t_BmPortal
modifier|*
name|p_Portal
init|=
operator|(
name|t_BmPortal
operator|*
operator|)
name|p_BmPool
operator|->
name|h_BmPortal
decl_stmt|;
name|NCSW_PLOCK
argument_list|(
name|p_Portal
argument_list|)
expr_stmt|;
name|p_Portal
operator|->
name|depletionPoolsTable
index|[
name|p_BmPool
operator|->
name|bpid
index|]
operator|=
name|NULL
expr_stmt|;
name|bm_isr_bscn_mask
argument_list|(
name|p_Portal
operator|->
name|p_BmPortalLow
argument_list|,
operator|(
name|uint8_t
operator|)
name|p_BmPool
operator|->
name|bpid
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PUNLOCK
argument_list|(
name|p_Portal
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|BmPoolRelease
parameter_list|(
name|t_BmPool
modifier|*
name|p_BmPool
parameter_list|,
name|t_Handle
name|h_BmPortal
parameter_list|,
name|struct
name|bm_buffer
modifier|*
name|bufs
parameter_list|,
name|uint8_t
name|num
parameter_list|,
name|uint32_t
name|flags
parameter_list|)
block|{
name|ASSERT_COND
argument_list|(
name|num
operator|&&
operator|(
name|num
operator|<=
literal|8
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_BmPool
operator|->
name|flags
operator|&
name|BMAN_POOL_FLAG_NO_RELEASE
condition|)
return|return
name|ERROR_CODE
argument_list|(
name|E_INVALID_VALUE
argument_list|)
return|;
comment|/* Without stockpile, this API is a pass-through to the h/w operation */
if|if
condition|(
operator|!
operator|(
name|p_BmPool
operator|->
name|flags
operator|&
name|BMAN_POOL_FLAG_STOCKPILE
operator|)
condition|)
return|return
name|BmPortalRelease
argument_list|(
name|h_BmPortal
argument_list|,
name|p_BmPool
operator|->
name|bpid
argument_list|,
name|bufs
argument_list|,
name|num
argument_list|,
name|flags
argument_list|)
return|;
comment|/* This needs some explanation. Adding the given buffers may take the      * stockpile over the threshold, but in fact the stockpile may already      * *be* over the threshold if a previous release-to-hw attempt had      * failed. So we have 3 cases to cover;      *   1. we add to the stockpile and don't hit the threshold,      *   2. we add to the stockpile, hit the threshold and release-to-hw,      *   3. we have to release-to-hw before adding to the stockpile      *      (not enough room in the stockpile for case 2).      * Our constraints on thresholds guarantee that in case 3, there must be      * at least 8 bufs already in the stockpile, so all release-to-hw ops      * are for 8 bufs. Despite all this, the API must indicate whether the      * given buffers were taken off the caller's hands, irrespective of      * whether a release-to-hw was attempted. */
while|while
condition|(
name|num
condition|)
block|{
comment|/* Add buffers to stockpile if they fit */
if|if
condition|(
operator|(
name|p_BmPool
operator|->
name|spFill
operator|+
name|num
operator|)
operator|<=
name|p_BmPool
operator|->
name|spMaxBufs
condition|)
block|{
name|memcpy
argument_list|(
name|PTR_MOVE
argument_list|(
name|p_BmPool
operator|->
name|sp
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|bm_buffer
argument_list|)
operator|*
operator|(
name|p_BmPool
operator|->
name|spFill
operator|)
argument_list|)
argument_list|,
name|bufs
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|bm_buffer
argument_list|)
operator|*
name|num
argument_list|)
expr_stmt|;
name|p_BmPool
operator|->
name|spFill
operator|+=
name|num
expr_stmt|;
name|num
operator|=
literal|0
expr_stmt|;
comment|/* --> will return success no matter what */
block|}
else|else
comment|/* Do hw op if hitting the high-water threshold */
block|{
name|t_Error
name|ret
init|=
name|BmPortalRelease
argument_list|(
name|h_BmPortal
argument_list|,
name|p_BmPool
operator|->
name|bpid
argument_list|,
operator|(
expr|struct
name|bm_buffer
operator|*
operator|)
name|PTR_MOVE
argument_list|(
name|p_BmPool
operator|->
name|sp
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|bm_buffer
argument_list|)
operator|*
operator|(
name|p_BmPool
operator|->
name|spFill
operator|-
name|p_BmPool
operator|->
name|spBufsCmd
operator|)
argument_list|)
argument_list|,
name|p_BmPool
operator|->
name|spBufsCmd
argument_list|,
name|flags
argument_list|)
decl_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
operator|(
name|num
condition|?
name|ret
else|:
name|E_OK
operator|)
return|;
name|p_BmPool
operator|->
name|spFill
operator|-=
name|p_BmPool
operator|->
name|spBufsCmd
expr_stmt|;
block|}
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|BmPoolAcquire
parameter_list|(
name|t_BmPool
modifier|*
name|p_BmPool
parameter_list|,
name|t_Handle
name|h_BmPortal
parameter_list|,
name|struct
name|bm_buffer
modifier|*
name|bufs
parameter_list|,
name|uint8_t
name|num
parameter_list|,
name|uint32_t
name|flags
parameter_list|)
block|{
name|ASSERT_COND
argument_list|(
name|IN_RANGE
argument_list|(
literal|1
argument_list|,
name|num
argument_list|,
literal|8
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_BmPool
operator|->
name|flags
operator|&
name|BMAN_POOL_FLAG_ONLY_RELEASE
condition|)
return|return
literal|0
return|;
comment|/* Without stockpile, this API is a pass-through to the h/w operation */
if|if
condition|(
operator|!
operator|(
name|p_BmPool
operator|->
name|flags
operator|&
name|BMAN_POOL_FLAG_STOCKPILE
operator|)
condition|)
return|return
name|BmPortalAcquire
argument_list|(
name|h_BmPortal
argument_list|,
name|p_BmPool
operator|->
name|bpid
argument_list|,
name|bufs
argument_list|,
name|num
argument_list|)
return|;
comment|/* Only need a h/w op if we'll hit the low-water thresh */
if|if
condition|(
operator|!
operator|(
name|flags
operator|&
name|BMAN_ACQUIRE_FLAG_STOCKPILE
operator|)
operator|&&
operator|(
operator|(
name|p_BmPool
operator|->
name|spFill
operator|-
name|num
operator|)
operator|<
name|p_BmPool
operator|->
name|spMinBufs
operator|)
condition|)
block|{
name|p_BmPool
operator|->
name|spFill
operator|+=
name|BmPortalAcquire
argument_list|(
name|h_BmPortal
argument_list|,
name|p_BmPool
operator|->
name|bpid
argument_list|,
operator|(
expr|struct
name|bm_buffer
operator|*
operator|)
name|PTR_MOVE
argument_list|(
name|p_BmPool
operator|->
name|sp
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|bm_buffer
argument_list|)
operator|*
operator|(
name|p_BmPool
operator|->
name|spFill
operator|)
argument_list|)
argument_list|,
name|p_BmPool
operator|->
name|spBufsCmd
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p_BmPool
operator|->
name|spFill
operator|<
name|num
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|p_BmPool
operator|->
name|spFill
condition|)
return|return
literal|0
return|;
name|memcpy
argument_list|(
name|bufs
argument_list|,
name|PTR_MOVE
argument_list|(
name|p_BmPool
operator|->
name|sp
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|bm_buffer
argument_list|)
operator|*
operator|(
name|p_BmPool
operator|->
name|spFill
operator|-
name|num
operator|)
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|bm_buffer
argument_list|)
operator|*
name|num
argument_list|)
expr_stmt|;
name|p_BmPool
operator|->
name|spFill
operator|-=
name|num
expr_stmt|;
return|return
name|num
return|;
block|}
end_function

begin_function
specifier|static
name|t_Error
name|BmPoolFree
parameter_list|(
name|t_BmPool
modifier|*
name|p_BmPool
parameter_list|,
name|bool
name|discardBuffers
parameter_list|)
block|{
name|t_Handle
name|h_BufContext
decl_stmt|;
name|void
modifier|*
name|p_Data
decl_stmt|;
name|ASSERT_COND
argument_list|(
name|p_BmPool
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_BmPool
operator|->
name|shadowMode
condition|)
block|{
if|if
condition|(
name|p_BmPool
operator|->
name|flags
operator|&
name|BMAN_POOL_FLAG_DEPLETION
condition|)
block|{
name|depletion_unlink
argument_list|(
name|p_BmPool
argument_list|)
expr_stmt|;
name|BmUnSetPoolThresholds
argument_list|(
name|p_BmPool
operator|->
name|h_Bm
argument_list|,
name|p_BmPool
operator|->
name|bpid
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|TRUE
condition|)
block|{
name|p_Data
operator|=
name|BM_POOL_GetBuf
argument_list|(
name|p_BmPool
argument_list|,
name|p_BmPool
operator|->
name|h_BmPortal
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Data
condition|)
break|break;
name|h_BufContext
operator|=
name|BM_POOL_GetBufferContext
argument_list|(
name|p_BmPool
argument_list|,
name|p_Data
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|discardBuffers
condition|)
name|p_BmPool
operator|->
name|bufferPoolInfo
operator|.
name|f_PutBuf
argument_list|(
name|p_BmPool
operator|->
name|bufferPoolInfo
operator|.
name|h_BufferPool
argument_list|,
name|p_Data
argument_list|,
name|h_BufContext
argument_list|)
expr_stmt|;
block|}
name|BmBpidPut
argument_list|(
name|p_BmPool
operator|->
name|h_Bm
argument_list|,
name|p_BmPool
operator|->
name|bpid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p_BmPool
operator|->
name|sp
condition|)
name|XX_Free
argument_list|(
name|p_BmPool
operator|->
name|sp
argument_list|)
expr_stmt|;
name|XX_Free
argument_list|(
name|p_BmPool
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_comment
comment|/****************************************/
end_comment

begin_comment
comment|/*       API Init unit functions        */
end_comment

begin_comment
comment|/****************************************/
end_comment

begin_function
name|t_Handle
name|BM_POOL_Config
parameter_list|(
name|t_BmPoolParam
modifier|*
name|p_BmPoolParam
parameter_list|)
block|{
name|t_BmPool
modifier|*
name|p_BmPool
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_BmPoolParam
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_BmPoolParam
operator|->
name|h_Bm
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
operator|(
name|p_BmPoolParam
operator|->
name|shadowMode
operator|||
operator|(
name|p_BmPoolParam
operator|->
name|bufferPoolInfo
operator|.
name|h_BufferPool
operator|&&
name|p_BmPoolParam
operator|->
name|bufferPoolInfo
operator|.
name|f_GetBuf
operator|&&
name|p_BmPoolParam
operator|->
name|bufferPoolInfo
operator|.
name|f_PutBuf
operator|&&
name|p_BmPoolParam
operator|->
name|bufferPoolInfo
operator|.
name|bufferSize
operator|)
operator|)
argument_list|,
name|E_INVALID_STATE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|p_BmPool
operator|=
operator|(
name|t_BmPool
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|t_BmPool
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_BmPool
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"BM Pool obj!!!"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_BmPool
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_BmPool
argument_list|)
argument_list|)
expr_stmt|;
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
operator|=
operator|(
name|t_BmPoolDriverParams
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|t_BmPoolDriverParams
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
condition|)
block|{
name|XX_Free
argument_list|(
name|p_BmPool
argument_list|)
expr_stmt|;
name|REPORT_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"Bm Pool driver parameters"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|t_BmPoolDriverParams
argument_list|)
argument_list|)
expr_stmt|;
name|p_BmPool
operator|->
name|h_Bm
operator|=
name|p_BmPoolParam
operator|->
name|h_Bm
expr_stmt|;
name|p_BmPool
operator|->
name|h_BmPortal
operator|=
name|p_BmPoolParam
operator|->
name|h_BmPortal
expr_stmt|;
name|p_BmPool
operator|->
name|h_App
operator|=
name|p_BmPoolParam
operator|->
name|h_App
expr_stmt|;
name|p_BmPool
operator|->
name|numOfBuffers
operator|=
name|p_BmPoolParam
operator|->
name|numOfBuffers
expr_stmt|;
name|p_BmPool
operator|->
name|shadowMode
operator|=
name|p_BmPoolParam
operator|->
name|shadowMode
expr_stmt|;
if|if
condition|(
operator|!
name|p_BmPool
operator|->
name|h_BmPortal
condition|)
block|{
name|p_BmPool
operator|->
name|h_BmPortal
operator|=
name|BmGetPortalHandle
argument_list|(
name|p_BmPool
operator|->
name|h_Bm
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_BmPool
operator|->
name|h_BmPortal
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
operator|&
name|p_BmPool
operator|->
name|bufferPoolInfo
argument_list|,
operator|&
name|p_BmPoolParam
operator|->
name|bufferPoolInfo
argument_list|,
sizeof|sizeof
argument_list|(
name|t_BufferPoolInfo
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_BmPool
operator|->
name|bufferPoolInfo
operator|.
name|f_PhysToVirt
condition|)
name|p_BmPool
operator|->
name|bufferPoolInfo
operator|.
name|f_PhysToVirt
operator|=
name|XX_PhysToVirt
expr_stmt|;
if|if
condition|(
operator|!
name|p_BmPool
operator|->
name|bufferPoolInfo
operator|.
name|f_VirtToPhys
condition|)
name|p_BmPool
operator|->
name|bufferPoolInfo
operator|.
name|f_VirtToPhys
operator|=
name|XX_VirtToPhys
expr_stmt|;
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
operator|->
name|dynamicBpid
operator|=
name|DEFAULT_dynamicBpid
expr_stmt|;
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
operator|->
name|useDepletion
operator|=
name|DEFAULT_useDepletion
expr_stmt|;
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
operator|->
name|useStockpile
operator|=
name|DEFAULT_useStockpile
expr_stmt|;
if|if
condition|(
name|p_BmPool
operator|->
name|shadowMode
condition|)
block|{
name|p_BmPool
operator|->
name|numOfBuffers
operator|=
literal|0
expr_stmt|;
name|BM_POOL_ConfigBpid
argument_list|(
name|p_BmPool
argument_list|,
name|p_BmPoolParam
operator|->
name|bpid
argument_list|)
expr_stmt|;
block|}
return|return
name|p_BmPool
return|;
block|}
end_function

begin_function
name|t_Error
name|BM_POOL_Init
parameter_list|(
name|t_Handle
name|h_BmPool
parameter_list|)
block|{
name|t_BmPool
modifier|*
name|p_BmPool
init|=
operator|(
name|t_BmPool
operator|*
operator|)
name|h_BmPool
decl_stmt|;
name|t_Error
name|err
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_BmPool
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_BmPool
operator|->
name|flags
operator||=
operator|(
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
operator|->
name|dynamicBpid
operator|)
condition|?
name|BMAN_POOL_FLAG_DYNAMIC_BPID
else|:
literal|0
expr_stmt|;
name|p_BmPool
operator|->
name|flags
operator||=
operator|(
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
operator|->
name|useStockpile
operator|)
condition|?
name|BMAN_POOL_FLAG_STOCKPILE
else|:
literal|0
expr_stmt|;
name|p_BmPool
operator|->
name|flags
operator||=
operator|(
operator|(
operator|!
name|p_BmPool
operator|->
name|shadowMode
operator|)
operator|&&
operator|(
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
operator|->
name|useDepletion
operator|)
operator|)
condition|?
name|BMAN_POOL_FLAG_DEPLETION
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|p_BmPool
operator|->
name|flags
operator|&
name|BMAN_POOL_FLAG_DYNAMIC_BPID
condition|)
block|{
if|if
condition|(
operator|(
name|p_BmPool
operator|->
name|bpid
operator|=
operator|(
name|uint8_t
operator|)
name|BmBpidGet
argument_list|(
name|p_BmPool
operator|->
name|h_Bm
argument_list|,
name|FALSE
argument_list|,
operator|(
name|uint32_t
operator|)
literal|0
argument_list|)
operator|)
operator|==
operator|(
name|uint8_t
operator|)
name|ILLEGAL_BASE
condition|)
block|{
name|BM_POOL_Free
argument_list|(
name|p_BmPool
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|CRITICAL
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"can't allocate new dynamic pool id"
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|BmBpidGet
argument_list|(
name|p_BmPool
operator|->
name|h_Bm
argument_list|,
name|TRUE
argument_list|,
operator|(
name|uint32_t
operator|)
name|p_BmPool
operator|->
name|bpid
argument_list|)
operator|==
operator|(
name|uint32_t
operator|)
name|ILLEGAL_BASE
condition|)
block|{
name|BM_POOL_Free
argument_list|(
name|p_BmPool
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|CRITICAL
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"can't force pool id %d"
operator|,
name|p_BmPool
operator|->
name|bpid
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|p_BmPool
operator|->
name|flags
operator|&
name|BMAN_POOL_FLAG_DEPLETION
condition|)
block|{
if|if
condition|(
name|BmSetPoolThresholds
argument_list|(
name|p_BmPool
operator|->
name|h_Bm
argument_list|,
name|p_BmPool
operator|->
name|bpid
argument_list|,
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
operator|->
name|depletionThresholds
argument_list|)
condition|)
block|{
name|BM_POOL_Free
argument_list|(
name|p_BmPool
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"can't set thresh for pool bpid %d"
operator|,
name|p_BmPool
operator|->
name|bpid
operator|)
argument_list|)
expr_stmt|;
block|}
name|depletion_link
argument_list|(
name|p_BmPool
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p_BmPool
operator|->
name|flags
operator|&
name|BMAN_POOL_FLAG_STOCKPILE
condition|)
block|{
name|p_BmPool
operator|->
name|sp
operator|=
operator|(
expr|struct
name|bm_buffer
operator|*
operator|)
name|XX_Malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|bm_buffer
argument_list|)
operator|*
name|p_BmPool
operator|->
name|spMaxBufs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_BmPool
operator|->
name|sp
condition|)
block|{
name|BM_POOL_Free
argument_list|(
name|p_BmPool
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_NO_MEMORY
argument_list|,
operator|(
literal|"Bm Pool Stockpile"
operator|)
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
name|p_BmPool
operator|->
name|sp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|bm_buffer
argument_list|)
operator|*
name|p_BmPool
operator|->
name|spMaxBufs
argument_list|)
expr_stmt|;
block|}
name|XX_Free
argument_list|(
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
argument_list|)
expr_stmt|;
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
operator|=
name|NULL
expr_stmt|;
comment|/*******************/
comment|/* Create buffers  */
comment|/*******************/
if|if
condition|(
operator|(
name|err
operator|=
name|BM_POOL_FillBufs
argument_list|(
name|p_BmPool
argument_list|,
name|p_BmPool
operator|->
name|h_BmPortal
argument_list|,
name|p_BmPool
operator|->
name|numOfBuffers
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
block|{
name|BM_POOL_Free
argument_list|(
name|p_BmPool
argument_list|)
expr_stmt|;
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|err
argument_list|,
name|NO_MSG
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|BM_POOL_Free
parameter_list|(
name|t_Handle
name|h_BmPool
parameter_list|)
block|{
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|h_BmPool
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
return|return
name|BmPoolFree
argument_list|(
name|h_BmPool
argument_list|,
name|FALSE
argument_list|)
return|;
block|}
end_function

begin_function
name|t_Error
name|BM_POOL_ConfigBpid
parameter_list|(
name|t_Handle
name|h_BmPool
parameter_list|,
name|uint8_t
name|bpid
parameter_list|)
block|{
name|t_BmPool
modifier|*
name|p_BmPool
init|=
operator|(
name|t_BmPool
operator|*
operator|)
name|h_BmPool
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_BmPool
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|bpid
operator|<
name|BM_MAX_NUM_OF_POOLS
argument_list|,
name|E_INVALID_VALUE
argument_list|)
expr_stmt|;
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
operator|->
name|dynamicBpid
operator|=
name|FALSE
expr_stmt|;
name|p_BmPool
operator|->
name|bpid
operator|=
name|bpid
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|BM_POOL_ConfigDepletion
parameter_list|(
name|t_Handle
name|h_BmPool
parameter_list|,
name|t_BmDepletionCallback
modifier|*
name|f_Depletion
parameter_list|,
name|uint32_t
modifier|*
name|p_Thresholds
parameter_list|)
block|{
name|t_BmPool
modifier|*
name|p_BmPool
init|=
operator|(
name|t_BmPool
operator|*
operator|)
name|h_BmPool
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_BmPool
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|f_Depletion
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
operator|->
name|useDepletion
operator|=
name|TRUE
expr_stmt|;
name|p_BmPool
operator|->
name|f_Depletion
operator|=
name|f_Depletion
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
operator|->
name|depletionThresholds
argument_list|,
name|p_Thresholds
argument_list|,
sizeof|sizeof
argument_list|(
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
operator|->
name|depletionThresholds
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|BM_POOL_ConfigStockpile
parameter_list|(
name|t_Handle
name|h_BmPool
parameter_list|,
name|uint16_t
name|maxBuffers
parameter_list|,
name|uint16_t
name|minBuffers
parameter_list|)
block|{
name|t_BmPool
modifier|*
name|p_BmPool
init|=
operator|(
name|t_BmPool
operator|*
operator|)
name|h_BmPool
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_BmPool
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|maxBuffers
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|maxBuffers
operator|>=
name|minBuffers
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_BmPool
operator|->
name|shadowMode
operator|||
operator|(
operator|(
name|maxBuffers
operator|*
literal|2
operator|)
operator|<=
name|p_BmPool
operator|->
name|numOfBuffers
operator|)
operator|)
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
operator|->
name|useStockpile
operator|=
name|TRUE
expr_stmt|;
name|p_BmPool
operator|->
name|spMaxBufs
operator|=
name|maxBuffers
expr_stmt|;
name|p_BmPool
operator|->
name|spMinBufs
operator|=
name|minBuffers
expr_stmt|;
name|p_BmPool
operator|->
name|spBufsCmd
operator|=
name|DEFAULT_numOfBufsPerCmd
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|(
name|p_BmPool
operator|->
name|spMaxBufs
operator|>=
operator|(
name|p_BmPool
operator|->
name|spMinBufs
operator|+
name|p_BmPool
operator|->
name|spBufsCmd
operator|)
operator|)
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|t_Error
name|BM_POOL_ConfigBuffContextMode
parameter_list|(
name|t_Handle
name|h_BmPool
parameter_list|,
name|bool
name|en
parameter_list|)
block|{
name|t_BmPool
modifier|*
name|p_BmPool
init|=
operator|(
name|t_BmPool
operator|*
operator|)
name|h_BmPool
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_BmPool
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|p_BmPool
operator|->
name|noBuffCtxt
operator|=
operator|!
name|en
expr_stmt|;
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|BM_POOL_GetBuf
parameter_list|(
name|t_Handle
name|h_BmPool
parameter_list|,
name|t_Handle
name|h_BmPortal
parameter_list|)
block|{
name|t_BmPool
modifier|*
name|p_BmPool
init|=
operator|(
name|t_BmPool
operator|*
operator|)
name|h_BmPool
decl_stmt|;
name|struct
name|bm_buffer
name|bufs
index|[
literal|1
index|]
decl_stmt|;
name|uint8_t
name|retBufsNum
decl_stmt|;
name|uint64_t
name|physAddr
decl_stmt|;
name|uint32_t
name|flags
init|=
literal|0
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_BmPool
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
operator|!
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_BmPool
operator|->
name|bufferPoolInfo
operator|.
name|f_PhysToVirt
argument_list|,
name|E_INVALID_STATE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|h_BmPortal
condition|)
block|{
if|if
condition|(
name|p_BmPool
operator|->
name|h_BmPortal
condition|)
name|h_BmPortal
operator|=
name|p_BmPool
operator|->
name|h_BmPortal
expr_stmt|;
else|else
block|{
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_BmPool
operator|->
name|h_Bm
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|h_BmPortal
operator|=
name|BmGetPortalHandle
argument_list|(
name|p_BmPool
operator|->
name|h_Bm
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|h_BmPortal
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
name|retBufsNum
operator|=
operator|(
name|uint8_t
operator|)
name|BmPoolAcquire
argument_list|(
name|p_BmPool
argument_list|,
name|h_BmPortal
argument_list|,
name|bufs
argument_list|,
literal|1
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|retBufsNum
condition|)
block|{
name|REPORT_ERROR
argument_list|(
name|TRACE
argument_list|,
name|E_NOT_AVAILABLE
argument_list|,
operator|(
literal|"buffer"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|physAddr
operator|=
operator|(
name|uint64_t
operator|)
name|bufs
index|[
literal|0
index|]
operator|.
name|lo
expr_stmt|;
name|physAddr
operator||=
call|(
name|uint64_t
call|)
argument_list|(
operator|(
operator|(
name|uint64_t
operator|)
name|bufs
index|[
literal|0
index|]
operator|.
name|hi
operator|<<
literal|32
operator|)
operator|&
literal|0x000000ff00000000LL
argument_list|)
expr_stmt|;
name|DBG
argument_list|(
name|TRACE
argument_list|,
operator|(
literal|"Get Buffer : poolId %d, address 0x%016llx"
operator|,
name|p_BmPool
operator|->
name|bpid
operator|,
name|p_BmPool
operator|->
name|bufferPoolInfo
operator|.
name|f_PhysToVirt
argument_list|(
operator|(
name|physAddress_t
operator|)
name|physAddr
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|p_BmPool
operator|->
name|bufferPoolInfo
operator|.
name|f_PhysToVirt
argument_list|(
operator|(
name|physAddress_t
operator|)
name|physAddr
argument_list|)
return|;
block|}
end_function

begin_function
name|t_Error
name|BM_POOL_PutBuf
parameter_list|(
name|t_Handle
name|h_BmPool
parameter_list|,
name|t_Handle
name|h_BmPortal
parameter_list|,
name|void
modifier|*
name|p_Buff
parameter_list|)
block|{
name|t_BmPool
modifier|*
name|p_BmPool
init|=
operator|(
name|t_BmPool
operator|*
operator|)
name|h_BmPool
decl_stmt|;
name|uint64_t
name|physAddress
decl_stmt|;
name|struct
name|bm_buffer
name|bufs
index|[
literal|1
index|]
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_BmPool
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_Buff
argument_list|,
name|E_NULL_POINTER
argument_list|)
expr_stmt|;
name|physAddress
operator|=
call|(
name|uint64_t
call|)
argument_list|(
name|XX_VirtToPhys
argument_list|(
name|p_Buff
argument_list|)
argument_list|)
expr_stmt|;
name|bufs
index|[
literal|0
index|]
operator|.
name|bpid
operator|=
name|p_BmPool
operator|->
name|bpid
expr_stmt|;
name|bufs
index|[
literal|0
index|]
operator|.
name|hi
operator|=
call|(
name|uint8_t
call|)
argument_list|(
operator|(
name|physAddress
operator|&
literal|0x000000ff00000000LL
operator|)
operator|>>
literal|32
argument_list|)
expr_stmt|;
name|bufs
index|[
literal|0
index|]
operator|.
name|lo
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|physAddress
operator|&
literal|0xffffffff
argument_list|)
expr_stmt|;
name|DBG
argument_list|(
name|TRACE
argument_list|,
operator|(
literal|"Put Buffer : poolId %d, address 0x%016llx, phys 0x%016llx"
operator|,
name|p_BmPool
operator|->
name|bpid
operator|,
operator|(
name|uint64_t
operator|)
name|PTR_TO_UINT
argument_list|(
name|p_Buff
argument_list|)
operator|,
name|physAddress
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|h_BmPortal
condition|)
block|{
if|if
condition|(
name|p_BmPool
operator|->
name|h_BmPortal
condition|)
name|h_BmPortal
operator|=
name|p_BmPool
operator|->
name|h_BmPortal
expr_stmt|;
else|else
block|{
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_BmPool
operator|->
name|h_Bm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|h_BmPortal
operator|=
name|BmGetPortalHandle
argument_list|(
name|p_BmPool
operator|->
name|h_Bm
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|h_BmPortal
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|BmPoolRelease
argument_list|(
name|p_BmPool
argument_list|,
name|h_BmPortal
argument_list|,
name|bufs
argument_list|,
literal|1
argument_list|,
name|BMAN_RELEASE_FLAG_WAIT
argument_list|)
return|;
block|}
end_function

begin_function
name|t_Error
name|BM_POOL_FillBufs
parameter_list|(
name|t_Handle
name|h_BmPool
parameter_list|,
name|t_Handle
name|h_BmPortal
parameter_list|,
name|uint32_t
name|numBufs
parameter_list|)
block|{
name|t_BmPool
modifier|*
name|p_BmPool
init|=
operator|(
name|t_BmPool
operator|*
operator|)
name|h_BmPool
decl_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_BmPool
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
operator|!
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
argument_list|,
name|E_INVALID_STATE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|h_BmPortal
condition|)
block|{
if|if
condition|(
name|p_BmPool
operator|->
name|h_BmPortal
condition|)
name|h_BmPortal
operator|=
name|p_BmPool
operator|->
name|h_BmPortal
expr_stmt|;
else|else
block|{
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|p_BmPool
operator|->
name|h_Bm
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
name|h_BmPortal
operator|=
name|BmGetPortalHandle
argument_list|(
name|p_BmPool
operator|->
name|h_Bm
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_ERROR
argument_list|(
name|h_BmPortal
argument_list|,
name|E_INVALID_HANDLE
argument_list|)
expr_stmt|;
block|}
block|}
while|while
condition|(
name|numBufs
operator|--
condition|)
block|{
name|uint8_t
modifier|*
name|p_Data
decl_stmt|;
name|t_Error
name|res
decl_stmt|;
name|t_Handle
name|h_BufContext
decl_stmt|;
name|p_Data
operator|=
name|p_BmPool
operator|->
name|bufferPoolInfo
operator|.
name|f_GetBuf
argument_list|(
name|p_BmPool
operator|->
name|bufferPoolInfo
operator|.
name|h_BufferPool
argument_list|,
operator|&
name|h_BufContext
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_Data
condition|)
name|RETURN_ERROR
argument_list|(
name|MAJOR
argument_list|,
name|E_INVALID_STATE
argument_list|,
operator|(
literal|"run-out of buffers for bpid %d"
operator|,
name|p_BmPool
operator|->
name|bpid
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_BmPool
operator|->
name|noBuffCtxt
condition|)
operator|*
operator|(
name|t_Handle
operator|*
operator|)
operator|(
name|p_Data
operator|-
sizeof|sizeof
argument_list|(
name|t_Handle
argument_list|)
operator|)
operator|=
name|h_BufContext
expr_stmt|;
if|if
condition|(
operator|(
name|res
operator|=
name|BM_POOL_PutBuf
argument_list|(
name|p_BmPool
argument_list|,
name|h_BmPortal
argument_list|,
name|p_Data
argument_list|)
operator|)
operator|!=
name|E_OK
condition|)
name|RETURN_ERROR
argument_list|(
name|CRITICAL
argument_list|,
name|res
argument_list|,
operator|(
literal|"Seeding reserved buffer pool failed"
operator|)
argument_list|)
expr_stmt|;
block|}
return|return
name|E_OK
return|;
block|}
end_function

begin_function
name|uint8_t
name|BM_POOL_GetId
parameter_list|(
name|t_Handle
name|h_BmPool
parameter_list|)
block|{
name|t_BmPool
modifier|*
name|p_BmPool
init|=
operator|(
name|t_BmPool
operator|*
operator|)
name|h_BmPool
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_BmPool
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
operator|!
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|p_BmPool
operator|->
name|bpid
return|;
block|}
end_function

begin_function
name|uint16_t
name|BM_POOL_GetBufferSize
parameter_list|(
name|t_Handle
name|h_BmPool
parameter_list|)
block|{
name|t_BmPool
modifier|*
name|p_BmPool
init|=
operator|(
name|t_BmPool
operator|*
operator|)
name|h_BmPool
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_BmPool
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
operator|!
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|p_BmPool
operator|->
name|bufferPoolInfo
operator|.
name|bufferSize
return|;
block|}
end_function

begin_function
name|t_Handle
name|BM_POOL_GetBufferContext
parameter_list|(
name|t_Handle
name|h_BmPool
parameter_list|,
name|void
modifier|*
name|p_Buff
parameter_list|)
block|{
name|t_BmPool
modifier|*
name|p_BmPool
init|=
operator|(
name|t_BmPool
operator|*
operator|)
name|h_BmPool
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_BmPool
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
operator|!
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_Buff
argument_list|,
name|E_NULL_POINTER
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|p_BmPool
operator|->
name|noBuffCtxt
condition|)
return|return
name|NULL
return|;
return|return
operator|*
operator|(
name|t_Handle
operator|*
operator|)
name|PTR_MOVE
argument_list|(
name|p_Buff
argument_list|,
operator|-
operator|(
sizeof|sizeof
argument_list|(
name|t_Handle
argument_list|)
operator|)
argument_list|)
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|BM_POOL_PhysToVirt
parameter_list|(
name|t_Handle
name|h_BmPool
parameter_list|,
name|physAddress_t
name|addr
parameter_list|)
block|{
name|t_BmPool
modifier|*
name|p_BmPool
init|=
operator|(
name|t_BmPool
operator|*
operator|)
name|h_BmPool
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_BmPool
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
operator|!
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|p_BmPool
operator|->
name|bufferPoolInfo
operator|.
name|f_PhysToVirt
argument_list|(
name|addr
argument_list|)
return|;
block|}
end_function

begin_function
name|physAddress_t
name|BM_POOL_VirtToPhys
parameter_list|(
name|t_Handle
name|h_BmPool
parameter_list|,
name|void
modifier|*
name|p_Buff
parameter_list|)
block|{
name|t_BmPool
modifier|*
name|p_BmPool
init|=
operator|(
name|t_BmPool
operator|*
operator|)
name|h_BmPool
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_BmPool
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
operator|(
name|physAddress_t
operator|)
literal|0
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
operator|!
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
operator|(
name|physAddress_t
operator|)
literal|0
argument_list|)
expr_stmt|;
return|return
name|p_BmPool
operator|->
name|bufferPoolInfo
operator|.
name|f_VirtToPhys
argument_list|(
name|p_Buff
argument_list|)
return|;
block|}
end_function

begin_function
name|uint32_t
name|BM_POOL_GetCounter
parameter_list|(
name|t_Handle
name|h_BmPool
parameter_list|,
name|e_BmPoolCounters
name|counter
parameter_list|)
block|{
name|t_BmPool
modifier|*
name|p_BmPool
init|=
operator|(
name|t_BmPool
operator|*
operator|)
name|h_BmPool
decl_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
name|p_BmPool
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SANITY_CHECK_RETURN_VALUE
argument_list|(
operator|!
name|p_BmPool
operator|->
name|p_BmPoolDriverParams
argument_list|,
name|E_INVALID_HANDLE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|counter
condition|)
block|{
case|case
operator|(
name|e_BM_POOL_COUNTERS_CONTENT
operator|)
case|:
return|return
name|BmGetCounter
argument_list|(
name|p_BmPool
operator|->
name|h_Bm
argument_list|,
name|e_BM_IM_COUNTERS_POOL_CONTENT
argument_list|,
name|p_BmPool
operator|->
name|bpid
argument_list|)
return|;
case|case
operator|(
name|e_BM_POOL_COUNTERS_SW_DEPLETION
operator|)
case|:
return|return
operator|(
name|p_BmPool
operator|->
name|swDepletionCount
operator|+=
name|BmGetCounter
argument_list|(
name|p_BmPool
operator|->
name|h_Bm
argument_list|,
name|e_BM_IM_COUNTERS_POOL_SW_DEPLETION
argument_list|,
name|p_BmPool
operator|->
name|bpid
argument_list|)
operator|)
return|;
case|case
operator|(
name|e_BM_POOL_COUNTERS_HW_DEPLETION
operator|)
case|:
return|return
operator|(
name|p_BmPool
operator|->
name|hwDepletionCount
operator|+=
name|BmGetCounter
argument_list|(
name|p_BmPool
operator|->
name|h_Bm
argument_list|,
name|e_BM_IM_COUNTERS_POOL_HW_DEPLETION
argument_list|,
name|p_BmPool
operator|->
name|bpid
argument_list|)
operator|)
return|;
default|default:
break|break;
block|}
comment|/* should never get here */
name|ASSERT_COND
argument_list|(
name|FALSE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


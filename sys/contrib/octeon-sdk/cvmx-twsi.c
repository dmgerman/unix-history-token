begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/***********************license start***************  * Copyright (c) 2003-2010  Cavium Inc. (support@cavium.com). All rights  * reserved.  *  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are  * met:  *  *   * Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *  *   * Redistributions in binary form must reproduce the above  *     copyright notice, this list of conditions and the following  *     disclaimer in the documentation and/or other materials provided  *     with the distribution.   *   * Neither the name of Cavium Inc. nor the names of  *     its contributors may be used to endorse or promote products  *     derived from this software without specific prior written  *     permission.   * This Software, including technical data, may be subject to U.S. export  control  * laws, including the U.S. Export Administration Act and its  associated  * regulations, and may be subject to export or import  regulations in other  * countries.   * TO THE MAXIMUM EXTENT PERMITTED BY LAW, THE SOFTWARE IS PROVIDED "AS IS"  * AND WITH ALL FAULTS AND CAVIUM INC. MAKES NO PROMISES, REPRESENTATIONS OR  * WARRANTIES, EITHER EXPRESS, IMPLIED, STATUTORY, OR OTHERWISE, WITH RESPECT TO  * THE SOFTWARE, INCLUDING ITS CONDITION, ITS CONFORMITY TO ANY REPRESENTATION OR  * DESCRIPTION, OR THE EXISTENCE OF ANY LATENT OR PATENT DEFECTS, AND CAVIUM  * SPECIFICALLY DISCLAIMS ALL IMPLIED (IF ANY) WARRANTIES OF TITLE,  * MERCHANTABILITY, NONINFRINGEMENT, FITNESS FOR A PARTICULAR PURPOSE, LACK OF  * VIRUSES, ACCURACY OR COMPLETENESS, QUIET ENJOYMENT, QUIET POSSESSION OR  * CORRESPONDENCE TO DESCRIPTION. THE ENTIRE  RISK ARISING OUT OF USE OR  * PERFORMANCE OF THE SOFTWARE LIES WITH YOU.  ***********************license end**************************************/
end_comment

begin_comment
comment|/**  * @file  *  * Interface to the TWSI / I2C bus  *  *<hr>$Revision: 70030 $<hr>  *  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CVMX_BUILD_FOR_LINUX_KERNEL
end_ifdef

begin_include
include|#
directive|include
file|<linux/i2c.h>
end_include

begin_include
include|#
directive|include
file|<asm/octeon/cvmx.h>
end_include

begin_include
include|#
directive|include
file|<asm/octeon/cvmx-twsi.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|"cvmx.h"
end_include

begin_include
include|#
directive|include
file|"cvmx-twsi.h"
end_include

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|CVMX_BUILD_FOR_FREEBSD_KERNEL
argument_list|)
end_if

begin_include
include|#
directive|include
file|"cvmx-csr-db.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|//#define PRINT_TWSI_CONFIG
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|PRINT_TWSI_CONFIG
end_ifdef

begin_define
define|#
directive|define
name|twsi_printf
value|printf
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|twsi_printf
parameter_list|(
modifier|...
parameter_list|)
end_define

begin_define
define|#
directive|define
name|cvmx_csr_db_decode
parameter_list|(
modifier|...
parameter_list|)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|CVMX_BUILD_FOR_LINUX_KERNEL
end_ifdef

begin_if
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_I2C
argument_list|)
operator|||
name|defined
argument_list|(
name|CONFIG_I2C_MODULE
argument_list|)
end_if

begin_function
specifier|static
name|struct
name|i2c_adapter
modifier|*
name|__cvmx_twsix_get_adapter
parameter_list|(
name|int
name|twsi_id
parameter_list|)
block|{
struct|struct
name|octeon_i2c
block|{
name|wait_queue_head_t
name|queue
decl_stmt|;
name|struct
name|i2c_adapter
name|adap
decl_stmt|;
name|int
name|irq
decl_stmt|;
name|int
name|twsi_freq
decl_stmt|;
name|int
name|sys_freq
decl_stmt|;
name|resource_size_t
name|twsi_phys
decl_stmt|;
name|void
name|__iomem
modifier|*
name|twsi_base
decl_stmt|;
name|resource_size_t
name|regsize
decl_stmt|;
name|device_t
name|dev
decl_stmt|;
name|int
name|broken_irq_mode
decl_stmt|;
block|}
struct|;
name|struct
name|i2c_adapter
modifier|*
name|adapter
decl_stmt|;
name|struct
name|octeon_i2c
modifier|*
name|i2c
decl_stmt|;
name|adapter
operator|=
name|i2c_get_adapter
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|adapter
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|i2c
operator|=
name|container_of
argument_list|(
name|adapter
argument_list|,
expr|struct
name|octeon_i2c
argument_list|,
name|adap
argument_list|)
expr_stmt|;
return|return
operator|&
name|i2c
index|[
name|twsi_id
index|]
operator|.
name|adap
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/**  * Do a twsi read from a 7 bit device address using an (optional) internal address.  * Up to 8 bytes can be read at a time.  *  * @param twsi_id   which Octeon TWSI bus to use  * @param dev_addr  Device address (7 bit)  * @param internal_addr  *                  Internal address.  Can be 0, 1 or 2 bytes in width  * @param num_bytes Number of data bytes to read  * @param ia_width_bytes  *                  Internal address size in bytes (0, 1, or 2)  * @param data      Pointer argument where the read data is returned.  *  * @return read data returned in 'data' argument  *         Number of bytes read on success  *         -1 on failure  */
end_comment

begin_function
name|int
name|cvmx_twsix_read_ia
parameter_list|(
name|int
name|twsi_id
parameter_list|,
name|uint8_t
name|dev_addr
parameter_list|,
name|uint16_t
name|internal_addr
parameter_list|,
name|int
name|num_bytes
parameter_list|,
name|int
name|ia_width_bytes
parameter_list|,
name|uint64_t
modifier|*
name|data
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CVMX_BUILD_FOR_LINUX_KERNEL
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_I2C
argument_list|)
operator|||
name|defined
argument_list|(
name|CONFIG_I2C_MODULE
argument_list|)
name|struct
name|i2c_adapter
modifier|*
name|adapter
decl_stmt|;
name|u8
name|data_buf
index|[
literal|8
index|]
decl_stmt|;
name|u8
name|addr_buf
index|[
literal|8
index|]
decl_stmt|;
name|struct
name|i2c_msg
name|msg
index|[
literal|2
index|]
decl_stmt|;
name|uint64_t
name|r
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
if|if
condition|(
name|ia_width_bytes
operator|==
literal|0
condition|)
return|return
name|cvmx_twsix_read
argument_list|(
name|twsi_id
argument_list|,
name|dev_addr
argument_list|,
name|num_bytes
argument_list|,
name|data
argument_list|)
return|;
name|BUG_ON
argument_list|(
name|ia_width_bytes
operator|>
literal|2
argument_list|)
expr_stmt|;
name|BUG_ON
argument_list|(
name|num_bytes
operator|>
literal|8
operator|||
name|num_bytes
operator|<
literal|1
argument_list|)
expr_stmt|;
name|adapter
operator|=
name|__cvmx_twsix_get_adapter
argument_list|(
name|twsi_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|adapter
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|j
operator|=
literal|0
operator|,
name|i
operator|=
name|ia_width_bytes
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
operator|,
name|j
operator|++
control|)
name|addr_buf
index|[
name|j
index|]
operator|=
call|(
name|u8
call|)
argument_list|(
name|internal_addr
operator|>>
operator|(
name|i
operator|*
literal|8
operator|)
argument_list|)
expr_stmt|;
name|msg
index|[
literal|0
index|]
operator|.
name|addr
operator|=
name|dev_addr
expr_stmt|;
name|msg
index|[
literal|0
index|]
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|msg
index|[
literal|0
index|]
operator|.
name|len
operator|=
name|ia_width_bytes
expr_stmt|;
name|msg
index|[
literal|0
index|]
operator|.
name|buf
operator|=
name|addr_buf
expr_stmt|;
name|msg
index|[
literal|1
index|]
operator|.
name|addr
operator|=
name|dev_addr
expr_stmt|;
name|msg
index|[
literal|1
index|]
operator|.
name|flags
operator|=
name|I2C_M_RD
expr_stmt|;
name|msg
index|[
literal|1
index|]
operator|.
name|len
operator|=
name|num_bytes
expr_stmt|;
name|msg
index|[
literal|1
index|]
operator|.
name|buf
operator|=
name|data_buf
expr_stmt|;
name|i
operator|=
name|i2c_transfer
argument_list|(
name|adapter
argument_list|,
name|msg
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|i2c_put_adapter
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|2
condition|)
block|{
name|r
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_bytes
condition|;
name|i
operator|++
control|)
name|r
operator|=
operator|(
name|r
operator|<<
literal|8
operator|)
operator||
name|data_buf
index|[
name|i
index|]
expr_stmt|;
operator|*
name|data
operator|=
name|r
expr_stmt|;
return|return
name|num_bytes
return|;
block|}
else|else
block|{
return|return
operator|-
literal|1
return|;
block|}
else|#
directive|else
name|BUG
argument_list|()
expr_stmt|;
comment|/* The I2C driver is not compiled in */
endif|#
directive|endif
else|#
directive|else
name|cvmx_mio_twsx_sw_twsi_t
name|sw_twsi_val
decl_stmt|;
name|cvmx_mio_twsx_sw_twsi_ext_t
name|twsi_ext
decl_stmt|;
name|int
name|retry_limit
init|=
literal|5
decl_stmt|;
if|if
condition|(
name|num_bytes
operator|<
literal|1
operator|||
name|num_bytes
operator|>
literal|8
operator|||
operator|!
name|data
operator|||
name|ia_width_bytes
operator|<
literal|0
operator|||
name|ia_width_bytes
operator|>
literal|2
condition|)
return|return
operator|-
literal|1
return|;
name|retry
label|:
name|twsi_ext
operator|.
name|u64
operator|=
literal|0
expr_stmt|;
name|sw_twsi_val
operator|.
name|u64
operator|=
literal|0
expr_stmt|;
name|sw_twsi_val
operator|.
name|s
operator|.
name|v
operator|=
literal|1
expr_stmt|;
name|sw_twsi_val
operator|.
name|s
operator|.
name|r
operator|=
literal|1
expr_stmt|;
name|sw_twsi_val
operator|.
name|s
operator|.
name|sovr
operator|=
literal|1
expr_stmt|;
name|sw_twsi_val
operator|.
name|s
operator|.
name|size
operator|=
name|num_bytes
operator|-
literal|1
expr_stmt|;
name|sw_twsi_val
operator|.
name|s
operator|.
name|a
operator|=
name|dev_addr
expr_stmt|;
if|if
condition|(
name|ia_width_bytes
operator|>
literal|0
condition|)
block|{
name|sw_twsi_val
operator|.
name|s
operator|.
name|op
operator|=
literal|1
expr_stmt|;
name|sw_twsi_val
operator|.
name|s
operator|.
name|ia
operator|=
operator|(
name|internal_addr
operator|>>
literal|3
operator|)
operator|&
literal|0x1f
expr_stmt|;
name|sw_twsi_val
operator|.
name|s
operator|.
name|eop_ia
operator|=
name|internal_addr
operator|&
literal|0x7
expr_stmt|;
block|}
if|if
condition|(
name|ia_width_bytes
operator|==
literal|2
condition|)
block|{
name|sw_twsi_val
operator|.
name|s
operator|.
name|eia
operator|=
literal|1
expr_stmt|;
name|twsi_ext
operator|.
name|s
operator|.
name|ia
operator|=
name|internal_addr
operator|>>
literal|8
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_MIO_TWSX_SW_TWSI_EXT
argument_list|(
name|twsi_id
argument_list|)
argument_list|,
name|twsi_ext
operator|.
name|u64
argument_list|)
expr_stmt|;
block|}
name|cvmx_csr_db_decode
argument_list|(
name|cvmx_get_proc_id
argument_list|()
argument_list|,
name|CVMX_MIO_TWSX_SW_TWSI
argument_list|(
name|twsi_id
argument_list|)
argument_list|,
name|sw_twsi_val
operator|.
name|u64
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_MIO_TWSX_SW_TWSI
argument_list|(
name|twsi_id
argument_list|)
argument_list|,
name|sw_twsi_val
operator|.
name|u64
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
call|(
name|cvmx_mio_twsx_sw_twsi_t
call|)
argument_list|(
name|sw_twsi_val
operator|.
name|u64
operator|=
name|cvmx_read_csr
argument_list|(
name|CVMX_MIO_TWSX_SW_TWSI
argument_list|(
name|twsi_id
argument_list|)
argument_list|)
argument_list|)
operator|)
operator|.
name|s
operator|.
name|v
condition|)
name|cvmx_wait
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|twsi_printf
argument_list|(
literal|"Results:\n"
argument_list|)
expr_stmt|;
name|cvmx_csr_db_decode
argument_list|(
name|cvmx_get_proc_id
argument_list|()
argument_list|,
name|CVMX_MIO_TWSX_SW_TWSI
argument_list|(
name|twsi_id
argument_list|)
argument_list|,
name|sw_twsi_val
operator|.
name|u64
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sw_twsi_val
operator|.
name|s
operator|.
name|r
condition|)
block|{
comment|/* Check the reason for the failure.  We may need to retry to handle multi-master             ** configurations.             ** Lost arbitration : 0x38, 0x68, 0xB0, 0x78             ** Core busy as slave: 0x80, 0x88, 0xA0, 0xA8, 0xB8, 0xC0, 0xC8             */
if|if
condition|(
name|sw_twsi_val
operator|.
name|s
operator|.
name|d
operator|==
literal|0x38
operator|||
name|sw_twsi_val
operator|.
name|s
operator|.
name|d
operator|==
literal|0x68
operator|||
name|sw_twsi_val
operator|.
name|s
operator|.
name|d
operator|==
literal|0xB0
operator|||
name|sw_twsi_val
operator|.
name|s
operator|.
name|d
operator|==
literal|0x78
operator|||
name|sw_twsi_val
operator|.
name|s
operator|.
name|d
operator|==
literal|0x80
operator|||
name|sw_twsi_val
operator|.
name|s
operator|.
name|d
operator|==
literal|0x88
operator|||
name|sw_twsi_val
operator|.
name|s
operator|.
name|d
operator|==
literal|0xA0
operator|||
name|sw_twsi_val
operator|.
name|s
operator|.
name|d
operator|==
literal|0xA8
operator|||
name|sw_twsi_val
operator|.
name|s
operator|.
name|d
operator|==
literal|0xB8
operator|||
name|sw_twsi_val
operator|.
name|s
operator|.
name|d
operator|==
literal|0xC8
condition|)
block|{
if|if
condition|(
name|retry_limit
operator|--
operator|>
literal|0
condition|)
block|{
name|cvmx_wait_usec
argument_list|(
literal|100
argument_list|)
expr_stmt|;
goto|goto
name|retry
goto|;
block|}
block|}
comment|/* For all other errors, return an error code */
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|data
operator|=
operator|(
name|sw_twsi_val
operator|.
name|s
operator|.
name|d
operator|&
operator|(
literal|0xFFFFFFFF
operator|>>
operator|(
literal|32
operator|-
name|num_bytes
operator|*
literal|8
operator|)
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|num_bytes
operator|>
literal|4
condition|)
block|{
name|twsi_ext
operator|.
name|u64
operator|=
name|cvmx_read_csr
argument_list|(
name|CVMX_MIO_TWSX_SW_TWSI_EXT
argument_list|(
name|twsi_id
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|data
operator||=
operator|(
call|(
name|unsigned
name|long
name|long
call|)
argument_list|(
name|twsi_ext
operator|.
name|s
operator|.
name|d
operator|&
operator|(
literal|0xFFFFFFFF
operator|>>
operator|(
literal|32
operator|-
name|num_bytes
operator|*
literal|8
operator|)
operator|)
argument_list|)
operator|<<
literal|32
operator|)
expr_stmt|;
block|}
return|return
name|num_bytes
return|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/**  * Read from a TWSI device (7 bit device address only) without generating any  * internal addresses.  * Read from 1-8 bytes and returns them in the data pointer.  *  * @param twsi_id   TWSI interface on Octeon to use  * @param dev_addr  TWSI device address (7 bit only)  * @param num_bytes number of bytes to read  * @param data      Pointer to data read from TWSI device  *  * @return Number of bytes read on success  *         -1 on error  */
end_comment

begin_function
name|int
name|cvmx_twsix_read
parameter_list|(
name|int
name|twsi_id
parameter_list|,
name|uint8_t
name|dev_addr
parameter_list|,
name|int
name|num_bytes
parameter_list|,
name|uint64_t
modifier|*
name|data
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CVMX_BUILD_FOR_LINUX_KERNEL
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_I2C
argument_list|)
operator|||
name|defined
argument_list|(
name|CONFIG_I2C_MODULE
argument_list|)
name|struct
name|i2c_adapter
modifier|*
name|adapter
decl_stmt|;
name|u8
name|data_buf
index|[
literal|8
index|]
decl_stmt|;
name|struct
name|i2c_msg
name|msg
index|[
literal|1
index|]
decl_stmt|;
name|uint64_t
name|r
decl_stmt|;
name|int
name|i
decl_stmt|;
name|BUG_ON
argument_list|(
name|num_bytes
operator|>
literal|8
operator|||
name|num_bytes
operator|<
literal|1
argument_list|)
expr_stmt|;
name|adapter
operator|=
name|__cvmx_twsix_get_adapter
argument_list|(
name|twsi_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|adapter
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|msg
index|[
literal|0
index|]
operator|.
name|addr
operator|=
name|dev_addr
expr_stmt|;
name|msg
index|[
literal|0
index|]
operator|.
name|flags
operator|=
name|I2C_M_RD
expr_stmt|;
name|msg
index|[
literal|0
index|]
operator|.
name|len
operator|=
name|num_bytes
expr_stmt|;
name|msg
index|[
literal|0
index|]
operator|.
name|buf
operator|=
name|data_buf
expr_stmt|;
name|i
operator|=
name|i2c_transfer
argument_list|(
name|adapter
argument_list|,
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|i2c_put_adapter
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|1
condition|)
block|{
name|r
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_bytes
condition|;
name|i
operator|++
control|)
name|r
operator|=
operator|(
name|r
operator|<<
literal|8
operator|)
operator||
name|data_buf
index|[
name|i
index|]
expr_stmt|;
operator|*
name|data
operator|=
name|r
expr_stmt|;
return|return
name|num_bytes
return|;
block|}
else|else
block|{
return|return
operator|-
literal|1
return|;
block|}
else|#
directive|else
name|BUG
argument_list|()
expr_stmt|;
comment|/* The I2C driver is not compiled in */
endif|#
directive|endif
else|#
directive|else
name|cvmx_mio_twsx_sw_twsi_t
name|sw_twsi_val
decl_stmt|;
name|cvmx_mio_twsx_sw_twsi_ext_t
name|twsi_ext
decl_stmt|;
name|int
name|retry_limit
init|=
literal|5
decl_stmt|;
if|if
condition|(
name|num_bytes
operator|>
literal|8
operator|||
name|num_bytes
operator|<
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|retry
label|:
name|sw_twsi_val
operator|.
name|u64
operator|=
literal|0
expr_stmt|;
name|sw_twsi_val
operator|.
name|s
operator|.
name|v
operator|=
literal|1
expr_stmt|;
name|sw_twsi_val
operator|.
name|s
operator|.
name|r
operator|=
literal|1
expr_stmt|;
name|sw_twsi_val
operator|.
name|s
operator|.
name|a
operator|=
name|dev_addr
expr_stmt|;
name|sw_twsi_val
operator|.
name|s
operator|.
name|sovr
operator|=
literal|1
expr_stmt|;
name|sw_twsi_val
operator|.
name|s
operator|.
name|size
operator|=
name|num_bytes
operator|-
literal|1
expr_stmt|;
name|cvmx_csr_db_decode
argument_list|(
name|cvmx_get_proc_id
argument_list|()
argument_list|,
name|CVMX_MIO_TWSX_SW_TWSI
argument_list|(
name|twsi_id
argument_list|)
argument_list|,
name|sw_twsi_val
operator|.
name|u64
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_MIO_TWSX_SW_TWSI
argument_list|(
name|twsi_id
argument_list|)
argument_list|,
name|sw_twsi_val
operator|.
name|u64
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
call|(
name|cvmx_mio_twsx_sw_twsi_t
call|)
argument_list|(
name|sw_twsi_val
operator|.
name|u64
operator|=
name|cvmx_read_csr
argument_list|(
name|CVMX_MIO_TWSX_SW_TWSI
argument_list|(
name|twsi_id
argument_list|)
argument_list|)
argument_list|)
operator|)
operator|.
name|s
operator|.
name|v
condition|)
name|cvmx_wait
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
name|twsi_printf
argument_list|(
literal|"Results:\n"
argument_list|)
expr_stmt|;
name|cvmx_csr_db_decode
argument_list|(
name|cvmx_get_proc_id
argument_list|()
argument_list|,
name|CVMX_MIO_TWSX_SW_TWSI
argument_list|(
name|twsi_id
argument_list|)
argument_list|,
name|sw_twsi_val
operator|.
name|u64
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sw_twsi_val
operator|.
name|s
operator|.
name|r
condition|)
if|if
condition|(
operator|!
name|sw_twsi_val
operator|.
name|s
operator|.
name|r
condition|)
block|{
comment|/* Check the reason for the failure.  We may need to retry to handle multi-master                 ** configurations.                 ** Lost arbitration : 0x38, 0x68, 0xB0, 0x78                 ** Core busy as slave: 0x80, 0x88, 0xA0, 0xA8, 0xB8, 0xC0, 0xC8                 */
if|if
condition|(
name|sw_twsi_val
operator|.
name|s
operator|.
name|d
operator|==
literal|0x38
operator|||
name|sw_twsi_val
operator|.
name|s
operator|.
name|d
operator|==
literal|0x68
operator|||
name|sw_twsi_val
operator|.
name|s
operator|.
name|d
operator|==
literal|0xB0
operator|||
name|sw_twsi_val
operator|.
name|s
operator|.
name|d
operator|==
literal|0x78
operator|||
name|sw_twsi_val
operator|.
name|s
operator|.
name|d
operator|==
literal|0x80
operator|||
name|sw_twsi_val
operator|.
name|s
operator|.
name|d
operator|==
literal|0x88
operator|||
name|sw_twsi_val
operator|.
name|s
operator|.
name|d
operator|==
literal|0xA0
operator|||
name|sw_twsi_val
operator|.
name|s
operator|.
name|d
operator|==
literal|0xA8
operator|||
name|sw_twsi_val
operator|.
name|s
operator|.
name|d
operator|==
literal|0xB8
operator|||
name|sw_twsi_val
operator|.
name|s
operator|.
name|d
operator|==
literal|0xC8
condition|)
block|{
if|if
condition|(
name|retry_limit
operator|--
operator|>
literal|0
condition|)
block|{
name|cvmx_wait_usec
argument_list|(
literal|100
argument_list|)
expr_stmt|;
goto|goto
name|retry
goto|;
block|}
block|}
comment|/* For all other errors, return an error code */
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|data
operator|=
operator|(
name|sw_twsi_val
operator|.
name|s
operator|.
name|d
operator|&
operator|(
literal|0xFFFFFFFF
operator|>>
operator|(
literal|32
operator|-
name|num_bytes
operator|*
literal|8
operator|)
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|num_bytes
operator|>
literal|4
condition|)
block|{
name|twsi_ext
operator|.
name|u64
operator|=
name|cvmx_read_csr
argument_list|(
name|CVMX_MIO_TWSX_SW_TWSI_EXT
argument_list|(
name|twsi_id
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|data
operator||=
operator|(
call|(
name|unsigned
name|long
name|long
call|)
argument_list|(
name|twsi_ext
operator|.
name|s
operator|.
name|d
operator|&
operator|(
literal|0xFFFFFFFF
operator|>>
operator|(
literal|32
operator|-
name|num_bytes
operator|*
literal|8
operator|)
operator|)
argument_list|)
operator|<<
literal|32
operator|)
expr_stmt|;
block|}
return|return
name|num_bytes
return|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/**  * Perform a twsi write operation to a 7 bit device address.  *  * Note that many eeprom devices have page restrictions regarding address boundaries  * that can be crossed in one write operation.  This is device dependent, and this routine  * does nothing in this regard.  * This command does not generate any internal addressess.  *  * @param twsi_id   Octeon TWSI interface to use  * @param dev_addr  TWSI device address  * @param num_bytes Number of bytes to write (between 1 and 8 inclusive)  * @param data      Data to write  *  * @return 0 on success  *         -1 on failure  */
end_comment

begin_function
name|int
name|cvmx_twsix_write
parameter_list|(
name|int
name|twsi_id
parameter_list|,
name|uint8_t
name|dev_addr
parameter_list|,
name|int
name|num_bytes
parameter_list|,
name|uint64_t
name|data
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CVMX_BUILD_FOR_LINUX_KERNEL
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_I2C
argument_list|)
operator|||
name|defined
argument_list|(
name|CONFIG_I2C_MODULE
argument_list|)
name|struct
name|i2c_adapter
modifier|*
name|adapter
decl_stmt|;
name|u8
name|data_buf
index|[
literal|8
index|]
decl_stmt|;
name|struct
name|i2c_msg
name|msg
index|[
literal|1
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|BUG_ON
argument_list|(
name|num_bytes
operator|>
literal|8
operator|||
name|num_bytes
operator|<
literal|1
argument_list|)
expr_stmt|;
name|adapter
operator|=
name|__cvmx_twsix_get_adapter
argument_list|(
name|twsi_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|adapter
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|j
operator|=
literal|0
operator|,
name|i
operator|=
name|num_bytes
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
operator|,
name|j
operator|++
control|)
name|data_buf
index|[
name|j
index|]
operator|=
call|(
name|u8
call|)
argument_list|(
name|data
operator|>>
operator|(
name|i
operator|*
literal|8
operator|)
argument_list|)
expr_stmt|;
name|msg
index|[
literal|0
index|]
operator|.
name|addr
operator|=
name|dev_addr
expr_stmt|;
name|msg
index|[
literal|0
index|]
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|msg
index|[
literal|0
index|]
operator|.
name|len
operator|=
name|num_bytes
expr_stmt|;
name|msg
index|[
literal|0
index|]
operator|.
name|buf
operator|=
name|data_buf
expr_stmt|;
name|i
operator|=
name|i2c_transfer
argument_list|(
name|adapter
argument_list|,
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|i2c_put_adapter
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|1
condition|)
return|return
name|num_bytes
return|;
else|else
return|return
operator|-
literal|1
return|;
else|#
directive|else
name|BUG
argument_list|()
expr_stmt|;
comment|/* The I2C driver is not compiled in */
endif|#
directive|endif
else|#
directive|else
name|cvmx_mio_twsx_sw_twsi_t
name|sw_twsi_val
decl_stmt|;
if|if
condition|(
name|num_bytes
operator|>
literal|8
operator|||
name|num_bytes
operator|<
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|sw_twsi_val
operator|.
name|u64
operator|=
literal|0
expr_stmt|;
name|sw_twsi_val
operator|.
name|s
operator|.
name|v
operator|=
literal|1
expr_stmt|;
name|sw_twsi_val
operator|.
name|s
operator|.
name|a
operator|=
name|dev_addr
expr_stmt|;
name|sw_twsi_val
operator|.
name|s
operator|.
name|d
operator|=
name|data
operator|&
literal|0xffffffff
expr_stmt|;
name|sw_twsi_val
operator|.
name|s
operator|.
name|sovr
operator|=
literal|1
expr_stmt|;
name|sw_twsi_val
operator|.
name|s
operator|.
name|size
operator|=
name|num_bytes
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|num_bytes
operator|>
literal|4
condition|)
block|{
comment|/* Upper four bytes go into a separate register */
name|cvmx_mio_twsx_sw_twsi_ext_t
name|twsi_ext
decl_stmt|;
name|twsi_ext
operator|.
name|u64
operator|=
literal|0
expr_stmt|;
name|twsi_ext
operator|.
name|s
operator|.
name|d
operator|=
name|data
operator|>>
literal|32
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_MIO_TWSX_SW_TWSI_EXT
argument_list|(
name|twsi_id
argument_list|)
argument_list|,
name|twsi_ext
operator|.
name|u64
argument_list|)
expr_stmt|;
block|}
name|cvmx_csr_db_decode
argument_list|(
name|cvmx_get_proc_id
argument_list|()
argument_list|,
name|CVMX_MIO_TWSX_SW_TWSI
argument_list|(
name|twsi_id
argument_list|)
argument_list|,
name|sw_twsi_val
operator|.
name|u64
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_MIO_TWSX_SW_TWSI
argument_list|(
name|twsi_id
argument_list|)
argument_list|,
name|sw_twsi_val
operator|.
name|u64
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
call|(
name|cvmx_mio_twsx_sw_twsi_t
call|)
argument_list|(
name|sw_twsi_val
operator|.
name|u64
operator|=
name|cvmx_read_csr
argument_list|(
name|CVMX_MIO_TWSX_SW_TWSI
argument_list|(
name|twsi_id
argument_list|)
argument_list|)
argument_list|)
operator|)
operator|.
name|s
operator|.
name|v
condition|)
empty_stmt|;
name|twsi_printf
argument_list|(
literal|"Results:\n"
argument_list|)
expr_stmt|;
name|cvmx_csr_db_decode
argument_list|(
name|cvmx_get_proc_id
argument_list|()
argument_list|,
name|CVMX_MIO_TWSX_SW_TWSI
argument_list|(
name|twsi_id
argument_list|)
argument_list|,
name|sw_twsi_val
operator|.
name|u64
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sw_twsi_val
operator|.
name|s
operator|.
name|r
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/**  * Write 1-8 bytes to a TWSI device using an internal address.  *  * @param twsi_id   which TWSI interface on Octeon to use  * @param dev_addr  TWSI device address (7 bit only)  * @param internal_addr  *                  TWSI internal address (0, 8, or 16 bits)  * @param num_bytes Number of bytes to write (1-8)  * @param ia_width_bytes  *                  internal address width, in bytes (0, 1, 2)  * @param data      Data to write.  Data is written MSB first on the twsi bus, and only the lower  *                  num_bytes bytes of the argument are valid.  (If a 2 byte write is done, only  *                  the low 2 bytes of the argument is used.  *  * @return Number of bytes read on success,  *         -1 on error  */
end_comment

begin_function
name|int
name|cvmx_twsix_write_ia
parameter_list|(
name|int
name|twsi_id
parameter_list|,
name|uint8_t
name|dev_addr
parameter_list|,
name|uint16_t
name|internal_addr
parameter_list|,
name|int
name|num_bytes
parameter_list|,
name|int
name|ia_width_bytes
parameter_list|,
name|uint64_t
name|data
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CVMX_BUILD_FOR_LINUX_KERNEL
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_I2C
argument_list|)
operator|||
name|defined
argument_list|(
name|CONFIG_I2C_MODULE
argument_list|)
name|struct
name|i2c_adapter
modifier|*
name|adapter
decl_stmt|;
name|u8
name|data_buf
index|[
literal|8
index|]
decl_stmt|;
name|u8
name|addr_buf
index|[
literal|8
index|]
decl_stmt|;
name|struct
name|i2c_msg
name|msg
index|[
literal|2
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
if|if
condition|(
name|ia_width_bytes
operator|==
literal|0
condition|)
return|return
name|cvmx_twsix_write
argument_list|(
name|twsi_id
argument_list|,
name|dev_addr
argument_list|,
name|num_bytes
argument_list|,
name|data
argument_list|)
return|;
name|BUG_ON
argument_list|(
name|ia_width_bytes
operator|>
literal|2
argument_list|)
expr_stmt|;
name|BUG_ON
argument_list|(
name|num_bytes
operator|>
literal|8
operator|||
name|num_bytes
operator|<
literal|1
argument_list|)
expr_stmt|;
name|adapter
operator|=
name|__cvmx_twsix_get_adapter
argument_list|(
name|twsi_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|adapter
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|j
operator|=
literal|0
operator|,
name|i
operator|=
name|ia_width_bytes
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
operator|,
name|j
operator|++
control|)
name|addr_buf
index|[
name|j
index|]
operator|=
call|(
name|u8
call|)
argument_list|(
name|internal_addr
operator|>>
operator|(
name|i
operator|*
literal|8
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
operator|,
name|i
operator|=
name|num_bytes
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
operator|,
name|j
operator|++
control|)
name|data_buf
index|[
name|j
index|]
operator|=
call|(
name|u8
call|)
argument_list|(
name|data
operator|>>
operator|(
name|i
operator|*
literal|8
operator|)
argument_list|)
expr_stmt|;
name|msg
index|[
literal|0
index|]
operator|.
name|addr
operator|=
name|dev_addr
expr_stmt|;
name|msg
index|[
literal|0
index|]
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|msg
index|[
literal|0
index|]
operator|.
name|len
operator|=
name|ia_width_bytes
expr_stmt|;
name|msg
index|[
literal|0
index|]
operator|.
name|buf
operator|=
name|addr_buf
expr_stmt|;
name|msg
index|[
literal|1
index|]
operator|.
name|addr
operator|=
name|dev_addr
expr_stmt|;
name|msg
index|[
literal|1
index|]
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|msg
index|[
literal|1
index|]
operator|.
name|len
operator|=
name|num_bytes
expr_stmt|;
name|msg
index|[
literal|1
index|]
operator|.
name|buf
operator|=
name|data_buf
expr_stmt|;
name|i
operator|=
name|i2c_transfer
argument_list|(
name|adapter
argument_list|,
name|msg
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|i2c_put_adapter
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|2
condition|)
block|{
comment|/* Poll until reads succeed, or polling times out */
name|int
name|to
init|=
literal|100
decl_stmt|;
while|while
condition|(
name|to
operator|--
operator|>
literal|0
condition|)
block|{
name|uint64_t
name|data
decl_stmt|;
if|if
condition|(
name|cvmx_twsix_read
argument_list|(
name|twsi_id
argument_list|,
name|dev_addr
argument_list|,
literal|1
argument_list|,
operator|&
name|data
argument_list|)
operator|>=
literal|0
condition|)
break|break;
block|}
block|}
if|if
condition|(
name|i
operator|==
literal|2
condition|)
return|return
name|num_bytes
return|;
else|else
return|return
operator|-
literal|1
return|;
else|#
directive|else
name|BUG
argument_list|()
expr_stmt|;
comment|/* The I2C driver is not compiled in */
endif|#
directive|endif
else|#
directive|else
name|cvmx_mio_twsx_sw_twsi_t
name|sw_twsi_val
decl_stmt|;
name|cvmx_mio_twsx_sw_twsi_ext_t
name|twsi_ext
decl_stmt|;
name|int
name|to
decl_stmt|;
if|if
condition|(
name|num_bytes
operator|<
literal|1
operator|||
name|num_bytes
operator|>
literal|8
operator|||
name|ia_width_bytes
operator|<
literal|0
operator|||
name|ia_width_bytes
operator|>
literal|2
condition|)
return|return
operator|-
literal|1
return|;
name|twsi_ext
operator|.
name|u64
operator|=
literal|0
expr_stmt|;
name|sw_twsi_val
operator|.
name|u64
operator|=
literal|0
expr_stmt|;
name|sw_twsi_val
operator|.
name|s
operator|.
name|v
operator|=
literal|1
expr_stmt|;
name|sw_twsi_val
operator|.
name|s
operator|.
name|sovr
operator|=
literal|1
expr_stmt|;
name|sw_twsi_val
operator|.
name|s
operator|.
name|size
operator|=
name|num_bytes
operator|-
literal|1
expr_stmt|;
name|sw_twsi_val
operator|.
name|s
operator|.
name|a
operator|=
name|dev_addr
expr_stmt|;
name|sw_twsi_val
operator|.
name|s
operator|.
name|d
operator|=
literal|0xFFFFFFFF
operator|&
name|data
expr_stmt|;
if|if
condition|(
name|ia_width_bytes
operator|>
literal|0
condition|)
block|{
name|sw_twsi_val
operator|.
name|s
operator|.
name|op
operator|=
literal|1
expr_stmt|;
name|sw_twsi_val
operator|.
name|s
operator|.
name|ia
operator|=
operator|(
name|internal_addr
operator|>>
literal|3
operator|)
operator|&
literal|0x1f
expr_stmt|;
name|sw_twsi_val
operator|.
name|s
operator|.
name|eop_ia
operator|=
name|internal_addr
operator|&
literal|0x7
expr_stmt|;
block|}
if|if
condition|(
name|ia_width_bytes
operator|==
literal|2
condition|)
block|{
name|sw_twsi_val
operator|.
name|s
operator|.
name|eia
operator|=
literal|1
expr_stmt|;
name|twsi_ext
operator|.
name|s
operator|.
name|ia
operator|=
name|internal_addr
operator|>>
literal|8
expr_stmt|;
block|}
if|if
condition|(
name|num_bytes
operator|>
literal|4
condition|)
name|twsi_ext
operator|.
name|s
operator|.
name|d
operator|=
name|data
operator|>>
literal|32
expr_stmt|;
name|twsi_printf
argument_list|(
literal|"%s: twsi_id=%x, dev_addr=%x, internal_addr=%x\n\tnum_bytes=%d, ia_width_bytes=%d, data=%lx\n"
argument_list|,
name|__FUNCTION__
argument_list|,
name|twsi_id
argument_list|,
name|dev_addr
argument_list|,
name|internal_addr
argument_list|,
name|num_bytes
argument_list|,
name|ia_width_bytes
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|cvmx_csr_db_decode
argument_list|(
name|cvmx_get_proc_id
argument_list|()
argument_list|,
name|CVMX_MIO_TWSX_SW_TWSI_EXT
argument_list|(
name|twsi_id
argument_list|)
argument_list|,
name|twsi_ext
operator|.
name|u64
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_MIO_TWSX_SW_TWSI_EXT
argument_list|(
name|twsi_id
argument_list|)
argument_list|,
name|twsi_ext
operator|.
name|u64
argument_list|)
expr_stmt|;
name|cvmx_csr_db_decode
argument_list|(
name|cvmx_get_proc_id
argument_list|()
argument_list|,
name|CVMX_MIO_TWSX_SW_TWSI
argument_list|(
name|twsi_id
argument_list|)
argument_list|,
name|sw_twsi_val
operator|.
name|u64
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_MIO_TWSX_SW_TWSI
argument_list|(
name|twsi_id
argument_list|)
argument_list|,
name|sw_twsi_val
operator|.
name|u64
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
call|(
name|cvmx_mio_twsx_sw_twsi_t
call|)
argument_list|(
name|sw_twsi_val
operator|.
name|u64
operator|=
name|cvmx_read_csr
argument_list|(
name|CVMX_MIO_TWSX_SW_TWSI
argument_list|(
name|twsi_id
argument_list|)
argument_list|)
argument_list|)
operator|)
operator|.
name|s
operator|.
name|v
condition|)
empty_stmt|;
name|twsi_printf
argument_list|(
literal|"Results:\n"
argument_list|)
expr_stmt|;
name|cvmx_csr_db_decode
argument_list|(
name|cvmx_get_proc_id
argument_list|()
argument_list|,
name|CVMX_MIO_TWSX_SW_TWSI
argument_list|(
name|twsi_id
argument_list|)
argument_list|,
name|sw_twsi_val
operator|.
name|u64
argument_list|)
expr_stmt|;
comment|/* Poll until reads succeed, or polling times out */
name|to
operator|=
literal|100
expr_stmt|;
while|while
condition|(
name|to
operator|--
operator|>
literal|0
condition|)
block|{
name|uint64_t
name|data
decl_stmt|;
if|if
condition|(
name|cvmx_twsix_read
argument_list|(
name|twsi_id
argument_list|,
name|dev_addr
argument_list|,
literal|1
argument_list|,
operator|&
name|data
argument_list|)
operator|>=
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|to
operator|<=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|num_bytes
return|;
endif|#
directive|endif
block|}
end_function

end_unit


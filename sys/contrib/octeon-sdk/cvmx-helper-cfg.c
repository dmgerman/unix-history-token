begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/***********************license start***************  * Copyright (c) 2003-2010  Cavium Inc. (support@cavium.com). All rights  * reserved.  *  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are  * met:  *  *   * Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *  *   * Redistributions in binary form must reproduce the above  *     copyright notice, this list of conditions and the following  *     disclaimer in the documentation and/or other materials provided  *     with the distribution.   *   * Neither the name of Cavium Inc. nor the names of  *     its contributors may be used to endorse or promote products  *     derived from this software without specific prior written  *     permission.   * This Software, including technical data, may be subject to U.S. export  control  * laws, including the U.S. Export Administration Act and its  associated  * regulations, and may be subject to export or import  regulations in other  * countries.   * TO THE MAXIMUM EXTENT PERMITTED BY LAW, THE SOFTWARE IS PROVIDED "AS IS"  * AND WITH ALL FAULTS AND CAVIUM INC. MAKES NO PROMISES, REPRESENTATIONS OR  * WARRANTIES, EITHER EXPRESS, IMPLIED, STATUTORY, OR OTHERWISE, WITH RESPECT TO  * THE SOFTWARE, INCLUDING ITS CONDITION, ITS CONFORMITY TO ANY REPRESENTATION OR  * DESCRIPTION, OR THE EXISTENCE OF ANY LATENT OR PATENT DEFECTS, AND CAVIUM  * SPECIFICALLY DISCLAIMS ALL IMPLIED (IF ANY) WARRANTIES OF TITLE,  * MERCHANTABILITY, NONINFRINGEMENT, FITNESS FOR A PARTICULAR PURPOSE, LACK OF  * VIRUSES, ACCURACY OR COMPLETENESS, QUIET ENJOYMENT, QUIET POSSESSION OR  * CORRESPONDENCE TO DESCRIPTION. THE ENTIRE  RISK ARISING OUT OF USE OR  * PERFORMANCE OF THE SOFTWARE LIES WITH YOU.  ***********************license end**************************************/
end_comment

begin_comment
comment|/**  * @file  *  * Helper Functions for the Configuration Framework  *  *<hr>$Revision: 0 $<hr>  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CVMX_BUILD_FOR_LINUX_KERNEL
end_ifdef

begin_include
include|#
directive|include
file|<linux/module.h>
end_include

begin_include
include|#
directive|include
file|<asm/octeon/cvmx.h>
end_include

begin_include
include|#
directive|include
file|<asm/octeon/cvmx-helper.h>
end_include

begin_include
include|#
directive|include
file|<asm/octeon/cvmx-helper-util.h>
end_include

begin_include
include|#
directive|include
file|<asm/octeon/cvmx-helper-cfg.h>
end_include

begin_include
include|#
directive|include
file|<asm/octeon/cvmx-helper-ilk.h>
end_include

begin_include
include|#
directive|include
file|<asm/octeon/cvmx-ilk.h>
end_include

begin_include
include|#
directive|include
file|<asm/octeon/cvmx-config.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|"cvmx.h"
end_include

begin_include
include|#
directive|include
file|"cvmx-bootmem.h"
end_include

begin_include
include|#
directive|include
file|"cvmx-helper.h"
end_include

begin_include
include|#
directive|include
file|"cvmx-helper-util.h"
end_include

begin_include
include|#
directive|include
file|"cvmx-helper-cfg.h"
end_include

begin_include
include|#
directive|include
file|"cvmx-ilk.h"
end_include

begin_include
include|#
directive|include
file|"cvmx-helper-ilk.h"
end_include

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
operator|||
operator|!
name|defined
argument_list|(
name|_KERNEL
argument_list|)
end_if

begin_include
include|#
directive|include
file|"cvmx-config.h"
end_include

begin_include
include|#
directive|include
file|"executive-config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|min
argument_list|)
end_if

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|min
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|( ( a )< ( b ) ) ? ( a ) : ( b )
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* #define CVMX_HELPER_CFG_DEBUG */
end_comment

begin_comment
comment|/*  * Per physical port  */
end_comment

begin_struct
struct|struct
name|cvmx_cfg_port_param
block|{
name|int8_t
name|ccpp_pknd
decl_stmt|;
name|int8_t
name|ccpp_bpid
decl_stmt|;
name|int8_t
name|ccpp_pko_port_base
decl_stmt|;
name|int8_t
name|ccpp_pko_num_ports
decl_stmt|;
name|uint8_t
name|ccpp_pko_nqueues
decl_stmt|;
comment|/* 					 * When the user explicitly 					 * assigns queues, 					 * cvmx_cfg_pko_nqueue_pool[ 					 *     ccpp_pko_nqueues ...  					 *     ccpp_pko_nqueues +  					 *     ccpp_pko_num_ports - 1] 					 * are the numbers of PKO queues 					 * assigned to the PKO ports for 					 * this physical port. 					 */
block|}
struct|;
end_struct

begin_comment
comment|/*  * Per pko_port  */
end_comment

begin_struct
struct|struct
name|cvmx_cfg_pko_port_param
block|{
name|int16_t
name|ccppp_queue_base
decl_stmt|;
name|int16_t
name|ccppp_num_queues
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * A map from pko_port to  *     interface,  *     index, and  *     pko engine id  */
end_comment

begin_struct
struct|struct
name|cvmx_cfg_pko_port_map
block|{
name|int16_t
name|ccppl_interface
decl_stmt|;
name|int16_t
name|ccppl_index
decl_stmt|;
name|int16_t
name|ccppl_eid
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * This is for looking up pko_base_port and pko_nport for ipd_port  */
end_comment

begin_struct
struct|struct
name|cvmx_cfg_pko_port_pair
block|{
name|int8_t
name|ccppp_base_port
decl_stmt|;
name|int8_t
name|ccppp_nports
decl_stmt|;
block|}
struct|;
end_struct

begin_expr_stmt
specifier|static
name|CVMX_SHARED
expr|struct
name|cvmx_cfg_port_param
name|cvmx_cfg_port
index|[
name|CVMX_HELPER_CFG_MAX_IFACE
index|]
index|[
name|CVMX_HELPER_CFG_MAX_PORT_PER_IFACE
index|]
operator|=
block|{
index|[
literal|0
operator|...
name|CVMX_HELPER_CFG_MAX_IFACE
operator|-
literal|1
index|]
operator|=
block|{
index|[
literal|0
operator|...
name|CVMX_HELPER_CFG_MAX_PORT_PER_IFACE
operator|-
literal|1
index|]
operator|=
block|{
name|CVMX_HELPER_CFG_INVALID_VALUE
block|,
name|CVMX_HELPER_CFG_INVALID_VALUE
block|,
name|CVMX_HELPER_CFG_INVALID_VALUE
block|,
name|CVMX_HELPER_CFG_INVALID_VALUE
block|,
name|CVMX_HELPER_CFG_INVALID_VALUE
block|}
block|}
block|}
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Indexed by the pko_port number  */
end_comment

begin_expr_stmt
specifier|static
name|CVMX_SHARED
expr|struct
name|cvmx_cfg_pko_port_param
name|cvmx_cfg_pko_port
index|[
name|CVMX_HELPER_CFG_MAX_PKO_PORT
index|]
operator|=
block|{
index|[
literal|0
operator|...
name|CVMX_HELPER_CFG_MAX_PKO_PORT
operator|-
literal|1
index|]
operator|=
block|{
name|CVMX_HELPER_CFG_INVALID_VALUE
block|,
name|CVMX_HELPER_CFG_INVALID_VALUE
block|}
block|}
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|CVMX_SHARED
expr|struct
name|cvmx_cfg_pko_port_map
name|cvmx_cfg_pko_port_map
index|[
name|CVMX_HELPER_CFG_MAX_PKO_PORT
index|]
operator|=
block|{
index|[
literal|0
operator|...
name|CVMX_HELPER_CFG_MAX_PKO_PORT
operator|-
literal|1
index|]
operator|=
block|{
name|CVMX_HELPER_CFG_INVALID_VALUE
block|,
name|CVMX_HELPER_CFG_INVALID_VALUE
block|,
name|CVMX_HELPER_CFG_INVALID_VALUE
block|}
block|}
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|CVMX_ENABLE_PKO_FUNCTIONS
end_ifdef

begin_comment
comment|/*  * This array assists translation from ipd_port to pko_port.  * The ``16'' is the rounded value for the 3rd 4-bit value of  * ipd_port, used to differentiate ``interfaces.''  */
end_comment

begin_expr_stmt
specifier|static
name|CVMX_SHARED
expr|struct
name|cvmx_cfg_pko_port_pair
name|ipd2pko_port_cache
index|[
literal|16
index|]
index|[
name|CVMX_HELPER_CFG_MAX_PORT_PER_IFACE
index|]
operator|=
block|{
index|[
literal|0
operator|...
literal|15
index|]
operator|=
block|{
index|[
literal|0
operator|...
name|CVMX_HELPER_CFG_MAX_PORT_PER_IFACE
operator|-
literal|1
index|]
operator|=
block|{
name|CVMX_HELPER_CFG_INVALID_VALUE
block|,
name|CVMX_HELPER_CFG_INVALID_VALUE
block|}
block|}
block|}
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|CVMX_USER_DEFINED_HELPER_CONFIG_INIT
end_ifdef

begin_decl_stmt
specifier|static
name|CVMX_SHARED
name|int
name|cvmx_cfg_default_pko_nqueues
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * A pool for holding the pko_nqueues for the pko_ports assigned to a  * physical port.  */
end_comment

begin_decl_stmt
specifier|static
name|CVMX_SHARED
name|uint8_t
name|cvmx_cfg_pko_nqueue_pool
index|[
name|CVMX_HELPER_CFG_MAX_PKO_QUEUES
index|]
init|=
block|{
index|[
literal|0
operator|...
name|CVMX_HELPER_CFG_MAX_PKO_QUEUES
operator|-
literal|1
index|]
operator|=
literal|1
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Options  *  * Each array-elem's intial value is also the option's default value.  */
end_comment

begin_decl_stmt
specifier|static
name|CVMX_SHARED
name|uint64_t
name|cvmx_cfg_opts
index|[
name|CVMX_HELPER_CFG_OPT_MAX
index|]
init|=
block|{
index|[
literal|0
operator|...
name|CVMX_HELPER_CFG_OPT_MAX
operator|-
literal|1
index|]
operator|=
literal|1
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * MISC  */
end_comment

begin_decl_stmt
specifier|static
name|CVMX_SHARED
name|int
name|cvmx_cfg_max_pko_engines
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* # of PKO DMA engines  						    allocated */
end_comment

begin_function
name|int
name|__cvmx_helper_cfg_pknd
parameter_list|(
name|int
name|interface
parameter_list|,
name|int
name|index
parameter_list|)
block|{
return|return
name|cvmx_cfg_port
index|[
name|interface
index|]
index|[
name|index
index|]
operator|.
name|ccpp_pknd
return|;
block|}
end_function

begin_function
name|int
name|__cvmx_helper_cfg_bpid
parameter_list|(
name|int
name|interface
parameter_list|,
name|int
name|index
parameter_list|)
block|{
return|return
name|cvmx_cfg_port
index|[
name|interface
index|]
index|[
name|index
index|]
operator|.
name|ccpp_bpid
return|;
block|}
end_function

begin_function
name|int
name|__cvmx_helper_cfg_pko_port_base
parameter_list|(
name|int
name|interface
parameter_list|,
name|int
name|index
parameter_list|)
block|{
return|return
name|cvmx_cfg_port
index|[
name|interface
index|]
index|[
name|index
index|]
operator|.
name|ccpp_pko_port_base
return|;
block|}
end_function

begin_function
name|int
name|__cvmx_helper_cfg_pko_port_num
parameter_list|(
name|int
name|interface
parameter_list|,
name|int
name|index
parameter_list|)
block|{
return|return
name|cvmx_cfg_port
index|[
name|interface
index|]
index|[
name|index
index|]
operator|.
name|ccpp_pko_num_ports
return|;
block|}
end_function

begin_function
name|int
name|__cvmx_helper_cfg_pko_queue_num
parameter_list|(
name|int
name|pko_port
parameter_list|)
block|{
return|return
name|cvmx_cfg_pko_port
index|[
name|pko_port
index|]
operator|.
name|ccppp_num_queues
return|;
block|}
end_function

begin_function
name|int
name|__cvmx_helper_cfg_pko_queue_base
parameter_list|(
name|int
name|pko_port
parameter_list|)
block|{
return|return
name|cvmx_cfg_pko_port
index|[
name|pko_port
index|]
operator|.
name|ccppp_queue_base
return|;
block|}
end_function

begin_function
name|int
name|__cvmx_helper_cfg_pko_max_queue
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|i
operator|=
name|CVMX_HELPER_CFG_MAX_PKO_PORT
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|i
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|cvmx_cfg_pko_port
index|[
name|i
index|]
operator|.
name|ccppp_queue_base
operator|!=
name|CVMX_HELPER_CFG_INVALID_VALUE
condition|)
block|{
name|cvmx_helper_cfg_assert
argument_list|(
name|cvmx_cfg_pko_port
index|[
name|i
index|]
operator|.
name|ccppp_num_queues
operator|>
literal|0
argument_list|)
expr_stmt|;
return|return
operator|(
name|cvmx_cfg_pko_port
index|[
name|i
index|]
operator|.
name|ccppp_queue_base
operator|+
name|cvmx_cfg_pko_port
index|[
name|i
index|]
operator|.
name|ccppp_num_queues
operator|)
return|;
block|}
name|i
operator|--
expr_stmt|;
block|}
name|cvmx_helper_cfg_assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* shouldn't get here */
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|__cvmx_helper_cfg_pko_max_engine
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|cvmx_cfg_max_pko_engines
return|;
block|}
end_function

begin_function
name|int
name|cvmx_helper_cfg_opt_set
parameter_list|(
name|cvmx_helper_cfg_option_t
name|opt
parameter_list|,
name|uint64_t
name|val
parameter_list|)
block|{
if|if
condition|(
name|opt
operator|>=
name|CVMX_HELPER_CFG_OPT_MAX
condition|)
return|return
operator|-
literal|1
return|;
name|cvmx_cfg_opts
index|[
name|opt
index|]
operator|=
name|val
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|uint64_t
name|cvmx_helper_cfg_opt_get
parameter_list|(
name|cvmx_helper_cfg_option_t
name|opt
parameter_list|)
block|{
if|if
condition|(
name|opt
operator|>=
name|CVMX_HELPER_CFG_OPT_MAX
condition|)
return|return
operator|(
name|uint64_t
operator|)
name|CVMX_HELPER_CFG_INVALID_VALUE
return|;
return|return
name|cvmx_cfg_opts
index|[
name|opt
index|]
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CVMX_BUILD_FOR_LINUX_KERNEL
end_ifdef

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|__cvmx_helper_cfg_init
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|__cvmx_helper_cfg_pknd
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|__cvmx_helper_cfg_bpid
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|__cvmx_helper_cfg_pko_port_base
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|__cvmx_helper_cfg_pko_port_num
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|__cvmx_helper_cfg_pko_queue_base
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|__cvmx_helper_cfg_pko_queue_num
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|__cvmx_helper_cfg_pko_max_queue
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|__cvmx_helper_cfg_pko_port_interface
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|__cvmx_helper_cfg_pko_port_index
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|__cvmx_helper_cfg_pko_port_eid
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|__cvmx_helper_cfg_pko_max_engine
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|cvmx_helper_cfg_opt_get
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|cvmx_helper_cfg_opt_set
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|cvmx_helper_cfg_ipd2pko_port_base
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|cvmx_helper_cfg_ipd2pko_port_num
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|CVMX_ENABLE_HELPER_FUNCTIONS
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|CVMX_HELPER_CFG_DEBUG
end_ifdef

begin_function
name|void
name|cvmx_helper_cfg_show_cfg
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cvmx_helper_get_number_of_interfaces
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|cvmx_dprintf
argument_list|(
literal|"cvmx_helper_cfg_show_cfg: interface%d mode %10s nports%4d\n"
argument_list|,
name|i
argument_list|,
name|cvmx_helper_interface_mode_to_string
argument_list|(
name|cvmx_helper_interface_get_mode
argument_list|(
name|i
argument_list|)
argument_list|)
argument_list|,
name|cvmx_helper_interface_enumerate
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|cvmx_helper_interface_enumerate
argument_list|(
name|i
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
name|cvmx_dprintf
argument_list|(
literal|"\tpknd[%i][%d]%d"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
name|__cvmx_helper_cfg_pknd
argument_list|(
name|i
argument_list|,
name|j
argument_list|)
argument_list|)
expr_stmt|;
name|cvmx_dprintf
argument_list|(
literal|" pko_port_base[%i][%d]%d"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
name|__cvmx_helper_cfg_pko_port_base
argument_list|(
name|i
argument_list|,
name|j
argument_list|)
argument_list|)
expr_stmt|;
name|cvmx_dprintf
argument_list|(
literal|" pko_port_num[%i][%d]%d\n"
argument_list|,
name|i
argument_list|,
name|j
argument_list|,
name|__cvmx_helper_cfg_pko_port_num
argument_list|(
name|i
argument_list|,
name|j
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CVMX_HELPER_CFG_MAX_PKO_PORT
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|__cvmx_helper_cfg_pko_queue_base
argument_list|(
name|i
argument_list|)
operator|!=
name|CVMX_HELPER_CFG_INVALID_VALUE
condition|)
block|{
name|cvmx_dprintf
argument_list|(
literal|"cvmx_helper_cfg_show_cfg: pko_port%d qbase%d nqueues%d "
literal|"interface%d index%d\n"
argument_list|,
name|i
argument_list|,
name|__cvmx_helper_cfg_pko_queue_base
argument_list|(
name|i
argument_list|)
argument_list|,
name|__cvmx_helper_cfg_pko_queue_num
argument_list|(
name|i
argument_list|)
argument_list|,
name|__cvmx_helper_cfg_pko_port_interface
argument_list|(
name|i
argument_list|)
argument_list|,
name|__cvmx_helper_cfg_pko_port_index
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * initialize cvmx_cfg_pko_port_map  */
end_comment

begin_function
specifier|static
name|void
name|cvmx_helper_cfg_init_pko_port_map
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|;
name|int
name|pko_eid
decl_stmt|;
name|int
name|pko_port_base
decl_stmt|,
name|pko_port_max
decl_stmt|;
name|cvmx_helper_interface_mode_t
name|mode
decl_stmt|;
comment|/*      * one pko_eid is allocated to each port except for ILK, NPI, and      * LOOP. Each of the three has one eid.      */
name|pko_eid
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cvmx_helper_get_number_of_interfaces
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|mode
operator|=
name|cvmx_helper_interface_get_mode
argument_list|(
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|cvmx_helper_interface_enumerate
argument_list|(
name|i
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
name|pko_port_base
operator|=
name|cvmx_cfg_port
index|[
name|i
index|]
index|[
name|j
index|]
operator|.
name|ccpp_pko_port_base
expr_stmt|;
name|pko_port_max
operator|=
name|pko_port_base
operator|+
name|cvmx_cfg_port
index|[
name|i
index|]
index|[
name|j
index|]
operator|.
name|ccpp_pko_num_ports
expr_stmt|;
name|cvmx_helper_cfg_assert
argument_list|(
name|pko_port_base
operator|!=
name|CVMX_HELPER_CFG_INVALID_VALUE
argument_list|)
expr_stmt|;
name|cvmx_helper_cfg_assert
argument_list|(
name|pko_port_max
operator|>=
name|pko_port_base
argument_list|)
expr_stmt|;
for|for
control|(
name|k
operator|=
name|pko_port_base
init|;
name|k
operator|<
name|pko_port_max
condition|;
name|k
operator|++
control|)
block|{
name|cvmx_cfg_pko_port_map
index|[
name|k
index|]
operator|.
name|ccppl_interface
operator|=
name|i
expr_stmt|;
name|cvmx_cfg_pko_port_map
index|[
name|k
index|]
operator|.
name|ccppl_index
operator|=
name|j
expr_stmt|;
name|cvmx_cfg_pko_port_map
index|[
name|k
index|]
operator|.
name|ccppl_eid
operator|=
name|pko_eid
expr_stmt|;
block|}
if|#
directive|if
literal|0
comment|/* 	     * For a physical port that is not configured a PKO port, 	     * pko_port_base here equals to pko_port_max. In this 	     * case, the physical port does not take a DMA engine. 	     */
block|if (pko_port_base> pko_port_max)
endif|#
directive|endif
if|if
condition|(
operator|!
operator|(
name|mode
operator|==
name|CVMX_HELPER_INTERFACE_MODE_NPI
operator|||
name|mode
operator|==
name|CVMX_HELPER_INTERFACE_MODE_LOOP
operator|||
name|mode
operator|==
name|CVMX_HELPER_INTERFACE_MODE_ILK
operator|)
condition|)
name|pko_eid
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|mode
operator|==
name|CVMX_HELPER_INTERFACE_MODE_NPI
operator|||
name|mode
operator|==
name|CVMX_HELPER_INTERFACE_MODE_LOOP
operator|||
name|mode
operator|==
name|CVMX_HELPER_INTERFACE_MODE_ILK
condition|)
name|pko_eid
operator|++
expr_stmt|;
block|}
comment|/*      * Legal pko_eids [0, 0x13] should not be exhausted.      */
name|cvmx_helper_cfg_assert
argument_list|(
name|pko_eid
operator|<=
literal|0x14
argument_list|)
expr_stmt|;
name|cvmx_cfg_max_pko_engines
operator|=
name|pko_eid
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|int
name|__cvmx_helper_cfg_pko_port_interface
parameter_list|(
name|int
name|pko_port
parameter_list|)
block|{
return|return
name|cvmx_cfg_pko_port_map
index|[
name|pko_port
index|]
operator|.
name|ccppl_interface
return|;
block|}
end_function

begin_function
name|int
name|__cvmx_helper_cfg_pko_port_index
parameter_list|(
name|int
name|pko_port
parameter_list|)
block|{
return|return
name|cvmx_cfg_pko_port_map
index|[
name|pko_port
index|]
operator|.
name|ccppl_index
return|;
block|}
end_function

begin_function
name|int
name|__cvmx_helper_cfg_pko_port_eid
parameter_list|(
name|int
name|pko_port
parameter_list|)
block|{
return|return
name|cvmx_cfg_pko_port_map
index|[
name|pko_port
index|]
operator|.
name|ccppl_eid
return|;
block|}
end_function

begin_comment
comment|/**  * Perform common init tasks for all chips.  * @return 1 for the caller to continue init and 0 otherwise.  *  * Note: ``common'' means this function is executed regardless of  * 	- chip, and  * 	- CVMX_ENABLE_HELPER_FUNCTIONS.  *  * This function decides based on these conditions if the  * configuration stage of the init process should continue.  *  * This is only meant to be called by __cvmx_helper_cfg_init().  */
end_comment

begin_function
specifier|static
name|int
name|__cvmx_helper_cfg_init_common
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|val
decl_stmt|;
ifndef|#
directive|ifndef
name|CVMX_ENABLE_HELPER_FUNCTIONS
name|val
operator|=
literal|0
expr_stmt|;
else|#
directive|else
name|val
operator|=
operator|(
name|octeon_has_feature
argument_list|(
name|OCTEON_FEATURE_PKND
argument_list|)
operator|)
expr_stmt|;
endif|#
directive|endif
return|return
name|val
return|;
block|}
end_function

begin_define
define|#
directive|define
name|IPD2PKO_CACHE_Y
parameter_list|(
name|ipd_port
parameter_list|)
value|(ipd_port)>> 8
end_define

begin_define
define|#
directive|define
name|IPD2PKO_CACHE_X
parameter_list|(
name|ipd_port
parameter_list|)
value|(ipd_port)& 0xff
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|CVMX_ENABLE_PKO_FUNCTIONS
end_ifdef

begin_comment
comment|/*  * ipd_port to pko_port translation cache  */
end_comment

begin_function
specifier|static
name|int
name|__cvmx_helper_cfg_init_ipd2pko_cache
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|n
decl_stmt|;
name|int
name|ipd_y
decl_stmt|,
name|ipd_x
decl_stmt|,
name|ipd_port
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cvmx_helper_get_number_of_interfaces
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|n
operator|=
name|cvmx_helper_interface_enumerate
argument_list|(
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|n
condition|;
name|j
operator|++
control|)
block|{
name|ipd_port
operator|=
name|cvmx_helper_get_ipd_port
argument_list|(
name|i
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|ipd_y
operator|=
name|IPD2PKO_CACHE_Y
argument_list|(
name|ipd_port
argument_list|)
expr_stmt|;
name|ipd_x
operator|=
name|IPD2PKO_CACHE_X
argument_list|(
name|ipd_port
argument_list|)
expr_stmt|;
name|ipd2pko_port_cache
index|[
name|ipd_y
index|]
index|[
operator|(
name|ipd_port
operator|&
literal|0x800
operator|)
condition|?
operator|(
operator|(
name|ipd_x
operator|>>
literal|4
operator|)
operator|&
literal|3
operator|)
else|:
name|ipd_x
index|]
operator|=
operator|(
expr|struct
name|cvmx_cfg_pko_port_pair
operator|)
block|{
name|__cvmx_helper_cfg_pko_port_base
argument_list|(
name|i
argument_list|,
name|j
argument_list|)
block|,
name|__cvmx_helper_cfg_pko_port_num
argument_list|(
argument|i
argument_list|,
argument|j
argument_list|)
block|}
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|cvmx_helper_cfg_ipd2pko_port_base
parameter_list|(
name|int
name|ipd_port
parameter_list|)
block|{
name|int
name|ipd_y
decl_stmt|,
name|ipd_x
decl_stmt|;
name|ipd_y
operator|=
name|IPD2PKO_CACHE_Y
argument_list|(
name|ipd_port
argument_list|)
expr_stmt|;
name|ipd_x
operator|=
name|IPD2PKO_CACHE_X
argument_list|(
name|ipd_port
argument_list|)
expr_stmt|;
return|return
name|ipd2pko_port_cache
index|[
name|ipd_y
index|]
index|[
operator|(
name|ipd_port
operator|&
literal|0x800
operator|)
condition|?
operator|(
operator|(
name|ipd_x
operator|>>
literal|4
operator|)
operator|&
literal|3
operator|)
else|:
name|ipd_x
index|]
operator|.
name|ccppp_base_port
return|;
block|}
end_function

begin_function
name|int
name|cvmx_helper_cfg_ipd2pko_port_num
parameter_list|(
name|int
name|ipd_port
parameter_list|)
block|{
name|int
name|ipd_y
decl_stmt|,
name|ipd_x
decl_stmt|;
name|ipd_y
operator|=
name|IPD2PKO_CACHE_Y
argument_list|(
name|ipd_port
argument_list|)
expr_stmt|;
name|ipd_x
operator|=
name|IPD2PKO_CACHE_X
argument_list|(
name|ipd_port
argument_list|)
expr_stmt|;
return|return
name|ipd2pko_port_cache
index|[
name|ipd_y
index|]
index|[
operator|(
name|ipd_port
operator|&
literal|0x800
operator|)
condition|?
operator|(
operator|(
name|ipd_x
operator|>>
literal|4
operator|)
operator|&
literal|3
operator|)
else|:
name|ipd_x
index|]
operator|.
name|ccppp_nports
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|CVMX_ENABLE_HELPER_FUNCTIONS
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|CVMX_USER_DEFINED_HELPER_CONFIG_INIT
end_ifdef

begin_comment
comment|/**  * Return the number of queues assigned to this pko_port by user  *  * @param pko_port  * @return the number of queues for this pko_port  *  * Note: Called after the pko_port map is set up.  */
end_comment

begin_function
specifier|static
name|int
name|__cvmx_ucfg_nqueues
parameter_list|(
name|int
name|pko_port
parameter_list|)
block|{
name|int
name|interface
decl_stmt|,
name|index
decl_stmt|;
name|int
name|i
decl_stmt|,
name|k
decl_stmt|;
name|interface
operator|=
name|__cvmx_helper_cfg_pko_port_interface
argument_list|(
name|pko_port
argument_list|)
expr_stmt|;
name|index
operator|=
name|__cvmx_helper_cfg_pko_port_index
argument_list|(
name|pko_port
argument_list|)
expr_stmt|;
comment|/*      * pko_port belongs to no physical port,      * don't assign a queue to it.      */
if|if
condition|(
name|interface
operator|==
name|CVMX_HELPER_CFG_INVALID_VALUE
operator|||
name|index
operator|==
name|CVMX_HELPER_CFG_INVALID_VALUE
condition|)
return|return
literal|0
return|;
comment|/*      * Assign the default number of queues to those pko_ports not      * assigned explicitly.      */
name|i
operator|=
name|cvmx_cfg_port
index|[
name|interface
index|]
index|[
name|index
index|]
operator|.
name|ccpp_pko_nqueues
expr_stmt|;
if|if
condition|(
name|i
operator|==
operator|(
name|uint8_t
operator|)
name|CVMX_HELPER_CFG_INVALID_VALUE
condition|)
return|return
name|cvmx_cfg_default_pko_nqueues
return|;
comment|/*      * The user has assigned nqueues to this pko_port,      * recorded in the pool.      */
name|k
operator|=
name|pko_port
operator|-
name|cvmx_cfg_port
index|[
name|interface
index|]
index|[
name|index
index|]
operator|.
name|ccpp_pko_port_base
expr_stmt|;
name|cvmx_helper_cfg_assert
argument_list|(
name|k
operator|<
name|cvmx_cfg_port
index|[
name|interface
index|]
index|[
name|index
index|]
operator|.
name|ccpp_pko_num_ports
argument_list|)
expr_stmt|;
return|return
name|cvmx_cfg_pko_nqueue_pool
index|[
name|i
operator|+
name|k
index|]
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/**  * Return the number of queues to be assigned to this pko_port  *  * @param pko_port  * @return the number of queues for this pko_port  *  * Note: This function exists for backward compatibility.  * CVMX_PKO_QUEUES_PER_PORT_XXXX defines no of queues per HW port.  * pko_port is equivalent in pre-o68 SDK.  */
end_comment

begin_function
specifier|static
name|int
name|cvmx_helper_cfg_dft_nqueues
parameter_list|(
name|int
name|pko_port
parameter_list|)
block|{
name|cvmx_helper_interface_mode_t
name|mode
decl_stmt|;
name|int
name|interface
decl_stmt|;
name|int
name|n
decl_stmt|;
ifndef|#
directive|ifndef
name|CVMX_HELPER_PKO_QUEUES_PER_PORT_INTERFACE0
define|#
directive|define
name|CVMX_HELPER_PKO_QUEUES_PER_PORT_INTERFACE0
value|1
endif|#
directive|endif
ifndef|#
directive|ifndef
name|CVMX_HELPER_PKO_QUEUES_PER_PORT_INTERFACE1
define|#
directive|define
name|CVMX_HELPER_PKO_QUEUES_PER_PORT_INTERFACE1
value|1
endif|#
directive|endif
ifndef|#
directive|ifndef
name|CVMX_HELPER_PKO_QUEUES_PER_PORT_INTERFACE2
define|#
directive|define
name|CVMX_HELPER_PKO_QUEUES_PER_PORT_INTERFACE2
value|1
endif|#
directive|endif
ifndef|#
directive|ifndef
name|CVMX_HELPER_PKO_QUEUES_PER_PORT_INTERFACE3
define|#
directive|define
name|CVMX_HELPER_PKO_QUEUES_PER_PORT_INTERFACE3
value|1
endif|#
directive|endif
ifndef|#
directive|ifndef
name|CVMX_HELPER_PKO_QUEUES_PER_PORT_INTERFACE4
define|#
directive|define
name|CVMX_HELPER_PKO_QUEUES_PER_PORT_INTERFACE4
value|1
endif|#
directive|endif
name|n
operator|=
literal|1
expr_stmt|;
name|interface
operator|=
name|__cvmx_helper_cfg_pko_port_interface
argument_list|(
name|pko_port
argument_list|)
expr_stmt|;
if|if
condition|(
name|interface
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|CVMX_PKO_QUEUES_PER_PORT_INTERFACE0
name|n
operator|=
name|CVMX_PKO_QUEUES_PER_PORT_INTERFACE0
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|interface
operator|==
literal|1
condition|)
block|{
ifdef|#
directive|ifdef
name|CVMX_PKO_QUEUES_PER_PORT_INTERFACE1
name|n
operator|=
name|CVMX_PKO_QUEUES_PER_PORT_INTERFACE1
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|interface
operator|==
literal|2
condition|)
block|{
ifdef|#
directive|ifdef
name|CVMX_PKO_QUEUES_PER_PORT_INTERFACE2
name|n
operator|=
name|CVMX_PKO_QUEUES_PER_PORT_INTERFACE2
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|interface
operator|==
literal|3
condition|)
block|{
ifdef|#
directive|ifdef
name|CVMX_PKO_QUEUES_PER_PORT_INTERFACE3
name|n
operator|=
name|CVMX_PKO_QUEUES_PER_PORT_INTERFACE3
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|interface
operator|==
literal|4
condition|)
block|{
ifdef|#
directive|ifdef
name|CVMX_PKO_QUEUES_PER_PORT_INTERFACE4
name|n
operator|=
name|CVMX_PKO_QUEUES_PER_PORT_INTERFACE4
expr_stmt|;
endif|#
directive|endif
block|}
name|mode
operator|=
name|cvmx_helper_interface_get_mode
argument_list|(
name|interface
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|==
name|CVMX_HELPER_INTERFACE_MODE_LOOP
condition|)
block|{
ifdef|#
directive|ifdef
name|CVMX_PKO_QUEUES_PER_PORT_LOOP
name|n
operator|=
name|CVMX_PKO_QUEUES_PER_PORT_LOOP
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|mode
operator|==
name|CVMX_HELPER_INTERFACE_MODE_NPI
condition|)
block|{
ifdef|#
directive|ifdef
name|CVMX_PKO_QUEUES_PER_PORT_PCI
name|n
operator|=
name|CVMX_PKO_QUEUES_PER_PORT_PCI
expr_stmt|;
endif|#
directive|endif
block|}
return|return
name|n
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CVMX_USER_DEFINED_HELPER_CONFIG_INIT */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CVMX_ENABLE_HELPER_FUNCTIONS */
end_comment

begin_function
name|int
name|__cvmx_helper_cfg_init
parameter_list|(
name|void
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CVMX_ENABLE_HELPER_FUNCTIONS
name|struct
name|cvmx_cfg_port_param
modifier|*
name|pport
decl_stmt|;
name|int
name|cvmx_cfg_default_pko_nports
decl_stmt|;
name|int
name|pknd
decl_stmt|,
name|bpid
decl_stmt|,
name|pko_port_base
decl_stmt|;
name|int
name|qbase
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|n
decl_stmt|;
name|cvmx_cfg_default_pko_nports
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|__cvmx_helper_cfg_init_common
argument_list|()
condition|)
return|return
literal|0
return|;
ifdef|#
directive|ifdef
name|CVMX_ENABLE_HELPER_FUNCTIONS
ifdef|#
directive|ifdef
name|CVMX_USER_DEFINED_HELPER_CONFIG_INIT
block|{
name|int
name|cvmx_ucfg_nq
decl_stmt|;
name|cvmx_ucfg_nq
operator|=
literal|0
expr_stmt|;
include|#
directive|include
file|"cvmx-helper-cfg-init.c"
block|}
endif|#
directive|endif
comment|/*      * per-port parameters      */
name|pknd
operator|=
literal|0
expr_stmt|;
name|bpid
operator|=
literal|0
expr_stmt|;
name|pko_port_base
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cvmx_helper_get_number_of_interfaces
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|n
operator|=
name|cvmx_helper_interface_enumerate
argument_list|(
name|i
argument_list|)
expr_stmt|;
name|pport
operator|=
name|cvmx_cfg_port
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|n
condition|;
name|j
operator|++
operator|,
name|pport
operator|++
control|)
block|{
name|int
name|t
decl_stmt|;
name|t
operator|=
name|cvmx_cfg_default_pko_nports
expr_stmt|;
if|if
condition|(
name|pport
operator|->
name|ccpp_pko_num_ports
operator|!=
name|CVMX_HELPER_CFG_INVALID_VALUE
condition|)
name|t
operator|=
name|pport
operator|->
name|ccpp_pko_num_ports
expr_stmt|;
operator|*
name|pport
operator|=
operator|(
expr|struct
name|cvmx_cfg_port_param
operator|)
block|{
name|pknd
operator|++
block|,
name|bpid
operator|++
block|,
name|pko_port_base
block|,
name|t
block|,
name|pport
operator|->
name|ccpp_pko_nqueues
block|}
expr_stmt|;
name|pko_port_base
operator|+=
name|t
expr_stmt|;
block|}
block|}
name|cvmx_helper_cfg_assert
argument_list|(
name|pknd
operator|<=
name|CVMX_HELPER_CFG_MAX_PIP_PKND
argument_list|)
expr_stmt|;
name|cvmx_helper_cfg_assert
argument_list|(
name|bpid
operator|<=
name|CVMX_HELPER_CFG_MAX_PIP_BPID
argument_list|)
expr_stmt|;
name|cvmx_helper_cfg_assert
argument_list|(
name|pko_port_base
operator|<=
name|CVMX_HELPER_CFG_MAX_PKO_PORT
argument_list|)
expr_stmt|;
comment|/*      * pko_port map      */
name|cvmx_helper_cfg_init_pko_port_map
argument_list|()
expr_stmt|;
comment|/*      * per-pko_port parameters      */
name|qbase
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pko_port_base
condition|;
name|i
operator|++
control|)
block|{
ifdef|#
directive|ifdef
name|CVMX_USER_DEFINED_HELPER_CONFIG_INIT
name|n
operator|=
name|__cvmx_ucfg_nqueues
argument_list|(
name|i
argument_list|)
expr_stmt|;
else|#
directive|else
name|n
operator|=
name|cvmx_helper_cfg_dft_nqueues
argument_list|(
name|i
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|cvmx_cfg_pko_port
index|[
name|i
index|]
operator|=
operator|(
expr|struct
name|cvmx_cfg_pko_port_param
operator|)
block|{
name|qbase
block|,
name|n
block|}
expr_stmt|;
name|qbase
operator|+=
name|n
expr_stmt|;
name|cvmx_helper_cfg_assert
argument_list|(
name|qbase
operator|<=
name|CVMX_HELPER_CFG_MAX_PKO_QUEUES
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CVMX_ENABLE_PKO_FUNCTIONS
name|__cvmx_helper_cfg_init_ipd2pko_cache
argument_list|()
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|CVMX_HELPER_CFG_DEBUG
name|cvmx_helper_cfg_show_cfg
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|/* CVMX_HELPER_CFG_DEBUG */
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

end_unit


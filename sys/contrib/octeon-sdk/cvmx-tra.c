begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/***********************license start***************  * Copyright (c) 2003-2010  Cavium Inc. (support@cavium.com). All rights  * reserved.  *  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions are  * met:  *  *   * Redistributions of source code must retain the above copyright  *     notice, this list of conditions and the following disclaimer.  *  *   * Redistributions in binary form must reproduce the above  *     copyright notice, this list of conditions and the following  *     disclaimer in the documentation and/or other materials provided  *     with the distribution.   *   * Neither the name of Cavium Inc. nor the names of  *     its contributors may be used to endorse or promote products  *     derived from this software without specific prior written  *     permission.   * This Software, including technical data, may be subject to U.S. export  control  * laws, including the U.S. Export Administration Act and its  associated  * regulations, and may be subject to export or import  regulations in other  * countries.   * TO THE MAXIMUM EXTENT PERMITTED BY LAW, THE SOFTWARE IS PROVIDED "AS IS"  * AND WITH ALL FAULTS AND CAVIUM INC. MAKES NO PROMISES, REPRESENTATIONS OR  * WARRANTIES, EITHER EXPRESS, IMPLIED, STATUTORY, OR OTHERWISE, WITH RESPECT TO  * THE SOFTWARE, INCLUDING ITS CONDITION, ITS CONFORMITY TO ANY REPRESENTATION OR  * DESCRIPTION, OR THE EXISTENCE OF ANY LATENT OR PATENT DEFECTS, AND CAVIUM  * SPECIFICALLY DISCLAIMS ALL IMPLIED (IF ANY) WARRANTIES OF TITLE,  * MERCHANTABILITY, NONINFRINGEMENT, FITNESS FOR A PARTICULAR PURPOSE, LACK OF  * VIRUSES, ACCURACY OR COMPLETENESS, QUIET ENJOYMENT, QUIET POSSESSION OR  * CORRESPONDENCE TO DESCRIPTION. THE ENTIRE  RISK ARISING OUT OF USE OR  * PERFORMANCE OF THE SOFTWARE LIES WITH YOU.  ***********************license end**************************************/
end_comment

begin_comment
comment|/**  * @file  *  * Interface to the Trace buffer hardware.  *  *<hr>$Revision: 30644 $<hr>  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CVMX_BUILD_FOR_LINUX_KERNEL
end_ifdef

begin_include
include|#
directive|include
file|<linux/module.h>
end_include

begin_include
include|#
directive|include
file|<asm/octeon/cvmx.h>
end_include

begin_include
include|#
directive|include
file|<asm/octeon/cvmx-tra.h>
end_include

begin_include
include|#
directive|include
file|<asm/octeon/cvmx-l2c.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|"cvmx.h"
end_include

begin_include
include|#
directive|include
file|"cvmx-tra.h"
end_include

begin_include
include|#
directive|include
file|"cvmx-l2c.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|TYPE_ARRAY
index|[]
init|=
block|{
literal|"DWB - Don't write back"
block|,
literal|"PL2 - Prefetch into L2"
block|,
literal|"PSL1 - Dcache fill, skip L2"
block|,
literal|"LDD - Dcache fill"
block|,
literal|"LDI - Icache/IO fill"
block|,
literal|"LDT - Icache/IO fill, skip L2"
block|,
literal|"STF - Store full"
block|,
literal|"STC - Store conditional"
block|,
literal|"STP - Store partial"
block|,
literal|"STT - Store full, skip L2"
block|,
literal|"IOBLD8 - IOB 8bit load"
block|,
literal|"IOBLD16 - IOB 16bit load"
block|,
literal|"IOBLD32 - IOB 32bit load"
block|,
literal|"IOBLD64 - IOB 64bit load"
block|,
literal|"IOBST - IOB store"
block|,
literal|"IOBDMA - Async IOB"
block|,
literal|"SAA - Store atomic add"
block|,
literal|"RSVD17"
block|,
literal|"RSVD18"
block|,
literal|"RSVD19"
block|,
literal|"RSVD20"
block|,
literal|"RSVD21"
block|,
literal|"RSVD22"
block|,
literal|"RSVD23"
block|,
literal|"RSVD24"
block|,
literal|"RSVD25"
block|,
literal|"RSVD26"
block|,
literal|"RSVD27"
block|,
literal|"RSVD28"
block|,
literal|"RSVD29"
block|,
literal|"RSVD30"
block|,
literal|"RSVD31"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|TYPE_ARRAY2
index|[]
init|=
block|{
literal|"NOP - None"
block|,
literal|"LDT - Icache/IO fill, skip L2"
block|,
literal|"LDI - Icache/IO fill"
block|,
literal|"PL2 - Prefetch into L2"
block|,
literal|"RPL2 - Mark for replacement in L2"
block|,
literal|"DWB - Don't write back"
block|,
literal|"RSVD6"
block|,
literal|"RSVD7"
block|,
literal|"LDD - Dcache fill"
block|,
literal|"PSL1 - Prefetch L1, skip L2"
block|,
literal|"RSVD10"
block|,
literal|"RSVD11"
block|,
literal|"RSVD12"
block|,
literal|"RSVD13"
block|,
literal|"RSVD14"
block|,
literal|"IOBDMA - Async IOB"
block|,
literal|"STF - Store full"
block|,
literal|"STT - Store full, skip L2"
block|,
literal|"STP - Store partial"
block|,
literal|"STC - Store conditional"
block|,
literal|"STFIL1 - Store full, invalidate L1"
block|,
literal|"STTIL1 - Store full, skip L2, invalidate L1"
block|,
literal|"FAS32 - Atomic 32bit swap"
block|,
literal|"FAS64 - Atomic 64bit swap"
block|,
literal|"WBIL2i - Writeback, invalidate, by index/way"
block|,
literal|"LTGL2i - Read tag@index/way"
block|,
literal|"STGL2i - Write tag@index/way"
block|,
literal|"RSVD27"
block|,
literal|"INVL2 - Invalidate, by address"
block|,
literal|"WBIL2 - Writeback, invalidate, by address"
block|,
literal|"WBL2 - Writeback, by address"
block|,
literal|"LCKL2 - Allocate, lock, by address"
block|,
literal|"IOBLD8 - IOB 8bit load"
block|,
literal|"IOBLD16 - IOB 16bit load"
block|,
literal|"IOBLD32 - IOB 32bit load"
block|,
literal|"IOBLD64 - IOB 64bit load"
block|,
literal|"IOBST8 - IOB 8bit store"
block|,
literal|"IOBST16 - IOB 16bit store"
block|,
literal|"IOBST32 - IOB 32bit store"
block|,
literal|"IOBST64 - IOB 64bit store"
block|,
literal|"SET8 - 8bit Atomic swap with 1's"
block|,
literal|"SET16 - 16bit Atomic swap with 1's"
block|,
literal|"SET32 - 32bit Atomic swap with 1's"
block|,
literal|"SET64 - 64bit Atomic swap with 1's"
block|,
literal|"CLR8 - 8bit Atomic swap with 0's"
block|,
literal|"CLR16 - 16bit Atomic swap with 0's"
block|,
literal|"CLR32 - 32bit Atomic swap with 0's"
block|,
literal|"CLR64 - 64bit Atomic swap with 0's"
block|,
literal|"INCR8 - 8bit Atomic fetch& add by 1"
block|,
literal|"INCR16 - 16bit Atomic fetch& add by 1"
block|,
literal|"INCR32 - 32bit Atomic fetch& add by 1"
block|,
literal|"INCR64 - 64bit Atomic fetch& add by 1"
block|,
literal|"DECR8 - 8bit Atomic fetch& add by -1"
block|,
literal|"DECR16 - 16bit Atomic fetch& add by -1"
block|,
literal|"DECR32 - 32bit Atomic fetch& add by -1"
block|,
literal|"DECR64 - 64bit Atomic fetch& add by -1"
block|,
literal|"RSVD56"
block|,
literal|"RSVD57"
block|,
literal|"FAA32 - 32bit Atomic fetch and add"
block|,
literal|"FAA64 - 64bit Atomic fetch and add"
block|,
literal|"RSVD60"
block|,
literal|"RSVD61"
block|,
literal|"SAA32 - 32bit Atomic add"
block|,
literal|"SAA64 - 64bit Atomic add"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|SOURCE_ARRAY
index|[]
init|=
block|{
literal|"PP0"
block|,
literal|"PP1"
block|,
literal|"PP2"
block|,
literal|"PP3"
block|,
literal|"PP4"
block|,
literal|"PP5"
block|,
literal|"PP6"
block|,
literal|"PP7"
block|,
literal|"PP8"
block|,
literal|"PP9"
block|,
literal|"PP10"
block|,
literal|"PP11"
block|,
literal|"PP12"
block|,
literal|"PP13"
block|,
literal|"PP14"
block|,
literal|"PP15"
block|,
literal|"PIP/IPD"
block|,
literal|"PKO-R"
block|,
literal|"FPA/TIM/DFA/PCI/ZIP/POW/PKO-W"
block|,
literal|"DWB"
block|,
literal|"RSVD20"
block|,
literal|"RSVD21"
block|,
literal|"RSVD22"
block|,
literal|"RSVD23"
block|,
literal|"RSVD24"
block|,
literal|"RSVD25"
block|,
literal|"RSVD26"
block|,
literal|"RSVD27"
block|,
literal|"RSVD28"
block|,
literal|"RSVD29"
block|,
literal|"RSVD30"
block|,
literal|"RSVD31"
block|,
literal|"PP16"
block|,
literal|"PP17"
block|,
literal|"PP18"
block|,
literal|"PP19"
block|,
literal|"PP20"
block|,
literal|"PP21"
block|,
literal|"PP22"
block|,
literal|"PP23"
block|,
literal|"PP24"
block|,
literal|"PP25"
block|,
literal|"PP26"
block|,
literal|"PP27"
block|,
literal|"PP28"
block|,
literal|"PP29"
block|,
literal|"PP30"
block|,
literal|"PP31"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|DEST_ARRAY
index|[]
init|=
block|{
literal|"CIU/GPIO"
block|,
literal|"RSVD1"
block|,
literal|"RSVD2"
block|,
literal|"PCI/PCIe/SLI"
block|,
literal|"KEY"
block|,
literal|"FPA"
block|,
literal|"DFA"
block|,
literal|"ZIP"
block|,
literal|"RNG"
block|,
literal|"IPD"
block|,
literal|"PKO"
block|,
literal|"RSVD11"
block|,
literal|"POW"
block|,
literal|"USB0"
block|,
literal|"RAD"
block|,
literal|"RSVD15"
block|,
literal|"RSVD16"
block|,
literal|"RSVD17"
block|,
literal|"RSVD18"
block|,
literal|"RSVD19"
block|,
literal|"RSVD20"
block|,
literal|"RSVD21"
block|,
literal|"RSVD22"
block|,
literal|"RSVD23"
block|,
literal|"RSVD24"
block|,
literal|"RSVD25"
block|,
literal|"RSVD26"
block|,
literal|"DPI"
block|,
literal|"RSVD28"
block|,
literal|"RSVD29"
block|,
literal|"FAU"
block|,
literal|"RSVD31"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|_cvmx_tra_unit
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CVMX_TRA_SOURCE_MASK
value|(OCTEON_IS_MODEL(OCTEON_CN63XX) ? 0xf00ff : 0xfffff)
end_define

begin_define
define|#
directive|define
name|CVMX_TRA_DESTINATION_MASK
value|0xfffffffful
end_define

begin_comment
comment|/**  * @INTERNAL  * Setup the trace buffer filter command mask. The bit position of filter commands  * are different for each Octeon model.  *  * @param filter    Which event to log  * @return          Bitmask of filter command based on the event.  */
end_comment

begin_function
specifier|static
name|uint64_t
name|__cvmx_tra_set_filter_cmd_mask
parameter_list|(
name|cvmx_tra_filt_t
name|filter
parameter_list|)
block|{
name|cvmx_tra_filt_cmd_t
name|filter_command
decl_stmt|;
if|if
condition|(
name|OCTEON_IS_MODEL
argument_list|(
name|OCTEON_CN3XXX
argument_list|)
operator|||
name|OCTEON_IS_MODEL
argument_list|(
name|OCTEON_CN5XXX
argument_list|)
condition|)
block|{
comment|/* Bit positions of filter commands are different, map it accordingly */
name|uint64_t
name|cmd
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|filter
operator|&
name|CVMX_TRA_FILT_ALL
operator|)
operator|==
operator|-
literal|1ull
condition|)
block|{
if|if
condition|(
name|OCTEON_IS_MODEL
argument_list|(
name|OCTEON_CN5XXX
argument_list|)
condition|)
name|cmd
operator|=
literal|0x1ffff
expr_stmt|;
else|else
name|cmd
operator|=
literal|0xffff
expr_stmt|;
block|}
if|if
condition|(
name|filter
operator|&
name|CVMX_TRA_FILT_DWB
condition|)
name|cmd
operator||=
literal|1ull
operator|<<
literal|0
expr_stmt|;
if|if
condition|(
name|filter
operator|&
name|CVMX_TRA_FILT_PL2
condition|)
name|cmd
operator||=
literal|1ull
operator|<<
literal|1
expr_stmt|;
if|if
condition|(
name|filter
operator|&
name|CVMX_TRA_FILT_PSL1
condition|)
name|cmd
operator||=
literal|1ull
operator|<<
literal|2
expr_stmt|;
if|if
condition|(
name|filter
operator|&
name|CVMX_TRA_FILT_LDD
condition|)
name|cmd
operator||=
literal|1ull
operator|<<
literal|3
expr_stmt|;
if|if
condition|(
name|filter
operator|&
name|CVMX_TRA_FILT_LDI
condition|)
name|cmd
operator||=
literal|1ull
operator|<<
literal|4
expr_stmt|;
if|if
condition|(
name|filter
operator|&
name|CVMX_TRA_FILT_LDT
condition|)
name|cmd
operator||=
literal|1ull
operator|<<
literal|5
expr_stmt|;
if|if
condition|(
name|filter
operator|&
name|CVMX_TRA_FILT_STF
condition|)
name|cmd
operator||=
literal|1ull
operator|<<
literal|6
expr_stmt|;
if|if
condition|(
name|filter
operator|&
name|CVMX_TRA_FILT_STC
condition|)
name|cmd
operator||=
literal|1ull
operator|<<
literal|7
expr_stmt|;
if|if
condition|(
name|filter
operator|&
name|CVMX_TRA_FILT_STP
condition|)
name|cmd
operator||=
literal|1ull
operator|<<
literal|8
expr_stmt|;
if|if
condition|(
name|filter
operator|&
name|CVMX_TRA_FILT_STT
condition|)
name|cmd
operator||=
literal|1ull
operator|<<
literal|9
expr_stmt|;
if|if
condition|(
name|filter
operator|&
name|CVMX_TRA_FILT_IOBLD8
condition|)
name|cmd
operator||=
literal|1ull
operator|<<
literal|10
expr_stmt|;
if|if
condition|(
name|filter
operator|&
name|CVMX_TRA_FILT_IOBLD16
condition|)
name|cmd
operator||=
literal|1ull
operator|<<
literal|11
expr_stmt|;
if|if
condition|(
name|filter
operator|&
name|CVMX_TRA_FILT_IOBLD32
condition|)
name|cmd
operator||=
literal|1ull
operator|<<
literal|12
expr_stmt|;
if|if
condition|(
name|filter
operator|&
name|CVMX_TRA_FILT_IOBLD64
condition|)
name|cmd
operator||=
literal|1ull
operator|<<
literal|13
expr_stmt|;
if|if
condition|(
name|filter
operator|&
name|CVMX_TRA_FILT_IOBST
condition|)
name|cmd
operator||=
literal|1ull
operator|<<
literal|14
expr_stmt|;
if|if
condition|(
name|filter
operator|&
name|CVMX_TRA_FILT_IOBDMA
condition|)
name|cmd
operator||=
literal|1ull
operator|<<
literal|15
expr_stmt|;
if|if
condition|(
name|OCTEON_IS_MODEL
argument_list|(
name|OCTEON_CN5XXX
argument_list|)
operator|&&
operator|(
name|filter
operator|&
name|CVMX_TRA_FILT_SAA
operator|)
condition|)
name|cmd
operator||=
literal|1ull
operator|<<
literal|16
expr_stmt|;
name|filter_command
operator|.
name|u64
operator|=
name|cmd
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|filter
operator|&
name|CVMX_TRA_FILT_ALL
operator|)
operator|==
operator|-
literal|1ull
condition|)
name|filter_command
operator|.
name|u64
operator|=
name|CVMX_TRA_FILT_ALL
expr_stmt|;
else|else
name|filter_command
operator|.
name|u64
operator|=
name|filter
expr_stmt|;
name|filter_command
operator|.
name|cn63xx
operator|.
name|reserved_60_61
operator|=
literal|0
expr_stmt|;
name|filter_command
operator|.
name|cn63xx
operator|.
name|reserved_56_57
operator|=
literal|0
expr_stmt|;
name|filter_command
operator|.
name|cn63xx
operator|.
name|reserved_27_27
operator|=
literal|0
expr_stmt|;
name|filter_command
operator|.
name|cn63xx
operator|.
name|reserved_10_14
operator|=
literal|0
expr_stmt|;
name|filter_command
operator|.
name|cn63xx
operator|.
name|reserved_6_7
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|filter_command
operator|.
name|u64
return|;
block|}
end_function

begin_comment
comment|/**  * Setup the TRA buffer for use  *  * @param control TRA control setup  * @param filter  Which events to log  * @param source_filter  *                Source match  * @param dest_filter  *                Destination match  * @param address Address compare  * @param address_mask  *                Address mask  */
end_comment

begin_function
name|void
name|cvmx_tra_setup
parameter_list|(
name|cvmx_tra_ctl_t
name|control
parameter_list|,
name|cvmx_tra_filt_t
name|filter
parameter_list|,
name|cvmx_tra_sid_t
name|source_filter
parameter_list|,
name|cvmx_tra_did_t
name|dest_filter
parameter_list|,
name|uint64_t
name|address
parameter_list|,
name|uint64_t
name|address_mask
parameter_list|)
block|{
name|cvmx_tra_filt_cmd_t
name|filt_cmd
decl_stmt|;
name|cvmx_tra_filt_sid_t
name|filt_sid
decl_stmt|;
name|cvmx_tra_filt_did_t
name|filt_did
decl_stmt|;
name|int
name|tad
decl_stmt|;
name|filt_cmd
operator|.
name|u64
operator|=
name|__cvmx_tra_set_filter_cmd_mask
argument_list|(
name|filter
argument_list|)
expr_stmt|;
name|filt_sid
operator|.
name|u64
operator|=
name|source_filter
operator|&
name|CVMX_TRA_SOURCE_MASK
expr_stmt|;
name|filt_did
operator|.
name|u64
operator|=
name|dest_filter
operator|&
name|CVMX_TRA_DESTINATION_MASK
expr_stmt|;
comment|/* Address filtering does not work when IOBDMA filter command is enabled        because of some caveats.  Disable the IOBDMA filter command. */
if|if
condition|(
operator|(
name|OCTEON_IS_MODEL
argument_list|(
name|OCTEON_CN6XXX
argument_list|)
operator|||
name|OCTEON_IS_MODEL
argument_list|(
name|OCTEON_CNF7XXX
argument_list|)
operator|)
operator|&&
operator|(
operator|(
name|filt_cmd
operator|.
name|u64
operator|&
name|CVMX_TRA_FILT_IOBDMA
operator|)
operator|==
name|CVMX_TRA_FILT_IOBDMA
operator|)
operator|&&
name|address_mask
operator|!=
literal|0
condition|)
block|{
name|cvmx_dprintf
argument_list|(
literal|"The address-based filtering does not work with IOBDMAs, disabling the filter command.\n"
argument_list|)
expr_stmt|;
name|filt_cmd
operator|.
name|u64
operator|&=
operator|~
operator|(
name|CVMX_TRA_FILT_IOBDMA
operator|)
expr_stmt|;
block|}
comment|/* In OcteonII pass2, the mode bit is added to enable reading the trace         buffer data from different registers for lower and upper 64-bit value.        This bit is reserved in other Octeon models. */
name|control
operator|.
name|s
operator|.
name|rdat_md
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|tad
operator|=
literal|0
init|;
name|tad
operator|<
name|CVMX_L2C_TADS
condition|;
name|tad
operator|++
control|)
block|{
name|cvmx_write_csr
argument_list|(
name|CVMX_TRAX_CTL
argument_list|(
name|tad
argument_list|)
argument_list|,
name|control
operator|.
name|u64
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_TRAX_FILT_CMD
argument_list|(
name|tad
argument_list|)
argument_list|,
name|filt_cmd
operator|.
name|u64
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_TRAX_FILT_SID
argument_list|(
name|tad
argument_list|)
argument_list|,
name|filt_sid
operator|.
name|u64
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_TRAX_FILT_DID
argument_list|(
name|tad
argument_list|)
argument_list|,
name|filt_did
operator|.
name|u64
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_TRAX_FILT_ADR_ADR
argument_list|(
name|tad
argument_list|)
argument_list|,
name|address
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_TRAX_FILT_ADR_MSK
argument_list|(
name|tad
argument_list|)
argument_list|,
name|address_mask
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CVMX_BUILD_FOR_LINUX_KERNEL
end_ifdef

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|cvmx_tra_setup
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/**  * Setup each TRA buffer for use  *  * @param tra     Which TRA buffer to use (0-3)  * @param control TRA control setup  * @param filter  Which events to log  * @param source_filter  *                Source match  * @param dest_filter  *                Destination match  * @param address Address compare  * @param address_mask  *                Address mask  */
end_comment

begin_function
name|void
name|cvmx_tra_setup_v2
parameter_list|(
name|int
name|tra
parameter_list|,
name|cvmx_tra_ctl_t
name|control
parameter_list|,
name|cvmx_tra_filt_t
name|filter
parameter_list|,
name|cvmx_tra_sid_t
name|source_filter
parameter_list|,
name|cvmx_tra_did_t
name|dest_filter
parameter_list|,
name|uint64_t
name|address
parameter_list|,
name|uint64_t
name|address_mask
parameter_list|)
block|{
name|cvmx_tra_filt_cmd_t
name|filt_cmd
decl_stmt|;
name|cvmx_tra_filt_sid_t
name|filt_sid
decl_stmt|;
name|cvmx_tra_filt_did_t
name|filt_did
decl_stmt|;
if|if
condition|(
operator|(
name|tra
operator|+
literal|1
operator|)
operator|>
name|CVMX_L2C_TADS
condition|)
block|{
name|cvmx_dprintf
argument_list|(
literal|"cvmx_tra_setup_per_tra: Invalid tra(%d), max allowed (%d)\n"
argument_list|,
name|tra
argument_list|,
name|CVMX_L2C_TADS
operator|-
literal|1
argument_list|)
expr_stmt|;
name|tra
operator|=
literal|0
expr_stmt|;
block|}
name|filt_cmd
operator|.
name|u64
operator|=
name|__cvmx_tra_set_filter_cmd_mask
argument_list|(
name|filter
argument_list|)
expr_stmt|;
name|filt_sid
operator|.
name|u64
operator|=
name|source_filter
operator|&
name|CVMX_TRA_SOURCE_MASK
expr_stmt|;
name|filt_did
operator|.
name|u64
operator|=
name|dest_filter
operator|&
name|CVMX_TRA_DESTINATION_MASK
expr_stmt|;
comment|/* Address filtering does not work when IOBDMA filter command is enabled        because of some caveats.  Disable the IOBDMA filter command. */
if|if
condition|(
operator|(
name|OCTEON_IS_MODEL
argument_list|(
name|OCTEON_CN6XXX
argument_list|)
operator|||
name|OCTEON_IS_MODEL
argument_list|(
name|OCTEON_CNF7XXX
argument_list|)
operator|)
operator|&&
operator|(
operator|(
name|filt_cmd
operator|.
name|u64
operator|&
name|CVMX_TRA_FILT_IOBDMA
operator|)
operator|==
name|CVMX_TRA_FILT_IOBDMA
operator|)
operator|&&
name|address_mask
operator|!=
literal|0
condition|)
block|{
name|cvmx_dprintf
argument_list|(
literal|"The address-based filtering does not work with IOBDMAs, disabling the filter command.\n"
argument_list|)
expr_stmt|;
name|filt_cmd
operator|.
name|u64
operator|&=
operator|~
operator|(
name|CVMX_TRA_FILT_IOBDMA
operator|)
expr_stmt|;
block|}
comment|/* In OcteonII pass2, the mode bit is added to enable reading the trace         buffer data from different registers for lower and upper 64-bit value.        This bit is reserved in other Octeon models. */
name|control
operator|.
name|s
operator|.
name|rdat_md
operator|=
literal|1
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_TRAX_CTL
argument_list|(
name|tra
argument_list|)
argument_list|,
name|control
operator|.
name|u64
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_TRAX_FILT_CMD
argument_list|(
name|tra
argument_list|)
argument_list|,
name|filt_cmd
operator|.
name|u64
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_TRAX_FILT_SID
argument_list|(
name|tra
argument_list|)
argument_list|,
name|filt_sid
operator|.
name|u64
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_TRAX_FILT_DID
argument_list|(
name|tra
argument_list|)
argument_list|,
name|filt_did
operator|.
name|u64
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_TRAX_FILT_ADR_ADR
argument_list|(
name|tra
argument_list|)
argument_list|,
name|address
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_TRAX_FILT_ADR_MSK
argument_list|(
name|tra
argument_list|)
argument_list|,
name|address_mask
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CVMX_BUILD_FOR_LINUX_KERNEL
end_ifdef

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|cvmx_tra_setup_v2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/**  * Setup a TRA trigger. How the triggers are used should be  * setup using cvmx_tra_setup.  *  * @param trigger Trigger to setup (0 or 1)  * @param filter  Which types of events to trigger on  * @param source_filter  *                Source trigger match  * @param dest_filter  *                Destination trigger match  * @param address Trigger address compare  * @param address_mask  *                Trigger address mask  */
end_comment

begin_function
name|void
name|cvmx_tra_trig_setup
parameter_list|(
name|uint64_t
name|trigger
parameter_list|,
name|cvmx_tra_filt_t
name|filter
parameter_list|,
name|cvmx_tra_sid_t
name|source_filter
parameter_list|,
name|cvmx_tra_did_t
name|dest_filter
parameter_list|,
name|uint64_t
name|address
parameter_list|,
name|uint64_t
name|address_mask
parameter_list|)
block|{
name|cvmx_tra_filt_cmd_t
name|tra_filt_cmd
decl_stmt|;
name|cvmx_tra_filt_sid_t
name|tra_filt_sid
decl_stmt|;
name|cvmx_tra_filt_did_t
name|tra_filt_did
decl_stmt|;
name|int
name|tad
decl_stmt|;
name|tra_filt_cmd
operator|.
name|u64
operator|=
name|__cvmx_tra_set_filter_cmd_mask
argument_list|(
name|filter
argument_list|)
expr_stmt|;
name|tra_filt_sid
operator|.
name|u64
operator|=
name|source_filter
operator|&
name|CVMX_TRA_SOURCE_MASK
expr_stmt|;
name|tra_filt_did
operator|.
name|u64
operator|=
name|dest_filter
operator|&
name|CVMX_TRA_DESTINATION_MASK
expr_stmt|;
comment|/* Address filtering does not work when IOBDMA filter command is enabled        because of some caveats.  Disable the IOBDMA filter command. */
if|if
condition|(
operator|(
name|OCTEON_IS_MODEL
argument_list|(
name|OCTEON_CN6XXX
argument_list|)
operator|||
name|OCTEON_IS_MODEL
argument_list|(
name|OCTEON_CNF7XXX
argument_list|)
operator|)
operator|&&
operator|(
operator|(
name|tra_filt_cmd
operator|.
name|u64
operator|&
name|CVMX_TRA_FILT_IOBDMA
operator|)
operator|==
name|CVMX_TRA_FILT_IOBDMA
operator|)
operator|&&
name|address_mask
operator|!=
literal|0
condition|)
block|{
name|cvmx_dprintf
argument_list|(
literal|"The address-based filtering does not work with IOBDMAs, disabling the filter command.\n"
argument_list|)
expr_stmt|;
name|tra_filt_cmd
operator|.
name|u64
operator|&=
operator|~
operator|(
name|CVMX_TRA_FILT_IOBDMA
operator|)
expr_stmt|;
block|}
for|for
control|(
name|tad
operator|=
literal|0
init|;
name|tad
operator|<
name|CVMX_L2C_TADS
condition|;
name|tad
operator|++
control|)
block|{
name|cvmx_write_csr
argument_list|(
name|CVMX_TRAX_TRIG0_CMD
argument_list|(
name|tad
argument_list|)
operator|+
name|trigger
operator|*
literal|64
argument_list|,
name|tra_filt_cmd
operator|.
name|u64
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_TRAX_TRIG0_SID
argument_list|(
name|tad
argument_list|)
operator|+
name|trigger
operator|*
literal|64
argument_list|,
name|tra_filt_sid
operator|.
name|u64
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_TRAX_TRIG0_DID
argument_list|(
name|tad
argument_list|)
operator|+
name|trigger
operator|*
literal|64
argument_list|,
name|tra_filt_did
operator|.
name|u64
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_TRAX_TRIG0_ADR_ADR
argument_list|(
name|tad
argument_list|)
operator|+
name|trigger
operator|*
literal|64
argument_list|,
name|address
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_TRAX_TRIG0_ADR_MSK
argument_list|(
name|tad
argument_list|)
operator|+
name|trigger
operator|*
literal|64
argument_list|,
name|address_mask
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CVMX_BUILD_FOR_LINUX_KERNEL
end_ifdef

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|cvmx_tra_trig_setup
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/**  * Setup each TRA trigger. How the triggers are used should be  * setup using cvmx_tra_setup.  *  * @param tra     Which TRA buffer to use (0-3)  * @param trigger Trigger to setup (0 or 1)  * @param filter  Which types of events to trigger on  * @param source_filter  *                Source trigger match  * @param dest_filter  *                Destination trigger match  * @param address Trigger address compare  * @param address_mask  *                Trigger address mask  */
end_comment

begin_function
name|void
name|cvmx_tra_trig_setup_v2
parameter_list|(
name|int
name|tra
parameter_list|,
name|uint64_t
name|trigger
parameter_list|,
name|cvmx_tra_filt_t
name|filter
parameter_list|,
name|cvmx_tra_sid_t
name|source_filter
parameter_list|,
name|cvmx_tra_did_t
name|dest_filter
parameter_list|,
name|uint64_t
name|address
parameter_list|,
name|uint64_t
name|address_mask
parameter_list|)
block|{
name|cvmx_tra_filt_cmd_t
name|tra_filt_cmd
decl_stmt|;
name|cvmx_tra_filt_sid_t
name|tra_filt_sid
decl_stmt|;
name|cvmx_tra_filt_did_t
name|tra_filt_did
decl_stmt|;
name|tra_filt_cmd
operator|.
name|u64
operator|=
name|__cvmx_tra_set_filter_cmd_mask
argument_list|(
name|filter
argument_list|)
expr_stmt|;
name|tra_filt_sid
operator|.
name|u64
operator|=
name|source_filter
operator|&
name|CVMX_TRA_SOURCE_MASK
expr_stmt|;
name|tra_filt_did
operator|.
name|u64
operator|=
name|dest_filter
operator|&
name|CVMX_TRA_DESTINATION_MASK
expr_stmt|;
comment|/* Address filtering does not work when IOBDMA filter command is enabled        because of some caveats.  Disable the IOBDMA filter command. */
if|if
condition|(
operator|(
name|OCTEON_IS_MODEL
argument_list|(
name|OCTEON_CN6XXX
argument_list|)
operator|||
name|OCTEON_IS_MODEL
argument_list|(
name|OCTEON_CNF7XXX
argument_list|)
operator|)
operator|&&
operator|(
operator|(
name|tra_filt_cmd
operator|.
name|u64
operator|&
name|CVMX_TRA_FILT_IOBDMA
operator|)
operator|==
name|CVMX_TRA_FILT_IOBDMA
operator|)
operator|&&
name|address_mask
operator|!=
literal|0
condition|)
block|{
name|cvmx_dprintf
argument_list|(
literal|"The address-based filtering does not work with IOBDMAs, disabling the filter command.\n"
argument_list|)
expr_stmt|;
name|tra_filt_cmd
operator|.
name|u64
operator|&=
operator|~
operator|(
name|CVMX_TRA_FILT_IOBDMA
operator|)
expr_stmt|;
block|}
name|cvmx_write_csr
argument_list|(
name|CVMX_TRAX_TRIG0_CMD
argument_list|(
name|tra
argument_list|)
operator|+
name|trigger
operator|*
literal|64
argument_list|,
name|tra_filt_cmd
operator|.
name|u64
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_TRAX_TRIG0_SID
argument_list|(
name|tra
argument_list|)
operator|+
name|trigger
operator|*
literal|64
argument_list|,
name|tra_filt_sid
operator|.
name|u64
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_TRAX_TRIG0_DID
argument_list|(
name|tra
argument_list|)
operator|+
name|trigger
operator|*
literal|64
argument_list|,
name|tra_filt_did
operator|.
name|u64
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_TRAX_TRIG0_ADR_ADR
argument_list|(
name|tra
argument_list|)
operator|+
name|trigger
operator|*
literal|64
argument_list|,
name|address
argument_list|)
expr_stmt|;
name|cvmx_write_csr
argument_list|(
name|CVMX_TRAX_TRIG0_ADR_MSK
argument_list|(
name|tra
argument_list|)
operator|+
name|trigger
operator|*
literal|64
argument_list|,
name|address_mask
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CVMX_BUILD_FOR_LINUX_KERNEL
end_ifdef

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|cvmx_tra_trig_setup_v2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/**  * Read an entry from the TRA buffer  *  * @return Value return. High bit will be zero if there wasn't any data  */
end_comment

begin_function
name|cvmx_tra_data_t
name|cvmx_tra_read
parameter_list|(
name|void
parameter_list|)
block|{
name|uint64_t
name|address
init|=
name|CVMX_TRA_READ_DAT
decl_stmt|;
name|cvmx_tra_data_t
name|result
decl_stmt|;
comment|/* The trace buffer format is wider than 64-bits in OcteonII model,        read the register again to get the second part of the data. */
if|if
condition|(
name|OCTEON_IS_MODEL
argument_list|(
name|OCTEON_CN63XX_PASS1_X
argument_list|)
condition|)
block|{
comment|/* These reads need to be as close as possible to each other */
name|result
operator|.
name|u128
operator|.
name|data
operator|=
name|cvmx_read_csr
argument_list|(
name|address
argument_list|)
expr_stmt|;
name|result
operator|.
name|u128
operator|.
name|datahi
operator|=
name|cvmx_read_csr
argument_list|(
name|address
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|OCTEON_IS_MODEL
argument_list|(
name|OCTEON_CN3XXX
argument_list|)
operator|&&
operator|!
name|OCTEON_IS_MODEL
argument_list|(
name|OCTEON_CN5XXX
argument_list|)
condition|)
block|{
comment|/* OcteonII pass2 uses different trace buffer data register for reading            lower and upper 64-bit values */
name|result
operator|.
name|u128
operator|.
name|data
operator|=
name|cvmx_read_csr
argument_list|(
name|address
argument_list|)
expr_stmt|;
name|result
operator|.
name|u128
operator|.
name|datahi
operator|=
name|cvmx_read_csr
argument_list|(
name|CVMX_TRA_READ_DAT_HI
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|result
operator|.
name|u128
operator|.
name|data
operator|=
name|cvmx_read_csr
argument_list|(
name|address
argument_list|)
expr_stmt|;
name|result
operator|.
name|u128
operator|.
name|datahi
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/**  * Read an entry from the TRA buffer from a given TRA unit.  *  * @param tra_unit  Trace buffer unit to read  *  * @return Value return. High bit will be zero if there wasn't any data  */
end_comment

begin_function
name|cvmx_tra_data_t
name|cvmx_tra_read_v2
parameter_list|(
name|int
name|tra_unit
parameter_list|)
block|{
name|cvmx_tra_data_t
name|result
decl_stmt|;
name|result
operator|.
name|u128
operator|.
name|data
operator|=
name|cvmx_read_csr
argument_list|(
name|CVMX_TRAX_READ_DAT
argument_list|(
name|tra_unit
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|.
name|u128
operator|.
name|datahi
operator|=
name|cvmx_read_csr
argument_list|(
name|CVMX_TRAX_READ_DAT_HI
argument_list|(
name|tra_unit
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/**  * Decode a TRA entry into human readable output  *  * @param tra_ctl Trace control setup  * @param data    Data to decode  */
end_comment

begin_function
name|void
name|cvmx_tra_decode_text
parameter_list|(
name|cvmx_tra_ctl_t
name|tra_ctl
parameter_list|,
name|cvmx_tra_data_t
name|data
parameter_list|)
block|{
if|if
condition|(
name|OCTEON_IS_MODEL
argument_list|(
name|OCTEON_CN3XXX
argument_list|)
operator|||
name|OCTEON_IS_MODEL
argument_list|(
name|OCTEON_CN5XXX
argument_list|)
condition|)
block|{
comment|/* The type is a five bit field for some entries and 4 for other. The four            bit entries can be mis-typed if the top is set */
name|int
name|type
init|=
name|data
operator|.
name|cmn
operator|.
name|type
decl_stmt|;
if|if
condition|(
name|type
operator|>=
literal|0x1a
condition|)
name|type
operator|&=
literal|0xf
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
literal|0
case|:
comment|/* DWB */
case|case
literal|1
case|:
comment|/* PL2 */
case|case
literal|2
case|:
comment|/* PSL1 */
case|case
literal|3
case|:
comment|/* LDD */
case|case
literal|4
case|:
comment|/* LDI */
case|case
literal|5
case|:
comment|/* LDT */
name|cvmx_dprintf
argument_list|(
literal|"0x%016llx %c%+10d %s %s 0x%016llx\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|u128
operator|.
name|data
argument_list|,
operator|(
name|data
operator|.
name|cmn
operator|.
name|discontinuity
operator|)
condition|?
literal|'D'
else|:
literal|' '
argument_list|,
name|data
operator|.
name|cmn
operator|.
name|timestamp
operator|<<
operator|(
name|tra_ctl
operator|.
name|s
operator|.
name|time_grn
operator|*
literal|3
operator|)
argument_list|,
name|TYPE_ARRAY
index|[
name|type
index|]
argument_list|,
name|SOURCE_ARRAY
index|[
name|data
operator|.
name|cmn
operator|.
name|source
index|]
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|cmn
operator|.
name|address
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
comment|/* STF */
case|case
literal|7
case|:
comment|/* STC */
case|case
literal|8
case|:
comment|/* STP */
case|case
literal|9
case|:
comment|/* STT */
case|case
literal|16
case|:
comment|/* SAA */
name|cvmx_dprintf
argument_list|(
literal|"0x%016llx %c%+10d %s %s mask=0x%02x 0x%016llx\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|u128
operator|.
name|data
argument_list|,
operator|(
name|data
operator|.
name|cmn
operator|.
name|discontinuity
operator|)
condition|?
literal|'D'
else|:
literal|' '
argument_list|,
name|data
operator|.
name|cmn
operator|.
name|timestamp
operator|<<
operator|(
name|tra_ctl
operator|.
name|s
operator|.
name|time_grn
operator|*
literal|3
operator|)
argument_list|,
name|TYPE_ARRAY
index|[
name|type
index|]
argument_list|,
name|SOURCE_ARRAY
index|[
name|data
operator|.
name|store
operator|.
name|source
index|]
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|data
operator|.
name|store
operator|.
name|mask
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|store
operator|.
name|address
operator|<<
literal|3
argument_list|)
expr_stmt|;
break|break;
case|case
literal|10
case|:
comment|/* IOBLD8 */
case|case
literal|11
case|:
comment|/* IOBLD16 */
case|case
literal|12
case|:
comment|/* IOBLD32 */
case|case
literal|13
case|:
comment|/* IOBLD64 */
case|case
literal|14
case|:
comment|/* IOBST */
name|cvmx_dprintf
argument_list|(
literal|"0x%016llx %c%+10d %s %s->%s subdid=0x%x 0x%016llx\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|u128
operator|.
name|data
argument_list|,
operator|(
name|data
operator|.
name|cmn
operator|.
name|discontinuity
operator|)
condition|?
literal|'D'
else|:
literal|' '
argument_list|,
name|data
operator|.
name|cmn
operator|.
name|timestamp
operator|<<
operator|(
name|tra_ctl
operator|.
name|s
operator|.
name|time_grn
operator|*
literal|3
operator|)
argument_list|,
name|TYPE_ARRAY
index|[
name|type
index|]
argument_list|,
name|SOURCE_ARRAY
index|[
name|data
operator|.
name|iobld
operator|.
name|source
index|]
argument_list|,
name|DEST_ARRAY
index|[
name|data
operator|.
name|iobld
operator|.
name|dest
index|]
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|data
operator|.
name|iobld
operator|.
name|subid
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|iobld
operator|.
name|address
argument_list|)
expr_stmt|;
break|break;
case|case
literal|15
case|:
comment|/* IOBDMA */
name|cvmx_dprintf
argument_list|(
literal|"0x%016llx %c%+10d %s %s->%s len=0x%x 0x%016llx\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|u128
operator|.
name|data
argument_list|,
operator|(
name|data
operator|.
name|cmn
operator|.
name|discontinuity
operator|)
condition|?
literal|'D'
else|:
literal|' '
argument_list|,
name|data
operator|.
name|cmn
operator|.
name|timestamp
operator|<<
operator|(
name|tra_ctl
operator|.
name|s
operator|.
name|time_grn
operator|*
literal|3
operator|)
argument_list|,
name|TYPE_ARRAY
index|[
name|type
index|]
argument_list|,
name|SOURCE_ARRAY
index|[
name|data
operator|.
name|iob
operator|.
name|source
index|]
argument_list|,
name|DEST_ARRAY
index|[
name|data
operator|.
name|iob
operator|.
name|dest
index|]
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|data
operator|.
name|iob
operator|.
name|mask
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|iob
operator|.
name|address
operator|<<
literal|3
argument_list|)
expr_stmt|;
break|break;
default|default:
name|cvmx_dprintf
argument_list|(
literal|"0x%016llx %c%+10d Unknown format\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|u128
operator|.
name|data
argument_list|,
operator|(
name|data
operator|.
name|cmn
operator|.
name|discontinuity
operator|)
condition|?
literal|'D'
else|:
literal|' '
argument_list|,
name|data
operator|.
name|cmn
operator|.
name|timestamp
operator|<<
operator|(
name|tra_ctl
operator|.
name|s
operator|.
name|time_grn
operator|*
literal|3
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|int
name|type
decl_stmt|;
name|int
name|srcId
decl_stmt|;
name|type
operator|=
name|data
operator|.
name|cmn2
operator|.
name|type
expr_stmt|;
switch|switch
condition|(
literal|1ull
operator|<<
name|type
condition|)
block|{
case|case
name|CVMX_TRA_FILT_DECR64
case|:
case|case
name|CVMX_TRA_FILT_DECR32
case|:
case|case
name|CVMX_TRA_FILT_DECR16
case|:
case|case
name|CVMX_TRA_FILT_DECR8
case|:
case|case
name|CVMX_TRA_FILT_INCR64
case|:
case|case
name|CVMX_TRA_FILT_INCR32
case|:
case|case
name|CVMX_TRA_FILT_INCR16
case|:
case|case
name|CVMX_TRA_FILT_INCR8
case|:
case|case
name|CVMX_TRA_FILT_CLR64
case|:
case|case
name|CVMX_TRA_FILT_CLR32
case|:
case|case
name|CVMX_TRA_FILT_CLR16
case|:
case|case
name|CVMX_TRA_FILT_CLR8
case|:
case|case
name|CVMX_TRA_FILT_SET64
case|:
case|case
name|CVMX_TRA_FILT_SET32
case|:
case|case
name|CVMX_TRA_FILT_SET16
case|:
case|case
name|CVMX_TRA_FILT_SET8
case|:
case|case
name|CVMX_TRA_FILT_LCKL2
case|:
case|case
name|CVMX_TRA_FILT_WBIL2
case|:
case|case
name|CVMX_TRA_FILT_INVL2
case|:
case|case
name|CVMX_TRA_FILT_STGL2I
case|:
case|case
name|CVMX_TRA_FILT_LTGL2I
case|:
case|case
name|CVMX_TRA_FILT_WBIL2I
case|:
case|case
name|CVMX_TRA_FILT_WBL2
case|:
case|case
name|CVMX_TRA_FILT_DWB
case|:
case|case
name|CVMX_TRA_FILT_RPL2
case|:
case|case
name|CVMX_TRA_FILT_PL2
case|:
case|case
name|CVMX_TRA_FILT_LDI
case|:
case|case
name|CVMX_TRA_FILT_LDT
case|:
comment|/* CN68XX has 32 cores which are distributed to use different                    trace buffers, decode the core that has data */
if|if
condition|(
name|OCTEON_IS_MODEL
argument_list|(
name|OCTEON_CN68XX
argument_list|)
condition|)
block|{
if|if
condition|(
name|data
operator|.
name|cmn2
operator|.
name|source
operator|<=
literal|7
condition|)
block|{
name|srcId
operator|=
name|_cvmx_tra_unit
operator|+
operator|(
name|data
operator|.
name|cmn2
operator|.
name|source
operator|*
literal|4
operator|)
expr_stmt|;
if|if
condition|(
name|srcId
operator|>=
literal|16
condition|)
name|srcId
operator|+=
literal|16
expr_stmt|;
block|}
else|else
name|srcId
operator|=
operator|(
name|data
operator|.
name|cmn2
operator|.
name|source
operator|)
expr_stmt|;
block|}
else|else
name|srcId
operator|=
operator|(
name|data
operator|.
name|cmn2
operator|.
name|source
operator|)
expr_stmt|;
name|cvmx_dprintf
argument_list|(
literal|"0x%016llx%016llx %c%+10d %s %s 0x%016llx%llx\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|u128
operator|.
name|datahi
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|u128
operator|.
name|data
argument_list|,
operator|(
name|data
operator|.
name|cmn2
operator|.
name|discontinuity
operator|)
condition|?
literal|'D'
else|:
literal|' '
argument_list|,
name|data
operator|.
name|cmn2
operator|.
name|timestamp
operator|<<
operator|(
name|tra_ctl
operator|.
name|s
operator|.
name|time_grn
operator|*
literal|3
operator|)
argument_list|,
name|TYPE_ARRAY2
index|[
name|type
index|]
argument_list|,
name|SOURCE_ARRAY
index|[
name|srcId
index|]
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|cmn2
operator|.
name|addresshi
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|cmn2
operator|.
name|addresslo
argument_list|)
expr_stmt|;
break|break;
case|case
name|CVMX_TRA_FILT_PSL1
case|:
case|case
name|CVMX_TRA_FILT_LDD
case|:
case|case
name|CVMX_TRA_FILT_FAS64
case|:
case|case
name|CVMX_TRA_FILT_FAS32
case|:
case|case
name|CVMX_TRA_FILT_FAA64
case|:
case|case
name|CVMX_TRA_FILT_FAA32
case|:
case|case
name|CVMX_TRA_FILT_SAA64
case|:
case|case
name|CVMX_TRA_FILT_SAA32
case|:
case|case
name|CVMX_TRA_FILT_STC
case|:
case|case
name|CVMX_TRA_FILT_STF
case|:
case|case
name|CVMX_TRA_FILT_STP
case|:
case|case
name|CVMX_TRA_FILT_STT
case|:
case|case
name|CVMX_TRA_FILT_STTIL1
case|:
case|case
name|CVMX_TRA_FILT_STFIL1
case|:
comment|/* CN68XX has 32 cores which are distributed to use different                    trace buffers, decode the core that has data */
if|if
condition|(
name|OCTEON_IS_MODEL
argument_list|(
name|OCTEON_CN68XX
argument_list|)
condition|)
block|{
if|if
condition|(
name|data
operator|.
name|store2
operator|.
name|source
operator|<=
literal|7
condition|)
block|{
name|srcId
operator|=
name|_cvmx_tra_unit
operator|+
operator|(
name|data
operator|.
name|store2
operator|.
name|source
operator|*
literal|4
operator|)
expr_stmt|;
if|if
condition|(
name|srcId
operator|>=
literal|16
condition|)
name|srcId
operator|+=
literal|16
expr_stmt|;
block|}
else|else
name|srcId
operator|=
name|data
operator|.
name|store2
operator|.
name|source
expr_stmt|;
block|}
else|else
name|srcId
operator|=
name|data
operator|.
name|store2
operator|.
name|source
expr_stmt|;
name|cvmx_dprintf
argument_list|(
literal|"0x%016llx%016llx %c%+10d %s %s mask=0x%02x 0x%016llx%llx\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|u128
operator|.
name|datahi
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|u128
operator|.
name|data
argument_list|,
operator|(
name|data
operator|.
name|cmn2
operator|.
name|discontinuity
operator|)
condition|?
literal|'D'
else|:
literal|' '
argument_list|,
name|data
operator|.
name|cmn2
operator|.
name|timestamp
operator|<<
operator|(
name|tra_ctl
operator|.
name|s
operator|.
name|time_grn
operator|*
literal|3
operator|)
argument_list|,
name|TYPE_ARRAY2
index|[
name|type
index|]
argument_list|,
name|SOURCE_ARRAY
index|[
name|srcId
index|]
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|data
operator|.
name|store2
operator|.
name|mask
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|store2
operator|.
name|addresshi
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|store2
operator|.
name|addresslo
argument_list|)
expr_stmt|;
break|break;
case|case
name|CVMX_TRA_FILT_IOBST64
case|:
case|case
name|CVMX_TRA_FILT_IOBST32
case|:
case|case
name|CVMX_TRA_FILT_IOBST16
case|:
case|case
name|CVMX_TRA_FILT_IOBST8
case|:
case|case
name|CVMX_TRA_FILT_IOBLD64
case|:
case|case
name|CVMX_TRA_FILT_IOBLD32
case|:
case|case
name|CVMX_TRA_FILT_IOBLD16
case|:
case|case
name|CVMX_TRA_FILT_IOBLD8
case|:
comment|/* CN68XX has 32 cores which are distributed to use different                    trace buffers, decode the core that has data */
if|if
condition|(
name|OCTEON_IS_MODEL
argument_list|(
name|OCTEON_CN68XX
argument_list|)
condition|)
block|{
if|if
condition|(
name|data
operator|.
name|iobld2
operator|.
name|source
operator|<=
literal|7
condition|)
block|{
name|srcId
operator|=
name|_cvmx_tra_unit
operator|+
operator|(
name|data
operator|.
name|iobld2
operator|.
name|source
operator|*
literal|4
operator|)
expr_stmt|;
if|if
condition|(
name|srcId
operator|>=
literal|16
condition|)
name|srcId
operator|+=
literal|16
expr_stmt|;
block|}
else|else
name|srcId
operator|=
name|data
operator|.
name|iobld2
operator|.
name|source
expr_stmt|;
block|}
else|else
name|srcId
operator|=
name|data
operator|.
name|iobld2
operator|.
name|source
expr_stmt|;
name|cvmx_dprintf
argument_list|(
literal|"0x%016llx%016llx %c%+10d %s %s->%s subdid=0x%x 0x%016llx%llx\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|u128
operator|.
name|datahi
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|u128
operator|.
name|data
argument_list|,
operator|(
name|data
operator|.
name|cmn2
operator|.
name|discontinuity
operator|)
condition|?
literal|'D'
else|:
literal|' '
argument_list|,
name|data
operator|.
name|cmn2
operator|.
name|timestamp
operator|<<
operator|(
name|tra_ctl
operator|.
name|s
operator|.
name|time_grn
operator|*
literal|3
operator|)
argument_list|,
name|TYPE_ARRAY2
index|[
name|type
index|]
argument_list|,
name|SOURCE_ARRAY
index|[
name|srcId
index|]
argument_list|,
name|DEST_ARRAY
index|[
name|data
operator|.
name|iobld2
operator|.
name|dest
index|]
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|data
operator|.
name|iobld2
operator|.
name|subid
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|iobld2
operator|.
name|addresshi
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|iobld2
operator|.
name|addresslo
argument_list|)
expr_stmt|;
break|break;
case|case
name|CVMX_TRA_FILT_IOBDMA
case|:
comment|/* CN68XX has 32 cores which are distributed to use different                    trace buffers, decode the core that has data */
if|if
condition|(
name|OCTEON_IS_MODEL
argument_list|(
name|OCTEON_CN68XX
argument_list|)
condition|)
block|{
if|if
condition|(
name|data
operator|.
name|iob2
operator|.
name|source
operator|<=
literal|7
condition|)
block|{
name|srcId
operator|=
name|_cvmx_tra_unit
operator|+
operator|(
name|data
operator|.
name|iob2
operator|.
name|source
operator|*
literal|4
operator|)
expr_stmt|;
if|if
condition|(
name|srcId
operator|>=
literal|16
condition|)
name|srcId
operator|+=
literal|16
expr_stmt|;
block|}
else|else
name|srcId
operator|=
name|data
operator|.
name|iob2
operator|.
name|source
expr_stmt|;
block|}
else|else
name|srcId
operator|=
name|data
operator|.
name|iob2
operator|.
name|source
expr_stmt|;
name|cvmx_dprintf
argument_list|(
literal|"0x%016llx%016llx %c%+10d %s %s->%s len=0x%x 0x%016llx%llx\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|u128
operator|.
name|datahi
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|u128
operator|.
name|data
argument_list|,
operator|(
name|data
operator|.
name|iob2
operator|.
name|discontinuity
operator|)
condition|?
literal|'D'
else|:
literal|' '
argument_list|,
name|data
operator|.
name|iob2
operator|.
name|timestamp
operator|<<
operator|(
name|tra_ctl
operator|.
name|s
operator|.
name|time_grn
operator|*
literal|3
operator|)
argument_list|,
name|TYPE_ARRAY2
index|[
name|type
index|]
argument_list|,
name|SOURCE_ARRAY
index|[
name|srcId
index|]
argument_list|,
name|DEST_ARRAY
index|[
name|data
operator|.
name|iob2
operator|.
name|dest
index|]
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|data
operator|.
name|iob2
operator|.
name|mask
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|iob2
operator|.
name|addresshi
operator|<<
literal|3
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|iob2
operator|.
name|addresslo
operator|<<
literal|3
argument_list|)
expr_stmt|;
break|break;
default|default:
name|cvmx_dprintf
argument_list|(
literal|"0x%016llx%016llx %c%+10d Unknown format\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|u128
operator|.
name|datahi
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|data
operator|.
name|u128
operator|.
name|data
argument_list|,
operator|(
name|data
operator|.
name|cmn2
operator|.
name|discontinuity
operator|)
condition|?
literal|'D'
else|:
literal|' '
argument_list|,
name|data
operator|.
name|cmn2
operator|.
name|timestamp
operator|<<
operator|(
name|tra_ctl
operator|.
name|s
operator|.
name|time_grn
operator|*
literal|3
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_comment
comment|/**  * Display the entire trace buffer. It is advised that you  * disable the trace buffer before calling this routine  * otherwise it could infinitely loop displaying trace data  * that it created.  */
end_comment

begin_function
name|void
name|cvmx_tra_display
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|valid
init|=
literal|0
decl_stmt|;
comment|/* Collect data from each TRA unit for decoding */
if|if
condition|(
name|CVMX_L2C_TADS
operator|>
literal|1
condition|)
block|{
name|cvmx_trax_ctl_t
name|tra_ctl
decl_stmt|;
name|cvmx_tra_data_t
name|data
index|[
literal|4
index|]
decl_stmt|;
name|int
name|tad
decl_stmt|;
do|do
block|{
name|valid
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|tad
operator|=
literal|0
init|;
name|tad
operator|<
name|CVMX_L2C_TADS
condition|;
name|tad
operator|++
control|)
name|data
index|[
name|tad
index|]
operator|=
name|cvmx_tra_read_v2
argument_list|(
name|tad
argument_list|)
expr_stmt|;
for|for
control|(
name|tad
operator|=
literal|0
init|;
name|tad
operator|<
name|CVMX_L2C_TADS
condition|;
name|tad
operator|++
control|)
block|{
name|tra_ctl
operator|.
name|u64
operator|=
name|cvmx_read_csr
argument_list|(
name|CVMX_TRAX_CTL
argument_list|(
name|tad
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
index|[
name|tad
index|]
operator|.
name|cmn2
operator|.
name|valid
condition|)
block|{
name|_cvmx_tra_unit
operator|=
name|tad
expr_stmt|;
name|cvmx_tra_decode_text
argument_list|(
name|tra_ctl
argument_list|,
name|data
index|[
name|tad
index|]
argument_list|)
expr_stmt|;
name|valid
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
do|while
condition|(
name|valid
condition|)
do|;
block|}
else|else
block|{
name|cvmx_tra_ctl_t
name|tra_ctl
decl_stmt|;
name|cvmx_tra_data_t
name|data
decl_stmt|;
name|tra_ctl
operator|.
name|u64
operator|=
name|cvmx_read_csr
argument_list|(
name|CVMX_TRA_CTL
argument_list|)
expr_stmt|;
do|do
block|{
name|data
operator|=
name|cvmx_tra_read
argument_list|()
expr_stmt|;
if|if
condition|(
operator|(
name|OCTEON_IS_MODEL
argument_list|(
name|OCTEON_CN3XXX
argument_list|)
operator|||
name|OCTEON_IS_MODEL
argument_list|(
name|OCTEON_CN5XXX
argument_list|)
operator|)
operator|&&
name|data
operator|.
name|cmn
operator|.
name|valid
condition|)
name|valid
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|data
operator|.
name|cmn2
operator|.
name|valid
condition|)
name|valid
operator|=
literal|1
expr_stmt|;
else|else
name|valid
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|valid
condition|)
name|cvmx_tra_decode_text
argument_list|(
name|tra_ctl
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|valid
condition|)
do|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CVMX_BUILD_FOR_LINUX_KERNEL
end_ifdef

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|cvmx_tra_display
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/**  * Display the entire trace buffer. It is advised that you  * disable the trace buffer before calling this routine  * otherwise it could infinitely loop displaying trace data  * that it created.  *  * @param tra_unit   Which TRA buffer to use.  */
end_comment

begin_function
name|void
name|cvmx_tra_display_v2
parameter_list|(
name|int
name|tra_unit
parameter_list|)
block|{
name|int
name|valid
init|=
literal|0
decl_stmt|;
name|cvmx_trax_ctl_t
name|tra_ctl
decl_stmt|;
name|cvmx_tra_data_t
name|data
decl_stmt|;
name|valid
operator|=
literal|0
expr_stmt|;
name|tra_ctl
operator|.
name|u64
operator|=
name|cvmx_read_csr
argument_list|(
name|CVMX_TRAX_CTL
argument_list|(
name|tra_unit
argument_list|)
argument_list|)
expr_stmt|;
do|do
block|{
name|data
operator|=
name|cvmx_tra_read_v2
argument_list|(
name|tra_unit
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|.
name|cmn2
operator|.
name|valid
condition|)
block|{
name|_cvmx_tra_unit
operator|=
name|tra_unit
expr_stmt|;
name|cvmx_tra_decode_text
argument_list|(
name|tra_ctl
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|valid
operator|=
literal|1
expr_stmt|;
block|}
block|}
do|while
condition|(
name|valid
condition|)
do|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CVMX_BUILD_FOR_LINUX_KERNEL
end_ifdef

begin_expr_stmt
name|EXPORT_SYMBOL
argument_list|(
name|cvmx_tra_display_v2
argument_list|)
expr_stmt|;
end_expr_stmt

begin_endif
endif|#
directive|endif
end_endif

end_unit


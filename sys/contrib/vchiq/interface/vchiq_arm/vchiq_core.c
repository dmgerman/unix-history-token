begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/**  * Copyright (c) 2010-2012 Broadcom. All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions, and the following disclaimer,  *    without modification.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. The names of the above-listed copyright holders may not be used  *    to endorse or promote products derived from this software without  *    specific prior written permission.  *  * ALTERNATIVELY, this software may be distributed under the terms of the  * GNU General Public License ("GPL") version 2, as published by the Free  * Software Foundation.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS  * IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,  * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR  * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,  * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,  * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF  * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING  * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"vchiq_core.h"
end_include

begin_define
define|#
directive|define
name|VCHIQ_SLOT_HANDLER_STACK
value|8192
end_define

begin_define
define|#
directive|define
name|HANDLE_STATE_SHIFT
value|12
end_define

begin_define
define|#
directive|define
name|SLOT_INFO_FROM_INDEX
parameter_list|(
name|state
parameter_list|,
name|index
parameter_list|)
value|(state->slot_info + (index))
end_define

begin_define
define|#
directive|define
name|SLOT_DATA_FROM_INDEX
parameter_list|(
name|state
parameter_list|,
name|index
parameter_list|)
value|(state->slot_data + (index))
end_define

begin_define
define|#
directive|define
name|SLOT_INDEX_FROM_DATA
parameter_list|(
name|state
parameter_list|,
name|data
parameter_list|)
define|\
value|(((unsigned int)((char *)data - (char *)state->slot_data)) / \ 	VCHIQ_SLOT_SIZE)
end_define

begin_define
define|#
directive|define
name|SLOT_INDEX_FROM_INFO
parameter_list|(
name|state
parameter_list|,
name|info
parameter_list|)
define|\
value|((unsigned int)(info - state->slot_info))
end_define

begin_define
define|#
directive|define
name|SLOT_QUEUE_INDEX_FROM_POS
parameter_list|(
name|pos
parameter_list|)
define|\
value|((int)((unsigned int)(pos) / VCHIQ_SLOT_SIZE))
end_define

begin_define
define|#
directive|define
name|BULK_INDEX
parameter_list|(
name|x
parameter_list|)
value|(x& (VCHIQ_NUM_SERVICE_BULKS - 1))
end_define

begin_struct
struct|struct
name|vchiq_open_payload
block|{
name|int
name|fourcc
decl_stmt|;
name|int
name|client_id
decl_stmt|;
name|short
name|version
decl_stmt|;
name|short
name|version_min
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|vchiq_openack_payload
block|{
name|short
name|version
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* we require this for consistency between endpoints */
end_comment

begin_expr_stmt
name|vchiq_static_assert
argument_list|(
sizeof|sizeof
argument_list|(
name|VCHIQ_HEADER_T
argument_list|)
operator|==
literal|8
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|vchiq_static_assert
argument_list|(
name|IS_POW2
argument_list|(
sizeof|sizeof
argument_list|(
name|VCHIQ_HEADER_T
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|vchiq_static_assert
argument_list|(
name|IS_POW2
argument_list|(
name|VCHIQ_NUM_CURRENT_BULKS
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|vchiq_static_assert
argument_list|(
name|IS_POW2
argument_list|(
name|VCHIQ_NUM_SERVICE_BULKS
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|vchiq_static_assert
argument_list|(
name|IS_POW2
argument_list|(
name|VCHIQ_MAX_SERVICES
argument_list|)
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|vchiq_static_assert
argument_list|(
name|VCHIQ_VERSION
operator|>=
name|VCHIQ_VERSION_MIN
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* Run time control of log level, based on KERN_XXX level. */
end_comment

begin_decl_stmt
name|int
name|vchiq_core_log_level
init|=
name|VCHIQ_LOG_DEFAULT
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|vchiq_core_msg_log_level
init|=
name|VCHIQ_LOG_DEFAULT
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|vchiq_sync_log_level
init|=
name|VCHIQ_LOG_DEFAULT
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|atomic_t
name|pause_bulks_count
init|=
name|ATOMIC_INIT
argument_list|(
literal|0
argument_list|)
decl_stmt|;
end_decl_stmt

begin_expr_stmt
specifier|static
name|DEFINE_SPINLOCK
argument_list|(
name|service_spinlock
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DEFINE_SPINLOCK
argument_list|(
name|bulk_waiter_spinlock
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DEFINE_SPINLOCK
argument_list|(
name|quota_spinlock
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
name|void
name|vchiq_core_initialize
parameter_list|(
name|void
parameter_list|)
block|{
name|spin_lock_init
argument_list|(
operator|&
name|service_spinlock
argument_list|)
expr_stmt|;
name|spin_lock_init
argument_list|(
operator|&
name|bulk_waiter_spinlock
argument_list|)
expr_stmt|;
name|spin_lock_init
argument_list|(
operator|&
name|quota_spinlock
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|VCHIQ_STATE_T
modifier|*
name|vchiq_states
index|[
name|VCHIQ_MAX_STATES
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|unsigned
name|int
name|handle_seq
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|srvstate_names
index|[]
init|=
block|{
literal|"FREE"
block|,
literal|"HIDDEN"
block|,
literal|"LISTENING"
block|,
literal|"OPENING"
block|,
literal|"OPEN"
block|,
literal|"OPENSYNC"
block|,
literal|"CLOSESENT"
block|,
literal|"CLOSERECVD"
block|,
literal|"CLOSEWAIT"
block|,
literal|"CLOSED"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|reason_names
index|[]
init|=
block|{
literal|"SERVICE_OPENED"
block|,
literal|"SERVICE_CLOSED"
block|,
literal|"MESSAGE_AVAILABLE"
block|,
literal|"BULK_TRANSMIT_DONE"
block|,
literal|"BULK_RECEIVE_DONE"
block|,
literal|"BULK_TRANSMIT_ABORTED"
block|,
literal|"BULK_RECEIVE_ABORTED"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|conn_state_names
index|[]
init|=
block|{
literal|"DISCONNECTED"
block|,
literal|"CONNECTING"
block|,
literal|"CONNECTED"
block|,
literal|"PAUSING"
block|,
literal|"PAUSE_SENT"
block|,
literal|"PAUSED"
block|,
literal|"RESUMING"
block|,
literal|"PAUSE_TIMEOUT"
block|,
literal|"RESUME_TIMEOUT"
block|}
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
name|release_message_sync
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|,
name|VCHIQ_HEADER_T
modifier|*
name|header
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|msg_type_str
parameter_list|(
name|unsigned
name|int
name|msg_type
parameter_list|)
block|{
switch|switch
condition|(
name|msg_type
condition|)
block|{
case|case
name|VCHIQ_MSG_PADDING
case|:
return|return
literal|"PADDING"
return|;
case|case
name|VCHIQ_MSG_CONNECT
case|:
return|return
literal|"CONNECT"
return|;
case|case
name|VCHIQ_MSG_OPEN
case|:
return|return
literal|"OPEN"
return|;
case|case
name|VCHIQ_MSG_OPENACK
case|:
return|return
literal|"OPENACK"
return|;
case|case
name|VCHIQ_MSG_CLOSE
case|:
return|return
literal|"CLOSE"
return|;
case|case
name|VCHIQ_MSG_DATA
case|:
return|return
literal|"DATA"
return|;
case|case
name|VCHIQ_MSG_BULK_RX
case|:
return|return
literal|"BULK_RX"
return|;
case|case
name|VCHIQ_MSG_BULK_TX
case|:
return|return
literal|"BULK_TX"
return|;
case|case
name|VCHIQ_MSG_BULK_RX_DONE
case|:
return|return
literal|"BULK_RX_DONE"
return|;
case|case
name|VCHIQ_MSG_BULK_TX_DONE
case|:
return|return
literal|"BULK_TX_DONE"
return|;
case|case
name|VCHIQ_MSG_PAUSE
case|:
return|return
literal|"PAUSE"
return|;
case|case
name|VCHIQ_MSG_RESUME
case|:
return|return
literal|"RESUME"
return|;
case|case
name|VCHIQ_MSG_REMOTE_USE
case|:
return|return
literal|"REMOTE_USE"
return|;
case|case
name|VCHIQ_MSG_REMOTE_RELEASE
case|:
return|return
literal|"REMOTE_RELEASE"
return|;
case|case
name|VCHIQ_MSG_REMOTE_USE_ACTIVE
case|:
return|return
literal|"REMOTE_USE_ACTIVE"
return|;
block|}
return|return
literal|"???"
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|vchiq_set_service_state
parameter_list|(
name|VCHIQ_SERVICE_T
modifier|*
name|service
parameter_list|,
name|int
name|newstate
parameter_list|)
block|{
name|vchiq_log_info
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: srv:%d %s->%s"
argument_list|,
name|service
operator|->
name|state
operator|->
name|id
argument_list|,
name|service
operator|->
name|localport
argument_list|,
name|srvstate_names
index|[
name|service
operator|->
name|srvstate
index|]
argument_list|,
name|srvstate_names
index|[
name|newstate
index|]
argument_list|)
expr_stmt|;
name|service
operator|->
name|srvstate
operator|=
name|newstate
expr_stmt|;
block|}
end_function

begin_function
name|VCHIQ_SERVICE_T
modifier|*
name|find_service_by_handle
parameter_list|(
name|VCHIQ_SERVICE_HANDLE_T
name|handle
parameter_list|)
block|{
name|VCHIQ_SERVICE_T
modifier|*
name|service
decl_stmt|;
name|spin_lock
argument_list|(
operator|&
name|service_spinlock
argument_list|)
expr_stmt|;
name|service
operator|=
name|handle_to_service
argument_list|(
name|handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|service
operator|&&
operator|(
name|service
operator|->
name|srvstate
operator|!=
name|VCHIQ_SRVSTATE_FREE
operator|)
operator|&&
operator|(
name|service
operator|->
name|handle
operator|==
name|handle
operator|)
condition|)
block|{
name|BUG_ON
argument_list|(
name|service
operator|->
name|ref_count
operator|==
literal|0
argument_list|)
expr_stmt|;
name|service
operator|->
name|ref_count
operator|++
expr_stmt|;
block|}
else|else
name|service
operator|=
name|NULL
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|service_spinlock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|service
condition|)
name|vchiq_log_info
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"Invalid service handle 0x%x"
argument_list|,
name|handle
argument_list|)
expr_stmt|;
return|return
name|service
return|;
block|}
end_function

begin_function
name|VCHIQ_SERVICE_T
modifier|*
name|find_service_by_port
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|,
name|int
name|localport
parameter_list|)
block|{
name|VCHIQ_SERVICE_T
modifier|*
name|service
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|(
name|unsigned
name|int
operator|)
name|localport
operator|<=
name|VCHIQ_PORT_MAX
condition|)
block|{
name|spin_lock
argument_list|(
operator|&
name|service_spinlock
argument_list|)
expr_stmt|;
name|service
operator|=
name|state
operator|->
name|services
index|[
name|localport
index|]
expr_stmt|;
if|if
condition|(
name|service
operator|&&
operator|(
name|service
operator|->
name|srvstate
operator|!=
name|VCHIQ_SRVSTATE_FREE
operator|)
condition|)
block|{
name|BUG_ON
argument_list|(
name|service
operator|->
name|ref_count
operator|==
literal|0
argument_list|)
expr_stmt|;
name|service
operator|->
name|ref_count
operator|++
expr_stmt|;
block|}
else|else
name|service
operator|=
name|NULL
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|service_spinlock
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|service
condition|)
name|vchiq_log_info
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"Invalid port %d"
argument_list|,
name|localport
argument_list|)
expr_stmt|;
return|return
name|service
return|;
block|}
end_function

begin_function
name|VCHIQ_SERVICE_T
modifier|*
name|find_service_for_instance
parameter_list|(
name|VCHIQ_INSTANCE_T
name|instance
parameter_list|,
name|VCHIQ_SERVICE_HANDLE_T
name|handle
parameter_list|)
block|{
name|VCHIQ_SERVICE_T
modifier|*
name|service
decl_stmt|;
name|spin_lock
argument_list|(
operator|&
name|service_spinlock
argument_list|)
expr_stmt|;
name|service
operator|=
name|handle_to_service
argument_list|(
name|handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|service
operator|&&
operator|(
name|service
operator|->
name|srvstate
operator|!=
name|VCHIQ_SRVSTATE_FREE
operator|)
operator|&&
operator|(
name|service
operator|->
name|handle
operator|==
name|handle
operator|)
operator|&&
operator|(
name|service
operator|->
name|instance
operator|==
name|instance
operator|)
condition|)
block|{
name|BUG_ON
argument_list|(
name|service
operator|->
name|ref_count
operator|==
literal|0
argument_list|)
expr_stmt|;
name|service
operator|->
name|ref_count
operator|++
expr_stmt|;
block|}
else|else
name|service
operator|=
name|NULL
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|service_spinlock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|service
condition|)
name|vchiq_log_info
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"Invalid service handle 0x%x"
argument_list|,
name|handle
argument_list|)
expr_stmt|;
return|return
name|service
return|;
block|}
end_function

begin_function
name|VCHIQ_SERVICE_T
modifier|*
name|next_service_by_instance
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|,
name|VCHIQ_INSTANCE_T
name|instance
parameter_list|,
name|int
modifier|*
name|pidx
parameter_list|)
block|{
name|VCHIQ_SERVICE_T
modifier|*
name|service
init|=
name|NULL
decl_stmt|;
name|int
name|idx
init|=
operator|*
name|pidx
decl_stmt|;
name|spin_lock
argument_list|(
operator|&
name|service_spinlock
argument_list|)
expr_stmt|;
while|while
condition|(
name|idx
operator|<
name|state
operator|->
name|unused_service
condition|)
block|{
name|VCHIQ_SERVICE_T
modifier|*
name|srv
init|=
name|state
operator|->
name|services
index|[
name|idx
operator|++
index|]
decl_stmt|;
if|if
condition|(
name|srv
operator|&&
operator|(
name|srv
operator|->
name|srvstate
operator|!=
name|VCHIQ_SRVSTATE_FREE
operator|)
operator|&&
operator|(
name|srv
operator|->
name|instance
operator|==
name|instance
operator|)
condition|)
block|{
name|service
operator|=
name|srv
expr_stmt|;
name|BUG_ON
argument_list|(
name|service
operator|->
name|ref_count
operator|==
literal|0
argument_list|)
expr_stmt|;
name|service
operator|->
name|ref_count
operator|++
expr_stmt|;
break|break;
block|}
block|}
name|spin_unlock
argument_list|(
operator|&
name|service_spinlock
argument_list|)
expr_stmt|;
operator|*
name|pidx
operator|=
name|idx
expr_stmt|;
return|return
name|service
return|;
block|}
end_function

begin_function
name|void
name|lock_service
parameter_list|(
name|VCHIQ_SERVICE_T
modifier|*
name|service
parameter_list|)
block|{
name|spin_lock
argument_list|(
operator|&
name|service_spinlock
argument_list|)
expr_stmt|;
name|BUG_ON
argument_list|(
operator|!
name|service
operator|||
operator|(
name|service
operator|->
name|ref_count
operator|==
literal|0
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|service
condition|)
name|service
operator|->
name|ref_count
operator|++
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|service_spinlock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|unlock_service
parameter_list|(
name|VCHIQ_SERVICE_T
modifier|*
name|service
parameter_list|)
block|{
name|VCHIQ_STATE_T
modifier|*
name|state
init|=
name|service
operator|->
name|state
decl_stmt|;
name|spin_lock
argument_list|(
operator|&
name|service_spinlock
argument_list|)
expr_stmt|;
name|BUG_ON
argument_list|(
operator|!
name|service
operator|||
operator|(
name|service
operator|->
name|ref_count
operator|==
literal|0
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|service
operator|&&
name|service
operator|->
name|ref_count
condition|)
block|{
name|service
operator|->
name|ref_count
operator|--
expr_stmt|;
if|if
condition|(
operator|!
name|service
operator|->
name|ref_count
condition|)
block|{
name|BUG_ON
argument_list|(
name|service
operator|->
name|srvstate
operator|!=
name|VCHIQ_SRVSTATE_FREE
argument_list|)
expr_stmt|;
name|state
operator|->
name|services
index|[
name|service
operator|->
name|localport
index|]
operator|=
name|NULL
expr_stmt|;
name|_sema_destroy
argument_list|(
operator|&
name|service
operator|->
name|remove_event
argument_list|)
expr_stmt|;
name|_sema_destroy
argument_list|(
operator|&
name|service
operator|->
name|bulk_remove_event
argument_list|)
expr_stmt|;
name|lmutex_destroy
argument_list|(
operator|&
name|service
operator|->
name|bulk_mutex
argument_list|)
expr_stmt|;
block|}
else|else
name|service
operator|=
name|NULL
expr_stmt|;
block|}
name|spin_unlock
argument_list|(
operator|&
name|service_spinlock
argument_list|)
expr_stmt|;
if|if
condition|(
name|service
operator|&&
name|service
operator|->
name|userdata_term
condition|)
name|service
operator|->
name|userdata_term
argument_list|(
name|service
operator|->
name|base
operator|.
name|userdata
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|service
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|vchiq_get_client_id
parameter_list|(
name|VCHIQ_SERVICE_HANDLE_T
name|handle
parameter_list|)
block|{
name|VCHIQ_SERVICE_T
modifier|*
name|service
init|=
name|find_service_by_handle
argument_list|(
name|handle
argument_list|)
decl_stmt|;
name|int
name|id
decl_stmt|;
name|id
operator|=
name|service
condition|?
name|service
operator|->
name|client_id
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|service
condition|)
name|unlock_service
argument_list|(
name|service
argument_list|)
expr_stmt|;
return|return
name|id
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|vchiq_get_service_userdata
parameter_list|(
name|VCHIQ_SERVICE_HANDLE_T
name|handle
parameter_list|)
block|{
name|VCHIQ_SERVICE_T
modifier|*
name|service
init|=
name|handle_to_service
argument_list|(
name|handle
argument_list|)
decl_stmt|;
return|return
name|service
condition|?
name|service
operator|->
name|base
operator|.
name|userdata
else|:
name|NULL
return|;
block|}
end_function

begin_function
name|int
name|vchiq_get_service_fourcc
parameter_list|(
name|VCHIQ_SERVICE_HANDLE_T
name|handle
parameter_list|)
block|{
name|VCHIQ_SERVICE_T
modifier|*
name|service
init|=
name|handle_to_service
argument_list|(
name|handle
argument_list|)
decl_stmt|;
return|return
name|service
condition|?
name|service
operator|->
name|base
operator|.
name|fourcc
else|:
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mark_service_closing_internal
parameter_list|(
name|VCHIQ_SERVICE_T
modifier|*
name|service
parameter_list|,
name|int
name|sh_thread
parameter_list|)
block|{
name|VCHIQ_STATE_T
modifier|*
name|state
init|=
name|service
operator|->
name|state
decl_stmt|;
name|VCHIQ_SERVICE_QUOTA_T
modifier|*
name|service_quota
decl_stmt|;
name|service
operator|->
name|closing
operator|=
literal|1
expr_stmt|;
comment|/* Synchronise with other threads. */
name|lmutex_lock
argument_list|(
operator|&
name|state
operator|->
name|recycle_mutex
argument_list|)
expr_stmt|;
name|lmutex_unlock
argument_list|(
operator|&
name|state
operator|->
name|recycle_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sh_thread
operator|||
operator|(
name|state
operator|->
name|conn_state
operator|!=
name|VCHIQ_CONNSTATE_PAUSE_SENT
operator|)
condition|)
block|{
comment|/* If we're pausing then the slot_mutex is held until resume 		 * by the slot handler.  Therefore don't try to acquire this 		 * mutex if we're the slot handler and in the pause sent state. 		 * We don't need to in this case anyway. */
name|lmutex_lock
argument_list|(
operator|&
name|state
operator|->
name|slot_mutex
argument_list|)
expr_stmt|;
name|lmutex_unlock
argument_list|(
operator|&
name|state
operator|->
name|slot_mutex
argument_list|)
expr_stmt|;
block|}
comment|/* Unblock any sending thread. */
name|service_quota
operator|=
operator|&
name|state
operator|->
name|service_quotas
index|[
name|service
operator|->
name|localport
index|]
expr_stmt|;
name|up
argument_list|(
operator|&
name|service_quota
operator|->
name|quota_event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mark_service_closing
parameter_list|(
name|VCHIQ_SERVICE_T
modifier|*
name|service
parameter_list|)
block|{
name|mark_service_closing_internal
argument_list|(
name|service
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|VCHIQ_STATUS_T
name|make_service_callback
parameter_list|(
name|VCHIQ_SERVICE_T
modifier|*
name|service
parameter_list|,
name|VCHIQ_REASON_T
name|reason
parameter_list|,
name|VCHIQ_HEADER_T
modifier|*
name|header
parameter_list|,
name|void
modifier|*
name|bulk_userdata
parameter_list|)
block|{
name|VCHIQ_STATUS_T
name|status
decl_stmt|;
name|vchiq_log_trace
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: callback:%d (%s, %x, %x)"
argument_list|,
name|service
operator|->
name|state
operator|->
name|id
argument_list|,
name|service
operator|->
name|localport
argument_list|,
name|reason_names
index|[
name|reason
index|]
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|bulk_userdata
argument_list|)
expr_stmt|;
name|status
operator|=
name|service
operator|->
name|base
operator|.
name|callback
argument_list|(
name|reason
argument_list|,
name|header
argument_list|,
name|service
operator|->
name|handle
argument_list|,
name|bulk_userdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|VCHIQ_ERROR
condition|)
block|{
name|vchiq_log_warning
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: ignoring ERROR from callback to service %x"
argument_list|,
name|service
operator|->
name|state
operator|->
name|id
argument_list|,
name|service
operator|->
name|handle
argument_list|)
expr_stmt|;
name|status
operator|=
name|VCHIQ_SUCCESS
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|inline
name|void
name|vchiq_set_conn_state
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|,
name|VCHIQ_CONNSTATE_T
name|newstate
parameter_list|)
block|{
name|VCHIQ_CONNSTATE_T
name|oldstate
init|=
name|state
operator|->
name|conn_state
decl_stmt|;
name|vchiq_log_info
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: %s->%s"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|conn_state_names
index|[
name|oldstate
index|]
argument_list|,
name|conn_state_names
index|[
name|newstate
index|]
argument_list|)
expr_stmt|;
name|state
operator|->
name|conn_state
operator|=
name|newstate
expr_stmt|;
name|vchiq_platform_conn_state_changed
argument_list|(
name|state
argument_list|,
name|oldstate
argument_list|,
name|newstate
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|remote_event_create
parameter_list|(
name|REMOTE_EVENT_T
modifier|*
name|event
parameter_list|)
block|{
name|event
operator|->
name|armed
operator|=
literal|0
expr_stmt|;
comment|/* Don't clear the 'fired' flag because it may already have been set 	** by the other side. */
name|_sema_init
argument_list|(
name|event
operator|->
name|event
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|__unused
specifier|static
specifier|inline
name|void
name|remote_event_destroy
parameter_list|(
name|REMOTE_EVENT_T
modifier|*
name|event
parameter_list|)
block|{
operator|(
name|void
operator|)
name|event
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|int
name|remote_event_wait
parameter_list|(
name|REMOTE_EVENT_T
modifier|*
name|event
parameter_list|)
block|{
if|if
condition|(
operator|!
name|event
operator|->
name|fired
condition|)
block|{
name|event
operator|->
name|armed
operator|=
literal|1
expr_stmt|;
name|dsb
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|event
operator|->
name|fired
condition|)
block|{
if|if
condition|(
name|down_interruptible
argument_list|(
name|event
operator|->
name|event
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|event
operator|->
name|armed
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
name|event
operator|->
name|armed
operator|=
literal|0
expr_stmt|;
name|wmb
argument_list|()
expr_stmt|;
block|}
name|event
operator|->
name|fired
operator|=
literal|0
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|remote_event_signal_local
parameter_list|(
name|REMOTE_EVENT_T
modifier|*
name|event
parameter_list|)
block|{
name|event
operator|->
name|armed
operator|=
literal|0
expr_stmt|;
name|up
argument_list|(
name|event
operator|->
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|remote_event_poll
parameter_list|(
name|REMOTE_EVENT_T
modifier|*
name|event
parameter_list|)
block|{
if|if
condition|(
name|event
operator|->
name|fired
operator|&&
name|event
operator|->
name|armed
condition|)
name|remote_event_signal_local
argument_list|(
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|remote_event_pollall
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|)
block|{
name|remote_event_poll
argument_list|(
operator|&
name|state
operator|->
name|local
operator|->
name|sync_trigger
argument_list|)
expr_stmt|;
name|remote_event_poll
argument_list|(
operator|&
name|state
operator|->
name|local
operator|->
name|sync_release
argument_list|)
expr_stmt|;
name|remote_event_poll
argument_list|(
operator|&
name|state
operator|->
name|local
operator|->
name|trigger
argument_list|)
expr_stmt|;
name|remote_event_poll
argument_list|(
operator|&
name|state
operator|->
name|local
operator|->
name|recycle
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Round up message sizes so that any space at the end of a slot is always big ** enough for a header. This relies on header size being a power of two, which ** has been verified earlier by a static assertion. */
end_comment

begin_function
specifier|static
specifier|inline
name|unsigned
name|int
name|calc_stride
parameter_list|(
name|unsigned
name|int
name|size
parameter_list|)
block|{
comment|/* Allow room for the header */
name|size
operator|+=
sizeof|sizeof
argument_list|(
name|VCHIQ_HEADER_T
argument_list|)
expr_stmt|;
comment|/* Round up */
return|return
operator|(
name|size
operator|+
sizeof|sizeof
argument_list|(
name|VCHIQ_HEADER_T
argument_list|)
operator|-
literal|1
operator|)
operator|&
operator|~
operator|(
sizeof|sizeof
argument_list|(
name|VCHIQ_HEADER_T
argument_list|)
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Called by the slot handler thread */
end_comment

begin_function
specifier|static
name|VCHIQ_SERVICE_T
modifier|*
name|get_listening_service
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|,
name|int
name|fourcc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|WARN_ON
argument_list|(
name|fourcc
operator|==
name|VCHIQ_FOURCC_INVALID
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|state
operator|->
name|unused_service
condition|;
name|i
operator|++
control|)
block|{
name|VCHIQ_SERVICE_T
modifier|*
name|service
init|=
name|state
operator|->
name|services
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|service
operator|&&
operator|(
name|service
operator|->
name|public_fourcc
operator|==
name|fourcc
operator|)
operator|&&
operator|(
operator|(
name|service
operator|->
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_LISTENING
operator|)
operator|||
operator|(
operator|(
name|service
operator|->
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_OPEN
operator|)
operator|&&
operator|(
name|service
operator|->
name|remoteport
operator|==
name|VCHIQ_PORT_FREE
operator|)
operator|)
operator|)
condition|)
block|{
name|lock_service
argument_list|(
name|service
argument_list|)
expr_stmt|;
return|return
name|service
return|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/* Called by the slot handler thread */
end_comment

begin_function
specifier|static
name|VCHIQ_SERVICE_T
modifier|*
name|get_connected_service
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|,
name|unsigned
name|int
name|port
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|state
operator|->
name|unused_service
condition|;
name|i
operator|++
control|)
block|{
name|VCHIQ_SERVICE_T
modifier|*
name|service
init|=
name|state
operator|->
name|services
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|service
operator|&&
operator|(
name|service
operator|->
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_OPEN
operator|)
operator|&&
operator|(
name|service
operator|->
name|remoteport
operator|==
name|port
operator|)
condition|)
block|{
name|lock_service
argument_list|(
name|service
argument_list|)
expr_stmt|;
return|return
name|service
return|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|inline
name|void
name|request_poll
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|,
name|VCHIQ_SERVICE_T
modifier|*
name|service
parameter_list|,
name|int
name|poll_type
parameter_list|)
block|{
name|uint32_t
name|value
decl_stmt|;
if|if
condition|(
name|service
condition|)
block|{
do|do
block|{
name|value
operator|=
name|atomic_read
argument_list|(
operator|&
name|service
operator|->
name|poll_flags
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|atomic_cmpxchg
argument_list|(
operator|&
name|service
operator|->
name|poll_flags
argument_list|,
name|value
argument_list|,
name|value
operator||
operator|(
literal|1
operator|<<
name|poll_type
operator|)
argument_list|)
operator|!=
name|value
condition|)
do|;
do|do
block|{
name|value
operator|=
name|atomic_read
argument_list|(
operator|&
name|state
operator|->
name|poll_services
index|[
name|service
operator|->
name|localport
operator|>>
literal|5
index|]
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|atomic_cmpxchg
argument_list|(
operator|&
name|state
operator|->
name|poll_services
index|[
name|service
operator|->
name|localport
operator|>>
literal|5
index|]
argument_list|,
name|value
argument_list|,
name|value
operator||
operator|(
literal|1
operator|<<
operator|(
name|service
operator|->
name|localport
operator|&
literal|0x1f
operator|)
operator|)
argument_list|)
operator|!=
name|value
condition|)
do|;
block|}
name|state
operator|->
name|poll_needed
operator|=
literal|1
expr_stmt|;
name|wmb
argument_list|()
expr_stmt|;
comment|/* ... and ensure the slot handler runs. */
name|remote_event_signal_local
argument_list|(
operator|&
name|state
operator|->
name|local
operator|->
name|trigger
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Called from queue_message, by the slot handler and application threads, ** with slot_mutex held */
end_comment

begin_function
specifier|static
name|VCHIQ_HEADER_T
modifier|*
name|reserve_space
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|,
name|int
name|space
parameter_list|,
name|int
name|is_blocking
parameter_list|)
block|{
name|VCHIQ_SHARED_STATE_T
modifier|*
name|local
init|=
name|state
operator|->
name|local
decl_stmt|;
name|int
name|tx_pos
init|=
name|state
operator|->
name|local_tx_pos
decl_stmt|;
name|int
name|slot_space
init|=
name|VCHIQ_SLOT_SIZE
operator|-
operator|(
name|tx_pos
operator|&
name|VCHIQ_SLOT_MASK
operator|)
decl_stmt|;
if|if
condition|(
name|space
operator|>
name|slot_space
condition|)
block|{
name|VCHIQ_HEADER_T
modifier|*
name|header
decl_stmt|;
comment|/* Fill the remaining space with padding */
name|WARN_ON
argument_list|(
name|state
operator|->
name|tx_data
operator|==
name|NULL
argument_list|)
expr_stmt|;
name|header
operator|=
operator|(
name|VCHIQ_HEADER_T
operator|*
operator|)
operator|(
name|state
operator|->
name|tx_data
operator|+
operator|(
name|tx_pos
operator|&
name|VCHIQ_SLOT_MASK
operator|)
operator|)
expr_stmt|;
name|header
operator|->
name|msgid
operator|=
name|VCHIQ_MSGID_PADDING
expr_stmt|;
name|header
operator|->
name|size
operator|=
name|slot_space
operator|-
sizeof|sizeof
argument_list|(
name|VCHIQ_HEADER_T
argument_list|)
expr_stmt|;
name|tx_pos
operator|+=
name|slot_space
expr_stmt|;
block|}
comment|/* If necessary, get the next slot. */
if|if
condition|(
operator|(
name|tx_pos
operator|&
name|VCHIQ_SLOT_MASK
operator|)
operator|==
literal|0
condition|)
block|{
name|int
name|slot_index
decl_stmt|;
comment|/* If there is no free slot... */
if|if
condition|(
name|down_trylock
argument_list|(
operator|&
name|state
operator|->
name|slot_available_event
argument_list|)
operator|!=
literal|0
condition|)
block|{
comment|/* ...wait for one. */
name|VCHIQ_STATS_INC
argument_list|(
name|state
argument_list|,
name|slot_stalls
argument_list|)
expr_stmt|;
comment|/* But first, flush through the last slot. */
name|state
operator|->
name|local_tx_pos
operator|=
name|tx_pos
expr_stmt|;
name|local
operator|->
name|tx_pos
operator|=
name|tx_pos
expr_stmt|;
name|remote_event_signal
argument_list|(
operator|&
name|state
operator|->
name|remote
operator|->
name|trigger
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|is_blocking
operator|||
operator|(
name|down_interruptible
argument_list|(
operator|&
name|state
operator|->
name|slot_available_event
argument_list|)
operator|!=
literal|0
operator|)
condition|)
return|return
name|NULL
return|;
comment|/* No space available */
block|}
name|BUG_ON
argument_list|(
name|tx_pos
operator|==
operator|(
name|state
operator|->
name|slot_queue_available
operator|*
name|VCHIQ_SLOT_SIZE
operator|)
argument_list|)
expr_stmt|;
name|slot_index
operator|=
name|local
operator|->
name|slot_queue
index|[
name|SLOT_QUEUE_INDEX_FROM_POS
argument_list|(
name|tx_pos
argument_list|)
operator|&
name|VCHIQ_SLOT_QUEUE_MASK
index|]
expr_stmt|;
name|state
operator|->
name|tx_data
operator|=
operator|(
name|char
operator|*
operator|)
name|SLOT_DATA_FROM_INDEX
argument_list|(
name|state
argument_list|,
name|slot_index
argument_list|)
expr_stmt|;
block|}
name|state
operator|->
name|local_tx_pos
operator|=
name|tx_pos
operator|+
name|space
expr_stmt|;
return|return
operator|(
name|VCHIQ_HEADER_T
operator|*
operator|)
operator|(
name|state
operator|->
name|tx_data
operator|+
operator|(
name|tx_pos
operator|&
name|VCHIQ_SLOT_MASK
operator|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Called by the recycle thread. */
end_comment

begin_function
specifier|static
name|void
name|process_free_queue
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|)
block|{
name|VCHIQ_SHARED_STATE_T
modifier|*
name|local
init|=
name|state
operator|->
name|local
decl_stmt|;
name|BITSET_T
name|service_found
index|[
name|BITSET_SIZE
argument_list|(
name|VCHIQ_MAX_SERVICES
argument_list|)
index|]
decl_stmt|;
name|int
name|slot_queue_available
decl_stmt|;
comment|/* Use a read memory barrier to ensure that any state that may have 	** been modified by another thread is not masked by stale prefetched 	** values. */
name|rmb
argument_list|()
expr_stmt|;
comment|/* Find slots which have been freed by the other side, and return them 	** to the available queue. */
name|slot_queue_available
operator|=
name|state
operator|->
name|slot_queue_available
expr_stmt|;
while|while
condition|(
name|slot_queue_available
operator|!=
name|local
operator|->
name|slot_queue_recycle
condition|)
block|{
name|unsigned
name|int
name|pos
decl_stmt|;
name|int
name|slot_index
init|=
name|local
operator|->
name|slot_queue
index|[
name|slot_queue_available
operator|++
operator|&
name|VCHIQ_SLOT_QUEUE_MASK
index|]
decl_stmt|;
name|char
modifier|*
name|data
init|=
operator|(
name|char
operator|*
operator|)
name|SLOT_DATA_FROM_INDEX
argument_list|(
name|state
argument_list|,
name|slot_index
argument_list|)
decl_stmt|;
name|int
name|data_found
init|=
literal|0
decl_stmt|;
name|vchiq_log_trace
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: pfq %d=%x %x %x"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|slot_index
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|data
argument_list|,
name|local
operator|->
name|slot_queue_recycle
argument_list|,
name|slot_queue_available
argument_list|)
expr_stmt|;
comment|/* Initialise the bitmask for services which have used this 		** slot */
name|BITSET_ZERO
argument_list|(
name|service_found
argument_list|)
expr_stmt|;
name|pos
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|pos
operator|<
name|VCHIQ_SLOT_SIZE
condition|)
block|{
name|VCHIQ_HEADER_T
modifier|*
name|header
init|=
operator|(
name|VCHIQ_HEADER_T
operator|*
operator|)
operator|(
name|data
operator|+
name|pos
operator|)
decl_stmt|;
name|int
name|msgid
init|=
name|header
operator|->
name|msgid
decl_stmt|;
if|if
condition|(
name|VCHIQ_MSG_TYPE
argument_list|(
name|msgid
argument_list|)
operator|==
name|VCHIQ_MSG_DATA
condition|)
block|{
name|int
name|port
init|=
name|VCHIQ_MSG_SRCPORT
argument_list|(
name|msgid
argument_list|)
decl_stmt|;
name|VCHIQ_SERVICE_QUOTA_T
modifier|*
name|service_quota
init|=
operator|&
name|state
operator|->
name|service_quotas
index|[
name|port
index|]
decl_stmt|;
name|int
name|count
decl_stmt|;
name|spin_lock
argument_list|(
operator|&
name|quota_spinlock
argument_list|)
expr_stmt|;
name|count
operator|=
name|service_quota
operator|->
name|message_use_count
expr_stmt|;
if|if
condition|(
name|count
operator|>
literal|0
condition|)
name|service_quota
operator|->
name|message_use_count
operator|=
name|count
operator|-
literal|1
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|quota_spinlock
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|==
name|service_quota
operator|->
name|message_quota
condition|)
comment|/* Signal the service that it 					** has dropped below its quota 					*/
name|up
argument_list|(
operator|&
name|service_quota
operator|->
name|quota_event
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|count
operator|==
literal|0
condition|)
block|{
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"service %d "
literal|"message_use_count=%d "
literal|"(header %x, msgid %x, "
literal|"header->msgid %x, "
literal|"header->size %x)"
argument_list|,
name|port
argument_list|,
name|service_quota
operator|->
name|message_use_count
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
name|msgid
argument_list|,
name|header
operator|->
name|msgid
argument_list|,
name|header
operator|->
name|size
argument_list|)
expr_stmt|;
name|WARN
argument_list|(
literal|1
argument_list|,
literal|"invalid message use count\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|BITSET_IS_SET
argument_list|(
name|service_found
argument_list|,
name|port
argument_list|)
condition|)
block|{
comment|/* Set the found bit for this service */
name|BITSET_SET
argument_list|(
name|service_found
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|spin_lock
argument_list|(
operator|&
name|quota_spinlock
argument_list|)
expr_stmt|;
name|count
operator|=
name|service_quota
operator|->
name|slot_use_count
expr_stmt|;
if|if
condition|(
name|count
operator|>
literal|0
condition|)
name|service_quota
operator|->
name|slot_use_count
operator|=
name|count
operator|-
literal|1
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|quota_spinlock
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|>
literal|0
condition|)
block|{
comment|/* Signal the service in case 						** it has dropped below its 						** quota */
name|up
argument_list|(
operator|&
name|service_quota
operator|->
name|quota_event
argument_list|)
expr_stmt|;
name|vchiq_log_trace
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: pfq:%d %x@%x - "
literal|"slot_use->%d"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|port
argument_list|,
name|header
operator|->
name|size
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
name|count
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"service %d "
literal|"slot_use_count"
literal|"=%d (header %x"
literal|", msgid %x, "
literal|"header->msgid"
literal|" %x, header->"
literal|"size %x)"
argument_list|,
name|port
argument_list|,
name|count
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
name|msgid
argument_list|,
name|header
operator|->
name|msgid
argument_list|,
name|header
operator|->
name|size
argument_list|)
expr_stmt|;
name|WARN
argument_list|(
literal|1
argument_list|,
literal|"bad slot use count\n"
argument_list|)
expr_stmt|;
block|}
block|}
name|data_found
operator|=
literal|1
expr_stmt|;
block|}
name|pos
operator|+=
name|calc_stride
argument_list|(
name|header
operator|->
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|>
name|VCHIQ_SLOT_SIZE
condition|)
block|{
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"pfq - pos %x: header %x, msgid %x, "
literal|"header->msgid %x, header->size %x"
argument_list|,
name|pos
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
name|msgid
argument_list|,
name|header
operator|->
name|msgid
argument_list|,
name|header
operator|->
name|size
argument_list|)
expr_stmt|;
name|WARN
argument_list|(
literal|1
argument_list|,
literal|"invalid slot position\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|data_found
condition|)
block|{
name|int
name|count
decl_stmt|;
name|spin_lock
argument_list|(
operator|&
name|quota_spinlock
argument_list|)
expr_stmt|;
name|count
operator|=
name|state
operator|->
name|data_use_count
expr_stmt|;
if|if
condition|(
name|count
operator|>
literal|0
condition|)
name|state
operator|->
name|data_use_count
operator|=
name|count
operator|-
literal|1
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|quota_spinlock
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|==
name|state
operator|->
name|data_quota
condition|)
name|up
argument_list|(
operator|&
name|state
operator|->
name|data_quota_event
argument_list|)
expr_stmt|;
block|}
name|state
operator|->
name|slot_queue_available
operator|=
name|slot_queue_available
expr_stmt|;
name|up
argument_list|(
operator|&
name|state
operator|->
name|slot_available_event
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Called by the slot handler and application threads */
end_comment

begin_function
specifier|static
name|VCHIQ_STATUS_T
name|queue_message
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|,
name|VCHIQ_SERVICE_T
modifier|*
name|service
parameter_list|,
name|int
name|msgid
parameter_list|,
specifier|const
name|VCHIQ_ELEMENT_T
modifier|*
name|elements
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|size
parameter_list|,
name|int
name|is_blocking
parameter_list|)
block|{
name|VCHIQ_SHARED_STATE_T
modifier|*
name|local
decl_stmt|;
name|VCHIQ_SERVICE_QUOTA_T
modifier|*
name|service_quota
init|=
name|NULL
decl_stmt|;
name|VCHIQ_HEADER_T
modifier|*
name|header
decl_stmt|;
name|int
name|type
init|=
name|VCHIQ_MSG_TYPE
argument_list|(
name|msgid
argument_list|)
decl_stmt|;
name|unsigned
name|int
name|stride
decl_stmt|;
name|local
operator|=
name|state
operator|->
name|local
expr_stmt|;
name|stride
operator|=
name|calc_stride
argument_list|(
name|size
argument_list|)
expr_stmt|;
name|WARN_ON
argument_list|(
operator|!
operator|(
name|stride
operator|<=
name|VCHIQ_SLOT_SIZE
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|type
operator|!=
name|VCHIQ_MSG_RESUME
operator|)
operator|&&
operator|(
name|lmutex_lock_interruptible
argument_list|(
operator|&
name|state
operator|->
name|slot_mutex
argument_list|)
operator|!=
literal|0
operator|)
condition|)
return|return
name|VCHIQ_RETRY
return|;
if|if
condition|(
name|type
operator|==
name|VCHIQ_MSG_DATA
condition|)
block|{
name|int
name|tx_end_index
decl_stmt|;
name|BUG_ON
argument_list|(
operator|!
name|service
argument_list|)
expr_stmt|;
if|if
condition|(
name|service
operator|->
name|closing
condition|)
block|{
comment|/* The service has been closed */
name|lmutex_unlock
argument_list|(
operator|&
name|state
operator|->
name|slot_mutex
argument_list|)
expr_stmt|;
return|return
name|VCHIQ_ERROR
return|;
block|}
name|service_quota
operator|=
operator|&
name|state
operator|->
name|service_quotas
index|[
name|service
operator|->
name|localport
index|]
expr_stmt|;
name|spin_lock
argument_list|(
operator|&
name|quota_spinlock
argument_list|)
expr_stmt|;
comment|/* Ensure this service doesn't use more than its quota of 		** messages or slots */
name|tx_end_index
operator|=
name|SLOT_QUEUE_INDEX_FROM_POS
argument_list|(
name|state
operator|->
name|local_tx_pos
operator|+
name|stride
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Ensure data messages don't use more than their quota of 		** slots */
while|while
condition|(
operator|(
name|tx_end_index
operator|!=
name|state
operator|->
name|previous_data_index
operator|)
operator|&&
operator|(
name|state
operator|->
name|data_use_count
operator|==
name|state
operator|->
name|data_quota
operator|)
condition|)
block|{
name|VCHIQ_STATS_INC
argument_list|(
name|state
argument_list|,
name|data_stalls
argument_list|)
expr_stmt|;
name|spin_unlock
argument_list|(
operator|&
name|quota_spinlock
argument_list|)
expr_stmt|;
name|lmutex_unlock
argument_list|(
operator|&
name|state
operator|->
name|slot_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|down_interruptible
argument_list|(
operator|&
name|state
operator|->
name|data_quota_event
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|VCHIQ_RETRY
return|;
name|lmutex_lock
argument_list|(
operator|&
name|state
operator|->
name|slot_mutex
argument_list|)
expr_stmt|;
name|spin_lock
argument_list|(
operator|&
name|quota_spinlock
argument_list|)
expr_stmt|;
name|tx_end_index
operator|=
name|SLOT_QUEUE_INDEX_FROM_POS
argument_list|(
name|state
operator|->
name|local_tx_pos
operator|+
name|stride
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|tx_end_index
operator|==
name|state
operator|->
name|previous_data_index
operator|)
operator|||
operator|(
name|state
operator|->
name|data_use_count
operator|<
name|state
operator|->
name|data_quota
operator|)
condition|)
block|{
comment|/* Pass the signal on to other waiters */
name|up
argument_list|(
operator|&
name|state
operator|->
name|data_quota_event
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
while|while
condition|(
operator|(
name|service_quota
operator|->
name|message_use_count
operator|==
name|service_quota
operator|->
name|message_quota
operator|)
operator|||
operator|(
operator|(
name|tx_end_index
operator|!=
name|service_quota
operator|->
name|previous_tx_index
operator|)
operator|&&
operator|(
name|service_quota
operator|->
name|slot_use_count
operator|==
name|service_quota
operator|->
name|slot_quota
operator|)
operator|)
condition|)
block|{
name|spin_unlock
argument_list|(
operator|&
name|quota_spinlock
argument_list|)
expr_stmt|;
name|vchiq_log_trace
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: qm:%d %s,%x - quota stall "
literal|"(msg %d, slot %d)"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|service
operator|->
name|localport
argument_list|,
name|msg_type_str
argument_list|(
name|type
argument_list|)
argument_list|,
name|size
argument_list|,
name|service_quota
operator|->
name|message_use_count
argument_list|,
name|service_quota
operator|->
name|slot_use_count
argument_list|)
expr_stmt|;
name|VCHIQ_SERVICE_STATS_INC
argument_list|(
name|service
argument_list|,
name|quota_stalls
argument_list|)
expr_stmt|;
name|lmutex_unlock
argument_list|(
operator|&
name|state
operator|->
name|slot_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|down_interruptible
argument_list|(
operator|&
name|service_quota
operator|->
name|quota_event
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|VCHIQ_RETRY
return|;
if|if
condition|(
name|service
operator|->
name|closing
condition|)
return|return
name|VCHIQ_ERROR
return|;
if|if
condition|(
name|lmutex_lock_interruptible
argument_list|(
operator|&
name|state
operator|->
name|slot_mutex
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|VCHIQ_RETRY
return|;
if|if
condition|(
name|service
operator|->
name|srvstate
operator|!=
name|VCHIQ_SRVSTATE_OPEN
condition|)
block|{
comment|/* The service has been closed */
name|lmutex_unlock
argument_list|(
operator|&
name|state
operator|->
name|slot_mutex
argument_list|)
expr_stmt|;
return|return
name|VCHIQ_ERROR
return|;
block|}
name|spin_lock
argument_list|(
operator|&
name|quota_spinlock
argument_list|)
expr_stmt|;
name|tx_end_index
operator|=
name|SLOT_QUEUE_INDEX_FROM_POS
argument_list|(
name|state
operator|->
name|local_tx_pos
operator|+
name|stride
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|spin_unlock
argument_list|(
operator|&
name|quota_spinlock
argument_list|)
expr_stmt|;
block|}
name|header
operator|=
name|reserve_space
argument_list|(
name|state
argument_list|,
name|stride
argument_list|,
name|is_blocking
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|header
condition|)
block|{
if|if
condition|(
name|service
condition|)
name|VCHIQ_SERVICE_STATS_INC
argument_list|(
name|service
argument_list|,
name|slot_stalls
argument_list|)
expr_stmt|;
name|lmutex_unlock
argument_list|(
operator|&
name|state
operator|->
name|slot_mutex
argument_list|)
expr_stmt|;
return|return
name|VCHIQ_RETRY
return|;
block|}
if|if
condition|(
name|type
operator|==
name|VCHIQ_MSG_DATA
condition|)
block|{
name|int
name|i
decl_stmt|,
name|pos
decl_stmt|;
name|int
name|tx_end_index
decl_stmt|;
name|int
name|slot_use_count
decl_stmt|;
name|vchiq_log_info
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: qm %s@%x,%x (%d->%d)"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|msg_type_str
argument_list|(
name|VCHIQ_MSG_TYPE
argument_list|(
name|msgid
argument_list|)
argument_list|)
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
name|size
argument_list|,
name|VCHIQ_MSG_SRCPORT
argument_list|(
name|msgid
argument_list|)
argument_list|,
name|VCHIQ_MSG_DSTPORT
argument_list|(
name|msgid
argument_list|)
argument_list|)
expr_stmt|;
name|BUG_ON
argument_list|(
operator|!
name|service
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|pos
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|unsigned
name|int
operator|)
name|count
condition|;
name|pos
operator|+=
name|elements
index|[
name|i
operator|++
index|]
operator|.
name|size
control|)
if|if
condition|(
name|elements
index|[
name|i
index|]
operator|.
name|size
condition|)
block|{
if|if
condition|(
name|vchiq_copy_from_user
argument_list|(
name|header
operator|->
name|data
operator|+
name|pos
argument_list|,
name|elements
index|[
name|i
index|]
operator|.
name|data
argument_list|,
operator|(
name|size_t
operator|)
name|elements
index|[
name|i
index|]
operator|.
name|size
argument_list|)
operator|!=
name|VCHIQ_SUCCESS
condition|)
block|{
name|lmutex_unlock
argument_list|(
operator|&
name|state
operator|->
name|slot_mutex
argument_list|)
expr_stmt|;
name|VCHIQ_SERVICE_STATS_INC
argument_list|(
name|service
argument_list|,
name|error_count
argument_list|)
expr_stmt|;
return|return
name|VCHIQ_ERROR
return|;
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|vchiq_core_msg_log_level
operator|>=
name|VCHIQ_LOG_INFO
condition|)
name|vchiq_log_dump_mem
argument_list|(
literal|"Sent"
argument_list|,
literal|0
argument_list|,
name|header
operator|->
name|data
operator|+
name|pos
argument_list|,
name|min
argument_list|(
literal|64
argument_list|,
name|elements
index|[
literal|0
index|]
operator|.
name|size
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|spin_lock
argument_list|(
operator|&
name|quota_spinlock
argument_list|)
expr_stmt|;
name|service_quota
operator|->
name|message_use_count
operator|++
expr_stmt|;
name|tx_end_index
operator|=
name|SLOT_QUEUE_INDEX_FROM_POS
argument_list|(
name|state
operator|->
name|local_tx_pos
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* If this transmission can't fit in the last slot used by any 		** service, the data_use_count must be increased. */
if|if
condition|(
name|tx_end_index
operator|!=
name|state
operator|->
name|previous_data_index
condition|)
block|{
name|state
operator|->
name|previous_data_index
operator|=
name|tx_end_index
expr_stmt|;
name|state
operator|->
name|data_use_count
operator|++
expr_stmt|;
block|}
comment|/* If this isn't the same slot last used by this service, 		** the service's slot_use_count must be increased. */
if|if
condition|(
name|tx_end_index
operator|!=
name|service_quota
operator|->
name|previous_tx_index
condition|)
block|{
name|service_quota
operator|->
name|previous_tx_index
operator|=
name|tx_end_index
expr_stmt|;
name|slot_use_count
operator|=
operator|++
name|service_quota
operator|->
name|slot_use_count
expr_stmt|;
block|}
else|else
block|{
name|slot_use_count
operator|=
literal|0
expr_stmt|;
block|}
name|spin_unlock
argument_list|(
operator|&
name|quota_spinlock
argument_list|)
expr_stmt|;
if|if
condition|(
name|slot_use_count
condition|)
name|vchiq_log_trace
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: qm:%d %s,%x - slot_use->%d (hdr %p)"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|service
operator|->
name|localport
argument_list|,
name|msg_type_str
argument_list|(
name|VCHIQ_MSG_TYPE
argument_list|(
name|msgid
argument_list|)
argument_list|)
argument_list|,
name|size
argument_list|,
name|slot_use_count
argument_list|,
name|header
argument_list|)
expr_stmt|;
name|VCHIQ_SERVICE_STATS_INC
argument_list|(
name|service
argument_list|,
name|ctrl_tx_count
argument_list|)
expr_stmt|;
name|VCHIQ_SERVICE_STATS_ADD
argument_list|(
name|service
argument_list|,
name|ctrl_tx_bytes
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|vchiq_log_info
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: qm %s@%x,%x (%d->%d)"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|msg_type_str
argument_list|(
name|VCHIQ_MSG_TYPE
argument_list|(
name|msgid
argument_list|)
argument_list|)
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
name|size
argument_list|,
name|VCHIQ_MSG_SRCPORT
argument_list|(
name|msgid
argument_list|)
argument_list|,
name|VCHIQ_MSG_DSTPORT
argument_list|(
name|msgid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
operator|!=
literal|0
condition|)
block|{
name|WARN_ON
argument_list|(
operator|!
operator|(
operator|(
name|count
operator|==
literal|1
operator|)
operator|&&
operator|(
name|size
operator|==
name|elements
index|[
literal|0
index|]
operator|.
name|size
operator|)
operator|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|header
operator|->
name|data
argument_list|,
name|elements
index|[
literal|0
index|]
operator|.
name|data
argument_list|,
name|elements
index|[
literal|0
index|]
operator|.
name|size
argument_list|)
expr_stmt|;
block|}
name|VCHIQ_STATS_INC
argument_list|(
name|state
argument_list|,
name|ctrl_tx_count
argument_list|)
expr_stmt|;
block|}
name|header
operator|->
name|msgid
operator|=
name|msgid
expr_stmt|;
name|header
operator|->
name|size
operator|=
name|size
expr_stmt|;
block|{
name|int
name|svc_fourcc
decl_stmt|;
name|svc_fourcc
operator|=
name|service
condition|?
name|service
operator|->
name|base
operator|.
name|fourcc
else|:
name|VCHIQ_MAKE_FOURCC
argument_list|(
literal|'?'
argument_list|,
literal|'?'
argument_list|,
literal|'?'
argument_list|,
literal|'?'
argument_list|)
expr_stmt|;
name|vchiq_log_info
argument_list|(
name|vchiq_core_msg_log_level
argument_list|,
literal|"Sent Msg %s(%u) to %c%c%c%c s:%u d:%d len:%d"
argument_list|,
name|msg_type_str
argument_list|(
name|VCHIQ_MSG_TYPE
argument_list|(
name|msgid
argument_list|)
argument_list|)
argument_list|,
name|VCHIQ_MSG_TYPE
argument_list|(
name|msgid
argument_list|)
argument_list|,
name|VCHIQ_FOURCC_AS_4CHARS
argument_list|(
name|svc_fourcc
argument_list|)
argument_list|,
name|VCHIQ_MSG_SRCPORT
argument_list|(
name|msgid
argument_list|)
argument_list|,
name|VCHIQ_MSG_DSTPORT
argument_list|(
name|msgid
argument_list|)
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
comment|/* Make sure the new header is visible to the peer. */
name|wmb
argument_list|()
expr_stmt|;
comment|/* Make the new tx_pos visible to the peer. */
name|local
operator|->
name|tx_pos
operator|=
name|state
operator|->
name|local_tx_pos
expr_stmt|;
name|wmb
argument_list|()
expr_stmt|;
if|if
condition|(
name|service
operator|&&
operator|(
name|type
operator|==
name|VCHIQ_MSG_CLOSE
operator|)
condition|)
name|vchiq_set_service_state
argument_list|(
name|service
argument_list|,
name|VCHIQ_SRVSTATE_CLOSESENT
argument_list|)
expr_stmt|;
if|if
condition|(
name|VCHIQ_MSG_TYPE
argument_list|(
name|msgid
argument_list|)
operator|!=
name|VCHIQ_MSG_PAUSE
condition|)
name|lmutex_unlock
argument_list|(
operator|&
name|state
operator|->
name|slot_mutex
argument_list|)
expr_stmt|;
name|remote_event_signal
argument_list|(
operator|&
name|state
operator|->
name|remote
operator|->
name|trigger
argument_list|)
expr_stmt|;
return|return
name|VCHIQ_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/* Called by the slot handler and application threads */
end_comment

begin_function
specifier|static
name|VCHIQ_STATUS_T
name|queue_message_sync
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|,
name|VCHIQ_SERVICE_T
modifier|*
name|service
parameter_list|,
name|int
name|msgid
parameter_list|,
specifier|const
name|VCHIQ_ELEMENT_T
modifier|*
name|elements
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|size
parameter_list|,
name|int
name|is_blocking
parameter_list|)
block|{
name|VCHIQ_SHARED_STATE_T
modifier|*
name|local
decl_stmt|;
name|VCHIQ_HEADER_T
modifier|*
name|header
decl_stmt|;
name|local
operator|=
name|state
operator|->
name|local
expr_stmt|;
if|if
condition|(
operator|(
name|VCHIQ_MSG_TYPE
argument_list|(
name|msgid
argument_list|)
operator|!=
name|VCHIQ_MSG_RESUME
operator|)
operator|&&
operator|(
name|lmutex_lock_interruptible
argument_list|(
operator|&
name|state
operator|->
name|sync_mutex
argument_list|)
operator|!=
literal|0
operator|)
condition|)
return|return
name|VCHIQ_RETRY
return|;
name|remote_event_wait
argument_list|(
operator|&
name|local
operator|->
name|sync_release
argument_list|)
expr_stmt|;
name|rmb
argument_list|()
expr_stmt|;
name|header
operator|=
operator|(
name|VCHIQ_HEADER_T
operator|*
operator|)
name|SLOT_DATA_FROM_INDEX
argument_list|(
name|state
argument_list|,
name|local
operator|->
name|slot_sync
argument_list|)
expr_stmt|;
block|{
name|int
name|oldmsgid
init|=
name|header
operator|->
name|msgid
decl_stmt|;
if|if
condition|(
name|oldmsgid
operator|!=
name|VCHIQ_MSGID_PADDING
condition|)
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: qms - msgid %x, not PADDING"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|oldmsgid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|service
condition|)
block|{
name|int
name|i
decl_stmt|,
name|pos
decl_stmt|;
name|vchiq_log_info
argument_list|(
name|vchiq_sync_log_level
argument_list|,
literal|"%d: qms %s@%x,%x (%d->%d)"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|msg_type_str
argument_list|(
name|VCHIQ_MSG_TYPE
argument_list|(
name|msgid
argument_list|)
argument_list|)
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
name|size
argument_list|,
name|VCHIQ_MSG_SRCPORT
argument_list|(
name|msgid
argument_list|)
argument_list|,
name|VCHIQ_MSG_DSTPORT
argument_list|(
name|msgid
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|pos
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|unsigned
name|int
operator|)
name|count
condition|;
name|pos
operator|+=
name|elements
index|[
name|i
operator|++
index|]
operator|.
name|size
control|)
if|if
condition|(
name|elements
index|[
name|i
index|]
operator|.
name|size
condition|)
block|{
if|if
condition|(
name|vchiq_copy_from_user
argument_list|(
name|header
operator|->
name|data
operator|+
name|pos
argument_list|,
name|elements
index|[
name|i
index|]
operator|.
name|data
argument_list|,
operator|(
name|size_t
operator|)
name|elements
index|[
name|i
index|]
operator|.
name|size
argument_list|)
operator|!=
name|VCHIQ_SUCCESS
condition|)
block|{
name|lmutex_unlock
argument_list|(
operator|&
name|state
operator|->
name|sync_mutex
argument_list|)
expr_stmt|;
name|VCHIQ_SERVICE_STATS_INC
argument_list|(
name|service
argument_list|,
name|error_count
argument_list|)
expr_stmt|;
return|return
name|VCHIQ_ERROR
return|;
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|vchiq_sync_log_level
operator|>=
name|VCHIQ_LOG_TRACE
condition|)
name|vchiq_log_dump_mem
argument_list|(
literal|"Sent Sync"
argument_list|,
literal|0
argument_list|,
name|header
operator|->
name|data
operator|+
name|pos
argument_list|,
name|min
argument_list|(
literal|64
argument_list|,
name|elements
index|[
literal|0
index|]
operator|.
name|size
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|VCHIQ_SERVICE_STATS_INC
argument_list|(
name|service
argument_list|,
name|ctrl_tx_count
argument_list|)
expr_stmt|;
name|VCHIQ_SERVICE_STATS_ADD
argument_list|(
name|service
argument_list|,
name|ctrl_tx_bytes
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|vchiq_log_info
argument_list|(
name|vchiq_sync_log_level
argument_list|,
literal|"%d: qms %s@%x,%x (%d->%d)"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|msg_type_str
argument_list|(
name|VCHIQ_MSG_TYPE
argument_list|(
name|msgid
argument_list|)
argument_list|)
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
name|size
argument_list|,
name|VCHIQ_MSG_SRCPORT
argument_list|(
name|msgid
argument_list|)
argument_list|,
name|VCHIQ_MSG_DSTPORT
argument_list|(
name|msgid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
operator|!=
literal|0
condition|)
block|{
name|WARN_ON
argument_list|(
operator|!
operator|(
operator|(
name|count
operator|==
literal|1
operator|)
operator|&&
operator|(
name|size
operator|==
name|elements
index|[
literal|0
index|]
operator|.
name|size
operator|)
operator|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|header
operator|->
name|data
argument_list|,
name|elements
index|[
literal|0
index|]
operator|.
name|data
argument_list|,
name|elements
index|[
literal|0
index|]
operator|.
name|size
argument_list|)
expr_stmt|;
block|}
name|VCHIQ_STATS_INC
argument_list|(
name|state
argument_list|,
name|ctrl_tx_count
argument_list|)
expr_stmt|;
block|}
name|header
operator|->
name|size
operator|=
name|size
expr_stmt|;
name|header
operator|->
name|msgid
operator|=
name|msgid
expr_stmt|;
if|if
condition|(
name|vchiq_sync_log_level
operator|>=
name|VCHIQ_LOG_TRACE
condition|)
block|{
name|int
name|svc_fourcc
decl_stmt|;
name|svc_fourcc
operator|=
name|service
condition|?
name|service
operator|->
name|base
operator|.
name|fourcc
else|:
name|VCHIQ_MAKE_FOURCC
argument_list|(
literal|'?'
argument_list|,
literal|'?'
argument_list|,
literal|'?'
argument_list|,
literal|'?'
argument_list|)
expr_stmt|;
name|vchiq_log_trace
argument_list|(
name|vchiq_sync_log_level
argument_list|,
literal|"Sent Sync Msg %s(%u) to %c%c%c%c s:%u d:%d len:%d"
argument_list|,
name|msg_type_str
argument_list|(
name|VCHIQ_MSG_TYPE
argument_list|(
name|msgid
argument_list|)
argument_list|)
argument_list|,
name|VCHIQ_MSG_TYPE
argument_list|(
name|msgid
argument_list|)
argument_list|,
name|VCHIQ_FOURCC_AS_4CHARS
argument_list|(
name|svc_fourcc
argument_list|)
argument_list|,
name|VCHIQ_MSG_SRCPORT
argument_list|(
name|msgid
argument_list|)
argument_list|,
name|VCHIQ_MSG_DSTPORT
argument_list|(
name|msgid
argument_list|)
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
comment|/* Make sure the new header is visible to the peer. */
name|wmb
argument_list|()
expr_stmt|;
name|remote_event_signal
argument_list|(
operator|&
name|state
operator|->
name|remote
operator|->
name|sync_trigger
argument_list|)
expr_stmt|;
if|if
condition|(
name|VCHIQ_MSG_TYPE
argument_list|(
name|msgid
argument_list|)
operator|!=
name|VCHIQ_MSG_PAUSE
condition|)
name|lmutex_unlock
argument_list|(
operator|&
name|state
operator|->
name|sync_mutex
argument_list|)
expr_stmt|;
return|return
name|VCHIQ_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|claim_slot
parameter_list|(
name|VCHIQ_SLOT_INFO_T
modifier|*
name|slot
parameter_list|)
block|{
name|slot
operator|->
name|use_count
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|release_slot
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|,
name|VCHIQ_SLOT_INFO_T
modifier|*
name|slot_info
parameter_list|,
name|VCHIQ_HEADER_T
modifier|*
name|header
parameter_list|,
name|VCHIQ_SERVICE_T
modifier|*
name|service
parameter_list|)
block|{
name|int
name|release_count
decl_stmt|;
name|lmutex_lock
argument_list|(
operator|&
name|state
operator|->
name|recycle_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|header
condition|)
block|{
name|int
name|msgid
init|=
name|header
operator|->
name|msgid
decl_stmt|;
if|if
condition|(
operator|(
operator|(
name|msgid
operator|&
name|VCHIQ_MSGID_CLAIMED
operator|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|service
operator|&&
name|service
operator|->
name|closing
operator|)
condition|)
block|{
name|lmutex_unlock
argument_list|(
operator|&
name|state
operator|->
name|recycle_mutex
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Rewrite the message header to prevent a double 		** release */
name|header
operator|->
name|msgid
operator|=
name|msgid
operator|&
operator|~
name|VCHIQ_MSGID_CLAIMED
expr_stmt|;
block|}
name|release_count
operator|=
name|slot_info
operator|->
name|release_count
expr_stmt|;
name|slot_info
operator|->
name|release_count
operator|=
operator|++
name|release_count
expr_stmt|;
if|if
condition|(
name|release_count
operator|==
name|slot_info
operator|->
name|use_count
condition|)
block|{
name|int
name|slot_queue_recycle
decl_stmt|;
comment|/* Add to the freed queue */
comment|/* A read barrier is necessary here to prevent speculative 		** fetches of remote->slot_queue_recycle from overtaking the 		** mutex. */
name|rmb
argument_list|()
expr_stmt|;
name|slot_queue_recycle
operator|=
name|state
operator|->
name|remote
operator|->
name|slot_queue_recycle
expr_stmt|;
name|state
operator|->
name|remote
operator|->
name|slot_queue
index|[
name|slot_queue_recycle
operator|&
name|VCHIQ_SLOT_QUEUE_MASK
index|]
operator|=
name|SLOT_INDEX_FROM_INFO
argument_list|(
name|state
argument_list|,
name|slot_info
argument_list|)
expr_stmt|;
name|state
operator|->
name|remote
operator|->
name|slot_queue_recycle
operator|=
name|slot_queue_recycle
operator|+
literal|1
expr_stmt|;
name|vchiq_log_info
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: release_slot %d - recycle->%x"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|SLOT_INDEX_FROM_INFO
argument_list|(
name|state
argument_list|,
name|slot_info
argument_list|)
argument_list|,
name|state
operator|->
name|remote
operator|->
name|slot_queue_recycle
argument_list|)
expr_stmt|;
comment|/* A write barrier is necessary, but remote_event_signal 		** contains one. */
name|remote_event_signal
argument_list|(
operator|&
name|state
operator|->
name|remote
operator|->
name|recycle
argument_list|)
expr_stmt|;
block|}
name|lmutex_unlock
argument_list|(
operator|&
name|state
operator|->
name|recycle_mutex
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Called by the slot handler - don't hold the bulk mutex */
end_comment

begin_function
specifier|static
name|VCHIQ_STATUS_T
name|notify_bulks
parameter_list|(
name|VCHIQ_SERVICE_T
modifier|*
name|service
parameter_list|,
name|VCHIQ_BULK_QUEUE_T
modifier|*
name|queue
parameter_list|,
name|int
name|retry_poll
parameter_list|)
block|{
name|VCHIQ_STATUS_T
name|status
init|=
name|VCHIQ_SUCCESS
decl_stmt|;
name|vchiq_log_trace
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: nb:%d %cx - p=%x rn=%x r=%x"
argument_list|,
name|service
operator|->
name|state
operator|->
name|id
argument_list|,
name|service
operator|->
name|localport
argument_list|,
operator|(
name|queue
operator|==
operator|&
name|service
operator|->
name|bulk_tx
operator|)
condition|?
literal|'t'
else|:
literal|'r'
argument_list|,
name|queue
operator|->
name|process
argument_list|,
name|queue
operator|->
name|remote_notify
argument_list|,
name|queue
operator|->
name|remove
argument_list|)
expr_stmt|;
if|if
condition|(
name|service
operator|->
name|state
operator|->
name|is_master
condition|)
block|{
while|while
condition|(
name|queue
operator|->
name|remote_notify
operator|!=
name|queue
operator|->
name|process
condition|)
block|{
name|VCHIQ_BULK_T
modifier|*
name|bulk
init|=
operator|&
name|queue
operator|->
name|bulks
index|[
name|BULK_INDEX
argument_list|(
name|queue
operator|->
name|remote_notify
argument_list|)
index|]
decl_stmt|;
name|int
name|msgtype
init|=
operator|(
name|bulk
operator|->
name|dir
operator|==
name|VCHIQ_BULK_TRANSMIT
operator|)
condition|?
name|VCHIQ_MSG_BULK_RX_DONE
else|:
name|VCHIQ_MSG_BULK_TX_DONE
decl_stmt|;
name|int
name|msgid
init|=
name|VCHIQ_MAKE_MSG
argument_list|(
name|msgtype
argument_list|,
name|service
operator|->
name|localport
argument_list|,
name|service
operator|->
name|remoteport
argument_list|)
decl_stmt|;
name|VCHIQ_ELEMENT_T
name|element
init|=
block|{
operator|&
name|bulk
operator|->
name|actual
block|,
literal|4
block|}
decl_stmt|;
comment|/* Only reply to non-dummy bulk requests */
if|if
condition|(
name|bulk
operator|->
name|remote_data
condition|)
block|{
name|status
operator|=
name|queue_message
argument_list|(
name|service
operator|->
name|state
argument_list|,
name|NULL
argument_list|,
name|msgid
argument_list|,
operator|&
name|element
argument_list|,
literal|1
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VCHIQ_SUCCESS
condition|)
break|break;
block|}
name|queue
operator|->
name|remote_notify
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
name|queue
operator|->
name|remote_notify
operator|=
name|queue
operator|->
name|process
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|VCHIQ_SUCCESS
condition|)
block|{
while|while
condition|(
name|queue
operator|->
name|remove
operator|!=
name|queue
operator|->
name|remote_notify
condition|)
block|{
name|VCHIQ_BULK_T
modifier|*
name|bulk
init|=
operator|&
name|queue
operator|->
name|bulks
index|[
name|BULK_INDEX
argument_list|(
name|queue
operator|->
name|remove
argument_list|)
index|]
decl_stmt|;
comment|/* Only generate callbacks for non-dummy bulk 			** requests, and non-terminated services */
if|if
condition|(
name|bulk
operator|->
name|data
operator|&&
name|service
operator|->
name|instance
condition|)
block|{
if|if
condition|(
name|bulk
operator|->
name|actual
operator|!=
name|VCHIQ_BULK_ACTUAL_ABORTED
condition|)
block|{
if|if
condition|(
name|bulk
operator|->
name|dir
operator|==
name|VCHIQ_BULK_TRANSMIT
condition|)
block|{
name|VCHIQ_SERVICE_STATS_INC
argument_list|(
name|service
argument_list|,
name|bulk_tx_count
argument_list|)
expr_stmt|;
name|VCHIQ_SERVICE_STATS_ADD
argument_list|(
name|service
argument_list|,
name|bulk_tx_bytes
argument_list|,
name|bulk
operator|->
name|actual
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|VCHIQ_SERVICE_STATS_INC
argument_list|(
name|service
argument_list|,
name|bulk_rx_count
argument_list|)
expr_stmt|;
name|VCHIQ_SERVICE_STATS_ADD
argument_list|(
name|service
argument_list|,
name|bulk_rx_bytes
argument_list|,
name|bulk
operator|->
name|actual
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|VCHIQ_SERVICE_STATS_INC
argument_list|(
name|service
argument_list|,
name|bulk_aborted_count
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bulk
operator|->
name|mode
operator|==
name|VCHIQ_BULK_MODE_BLOCKING
condition|)
block|{
name|struct
name|bulk_waiter
modifier|*
name|waiter
decl_stmt|;
name|spin_lock
argument_list|(
operator|&
name|bulk_waiter_spinlock
argument_list|)
expr_stmt|;
name|waiter
operator|=
name|bulk
operator|->
name|userdata
expr_stmt|;
if|if
condition|(
name|waiter
condition|)
block|{
name|waiter
operator|->
name|actual
operator|=
name|bulk
operator|->
name|actual
expr_stmt|;
name|up
argument_list|(
operator|&
name|waiter
operator|->
name|event
argument_list|)
expr_stmt|;
block|}
name|spin_unlock
argument_list|(
operator|&
name|bulk_waiter_spinlock
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bulk
operator|->
name|mode
operator|==
name|VCHIQ_BULK_MODE_CALLBACK
condition|)
block|{
name|VCHIQ_REASON_T
name|reason
init|=
operator|(
name|bulk
operator|->
name|dir
operator|==
name|VCHIQ_BULK_TRANSMIT
operator|)
condition|?
operator|(
operator|(
name|bulk
operator|->
name|actual
operator|==
name|VCHIQ_BULK_ACTUAL_ABORTED
operator|)
condition|?
name|VCHIQ_BULK_TRANSMIT_ABORTED
else|:
name|VCHIQ_BULK_TRANSMIT_DONE
operator|)
else|:
operator|(
operator|(
name|bulk
operator|->
name|actual
operator|==
name|VCHIQ_BULK_ACTUAL_ABORTED
operator|)
condition|?
name|VCHIQ_BULK_RECEIVE_ABORTED
else|:
name|VCHIQ_BULK_RECEIVE_DONE
operator|)
decl_stmt|;
name|status
operator|=
name|make_service_callback
argument_list|(
name|service
argument_list|,
name|reason
argument_list|,
name|NULL
argument_list|,
name|bulk
operator|->
name|userdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|VCHIQ_RETRY
condition|)
break|break;
block|}
block|}
name|queue
operator|->
name|remove
operator|++
expr_stmt|;
name|up
argument_list|(
operator|&
name|service
operator|->
name|bulk_remove_event
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|retry_poll
condition|)
name|status
operator|=
name|VCHIQ_SUCCESS
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|VCHIQ_RETRY
condition|)
name|request_poll
argument_list|(
name|service
operator|->
name|state
argument_list|,
name|service
argument_list|,
operator|(
name|queue
operator|==
operator|&
name|service
operator|->
name|bulk_tx
operator|)
condition|?
name|VCHIQ_POLL_TXNOTIFY
else|:
name|VCHIQ_POLL_RXNOTIFY
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/* Called by the slot handler thread */
end_comment

begin_function
specifier|static
name|void
name|poll_services
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|)
block|{
name|int
name|group
decl_stmt|,
name|i
decl_stmt|;
for|for
control|(
name|group
operator|=
literal|0
init|;
name|group
operator|<
name|BITSET_SIZE
argument_list|(
name|state
operator|->
name|unused_service
argument_list|)
condition|;
name|group
operator|++
control|)
block|{
name|uint32_t
name|flags
decl_stmt|;
name|flags
operator|=
name|atomic_xchg
argument_list|(
operator|&
name|state
operator|->
name|poll_services
index|[
name|group
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|flags
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|flags
operator|&
operator|(
literal|1
operator|<<
name|i
operator|)
condition|)
block|{
name|VCHIQ_SERVICE_T
modifier|*
name|service
init|=
name|find_service_by_port
argument_list|(
name|state
argument_list|,
operator|(
name|group
operator|<<
literal|5
operator|)
operator|+
name|i
argument_list|)
decl_stmt|;
name|uint32_t
name|service_flags
decl_stmt|;
name|flags
operator|&=
operator|~
operator|(
literal|1
operator|<<
name|i
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|service
condition|)
continue|continue;
name|service_flags
operator|=
name|atomic_xchg
argument_list|(
operator|&
name|service
operator|->
name|poll_flags
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|service_flags
operator|&
operator|(
literal|1
operator|<<
name|VCHIQ_POLL_REMOVE
operator|)
condition|)
block|{
name|vchiq_log_info
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: ps - remove %d<->%d"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|service
operator|->
name|localport
argument_list|,
name|service
operator|->
name|remoteport
argument_list|)
expr_stmt|;
comment|/* Make it look like a client, because 					   it must be removed and not left in 					   the LISTENING state. */
name|service
operator|->
name|public_fourcc
operator|=
name|VCHIQ_FOURCC_INVALID
expr_stmt|;
if|if
condition|(
name|vchiq_close_service_internal
argument_list|(
name|service
argument_list|,
literal|0
comment|/*!close_recvd*/
argument_list|)
operator|!=
name|VCHIQ_SUCCESS
condition|)
name|request_poll
argument_list|(
name|state
argument_list|,
name|service
argument_list|,
name|VCHIQ_POLL_REMOVE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|service_flags
operator|&
operator|(
literal|1
operator|<<
name|VCHIQ_POLL_TERMINATE
operator|)
condition|)
block|{
name|vchiq_log_info
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: ps - terminate %d<->%d"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|service
operator|->
name|localport
argument_list|,
name|service
operator|->
name|remoteport
argument_list|)
expr_stmt|;
if|if
condition|(
name|vchiq_close_service_internal
argument_list|(
name|service
argument_list|,
literal|0
comment|/*!close_recvd*/
argument_list|)
operator|!=
name|VCHIQ_SUCCESS
condition|)
name|request_poll
argument_list|(
name|state
argument_list|,
name|service
argument_list|,
name|VCHIQ_POLL_TERMINATE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|service_flags
operator|&
operator|(
literal|1
operator|<<
name|VCHIQ_POLL_TXNOTIFY
operator|)
condition|)
name|notify_bulks
argument_list|(
name|service
argument_list|,
operator|&
name|service
operator|->
name|bulk_tx
argument_list|,
literal|1
comment|/*retry_poll*/
argument_list|)
expr_stmt|;
if|if
condition|(
name|service_flags
operator|&
operator|(
literal|1
operator|<<
name|VCHIQ_POLL_RXNOTIFY
operator|)
condition|)
name|notify_bulks
argument_list|(
name|service
argument_list|,
operator|&
name|service
operator|->
name|bulk_rx
argument_list|,
literal|1
comment|/*retry_poll*/
argument_list|)
expr_stmt|;
name|unlock_service
argument_list|(
name|service
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_comment
comment|/* Called by the slot handler or application threads, holding the bulk mutex. */
end_comment

begin_function
specifier|static
name|int
name|resolve_bulks
parameter_list|(
name|VCHIQ_SERVICE_T
modifier|*
name|service
parameter_list|,
name|VCHIQ_BULK_QUEUE_T
modifier|*
name|queue
parameter_list|)
block|{
name|VCHIQ_STATE_T
modifier|*
name|state
init|=
name|service
operator|->
name|state
decl_stmt|;
name|int
name|resolved
init|=
literal|0
decl_stmt|;
name|int
name|rc
decl_stmt|;
while|while
condition|(
operator|(
name|queue
operator|->
name|process
operator|!=
name|queue
operator|->
name|local_insert
operator|)
operator|&&
operator|(
name|queue
operator|->
name|process
operator|!=
name|queue
operator|->
name|remote_insert
operator|)
condition|)
block|{
name|VCHIQ_BULK_T
modifier|*
name|bulk
init|=
operator|&
name|queue
operator|->
name|bulks
index|[
name|BULK_INDEX
argument_list|(
name|queue
operator|->
name|process
argument_list|)
index|]
decl_stmt|;
name|vchiq_log_trace
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: rb:%d %cx - li=%x ri=%x p=%x"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|service
operator|->
name|localport
argument_list|,
operator|(
name|queue
operator|==
operator|&
name|service
operator|->
name|bulk_tx
operator|)
condition|?
literal|'t'
else|:
literal|'r'
argument_list|,
name|queue
operator|->
name|local_insert
argument_list|,
name|queue
operator|->
name|remote_insert
argument_list|,
name|queue
operator|->
name|process
argument_list|)
expr_stmt|;
name|WARN_ON
argument_list|(
operator|!
operator|(
call|(
name|int
call|)
argument_list|(
name|queue
operator|->
name|local_insert
operator|-
name|queue
operator|->
name|process
argument_list|)
operator|>
literal|0
operator|)
argument_list|)
expr_stmt|;
name|WARN_ON
argument_list|(
operator|!
operator|(
call|(
name|int
call|)
argument_list|(
name|queue
operator|->
name|remote_insert
operator|-
name|queue
operator|->
name|process
argument_list|)
operator|>
literal|0
operator|)
argument_list|)
expr_stmt|;
name|rc
operator|=
name|lmutex_lock_interruptible
argument_list|(
operator|&
name|state
operator|->
name|bulk_transfer_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
break|break;
name|vchiq_transfer_bulk
argument_list|(
name|bulk
argument_list|)
expr_stmt|;
name|lmutex_unlock
argument_list|(
operator|&
name|state
operator|->
name|bulk_transfer_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|vchiq_core_msg_log_level
operator|>=
name|VCHIQ_LOG_INFO
condition|)
block|{
specifier|const
name|char
modifier|*
name|header
init|=
operator|(
name|queue
operator|==
operator|&
name|service
operator|->
name|bulk_tx
operator|)
condition|?
literal|"Send Bulk to"
else|:
literal|"Recv Bulk from"
decl_stmt|;
if|if
condition|(
name|bulk
operator|->
name|actual
operator|!=
name|VCHIQ_BULK_ACTUAL_ABORTED
condition|)
name|vchiq_log_info
argument_list|(
name|vchiq_core_msg_log_level
argument_list|,
literal|"%s %c%c%c%c d:%d len:%d %x<->%x"
argument_list|,
name|header
argument_list|,
name|VCHIQ_FOURCC_AS_4CHARS
argument_list|(
name|service
operator|->
name|base
operator|.
name|fourcc
argument_list|)
argument_list|,
name|service
operator|->
name|remoteport
argument_list|,
name|bulk
operator|->
name|size
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|bulk
operator|->
name|data
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|bulk
operator|->
name|remote_data
argument_list|)
expr_stmt|;
else|else
name|vchiq_log_info
argument_list|(
name|vchiq_core_msg_log_level
argument_list|,
literal|"%s %c%c%c%c d:%d ABORTED - tx len:%d,"
literal|" rx len:%d %x<->%x"
argument_list|,
name|header
argument_list|,
name|VCHIQ_FOURCC_AS_4CHARS
argument_list|(
name|service
operator|->
name|base
operator|.
name|fourcc
argument_list|)
argument_list|,
name|service
operator|->
name|remoteport
argument_list|,
name|bulk
operator|->
name|size
argument_list|,
name|bulk
operator|->
name|remote_size
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|bulk
operator|->
name|data
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|bulk
operator|->
name|remote_data
argument_list|)
expr_stmt|;
block|}
name|vchiq_complete_bulk
argument_list|(
name|bulk
argument_list|)
expr_stmt|;
name|queue
operator|->
name|process
operator|++
expr_stmt|;
name|resolved
operator|++
expr_stmt|;
block|}
return|return
name|resolved
return|;
block|}
end_function

begin_comment
comment|/* Called with the bulk_mutex held */
end_comment

begin_function
specifier|static
name|void
name|abort_outstanding_bulks
parameter_list|(
name|VCHIQ_SERVICE_T
modifier|*
name|service
parameter_list|,
name|VCHIQ_BULK_QUEUE_T
modifier|*
name|queue
parameter_list|)
block|{
name|int
name|is_tx
init|=
operator|(
name|queue
operator|==
operator|&
name|service
operator|->
name|bulk_tx
operator|)
decl_stmt|;
name|vchiq_log_trace
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: aob:%d %cx - li=%x ri=%x p=%x"
argument_list|,
name|service
operator|->
name|state
operator|->
name|id
argument_list|,
name|service
operator|->
name|localport
argument_list|,
name|is_tx
condition|?
literal|'t'
else|:
literal|'r'
argument_list|,
name|queue
operator|->
name|local_insert
argument_list|,
name|queue
operator|->
name|remote_insert
argument_list|,
name|queue
operator|->
name|process
argument_list|)
expr_stmt|;
name|WARN_ON
argument_list|(
operator|!
operator|(
call|(
name|int
call|)
argument_list|(
name|queue
operator|->
name|local_insert
operator|-
name|queue
operator|->
name|process
argument_list|)
operator|>=
literal|0
operator|)
argument_list|)
expr_stmt|;
name|WARN_ON
argument_list|(
operator|!
operator|(
call|(
name|int
call|)
argument_list|(
name|queue
operator|->
name|remote_insert
operator|-
name|queue
operator|->
name|process
argument_list|)
operator|>=
literal|0
operator|)
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|queue
operator|->
name|process
operator|!=
name|queue
operator|->
name|local_insert
operator|)
operator|||
operator|(
name|queue
operator|->
name|process
operator|!=
name|queue
operator|->
name|remote_insert
operator|)
condition|)
block|{
name|VCHIQ_BULK_T
modifier|*
name|bulk
init|=
operator|&
name|queue
operator|->
name|bulks
index|[
name|BULK_INDEX
argument_list|(
name|queue
operator|->
name|process
argument_list|)
index|]
decl_stmt|;
if|if
condition|(
name|queue
operator|->
name|process
operator|==
name|queue
operator|->
name|remote_insert
condition|)
block|{
comment|/* fabricate a matching dummy bulk */
name|bulk
operator|->
name|remote_data
operator|=
name|NULL
expr_stmt|;
name|bulk
operator|->
name|remote_size
operator|=
literal|0
expr_stmt|;
name|queue
operator|->
name|remote_insert
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|queue
operator|->
name|process
operator|!=
name|queue
operator|->
name|local_insert
condition|)
block|{
name|vchiq_complete_bulk
argument_list|(
name|bulk
argument_list|)
expr_stmt|;
name|vchiq_log_info
argument_list|(
name|vchiq_core_msg_log_level
argument_list|,
literal|"%s %c%c%c%c d:%d ABORTED - tx len:%d, "
literal|"rx len:%d"
argument_list|,
name|is_tx
condition|?
literal|"Send Bulk to"
else|:
literal|"Recv Bulk from"
argument_list|,
name|VCHIQ_FOURCC_AS_4CHARS
argument_list|(
name|service
operator|->
name|base
operator|.
name|fourcc
argument_list|)
argument_list|,
name|service
operator|->
name|remoteport
argument_list|,
name|bulk
operator|->
name|size
argument_list|,
name|bulk
operator|->
name|remote_size
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* fabricate a matching dummy bulk */
name|bulk
operator|->
name|data
operator|=
name|NULL
expr_stmt|;
name|bulk
operator|->
name|size
operator|=
literal|0
expr_stmt|;
name|bulk
operator|->
name|actual
operator|=
name|VCHIQ_BULK_ACTUAL_ABORTED
expr_stmt|;
name|bulk
operator|->
name|dir
operator|=
name|is_tx
condition|?
name|VCHIQ_BULK_TRANSMIT
else|:
name|VCHIQ_BULK_RECEIVE
expr_stmt|;
name|queue
operator|->
name|local_insert
operator|++
expr_stmt|;
block|}
name|queue
operator|->
name|process
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Called from the slot handler thread */
end_comment

begin_function
specifier|static
name|void
name|pause_bulks
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|)
block|{
if|if
condition|(
name|unlikely
argument_list|(
name|atomic_inc_return
argument_list|(
operator|&
name|pause_bulks_count
argument_list|)
operator|!=
literal|1
argument_list|)
condition|)
block|{
name|WARN_ON_ONCE
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|pause_bulks_count
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Block bulk transfers from all services */
name|lmutex_lock
argument_list|(
operator|&
name|state
operator|->
name|bulk_transfer_mutex
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Called from the slot handler thread */
end_comment

begin_function
specifier|static
name|void
name|resume_bulks
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|atomic_dec_return
argument_list|(
operator|&
name|pause_bulks_count
argument_list|)
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|WARN_ON_ONCE
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|pause_bulks_count
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Allow bulk transfers from all services */
name|lmutex_unlock
argument_list|(
operator|&
name|state
operator|->
name|bulk_transfer_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|->
name|deferred_bulks
operator|==
literal|0
condition|)
return|return;
comment|/* Deal with any bulks which had to be deferred due to being in 	 * paused state.  Don't try to match up to number of deferred bulks 	 * in case we've had something come and close the service in the 	 * interim - just process all bulk queues for all services */
name|vchiq_log_info
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%s: processing %d deferred bulks"
argument_list|,
name|__func__
argument_list|,
name|state
operator|->
name|deferred_bulks
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|state
operator|->
name|unused_service
condition|;
name|i
operator|++
control|)
block|{
name|VCHIQ_SERVICE_T
modifier|*
name|service
init|=
name|state
operator|->
name|services
index|[
name|i
index|]
decl_stmt|;
name|int
name|resolved_rx
init|=
literal|0
decl_stmt|;
name|int
name|resolved_tx
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|service
operator|||
operator|(
name|service
operator|->
name|srvstate
operator|!=
name|VCHIQ_SRVSTATE_OPEN
operator|)
condition|)
continue|continue;
name|lmutex_lock
argument_list|(
operator|&
name|service
operator|->
name|bulk_mutex
argument_list|)
expr_stmt|;
name|resolved_rx
operator|=
name|resolve_bulks
argument_list|(
name|service
argument_list|,
operator|&
name|service
operator|->
name|bulk_rx
argument_list|)
expr_stmt|;
name|resolved_tx
operator|=
name|resolve_bulks
argument_list|(
name|service
argument_list|,
operator|&
name|service
operator|->
name|bulk_tx
argument_list|)
expr_stmt|;
name|lmutex_unlock
argument_list|(
operator|&
name|service
operator|->
name|bulk_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|resolved_rx
condition|)
name|notify_bulks
argument_list|(
name|service
argument_list|,
operator|&
name|service
operator|->
name|bulk_rx
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|resolved_tx
condition|)
name|notify_bulks
argument_list|(
name|service
argument_list|,
operator|&
name|service
operator|->
name|bulk_tx
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|state
operator|->
name|deferred_bulks
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|parse_open
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|,
name|VCHIQ_HEADER_T
modifier|*
name|header
parameter_list|)
block|{
name|VCHIQ_SERVICE_T
modifier|*
name|service
init|=
name|NULL
decl_stmt|;
name|int
name|msgid
decl_stmt|,
name|size
decl_stmt|;
name|unsigned
name|int
name|localport
decl_stmt|,
name|remoteport
decl_stmt|;
name|msgid
operator|=
name|header
operator|->
name|msgid
expr_stmt|;
name|size
operator|=
name|header
operator|->
name|size
expr_stmt|;
comment|//int type = VCHIQ_MSG_TYPE(msgid);
name|localport
operator|=
name|VCHIQ_MSG_DSTPORT
argument_list|(
name|msgid
argument_list|)
expr_stmt|;
name|remoteport
operator|=
name|VCHIQ_MSG_SRCPORT
argument_list|(
name|msgid
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
operator|>=
sizeof|sizeof
argument_list|(
expr|struct
name|vchiq_open_payload
argument_list|)
condition|)
block|{
specifier|const
name|struct
name|vchiq_open_payload
modifier|*
name|payload
init|=
operator|(
expr|struct
name|vchiq_open_payload
operator|*
operator|)
name|header
operator|->
name|data
decl_stmt|;
name|unsigned
name|int
name|fourcc
decl_stmt|;
name|fourcc
operator|=
name|payload
operator|->
name|fourcc
expr_stmt|;
name|vchiq_log_info
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: prs OPEN@%x (%d->'%c%c%c%c')"
argument_list|,
name|state
operator|->
name|id
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
name|localport
argument_list|,
name|VCHIQ_FOURCC_AS_4CHARS
argument_list|(
name|fourcc
argument_list|)
argument_list|)
expr_stmt|;
name|service
operator|=
name|get_listening_service
argument_list|(
name|state
argument_list|,
name|fourcc
argument_list|)
expr_stmt|;
if|if
condition|(
name|service
condition|)
block|{
comment|/* A matching service exists */
name|short
name|v
init|=
name|payload
operator|->
name|version
decl_stmt|;
name|short
name|version_min
init|=
name|payload
operator|->
name|version_min
decl_stmt|;
if|if
condition|(
operator|(
name|service
operator|->
name|version
operator|<
name|version_min
operator|)
operator|||
operator|(
name|v
operator|<
name|service
operator|->
name|version_min
operator|)
condition|)
block|{
comment|/* Version mismatch */
name|vchiq_loud_error_header
argument_list|()
expr_stmt|;
name|vchiq_loud_error
argument_list|(
literal|"%d: service %d (%c%c%c%c) "
literal|"version mismatch - local (%d, min %d)"
literal|" vs. remote (%d, min %d)"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|service
operator|->
name|localport
argument_list|,
name|VCHIQ_FOURCC_AS_4CHARS
argument_list|(
name|fourcc
argument_list|)
argument_list|,
name|service
operator|->
name|version
argument_list|,
name|service
operator|->
name|version_min
argument_list|,
name|v
argument_list|,
name|version_min
argument_list|)
expr_stmt|;
name|vchiq_loud_error_footer
argument_list|()
expr_stmt|;
name|unlock_service
argument_list|(
name|service
argument_list|)
expr_stmt|;
goto|goto
name|fail_open
goto|;
block|}
name|service
operator|->
name|peer_version
operator|=
name|v
expr_stmt|;
if|if
condition|(
name|service
operator|->
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_LISTENING
condition|)
block|{
name|struct
name|vchiq_openack_payload
name|ack_payload
init|=
block|{
name|service
operator|->
name|version
block|}
decl_stmt|;
name|VCHIQ_ELEMENT_T
name|body
init|=
block|{
operator|&
name|ack_payload
block|,
expr|sizeof
operator|(
name|ack_payload
operator|)
block|}
decl_stmt|;
comment|/* Acknowledge the OPEN */
if|if
condition|(
name|service
operator|->
name|sync
condition|)
block|{
if|if
condition|(
name|queue_message_sync
argument_list|(
name|state
argument_list|,
name|NULL
argument_list|,
name|VCHIQ_MAKE_MSG
argument_list|(
name|VCHIQ_MSG_OPENACK
argument_list|,
name|service
operator|->
name|localport
argument_list|,
name|remoteport
argument_list|)
argument_list|,
operator|&
name|body
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|ack_payload
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|==
name|VCHIQ_RETRY
condition|)
goto|goto
name|bail_not_ready
goto|;
block|}
else|else
block|{
if|if
condition|(
name|queue_message
argument_list|(
name|state
argument_list|,
name|NULL
argument_list|,
name|VCHIQ_MAKE_MSG
argument_list|(
name|VCHIQ_MSG_OPENACK
argument_list|,
name|service
operator|->
name|localport
argument_list|,
name|remoteport
argument_list|)
argument_list|,
operator|&
name|body
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|ack_payload
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|==
name|VCHIQ_RETRY
condition|)
goto|goto
name|bail_not_ready
goto|;
block|}
comment|/* The service is now open */
name|vchiq_set_service_state
argument_list|(
name|service
argument_list|,
name|service
operator|->
name|sync
condition|?
name|VCHIQ_SRVSTATE_OPENSYNC
else|:
name|VCHIQ_SRVSTATE_OPEN
argument_list|)
expr_stmt|;
block|}
name|service
operator|->
name|remoteport
operator|=
name|remoteport
expr_stmt|;
name|service
operator|->
name|client_id
operator|=
operator|(
operator|(
name|int
operator|*
operator|)
name|header
operator|->
name|data
operator|)
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|make_service_callback
argument_list|(
name|service
argument_list|,
name|VCHIQ_SERVICE_OPENED
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|==
name|VCHIQ_RETRY
condition|)
block|{
comment|/* Bail out if not ready */
name|service
operator|->
name|remoteport
operator|=
name|VCHIQ_PORT_FREE
expr_stmt|;
goto|goto
name|bail_not_ready
goto|;
block|}
comment|/* Success - the message has been dealt with */
name|unlock_service
argument_list|(
name|service
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
name|fail_open
label|:
comment|/* No available service, or an invalid request - send a CLOSE */
if|if
condition|(
name|queue_message
argument_list|(
name|state
argument_list|,
name|NULL
argument_list|,
name|VCHIQ_MAKE_MSG
argument_list|(
name|VCHIQ_MSG_CLOSE
argument_list|,
literal|0
argument_list|,
name|VCHIQ_MSG_SRCPORT
argument_list|(
name|msgid
argument_list|)
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|==
name|VCHIQ_RETRY
condition|)
goto|goto
name|bail_not_ready
goto|;
return|return
literal|1
return|;
name|bail_not_ready
label|:
if|if
condition|(
name|service
condition|)
name|unlock_service
argument_list|(
name|service
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Called by the slot handler thread */
end_comment

begin_function
specifier|static
name|void
name|parse_rx_slots
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|)
block|{
name|VCHIQ_SHARED_STATE_T
modifier|*
name|remote
init|=
name|state
operator|->
name|remote
decl_stmt|;
name|VCHIQ_SERVICE_T
modifier|*
name|service
init|=
name|NULL
decl_stmt|;
name|int
name|tx_pos
decl_stmt|;
name|DEBUG_INITIALISE
argument_list|(
argument|state->local
argument_list|)
name|tx_pos
operator|=
name|remote
operator|->
name|tx_pos
expr_stmt|;
while|while
condition|(
name|state
operator|->
name|rx_pos
operator|!=
name|tx_pos
condition|)
block|{
name|VCHIQ_HEADER_T
modifier|*
name|header
decl_stmt|;
name|int
name|msgid
decl_stmt|,
name|size
decl_stmt|;
name|int
name|type
decl_stmt|;
name|unsigned
name|int
name|localport
decl_stmt|,
name|remoteport
decl_stmt|;
name|DEBUG_TRACE
argument_list|(
name|PARSE_LINE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|state
operator|->
name|rx_data
condition|)
block|{
name|int
name|rx_index
decl_stmt|;
name|WARN_ON
argument_list|(
operator|!
operator|(
operator|(
name|state
operator|->
name|rx_pos
operator|&
name|VCHIQ_SLOT_MASK
operator|)
operator|==
literal|0
operator|)
argument_list|)
expr_stmt|;
name|rx_index
operator|=
name|remote
operator|->
name|slot_queue
index|[
name|SLOT_QUEUE_INDEX_FROM_POS
argument_list|(
name|state
operator|->
name|rx_pos
argument_list|)
operator|&
name|VCHIQ_SLOT_QUEUE_MASK
index|]
expr_stmt|;
name|state
operator|->
name|rx_data
operator|=
operator|(
name|char
operator|*
operator|)
name|SLOT_DATA_FROM_INDEX
argument_list|(
name|state
argument_list|,
name|rx_index
argument_list|)
expr_stmt|;
name|state
operator|->
name|rx_info
operator|=
name|SLOT_INFO_FROM_INDEX
argument_list|(
name|state
argument_list|,
name|rx_index
argument_list|)
expr_stmt|;
comment|/* Initialise use_count to one, and increment 			** release_count at the end of the slot to avoid 			** releasing the slot prematurely. */
name|state
operator|->
name|rx_info
operator|->
name|use_count
operator|=
literal|1
expr_stmt|;
name|state
operator|->
name|rx_info
operator|->
name|release_count
operator|=
literal|0
expr_stmt|;
block|}
name|header
operator|=
operator|(
name|VCHIQ_HEADER_T
operator|*
operator|)
operator|(
name|state
operator|->
name|rx_data
operator|+
operator|(
name|state
operator|->
name|rx_pos
operator|&
name|VCHIQ_SLOT_MASK
operator|)
operator|)
expr_stmt|;
name|DEBUG_VALUE
argument_list|(
name|PARSE_HEADER
argument_list|,
operator|(
name|int
operator|)
name|header
argument_list|)
expr_stmt|;
name|msgid
operator|=
name|header
operator|->
name|msgid
expr_stmt|;
name|DEBUG_VALUE
argument_list|(
name|PARSE_MSGID
argument_list|,
name|msgid
argument_list|)
expr_stmt|;
name|size
operator|=
name|header
operator|->
name|size
expr_stmt|;
name|type
operator|=
name|VCHIQ_MSG_TYPE
argument_list|(
name|msgid
argument_list|)
expr_stmt|;
name|localport
operator|=
name|VCHIQ_MSG_DSTPORT
argument_list|(
name|msgid
argument_list|)
expr_stmt|;
name|remoteport
operator|=
name|VCHIQ_MSG_SRCPORT
argument_list|(
name|msgid
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|!=
name|VCHIQ_MSG_DATA
condition|)
name|VCHIQ_STATS_INC
argument_list|(
name|state
argument_list|,
name|ctrl_rx_count
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|VCHIQ_MSG_OPENACK
case|:
case|case
name|VCHIQ_MSG_CLOSE
case|:
case|case
name|VCHIQ_MSG_DATA
case|:
case|case
name|VCHIQ_MSG_BULK_RX
case|:
case|case
name|VCHIQ_MSG_BULK_TX
case|:
case|case
name|VCHIQ_MSG_BULK_RX_DONE
case|:
case|case
name|VCHIQ_MSG_BULK_TX_DONE
case|:
name|service
operator|=
name|find_service_by_port
argument_list|(
name|state
argument_list|,
name|localport
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|service
operator|||
name|service
operator|->
name|remoteport
operator|!=
name|remoteport
operator|)
operator|&&
operator|(
name|localport
operator|==
literal|0
operator|)
operator|&&
operator|(
name|type
operator|==
name|VCHIQ_MSG_CLOSE
operator|)
condition|)
block|{
comment|/* This could be a CLOSE from a client which 				   hadn't yet received the OPENACK - look for 				   the connected service */
if|if
condition|(
name|service
condition|)
name|unlock_service
argument_list|(
name|service
argument_list|)
expr_stmt|;
name|service
operator|=
name|get_connected_service
argument_list|(
name|state
argument_list|,
name|remoteport
argument_list|)
expr_stmt|;
if|if
condition|(
name|service
condition|)
name|vchiq_log_warning
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: prs %s@%x (%d->%d) - "
literal|"found connected service %d"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|msg_type_str
argument_list|(
name|type
argument_list|)
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
name|remoteport
argument_list|,
name|localport
argument_list|,
name|service
operator|->
name|localport
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|service
condition|)
block|{
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: prs %s@%x (%d->%d) - "
literal|"invalid/closed service %d"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|msg_type_str
argument_list|(
name|type
argument_list|)
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
name|remoteport
argument_list|,
name|localport
argument_list|,
name|localport
argument_list|)
expr_stmt|;
goto|goto
name|skip_message
goto|;
block|}
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|vchiq_core_msg_log_level
operator|>=
name|VCHIQ_LOG_INFO
condition|)
block|{
name|int
name|svc_fourcc
decl_stmt|;
name|svc_fourcc
operator|=
name|service
condition|?
name|service
operator|->
name|base
operator|.
name|fourcc
else|:
name|VCHIQ_MAKE_FOURCC
argument_list|(
literal|'?'
argument_list|,
literal|'?'
argument_list|,
literal|'?'
argument_list|,
literal|'?'
argument_list|)
expr_stmt|;
name|vchiq_log_info
argument_list|(
name|vchiq_core_msg_log_level
argument_list|,
literal|"Rcvd Msg %s(%u) from %c%c%c%c s:%d d:%d "
literal|"len:%d"
argument_list|,
name|msg_type_str
argument_list|(
name|type
argument_list|)
argument_list|,
name|type
argument_list|,
name|VCHIQ_FOURCC_AS_4CHARS
argument_list|(
name|svc_fourcc
argument_list|)
argument_list|,
name|remoteport
argument_list|,
name|localport
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
operator|>
literal|0
condition|)
name|vchiq_log_dump_mem
argument_list|(
literal|"Rcvd"
argument_list|,
literal|0
argument_list|,
name|header
operator|->
name|data
argument_list|,
name|min
argument_list|(
literal|64
argument_list|,
name|size
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|(
name|unsigned
name|int
operator|)
name|header
operator|&
name|VCHIQ_SLOT_MASK
operator|)
operator|+
name|calc_stride
argument_list|(
name|size
argument_list|)
operator|>
name|VCHIQ_SLOT_SIZE
condition|)
block|{
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"header %x (msgid %x) - size %x too big for "
literal|"slot"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|msgid
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|size
argument_list|)
expr_stmt|;
name|WARN
argument_list|(
literal|1
argument_list|,
literal|"oversized for slot\n"
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|VCHIQ_MSG_OPEN
case|:
name|WARN_ON
argument_list|(
operator|!
operator|(
name|VCHIQ_MSG_DSTPORT
argument_list|(
name|msgid
argument_list|)
operator|==
literal|0
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|parse_open
argument_list|(
name|state
argument_list|,
name|header
argument_list|)
condition|)
goto|goto
name|bail_not_ready
goto|;
break|break;
case|case
name|VCHIQ_MSG_OPENACK
case|:
if|if
condition|(
name|size
operator|>=
sizeof|sizeof
argument_list|(
expr|struct
name|vchiq_openack_payload
argument_list|)
condition|)
block|{
specifier|const
name|struct
name|vchiq_openack_payload
modifier|*
name|payload
init|=
operator|(
expr|struct
name|vchiq_openack_payload
operator|*
operator|)
name|header
operator|->
name|data
decl_stmt|;
name|service
operator|->
name|peer_version
operator|=
name|payload
operator|->
name|version
expr_stmt|;
block|}
name|vchiq_log_info
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: prs OPENACK@%x,%x (%d->%d) v:%d"
argument_list|,
name|state
operator|->
name|id
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
name|size
argument_list|,
name|remoteport
argument_list|,
name|localport
argument_list|,
name|service
operator|->
name|peer_version
argument_list|)
expr_stmt|;
if|if
condition|(
name|service
operator|->
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_OPENING
condition|)
block|{
name|service
operator|->
name|remoteport
operator|=
name|remoteport
expr_stmt|;
name|vchiq_set_service_state
argument_list|(
name|service
argument_list|,
name|VCHIQ_SRVSTATE_OPEN
argument_list|)
expr_stmt|;
name|up
argument_list|(
operator|&
name|service
operator|->
name|remove_event
argument_list|)
expr_stmt|;
block|}
else|else
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"OPENACK received in state %s"
argument_list|,
name|srvstate_names
index|[
name|service
operator|->
name|srvstate
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|VCHIQ_MSG_CLOSE
case|:
name|WARN_ON
argument_list|(
name|size
operator|!=
literal|0
argument_list|)
expr_stmt|;
comment|/* There should be no data */
name|vchiq_log_info
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: prs CLOSE@%x (%d->%d)"
argument_list|,
name|state
operator|->
name|id
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
name|remoteport
argument_list|,
name|localport
argument_list|)
expr_stmt|;
name|mark_service_closing_internal
argument_list|(
name|service
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|vchiq_close_service_internal
argument_list|(
name|service
argument_list|,
literal|1
comment|/*close_recvd*/
argument_list|)
operator|==
name|VCHIQ_RETRY
condition|)
goto|goto
name|bail_not_ready
goto|;
name|vchiq_log_info
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"Close Service %c%c%c%c s:%u d:%d"
argument_list|,
name|VCHIQ_FOURCC_AS_4CHARS
argument_list|(
name|service
operator|->
name|base
operator|.
name|fourcc
argument_list|)
argument_list|,
name|service
operator|->
name|localport
argument_list|,
name|service
operator|->
name|remoteport
argument_list|)
expr_stmt|;
break|break;
case|case
name|VCHIQ_MSG_DATA
case|:
name|vchiq_log_trace
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: prs DATA@%x,%x (%d->%d)"
argument_list|,
name|state
operator|->
name|id
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
name|size
argument_list|,
name|remoteport
argument_list|,
name|localport
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|service
operator|->
name|remoteport
operator|==
name|remoteport
operator|)
operator|&&
operator|(
name|service
operator|->
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_OPEN
operator|)
condition|)
block|{
name|header
operator|->
name|msgid
operator|=
name|msgid
operator||
name|VCHIQ_MSGID_CLAIMED
expr_stmt|;
name|claim_slot
argument_list|(
name|state
operator|->
name|rx_info
argument_list|)
expr_stmt|;
name|DEBUG_TRACE
argument_list|(
name|PARSE_LINE
argument_list|)
expr_stmt|;
if|if
condition|(
name|make_service_callback
argument_list|(
name|service
argument_list|,
name|VCHIQ_MESSAGE_AVAILABLE
argument_list|,
name|header
argument_list|,
name|NULL
argument_list|)
operator|==
name|VCHIQ_RETRY
condition|)
block|{
name|DEBUG_TRACE
argument_list|(
name|PARSE_LINE
argument_list|)
expr_stmt|;
goto|goto
name|bail_not_ready
goto|;
block|}
name|VCHIQ_SERVICE_STATS_INC
argument_list|(
name|service
argument_list|,
name|ctrl_rx_count
argument_list|)
expr_stmt|;
name|VCHIQ_SERVICE_STATS_ADD
argument_list|(
name|service
argument_list|,
name|ctrl_rx_bytes
argument_list|,
name|size
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|VCHIQ_STATS_INC
argument_list|(
name|state
argument_list|,
name|error_count
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|VCHIQ_MSG_CONNECT
case|:
name|vchiq_log_info
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: prs CONNECT@%x"
argument_list|,
name|state
operator|->
name|id
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|)
expr_stmt|;
name|up
argument_list|(
operator|&
name|state
operator|->
name|connect
argument_list|)
expr_stmt|;
break|break;
case|case
name|VCHIQ_MSG_BULK_RX
case|:
case|case
name|VCHIQ_MSG_BULK_TX
case|:
block|{
name|VCHIQ_BULK_QUEUE_T
modifier|*
name|queue
decl_stmt|;
name|WARN_ON
argument_list|(
operator|!
name|state
operator|->
name|is_master
argument_list|)
expr_stmt|;
name|queue
operator|=
operator|(
name|type
operator|==
name|VCHIQ_MSG_BULK_RX
operator|)
condition|?
operator|&
name|service
operator|->
name|bulk_tx
else|:
operator|&
name|service
operator|->
name|bulk_rx
expr_stmt|;
if|if
condition|(
operator|(
name|service
operator|->
name|remoteport
operator|==
name|remoteport
operator|)
operator|&&
operator|(
name|service
operator|->
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_OPEN
operator|)
condition|)
block|{
name|VCHIQ_BULK_T
modifier|*
name|bulk
decl_stmt|;
name|int
name|resolved
init|=
literal|0
decl_stmt|;
name|DEBUG_TRACE
argument_list|(
name|PARSE_LINE
argument_list|)
expr_stmt|;
if|if
condition|(
name|lmutex_lock_interruptible
argument_list|(
operator|&
name|service
operator|->
name|bulk_mutex
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|DEBUG_TRACE
argument_list|(
name|PARSE_LINE
argument_list|)
expr_stmt|;
goto|goto
name|bail_not_ready
goto|;
block|}
name|WARN_ON
argument_list|(
operator|!
operator|(
name|queue
operator|->
name|remote_insert
operator|<
name|queue
operator|->
name|remove
operator|+
name|VCHIQ_NUM_SERVICE_BULKS
operator|)
argument_list|)
expr_stmt|;
name|bulk
operator|=
operator|&
name|queue
operator|->
name|bulks
index|[
name|BULK_INDEX
argument_list|(
name|queue
operator|->
name|remote_insert
argument_list|)
index|]
expr_stmt|;
name|bulk
operator|->
name|remote_data
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
operator|(
name|int
operator|*
operator|)
name|header
operator|->
name|data
operator|)
index|[
literal|0
index|]
expr_stmt|;
name|bulk
operator|->
name|remote_size
operator|=
operator|(
operator|(
name|int
operator|*
operator|)
name|header
operator|->
name|data
operator|)
index|[
literal|1
index|]
expr_stmt|;
name|wmb
argument_list|()
expr_stmt|;
name|vchiq_log_info
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: prs %s@%x (%d->%d) %x@%x"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|msg_type_str
argument_list|(
name|type
argument_list|)
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
name|remoteport
argument_list|,
name|localport
argument_list|,
name|bulk
operator|->
name|remote_size
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|bulk
operator|->
name|remote_data
argument_list|)
expr_stmt|;
name|queue
operator|->
name|remote_insert
operator|++
expr_stmt|;
if|if
condition|(
name|atomic_read
argument_list|(
operator|&
name|pause_bulks_count
argument_list|)
condition|)
block|{
name|state
operator|->
name|deferred_bulks
operator|++
expr_stmt|;
name|vchiq_log_info
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%s: deferring bulk (%d)"
argument_list|,
name|__func__
argument_list|,
name|state
operator|->
name|deferred_bulks
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|->
name|conn_state
operator|!=
name|VCHIQ_CONNSTATE_PAUSE_SENT
condition|)
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%s: bulks paused in "
literal|"unexpected state %s"
argument_list|,
name|__func__
argument_list|,
name|conn_state_names
index|[
name|state
operator|->
name|conn_state
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|state
operator|->
name|conn_state
operator|==
name|VCHIQ_CONNSTATE_CONNECTED
condition|)
block|{
name|DEBUG_TRACE
argument_list|(
name|PARSE_LINE
argument_list|)
expr_stmt|;
name|resolved
operator|=
name|resolve_bulks
argument_list|(
name|service
argument_list|,
name|queue
argument_list|)
expr_stmt|;
block|}
name|lmutex_unlock
argument_list|(
operator|&
name|service
operator|->
name|bulk_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|resolved
condition|)
name|notify_bulks
argument_list|(
name|service
argument_list|,
name|queue
argument_list|,
literal|1
comment|/*retry_poll*/
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|VCHIQ_MSG_BULK_RX_DONE
case|:
case|case
name|VCHIQ_MSG_BULK_TX_DONE
case|:
name|WARN_ON
argument_list|(
name|state
operator|->
name|is_master
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|service
operator|->
name|remoteport
operator|==
name|remoteport
operator|)
operator|&&
operator|(
name|service
operator|->
name|srvstate
operator|!=
name|VCHIQ_SRVSTATE_FREE
operator|)
condition|)
block|{
name|VCHIQ_BULK_QUEUE_T
modifier|*
name|queue
decl_stmt|;
name|VCHIQ_BULK_T
modifier|*
name|bulk
decl_stmt|;
name|queue
operator|=
operator|(
name|type
operator|==
name|VCHIQ_MSG_BULK_RX_DONE
operator|)
condition|?
operator|&
name|service
operator|->
name|bulk_rx
else|:
operator|&
name|service
operator|->
name|bulk_tx
expr_stmt|;
name|DEBUG_TRACE
argument_list|(
name|PARSE_LINE
argument_list|)
expr_stmt|;
if|if
condition|(
name|lmutex_lock_interruptible
argument_list|(
operator|&
name|service
operator|->
name|bulk_mutex
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|DEBUG_TRACE
argument_list|(
name|PARSE_LINE
argument_list|)
expr_stmt|;
goto|goto
name|bail_not_ready
goto|;
block|}
if|if
condition|(
call|(
name|int
call|)
argument_list|(
name|queue
operator|->
name|remote_insert
operator|-
name|queue
operator|->
name|local_insert
argument_list|)
operator|>=
literal|0
condition|)
block|{
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: prs %s@%x (%d->%d) "
literal|"unexpected (ri=%d,li=%d)"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|msg_type_str
argument_list|(
name|type
argument_list|)
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
name|remoteport
argument_list|,
name|localport
argument_list|,
name|queue
operator|->
name|remote_insert
argument_list|,
name|queue
operator|->
name|local_insert
argument_list|)
expr_stmt|;
name|lmutex_unlock
argument_list|(
operator|&
name|service
operator|->
name|bulk_mutex
argument_list|)
expr_stmt|;
break|break;
block|}
name|BUG_ON
argument_list|(
name|queue
operator|->
name|process
operator|==
name|queue
operator|->
name|local_insert
argument_list|)
expr_stmt|;
name|BUG_ON
argument_list|(
name|queue
operator|->
name|process
operator|!=
name|queue
operator|->
name|remote_insert
argument_list|)
expr_stmt|;
name|bulk
operator|=
operator|&
name|queue
operator|->
name|bulks
index|[
name|BULK_INDEX
argument_list|(
name|queue
operator|->
name|remote_insert
argument_list|)
index|]
expr_stmt|;
name|bulk
operator|->
name|actual
operator|=
operator|*
operator|(
name|int
operator|*
operator|)
name|header
operator|->
name|data
expr_stmt|;
name|queue
operator|->
name|remote_insert
operator|++
expr_stmt|;
name|vchiq_log_info
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: prs %s@%x (%d->%d) %x@%x"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|msg_type_str
argument_list|(
name|type
argument_list|)
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
name|remoteport
argument_list|,
name|localport
argument_list|,
name|bulk
operator|->
name|actual
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|bulk
operator|->
name|data
argument_list|)
expr_stmt|;
name|vchiq_log_trace
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: prs:%d %cx li=%x ri=%x p=%x"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|localport
argument_list|,
operator|(
name|type
operator|==
name|VCHIQ_MSG_BULK_RX_DONE
operator|)
condition|?
literal|'r'
else|:
literal|'t'
argument_list|,
name|queue
operator|->
name|local_insert
argument_list|,
name|queue
operator|->
name|remote_insert
argument_list|,
name|queue
operator|->
name|process
argument_list|)
expr_stmt|;
name|DEBUG_TRACE
argument_list|(
name|PARSE_LINE
argument_list|)
expr_stmt|;
name|WARN_ON
argument_list|(
name|queue
operator|->
name|process
operator|==
name|queue
operator|->
name|local_insert
argument_list|)
expr_stmt|;
name|vchiq_complete_bulk
argument_list|(
name|bulk
argument_list|)
expr_stmt|;
name|queue
operator|->
name|process
operator|++
expr_stmt|;
name|lmutex_unlock
argument_list|(
operator|&
name|service
operator|->
name|bulk_mutex
argument_list|)
expr_stmt|;
name|DEBUG_TRACE
argument_list|(
name|PARSE_LINE
argument_list|)
expr_stmt|;
name|notify_bulks
argument_list|(
name|service
argument_list|,
name|queue
argument_list|,
literal|1
comment|/*retry_poll*/
argument_list|)
expr_stmt|;
name|DEBUG_TRACE
argument_list|(
name|PARSE_LINE
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|VCHIQ_MSG_PADDING
case|:
name|vchiq_log_trace
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: prs PADDING@%x,%x"
argument_list|,
name|state
operator|->
name|id
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
name|size
argument_list|)
expr_stmt|;
break|break;
case|case
name|VCHIQ_MSG_PAUSE
case|:
comment|/* If initiated, signal the application thread */
name|vchiq_log_trace
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: prs PAUSE@%x,%x"
argument_list|,
name|state
operator|->
name|id
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|->
name|conn_state
operator|==
name|VCHIQ_CONNSTATE_PAUSED
condition|)
block|{
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: PAUSE received in state PAUSED"
argument_list|,
name|state
operator|->
name|id
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|state
operator|->
name|conn_state
operator|!=
name|VCHIQ_CONNSTATE_PAUSE_SENT
condition|)
block|{
comment|/* Send a PAUSE in response */
if|if
condition|(
name|queue_message
argument_list|(
name|state
argument_list|,
name|NULL
argument_list|,
name|VCHIQ_MAKE_MSG
argument_list|(
name|VCHIQ_MSG_PAUSE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|==
name|VCHIQ_RETRY
condition|)
goto|goto
name|bail_not_ready
goto|;
if|if
condition|(
name|state
operator|->
name|is_master
condition|)
name|pause_bulks
argument_list|(
name|state
argument_list|)
expr_stmt|;
block|}
comment|/* At this point slot_mutex is held */
name|vchiq_set_conn_state
argument_list|(
name|state
argument_list|,
name|VCHIQ_CONNSTATE_PAUSED
argument_list|)
expr_stmt|;
name|vchiq_platform_paused
argument_list|(
name|state
argument_list|)
expr_stmt|;
break|break;
case|case
name|VCHIQ_MSG_RESUME
case|:
name|vchiq_log_trace
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: prs RESUME@%x,%x"
argument_list|,
name|state
operator|->
name|id
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
name|size
argument_list|)
expr_stmt|;
comment|/* Release the slot mutex */
name|lmutex_unlock
argument_list|(
operator|&
name|state
operator|->
name|slot_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|->
name|is_master
condition|)
name|resume_bulks
argument_list|(
name|state
argument_list|)
expr_stmt|;
name|vchiq_set_conn_state
argument_list|(
name|state
argument_list|,
name|VCHIQ_CONNSTATE_CONNECTED
argument_list|)
expr_stmt|;
name|vchiq_platform_resumed
argument_list|(
name|state
argument_list|)
expr_stmt|;
break|break;
case|case
name|VCHIQ_MSG_REMOTE_USE
case|:
name|vchiq_on_remote_use
argument_list|(
name|state
argument_list|)
expr_stmt|;
break|break;
case|case
name|VCHIQ_MSG_REMOTE_RELEASE
case|:
name|vchiq_on_remote_release
argument_list|(
name|state
argument_list|)
expr_stmt|;
break|break;
case|case
name|VCHIQ_MSG_REMOTE_USE_ACTIVE
case|:
name|vchiq_on_remote_use_active
argument_list|(
name|state
argument_list|)
expr_stmt|;
break|break;
default|default:
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: prs invalid msgid %x@%x,%x"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|msgid
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|WARN
argument_list|(
literal|1
argument_list|,
literal|"invalid message\n"
argument_list|)
expr_stmt|;
break|break;
block|}
name|skip_message
label|:
if|if
condition|(
name|service
condition|)
block|{
name|unlock_service
argument_list|(
name|service
argument_list|)
expr_stmt|;
name|service
operator|=
name|NULL
expr_stmt|;
block|}
name|state
operator|->
name|rx_pos
operator|+=
name|calc_stride
argument_list|(
name|size
argument_list|)
expr_stmt|;
name|DEBUG_TRACE
argument_list|(
name|PARSE_LINE
argument_list|)
expr_stmt|;
comment|/* Perform some housekeeping when the end of the slot is 		** reached. */
if|if
condition|(
operator|(
name|state
operator|->
name|rx_pos
operator|&
name|VCHIQ_SLOT_MASK
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* Remove the extra reference count. */
name|release_slot
argument_list|(
name|state
argument_list|,
name|state
operator|->
name|rx_info
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|state
operator|->
name|rx_data
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|bail_not_ready
label|:
if|if
condition|(
name|service
condition|)
name|unlock_service
argument_list|(
name|service
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Called by the slot handler thread */
end_comment

begin_function_decl
name|int
name|slot_handler_func
parameter_list|(
name|void
modifier|*
name|v
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|slot_handler_func
parameter_list|(
name|void
modifier|*
name|v
parameter_list|)
block|{
name|VCHIQ_STATE_T
modifier|*
name|state
init|=
operator|(
name|VCHIQ_STATE_T
operator|*
operator|)
name|v
decl_stmt|;
name|VCHIQ_SHARED_STATE_T
modifier|*
name|local
init|=
name|state
operator|->
name|local
decl_stmt|;
name|DEBUG_INITIALISE
argument_list|(
argument|local
argument_list|)
while|while
condition|(
literal|1
condition|)
block|{
name|DEBUG_COUNT
argument_list|(
name|SLOT_HANDLER_COUNT
argument_list|)
expr_stmt|;
name|DEBUG_TRACE
argument_list|(
name|SLOT_HANDLER_LINE
argument_list|)
expr_stmt|;
name|remote_event_wait
argument_list|(
operator|&
name|local
operator|->
name|trigger
argument_list|)
expr_stmt|;
name|rmb
argument_list|()
expr_stmt|;
name|DEBUG_TRACE
argument_list|(
name|SLOT_HANDLER_LINE
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|->
name|poll_needed
condition|)
block|{
comment|/* Check if we need to suspend - may change our 			 * conn_state */
name|vchiq_platform_check_suspend
argument_list|(
name|state
argument_list|)
expr_stmt|;
name|state
operator|->
name|poll_needed
operator|=
literal|0
expr_stmt|;
comment|/* Handle service polling and other rare conditions here 			** out of the mainline code */
switch|switch
condition|(
name|state
operator|->
name|conn_state
condition|)
block|{
case|case
name|VCHIQ_CONNSTATE_CONNECTED
case|:
comment|/* Poll the services as requested */
name|poll_services
argument_list|(
name|state
argument_list|)
expr_stmt|;
break|break;
case|case
name|VCHIQ_CONNSTATE_PAUSING
case|:
if|if
condition|(
name|state
operator|->
name|is_master
condition|)
name|pause_bulks
argument_list|(
name|state
argument_list|)
expr_stmt|;
if|if
condition|(
name|queue_message
argument_list|(
name|state
argument_list|,
name|NULL
argument_list|,
name|VCHIQ_MAKE_MSG
argument_list|(
name|VCHIQ_MSG_PAUSE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|!=
name|VCHIQ_RETRY
condition|)
block|{
name|vchiq_set_conn_state
argument_list|(
name|state
argument_list|,
name|VCHIQ_CONNSTATE_PAUSE_SENT
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|state
operator|->
name|is_master
condition|)
name|resume_bulks
argument_list|(
name|state
argument_list|)
expr_stmt|;
comment|/* Retry later */
name|state
operator|->
name|poll_needed
operator|=
literal|1
expr_stmt|;
block|}
break|break;
case|case
name|VCHIQ_CONNSTATE_PAUSED
case|:
name|vchiq_platform_resume
argument_list|(
name|state
argument_list|)
expr_stmt|;
break|break;
case|case
name|VCHIQ_CONNSTATE_RESUMING
case|:
if|if
condition|(
name|queue_message
argument_list|(
name|state
argument_list|,
name|NULL
argument_list|,
name|VCHIQ_MAKE_MSG
argument_list|(
name|VCHIQ_MSG_RESUME
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|!=
name|VCHIQ_RETRY
condition|)
block|{
if|if
condition|(
name|state
operator|->
name|is_master
condition|)
name|resume_bulks
argument_list|(
name|state
argument_list|)
expr_stmt|;
name|vchiq_set_conn_state
argument_list|(
name|state
argument_list|,
name|VCHIQ_CONNSTATE_CONNECTED
argument_list|)
expr_stmt|;
name|vchiq_platform_resumed
argument_list|(
name|state
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* This should really be impossible, 					** since the PAUSE should have flushed 					** through outstanding messages. */
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"Failed to send RESUME "
literal|"message"
argument_list|)
expr_stmt|;
name|BUG
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
name|VCHIQ_CONNSTATE_PAUSE_TIMEOUT
case|:
case|case
name|VCHIQ_CONNSTATE_RESUME_TIMEOUT
case|:
name|vchiq_platform_handle_timeout
argument_list|(
name|state
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
name|DEBUG_TRACE
argument_list|(
name|SLOT_HANDLER_LINE
argument_list|)
expr_stmt|;
name|parse_rx_slots
argument_list|(
name|state
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Called by the recycle thread */
end_comment

begin_function_decl
name|int
name|recycle_func
parameter_list|(
name|void
modifier|*
name|v
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|recycle_func
parameter_list|(
name|void
modifier|*
name|v
parameter_list|)
block|{
name|VCHIQ_STATE_T
modifier|*
name|state
init|=
operator|(
name|VCHIQ_STATE_T
operator|*
operator|)
name|v
decl_stmt|;
name|VCHIQ_SHARED_STATE_T
modifier|*
name|local
init|=
name|state
operator|->
name|local
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|remote_event_wait
argument_list|(
operator|&
name|local
operator|->
name|recycle
argument_list|)
expr_stmt|;
name|process_free_queue
argument_list|(
name|state
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Called by the sync thread */
end_comment

begin_function_decl
name|int
name|sync_func
parameter_list|(
name|void
modifier|*
name|v
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|sync_func
parameter_list|(
name|void
modifier|*
name|v
parameter_list|)
block|{
name|VCHIQ_STATE_T
modifier|*
name|state
init|=
operator|(
name|VCHIQ_STATE_T
operator|*
operator|)
name|v
decl_stmt|;
name|VCHIQ_SHARED_STATE_T
modifier|*
name|local
init|=
name|state
operator|->
name|local
decl_stmt|;
name|VCHIQ_HEADER_T
modifier|*
name|header
init|=
operator|(
name|VCHIQ_HEADER_T
operator|*
operator|)
name|SLOT_DATA_FROM_INDEX
argument_list|(
name|state
argument_list|,
name|state
operator|->
name|remote
operator|->
name|slot_sync
argument_list|)
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|VCHIQ_SERVICE_T
modifier|*
name|service
decl_stmt|;
name|int
name|msgid
decl_stmt|,
name|size
decl_stmt|;
name|int
name|type
decl_stmt|;
name|unsigned
name|int
name|localport
decl_stmt|,
name|remoteport
decl_stmt|;
name|remote_event_wait
argument_list|(
operator|&
name|local
operator|->
name|sync_trigger
argument_list|)
expr_stmt|;
name|rmb
argument_list|()
expr_stmt|;
name|msgid
operator|=
name|header
operator|->
name|msgid
expr_stmt|;
name|size
operator|=
name|header
operator|->
name|size
expr_stmt|;
name|type
operator|=
name|VCHIQ_MSG_TYPE
argument_list|(
name|msgid
argument_list|)
expr_stmt|;
name|localport
operator|=
name|VCHIQ_MSG_DSTPORT
argument_list|(
name|msgid
argument_list|)
expr_stmt|;
name|remoteport
operator|=
name|VCHIQ_MSG_SRCPORT
argument_list|(
name|msgid
argument_list|)
expr_stmt|;
name|service
operator|=
name|find_service_by_port
argument_list|(
name|state
argument_list|,
name|localport
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|service
condition|)
block|{
name|vchiq_log_error
argument_list|(
name|vchiq_sync_log_level
argument_list|,
literal|"%d: sf %s@%x (%d->%d) - "
literal|"invalid/closed service %d"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|msg_type_str
argument_list|(
name|type
argument_list|)
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
name|remoteport
argument_list|,
name|localport
argument_list|,
name|localport
argument_list|)
expr_stmt|;
name|release_message_sync
argument_list|(
name|state
argument_list|,
name|header
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|vchiq_sync_log_level
operator|>=
name|VCHIQ_LOG_TRACE
condition|)
block|{
name|int
name|svc_fourcc
decl_stmt|;
name|svc_fourcc
operator|=
name|service
condition|?
name|service
operator|->
name|base
operator|.
name|fourcc
else|:
name|VCHIQ_MAKE_FOURCC
argument_list|(
literal|'?'
argument_list|,
literal|'?'
argument_list|,
literal|'?'
argument_list|,
literal|'?'
argument_list|)
expr_stmt|;
name|vchiq_log_trace
argument_list|(
name|vchiq_sync_log_level
argument_list|,
literal|"Rcvd Msg %s from %c%c%c%c s:%d d:%d len:%d"
argument_list|,
name|msg_type_str
argument_list|(
name|type
argument_list|)
argument_list|,
name|VCHIQ_FOURCC_AS_4CHARS
argument_list|(
name|svc_fourcc
argument_list|)
argument_list|,
name|remoteport
argument_list|,
name|localport
argument_list|,
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
operator|>
literal|0
condition|)
name|vchiq_log_dump_mem
argument_list|(
literal|"Rcvd"
argument_list|,
literal|0
argument_list|,
name|header
operator|->
name|data
argument_list|,
name|min
argument_list|(
literal|64
argument_list|,
name|size
argument_list|)
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|VCHIQ_MSG_OPENACK
case|:
if|if
condition|(
name|size
operator|>=
sizeof|sizeof
argument_list|(
expr|struct
name|vchiq_openack_payload
argument_list|)
condition|)
block|{
specifier|const
name|struct
name|vchiq_openack_payload
modifier|*
name|payload
init|=
operator|(
expr|struct
name|vchiq_openack_payload
operator|*
operator|)
name|header
operator|->
name|data
decl_stmt|;
name|service
operator|->
name|peer_version
operator|=
name|payload
operator|->
name|version
expr_stmt|;
block|}
name|vchiq_log_info
argument_list|(
name|vchiq_sync_log_level
argument_list|,
literal|"%d: sf OPENACK@%x,%x (%d->%d) v:%d"
argument_list|,
name|state
operator|->
name|id
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
name|size
argument_list|,
name|remoteport
argument_list|,
name|localport
argument_list|,
name|service
operator|->
name|peer_version
argument_list|)
expr_stmt|;
if|if
condition|(
name|service
operator|->
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_OPENING
condition|)
block|{
name|service
operator|->
name|remoteport
operator|=
name|remoteport
expr_stmt|;
name|vchiq_set_service_state
argument_list|(
name|service
argument_list|,
name|VCHIQ_SRVSTATE_OPENSYNC
argument_list|)
expr_stmt|;
name|up
argument_list|(
operator|&
name|service
operator|->
name|remove_event
argument_list|)
expr_stmt|;
block|}
name|release_message_sync
argument_list|(
name|state
argument_list|,
name|header
argument_list|)
expr_stmt|;
break|break;
case|case
name|VCHIQ_MSG_DATA
case|:
name|vchiq_log_trace
argument_list|(
name|vchiq_sync_log_level
argument_list|,
literal|"%d: sf DATA@%x,%x (%d->%d)"
argument_list|,
name|state
operator|->
name|id
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
name|size
argument_list|,
name|remoteport
argument_list|,
name|localport
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|service
operator|->
name|remoteport
operator|==
name|remoteport
operator|)
operator|&&
operator|(
name|service
operator|->
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_OPENSYNC
operator|)
condition|)
block|{
if|if
condition|(
name|make_service_callback
argument_list|(
name|service
argument_list|,
name|VCHIQ_MESSAGE_AVAILABLE
argument_list|,
name|header
argument_list|,
name|NULL
argument_list|)
operator|==
name|VCHIQ_RETRY
condition|)
name|vchiq_log_error
argument_list|(
name|vchiq_sync_log_level
argument_list|,
literal|"synchronous callback to "
literal|"service %d returns "
literal|"VCHIQ_RETRY"
argument_list|,
name|localport
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|vchiq_log_error
argument_list|(
name|vchiq_sync_log_level
argument_list|,
literal|"%d: sf unexpected msgid %x@%x,%x"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|msgid
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|release_message_sync
argument_list|(
name|state
argument_list|,
name|header
argument_list|)
expr_stmt|;
break|break;
block|}
name|unlock_service
argument_list|(
name|service
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|init_bulk_queue
parameter_list|(
name|VCHIQ_BULK_QUEUE_T
modifier|*
name|queue
parameter_list|)
block|{
name|queue
operator|->
name|local_insert
operator|=
literal|0
expr_stmt|;
name|queue
operator|->
name|remote_insert
operator|=
literal|0
expr_stmt|;
name|queue
operator|->
name|process
operator|=
literal|0
expr_stmt|;
name|queue
operator|->
name|remote_notify
operator|=
literal|0
expr_stmt|;
name|queue
operator|->
name|remove
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|inline
specifier|const
name|char
modifier|*
name|get_conn_state_name
parameter_list|(
name|VCHIQ_CONNSTATE_T
name|conn_state
parameter_list|)
block|{
return|return
name|conn_state_names
index|[
name|conn_state
index|]
return|;
block|}
end_function

begin_function
name|VCHIQ_SLOT_ZERO_T
modifier|*
name|vchiq_init_slots
parameter_list|(
name|void
modifier|*
name|mem_base
parameter_list|,
name|int
name|mem_size
parameter_list|)
block|{
name|int
name|mem_align
init|=
operator|(
name|VCHIQ_SLOT_SIZE
operator|-
operator|(
name|int
operator|)
name|mem_base
operator|)
operator|&
name|VCHIQ_SLOT_MASK
decl_stmt|;
name|VCHIQ_SLOT_ZERO_T
modifier|*
name|slot_zero
init|=
operator|(
name|VCHIQ_SLOT_ZERO_T
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|mem_base
operator|+
name|mem_align
operator|)
decl_stmt|;
name|int
name|num_slots
init|=
operator|(
name|mem_size
operator|-
name|mem_align
operator|)
operator|/
name|VCHIQ_SLOT_SIZE
decl_stmt|;
name|int
name|first_data_slot
init|=
name|VCHIQ_SLOT_ZERO_SLOTS
decl_stmt|;
comment|/* Ensure there is enough memory to run an absolutely minimum system */
name|num_slots
operator|-=
name|first_data_slot
expr_stmt|;
if|if
condition|(
name|num_slots
operator|<
literal|4
condition|)
block|{
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"vchiq_init_slots - insufficient memory %x bytes"
argument_list|,
name|mem_size
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|memset
argument_list|(
name|slot_zero
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|VCHIQ_SLOT_ZERO_T
argument_list|)
argument_list|)
expr_stmt|;
name|slot_zero
operator|->
name|magic
operator|=
name|VCHIQ_MAGIC
expr_stmt|;
name|slot_zero
operator|->
name|version
operator|=
name|VCHIQ_VERSION
expr_stmt|;
name|slot_zero
operator|->
name|version_min
operator|=
name|VCHIQ_VERSION_MIN
expr_stmt|;
name|slot_zero
operator|->
name|slot_zero_size
operator|=
sizeof|sizeof
argument_list|(
name|VCHIQ_SLOT_ZERO_T
argument_list|)
expr_stmt|;
name|slot_zero
operator|->
name|slot_size
operator|=
name|VCHIQ_SLOT_SIZE
expr_stmt|;
name|slot_zero
operator|->
name|max_slots
operator|=
name|VCHIQ_MAX_SLOTS
expr_stmt|;
name|slot_zero
operator|->
name|max_slots_per_side
operator|=
name|VCHIQ_MAX_SLOTS_PER_SIDE
expr_stmt|;
name|slot_zero
operator|->
name|master
operator|.
name|slot_sync
operator|=
name|first_data_slot
expr_stmt|;
name|slot_zero
operator|->
name|master
operator|.
name|slot_first
operator|=
name|first_data_slot
operator|+
literal|1
expr_stmt|;
name|slot_zero
operator|->
name|master
operator|.
name|slot_last
operator|=
name|first_data_slot
operator|+
operator|(
name|num_slots
operator|/
literal|2
operator|)
operator|-
literal|1
expr_stmt|;
name|slot_zero
operator|->
name|slave
operator|.
name|slot_sync
operator|=
name|first_data_slot
operator|+
operator|(
name|num_slots
operator|/
literal|2
operator|)
expr_stmt|;
name|slot_zero
operator|->
name|slave
operator|.
name|slot_first
operator|=
name|first_data_slot
operator|+
operator|(
name|num_slots
operator|/
literal|2
operator|)
operator|+
literal|1
expr_stmt|;
name|slot_zero
operator|->
name|slave
operator|.
name|slot_last
operator|=
name|first_data_slot
operator|+
name|num_slots
operator|-
literal|1
expr_stmt|;
return|return
name|slot_zero
return|;
block|}
end_function

begin_function
name|VCHIQ_STATUS_T
name|vchiq_init_state
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|,
name|VCHIQ_SLOT_ZERO_T
modifier|*
name|slot_zero
parameter_list|,
name|int
name|is_master
parameter_list|)
block|{
name|VCHIQ_SHARED_STATE_T
modifier|*
name|local
decl_stmt|;
name|VCHIQ_SHARED_STATE_T
modifier|*
name|remote
decl_stmt|;
name|VCHIQ_STATUS_T
name|status
decl_stmt|;
name|char
name|threadname
index|[
literal|10
index|]
decl_stmt|;
specifier|static
name|int
name|id
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Check the input configuration */
if|if
condition|(
name|slot_zero
operator|->
name|magic
operator|!=
name|VCHIQ_MAGIC
condition|)
block|{
name|vchiq_loud_error_header
argument_list|()
expr_stmt|;
name|vchiq_loud_error
argument_list|(
literal|"Invalid VCHIQ magic value found."
argument_list|)
expr_stmt|;
name|vchiq_loud_error
argument_list|(
literal|"slot_zero=%x: magic=%x (expected %x)"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|slot_zero
argument_list|,
name|slot_zero
operator|->
name|magic
argument_list|,
name|VCHIQ_MAGIC
argument_list|)
expr_stmt|;
name|vchiq_loud_error_footer
argument_list|()
expr_stmt|;
return|return
name|VCHIQ_ERROR
return|;
block|}
name|vchiq_log_warning
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"local ver %d (min %d), remote ver %d."
argument_list|,
name|VCHIQ_VERSION
argument_list|,
name|VCHIQ_VERSION_MIN
argument_list|,
name|slot_zero
operator|->
name|version
argument_list|)
expr_stmt|;
if|if
condition|(
name|slot_zero
operator|->
name|version
operator|<
name|VCHIQ_VERSION_MIN
condition|)
block|{
name|vchiq_loud_error_header
argument_list|()
expr_stmt|;
name|vchiq_loud_error
argument_list|(
literal|"Incompatible VCHIQ versions found."
argument_list|)
expr_stmt|;
name|vchiq_loud_error
argument_list|(
literal|"slot_zero=%x: VideoCore version=%d "
literal|"(minimum %d)"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|slot_zero
argument_list|,
name|slot_zero
operator|->
name|version
argument_list|,
name|VCHIQ_VERSION_MIN
argument_list|)
expr_stmt|;
name|vchiq_loud_error
argument_list|(
literal|"Restart with a newer VideoCore image."
argument_list|)
expr_stmt|;
name|vchiq_loud_error_footer
argument_list|()
expr_stmt|;
return|return
name|VCHIQ_ERROR
return|;
block|}
if|if
condition|(
name|VCHIQ_VERSION
operator|<
name|slot_zero
operator|->
name|version_min
condition|)
block|{
name|vchiq_loud_error_header
argument_list|()
expr_stmt|;
name|vchiq_loud_error
argument_list|(
literal|"Incompatible VCHIQ versions found."
argument_list|)
expr_stmt|;
name|vchiq_loud_error
argument_list|(
literal|"slot_zero=%x: version=%d (VideoCore "
literal|"minimum %d)"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|slot_zero
argument_list|,
name|VCHIQ_VERSION
argument_list|,
name|slot_zero
operator|->
name|version_min
argument_list|)
expr_stmt|;
name|vchiq_loud_error
argument_list|(
literal|"Restart with a newer kernel."
argument_list|)
expr_stmt|;
name|vchiq_loud_error_footer
argument_list|()
expr_stmt|;
return|return
name|VCHIQ_ERROR
return|;
block|}
if|if
condition|(
operator|(
name|slot_zero
operator|->
name|slot_zero_size
operator|!=
sizeof|sizeof
argument_list|(
name|VCHIQ_SLOT_ZERO_T
argument_list|)
operator|)
operator|||
operator|(
name|slot_zero
operator|->
name|slot_size
operator|!=
name|VCHIQ_SLOT_SIZE
operator|)
operator|||
operator|(
name|slot_zero
operator|->
name|max_slots
operator|!=
name|VCHIQ_MAX_SLOTS
operator|)
operator|||
operator|(
name|slot_zero
operator|->
name|max_slots_per_side
operator|!=
name|VCHIQ_MAX_SLOTS_PER_SIDE
operator|)
condition|)
block|{
name|vchiq_loud_error_header
argument_list|()
expr_stmt|;
if|if
condition|(
name|slot_zero
operator|->
name|slot_zero_size
operator|!=
sizeof|sizeof
argument_list|(
name|VCHIQ_SLOT_ZERO_T
argument_list|)
condition|)
name|vchiq_loud_error
argument_list|(
literal|"slot_zero=%x: slot_zero_size=%x "
literal|"(expected %zx)"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|slot_zero
argument_list|,
name|slot_zero
operator|->
name|slot_zero_size
argument_list|,
sizeof|sizeof
argument_list|(
name|VCHIQ_SLOT_ZERO_T
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|slot_zero
operator|->
name|slot_size
operator|!=
name|VCHIQ_SLOT_SIZE
condition|)
name|vchiq_loud_error
argument_list|(
literal|"slot_zero=%x: slot_size=%d "
literal|"(expected %d"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|slot_zero
argument_list|,
name|slot_zero
operator|->
name|slot_size
argument_list|,
name|VCHIQ_SLOT_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|slot_zero
operator|->
name|max_slots
operator|!=
name|VCHIQ_MAX_SLOTS
condition|)
name|vchiq_loud_error
argument_list|(
literal|"slot_zero=%x: max_slots=%d "
literal|"(expected %d)"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|slot_zero
argument_list|,
name|slot_zero
operator|->
name|max_slots
argument_list|,
name|VCHIQ_MAX_SLOTS
argument_list|)
expr_stmt|;
if|if
condition|(
name|slot_zero
operator|->
name|max_slots_per_side
operator|!=
name|VCHIQ_MAX_SLOTS_PER_SIDE
condition|)
name|vchiq_loud_error
argument_list|(
literal|"slot_zero=%x: max_slots_per_side=%d "
literal|"(expected %d)"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|slot_zero
argument_list|,
name|slot_zero
operator|->
name|max_slots_per_side
argument_list|,
name|VCHIQ_MAX_SLOTS_PER_SIDE
argument_list|)
expr_stmt|;
name|vchiq_loud_error_footer
argument_list|()
expr_stmt|;
return|return
name|VCHIQ_ERROR
return|;
block|}
if|if
condition|(
name|is_master
condition|)
block|{
name|local
operator|=
operator|&
name|slot_zero
operator|->
name|master
expr_stmt|;
name|remote
operator|=
operator|&
name|slot_zero
operator|->
name|slave
expr_stmt|;
block|}
else|else
block|{
name|local
operator|=
operator|&
name|slot_zero
operator|->
name|slave
expr_stmt|;
name|remote
operator|=
operator|&
name|slot_zero
operator|->
name|master
expr_stmt|;
block|}
if|if
condition|(
name|local
operator|->
name|initialised
condition|)
block|{
name|vchiq_loud_error_header
argument_list|()
expr_stmt|;
if|if
condition|(
name|remote
operator|->
name|initialised
condition|)
name|vchiq_loud_error
argument_list|(
literal|"local state has already been "
literal|"initialised"
argument_list|)
expr_stmt|;
else|else
name|vchiq_loud_error
argument_list|(
literal|"master/slave mismatch - two %ss"
argument_list|,
name|is_master
condition|?
literal|"master"
else|:
literal|"slave"
argument_list|)
expr_stmt|;
name|vchiq_loud_error_footer
argument_list|()
expr_stmt|;
return|return
name|VCHIQ_ERROR
return|;
block|}
name|memset
argument_list|(
name|state
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|VCHIQ_STATE_T
argument_list|)
argument_list|)
expr_stmt|;
name|state
operator|->
name|id
operator|=
name|id
operator|++
expr_stmt|;
name|state
operator|->
name|is_master
operator|=
name|is_master
expr_stmt|;
comment|/* 		initialize shared state pointers 	 */
name|state
operator|->
name|local
operator|=
name|local
expr_stmt|;
name|state
operator|->
name|remote
operator|=
name|remote
expr_stmt|;
name|state
operator|->
name|slot_data
operator|=
operator|(
name|VCHIQ_SLOT_T
operator|*
operator|)
name|slot_zero
expr_stmt|;
comment|/* 		initialize events and mutexes 	 */
name|_sema_init
argument_list|(
operator|&
name|state
operator|->
name|connect
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|lmutex_init
argument_list|(
operator|&
name|state
operator|->
name|mutex
argument_list|)
expr_stmt|;
name|_sema_init
argument_list|(
operator|&
name|state
operator|->
name|trigger_event
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|_sema_init
argument_list|(
operator|&
name|state
operator|->
name|recycle_event
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|_sema_init
argument_list|(
operator|&
name|state
operator|->
name|sync_trigger_event
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|_sema_init
argument_list|(
operator|&
name|state
operator|->
name|sync_release_event
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|lmutex_init
argument_list|(
operator|&
name|state
operator|->
name|slot_mutex
argument_list|)
expr_stmt|;
name|lmutex_init
argument_list|(
operator|&
name|state
operator|->
name|recycle_mutex
argument_list|)
expr_stmt|;
name|lmutex_init
argument_list|(
operator|&
name|state
operator|->
name|sync_mutex
argument_list|)
expr_stmt|;
name|lmutex_init
argument_list|(
operator|&
name|state
operator|->
name|bulk_transfer_mutex
argument_list|)
expr_stmt|;
name|_sema_init
argument_list|(
operator|&
name|state
operator|->
name|slot_available_event
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|_sema_init
argument_list|(
operator|&
name|state
operator|->
name|slot_remove_event
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|_sema_init
argument_list|(
operator|&
name|state
operator|->
name|data_quota_event
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|state
operator|->
name|slot_queue_available
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|VCHIQ_MAX_SERVICES
condition|;
name|i
operator|++
control|)
block|{
name|VCHIQ_SERVICE_QUOTA_T
modifier|*
name|service_quota
init|=
operator|&
name|state
operator|->
name|service_quotas
index|[
name|i
index|]
decl_stmt|;
name|_sema_init
argument_list|(
operator|&
name|service_quota
operator|->
name|quota_event
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
name|local
operator|->
name|slot_first
init|;
name|i
operator|<=
name|local
operator|->
name|slot_last
condition|;
name|i
operator|++
control|)
block|{
name|local
operator|->
name|slot_queue
index|[
name|state
operator|->
name|slot_queue_available
operator|++
index|]
operator|=
name|i
expr_stmt|;
name|up
argument_list|(
operator|&
name|state
operator|->
name|slot_available_event
argument_list|)
expr_stmt|;
block|}
name|state
operator|->
name|default_slot_quota
operator|=
name|state
operator|->
name|slot_queue_available
operator|/
literal|2
expr_stmt|;
name|state
operator|->
name|default_message_quota
operator|=
name|min
argument_list|(
call|(
name|unsigned
name|short
call|)
argument_list|(
name|state
operator|->
name|default_slot_quota
operator|*
literal|256
argument_list|)
argument_list|,
operator|(
name|unsigned
name|short
operator|)
operator|~
literal|0
argument_list|)
expr_stmt|;
name|state
operator|->
name|previous_data_index
operator|=
operator|-
literal|1
expr_stmt|;
name|state
operator|->
name|data_use_count
operator|=
literal|0
expr_stmt|;
name|state
operator|->
name|data_quota
operator|=
name|state
operator|->
name|slot_queue_available
operator|-
literal|1
expr_stmt|;
name|local
operator|->
name|trigger
operator|.
name|event
operator|=
operator|&
name|state
operator|->
name|trigger_event
expr_stmt|;
name|remote_event_create
argument_list|(
operator|&
name|local
operator|->
name|trigger
argument_list|)
expr_stmt|;
name|local
operator|->
name|tx_pos
operator|=
literal|0
expr_stmt|;
name|local
operator|->
name|recycle
operator|.
name|event
operator|=
operator|&
name|state
operator|->
name|recycle_event
expr_stmt|;
name|remote_event_create
argument_list|(
operator|&
name|local
operator|->
name|recycle
argument_list|)
expr_stmt|;
name|local
operator|->
name|slot_queue_recycle
operator|=
name|state
operator|->
name|slot_queue_available
expr_stmt|;
name|local
operator|->
name|sync_trigger
operator|.
name|event
operator|=
operator|&
name|state
operator|->
name|sync_trigger_event
expr_stmt|;
name|remote_event_create
argument_list|(
operator|&
name|local
operator|->
name|sync_trigger
argument_list|)
expr_stmt|;
name|local
operator|->
name|sync_release
operator|.
name|event
operator|=
operator|&
name|state
operator|->
name|sync_release_event
expr_stmt|;
name|remote_event_create
argument_list|(
operator|&
name|local
operator|->
name|sync_release
argument_list|)
expr_stmt|;
comment|/* At start-of-day, the slot is empty and available */
operator|(
operator|(
name|VCHIQ_HEADER_T
operator|*
operator|)
name|SLOT_DATA_FROM_INDEX
argument_list|(
name|state
argument_list|,
name|local
operator|->
name|slot_sync
argument_list|)
operator|)
operator|->
name|msgid
operator|=
name|VCHIQ_MSGID_PADDING
expr_stmt|;
name|remote_event_signal_local
argument_list|(
operator|&
name|local
operator|->
name|sync_release
argument_list|)
expr_stmt|;
name|local
operator|->
name|debug
index|[
name|DEBUG_ENTRIES
index|]
operator|=
name|DEBUG_MAX
expr_stmt|;
name|status
operator|=
name|vchiq_platform_init_state
argument_list|(
name|state
argument_list|)
expr_stmt|;
comment|/* 		bring up slot handler thread 	 */
name|snprintf
argument_list|(
name|threadname
argument_list|,
sizeof|sizeof
argument_list|(
name|threadname
argument_list|)
argument_list|,
literal|"VCHIQ-%d"
argument_list|,
name|state
operator|->
name|id
argument_list|)
expr_stmt|;
name|state
operator|->
name|slot_handler_thread
operator|=
name|vchiq_thread_create
argument_list|(
operator|&
name|slot_handler_func
argument_list|,
operator|(
name|void
operator|*
operator|)
name|state
argument_list|,
name|threadname
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|->
name|slot_handler_thread
operator|==
name|NULL
condition|)
block|{
name|vchiq_loud_error_header
argument_list|()
expr_stmt|;
name|vchiq_loud_error
argument_list|(
literal|"couldn't create thread %s"
argument_list|,
name|threadname
argument_list|)
expr_stmt|;
name|vchiq_loud_error_footer
argument_list|()
expr_stmt|;
return|return
name|VCHIQ_ERROR
return|;
block|}
name|set_user_nice
argument_list|(
name|state
operator|->
name|slot_handler_thread
argument_list|,
operator|-
literal|19
argument_list|)
expr_stmt|;
name|wake_up_process
argument_list|(
name|state
operator|->
name|slot_handler_thread
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|threadname
argument_list|,
sizeof|sizeof
argument_list|(
name|threadname
argument_list|)
argument_list|,
literal|"VCHIQr-%d"
argument_list|,
name|state
operator|->
name|id
argument_list|)
expr_stmt|;
name|state
operator|->
name|recycle_thread
operator|=
name|vchiq_thread_create
argument_list|(
operator|&
name|recycle_func
argument_list|,
operator|(
name|void
operator|*
operator|)
name|state
argument_list|,
name|threadname
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|->
name|recycle_thread
operator|==
name|NULL
condition|)
block|{
name|vchiq_loud_error_header
argument_list|()
expr_stmt|;
name|vchiq_loud_error
argument_list|(
literal|"couldn't create thread %s"
argument_list|,
name|threadname
argument_list|)
expr_stmt|;
name|vchiq_loud_error_footer
argument_list|()
expr_stmt|;
return|return
name|VCHIQ_ERROR
return|;
block|}
name|set_user_nice
argument_list|(
name|state
operator|->
name|recycle_thread
argument_list|,
operator|-
literal|19
argument_list|)
expr_stmt|;
name|wake_up_process
argument_list|(
name|state
operator|->
name|recycle_thread
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|threadname
argument_list|,
sizeof|sizeof
argument_list|(
name|threadname
argument_list|)
argument_list|,
literal|"VCHIQs-%d"
argument_list|,
name|state
operator|->
name|id
argument_list|)
expr_stmt|;
name|state
operator|->
name|sync_thread
operator|=
name|vchiq_thread_create
argument_list|(
operator|&
name|sync_func
argument_list|,
operator|(
name|void
operator|*
operator|)
name|state
argument_list|,
name|threadname
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|->
name|sync_thread
operator|==
name|NULL
condition|)
block|{
name|vchiq_loud_error_header
argument_list|()
expr_stmt|;
name|vchiq_loud_error
argument_list|(
literal|"couldn't create thread %s"
argument_list|,
name|threadname
argument_list|)
expr_stmt|;
name|vchiq_loud_error_footer
argument_list|()
expr_stmt|;
return|return
name|VCHIQ_ERROR
return|;
block|}
name|set_user_nice
argument_list|(
name|state
operator|->
name|sync_thread
argument_list|,
operator|-
literal|20
argument_list|)
expr_stmt|;
name|wake_up_process
argument_list|(
name|state
operator|->
name|sync_thread
argument_list|)
expr_stmt|;
name|BUG_ON
argument_list|(
name|state
operator|->
name|id
operator|>=
name|VCHIQ_MAX_STATES
argument_list|)
expr_stmt|;
name|vchiq_states
index|[
name|state
operator|->
name|id
index|]
operator|=
name|state
expr_stmt|;
comment|/* Indicate readiness to the other side */
name|local
operator|->
name|initialised
operator|=
literal|1
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/* Called from application thread when a client or server service is created. */
end_comment

begin_function
name|VCHIQ_SERVICE_T
modifier|*
name|vchiq_add_service_internal
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|,
specifier|const
name|VCHIQ_SERVICE_PARAMS_T
modifier|*
name|params
parameter_list|,
name|int
name|srvstate
parameter_list|,
name|VCHIQ_INSTANCE_T
name|instance
parameter_list|,
name|VCHIQ_USERDATA_TERM_T
name|userdata_term
parameter_list|)
block|{
name|VCHIQ_SERVICE_T
modifier|*
name|service
decl_stmt|;
name|service
operator|=
name|kmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|VCHIQ_SERVICE_T
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
name|service
condition|)
block|{
name|service
operator|->
name|base
operator|.
name|fourcc
operator|=
name|params
operator|->
name|fourcc
expr_stmt|;
name|service
operator|->
name|base
operator|.
name|callback
operator|=
name|params
operator|->
name|callback
expr_stmt|;
name|service
operator|->
name|base
operator|.
name|userdata
operator|=
name|params
operator|->
name|userdata
expr_stmt|;
name|service
operator|->
name|handle
operator|=
name|VCHIQ_SERVICE_HANDLE_INVALID
expr_stmt|;
name|service
operator|->
name|ref_count
operator|=
literal|1
expr_stmt|;
name|service
operator|->
name|srvstate
operator|=
name|VCHIQ_SRVSTATE_FREE
expr_stmt|;
name|service
operator|->
name|userdata_term
operator|=
name|userdata_term
expr_stmt|;
name|service
operator|->
name|localport
operator|=
name|VCHIQ_PORT_FREE
expr_stmt|;
name|service
operator|->
name|remoteport
operator|=
name|VCHIQ_PORT_FREE
expr_stmt|;
name|service
operator|->
name|public_fourcc
operator|=
operator|(
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_OPENING
operator|)
condition|?
name|VCHIQ_FOURCC_INVALID
else|:
name|params
operator|->
name|fourcc
expr_stmt|;
name|service
operator|->
name|client_id
operator|=
literal|0
expr_stmt|;
name|service
operator|->
name|auto_close
operator|=
literal|1
expr_stmt|;
name|service
operator|->
name|sync
operator|=
literal|0
expr_stmt|;
name|service
operator|->
name|closing
operator|=
literal|0
expr_stmt|;
name|atomic_set
argument_list|(
operator|&
name|service
operator|->
name|poll_flags
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|service
operator|->
name|version
operator|=
name|params
operator|->
name|version
expr_stmt|;
name|service
operator|->
name|version_min
operator|=
name|params
operator|->
name|version_min
expr_stmt|;
name|service
operator|->
name|state
operator|=
name|state
expr_stmt|;
name|service
operator|->
name|instance
operator|=
name|instance
expr_stmt|;
name|service
operator|->
name|service_use_count
operator|=
literal|0
expr_stmt|;
name|init_bulk_queue
argument_list|(
operator|&
name|service
operator|->
name|bulk_tx
argument_list|)
expr_stmt|;
name|init_bulk_queue
argument_list|(
operator|&
name|service
operator|->
name|bulk_rx
argument_list|)
expr_stmt|;
name|_sema_init
argument_list|(
operator|&
name|service
operator|->
name|remove_event
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|_sema_init
argument_list|(
operator|&
name|service
operator|->
name|bulk_remove_event
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|lmutex_init
argument_list|(
operator|&
name|service
operator|->
name|bulk_mutex
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|service
operator|->
name|stats
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|service
operator|->
name|stats
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"Out of memory"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|service
condition|)
block|{
name|VCHIQ_SERVICE_T
modifier|*
modifier|*
name|pservice
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Although it is perfectly possible to use service_spinlock 		** to protect the creation of services, it is overkill as it 		** disables interrupts while the array is searched. 		** The only danger is of another thread trying to create a 		** service - service deletion is safe. 		** Therefore it is preferable to use state->mutex which, 		** although slower to claim, doesn't block interrupts while 		** it is held. 		*/
name|lmutex_lock
argument_list|(
operator|&
name|state
operator|->
name|mutex
argument_list|)
expr_stmt|;
comment|/* Prepare to use a previously unused service */
if|if
condition|(
name|state
operator|->
name|unused_service
operator|<
name|VCHIQ_MAX_SERVICES
condition|)
name|pservice
operator|=
operator|&
name|state
operator|->
name|services
index|[
name|state
operator|->
name|unused_service
index|]
expr_stmt|;
if|if
condition|(
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_OPENING
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|state
operator|->
name|unused_service
condition|;
name|i
operator|++
control|)
block|{
name|VCHIQ_SERVICE_T
modifier|*
name|srv
init|=
name|state
operator|->
name|services
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|srv
condition|)
block|{
name|pservice
operator|=
operator|&
name|state
operator|->
name|services
index|[
name|i
index|]
expr_stmt|;
break|break;
block|}
block|}
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
operator|(
name|state
operator|->
name|unused_service
operator|-
literal|1
operator|)
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
block|{
name|VCHIQ_SERVICE_T
modifier|*
name|srv
init|=
name|state
operator|->
name|services
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|srv
condition|)
name|pservice
operator|=
operator|&
name|state
operator|->
name|services
index|[
name|i
index|]
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|srv
operator|->
name|public_fourcc
operator|==
name|params
operator|->
name|fourcc
operator|)
operator|&&
operator|(
operator|(
name|srv
operator|->
name|instance
operator|!=
name|instance
operator|)
operator|||
operator|(
name|srv
operator|->
name|base
operator|.
name|callback
operator|!=
name|params
operator|->
name|callback
operator|)
operator|)
condition|)
block|{
comment|/* There is another server using this 					** fourcc which doesn't match. */
name|pservice
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
name|pservice
condition|)
block|{
name|service
operator|->
name|localport
operator|=
operator|(
name|pservice
operator|-
name|state
operator|->
name|services
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|handle_seq
condition|)
name|handle_seq
operator|=
name|VCHIQ_MAX_STATES
operator|*
name|VCHIQ_MAX_SERVICES
expr_stmt|;
name|service
operator|->
name|handle
operator|=
name|handle_seq
operator||
operator|(
name|state
operator|->
name|id
operator|*
name|VCHIQ_MAX_SERVICES
operator|)
operator||
name|service
operator|->
name|localport
expr_stmt|;
name|handle_seq
operator|+=
name|VCHIQ_MAX_STATES
operator|*
name|VCHIQ_MAX_SERVICES
expr_stmt|;
operator|*
name|pservice
operator|=
name|service
expr_stmt|;
if|if
condition|(
name|pservice
operator|==
operator|&
name|state
operator|->
name|services
index|[
name|state
operator|->
name|unused_service
index|]
condition|)
name|state
operator|->
name|unused_service
operator|++
expr_stmt|;
block|}
name|lmutex_unlock
argument_list|(
operator|&
name|state
operator|->
name|mutex
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pservice
condition|)
block|{
name|_sema_destroy
argument_list|(
operator|&
name|service
operator|->
name|remove_event
argument_list|)
expr_stmt|;
name|_sema_destroy
argument_list|(
operator|&
name|service
operator|->
name|bulk_remove_event
argument_list|)
expr_stmt|;
name|lmutex_destroy
argument_list|(
operator|&
name|service
operator|->
name|bulk_mutex
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|service
argument_list|)
expr_stmt|;
name|service
operator|=
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
name|service
condition|)
block|{
name|VCHIQ_SERVICE_QUOTA_T
modifier|*
name|service_quota
init|=
operator|&
name|state
operator|->
name|service_quotas
index|[
name|service
operator|->
name|localport
index|]
decl_stmt|;
name|service_quota
operator|->
name|slot_quota
operator|=
name|state
operator|->
name|default_slot_quota
expr_stmt|;
name|service_quota
operator|->
name|message_quota
operator|=
name|state
operator|->
name|default_message_quota
expr_stmt|;
if|if
condition|(
name|service_quota
operator|->
name|slot_use_count
operator|==
literal|0
condition|)
name|service_quota
operator|->
name|previous_tx_index
operator|=
name|SLOT_QUEUE_INDEX_FROM_POS
argument_list|(
name|state
operator|->
name|local_tx_pos
argument_list|)
operator|-
literal|1
expr_stmt|;
comment|/* Bring this service online */
name|vchiq_set_service_state
argument_list|(
name|service
argument_list|,
name|srvstate
argument_list|)
expr_stmt|;
name|vchiq_log_info
argument_list|(
name|vchiq_core_msg_log_level
argument_list|,
literal|"%s Service %c%c%c%c SrcPort:%d"
argument_list|,
operator|(
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_OPENING
operator|)
condition|?
literal|"Open"
else|:
literal|"Add"
argument_list|,
name|VCHIQ_FOURCC_AS_4CHARS
argument_list|(
name|params
operator|->
name|fourcc
argument_list|)
argument_list|,
name|service
operator|->
name|localport
argument_list|)
expr_stmt|;
block|}
comment|/* Don't unlock the service - leave it with a ref_count of 1. */
return|return
name|service
return|;
block|}
end_function

begin_function
name|VCHIQ_STATUS_T
name|vchiq_open_service_internal
parameter_list|(
name|VCHIQ_SERVICE_T
modifier|*
name|service
parameter_list|,
name|int
name|client_id
parameter_list|)
block|{
name|struct
name|vchiq_open_payload
name|payload
init|=
block|{
name|service
operator|->
name|base
operator|.
name|fourcc
block|,
name|client_id
block|,
name|service
operator|->
name|version
block|,
name|service
operator|->
name|version_min
block|}
decl_stmt|;
name|VCHIQ_ELEMENT_T
name|body
init|=
block|{
operator|&
name|payload
block|,
expr|sizeof
operator|(
name|payload
operator|)
block|}
decl_stmt|;
name|VCHIQ_STATUS_T
name|status
init|=
name|VCHIQ_SUCCESS
decl_stmt|;
name|service
operator|->
name|client_id
operator|=
name|client_id
expr_stmt|;
name|vchiq_use_service_internal
argument_list|(
name|service
argument_list|)
expr_stmt|;
name|status
operator|=
name|queue_message
argument_list|(
name|service
operator|->
name|state
argument_list|,
name|NULL
argument_list|,
name|VCHIQ_MAKE_MSG
argument_list|(
name|VCHIQ_MSG_OPEN
argument_list|,
name|service
operator|->
name|localport
argument_list|,
literal|0
argument_list|)
argument_list|,
operator|&
name|body
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|payload
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|VCHIQ_SUCCESS
condition|)
block|{
if|if
condition|(
name|down_interruptible
argument_list|(
operator|&
name|service
operator|->
name|remove_event
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|status
operator|=
name|VCHIQ_RETRY
expr_stmt|;
name|vchiq_release_service_internal
argument_list|(
name|service
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|service
operator|->
name|srvstate
operator|!=
name|VCHIQ_SRVSTATE_OPEN
operator|)
operator|&&
operator|(
name|service
operator|->
name|srvstate
operator|!=
name|VCHIQ_SRVSTATE_OPENSYNC
operator|)
condition|)
block|{
if|if
condition|(
name|service
operator|->
name|srvstate
operator|!=
name|VCHIQ_SRVSTATE_CLOSEWAIT
condition|)
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: osi - srvstate = %s (ref %d)"
argument_list|,
name|service
operator|->
name|state
operator|->
name|id
argument_list|,
name|srvstate_names
index|[
name|service
operator|->
name|srvstate
index|]
argument_list|,
name|service
operator|->
name|ref_count
argument_list|)
expr_stmt|;
name|status
operator|=
name|VCHIQ_ERROR
expr_stmt|;
name|VCHIQ_SERVICE_STATS_INC
argument_list|(
name|service
argument_list|,
name|error_count
argument_list|)
expr_stmt|;
name|vchiq_release_service_internal
argument_list|(
name|service
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|release_service_messages
parameter_list|(
name|VCHIQ_SERVICE_T
modifier|*
name|service
parameter_list|)
block|{
name|VCHIQ_STATE_T
modifier|*
name|state
init|=
name|service
operator|->
name|state
decl_stmt|;
name|int
name|slot_last
init|=
name|state
operator|->
name|remote
operator|->
name|slot_last
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Release any claimed messages */
for|for
control|(
name|i
operator|=
name|state
operator|->
name|remote
operator|->
name|slot_first
init|;
name|i
operator|<=
name|slot_last
condition|;
name|i
operator|++
control|)
block|{
name|VCHIQ_SLOT_INFO_T
modifier|*
name|slot_info
init|=
name|SLOT_INFO_FROM_INDEX
argument_list|(
name|state
argument_list|,
name|i
argument_list|)
decl_stmt|;
if|if
condition|(
name|slot_info
operator|->
name|release_count
operator|!=
name|slot_info
operator|->
name|use_count
condition|)
block|{
name|char
modifier|*
name|data
init|=
operator|(
name|char
operator|*
operator|)
name|SLOT_DATA_FROM_INDEX
argument_list|(
name|state
argument_list|,
name|i
argument_list|)
decl_stmt|;
name|unsigned
name|int
name|pos
decl_stmt|,
name|end
decl_stmt|;
name|end
operator|=
name|VCHIQ_SLOT_SIZE
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|state
operator|->
name|rx_data
condition|)
comment|/* This buffer is still being read from - stop 				** at the current read position */
name|end
operator|=
name|state
operator|->
name|rx_pos
operator|&
name|VCHIQ_SLOT_MASK
expr_stmt|;
name|pos
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|pos
operator|<
name|end
condition|)
block|{
name|VCHIQ_HEADER_T
modifier|*
name|header
init|=
operator|(
name|VCHIQ_HEADER_T
operator|*
operator|)
operator|(
name|data
operator|+
name|pos
operator|)
decl_stmt|;
name|int
name|msgid
init|=
name|header
operator|->
name|msgid
decl_stmt|;
name|int
name|port
init|=
name|VCHIQ_MSG_DSTPORT
argument_list|(
name|msgid
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|port
operator|==
name|service
operator|->
name|localport
operator|)
operator|&&
operator|(
name|msgid
operator|&
name|VCHIQ_MSGID_CLAIMED
operator|)
condition|)
block|{
name|vchiq_log_info
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"  fsi - hdr %x"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|)
expr_stmt|;
name|release_slot
argument_list|(
name|state
argument_list|,
name|slot_info
argument_list|,
name|header
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|pos
operator|+=
name|calc_stride
argument_list|(
name|header
operator|->
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|>
name|VCHIQ_SLOT_SIZE
condition|)
block|{
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"fsi - pos %x: header %x, "
literal|"msgid %x, header->msgid %x, "
literal|"header->size %x"
argument_list|,
name|pos
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|header
argument_list|,
name|msgid
argument_list|,
name|header
operator|->
name|msgid
argument_list|,
name|header
operator|->
name|size
argument_list|)
expr_stmt|;
name|WARN
argument_list|(
literal|1
argument_list|,
literal|"invalid slot position\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|do_abort_bulks
parameter_list|(
name|VCHIQ_SERVICE_T
modifier|*
name|service
parameter_list|)
block|{
name|VCHIQ_STATUS_T
name|status
decl_stmt|;
comment|/* Abort any outstanding bulk transfers */
if|if
condition|(
name|lmutex_lock_interruptible
argument_list|(
operator|&
name|service
operator|->
name|bulk_mutex
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
name|abort_outstanding_bulks
argument_list|(
name|service
argument_list|,
operator|&
name|service
operator|->
name|bulk_tx
argument_list|)
expr_stmt|;
name|abort_outstanding_bulks
argument_list|(
name|service
argument_list|,
operator|&
name|service
operator|->
name|bulk_rx
argument_list|)
expr_stmt|;
name|lmutex_unlock
argument_list|(
operator|&
name|service
operator|->
name|bulk_mutex
argument_list|)
expr_stmt|;
name|status
operator|=
name|notify_bulks
argument_list|(
name|service
argument_list|,
operator|&
name|service
operator|->
name|bulk_tx
argument_list|,
literal|0
comment|/*!retry_poll*/
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|VCHIQ_SUCCESS
condition|)
name|status
operator|=
name|notify_bulks
argument_list|(
name|service
argument_list|,
operator|&
name|service
operator|->
name|bulk_rx
argument_list|,
literal|0
comment|/*!retry_poll*/
argument_list|)
expr_stmt|;
return|return
operator|(
name|status
operator|==
name|VCHIQ_SUCCESS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|VCHIQ_STATUS_T
name|close_service_complete
parameter_list|(
name|VCHIQ_SERVICE_T
modifier|*
name|service
parameter_list|,
name|int
name|failstate
parameter_list|)
block|{
name|VCHIQ_STATUS_T
name|status
decl_stmt|;
name|int
name|is_server
init|=
operator|(
name|service
operator|->
name|public_fourcc
operator|!=
name|VCHIQ_FOURCC_INVALID
operator|)
decl_stmt|;
name|int
name|newstate
decl_stmt|;
switch|switch
condition|(
name|service
operator|->
name|srvstate
condition|)
block|{
case|case
name|VCHIQ_SRVSTATE_OPEN
case|:
case|case
name|VCHIQ_SRVSTATE_CLOSESENT
case|:
case|case
name|VCHIQ_SRVSTATE_CLOSERECVD
case|:
if|if
condition|(
name|is_server
condition|)
block|{
if|if
condition|(
name|service
operator|->
name|auto_close
condition|)
block|{
name|service
operator|->
name|client_id
operator|=
literal|0
expr_stmt|;
name|service
operator|->
name|remoteport
operator|=
name|VCHIQ_PORT_FREE
expr_stmt|;
name|newstate
operator|=
name|VCHIQ_SRVSTATE_LISTENING
expr_stmt|;
block|}
else|else
name|newstate
operator|=
name|VCHIQ_SRVSTATE_CLOSEWAIT
expr_stmt|;
block|}
else|else
name|newstate
operator|=
name|VCHIQ_SRVSTATE_CLOSED
expr_stmt|;
name|vchiq_set_service_state
argument_list|(
name|service
argument_list|,
name|newstate
argument_list|)
expr_stmt|;
break|break;
case|case
name|VCHIQ_SRVSTATE_LISTENING
case|:
break|break;
default|default:
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"close_service_complete(%x) called in state %s"
argument_list|,
name|service
operator|->
name|handle
argument_list|,
name|srvstate_names
index|[
name|service
operator|->
name|srvstate
index|]
argument_list|)
expr_stmt|;
name|WARN
argument_list|(
literal|1
argument_list|,
literal|"close_service_complete in unexpected state\n"
argument_list|)
expr_stmt|;
return|return
name|VCHIQ_ERROR
return|;
block|}
name|status
operator|=
name|make_service_callback
argument_list|(
name|service
argument_list|,
name|VCHIQ_SERVICE_CLOSED
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VCHIQ_RETRY
condition|)
block|{
name|int
name|uc
init|=
name|service
operator|->
name|service_use_count
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Complete the close process */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|uc
condition|;
name|i
operator|++
control|)
comment|/* cater for cases where close is forced and the 			** client may not close all it's handles */
name|vchiq_release_service_internal
argument_list|(
name|service
argument_list|)
expr_stmt|;
name|service
operator|->
name|client_id
operator|=
literal|0
expr_stmt|;
name|service
operator|->
name|remoteport
operator|=
name|VCHIQ_PORT_FREE
expr_stmt|;
if|if
condition|(
name|service
operator|->
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_CLOSED
condition|)
name|vchiq_free_service_internal
argument_list|(
name|service
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|service
operator|->
name|srvstate
operator|!=
name|VCHIQ_SRVSTATE_CLOSEWAIT
condition|)
block|{
if|if
condition|(
name|is_server
condition|)
name|service
operator|->
name|closing
operator|=
literal|0
expr_stmt|;
name|up
argument_list|(
operator|&
name|service
operator|->
name|remove_event
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|vchiq_set_service_state
argument_list|(
name|service
argument_list|,
name|failstate
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/* Called by the slot handler */
end_comment

begin_function
name|VCHIQ_STATUS_T
name|vchiq_close_service_internal
parameter_list|(
name|VCHIQ_SERVICE_T
modifier|*
name|service
parameter_list|,
name|int
name|close_recvd
parameter_list|)
block|{
name|VCHIQ_STATE_T
modifier|*
name|state
init|=
name|service
operator|->
name|state
decl_stmt|;
name|VCHIQ_STATUS_T
name|status
init|=
name|VCHIQ_SUCCESS
decl_stmt|;
name|int
name|is_server
init|=
operator|(
name|service
operator|->
name|public_fourcc
operator|!=
name|VCHIQ_FOURCC_INVALID
operator|)
decl_stmt|;
name|vchiq_log_info
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: csi:%d,%d (%s)"
argument_list|,
name|service
operator|->
name|state
operator|->
name|id
argument_list|,
name|service
operator|->
name|localport
argument_list|,
name|close_recvd
argument_list|,
name|srvstate_names
index|[
name|service
operator|->
name|srvstate
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|service
operator|->
name|srvstate
condition|)
block|{
case|case
name|VCHIQ_SRVSTATE_CLOSED
case|:
case|case
name|VCHIQ_SRVSTATE_HIDDEN
case|:
case|case
name|VCHIQ_SRVSTATE_LISTENING
case|:
case|case
name|VCHIQ_SRVSTATE_CLOSEWAIT
case|:
if|if
condition|(
name|close_recvd
condition|)
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"vchiq_close_service_internal(1) called "
literal|"in state %s"
argument_list|,
name|srvstate_names
index|[
name|service
operator|->
name|srvstate
index|]
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|is_server
condition|)
block|{
if|if
condition|(
name|service
operator|->
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_LISTENING
condition|)
block|{
name|status
operator|=
name|VCHIQ_ERROR
expr_stmt|;
block|}
else|else
block|{
name|service
operator|->
name|client_id
operator|=
literal|0
expr_stmt|;
name|service
operator|->
name|remoteport
operator|=
name|VCHIQ_PORT_FREE
expr_stmt|;
if|if
condition|(
name|service
operator|->
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_CLOSEWAIT
condition|)
name|vchiq_set_service_state
argument_list|(
name|service
argument_list|,
name|VCHIQ_SRVSTATE_LISTENING
argument_list|)
expr_stmt|;
block|}
name|up
argument_list|(
operator|&
name|service
operator|->
name|remove_event
argument_list|)
expr_stmt|;
block|}
else|else
name|vchiq_free_service_internal
argument_list|(
name|service
argument_list|)
expr_stmt|;
break|break;
case|case
name|VCHIQ_SRVSTATE_OPENING
case|:
if|if
condition|(
name|close_recvd
condition|)
block|{
comment|/* The open was rejected - tell the user */
name|vchiq_set_service_state
argument_list|(
name|service
argument_list|,
name|VCHIQ_SRVSTATE_CLOSEWAIT
argument_list|)
expr_stmt|;
name|up
argument_list|(
operator|&
name|service
operator|->
name|remove_event
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Shutdown mid-open - let the other side know */
name|status
operator|=
name|queue_message
argument_list|(
name|state
argument_list|,
name|service
argument_list|,
name|VCHIQ_MAKE_MSG
argument_list|(
name|VCHIQ_MSG_CLOSE
argument_list|,
name|service
operator|->
name|localport
argument_list|,
name|VCHIQ_MSG_DSTPORT
argument_list|(
name|service
operator|->
name|remoteport
argument_list|)
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|VCHIQ_SRVSTATE_OPENSYNC
case|:
name|lmutex_lock
argument_list|(
operator|&
name|state
operator|->
name|sync_mutex
argument_list|)
expr_stmt|;
comment|/* Drop through */
case|case
name|VCHIQ_SRVSTATE_OPEN
case|:
if|if
condition|(
name|state
operator|->
name|is_master
operator|||
name|close_recvd
condition|)
block|{
if|if
condition|(
operator|!
name|do_abort_bulks
argument_list|(
name|service
argument_list|)
condition|)
name|status
operator|=
name|VCHIQ_RETRY
expr_stmt|;
block|}
name|release_service_messages
argument_list|(
name|service
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|VCHIQ_SUCCESS
condition|)
name|status
operator|=
name|queue_message
argument_list|(
name|state
argument_list|,
name|service
argument_list|,
name|VCHIQ_MAKE_MSG
argument_list|(
name|VCHIQ_MSG_CLOSE
argument_list|,
name|service
operator|->
name|localport
argument_list|,
name|VCHIQ_MSG_DSTPORT
argument_list|(
name|service
operator|->
name|remoteport
argument_list|)
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|VCHIQ_SUCCESS
condition|)
block|{
if|if
condition|(
operator|!
name|close_recvd
condition|)
break|break;
block|}
elseif|else
if|if
condition|(
name|service
operator|->
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_OPENSYNC
condition|)
block|{
name|lmutex_unlock
argument_list|(
operator|&
name|state
operator|->
name|sync_mutex
argument_list|)
expr_stmt|;
break|break;
block|}
else|else
break|break;
name|status
operator|=
name|close_service_complete
argument_list|(
name|service
argument_list|,
name|VCHIQ_SRVSTATE_CLOSERECVD
argument_list|)
expr_stmt|;
break|break;
case|case
name|VCHIQ_SRVSTATE_CLOSESENT
case|:
if|if
condition|(
operator|!
name|close_recvd
condition|)
comment|/* This happens when a process is killed mid-close */
break|break;
if|if
condition|(
operator|!
name|state
operator|->
name|is_master
condition|)
block|{
if|if
condition|(
operator|!
name|do_abort_bulks
argument_list|(
name|service
argument_list|)
condition|)
block|{
name|status
operator|=
name|VCHIQ_RETRY
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|status
operator|==
name|VCHIQ_SUCCESS
condition|)
name|status
operator|=
name|close_service_complete
argument_list|(
name|service
argument_list|,
name|VCHIQ_SRVSTATE_CLOSERECVD
argument_list|)
expr_stmt|;
break|break;
case|case
name|VCHIQ_SRVSTATE_CLOSERECVD
case|:
if|if
condition|(
operator|!
name|close_recvd
operator|&&
name|is_server
condition|)
comment|/* Force into LISTENING mode */
name|vchiq_set_service_state
argument_list|(
name|service
argument_list|,
name|VCHIQ_SRVSTATE_LISTENING
argument_list|)
expr_stmt|;
name|status
operator|=
name|close_service_complete
argument_list|(
name|service
argument_list|,
name|VCHIQ_SRVSTATE_CLOSERECVD
argument_list|)
expr_stmt|;
break|break;
default|default:
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"vchiq_close_service_internal(%d) called in state %s"
argument_list|,
name|close_recvd
argument_list|,
name|srvstate_names
index|[
name|service
operator|->
name|srvstate
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/* Called from the application process upon process death */
end_comment

begin_function
name|void
name|vchiq_terminate_service_internal
parameter_list|(
name|VCHIQ_SERVICE_T
modifier|*
name|service
parameter_list|)
block|{
name|VCHIQ_STATE_T
modifier|*
name|state
init|=
name|service
operator|->
name|state
decl_stmt|;
name|vchiq_log_info
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: tsi - (%d<->%d)"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|service
operator|->
name|localport
argument_list|,
name|service
operator|->
name|remoteport
argument_list|)
expr_stmt|;
name|mark_service_closing
argument_list|(
name|service
argument_list|)
expr_stmt|;
comment|/* Mark the service for removal by the slot handler */
name|request_poll
argument_list|(
name|state
argument_list|,
name|service
argument_list|,
name|VCHIQ_POLL_REMOVE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Called from the slot handler */
end_comment

begin_function
name|void
name|vchiq_free_service_internal
parameter_list|(
name|VCHIQ_SERVICE_T
modifier|*
name|service
parameter_list|)
block|{
name|VCHIQ_STATE_T
modifier|*
name|state
init|=
name|service
operator|->
name|state
decl_stmt|;
name|vchiq_log_info
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: fsi - (%d)"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|service
operator|->
name|localport
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|service
operator|->
name|srvstate
condition|)
block|{
case|case
name|VCHIQ_SRVSTATE_OPENING
case|:
case|case
name|VCHIQ_SRVSTATE_CLOSED
case|:
case|case
name|VCHIQ_SRVSTATE_HIDDEN
case|:
case|case
name|VCHIQ_SRVSTATE_LISTENING
case|:
case|case
name|VCHIQ_SRVSTATE_CLOSEWAIT
case|:
break|break;
default|default:
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: fsi - (%d) in state %s"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|service
operator|->
name|localport
argument_list|,
name|srvstate_names
index|[
name|service
operator|->
name|srvstate
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
name|vchiq_set_service_state
argument_list|(
name|service
argument_list|,
name|VCHIQ_SRVSTATE_FREE
argument_list|)
expr_stmt|;
name|up
argument_list|(
operator|&
name|service
operator|->
name|remove_event
argument_list|)
expr_stmt|;
comment|/* Release the initial lock */
name|unlock_service
argument_list|(
name|service
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|VCHIQ_STATUS_T
name|vchiq_connect_internal
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|,
name|VCHIQ_INSTANCE_T
name|instance
parameter_list|)
block|{
name|VCHIQ_SERVICE_T
modifier|*
name|service
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Find all services registered to this client and enable them. */
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|service
operator|=
name|next_service_by_instance
argument_list|(
name|state
argument_list|,
name|instance
argument_list|,
operator|&
name|i
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|service
operator|->
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_HIDDEN
condition|)
name|vchiq_set_service_state
argument_list|(
name|service
argument_list|,
name|VCHIQ_SRVSTATE_LISTENING
argument_list|)
expr_stmt|;
name|unlock_service
argument_list|(
name|service
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|state
operator|->
name|conn_state
operator|==
name|VCHIQ_CONNSTATE_DISCONNECTED
condition|)
block|{
if|if
condition|(
name|queue_message
argument_list|(
name|state
argument_list|,
name|NULL
argument_list|,
name|VCHIQ_MAKE_MSG
argument_list|(
name|VCHIQ_MSG_CONNECT
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
operator|==
name|VCHIQ_RETRY
condition|)
return|return
name|VCHIQ_RETRY
return|;
name|vchiq_set_conn_state
argument_list|(
name|state
argument_list|,
name|VCHIQ_CONNSTATE_CONNECTING
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|state
operator|->
name|conn_state
operator|==
name|VCHIQ_CONNSTATE_CONNECTING
condition|)
block|{
if|if
condition|(
name|down_interruptible
argument_list|(
operator|&
name|state
operator|->
name|connect
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|VCHIQ_RETRY
return|;
name|vchiq_set_conn_state
argument_list|(
name|state
argument_list|,
name|VCHIQ_CONNSTATE_CONNECTED
argument_list|)
expr_stmt|;
name|up
argument_list|(
operator|&
name|state
operator|->
name|connect
argument_list|)
expr_stmt|;
block|}
return|return
name|VCHIQ_SUCCESS
return|;
block|}
end_function

begin_function
name|VCHIQ_STATUS_T
name|vchiq_shutdown_internal
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|,
name|VCHIQ_INSTANCE_T
name|instance
parameter_list|)
block|{
name|VCHIQ_SERVICE_T
modifier|*
name|service
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Find all services registered to this client and enable them. */
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|service
operator|=
name|next_service_by_instance
argument_list|(
name|state
argument_list|,
name|instance
argument_list|,
operator|&
name|i
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|vchiq_remove_service
argument_list|(
name|service
operator|->
name|handle
argument_list|)
expr_stmt|;
name|unlock_service
argument_list|(
name|service
argument_list|)
expr_stmt|;
block|}
return|return
name|VCHIQ_SUCCESS
return|;
block|}
end_function

begin_function
name|VCHIQ_STATUS_T
name|vchiq_pause_internal
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|)
block|{
name|VCHIQ_STATUS_T
name|status
init|=
name|VCHIQ_SUCCESS
decl_stmt|;
switch|switch
condition|(
name|state
operator|->
name|conn_state
condition|)
block|{
case|case
name|VCHIQ_CONNSTATE_CONNECTED
case|:
comment|/* Request a pause */
name|vchiq_set_conn_state
argument_list|(
name|state
argument_list|,
name|VCHIQ_CONNSTATE_PAUSING
argument_list|)
expr_stmt|;
name|request_poll
argument_list|(
name|state
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"vchiq_pause_internal in state %s\n"
argument_list|,
name|conn_state_names
index|[
name|state
operator|->
name|conn_state
index|]
argument_list|)
expr_stmt|;
name|status
operator|=
name|VCHIQ_ERROR
expr_stmt|;
name|VCHIQ_STATS_INC
argument_list|(
name|state
argument_list|,
name|error_count
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|status
return|;
block|}
end_function

begin_function
name|VCHIQ_STATUS_T
name|vchiq_resume_internal
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|)
block|{
name|VCHIQ_STATUS_T
name|status
init|=
name|VCHIQ_SUCCESS
decl_stmt|;
if|if
condition|(
name|state
operator|->
name|conn_state
operator|==
name|VCHIQ_CONNSTATE_PAUSED
condition|)
block|{
name|vchiq_set_conn_state
argument_list|(
name|state
argument_list|,
name|VCHIQ_CONNSTATE_RESUMING
argument_list|)
expr_stmt|;
name|request_poll
argument_list|(
name|state
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|VCHIQ_ERROR
expr_stmt|;
name|VCHIQ_STATS_INC
argument_list|(
name|state
argument_list|,
name|error_count
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_function
name|VCHIQ_STATUS_T
name|vchiq_close_service
parameter_list|(
name|VCHIQ_SERVICE_HANDLE_T
name|handle
parameter_list|)
block|{
comment|/* Unregister the service */
name|VCHIQ_SERVICE_T
modifier|*
name|service
init|=
name|find_service_by_handle
argument_list|(
name|handle
argument_list|)
decl_stmt|;
name|VCHIQ_STATUS_T
name|status
init|=
name|VCHIQ_SUCCESS
decl_stmt|;
if|if
condition|(
operator|!
name|service
condition|)
return|return
name|VCHIQ_ERROR
return|;
name|vchiq_log_info
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: close_service:%d"
argument_list|,
name|service
operator|->
name|state
operator|->
name|id
argument_list|,
name|service
operator|->
name|localport
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|service
operator|->
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_FREE
operator|)
operator|||
operator|(
name|service
operator|->
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_LISTENING
operator|)
operator|||
operator|(
name|service
operator|->
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_HIDDEN
operator|)
condition|)
block|{
name|unlock_service
argument_list|(
name|service
argument_list|)
expr_stmt|;
return|return
name|VCHIQ_ERROR
return|;
block|}
name|mark_service_closing
argument_list|(
name|service
argument_list|)
expr_stmt|;
if|if
condition|(
name|current
operator|==
name|service
operator|->
name|state
operator|->
name|slot_handler_thread
condition|)
block|{
name|status
operator|=
name|vchiq_close_service_internal
argument_list|(
name|service
argument_list|,
literal|0
comment|/*!close_recvd*/
argument_list|)
expr_stmt|;
name|BUG_ON
argument_list|(
name|status
operator|==
name|VCHIQ_RETRY
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Mark the service for termination by the slot handler */
name|request_poll
argument_list|(
name|service
operator|->
name|state
argument_list|,
name|service
argument_list|,
name|VCHIQ_POLL_TERMINATE
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|down_interruptible
argument_list|(
operator|&
name|service
operator|->
name|remove_event
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|status
operator|=
name|VCHIQ_RETRY
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|service
operator|->
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_FREE
operator|)
operator|||
operator|(
name|service
operator|->
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_LISTENING
operator|)
operator|||
operator|(
name|service
operator|->
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_OPEN
operator|)
condition|)
break|break;
name|vchiq_log_warning
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: close_service:%d - waiting in state %s"
argument_list|,
name|service
operator|->
name|state
operator|->
name|id
argument_list|,
name|service
operator|->
name|localport
argument_list|,
name|srvstate_names
index|[
name|service
operator|->
name|srvstate
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|status
operator|==
name|VCHIQ_SUCCESS
operator|)
operator|&&
operator|(
name|service
operator|->
name|srvstate
operator|!=
name|VCHIQ_SRVSTATE_FREE
operator|)
operator|&&
operator|(
name|service
operator|->
name|srvstate
operator|!=
name|VCHIQ_SRVSTATE_LISTENING
operator|)
condition|)
name|status
operator|=
name|VCHIQ_ERROR
expr_stmt|;
name|unlock_service
argument_list|(
name|service
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|VCHIQ_STATUS_T
name|vchiq_remove_service
parameter_list|(
name|VCHIQ_SERVICE_HANDLE_T
name|handle
parameter_list|)
block|{
comment|/* Unregister the service */
name|VCHIQ_SERVICE_T
modifier|*
name|service
init|=
name|find_service_by_handle
argument_list|(
name|handle
argument_list|)
decl_stmt|;
name|VCHIQ_STATUS_T
name|status
init|=
name|VCHIQ_SUCCESS
decl_stmt|;
if|if
condition|(
operator|!
name|service
condition|)
return|return
name|VCHIQ_ERROR
return|;
name|vchiq_log_info
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: remove_service:%d"
argument_list|,
name|service
operator|->
name|state
operator|->
name|id
argument_list|,
name|service
operator|->
name|localport
argument_list|)
expr_stmt|;
if|if
condition|(
name|service
operator|->
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_FREE
condition|)
block|{
name|unlock_service
argument_list|(
name|service
argument_list|)
expr_stmt|;
return|return
name|VCHIQ_ERROR
return|;
block|}
name|mark_service_closing
argument_list|(
name|service
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|service
operator|->
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_HIDDEN
operator|)
operator|||
operator|(
name|current
operator|==
name|service
operator|->
name|state
operator|->
name|slot_handler_thread
operator|)
condition|)
block|{
comment|/* Make it look like a client, because it must be removed and 		   not left in the LISTENING state. */
name|service
operator|->
name|public_fourcc
operator|=
name|VCHIQ_FOURCC_INVALID
expr_stmt|;
name|status
operator|=
name|vchiq_close_service_internal
argument_list|(
name|service
argument_list|,
literal|0
comment|/*!close_recvd*/
argument_list|)
expr_stmt|;
name|BUG_ON
argument_list|(
name|status
operator|==
name|VCHIQ_RETRY
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Mark the service for removal by the slot handler */
name|request_poll
argument_list|(
name|service
operator|->
name|state
argument_list|,
name|service
argument_list|,
name|VCHIQ_POLL_REMOVE
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|down_interruptible
argument_list|(
operator|&
name|service
operator|->
name|remove_event
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|status
operator|=
name|VCHIQ_RETRY
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|service
operator|->
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_FREE
operator|)
operator|||
operator|(
name|service
operator|->
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_OPEN
operator|)
condition|)
break|break;
name|vchiq_log_warning
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: remove_service:%d - waiting in state %s"
argument_list|,
name|service
operator|->
name|state
operator|->
name|id
argument_list|,
name|service
operator|->
name|localport
argument_list|,
name|srvstate_names
index|[
name|service
operator|->
name|srvstate
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|status
operator|==
name|VCHIQ_SUCCESS
operator|)
operator|&&
operator|(
name|service
operator|->
name|srvstate
operator|!=
name|VCHIQ_SRVSTATE_FREE
operator|)
condition|)
name|status
operator|=
name|VCHIQ_ERROR
expr_stmt|;
name|unlock_service
argument_list|(
name|service
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/* This function may be called by kernel threads or user threads.  * User threads may receive VCHIQ_RETRY to indicate that a signal has been  * received and the call should be retried after being returned to user  * context.  * When called in blocking mode, the userdata field points to a bulk_waiter  * structure.  */
end_comment

begin_function
name|VCHIQ_STATUS_T
name|vchiq_bulk_transfer
parameter_list|(
name|VCHIQ_SERVICE_HANDLE_T
name|handle
parameter_list|,
name|VCHI_MEM_HANDLE_T
name|memhandle
parameter_list|,
name|void
modifier|*
name|offset
parameter_list|,
name|int
name|size
parameter_list|,
name|void
modifier|*
name|userdata
parameter_list|,
name|VCHIQ_BULK_MODE_T
name|mode
parameter_list|,
name|VCHIQ_BULK_DIR_T
name|dir
parameter_list|)
block|{
name|VCHIQ_SERVICE_T
modifier|*
name|service
init|=
name|find_service_by_handle
argument_list|(
name|handle
argument_list|)
decl_stmt|;
name|VCHIQ_BULK_QUEUE_T
modifier|*
name|queue
decl_stmt|;
name|VCHIQ_BULK_T
modifier|*
name|bulk
decl_stmt|;
name|VCHIQ_STATE_T
modifier|*
name|state
decl_stmt|;
name|struct
name|bulk_waiter
modifier|*
name|bulk_waiter
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
name|dir_char
init|=
operator|(
name|dir
operator|==
name|VCHIQ_BULK_TRANSMIT
operator|)
condition|?
literal|'t'
else|:
literal|'r'
decl_stmt|;
specifier|const
name|int
name|dir_msgtype
init|=
operator|(
name|dir
operator|==
name|VCHIQ_BULK_TRANSMIT
operator|)
condition|?
name|VCHIQ_MSG_BULK_TX
else|:
name|VCHIQ_MSG_BULK_RX
decl_stmt|;
name|VCHIQ_STATUS_T
name|status
init|=
name|VCHIQ_ERROR
decl_stmt|;
if|if
condition|(
operator|!
name|service
operator|||
operator|(
name|service
operator|->
name|srvstate
operator|!=
name|VCHIQ_SRVSTATE_OPEN
operator|)
operator|||
operator|(
operator|(
name|memhandle
operator|==
name|VCHI_MEM_HANDLE_INVALID
operator|)
operator|&&
operator|(
name|offset
operator|==
name|NULL
operator|)
operator|)
operator|||
operator|(
name|vchiq_check_service
argument_list|(
name|service
argument_list|)
operator|!=
name|VCHIQ_SUCCESS
operator|)
condition|)
goto|goto
name|error_exit
goto|;
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|VCHIQ_BULK_MODE_NOCALLBACK
case|:
case|case
name|VCHIQ_BULK_MODE_CALLBACK
case|:
break|break;
case|case
name|VCHIQ_BULK_MODE_BLOCKING
case|:
name|bulk_waiter
operator|=
operator|(
expr|struct
name|bulk_waiter
operator|*
operator|)
name|userdata
expr_stmt|;
name|_sema_init
argument_list|(
operator|&
name|bulk_waiter
operator|->
name|event
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|bulk_waiter
operator|->
name|actual
operator|=
literal|0
expr_stmt|;
name|bulk_waiter
operator|->
name|bulk
operator|=
name|NULL
expr_stmt|;
break|break;
case|case
name|VCHIQ_BULK_MODE_WAITING
case|:
name|bulk_waiter
operator|=
operator|(
expr|struct
name|bulk_waiter
operator|*
operator|)
name|userdata
expr_stmt|;
name|bulk
operator|=
name|bulk_waiter
operator|->
name|bulk
expr_stmt|;
goto|goto
name|waiting
goto|;
default|default:
goto|goto
name|error_exit
goto|;
block|}
name|state
operator|=
name|service
operator|->
name|state
expr_stmt|;
name|queue
operator|=
operator|(
name|dir
operator|==
name|VCHIQ_BULK_TRANSMIT
operator|)
condition|?
operator|&
name|service
operator|->
name|bulk_tx
else|:
operator|&
name|service
operator|->
name|bulk_rx
expr_stmt|;
if|if
condition|(
name|lmutex_lock_interruptible
argument_list|(
operator|&
name|service
operator|->
name|bulk_mutex
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|status
operator|=
name|VCHIQ_RETRY
expr_stmt|;
goto|goto
name|error_exit
goto|;
block|}
if|if
condition|(
name|queue
operator|->
name|local_insert
operator|==
name|queue
operator|->
name|remove
operator|+
name|VCHIQ_NUM_SERVICE_BULKS
condition|)
block|{
name|VCHIQ_SERVICE_STATS_INC
argument_list|(
name|service
argument_list|,
name|bulk_stalls
argument_list|)
expr_stmt|;
do|do
block|{
name|lmutex_unlock
argument_list|(
operator|&
name|service
operator|->
name|bulk_mutex
argument_list|)
expr_stmt|;
if|if
condition|(
name|down_interruptible
argument_list|(
operator|&
name|service
operator|->
name|bulk_remove_event
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|status
operator|=
name|VCHIQ_RETRY
expr_stmt|;
goto|goto
name|error_exit
goto|;
block|}
if|if
condition|(
name|lmutex_lock_interruptible
argument_list|(
operator|&
name|service
operator|->
name|bulk_mutex
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|status
operator|=
name|VCHIQ_RETRY
expr_stmt|;
goto|goto
name|error_exit
goto|;
block|}
block|}
do|while
condition|(
name|queue
operator|->
name|local_insert
operator|==
name|queue
operator|->
name|remove
operator|+
name|VCHIQ_NUM_SERVICE_BULKS
condition|)
do|;
block|}
name|bulk
operator|=
operator|&
name|queue
operator|->
name|bulks
index|[
name|BULK_INDEX
argument_list|(
name|queue
operator|->
name|local_insert
argument_list|)
index|]
expr_stmt|;
name|bulk
operator|->
name|mode
operator|=
name|mode
expr_stmt|;
name|bulk
operator|->
name|dir
operator|=
name|dir
expr_stmt|;
name|bulk
operator|->
name|userdata
operator|=
name|userdata
expr_stmt|;
name|bulk
operator|->
name|size
operator|=
name|size
expr_stmt|;
name|bulk
operator|->
name|actual
operator|=
name|VCHIQ_BULK_ACTUAL_ABORTED
expr_stmt|;
if|if
condition|(
name|vchiq_prepare_bulk_data
argument_list|(
name|bulk
argument_list|,
name|memhandle
argument_list|,
name|offset
argument_list|,
name|size
argument_list|,
name|dir
argument_list|)
operator|!=
name|VCHIQ_SUCCESS
condition|)
goto|goto
name|unlock_error_exit
goto|;
name|wmb
argument_list|()
expr_stmt|;
name|vchiq_log_info
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: bt (%d->%d) %cx %x@%x %x"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|service
operator|->
name|localport
argument_list|,
name|service
operator|->
name|remoteport
argument_list|,
name|dir_char
argument_list|,
name|size
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|bulk
operator|->
name|data
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|userdata
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|->
name|is_master
condition|)
block|{
name|queue
operator|->
name|local_insert
operator|++
expr_stmt|;
if|if
condition|(
name|resolve_bulks
argument_list|(
name|service
argument_list|,
name|queue
argument_list|)
condition|)
name|request_poll
argument_list|(
name|state
argument_list|,
name|service
argument_list|,
operator|(
name|dir
operator|==
name|VCHIQ_BULK_TRANSMIT
operator|)
condition|?
name|VCHIQ_POLL_TXNOTIFY
else|:
name|VCHIQ_POLL_RXNOTIFY
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|payload
index|[
literal|2
index|]
init|=
block|{
operator|(
name|int
operator|)
name|bulk
operator|->
name|data
block|,
name|bulk
operator|->
name|size
block|}
decl_stmt|;
name|VCHIQ_ELEMENT_T
name|element
init|=
block|{
name|payload
block|,
expr|sizeof
operator|(
name|payload
operator|)
block|}
decl_stmt|;
name|status
operator|=
name|queue_message
argument_list|(
name|state
argument_list|,
name|NULL
argument_list|,
name|VCHIQ_MAKE_MSG
argument_list|(
name|dir_msgtype
argument_list|,
name|service
operator|->
name|localport
argument_list|,
name|service
operator|->
name|remoteport
argument_list|)
argument_list|,
operator|&
name|element
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|payload
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|VCHIQ_SUCCESS
condition|)
block|{
name|vchiq_complete_bulk
argument_list|(
name|bulk
argument_list|)
expr_stmt|;
goto|goto
name|unlock_error_exit
goto|;
block|}
name|queue
operator|->
name|local_insert
operator|++
expr_stmt|;
block|}
name|lmutex_unlock
argument_list|(
operator|&
name|service
operator|->
name|bulk_mutex
argument_list|)
expr_stmt|;
name|vchiq_log_trace
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"%d: bt:%d %cx li=%x ri=%x p=%x"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|service
operator|->
name|localport
argument_list|,
name|dir_char
argument_list|,
name|queue
operator|->
name|local_insert
argument_list|,
name|queue
operator|->
name|remote_insert
argument_list|,
name|queue
operator|->
name|process
argument_list|)
expr_stmt|;
name|waiting
label|:
name|unlock_service
argument_list|(
name|service
argument_list|)
expr_stmt|;
name|status
operator|=
name|VCHIQ_SUCCESS
expr_stmt|;
if|if
condition|(
name|bulk_waiter
condition|)
block|{
name|bulk_waiter
operator|->
name|bulk
operator|=
name|bulk
expr_stmt|;
if|if
condition|(
name|down_interruptible
argument_list|(
operator|&
name|bulk_waiter
operator|->
name|event
argument_list|)
operator|!=
literal|0
condition|)
name|status
operator|=
name|VCHIQ_RETRY
expr_stmt|;
elseif|else
if|if
condition|(
name|bulk_waiter
operator|->
name|actual
operator|==
name|VCHIQ_BULK_ACTUAL_ABORTED
condition|)
name|status
operator|=
name|VCHIQ_ERROR
expr_stmt|;
block|}
return|return
name|status
return|;
name|unlock_error_exit
label|:
name|lmutex_unlock
argument_list|(
operator|&
name|service
operator|->
name|bulk_mutex
argument_list|)
expr_stmt|;
name|error_exit
label|:
if|if
condition|(
name|service
condition|)
name|unlock_service
argument_list|(
name|service
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|VCHIQ_STATUS_T
name|vchiq_queue_message
parameter_list|(
name|VCHIQ_SERVICE_HANDLE_T
name|handle
parameter_list|,
specifier|const
name|VCHIQ_ELEMENT_T
modifier|*
name|elements
parameter_list|,
name|unsigned
name|int
name|count
parameter_list|)
block|{
name|VCHIQ_SERVICE_T
modifier|*
name|service
init|=
name|find_service_by_handle
argument_list|(
name|handle
argument_list|)
decl_stmt|;
name|VCHIQ_STATUS_T
name|status
init|=
name|VCHIQ_ERROR
decl_stmt|;
name|unsigned
name|int
name|size
init|=
literal|0
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|service
operator|||
operator|(
name|vchiq_check_service
argument_list|(
name|service
argument_list|)
operator|!=
name|VCHIQ_SUCCESS
operator|)
condition|)
goto|goto
name|error_exit
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|unsigned
name|int
operator|)
name|count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|elements
index|[
name|i
index|]
operator|.
name|size
condition|)
block|{
if|if
condition|(
name|elements
index|[
name|i
index|]
operator|.
name|data
operator|==
name|NULL
condition|)
block|{
name|VCHIQ_SERVICE_STATS_INC
argument_list|(
name|service
argument_list|,
name|error_count
argument_list|)
expr_stmt|;
goto|goto
name|error_exit
goto|;
block|}
name|size
operator|+=
name|elements
index|[
name|i
index|]
operator|.
name|size
expr_stmt|;
block|}
block|}
if|if
condition|(
name|size
operator|>
name|VCHIQ_MAX_MSG_SIZE
condition|)
block|{
name|VCHIQ_SERVICE_STATS_INC
argument_list|(
name|service
argument_list|,
name|error_count
argument_list|)
expr_stmt|;
goto|goto
name|error_exit
goto|;
block|}
switch|switch
condition|(
name|service
operator|->
name|srvstate
condition|)
block|{
case|case
name|VCHIQ_SRVSTATE_OPEN
case|:
name|status
operator|=
name|queue_message
argument_list|(
name|service
operator|->
name|state
argument_list|,
name|service
argument_list|,
name|VCHIQ_MAKE_MSG
argument_list|(
name|VCHIQ_MSG_DATA
argument_list|,
name|service
operator|->
name|localport
argument_list|,
name|service
operator|->
name|remoteport
argument_list|)
argument_list|,
name|elements
argument_list|,
name|count
argument_list|,
name|size
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|VCHIQ_SRVSTATE_OPENSYNC
case|:
name|status
operator|=
name|queue_message_sync
argument_list|(
name|service
operator|->
name|state
argument_list|,
name|service
argument_list|,
name|VCHIQ_MAKE_MSG
argument_list|(
name|VCHIQ_MSG_DATA
argument_list|,
name|service
operator|->
name|localport
argument_list|,
name|service
operator|->
name|remoteport
argument_list|)
argument_list|,
name|elements
argument_list|,
name|count
argument_list|,
name|size
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
default|default:
name|status
operator|=
name|VCHIQ_ERROR
expr_stmt|;
break|break;
block|}
name|error_exit
label|:
if|if
condition|(
name|service
condition|)
name|unlock_service
argument_list|(
name|service
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|void
name|vchiq_release_message
parameter_list|(
name|VCHIQ_SERVICE_HANDLE_T
name|handle
parameter_list|,
name|VCHIQ_HEADER_T
modifier|*
name|header
parameter_list|)
block|{
name|VCHIQ_SERVICE_T
modifier|*
name|service
init|=
name|find_service_by_handle
argument_list|(
name|handle
argument_list|)
decl_stmt|;
name|VCHIQ_SHARED_STATE_T
modifier|*
name|remote
decl_stmt|;
name|VCHIQ_STATE_T
modifier|*
name|state
decl_stmt|;
name|int
name|slot_index
decl_stmt|;
if|if
condition|(
operator|!
name|service
condition|)
return|return;
name|state
operator|=
name|service
operator|->
name|state
expr_stmt|;
name|remote
operator|=
name|state
operator|->
name|remote
expr_stmt|;
name|slot_index
operator|=
name|SLOT_INDEX_FROM_DATA
argument_list|(
name|state
argument_list|,
operator|(
name|void
operator|*
operator|)
name|header
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|slot_index
operator|>=
name|remote
operator|->
name|slot_first
operator|)
operator|&&
operator|(
name|slot_index
operator|<=
name|remote
operator|->
name|slot_last
operator|)
condition|)
block|{
name|int
name|msgid
init|=
name|header
operator|->
name|msgid
decl_stmt|;
if|if
condition|(
name|msgid
operator|&
name|VCHIQ_MSGID_CLAIMED
condition|)
block|{
name|VCHIQ_SLOT_INFO_T
modifier|*
name|slot_info
init|=
name|SLOT_INFO_FROM_INDEX
argument_list|(
name|state
argument_list|,
name|slot_index
argument_list|)
decl_stmt|;
name|release_slot
argument_list|(
name|state
argument_list|,
name|slot_info
argument_list|,
name|header
argument_list|,
name|service
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|slot_index
operator|==
name|remote
operator|->
name|slot_sync
condition|)
name|release_message_sync
argument_list|(
name|state
argument_list|,
name|header
argument_list|)
expr_stmt|;
name|unlock_service
argument_list|(
name|service
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|release_message_sync
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|,
name|VCHIQ_HEADER_T
modifier|*
name|header
parameter_list|)
block|{
name|header
operator|->
name|msgid
operator|=
name|VCHIQ_MSGID_PADDING
expr_stmt|;
name|wmb
argument_list|()
expr_stmt|;
name|remote_event_signal
argument_list|(
operator|&
name|state
operator|->
name|remote
operator|->
name|sync_release
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|VCHIQ_STATUS_T
name|vchiq_get_peer_version
parameter_list|(
name|VCHIQ_SERVICE_HANDLE_T
name|handle
parameter_list|,
name|short
modifier|*
name|peer_version
parameter_list|)
block|{
name|VCHIQ_STATUS_T
name|status
init|=
name|VCHIQ_ERROR
decl_stmt|;
name|VCHIQ_SERVICE_T
modifier|*
name|service
init|=
name|find_service_by_handle
argument_list|(
name|handle
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|service
operator|||
operator|(
name|vchiq_check_service
argument_list|(
name|service
argument_list|)
operator|!=
name|VCHIQ_SUCCESS
operator|)
operator|||
operator|!
name|peer_version
condition|)
goto|goto
name|exit
goto|;
operator|*
name|peer_version
operator|=
name|service
operator|->
name|peer_version
expr_stmt|;
name|status
operator|=
name|VCHIQ_SUCCESS
expr_stmt|;
name|exit
label|:
if|if
condition|(
name|service
condition|)
name|unlock_service
argument_list|(
name|service
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|VCHIQ_STATUS_T
name|vchiq_get_config
parameter_list|(
name|VCHIQ_INSTANCE_T
name|instance
parameter_list|,
name|int
name|config_size
parameter_list|,
name|VCHIQ_CONFIG_T
modifier|*
name|pconfig
parameter_list|)
block|{
name|VCHIQ_CONFIG_T
name|config
decl_stmt|;
operator|(
name|void
operator|)
name|instance
expr_stmt|;
name|config
operator|.
name|max_msg_size
operator|=
name|VCHIQ_MAX_MSG_SIZE
expr_stmt|;
name|config
operator|.
name|bulk_threshold
operator|=
name|VCHIQ_MAX_MSG_SIZE
expr_stmt|;
name|config
operator|.
name|max_outstanding_bulks
operator|=
name|VCHIQ_NUM_SERVICE_BULKS
expr_stmt|;
name|config
operator|.
name|max_services
operator|=
name|VCHIQ_MAX_SERVICES
expr_stmt|;
name|config
operator|.
name|version
operator|=
name|VCHIQ_VERSION
expr_stmt|;
name|config
operator|.
name|version_min
operator|=
name|VCHIQ_VERSION_MIN
expr_stmt|;
if|if
condition|(
name|config_size
operator|>
sizeof|sizeof
argument_list|(
name|VCHIQ_CONFIG_T
argument_list|)
condition|)
return|return
name|VCHIQ_ERROR
return|;
name|memcpy
argument_list|(
name|pconfig
argument_list|,
operator|&
name|config
argument_list|,
name|min
argument_list|(
name|config_size
argument_list|,
call|(
name|int
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|VCHIQ_CONFIG_T
argument_list|)
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|VCHIQ_SUCCESS
return|;
block|}
end_function

begin_function
name|VCHIQ_STATUS_T
name|vchiq_set_service_option
parameter_list|(
name|VCHIQ_SERVICE_HANDLE_T
name|handle
parameter_list|,
name|VCHIQ_SERVICE_OPTION_T
name|option
parameter_list|,
name|int
name|value
parameter_list|)
block|{
name|VCHIQ_SERVICE_T
modifier|*
name|service
init|=
name|find_service_by_handle
argument_list|(
name|handle
argument_list|)
decl_stmt|;
name|VCHIQ_STATUS_T
name|status
init|=
name|VCHIQ_ERROR
decl_stmt|;
if|if
condition|(
name|service
condition|)
block|{
switch|switch
condition|(
name|option
condition|)
block|{
case|case
name|VCHIQ_SERVICE_OPTION_AUTOCLOSE
case|:
name|service
operator|->
name|auto_close
operator|=
name|value
expr_stmt|;
name|status
operator|=
name|VCHIQ_SUCCESS
expr_stmt|;
break|break;
case|case
name|VCHIQ_SERVICE_OPTION_SLOT_QUOTA
case|:
block|{
name|VCHIQ_SERVICE_QUOTA_T
modifier|*
name|service_quota
init|=
operator|&
name|service
operator|->
name|state
operator|->
name|service_quotas
index|[
name|service
operator|->
name|localport
index|]
decl_stmt|;
if|if
condition|(
name|value
operator|==
literal|0
condition|)
name|value
operator|=
name|service
operator|->
name|state
operator|->
name|default_slot_quota
expr_stmt|;
if|if
condition|(
operator|(
name|value
operator|>=
name|service_quota
operator|->
name|slot_use_count
operator|)
operator|&&
operator|(
name|value
operator|<
operator|(
name|unsigned
name|short
operator|)
operator|~
literal|0
operator|)
condition|)
block|{
name|service_quota
operator|->
name|slot_quota
operator|=
name|value
expr_stmt|;
if|if
condition|(
operator|(
name|value
operator|>=
name|service_quota
operator|->
name|slot_use_count
operator|)
operator|&&
operator|(
name|service_quota
operator|->
name|message_quota
operator|>=
name|service_quota
operator|->
name|message_use_count
operator|)
condition|)
block|{
comment|/* Signal the service that it may have 					** dropped below its quota */
name|up
argument_list|(
operator|&
name|service_quota
operator|->
name|quota_event
argument_list|)
expr_stmt|;
block|}
name|status
operator|=
name|VCHIQ_SUCCESS
expr_stmt|;
block|}
block|}
break|break;
case|case
name|VCHIQ_SERVICE_OPTION_MESSAGE_QUOTA
case|:
block|{
name|VCHIQ_SERVICE_QUOTA_T
modifier|*
name|service_quota
init|=
operator|&
name|service
operator|->
name|state
operator|->
name|service_quotas
index|[
name|service
operator|->
name|localport
index|]
decl_stmt|;
if|if
condition|(
name|value
operator|==
literal|0
condition|)
name|value
operator|=
name|service
operator|->
name|state
operator|->
name|default_message_quota
expr_stmt|;
if|if
condition|(
operator|(
name|value
operator|>=
name|service_quota
operator|->
name|message_use_count
operator|)
operator|&&
operator|(
name|value
operator|<
operator|(
name|unsigned
name|short
operator|)
operator|~
literal|0
operator|)
condition|)
block|{
name|service_quota
operator|->
name|message_quota
operator|=
name|value
expr_stmt|;
if|if
condition|(
operator|(
name|value
operator|>=
name|service_quota
operator|->
name|message_use_count
operator|)
operator|&&
operator|(
name|service_quota
operator|->
name|slot_quota
operator|>=
name|service_quota
operator|->
name|slot_use_count
operator|)
condition|)
comment|/* Signal the service that it may have 					** dropped below its quota */
name|up
argument_list|(
operator|&
name|service_quota
operator|->
name|quota_event
argument_list|)
expr_stmt|;
name|status
operator|=
name|VCHIQ_SUCCESS
expr_stmt|;
block|}
block|}
break|break;
case|case
name|VCHIQ_SERVICE_OPTION_SYNCHRONOUS
case|:
if|if
condition|(
operator|(
name|service
operator|->
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_HIDDEN
operator|)
operator|||
operator|(
name|service
operator|->
name|srvstate
operator|==
name|VCHIQ_SRVSTATE_LISTENING
operator|)
condition|)
block|{
name|service
operator|->
name|sync
operator|=
name|value
expr_stmt|;
name|status
operator|=
name|VCHIQ_SUCCESS
expr_stmt|;
block|}
break|break;
default|default:
break|break;
block|}
name|unlock_service
argument_list|(
name|service
argument_list|)
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|vchiq_dump_shared_state
parameter_list|(
name|void
modifier|*
name|dump_context
parameter_list|,
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|,
name|VCHIQ_SHARED_STATE_T
modifier|*
name|shared
parameter_list|,
specifier|const
name|char
modifier|*
name|label
parameter_list|)
block|{
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|debug_names
index|[]
init|=
block|{
literal|"<entries>"
block|,
literal|"SLOT_HANDLER_COUNT"
block|,
literal|"SLOT_HANDLER_LINE"
block|,
literal|"PARSE_LINE"
block|,
literal|"PARSE_HEADER"
block|,
literal|"PARSE_MSGID"
block|,
literal|"AWAIT_COMPLETION_LINE"
block|,
literal|"DEQUEUE_MESSAGE_LINE"
block|,
literal|"SERVICE_CALLBACK_LINE"
block|,
literal|"MSG_QUEUE_FULL_COUNT"
block|,
literal|"COMPLETION_QUEUE_FULL_COUNT"
block|}
decl_stmt|;
name|int
name|i
decl_stmt|;
name|char
name|buf
index|[
literal|80
index|]
decl_stmt|;
name|int
name|len
decl_stmt|;
name|len
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"  %s: slots %d-%d tx_pos=%x recycle=%x"
argument_list|,
name|label
argument_list|,
name|shared
operator|->
name|slot_first
argument_list|,
name|shared
operator|->
name|slot_last
argument_list|,
name|shared
operator|->
name|tx_pos
argument_list|,
name|shared
operator|->
name|slot_queue_recycle
argument_list|)
expr_stmt|;
name|vchiq_dump
argument_list|(
name|dump_context
argument_list|,
name|buf
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|len
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"    Slots claimed:"
argument_list|)
expr_stmt|;
name|vchiq_dump
argument_list|(
name|dump_context
argument_list|,
name|buf
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|shared
operator|->
name|slot_first
init|;
name|i
operator|<=
name|shared
operator|->
name|slot_last
condition|;
name|i
operator|++
control|)
block|{
name|VCHIQ_SLOT_INFO_T
name|slot_info
init|=
operator|*
name|SLOT_INFO_FROM_INDEX
argument_list|(
name|state
argument_list|,
name|i
argument_list|)
decl_stmt|;
if|if
condition|(
name|slot_info
operator|.
name|use_count
operator|!=
name|slot_info
operator|.
name|release_count
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"      %d: %d/%d"
argument_list|,
name|i
argument_list|,
name|slot_info
operator|.
name|use_count
argument_list|,
name|slot_info
operator|.
name|release_count
argument_list|)
expr_stmt|;
name|vchiq_dump
argument_list|(
name|dump_context
argument_list|,
name|buf
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|shared
operator|->
name|debug
index|[
name|DEBUG_ENTRIES
index|]
condition|;
name|i
operator|++
control|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"    DEBUG: %s = %d(%x)"
argument_list|,
name|debug_names
index|[
name|i
index|]
argument_list|,
name|shared
operator|->
name|debug
index|[
name|i
index|]
argument_list|,
name|shared
operator|->
name|debug
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|vchiq_dump
argument_list|(
name|dump_context
argument_list|,
name|buf
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|vchiq_dump_state
parameter_list|(
name|void
modifier|*
name|dump_context
parameter_list|,
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|)
block|{
name|char
name|buf
index|[
literal|80
index|]
decl_stmt|;
name|int
name|len
decl_stmt|;
name|int
name|i
decl_stmt|;
name|len
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"State %d: %s"
argument_list|,
name|state
operator|->
name|id
argument_list|,
name|conn_state_names
index|[
name|state
operator|->
name|conn_state
index|]
argument_list|)
expr_stmt|;
name|vchiq_dump
argument_list|(
name|dump_context
argument_list|,
name|buf
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|len
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"  tx_pos=%x(@%x), rx_pos=%x(@%x)"
argument_list|,
name|state
operator|->
name|local
operator|->
name|tx_pos
argument_list|,
operator|(
name|uint32_t
operator|)
name|state
operator|->
name|tx_data
operator|+
operator|(
name|state
operator|->
name|local_tx_pos
operator|&
name|VCHIQ_SLOT_MASK
operator|)
argument_list|,
name|state
operator|->
name|rx_pos
argument_list|,
operator|(
name|uint32_t
operator|)
name|state
operator|->
name|rx_data
operator|+
operator|(
name|state
operator|->
name|rx_pos
operator|&
name|VCHIQ_SLOT_MASK
operator|)
argument_list|)
expr_stmt|;
name|vchiq_dump
argument_list|(
name|dump_context
argument_list|,
name|buf
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|len
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"  Version: %d (min %d)"
argument_list|,
name|VCHIQ_VERSION
argument_list|,
name|VCHIQ_VERSION_MIN
argument_list|)
expr_stmt|;
name|vchiq_dump
argument_list|(
name|dump_context
argument_list|,
name|buf
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|VCHIQ_ENABLE_STATS
condition|)
block|{
name|len
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"  Stats: ctrl_tx_count=%d, ctrl_rx_count=%d, "
literal|"error_count=%d"
argument_list|,
name|state
operator|->
name|stats
operator|.
name|ctrl_tx_count
argument_list|,
name|state
operator|->
name|stats
operator|.
name|ctrl_rx_count
argument_list|,
name|state
operator|->
name|stats
operator|.
name|error_count
argument_list|)
expr_stmt|;
name|vchiq_dump
argument_list|(
name|dump_context
argument_list|,
name|buf
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
name|len
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"  Slots: %d available (%d data), %d recyclable, %d stalls "
literal|"(%d data)"
argument_list|,
operator|(
operator|(
name|state
operator|->
name|slot_queue_available
operator|*
name|VCHIQ_SLOT_SIZE
operator|)
operator|-
name|state
operator|->
name|local_tx_pos
operator|)
operator|/
name|VCHIQ_SLOT_SIZE
argument_list|,
name|state
operator|->
name|data_quota
operator|-
name|state
operator|->
name|data_use_count
argument_list|,
name|state
operator|->
name|local
operator|->
name|slot_queue_recycle
operator|-
name|state
operator|->
name|slot_queue_available
argument_list|,
name|state
operator|->
name|stats
operator|.
name|slot_stalls
argument_list|,
name|state
operator|->
name|stats
operator|.
name|data_stalls
argument_list|)
expr_stmt|;
name|vchiq_dump
argument_list|(
name|dump_context
argument_list|,
name|buf
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|vchiq_dump_platform_state
argument_list|(
name|dump_context
argument_list|)
expr_stmt|;
name|vchiq_dump_shared_state
argument_list|(
name|dump_context
argument_list|,
name|state
argument_list|,
name|state
operator|->
name|local
argument_list|,
literal|"Local"
argument_list|)
expr_stmt|;
name|vchiq_dump_shared_state
argument_list|(
name|dump_context
argument_list|,
name|state
argument_list|,
name|state
operator|->
name|remote
argument_list|,
literal|"Remote"
argument_list|)
expr_stmt|;
name|vchiq_dump_platform_instances
argument_list|(
name|dump_context
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|state
operator|->
name|unused_service
condition|;
name|i
operator|++
control|)
block|{
name|VCHIQ_SERVICE_T
modifier|*
name|service
init|=
name|find_service_by_port
argument_list|(
name|state
argument_list|,
name|i
argument_list|)
decl_stmt|;
if|if
condition|(
name|service
condition|)
block|{
name|vchiq_dump_service_state
argument_list|(
name|dump_context
argument_list|,
name|service
argument_list|)
expr_stmt|;
name|unlock_service
argument_list|(
name|service
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|vchiq_dump_service_state
parameter_list|(
name|void
modifier|*
name|dump_context
parameter_list|,
name|VCHIQ_SERVICE_T
modifier|*
name|service
parameter_list|)
block|{
name|char
name|buf
index|[
literal|120
index|]
decl_stmt|;
name|int
name|len
decl_stmt|;
name|len
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"Service %d: %s (ref %u)"
argument_list|,
name|service
operator|->
name|localport
argument_list|,
name|srvstate_names
index|[
name|service
operator|->
name|srvstate
index|]
argument_list|,
name|service
operator|->
name|ref_count
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/*Don't include the lock just taken*/
if|if
condition|(
name|service
operator|->
name|srvstate
operator|!=
name|VCHIQ_SRVSTATE_FREE
condition|)
block|{
name|char
name|remoteport
index|[
literal|30
index|]
decl_stmt|;
name|VCHIQ_SERVICE_QUOTA_T
modifier|*
name|service_quota
init|=
operator|&
name|service
operator|->
name|state
operator|->
name|service_quotas
index|[
name|service
operator|->
name|localport
index|]
decl_stmt|;
name|int
name|fourcc
init|=
name|service
operator|->
name|base
operator|.
name|fourcc
decl_stmt|;
name|int
name|tx_pending
decl_stmt|,
name|rx_pending
decl_stmt|;
if|if
condition|(
name|service
operator|->
name|remoteport
operator|!=
name|VCHIQ_PORT_FREE
condition|)
block|{
name|int
name|len2
init|=
name|snprintf
argument_list|(
name|remoteport
argument_list|,
sizeof|sizeof
argument_list|(
name|remoteport
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|service
operator|->
name|remoteport
argument_list|)
decl_stmt|;
if|if
condition|(
name|service
operator|->
name|public_fourcc
operator|!=
name|VCHIQ_FOURCC_INVALID
condition|)
name|snprintf
argument_list|(
name|remoteport
operator|+
name|len2
argument_list|,
sizeof|sizeof
argument_list|(
name|remoteport
argument_list|)
operator|-
name|len2
argument_list|,
literal|" (client %8x)"
argument_list|,
name|service
operator|->
name|client_id
argument_list|)
expr_stmt|;
block|}
else|else
name|strcpy
argument_list|(
name|remoteport
argument_list|,
literal|"n/a"
argument_list|)
expr_stmt|;
name|len
operator|+=
name|snprintf
argument_list|(
name|buf
operator|+
name|len
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
name|len
argument_list|,
literal|" '%c%c%c%c' remote %s (msg use %d/%d, slot use %d/%d)"
argument_list|,
name|VCHIQ_FOURCC_AS_4CHARS
argument_list|(
name|fourcc
argument_list|)
argument_list|,
name|remoteport
argument_list|,
name|service_quota
operator|->
name|message_use_count
argument_list|,
name|service_quota
operator|->
name|message_quota
argument_list|,
name|service_quota
operator|->
name|slot_use_count
argument_list|,
name|service_quota
operator|->
name|slot_quota
argument_list|)
expr_stmt|;
name|vchiq_dump
argument_list|(
name|dump_context
argument_list|,
name|buf
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|tx_pending
operator|=
name|service
operator|->
name|bulk_tx
operator|.
name|local_insert
operator|-
name|service
operator|->
name|bulk_tx
operator|.
name|remote_insert
expr_stmt|;
name|rx_pending
operator|=
name|service
operator|->
name|bulk_rx
operator|.
name|local_insert
operator|-
name|service
operator|->
name|bulk_rx
operator|.
name|remote_insert
expr_stmt|;
name|len
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"  Bulk: tx_pending=%d (size %d),"
literal|" rx_pending=%d (size %d)"
argument_list|,
name|tx_pending
argument_list|,
name|tx_pending
condition|?
name|service
operator|->
name|bulk_tx
operator|.
name|bulks
index|[
name|BULK_INDEX
argument_list|(
name|service
operator|->
name|bulk_tx
operator|.
name|remove
argument_list|)
index|]
operator|.
name|size
else|:
literal|0
argument_list|,
name|rx_pending
argument_list|,
name|rx_pending
condition|?
name|service
operator|->
name|bulk_rx
operator|.
name|bulks
index|[
name|BULK_INDEX
argument_list|(
name|service
operator|->
name|bulk_rx
operator|.
name|remove
argument_list|)
index|]
operator|.
name|size
else|:
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|VCHIQ_ENABLE_STATS
condition|)
block|{
name|vchiq_dump
argument_list|(
name|dump_context
argument_list|,
name|buf
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|len
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"  Ctrl: tx_count=%d, tx_bytes=%llu, "
literal|"rx_count=%d, rx_bytes=%llu"
argument_list|,
name|service
operator|->
name|stats
operator|.
name|ctrl_tx_count
argument_list|,
name|service
operator|->
name|stats
operator|.
name|ctrl_tx_bytes
argument_list|,
name|service
operator|->
name|stats
operator|.
name|ctrl_rx_count
argument_list|,
name|service
operator|->
name|stats
operator|.
name|ctrl_rx_bytes
argument_list|)
expr_stmt|;
name|vchiq_dump
argument_list|(
name|dump_context
argument_list|,
name|buf
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|len
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"  Bulk: tx_count=%d, tx_bytes=%llu, "
literal|"rx_count=%d, rx_bytes=%llu"
argument_list|,
name|service
operator|->
name|stats
operator|.
name|bulk_tx_count
argument_list|,
name|service
operator|->
name|stats
operator|.
name|bulk_tx_bytes
argument_list|,
name|service
operator|->
name|stats
operator|.
name|bulk_rx_count
argument_list|,
name|service
operator|->
name|stats
operator|.
name|bulk_rx_bytes
argument_list|)
expr_stmt|;
name|vchiq_dump
argument_list|(
name|dump_context
argument_list|,
name|buf
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|len
operator|=
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"  %d quota stalls, %d slot stalls, "
literal|"%d bulk stalls, %d aborted, %d errors"
argument_list|,
name|service
operator|->
name|stats
operator|.
name|quota_stalls
argument_list|,
name|service
operator|->
name|stats
operator|.
name|slot_stalls
argument_list|,
name|service
operator|->
name|stats
operator|.
name|bulk_stalls
argument_list|,
name|service
operator|->
name|stats
operator|.
name|bulk_aborted_count
argument_list|,
name|service
operator|->
name|stats
operator|.
name|error_count
argument_list|)
expr_stmt|;
block|}
block|}
name|vchiq_dump
argument_list|(
name|dump_context
argument_list|,
name|buf
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|service
operator|->
name|srvstate
operator|!=
name|VCHIQ_SRVSTATE_FREE
condition|)
name|vchiq_dump_platform_service_state
argument_list|(
name|dump_context
argument_list|,
name|service
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|vchiq_loud_error_header
parameter_list|(
name|void
parameter_list|)
block|{
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"============================================================"
literal|"================"
argument_list|)
expr_stmt|;
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"============================================================"
literal|"================"
argument_list|)
expr_stmt|;
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"====="
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|vchiq_loud_error_footer
parameter_list|(
name|void
parameter_list|)
block|{
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"====="
argument_list|)
expr_stmt|;
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"============================================================"
literal|"================"
argument_list|)
expr_stmt|;
name|vchiq_log_error
argument_list|(
name|vchiq_core_log_level
argument_list|,
literal|"============================================================"
literal|"================"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|VCHIQ_STATUS_T
name|vchiq_send_remote_use
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|)
block|{
name|VCHIQ_STATUS_T
name|status
init|=
name|VCHIQ_RETRY
decl_stmt|;
if|if
condition|(
name|state
operator|->
name|conn_state
operator|!=
name|VCHIQ_CONNSTATE_DISCONNECTED
condition|)
name|status
operator|=
name|queue_message
argument_list|(
name|state
argument_list|,
name|NULL
argument_list|,
name|VCHIQ_MAKE_MSG
argument_list|(
name|VCHIQ_MSG_REMOTE_USE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|VCHIQ_STATUS_T
name|vchiq_send_remote_release
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|)
block|{
name|VCHIQ_STATUS_T
name|status
init|=
name|VCHIQ_RETRY
decl_stmt|;
if|if
condition|(
name|state
operator|->
name|conn_state
operator|!=
name|VCHIQ_CONNSTATE_DISCONNECTED
condition|)
name|status
operator|=
name|queue_message
argument_list|(
name|state
argument_list|,
name|NULL
argument_list|,
name|VCHIQ_MAKE_MSG
argument_list|(
name|VCHIQ_MSG_REMOTE_RELEASE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|VCHIQ_STATUS_T
name|vchiq_send_remote_use_active
parameter_list|(
name|VCHIQ_STATE_T
modifier|*
name|state
parameter_list|)
block|{
name|VCHIQ_STATUS_T
name|status
init|=
name|VCHIQ_RETRY
decl_stmt|;
if|if
condition|(
name|state
operator|->
name|conn_state
operator|!=
name|VCHIQ_CONNSTATE_DISCONNECTED
condition|)
name|status
operator|=
name|queue_message
argument_list|(
name|state
argument_list|,
name|NULL
argument_list|,
name|VCHIQ_MAKE_MSG
argument_list|(
name|VCHIQ_MSG_REMOTE_USE_ACTIVE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|void
name|vchiq_log_dump_mem
parameter_list|(
specifier|const
name|char
modifier|*
name|label
parameter_list|,
name|uint32_t
name|addr
parameter_list|,
specifier|const
name|void
modifier|*
name|voidMem
parameter_list|,
name|size_t
name|numBytes
parameter_list|)
block|{
specifier|const
name|uint8_t
modifier|*
name|mem
init|=
operator|(
specifier|const
name|uint8_t
operator|*
operator|)
name|voidMem
decl_stmt|;
name|size_t
name|offset
decl_stmt|;
name|char
name|lineBuf
index|[
literal|100
index|]
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
while|while
condition|(
name|numBytes
operator|>
literal|0
condition|)
block|{
name|s
operator|=
name|lineBuf
expr_stmt|;
for|for
control|(
name|offset
operator|=
literal|0
init|;
name|offset
operator|<
literal|16
condition|;
name|offset
operator|++
control|)
block|{
if|if
condition|(
name|offset
operator|<
name|numBytes
condition|)
name|s
operator|+=
name|snprintf
argument_list|(
name|s
argument_list|,
literal|4
argument_list|,
literal|"%02x "
argument_list|,
name|mem
index|[
name|offset
index|]
argument_list|)
expr_stmt|;
else|else
name|s
operator|+=
name|snprintf
argument_list|(
name|s
argument_list|,
literal|4
argument_list|,
literal|"   "
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|offset
operator|=
literal|0
init|;
name|offset
operator|<
literal|16
condition|;
name|offset
operator|++
control|)
block|{
if|if
condition|(
name|offset
operator|<
name|numBytes
condition|)
block|{
name|uint8_t
name|ch
init|=
name|mem
index|[
name|offset
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|ch
operator|<
literal|' '
operator|)
operator|||
operator|(
name|ch
operator|>
literal|'~'
operator|)
condition|)
name|ch
operator|=
literal|'.'
expr_stmt|;
operator|*
name|s
operator|++
operator|=
operator|(
name|char
operator|)
name|ch
expr_stmt|;
block|}
block|}
operator|*
name|s
operator|++
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|(
name|label
operator|!=
name|NULL
operator|)
operator|&&
operator|(
operator|*
name|label
operator|!=
literal|'\0'
operator|)
condition|)
name|vchiq_log_trace
argument_list|(
name|VCHIQ_LOG_TRACE
argument_list|,
literal|"%s: %08x: %s"
argument_list|,
name|label
argument_list|,
name|addr
argument_list|,
name|lineBuf
argument_list|)
expr_stmt|;
else|else
name|vchiq_log_trace
argument_list|(
name|VCHIQ_LOG_TRACE
argument_list|,
literal|"%08x: %s"
argument_list|,
name|addr
argument_list|,
name|lineBuf
argument_list|)
expr_stmt|;
name|addr
operator|+=
literal|16
expr_stmt|;
name|mem
operator|+=
literal|16
expr_stmt|;
if|if
condition|(
name|numBytes
operator|>
literal|16
condition|)
name|numBytes
operator|-=
literal|16
expr_stmt|;
else|else
name|numBytes
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

end_unit


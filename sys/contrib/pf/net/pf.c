begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*	$FreeBSD$	*/
end_comment

begin_comment
comment|/*	$OpenBSD: pf.c,v 1.483 2005/03/15 17:38:43 dhartmei Exp $ */
end_comment

begin_comment
comment|/*  * Copyright (c) 2001 Daniel Hartmeier  * Copyright (c) 2002,2003 Henning Brauer  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *  *    - Redistributions of source code must retain the above copyright  *      notice, this list of conditions and the following disclaimer.  *    - Redistributions in binary form must reproduce the above  *      copyright notice, this list of conditions and the following  *      disclaimer in the documentation and/or other materials provided  *      with the distribution.  *  * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS  * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE  * COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,  * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;  * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER  * CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN  * ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE  * POSSIBILITY OF SUCH DAMAGE.  *  * Effort sponsored in part by the Defense Advanced Research Projects  * Agency (DARPA) and Air Force Research Laboratory, Air Force  * Materiel Command, USAF, under agreement number F30602-01-2-0537.  *  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_include
include|#
directive|include
file|"opt_inet.h"
end_include

begin_include
include|#
directive|include
file|"opt_inet6.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_include
include|#
directive|include
file|"opt_bpf.h"
end_include

begin_include
include|#
directive|include
file|"opt_pf.h"
end_include

begin_define
define|#
directive|define
name|NBPFILTER
value|DEV_BPF
end_define

begin_define
define|#
directive|define
name|NPFLOG
value|DEV_PFLOG
end_define

begin_define
define|#
directive|define
name|NPFSYNC
value|DEV_PFSYNC
end_define

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|"bpfilter.h"
end_include

begin_include
include|#
directive|include
file|"pflog.h"
end_include

begin_include
include|#
directive|include
file|"pfsync.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/filio.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/socketvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<sys/pool.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/bpf.h>
end_include

begin_include
include|#
directive|include
file|<net/route.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_systm.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp_seq.h>
end_include

begin_include
include|#
directive|include
file|<netinet/udp.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip_icmp.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_pcb.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp_timer.h>
end_include

begin_include
include|#
directive|include
file|<netinet/tcp_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/udp_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/icmp_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet/if_ether.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|__FreeBSD__
end_ifndef

begin_include
include|#
directive|include
file|<dev/rndvar.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<net/pfvar.h>
end_include

begin_include
include|#
directive|include
file|<net/if_pflog.h>
end_include

begin_if
if|#
directive|if
name|NPFSYNC
operator|>
literal|0
end_if

begin_include
include|#
directive|include
file|<net/if_pfsync.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NPFSYNC> 0 */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|INET6
end_ifdef

begin_include
include|#
directive|include
file|<netinet/ip6.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in_pcb.h>
end_include

begin_include
include|#
directive|include
file|<netinet/icmp6.h>
end_include

begin_include
include|#
directive|include
file|<netinet6/nd6.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_include
include|#
directive|include
file|<netinet6/ip6_var.h>
end_include

begin_include
include|#
directive|include
file|<netinet6/in6_pcb.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* INET6 */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_include
include|#
directive|include
file|<machine/in_cksum.h>
end_include

begin_include
include|#
directive|include
file|<sys/limits.h>
end_include

begin_include
include|#
directive|include
file|<sys/ucred.h>
end_include

begin_function_decl
specifier|extern
name|int
name|ip_optcopy
parameter_list|(
name|struct
name|ip
modifier|*
parameter_list|,
name|struct
name|ip
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|DPFPRINTF
parameter_list|(
name|n
parameter_list|,
name|x
parameter_list|)
value|if (pf_status.debug>= (n)) printf x
end_define

begin_comment
comment|/*  * Global variables  */
end_comment

begin_decl_stmt
name|struct
name|pf_anchor_global
name|pf_anchors
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|pf_ruleset
name|pf_main_ruleset
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|pf_altqqueue
name|pf_altqs
index|[
literal|2
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|pf_palist
name|pf_pabuf
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|pf_altqqueue
modifier|*
name|pf_altqs_active
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|pf_altqqueue
modifier|*
name|pf_altqs_inactive
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|pf_status
name|pf_status
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_int32_t
name|ticket_altqs_active
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_int32_t
name|ticket_altqs_inactive
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|altqs_inactive_open
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|u_int32_t
name|ticket_pabuf
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_decl_stmt
name|struct
name|callout
name|pf_expire_to
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* expire timeout */
end_comment

begin_else
else|#
directive|else
end_else

begin_decl_stmt
name|struct
name|timeout
name|pf_expire_to
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* expire timeout */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_struct
struct|struct
name|pf_anchor_stackframe
block|{
name|struct
name|pf_ruleset
modifier|*
name|rs
decl_stmt|;
name|struct
name|pf_rule
modifier|*
name|r
decl_stmt|;
name|struct
name|pf_anchor_node
modifier|*
name|parent
decl_stmt|;
name|struct
name|pf_anchor
modifier|*
name|child
decl_stmt|;
block|}
name|pf_anchor_stack
index|[
literal|64
index|]
struct|;
end_struct

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_decl_stmt
name|uma_zone_t
name|pf_src_tree_pl
decl_stmt|,
name|pf_rule_pl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|uma_zone_t
name|pf_state_pl
decl_stmt|,
name|pf_altq_pl
decl_stmt|,
name|pf_pooladdr_pl
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_decl_stmt
name|struct
name|pool
name|pf_src_tree_pl
decl_stmt|,
name|pf_rule_pl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|pool
name|pf_state_pl
decl_stmt|,
name|pf_altq_pl
decl_stmt|,
name|pf_pooladdr_pl
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
name|void
name|pf_print_host
parameter_list|(
name|struct
name|pf_addr
modifier|*
parameter_list|,
name|u_int16_t
parameter_list|,
name|u_int8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|pf_init_threshold
parameter_list|(
name|struct
name|pf_threshold
modifier|*
parameter_list|,
name|u_int32_t
parameter_list|,
name|u_int32_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|pf_add_threshold
parameter_list|(
name|struct
name|pf_threshold
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pf_check_threshold
parameter_list|(
name|struct
name|pf_threshold
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|pf_change_ap
parameter_list|(
name|struct
name|pf_addr
modifier|*
parameter_list|,
name|u_int16_t
modifier|*
parameter_list|,
name|u_int16_t
modifier|*
parameter_list|,
name|u_int16_t
modifier|*
parameter_list|,
name|struct
name|pf_addr
modifier|*
parameter_list|,
name|u_int16_t
parameter_list|,
name|u_int8_t
parameter_list|,
name|sa_family_t
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|INET6
end_ifdef

begin_function_decl
name|void
name|pf_change_a6
parameter_list|(
name|struct
name|pf_addr
modifier|*
parameter_list|,
name|u_int16_t
modifier|*
parameter_list|,
name|struct
name|pf_addr
modifier|*
parameter_list|,
name|u_int8_t
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* INET6 */
end_comment

begin_function_decl
name|void
name|pf_change_icmp
parameter_list|(
name|struct
name|pf_addr
modifier|*
parameter_list|,
name|u_int16_t
modifier|*
parameter_list|,
name|struct
name|pf_addr
modifier|*
parameter_list|,
name|struct
name|pf_addr
modifier|*
parameter_list|,
name|u_int16_t
parameter_list|,
name|u_int16_t
modifier|*
parameter_list|,
name|u_int16_t
modifier|*
parameter_list|,
name|u_int16_t
modifier|*
parameter_list|,
name|u_int16_t
modifier|*
parameter_list|,
name|u_int8_t
parameter_list|,
name|sa_family_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|pf_send_tcp
parameter_list|(
specifier|const
name|struct
name|pf_rule
modifier|*
parameter_list|,
name|sa_family_t
parameter_list|,
specifier|const
name|struct
name|pf_addr
modifier|*
parameter_list|,
specifier|const
name|struct
name|pf_addr
modifier|*
parameter_list|,
name|u_int16_t
parameter_list|,
name|u_int16_t
parameter_list|,
name|u_int32_t
parameter_list|,
name|u_int32_t
parameter_list|,
name|u_int8_t
parameter_list|,
name|u_int16_t
parameter_list|,
name|u_int16_t
parameter_list|,
name|u_int8_t
parameter_list|,
name|int
parameter_list|,
name|struct
name|ether_header
modifier|*
parameter_list|,
name|struct
name|ifnet
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|pf_send_icmp
parameter_list|(
name|struct
name|mbuf
modifier|*
parameter_list|,
name|u_int8_t
parameter_list|,
name|u_int8_t
parameter_list|,
name|sa_family_t
parameter_list|,
name|struct
name|pf_rule
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|struct
name|pf_rule
modifier|*
name|pf_match_translation
parameter_list|(
name|struct
name|pf_pdesc
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|struct
name|pfi_kif
modifier|*
parameter_list|,
name|struct
name|pf_addr
modifier|*
parameter_list|,
name|u_int16_t
parameter_list|,
name|struct
name|pf_addr
modifier|*
parameter_list|,
name|u_int16_t
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|struct
name|pf_rule
modifier|*
name|pf_get_translation
parameter_list|(
name|struct
name|pf_pdesc
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|struct
name|pfi_kif
modifier|*
parameter_list|,
name|struct
name|pf_src_node
modifier|*
modifier|*
parameter_list|,
name|struct
name|pf_addr
modifier|*
parameter_list|,
name|u_int16_t
parameter_list|,
name|struct
name|pf_addr
modifier|*
parameter_list|,
name|u_int16_t
parameter_list|,
name|struct
name|pf_addr
modifier|*
parameter_list|,
name|u_int16_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pf_test_tcp
parameter_list|(
name|struct
name|pf_rule
modifier|*
modifier|*
parameter_list|,
name|struct
name|pf_state
modifier|*
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|pfi_kif
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|int
parameter_list|,
name|void
modifier|*
parameter_list|,
name|struct
name|pf_pdesc
modifier|*
parameter_list|,
name|struct
name|pf_rule
modifier|*
modifier|*
parameter_list|,
ifdef|#
directive|ifdef
name|__FreeBSD__
name|struct
name|pf_ruleset
modifier|*
modifier|*
parameter_list|,
name|struct
name|ifqueue
modifier|*
parameter_list|,
name|struct
name|inpcb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_else
else|#
directive|else
end_else

begin_struct_decl
struct_decl|struct
name|pf_ruleset
modifier|*
modifier|*
struct_decl|, struct ifqueue *
end_struct_decl

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
name|int
name|pf_test_udp
parameter_list|(
name|struct
name|pf_rule
modifier|*
modifier|*
parameter_list|,
name|struct
name|pf_state
modifier|*
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|pfi_kif
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|int
parameter_list|,
name|void
modifier|*
parameter_list|,
name|struct
name|pf_pdesc
modifier|*
parameter_list|,
name|struct
name|pf_rule
modifier|*
modifier|*
parameter_list|,
ifdef|#
directive|ifdef
name|__FreeBSD__
name|struct
name|pf_ruleset
modifier|*
modifier|*
parameter_list|,
name|struct
name|ifqueue
modifier|*
parameter_list|,
name|struct
name|inpcb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_else
else|#
directive|else
end_else

begin_struct_decl
struct_decl|struct
name|pf_ruleset
modifier|*
modifier|*
struct_decl|, struct ifqueue *
end_struct_decl

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
name|int
name|pf_test_icmp
parameter_list|(
name|struct
name|pf_rule
modifier|*
modifier|*
parameter_list|,
name|struct
name|pf_state
modifier|*
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|pfi_kif
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|int
parameter_list|,
name|void
modifier|*
parameter_list|,
name|struct
name|pf_pdesc
modifier|*
parameter_list|,
name|struct
name|pf_rule
modifier|*
modifier|*
parameter_list|,
name|struct
name|pf_ruleset
modifier|*
modifier|*
parameter_list|,
name|struct
name|ifqueue
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pf_test_other
parameter_list|(
name|struct
name|pf_rule
modifier|*
modifier|*
parameter_list|,
name|struct
name|pf_state
modifier|*
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|pfi_kif
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|int
parameter_list|,
name|void
modifier|*
parameter_list|,
name|struct
name|pf_pdesc
modifier|*
parameter_list|,
name|struct
name|pf_rule
modifier|*
modifier|*
parameter_list|,
name|struct
name|pf_ruleset
modifier|*
modifier|*
parameter_list|,
name|struct
name|ifqueue
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pf_test_fragment
parameter_list|(
name|struct
name|pf_rule
modifier|*
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|pfi_kif
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|,
name|struct
name|pf_pdesc
modifier|*
parameter_list|,
name|struct
name|pf_rule
modifier|*
modifier|*
parameter_list|,
name|struct
name|pf_ruleset
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pf_test_state_tcp
parameter_list|(
name|struct
name|pf_state
modifier|*
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|pfi_kif
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|int
parameter_list|,
name|void
modifier|*
parameter_list|,
name|struct
name|pf_pdesc
modifier|*
parameter_list|,
name|u_short
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pf_test_state_udp
parameter_list|(
name|struct
name|pf_state
modifier|*
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|pfi_kif
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|int
parameter_list|,
name|void
modifier|*
parameter_list|,
name|struct
name|pf_pdesc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pf_test_state_icmp
parameter_list|(
name|struct
name|pf_state
modifier|*
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|pfi_kif
modifier|*
parameter_list|,
name|struct
name|mbuf
modifier|*
parameter_list|,
name|int
parameter_list|,
name|void
modifier|*
parameter_list|,
name|struct
name|pf_pdesc
modifier|*
parameter_list|,
name|u_short
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pf_test_state_other
parameter_list|(
name|struct
name|pf_state
modifier|*
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|pfi_kif
modifier|*
parameter_list|,
name|struct
name|pf_pdesc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|struct
name|pf_tag
modifier|*
name|pf_get_tag
parameter_list|(
name|struct
name|mbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pf_match_tag
parameter_list|(
name|struct
name|mbuf
modifier|*
parameter_list|,
name|struct
name|pf_rule
modifier|*
parameter_list|,
name|struct
name|pf_tag
modifier|*
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|pf_hash
parameter_list|(
name|struct
name|pf_addr
modifier|*
parameter_list|,
name|struct
name|pf_addr
modifier|*
parameter_list|,
name|struct
name|pf_poolhashkey
modifier|*
parameter_list|,
name|sa_family_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pf_map_addr
parameter_list|(
name|u_int8_t
parameter_list|,
name|struct
name|pf_rule
modifier|*
parameter_list|,
name|struct
name|pf_addr
modifier|*
parameter_list|,
name|struct
name|pf_addr
modifier|*
parameter_list|,
name|struct
name|pf_addr
modifier|*
parameter_list|,
name|struct
name|pf_src_node
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pf_get_sport
parameter_list|(
name|sa_family_t
parameter_list|,
name|u_int8_t
parameter_list|,
name|struct
name|pf_rule
modifier|*
parameter_list|,
name|struct
name|pf_addr
modifier|*
parameter_list|,
name|struct
name|pf_addr
modifier|*
parameter_list|,
name|u_int16_t
parameter_list|,
name|struct
name|pf_addr
modifier|*
parameter_list|,
name|u_int16_t
modifier|*
parameter_list|,
name|u_int16_t
parameter_list|,
name|u_int16_t
parameter_list|,
name|struct
name|pf_src_node
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|pf_route
parameter_list|(
name|struct
name|mbuf
modifier|*
modifier|*
parameter_list|,
name|struct
name|pf_rule
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|ifnet
modifier|*
parameter_list|,
name|struct
name|pf_state
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|pf_route6
parameter_list|(
name|struct
name|mbuf
modifier|*
modifier|*
parameter_list|,
name|struct
name|pf_rule
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|ifnet
modifier|*
parameter_list|,
name|struct
name|pf_state
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_function_decl
name|int
name|pf_socket_lookup
parameter_list|(
name|uid_t
modifier|*
parameter_list|,
name|gid_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|pf_pdesc
modifier|*
parameter_list|,
name|struct
name|inpcb
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_else
else|#
directive|else
end_else

begin_function_decl
name|int
name|pf_socket_lookup
parameter_list|(
name|uid_t
modifier|*
parameter_list|,
name|gid_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|pf_pdesc
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
name|u_int8_t
name|pf_get_wscale
parameter_list|(
name|struct
name|mbuf
modifier|*
parameter_list|,
name|int
parameter_list|,
name|u_int16_t
parameter_list|,
name|sa_family_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|u_int16_t
name|pf_get_mss
parameter_list|(
name|struct
name|mbuf
modifier|*
parameter_list|,
name|int
parameter_list|,
name|u_int16_t
parameter_list|,
name|sa_family_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|u_int16_t
name|pf_calc_mss
parameter_list|(
name|struct
name|pf_addr
modifier|*
parameter_list|,
name|sa_family_t
parameter_list|,
name|u_int16_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|pf_set_rt_ifp
parameter_list|(
name|struct
name|pf_state
modifier|*
parameter_list|,
name|struct
name|pf_addr
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pf_check_proto_cksum
parameter_list|(
name|struct
name|mbuf
modifier|*
parameter_list|,
name|int
parameter_list|,
name|int
parameter_list|,
name|u_int8_t
parameter_list|,
name|sa_family_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pf_addr_wrap_neq
parameter_list|(
name|struct
name|pf_addr_wrap
modifier|*
parameter_list|,
name|struct
name|pf_addr_wrap
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|pf_add_mbuf_tag
parameter_list|(
name|struct
name|mbuf
modifier|*
parameter_list|,
name|u_int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|struct
name|pf_state
modifier|*
name|pf_find_state_recurse
parameter_list|(
name|struct
name|pfi_kif
modifier|*
parameter_list|,
name|struct
name|pf_state
modifier|*
parameter_list|,
name|u_int8_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pf_src_connlimit
parameter_list|(
name|struct
name|pf_state
modifier|*
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|pf_check_congestion
parameter_list|(
name|struct
name|ifqueue
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_function_decl
name|int
name|in4_cksum
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|u_int8_t
name|nxt
parameter_list|,
name|int
name|off
parameter_list|,
name|int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|struct
name|pf_pool_limit
name|pf_pool_limits
index|[
name|PF_LIMIT_MAX
index|]
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_decl_stmt
name|struct
name|pf_pool_limit
name|pf_pool_limits
index|[
name|PF_LIMIT_MAX
index|]
init|=
block|{
block|{
operator|&
name|pf_state_pl
block|,
name|PFSTATE_HIWAT
block|}
block|,
block|{
operator|&
name|pf_src_tree_pl
block|,
name|PFSNODE_HIWAT
block|}
block|,
block|{
operator|&
name|pf_frent_pl
block|,
name|PFFRAG_FRENT_HIWAT
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|STATE_LOOKUP
parameter_list|()
define|\
value|do {								\ 		if (direction == PF_IN)					\ 			*state = pf_find_state_recurse(			\ 			    kif,&key, PF_EXT_GWY);			\ 		else							\ 			*state = pf_find_state_recurse(			\ 			    kif,&key, PF_LAN_EXT);			\ 		if (*state == NULL || (*state)->timeout == PFTM_PURGE)	\ 			return (PF_DROP);				\ 		if (direction == PF_OUT&&				\ 		    (((*state)->rule.ptr->rt == PF_ROUTETO&&		\ 		    (*state)->rule.ptr->direction == PF_OUT) ||		\ 		    ((*state)->rule.ptr->rt == PF_REPLYTO&&		\ 		    (*state)->rule.ptr->direction == PF_IN))&&		\ 		    (*state)->rt_kif != NULL&&				\ 		    (*state)->rt_kif != kif)				\ 			return (PF_PASS);				\ 	} while (0)
end_define

begin_define
define|#
directive|define
name|STATE_TRANSLATE
parameter_list|(
name|s
parameter_list|)
define|\
value|(s)->lan.addr.addr32[0] != (s)->gwy.addr.addr32[0] || \ 	((s)->af == AF_INET6&& \ 	((s)->lan.addr.addr32[1] != (s)->gwy.addr.addr32[1] || \ 	(s)->lan.addr.addr32[2] != (s)->gwy.addr.addr32[2] || \ 	(s)->lan.addr.addr32[3] != (s)->gwy.addr.addr32[3])) || \ 	(s)->lan.port != (s)->gwy.port
end_define

begin_define
define|#
directive|define
name|BOUND_IFACE
parameter_list|(
name|r
parameter_list|,
name|k
parameter_list|)
value|(((r)->rule_flag& PFRULE_IFBOUND) ? (k) :   \ 	((r)->rule_flag& PFRULE_GRBOUND) ? (k)->pfik_parent :	       \ 	(k)->pfik_parent->pfik_parent)
end_define

begin_define
define|#
directive|define
name|STATE_INC_COUNTERS
parameter_list|(
name|s
parameter_list|)
define|\
value|do {						\ 		s->rule.ptr->states++;			\ 		if (s->anchor.ptr != NULL)		\ 			s->anchor.ptr->states++;	\ 		if (s->nat_rule.ptr != NULL)		\ 			s->nat_rule.ptr->states++;	\ 	} while (0)
end_define

begin_define
define|#
directive|define
name|STATE_DEC_COUNTERS
parameter_list|(
name|s
parameter_list|)
define|\
value|do {						\ 		if (s->nat_rule.ptr != NULL)		\ 			s->nat_rule.ptr->states--;	\ 		if (s->anchor.ptr != NULL)		\ 			s->anchor.ptr->states--;	\ 		s->rule.ptr->states--;			\ 	} while (0)
end_define

begin_ifndef
ifndef|#
directive|ifndef
name|__FreeBSD__
end_ifndef

begin_function_decl
specifier|static
name|__inline
name|int
name|pf_src_compare
parameter_list|(
name|struct
name|pf_src_node
modifier|*
parameter_list|,
name|struct
name|pf_src_node
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|__inline
name|int
name|pf_state_compare_lan_ext
parameter_list|(
name|struct
name|pf_state
modifier|*
parameter_list|,
name|struct
name|pf_state
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|__inline
name|int
name|pf_state_compare_ext_gwy
parameter_list|(
name|struct
name|pf_state
modifier|*
parameter_list|,
name|struct
name|pf_state
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|__inline
name|int
name|pf_state_compare_id
parameter_list|(
name|struct
name|pf_state
modifier|*
parameter_list|,
name|struct
name|pf_state
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|__inline
name|int
name|pf_anchor_compare
parameter_list|(
name|struct
name|pf_anchor
modifier|*
parameter_list|,
name|struct
name|pf_anchor
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_else
else|#
directive|else
end_else

begin_function_decl
specifier|static
name|int
name|pf_src_compare
parameter_list|(
name|struct
name|pf_src_node
modifier|*
parameter_list|,
name|struct
name|pf_src_node
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|pf_state_compare_lan_ext
parameter_list|(
name|struct
name|pf_state
modifier|*
parameter_list|,
name|struct
name|pf_state
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|pf_state_compare_ext_gwy
parameter_list|(
name|struct
name|pf_state
modifier|*
parameter_list|,
name|struct
name|pf_state
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|pf_state_compare_id
parameter_list|(
name|struct
name|pf_state
modifier|*
parameter_list|,
name|struct
name|pf_state
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|pf_anchor_compare
parameter_list|(
name|struct
name|pf_anchor
modifier|*
parameter_list|,
name|struct
name|pf_anchor
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|struct
name|pf_src_tree
name|tree_src_tracking
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|pf_state_tree_id
name|tree_id
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|pf_state_queue
name|state_updates
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|RB_GENERATE
argument_list|(
name|pf_src_tree
argument_list|,
name|pf_src_node
argument_list|,
name|entry
argument_list|,
name|pf_src_compare
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|RB_GENERATE
argument_list|(
name|pf_state_tree_lan_ext
argument_list|,
name|pf_state
argument_list|,
name|u
operator|.
name|s
operator|.
name|entry_lan_ext
argument_list|,
name|pf_state_compare_lan_ext
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|RB_GENERATE
argument_list|(
name|pf_state_tree_ext_gwy
argument_list|,
name|pf_state
argument_list|,
name|u
operator|.
name|s
operator|.
name|entry_ext_gwy
argument_list|,
name|pf_state_compare_ext_gwy
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|RB_GENERATE
argument_list|(
name|pf_state_tree_id
argument_list|,
name|pf_state
argument_list|,
name|u
operator|.
name|s
operator|.
name|entry_id
argument_list|,
name|pf_state_compare_id
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|RB_GENERATE
argument_list|(
name|pf_anchor_global
argument_list|,
name|pf_anchor
argument_list|,
name|entry_global
argument_list|,
name|pf_anchor_compare
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|RB_GENERATE
argument_list|(
name|pf_anchor_node
argument_list|,
name|pf_anchor
argument_list|,
name|entry_node
argument_list|,
name|pf_anchor_compare
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_function
specifier|static
name|int
else|#
directive|else
specifier|static
name|__inline
name|int
endif|#
directive|endif
name|pf_src_compare
parameter_list|(
name|struct
name|pf_src_node
modifier|*
name|a
parameter_list|,
name|struct
name|pf_src_node
modifier|*
name|b
parameter_list|)
block|{
name|int
name|diff
decl_stmt|;
if|if
condition|(
name|a
operator|->
name|rule
operator|.
name|ptr
operator|>
name|b
operator|->
name|rule
operator|.
name|ptr
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|rule
operator|.
name|ptr
operator|<
name|b
operator|->
name|rule
operator|.
name|ptr
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
operator|(
name|diff
operator|=
name|a
operator|->
name|af
operator|-
name|b
operator|->
name|af
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|diff
operator|)
return|;
switch|switch
condition|(
name|a
operator|->
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
if|if
condition|(
name|a
operator|->
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
operator|>
name|b
operator|->
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
operator|<
name|b
operator|->
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
if|if
condition|(
name|a
operator|->
name|addr
operator|.
name|addr32
index|[
literal|3
index|]
operator|>
name|b
operator|->
name|addr
operator|.
name|addr32
index|[
literal|3
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|addr
operator|.
name|addr32
index|[
literal|3
index|]
operator|<
name|b
operator|->
name|addr
operator|.
name|addr32
index|[
literal|3
index|]
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|addr
operator|.
name|addr32
index|[
literal|2
index|]
operator|>
name|b
operator|->
name|addr
operator|.
name|addr32
index|[
literal|2
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|addr
operator|.
name|addr32
index|[
literal|2
index|]
operator|<
name|b
operator|->
name|addr
operator|.
name|addr32
index|[
literal|2
index|]
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|addr
operator|.
name|addr32
index|[
literal|1
index|]
operator|>
name|b
operator|->
name|addr
operator|.
name|addr32
index|[
literal|1
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|addr
operator|.
name|addr32
index|[
literal|1
index|]
operator|<
name|b
operator|->
name|addr
operator|.
name|addr32
index|[
literal|1
index|]
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
operator|>
name|b
operator|->
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
operator|<
name|b
operator|->
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_function
specifier|static
name|int
else|#
directive|else
specifier|static
name|__inline
name|int
endif|#
directive|endif
name|pf_state_compare_lan_ext
parameter_list|(
name|struct
name|pf_state
modifier|*
name|a
parameter_list|,
name|struct
name|pf_state
modifier|*
name|b
parameter_list|)
block|{
name|int
name|diff
decl_stmt|;
if|if
condition|(
operator|(
name|diff
operator|=
name|a
operator|->
name|proto
operator|-
name|b
operator|->
name|proto
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|diff
operator|)
return|;
if|if
condition|(
operator|(
name|diff
operator|=
name|a
operator|->
name|af
operator|-
name|b
operator|->
name|af
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|diff
operator|)
return|;
switch|switch
condition|(
name|a
operator|->
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
if|if
condition|(
name|a
operator|->
name|lan
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
operator|>
name|b
operator|->
name|lan
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|lan
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
operator|<
name|b
operator|->
name|lan
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
operator|>
name|b
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
operator|<
name|b
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
if|if
condition|(
name|a
operator|->
name|lan
operator|.
name|addr
operator|.
name|addr32
index|[
literal|3
index|]
operator|>
name|b
operator|->
name|lan
operator|.
name|addr
operator|.
name|addr32
index|[
literal|3
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|lan
operator|.
name|addr
operator|.
name|addr32
index|[
literal|3
index|]
operator|<
name|b
operator|->
name|lan
operator|.
name|addr
operator|.
name|addr32
index|[
literal|3
index|]
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|3
index|]
operator|>
name|b
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|3
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|3
index|]
operator|<
name|b
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|3
index|]
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|lan
operator|.
name|addr
operator|.
name|addr32
index|[
literal|2
index|]
operator|>
name|b
operator|->
name|lan
operator|.
name|addr
operator|.
name|addr32
index|[
literal|2
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|lan
operator|.
name|addr
operator|.
name|addr32
index|[
literal|2
index|]
operator|<
name|b
operator|->
name|lan
operator|.
name|addr
operator|.
name|addr32
index|[
literal|2
index|]
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|2
index|]
operator|>
name|b
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|2
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|2
index|]
operator|<
name|b
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|2
index|]
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|lan
operator|.
name|addr
operator|.
name|addr32
index|[
literal|1
index|]
operator|>
name|b
operator|->
name|lan
operator|.
name|addr
operator|.
name|addr32
index|[
literal|1
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|lan
operator|.
name|addr
operator|.
name|addr32
index|[
literal|1
index|]
operator|<
name|b
operator|->
name|lan
operator|.
name|addr
operator|.
name|addr32
index|[
literal|1
index|]
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|1
index|]
operator|>
name|b
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|1
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|1
index|]
operator|<
name|b
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|1
index|]
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|lan
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
operator|>
name|b
operator|->
name|lan
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|lan
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
operator|<
name|b
operator|->
name|lan
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
operator|>
name|b
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
operator|<
name|b
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
if|if
condition|(
operator|(
name|diff
operator|=
name|a
operator|->
name|lan
operator|.
name|port
operator|-
name|b
operator|->
name|lan
operator|.
name|port
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|diff
operator|)
return|;
if|if
condition|(
operator|(
name|diff
operator|=
name|a
operator|->
name|ext
operator|.
name|port
operator|-
name|b
operator|->
name|ext
operator|.
name|port
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|diff
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_function
specifier|static
name|int
else|#
directive|else
specifier|static
name|__inline
name|int
endif|#
directive|endif
name|pf_state_compare_ext_gwy
parameter_list|(
name|struct
name|pf_state
modifier|*
name|a
parameter_list|,
name|struct
name|pf_state
modifier|*
name|b
parameter_list|)
block|{
name|int
name|diff
decl_stmt|;
if|if
condition|(
operator|(
name|diff
operator|=
name|a
operator|->
name|proto
operator|-
name|b
operator|->
name|proto
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|diff
operator|)
return|;
if|if
condition|(
operator|(
name|diff
operator|=
name|a
operator|->
name|af
operator|-
name|b
operator|->
name|af
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|diff
operator|)
return|;
switch|switch
condition|(
name|a
operator|->
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
if|if
condition|(
name|a
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
operator|>
name|b
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
operator|<
name|b
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|gwy
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
operator|>
name|b
operator|->
name|gwy
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|gwy
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
operator|<
name|b
operator|->
name|gwy
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
if|if
condition|(
name|a
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|3
index|]
operator|>
name|b
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|3
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|3
index|]
operator|<
name|b
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|3
index|]
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|gwy
operator|.
name|addr
operator|.
name|addr32
index|[
literal|3
index|]
operator|>
name|b
operator|->
name|gwy
operator|.
name|addr
operator|.
name|addr32
index|[
literal|3
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|gwy
operator|.
name|addr
operator|.
name|addr32
index|[
literal|3
index|]
operator|<
name|b
operator|->
name|gwy
operator|.
name|addr
operator|.
name|addr32
index|[
literal|3
index|]
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|2
index|]
operator|>
name|b
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|2
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|2
index|]
operator|<
name|b
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|2
index|]
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|gwy
operator|.
name|addr
operator|.
name|addr32
index|[
literal|2
index|]
operator|>
name|b
operator|->
name|gwy
operator|.
name|addr
operator|.
name|addr32
index|[
literal|2
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|gwy
operator|.
name|addr
operator|.
name|addr32
index|[
literal|2
index|]
operator|<
name|b
operator|->
name|gwy
operator|.
name|addr
operator|.
name|addr32
index|[
literal|2
index|]
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|1
index|]
operator|>
name|b
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|1
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|1
index|]
operator|<
name|b
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|1
index|]
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|gwy
operator|.
name|addr
operator|.
name|addr32
index|[
literal|1
index|]
operator|>
name|b
operator|->
name|gwy
operator|.
name|addr
operator|.
name|addr32
index|[
literal|1
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|gwy
operator|.
name|addr
operator|.
name|addr32
index|[
literal|1
index|]
operator|<
name|b
operator|->
name|gwy
operator|.
name|addr
operator|.
name|addr32
index|[
literal|1
index|]
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
operator|>
name|b
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
operator|<
name|b
operator|->
name|ext
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|gwy
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
operator|>
name|b
operator|->
name|gwy
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|gwy
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
operator|<
name|b
operator|->
name|gwy
operator|.
name|addr
operator|.
name|addr32
index|[
literal|0
index|]
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
if|if
condition|(
operator|(
name|diff
operator|=
name|a
operator|->
name|ext
operator|.
name|port
operator|-
name|b
operator|->
name|ext
operator|.
name|port
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|diff
operator|)
return|;
if|if
condition|(
operator|(
name|diff
operator|=
name|a
operator|->
name|gwy
operator|.
name|port
operator|-
name|b
operator|->
name|gwy
operator|.
name|port
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
name|diff
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_function
specifier|static
name|int
else|#
directive|else
specifier|static
name|__inline
name|int
endif|#
directive|endif
name|pf_state_compare_id
parameter_list|(
name|struct
name|pf_state
modifier|*
name|a
parameter_list|,
name|struct
name|pf_state
modifier|*
name|b
parameter_list|)
block|{
if|if
condition|(
name|a
operator|->
name|id
operator|>
name|b
operator|->
name|id
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|id
operator|<
name|b
operator|->
name|id
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|creatorid
operator|>
name|b
operator|->
name|creatorid
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|a
operator|->
name|creatorid
operator|<
name|b
operator|->
name|creatorid
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_function
specifier|static
name|int
else|#
directive|else
specifier|static
name|__inline
name|int
endif|#
directive|endif
name|pf_anchor_compare
parameter_list|(
name|struct
name|pf_anchor
modifier|*
name|a
parameter_list|,
name|struct
name|pf_anchor
modifier|*
name|b
parameter_list|)
block|{
name|int
name|c
init|=
name|strcmp
argument_list|(
name|a
operator|->
name|path
argument_list|,
name|b
operator|->
name|path
argument_list|)
decl_stmt|;
return|return
operator|(
name|c
condition|?
operator|(
name|c
operator|<
literal|0
condition|?
operator|-
literal|1
else|:
literal|1
operator|)
else|:
literal|0
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|INET6
end_ifdef

begin_function
name|void
name|pf_addrcpy
parameter_list|(
name|struct
name|pf_addr
modifier|*
name|dst
parameter_list|,
name|struct
name|pf_addr
modifier|*
name|src
parameter_list|,
name|sa_family_t
name|af
parameter_list|)
block|{
switch|switch
condition|(
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
name|dst
operator|->
name|addr32
index|[
literal|0
index|]
operator|=
name|src
operator|->
name|addr32
index|[
literal|0
index|]
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
case|case
name|AF_INET6
case|:
name|dst
operator|->
name|addr32
index|[
literal|0
index|]
operator|=
name|src
operator|->
name|addr32
index|[
literal|0
index|]
expr_stmt|;
name|dst
operator|->
name|addr32
index|[
literal|1
index|]
operator|=
name|src
operator|->
name|addr32
index|[
literal|1
index|]
expr_stmt|;
name|dst
operator|->
name|addr32
index|[
literal|2
index|]
operator|=
name|src
operator|->
name|addr32
index|[
literal|2
index|]
expr_stmt|;
name|dst
operator|->
name|addr32
index|[
literal|3
index|]
operator|=
name|src
operator|->
name|addr32
index|[
literal|3
index|]
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* INET6 */
end_comment

begin_function
name|struct
name|pf_state
modifier|*
name|pf_find_state_byid
parameter_list|(
name|struct
name|pf_state
modifier|*
name|key
parameter_list|)
block|{
name|pf_status
operator|.
name|fcounters
index|[
name|FCNT_STATE_SEARCH
index|]
operator|++
expr_stmt|;
return|return
operator|(
name|RB_FIND
argument_list|(
name|pf_state_tree_id
argument_list|,
operator|&
name|tree_id
argument_list|,
name|key
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|pf_state
modifier|*
name|pf_find_state_recurse
parameter_list|(
name|struct
name|pfi_kif
modifier|*
name|kif
parameter_list|,
name|struct
name|pf_state
modifier|*
name|key
parameter_list|,
name|u_int8_t
name|tree
parameter_list|)
block|{
name|struct
name|pf_state
modifier|*
name|s
decl_stmt|;
name|pf_status
operator|.
name|fcounters
index|[
name|FCNT_STATE_SEARCH
index|]
operator|++
expr_stmt|;
switch|switch
condition|(
name|tree
condition|)
block|{
case|case
name|PF_LAN_EXT
case|:
for|for
control|(
init|;
name|kif
operator|!=
name|NULL
condition|;
name|kif
operator|=
name|kif
operator|->
name|pfik_parent
control|)
block|{
name|s
operator|=
name|RB_FIND
argument_list|(
name|pf_state_tree_lan_ext
argument_list|,
operator|&
name|kif
operator|->
name|pfik_lan_ext
argument_list|,
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|!=
name|NULL
condition|)
return|return
operator|(
name|s
operator|)
return|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
case|case
name|PF_EXT_GWY
case|:
for|for
control|(
init|;
name|kif
operator|!=
name|NULL
condition|;
name|kif
operator|=
name|kif
operator|->
name|pfik_parent
control|)
block|{
name|s
operator|=
name|RB_FIND
argument_list|(
name|pf_state_tree_ext_gwy
argument_list|,
operator|&
name|kif
operator|->
name|pfik_ext_gwy
argument_list|,
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|!=
name|NULL
condition|)
return|return
operator|(
name|s
operator|)
return|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
default|default:
name|panic
argument_list|(
literal|"pf_find_state_recurse"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|struct
name|pf_state
modifier|*
name|pf_find_state_all
parameter_list|(
name|struct
name|pf_state
modifier|*
name|key
parameter_list|,
name|u_int8_t
name|tree
parameter_list|,
name|int
modifier|*
name|more
parameter_list|)
block|{
name|struct
name|pf_state
modifier|*
name|s
decl_stmt|,
modifier|*
name|ss
init|=
name|NULL
decl_stmt|;
name|struct
name|pfi_kif
modifier|*
name|kif
decl_stmt|;
name|pf_status
operator|.
name|fcounters
index|[
name|FCNT_STATE_SEARCH
index|]
operator|++
expr_stmt|;
switch|switch
condition|(
name|tree
condition|)
block|{
case|case
name|PF_LAN_EXT
case|:
name|TAILQ_FOREACH
argument_list|(
argument|kif
argument_list|,
argument|&pfi_statehead
argument_list|,
argument|pfik_w_states
argument_list|)
block|{
name|s
operator|=
name|RB_FIND
argument_list|(
name|pf_state_tree_lan_ext
argument_list|,
operator|&
name|kif
operator|->
name|pfik_lan_ext
argument_list|,
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|more
operator|==
name|NULL
condition|)
return|return
operator|(
name|s
operator|)
return|;
name|ss
operator|=
name|s
expr_stmt|;
operator|(
operator|*
name|more
operator|)
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|ss
operator|)
return|;
case|case
name|PF_EXT_GWY
case|:
name|TAILQ_FOREACH
argument_list|(
argument|kif
argument_list|,
argument|&pfi_statehead
argument_list|,
argument|pfik_w_states
argument_list|)
block|{
name|s
operator|=
name|RB_FIND
argument_list|(
name|pf_state_tree_ext_gwy
argument_list|,
operator|&
name|kif
operator|->
name|pfik_ext_gwy
argument_list|,
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|more
operator|==
name|NULL
condition|)
return|return
operator|(
name|s
operator|)
return|;
name|ss
operator|=
name|s
expr_stmt|;
operator|(
operator|*
name|more
operator|)
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|ss
operator|)
return|;
default|default:
name|panic
argument_list|(
literal|"pf_find_state_all"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|pf_init_threshold
parameter_list|(
name|struct
name|pf_threshold
modifier|*
name|threshold
parameter_list|,
name|u_int32_t
name|limit
parameter_list|,
name|u_int32_t
name|seconds
parameter_list|)
block|{
name|threshold
operator|->
name|limit
operator|=
name|limit
operator|*
name|PF_THRESHOLD_MULT
expr_stmt|;
name|threshold
operator|->
name|seconds
operator|=
name|seconds
expr_stmt|;
name|threshold
operator|->
name|count
operator|=
literal|0
expr_stmt|;
name|threshold
operator|->
name|last
operator|=
name|time_second
expr_stmt|;
block|}
end_function

begin_function
name|void
name|pf_add_threshold
parameter_list|(
name|struct
name|pf_threshold
modifier|*
name|threshold
parameter_list|)
block|{
name|u_int32_t
name|t
init|=
name|time_second
decl_stmt|,
name|diff
init|=
name|t
operator|-
name|threshold
operator|->
name|last
decl_stmt|;
if|if
condition|(
name|diff
operator|>=
name|threshold
operator|->
name|seconds
condition|)
name|threshold
operator|->
name|count
operator|=
literal|0
expr_stmt|;
else|else
name|threshold
operator|->
name|count
operator|-=
name|threshold
operator|->
name|count
operator|*
name|diff
operator|/
name|threshold
operator|->
name|seconds
expr_stmt|;
name|threshold
operator|->
name|count
operator|+=
name|PF_THRESHOLD_MULT
expr_stmt|;
name|threshold
operator|->
name|last
operator|=
name|t
expr_stmt|;
block|}
end_function

begin_function
name|int
name|pf_check_threshold
parameter_list|(
name|struct
name|pf_threshold
modifier|*
name|threshold
parameter_list|)
block|{
return|return
operator|(
name|threshold
operator|->
name|count
operator|>
name|threshold
operator|->
name|limit
operator|)
return|;
block|}
end_function

begin_function
name|int
name|pf_src_connlimit
parameter_list|(
name|struct
name|pf_state
modifier|*
modifier|*
name|state
parameter_list|)
block|{
name|struct
name|pf_state
modifier|*
name|s
decl_stmt|;
name|int
name|bad
init|=
literal|0
decl_stmt|;
operator|(
operator|*
name|state
operator|)
operator|->
name|src_node
operator|->
name|conn
operator|++
expr_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
operator|(
operator|*
name|state
operator|)
operator|->
name|local_flags
operator||=
name|PFSTATE_SRC_CONN
expr_stmt|;
endif|#
directive|endif
name|pf_add_threshold
argument_list|(
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|src_node
operator|->
name|conn_rate
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|state
operator|)
operator|->
name|rule
operator|.
name|ptr
operator|->
name|max_src_conn
operator|&&
operator|(
operator|*
name|state
operator|)
operator|->
name|rule
operator|.
name|ptr
operator|->
name|max_src_conn
operator|<
operator|(
operator|*
name|state
operator|)
operator|->
name|src_node
operator|->
name|conn
condition|)
block|{
name|pf_status
operator|.
name|lcounters
index|[
name|LCNT_SRCCONN
index|]
operator|++
expr_stmt|;
name|bad
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|*
name|state
operator|)
operator|->
name|rule
operator|.
name|ptr
operator|->
name|max_src_conn_rate
operator|.
name|limit
operator|&&
name|pf_check_threshold
argument_list|(
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|src_node
operator|->
name|conn_rate
argument_list|)
condition|)
block|{
name|pf_status
operator|.
name|lcounters
index|[
name|LCNT_SRCCONNRATE
index|]
operator|++
expr_stmt|;
name|bad
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|bad
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
operator|*
name|state
operator|)
operator|->
name|rule
operator|.
name|ptr
operator|->
name|overload_tbl
condition|)
block|{
name|struct
name|pfr_addr
name|p
decl_stmt|;
name|u_int32_t
name|killed
init|=
literal|0
decl_stmt|;
name|pf_status
operator|.
name|lcounters
index|[
name|LCNT_OVERLOAD_TABLE
index|]
operator|++
expr_stmt|;
if|if
condition|(
name|pf_status
operator|.
name|debug
operator|>=
name|PF_DEBUG_MISC
condition|)
block|{
name|printf
argument_list|(
literal|"pf_src_connlimit: blocking address "
argument_list|)
expr_stmt|;
name|pf_print_host
argument_list|(
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|src_node
operator|->
name|addr
argument_list|,
literal|0
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|af
argument_list|)
expr_stmt|;
block|}
name|bzero
argument_list|(
operator|&
name|p
argument_list|,
sizeof|sizeof
argument_list|(
name|p
argument_list|)
argument_list|)
expr_stmt|;
name|p
operator|.
name|pfra_af
operator|=
operator|(
operator|*
name|state
operator|)
operator|->
name|af
expr_stmt|;
switch|switch
condition|(
operator|(
operator|*
name|state
operator|)
operator|->
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
name|p
operator|.
name|pfra_net
operator|=
literal|32
expr_stmt|;
name|p
operator|.
name|pfra_ip4addr
operator|=
operator|(
operator|*
name|state
operator|)
operator|->
name|src_node
operator|->
name|addr
operator|.
name|v4
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
name|p
operator|.
name|pfra_net
operator|=
literal|128
expr_stmt|;
name|p
operator|.
name|pfra_ip6addr
operator|=
operator|(
operator|*
name|state
operator|)
operator|->
name|src_node
operator|->
name|addr
operator|.
name|v6
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
name|pfr_insert_kentry
argument_list|(
operator|(
operator|*
name|state
operator|)
operator|->
name|rule
operator|.
name|ptr
operator|->
name|overload_tbl
argument_list|,
operator|&
name|p
argument_list|,
name|time_second
argument_list|)
expr_stmt|;
comment|/* kill existing states if that's required. */
if|if
condition|(
operator|(
operator|*
name|state
operator|)
operator|->
name|rule
operator|.
name|ptr
operator|->
name|flush
condition|)
block|{
name|pf_status
operator|.
name|lcounters
index|[
name|LCNT_OVERLOAD_FLUSH
index|]
operator|++
expr_stmt|;
name|RB_FOREACH
argument_list|(
argument|s
argument_list|,
argument|pf_state_tree_id
argument_list|,
argument|&tree_id
argument_list|)
block|{
comment|/* 				 * Kill states from this source.  (Only those 				 * from the same rule if PF_FLUSH_GLOBAL is not 				 * set) 				 */
if|if
condition|(
name|s
operator|->
name|af
operator|==
operator|(
operator|*
name|state
operator|)
operator|->
name|af
operator|&&
operator|(
operator|(
operator|(
operator|*
name|state
operator|)
operator|->
name|direction
operator|==
name|PF_OUT
operator|&&
name|PF_AEQ
argument_list|(
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|src_node
operator|->
name|addr
argument_list|,
operator|&
name|s
operator|->
name|lan
operator|.
name|addr
argument_list|,
name|s
operator|->
name|af
argument_list|)
operator|)
operator|||
operator|(
operator|(
operator|*
name|state
operator|)
operator|->
name|direction
operator|==
name|PF_IN
operator|&&
name|PF_AEQ
argument_list|(
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|src_node
operator|->
name|addr
argument_list|,
operator|&
name|s
operator|->
name|ext
operator|.
name|addr
argument_list|,
name|s
operator|->
name|af
argument_list|)
operator|)
operator|)
operator|&&
operator|(
operator|(
operator|*
name|state
operator|)
operator|->
name|rule
operator|.
name|ptr
operator|->
name|flush
operator|&
name|PF_FLUSH_GLOBAL
operator|||
operator|(
operator|*
name|state
operator|)
operator|->
name|rule
operator|.
name|ptr
operator|==
name|s
operator|->
name|rule
operator|.
name|ptr
operator|)
condition|)
block|{
name|s
operator|->
name|timeout
operator|=
name|PFTM_PURGE
expr_stmt|;
name|s
operator|->
name|src
operator|.
name|state
operator|=
name|s
operator|->
name|dst
operator|.
name|state
operator|=
name|TCPS_CLOSED
expr_stmt|;
name|killed
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|pf_status
operator|.
name|debug
operator|>=
name|PF_DEBUG_MISC
condition|)
name|printf
argument_list|(
literal|", %u states killed"
argument_list|,
name|killed
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pf_status
operator|.
name|debug
operator|>=
name|PF_DEBUG_MISC
condition|)
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
comment|/* kill this state */
operator|(
operator|*
name|state
operator|)
operator|->
name|timeout
operator|=
name|PFTM_PURGE
expr_stmt|;
operator|(
operator|*
name|state
operator|)
operator|->
name|src
operator|.
name|state
operator|=
operator|(
operator|*
name|state
operator|)
operator|->
name|dst
operator|.
name|state
operator|=
name|TCPS_CLOSED
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|int
name|pf_insert_src_node
parameter_list|(
name|struct
name|pf_src_node
modifier|*
modifier|*
name|sn
parameter_list|,
name|struct
name|pf_rule
modifier|*
name|rule
parameter_list|,
name|struct
name|pf_addr
modifier|*
name|src
parameter_list|,
name|sa_family_t
name|af
parameter_list|)
block|{
name|struct
name|pf_src_node
name|k
decl_stmt|;
if|if
condition|(
operator|*
name|sn
operator|==
name|NULL
condition|)
block|{
name|k
operator|.
name|af
operator|=
name|af
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|k
operator|.
name|addr
argument_list|,
name|src
argument_list|,
name|af
argument_list|)
expr_stmt|;
if|if
condition|(
name|rule
operator|->
name|rule_flag
operator|&
name|PFRULE_RULESRCTRACK
operator|||
name|rule
operator|->
name|rpool
operator|.
name|opts
operator|&
name|PF_POOL_STICKYADDR
condition|)
name|k
operator|.
name|rule
operator|.
name|ptr
operator|=
name|rule
expr_stmt|;
else|else
name|k
operator|.
name|rule
operator|.
name|ptr
operator|=
name|NULL
expr_stmt|;
name|pf_status
operator|.
name|scounters
index|[
name|SCNT_SRC_NODE_SEARCH
index|]
operator|++
expr_stmt|;
operator|*
name|sn
operator|=
name|RB_FIND
argument_list|(
name|pf_src_tree
argument_list|,
operator|&
name|tree_src_tracking
argument_list|,
operator|&
name|k
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|sn
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|!
name|rule
operator|->
name|max_src_nodes
operator|||
name|rule
operator|->
name|src_nodes
operator|<
name|rule
operator|->
name|max_src_nodes
condition|)
operator|(
operator|*
name|sn
operator|)
operator|=
name|pool_get
argument_list|(
operator|&
name|pf_src_tree_pl
argument_list|,
name|PR_NOWAIT
argument_list|)
expr_stmt|;
else|else
name|pf_status
operator|.
name|lcounters
index|[
name|LCNT_SRCNODES
index|]
operator|++
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|sn
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|bzero
argument_list|(
operator|*
name|sn
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|pf_src_node
argument_list|)
argument_list|)
expr_stmt|;
name|pf_init_threshold
argument_list|(
operator|&
operator|(
operator|*
name|sn
operator|)
operator|->
name|conn_rate
argument_list|,
name|rule
operator|->
name|max_src_conn_rate
operator|.
name|limit
argument_list|,
name|rule
operator|->
name|max_src_conn_rate
operator|.
name|seconds
argument_list|)
expr_stmt|;
operator|(
operator|*
name|sn
operator|)
operator|->
name|af
operator|=
name|af
expr_stmt|;
if|if
condition|(
name|rule
operator|->
name|rule_flag
operator|&
name|PFRULE_RULESRCTRACK
operator|||
name|rule
operator|->
name|rpool
operator|.
name|opts
operator|&
name|PF_POOL_STICKYADDR
condition|)
operator|(
operator|*
name|sn
operator|)
operator|->
name|rule
operator|.
name|ptr
operator|=
name|rule
expr_stmt|;
else|else
operator|(
operator|*
name|sn
operator|)
operator|->
name|rule
operator|.
name|ptr
operator|=
name|NULL
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
operator|(
operator|*
name|sn
operator|)
operator|->
name|addr
argument_list|,
name|src
argument_list|,
name|af
argument_list|)
expr_stmt|;
if|if
condition|(
name|RB_INSERT
argument_list|(
name|pf_src_tree
argument_list|,
operator|&
name|tree_src_tracking
argument_list|,
operator|*
name|sn
argument_list|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|pf_status
operator|.
name|debug
operator|>=
name|PF_DEBUG_MISC
condition|)
block|{
name|printf
argument_list|(
literal|"pf: src_tree insert failed: "
argument_list|)
expr_stmt|;
name|pf_print_host
argument_list|(
operator|&
operator|(
operator|*
name|sn
operator|)
operator|->
name|addr
argument_list|,
literal|0
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|pool_put
argument_list|(
operator|&
name|pf_src_tree_pl
argument_list|,
operator|*
name|sn
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
operator|(
operator|*
name|sn
operator|)
operator|->
name|creation
operator|=
name|time_second
expr_stmt|;
operator|(
operator|*
name|sn
operator|)
operator|->
name|ruletype
operator|=
name|rule
operator|->
name|action
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|sn
operator|)
operator|->
name|rule
operator|.
name|ptr
operator|!=
name|NULL
condition|)
operator|(
operator|*
name|sn
operator|)
operator|->
name|rule
operator|.
name|ptr
operator|->
name|src_nodes
operator|++
expr_stmt|;
name|pf_status
operator|.
name|scounters
index|[
name|SCNT_SRC_NODE_INSERT
index|]
operator|++
expr_stmt|;
name|pf_status
operator|.
name|src_nodes
operator|++
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|rule
operator|->
name|max_src_states
operator|&&
operator|(
operator|*
name|sn
operator|)
operator|->
name|states
operator|>=
name|rule
operator|->
name|max_src_states
condition|)
block|{
name|pf_status
operator|.
name|lcounters
index|[
name|LCNT_SRCSTATES
index|]
operator|++
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|pf_insert_state
parameter_list|(
name|struct
name|pfi_kif
modifier|*
name|kif
parameter_list|,
name|struct
name|pf_state
modifier|*
name|state
parameter_list|)
block|{
comment|/* Thou MUST NOT insert multiple duplicate keys */
name|state
operator|->
name|u
operator|.
name|s
operator|.
name|kif
operator|=
name|kif
expr_stmt|;
if|if
condition|(
name|RB_INSERT
argument_list|(
name|pf_state_tree_lan_ext
argument_list|,
operator|&
name|kif
operator|->
name|pfik_lan_ext
argument_list|,
name|state
argument_list|)
condition|)
block|{
if|if
condition|(
name|pf_status
operator|.
name|debug
operator|>=
name|PF_DEBUG_MISC
condition|)
block|{
name|printf
argument_list|(
literal|"pf: state insert failed: tree_lan_ext"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" lan: "
argument_list|)
expr_stmt|;
name|pf_print_host
argument_list|(
operator|&
name|state
operator|->
name|lan
operator|.
name|addr
argument_list|,
name|state
operator|->
name|lan
operator|.
name|port
argument_list|,
name|state
operator|->
name|af
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" gwy: "
argument_list|)
expr_stmt|;
name|pf_print_host
argument_list|(
operator|&
name|state
operator|->
name|gwy
operator|.
name|addr
argument_list|,
name|state
operator|->
name|gwy
operator|.
name|port
argument_list|,
name|state
operator|->
name|af
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" ext: "
argument_list|)
expr_stmt|;
name|pf_print_host
argument_list|(
operator|&
name|state
operator|->
name|ext
operator|.
name|addr
argument_list|,
name|state
operator|->
name|ext
operator|.
name|port
argument_list|,
name|state
operator|->
name|af
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|->
name|sync_flags
operator|&
name|PFSTATE_FROMSYNC
condition|)
name|printf
argument_list|(
literal|" (from sync)"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|RB_INSERT
argument_list|(
name|pf_state_tree_ext_gwy
argument_list|,
operator|&
name|kif
operator|->
name|pfik_ext_gwy
argument_list|,
name|state
argument_list|)
condition|)
block|{
if|if
condition|(
name|pf_status
operator|.
name|debug
operator|>=
name|PF_DEBUG_MISC
condition|)
block|{
name|printf
argument_list|(
literal|"pf: state insert failed: tree_ext_gwy"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" lan: "
argument_list|)
expr_stmt|;
name|pf_print_host
argument_list|(
operator|&
name|state
operator|->
name|lan
operator|.
name|addr
argument_list|,
name|state
operator|->
name|lan
operator|.
name|port
argument_list|,
name|state
operator|->
name|af
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" gwy: "
argument_list|)
expr_stmt|;
name|pf_print_host
argument_list|(
operator|&
name|state
operator|->
name|gwy
operator|.
name|addr
argument_list|,
name|state
operator|->
name|gwy
operator|.
name|port
argument_list|,
name|state
operator|->
name|af
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" ext: "
argument_list|)
expr_stmt|;
name|pf_print_host
argument_list|(
operator|&
name|state
operator|->
name|ext
operator|.
name|addr
argument_list|,
name|state
operator|->
name|ext
operator|.
name|port
argument_list|,
name|state
operator|->
name|af
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|->
name|sync_flags
operator|&
name|PFSTATE_FROMSYNC
condition|)
name|printf
argument_list|(
literal|" (from sync)"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|RB_REMOVE
argument_list|(
name|pf_state_tree_lan_ext
argument_list|,
operator|&
name|kif
operator|->
name|pfik_lan_ext
argument_list|,
name|state
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|state
operator|->
name|id
operator|==
literal|0
operator|&&
name|state
operator|->
name|creatorid
operator|==
literal|0
condition|)
block|{
name|state
operator|->
name|id
operator|=
name|htobe64
argument_list|(
name|pf_status
operator|.
name|stateid
operator|++
argument_list|)
expr_stmt|;
name|state
operator|->
name|creatorid
operator|=
name|pf_status
operator|.
name|hostid
expr_stmt|;
block|}
if|if
condition|(
name|RB_INSERT
argument_list|(
name|pf_state_tree_id
argument_list|,
operator|&
name|tree_id
argument_list|,
name|state
argument_list|)
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|pf_status
operator|.
name|debug
operator|>=
name|PF_DEBUG_MISC
condition|)
block|{
ifdef|#
directive|ifdef
name|__FreeBSD__
name|printf
argument_list|(
literal|"pf: state insert failed: "
literal|"id: %016llx creatorid: %08x"
argument_list|,
operator|(
name|long
name|long
operator|)
name|be64toh
argument_list|(
name|state
operator|->
name|id
argument_list|)
argument_list|,
name|ntohl
argument_list|(
name|state
operator|->
name|creatorid
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|printf
argument_list|(
literal|"pf: state insert failed: "
literal|"id: %016llx creatorid: %08x"
argument_list|,
name|betoh64
argument_list|(
name|state
operator|->
name|id
argument_list|)
argument_list|,
name|ntohl
argument_list|(
name|state
operator|->
name|creatorid
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|state
operator|->
name|sync_flags
operator|&
name|PFSTATE_FROMSYNC
condition|)
name|printf
argument_list|(
literal|" (from sync)"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|RB_REMOVE
argument_list|(
name|pf_state_tree_lan_ext
argument_list|,
operator|&
name|kif
operator|->
name|pfik_lan_ext
argument_list|,
name|state
argument_list|)
expr_stmt|;
name|RB_REMOVE
argument_list|(
name|pf_state_tree_ext_gwy
argument_list|,
operator|&
name|kif
operator|->
name|pfik_ext_gwy
argument_list|,
name|state
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|TAILQ_INSERT_HEAD
argument_list|(
operator|&
name|state_updates
argument_list|,
name|state
argument_list|,
name|u
operator|.
name|s
operator|.
name|entry_updates
argument_list|)
expr_stmt|;
name|pf_status
operator|.
name|fcounters
index|[
name|FCNT_STATE_INSERT
index|]
operator|++
expr_stmt|;
name|pf_status
operator|.
name|states
operator|++
expr_stmt|;
name|pfi_attach_state
argument_list|(
name|kif
argument_list|)
expr_stmt|;
if|#
directive|if
name|NPFSYNC
name|pfsync_insert_state
argument_list|(
name|state
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|pf_purge_timeout
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|__FreeBSD__
name|struct
name|callout
modifier|*
name|to
init|=
name|arg
decl_stmt|;
else|#
directive|else
name|struct
name|timeout
modifier|*
name|to
init|=
name|arg
decl_stmt|;
endif|#
directive|endif
name|int
name|s
decl_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
name|PF_LOCK
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|s
operator|=
name|splsoftnet
argument_list|()
expr_stmt|;
name|pf_purge_expired_states
argument_list|()
expr_stmt|;
name|pf_purge_expired_fragments
argument_list|()
expr_stmt|;
name|pf_purge_expired_src_nodes
argument_list|()
expr_stmt|;
name|splx
argument_list|(
name|s
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
name|PF_UNLOCK
argument_list|()
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|__FreeBSD__
name|callout_reset
argument_list|(
name|to
argument_list|,
name|pf_default_rule
operator|.
name|timeout
index|[
name|PFTM_INTERVAL
index|]
operator|*
name|hz
argument_list|,
name|pf_purge_timeout
argument_list|,
name|to
argument_list|)
expr_stmt|;
else|#
directive|else
name|timeout_add
argument_list|(
name|to
argument_list|,
name|pf_default_rule
operator|.
name|timeout
index|[
name|PFTM_INTERVAL
index|]
operator|*
name|hz
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
name|u_int32_t
name|pf_state_expires
parameter_list|(
specifier|const
name|struct
name|pf_state
modifier|*
name|state
parameter_list|)
block|{
name|u_int32_t
name|timeout
decl_stmt|;
name|u_int32_t
name|start
decl_stmt|;
name|u_int32_t
name|end
decl_stmt|;
name|u_int32_t
name|states
decl_stmt|;
comment|/* handle all PFTM_*> PFTM_MAX here */
if|if
condition|(
name|state
operator|->
name|timeout
operator|==
name|PFTM_PURGE
condition|)
return|return
operator|(
name|time_second
operator|)
return|;
if|if
condition|(
name|state
operator|->
name|timeout
operator|==
name|PFTM_UNTIL_PACKET
condition|)
return|return
operator|(
literal|0
operator|)
return|;
ifdef|#
directive|ifdef
name|__FreeBSD__
name|KASSERT
argument_list|(
operator|(
name|state
operator|->
name|timeout
operator|<
name|PFTM_MAX
operator|)
argument_list|,
operator|(
literal|"pf_state_expires: timeout> PFTM_MAX"
operator|)
argument_list|)
expr_stmt|;
else|#
directive|else
name|KASSERT
argument_list|(
name|state
operator|->
name|timeout
operator|<
name|PFTM_MAX
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|timeout
operator|=
name|state
operator|->
name|rule
operator|.
name|ptr
operator|->
name|timeout
index|[
name|state
operator|->
name|timeout
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|timeout
condition|)
name|timeout
operator|=
name|pf_default_rule
operator|.
name|timeout
index|[
name|state
operator|->
name|timeout
index|]
expr_stmt|;
name|start
operator|=
name|state
operator|->
name|rule
operator|.
name|ptr
operator|->
name|timeout
index|[
name|PFTM_ADAPTIVE_START
index|]
expr_stmt|;
if|if
condition|(
name|start
condition|)
block|{
name|end
operator|=
name|state
operator|->
name|rule
operator|.
name|ptr
operator|->
name|timeout
index|[
name|PFTM_ADAPTIVE_END
index|]
expr_stmt|;
name|states
operator|=
name|state
operator|->
name|rule
operator|.
name|ptr
operator|->
name|states
expr_stmt|;
block|}
else|else
block|{
name|start
operator|=
name|pf_default_rule
operator|.
name|timeout
index|[
name|PFTM_ADAPTIVE_START
index|]
expr_stmt|;
name|end
operator|=
name|pf_default_rule
operator|.
name|timeout
index|[
name|PFTM_ADAPTIVE_END
index|]
expr_stmt|;
name|states
operator|=
name|pf_status
operator|.
name|states
expr_stmt|;
block|}
if|if
condition|(
name|end
operator|&&
name|states
operator|>
name|start
operator|&&
name|start
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|states
operator|<
name|end
condition|)
return|return
operator|(
name|state
operator|->
name|expire
operator|+
name|timeout
operator|*
operator|(
name|end
operator|-
name|states
operator|)
operator|/
operator|(
name|end
operator|-
name|start
operator|)
operator|)
return|;
else|else
return|return
operator|(
name|time_second
operator|)
return|;
block|}
return|return
operator|(
name|state
operator|->
name|expire
operator|+
name|timeout
operator|)
return|;
block|}
end_function

begin_function
name|void
name|pf_purge_expired_src_nodes
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|pf_src_node
modifier|*
name|cur
decl_stmt|,
modifier|*
name|next
decl_stmt|;
for|for
control|(
name|cur
operator|=
name|RB_MIN
argument_list|(
name|pf_src_tree
argument_list|,
operator|&
name|tree_src_tracking
argument_list|)
init|;
name|cur
condition|;
name|cur
operator|=
name|next
control|)
block|{
name|next
operator|=
name|RB_NEXT
argument_list|(
name|pf_src_tree
argument_list|,
operator|&
name|tree_src_tracking
argument_list|,
name|cur
argument_list|)
expr_stmt|;
if|if
condition|(
name|cur
operator|->
name|states
operator|<=
literal|0
operator|&&
name|cur
operator|->
name|expire
operator|<=
name|time_second
condition|)
block|{
if|if
condition|(
name|cur
operator|->
name|rule
operator|.
name|ptr
operator|!=
name|NULL
condition|)
block|{
name|cur
operator|->
name|rule
operator|.
name|ptr
operator|->
name|src_nodes
operator|--
expr_stmt|;
if|if
condition|(
name|cur
operator|->
name|rule
operator|.
name|ptr
operator|->
name|states
operator|<=
literal|0
operator|&&
name|cur
operator|->
name|rule
operator|.
name|ptr
operator|->
name|max_src_nodes
operator|<=
literal|0
condition|)
name|pf_rm_rule
argument_list|(
name|NULL
argument_list|,
name|cur
operator|->
name|rule
operator|.
name|ptr
argument_list|)
expr_stmt|;
block|}
name|RB_REMOVE
argument_list|(
name|pf_src_tree
argument_list|,
operator|&
name|tree_src_tracking
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|pf_status
operator|.
name|scounters
index|[
name|SCNT_SRC_NODE_REMOVALS
index|]
operator|++
expr_stmt|;
name|pf_status
operator|.
name|src_nodes
operator|--
expr_stmt|;
name|pool_put
argument_list|(
operator|&
name|pf_src_tree_pl
argument_list|,
name|cur
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|pf_src_tree_remove_state
parameter_list|(
name|struct
name|pf_state
modifier|*
name|s
parameter_list|)
block|{
name|u_int32_t
name|timeout
decl_stmt|;
if|if
condition|(
name|s
operator|->
name|src_node
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|s
operator|->
name|proto
operator|==
name|IPPROTO_TCP
condition|)
block|{
ifdef|#
directive|ifdef
name|__FreeBSD__
if|if
condition|(
name|s
operator|->
name|local_flags
operator|&
name|PFSTATE_SRC_CONN
condition|)
else|#
directive|else
if|if
condition|(
name|s
operator|->
name|src
operator|.
name|state
operator|==
name|PF_TCPS_PROXY_DST
operator|||
name|s
operator|->
name|timeout
operator|>=
name|PFTM_TCP_ESTABLISHED
condition|)
endif|#
directive|endif
operator|--
name|s
operator|->
name|src_node
operator|->
name|conn
expr_stmt|;
block|}
if|if
condition|(
operator|--
name|s
operator|->
name|src_node
operator|->
name|states
operator|<=
literal|0
condition|)
block|{
name|timeout
operator|=
name|s
operator|->
name|rule
operator|.
name|ptr
operator|->
name|timeout
index|[
name|PFTM_SRC_NODE
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|timeout
condition|)
name|timeout
operator|=
name|pf_default_rule
operator|.
name|timeout
index|[
name|PFTM_SRC_NODE
index|]
expr_stmt|;
name|s
operator|->
name|src_node
operator|->
name|expire
operator|=
name|time_second
operator|+
name|timeout
expr_stmt|;
block|}
block|}
if|if
condition|(
name|s
operator|->
name|nat_src_node
operator|!=
name|s
operator|->
name|src_node
operator|&&
name|s
operator|->
name|nat_src_node
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|--
name|s
operator|->
name|nat_src_node
operator|->
name|states
operator|<=
literal|0
condition|)
block|{
name|timeout
operator|=
name|s
operator|->
name|rule
operator|.
name|ptr
operator|->
name|timeout
index|[
name|PFTM_SRC_NODE
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|timeout
condition|)
name|timeout
operator|=
name|pf_default_rule
operator|.
name|timeout
index|[
name|PFTM_SRC_NODE
index|]
expr_stmt|;
name|s
operator|->
name|nat_src_node
operator|->
name|expire
operator|=
name|time_second
operator|+
name|timeout
expr_stmt|;
block|}
block|}
name|s
operator|->
name|src_node
operator|=
name|s
operator|->
name|nat_src_node
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|void
name|pf_purge_expired_state
parameter_list|(
name|struct
name|pf_state
modifier|*
name|cur
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|__FreeBSD__
if|if
condition|(
name|cur
operator|->
name|local_flags
operator|&
name|PFSTATE_EXPIRING
condition|)
return|return;
name|cur
operator|->
name|local_flags
operator||=
name|PFSTATE_EXPIRING
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|cur
operator|->
name|src
operator|.
name|state
operator|==
name|PF_TCPS_PROXY_DST
condition|)
name|pf_send_tcp
argument_list|(
name|cur
operator|->
name|rule
operator|.
name|ptr
argument_list|,
name|cur
operator|->
name|af
argument_list|,
operator|&
name|cur
operator|->
name|ext
operator|.
name|addr
argument_list|,
operator|&
name|cur
operator|->
name|lan
operator|.
name|addr
argument_list|,
name|cur
operator|->
name|ext
operator|.
name|port
argument_list|,
name|cur
operator|->
name|lan
operator|.
name|port
argument_list|,
name|cur
operator|->
name|src
operator|.
name|seqhi
argument_list|,
name|cur
operator|->
name|src
operator|.
name|seqlo
operator|+
literal|1
argument_list|,
name|TH_RST
operator||
name|TH_ACK
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|RB_REMOVE
argument_list|(
name|pf_state_tree_ext_gwy
argument_list|,
operator|&
name|cur
operator|->
name|u
operator|.
name|s
operator|.
name|kif
operator|->
name|pfik_ext_gwy
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|RB_REMOVE
argument_list|(
name|pf_state_tree_lan_ext
argument_list|,
operator|&
name|cur
operator|->
name|u
operator|.
name|s
operator|.
name|kif
operator|->
name|pfik_lan_ext
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|RB_REMOVE
argument_list|(
name|pf_state_tree_id
argument_list|,
operator|&
name|tree_id
argument_list|,
name|cur
argument_list|)
expr_stmt|;
if|#
directive|if
name|NPFSYNC
name|pfsync_delete_state
argument_list|(
name|cur
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|pf_src_tree_remove_state
argument_list|(
name|cur
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|cur
operator|->
name|rule
operator|.
name|ptr
operator|->
name|states
operator|<=
literal|0
operator|&&
name|cur
operator|->
name|rule
operator|.
name|ptr
operator|->
name|src_nodes
operator|<=
literal|0
condition|)
name|pf_rm_rule
argument_list|(
name|NULL
argument_list|,
name|cur
operator|->
name|rule
operator|.
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|cur
operator|->
name|nat_rule
operator|.
name|ptr
operator|!=
name|NULL
condition|)
if|if
condition|(
operator|--
name|cur
operator|->
name|nat_rule
operator|.
name|ptr
operator|->
name|states
operator|<=
literal|0
operator|&&
name|cur
operator|->
name|nat_rule
operator|.
name|ptr
operator|->
name|src_nodes
operator|<=
literal|0
condition|)
name|pf_rm_rule
argument_list|(
name|NULL
argument_list|,
name|cur
operator|->
name|nat_rule
operator|.
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|cur
operator|->
name|anchor
operator|.
name|ptr
operator|!=
name|NULL
condition|)
if|if
condition|(
operator|--
name|cur
operator|->
name|anchor
operator|.
name|ptr
operator|->
name|states
operator|<=
literal|0
condition|)
name|pf_rm_rule
argument_list|(
name|NULL
argument_list|,
name|cur
operator|->
name|anchor
operator|.
name|ptr
argument_list|)
expr_stmt|;
name|pf_normalize_tcp_cleanup
argument_list|(
name|cur
argument_list|)
expr_stmt|;
name|pfi_detach_state
argument_list|(
name|cur
operator|->
name|u
operator|.
name|s
operator|.
name|kif
argument_list|)
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|state_updates
argument_list|,
name|cur
argument_list|,
name|u
operator|.
name|s
operator|.
name|entry_updates
argument_list|)
expr_stmt|;
if|if
condition|(
name|cur
operator|->
name|tag
condition|)
name|pf_tag_unref
argument_list|(
name|cur
operator|->
name|tag
argument_list|)
expr_stmt|;
name|pool_put
argument_list|(
operator|&
name|pf_state_pl
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|pf_status
operator|.
name|fcounters
index|[
name|FCNT_STATE_REMOVALS
index|]
operator|++
expr_stmt|;
name|pf_status
operator|.
name|states
operator|--
expr_stmt|;
block|}
end_function

begin_function
name|void
name|pf_purge_expired_states
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|pf_state
modifier|*
name|cur
decl_stmt|,
modifier|*
name|next
decl_stmt|;
for|for
control|(
name|cur
operator|=
name|RB_MIN
argument_list|(
name|pf_state_tree_id
argument_list|,
operator|&
name|tree_id
argument_list|)
init|;
name|cur
condition|;
name|cur
operator|=
name|next
control|)
block|{
name|next
operator|=
name|RB_NEXT
argument_list|(
name|pf_state_tree_id
argument_list|,
operator|&
name|tree_id
argument_list|,
name|cur
argument_list|)
expr_stmt|;
if|if
condition|(
name|pf_state_expires
argument_list|(
name|cur
argument_list|)
operator|<=
name|time_second
condition|)
name|pf_purge_expired_state
argument_list|(
name|cur
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|pf_tbladdr_setup
parameter_list|(
name|struct
name|pf_ruleset
modifier|*
name|rs
parameter_list|,
name|struct
name|pf_addr_wrap
modifier|*
name|aw
parameter_list|)
block|{
if|if
condition|(
name|aw
operator|->
name|type
operator|!=
name|PF_ADDR_TABLE
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
name|aw
operator|->
name|p
operator|.
name|tbl
operator|=
name|pfr_attach_table
argument_list|(
name|rs
argument_list|,
name|aw
operator|->
name|v
operator|.
name|tblname
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|pf_tbladdr_remove
parameter_list|(
name|struct
name|pf_addr_wrap
modifier|*
name|aw
parameter_list|)
block|{
if|if
condition|(
name|aw
operator|->
name|type
operator|!=
name|PF_ADDR_TABLE
operator|||
name|aw
operator|->
name|p
operator|.
name|tbl
operator|==
name|NULL
condition|)
return|return;
name|pfr_detach_table
argument_list|(
name|aw
operator|->
name|p
operator|.
name|tbl
argument_list|)
expr_stmt|;
name|aw
operator|->
name|p
operator|.
name|tbl
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|void
name|pf_tbladdr_copyout
parameter_list|(
name|struct
name|pf_addr_wrap
modifier|*
name|aw
parameter_list|)
block|{
name|struct
name|pfr_ktable
modifier|*
name|kt
init|=
name|aw
operator|->
name|p
operator|.
name|tbl
decl_stmt|;
if|if
condition|(
name|aw
operator|->
name|type
operator|!=
name|PF_ADDR_TABLE
operator|||
name|kt
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
operator|!
operator|(
name|kt
operator|->
name|pfrkt_flags
operator|&
name|PFR_TFLAG_ACTIVE
operator|)
operator|&&
name|kt
operator|->
name|pfrkt_root
operator|!=
name|NULL
condition|)
name|kt
operator|=
name|kt
operator|->
name|pfrkt_root
expr_stmt|;
name|aw
operator|->
name|p
operator|.
name|tbl
operator|=
name|NULL
expr_stmt|;
name|aw
operator|->
name|p
operator|.
name|tblcnt
operator|=
operator|(
name|kt
operator|->
name|pfrkt_flags
operator|&
name|PFR_TFLAG_ACTIVE
operator|)
condition|?
name|kt
operator|->
name|pfrkt_cnt
else|:
operator|-
literal|1
expr_stmt|;
block|}
end_function

begin_function
name|void
name|pf_print_host
parameter_list|(
name|struct
name|pf_addr
modifier|*
name|addr
parameter_list|,
name|u_int16_t
name|p
parameter_list|,
name|sa_family_t
name|af
parameter_list|)
block|{
switch|switch
condition|(
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
block|{
name|u_int32_t
name|a
init|=
name|ntohl
argument_list|(
name|addr
operator|->
name|addr32
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|printf
argument_list|(
literal|"%u.%u.%u.%u"
argument_list|,
operator|(
name|a
operator|>>
literal|24
operator|)
operator|&
literal|255
argument_list|,
operator|(
name|a
operator|>>
literal|16
operator|)
operator|&
literal|255
argument_list|,
operator|(
name|a
operator|>>
literal|8
operator|)
operator|&
literal|255
argument_list|,
name|a
operator|&
literal|255
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
block|{
name|p
operator|=
name|ntohs
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|":%u"
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
block|{
name|u_int16_t
name|b
decl_stmt|;
name|u_int8_t
name|i
decl_stmt|,
name|curstart
init|=
literal|255
decl_stmt|,
name|curend
init|=
literal|0
decl_stmt|,
name|maxstart
init|=
literal|0
decl_stmt|,
name|maxend
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|addr
operator|->
name|addr16
index|[
name|i
index|]
condition|)
block|{
if|if
condition|(
name|curstart
operator|==
literal|255
condition|)
name|curstart
operator|=
name|i
expr_stmt|;
else|else
name|curend
operator|=
name|i
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|curstart
condition|)
block|{
if|if
condition|(
operator|(
name|curend
operator|-
name|curstart
operator|)
operator|>
operator|(
name|maxend
operator|-
name|maxstart
operator|)
condition|)
block|{
name|maxstart
operator|=
name|curstart
expr_stmt|;
name|maxend
operator|=
name|curend
expr_stmt|;
name|curstart
operator|=
literal|255
expr_stmt|;
block|}
block|}
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|>=
name|maxstart
operator|&&
name|i
operator|<=
name|maxend
condition|)
block|{
if|if
condition|(
name|maxend
operator|!=
literal|7
condition|)
block|{
if|if
condition|(
name|i
operator|==
name|maxstart
condition|)
name|printf
argument_list|(
literal|":"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|i
operator|==
name|maxend
condition|)
name|printf
argument_list|(
literal|":"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|b
operator|=
name|ntohs
argument_list|(
name|addr
operator|->
name|addr16
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%x"
argument_list|,
name|b
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|7
condition|)
name|printf
argument_list|(
literal|":"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|p
condition|)
block|{
name|p
operator|=
name|ntohs
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"[%u]"
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
endif|#
directive|endif
comment|/* INET6 */
block|}
block|}
end_function

begin_function
name|void
name|pf_print_state
parameter_list|(
name|struct
name|pf_state
modifier|*
name|s
parameter_list|)
block|{
switch|switch
condition|(
name|s
operator|->
name|proto
condition|)
block|{
case|case
name|IPPROTO_TCP
case|:
name|printf
argument_list|(
literal|"TCP "
argument_list|)
expr_stmt|;
break|break;
case|case
name|IPPROTO_UDP
case|:
name|printf
argument_list|(
literal|"UDP "
argument_list|)
expr_stmt|;
break|break;
case|case
name|IPPROTO_ICMP
case|:
name|printf
argument_list|(
literal|"ICMP "
argument_list|)
expr_stmt|;
break|break;
case|case
name|IPPROTO_ICMPV6
case|:
name|printf
argument_list|(
literal|"ICMPV6 "
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printf
argument_list|(
literal|"%u "
argument_list|,
name|s
operator|->
name|proto
argument_list|)
expr_stmt|;
break|break;
block|}
name|pf_print_host
argument_list|(
operator|&
name|s
operator|->
name|lan
operator|.
name|addr
argument_list|,
name|s
operator|->
name|lan
operator|.
name|port
argument_list|,
name|s
operator|->
name|af
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|pf_print_host
argument_list|(
operator|&
name|s
operator|->
name|gwy
operator|.
name|addr
argument_list|,
name|s
operator|->
name|gwy
operator|.
name|port
argument_list|,
name|s
operator|->
name|af
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|pf_print_host
argument_list|(
operator|&
name|s
operator|->
name|ext
operator|.
name|addr
argument_list|,
name|s
operator|->
name|ext
operator|.
name|port
argument_list|,
name|s
operator|->
name|af
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" [lo=%u high=%u win=%u modulator=%u"
argument_list|,
name|s
operator|->
name|src
operator|.
name|seqlo
argument_list|,
name|s
operator|->
name|src
operator|.
name|seqhi
argument_list|,
name|s
operator|->
name|src
operator|.
name|max_win
argument_list|,
name|s
operator|->
name|src
operator|.
name|seqdiff
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|src
operator|.
name|wscale
operator|&&
name|s
operator|->
name|dst
operator|.
name|wscale
condition|)
name|printf
argument_list|(
literal|" wscale=%u"
argument_list|,
name|s
operator|->
name|src
operator|.
name|wscale
operator|&
name|PF_WSCALE_MASK
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" [lo=%u high=%u win=%u modulator=%u"
argument_list|,
name|s
operator|->
name|dst
operator|.
name|seqlo
argument_list|,
name|s
operator|->
name|dst
operator|.
name|seqhi
argument_list|,
name|s
operator|->
name|dst
operator|.
name|max_win
argument_list|,
name|s
operator|->
name|dst
operator|.
name|seqdiff
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|src
operator|.
name|wscale
operator|&&
name|s
operator|->
name|dst
operator|.
name|wscale
condition|)
name|printf
argument_list|(
literal|" wscale=%u"
argument_list|,
name|s
operator|->
name|dst
operator|.
name|wscale
operator|&
name|PF_WSCALE_MASK
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"]"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %u:%u"
argument_list|,
name|s
operator|->
name|src
operator|.
name|state
argument_list|,
name|s
operator|->
name|dst
operator|.
name|state
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|pf_print_flags
parameter_list|(
name|u_int8_t
name|f
parameter_list|)
block|{
if|if
condition|(
name|f
condition|)
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|&
name|TH_FIN
condition|)
name|printf
argument_list|(
literal|"F"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|&
name|TH_SYN
condition|)
name|printf
argument_list|(
literal|"S"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|&
name|TH_RST
condition|)
name|printf
argument_list|(
literal|"R"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|&
name|TH_PUSH
condition|)
name|printf
argument_list|(
literal|"P"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|&
name|TH_ACK
condition|)
name|printf
argument_list|(
literal|"A"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|&
name|TH_URG
condition|)
name|printf
argument_list|(
literal|"U"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|&
name|TH_ECE
condition|)
name|printf
argument_list|(
literal|"E"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|&
name|TH_CWR
condition|)
name|printf
argument_list|(
literal|"W"
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|PF_SET_SKIP_STEPS
parameter_list|(
name|i
parameter_list|)
define|\
value|do {							\ 		while (head[i] != cur) {			\ 			head[i]->skip[i].ptr = cur;		\ 			head[i] = TAILQ_NEXT(head[i], entries);	\ 		}						\ 	} while (0)
end_define

begin_function
name|void
name|pf_calc_skip_steps
parameter_list|(
name|struct
name|pf_rulequeue
modifier|*
name|rules
parameter_list|)
block|{
name|struct
name|pf_rule
modifier|*
name|cur
decl_stmt|,
modifier|*
name|prev
decl_stmt|,
modifier|*
name|head
index|[
name|PF_SKIP_COUNT
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|cur
operator|=
name|TAILQ_FIRST
argument_list|(
name|rules
argument_list|)
expr_stmt|;
name|prev
operator|=
name|cur
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|PF_SKIP_COUNT
condition|;
operator|++
name|i
control|)
name|head
index|[
name|i
index|]
operator|=
name|cur
expr_stmt|;
while|while
condition|(
name|cur
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|cur
operator|->
name|kif
operator|!=
name|prev
operator|->
name|kif
operator|||
name|cur
operator|->
name|ifnot
operator|!=
name|prev
operator|->
name|ifnot
condition|)
name|PF_SET_SKIP_STEPS
argument_list|(
name|PF_SKIP_IFP
argument_list|)
expr_stmt|;
if|if
condition|(
name|cur
operator|->
name|direction
operator|!=
name|prev
operator|->
name|direction
condition|)
name|PF_SET_SKIP_STEPS
argument_list|(
name|PF_SKIP_DIR
argument_list|)
expr_stmt|;
if|if
condition|(
name|cur
operator|->
name|af
operator|!=
name|prev
operator|->
name|af
condition|)
name|PF_SET_SKIP_STEPS
argument_list|(
name|PF_SKIP_AF
argument_list|)
expr_stmt|;
if|if
condition|(
name|cur
operator|->
name|proto
operator|!=
name|prev
operator|->
name|proto
condition|)
name|PF_SET_SKIP_STEPS
argument_list|(
name|PF_SKIP_PROTO
argument_list|)
expr_stmt|;
if|if
condition|(
name|cur
operator|->
name|src
operator|.
name|neg
operator|!=
name|prev
operator|->
name|src
operator|.
name|neg
operator|||
name|pf_addr_wrap_neq
argument_list|(
operator|&
name|cur
operator|->
name|src
operator|.
name|addr
argument_list|,
operator|&
name|prev
operator|->
name|src
operator|.
name|addr
argument_list|)
condition|)
name|PF_SET_SKIP_STEPS
argument_list|(
name|PF_SKIP_SRC_ADDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|cur
operator|->
name|src
operator|.
name|port
index|[
literal|0
index|]
operator|!=
name|prev
operator|->
name|src
operator|.
name|port
index|[
literal|0
index|]
operator|||
name|cur
operator|->
name|src
operator|.
name|port
index|[
literal|1
index|]
operator|!=
name|prev
operator|->
name|src
operator|.
name|port
index|[
literal|1
index|]
operator|||
name|cur
operator|->
name|src
operator|.
name|port_op
operator|!=
name|prev
operator|->
name|src
operator|.
name|port_op
condition|)
name|PF_SET_SKIP_STEPS
argument_list|(
name|PF_SKIP_SRC_PORT
argument_list|)
expr_stmt|;
if|if
condition|(
name|cur
operator|->
name|dst
operator|.
name|neg
operator|!=
name|prev
operator|->
name|dst
operator|.
name|neg
operator|||
name|pf_addr_wrap_neq
argument_list|(
operator|&
name|cur
operator|->
name|dst
operator|.
name|addr
argument_list|,
operator|&
name|prev
operator|->
name|dst
operator|.
name|addr
argument_list|)
condition|)
name|PF_SET_SKIP_STEPS
argument_list|(
name|PF_SKIP_DST_ADDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|cur
operator|->
name|dst
operator|.
name|port
index|[
literal|0
index|]
operator|!=
name|prev
operator|->
name|dst
operator|.
name|port
index|[
literal|0
index|]
operator|||
name|cur
operator|->
name|dst
operator|.
name|port
index|[
literal|1
index|]
operator|!=
name|prev
operator|->
name|dst
operator|.
name|port
index|[
literal|1
index|]
operator|||
name|cur
operator|->
name|dst
operator|.
name|port_op
operator|!=
name|prev
operator|->
name|dst
operator|.
name|port_op
condition|)
name|PF_SET_SKIP_STEPS
argument_list|(
name|PF_SKIP_DST_PORT
argument_list|)
expr_stmt|;
name|prev
operator|=
name|cur
expr_stmt|;
name|cur
operator|=
name|TAILQ_NEXT
argument_list|(
name|cur
argument_list|,
name|entries
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|PF_SKIP_COUNT
condition|;
operator|++
name|i
control|)
name|PF_SET_SKIP_STEPS
argument_list|(
name|i
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|pf_addr_wrap_neq
parameter_list|(
name|struct
name|pf_addr_wrap
modifier|*
name|aw1
parameter_list|,
name|struct
name|pf_addr_wrap
modifier|*
name|aw2
parameter_list|)
block|{
if|if
condition|(
name|aw1
operator|->
name|type
operator|!=
name|aw2
operator|->
name|type
condition|)
return|return
operator|(
literal|1
operator|)
return|;
switch|switch
condition|(
name|aw1
operator|->
name|type
condition|)
block|{
case|case
name|PF_ADDR_ADDRMASK
case|:
if|if
condition|(
name|PF_ANEQ
argument_list|(
operator|&
name|aw1
operator|->
name|v
operator|.
name|a
operator|.
name|addr
argument_list|,
operator|&
name|aw2
operator|->
name|v
operator|.
name|a
operator|.
name|addr
argument_list|,
literal|0
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|PF_ANEQ
argument_list|(
operator|&
name|aw1
operator|->
name|v
operator|.
name|a
operator|.
name|mask
argument_list|,
operator|&
name|aw2
operator|->
name|v
operator|.
name|a
operator|.
name|mask
argument_list|,
literal|0
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|PF_ADDR_DYNIFTL
case|:
return|return
operator|(
name|aw1
operator|->
name|p
operator|.
name|dyn
operator|->
name|pfid_kt
operator|!=
name|aw2
operator|->
name|p
operator|.
name|dyn
operator|->
name|pfid_kt
operator|)
return|;
case|case
name|PF_ADDR_NOROUTE
case|:
return|return
operator|(
literal|0
operator|)
return|;
case|case
name|PF_ADDR_TABLE
case|:
return|return
operator|(
name|aw1
operator|->
name|p
operator|.
name|tbl
operator|!=
name|aw2
operator|->
name|p
operator|.
name|tbl
operator|)
return|;
default|default:
name|printf
argument_list|(
literal|"invalid address type: %d\n"
argument_list|,
name|aw1
operator|->
name|type
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
end_function

begin_function
name|u_int16_t
name|pf_cksum_fixup
parameter_list|(
name|u_int16_t
name|cksum
parameter_list|,
name|u_int16_t
name|old
parameter_list|,
name|u_int16_t
name|new
parameter_list|,
name|u_int8_t
name|udp
parameter_list|)
block|{
name|u_int32_t
name|l
decl_stmt|;
if|if
condition|(
name|udp
operator|&&
operator|!
name|cksum
condition|)
return|return
operator|(
literal|0x0000
operator|)
return|;
name|l
operator|=
name|cksum
operator|+
name|old
operator|-
name|new
expr_stmt|;
name|l
operator|=
operator|(
name|l
operator|>>
literal|16
operator|)
operator|+
operator|(
name|l
operator|&
literal|65535
operator|)
expr_stmt|;
name|l
operator|=
name|l
operator|&
literal|65535
expr_stmt|;
if|if
condition|(
name|udp
operator|&&
operator|!
name|l
condition|)
return|return
operator|(
literal|0xFFFF
operator|)
return|;
return|return
operator|(
name|l
operator|)
return|;
block|}
end_function

begin_function
name|void
name|pf_change_ap
parameter_list|(
name|struct
name|pf_addr
modifier|*
name|a
parameter_list|,
name|u_int16_t
modifier|*
name|p
parameter_list|,
name|u_int16_t
modifier|*
name|ic
parameter_list|,
name|u_int16_t
modifier|*
name|pc
parameter_list|,
name|struct
name|pf_addr
modifier|*
name|an
parameter_list|,
name|u_int16_t
name|pn
parameter_list|,
name|u_int8_t
name|u
parameter_list|,
name|sa_family_t
name|af
parameter_list|)
block|{
name|struct
name|pf_addr
name|ao
decl_stmt|;
name|u_int16_t
name|po
init|=
operator|*
name|p
decl_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|ao
argument_list|,
name|a
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|PF_ACPY
argument_list|(
name|a
argument_list|,
name|an
argument_list|,
name|af
argument_list|)
expr_stmt|;
operator|*
name|p
operator|=
name|pn
expr_stmt|;
switch|switch
condition|(
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
operator|*
name|ic
operator|=
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
operator|*
name|ic
argument_list|,
name|ao
operator|.
name|addr16
index|[
literal|0
index|]
argument_list|,
name|an
operator|->
name|addr16
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ao
operator|.
name|addr16
index|[
literal|1
index|]
argument_list|,
name|an
operator|->
name|addr16
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|p
operator|=
name|pn
expr_stmt|;
operator|*
name|pc
operator|=
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
operator|*
name|pc
argument_list|,
name|ao
operator|.
name|addr16
index|[
literal|0
index|]
argument_list|,
name|an
operator|->
name|addr16
index|[
literal|0
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|ao
operator|.
name|addr16
index|[
literal|1
index|]
argument_list|,
name|an
operator|->
name|addr16
index|[
literal|1
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|po
argument_list|,
name|pn
argument_list|,
name|u
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
operator|*
name|pc
operator|=
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
operator|*
name|pc
argument_list|,
name|ao
operator|.
name|addr16
index|[
literal|0
index|]
argument_list|,
name|an
operator|->
name|addr16
index|[
literal|0
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|ao
operator|.
name|addr16
index|[
literal|1
index|]
argument_list|,
name|an
operator|->
name|addr16
index|[
literal|1
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|ao
operator|.
name|addr16
index|[
literal|2
index|]
argument_list|,
name|an
operator|->
name|addr16
index|[
literal|2
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|ao
operator|.
name|addr16
index|[
literal|3
index|]
argument_list|,
name|an
operator|->
name|addr16
index|[
literal|3
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|ao
operator|.
name|addr16
index|[
literal|4
index|]
argument_list|,
name|an
operator|->
name|addr16
index|[
literal|4
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|ao
operator|.
name|addr16
index|[
literal|5
index|]
argument_list|,
name|an
operator|->
name|addr16
index|[
literal|5
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|ao
operator|.
name|addr16
index|[
literal|6
index|]
argument_list|,
name|an
operator|->
name|addr16
index|[
literal|6
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|ao
operator|.
name|addr16
index|[
literal|7
index|]
argument_list|,
name|an
operator|->
name|addr16
index|[
literal|7
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|po
argument_list|,
name|pn
argument_list|,
name|u
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
block|}
end_function

begin_comment
comment|/* Changes a u_int32_t.  Uses a void * so there are no align restrictions */
end_comment

begin_function
name|void
name|pf_change_a
parameter_list|(
name|void
modifier|*
name|a
parameter_list|,
name|u_int16_t
modifier|*
name|c
parameter_list|,
name|u_int32_t
name|an
parameter_list|,
name|u_int8_t
name|u
parameter_list|)
block|{
name|u_int32_t
name|ao
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|ao
argument_list|,
name|a
argument_list|,
sizeof|sizeof
argument_list|(
name|ao
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|a
argument_list|,
operator|&
name|an
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|c
operator|=
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
operator|*
name|c
argument_list|,
name|ao
operator|/
literal|65536
argument_list|,
name|an
operator|/
literal|65536
argument_list|,
name|u
argument_list|)
argument_list|,
name|ao
operator|%
literal|65536
argument_list|,
name|an
operator|%
literal|65536
argument_list|,
name|u
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|INET6
end_ifdef

begin_function
name|void
name|pf_change_a6
parameter_list|(
name|struct
name|pf_addr
modifier|*
name|a
parameter_list|,
name|u_int16_t
modifier|*
name|c
parameter_list|,
name|struct
name|pf_addr
modifier|*
name|an
parameter_list|,
name|u_int8_t
name|u
parameter_list|)
block|{
name|struct
name|pf_addr
name|ao
decl_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|ao
argument_list|,
name|a
argument_list|,
name|AF_INET6
argument_list|)
expr_stmt|;
name|PF_ACPY
argument_list|(
name|a
argument_list|,
name|an
argument_list|,
name|AF_INET6
argument_list|)
expr_stmt|;
operator|*
name|c
operator|=
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
operator|*
name|c
argument_list|,
name|ao
operator|.
name|addr16
index|[
literal|0
index|]
argument_list|,
name|an
operator|->
name|addr16
index|[
literal|0
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|ao
operator|.
name|addr16
index|[
literal|1
index|]
argument_list|,
name|an
operator|->
name|addr16
index|[
literal|1
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|ao
operator|.
name|addr16
index|[
literal|2
index|]
argument_list|,
name|an
operator|->
name|addr16
index|[
literal|2
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|ao
operator|.
name|addr16
index|[
literal|3
index|]
argument_list|,
name|an
operator|->
name|addr16
index|[
literal|3
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|ao
operator|.
name|addr16
index|[
literal|4
index|]
argument_list|,
name|an
operator|->
name|addr16
index|[
literal|4
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|ao
operator|.
name|addr16
index|[
literal|5
index|]
argument_list|,
name|an
operator|->
name|addr16
index|[
literal|5
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|ao
operator|.
name|addr16
index|[
literal|6
index|]
argument_list|,
name|an
operator|->
name|addr16
index|[
literal|6
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|ao
operator|.
name|addr16
index|[
literal|7
index|]
argument_list|,
name|an
operator|->
name|addr16
index|[
literal|7
index|]
argument_list|,
name|u
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* INET6 */
end_comment

begin_function
name|void
name|pf_change_icmp
parameter_list|(
name|struct
name|pf_addr
modifier|*
name|ia
parameter_list|,
name|u_int16_t
modifier|*
name|ip
parameter_list|,
name|struct
name|pf_addr
modifier|*
name|oa
parameter_list|,
name|struct
name|pf_addr
modifier|*
name|na
parameter_list|,
name|u_int16_t
name|np
parameter_list|,
name|u_int16_t
modifier|*
name|pc
parameter_list|,
name|u_int16_t
modifier|*
name|h2c
parameter_list|,
name|u_int16_t
modifier|*
name|ic
parameter_list|,
name|u_int16_t
modifier|*
name|hc
parameter_list|,
name|u_int8_t
name|u
parameter_list|,
name|sa_family_t
name|af
parameter_list|)
block|{
name|struct
name|pf_addr
name|oia
decl_stmt|,
name|ooa
decl_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|oia
argument_list|,
name|ia
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|ooa
argument_list|,
name|oa
argument_list|,
name|af
argument_list|)
expr_stmt|;
comment|/* Change inner protocol port, fix inner protocol checksum. */
if|if
condition|(
name|ip
operator|!=
name|NULL
condition|)
block|{
name|u_int16_t
name|oip
init|=
operator|*
name|ip
decl_stmt|;
name|u_int32_t
name|opc
init|=
literal|0
decl_stmt|;
comment|/* make the compiler happy */
if|if
condition|(
name|pc
operator|!=
name|NULL
condition|)
name|opc
operator|=
operator|*
name|pc
expr_stmt|;
operator|*
name|ip
operator|=
name|np
expr_stmt|;
if|if
condition|(
name|pc
operator|!=
name|NULL
condition|)
operator|*
name|pc
operator|=
name|pf_cksum_fixup
argument_list|(
operator|*
name|pc
argument_list|,
name|oip
argument_list|,
operator|*
name|ip
argument_list|,
name|u
argument_list|)
expr_stmt|;
operator|*
name|ic
operator|=
name|pf_cksum_fixup
argument_list|(
operator|*
name|ic
argument_list|,
name|oip
argument_list|,
operator|*
name|ip
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|pc
operator|!=
name|NULL
condition|)
operator|*
name|ic
operator|=
name|pf_cksum_fixup
argument_list|(
operator|*
name|ic
argument_list|,
name|opc
argument_list|,
operator|*
name|pc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* Change inner ip address, fix inner ip and icmp checksums. */
name|PF_ACPY
argument_list|(
name|ia
argument_list|,
name|na
argument_list|,
name|af
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
block|{
name|u_int32_t
name|oh2c
init|=
operator|*
name|h2c
decl_stmt|;
operator|*
name|h2c
operator|=
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
operator|*
name|h2c
argument_list|,
name|oia
operator|.
name|addr16
index|[
literal|0
index|]
argument_list|,
name|ia
operator|->
name|addr16
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
argument_list|,
name|oia
operator|.
name|addr16
index|[
literal|1
index|]
argument_list|,
name|ia
operator|->
name|addr16
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|ic
operator|=
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
operator|*
name|ic
argument_list|,
name|oia
operator|.
name|addr16
index|[
literal|0
index|]
argument_list|,
name|ia
operator|->
name|addr16
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
argument_list|,
name|oia
operator|.
name|addr16
index|[
literal|1
index|]
argument_list|,
name|ia
operator|->
name|addr16
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|ic
operator|=
name|pf_cksum_fixup
argument_list|(
operator|*
name|ic
argument_list|,
name|oh2c
argument_list|,
operator|*
name|h2c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
operator|*
name|ic
operator|=
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
operator|*
name|ic
argument_list|,
name|oia
operator|.
name|addr16
index|[
literal|0
index|]
argument_list|,
name|ia
operator|->
name|addr16
index|[
literal|0
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|oia
operator|.
name|addr16
index|[
literal|1
index|]
argument_list|,
name|ia
operator|->
name|addr16
index|[
literal|1
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|oia
operator|.
name|addr16
index|[
literal|2
index|]
argument_list|,
name|ia
operator|->
name|addr16
index|[
literal|2
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|oia
operator|.
name|addr16
index|[
literal|3
index|]
argument_list|,
name|ia
operator|->
name|addr16
index|[
literal|3
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|oia
operator|.
name|addr16
index|[
literal|4
index|]
argument_list|,
name|ia
operator|->
name|addr16
index|[
literal|4
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|oia
operator|.
name|addr16
index|[
literal|5
index|]
argument_list|,
name|ia
operator|->
name|addr16
index|[
literal|5
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|oia
operator|.
name|addr16
index|[
literal|6
index|]
argument_list|,
name|ia
operator|->
name|addr16
index|[
literal|6
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|oia
operator|.
name|addr16
index|[
literal|7
index|]
argument_list|,
name|ia
operator|->
name|addr16
index|[
literal|7
index|]
argument_list|,
name|u
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
comment|/* Change outer ip address, fix outer ip or icmpv6 checksum. */
name|PF_ACPY
argument_list|(
name|oa
argument_list|,
name|na
argument_list|,
name|af
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
operator|*
name|hc
operator|=
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
operator|*
name|hc
argument_list|,
name|ooa
operator|.
name|addr16
index|[
literal|0
index|]
argument_list|,
name|oa
operator|->
name|addr16
index|[
literal|0
index|]
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ooa
operator|.
name|addr16
index|[
literal|1
index|]
argument_list|,
name|oa
operator|->
name|addr16
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
operator|*
name|ic
operator|=
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
name|pf_cksum_fixup
argument_list|(
operator|*
name|ic
argument_list|,
name|ooa
operator|.
name|addr16
index|[
literal|0
index|]
argument_list|,
name|oa
operator|->
name|addr16
index|[
literal|0
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|ooa
operator|.
name|addr16
index|[
literal|1
index|]
argument_list|,
name|oa
operator|->
name|addr16
index|[
literal|1
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|ooa
operator|.
name|addr16
index|[
literal|2
index|]
argument_list|,
name|oa
operator|->
name|addr16
index|[
literal|2
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|ooa
operator|.
name|addr16
index|[
literal|3
index|]
argument_list|,
name|oa
operator|->
name|addr16
index|[
literal|3
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|ooa
operator|.
name|addr16
index|[
literal|4
index|]
argument_list|,
name|oa
operator|->
name|addr16
index|[
literal|4
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|ooa
operator|.
name|addr16
index|[
literal|5
index|]
argument_list|,
name|oa
operator|->
name|addr16
index|[
literal|5
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|ooa
operator|.
name|addr16
index|[
literal|6
index|]
argument_list|,
name|oa
operator|->
name|addr16
index|[
literal|6
index|]
argument_list|,
name|u
argument_list|)
argument_list|,
name|ooa
operator|.
name|addr16
index|[
literal|7
index|]
argument_list|,
name|oa
operator|->
name|addr16
index|[
literal|7
index|]
argument_list|,
name|u
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
block|}
end_function

begin_function
name|void
name|pf_send_tcp
parameter_list|(
specifier|const
name|struct
name|pf_rule
modifier|*
name|r
parameter_list|,
name|sa_family_t
name|af
parameter_list|,
specifier|const
name|struct
name|pf_addr
modifier|*
name|saddr
parameter_list|,
specifier|const
name|struct
name|pf_addr
modifier|*
name|daddr
parameter_list|,
name|u_int16_t
name|sport
parameter_list|,
name|u_int16_t
name|dport
parameter_list|,
name|u_int32_t
name|seq
parameter_list|,
name|u_int32_t
name|ack
parameter_list|,
name|u_int8_t
name|flags
parameter_list|,
name|u_int16_t
name|win
parameter_list|,
name|u_int16_t
name|mss
parameter_list|,
name|u_int8_t
name|ttl
parameter_list|,
name|int
name|tag
parameter_list|,
name|struct
name|ether_header
modifier|*
name|eh
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|m
decl_stmt|;
name|int
name|len
init|=
literal|0
decl_stmt|,
name|tlen
decl_stmt|;
comment|/* make the compiler happy */
ifdef|#
directive|ifdef
name|INET
name|struct
name|ip
modifier|*
name|h
init|=
name|NULL
decl_stmt|;
comment|/* make the compiler happy */
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
name|struct
name|ip6_hdr
modifier|*
name|h6
init|=
name|NULL
decl_stmt|;
comment|/* make the compiler happy */
endif|#
directive|endif
comment|/* INET6 */
name|struct
name|tcphdr
modifier|*
name|th
init|=
name|NULL
decl_stmt|;
comment|/* make the compiler happy */
name|char
modifier|*
name|opt
decl_stmt|;
comment|/* maximum segment size tcp option */
name|tlen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|tcphdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|mss
condition|)
name|tlen
operator|+=
literal|4
expr_stmt|;
switch|switch
condition|(
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
operator|+
name|tlen
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
operator|+
name|tlen
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
comment|/* create outgoing mbuf */
name|m
operator|=
name|m_gethdr
argument_list|(
name|M_DONTWAIT
argument_list|,
name|MT_HEADER
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|tag
condition|)
block|{
ifdef|#
directive|ifdef
name|__FreeBSD__
name|m
operator|->
name|m_flags
operator||=
name|M_SKIP_FIREWALL
expr_stmt|;
else|#
directive|else
name|struct
name|m_tag
modifier|*
name|mtag
decl_stmt|;
name|mtag
operator|=
name|m_tag_get
argument_list|(
name|PACKET_TAG_PF_GENERATED
argument_list|,
literal|0
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|mtag
operator|==
name|NULL
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
name|m_tag_prepend
argument_list|(
name|m
argument_list|,
name|mtag
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
ifdef|#
directive|ifdef
name|ALTQ
if|if
condition|(
name|r
operator|!=
name|NULL
operator|&&
name|r
operator|->
name|qid
condition|)
block|{
name|struct
name|m_tag
modifier|*
name|mtag
decl_stmt|;
name|struct
name|altq_tag
modifier|*
name|atag
decl_stmt|;
name|mtag
operator|=
name|m_tag_get
argument_list|(
name|PACKET_TAG_PF_QID
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|atag
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|mtag
operator|!=
name|NULL
condition|)
block|{
name|atag
operator|=
operator|(
expr|struct
name|altq_tag
operator|*
operator|)
operator|(
name|mtag
operator|+
literal|1
operator|)
expr_stmt|;
name|atag
operator|->
name|qid
operator|=
name|r
operator|->
name|qid
expr_stmt|;
comment|/* add hints for ecn */
name|atag
operator|->
name|af
operator|=
name|af
expr_stmt|;
name|atag
operator|->
name|hdr
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ip
operator|*
argument_list|)
expr_stmt|;
name|m_tag_prepend
argument_list|(
name|m
argument_list|,
name|mtag
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* ALTQ */
name|m
operator|->
name|m_data
operator|+=
name|max_linkhdr
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|=
name|m
operator|->
name|m_len
operator|=
name|len
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|rcvif
operator|=
name|NULL
expr_stmt|;
name|bzero
argument_list|(
name|m
operator|->
name|m_data
argument_list|,
name|len
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
name|h
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ip
operator|*
argument_list|)
expr_stmt|;
comment|/* IP header fields included in the TCP checksum */
name|h
operator|->
name|ip_p
operator|=
name|IPPROTO_TCP
expr_stmt|;
name|h
operator|->
name|ip_len
operator|=
name|htons
argument_list|(
name|tlen
argument_list|)
expr_stmt|;
name|h
operator|->
name|ip_src
operator|.
name|s_addr
operator|=
name|saddr
operator|->
name|v4
operator|.
name|s_addr
expr_stmt|;
name|h
operator|->
name|ip_dst
operator|.
name|s_addr
operator|=
name|daddr
operator|->
name|v4
operator|.
name|s_addr
expr_stmt|;
name|th
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|h
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
operator|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
name|h6
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ip6_hdr
operator|*
argument_list|)
expr_stmt|;
comment|/* IP header fields included in the TCP checksum */
name|h6
operator|->
name|ip6_nxt
operator|=
name|IPPROTO_TCP
expr_stmt|;
name|h6
operator|->
name|ip6_plen
operator|=
name|htons
argument_list|(
name|tlen
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|h6
operator|->
name|ip6_src
argument_list|,
operator|&
name|saddr
operator|->
name|v6
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|h6
operator|->
name|ip6_dst
argument_list|,
operator|&
name|daddr
operator|->
name|v6
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in6_addr
argument_list|)
argument_list|)
expr_stmt|;
name|th
operator|=
operator|(
expr|struct
name|tcphdr
operator|*
operator|)
operator|(
operator|(
name|caddr_t
operator|)
name|h6
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
operator|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
comment|/* TCP header */
name|th
operator|->
name|th_sport
operator|=
name|sport
expr_stmt|;
name|th
operator|->
name|th_dport
operator|=
name|dport
expr_stmt|;
name|th
operator|->
name|th_seq
operator|=
name|htonl
argument_list|(
name|seq
argument_list|)
expr_stmt|;
name|th
operator|->
name|th_ack
operator|=
name|htonl
argument_list|(
name|ack
argument_list|)
expr_stmt|;
name|th
operator|->
name|th_off
operator|=
name|tlen
operator|>>
literal|2
expr_stmt|;
name|th
operator|->
name|th_flags
operator|=
name|flags
expr_stmt|;
name|th
operator|->
name|th_win
operator|=
name|htons
argument_list|(
name|win
argument_list|)
expr_stmt|;
if|if
condition|(
name|mss
condition|)
block|{
name|opt
operator|=
operator|(
name|char
operator|*
operator|)
operator|(
name|th
operator|+
literal|1
operator|)
expr_stmt|;
name|opt
index|[
literal|0
index|]
operator|=
name|TCPOPT_MAXSEG
expr_stmt|;
name|opt
index|[
literal|1
index|]
operator|=
literal|4
expr_stmt|;
name|HTONS
argument_list|(
name|mss
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|mss
argument_list|,
call|(
name|caddr_t
call|)
argument_list|(
name|opt
operator|+
literal|2
argument_list|)
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
comment|/* TCP checksum */
name|th
operator|->
name|th_sum
operator|=
name|in_cksum
argument_list|(
name|m
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* Finish the IP header */
name|h
operator|->
name|ip_v
operator|=
literal|4
expr_stmt|;
name|h
operator|->
name|ip_hl
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|h
argument_list|)
operator|>>
literal|2
expr_stmt|;
name|h
operator|->
name|ip_tos
operator|=
name|IPTOS_LOWDELAY
expr_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
name|h
operator|->
name|ip_off
operator|=
name|path_mtu_discovery
condition|?
name|IP_DF
else|:
literal|0
expr_stmt|;
name|h
operator|->
name|ip_len
operator|=
name|len
expr_stmt|;
else|#
directive|else
name|h
operator|->
name|ip_off
operator|=
name|htons
argument_list|(
name|ip_mtudisc
condition|?
name|IP_DF
else|:
literal|0
argument_list|)
expr_stmt|;
name|h
operator|->
name|ip_len
operator|=
name|htons
argument_list|(
name|len
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|h
operator|->
name|ip_ttl
operator|=
name|ttl
condition|?
name|ttl
else|:
name|ip_defttl
expr_stmt|;
name|h
operator|->
name|ip_sum
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|eh
operator|==
name|NULL
condition|)
block|{
ifdef|#
directive|ifdef
name|__FreeBSD__
name|PF_UNLOCK
argument_list|()
expr_stmt|;
name|ip_output
argument_list|(
name|m
argument_list|,
operator|(
name|void
operator|*
operator|)
name|NULL
argument_list|,
operator|(
name|void
operator|*
operator|)
name|NULL
argument_list|,
literal|0
argument_list|,
operator|(
name|void
operator|*
operator|)
name|NULL
argument_list|,
operator|(
name|void
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|PF_LOCK
argument_list|()
expr_stmt|;
else|#
directive|else
comment|/* ! __FreeBSD__ */
name|ip_output
argument_list|(
name|m
argument_list|,
operator|(
name|void
operator|*
operator|)
name|NULL
argument_list|,
operator|(
name|void
operator|*
operator|)
name|NULL
argument_list|,
literal|0
argument_list|,
operator|(
name|void
operator|*
operator|)
name|NULL
argument_list|,
operator|(
name|void
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
name|struct
name|route
name|ro
decl_stmt|;
name|struct
name|rtentry
name|rt
decl_stmt|;
name|struct
name|ether_header
modifier|*
name|e
init|=
operator|(
name|void
operator|*
operator|)
name|ro
operator|.
name|ro_dst
operator|.
name|sa_data
decl_stmt|;
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
block|{
name|m_freem
argument_list|(
name|m
argument_list|)
expr_stmt|;
return|return;
block|}
name|rt
operator|.
name|rt_ifp
operator|=
name|ifp
expr_stmt|;
name|ro
operator|.
name|ro_rt
operator|=
operator|&
name|rt
expr_stmt|;
name|ro
operator|.
name|ro_dst
operator|.
name|sa_len
operator|=
sizeof|sizeof
argument_list|(
name|ro
operator|.
name|ro_dst
argument_list|)
expr_stmt|;
name|ro
operator|.
name|ro_dst
operator|.
name|sa_family
operator|=
name|pseudo_AF_HDRCMPLT
expr_stmt|;
name|bcopy
argument_list|(
name|eh
operator|->
name|ether_dhost
argument_list|,
name|e
operator|->
name|ether_shost
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|eh
operator|->
name|ether_shost
argument_list|,
name|e
operator|->
name|ether_dhost
argument_list|,
name|ETHER_ADDR_LEN
argument_list|)
expr_stmt|;
name|e
operator|->
name|ether_type
operator|=
name|eh
operator|->
name|ether_type
expr_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
name|PF_UNLOCK
argument_list|()
expr_stmt|;
comment|/* XXX_IMPORT: later */
name|ip_output
argument_list|(
name|m
argument_list|,
operator|(
name|void
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|ro
argument_list|,
literal|0
argument_list|,
operator|(
name|void
operator|*
operator|)
name|NULL
argument_list|,
operator|(
name|void
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
name|PF_LOCK
argument_list|()
expr_stmt|;
else|#
directive|else
comment|/* ! __FreeBSD__ */
name|ip_output
argument_list|(
name|m
argument_list|,
operator|(
name|void
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|ro
argument_list|,
name|IP_ROUTETOETHER
argument_list|,
operator|(
name|void
operator|*
operator|)
name|NULL
argument_list|,
operator|(
name|void
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
comment|/* TCP checksum */
name|th
operator|->
name|th_sum
operator|=
name|in6_cksum
argument_list|(
name|m
argument_list|,
name|IPPROTO_TCP
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
argument_list|,
name|tlen
argument_list|)
expr_stmt|;
name|h6
operator|->
name|ip6_vfc
operator||=
name|IPV6_VERSION
expr_stmt|;
name|h6
operator|->
name|ip6_hlim
operator|=
name|IPV6_DEFHLIM
expr_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
name|PF_UNLOCK
argument_list|()
expr_stmt|;
name|ip6_output
argument_list|(
name|m
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|PF_LOCK
argument_list|()
expr_stmt|;
else|#
directive|else
name|ip6_output
argument_list|(
name|m
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
block|}
end_function

begin_function
name|void
name|pf_send_icmp
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|u_int8_t
name|type
parameter_list|,
name|u_int8_t
name|code
parameter_list|,
name|sa_family_t
name|af
parameter_list|,
name|struct
name|pf_rule
modifier|*
name|r
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|ALTQ
name|struct
name|m_tag
modifier|*
name|mtag
decl_stmt|;
endif|#
directive|endif
name|struct
name|mbuf
modifier|*
name|m0
decl_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|__FreeBSD__
name|m0
operator|=
name|m_copypacket
argument_list|(
name|m
argument_list|,
name|M_DONTWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|m0
operator|==
name|NULL
condition|)
return|return;
name|m0
operator|->
name|m_flags
operator||=
name|M_SKIP_FIREWALL
expr_stmt|;
else|#
directive|else
name|mtag
operator|=
name|m_tag_get
argument_list|(
name|PACKET_TAG_PF_GENERATED
argument_list|,
literal|0
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|mtag
operator|==
name|NULL
condition|)
return|return;
name|m0
operator|=
name|m_copy
argument_list|(
name|m
argument_list|,
literal|0
argument_list|,
name|M_COPYALL
argument_list|)
expr_stmt|;
if|if
condition|(
name|m0
operator|==
name|NULL
condition|)
block|{
name|m_tag_free
argument_list|(
name|mtag
argument_list|)
expr_stmt|;
return|return;
block|}
name|m_tag_prepend
argument_list|(
name|m0
argument_list|,
name|mtag
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|ALTQ
if|if
condition|(
name|r
operator|->
name|qid
condition|)
block|{
name|struct
name|altq_tag
modifier|*
name|atag
decl_stmt|;
name|mtag
operator|=
name|m_tag_get
argument_list|(
name|PACKET_TAG_PF_QID
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|atag
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|mtag
operator|!=
name|NULL
condition|)
block|{
name|atag
operator|=
operator|(
expr|struct
name|altq_tag
operator|*
operator|)
operator|(
name|mtag
operator|+
literal|1
operator|)
expr_stmt|;
name|atag
operator|->
name|qid
operator|=
name|r
operator|->
name|qid
expr_stmt|;
comment|/* add hints for ecn */
name|atag
operator|->
name|af
operator|=
name|af
expr_stmt|;
name|atag
operator|->
name|hdr
operator|=
name|mtod
argument_list|(
name|m0
argument_list|,
expr|struct
name|ip
operator|*
argument_list|)
expr_stmt|;
name|m_tag_prepend
argument_list|(
name|m0
argument_list|,
name|mtag
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* ALTQ */
switch|switch
condition|(
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
ifdef|#
directive|ifdef
name|__FreeBSD__
comment|/* icmp_error() expects host byte ordering */
name|ip
operator|=
name|mtod
argument_list|(
name|m0
argument_list|,
expr|struct
name|ip
operator|*
argument_list|)
expr_stmt|;
name|NTOHS
argument_list|(
name|ip
operator|->
name|ip_len
argument_list|)
expr_stmt|;
name|NTOHS
argument_list|(
name|ip
operator|->
name|ip_off
argument_list|)
expr_stmt|;
name|PF_UNLOCK
argument_list|()
expr_stmt|;
name|icmp_error
argument_list|(
name|m0
argument_list|,
name|type
argument_list|,
name|code
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|PF_LOCK
argument_list|()
expr_stmt|;
else|#
directive|else
name|icmp_error
argument_list|(
name|m0
argument_list|,
name|type
argument_list|,
name|code
argument_list|,
literal|0
argument_list|,
operator|(
name|void
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
ifdef|#
directive|ifdef
name|__FreeBSD__
name|PF_UNLOCK
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|icmp6_error
argument_list|(
name|m0
argument_list|,
name|type
argument_list|,
name|code
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
name|PF_LOCK
argument_list|()
expr_stmt|;
endif|#
directive|endif
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
block|}
end_function

begin_comment
comment|/*  * Return 1 if the addresses a and b match (with mask m), otherwise return 0.  * If n is 0, they match if they are equal. If n is != 0, they match if they  * are different.  */
end_comment

begin_function
name|int
name|pf_match_addr
parameter_list|(
name|u_int8_t
name|n
parameter_list|,
name|struct
name|pf_addr
modifier|*
name|a
parameter_list|,
name|struct
name|pf_addr
modifier|*
name|m
parameter_list|,
name|struct
name|pf_addr
modifier|*
name|b
parameter_list|,
name|sa_family_t
name|af
parameter_list|)
block|{
name|int
name|match
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
if|if
condition|(
operator|(
name|a
operator|->
name|addr32
index|[
literal|0
index|]
operator|&
name|m
operator|->
name|addr32
index|[
literal|0
index|]
operator|)
operator|==
operator|(
name|b
operator|->
name|addr32
index|[
literal|0
index|]
operator|&
name|m
operator|->
name|addr32
index|[
literal|0
index|]
operator|)
condition|)
name|match
operator|++
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
if|if
condition|(
operator|(
operator|(
name|a
operator|->
name|addr32
index|[
literal|0
index|]
operator|&
name|m
operator|->
name|addr32
index|[
literal|0
index|]
operator|)
operator|==
operator|(
name|b
operator|->
name|addr32
index|[
literal|0
index|]
operator|&
name|m
operator|->
name|addr32
index|[
literal|0
index|]
operator|)
operator|)
operator|&&
operator|(
operator|(
name|a
operator|->
name|addr32
index|[
literal|1
index|]
operator|&
name|m
operator|->
name|addr32
index|[
literal|1
index|]
operator|)
operator|==
operator|(
name|b
operator|->
name|addr32
index|[
literal|1
index|]
operator|&
name|m
operator|->
name|addr32
index|[
literal|1
index|]
operator|)
operator|)
operator|&&
operator|(
operator|(
name|a
operator|->
name|addr32
index|[
literal|2
index|]
operator|&
name|m
operator|->
name|addr32
index|[
literal|2
index|]
operator|)
operator|==
operator|(
name|b
operator|->
name|addr32
index|[
literal|2
index|]
operator|&
name|m
operator|->
name|addr32
index|[
literal|2
index|]
operator|)
operator|)
operator|&&
operator|(
operator|(
name|a
operator|->
name|addr32
index|[
literal|3
index|]
operator|&
name|m
operator|->
name|addr32
index|[
literal|3
index|]
operator|)
operator|==
operator|(
name|b
operator|->
name|addr32
index|[
literal|3
index|]
operator|&
name|m
operator|->
name|addr32
index|[
literal|3
index|]
operator|)
operator|)
condition|)
name|match
operator|++
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
if|if
condition|(
name|match
condition|)
block|{
if|if
condition|(
name|n
condition|)
return|return
operator|(
literal|0
operator|)
return|;
else|else
return|return
operator|(
literal|1
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|n
condition|)
return|return
operator|(
literal|1
operator|)
return|;
else|else
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
end_function

begin_function
name|int
name|pf_match
parameter_list|(
name|u_int8_t
name|op
parameter_list|,
name|u_int32_t
name|a1
parameter_list|,
name|u_int32_t
name|a2
parameter_list|,
name|u_int32_t
name|p
parameter_list|)
block|{
switch|switch
condition|(
name|op
condition|)
block|{
case|case
name|PF_OP_IRG
case|:
return|return
operator|(
operator|(
name|p
operator|>
name|a1
operator|)
operator|&&
operator|(
name|p
operator|<
name|a2
operator|)
operator|)
return|;
case|case
name|PF_OP_XRG
case|:
return|return
operator|(
operator|(
name|p
operator|<
name|a1
operator|)
operator|||
operator|(
name|p
operator|>
name|a2
operator|)
operator|)
return|;
case|case
name|PF_OP_RRG
case|:
return|return
operator|(
operator|(
name|p
operator|>=
name|a1
operator|)
operator|&&
operator|(
name|p
operator|<=
name|a2
operator|)
operator|)
return|;
case|case
name|PF_OP_EQ
case|:
return|return
operator|(
name|p
operator|==
name|a1
operator|)
return|;
case|case
name|PF_OP_NE
case|:
return|return
operator|(
name|p
operator|!=
name|a1
operator|)
return|;
case|case
name|PF_OP_LT
case|:
return|return
operator|(
name|p
operator|<
name|a1
operator|)
return|;
case|case
name|PF_OP_LE
case|:
return|return
operator|(
name|p
operator|<=
name|a1
operator|)
return|;
case|case
name|PF_OP_GT
case|:
return|return
operator|(
name|p
operator|>
name|a1
operator|)
return|;
case|case
name|PF_OP_GE
case|:
return|return
operator|(
name|p
operator|>=
name|a1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
comment|/* never reached */
block|}
end_function

begin_function
name|int
name|pf_match_port
parameter_list|(
name|u_int8_t
name|op
parameter_list|,
name|u_int16_t
name|a1
parameter_list|,
name|u_int16_t
name|a2
parameter_list|,
name|u_int16_t
name|p
parameter_list|)
block|{
name|NTOHS
argument_list|(
name|a1
argument_list|)
expr_stmt|;
name|NTOHS
argument_list|(
name|a2
argument_list|)
expr_stmt|;
name|NTOHS
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
operator|(
name|pf_match
argument_list|(
name|op
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|,
name|p
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|pf_match_uid
parameter_list|(
name|u_int8_t
name|op
parameter_list|,
name|uid_t
name|a1
parameter_list|,
name|uid_t
name|a2
parameter_list|,
name|uid_t
name|u
parameter_list|)
block|{
if|if
condition|(
name|u
operator|==
name|UID_MAX
operator|&&
name|op
operator|!=
name|PF_OP_EQ
operator|&&
name|op
operator|!=
name|PF_OP_NE
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
name|pf_match
argument_list|(
name|op
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|,
name|u
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|pf_match_gid
parameter_list|(
name|u_int8_t
name|op
parameter_list|,
name|gid_t
name|a1
parameter_list|,
name|gid_t
name|a2
parameter_list|,
name|gid_t
name|g
parameter_list|)
block|{
if|if
condition|(
name|g
operator|==
name|GID_MAX
operator|&&
name|op
operator|!=
name|PF_OP_EQ
operator|&&
name|op
operator|!=
name|PF_OP_NE
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
name|pf_match
argument_list|(
name|op
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|,
name|g
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|pf_tag
modifier|*
name|pf_get_tag
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|)
block|{
name|struct
name|m_tag
modifier|*
name|mtag
decl_stmt|;
if|if
condition|(
operator|(
name|mtag
operator|=
name|m_tag_find
argument_list|(
name|m
argument_list|,
name|PACKET_TAG_PF_TAG
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
return|return
operator|(
operator|(
expr|struct
name|pf_tag
operator|*
operator|)
operator|(
name|mtag
operator|+
literal|1
operator|)
operator|)
return|;
else|else
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_function
name|int
name|pf_match_tag
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|pf_rule
modifier|*
name|r
parameter_list|,
name|struct
name|pf_tag
modifier|*
modifier|*
name|pftag
parameter_list|,
name|int
modifier|*
name|tag
parameter_list|)
block|{
if|if
condition|(
operator|*
name|tag
operator|==
operator|-
literal|1
condition|)
block|{
comment|/* find mbuf tag */
operator|*
name|pftag
operator|=
name|pf_get_tag
argument_list|(
name|m
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|pftag
operator|!=
name|NULL
condition|)
operator|*
name|tag
operator|=
operator|(
operator|*
name|pftag
operator|)
operator|->
name|tag
expr_stmt|;
else|else
operator|*
name|tag
operator|=
literal|0
expr_stmt|;
block|}
return|return
operator|(
operator|(
operator|!
name|r
operator|->
name|match_tag_not
operator|&&
name|r
operator|->
name|match_tag
operator|==
operator|*
name|tag
operator|)
operator|||
operator|(
name|r
operator|->
name|match_tag_not
operator|&&
name|r
operator|->
name|match_tag
operator|!=
operator|*
name|tag
operator|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|pf_tag_packet
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|struct
name|pf_tag
modifier|*
name|pftag
parameter_list|,
name|int
name|tag
parameter_list|)
block|{
name|struct
name|m_tag
modifier|*
name|mtag
decl_stmt|;
if|if
condition|(
name|tag
operator|<=
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|pftag
operator|==
name|NULL
condition|)
block|{
name|mtag
operator|=
name|m_tag_get
argument_list|(
name|PACKET_TAG_PF_TAG
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pftag
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|mtag
operator|==
name|NULL
condition|)
return|return
operator|(
literal|1
operator|)
return|;
operator|(
operator|(
expr|struct
name|pf_tag
operator|*
operator|)
operator|(
name|mtag
operator|+
literal|1
operator|)
operator|)
operator|->
name|tag
operator|=
name|tag
expr_stmt|;
name|m_tag_prepend
argument_list|(
name|m
argument_list|,
name|mtag
argument_list|)
expr_stmt|;
block|}
else|else
name|pftag
operator|->
name|tag
operator|=
name|tag
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|pf_step_into_anchor
parameter_list|(
name|int
modifier|*
name|depth
parameter_list|,
name|struct
name|pf_ruleset
modifier|*
modifier|*
name|rs
parameter_list|,
name|int
name|n
parameter_list|,
name|struct
name|pf_rule
modifier|*
modifier|*
name|r
parameter_list|,
name|struct
name|pf_rule
modifier|*
modifier|*
name|a
parameter_list|)
block|{
name|struct
name|pf_anchor_stackframe
modifier|*
name|f
decl_stmt|;
if|if
condition|(
operator|*
name|depth
operator|>=
sizeof|sizeof
argument_list|(
name|pf_anchor_stack
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|pf_anchor_stack
index|[
literal|0
index|]
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"pf_step_into_anchor: stack overflow\n"
argument_list|)
expr_stmt|;
operator|*
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
operator|*
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
operator|*
name|depth
operator|==
literal|0
operator|&&
name|a
operator|!=
name|NULL
condition|)
operator|*
name|a
operator|=
operator|*
name|r
expr_stmt|;
name|f
operator|=
name|pf_anchor_stack
operator|+
operator|(
operator|*
name|depth
operator|)
operator|++
expr_stmt|;
name|f
operator|->
name|rs
operator|=
operator|*
name|rs
expr_stmt|;
name|f
operator|->
name|r
operator|=
operator|*
name|r
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|r
operator|)
operator|->
name|anchor_wildcard
condition|)
block|{
name|f
operator|->
name|parent
operator|=
operator|&
operator|(
operator|*
name|r
operator|)
operator|->
name|anchor
operator|->
name|children
expr_stmt|;
if|if
condition|(
operator|(
name|f
operator|->
name|child
operator|=
name|RB_MIN
argument_list|(
name|pf_anchor_node
argument_list|,
name|f
operator|->
name|parent
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
operator|*
name|r
operator|=
name|NULL
expr_stmt|;
return|return;
block|}
operator|*
name|rs
operator|=
operator|&
name|f
operator|->
name|child
operator|->
name|ruleset
expr_stmt|;
block|}
else|else
block|{
name|f
operator|->
name|parent
operator|=
name|NULL
expr_stmt|;
name|f
operator|->
name|child
operator|=
name|NULL
expr_stmt|;
operator|*
name|rs
operator|=
operator|&
operator|(
operator|*
name|r
operator|)
operator|->
name|anchor
operator|->
name|ruleset
expr_stmt|;
block|}
operator|*
name|r
operator|=
name|TAILQ_FIRST
argument_list|(
operator|(
operator|*
name|rs
operator|)
operator|->
name|rules
index|[
name|n
index|]
operator|.
name|active
operator|.
name|ptr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|pf_step_out_of_anchor
parameter_list|(
name|int
modifier|*
name|depth
parameter_list|,
name|struct
name|pf_ruleset
modifier|*
modifier|*
name|rs
parameter_list|,
name|int
name|n
parameter_list|,
name|struct
name|pf_rule
modifier|*
modifier|*
name|r
parameter_list|,
name|struct
name|pf_rule
modifier|*
modifier|*
name|a
parameter_list|)
block|{
name|struct
name|pf_anchor_stackframe
modifier|*
name|f
decl_stmt|;
do|do
block|{
if|if
condition|(
operator|*
name|depth
operator|<=
literal|0
condition|)
break|break;
name|f
operator|=
name|pf_anchor_stack
operator|+
operator|*
name|depth
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|parent
operator|!=
name|NULL
operator|&&
name|f
operator|->
name|child
operator|!=
name|NULL
condition|)
block|{
name|f
operator|->
name|child
operator|=
name|RB_NEXT
argument_list|(
name|pf_anchor_node
argument_list|,
name|f
operator|->
name|parent
argument_list|,
name|f
operator|->
name|child
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|->
name|child
operator|!=
name|NULL
condition|)
block|{
operator|*
name|rs
operator|=
operator|&
name|f
operator|->
name|child
operator|->
name|ruleset
expr_stmt|;
operator|*
name|r
operator|=
name|TAILQ_FIRST
argument_list|(
operator|(
operator|*
name|rs
operator|)
operator|->
name|rules
index|[
name|n
index|]
operator|.
name|active
operator|.
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|r
operator|==
name|NULL
condition|)
continue|continue;
else|else
break|break;
block|}
block|}
operator|(
operator|*
name|depth
operator|)
operator|--
expr_stmt|;
if|if
condition|(
operator|*
name|depth
operator|==
literal|0
operator|&&
name|a
operator|!=
name|NULL
condition|)
operator|*
name|a
operator|=
name|NULL
expr_stmt|;
operator|*
name|rs
operator|=
name|f
operator|->
name|rs
expr_stmt|;
operator|*
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|f
operator|->
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
operator|*
name|r
operator|==
name|NULL
condition|)
do|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|INET6
end_ifdef

begin_function
name|void
name|pf_poolmask
parameter_list|(
name|struct
name|pf_addr
modifier|*
name|naddr
parameter_list|,
name|struct
name|pf_addr
modifier|*
name|raddr
parameter_list|,
name|struct
name|pf_addr
modifier|*
name|rmask
parameter_list|,
name|struct
name|pf_addr
modifier|*
name|saddr
parameter_list|,
name|sa_family_t
name|af
parameter_list|)
block|{
switch|switch
condition|(
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
name|naddr
operator|->
name|addr32
index|[
literal|0
index|]
operator|=
operator|(
name|raddr
operator|->
name|addr32
index|[
literal|0
index|]
operator|&
name|rmask
operator|->
name|addr32
index|[
literal|0
index|]
operator|)
operator||
operator|(
operator|(
name|rmask
operator|->
name|addr32
index|[
literal|0
index|]
operator|^
literal|0xffffffff
operator|)
operator|&
name|saddr
operator|->
name|addr32
index|[
literal|0
index|]
operator|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
case|case
name|AF_INET6
case|:
name|naddr
operator|->
name|addr32
index|[
literal|0
index|]
operator|=
operator|(
name|raddr
operator|->
name|addr32
index|[
literal|0
index|]
operator|&
name|rmask
operator|->
name|addr32
index|[
literal|0
index|]
operator|)
operator||
operator|(
operator|(
name|rmask
operator|->
name|addr32
index|[
literal|0
index|]
operator|^
literal|0xffffffff
operator|)
operator|&
name|saddr
operator|->
name|addr32
index|[
literal|0
index|]
operator|)
expr_stmt|;
name|naddr
operator|->
name|addr32
index|[
literal|1
index|]
operator|=
operator|(
name|raddr
operator|->
name|addr32
index|[
literal|1
index|]
operator|&
name|rmask
operator|->
name|addr32
index|[
literal|1
index|]
operator|)
operator||
operator|(
operator|(
name|rmask
operator|->
name|addr32
index|[
literal|1
index|]
operator|^
literal|0xffffffff
operator|)
operator|&
name|saddr
operator|->
name|addr32
index|[
literal|1
index|]
operator|)
expr_stmt|;
name|naddr
operator|->
name|addr32
index|[
literal|2
index|]
operator|=
operator|(
name|raddr
operator|->
name|addr32
index|[
literal|2
index|]
operator|&
name|rmask
operator|->
name|addr32
index|[
literal|2
index|]
operator|)
operator||
operator|(
operator|(
name|rmask
operator|->
name|addr32
index|[
literal|2
index|]
operator|^
literal|0xffffffff
operator|)
operator|&
name|saddr
operator|->
name|addr32
index|[
literal|2
index|]
operator|)
expr_stmt|;
name|naddr
operator|->
name|addr32
index|[
literal|3
index|]
operator|=
operator|(
name|raddr
operator|->
name|addr32
index|[
literal|3
index|]
operator|&
name|rmask
operator|->
name|addr32
index|[
literal|3
index|]
operator|)
operator||
operator|(
operator|(
name|rmask
operator|->
name|addr32
index|[
literal|3
index|]
operator|^
literal|0xffffffff
operator|)
operator|&
name|saddr
operator|->
name|addr32
index|[
literal|3
index|]
operator|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|pf_addr_inc
parameter_list|(
name|struct
name|pf_addr
modifier|*
name|addr
parameter_list|,
name|sa_family_t
name|af
parameter_list|)
block|{
switch|switch
condition|(
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
name|addr
operator|->
name|addr32
index|[
literal|0
index|]
operator|=
name|htonl
argument_list|(
name|ntohl
argument_list|(
name|addr
operator|->
name|addr32
index|[
literal|0
index|]
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
case|case
name|AF_INET6
case|:
if|if
condition|(
name|addr
operator|->
name|addr32
index|[
literal|3
index|]
operator|==
literal|0xffffffff
condition|)
block|{
name|addr
operator|->
name|addr32
index|[
literal|3
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|addr
operator|->
name|addr32
index|[
literal|2
index|]
operator|==
literal|0xffffffff
condition|)
block|{
name|addr
operator|->
name|addr32
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|addr
operator|->
name|addr32
index|[
literal|1
index|]
operator|==
literal|0xffffffff
condition|)
block|{
name|addr
operator|->
name|addr32
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|addr
operator|->
name|addr32
index|[
literal|0
index|]
operator|=
name|htonl
argument_list|(
name|ntohl
argument_list|(
name|addr
operator|->
name|addr32
index|[
literal|0
index|]
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|addr
operator|->
name|addr32
index|[
literal|1
index|]
operator|=
name|htonl
argument_list|(
name|ntohl
argument_list|(
name|addr
operator|->
name|addr32
index|[
literal|1
index|]
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|addr
operator|->
name|addr32
index|[
literal|2
index|]
operator|=
name|htonl
argument_list|(
name|ntohl
argument_list|(
name|addr
operator|->
name|addr32
index|[
literal|2
index|]
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|addr
operator|->
name|addr32
index|[
literal|3
index|]
operator|=
name|htonl
argument_list|(
name|ntohl
argument_list|(
name|addr
operator|->
name|addr32
index|[
literal|3
index|]
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* INET6 */
end_comment

begin_define
define|#
directive|define
name|mix
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|,
name|c
parameter_list|)
define|\
value|do {					\ 		a -= b; a -= c; a ^= (c>> 13);	\ 		b -= c; b -= a; b ^= (a<< 8);	\ 		c -= a; c -= b; c ^= (b>> 13);	\ 		a -= b; a -= c; a ^= (c>> 12);	\ 		b -= c; b -= a; b ^= (a<< 16);	\ 		c -= a; c -= b; c ^= (b>> 5);	\ 		a -= b; a -= c; a ^= (c>> 3);	\ 		b -= c; b -= a; b ^= (a<< 10);	\ 		c -= a; c -= b; c ^= (b>> 15);	\ 	} while (0)
end_define

begin_comment
comment|/*  * hash function based on bridge_hash in if_bridge.c  */
end_comment

begin_function
name|void
name|pf_hash
parameter_list|(
name|struct
name|pf_addr
modifier|*
name|inaddr
parameter_list|,
name|struct
name|pf_addr
modifier|*
name|hash
parameter_list|,
name|struct
name|pf_poolhashkey
modifier|*
name|key
parameter_list|,
name|sa_family_t
name|af
parameter_list|)
block|{
name|u_int32_t
name|a
init|=
literal|0x9e3779b9
decl_stmt|,
name|b
init|=
literal|0x9e3779b9
decl_stmt|,
name|c
init|=
name|key
operator|->
name|key32
index|[
literal|0
index|]
decl_stmt|;
switch|switch
condition|(
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
name|a
operator|+=
name|inaddr
operator|->
name|addr32
index|[
literal|0
index|]
expr_stmt|;
name|b
operator|+=
name|key
operator|->
name|key32
index|[
literal|1
index|]
expr_stmt|;
name|mix
argument_list|(
name|a
argument_list|,
name|b
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|hash
operator|->
name|addr32
index|[
literal|0
index|]
operator|=
name|c
operator|+
name|key
operator|->
name|key32
index|[
literal|2
index|]
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
name|a
operator|+=
name|inaddr
operator|->
name|addr32
index|[
literal|0
index|]
expr_stmt|;
name|b
operator|+=
name|inaddr
operator|->
name|addr32
index|[
literal|2
index|]
expr_stmt|;
name|mix
argument_list|(
name|a
argument_list|,
name|b
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|hash
operator|->
name|addr32
index|[
literal|0
index|]
operator|=
name|c
expr_stmt|;
name|a
operator|+=
name|inaddr
operator|->
name|addr32
index|[
literal|1
index|]
expr_stmt|;
name|b
operator|+=
name|inaddr
operator|->
name|addr32
index|[
literal|3
index|]
expr_stmt|;
name|c
operator|+=
name|key
operator|->
name|key32
index|[
literal|1
index|]
expr_stmt|;
name|mix
argument_list|(
name|a
argument_list|,
name|b
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|hash
operator|->
name|addr32
index|[
literal|1
index|]
operator|=
name|c
expr_stmt|;
name|a
operator|+=
name|inaddr
operator|->
name|addr32
index|[
literal|2
index|]
expr_stmt|;
name|b
operator|+=
name|inaddr
operator|->
name|addr32
index|[
literal|1
index|]
expr_stmt|;
name|c
operator|+=
name|key
operator|->
name|key32
index|[
literal|2
index|]
expr_stmt|;
name|mix
argument_list|(
name|a
argument_list|,
name|b
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|hash
operator|->
name|addr32
index|[
literal|2
index|]
operator|=
name|c
expr_stmt|;
name|a
operator|+=
name|inaddr
operator|->
name|addr32
index|[
literal|3
index|]
expr_stmt|;
name|b
operator|+=
name|inaddr
operator|->
name|addr32
index|[
literal|0
index|]
expr_stmt|;
name|c
operator|+=
name|key
operator|->
name|key32
index|[
literal|3
index|]
expr_stmt|;
name|mix
argument_list|(
name|a
argument_list|,
name|b
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|hash
operator|->
name|addr32
index|[
literal|3
index|]
operator|=
name|c
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
block|}
end_function

begin_function
name|int
name|pf_map_addr
parameter_list|(
name|sa_family_t
name|af
parameter_list|,
name|struct
name|pf_rule
modifier|*
name|r
parameter_list|,
name|struct
name|pf_addr
modifier|*
name|saddr
parameter_list|,
name|struct
name|pf_addr
modifier|*
name|naddr
parameter_list|,
name|struct
name|pf_addr
modifier|*
name|init_addr
parameter_list|,
name|struct
name|pf_src_node
modifier|*
modifier|*
name|sn
parameter_list|)
block|{
name|unsigned
name|char
name|hash
index|[
literal|16
index|]
decl_stmt|;
name|struct
name|pf_pool
modifier|*
name|rpool
init|=
operator|&
name|r
operator|->
name|rpool
decl_stmt|;
name|struct
name|pf_addr
modifier|*
name|raddr
init|=
operator|&
name|rpool
operator|->
name|cur
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|addr
decl_stmt|;
name|struct
name|pf_addr
modifier|*
name|rmask
init|=
operator|&
name|rpool
operator|->
name|cur
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|mask
decl_stmt|;
name|struct
name|pf_pooladdr
modifier|*
name|acur
init|=
name|rpool
operator|->
name|cur
decl_stmt|;
name|struct
name|pf_src_node
name|k
decl_stmt|;
if|if
condition|(
operator|*
name|sn
operator|==
name|NULL
operator|&&
name|r
operator|->
name|rpool
operator|.
name|opts
operator|&
name|PF_POOL_STICKYADDR
operator|&&
operator|(
name|r
operator|->
name|rpool
operator|.
name|opts
operator|&
name|PF_POOL_TYPEMASK
operator|)
operator|!=
name|PF_POOL_NONE
condition|)
block|{
name|k
operator|.
name|af
operator|=
name|af
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|k
operator|.
name|addr
argument_list|,
name|saddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_RULESRCTRACK
operator|||
name|r
operator|->
name|rpool
operator|.
name|opts
operator|&
name|PF_POOL_STICKYADDR
condition|)
name|k
operator|.
name|rule
operator|.
name|ptr
operator|=
name|r
expr_stmt|;
else|else
name|k
operator|.
name|rule
operator|.
name|ptr
operator|=
name|NULL
expr_stmt|;
name|pf_status
operator|.
name|scounters
index|[
name|SCNT_SRC_NODE_SEARCH
index|]
operator|++
expr_stmt|;
operator|*
name|sn
operator|=
name|RB_FIND
argument_list|(
name|pf_src_tree
argument_list|,
operator|&
name|tree_src_tracking
argument_list|,
operator|&
name|k
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|sn
operator|!=
name|NULL
operator|&&
operator|!
name|PF_AZERO
argument_list|(
operator|&
operator|(
operator|*
name|sn
operator|)
operator|->
name|raddr
argument_list|,
name|af
argument_list|)
condition|)
block|{
name|PF_ACPY
argument_list|(
name|naddr
argument_list|,
operator|&
operator|(
operator|*
name|sn
operator|)
operator|->
name|raddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
if|if
condition|(
name|pf_status
operator|.
name|debug
operator|>=
name|PF_DEBUG_MISC
condition|)
block|{
name|printf
argument_list|(
literal|"pf_map_addr: src tracking maps "
argument_list|)
expr_stmt|;
name|pf_print_host
argument_list|(
operator|&
name|k
operator|.
name|addr
argument_list|,
literal|0
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" to "
argument_list|)
expr_stmt|;
name|pf_print_host
argument_list|(
name|naddr
argument_list|,
literal|0
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
if|if
condition|(
name|rpool
operator|->
name|cur
operator|->
name|addr
operator|.
name|type
operator|==
name|PF_ADDR_NOROUTE
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|rpool
operator|->
name|cur
operator|->
name|addr
operator|.
name|type
operator|==
name|PF_ADDR_DYNIFTL
condition|)
block|{
switch|switch
condition|(
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
if|if
condition|(
name|rpool
operator|->
name|cur
operator|->
name|addr
operator|.
name|p
operator|.
name|dyn
operator|->
name|pfid_acnt4
operator|<
literal|1
operator|&&
operator|(
name|rpool
operator|->
name|opts
operator|&
name|PF_POOL_TYPEMASK
operator|)
operator|!=
name|PF_POOL_ROUNDROBIN
condition|)
return|return
operator|(
literal|1
operator|)
return|;
name|raddr
operator|=
operator|&
name|rpool
operator|->
name|cur
operator|->
name|addr
operator|.
name|p
operator|.
name|dyn
operator|->
name|pfid_addr4
expr_stmt|;
name|rmask
operator|=
operator|&
name|rpool
operator|->
name|cur
operator|->
name|addr
operator|.
name|p
operator|.
name|dyn
operator|->
name|pfid_mask4
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
if|if
condition|(
name|rpool
operator|->
name|cur
operator|->
name|addr
operator|.
name|p
operator|.
name|dyn
operator|->
name|pfid_acnt6
operator|<
literal|1
operator|&&
operator|(
name|rpool
operator|->
name|opts
operator|&
name|PF_POOL_TYPEMASK
operator|)
operator|!=
name|PF_POOL_ROUNDROBIN
condition|)
return|return
operator|(
literal|1
operator|)
return|;
name|raddr
operator|=
operator|&
name|rpool
operator|->
name|cur
operator|->
name|addr
operator|.
name|p
operator|.
name|dyn
operator|->
name|pfid_addr6
expr_stmt|;
name|rmask
operator|=
operator|&
name|rpool
operator|->
name|cur
operator|->
name|addr
operator|.
name|p
operator|.
name|dyn
operator|->
name|pfid_mask6
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
block|}
elseif|else
if|if
condition|(
name|rpool
operator|->
name|cur
operator|->
name|addr
operator|.
name|type
operator|==
name|PF_ADDR_TABLE
condition|)
block|{
if|if
condition|(
operator|(
name|rpool
operator|->
name|opts
operator|&
name|PF_POOL_TYPEMASK
operator|)
operator|!=
name|PF_POOL_ROUNDROBIN
condition|)
return|return
operator|(
literal|1
operator|)
return|;
comment|/* unsupported */
block|}
else|else
block|{
name|raddr
operator|=
operator|&
name|rpool
operator|->
name|cur
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|addr
expr_stmt|;
name|rmask
operator|=
operator|&
name|rpool
operator|->
name|cur
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|mask
expr_stmt|;
block|}
switch|switch
condition|(
name|rpool
operator|->
name|opts
operator|&
name|PF_POOL_TYPEMASK
condition|)
block|{
case|case
name|PF_POOL_NONE
case|:
name|PF_ACPY
argument_list|(
name|naddr
argument_list|,
name|raddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
break|break;
case|case
name|PF_POOL_BITMASK
case|:
name|PF_POOLMASK
argument_list|(
name|naddr
argument_list|,
name|raddr
argument_list|,
name|rmask
argument_list|,
name|saddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
break|break;
case|case
name|PF_POOL_RANDOM
case|:
if|if
condition|(
name|init_addr
operator|!=
name|NULL
operator|&&
name|PF_AZERO
argument_list|(
name|init_addr
argument_list|,
name|af
argument_list|)
condition|)
block|{
switch|switch
condition|(
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
name|rpool
operator|->
name|counter
operator|.
name|addr32
index|[
literal|0
index|]
operator|=
name|htonl
argument_list|(
name|arc4random
argument_list|()
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
if|if
condition|(
name|rmask
operator|->
name|addr32
index|[
literal|3
index|]
operator|!=
literal|0xffffffff
condition|)
name|rpool
operator|->
name|counter
operator|.
name|addr32
index|[
literal|3
index|]
operator|=
name|htonl
argument_list|(
name|arc4random
argument_list|()
argument_list|)
expr_stmt|;
else|else
break|break;
if|if
condition|(
name|rmask
operator|->
name|addr32
index|[
literal|2
index|]
operator|!=
literal|0xffffffff
condition|)
name|rpool
operator|->
name|counter
operator|.
name|addr32
index|[
literal|2
index|]
operator|=
name|htonl
argument_list|(
name|arc4random
argument_list|()
argument_list|)
expr_stmt|;
else|else
break|break;
if|if
condition|(
name|rmask
operator|->
name|addr32
index|[
literal|1
index|]
operator|!=
literal|0xffffffff
condition|)
name|rpool
operator|->
name|counter
operator|.
name|addr32
index|[
literal|1
index|]
operator|=
name|htonl
argument_list|(
name|arc4random
argument_list|()
argument_list|)
expr_stmt|;
else|else
break|break;
if|if
condition|(
name|rmask
operator|->
name|addr32
index|[
literal|0
index|]
operator|!=
literal|0xffffffff
condition|)
name|rpool
operator|->
name|counter
operator|.
name|addr32
index|[
literal|0
index|]
operator|=
name|htonl
argument_list|(
name|arc4random
argument_list|()
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
name|PF_POOLMASK
argument_list|(
name|naddr
argument_list|,
name|raddr
argument_list|,
name|rmask
argument_list|,
operator|&
name|rpool
operator|->
name|counter
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|PF_ACPY
argument_list|(
name|init_addr
argument_list|,
name|naddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|PF_AINC
argument_list|(
operator|&
name|rpool
operator|->
name|counter
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|PF_POOLMASK
argument_list|(
name|naddr
argument_list|,
name|raddr
argument_list|,
name|rmask
argument_list|,
operator|&
name|rpool
operator|->
name|counter
argument_list|,
name|af
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PF_POOL_SRCHASH
case|:
name|pf_hash
argument_list|(
name|saddr
argument_list|,
operator|(
expr|struct
name|pf_addr
operator|*
operator|)
operator|&
name|hash
argument_list|,
operator|&
name|rpool
operator|->
name|key
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|PF_POOLMASK
argument_list|(
name|naddr
argument_list|,
name|raddr
argument_list|,
name|rmask
argument_list|,
operator|(
expr|struct
name|pf_addr
operator|*
operator|)
operator|&
name|hash
argument_list|,
name|af
argument_list|)
expr_stmt|;
break|break;
case|case
name|PF_POOL_ROUNDROBIN
case|:
if|if
condition|(
name|rpool
operator|->
name|cur
operator|->
name|addr
operator|.
name|type
operator|==
name|PF_ADDR_TABLE
condition|)
block|{
if|if
condition|(
operator|!
name|pfr_pool_get
argument_list|(
name|rpool
operator|->
name|cur
operator|->
name|addr
operator|.
name|p
operator|.
name|tbl
argument_list|,
operator|&
name|rpool
operator|->
name|tblidx
argument_list|,
operator|&
name|rpool
operator|->
name|counter
argument_list|,
operator|&
name|raddr
argument_list|,
operator|&
name|rmask
argument_list|,
name|af
argument_list|)
condition|)
goto|goto
name|get_addr
goto|;
block|}
elseif|else
if|if
condition|(
name|rpool
operator|->
name|cur
operator|->
name|addr
operator|.
name|type
operator|==
name|PF_ADDR_DYNIFTL
condition|)
block|{
if|if
condition|(
operator|!
name|pfr_pool_get
argument_list|(
name|rpool
operator|->
name|cur
operator|->
name|addr
operator|.
name|p
operator|.
name|dyn
operator|->
name|pfid_kt
argument_list|,
operator|&
name|rpool
operator|->
name|tblidx
argument_list|,
operator|&
name|rpool
operator|->
name|counter
argument_list|,
operator|&
name|raddr
argument_list|,
operator|&
name|rmask
argument_list|,
name|af
argument_list|)
condition|)
goto|goto
name|get_addr
goto|;
block|}
elseif|else
if|if
condition|(
name|pf_match_addr
argument_list|(
literal|0
argument_list|,
name|raddr
argument_list|,
name|rmask
argument_list|,
operator|&
name|rpool
operator|->
name|counter
argument_list|,
name|af
argument_list|)
condition|)
goto|goto
name|get_addr
goto|;
name|try_next
label|:
if|if
condition|(
operator|(
name|rpool
operator|->
name|cur
operator|=
name|TAILQ_NEXT
argument_list|(
name|rpool
operator|->
name|cur
argument_list|,
name|entries
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|rpool
operator|->
name|cur
operator|=
name|TAILQ_FIRST
argument_list|(
operator|&
name|rpool
operator|->
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|rpool
operator|->
name|cur
operator|->
name|addr
operator|.
name|type
operator|==
name|PF_ADDR_TABLE
condition|)
block|{
name|rpool
operator|->
name|tblidx
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|pfr_pool_get
argument_list|(
name|rpool
operator|->
name|cur
operator|->
name|addr
operator|.
name|p
operator|.
name|tbl
argument_list|,
operator|&
name|rpool
operator|->
name|tblidx
argument_list|,
operator|&
name|rpool
operator|->
name|counter
argument_list|,
operator|&
name|raddr
argument_list|,
operator|&
name|rmask
argument_list|,
name|af
argument_list|)
condition|)
block|{
comment|/* table contains no address of type 'af' */
if|if
condition|(
name|rpool
operator|->
name|cur
operator|!=
name|acur
condition|)
goto|goto
name|try_next
goto|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|rpool
operator|->
name|cur
operator|->
name|addr
operator|.
name|type
operator|==
name|PF_ADDR_DYNIFTL
condition|)
block|{
name|rpool
operator|->
name|tblidx
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|pfr_pool_get
argument_list|(
name|rpool
operator|->
name|cur
operator|->
name|addr
operator|.
name|p
operator|.
name|dyn
operator|->
name|pfid_kt
argument_list|,
operator|&
name|rpool
operator|->
name|tblidx
argument_list|,
operator|&
name|rpool
operator|->
name|counter
argument_list|,
operator|&
name|raddr
argument_list|,
operator|&
name|rmask
argument_list|,
name|af
argument_list|)
condition|)
block|{
comment|/* table contains no address of type 'af' */
if|if
condition|(
name|rpool
operator|->
name|cur
operator|!=
name|acur
condition|)
goto|goto
name|try_next
goto|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
else|else
block|{
name|raddr
operator|=
operator|&
name|rpool
operator|->
name|cur
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|addr
expr_stmt|;
name|rmask
operator|=
operator|&
name|rpool
operator|->
name|cur
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|mask
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|rpool
operator|->
name|counter
argument_list|,
name|raddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
block|}
name|get_addr
label|:
name|PF_ACPY
argument_list|(
name|naddr
argument_list|,
operator|&
name|rpool
operator|->
name|counter
argument_list|,
name|af
argument_list|)
expr_stmt|;
if|if
condition|(
name|init_addr
operator|!=
name|NULL
operator|&&
name|PF_AZERO
argument_list|(
name|init_addr
argument_list|,
name|af
argument_list|)
condition|)
name|PF_ACPY
argument_list|(
name|init_addr
argument_list|,
name|naddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|PF_AINC
argument_list|(
operator|&
name|rpool
operator|->
name|counter
argument_list|,
name|af
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|*
name|sn
operator|!=
name|NULL
condition|)
name|PF_ACPY
argument_list|(
operator|&
operator|(
operator|*
name|sn
operator|)
operator|->
name|raddr
argument_list|,
name|naddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
if|if
condition|(
name|pf_status
operator|.
name|debug
operator|>=
name|PF_DEBUG_MISC
operator|&&
operator|(
name|rpool
operator|->
name|opts
operator|&
name|PF_POOL_TYPEMASK
operator|)
operator|!=
name|PF_POOL_NONE
condition|)
block|{
name|printf
argument_list|(
literal|"pf_map_addr: selected address "
argument_list|)
expr_stmt|;
name|pf_print_host
argument_list|(
name|naddr
argument_list|,
literal|0
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|pf_get_sport
parameter_list|(
name|sa_family_t
name|af
parameter_list|,
name|u_int8_t
name|proto
parameter_list|,
name|struct
name|pf_rule
modifier|*
name|r
parameter_list|,
name|struct
name|pf_addr
modifier|*
name|saddr
parameter_list|,
name|struct
name|pf_addr
modifier|*
name|daddr
parameter_list|,
name|u_int16_t
name|dport
parameter_list|,
name|struct
name|pf_addr
modifier|*
name|naddr
parameter_list|,
name|u_int16_t
modifier|*
name|nport
parameter_list|,
name|u_int16_t
name|low
parameter_list|,
name|u_int16_t
name|high
parameter_list|,
name|struct
name|pf_src_node
modifier|*
modifier|*
name|sn
parameter_list|)
block|{
name|struct
name|pf_state
name|key
decl_stmt|;
name|struct
name|pf_addr
name|init_addr
decl_stmt|;
name|u_int16_t
name|cut
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|init_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|init_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pf_map_addr
argument_list|(
name|af
argument_list|,
name|r
argument_list|,
name|saddr
argument_list|,
name|naddr
argument_list|,
operator|&
name|init_addr
argument_list|,
name|sn
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|proto
operator|==
name|IPPROTO_ICMP
condition|)
block|{
name|low
operator|=
literal|1
expr_stmt|;
name|high
operator|=
literal|65535
expr_stmt|;
block|}
do|do
block|{
name|key
operator|.
name|af
operator|=
name|af
expr_stmt|;
name|key
operator|.
name|proto
operator|=
name|proto
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|ext
operator|.
name|addr
argument_list|,
name|daddr
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|gwy
operator|.
name|addr
argument_list|,
name|naddr
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|key
operator|.
name|ext
operator|.
name|port
operator|=
name|dport
expr_stmt|;
comment|/* 		 * port search; start random, step; 		 * similar 2 portloop in in_pcbbind 		 */
if|if
condition|(
operator|!
operator|(
name|proto
operator|==
name|IPPROTO_TCP
operator|||
name|proto
operator|==
name|IPPROTO_UDP
operator|||
name|proto
operator|==
name|IPPROTO_ICMP
operator|)
condition|)
block|{
name|key
operator|.
name|gwy
operator|.
name|port
operator|=
name|dport
expr_stmt|;
if|if
condition|(
name|pf_find_state_all
argument_list|(
operator|&
name|key
argument_list|,
name|PF_EXT_GWY
argument_list|,
name|NULL
argument_list|)
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|low
operator|==
literal|0
operator|&&
name|high
operator|==
literal|0
condition|)
block|{
name|key
operator|.
name|gwy
operator|.
name|port
operator|=
operator|*
name|nport
expr_stmt|;
if|if
condition|(
name|pf_find_state_all
argument_list|(
operator|&
name|key
argument_list|,
name|PF_EXT_GWY
argument_list|,
name|NULL
argument_list|)
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|low
operator|==
name|high
condition|)
block|{
name|key
operator|.
name|gwy
operator|.
name|port
operator|=
name|htons
argument_list|(
name|low
argument_list|)
expr_stmt|;
if|if
condition|(
name|pf_find_state_all
argument_list|(
operator|&
name|key
argument_list|,
name|PF_EXT_GWY
argument_list|,
name|NULL
argument_list|)
operator|==
name|NULL
condition|)
block|{
operator|*
name|nport
operator|=
name|htons
argument_list|(
name|low
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
else|else
block|{
name|u_int16_t
name|tmp
decl_stmt|;
if|if
condition|(
name|low
operator|>
name|high
condition|)
block|{
name|tmp
operator|=
name|low
expr_stmt|;
name|low
operator|=
name|high
expr_stmt|;
name|high
operator|=
name|tmp
expr_stmt|;
block|}
comment|/* low< high */
name|cut
operator|=
name|htonl
argument_list|(
name|arc4random
argument_list|()
argument_list|)
operator|%
operator|(
literal|1
operator|+
name|high
operator|-
name|low
operator|)
operator|+
name|low
expr_stmt|;
comment|/* low<= cut<= high */
for|for
control|(
name|tmp
operator|=
name|cut
init|;
name|tmp
operator|<=
name|high
condition|;
operator|++
operator|(
name|tmp
operator|)
control|)
block|{
name|key
operator|.
name|gwy
operator|.
name|port
operator|=
name|htons
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|pf_find_state_all
argument_list|(
operator|&
name|key
argument_list|,
name|PF_EXT_GWY
argument_list|,
name|NULL
argument_list|)
operator|==
name|NULL
condition|)
block|{
operator|*
name|nport
operator|=
name|htons
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
for|for
control|(
name|tmp
operator|=
name|cut
operator|-
literal|1
init|;
name|tmp
operator|>=
name|low
condition|;
operator|--
operator|(
name|tmp
operator|)
control|)
block|{
name|key
operator|.
name|gwy
operator|.
name|port
operator|=
name|htons
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|pf_find_state_all
argument_list|(
operator|&
name|key
argument_list|,
name|PF_EXT_GWY
argument_list|,
name|NULL
argument_list|)
operator|==
name|NULL
condition|)
block|{
operator|*
name|nport
operator|=
name|htons
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
block|}
switch|switch
condition|(
name|r
operator|->
name|rpool
operator|.
name|opts
operator|&
name|PF_POOL_TYPEMASK
condition|)
block|{
case|case
name|PF_POOL_RANDOM
case|:
case|case
name|PF_POOL_ROUNDROBIN
case|:
if|if
condition|(
name|pf_map_addr
argument_list|(
name|af
argument_list|,
name|r
argument_list|,
name|saddr
argument_list|,
name|naddr
argument_list|,
operator|&
name|init_addr
argument_list|,
name|sn
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
break|break;
case|case
name|PF_POOL_NONE
case|:
case|case
name|PF_POOL_SRCHASH
case|:
case|case
name|PF_POOL_BITMASK
case|:
default|default:
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
do|while
condition|(
operator|!
name|PF_AEQ
argument_list|(
operator|&
name|init_addr
argument_list|,
name|naddr
argument_list|,
name|af
argument_list|)
condition|)
do|;
return|return
operator|(
literal|1
operator|)
return|;
comment|/* none available */
block|}
end_function

begin_function
name|struct
name|pf_rule
modifier|*
name|pf_match_translation
parameter_list|(
name|struct
name|pf_pdesc
modifier|*
name|pd
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|int
name|off
parameter_list|,
name|int
name|direction
parameter_list|,
name|struct
name|pfi_kif
modifier|*
name|kif
parameter_list|,
name|struct
name|pf_addr
modifier|*
name|saddr
parameter_list|,
name|u_int16_t
name|sport
parameter_list|,
name|struct
name|pf_addr
modifier|*
name|daddr
parameter_list|,
name|u_int16_t
name|dport
parameter_list|,
name|int
name|rs_num
parameter_list|)
block|{
name|struct
name|pf_rule
modifier|*
name|r
decl_stmt|,
modifier|*
name|rm
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_ruleset
modifier|*
name|ruleset
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_tag
modifier|*
name|pftag
init|=
name|NULL
decl_stmt|;
name|int
name|tag
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|asd
init|=
literal|0
decl_stmt|;
name|r
operator|=
name|TAILQ_FIRST
argument_list|(
name|pf_main_ruleset
operator|.
name|rules
index|[
name|rs_num
index|]
operator|.
name|active
operator|.
name|ptr
argument_list|)
expr_stmt|;
while|while
condition|(
name|r
operator|&&
name|rm
operator|==
name|NULL
condition|)
block|{
name|struct
name|pf_rule_addr
modifier|*
name|src
init|=
name|NULL
decl_stmt|,
modifier|*
name|dst
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_addr_wrap
modifier|*
name|xdst
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|r
operator|->
name|action
operator|==
name|PF_BINAT
operator|&&
name|direction
operator|==
name|PF_IN
condition|)
block|{
name|src
operator|=
operator|&
name|r
operator|->
name|dst
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|rpool
operator|.
name|cur
operator|!=
name|NULL
condition|)
name|xdst
operator|=
operator|&
name|r
operator|->
name|rpool
operator|.
name|cur
operator|->
name|addr
expr_stmt|;
block|}
else|else
block|{
name|src
operator|=
operator|&
name|r
operator|->
name|src
expr_stmt|;
name|dst
operator|=
operator|&
name|r
operator|->
name|dst
expr_stmt|;
block|}
name|r
operator|->
name|evaluations
operator|++
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|kif
operator|!=
name|NULL
operator|&&
operator|(
name|r
operator|->
name|kif
operator|!=
name|kif
operator|&&
name|r
operator|->
name|kif
operator|!=
name|kif
operator|->
name|pfik_parent
operator|)
operator|==
operator|!
name|r
operator|->
name|ifnot
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_IFP
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|direction
operator|&&
name|r
operator|->
name|direction
operator|!=
name|direction
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_DIR
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|af
operator|&&
name|r
operator|->
name|af
operator|!=
name|pd
operator|->
name|af
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_AF
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|proto
operator|&&
name|r
operator|->
name|proto
operator|!=
name|pd
operator|->
name|proto
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_PROTO
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|PF_MISMATCHAW
argument_list|(
operator|&
name|src
operator|->
name|addr
argument_list|,
name|saddr
argument_list|,
name|pd
operator|->
name|af
argument_list|,
name|src
operator|->
name|neg
argument_list|)
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|src
operator|==
operator|&
name|r
operator|->
name|src
condition|?
name|PF_SKIP_SRC_ADDR
else|:
name|PF_SKIP_DST_ADDR
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|src
operator|->
name|port_op
operator|&&
operator|!
name|pf_match_port
argument_list|(
name|src
operator|->
name|port_op
argument_list|,
name|src
operator|->
name|port
index|[
literal|0
index|]
argument_list|,
name|src
operator|->
name|port
index|[
literal|1
index|]
argument_list|,
name|sport
argument_list|)
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|src
operator|==
operator|&
name|r
operator|->
name|src
condition|?
name|PF_SKIP_SRC_PORT
else|:
name|PF_SKIP_DST_PORT
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|dst
operator|!=
name|NULL
operator|&&
name|PF_MISMATCHAW
argument_list|(
operator|&
name|dst
operator|->
name|addr
argument_list|,
name|daddr
argument_list|,
name|pd
operator|->
name|af
argument_list|,
name|dst
operator|->
name|neg
argument_list|)
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_DST_ADDR
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|xdst
operator|!=
name|NULL
operator|&&
name|PF_MISMATCHAW
argument_list|(
name|xdst
argument_list|,
name|daddr
argument_list|,
name|pd
operator|->
name|af
argument_list|,
literal|0
argument_list|)
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|dst
operator|!=
name|NULL
operator|&&
name|dst
operator|->
name|port_op
operator|&&
operator|!
name|pf_match_port
argument_list|(
name|dst
operator|->
name|port_op
argument_list|,
name|dst
operator|->
name|port
index|[
literal|0
index|]
argument_list|,
name|dst
operator|->
name|port
index|[
literal|1
index|]
argument_list|,
name|dport
argument_list|)
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_DST_PORT
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|match_tag
operator|&&
operator|!
name|pf_match_tag
argument_list|(
name|m
argument_list|,
name|r
argument_list|,
operator|&
name|pftag
argument_list|,
operator|&
name|tag
argument_list|)
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|os_fingerprint
operator|!=
name|PF_OSFP_ANY
operator|&&
operator|(
name|pd
operator|->
name|proto
operator|!=
name|IPPROTO_TCP
operator|||
operator|!
name|pf_osfp_match
argument_list|(
name|pf_osfp_fingerprint
argument_list|(
name|pd
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|pd
operator|->
name|hdr
operator|.
name|tcp
argument_list|)
argument_list|,
name|r
operator|->
name|os_fingerprint
argument_list|)
operator|)
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|r
operator|->
name|tag
condition|)
name|tag
operator|=
name|r
operator|->
name|tag
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|anchor
operator|==
name|NULL
condition|)
block|{
name|rm
operator|=
name|r
expr_stmt|;
block|}
else|else
name|pf_step_into_anchor
argument_list|(
operator|&
name|asd
argument_list|,
operator|&
name|ruleset
argument_list|,
name|rs_num
argument_list|,
operator|&
name|r
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|==
name|NULL
condition|)
name|pf_step_out_of_anchor
argument_list|(
operator|&
name|asd
argument_list|,
operator|&
name|ruleset
argument_list|,
name|rs_num
argument_list|,
operator|&
name|r
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pf_tag_packet
argument_list|(
name|m
argument_list|,
name|pftag
argument_list|,
name|tag
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
if|if
condition|(
name|rm
operator|!=
name|NULL
operator|&&
operator|(
name|rm
operator|->
name|action
operator|==
name|PF_NONAT
operator|||
name|rm
operator|->
name|action
operator|==
name|PF_NORDR
operator|||
name|rm
operator|->
name|action
operator|==
name|PF_NOBINAT
operator|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
return|return
operator|(
name|rm
operator|)
return|;
block|}
end_function

begin_function
name|struct
name|pf_rule
modifier|*
name|pf_get_translation
parameter_list|(
name|struct
name|pf_pdesc
modifier|*
name|pd
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|int
name|off
parameter_list|,
name|int
name|direction
parameter_list|,
name|struct
name|pfi_kif
modifier|*
name|kif
parameter_list|,
name|struct
name|pf_src_node
modifier|*
modifier|*
name|sn
parameter_list|,
name|struct
name|pf_addr
modifier|*
name|saddr
parameter_list|,
name|u_int16_t
name|sport
parameter_list|,
name|struct
name|pf_addr
modifier|*
name|daddr
parameter_list|,
name|u_int16_t
name|dport
parameter_list|,
name|struct
name|pf_addr
modifier|*
name|naddr
parameter_list|,
name|u_int16_t
modifier|*
name|nport
parameter_list|)
block|{
name|struct
name|pf_rule
modifier|*
name|r
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|direction
operator|==
name|PF_OUT
condition|)
block|{
name|r
operator|=
name|pf_match_translation
argument_list|(
name|pd
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|direction
argument_list|,
name|kif
argument_list|,
name|saddr
argument_list|,
name|sport
argument_list|,
name|daddr
argument_list|,
name|dport
argument_list|,
name|PF_RULESET_BINAT
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|NULL
condition|)
name|r
operator|=
name|pf_match_translation
argument_list|(
name|pd
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|direction
argument_list|,
name|kif
argument_list|,
name|saddr
argument_list|,
name|sport
argument_list|,
name|daddr
argument_list|,
name|dport
argument_list|,
name|PF_RULESET_NAT
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|r
operator|=
name|pf_match_translation
argument_list|(
name|pd
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|direction
argument_list|,
name|kif
argument_list|,
name|saddr
argument_list|,
name|sport
argument_list|,
name|daddr
argument_list|,
name|dport
argument_list|,
name|PF_RULESET_RDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|NULL
condition|)
name|r
operator|=
name|pf_match_translation
argument_list|(
name|pd
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|direction
argument_list|,
name|kif
argument_list|,
name|saddr
argument_list|,
name|sport
argument_list|,
name|daddr
argument_list|,
name|dport
argument_list|,
name|PF_RULESET_BINAT
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|!=
name|NULL
condition|)
block|{
switch|switch
condition|(
name|r
operator|->
name|action
condition|)
block|{
case|case
name|PF_NONAT
case|:
case|case
name|PF_NOBINAT
case|:
case|case
name|PF_NORDR
case|:
return|return
operator|(
name|NULL
operator|)
return|;
case|case
name|PF_NAT
case|:
if|if
condition|(
name|pf_get_sport
argument_list|(
name|pd
operator|->
name|af
argument_list|,
name|pd
operator|->
name|proto
argument_list|,
name|r
argument_list|,
name|saddr
argument_list|,
name|daddr
argument_list|,
name|dport
argument_list|,
name|naddr
argument_list|,
name|nport
argument_list|,
name|r
operator|->
name|rpool
operator|.
name|proxy_port
index|[
literal|0
index|]
argument_list|,
name|r
operator|->
name|rpool
operator|.
name|proxy_port
index|[
literal|1
index|]
argument_list|,
name|sn
argument_list|)
condition|)
block|{
name|DPFPRINTF
argument_list|(
name|PF_DEBUG_MISC
argument_list|,
operator|(
literal|"pf: NAT proxy port allocation "
literal|"(%u-%u) failed\n"
operator|,
name|r
operator|->
name|rpool
operator|.
name|proxy_port
index|[
literal|0
index|]
operator|,
name|r
operator|->
name|rpool
operator|.
name|proxy_port
index|[
literal|1
index|]
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
break|break;
case|case
name|PF_BINAT
case|:
switch|switch
condition|(
name|direction
condition|)
block|{
case|case
name|PF_OUT
case|:
if|if
condition|(
name|r
operator|->
name|rpool
operator|.
name|cur
operator|->
name|addr
operator|.
name|type
operator|==
name|PF_ADDR_DYNIFTL
condition|)
block|{
switch|switch
condition|(
name|pd
operator|->
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
if|if
condition|(
name|r
operator|->
name|rpool
operator|.
name|cur
operator|->
name|addr
operator|.
name|p
operator|.
name|dyn
operator|->
name|pfid_acnt4
operator|<
literal|1
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|PF_POOLMASK
argument_list|(
name|naddr
argument_list|,
operator|&
name|r
operator|->
name|rpool
operator|.
name|cur
operator|->
name|addr
operator|.
name|p
operator|.
name|dyn
operator|->
name|pfid_addr4
argument_list|,
operator|&
name|r
operator|->
name|rpool
operator|.
name|cur
operator|->
name|addr
operator|.
name|p
operator|.
name|dyn
operator|->
name|pfid_mask4
argument_list|,
name|saddr
argument_list|,
name|AF_INET
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
if|if
condition|(
name|r
operator|->
name|rpool
operator|.
name|cur
operator|->
name|addr
operator|.
name|p
operator|.
name|dyn
operator|->
name|pfid_acnt6
operator|<
literal|1
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|PF_POOLMASK
argument_list|(
name|naddr
argument_list|,
operator|&
name|r
operator|->
name|rpool
operator|.
name|cur
operator|->
name|addr
operator|.
name|p
operator|.
name|dyn
operator|->
name|pfid_addr6
argument_list|,
operator|&
name|r
operator|->
name|rpool
operator|.
name|cur
operator|->
name|addr
operator|.
name|p
operator|.
name|dyn
operator|->
name|pfid_mask6
argument_list|,
name|saddr
argument_list|,
name|AF_INET6
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
block|}
else|else
name|PF_POOLMASK
argument_list|(
name|naddr
argument_list|,
operator|&
name|r
operator|->
name|rpool
operator|.
name|cur
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|addr
argument_list|,
operator|&
name|r
operator|->
name|rpool
operator|.
name|cur
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|mask
argument_list|,
name|saddr
argument_list|,
name|pd
operator|->
name|af
argument_list|)
expr_stmt|;
break|break;
case|case
name|PF_IN
case|:
if|if
condition|(
name|r
operator|->
name|src
operator|.
name|addr
operator|.
name|type
operator|==
name|PF_ADDR_DYNIFTL
condition|)
block|{
switch|switch
condition|(
name|pd
operator|->
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
if|if
condition|(
name|r
operator|->
name|src
operator|.
name|addr
operator|.
name|p
operator|.
name|dyn
operator|->
name|pfid_acnt4
operator|<
literal|1
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|PF_POOLMASK
argument_list|(
name|naddr
argument_list|,
operator|&
name|r
operator|->
name|src
operator|.
name|addr
operator|.
name|p
operator|.
name|dyn
operator|->
name|pfid_addr4
argument_list|,
operator|&
name|r
operator|->
name|src
operator|.
name|addr
operator|.
name|p
operator|.
name|dyn
operator|->
name|pfid_mask4
argument_list|,
name|daddr
argument_list|,
name|AF_INET
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
if|if
condition|(
name|r
operator|->
name|src
operator|.
name|addr
operator|.
name|p
operator|.
name|dyn
operator|->
name|pfid_acnt6
operator|<
literal|1
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|PF_POOLMASK
argument_list|(
name|naddr
argument_list|,
operator|&
name|r
operator|->
name|src
operator|.
name|addr
operator|.
name|p
operator|.
name|dyn
operator|->
name|pfid_addr6
argument_list|,
operator|&
name|r
operator|->
name|src
operator|.
name|addr
operator|.
name|p
operator|.
name|dyn
operator|->
name|pfid_mask6
argument_list|,
name|daddr
argument_list|,
name|AF_INET6
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
block|}
else|else
name|PF_POOLMASK
argument_list|(
name|naddr
argument_list|,
operator|&
name|r
operator|->
name|src
operator|.
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|addr
argument_list|,
operator|&
name|r
operator|->
name|src
operator|.
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|mask
argument_list|,
name|daddr
argument_list|,
name|pd
operator|->
name|af
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|PF_RDR
case|:
block|{
if|if
condition|(
name|pf_map_addr
argument_list|(
name|pd
operator|->
name|af
argument_list|,
name|r
argument_list|,
name|saddr
argument_list|,
name|naddr
argument_list|,
name|NULL
argument_list|,
name|sn
argument_list|)
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
if|if
condition|(
operator|(
name|r
operator|->
name|rpool
operator|.
name|opts
operator|&
name|PF_POOL_TYPEMASK
operator|)
operator|==
name|PF_POOL_BITMASK
condition|)
name|PF_POOLMASK
argument_list|(
name|naddr
argument_list|,
name|naddr
argument_list|,
operator|&
name|r
operator|->
name|rpool
operator|.
name|cur
operator|->
name|addr
operator|.
name|v
operator|.
name|a
operator|.
name|mask
argument_list|,
name|daddr
argument_list|,
name|pd
operator|->
name|af
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|rpool
operator|.
name|proxy_port
index|[
literal|1
index|]
condition|)
block|{
name|u_int32_t
name|tmp_nport
decl_stmt|;
name|tmp_nport
operator|=
operator|(
operator|(
name|ntohs
argument_list|(
name|dport
argument_list|)
operator|-
name|ntohs
argument_list|(
name|r
operator|->
name|dst
operator|.
name|port
index|[
literal|0
index|]
argument_list|)
operator|)
operator|%
operator|(
name|r
operator|->
name|rpool
operator|.
name|proxy_port
index|[
literal|1
index|]
operator|-
name|r
operator|->
name|rpool
operator|.
name|proxy_port
index|[
literal|0
index|]
operator|+
literal|1
operator|)
operator|)
operator|+
name|r
operator|->
name|rpool
operator|.
name|proxy_port
index|[
literal|0
index|]
expr_stmt|;
comment|/* wrap around if necessary */
if|if
condition|(
name|tmp_nport
operator|>
literal|65535
condition|)
name|tmp_nport
operator|-=
literal|65535
expr_stmt|;
operator|*
name|nport
operator|=
name|htons
argument_list|(
operator|(
name|u_int16_t
operator|)
name|tmp_nport
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|r
operator|->
name|rpool
operator|.
name|proxy_port
index|[
literal|0
index|]
condition|)
operator|*
name|nport
operator|=
name|htons
argument_list|(
name|r
operator|->
name|rpool
operator|.
name|proxy_port
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
return|return
operator|(
name|NULL
operator|)
return|;
block|}
block|}
return|return
operator|(
name|r
operator|)
return|;
block|}
end_function

begin_function
name|int
ifdef|#
directive|ifdef
name|__FreeBSD__
name|pf_socket_lookup
parameter_list|(
name|uid_t
modifier|*
name|uid
parameter_list|,
name|gid_t
modifier|*
name|gid
parameter_list|,
name|int
name|direction
parameter_list|,
name|struct
name|pf_pdesc
modifier|*
name|pd
parameter_list|,
name|struct
name|inpcb
modifier|*
name|inp_arg
parameter_list|)
else|#
directive|else
function|pf_socket_lookup
parameter_list|(
name|uid_t
modifier|*
name|uid
parameter_list|,
name|gid_t
modifier|*
name|gid
parameter_list|,
name|int
name|direction
parameter_list|,
name|struct
name|pf_pdesc
modifier|*
name|pd
parameter_list|)
endif|#
directive|endif
block|{
name|struct
name|pf_addr
modifier|*
name|saddr
decl_stmt|,
modifier|*
name|daddr
decl_stmt|;
name|u_int16_t
name|sport
decl_stmt|,
name|dport
decl_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
name|struct
name|inpcbinfo
modifier|*
name|pi
decl_stmt|;
else|#
directive|else
name|struct
name|inpcbtable
modifier|*
name|tb
decl_stmt|;
endif|#
directive|endif
name|struct
name|inpcb
modifier|*
name|inp
decl_stmt|;
operator|*
name|uid
operator|=
name|UID_MAX
expr_stmt|;
operator|*
name|gid
operator|=
name|GID_MAX
expr_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
if|if
condition|(
name|inp_arg
operator|!=
name|NULL
condition|)
block|{
name|INP_LOCK_ASSERT
argument_list|(
name|inp_arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|inp_arg
operator|->
name|inp_socket
condition|)
block|{
operator|*
name|uid
operator|=
name|inp_arg
operator|->
name|inp_socket
operator|->
name|so_cred
operator|->
name|cr_uid
expr_stmt|;
operator|*
name|gid
operator|=
name|inp_arg
operator|->
name|inp_socket
operator|->
name|so_cred
operator|->
name|cr_groups
index|[
literal|0
index|]
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
else|else
return|return
operator|(
literal|0
operator|)
return|;
block|}
endif|#
directive|endif
switch|switch
condition|(
name|pd
operator|->
name|proto
condition|)
block|{
case|case
name|IPPROTO_TCP
case|:
name|sport
operator|=
name|pd
operator|->
name|hdr
operator|.
name|tcp
operator|->
name|th_sport
expr_stmt|;
name|dport
operator|=
name|pd
operator|->
name|hdr
operator|.
name|tcp
operator|->
name|th_dport
expr_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
name|pi
operator|=
operator|&
name|tcbinfo
expr_stmt|;
else|#
directive|else
name|tb
operator|=
operator|&
name|tcbtable
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|IPPROTO_UDP
case|:
name|sport
operator|=
name|pd
operator|->
name|hdr
operator|.
name|udp
operator|->
name|uh_sport
expr_stmt|;
name|dport
operator|=
name|pd
operator|->
name|hdr
operator|.
name|udp
operator|->
name|uh_dport
expr_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
name|pi
operator|=
operator|&
name|udbinfo
expr_stmt|;
else|#
directive|else
name|tb
operator|=
operator|&
name|udbtable
expr_stmt|;
endif|#
directive|endif
break|break;
default|default:
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|direction
operator|==
name|PF_IN
condition|)
block|{
name|saddr
operator|=
name|pd
operator|->
name|src
expr_stmt|;
name|daddr
operator|=
name|pd
operator|->
name|dst
expr_stmt|;
block|}
else|else
block|{
name|u_int16_t
name|p
decl_stmt|;
name|p
operator|=
name|sport
expr_stmt|;
name|sport
operator|=
name|dport
expr_stmt|;
name|dport
operator|=
name|p
expr_stmt|;
name|saddr
operator|=
name|pd
operator|->
name|dst
expr_stmt|;
name|daddr
operator|=
name|pd
operator|->
name|src
expr_stmt|;
block|}
switch|switch
condition|(
name|pd
operator|->
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
ifdef|#
directive|ifdef
name|__FreeBSD__
name|INP_INFO_RLOCK
argument_list|(
name|pi
argument_list|)
expr_stmt|;
comment|/* XXX LOR */
name|inp
operator|=
name|in_pcblookup_hash
argument_list|(
name|pi
argument_list|,
name|saddr
operator|->
name|v4
argument_list|,
name|sport
argument_list|,
name|daddr
operator|->
name|v4
argument_list|,
name|dport
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|inp
operator|==
name|NULL
condition|)
block|{
name|inp
operator|=
name|in_pcblookup_hash
argument_list|(
name|pi
argument_list|,
name|saddr
operator|->
name|v4
argument_list|,
name|sport
argument_list|,
name|daddr
operator|->
name|v4
argument_list|,
name|dport
argument_list|,
name|INPLOOKUP_WILDCARD
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|inp
operator|==
name|NULL
condition|)
block|{
name|INP_INFO_RUNLOCK
argument_list|(
name|pi
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
else|#
directive|else
name|inp
operator|=
name|in_pcbhashlookup
argument_list|(
name|tb
argument_list|,
name|saddr
operator|->
name|v4
argument_list|,
name|sport
argument_list|,
name|daddr
operator|->
name|v4
argument_list|,
name|dport
argument_list|)
expr_stmt|;
if|if
condition|(
name|inp
operator|==
name|NULL
condition|)
block|{
name|inp
operator|=
name|in_pcblookup_listen
argument_list|(
name|tb
argument_list|,
name|daddr
operator|->
name|v4
argument_list|,
name|dport
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|inp
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
endif|#
directive|endif
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
ifdef|#
directive|ifdef
name|__FreeBSD__
name|INP_INFO_RLOCK
argument_list|(
name|pi
argument_list|)
expr_stmt|;
name|inp
operator|=
name|in6_pcblookup_hash
argument_list|(
name|pi
argument_list|,
operator|&
name|saddr
operator|->
name|v6
argument_list|,
name|sport
argument_list|,
operator|&
name|daddr
operator|->
name|v6
argument_list|,
name|dport
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|inp
operator|==
name|NULL
condition|)
block|{
name|inp
operator|=
name|in6_pcblookup_hash
argument_list|(
name|pi
argument_list|,
operator|&
name|saddr
operator|->
name|v6
argument_list|,
name|sport
argument_list|,
operator|&
name|daddr
operator|->
name|v6
argument_list|,
name|dport
argument_list|,
name|INPLOOKUP_WILDCARD
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|inp
operator|==
name|NULL
condition|)
block|{
name|INP_INFO_RUNLOCK
argument_list|(
name|pi
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
else|#
directive|else
name|inp
operator|=
name|in6_pcbhashlookup
argument_list|(
name|tb
argument_list|,
operator|&
name|saddr
operator|->
name|v6
argument_list|,
name|sport
argument_list|,
operator|&
name|daddr
operator|->
name|v6
argument_list|,
name|dport
argument_list|)
expr_stmt|;
if|if
condition|(
name|inp
operator|==
name|NULL
condition|)
block|{
name|inp
operator|=
name|in6_pcblookup_listen
argument_list|(
name|tb
argument_list|,
operator|&
name|daddr
operator|->
name|v6
argument_list|,
name|dport
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|inp
operator|==
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
block|}
endif|#
directive|endif
break|break;
endif|#
directive|endif
comment|/* INET6 */
default|default:
return|return
operator|(
literal|0
operator|)
return|;
block|}
ifdef|#
directive|ifdef
name|__FreeBSD__
name|INP_LOCK
argument_list|(
name|inp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|inp
operator|->
name|inp_socket
operator|==
name|NULL
operator|)
operator|||
operator|(
name|inp
operator|->
name|inp_socket
operator|->
name|so_cred
operator|==
name|NULL
operator|)
condition|)
block|{
name|INP_UNLOCK
argument_list|(
name|inp
argument_list|)
expr_stmt|;
name|INP_INFO_RUNLOCK
argument_list|(
name|pi
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
operator|*
name|uid
operator|=
name|inp
operator|->
name|inp_socket
operator|->
name|so_cred
operator|->
name|cr_uid
expr_stmt|;
operator|*
name|gid
operator|=
name|inp
operator|->
name|inp_socket
operator|->
name|so_cred
operator|->
name|cr_groups
index|[
literal|0
index|]
expr_stmt|;
name|INP_UNLOCK
argument_list|(
name|inp
argument_list|)
expr_stmt|;
name|INP_INFO_RUNLOCK
argument_list|(
name|pi
argument_list|)
expr_stmt|;
else|#
directive|else
operator|*
name|uid
operator|=
name|inp
operator|->
name|inp_socket
operator|->
name|so_euid
expr_stmt|;
operator|*
name|gid
operator|=
name|inp
operator|->
name|inp_socket
operator|->
name|so_egid
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|u_int8_t
name|pf_get_wscale
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|int
name|off
parameter_list|,
name|u_int16_t
name|th_off
parameter_list|,
name|sa_family_t
name|af
parameter_list|)
block|{
name|int
name|hlen
decl_stmt|;
name|u_int8_t
name|hdr
index|[
literal|60
index|]
decl_stmt|;
name|u_int8_t
modifier|*
name|opt
decl_stmt|,
name|optlen
decl_stmt|;
name|u_int8_t
name|wscale
init|=
literal|0
decl_stmt|;
name|hlen
operator|=
name|th_off
operator|<<
literal|2
expr_stmt|;
comment|/* hlen<= sizeof(hdr) */
if|if
condition|(
name|hlen
operator|<=
sizeof|sizeof
argument_list|(
expr|struct
name|tcphdr
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
name|pf_pull_hdr
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
name|hdr
argument_list|,
name|hlen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|af
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|opt
operator|=
name|hdr
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|tcphdr
argument_list|)
expr_stmt|;
name|hlen
operator|-=
sizeof|sizeof
argument_list|(
expr|struct
name|tcphdr
argument_list|)
expr_stmt|;
while|while
condition|(
name|hlen
operator|>=
literal|3
condition|)
block|{
switch|switch
condition|(
operator|*
name|opt
condition|)
block|{
case|case
name|TCPOPT_EOL
case|:
case|case
name|TCPOPT_NOP
case|:
operator|++
name|opt
expr_stmt|;
operator|--
name|hlen
expr_stmt|;
break|break;
case|case
name|TCPOPT_WINDOW
case|:
name|wscale
operator|=
name|opt
index|[
literal|2
index|]
expr_stmt|;
if|if
condition|(
name|wscale
operator|>
name|TCP_MAX_WINSHIFT
condition|)
name|wscale
operator|=
name|TCP_MAX_WINSHIFT
expr_stmt|;
name|wscale
operator||=
name|PF_WSCALE_FLAG
expr_stmt|;
comment|/* FALLTHROUGH */
default|default:
name|optlen
operator|=
name|opt
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|optlen
operator|<
literal|2
condition|)
name|optlen
operator|=
literal|2
expr_stmt|;
name|hlen
operator|-=
name|optlen
expr_stmt|;
name|opt
operator|+=
name|optlen
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
name|wscale
operator|)
return|;
block|}
end_function

begin_function
name|u_int16_t
name|pf_get_mss
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|int
name|off
parameter_list|,
name|u_int16_t
name|th_off
parameter_list|,
name|sa_family_t
name|af
parameter_list|)
block|{
name|int
name|hlen
decl_stmt|;
name|u_int8_t
name|hdr
index|[
literal|60
index|]
decl_stmt|;
name|u_int8_t
modifier|*
name|opt
decl_stmt|,
name|optlen
decl_stmt|;
name|u_int16_t
name|mss
init|=
name|tcp_mssdflt
decl_stmt|;
name|hlen
operator|=
name|th_off
operator|<<
literal|2
expr_stmt|;
comment|/* hlen<= sizeof(hdr) */
if|if
condition|(
name|hlen
operator|<=
sizeof|sizeof
argument_list|(
expr|struct
name|tcphdr
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|!
name|pf_pull_hdr
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
name|hdr
argument_list|,
name|hlen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|af
argument_list|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|opt
operator|=
name|hdr
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|tcphdr
argument_list|)
expr_stmt|;
name|hlen
operator|-=
sizeof|sizeof
argument_list|(
expr|struct
name|tcphdr
argument_list|)
expr_stmt|;
while|while
condition|(
name|hlen
operator|>=
name|TCPOLEN_MAXSEG
condition|)
block|{
switch|switch
condition|(
operator|*
name|opt
condition|)
block|{
case|case
name|TCPOPT_EOL
case|:
case|case
name|TCPOPT_NOP
case|:
operator|++
name|opt
expr_stmt|;
operator|--
name|hlen
expr_stmt|;
break|break;
case|case
name|TCPOPT_MAXSEG
case|:
name|bcopy
argument_list|(
call|(
name|caddr_t
call|)
argument_list|(
name|opt
operator|+
literal|2
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|mss
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|NTOHS
argument_list|(
name|mss
argument_list|)
expr_stmt|;
comment|/* FALLTHROUGH */
default|default:
name|optlen
operator|=
name|opt
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|optlen
operator|<
literal|2
condition|)
name|optlen
operator|=
literal|2
expr_stmt|;
name|hlen
operator|-=
name|optlen
expr_stmt|;
name|opt
operator|+=
name|optlen
expr_stmt|;
break|break;
block|}
block|}
return|return
operator|(
name|mss
operator|)
return|;
block|}
end_function

begin_function
name|u_int16_t
name|pf_calc_mss
parameter_list|(
name|struct
name|pf_addr
modifier|*
name|addr
parameter_list|,
name|sa_family_t
name|af
parameter_list|,
name|u_int16_t
name|offer
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|INET
name|struct
name|sockaddr_in
modifier|*
name|dst
decl_stmt|;
name|struct
name|route
name|ro
decl_stmt|;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
name|struct
name|sockaddr_in6
modifier|*
name|dst6
decl_stmt|;
name|struct
name|route_in6
name|ro6
decl_stmt|;
endif|#
directive|endif
comment|/* INET6 */
name|struct
name|rtentry
modifier|*
name|rt
init|=
name|NULL
decl_stmt|;
name|int
name|hlen
init|=
literal|0
decl_stmt|;
comment|/* make the compiler happy */
name|u_int16_t
name|mss
init|=
name|tcp_mssdflt
decl_stmt|;
switch|switch
condition|(
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
name|hlen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|ro
argument_list|,
sizeof|sizeof
argument_list|(
name|ro
argument_list|)
argument_list|)
expr_stmt|;
name|dst
operator|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|&
name|ro
operator|.
name|ro_dst
expr_stmt|;
name|dst
operator|->
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|dst
operator|->
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|dst
argument_list|)
expr_stmt|;
name|dst
operator|->
name|sin_addr
operator|=
name|addr
operator|->
name|v4
expr_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
ifdef|#
directive|ifdef
name|RTF_PRCLONING
name|rtalloc_ign
argument_list|(
operator|&
name|ro
argument_list|,
operator|(
name|RTF_CLONING
operator||
name|RTF_PRCLONING
operator|)
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* !RTF_PRCLONING */
name|rtalloc_ign
argument_list|(
operator|&
name|ro
argument_list|,
name|RTF_CLONING
argument_list|)
expr_stmt|;
endif|#
directive|endif
else|#
directive|else
comment|/* ! __FreeBSD__ */
name|rtalloc_noclone
argument_list|(
operator|&
name|ro
argument_list|,
name|NO_CLONING
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|rt
operator|=
name|ro
operator|.
name|ro_rt
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
name|hlen
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|&
name|ro6
argument_list|,
sizeof|sizeof
argument_list|(
name|ro6
argument_list|)
argument_list|)
expr_stmt|;
name|dst6
operator|=
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
operator|&
name|ro6
operator|.
name|ro_dst
expr_stmt|;
name|dst6
operator|->
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|dst6
operator|->
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|dst6
argument_list|)
expr_stmt|;
name|dst6
operator|->
name|sin6_addr
operator|=
name|addr
operator|->
name|v6
expr_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
ifdef|#
directive|ifdef
name|RTF_PRCLONING
name|rtalloc_ign
argument_list|(
operator|(
expr|struct
name|route
operator|*
operator|)
operator|&
name|ro6
argument_list|,
operator|(
name|RTF_CLONING
operator||
name|RTF_PRCLONING
operator|)
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* !RTF_PRCLONING */
name|rtalloc_ign
argument_list|(
operator|(
expr|struct
name|route
operator|*
operator|)
operator|&
name|ro6
argument_list|,
name|RTF_CLONING
argument_list|)
expr_stmt|;
endif|#
directive|endif
else|#
directive|else
comment|/* ! __FreeBSD__ */
name|rtalloc_noclone
argument_list|(
operator|(
expr|struct
name|route
operator|*
operator|)
operator|&
name|ro6
argument_list|,
name|NO_CLONING
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|rt
operator|=
name|ro6
operator|.
name|ro_rt
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
if|if
condition|(
name|rt
operator|&&
name|rt
operator|->
name|rt_ifp
condition|)
block|{
name|mss
operator|=
name|rt
operator|->
name|rt_ifp
operator|->
name|if_mtu
operator|-
name|hlen
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|tcphdr
argument_list|)
expr_stmt|;
name|mss
operator|=
name|max
argument_list|(
name|tcp_mssdflt
argument_list|,
name|mss
argument_list|)
expr_stmt|;
name|RTFREE
argument_list|(
name|rt
argument_list|)
expr_stmt|;
block|}
name|mss
operator|=
name|min
argument_list|(
name|mss
argument_list|,
name|offer
argument_list|)
expr_stmt|;
name|mss
operator|=
name|max
argument_list|(
name|mss
argument_list|,
literal|64
argument_list|)
expr_stmt|;
comment|/* sanity - at least max opt space */
return|return
operator|(
name|mss
operator|)
return|;
block|}
end_function

begin_function
name|void
name|pf_set_rt_ifp
parameter_list|(
name|struct
name|pf_state
modifier|*
name|s
parameter_list|,
name|struct
name|pf_addr
modifier|*
name|saddr
parameter_list|)
block|{
name|struct
name|pf_rule
modifier|*
name|r
init|=
name|s
operator|->
name|rule
operator|.
name|ptr
decl_stmt|;
name|s
operator|->
name|rt_kif
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|r
operator|->
name|rt
operator|||
name|r
operator|->
name|rt
operator|==
name|PF_FASTROUTE
condition|)
return|return;
switch|switch
condition|(
name|s
operator|->
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
name|pf_map_addr
argument_list|(
name|AF_INET
argument_list|,
name|r
argument_list|,
name|saddr
argument_list|,
operator|&
name|s
operator|->
name|rt_addr
argument_list|,
name|NULL
argument_list|,
operator|&
name|s
operator|->
name|nat_src_node
argument_list|)
expr_stmt|;
name|s
operator|->
name|rt_kif
operator|=
name|r
operator|->
name|rpool
operator|.
name|cur
operator|->
name|kif
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
name|pf_map_addr
argument_list|(
name|AF_INET6
argument_list|,
name|r
argument_list|,
name|saddr
argument_list|,
operator|&
name|s
operator|->
name|rt_addr
argument_list|,
name|NULL
argument_list|,
operator|&
name|s
operator|->
name|nat_src_node
argument_list|)
expr_stmt|;
name|s
operator|->
name|rt_kif
operator|=
name|r
operator|->
name|rpool
operator|.
name|cur
operator|->
name|kif
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
block|}
end_function

begin_decl_stmt
name|int
name|pf_test_tcp
argument_list|(
expr|struct
name|pf_rule
operator|*
operator|*
name|rm
argument_list|,
expr|struct
name|pf_state
operator|*
operator|*
name|sm
argument_list|,
name|int
name|direction
argument_list|,
expr|struct
name|pfi_kif
operator|*
name|kif
argument_list|,
expr|struct
name|mbuf
operator|*
name|m
argument_list|,
name|int
name|off
argument_list|,
name|void
operator|*
name|h
argument_list|,
ifdef|#
directive|ifdef
name|__FreeBSD__
expr|struct
name|pf_pdesc
operator|*
name|pd
argument_list|,
expr|struct
name|pf_rule
operator|*
operator|*
name|am
argument_list|,
expr|struct
name|pf_ruleset
operator|*
operator|*
name|rsm
argument_list|,
expr|struct
name|ifqueue
operator|*
name|ifq
argument_list|,
expr|struct
name|inpcb
operator|*
name|inp
argument_list|)
else|#
directive|else
decl|struct
name|pf_pdesc
modifier|*
name|pd
decl_stmt|, struct
name|pf_rule
modifier|*
modifier|*
name|am
decl_stmt|, struct
name|pf_ruleset
modifier|*
modifier|*
name|rsm
decl_stmt|,     struct
name|ifqueue
modifier|*
name|ifq
decl_stmt|)
endif|#
directive|endif
block|{
name|struct
name|pf_rule
modifier|*
name|nr
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_addr
modifier|*
name|saddr
init|=
name|pd
operator|->
name|src
decl_stmt|,
modifier|*
name|daddr
init|=
name|pd
operator|->
name|dst
decl_stmt|;
name|struct
name|tcphdr
modifier|*
name|th
init|=
name|pd
operator|->
name|hdr
operator|.
name|tcp
decl_stmt|;
name|u_int16_t
name|bport
decl_stmt|,
name|nport
init|=
literal|0
decl_stmt|;
name|sa_family_t
name|af
init|=
name|pd
operator|->
name|af
decl_stmt|;
name|int
name|lookup
init|=
operator|-
literal|1
decl_stmt|;
name|uid_t
name|uid
decl_stmt|;
name|gid_t
name|gid
decl_stmt|;
name|struct
name|pf_rule
modifier|*
name|r
decl_stmt|,
modifier|*
name|a
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_ruleset
modifier|*
name|ruleset
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_src_node
modifier|*
name|nsn
init|=
name|NULL
decl_stmt|;
name|u_short
name|reason
decl_stmt|;
name|int
name|rewrite
init|=
literal|0
decl_stmt|;
name|struct
name|pf_tag
modifier|*
name|pftag
init|=
name|NULL
decl_stmt|;
name|int
name|tag
init|=
operator|-
literal|1
decl_stmt|;
name|u_int16_t
name|mss
init|=
name|tcp_mssdflt
decl_stmt|;
name|int
name|asd
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|pf_check_congestion
argument_list|(
name|ifq
argument_list|)
condition|)
block|{
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_CONGEST
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
name|r
operator|=
name|TAILQ_FIRST
argument_list|(
name|pf_main_ruleset
operator|.
name|rules
index|[
name|PF_RULESET_FILTER
index|]
operator|.
name|active
operator|.
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|direction
operator|==
name|PF_OUT
condition|)
block|{
name|bport
operator|=
name|nport
operator|=
name|th
operator|->
name|th_sport
expr_stmt|;
comment|/* check outgoing packet for BINAT/NAT */
if|if
condition|(
operator|(
name|nr
operator|=
name|pf_get_translation
argument_list|(
name|pd
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|PF_OUT
argument_list|,
name|kif
argument_list|,
operator|&
name|nsn
argument_list|,
name|saddr
argument_list|,
name|th
operator|->
name|th_sport
argument_list|,
name|daddr
argument_list|,
name|th
operator|->
name|th_dport
argument_list|,
operator|&
name|pd
operator|->
name|naddr
argument_list|,
operator|&
name|nport
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|saddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|pf_change_ap
argument_list|(
name|saddr
argument_list|,
operator|&
name|th
operator|->
name|th_sport
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
operator|&
name|th
operator|->
name|th_sum
argument_list|,
operator|&
name|pd
operator|->
name|naddr
argument_list|,
name|nport
argument_list|,
literal|0
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|rewrite
operator|++
expr_stmt|;
if|if
condition|(
name|nr
operator|->
name|natpass
condition|)
name|r
operator|=
name|NULL
expr_stmt|;
name|pd
operator|->
name|nat_rule
operator|=
name|nr
expr_stmt|;
block|}
block|}
else|else
block|{
name|bport
operator|=
name|nport
operator|=
name|th
operator|->
name|th_dport
expr_stmt|;
comment|/* check incoming packet for BINAT/RDR */
if|if
condition|(
operator|(
name|nr
operator|=
name|pf_get_translation
argument_list|(
name|pd
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|PF_IN
argument_list|,
name|kif
argument_list|,
operator|&
name|nsn
argument_list|,
name|saddr
argument_list|,
name|th
operator|->
name|th_sport
argument_list|,
name|daddr
argument_list|,
name|th
operator|->
name|th_dport
argument_list|,
operator|&
name|pd
operator|->
name|naddr
argument_list|,
operator|&
name|nport
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|daddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|pf_change_ap
argument_list|(
name|daddr
argument_list|,
operator|&
name|th
operator|->
name|th_dport
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
operator|&
name|th
operator|->
name|th_sum
argument_list|,
operator|&
name|pd
operator|->
name|naddr
argument_list|,
name|nport
argument_list|,
literal|0
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|rewrite
operator|++
expr_stmt|;
if|if
condition|(
name|nr
operator|->
name|natpass
condition|)
name|r
operator|=
name|NULL
expr_stmt|;
name|pd
operator|->
name|nat_rule
operator|=
name|nr
expr_stmt|;
block|}
block|}
while|while
condition|(
name|r
operator|!=
name|NULL
condition|)
block|{
name|r
operator|->
name|evaluations
operator|++
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|kif
operator|!=
name|NULL
operator|&&
operator|(
name|r
operator|->
name|kif
operator|!=
name|kif
operator|&&
name|r
operator|->
name|kif
operator|!=
name|kif
operator|->
name|pfik_parent
operator|)
operator|==
operator|!
name|r
operator|->
name|ifnot
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_IFP
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|direction
operator|&&
name|r
operator|->
name|direction
operator|!=
name|direction
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_DIR
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|af
operator|&&
name|r
operator|->
name|af
operator|!=
name|af
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_AF
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|proto
operator|&&
name|r
operator|->
name|proto
operator|!=
name|IPPROTO_TCP
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_PROTO
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|PF_MISMATCHAW
argument_list|(
operator|&
name|r
operator|->
name|src
operator|.
name|addr
argument_list|,
name|saddr
argument_list|,
name|af
argument_list|,
name|r
operator|->
name|src
operator|.
name|neg
argument_list|)
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_SRC_ADDR
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|src
operator|.
name|port_op
operator|&&
operator|!
name|pf_match_port
argument_list|(
name|r
operator|->
name|src
operator|.
name|port_op
argument_list|,
name|r
operator|->
name|src
operator|.
name|port
index|[
literal|0
index|]
argument_list|,
name|r
operator|->
name|src
operator|.
name|port
index|[
literal|1
index|]
argument_list|,
name|th
operator|->
name|th_sport
argument_list|)
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_SRC_PORT
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|PF_MISMATCHAW
argument_list|(
operator|&
name|r
operator|->
name|dst
operator|.
name|addr
argument_list|,
name|daddr
argument_list|,
name|af
argument_list|,
name|r
operator|->
name|dst
operator|.
name|neg
argument_list|)
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_DST_ADDR
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|dst
operator|.
name|port_op
operator|&&
operator|!
name|pf_match_port
argument_list|(
name|r
operator|->
name|dst
operator|.
name|port_op
argument_list|,
name|r
operator|->
name|dst
operator|.
name|port
index|[
literal|0
index|]
argument_list|,
name|r
operator|->
name|dst
operator|.
name|port
index|[
literal|1
index|]
argument_list|,
name|th
operator|->
name|th_dport
argument_list|)
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_DST_PORT
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|tos
operator|&&
operator|!
operator|(
name|r
operator|->
name|tos
operator|&
name|pd
operator|->
name|tos
operator|)
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_FRAGMENT
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|r
operator|->
name|flagset
operator|&
name|th
operator|->
name|th_flags
operator|)
operator|!=
name|r
operator|->
name|flags
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|uid
operator|.
name|op
operator|&&
operator|(
name|lookup
operator|!=
operator|-
literal|1
operator|||
operator|(
name|lookup
operator|=
ifdef|#
directive|ifdef
name|__FreeBSD__
name|pf_socket_lookup
argument_list|(
operator|&
name|uid
argument_list|,
operator|&
name|gid
argument_list|,
name|direction
argument_list|,
name|pd
argument_list|,
name|inp
argument_list|)
operator|,
literal|1
operator|)
operator|)
operator|&&
else|#
directive|else
name|pf_socket_lookup
argument_list|(
operator|&
name|uid
argument_list|,
operator|&
name|gid
argument_list|,
name|direction
argument_list|,
name|pd
argument_list|)
operator|,
literal|1
condition|)
block|)
operator|&&
endif|#
directive|endif
operator|!
name|pf_match_uid
argument_list|(
name|r
operator|->
name|uid
operator|.
name|op
argument_list|,
name|r
operator|->
name|uid
operator|.
name|uid
index|[
literal|0
index|]
argument_list|,
name|r
operator|->
name|uid
operator|.
name|uid
index|[
literal|1
index|]
argument_list|,
name|uid
argument_list|)
block|)
decl_stmt|r = TAILQ_NEXT(r
operator|,
decl_stmt|entries
end_decl_stmt

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_elseif
elseif|else
if|if
condition|(
name|r
operator|->
name|gid
operator|.
name|op
operator|&&
operator|(
name|lookup
operator|!=
operator|-
literal|1
operator|||
operator|(
name|lookup
operator|=
ifdef|#
directive|ifdef
name|__FreeBSD__
name|pf_socket_lookup
argument_list|(
operator|&
name|uid
argument_list|,
operator|&
name|gid
argument_list|,
name|direction
argument_list|,
name|pd
argument_list|,
name|inp
argument_list|)
operator|,
literal|1
operator|)
operator|)
operator|&&
else|#
directive|else
name|pf_socket_lookup
argument_list|(
operator|&
name|uid
argument_list|,
operator|&
name|gid
argument_list|,
name|direction
argument_list|,
name|pd
argument_list|)
operator|,
literal|1
condition|)
end_elseif

begin_expr_stmt
unit|)
operator|&&
endif|#
directive|endif
operator|!
name|pf_match_gid
argument_list|(
name|r
operator|->
name|gid
operator|.
name|op
argument_list|,
name|r
operator|->
name|gid
operator|.
name|gid
index|[
literal|0
index|]
argument_list|,
name|r
operator|->
name|gid
operator|.
name|gid
index|[
literal|1
index|]
argument_list|,
name|gid
argument_list|)
end_expr_stmt

begin_expr_stmt
unit|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
end_expr_stmt

begin_elseif
elseif|else
if|if
condition|(
name|r
operator|->
name|prob
operator|&&
name|r
operator|->
name|prob
operator|<=
name|arc4random
argument_list|()
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
end_elseif

begin_elseif
elseif|else
if|if
condition|(
name|r
operator|->
name|match_tag
operator|&&
operator|!
name|pf_match_tag
argument_list|(
name|m
argument_list|,
name|r
argument_list|,
operator|&
name|pftag
argument_list|,
operator|&
name|tag
argument_list|)
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
end_elseif

begin_elseif
elseif|else
if|if
condition|(
name|r
operator|->
name|os_fingerprint
operator|!=
name|PF_OSFP_ANY
operator|&&
operator|!
name|pf_osfp_match
argument_list|(
name|pf_osfp_fingerprint
argument_list|(
name|pd
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|th
argument_list|)
argument_list|,
name|r
operator|->
name|os_fingerprint
argument_list|)
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
end_elseif

begin_else
else|else
block|{
if|if
condition|(
name|r
operator|->
name|tag
condition|)
name|tag
operator|=
name|r
operator|->
name|tag
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|anchor
operator|==
name|NULL
condition|)
block|{
operator|*
name|rm
operator|=
name|r
expr_stmt|;
operator|*
name|am
operator|=
name|a
expr_stmt|;
operator|*
name|rsm
operator|=
name|ruleset
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|rm
operator|)
operator|->
name|quick
condition|)
break|break;
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
block|}
else|else
name|pf_step_into_anchor
argument_list|(
operator|&
name|asd
argument_list|,
operator|&
name|ruleset
argument_list|,
name|PF_RULESET_FILTER
argument_list|,
operator|&
name|r
argument_list|,
operator|&
name|a
argument_list|)
expr_stmt|;
block|}
end_else

begin_if
if|if
condition|(
name|r
operator|==
name|NULL
condition|)
name|pf_step_out_of_anchor
argument_list|(
operator|&
name|asd
argument_list|,
operator|&
name|ruleset
argument_list|,
name|PF_RULESET_FILTER
argument_list|,
operator|&
name|r
argument_list|,
operator|&
name|a
argument_list|)
expr_stmt|;
end_if

begin_expr_stmt
unit|} 	r
operator|=
operator|*
name|rm
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|a
operator|=
operator|*
name|am
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|ruleset
operator|=
operator|*
name|rsm
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_MATCH
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|r
operator|->
name|log
condition|)
block|{
if|if
condition|(
name|rewrite
condition|)
name|m_copyback
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|th
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
name|th
argument_list|)
expr_stmt|;
name|PFLOG_PACKET
argument_list|(
name|kif
argument_list|,
name|h
argument_list|,
name|m
argument_list|,
name|af
argument_list|,
name|direction
argument_list|,
name|reason
argument_list|,
name|r
argument_list|,
name|a
argument_list|,
name|ruleset
argument_list|)
expr_stmt|;
block|}
end_if

begin_if
if|if
condition|(
operator|(
name|r
operator|->
name|action
operator|==
name|PF_DROP
operator|)
operator|&&
operator|(
operator|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_RETURNRST
operator|)
operator|||
operator|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_RETURNICMP
operator|)
operator|||
operator|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_RETURN
operator|)
operator|)
condition|)
block|{
comment|/* undo NAT changes, if they have taken place */
if|if
condition|(
name|nr
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|direction
operator|==
name|PF_OUT
condition|)
block|{
name|pf_change_ap
argument_list|(
name|saddr
argument_list|,
operator|&
name|th
operator|->
name|th_sport
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
operator|&
name|th
operator|->
name|th_sum
argument_list|,
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|bport
argument_list|,
literal|0
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|rewrite
operator|++
expr_stmt|;
block|}
else|else
block|{
name|pf_change_ap
argument_list|(
name|daddr
argument_list|,
operator|&
name|th
operator|->
name|th_dport
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
operator|&
name|th
operator|->
name|th_sum
argument_list|,
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|bport
argument_list|,
literal|0
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|rewrite
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
operator|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_RETURNRST
operator|)
operator|||
operator|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_RETURN
operator|)
operator|)
operator|&&
operator|!
operator|(
name|th
operator|->
name|th_flags
operator|&
name|TH_RST
operator|)
condition|)
block|{
name|u_int32_t
name|ack
init|=
name|ntohl
argument_list|(
name|th
operator|->
name|th_seq
argument_list|)
operator|+
name|pd
operator|->
name|p_len
decl_stmt|;
if|if
condition|(
name|th
operator|->
name|th_flags
operator|&
name|TH_SYN
condition|)
name|ack
operator|++
expr_stmt|;
if|if
condition|(
name|th
operator|->
name|th_flags
operator|&
name|TH_FIN
condition|)
name|ack
operator|++
expr_stmt|;
name|pf_send_tcp
argument_list|(
name|r
argument_list|,
name|af
argument_list|,
name|pd
operator|->
name|dst
argument_list|,
name|pd
operator|->
name|src
argument_list|,
name|th
operator|->
name|th_dport
argument_list|,
name|th
operator|->
name|th_sport
argument_list|,
name|ntohl
argument_list|(
name|th
operator|->
name|th_ack
argument_list|)
argument_list|,
name|ack
argument_list|,
name|TH_RST
operator||
name|TH_ACK
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|r
operator|->
name|return_ttl
argument_list|,
literal|1
argument_list|,
name|pd
operator|->
name|eh
argument_list|,
name|kif
operator|->
name|pfik_ifp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|af
operator|==
name|AF_INET
operator|)
operator|&&
name|r
operator|->
name|return_icmp
condition|)
name|pf_send_icmp
argument_list|(
name|m
argument_list|,
name|r
operator|->
name|return_icmp
operator|>>
literal|8
argument_list|,
name|r
operator|->
name|return_icmp
operator|&
literal|255
argument_list|,
name|af
argument_list|,
name|r
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|af
operator|==
name|AF_INET6
operator|)
operator|&&
name|r
operator|->
name|return_icmp6
condition|)
name|pf_send_icmp
argument_list|(
name|m
argument_list|,
name|r
operator|->
name|return_icmp6
operator|>>
literal|8
argument_list|,
name|r
operator|->
name|return_icmp6
operator|&
literal|255
argument_list|,
name|af
argument_list|,
name|r
argument_list|)
expr_stmt|;
block|}
end_if

begin_if
if|if
condition|(
name|r
operator|->
name|action
operator|==
name|PF_DROP
condition|)
return|return
operator|(
name|PF_DROP
operator|)
return|;
end_if

begin_if
if|if
condition|(
name|pf_tag_packet
argument_list|(
name|m
argument_list|,
name|pftag
argument_list|,
name|tag
argument_list|)
condition|)
block|{
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
end_if

begin_if
if|if
condition|(
name|r
operator|->
name|keep_state
operator|||
name|nr
operator|!=
name|NULL
operator|||
operator|(
name|pd
operator|->
name|flags
operator|&
name|PFDESC_TCP_NORM
operator|)
condition|)
block|{
comment|/* create new state */
name|u_int16_t
name|len
decl_stmt|;
name|struct
name|pf_state
modifier|*
name|s
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_src_node
modifier|*
name|sn
init|=
name|NULL
decl_stmt|;
name|len
operator|=
name|pd
operator|->
name|tot_len
operator|-
name|off
operator|-
operator|(
name|th
operator|->
name|th_off
operator|<<
literal|2
operator|)
expr_stmt|;
comment|/* check maximums */
if|if
condition|(
name|r
operator|->
name|max_states
operator|&&
operator|(
name|r
operator|->
name|states
operator|>=
name|r
operator|->
name|max_states
operator|)
condition|)
block|{
name|pf_status
operator|.
name|lcounters
index|[
name|LCNT_STATES
index|]
operator|++
expr_stmt|;
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_MAXSTATES
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* src node for flter rule */
if|if
condition|(
operator|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_SRCTRACK
operator|||
name|r
operator|->
name|rpool
operator|.
name|opts
operator|&
name|PF_POOL_STICKYADDR
operator|)
operator|&&
name|pf_insert_src_node
argument_list|(
operator|&
name|sn
argument_list|,
name|r
argument_list|,
name|saddr
argument_list|,
name|af
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_SRCLIMIT
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* src node for translation rule */
if|if
condition|(
name|nr
operator|!=
name|NULL
operator|&&
operator|(
name|nr
operator|->
name|rpool
operator|.
name|opts
operator|&
name|PF_POOL_STICKYADDR
operator|)
operator|&&
operator|(
operator|(
name|direction
operator|==
name|PF_OUT
operator|&&
name|pf_insert_src_node
argument_list|(
operator|&
name|nsn
argument_list|,
name|nr
argument_list|,
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|af
argument_list|)
operator|!=
literal|0
operator|)
operator|||
operator|(
name|pf_insert_src_node
argument_list|(
operator|&
name|nsn
argument_list|,
name|nr
argument_list|,
name|saddr
argument_list|,
name|af
argument_list|)
operator|!=
literal|0
operator|)
operator|)
condition|)
block|{
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_SRCLIMIT
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|s
operator|=
name|pool_get
argument_list|(
operator|&
name|pf_state_pl
argument_list|,
name|PR_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_MEMORY
argument_list|)
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|sn
operator|!=
name|NULL
operator|&&
name|sn
operator|->
name|states
operator|==
literal|0
operator|&&
name|sn
operator|->
name|expire
operator|==
literal|0
condition|)
block|{
name|RB_REMOVE
argument_list|(
name|pf_src_tree
argument_list|,
operator|&
name|tree_src_tracking
argument_list|,
name|sn
argument_list|)
expr_stmt|;
name|pf_status
operator|.
name|scounters
index|[
name|SCNT_SRC_NODE_REMOVALS
index|]
operator|++
expr_stmt|;
name|pf_status
operator|.
name|src_nodes
operator|--
expr_stmt|;
name|pool_put
argument_list|(
operator|&
name|pf_src_tree_pl
argument_list|,
name|sn
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nsn
operator|!=
name|sn
operator|&&
name|nsn
operator|!=
name|NULL
operator|&&
name|nsn
operator|->
name|states
operator|==
literal|0
operator|&&
name|nsn
operator|->
name|expire
operator|==
literal|0
condition|)
block|{
name|RB_REMOVE
argument_list|(
name|pf_src_tree
argument_list|,
operator|&
name|tree_src_tracking
argument_list|,
name|nsn
argument_list|)
expr_stmt|;
name|pf_status
operator|.
name|scounters
index|[
name|SCNT_SRC_NODE_REMOVALS
index|]
operator|++
expr_stmt|;
name|pf_status
operator|.
name|src_nodes
operator|--
expr_stmt|;
name|pool_put
argument_list|(
operator|&
name|pf_src_tree_pl
argument_list|,
name|nsn
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
name|bzero
argument_list|(
name|s
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|s
argument_list|)
argument_list|)
expr_stmt|;
name|s
operator|->
name|rule
operator|.
name|ptr
operator|=
name|r
expr_stmt|;
name|s
operator|->
name|nat_rule
operator|.
name|ptr
operator|=
name|nr
expr_stmt|;
name|s
operator|->
name|anchor
operator|.
name|ptr
operator|=
name|a
expr_stmt|;
name|STATE_INC_COUNTERS
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|s
operator|->
name|allow_opts
operator|=
name|r
operator|->
name|allow_opts
expr_stmt|;
name|s
operator|->
name|log
operator|=
name|r
operator|->
name|log
operator|&
literal|2
expr_stmt|;
name|s
operator|->
name|proto
operator|=
name|IPPROTO_TCP
expr_stmt|;
name|s
operator|->
name|direction
operator|=
name|direction
expr_stmt|;
name|s
operator|->
name|af
operator|=
name|af
expr_stmt|;
if|if
condition|(
name|direction
operator|==
name|PF_OUT
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|gwy
operator|.
name|addr
argument_list|,
name|saddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|gwy
operator|.
name|port
operator|=
name|th
operator|->
name|th_sport
expr_stmt|;
comment|/* sport */
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|ext
operator|.
name|addr
argument_list|,
name|daddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|ext
operator|.
name|port
operator|=
name|th
operator|->
name|th_dport
expr_stmt|;
if|if
condition|(
name|nr
operator|!=
name|NULL
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|lan
operator|.
name|addr
argument_list|,
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|lan
operator|.
name|port
operator|=
name|bport
expr_stmt|;
block|}
else|else
block|{
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|lan
operator|.
name|addr
argument_list|,
operator|&
name|s
operator|->
name|gwy
operator|.
name|addr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|lan
operator|.
name|port
operator|=
name|s
operator|->
name|gwy
operator|.
name|port
expr_stmt|;
block|}
block|}
else|else
block|{
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|lan
operator|.
name|addr
argument_list|,
name|daddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|lan
operator|.
name|port
operator|=
name|th
operator|->
name|th_dport
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|ext
operator|.
name|addr
argument_list|,
name|saddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|ext
operator|.
name|port
operator|=
name|th
operator|->
name|th_sport
expr_stmt|;
if|if
condition|(
name|nr
operator|!=
name|NULL
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|gwy
operator|.
name|addr
argument_list|,
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|gwy
operator|.
name|port
operator|=
name|bport
expr_stmt|;
block|}
else|else
block|{
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|gwy
operator|.
name|addr
argument_list|,
operator|&
name|s
operator|->
name|lan
operator|.
name|addr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|gwy
operator|.
name|port
operator|=
name|s
operator|->
name|lan
operator|.
name|port
expr_stmt|;
block|}
block|}
name|s
operator|->
name|src
operator|.
name|seqlo
operator|=
name|ntohl
argument_list|(
name|th
operator|->
name|th_seq
argument_list|)
expr_stmt|;
name|s
operator|->
name|src
operator|.
name|seqhi
operator|=
name|s
operator|->
name|src
operator|.
name|seqlo
operator|+
name|len
operator|+
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|th
operator|->
name|th_flags
operator|&
operator|(
name|TH_SYN
operator||
name|TH_ACK
operator|)
operator|)
operator|==
name|TH_SYN
operator|&&
name|r
operator|->
name|keep_state
operator|==
name|PF_STATE_MODULATE
condition|)
block|{
comment|/* Generate sequence number modulator */
while|while
condition|(
operator|(
name|s
operator|->
name|src
operator|.
name|seqdiff
operator|=
name|htonl
argument_list|(
name|arc4random
argument_list|()
argument_list|)
operator|)
operator|==
literal|0
condition|)
empty_stmt|;
name|pf_change_a
argument_list|(
operator|&
name|th
operator|->
name|th_seq
argument_list|,
operator|&
name|th
operator|->
name|th_sum
argument_list|,
name|htonl
argument_list|(
name|s
operator|->
name|src
operator|.
name|seqlo
operator|+
name|s
operator|->
name|src
operator|.
name|seqdiff
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rewrite
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|s
operator|->
name|src
operator|.
name|seqdiff
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|th
operator|->
name|th_flags
operator|&
name|TH_SYN
condition|)
block|{
name|s
operator|->
name|src
operator|.
name|seqhi
operator|++
expr_stmt|;
name|s
operator|->
name|src
operator|.
name|wscale
operator|=
name|pf_get_wscale
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
name|th
operator|->
name|th_off
argument_list|,
name|af
argument_list|)
expr_stmt|;
block|}
name|s
operator|->
name|src
operator|.
name|max_win
operator|=
name|MAX
argument_list|(
name|ntohs
argument_list|(
name|th
operator|->
name|th_win
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|src
operator|.
name|wscale
operator|&
name|PF_WSCALE_MASK
condition|)
block|{
comment|/* Remove scale factor from initial window */
name|int
name|win
init|=
name|s
operator|->
name|src
operator|.
name|max_win
decl_stmt|;
name|win
operator|+=
literal|1
operator|<<
operator|(
name|s
operator|->
name|src
operator|.
name|wscale
operator|&
name|PF_WSCALE_MASK
operator|)
expr_stmt|;
name|s
operator|->
name|src
operator|.
name|max_win
operator|=
operator|(
name|win
operator|-
literal|1
operator|)
operator|>>
operator|(
name|s
operator|->
name|src
operator|.
name|wscale
operator|&
name|PF_WSCALE_MASK
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|th
operator|->
name|th_flags
operator|&
name|TH_FIN
condition|)
name|s
operator|->
name|src
operator|.
name|seqhi
operator|++
expr_stmt|;
name|s
operator|->
name|dst
operator|.
name|seqhi
operator|=
literal|1
expr_stmt|;
name|s
operator|->
name|dst
operator|.
name|max_win
operator|=
literal|1
expr_stmt|;
name|s
operator|->
name|src
operator|.
name|state
operator|=
name|TCPS_SYN_SENT
expr_stmt|;
name|s
operator|->
name|dst
operator|.
name|state
operator|=
name|TCPS_CLOSED
expr_stmt|;
name|s
operator|->
name|creation
operator|=
name|time_second
expr_stmt|;
name|s
operator|->
name|expire
operator|=
name|time_second
expr_stmt|;
name|s
operator|->
name|timeout
operator|=
name|PFTM_TCP_FIRST_PACKET
expr_stmt|;
name|pf_set_rt_ifp
argument_list|(
name|s
argument_list|,
name|saddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sn
operator|!=
name|NULL
condition|)
block|{
name|s
operator|->
name|src_node
operator|=
name|sn
expr_stmt|;
name|s
operator|->
name|src_node
operator|->
name|states
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|nsn
operator|!=
name|NULL
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|nsn
operator|->
name|raddr
argument_list|,
operator|&
name|pd
operator|->
name|naddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|nat_src_node
operator|=
name|nsn
expr_stmt|;
name|s
operator|->
name|nat_src_node
operator|->
name|states
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|pd
operator|->
name|flags
operator|&
name|PFDESC_TCP_NORM
operator|)
operator|&&
name|pf_normalize_tcp_init
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
name|pd
argument_list|,
name|th
argument_list|,
operator|&
name|s
operator|->
name|src
argument_list|,
operator|&
name|s
operator|->
name|dst
argument_list|)
condition|)
block|{
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_MEMORY
argument_list|)
expr_stmt|;
name|pf_src_tree_remove_state
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|STATE_DEC_COUNTERS
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|pool_put
argument_list|(
operator|&
name|pf_state_pl
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|pd
operator|->
name|flags
operator|&
name|PFDESC_TCP_NORM
operator|)
operator|&&
name|s
operator|->
name|src
operator|.
name|scrub
operator|&&
name|pf_normalize_tcp_stateful
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
name|pd
argument_list|,
operator|&
name|reason
argument_list|,
name|th
argument_list|,
name|s
argument_list|,
operator|&
name|s
operator|->
name|src
argument_list|,
operator|&
name|s
operator|->
name|dst
argument_list|,
operator|&
name|rewrite
argument_list|)
condition|)
block|{
comment|/* This really shouldn't happen!!! */
name|DPFPRINTF
argument_list|(
name|PF_DEBUG_URGENT
argument_list|,
operator|(
literal|"pf_normalize_tcp_stateful failed on first pkt"
operator|)
argument_list|)
expr_stmt|;
name|pf_normalize_tcp_cleanup
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|pf_src_tree_remove_state
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|STATE_DEC_COUNTERS
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|pool_put
argument_list|(
operator|&
name|pf_state_pl
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
if|if
condition|(
name|pf_insert_state
argument_list|(
name|BOUND_IFACE
argument_list|(
name|r
argument_list|,
name|kif
argument_list|)
argument_list|,
name|s
argument_list|)
condition|)
block|{
name|pf_normalize_tcp_cleanup
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_STATEINS
argument_list|)
expr_stmt|;
name|pf_src_tree_remove_state
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|STATE_DEC_COUNTERS
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|pool_put
argument_list|(
operator|&
name|pf_state_pl
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
else|else
operator|*
name|sm
operator|=
name|s
expr_stmt|;
if|if
condition|(
name|tag
operator|>
literal|0
condition|)
block|{
name|pf_tag_ref
argument_list|(
name|tag
argument_list|)
expr_stmt|;
name|s
operator|->
name|tag
operator|=
name|tag
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|th
operator|->
name|th_flags
operator|&
operator|(
name|TH_SYN
operator||
name|TH_ACK
operator|)
operator|)
operator|==
name|TH_SYN
operator|&&
name|r
operator|->
name|keep_state
operator|==
name|PF_STATE_SYNPROXY
condition|)
block|{
name|s
operator|->
name|src
operator|.
name|state
operator|=
name|PF_TCPS_PROXY_SRC
expr_stmt|;
if|if
condition|(
name|nr
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|direction
operator|==
name|PF_OUT
condition|)
block|{
name|pf_change_ap
argument_list|(
name|saddr
argument_list|,
operator|&
name|th
operator|->
name|th_sport
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
operator|&
name|th
operator|->
name|th_sum
argument_list|,
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|bport
argument_list|,
literal|0
argument_list|,
name|af
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pf_change_ap
argument_list|(
name|daddr
argument_list|,
operator|&
name|th
operator|->
name|th_dport
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
operator|&
name|th
operator|->
name|th_sum
argument_list|,
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|bport
argument_list|,
literal|0
argument_list|,
name|af
argument_list|)
expr_stmt|;
block|}
block|}
name|s
operator|->
name|src
operator|.
name|seqhi
operator|=
name|htonl
argument_list|(
name|arc4random
argument_list|()
argument_list|)
expr_stmt|;
comment|/* Find mss option */
name|mss
operator|=
name|pf_get_mss
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
name|th
operator|->
name|th_off
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|mss
operator|=
name|pf_calc_mss
argument_list|(
name|saddr
argument_list|,
name|af
argument_list|,
name|mss
argument_list|)
expr_stmt|;
name|mss
operator|=
name|pf_calc_mss
argument_list|(
name|daddr
argument_list|,
name|af
argument_list|,
name|mss
argument_list|)
expr_stmt|;
name|s
operator|->
name|src
operator|.
name|mss
operator|=
name|mss
expr_stmt|;
name|pf_send_tcp
argument_list|(
name|r
argument_list|,
name|af
argument_list|,
name|daddr
argument_list|,
name|saddr
argument_list|,
name|th
operator|->
name|th_dport
argument_list|,
name|th
operator|->
name|th_sport
argument_list|,
name|s
operator|->
name|src
operator|.
name|seqhi
argument_list|,
name|ntohl
argument_list|(
name|th
operator|->
name|th_seq
argument_list|)
operator|+
literal|1
argument_list|,
name|TH_SYN
operator||
name|TH_ACK
argument_list|,
literal|0
argument_list|,
name|s
operator|->
name|src
operator|.
name|mss
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_SYNPROXY
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_SYNPROXY_DROP
operator|)
return|;
block|}
block|}
end_if

begin_comment
comment|/* copy back packet headers if we performed NAT operations */
end_comment

begin_if
if|if
condition|(
name|rewrite
condition|)
name|m_copyback
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|th
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
name|th
argument_list|)
expr_stmt|;
end_if

begin_return
return|return
operator|(
name|PF_PASS
operator|)
return|;
end_return

begin_macro
unit|}  int
name|pf_test_udp
argument_list|(
argument|struct pf_rule **rm
argument_list|,
argument|struct pf_state **sm
argument_list|,
argument|int direction
argument_list|,
argument|struct pfi_kif *kif
argument_list|,
argument|struct mbuf *m
argument_list|,
argument|int off
argument_list|,
argument|void *h
argument_list|,
ifdef|#
directive|ifdef
name|__FreeBSD__
argument|struct pf_pdesc *pd
argument_list|,
argument|struct pf_rule **am
argument_list|,
argument|struct pf_ruleset **rsm
argument_list|,
argument|struct ifqueue *ifq
argument_list|,
argument|struct inpcb *inp
argument_list|)
end_macro

begin_else
else|#
directive|else
end_else

begin_decl_stmt
name|struct
name|pf_pdesc
modifier|*
name|pd
decl_stmt|, struct
name|pf_rule
modifier|*
modifier|*
name|am
decl_stmt|, struct
name|pf_ruleset
modifier|*
modifier|*
name|rsm
decl_stmt|,     struct
name|ifqueue
modifier|*
name|ifq
decl_stmt|)
endif|#
directive|endif
block|{
name|struct
name|pf_rule
modifier|*
name|nr
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_addr
modifier|*
name|saddr
init|=
name|pd
operator|->
name|src
decl_stmt|,
modifier|*
name|daddr
init|=
name|pd
operator|->
name|dst
decl_stmt|;
name|struct
name|udphdr
modifier|*
name|uh
init|=
name|pd
operator|->
name|hdr
operator|.
name|udp
decl_stmt|;
name|u_int16_t
name|bport
decl_stmt|,
name|nport
init|=
literal|0
decl_stmt|;
name|sa_family_t
name|af
init|=
name|pd
operator|->
name|af
decl_stmt|;
name|int
name|lookup
init|=
operator|-
literal|1
decl_stmt|;
name|uid_t
name|uid
decl_stmt|;
name|gid_t
name|gid
decl_stmt|;
name|struct
name|pf_rule
modifier|*
name|r
decl_stmt|,
modifier|*
name|a
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_ruleset
modifier|*
name|ruleset
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_src_node
modifier|*
name|nsn
init|=
name|NULL
decl_stmt|;
name|u_short
name|reason
decl_stmt|;
name|int
name|rewrite
init|=
literal|0
decl_stmt|;
name|struct
name|pf_tag
modifier|*
name|pftag
init|=
name|NULL
decl_stmt|;
name|int
name|tag
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|asd
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|pf_check_congestion
argument_list|(
name|ifq
argument_list|)
condition|)
block|{
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_CONGEST
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
name|r
operator|=
name|TAILQ_FIRST
argument_list|(
name|pf_main_ruleset
operator|.
name|rules
index|[
name|PF_RULESET_FILTER
index|]
operator|.
name|active
operator|.
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|direction
operator|==
name|PF_OUT
condition|)
block|{
name|bport
operator|=
name|nport
operator|=
name|uh
operator|->
name|uh_sport
expr_stmt|;
comment|/* check outgoing packet for BINAT/NAT */
if|if
condition|(
operator|(
name|nr
operator|=
name|pf_get_translation
argument_list|(
name|pd
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|PF_OUT
argument_list|,
name|kif
argument_list|,
operator|&
name|nsn
argument_list|,
name|saddr
argument_list|,
name|uh
operator|->
name|uh_sport
argument_list|,
name|daddr
argument_list|,
name|uh
operator|->
name|uh_dport
argument_list|,
operator|&
name|pd
operator|->
name|naddr
argument_list|,
operator|&
name|nport
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|saddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|pf_change_ap
argument_list|(
name|saddr
argument_list|,
operator|&
name|uh
operator|->
name|uh_sport
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
operator|&
name|uh
operator|->
name|uh_sum
argument_list|,
operator|&
name|pd
operator|->
name|naddr
argument_list|,
name|nport
argument_list|,
literal|1
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|rewrite
operator|++
expr_stmt|;
if|if
condition|(
name|nr
operator|->
name|natpass
condition|)
name|r
operator|=
name|NULL
expr_stmt|;
name|pd
operator|->
name|nat_rule
operator|=
name|nr
expr_stmt|;
block|}
block|}
else|else
block|{
name|bport
operator|=
name|nport
operator|=
name|uh
operator|->
name|uh_dport
expr_stmt|;
comment|/* check incoming packet for BINAT/RDR */
if|if
condition|(
operator|(
name|nr
operator|=
name|pf_get_translation
argument_list|(
name|pd
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|PF_IN
argument_list|,
name|kif
argument_list|,
operator|&
name|nsn
argument_list|,
name|saddr
argument_list|,
name|uh
operator|->
name|uh_sport
argument_list|,
name|daddr
argument_list|,
name|uh
operator|->
name|uh_dport
argument_list|,
operator|&
name|pd
operator|->
name|naddr
argument_list|,
operator|&
name|nport
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|daddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|pf_change_ap
argument_list|(
name|daddr
argument_list|,
operator|&
name|uh
operator|->
name|uh_dport
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
operator|&
name|uh
operator|->
name|uh_sum
argument_list|,
operator|&
name|pd
operator|->
name|naddr
argument_list|,
name|nport
argument_list|,
literal|1
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|rewrite
operator|++
expr_stmt|;
if|if
condition|(
name|nr
operator|->
name|natpass
condition|)
name|r
operator|=
name|NULL
expr_stmt|;
name|pd
operator|->
name|nat_rule
operator|=
name|nr
expr_stmt|;
block|}
block|}
while|while
condition|(
name|r
operator|!=
name|NULL
condition|)
block|{
name|r
operator|->
name|evaluations
operator|++
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|kif
operator|!=
name|NULL
operator|&&
operator|(
name|r
operator|->
name|kif
operator|!=
name|kif
operator|&&
name|r
operator|->
name|kif
operator|!=
name|kif
operator|->
name|pfik_parent
operator|)
operator|==
operator|!
name|r
operator|->
name|ifnot
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_IFP
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|direction
operator|&&
name|r
operator|->
name|direction
operator|!=
name|direction
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_DIR
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|af
operator|&&
name|r
operator|->
name|af
operator|!=
name|af
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_AF
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|proto
operator|&&
name|r
operator|->
name|proto
operator|!=
name|IPPROTO_UDP
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_PROTO
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|PF_MISMATCHAW
argument_list|(
operator|&
name|r
operator|->
name|src
operator|.
name|addr
argument_list|,
name|saddr
argument_list|,
name|af
argument_list|,
name|r
operator|->
name|src
operator|.
name|neg
argument_list|)
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_SRC_ADDR
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|src
operator|.
name|port_op
operator|&&
operator|!
name|pf_match_port
argument_list|(
name|r
operator|->
name|src
operator|.
name|port_op
argument_list|,
name|r
operator|->
name|src
operator|.
name|port
index|[
literal|0
index|]
argument_list|,
name|r
operator|->
name|src
operator|.
name|port
index|[
literal|1
index|]
argument_list|,
name|uh
operator|->
name|uh_sport
argument_list|)
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_SRC_PORT
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|PF_MISMATCHAW
argument_list|(
operator|&
name|r
operator|->
name|dst
operator|.
name|addr
argument_list|,
name|daddr
argument_list|,
name|af
argument_list|,
name|r
operator|->
name|dst
operator|.
name|neg
argument_list|)
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_DST_ADDR
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|dst
operator|.
name|port_op
operator|&&
operator|!
name|pf_match_port
argument_list|(
name|r
operator|->
name|dst
operator|.
name|port_op
argument_list|,
name|r
operator|->
name|dst
operator|.
name|port
index|[
literal|0
index|]
argument_list|,
name|r
operator|->
name|dst
operator|.
name|port
index|[
literal|1
index|]
argument_list|,
name|uh
operator|->
name|uh_dport
argument_list|)
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_DST_PORT
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|tos
operator|&&
operator|!
operator|(
name|r
operator|->
name|tos
operator|&
name|pd
operator|->
name|tos
operator|)
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_FRAGMENT
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|uid
operator|.
name|op
operator|&&
operator|(
name|lookup
operator|!=
operator|-
literal|1
operator|||
operator|(
name|lookup
operator|=
ifdef|#
directive|ifdef
name|__FreeBSD__
name|pf_socket_lookup
argument_list|(
operator|&
name|uid
argument_list|,
operator|&
name|gid
argument_list|,
name|direction
argument_list|,
name|pd
argument_list|,
name|inp
argument_list|)
operator|,
literal|1
operator|)
operator|)
operator|&&
else|#
directive|else
name|pf_socket_lookup
argument_list|(
operator|&
name|uid
argument_list|,
operator|&
name|gid
argument_list|,
name|direction
argument_list|,
name|pd
argument_list|)
operator|,
literal|1
condition|)
block|)
operator|&&
endif|#
directive|endif
operator|!
name|pf_match_uid
argument_list|(
name|r
operator|->
name|uid
operator|.
name|op
argument_list|,
name|r
operator|->
name|uid
operator|.
name|uid
index|[
literal|0
index|]
argument_list|,
name|r
operator|->
name|uid
operator|.
name|uid
index|[
literal|1
index|]
argument_list|,
name|uid
argument_list|)
block|)
decl_stmt|r = TAILQ_NEXT(r
operator|,
decl_stmt|entries
end_decl_stmt

begin_empty_stmt
unit|)
empty_stmt|;
end_empty_stmt

begin_elseif
elseif|else
if|if
condition|(
name|r
operator|->
name|gid
operator|.
name|op
operator|&&
operator|(
name|lookup
operator|!=
operator|-
literal|1
operator|||
operator|(
name|lookup
operator|=
ifdef|#
directive|ifdef
name|__FreeBSD__
name|pf_socket_lookup
argument_list|(
operator|&
name|uid
argument_list|,
operator|&
name|gid
argument_list|,
name|direction
argument_list|,
name|pd
argument_list|,
name|inp
argument_list|)
operator|,
literal|1
operator|)
operator|)
operator|&&
else|#
directive|else
name|pf_socket_lookup
argument_list|(
operator|&
name|uid
argument_list|,
operator|&
name|gid
argument_list|,
name|direction
argument_list|,
name|pd
argument_list|)
operator|,
literal|1
condition|)
end_elseif

begin_expr_stmt
unit|)
operator|&&
endif|#
directive|endif
operator|!
name|pf_match_gid
argument_list|(
name|r
operator|->
name|gid
operator|.
name|op
argument_list|,
name|r
operator|->
name|gid
operator|.
name|gid
index|[
literal|0
index|]
argument_list|,
name|r
operator|->
name|gid
operator|.
name|gid
index|[
literal|1
index|]
argument_list|,
name|gid
argument_list|)
end_expr_stmt

begin_expr_stmt
unit|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
end_expr_stmt

begin_elseif
elseif|else
if|if
condition|(
name|r
operator|->
name|prob
operator|&&
name|r
operator|->
name|prob
operator|<=
name|arc4random
argument_list|()
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
end_elseif

begin_elseif
elseif|else
if|if
condition|(
name|r
operator|->
name|match_tag
operator|&&
operator|!
name|pf_match_tag
argument_list|(
name|m
argument_list|,
name|r
argument_list|,
operator|&
name|pftag
argument_list|,
operator|&
name|tag
argument_list|)
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
end_elseif

begin_elseif
elseif|else
if|if
condition|(
name|r
operator|->
name|os_fingerprint
operator|!=
name|PF_OSFP_ANY
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
end_elseif

begin_else
else|else
block|{
if|if
condition|(
name|r
operator|->
name|tag
condition|)
name|tag
operator|=
name|r
operator|->
name|tag
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|anchor
operator|==
name|NULL
condition|)
block|{
operator|*
name|rm
operator|=
name|r
expr_stmt|;
operator|*
name|am
operator|=
name|a
expr_stmt|;
operator|*
name|rsm
operator|=
name|ruleset
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|rm
operator|)
operator|->
name|quick
condition|)
break|break;
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
block|}
else|else
name|pf_step_into_anchor
argument_list|(
operator|&
name|asd
argument_list|,
operator|&
name|ruleset
argument_list|,
name|PF_RULESET_FILTER
argument_list|,
operator|&
name|r
argument_list|,
operator|&
name|a
argument_list|)
expr_stmt|;
block|}
end_else

begin_if
if|if
condition|(
name|r
operator|==
name|NULL
condition|)
name|pf_step_out_of_anchor
argument_list|(
operator|&
name|asd
argument_list|,
operator|&
name|ruleset
argument_list|,
name|PF_RULESET_FILTER
argument_list|,
operator|&
name|r
argument_list|,
operator|&
name|a
argument_list|)
expr_stmt|;
end_if

begin_expr_stmt
unit|} 	r
operator|=
operator|*
name|rm
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|a
operator|=
operator|*
name|am
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|ruleset
operator|=
operator|*
name|rsm
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_MATCH
argument_list|)
expr_stmt|;
end_expr_stmt

begin_if
if|if
condition|(
name|r
operator|->
name|log
condition|)
block|{
if|if
condition|(
name|rewrite
condition|)
name|m_copyback
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|uh
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
name|uh
argument_list|)
expr_stmt|;
name|PFLOG_PACKET
argument_list|(
name|kif
argument_list|,
name|h
argument_list|,
name|m
argument_list|,
name|af
argument_list|,
name|direction
argument_list|,
name|reason
argument_list|,
name|r
argument_list|,
name|a
argument_list|,
name|ruleset
argument_list|)
expr_stmt|;
block|}
end_if

begin_if
if|if
condition|(
operator|(
name|r
operator|->
name|action
operator|==
name|PF_DROP
operator|)
operator|&&
operator|(
operator|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_RETURNICMP
operator|)
operator|||
operator|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_RETURN
operator|)
operator|)
condition|)
block|{
comment|/* undo NAT changes, if they have taken place */
if|if
condition|(
name|nr
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|direction
operator|==
name|PF_OUT
condition|)
block|{
name|pf_change_ap
argument_list|(
name|saddr
argument_list|,
operator|&
name|uh
operator|->
name|uh_sport
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
operator|&
name|uh
operator|->
name|uh_sum
argument_list|,
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|bport
argument_list|,
literal|1
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|rewrite
operator|++
expr_stmt|;
block|}
else|else
block|{
name|pf_change_ap
argument_list|(
name|daddr
argument_list|,
operator|&
name|uh
operator|->
name|uh_dport
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
operator|&
name|uh
operator|->
name|uh_sum
argument_list|,
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|bport
argument_list|,
literal|1
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|rewrite
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|af
operator|==
name|AF_INET
operator|)
operator|&&
name|r
operator|->
name|return_icmp
condition|)
name|pf_send_icmp
argument_list|(
name|m
argument_list|,
name|r
operator|->
name|return_icmp
operator|>>
literal|8
argument_list|,
name|r
operator|->
name|return_icmp
operator|&
literal|255
argument_list|,
name|af
argument_list|,
name|r
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|af
operator|==
name|AF_INET6
operator|)
operator|&&
name|r
operator|->
name|return_icmp6
condition|)
name|pf_send_icmp
argument_list|(
name|m
argument_list|,
name|r
operator|->
name|return_icmp6
operator|>>
literal|8
argument_list|,
name|r
operator|->
name|return_icmp6
operator|&
literal|255
argument_list|,
name|af
argument_list|,
name|r
argument_list|)
expr_stmt|;
block|}
end_if

begin_if
if|if
condition|(
name|r
operator|->
name|action
operator|==
name|PF_DROP
condition|)
return|return
operator|(
name|PF_DROP
operator|)
return|;
end_if

begin_if
if|if
condition|(
name|pf_tag_packet
argument_list|(
name|m
argument_list|,
name|pftag
argument_list|,
name|tag
argument_list|)
condition|)
block|{
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
end_if

begin_if
if|if
condition|(
name|r
operator|->
name|keep_state
operator|||
name|nr
operator|!=
name|NULL
condition|)
block|{
comment|/* create new state */
name|struct
name|pf_state
modifier|*
name|s
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_src_node
modifier|*
name|sn
init|=
name|NULL
decl_stmt|;
comment|/* check maximums */
if|if
condition|(
name|r
operator|->
name|max_states
operator|&&
operator|(
name|r
operator|->
name|states
operator|>=
name|r
operator|->
name|max_states
operator|)
condition|)
block|{
name|pf_status
operator|.
name|lcounters
index|[
name|LCNT_STATES
index|]
operator|++
expr_stmt|;
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_MAXSTATES
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* src node for flter rule */
if|if
condition|(
operator|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_SRCTRACK
operator|||
name|r
operator|->
name|rpool
operator|.
name|opts
operator|&
name|PF_POOL_STICKYADDR
operator|)
operator|&&
name|pf_insert_src_node
argument_list|(
operator|&
name|sn
argument_list|,
name|r
argument_list|,
name|saddr
argument_list|,
name|af
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_SRCLIMIT
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* src node for translation rule */
if|if
condition|(
name|nr
operator|!=
name|NULL
operator|&&
operator|(
name|nr
operator|->
name|rpool
operator|.
name|opts
operator|&
name|PF_POOL_STICKYADDR
operator|)
operator|&&
operator|(
operator|(
name|direction
operator|==
name|PF_OUT
operator|&&
name|pf_insert_src_node
argument_list|(
operator|&
name|nsn
argument_list|,
name|nr
argument_list|,
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|af
argument_list|)
operator|!=
literal|0
operator|)
operator|||
operator|(
name|pf_insert_src_node
argument_list|(
operator|&
name|nsn
argument_list|,
name|nr
argument_list|,
name|saddr
argument_list|,
name|af
argument_list|)
operator|!=
literal|0
operator|)
operator|)
condition|)
block|{
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_SRCLIMIT
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|s
operator|=
name|pool_get
argument_list|(
operator|&
name|pf_state_pl
argument_list|,
name|PR_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_MEMORY
argument_list|)
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|sn
operator|!=
name|NULL
operator|&&
name|sn
operator|->
name|states
operator|==
literal|0
operator|&&
name|sn
operator|->
name|expire
operator|==
literal|0
condition|)
block|{
name|RB_REMOVE
argument_list|(
name|pf_src_tree
argument_list|,
operator|&
name|tree_src_tracking
argument_list|,
name|sn
argument_list|)
expr_stmt|;
name|pf_status
operator|.
name|scounters
index|[
name|SCNT_SRC_NODE_REMOVALS
index|]
operator|++
expr_stmt|;
name|pf_status
operator|.
name|src_nodes
operator|--
expr_stmt|;
name|pool_put
argument_list|(
operator|&
name|pf_src_tree_pl
argument_list|,
name|sn
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nsn
operator|!=
name|sn
operator|&&
name|nsn
operator|!=
name|NULL
operator|&&
name|nsn
operator|->
name|states
operator|==
literal|0
operator|&&
name|nsn
operator|->
name|expire
operator|==
literal|0
condition|)
block|{
name|RB_REMOVE
argument_list|(
name|pf_src_tree
argument_list|,
operator|&
name|tree_src_tracking
argument_list|,
name|nsn
argument_list|)
expr_stmt|;
name|pf_status
operator|.
name|scounters
index|[
name|SCNT_SRC_NODE_REMOVALS
index|]
operator|++
expr_stmt|;
name|pf_status
operator|.
name|src_nodes
operator|--
expr_stmt|;
name|pool_put
argument_list|(
operator|&
name|pf_src_tree_pl
argument_list|,
name|nsn
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
name|bzero
argument_list|(
name|s
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|s
argument_list|)
argument_list|)
expr_stmt|;
name|s
operator|->
name|rule
operator|.
name|ptr
operator|=
name|r
expr_stmt|;
name|s
operator|->
name|nat_rule
operator|.
name|ptr
operator|=
name|nr
expr_stmt|;
name|s
operator|->
name|anchor
operator|.
name|ptr
operator|=
name|a
expr_stmt|;
name|STATE_INC_COUNTERS
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|s
operator|->
name|allow_opts
operator|=
name|r
operator|->
name|allow_opts
expr_stmt|;
name|s
operator|->
name|log
operator|=
name|r
operator|->
name|log
operator|&
literal|2
expr_stmt|;
name|s
operator|->
name|proto
operator|=
name|IPPROTO_UDP
expr_stmt|;
name|s
operator|->
name|direction
operator|=
name|direction
expr_stmt|;
name|s
operator|->
name|af
operator|=
name|af
expr_stmt|;
if|if
condition|(
name|direction
operator|==
name|PF_OUT
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|gwy
operator|.
name|addr
argument_list|,
name|saddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|gwy
operator|.
name|port
operator|=
name|uh
operator|->
name|uh_sport
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|ext
operator|.
name|addr
argument_list|,
name|daddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|ext
operator|.
name|port
operator|=
name|uh
operator|->
name|uh_dport
expr_stmt|;
if|if
condition|(
name|nr
operator|!=
name|NULL
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|lan
operator|.
name|addr
argument_list|,
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|lan
operator|.
name|port
operator|=
name|bport
expr_stmt|;
block|}
else|else
block|{
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|lan
operator|.
name|addr
argument_list|,
operator|&
name|s
operator|->
name|gwy
operator|.
name|addr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|lan
operator|.
name|port
operator|=
name|s
operator|->
name|gwy
operator|.
name|port
expr_stmt|;
block|}
block|}
else|else
block|{
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|lan
operator|.
name|addr
argument_list|,
name|daddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|lan
operator|.
name|port
operator|=
name|uh
operator|->
name|uh_dport
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|ext
operator|.
name|addr
argument_list|,
name|saddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|ext
operator|.
name|port
operator|=
name|uh
operator|->
name|uh_sport
expr_stmt|;
if|if
condition|(
name|nr
operator|!=
name|NULL
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|gwy
operator|.
name|addr
argument_list|,
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|gwy
operator|.
name|port
operator|=
name|bport
expr_stmt|;
block|}
else|else
block|{
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|gwy
operator|.
name|addr
argument_list|,
operator|&
name|s
operator|->
name|lan
operator|.
name|addr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|gwy
operator|.
name|port
operator|=
name|s
operator|->
name|lan
operator|.
name|port
expr_stmt|;
block|}
block|}
name|s
operator|->
name|src
operator|.
name|state
operator|=
name|PFUDPS_SINGLE
expr_stmt|;
name|s
operator|->
name|dst
operator|.
name|state
operator|=
name|PFUDPS_NO_TRAFFIC
expr_stmt|;
name|s
operator|->
name|creation
operator|=
name|time_second
expr_stmt|;
name|s
operator|->
name|expire
operator|=
name|time_second
expr_stmt|;
name|s
operator|->
name|timeout
operator|=
name|PFTM_UDP_FIRST_PACKET
expr_stmt|;
name|pf_set_rt_ifp
argument_list|(
name|s
argument_list|,
name|saddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sn
operator|!=
name|NULL
condition|)
block|{
name|s
operator|->
name|src_node
operator|=
name|sn
expr_stmt|;
name|s
operator|->
name|src_node
operator|->
name|states
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|nsn
operator|!=
name|NULL
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|nsn
operator|->
name|raddr
argument_list|,
operator|&
name|pd
operator|->
name|naddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|nat_src_node
operator|=
name|nsn
expr_stmt|;
name|s
operator|->
name|nat_src_node
operator|->
name|states
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|pf_insert_state
argument_list|(
name|BOUND_IFACE
argument_list|(
name|r
argument_list|,
name|kif
argument_list|)
argument_list|,
name|s
argument_list|)
condition|)
block|{
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_STATEINS
argument_list|)
expr_stmt|;
name|pf_src_tree_remove_state
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|STATE_DEC_COUNTERS
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|pool_put
argument_list|(
operator|&
name|pf_state_pl
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
else|else
operator|*
name|sm
operator|=
name|s
expr_stmt|;
if|if
condition|(
name|tag
operator|>
literal|0
condition|)
block|{
name|pf_tag_ref
argument_list|(
name|tag
argument_list|)
expr_stmt|;
name|s
operator|->
name|tag
operator|=
name|tag
expr_stmt|;
block|}
block|}
end_if

begin_comment
comment|/* copy back packet headers if we performed NAT operations */
end_comment

begin_if
if|if
condition|(
name|rewrite
condition|)
name|m_copyback
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|uh
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
name|uh
argument_list|)
expr_stmt|;
end_if

begin_return
return|return
operator|(
name|PF_PASS
operator|)
return|;
end_return

begin_macro
unit|}  int
name|pf_test_icmp
argument_list|(
argument|struct pf_rule **rm
argument_list|,
argument|struct pf_state **sm
argument_list|,
argument|int direction
argument_list|,
argument|struct pfi_kif *kif
argument_list|,
argument|struct mbuf *m
argument_list|,
argument|int off
argument_list|,
argument|void *h
argument_list|,
argument|struct pf_pdesc *pd
argument_list|,
argument|struct pf_rule **am
argument_list|,
argument|struct pf_ruleset **rsm
argument_list|,
argument|struct ifqueue *ifq
argument_list|)
end_macro

begin_block
block|{
name|struct
name|pf_rule
modifier|*
name|nr
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_addr
modifier|*
name|saddr
init|=
name|pd
operator|->
name|src
decl_stmt|,
modifier|*
name|daddr
init|=
name|pd
operator|->
name|dst
decl_stmt|;
name|struct
name|pf_rule
modifier|*
name|r
decl_stmt|,
modifier|*
name|a
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_ruleset
modifier|*
name|ruleset
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_src_node
modifier|*
name|nsn
init|=
name|NULL
decl_stmt|;
name|u_short
name|reason
decl_stmt|;
name|u_int16_t
name|icmpid
init|=
literal|0
decl_stmt|,
name|bport
decl_stmt|,
name|nport
init|=
literal|0
decl_stmt|;
name|sa_family_t
name|af
init|=
name|pd
operator|->
name|af
decl_stmt|;
name|u_int8_t
name|icmptype
init|=
literal|0
decl_stmt|;
comment|/* make the compiler happy */
name|u_int8_t
name|icmpcode
init|=
literal|0
decl_stmt|;
comment|/* make the compiler happy */
name|int
name|state_icmp
init|=
literal|0
decl_stmt|;
name|struct
name|pf_tag
modifier|*
name|pftag
init|=
name|NULL
decl_stmt|;
name|int
name|tag
init|=
operator|-
literal|1
decl_stmt|;
ifdef|#
directive|ifdef
name|INET6
name|int
name|rewrite
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
comment|/* INET6 */
name|int
name|asd
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|pf_check_congestion
argument_list|(
name|ifq
argument_list|)
condition|)
block|{
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_CONGEST
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
switch|switch
condition|(
name|pd
operator|->
name|proto
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|IPPROTO_ICMP
case|:
name|icmptype
operator|=
name|pd
operator|->
name|hdr
operator|.
name|icmp
operator|->
name|icmp_type
expr_stmt|;
name|icmpcode
operator|=
name|pd
operator|->
name|hdr
operator|.
name|icmp
operator|->
name|icmp_code
expr_stmt|;
name|icmpid
operator|=
name|pd
operator|->
name|hdr
operator|.
name|icmp
operator|->
name|icmp_id
expr_stmt|;
if|if
condition|(
name|icmptype
operator|==
name|ICMP_UNREACH
operator|||
name|icmptype
operator|==
name|ICMP_SOURCEQUENCH
operator|||
name|icmptype
operator|==
name|ICMP_REDIRECT
operator|||
name|icmptype
operator|==
name|ICMP_TIMXCEED
operator|||
name|icmptype
operator|==
name|ICMP_PARAMPROB
condition|)
name|state_icmp
operator|++
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|IPPROTO_ICMPV6
case|:
name|icmptype
operator|=
name|pd
operator|->
name|hdr
operator|.
name|icmp6
operator|->
name|icmp6_type
expr_stmt|;
name|icmpcode
operator|=
name|pd
operator|->
name|hdr
operator|.
name|icmp6
operator|->
name|icmp6_code
expr_stmt|;
name|icmpid
operator|=
name|pd
operator|->
name|hdr
operator|.
name|icmp6
operator|->
name|icmp6_id
expr_stmt|;
if|if
condition|(
name|icmptype
operator|==
name|ICMP6_DST_UNREACH
operator|||
name|icmptype
operator|==
name|ICMP6_PACKET_TOO_BIG
operator|||
name|icmptype
operator|==
name|ICMP6_TIME_EXCEEDED
operator|||
name|icmptype
operator|==
name|ICMP6_PARAM_PROB
condition|)
name|state_icmp
operator|++
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
name|r
operator|=
name|TAILQ_FIRST
argument_list|(
name|pf_main_ruleset
operator|.
name|rules
index|[
name|PF_RULESET_FILTER
index|]
operator|.
name|active
operator|.
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|direction
operator|==
name|PF_OUT
condition|)
block|{
name|bport
operator|=
name|nport
operator|=
name|icmpid
expr_stmt|;
comment|/* check outgoing packet for BINAT/NAT */
if|if
condition|(
operator|(
name|nr
operator|=
name|pf_get_translation
argument_list|(
name|pd
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|PF_OUT
argument_list|,
name|kif
argument_list|,
operator|&
name|nsn
argument_list|,
name|saddr
argument_list|,
name|icmpid
argument_list|,
name|daddr
argument_list|,
name|icmpid
argument_list|,
operator|&
name|pd
operator|->
name|naddr
argument_list|,
operator|&
name|nport
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|saddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
name|pf_change_a
argument_list|(
operator|&
name|saddr
operator|->
name|v4
operator|.
name|s_addr
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
name|pd
operator|->
name|naddr
operator|.
name|v4
operator|.
name|s_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pd
operator|->
name|hdr
operator|.
name|icmp
operator|->
name|icmp_cksum
operator|=
name|pf_cksum_fixup
argument_list|(
name|pd
operator|->
name|hdr
operator|.
name|icmp
operator|->
name|icmp_cksum
argument_list|,
name|icmpid
argument_list|,
name|nport
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pd
operator|->
name|hdr
operator|.
name|icmp
operator|->
name|icmp_id
operator|=
name|nport
expr_stmt|;
name|m_copyback
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
name|ICMP_MINLEN
argument_list|,
operator|(
name|caddr_t
operator|)
name|pd
operator|->
name|hdr
operator|.
name|icmp
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
name|pf_change_a6
argument_list|(
name|saddr
argument_list|,
operator|&
name|pd
operator|->
name|hdr
operator|.
name|icmp6
operator|->
name|icmp6_cksum
argument_list|,
operator|&
name|pd
operator|->
name|naddr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rewrite
operator|++
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
if|if
condition|(
name|nr
operator|->
name|natpass
condition|)
name|r
operator|=
name|NULL
expr_stmt|;
name|pd
operator|->
name|nat_rule
operator|=
name|nr
expr_stmt|;
block|}
block|}
else|else
block|{
name|bport
operator|=
name|nport
operator|=
name|icmpid
expr_stmt|;
comment|/* check incoming packet for BINAT/RDR */
if|if
condition|(
operator|(
name|nr
operator|=
name|pf_get_translation
argument_list|(
name|pd
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|PF_IN
argument_list|,
name|kif
argument_list|,
operator|&
name|nsn
argument_list|,
name|saddr
argument_list|,
name|icmpid
argument_list|,
name|daddr
argument_list|,
name|icmpid
argument_list|,
operator|&
name|pd
operator|->
name|naddr
argument_list|,
operator|&
name|nport
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|daddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
name|pf_change_a
argument_list|(
operator|&
name|daddr
operator|->
name|v4
operator|.
name|s_addr
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
name|pd
operator|->
name|naddr
operator|.
name|v4
operator|.
name|s_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
name|pf_change_a6
argument_list|(
name|daddr
argument_list|,
operator|&
name|pd
operator|->
name|hdr
operator|.
name|icmp6
operator|->
name|icmp6_cksum
argument_list|,
operator|&
name|pd
operator|->
name|naddr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rewrite
operator|++
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
if|if
condition|(
name|nr
operator|->
name|natpass
condition|)
name|r
operator|=
name|NULL
expr_stmt|;
name|pd
operator|->
name|nat_rule
operator|=
name|nr
expr_stmt|;
block|}
block|}
while|while
condition|(
name|r
operator|!=
name|NULL
condition|)
block|{
name|r
operator|->
name|evaluations
operator|++
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|kif
operator|!=
name|NULL
operator|&&
operator|(
name|r
operator|->
name|kif
operator|!=
name|kif
operator|&&
name|r
operator|->
name|kif
operator|!=
name|kif
operator|->
name|pfik_parent
operator|)
operator|==
operator|!
name|r
operator|->
name|ifnot
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_IFP
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|direction
operator|&&
name|r
operator|->
name|direction
operator|!=
name|direction
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_DIR
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|af
operator|&&
name|r
operator|->
name|af
operator|!=
name|af
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_AF
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|proto
operator|&&
name|r
operator|->
name|proto
operator|!=
name|pd
operator|->
name|proto
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_PROTO
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|PF_MISMATCHAW
argument_list|(
operator|&
name|r
operator|->
name|src
operator|.
name|addr
argument_list|,
name|saddr
argument_list|,
name|af
argument_list|,
name|r
operator|->
name|src
operator|.
name|neg
argument_list|)
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_SRC_ADDR
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|PF_MISMATCHAW
argument_list|(
operator|&
name|r
operator|->
name|dst
operator|.
name|addr
argument_list|,
name|daddr
argument_list|,
name|af
argument_list|,
name|r
operator|->
name|dst
operator|.
name|neg
argument_list|)
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_DST_ADDR
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|type
operator|&&
name|r
operator|->
name|type
operator|!=
name|icmptype
operator|+
literal|1
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|code
operator|&&
name|r
operator|->
name|code
operator|!=
name|icmpcode
operator|+
literal|1
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|tos
operator|&&
operator|!
operator|(
name|r
operator|->
name|tos
operator|&
name|pd
operator|->
name|tos
operator|)
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_FRAGMENT
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|prob
operator|&&
name|r
operator|->
name|prob
operator|<=
name|arc4random
argument_list|()
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|match_tag
operator|&&
operator|!
name|pf_match_tag
argument_list|(
name|m
argument_list|,
name|r
argument_list|,
operator|&
name|pftag
argument_list|,
operator|&
name|tag
argument_list|)
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|os_fingerprint
operator|!=
name|PF_OSFP_ANY
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|r
operator|->
name|tag
condition|)
name|tag
operator|=
name|r
operator|->
name|tag
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|anchor
operator|==
name|NULL
condition|)
block|{
operator|*
name|rm
operator|=
name|r
expr_stmt|;
operator|*
name|am
operator|=
name|a
expr_stmt|;
operator|*
name|rsm
operator|=
name|ruleset
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|rm
operator|)
operator|->
name|quick
condition|)
break|break;
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
block|}
else|else
name|pf_step_into_anchor
argument_list|(
operator|&
name|asd
argument_list|,
operator|&
name|ruleset
argument_list|,
name|PF_RULESET_FILTER
argument_list|,
operator|&
name|r
argument_list|,
operator|&
name|a
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|==
name|NULL
condition|)
name|pf_step_out_of_anchor
argument_list|(
operator|&
name|asd
argument_list|,
operator|&
name|ruleset
argument_list|,
name|PF_RULESET_FILTER
argument_list|,
operator|&
name|r
argument_list|,
operator|&
name|a
argument_list|)
expr_stmt|;
block|}
name|r
operator|=
operator|*
name|rm
expr_stmt|;
name|a
operator|=
operator|*
name|am
expr_stmt|;
name|ruleset
operator|=
operator|*
name|rsm
expr_stmt|;
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_MATCH
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|log
condition|)
block|{
ifdef|#
directive|ifdef
name|INET6
if|if
condition|(
name|rewrite
condition|)
name|m_copyback
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|icmp6_hdr
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
name|pd
operator|->
name|hdr
operator|.
name|icmp6
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* INET6 */
name|PFLOG_PACKET
argument_list|(
name|kif
argument_list|,
name|h
argument_list|,
name|m
argument_list|,
name|af
argument_list|,
name|direction
argument_list|,
name|reason
argument_list|,
name|r
argument_list|,
name|a
argument_list|,
name|ruleset
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|->
name|action
operator|!=
name|PF_PASS
condition|)
return|return
operator|(
name|PF_DROP
operator|)
return|;
if|if
condition|(
name|pf_tag_packet
argument_list|(
name|m
argument_list|,
name|pftag
argument_list|,
name|tag
argument_list|)
condition|)
block|{
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|state_icmp
operator|&&
operator|(
name|r
operator|->
name|keep_state
operator|||
name|nr
operator|!=
name|NULL
operator|)
condition|)
block|{
comment|/* create new state */
name|struct
name|pf_state
modifier|*
name|s
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_src_node
modifier|*
name|sn
init|=
name|NULL
decl_stmt|;
comment|/* check maximums */
if|if
condition|(
name|r
operator|->
name|max_states
operator|&&
operator|(
name|r
operator|->
name|states
operator|>=
name|r
operator|->
name|max_states
operator|)
condition|)
block|{
name|pf_status
operator|.
name|lcounters
index|[
name|LCNT_STATES
index|]
operator|++
expr_stmt|;
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_MAXSTATES
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* src node for flter rule */
if|if
condition|(
operator|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_SRCTRACK
operator|||
name|r
operator|->
name|rpool
operator|.
name|opts
operator|&
name|PF_POOL_STICKYADDR
operator|)
operator|&&
name|pf_insert_src_node
argument_list|(
operator|&
name|sn
argument_list|,
name|r
argument_list|,
name|saddr
argument_list|,
name|af
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_SRCLIMIT
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* src node for translation rule */
if|if
condition|(
name|nr
operator|!=
name|NULL
operator|&&
operator|(
name|nr
operator|->
name|rpool
operator|.
name|opts
operator|&
name|PF_POOL_STICKYADDR
operator|)
operator|&&
operator|(
operator|(
name|direction
operator|==
name|PF_OUT
operator|&&
name|pf_insert_src_node
argument_list|(
operator|&
name|nsn
argument_list|,
name|nr
argument_list|,
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|af
argument_list|)
operator|!=
literal|0
operator|)
operator|||
operator|(
name|pf_insert_src_node
argument_list|(
operator|&
name|nsn
argument_list|,
name|nr
argument_list|,
name|saddr
argument_list|,
name|af
argument_list|)
operator|!=
literal|0
operator|)
operator|)
condition|)
block|{
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_SRCLIMIT
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|s
operator|=
name|pool_get
argument_list|(
operator|&
name|pf_state_pl
argument_list|,
name|PR_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_MEMORY
argument_list|)
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|sn
operator|!=
name|NULL
operator|&&
name|sn
operator|->
name|states
operator|==
literal|0
operator|&&
name|sn
operator|->
name|expire
operator|==
literal|0
condition|)
block|{
name|RB_REMOVE
argument_list|(
name|pf_src_tree
argument_list|,
operator|&
name|tree_src_tracking
argument_list|,
name|sn
argument_list|)
expr_stmt|;
name|pf_status
operator|.
name|scounters
index|[
name|SCNT_SRC_NODE_REMOVALS
index|]
operator|++
expr_stmt|;
name|pf_status
operator|.
name|src_nodes
operator|--
expr_stmt|;
name|pool_put
argument_list|(
operator|&
name|pf_src_tree_pl
argument_list|,
name|sn
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nsn
operator|!=
name|sn
operator|&&
name|nsn
operator|!=
name|NULL
operator|&&
name|nsn
operator|->
name|states
operator|==
literal|0
operator|&&
name|nsn
operator|->
name|expire
operator|==
literal|0
condition|)
block|{
name|RB_REMOVE
argument_list|(
name|pf_src_tree
argument_list|,
operator|&
name|tree_src_tracking
argument_list|,
name|nsn
argument_list|)
expr_stmt|;
name|pf_status
operator|.
name|scounters
index|[
name|SCNT_SRC_NODE_REMOVALS
index|]
operator|++
expr_stmt|;
name|pf_status
operator|.
name|src_nodes
operator|--
expr_stmt|;
name|pool_put
argument_list|(
operator|&
name|pf_src_tree_pl
argument_list|,
name|nsn
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
name|bzero
argument_list|(
name|s
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|s
argument_list|)
argument_list|)
expr_stmt|;
name|s
operator|->
name|rule
operator|.
name|ptr
operator|=
name|r
expr_stmt|;
name|s
operator|->
name|nat_rule
operator|.
name|ptr
operator|=
name|nr
expr_stmt|;
name|s
operator|->
name|anchor
operator|.
name|ptr
operator|=
name|a
expr_stmt|;
name|STATE_INC_COUNTERS
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|s
operator|->
name|allow_opts
operator|=
name|r
operator|->
name|allow_opts
expr_stmt|;
name|s
operator|->
name|log
operator|=
name|r
operator|->
name|log
operator|&
literal|2
expr_stmt|;
name|s
operator|->
name|proto
operator|=
name|pd
operator|->
name|proto
expr_stmt|;
name|s
operator|->
name|direction
operator|=
name|direction
expr_stmt|;
name|s
operator|->
name|af
operator|=
name|af
expr_stmt|;
if|if
condition|(
name|direction
operator|==
name|PF_OUT
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|gwy
operator|.
name|addr
argument_list|,
name|saddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|gwy
operator|.
name|port
operator|=
name|nport
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|ext
operator|.
name|addr
argument_list|,
name|daddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|ext
operator|.
name|port
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|nr
operator|!=
name|NULL
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|lan
operator|.
name|addr
argument_list|,
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|lan
operator|.
name|port
operator|=
name|bport
expr_stmt|;
block|}
else|else
block|{
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|lan
operator|.
name|addr
argument_list|,
operator|&
name|s
operator|->
name|gwy
operator|.
name|addr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|lan
operator|.
name|port
operator|=
name|s
operator|->
name|gwy
operator|.
name|port
expr_stmt|;
block|}
block|}
else|else
block|{
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|lan
operator|.
name|addr
argument_list|,
name|daddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|lan
operator|.
name|port
operator|=
name|nport
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|ext
operator|.
name|addr
argument_list|,
name|saddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|ext
operator|.
name|port
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|nr
operator|!=
name|NULL
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|gwy
operator|.
name|addr
argument_list|,
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|gwy
operator|.
name|port
operator|=
name|bport
expr_stmt|;
block|}
else|else
block|{
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|gwy
operator|.
name|addr
argument_list|,
operator|&
name|s
operator|->
name|lan
operator|.
name|addr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|gwy
operator|.
name|port
operator|=
name|s
operator|->
name|lan
operator|.
name|port
expr_stmt|;
block|}
block|}
name|s
operator|->
name|creation
operator|=
name|time_second
expr_stmt|;
name|s
operator|->
name|expire
operator|=
name|time_second
expr_stmt|;
name|s
operator|->
name|timeout
operator|=
name|PFTM_ICMP_FIRST_PACKET
expr_stmt|;
name|pf_set_rt_ifp
argument_list|(
name|s
argument_list|,
name|saddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sn
operator|!=
name|NULL
condition|)
block|{
name|s
operator|->
name|src_node
operator|=
name|sn
expr_stmt|;
name|s
operator|->
name|src_node
operator|->
name|states
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|nsn
operator|!=
name|NULL
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|nsn
operator|->
name|raddr
argument_list|,
operator|&
name|pd
operator|->
name|naddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|nat_src_node
operator|=
name|nsn
expr_stmt|;
name|s
operator|->
name|nat_src_node
operator|->
name|states
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|pf_insert_state
argument_list|(
name|BOUND_IFACE
argument_list|(
name|r
argument_list|,
name|kif
argument_list|)
argument_list|,
name|s
argument_list|)
condition|)
block|{
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_STATEINS
argument_list|)
expr_stmt|;
name|pf_src_tree_remove_state
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|STATE_DEC_COUNTERS
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|pool_put
argument_list|(
operator|&
name|pf_state_pl
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
else|else
operator|*
name|sm
operator|=
name|s
expr_stmt|;
if|if
condition|(
name|tag
operator|>
literal|0
condition|)
block|{
name|pf_tag_ref
argument_list|(
name|tag
argument_list|)
expr_stmt|;
name|s
operator|->
name|tag
operator|=
name|tag
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|INET6
comment|/* copy back packet headers if we performed IPv6 NAT operations */
if|if
condition|(
name|rewrite
condition|)
name|m_copyback
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|icmp6_hdr
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
name|pd
operator|->
name|hdr
operator|.
name|icmp6
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* INET6 */
return|return
operator|(
name|PF_PASS
operator|)
return|;
block|}
end_block

begin_function
name|int
name|pf_test_other
parameter_list|(
name|struct
name|pf_rule
modifier|*
modifier|*
name|rm
parameter_list|,
name|struct
name|pf_state
modifier|*
modifier|*
name|sm
parameter_list|,
name|int
name|direction
parameter_list|,
name|struct
name|pfi_kif
modifier|*
name|kif
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|int
name|off
parameter_list|,
name|void
modifier|*
name|h
parameter_list|,
name|struct
name|pf_pdesc
modifier|*
name|pd
parameter_list|,
name|struct
name|pf_rule
modifier|*
modifier|*
name|am
parameter_list|,
name|struct
name|pf_ruleset
modifier|*
modifier|*
name|rsm
parameter_list|,
name|struct
name|ifqueue
modifier|*
name|ifq
parameter_list|)
block|{
name|struct
name|pf_rule
modifier|*
name|nr
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_rule
modifier|*
name|r
decl_stmt|,
modifier|*
name|a
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_ruleset
modifier|*
name|ruleset
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_src_node
modifier|*
name|nsn
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_addr
modifier|*
name|saddr
init|=
name|pd
operator|->
name|src
decl_stmt|,
modifier|*
name|daddr
init|=
name|pd
operator|->
name|dst
decl_stmt|;
name|sa_family_t
name|af
init|=
name|pd
operator|->
name|af
decl_stmt|;
name|u_short
name|reason
decl_stmt|;
name|struct
name|pf_tag
modifier|*
name|pftag
init|=
name|NULL
decl_stmt|;
name|int
name|tag
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|asd
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|pf_check_congestion
argument_list|(
name|ifq
argument_list|)
condition|)
block|{
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_CONGEST
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
name|r
operator|=
name|TAILQ_FIRST
argument_list|(
name|pf_main_ruleset
operator|.
name|rules
index|[
name|PF_RULESET_FILTER
index|]
operator|.
name|active
operator|.
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
name|direction
operator|==
name|PF_OUT
condition|)
block|{
comment|/* check outgoing packet for BINAT/NAT */
if|if
condition|(
operator|(
name|nr
operator|=
name|pf_get_translation
argument_list|(
name|pd
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|PF_OUT
argument_list|,
name|kif
argument_list|,
operator|&
name|nsn
argument_list|,
name|saddr
argument_list|,
literal|0
argument_list|,
name|daddr
argument_list|,
literal|0
argument_list|,
operator|&
name|pd
operator|->
name|naddr
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|saddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
name|pf_change_a
argument_list|(
operator|&
name|saddr
operator|->
name|v4
operator|.
name|s_addr
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
name|pd
operator|->
name|naddr
operator|.
name|v4
operator|.
name|s_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
name|PF_ACPY
argument_list|(
name|saddr
argument_list|,
operator|&
name|pd
operator|->
name|naddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
if|if
condition|(
name|nr
operator|->
name|natpass
condition|)
name|r
operator|=
name|NULL
expr_stmt|;
name|pd
operator|->
name|nat_rule
operator|=
name|nr
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* check incoming packet for BINAT/RDR */
if|if
condition|(
operator|(
name|nr
operator|=
name|pf_get_translation
argument_list|(
name|pd
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|PF_IN
argument_list|,
name|kif
argument_list|,
operator|&
name|nsn
argument_list|,
name|saddr
argument_list|,
literal|0
argument_list|,
name|daddr
argument_list|,
literal|0
argument_list|,
operator|&
name|pd
operator|->
name|naddr
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|daddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
name|pf_change_a
argument_list|(
operator|&
name|daddr
operator|->
name|v4
operator|.
name|s_addr
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
name|pd
operator|->
name|naddr
operator|.
name|v4
operator|.
name|s_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
name|PF_ACPY
argument_list|(
name|daddr
argument_list|,
operator|&
name|pd
operator|->
name|naddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
if|if
condition|(
name|nr
operator|->
name|natpass
condition|)
name|r
operator|=
name|NULL
expr_stmt|;
name|pd
operator|->
name|nat_rule
operator|=
name|nr
expr_stmt|;
block|}
block|}
while|while
condition|(
name|r
operator|!=
name|NULL
condition|)
block|{
name|r
operator|->
name|evaluations
operator|++
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|kif
operator|!=
name|NULL
operator|&&
operator|(
name|r
operator|->
name|kif
operator|!=
name|kif
operator|&&
name|r
operator|->
name|kif
operator|!=
name|kif
operator|->
name|pfik_parent
operator|)
operator|==
operator|!
name|r
operator|->
name|ifnot
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_IFP
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|direction
operator|&&
name|r
operator|->
name|direction
operator|!=
name|direction
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_DIR
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|af
operator|&&
name|r
operator|->
name|af
operator|!=
name|af
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_AF
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|proto
operator|&&
name|r
operator|->
name|proto
operator|!=
name|pd
operator|->
name|proto
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_PROTO
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|PF_MISMATCHAW
argument_list|(
operator|&
name|r
operator|->
name|src
operator|.
name|addr
argument_list|,
name|pd
operator|->
name|src
argument_list|,
name|af
argument_list|,
name|r
operator|->
name|src
operator|.
name|neg
argument_list|)
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_SRC_ADDR
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|PF_MISMATCHAW
argument_list|(
operator|&
name|r
operator|->
name|dst
operator|.
name|addr
argument_list|,
name|pd
operator|->
name|dst
argument_list|,
name|af
argument_list|,
name|r
operator|->
name|dst
operator|.
name|neg
argument_list|)
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_DST_ADDR
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|tos
operator|&&
operator|!
operator|(
name|r
operator|->
name|tos
operator|&
name|pd
operator|->
name|tos
operator|)
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_FRAGMENT
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|prob
operator|&&
name|r
operator|->
name|prob
operator|<=
name|arc4random
argument_list|()
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|match_tag
operator|&&
operator|!
name|pf_match_tag
argument_list|(
name|m
argument_list|,
name|r
argument_list|,
operator|&
name|pftag
argument_list|,
operator|&
name|tag
argument_list|)
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|os_fingerprint
operator|!=
name|PF_OSFP_ANY
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|r
operator|->
name|tag
condition|)
name|tag
operator|=
name|r
operator|->
name|tag
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|anchor
operator|==
name|NULL
condition|)
block|{
operator|*
name|rm
operator|=
name|r
expr_stmt|;
operator|*
name|am
operator|=
name|a
expr_stmt|;
operator|*
name|rsm
operator|=
name|ruleset
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|rm
operator|)
operator|->
name|quick
condition|)
break|break;
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
block|}
else|else
name|pf_step_into_anchor
argument_list|(
operator|&
name|asd
argument_list|,
operator|&
name|ruleset
argument_list|,
name|PF_RULESET_FILTER
argument_list|,
operator|&
name|r
argument_list|,
operator|&
name|a
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|==
name|NULL
condition|)
name|pf_step_out_of_anchor
argument_list|(
operator|&
name|asd
argument_list|,
operator|&
name|ruleset
argument_list|,
name|PF_RULESET_FILTER
argument_list|,
operator|&
name|r
argument_list|,
operator|&
name|a
argument_list|)
expr_stmt|;
block|}
name|r
operator|=
operator|*
name|rm
expr_stmt|;
name|a
operator|=
operator|*
name|am
expr_stmt|;
name|ruleset
operator|=
operator|*
name|rsm
expr_stmt|;
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_MATCH
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|log
condition|)
name|PFLOG_PACKET
argument_list|(
name|kif
argument_list|,
name|h
argument_list|,
name|m
argument_list|,
name|af
argument_list|,
name|direction
argument_list|,
name|reason
argument_list|,
name|r
argument_list|,
name|a
argument_list|,
name|ruleset
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|r
operator|->
name|action
operator|==
name|PF_DROP
operator|)
operator|&&
operator|(
operator|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_RETURNICMP
operator|)
operator|||
operator|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_RETURN
operator|)
operator|)
condition|)
block|{
name|struct
name|pf_addr
modifier|*
name|a
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|nr
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|direction
operator|==
name|PF_OUT
condition|)
name|a
operator|=
name|saddr
expr_stmt|;
else|else
name|a
operator|=
name|daddr
expr_stmt|;
block|}
if|if
condition|(
name|a
operator|!=
name|NULL
condition|)
block|{
switch|switch
condition|(
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
name|pf_change_a
argument_list|(
operator|&
name|a
operator|->
name|v4
operator|.
name|s_addr
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
name|pd
operator|->
name|baddr
operator|.
name|v4
operator|.
name|s_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
name|PF_ACPY
argument_list|(
name|a
argument_list|,
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
block|}
if|if
condition|(
operator|(
name|af
operator|==
name|AF_INET
operator|)
operator|&&
name|r
operator|->
name|return_icmp
condition|)
name|pf_send_icmp
argument_list|(
name|m
argument_list|,
name|r
operator|->
name|return_icmp
operator|>>
literal|8
argument_list|,
name|r
operator|->
name|return_icmp
operator|&
literal|255
argument_list|,
name|af
argument_list|,
name|r
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|af
operator|==
name|AF_INET6
operator|)
operator|&&
name|r
operator|->
name|return_icmp6
condition|)
name|pf_send_icmp
argument_list|(
name|m
argument_list|,
name|r
operator|->
name|return_icmp6
operator|>>
literal|8
argument_list|,
name|r
operator|->
name|return_icmp6
operator|&
literal|255
argument_list|,
name|af
argument_list|,
name|r
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|->
name|action
operator|!=
name|PF_PASS
condition|)
return|return
operator|(
name|PF_DROP
operator|)
return|;
if|if
condition|(
name|pf_tag_packet
argument_list|(
name|m
argument_list|,
name|pftag
argument_list|,
name|tag
argument_list|)
condition|)
block|{
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
if|if
condition|(
name|r
operator|->
name|keep_state
operator|||
name|nr
operator|!=
name|NULL
condition|)
block|{
comment|/* create new state */
name|struct
name|pf_state
modifier|*
name|s
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_src_node
modifier|*
name|sn
init|=
name|NULL
decl_stmt|;
comment|/* check maximums */
if|if
condition|(
name|r
operator|->
name|max_states
operator|&&
operator|(
name|r
operator|->
name|states
operator|>=
name|r
operator|->
name|max_states
operator|)
condition|)
block|{
name|pf_status
operator|.
name|lcounters
index|[
name|LCNT_STATES
index|]
operator|++
expr_stmt|;
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_MAXSTATES
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* src node for flter rule */
if|if
condition|(
operator|(
name|r
operator|->
name|rule_flag
operator|&
name|PFRULE_SRCTRACK
operator|||
name|r
operator|->
name|rpool
operator|.
name|opts
operator|&
name|PF_POOL_STICKYADDR
operator|)
operator|&&
name|pf_insert_src_node
argument_list|(
operator|&
name|sn
argument_list|,
name|r
argument_list|,
name|saddr
argument_list|,
name|af
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_SRCLIMIT
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
comment|/* src node for translation rule */
if|if
condition|(
name|nr
operator|!=
name|NULL
operator|&&
operator|(
name|nr
operator|->
name|rpool
operator|.
name|opts
operator|&
name|PF_POOL_STICKYADDR
operator|)
operator|&&
operator|(
operator|(
name|direction
operator|==
name|PF_OUT
operator|&&
name|pf_insert_src_node
argument_list|(
operator|&
name|nsn
argument_list|,
name|nr
argument_list|,
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|af
argument_list|)
operator|!=
literal|0
operator|)
operator|||
operator|(
name|pf_insert_src_node
argument_list|(
operator|&
name|nsn
argument_list|,
name|nr
argument_list|,
name|saddr
argument_list|,
name|af
argument_list|)
operator|!=
literal|0
operator|)
operator|)
condition|)
block|{
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_SRCLIMIT
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|s
operator|=
name|pool_get
argument_list|(
operator|&
name|pf_state_pl
argument_list|,
name|PR_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_MEMORY
argument_list|)
expr_stmt|;
name|cleanup
label|:
if|if
condition|(
name|sn
operator|!=
name|NULL
operator|&&
name|sn
operator|->
name|states
operator|==
literal|0
operator|&&
name|sn
operator|->
name|expire
operator|==
literal|0
condition|)
block|{
name|RB_REMOVE
argument_list|(
name|pf_src_tree
argument_list|,
operator|&
name|tree_src_tracking
argument_list|,
name|sn
argument_list|)
expr_stmt|;
name|pf_status
operator|.
name|scounters
index|[
name|SCNT_SRC_NODE_REMOVALS
index|]
operator|++
expr_stmt|;
name|pf_status
operator|.
name|src_nodes
operator|--
expr_stmt|;
name|pool_put
argument_list|(
operator|&
name|pf_src_tree_pl
argument_list|,
name|sn
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nsn
operator|!=
name|sn
operator|&&
name|nsn
operator|!=
name|NULL
operator|&&
name|nsn
operator|->
name|states
operator|==
literal|0
operator|&&
name|nsn
operator|->
name|expire
operator|==
literal|0
condition|)
block|{
name|RB_REMOVE
argument_list|(
name|pf_src_tree
argument_list|,
operator|&
name|tree_src_tracking
argument_list|,
name|nsn
argument_list|)
expr_stmt|;
name|pf_status
operator|.
name|scounters
index|[
name|SCNT_SRC_NODE_REMOVALS
index|]
operator|++
expr_stmt|;
name|pf_status
operator|.
name|src_nodes
operator|--
expr_stmt|;
name|pool_put
argument_list|(
operator|&
name|pf_src_tree_pl
argument_list|,
name|nsn
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
name|bzero
argument_list|(
name|s
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|s
argument_list|)
argument_list|)
expr_stmt|;
name|s
operator|->
name|rule
operator|.
name|ptr
operator|=
name|r
expr_stmt|;
name|s
operator|->
name|nat_rule
operator|.
name|ptr
operator|=
name|nr
expr_stmt|;
name|s
operator|->
name|anchor
operator|.
name|ptr
operator|=
name|a
expr_stmt|;
name|STATE_INC_COUNTERS
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|s
operator|->
name|allow_opts
operator|=
name|r
operator|->
name|allow_opts
expr_stmt|;
name|s
operator|->
name|log
operator|=
name|r
operator|->
name|log
operator|&
literal|2
expr_stmt|;
name|s
operator|->
name|proto
operator|=
name|pd
operator|->
name|proto
expr_stmt|;
name|s
operator|->
name|direction
operator|=
name|direction
expr_stmt|;
name|s
operator|->
name|af
operator|=
name|af
expr_stmt|;
if|if
condition|(
name|direction
operator|==
name|PF_OUT
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|gwy
operator|.
name|addr
argument_list|,
name|saddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|ext
operator|.
name|addr
argument_list|,
name|daddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
if|if
condition|(
name|nr
operator|!=
name|NULL
condition|)
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|lan
operator|.
name|addr
argument_list|,
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
else|else
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|lan
operator|.
name|addr
argument_list|,
operator|&
name|s
operator|->
name|gwy
operator|.
name|addr
argument_list|,
name|af
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|lan
operator|.
name|addr
argument_list|,
name|daddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|ext
operator|.
name|addr
argument_list|,
name|saddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
if|if
condition|(
name|nr
operator|!=
name|NULL
condition|)
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|gwy
operator|.
name|addr
argument_list|,
operator|&
name|pd
operator|->
name|baddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
else|else
name|PF_ACPY
argument_list|(
operator|&
name|s
operator|->
name|gwy
operator|.
name|addr
argument_list|,
operator|&
name|s
operator|->
name|lan
operator|.
name|addr
argument_list|,
name|af
argument_list|)
expr_stmt|;
block|}
name|s
operator|->
name|src
operator|.
name|state
operator|=
name|PFOTHERS_SINGLE
expr_stmt|;
name|s
operator|->
name|dst
operator|.
name|state
operator|=
name|PFOTHERS_NO_TRAFFIC
expr_stmt|;
name|s
operator|->
name|creation
operator|=
name|time_second
expr_stmt|;
name|s
operator|->
name|expire
operator|=
name|time_second
expr_stmt|;
name|s
operator|->
name|timeout
operator|=
name|PFTM_OTHER_FIRST_PACKET
expr_stmt|;
name|pf_set_rt_ifp
argument_list|(
name|s
argument_list|,
name|saddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sn
operator|!=
name|NULL
condition|)
block|{
name|s
operator|->
name|src_node
operator|=
name|sn
expr_stmt|;
name|s
operator|->
name|src_node
operator|->
name|states
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|nsn
operator|!=
name|NULL
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|nsn
operator|->
name|raddr
argument_list|,
operator|&
name|pd
operator|->
name|naddr
argument_list|,
name|af
argument_list|)
expr_stmt|;
name|s
operator|->
name|nat_src_node
operator|=
name|nsn
expr_stmt|;
name|s
operator|->
name|nat_src_node
operator|->
name|states
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|pf_insert_state
argument_list|(
name|BOUND_IFACE
argument_list|(
name|r
argument_list|,
name|kif
argument_list|)
argument_list|,
name|s
argument_list|)
condition|)
block|{
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_STATEINS
argument_list|)
expr_stmt|;
name|pf_src_tree_remove_state
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|STATE_DEC_COUNTERS
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|pool_put
argument_list|(
operator|&
name|pf_state_pl
argument_list|,
name|s
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
else|else
operator|*
name|sm
operator|=
name|s
expr_stmt|;
if|if
condition|(
name|tag
operator|>
literal|0
condition|)
block|{
name|pf_tag_ref
argument_list|(
name|tag
argument_list|)
expr_stmt|;
name|s
operator|->
name|tag
operator|=
name|tag
expr_stmt|;
block|}
block|}
return|return
operator|(
name|PF_PASS
operator|)
return|;
block|}
end_function

begin_function
name|int
name|pf_test_fragment
parameter_list|(
name|struct
name|pf_rule
modifier|*
modifier|*
name|rm
parameter_list|,
name|int
name|direction
parameter_list|,
name|struct
name|pfi_kif
modifier|*
name|kif
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|void
modifier|*
name|h
parameter_list|,
name|struct
name|pf_pdesc
modifier|*
name|pd
parameter_list|,
name|struct
name|pf_rule
modifier|*
modifier|*
name|am
parameter_list|,
name|struct
name|pf_ruleset
modifier|*
modifier|*
name|rsm
parameter_list|)
block|{
name|struct
name|pf_rule
modifier|*
name|r
decl_stmt|,
modifier|*
name|a
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_ruleset
modifier|*
name|ruleset
init|=
name|NULL
decl_stmt|;
name|sa_family_t
name|af
init|=
name|pd
operator|->
name|af
decl_stmt|;
name|u_short
name|reason
decl_stmt|;
name|struct
name|pf_tag
modifier|*
name|pftag
init|=
name|NULL
decl_stmt|;
name|int
name|tag
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|asd
init|=
literal|0
decl_stmt|;
name|r
operator|=
name|TAILQ_FIRST
argument_list|(
name|pf_main_ruleset
operator|.
name|rules
index|[
name|PF_RULESET_FILTER
index|]
operator|.
name|active
operator|.
name|ptr
argument_list|)
expr_stmt|;
while|while
condition|(
name|r
operator|!=
name|NULL
condition|)
block|{
name|r
operator|->
name|evaluations
operator|++
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|kif
operator|!=
name|NULL
operator|&&
operator|(
name|r
operator|->
name|kif
operator|!=
name|kif
operator|&&
name|r
operator|->
name|kif
operator|!=
name|kif
operator|->
name|pfik_parent
operator|)
operator|==
operator|!
name|r
operator|->
name|ifnot
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_IFP
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|direction
operator|&&
name|r
operator|->
name|direction
operator|!=
name|direction
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_DIR
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|af
operator|&&
name|r
operator|->
name|af
operator|!=
name|af
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_AF
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|proto
operator|&&
name|r
operator|->
name|proto
operator|!=
name|pd
operator|->
name|proto
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_PROTO
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|PF_MISMATCHAW
argument_list|(
operator|&
name|r
operator|->
name|src
operator|.
name|addr
argument_list|,
name|pd
operator|->
name|src
argument_list|,
name|af
argument_list|,
name|r
operator|->
name|src
operator|.
name|neg
argument_list|)
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_SRC_ADDR
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|PF_MISMATCHAW
argument_list|(
operator|&
name|r
operator|->
name|dst
operator|.
name|addr
argument_list|,
name|pd
operator|->
name|dst
argument_list|,
name|af
argument_list|,
name|r
operator|->
name|dst
operator|.
name|neg
argument_list|)
condition|)
name|r
operator|=
name|r
operator|->
name|skip
index|[
name|PF_SKIP_DST_ADDR
index|]
operator|.
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|tos
operator|&&
operator|!
operator|(
name|r
operator|->
name|tos
operator|&
name|pd
operator|->
name|tos
operator|)
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|src
operator|.
name|port_op
operator|||
name|r
operator|->
name|dst
operator|.
name|port_op
operator|||
name|r
operator|->
name|flagset
operator|||
name|r
operator|->
name|type
operator|||
name|r
operator|->
name|code
operator|||
name|r
operator|->
name|os_fingerprint
operator|!=
name|PF_OSFP_ANY
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|prob
operator|&&
name|r
operator|->
name|prob
operator|<=
name|arc4random
argument_list|()
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|->
name|match_tag
operator|&&
operator|!
name|pf_match_tag
argument_list|(
name|m
argument_list|,
name|r
argument_list|,
operator|&
name|pftag
argument_list|,
operator|&
name|tag
argument_list|)
condition|)
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|r
operator|->
name|anchor
operator|==
name|NULL
condition|)
block|{
operator|*
name|rm
operator|=
name|r
expr_stmt|;
operator|*
name|am
operator|=
name|a
expr_stmt|;
operator|*
name|rsm
operator|=
name|ruleset
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|rm
operator|)
operator|->
name|quick
condition|)
break|break;
name|r
operator|=
name|TAILQ_NEXT
argument_list|(
name|r
argument_list|,
name|entries
argument_list|)
expr_stmt|;
block|}
else|else
name|pf_step_into_anchor
argument_list|(
operator|&
name|asd
argument_list|,
operator|&
name|ruleset
argument_list|,
name|PF_RULESET_FILTER
argument_list|,
operator|&
name|r
argument_list|,
operator|&
name|a
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|==
name|NULL
condition|)
name|pf_step_out_of_anchor
argument_list|(
operator|&
name|asd
argument_list|,
operator|&
name|ruleset
argument_list|,
name|PF_RULESET_FILTER
argument_list|,
operator|&
name|r
argument_list|,
operator|&
name|a
argument_list|)
expr_stmt|;
block|}
name|r
operator|=
operator|*
name|rm
expr_stmt|;
name|a
operator|=
operator|*
name|am
expr_stmt|;
name|ruleset
operator|=
operator|*
name|rsm
expr_stmt|;
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_MATCH
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|log
condition|)
name|PFLOG_PACKET
argument_list|(
name|kif
argument_list|,
name|h
argument_list|,
name|m
argument_list|,
name|af
argument_list|,
name|direction
argument_list|,
name|reason
argument_list|,
name|r
argument_list|,
name|a
argument_list|,
name|ruleset
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|action
operator|!=
name|PF_PASS
condition|)
return|return
operator|(
name|PF_DROP
operator|)
return|;
if|if
condition|(
name|pf_tag_packet
argument_list|(
name|m
argument_list|,
name|pftag
argument_list|,
name|tag
argument_list|)
condition|)
block|{
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
return|return
operator|(
name|PF_PASS
operator|)
return|;
block|}
end_function

begin_function
name|int
name|pf_test_state_tcp
parameter_list|(
name|struct
name|pf_state
modifier|*
modifier|*
name|state
parameter_list|,
name|int
name|direction
parameter_list|,
name|struct
name|pfi_kif
modifier|*
name|kif
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|int
name|off
parameter_list|,
name|void
modifier|*
name|h
parameter_list|,
name|struct
name|pf_pdesc
modifier|*
name|pd
parameter_list|,
name|u_short
modifier|*
name|reason
parameter_list|)
block|{
name|struct
name|pf_state
name|key
decl_stmt|;
name|struct
name|tcphdr
modifier|*
name|th
init|=
name|pd
operator|->
name|hdr
operator|.
name|tcp
decl_stmt|;
name|u_int16_t
name|win
init|=
name|ntohs
argument_list|(
name|th
operator|->
name|th_win
argument_list|)
decl_stmt|;
name|u_int32_t
name|ack
decl_stmt|,
name|end
decl_stmt|,
name|seq
decl_stmt|,
name|orig_seq
decl_stmt|;
name|u_int8_t
name|sws
decl_stmt|,
name|dws
decl_stmt|;
name|int
name|ackskew
decl_stmt|;
name|int
name|copyback
init|=
literal|0
decl_stmt|;
name|struct
name|pf_state_peer
modifier|*
name|src
decl_stmt|,
modifier|*
name|dst
decl_stmt|;
name|key
operator|.
name|af
operator|=
name|pd
operator|->
name|af
expr_stmt|;
name|key
operator|.
name|proto
operator|=
name|IPPROTO_TCP
expr_stmt|;
if|if
condition|(
name|direction
operator|==
name|PF_IN
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|ext
operator|.
name|addr
argument_list|,
name|pd
operator|->
name|src
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|gwy
operator|.
name|addr
argument_list|,
name|pd
operator|->
name|dst
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|key
operator|.
name|ext
operator|.
name|port
operator|=
name|th
operator|->
name|th_sport
expr_stmt|;
name|key
operator|.
name|gwy
operator|.
name|port
operator|=
name|th
operator|->
name|th_dport
expr_stmt|;
block|}
else|else
block|{
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|lan
operator|.
name|addr
argument_list|,
name|pd
operator|->
name|src
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|ext
operator|.
name|addr
argument_list|,
name|pd
operator|->
name|dst
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|key
operator|.
name|lan
operator|.
name|port
operator|=
name|th
operator|->
name|th_sport
expr_stmt|;
name|key
operator|.
name|ext
operator|.
name|port
operator|=
name|th
operator|->
name|th_dport
expr_stmt|;
block|}
name|STATE_LOOKUP
argument_list|()
expr_stmt|;
if|if
condition|(
name|direction
operator|==
operator|(
operator|*
name|state
operator|)
operator|->
name|direction
condition|)
block|{
name|src
operator|=
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|src
expr_stmt|;
name|dst
operator|=
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|dst
expr_stmt|;
block|}
else|else
block|{
name|src
operator|=
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|dst
expr_stmt|;
name|dst
operator|=
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|src
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|*
name|state
operator|)
operator|->
name|src
operator|.
name|state
operator|==
name|PF_TCPS_PROXY_SRC
condition|)
block|{
if|if
condition|(
name|direction
operator|!=
operator|(
operator|*
name|state
operator|)
operator|->
name|direction
condition|)
block|{
name|REASON_SET
argument_list|(
name|reason
argument_list|,
name|PFRES_SYNPROXY
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_SYNPROXY_DROP
operator|)
return|;
block|}
if|if
condition|(
name|th
operator|->
name|th_flags
operator|&
name|TH_SYN
condition|)
block|{
if|if
condition|(
name|ntohl
argument_list|(
name|th
operator|->
name|th_seq
argument_list|)
operator|!=
operator|(
operator|*
name|state
operator|)
operator|->
name|src
operator|.
name|seqlo
condition|)
block|{
name|REASON_SET
argument_list|(
name|reason
argument_list|,
name|PFRES_SYNPROXY
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
name|pf_send_tcp
argument_list|(
operator|(
operator|*
name|state
operator|)
operator|->
name|rule
operator|.
name|ptr
argument_list|,
name|pd
operator|->
name|af
argument_list|,
name|pd
operator|->
name|dst
argument_list|,
name|pd
operator|->
name|src
argument_list|,
name|th
operator|->
name|th_dport
argument_list|,
name|th
operator|->
name|th_sport
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|src
operator|.
name|seqhi
argument_list|,
name|ntohl
argument_list|(
name|th
operator|->
name|th_seq
argument_list|)
operator|+
literal|1
argument_list|,
name|TH_SYN
operator||
name|TH_ACK
argument_list|,
literal|0
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|src
operator|.
name|mss
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|REASON_SET
argument_list|(
name|reason
argument_list|,
name|PFRES_SYNPROXY
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_SYNPROXY_DROP
operator|)
return|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|th
operator|->
name|th_flags
operator|&
name|TH_ACK
operator|)
operator|||
operator|(
name|ntohl
argument_list|(
name|th
operator|->
name|th_ack
argument_list|)
operator|!=
operator|(
operator|*
name|state
operator|)
operator|->
name|src
operator|.
name|seqhi
operator|+
literal|1
operator|)
operator|||
operator|(
name|ntohl
argument_list|(
name|th
operator|->
name|th_seq
argument_list|)
operator|!=
operator|(
operator|*
name|state
operator|)
operator|->
name|src
operator|.
name|seqlo
operator|+
literal|1
operator|)
condition|)
block|{
name|REASON_SET
argument_list|(
name|reason
argument_list|,
name|PFRES_SYNPROXY
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|*
name|state
operator|)
operator|->
name|src_node
operator|!=
name|NULL
operator|&&
name|pf_src_connlimit
argument_list|(
name|state
argument_list|)
condition|)
block|{
name|REASON_SET
argument_list|(
name|reason
argument_list|,
name|PFRES_SRCLIMIT
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
else|else
operator|(
operator|*
name|state
operator|)
operator|->
name|src
operator|.
name|state
operator|=
name|PF_TCPS_PROXY_DST
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|*
name|state
operator|)
operator|->
name|src
operator|.
name|state
operator|==
name|PF_TCPS_PROXY_DST
condition|)
block|{
name|struct
name|pf_state_host
modifier|*
name|src
decl_stmt|,
modifier|*
name|dst
decl_stmt|;
if|if
condition|(
name|direction
operator|==
name|PF_OUT
condition|)
block|{
name|src
operator|=
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|gwy
expr_stmt|;
name|dst
operator|=
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|ext
expr_stmt|;
block|}
else|else
block|{
name|src
operator|=
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|ext
expr_stmt|;
name|dst
operator|=
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|lan
expr_stmt|;
block|}
if|if
condition|(
name|direction
operator|==
operator|(
operator|*
name|state
operator|)
operator|->
name|direction
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|th
operator|->
name|th_flags
operator|&
operator|(
name|TH_SYN
operator||
name|TH_ACK
operator|)
operator|)
operator|!=
name|TH_ACK
operator|)
operator|||
operator|(
name|ntohl
argument_list|(
name|th
operator|->
name|th_ack
argument_list|)
operator|!=
operator|(
operator|*
name|state
operator|)
operator|->
name|src
operator|.
name|seqhi
operator|+
literal|1
operator|)
operator|||
operator|(
name|ntohl
argument_list|(
name|th
operator|->
name|th_seq
argument_list|)
operator|!=
operator|(
operator|*
name|state
operator|)
operator|->
name|src
operator|.
name|seqlo
operator|+
literal|1
operator|)
condition|)
block|{
name|REASON_SET
argument_list|(
name|reason
argument_list|,
name|PFRES_SYNPROXY
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
operator|(
operator|*
name|state
operator|)
operator|->
name|src
operator|.
name|max_win
operator|=
name|MAX
argument_list|(
name|ntohs
argument_list|(
name|th
operator|->
name|th_win
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|state
operator|)
operator|->
name|dst
operator|.
name|seqhi
operator|==
literal|1
condition|)
operator|(
operator|*
name|state
operator|)
operator|->
name|dst
operator|.
name|seqhi
operator|=
name|htonl
argument_list|(
name|arc4random
argument_list|()
argument_list|)
expr_stmt|;
name|pf_send_tcp
argument_list|(
operator|(
operator|*
name|state
operator|)
operator|->
name|rule
operator|.
name|ptr
argument_list|,
name|pd
operator|->
name|af
argument_list|,
operator|&
name|src
operator|->
name|addr
argument_list|,
operator|&
name|dst
operator|->
name|addr
argument_list|,
name|src
operator|->
name|port
argument_list|,
name|dst
operator|->
name|port
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|dst
operator|.
name|seqhi
argument_list|,
literal|0
argument_list|,
name|TH_SYN
argument_list|,
literal|0
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|src
operator|.
name|mss
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|REASON_SET
argument_list|(
name|reason
argument_list|,
name|PFRES_SYNPROXY
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_SYNPROXY_DROP
operator|)
return|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|(
name|th
operator|->
name|th_flags
operator|&
operator|(
name|TH_SYN
operator||
name|TH_ACK
operator|)
operator|)
operator|!=
operator|(
name|TH_SYN
operator||
name|TH_ACK
operator|)
operator|)
operator|||
operator|(
name|ntohl
argument_list|(
name|th
operator|->
name|th_ack
argument_list|)
operator|!=
operator|(
operator|*
name|state
operator|)
operator|->
name|dst
operator|.
name|seqhi
operator|+
literal|1
operator|)
condition|)
block|{
name|REASON_SET
argument_list|(
name|reason
argument_list|,
name|PFRES_SYNPROXY
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
else|else
block|{
operator|(
operator|*
name|state
operator|)
operator|->
name|dst
operator|.
name|max_win
operator|=
name|MAX
argument_list|(
name|ntohs
argument_list|(
name|th
operator|->
name|th_win
argument_list|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|(
operator|*
name|state
operator|)
operator|->
name|dst
operator|.
name|seqlo
operator|=
name|ntohl
argument_list|(
name|th
operator|->
name|th_seq
argument_list|)
expr_stmt|;
name|pf_send_tcp
argument_list|(
operator|(
operator|*
name|state
operator|)
operator|->
name|rule
operator|.
name|ptr
argument_list|,
name|pd
operator|->
name|af
argument_list|,
name|pd
operator|->
name|dst
argument_list|,
name|pd
operator|->
name|src
argument_list|,
name|th
operator|->
name|th_dport
argument_list|,
name|th
operator|->
name|th_sport
argument_list|,
name|ntohl
argument_list|(
name|th
operator|->
name|th_ack
argument_list|)
argument_list|,
name|ntohl
argument_list|(
name|th
operator|->
name|th_seq
argument_list|)
operator|+
literal|1
argument_list|,
name|TH_ACK
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|src
operator|.
name|max_win
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|pf_send_tcp
argument_list|(
operator|(
operator|*
name|state
operator|)
operator|->
name|rule
operator|.
name|ptr
argument_list|,
name|pd
operator|->
name|af
argument_list|,
operator|&
name|src
operator|->
name|addr
argument_list|,
operator|&
name|dst
operator|->
name|addr
argument_list|,
name|src
operator|->
name|port
argument_list|,
name|dst
operator|->
name|port
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|src
operator|.
name|seqhi
operator|+
literal|1
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|src
operator|.
name|seqlo
operator|+
literal|1
argument_list|,
name|TH_ACK
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|dst
operator|.
name|max_win
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
operator|(
operator|*
name|state
operator|)
operator|->
name|src
operator|.
name|seqdiff
operator|=
operator|(
operator|*
name|state
operator|)
operator|->
name|dst
operator|.
name|seqhi
operator|-
operator|(
operator|*
name|state
operator|)
operator|->
name|src
operator|.
name|seqlo
expr_stmt|;
operator|(
operator|*
name|state
operator|)
operator|->
name|dst
operator|.
name|seqdiff
operator|=
operator|(
operator|*
name|state
operator|)
operator|->
name|src
operator|.
name|seqhi
operator|-
operator|(
operator|*
name|state
operator|)
operator|->
name|dst
operator|.
name|seqlo
expr_stmt|;
operator|(
operator|*
name|state
operator|)
operator|->
name|src
operator|.
name|seqhi
operator|=
operator|(
operator|*
name|state
operator|)
operator|->
name|src
operator|.
name|seqlo
operator|+
operator|(
operator|*
name|state
operator|)
operator|->
name|dst
operator|.
name|max_win
expr_stmt|;
operator|(
operator|*
name|state
operator|)
operator|->
name|dst
operator|.
name|seqhi
operator|=
operator|(
operator|*
name|state
operator|)
operator|->
name|dst
operator|.
name|seqlo
operator|+
operator|(
operator|*
name|state
operator|)
operator|->
name|src
operator|.
name|max_win
expr_stmt|;
operator|(
operator|*
name|state
operator|)
operator|->
name|src
operator|.
name|wscale
operator|=
operator|(
operator|*
name|state
operator|)
operator|->
name|dst
operator|.
name|wscale
operator|=
literal|0
expr_stmt|;
operator|(
operator|*
name|state
operator|)
operator|->
name|src
operator|.
name|state
operator|=
operator|(
operator|*
name|state
operator|)
operator|->
name|dst
operator|.
name|state
operator|=
name|TCPS_ESTABLISHED
expr_stmt|;
name|REASON_SET
argument_list|(
name|reason
argument_list|,
name|PFRES_SYNPROXY
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_SYNPROXY_DROP
operator|)
return|;
block|}
block|}
if|if
condition|(
name|src
operator|->
name|wscale
operator|&&
name|dst
operator|->
name|wscale
operator|&&
operator|!
operator|(
name|th
operator|->
name|th_flags
operator|&
name|TH_SYN
operator|)
condition|)
block|{
name|sws
operator|=
name|src
operator|->
name|wscale
operator|&
name|PF_WSCALE_MASK
expr_stmt|;
name|dws
operator|=
name|dst
operator|->
name|wscale
operator|&
name|PF_WSCALE_MASK
expr_stmt|;
block|}
else|else
name|sws
operator|=
name|dws
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Sequence tracking algorithm from Guido van Rooij's paper: 	 *   http://www.madison-gurkha.com/publications/tcp_filtering/ 	 *	tcp_filtering.ps 	 */
name|orig_seq
operator|=
name|seq
operator|=
name|ntohl
argument_list|(
name|th
operator|->
name|th_seq
argument_list|)
expr_stmt|;
if|if
condition|(
name|src
operator|->
name|seqlo
operator|==
literal|0
condition|)
block|{
comment|/* First packet from this end. Set its state */
if|if
condition|(
operator|(
name|pd
operator|->
name|flags
operator|&
name|PFDESC_TCP_NORM
operator|||
name|dst
operator|->
name|scrub
operator|)
operator|&&
name|src
operator|->
name|scrub
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|pf_normalize_tcp_init
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
name|pd
argument_list|,
name|th
argument_list|,
name|src
argument_list|,
name|dst
argument_list|)
condition|)
block|{
name|REASON_SET
argument_list|(
name|reason
argument_list|,
name|PFRES_MEMORY
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
block|}
comment|/* Deferred generation of sequence number modulator */
if|if
condition|(
name|dst
operator|->
name|seqdiff
operator|&&
operator|!
name|src
operator|->
name|seqdiff
condition|)
block|{
while|while
condition|(
operator|(
name|src
operator|->
name|seqdiff
operator|=
name|htonl
argument_list|(
name|arc4random
argument_list|()
argument_list|)
operator|)
operator|==
literal|0
condition|)
empty_stmt|;
name|ack
operator|=
name|ntohl
argument_list|(
name|th
operator|->
name|th_ack
argument_list|)
operator|-
name|dst
operator|->
name|seqdiff
expr_stmt|;
name|pf_change_a
argument_list|(
operator|&
name|th
operator|->
name|th_seq
argument_list|,
operator|&
name|th
operator|->
name|th_sum
argument_list|,
name|htonl
argument_list|(
name|seq
operator|+
name|src
operator|->
name|seqdiff
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pf_change_a
argument_list|(
operator|&
name|th
operator|->
name|th_ack
argument_list|,
operator|&
name|th
operator|->
name|th_sum
argument_list|,
name|htonl
argument_list|(
name|ack
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|copyback
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|ack
operator|=
name|ntohl
argument_list|(
name|th
operator|->
name|th_ack
argument_list|)
expr_stmt|;
block|}
name|end
operator|=
name|seq
operator|+
name|pd
operator|->
name|p_len
expr_stmt|;
if|if
condition|(
name|th
operator|->
name|th_flags
operator|&
name|TH_SYN
condition|)
block|{
name|end
operator|++
expr_stmt|;
if|if
condition|(
name|dst
operator|->
name|wscale
operator|&
name|PF_WSCALE_FLAG
condition|)
block|{
name|src
operator|->
name|wscale
operator|=
name|pf_get_wscale
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
name|th
operator|->
name|th_off
argument_list|,
name|pd
operator|->
name|af
argument_list|)
expr_stmt|;
if|if
condition|(
name|src
operator|->
name|wscale
operator|&
name|PF_WSCALE_FLAG
condition|)
block|{
comment|/* Remove scale factor from initial 					 * window */
name|sws
operator|=
name|src
operator|->
name|wscale
operator|&
name|PF_WSCALE_MASK
expr_stmt|;
name|win
operator|=
operator|(
operator|(
name|u_int32_t
operator|)
name|win
operator|+
operator|(
literal|1
operator|<<
name|sws
operator|)
operator|-
literal|1
operator|)
operator|>>
name|sws
expr_stmt|;
name|dws
operator|=
name|dst
operator|->
name|wscale
operator|&
name|PF_WSCALE_MASK
expr_stmt|;
block|}
else|else
block|{
comment|/* fixup other window */
name|dst
operator|->
name|max_win
operator|<<=
name|dst
operator|->
name|wscale
operator|&
name|PF_WSCALE_MASK
expr_stmt|;
comment|/* in case of a retrans SYN|ACK */
name|dst
operator|->
name|wscale
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|th
operator|->
name|th_flags
operator|&
name|TH_FIN
condition|)
name|end
operator|++
expr_stmt|;
name|src
operator|->
name|seqlo
operator|=
name|seq
expr_stmt|;
if|if
condition|(
name|src
operator|->
name|state
operator|<
name|TCPS_SYN_SENT
condition|)
name|src
operator|->
name|state
operator|=
name|TCPS_SYN_SENT
expr_stmt|;
comment|/* 		 * May need to slide the window (seqhi may have been set by 		 * the crappy stack check or if we picked up the connection 		 * after establishment) 		 */
if|if
condition|(
name|src
operator|->
name|seqhi
operator|==
literal|1
operator|||
name|SEQ_GEQ
argument_list|(
name|end
operator|+
name|MAX
argument_list|(
literal|1
argument_list|,
name|dst
operator|->
name|max_win
operator|<<
name|dws
argument_list|)
argument_list|,
name|src
operator|->
name|seqhi
argument_list|)
condition|)
name|src
operator|->
name|seqhi
operator|=
name|end
operator|+
name|MAX
argument_list|(
literal|1
argument_list|,
name|dst
operator|->
name|max_win
operator|<<
name|dws
argument_list|)
expr_stmt|;
if|if
condition|(
name|win
operator|>
name|src
operator|->
name|max_win
condition|)
name|src
operator|->
name|max_win
operator|=
name|win
expr_stmt|;
block|}
else|else
block|{
name|ack
operator|=
name|ntohl
argument_list|(
name|th
operator|->
name|th_ack
argument_list|)
operator|-
name|dst
operator|->
name|seqdiff
expr_stmt|;
if|if
condition|(
name|src
operator|->
name|seqdiff
condition|)
block|{
comment|/* Modulate sequence numbers */
name|pf_change_a
argument_list|(
operator|&
name|th
operator|->
name|th_seq
argument_list|,
operator|&
name|th
operator|->
name|th_sum
argument_list|,
name|htonl
argument_list|(
name|seq
operator|+
name|src
operator|->
name|seqdiff
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pf_change_a
argument_list|(
operator|&
name|th
operator|->
name|th_ack
argument_list|,
operator|&
name|th
operator|->
name|th_sum
argument_list|,
name|htonl
argument_list|(
name|ack
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|copyback
operator|=
literal|1
expr_stmt|;
block|}
name|end
operator|=
name|seq
operator|+
name|pd
operator|->
name|p_len
expr_stmt|;
if|if
condition|(
name|th
operator|->
name|th_flags
operator|&
name|TH_SYN
condition|)
name|end
operator|++
expr_stmt|;
if|if
condition|(
name|th
operator|->
name|th_flags
operator|&
name|TH_FIN
condition|)
name|end
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|th
operator|->
name|th_flags
operator|&
name|TH_ACK
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* Let it pass through the ack skew check */
name|ack
operator|=
name|dst
operator|->
name|seqlo
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ack
operator|==
literal|0
operator|&&
operator|(
name|th
operator|->
name|th_flags
operator|&
operator|(
name|TH_ACK
operator||
name|TH_RST
operator|)
operator|)
operator|==
operator|(
name|TH_ACK
operator||
name|TH_RST
operator|)
operator|)
operator|||
comment|/* broken tcp stacks do not set ack */
operator|(
name|dst
operator|->
name|state
operator|<
name|TCPS_SYN_SENT
operator|)
condition|)
block|{
comment|/* 		 * Many stacks (ours included) will set the ACK number in an 		 * FIN|ACK if the SYN times out -- no sequence to ACK. 		 */
name|ack
operator|=
name|dst
operator|->
name|seqlo
expr_stmt|;
block|}
if|if
condition|(
name|seq
operator|==
name|end
condition|)
block|{
comment|/* Ease sequencing restrictions on no data packets */
name|seq
operator|=
name|src
operator|->
name|seqlo
expr_stmt|;
name|end
operator|=
name|seq
expr_stmt|;
block|}
name|ackskew
operator|=
name|dst
operator|->
name|seqlo
operator|-
name|ack
expr_stmt|;
define|#
directive|define
name|MAXACKWINDOW
value|(0xffff + 1500)
comment|/* 1500 is an arbitrary fudge factor */
if|if
condition|(
name|SEQ_GEQ
argument_list|(
name|src
operator|->
name|seqhi
argument_list|,
name|end
argument_list|)
operator|&&
comment|/* Last octet inside other's window space */
name|SEQ_GEQ
argument_list|(
name|seq
argument_list|,
name|src
operator|->
name|seqlo
operator|-
operator|(
name|dst
operator|->
name|max_win
operator|<<
name|dws
operator|)
argument_list|)
operator|&&
comment|/* Retrans: not more than one window back */
operator|(
name|ackskew
operator|>=
operator|-
name|MAXACKWINDOW
operator|)
operator|&&
comment|/* Acking not more than one reassembled fragment backwards */
operator|(
name|ackskew
operator|<=
operator|(
name|MAXACKWINDOW
operator|<<
name|sws
operator|)
operator|)
operator|&&
comment|/* Acking not more than one window forward */
operator|(
operator|(
name|th
operator|->
name|th_flags
operator|&
name|TH_RST
operator|)
operator|==
literal|0
operator|||
name|orig_seq
operator|==
name|src
operator|->
name|seqlo
operator|||
operator|(
name|pd
operator|->
name|flags
operator|&
name|PFDESC_IP_REAS
operator|)
operator|==
literal|0
operator|)
condition|)
block|{
comment|/* Require an exact sequence match on resets when possible */
if|if
condition|(
name|dst
operator|->
name|scrub
operator|||
name|src
operator|->
name|scrub
condition|)
block|{
if|if
condition|(
name|pf_normalize_tcp_stateful
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
name|pd
argument_list|,
name|reason
argument_list|,
name|th
argument_list|,
operator|*
name|state
argument_list|,
name|src
argument_list|,
name|dst
argument_list|,
operator|&
name|copyback
argument_list|)
condition|)
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
comment|/* update max window */
if|if
condition|(
name|src
operator|->
name|max_win
operator|<
name|win
condition|)
name|src
operator|->
name|max_win
operator|=
name|win
expr_stmt|;
comment|/* synchronize sequencing */
if|if
condition|(
name|SEQ_GT
argument_list|(
name|end
argument_list|,
name|src
operator|->
name|seqlo
argument_list|)
condition|)
name|src
operator|->
name|seqlo
operator|=
name|end
expr_stmt|;
comment|/* slide the window of what the other end can send */
if|if
condition|(
name|SEQ_GEQ
argument_list|(
name|ack
operator|+
operator|(
name|win
operator|<<
name|sws
operator|)
argument_list|,
name|dst
operator|->
name|seqhi
argument_list|)
condition|)
name|dst
operator|->
name|seqhi
operator|=
name|ack
operator|+
name|MAX
argument_list|(
operator|(
name|win
operator|<<
name|sws
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* update states */
if|if
condition|(
name|th
operator|->
name|th_flags
operator|&
name|TH_SYN
condition|)
if|if
condition|(
name|src
operator|->
name|state
operator|<
name|TCPS_SYN_SENT
condition|)
name|src
operator|->
name|state
operator|=
name|TCPS_SYN_SENT
expr_stmt|;
if|if
condition|(
name|th
operator|->
name|th_flags
operator|&
name|TH_FIN
condition|)
if|if
condition|(
name|src
operator|->
name|state
operator|<
name|TCPS_CLOSING
condition|)
name|src
operator|->
name|state
operator|=
name|TCPS_CLOSING
expr_stmt|;
if|if
condition|(
name|th
operator|->
name|th_flags
operator|&
name|TH_ACK
condition|)
block|{
if|if
condition|(
name|dst
operator|->
name|state
operator|==
name|TCPS_SYN_SENT
condition|)
block|{
name|dst
operator|->
name|state
operator|=
name|TCPS_ESTABLISHED
expr_stmt|;
if|if
condition|(
name|src
operator|->
name|state
operator|==
name|TCPS_ESTABLISHED
operator|&&
operator|(
operator|*
name|state
operator|)
operator|->
name|src_node
operator|!=
name|NULL
operator|&&
name|pf_src_connlimit
argument_list|(
name|state
argument_list|)
condition|)
block|{
name|REASON_SET
argument_list|(
name|reason
argument_list|,
name|PFRES_SRCLIMIT
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|dst
operator|->
name|state
operator|==
name|TCPS_CLOSING
condition|)
name|dst
operator|->
name|state
operator|=
name|TCPS_FIN_WAIT_2
expr_stmt|;
block|}
if|if
condition|(
name|th
operator|->
name|th_flags
operator|&
name|TH_RST
condition|)
name|src
operator|->
name|state
operator|=
name|dst
operator|->
name|state
operator|=
name|TCPS_TIME_WAIT
expr_stmt|;
comment|/* update expire time */
operator|(
operator|*
name|state
operator|)
operator|->
name|expire
operator|=
name|time_second
expr_stmt|;
if|if
condition|(
name|src
operator|->
name|state
operator|>=
name|TCPS_FIN_WAIT_2
operator|&&
name|dst
operator|->
name|state
operator|>=
name|TCPS_FIN_WAIT_2
condition|)
operator|(
operator|*
name|state
operator|)
operator|->
name|timeout
operator|=
name|PFTM_TCP_CLOSED
expr_stmt|;
elseif|else
if|if
condition|(
name|src
operator|->
name|state
operator|>=
name|TCPS_FIN_WAIT_2
operator|||
name|dst
operator|->
name|state
operator|>=
name|TCPS_FIN_WAIT_2
condition|)
operator|(
operator|*
name|state
operator|)
operator|->
name|timeout
operator|=
name|PFTM_TCP_FIN_WAIT
expr_stmt|;
elseif|else
if|if
condition|(
name|src
operator|->
name|state
operator|<
name|TCPS_ESTABLISHED
operator|||
name|dst
operator|->
name|state
operator|<
name|TCPS_ESTABLISHED
condition|)
operator|(
operator|*
name|state
operator|)
operator|->
name|timeout
operator|=
name|PFTM_TCP_OPENING
expr_stmt|;
elseif|else
if|if
condition|(
name|src
operator|->
name|state
operator|>=
name|TCPS_CLOSING
operator|||
name|dst
operator|->
name|state
operator|>=
name|TCPS_CLOSING
condition|)
operator|(
operator|*
name|state
operator|)
operator|->
name|timeout
operator|=
name|PFTM_TCP_CLOSING
expr_stmt|;
else|else
operator|(
operator|*
name|state
operator|)
operator|->
name|timeout
operator|=
name|PFTM_TCP_ESTABLISHED
expr_stmt|;
comment|/* Fall through to PASS packet */
block|}
elseif|else
if|if
condition|(
operator|(
name|dst
operator|->
name|state
operator|<
name|TCPS_SYN_SENT
operator|||
name|dst
operator|->
name|state
operator|>=
name|TCPS_FIN_WAIT_2
operator|||
name|src
operator|->
name|state
operator|>=
name|TCPS_FIN_WAIT_2
operator|)
operator|&&
name|SEQ_GEQ
argument_list|(
name|src
operator|->
name|seqhi
operator|+
name|MAXACKWINDOW
argument_list|,
name|end
argument_list|)
operator|&&
comment|/* Within a window forward of the originating packet */
name|SEQ_GEQ
argument_list|(
name|seq
argument_list|,
name|src
operator|->
name|seqlo
operator|-
name|MAXACKWINDOW
argument_list|)
condition|)
block|{
comment|/* Within a window backward of the originating packet */
comment|/* 		 * This currently handles three situations: 		 *  1) Stupid stacks will shotgun SYNs before their peer 		 *     replies. 		 *  2) When PF catches an already established stream (the 		 *     firewall rebooted, the state table was flushed, routes 		 *     changed...) 		 *  3) Packets get funky immediately after the connection 		 *     closes (this should catch Solaris spurious ACK|FINs 		 *     that web servers like to spew after a close) 		 * 		 * This must be a little more careful than the above code 		 * since packet floods will also be caught here. We don't 		 * update the TTL here to mitigate the damage of a packet 		 * flood and so the same code can handle awkward establishment 		 * and a loosened connection close. 		 * In the establishment case, a correct peer response will 		 * validate the connection, go through the normal state code 		 * and keep updating the state TTL. 		 */
if|if
condition|(
name|pf_status
operator|.
name|debug
operator|>=
name|PF_DEBUG_MISC
condition|)
block|{
name|printf
argument_list|(
literal|"pf: loose state match: "
argument_list|)
expr_stmt|;
name|pf_print_state
argument_list|(
operator|*
name|state
argument_list|)
expr_stmt|;
name|pf_print_flags
argument_list|(
name|th
operator|->
name|th_flags
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" seq=%u ack=%u len=%u ackskew=%d pkts=%d:%d\n"
argument_list|,
name|seq
argument_list|,
name|ack
argument_list|,
name|pd
operator|->
name|p_len
argument_list|,
name|ackskew
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|packets
index|[
literal|0
index|]
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|packets
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dst
operator|->
name|scrub
operator|||
name|src
operator|->
name|scrub
condition|)
block|{
if|if
condition|(
name|pf_normalize_tcp_stateful
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
name|pd
argument_list|,
name|reason
argument_list|,
name|th
argument_list|,
operator|*
name|state
argument_list|,
name|src
argument_list|,
name|dst
argument_list|,
operator|&
name|copyback
argument_list|)
condition|)
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
comment|/* update max window */
if|if
condition|(
name|src
operator|->
name|max_win
operator|<
name|win
condition|)
name|src
operator|->
name|max_win
operator|=
name|win
expr_stmt|;
comment|/* synchronize sequencing */
if|if
condition|(
name|SEQ_GT
argument_list|(
name|end
argument_list|,
name|src
operator|->
name|seqlo
argument_list|)
condition|)
name|src
operator|->
name|seqlo
operator|=
name|end
expr_stmt|;
comment|/* slide the window of what the other end can send */
if|if
condition|(
name|SEQ_GEQ
argument_list|(
name|ack
operator|+
operator|(
name|win
operator|<<
name|sws
operator|)
argument_list|,
name|dst
operator|->
name|seqhi
argument_list|)
condition|)
name|dst
operator|->
name|seqhi
operator|=
name|ack
operator|+
name|MAX
argument_list|(
operator|(
name|win
operator|<<
name|sws
operator|)
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* 		 * Cannot set dst->seqhi here since this could be a shotgunned 		 * SYN and not an already established connection. 		 */
if|if
condition|(
name|th
operator|->
name|th_flags
operator|&
name|TH_FIN
condition|)
if|if
condition|(
name|src
operator|->
name|state
operator|<
name|TCPS_CLOSING
condition|)
name|src
operator|->
name|state
operator|=
name|TCPS_CLOSING
expr_stmt|;
if|if
condition|(
name|th
operator|->
name|th_flags
operator|&
name|TH_RST
condition|)
name|src
operator|->
name|state
operator|=
name|dst
operator|->
name|state
operator|=
name|TCPS_TIME_WAIT
expr_stmt|;
comment|/* Fall through to PASS packet */
block|}
else|else
block|{
if|if
condition|(
operator|(
operator|*
name|state
operator|)
operator|->
name|dst
operator|.
name|state
operator|==
name|TCPS_SYN_SENT
operator|&&
operator|(
operator|*
name|state
operator|)
operator|->
name|src
operator|.
name|state
operator|==
name|TCPS_SYN_SENT
condition|)
block|{
comment|/* Send RST for state mismatches during handshake */
if|if
condition|(
operator|!
operator|(
name|th
operator|->
name|th_flags
operator|&
name|TH_RST
operator|)
condition|)
name|pf_send_tcp
argument_list|(
operator|(
operator|*
name|state
operator|)
operator|->
name|rule
operator|.
name|ptr
argument_list|,
name|pd
operator|->
name|af
argument_list|,
name|pd
operator|->
name|dst
argument_list|,
name|pd
operator|->
name|src
argument_list|,
name|th
operator|->
name|th_dport
argument_list|,
name|th
operator|->
name|th_sport
argument_list|,
name|ntohl
argument_list|(
name|th
operator|->
name|th_ack
argument_list|)
argument_list|,
literal|0
argument_list|,
name|TH_RST
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|rule
operator|.
name|ptr
operator|->
name|return_ttl
argument_list|,
literal|1
argument_list|,
name|pd
operator|->
name|eh
argument_list|,
name|kif
operator|->
name|pfik_ifp
argument_list|)
expr_stmt|;
name|src
operator|->
name|seqlo
operator|=
literal|0
expr_stmt|;
name|src
operator|->
name|seqhi
operator|=
literal|1
expr_stmt|;
name|src
operator|->
name|max_win
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pf_status
operator|.
name|debug
operator|>=
name|PF_DEBUG_MISC
condition|)
block|{
name|printf
argument_list|(
literal|"pf: BAD state: "
argument_list|)
expr_stmt|;
name|pf_print_state
argument_list|(
operator|*
name|state
argument_list|)
expr_stmt|;
name|pf_print_flags
argument_list|(
name|th
operator|->
name|th_flags
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" seq=%u ack=%u len=%u ackskew=%d pkts=%d:%d "
literal|"dir=%s,%s\n"
argument_list|,
name|seq
argument_list|,
name|ack
argument_list|,
name|pd
operator|->
name|p_len
argument_list|,
name|ackskew
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|packets
index|[
literal|0
index|]
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|packets
index|[
literal|1
index|]
argument_list|,
name|direction
operator|==
name|PF_IN
condition|?
literal|"in"
else|:
literal|"out"
argument_list|,
name|direction
operator|==
operator|(
operator|*
name|state
operator|)
operator|->
name|direction
condition|?
literal|"fwd"
else|:
literal|"rev"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"pf: State failure on: %c %c %c %c | %c %c\n"
argument_list|,
name|SEQ_GEQ
argument_list|(
name|src
operator|->
name|seqhi
argument_list|,
name|end
argument_list|)
condition|?
literal|' '
else|:
literal|'1'
argument_list|,
name|SEQ_GEQ
argument_list|(
name|seq
argument_list|,
name|src
operator|->
name|seqlo
operator|-
operator|(
name|dst
operator|->
name|max_win
operator|<<
name|dws
operator|)
argument_list|)
condition|?
literal|' '
else|:
literal|'2'
argument_list|,
operator|(
name|ackskew
operator|>=
operator|-
name|MAXACKWINDOW
operator|)
condition|?
literal|' '
else|:
literal|'3'
argument_list|,
operator|(
name|ackskew
operator|<=
operator|(
name|MAXACKWINDOW
operator|<<
name|sws
operator|)
operator|)
condition|?
literal|' '
else|:
literal|'4'
argument_list|,
name|SEQ_GEQ
argument_list|(
name|src
operator|->
name|seqhi
operator|+
name|MAXACKWINDOW
argument_list|,
name|end
argument_list|)
condition|?
literal|' '
else|:
literal|'5'
argument_list|,
name|SEQ_GEQ
argument_list|(
name|seq
argument_list|,
name|src
operator|->
name|seqlo
operator|-
name|MAXACKWINDOW
argument_list|)
condition|?
literal|' '
else|:
literal|'6'
argument_list|)
expr_stmt|;
block|}
name|REASON_SET
argument_list|(
name|reason
argument_list|,
name|PFRES_BADSTATE
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
comment|/* Any packets which have gotten here are to be passed */
comment|/* translate source/destination address, if necessary */
if|if
condition|(
name|STATE_TRANSLATE
argument_list|(
operator|*
name|state
argument_list|)
condition|)
block|{
if|if
condition|(
name|direction
operator|==
name|PF_OUT
condition|)
name|pf_change_ap
argument_list|(
name|pd
operator|->
name|src
argument_list|,
operator|&
name|th
operator|->
name|th_sport
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
operator|&
name|th
operator|->
name|th_sum
argument_list|,
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|gwy
operator|.
name|addr
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|gwy
operator|.
name|port
argument_list|,
literal|0
argument_list|,
name|pd
operator|->
name|af
argument_list|)
expr_stmt|;
else|else
name|pf_change_ap
argument_list|(
name|pd
operator|->
name|dst
argument_list|,
operator|&
name|th
operator|->
name|th_dport
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
operator|&
name|th
operator|->
name|th_sum
argument_list|,
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|lan
operator|.
name|addr
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|lan
operator|.
name|port
argument_list|,
literal|0
argument_list|,
name|pd
operator|->
name|af
argument_list|)
expr_stmt|;
name|m_copyback
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|th
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
name|th
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|copyback
condition|)
block|{
comment|/* Copyback sequence modulation or stateful scrub changes */
name|m_copyback
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|th
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
name|th
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|PF_PASS
operator|)
return|;
block|}
end_function

begin_function
name|int
name|pf_test_state_udp
parameter_list|(
name|struct
name|pf_state
modifier|*
modifier|*
name|state
parameter_list|,
name|int
name|direction
parameter_list|,
name|struct
name|pfi_kif
modifier|*
name|kif
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|int
name|off
parameter_list|,
name|void
modifier|*
name|h
parameter_list|,
name|struct
name|pf_pdesc
modifier|*
name|pd
parameter_list|)
block|{
name|struct
name|pf_state_peer
modifier|*
name|src
decl_stmt|,
modifier|*
name|dst
decl_stmt|;
name|struct
name|pf_state
name|key
decl_stmt|;
name|struct
name|udphdr
modifier|*
name|uh
init|=
name|pd
operator|->
name|hdr
operator|.
name|udp
decl_stmt|;
name|key
operator|.
name|af
operator|=
name|pd
operator|->
name|af
expr_stmt|;
name|key
operator|.
name|proto
operator|=
name|IPPROTO_UDP
expr_stmt|;
if|if
condition|(
name|direction
operator|==
name|PF_IN
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|ext
operator|.
name|addr
argument_list|,
name|pd
operator|->
name|src
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|gwy
operator|.
name|addr
argument_list|,
name|pd
operator|->
name|dst
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|key
operator|.
name|ext
operator|.
name|port
operator|=
name|uh
operator|->
name|uh_sport
expr_stmt|;
name|key
operator|.
name|gwy
operator|.
name|port
operator|=
name|uh
operator|->
name|uh_dport
expr_stmt|;
block|}
else|else
block|{
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|lan
operator|.
name|addr
argument_list|,
name|pd
operator|->
name|src
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|ext
operator|.
name|addr
argument_list|,
name|pd
operator|->
name|dst
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|key
operator|.
name|lan
operator|.
name|port
operator|=
name|uh
operator|->
name|uh_sport
expr_stmt|;
name|key
operator|.
name|ext
operator|.
name|port
operator|=
name|uh
operator|->
name|uh_dport
expr_stmt|;
block|}
name|STATE_LOOKUP
argument_list|()
expr_stmt|;
if|if
condition|(
name|direction
operator|==
operator|(
operator|*
name|state
operator|)
operator|->
name|direction
condition|)
block|{
name|src
operator|=
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|src
expr_stmt|;
name|dst
operator|=
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|dst
expr_stmt|;
block|}
else|else
block|{
name|src
operator|=
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|dst
expr_stmt|;
name|dst
operator|=
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|src
expr_stmt|;
block|}
comment|/* update states */
if|if
condition|(
name|src
operator|->
name|state
operator|<
name|PFUDPS_SINGLE
condition|)
name|src
operator|->
name|state
operator|=
name|PFUDPS_SINGLE
expr_stmt|;
if|if
condition|(
name|dst
operator|->
name|state
operator|==
name|PFUDPS_SINGLE
condition|)
name|dst
operator|->
name|state
operator|=
name|PFUDPS_MULTIPLE
expr_stmt|;
comment|/* update expire time */
operator|(
operator|*
name|state
operator|)
operator|->
name|expire
operator|=
name|time_second
expr_stmt|;
if|if
condition|(
name|src
operator|->
name|state
operator|==
name|PFUDPS_MULTIPLE
operator|&&
name|dst
operator|->
name|state
operator|==
name|PFUDPS_MULTIPLE
condition|)
operator|(
operator|*
name|state
operator|)
operator|->
name|timeout
operator|=
name|PFTM_UDP_MULTIPLE
expr_stmt|;
else|else
operator|(
operator|*
name|state
operator|)
operator|->
name|timeout
operator|=
name|PFTM_UDP_SINGLE
expr_stmt|;
comment|/* translate source/destination address, if necessary */
if|if
condition|(
name|STATE_TRANSLATE
argument_list|(
operator|*
name|state
argument_list|)
condition|)
block|{
if|if
condition|(
name|direction
operator|==
name|PF_OUT
condition|)
name|pf_change_ap
argument_list|(
name|pd
operator|->
name|src
argument_list|,
operator|&
name|uh
operator|->
name|uh_sport
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
operator|&
name|uh
operator|->
name|uh_sum
argument_list|,
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|gwy
operator|.
name|addr
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|gwy
operator|.
name|port
argument_list|,
literal|1
argument_list|,
name|pd
operator|->
name|af
argument_list|)
expr_stmt|;
else|else
name|pf_change_ap
argument_list|(
name|pd
operator|->
name|dst
argument_list|,
operator|&
name|uh
operator|->
name|uh_dport
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
operator|&
name|uh
operator|->
name|uh_sum
argument_list|,
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|lan
operator|.
name|addr
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|lan
operator|.
name|port
argument_list|,
literal|1
argument_list|,
name|pd
operator|->
name|af
argument_list|)
expr_stmt|;
name|m_copyback
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|uh
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
name|uh
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|PF_PASS
operator|)
return|;
block|}
end_function

begin_function
name|int
name|pf_test_state_icmp
parameter_list|(
name|struct
name|pf_state
modifier|*
modifier|*
name|state
parameter_list|,
name|int
name|direction
parameter_list|,
name|struct
name|pfi_kif
modifier|*
name|kif
parameter_list|,
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|int
name|off
parameter_list|,
name|void
modifier|*
name|h
parameter_list|,
name|struct
name|pf_pdesc
modifier|*
name|pd
parameter_list|,
name|u_short
modifier|*
name|reason
parameter_list|)
block|{
name|struct
name|pf_addr
modifier|*
name|saddr
init|=
name|pd
operator|->
name|src
decl_stmt|,
modifier|*
name|daddr
init|=
name|pd
operator|->
name|dst
decl_stmt|;
name|u_int16_t
name|icmpid
init|=
literal|0
decl_stmt|;
comment|/* make the compiler happy */
name|u_int16_t
modifier|*
name|icmpsum
init|=
name|NULL
decl_stmt|;
comment|/* make the compiler happy */
name|u_int8_t
name|icmptype
init|=
literal|0
decl_stmt|;
comment|/* make the compiler happy */
name|int
name|state_icmp
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|pd
operator|->
name|proto
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|IPPROTO_ICMP
case|:
name|icmptype
operator|=
name|pd
operator|->
name|hdr
operator|.
name|icmp
operator|->
name|icmp_type
expr_stmt|;
name|icmpid
operator|=
name|pd
operator|->
name|hdr
operator|.
name|icmp
operator|->
name|icmp_id
expr_stmt|;
name|icmpsum
operator|=
operator|&
name|pd
operator|->
name|hdr
operator|.
name|icmp
operator|->
name|icmp_cksum
expr_stmt|;
if|if
condition|(
name|icmptype
operator|==
name|ICMP_UNREACH
operator|||
name|icmptype
operator|==
name|ICMP_SOURCEQUENCH
operator|||
name|icmptype
operator|==
name|ICMP_REDIRECT
operator|||
name|icmptype
operator|==
name|ICMP_TIMXCEED
operator|||
name|icmptype
operator|==
name|ICMP_PARAMPROB
condition|)
name|state_icmp
operator|++
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|IPPROTO_ICMPV6
case|:
name|icmptype
operator|=
name|pd
operator|->
name|hdr
operator|.
name|icmp6
operator|->
name|icmp6_type
expr_stmt|;
name|icmpid
operator|=
name|pd
operator|->
name|hdr
operator|.
name|icmp6
operator|->
name|icmp6_id
expr_stmt|;
name|icmpsum
operator|=
operator|&
name|pd
operator|->
name|hdr
operator|.
name|icmp6
operator|->
name|icmp6_cksum
expr_stmt|;
if|if
condition|(
name|icmptype
operator|==
name|ICMP6_DST_UNREACH
operator|||
name|icmptype
operator|==
name|ICMP6_PACKET_TOO_BIG
operator|||
name|icmptype
operator|==
name|ICMP6_TIME_EXCEEDED
operator|||
name|icmptype
operator|==
name|ICMP6_PARAM_PROB
condition|)
name|state_icmp
operator|++
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
if|if
condition|(
operator|!
name|state_icmp
condition|)
block|{
comment|/* 		 * ICMP query/reply message not related to a TCP/UDP packet. 		 * Search for an ICMP state. 		 */
name|struct
name|pf_state
name|key
decl_stmt|;
name|key
operator|.
name|af
operator|=
name|pd
operator|->
name|af
expr_stmt|;
name|key
operator|.
name|proto
operator|=
name|pd
operator|->
name|proto
expr_stmt|;
if|if
condition|(
name|direction
operator|==
name|PF_IN
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|ext
operator|.
name|addr
argument_list|,
name|pd
operator|->
name|src
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|gwy
operator|.
name|addr
argument_list|,
name|pd
operator|->
name|dst
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|key
operator|.
name|ext
operator|.
name|port
operator|=
literal|0
expr_stmt|;
name|key
operator|.
name|gwy
operator|.
name|port
operator|=
name|icmpid
expr_stmt|;
block|}
else|else
block|{
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|lan
operator|.
name|addr
argument_list|,
name|pd
operator|->
name|src
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|ext
operator|.
name|addr
argument_list|,
name|pd
operator|->
name|dst
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|key
operator|.
name|lan
operator|.
name|port
operator|=
name|icmpid
expr_stmt|;
name|key
operator|.
name|ext
operator|.
name|port
operator|=
literal|0
expr_stmt|;
block|}
name|STATE_LOOKUP
argument_list|()
expr_stmt|;
operator|(
operator|*
name|state
operator|)
operator|->
name|expire
operator|=
name|time_second
expr_stmt|;
operator|(
operator|*
name|state
operator|)
operator|->
name|timeout
operator|=
name|PFTM_ICMP_ERROR_REPLY
expr_stmt|;
comment|/* translate source/destination address, if necessary */
if|if
condition|(
name|STATE_TRANSLATE
argument_list|(
operator|*
name|state
argument_list|)
condition|)
block|{
if|if
condition|(
name|direction
operator|==
name|PF_OUT
condition|)
block|{
switch|switch
condition|(
name|pd
operator|->
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
name|pf_change_a
argument_list|(
operator|&
name|saddr
operator|->
name|v4
operator|.
name|s_addr
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|gwy
operator|.
name|addr
operator|.
name|v4
operator|.
name|s_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pd
operator|->
name|hdr
operator|.
name|icmp
operator|->
name|icmp_cksum
operator|=
name|pf_cksum_fixup
argument_list|(
name|pd
operator|->
name|hdr
operator|.
name|icmp
operator|->
name|icmp_cksum
argument_list|,
name|icmpid
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|gwy
operator|.
name|port
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pd
operator|->
name|hdr
operator|.
name|icmp
operator|->
name|icmp_id
operator|=
operator|(
operator|*
name|state
operator|)
operator|->
name|gwy
operator|.
name|port
expr_stmt|;
name|m_copyback
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
name|ICMP_MINLEN
argument_list|,
operator|(
name|caddr_t
operator|)
name|pd
operator|->
name|hdr
operator|.
name|icmp
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
name|pf_change_a6
argument_list|(
name|saddr
argument_list|,
operator|&
name|pd
operator|->
name|hdr
operator|.
name|icmp6
operator|->
name|icmp6_cksum
argument_list|,
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|gwy
operator|.
name|addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|m_copyback
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|icmp6_hdr
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
name|pd
operator|->
name|hdr
operator|.
name|icmp6
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
block|}
else|else
block|{
switch|switch
condition|(
name|pd
operator|->
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
name|pf_change_a
argument_list|(
operator|&
name|daddr
operator|->
name|v4
operator|.
name|s_addr
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|lan
operator|.
name|addr
operator|.
name|v4
operator|.
name|s_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pd
operator|->
name|hdr
operator|.
name|icmp
operator|->
name|icmp_cksum
operator|=
name|pf_cksum_fixup
argument_list|(
name|pd
operator|->
name|hdr
operator|.
name|icmp
operator|->
name|icmp_cksum
argument_list|,
name|icmpid
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|lan
operator|.
name|port
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pd
operator|->
name|hdr
operator|.
name|icmp
operator|->
name|icmp_id
operator|=
operator|(
operator|*
name|state
operator|)
operator|->
name|lan
operator|.
name|port
expr_stmt|;
name|m_copyback
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
name|ICMP_MINLEN
argument_list|,
operator|(
name|caddr_t
operator|)
name|pd
operator|->
name|hdr
operator|.
name|icmp
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
name|pf_change_a6
argument_list|(
name|daddr
argument_list|,
operator|&
name|pd
operator|->
name|hdr
operator|.
name|icmp6
operator|->
name|icmp6_cksum
argument_list|,
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|lan
operator|.
name|addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|m_copyback
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|icmp6_hdr
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
name|pd
operator|->
name|hdr
operator|.
name|icmp6
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
block|}
block|}
return|return
operator|(
name|PF_PASS
operator|)
return|;
block|}
else|else
block|{
comment|/* 		 * ICMP error message in response to a TCP/UDP packet. 		 * Extract the inner TCP/UDP header and search for that state. 		 */
name|struct
name|pf_pdesc
name|pd2
decl_stmt|;
ifdef|#
directive|ifdef
name|INET
name|struct
name|ip
name|h2
decl_stmt|;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
name|struct
name|ip6_hdr
name|h2_6
decl_stmt|;
name|int
name|terminal
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
comment|/* INET6 */
name|int
name|ipoff2
init|=
literal|0
decl_stmt|;
comment|/* make the compiler happy */
name|int
name|off2
init|=
literal|0
decl_stmt|;
comment|/* make the compiler happy */
name|pd2
operator|.
name|af
operator|=
name|pd
operator|->
name|af
expr_stmt|;
switch|switch
condition|(
name|pd
operator|->
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
comment|/* offset of h2 in mbuf chain */
name|ipoff2
operator|=
name|off
operator|+
name|ICMP_MINLEN
expr_stmt|;
if|if
condition|(
operator|!
name|pf_pull_hdr
argument_list|(
name|m
argument_list|,
name|ipoff2
argument_list|,
operator|&
name|h2
argument_list|,
sizeof|sizeof
argument_list|(
name|h2
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|reason
argument_list|,
name|pd2
operator|.
name|af
argument_list|)
condition|)
block|{
name|DPFPRINTF
argument_list|(
name|PF_DEBUG_MISC
argument_list|,
operator|(
literal|"pf: ICMP error message too short "
literal|"(ip)\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
comment|/* 			 * ICMP error messages don't refer to non-first 			 * fragments 			 */
if|if
condition|(
name|h2
operator|.
name|ip_off
operator|&
name|htons
argument_list|(
name|IP_OFFMASK
argument_list|)
condition|)
block|{
name|REASON_SET
argument_list|(
name|reason
argument_list|,
name|PFRES_FRAG
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
comment|/* offset of protocol header that follows h2 */
name|off2
operator|=
name|ipoff2
operator|+
operator|(
name|h2
operator|.
name|ip_hl
operator|<<
literal|2
operator|)
expr_stmt|;
name|pd2
operator|.
name|proto
operator|=
name|h2
operator|.
name|ip_p
expr_stmt|;
name|pd2
operator|.
name|src
operator|=
operator|(
expr|struct
name|pf_addr
operator|*
operator|)
operator|&
name|h2
operator|.
name|ip_src
expr_stmt|;
name|pd2
operator|.
name|dst
operator|=
operator|(
expr|struct
name|pf_addr
operator|*
operator|)
operator|&
name|h2
operator|.
name|ip_dst
expr_stmt|;
name|pd2
operator|.
name|ip_sum
operator|=
operator|&
name|h2
operator|.
name|ip_sum
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
name|ipoff2
operator|=
name|off
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|icmp6_hdr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pf_pull_hdr
argument_list|(
name|m
argument_list|,
name|ipoff2
argument_list|,
operator|&
name|h2_6
argument_list|,
sizeof|sizeof
argument_list|(
name|h2_6
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|reason
argument_list|,
name|pd2
operator|.
name|af
argument_list|)
condition|)
block|{
name|DPFPRINTF
argument_list|(
name|PF_DEBUG_MISC
argument_list|,
operator|(
literal|"pf: ICMP error message too short "
literal|"(ip6)\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
name|pd2
operator|.
name|proto
operator|=
name|h2_6
operator|.
name|ip6_nxt
expr_stmt|;
name|pd2
operator|.
name|src
operator|=
operator|(
expr|struct
name|pf_addr
operator|*
operator|)
operator|&
name|h2_6
operator|.
name|ip6_src
expr_stmt|;
name|pd2
operator|.
name|dst
operator|=
operator|(
expr|struct
name|pf_addr
operator|*
operator|)
operator|&
name|h2_6
operator|.
name|ip6_dst
expr_stmt|;
name|pd2
operator|.
name|ip_sum
operator|=
name|NULL
expr_stmt|;
name|off2
operator|=
name|ipoff2
operator|+
sizeof|sizeof
argument_list|(
name|h2_6
argument_list|)
expr_stmt|;
do|do
block|{
switch|switch
condition|(
name|pd2
operator|.
name|proto
condition|)
block|{
case|case
name|IPPROTO_FRAGMENT
case|:
comment|/* 					 * ICMPv6 error messages for 					 * non-first fragments 					 */
name|REASON_SET
argument_list|(
name|reason
argument_list|,
name|PFRES_FRAG
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
case|case
name|IPPROTO_AH
case|:
case|case
name|IPPROTO_HOPOPTS
case|:
case|case
name|IPPROTO_ROUTING
case|:
case|case
name|IPPROTO_DSTOPTS
case|:
block|{
comment|/* get next header and header length */
name|struct
name|ip6_ext
name|opt6
decl_stmt|;
if|if
condition|(
operator|!
name|pf_pull_hdr
argument_list|(
name|m
argument_list|,
name|off2
argument_list|,
operator|&
name|opt6
argument_list|,
sizeof|sizeof
argument_list|(
name|opt6
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|reason
argument_list|,
name|pd2
operator|.
name|af
argument_list|)
condition|)
block|{
name|DPFPRINTF
argument_list|(
name|PF_DEBUG_MISC
argument_list|,
operator|(
literal|"pf: ICMPv6 short opt\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
if|if
condition|(
name|pd2
operator|.
name|proto
operator|==
name|IPPROTO_AH
condition|)
name|off2
operator|+=
operator|(
name|opt6
operator|.
name|ip6e_len
operator|+
literal|2
operator|)
operator|*
literal|4
expr_stmt|;
else|else
name|off2
operator|+=
operator|(
name|opt6
operator|.
name|ip6e_len
operator|+
literal|1
operator|)
operator|*
literal|8
expr_stmt|;
name|pd2
operator|.
name|proto
operator|=
name|opt6
operator|.
name|ip6e_nxt
expr_stmt|;
comment|/* goto the next header */
break|break;
block|}
default|default:
name|terminal
operator|++
expr_stmt|;
break|break;
block|}
block|}
do|while
condition|(
operator|!
name|terminal
condition|)
do|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
switch|switch
condition|(
name|pd2
operator|.
name|proto
condition|)
block|{
case|case
name|IPPROTO_TCP
case|:
block|{
name|struct
name|tcphdr
name|th
decl_stmt|;
name|u_int32_t
name|seq
decl_stmt|;
name|struct
name|pf_state
name|key
decl_stmt|;
name|struct
name|pf_state_peer
modifier|*
name|src
decl_stmt|,
modifier|*
name|dst
decl_stmt|;
name|u_int8_t
name|dws
decl_stmt|;
name|int
name|copyback
init|=
literal|0
decl_stmt|;
comment|/* 			 * Only the first 8 bytes of the TCP header can be 			 * expected. Don't access any TCP header fields after 			 * th_seq, an ackskew test is not possible. 			 */
if|if
condition|(
operator|!
name|pf_pull_hdr
argument_list|(
name|m
argument_list|,
name|off2
argument_list|,
operator|&
name|th
argument_list|,
literal|8
argument_list|,
name|NULL
argument_list|,
name|reason
argument_list|,
name|pd2
operator|.
name|af
argument_list|)
condition|)
block|{
name|DPFPRINTF
argument_list|(
name|PF_DEBUG_MISC
argument_list|,
operator|(
literal|"pf: ICMP error message too short "
literal|"(tcp)\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
name|key
operator|.
name|af
operator|=
name|pd2
operator|.
name|af
expr_stmt|;
name|key
operator|.
name|proto
operator|=
name|IPPROTO_TCP
expr_stmt|;
if|if
condition|(
name|direction
operator|==
name|PF_IN
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|ext
operator|.
name|addr
argument_list|,
name|pd2
operator|.
name|dst
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|gwy
operator|.
name|addr
argument_list|,
name|pd2
operator|.
name|src
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|key
operator|.
name|ext
operator|.
name|port
operator|=
name|th
operator|.
name|th_dport
expr_stmt|;
name|key
operator|.
name|gwy
operator|.
name|port
operator|=
name|th
operator|.
name|th_sport
expr_stmt|;
block|}
else|else
block|{
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|lan
operator|.
name|addr
argument_list|,
name|pd2
operator|.
name|dst
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|ext
operator|.
name|addr
argument_list|,
name|pd2
operator|.
name|src
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|key
operator|.
name|lan
operator|.
name|port
operator|=
name|th
operator|.
name|th_dport
expr_stmt|;
name|key
operator|.
name|ext
operator|.
name|port
operator|=
name|th
operator|.
name|th_sport
expr_stmt|;
block|}
name|STATE_LOOKUP
argument_list|()
expr_stmt|;
if|if
condition|(
name|direction
operator|==
operator|(
operator|*
name|state
operator|)
operator|->
name|direction
condition|)
block|{
name|src
operator|=
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|dst
expr_stmt|;
name|dst
operator|=
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|src
expr_stmt|;
block|}
else|else
block|{
name|src
operator|=
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|src
expr_stmt|;
name|dst
operator|=
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|dst
expr_stmt|;
block|}
if|if
condition|(
name|src
operator|->
name|wscale
operator|&&
name|dst
operator|->
name|wscale
operator|&&
operator|!
operator|(
name|th
operator|.
name|th_flags
operator|&
name|TH_SYN
operator|)
condition|)
name|dws
operator|=
name|dst
operator|->
name|wscale
operator|&
name|PF_WSCALE_MASK
expr_stmt|;
else|else
name|dws
operator|=
literal|0
expr_stmt|;
comment|/* Demodulate sequence number */
name|seq
operator|=
name|ntohl
argument_list|(
name|th
operator|.
name|th_seq
argument_list|)
operator|-
name|src
operator|->
name|seqdiff
expr_stmt|;
if|if
condition|(
name|src
operator|->
name|seqdiff
condition|)
block|{
name|pf_change_a
argument_list|(
operator|&
name|th
operator|.
name|th_seq
argument_list|,
name|icmpsum
argument_list|,
name|htonl
argument_list|(
name|seq
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|copyback
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|SEQ_GEQ
argument_list|(
name|src
operator|->
name|seqhi
argument_list|,
name|seq
argument_list|)
operator|||
operator|!
name|SEQ_GEQ
argument_list|(
name|seq
argument_list|,
name|src
operator|->
name|seqlo
operator|-
operator|(
name|dst
operator|->
name|max_win
operator|<<
name|dws
operator|)
argument_list|)
condition|)
block|{
if|if
condition|(
name|pf_status
operator|.
name|debug
operator|>=
name|PF_DEBUG_MISC
condition|)
block|{
name|printf
argument_list|(
literal|"pf: BAD ICMP %d:%d "
argument_list|,
name|icmptype
argument_list|,
name|pd
operator|->
name|hdr
operator|.
name|icmp
operator|->
name|icmp_code
argument_list|)
expr_stmt|;
name|pf_print_host
argument_list|(
name|pd
operator|->
name|src
argument_list|,
literal|0
argument_list|,
name|pd
operator|->
name|af
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" -> "
argument_list|)
expr_stmt|;
name|pf_print_host
argument_list|(
name|pd
operator|->
name|dst
argument_list|,
literal|0
argument_list|,
name|pd
operator|->
name|af
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" state: "
argument_list|)
expr_stmt|;
name|pf_print_state
argument_list|(
operator|*
name|state
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" seq=%u\n"
argument_list|,
name|seq
argument_list|)
expr_stmt|;
block|}
name|REASON_SET
argument_list|(
name|reason
argument_list|,
name|PFRES_BADSTATE
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
if|if
condition|(
name|STATE_TRANSLATE
argument_list|(
operator|*
name|state
argument_list|)
condition|)
block|{
if|if
condition|(
name|direction
operator|==
name|PF_IN
condition|)
block|{
name|pf_change_icmp
argument_list|(
name|pd2
operator|.
name|src
argument_list|,
operator|&
name|th
operator|.
name|th_sport
argument_list|,
name|daddr
argument_list|,
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|lan
operator|.
name|addr
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|lan
operator|.
name|port
argument_list|,
name|NULL
argument_list|,
name|pd2
operator|.
name|ip_sum
argument_list|,
name|icmpsum
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
literal|0
argument_list|,
name|pd2
operator|.
name|af
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pf_change_icmp
argument_list|(
name|pd2
operator|.
name|dst
argument_list|,
operator|&
name|th
operator|.
name|th_dport
argument_list|,
name|saddr
argument_list|,
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|gwy
operator|.
name|addr
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|gwy
operator|.
name|port
argument_list|,
name|NULL
argument_list|,
name|pd2
operator|.
name|ip_sum
argument_list|,
name|icmpsum
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
literal|0
argument_list|,
name|pd2
operator|.
name|af
argument_list|)
expr_stmt|;
block|}
name|copyback
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|copyback
condition|)
block|{
switch|switch
condition|(
name|pd2
operator|.
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
name|m_copyback
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
name|ICMP_MINLEN
argument_list|,
operator|(
name|caddr_t
operator|)
name|pd
operator|->
name|hdr
operator|.
name|icmp
argument_list|)
expr_stmt|;
name|m_copyback
argument_list|(
name|m
argument_list|,
name|ipoff2
argument_list|,
sizeof|sizeof
argument_list|(
name|h2
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|h2
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
name|m_copyback
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|icmp6_hdr
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
name|pd
operator|->
name|hdr
operator|.
name|icmp6
argument_list|)
expr_stmt|;
name|m_copyback
argument_list|(
name|m
argument_list|,
name|ipoff2
argument_list|,
sizeof|sizeof
argument_list|(
name|h2_6
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|h2_6
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
name|m_copyback
argument_list|(
name|m
argument_list|,
name|off2
argument_list|,
literal|8
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|th
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|PF_PASS
operator|)
return|;
break|break;
block|}
case|case
name|IPPROTO_UDP
case|:
block|{
name|struct
name|udphdr
name|uh
decl_stmt|;
name|struct
name|pf_state
name|key
decl_stmt|;
if|if
condition|(
operator|!
name|pf_pull_hdr
argument_list|(
name|m
argument_list|,
name|off2
argument_list|,
operator|&
name|uh
argument_list|,
sizeof|sizeof
argument_list|(
name|uh
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|reason
argument_list|,
name|pd2
operator|.
name|af
argument_list|)
condition|)
block|{
name|DPFPRINTF
argument_list|(
name|PF_DEBUG_MISC
argument_list|,
operator|(
literal|"pf: ICMP error message too short "
literal|"(udp)\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
name|key
operator|.
name|af
operator|=
name|pd2
operator|.
name|af
expr_stmt|;
name|key
operator|.
name|proto
operator|=
name|IPPROTO_UDP
expr_stmt|;
if|if
condition|(
name|direction
operator|==
name|PF_IN
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|ext
operator|.
name|addr
argument_list|,
name|pd2
operator|.
name|dst
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|gwy
operator|.
name|addr
argument_list|,
name|pd2
operator|.
name|src
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|key
operator|.
name|ext
operator|.
name|port
operator|=
name|uh
operator|.
name|uh_dport
expr_stmt|;
name|key
operator|.
name|gwy
operator|.
name|port
operator|=
name|uh
operator|.
name|uh_sport
expr_stmt|;
block|}
else|else
block|{
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|lan
operator|.
name|addr
argument_list|,
name|pd2
operator|.
name|dst
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|ext
operator|.
name|addr
argument_list|,
name|pd2
operator|.
name|src
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|key
operator|.
name|lan
operator|.
name|port
operator|=
name|uh
operator|.
name|uh_dport
expr_stmt|;
name|key
operator|.
name|ext
operator|.
name|port
operator|=
name|uh
operator|.
name|uh_sport
expr_stmt|;
block|}
name|STATE_LOOKUP
argument_list|()
expr_stmt|;
if|if
condition|(
name|STATE_TRANSLATE
argument_list|(
operator|*
name|state
argument_list|)
condition|)
block|{
if|if
condition|(
name|direction
operator|==
name|PF_IN
condition|)
block|{
name|pf_change_icmp
argument_list|(
name|pd2
operator|.
name|src
argument_list|,
operator|&
name|uh
operator|.
name|uh_sport
argument_list|,
name|daddr
argument_list|,
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|lan
operator|.
name|addr
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|lan
operator|.
name|port
argument_list|,
operator|&
name|uh
operator|.
name|uh_sum
argument_list|,
name|pd2
operator|.
name|ip_sum
argument_list|,
name|icmpsum
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
literal|1
argument_list|,
name|pd2
operator|.
name|af
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pf_change_icmp
argument_list|(
name|pd2
operator|.
name|dst
argument_list|,
operator|&
name|uh
operator|.
name|uh_dport
argument_list|,
name|saddr
argument_list|,
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|gwy
operator|.
name|addr
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|gwy
operator|.
name|port
argument_list|,
operator|&
name|uh
operator|.
name|uh_sum
argument_list|,
name|pd2
operator|.
name|ip_sum
argument_list|,
name|icmpsum
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
literal|1
argument_list|,
name|pd2
operator|.
name|af
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|pd2
operator|.
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
name|m_copyback
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
name|ICMP_MINLEN
argument_list|,
operator|(
name|caddr_t
operator|)
name|pd
operator|->
name|hdr
operator|.
name|icmp
argument_list|)
expr_stmt|;
name|m_copyback
argument_list|(
name|m
argument_list|,
name|ipoff2
argument_list|,
sizeof|sizeof
argument_list|(
name|h2
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|h2
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
name|m_copyback
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|icmp6_hdr
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
name|pd
operator|->
name|hdr
operator|.
name|icmp6
argument_list|)
expr_stmt|;
name|m_copyback
argument_list|(
name|m
argument_list|,
name|ipoff2
argument_list|,
sizeof|sizeof
argument_list|(
name|h2_6
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|h2_6
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
name|m_copyback
argument_list|(
name|m
argument_list|,
name|off2
argument_list|,
sizeof|sizeof
argument_list|(
name|uh
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|uh
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|PF_PASS
operator|)
return|;
break|break;
block|}
ifdef|#
directive|ifdef
name|INET
case|case
name|IPPROTO_ICMP
case|:
block|{
name|struct
name|icmp
name|iih
decl_stmt|;
name|struct
name|pf_state
name|key
decl_stmt|;
if|if
condition|(
operator|!
name|pf_pull_hdr
argument_list|(
name|m
argument_list|,
name|off2
argument_list|,
operator|&
name|iih
argument_list|,
name|ICMP_MINLEN
argument_list|,
name|NULL
argument_list|,
name|reason
argument_list|,
name|pd2
operator|.
name|af
argument_list|)
condition|)
block|{
name|DPFPRINTF
argument_list|(
name|PF_DEBUG_MISC
argument_list|,
operator|(
literal|"pf: ICMP error message too short i"
literal|"(icmp)\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
name|key
operator|.
name|af
operator|=
name|pd2
operator|.
name|af
expr_stmt|;
name|key
operator|.
name|proto
operator|=
name|IPPROTO_ICMP
expr_stmt|;
if|if
condition|(
name|direction
operator|==
name|PF_IN
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|ext
operator|.
name|addr
argument_list|,
name|pd2
operator|.
name|dst
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|gwy
operator|.
name|addr
argument_list|,
name|pd2
operator|.
name|src
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|key
operator|.
name|ext
operator|.
name|port
operator|=
literal|0
expr_stmt|;
name|key
operator|.
name|gwy
operator|.
name|port
operator|=
name|iih
operator|.
name|icmp_id
expr_stmt|;
block|}
else|else
block|{
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|lan
operator|.
name|addr
argument_list|,
name|pd2
operator|.
name|dst
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|ext
operator|.
name|addr
argument_list|,
name|pd2
operator|.
name|src
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|key
operator|.
name|lan
operator|.
name|port
operator|=
name|iih
operator|.
name|icmp_id
expr_stmt|;
name|key
operator|.
name|ext
operator|.
name|port
operator|=
literal|0
expr_stmt|;
block|}
name|STATE_LOOKUP
argument_list|()
expr_stmt|;
if|if
condition|(
name|STATE_TRANSLATE
argument_list|(
operator|*
name|state
argument_list|)
condition|)
block|{
if|if
condition|(
name|direction
operator|==
name|PF_IN
condition|)
block|{
name|pf_change_icmp
argument_list|(
name|pd2
operator|.
name|src
argument_list|,
operator|&
name|iih
operator|.
name|icmp_id
argument_list|,
name|daddr
argument_list|,
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|lan
operator|.
name|addr
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|lan
operator|.
name|port
argument_list|,
name|NULL
argument_list|,
name|pd2
operator|.
name|ip_sum
argument_list|,
name|icmpsum
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
literal|0
argument_list|,
name|AF_INET
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pf_change_icmp
argument_list|(
name|pd2
operator|.
name|dst
argument_list|,
operator|&
name|iih
operator|.
name|icmp_id
argument_list|,
name|saddr
argument_list|,
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|gwy
operator|.
name|addr
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|gwy
operator|.
name|port
argument_list|,
name|NULL
argument_list|,
name|pd2
operator|.
name|ip_sum
argument_list|,
name|icmpsum
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
literal|0
argument_list|,
name|AF_INET
argument_list|)
expr_stmt|;
block|}
name|m_copyback
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
name|ICMP_MINLEN
argument_list|,
operator|(
name|caddr_t
operator|)
name|pd
operator|->
name|hdr
operator|.
name|icmp
argument_list|)
expr_stmt|;
name|m_copyback
argument_list|(
name|m
argument_list|,
name|ipoff2
argument_list|,
sizeof|sizeof
argument_list|(
name|h2
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|h2
argument_list|)
expr_stmt|;
name|m_copyback
argument_list|(
name|m
argument_list|,
name|off2
argument_list|,
name|ICMP_MINLEN
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|iih
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|PF_PASS
operator|)
return|;
break|break;
block|}
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|IPPROTO_ICMPV6
case|:
block|{
name|struct
name|icmp6_hdr
name|iih
decl_stmt|;
name|struct
name|pf_state
name|key
decl_stmt|;
if|if
condition|(
operator|!
name|pf_pull_hdr
argument_list|(
name|m
argument_list|,
name|off2
argument_list|,
operator|&
name|iih
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|icmp6_hdr
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|reason
argument_list|,
name|pd2
operator|.
name|af
argument_list|)
condition|)
block|{
name|DPFPRINTF
argument_list|(
name|PF_DEBUG_MISC
argument_list|,
operator|(
literal|"pf: ICMP error message too short "
literal|"(icmp6)\n"
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
name|key
operator|.
name|af
operator|=
name|pd2
operator|.
name|af
expr_stmt|;
name|key
operator|.
name|proto
operator|=
name|IPPROTO_ICMPV6
expr_stmt|;
if|if
condition|(
name|direction
operator|==
name|PF_IN
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|ext
operator|.
name|addr
argument_list|,
name|pd2
operator|.
name|dst
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|gwy
operator|.
name|addr
argument_list|,
name|pd2
operator|.
name|src
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|key
operator|.
name|ext
operator|.
name|port
operator|=
literal|0
expr_stmt|;
name|key
operator|.
name|gwy
operator|.
name|port
operator|=
name|iih
operator|.
name|icmp6_id
expr_stmt|;
block|}
else|else
block|{
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|lan
operator|.
name|addr
argument_list|,
name|pd2
operator|.
name|dst
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|ext
operator|.
name|addr
argument_list|,
name|pd2
operator|.
name|src
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|key
operator|.
name|lan
operator|.
name|port
operator|=
name|iih
operator|.
name|icmp6_id
expr_stmt|;
name|key
operator|.
name|ext
operator|.
name|port
operator|=
literal|0
expr_stmt|;
block|}
name|STATE_LOOKUP
argument_list|()
expr_stmt|;
if|if
condition|(
name|STATE_TRANSLATE
argument_list|(
operator|*
name|state
argument_list|)
condition|)
block|{
if|if
condition|(
name|direction
operator|==
name|PF_IN
condition|)
block|{
name|pf_change_icmp
argument_list|(
name|pd2
operator|.
name|src
argument_list|,
operator|&
name|iih
operator|.
name|icmp6_id
argument_list|,
name|daddr
argument_list|,
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|lan
operator|.
name|addr
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|lan
operator|.
name|port
argument_list|,
name|NULL
argument_list|,
name|pd2
operator|.
name|ip_sum
argument_list|,
name|icmpsum
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
literal|0
argument_list|,
name|AF_INET6
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pf_change_icmp
argument_list|(
name|pd2
operator|.
name|dst
argument_list|,
operator|&
name|iih
operator|.
name|icmp6_id
argument_list|,
name|saddr
argument_list|,
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|gwy
operator|.
name|addr
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|gwy
operator|.
name|port
argument_list|,
name|NULL
argument_list|,
name|pd2
operator|.
name|ip_sum
argument_list|,
name|icmpsum
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
literal|0
argument_list|,
name|AF_INET6
argument_list|)
expr_stmt|;
block|}
name|m_copyback
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|icmp6_hdr
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
name|pd
operator|->
name|hdr
operator|.
name|icmp6
argument_list|)
expr_stmt|;
name|m_copyback
argument_list|(
name|m
argument_list|,
name|ipoff2
argument_list|,
sizeof|sizeof
argument_list|(
name|h2_6
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|h2_6
argument_list|)
expr_stmt|;
name|m_copyback
argument_list|(
name|m
argument_list|,
name|off2
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|icmp6_hdr
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|iih
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|PF_PASS
operator|)
return|;
break|break;
block|}
endif|#
directive|endif
comment|/* INET6 */
default|default:
block|{
name|struct
name|pf_state
name|key
decl_stmt|;
name|key
operator|.
name|af
operator|=
name|pd2
operator|.
name|af
expr_stmt|;
name|key
operator|.
name|proto
operator|=
name|pd2
operator|.
name|proto
expr_stmt|;
if|if
condition|(
name|direction
operator|==
name|PF_IN
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|ext
operator|.
name|addr
argument_list|,
name|pd2
operator|.
name|dst
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|gwy
operator|.
name|addr
argument_list|,
name|pd2
operator|.
name|src
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|key
operator|.
name|ext
operator|.
name|port
operator|=
literal|0
expr_stmt|;
name|key
operator|.
name|gwy
operator|.
name|port
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|lan
operator|.
name|addr
argument_list|,
name|pd2
operator|.
name|dst
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|ext
operator|.
name|addr
argument_list|,
name|pd2
operator|.
name|src
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|key
operator|.
name|lan
operator|.
name|port
operator|=
literal|0
expr_stmt|;
name|key
operator|.
name|ext
operator|.
name|port
operator|=
literal|0
expr_stmt|;
block|}
name|STATE_LOOKUP
argument_list|()
expr_stmt|;
if|if
condition|(
name|STATE_TRANSLATE
argument_list|(
operator|*
name|state
argument_list|)
condition|)
block|{
if|if
condition|(
name|direction
operator|==
name|PF_IN
condition|)
block|{
name|pf_change_icmp
argument_list|(
name|pd2
operator|.
name|src
argument_list|,
name|NULL
argument_list|,
name|daddr
argument_list|,
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|lan
operator|.
name|addr
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|pd2
operator|.
name|ip_sum
argument_list|,
name|icmpsum
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
literal|0
argument_list|,
name|pd2
operator|.
name|af
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pf_change_icmp
argument_list|(
name|pd2
operator|.
name|dst
argument_list|,
name|NULL
argument_list|,
name|saddr
argument_list|,
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|gwy
operator|.
name|addr
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|pd2
operator|.
name|ip_sum
argument_list|,
name|icmpsum
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
literal|0
argument_list|,
name|pd2
operator|.
name|af
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|pd2
operator|.
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
name|m_copyback
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
name|ICMP_MINLEN
argument_list|,
operator|(
name|caddr_t
operator|)
name|pd
operator|->
name|hdr
operator|.
name|icmp
argument_list|)
expr_stmt|;
name|m_copyback
argument_list|(
name|m
argument_list|,
name|ipoff2
argument_list|,
sizeof|sizeof
argument_list|(
name|h2
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|h2
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
name|m_copyback
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|icmp6_hdr
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
name|pd
operator|->
name|hdr
operator|.
name|icmp6
argument_list|)
expr_stmt|;
name|m_copyback
argument_list|(
name|m
argument_list|,
name|ipoff2
argument_list|,
sizeof|sizeof
argument_list|(
name|h2_6
argument_list|)
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|h2_6
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
block|}
return|return
operator|(
name|PF_PASS
operator|)
return|;
break|break;
block|}
block|}
block|}
block|}
end_function

begin_function
name|int
name|pf_test_state_other
parameter_list|(
name|struct
name|pf_state
modifier|*
modifier|*
name|state
parameter_list|,
name|int
name|direction
parameter_list|,
name|struct
name|pfi_kif
modifier|*
name|kif
parameter_list|,
name|struct
name|pf_pdesc
modifier|*
name|pd
parameter_list|)
block|{
name|struct
name|pf_state_peer
modifier|*
name|src
decl_stmt|,
modifier|*
name|dst
decl_stmt|;
name|struct
name|pf_state
name|key
decl_stmt|;
name|key
operator|.
name|af
operator|=
name|pd
operator|->
name|af
expr_stmt|;
name|key
operator|.
name|proto
operator|=
name|pd
operator|->
name|proto
expr_stmt|;
if|if
condition|(
name|direction
operator|==
name|PF_IN
condition|)
block|{
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|ext
operator|.
name|addr
argument_list|,
name|pd
operator|->
name|src
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|gwy
operator|.
name|addr
argument_list|,
name|pd
operator|->
name|dst
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|key
operator|.
name|ext
operator|.
name|port
operator|=
literal|0
expr_stmt|;
name|key
operator|.
name|gwy
operator|.
name|port
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|lan
operator|.
name|addr
argument_list|,
name|pd
operator|->
name|src
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|key
operator|.
name|ext
operator|.
name|addr
argument_list|,
name|pd
operator|->
name|dst
argument_list|,
name|key
operator|.
name|af
argument_list|)
expr_stmt|;
name|key
operator|.
name|lan
operator|.
name|port
operator|=
literal|0
expr_stmt|;
name|key
operator|.
name|ext
operator|.
name|port
operator|=
literal|0
expr_stmt|;
block|}
name|STATE_LOOKUP
argument_list|()
expr_stmt|;
if|if
condition|(
name|direction
operator|==
operator|(
operator|*
name|state
operator|)
operator|->
name|direction
condition|)
block|{
name|src
operator|=
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|src
expr_stmt|;
name|dst
operator|=
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|dst
expr_stmt|;
block|}
else|else
block|{
name|src
operator|=
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|dst
expr_stmt|;
name|dst
operator|=
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|src
expr_stmt|;
block|}
comment|/* update states */
if|if
condition|(
name|src
operator|->
name|state
operator|<
name|PFOTHERS_SINGLE
condition|)
name|src
operator|->
name|state
operator|=
name|PFOTHERS_SINGLE
expr_stmt|;
if|if
condition|(
name|dst
operator|->
name|state
operator|==
name|PFOTHERS_SINGLE
condition|)
name|dst
operator|->
name|state
operator|=
name|PFOTHERS_MULTIPLE
expr_stmt|;
comment|/* update expire time */
operator|(
operator|*
name|state
operator|)
operator|->
name|expire
operator|=
name|time_second
expr_stmt|;
if|if
condition|(
name|src
operator|->
name|state
operator|==
name|PFOTHERS_MULTIPLE
operator|&&
name|dst
operator|->
name|state
operator|==
name|PFOTHERS_MULTIPLE
condition|)
operator|(
operator|*
name|state
operator|)
operator|->
name|timeout
operator|=
name|PFTM_OTHER_MULTIPLE
expr_stmt|;
else|else
operator|(
operator|*
name|state
operator|)
operator|->
name|timeout
operator|=
name|PFTM_OTHER_SINGLE
expr_stmt|;
comment|/* translate source/destination address, if necessary */
if|if
condition|(
name|STATE_TRANSLATE
argument_list|(
operator|*
name|state
argument_list|)
condition|)
block|{
if|if
condition|(
name|direction
operator|==
name|PF_OUT
condition|)
switch|switch
condition|(
name|pd
operator|->
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
name|pf_change_a
argument_list|(
operator|&
name|pd
operator|->
name|src
operator|->
name|v4
operator|.
name|s_addr
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|gwy
operator|.
name|addr
operator|.
name|v4
operator|.
name|s_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
name|PF_ACPY
argument_list|(
name|pd
operator|->
name|src
argument_list|,
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|gwy
operator|.
name|addr
argument_list|,
name|pd
operator|->
name|af
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
else|else
switch|switch
condition|(
name|pd
operator|->
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
name|pf_change_a
argument_list|(
operator|&
name|pd
operator|->
name|dst
operator|->
name|v4
operator|.
name|s_addr
argument_list|,
name|pd
operator|->
name|ip_sum
argument_list|,
operator|(
operator|*
name|state
operator|)
operator|->
name|lan
operator|.
name|addr
operator|.
name|v4
operator|.
name|s_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
name|PF_ACPY
argument_list|(
name|pd
operator|->
name|dst
argument_list|,
operator|&
operator|(
operator|*
name|state
operator|)
operator|->
name|lan
operator|.
name|addr
argument_list|,
name|pd
operator|->
name|af
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
block|}
return|return
operator|(
name|PF_PASS
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * ipoff and off are measured from the start of the mbuf chain.  * h must be at "ipoff" on the mbuf chain.  */
end_comment

begin_function
name|void
modifier|*
name|pf_pull_hdr
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|int
name|off
parameter_list|,
name|void
modifier|*
name|p
parameter_list|,
name|int
name|len
parameter_list|,
name|u_short
modifier|*
name|actionp
parameter_list|,
name|u_short
modifier|*
name|reasonp
parameter_list|,
name|sa_family_t
name|af
parameter_list|)
block|{
switch|switch
condition|(
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
block|{
name|struct
name|ip
modifier|*
name|h
init|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ip
operator|*
argument_list|)
decl_stmt|;
name|u_int16_t
name|fragoff
init|=
operator|(
name|ntohs
argument_list|(
name|h
operator|->
name|ip_off
argument_list|)
operator|&
name|IP_OFFMASK
operator|)
operator|<<
literal|3
decl_stmt|;
if|if
condition|(
name|fragoff
condition|)
block|{
if|if
condition|(
name|fragoff
operator|>=
name|len
condition|)
name|ACTION_SET
argument_list|(
name|actionp
argument_list|,
name|PF_PASS
argument_list|)
expr_stmt|;
else|else
block|{
name|ACTION_SET
argument_list|(
name|actionp
argument_list|,
name|PF_DROP
argument_list|)
expr_stmt|;
name|REASON_SET
argument_list|(
name|reasonp
argument_list|,
name|PFRES_FRAG
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|<
name|off
operator|+
name|len
operator|||
name|ntohs
argument_list|(
name|h
operator|->
name|ip_len
argument_list|)
operator|<
name|off
operator|+
name|len
condition|)
block|{
name|ACTION_SET
argument_list|(
name|actionp
argument_list|,
name|PF_DROP
argument_list|)
expr_stmt|;
name|REASON_SET
argument_list|(
name|reasonp
argument_list|,
name|PFRES_SHORT
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
break|break;
block|}
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
block|{
name|struct
name|ip6_hdr
modifier|*
name|h
init|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ip6_hdr
operator|*
argument_list|)
decl_stmt|;
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|<
name|off
operator|+
name|len
operator|||
operator|(
name|ntohs
argument_list|(
name|h
operator|->
name|ip6_plen
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
operator|)
operator|<
call|(
name|unsigned
call|)
argument_list|(
name|off
operator|+
name|len
argument_list|)
condition|)
block|{
name|ACTION_SET
argument_list|(
name|actionp
argument_list|,
name|PF_DROP
argument_list|)
expr_stmt|;
name|REASON_SET
argument_list|(
name|reasonp
argument_list|,
name|PFRES_SHORT
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
break|break;
block|}
endif|#
directive|endif
comment|/* INET6 */
block|}
name|m_copydata
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
name|len
argument_list|,
name|p
argument_list|)
expr_stmt|;
return|return
operator|(
name|p
operator|)
return|;
block|}
end_function

begin_function
name|int
name|pf_routable
parameter_list|(
name|struct
name|pf_addr
modifier|*
name|addr
parameter_list|,
name|sa_family_t
name|af
parameter_list|)
block|{
name|struct
name|sockaddr_in
modifier|*
name|dst
decl_stmt|;
ifdef|#
directive|ifdef
name|INET6
name|struct
name|sockaddr_in6
modifier|*
name|dst6
decl_stmt|;
name|struct
name|route_in6
name|ro
decl_stmt|;
else|#
directive|else
name|struct
name|route
name|ro
decl_stmt|;
endif|#
directive|endif
name|bzero
argument_list|(
operator|&
name|ro
argument_list|,
sizeof|sizeof
argument_list|(
name|ro
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|af
condition|)
block|{
case|case
name|AF_INET
case|:
name|dst
operator|=
name|satosin
argument_list|(
operator|&
name|ro
operator|.
name|ro_dst
argument_list|)
expr_stmt|;
name|dst
operator|->
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|dst
operator|->
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|dst
argument_list|)
expr_stmt|;
name|dst
operator|->
name|sin_addr
operator|=
name|addr
operator|->
name|v4
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
name|dst6
operator|=
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
operator|&
name|ro
operator|.
name|ro_dst
expr_stmt|;
name|dst6
operator|->
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|dst6
operator|->
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|dst6
argument_list|)
expr_stmt|;
name|dst6
operator|->
name|sin6_addr
operator|=
name|addr
operator|->
name|v6
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
default|default:
return|return
operator|(
literal|0
operator|)
return|;
block|}
ifdef|#
directive|ifdef
name|__FreeBSD__
ifdef|#
directive|ifdef
name|RTF_PRCLONING
name|rtalloc_ign
argument_list|(
operator|(
expr|struct
name|route
operator|*
operator|)
operator|&
name|ro
argument_list|,
operator|(
name|RTF_CLONING
operator||
name|RTF_PRCLONING
operator|)
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* !RTF_PRCLONING */
name|rtalloc_ign
argument_list|(
operator|(
expr|struct
name|route
operator|*
operator|)
operator|&
name|ro
argument_list|,
name|RTF_CLONING
argument_list|)
expr_stmt|;
endif|#
directive|endif
else|#
directive|else
comment|/* ! __FreeBSD__ */
name|rtalloc_noclone
argument_list|(
operator|(
expr|struct
name|route
operator|*
operator|)
operator|&
name|ro
argument_list|,
name|NO_CLONING
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ro
operator|.
name|ro_rt
operator|!=
name|NULL
condition|)
block|{
name|RTFREE
argument_list|(
name|ro
operator|.
name|ro_rt
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|pf_rtlabel_match
parameter_list|(
name|struct
name|pf_addr
modifier|*
name|addr
parameter_list|,
name|sa_family_t
name|af
parameter_list|,
name|struct
name|pf_addr_wrap
modifier|*
name|aw
parameter_list|)
block|{
name|struct
name|sockaddr_in
modifier|*
name|dst
decl_stmt|;
ifdef|#
directive|ifdef
name|INET6
name|struct
name|sockaddr_in6
modifier|*
name|dst6
decl_stmt|;
name|struct
name|route_in6
name|ro
decl_stmt|;
else|#
directive|else
name|struct
name|route
name|ro
decl_stmt|;
endif|#
directive|endif
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|ro
argument_list|,
sizeof|sizeof
argument_list|(
name|ro
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|af
condition|)
block|{
case|case
name|AF_INET
case|:
name|dst
operator|=
name|satosin
argument_list|(
operator|&
name|ro
operator|.
name|ro_dst
argument_list|)
expr_stmt|;
name|dst
operator|->
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|dst
operator|->
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|dst
argument_list|)
expr_stmt|;
name|dst
operator|->
name|sin_addr
operator|=
name|addr
operator|->
name|v4
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
name|dst6
operator|=
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
operator|&
name|ro
operator|.
name|ro_dst
expr_stmt|;
name|dst6
operator|->
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|dst6
operator|->
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|dst6
argument_list|)
expr_stmt|;
name|dst6
operator|->
name|sin6_addr
operator|=
name|addr
operator|->
name|v6
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
default|default:
return|return
operator|(
literal|0
operator|)
return|;
block|}
ifdef|#
directive|ifdef
name|__FreeBSD__
ifdef|#
directive|ifdef
name|RTF_PRCLONING
name|rtalloc_ign
argument_list|(
operator|(
expr|struct
name|route
operator|*
operator|)
operator|&
name|ro
argument_list|,
operator|(
name|RTF_CLONING
operator||
name|RTF_PRCLONING
operator|)
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* !RTF_PRCLONING */
name|rtalloc_ign
argument_list|(
operator|(
expr|struct
name|route
operator|*
operator|)
operator|&
name|ro
argument_list|,
name|RTF_CLONING
argument_list|)
expr_stmt|;
endif|#
directive|endif
else|#
directive|else
comment|/* ! __FreeBSD__ */
name|rtalloc_noclone
argument_list|(
operator|(
expr|struct
name|route
operator|*
operator|)
operator|&
name|ro
argument_list|,
name|NO_CLONING
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ro
operator|.
name|ro_rt
operator|!=
name|NULL
condition|)
block|{
ifdef|#
directive|ifdef
name|__FreeBSD__
comment|/* XXX_IMPORT: later */
else|#
directive|else
if|if
condition|(
name|ro
operator|.
name|ro_rt
operator|->
name|rt_labelid
operator|==
name|aw
operator|->
name|v
operator|.
name|rtlabel
condition|)
name|ret
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
name|RTFREE
argument_list|(
name|ro
operator|.
name|ro_rt
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|INET
end_ifdef

begin_function
name|void
name|pf_route
parameter_list|(
name|struct
name|mbuf
modifier|*
modifier|*
name|m
parameter_list|,
name|struct
name|pf_rule
modifier|*
name|r
parameter_list|,
name|int
name|dir
parameter_list|,
name|struct
name|ifnet
modifier|*
name|oifp
parameter_list|,
name|struct
name|pf_state
modifier|*
name|s
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|m0
decl_stmt|,
modifier|*
name|m1
decl_stmt|;
name|struct
name|m_tag
modifier|*
name|mtag
decl_stmt|;
name|struct
name|route
name|iproute
decl_stmt|;
name|struct
name|route
modifier|*
name|ro
init|=
name|NULL
decl_stmt|;
comment|/* XXX: was uninitialized */
name|struct
name|sockaddr_in
modifier|*
name|dst
decl_stmt|;
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_addr
name|naddr
decl_stmt|;
name|struct
name|pf_src_node
modifier|*
name|sn
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
name|int
name|sw_csum
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
name|m
operator|==
name|NULL
operator|||
operator|*
name|m
operator|==
name|NULL
operator|||
name|r
operator|==
name|NULL
operator|||
operator|(
name|dir
operator|!=
name|PF_IN
operator|&&
name|dir
operator|!=
name|PF_OUT
operator|)
operator|||
name|oifp
operator|==
name|NULL
condition|)
name|panic
argument_list|(
literal|"pf_route: invalid parameters"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|mtag
operator|=
name|m_tag_find
argument_list|(
operator|*
name|m
argument_list|,
name|PACKET_TAG_PF_ROUTED
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|mtag
operator|=
name|m_tag_get
argument_list|(
name|PACKET_TAG_PF_ROUTED
argument_list|,
literal|1
argument_list|,
name|M_NOWAIT
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|m0
operator|=
operator|*
name|m
expr_stmt|;
operator|*
name|m
operator|=
name|NULL
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
operator|*
operator|(
name|char
operator|*
operator|)
operator|(
name|mtag
operator|+
literal|1
operator|)
operator|=
literal|1
expr_stmt|;
name|m_tag_prepend
argument_list|(
operator|*
name|m
argument_list|,
name|mtag
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|*
operator|(
name|char
operator|*
operator|)
operator|(
name|mtag
operator|+
literal|1
operator|)
operator|>
literal|3
condition|)
block|{
name|m0
operator|=
operator|*
name|m
expr_stmt|;
operator|*
name|m
operator|=
name|NULL
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
operator|(
operator|*
operator|(
name|char
operator|*
operator|)
operator|(
name|mtag
operator|+
literal|1
operator|)
operator|)
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|->
name|rt
operator|==
name|PF_DUPTO
condition|)
block|{
ifdef|#
directive|ifdef
name|__FreeBSD__
if|if
condition|(
operator|(
name|m0
operator|=
name|m_dup
argument_list|(
operator|*
name|m
argument_list|,
name|M_DONTWAIT
argument_list|)
operator|)
operator|==
name|NULL
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|m0
operator|=
name|m_copym2
argument_list|(
operator|*
name|m
argument_list|,
literal|0
argument_list|,
name|M_COPYALL
argument_list|,
name|M_NOWAIT
argument_list|)
operator|)
operator|==
name|NULL
condition|)
endif|#
directive|endif
return|return;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|r
operator|->
name|rt
operator|==
name|PF_REPLYTO
operator|)
operator|==
operator|(
name|r
operator|->
name|direction
operator|==
name|dir
operator|)
condition|)
return|return;
name|m0
operator|=
operator|*
name|m
expr_stmt|;
block|}
if|if
condition|(
name|m0
operator|->
name|m_len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
condition|)
block|{
name|DPFPRINTF
argument_list|(
name|PF_DEBUG_URGENT
argument_list|,
operator|(
literal|"pf_route: m0->m_len< sizeof(struct ip)\n"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|ip
operator|=
name|mtod
argument_list|(
name|m0
argument_list|,
expr|struct
name|ip
operator|*
argument_list|)
expr_stmt|;
name|ro
operator|=
operator|&
name|iproute
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|caddr_t
operator|)
name|ro
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ro
argument_list|)
argument_list|)
expr_stmt|;
name|dst
operator|=
name|satosin
argument_list|(
operator|&
name|ro
operator|->
name|ro_dst
argument_list|)
expr_stmt|;
name|dst
operator|->
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|dst
operator|->
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|dst
argument_list|)
expr_stmt|;
name|dst
operator|->
name|sin_addr
operator|=
name|ip
operator|->
name|ip_dst
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|rt
operator|==
name|PF_FASTROUTE
condition|)
block|{
name|rtalloc
argument_list|(
name|ro
argument_list|)
expr_stmt|;
if|if
condition|(
name|ro
operator|->
name|ro_rt
operator|==
literal|0
condition|)
block|{
name|ipstat
operator|.
name|ips_noroute
operator|++
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|ifp
operator|=
name|ro
operator|->
name|ro_rt
operator|->
name|rt_ifp
expr_stmt|;
name|ro
operator|->
name|ro_rt
operator|->
name|rt_use
operator|++
expr_stmt|;
if|if
condition|(
name|ro
operator|->
name|ro_rt
operator|->
name|rt_flags
operator|&
name|RTF_GATEWAY
condition|)
name|dst
operator|=
name|satosin
argument_list|(
name|ro
operator|->
name|ro_rt
operator|->
name|rt_gateway
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|TAILQ_EMPTY
argument_list|(
operator|&
name|r
operator|->
name|rpool
operator|.
name|list
argument_list|)
condition|)
block|{
name|DPFPRINTF
argument_list|(
name|PF_DEBUG_URGENT
argument_list|,
operator|(
literal|"pf_route: TAILQ_EMPTY(&r->rpool.list)\n"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
name|pf_map_addr
argument_list|(
name|AF_INET
argument_list|,
name|r
argument_list|,
operator|(
expr|struct
name|pf_addr
operator|*
operator|)
operator|&
name|ip
operator|->
name|ip_src
argument_list|,
operator|&
name|naddr
argument_list|,
name|NULL
argument_list|,
operator|&
name|sn
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|PF_AZERO
argument_list|(
operator|&
name|naddr
argument_list|,
name|AF_INET
argument_list|)
condition|)
name|dst
operator|->
name|sin_addr
operator|.
name|s_addr
operator|=
name|naddr
operator|.
name|v4
operator|.
name|s_addr
expr_stmt|;
name|ifp
operator|=
name|r
operator|->
name|rpool
operator|.
name|cur
operator|->
name|kif
condition|?
name|r
operator|->
name|rpool
operator|.
name|cur
operator|->
name|kif
operator|->
name|pfik_ifp
else|:
name|NULL
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|PF_AZERO
argument_list|(
operator|&
name|s
operator|->
name|rt_addr
argument_list|,
name|AF_INET
argument_list|)
condition|)
name|dst
operator|->
name|sin_addr
operator|.
name|s_addr
operator|=
name|s
operator|->
name|rt_addr
operator|.
name|v4
operator|.
name|s_addr
expr_stmt|;
name|ifp
operator|=
name|s
operator|->
name|rt_kif
condition|?
name|s
operator|->
name|rt_kif
operator|->
name|pfik_ifp
else|:
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
goto|goto
name|bad
goto|;
if|if
condition|(
name|oifp
operator|!=
name|ifp
condition|)
block|{
ifdef|#
directive|ifdef
name|__FreeBSD__
name|PF_UNLOCK
argument_list|()
expr_stmt|;
if|if
condition|(
name|pf_test
argument_list|(
name|PF_OUT
argument_list|,
name|ifp
argument_list|,
operator|&
name|m0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
name|PF_PASS
condition|)
block|{
name|PF_LOCK
argument_list|()
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
elseif|else
if|if
condition|(
name|m0
operator|==
name|NULL
condition|)
block|{
name|PF_LOCK
argument_list|()
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|PF_LOCK
argument_list|()
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|pf_test
argument_list|(
name|PF_OUT
argument_list|,
name|ifp
argument_list|,
operator|&
name|m0
argument_list|,
name|NULL
argument_list|)
operator|!=
name|PF_PASS
condition|)
goto|goto
name|bad
goto|;
elseif|else
if|if
condition|(
name|m0
operator|==
name|NULL
condition|)
goto|goto
name|done
goto|;
endif|#
directive|endif
if|if
condition|(
name|m0
operator|->
name|m_len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
condition|)
block|{
name|DPFPRINTF
argument_list|(
name|PF_DEBUG_URGENT
argument_list|,
operator|(
literal|"pf_route: m0->m_len< sizeof(struct ip)\n"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|ip
operator|=
name|mtod
argument_list|(
name|m0
argument_list|,
expr|struct
name|ip
operator|*
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|__FreeBSD__
comment|/* Copied from FreeBSD 5.1-CURRENT ip_output. */
name|m0
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator||=
name|CSUM_IP
expr_stmt|;
name|sw_csum
operator|=
name|m0
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
operator|~
name|ifp
operator|->
name|if_hwassist
expr_stmt|;
if|if
condition|(
name|sw_csum
operator|&
name|CSUM_DELAY_DATA
condition|)
block|{
comment|/* 		 * XXX: in_delayed_cksum assumes HBO for ip->ip_len (at least) 		 */
name|NTOHS
argument_list|(
name|ip
operator|->
name|ip_len
argument_list|)
expr_stmt|;
name|NTOHS
argument_list|(
name|ip
operator|->
name|ip_off
argument_list|)
expr_stmt|;
comment|/* XXX: needed? */
name|in_delayed_cksum
argument_list|(
name|m0
argument_list|)
expr_stmt|;
name|HTONS
argument_list|(
name|ip
operator|->
name|ip_len
argument_list|)
expr_stmt|;
name|HTONS
argument_list|(
name|ip
operator|->
name|ip_off
argument_list|)
expr_stmt|;
name|sw_csum
operator|&=
operator|~
name|CSUM_DELAY_DATA
expr_stmt|;
block|}
name|m0
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&=
name|ifp
operator|->
name|if_hwassist
expr_stmt|;
if|if
condition|(
name|ntohs
argument_list|(
name|ip
operator|->
name|ip_len
argument_list|)
operator|<=
name|ifp
operator|->
name|if_mtu
operator|||
operator|(
name|ifp
operator|->
name|if_hwassist
operator|&
name|CSUM_FRAGMENT
operator|&&
operator|(
operator|(
name|ip
operator|->
name|ip_off
operator|&
name|htons
argument_list|(
name|IP_DF
argument_list|)
operator|)
operator|==
literal|0
operator|)
operator|)
condition|)
block|{
comment|/* 		 * ip->ip_len = htons(ip->ip_len); 		 * ip->ip_off = htons(ip->ip_off); 		 */
name|ip
operator|->
name|ip_sum
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sw_csum
operator|&
name|CSUM_DELAY_IP
condition|)
block|{
comment|/* From KAME */
if|if
condition|(
name|ip
operator|->
name|ip_v
operator|==
name|IPVERSION
operator|&&
operator|(
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
operator|)
operator|==
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
condition|)
block|{
name|ip
operator|->
name|ip_sum
operator|=
name|in_cksum_hdr
argument_list|(
name|ip
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ip
operator|->
name|ip_sum
operator|=
name|in_cksum
argument_list|(
name|m0
argument_list|,
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
name|PF_UNLOCK
argument_list|()
expr_stmt|;
name|error
operator|=
call|(
modifier|*
name|ifp
operator|->
name|if_output
call|)
argument_list|(
name|ifp
argument_list|,
name|m0
argument_list|,
name|sintosa
argument_list|(
name|dst
argument_list|)
argument_list|,
name|ro
operator|->
name|ro_rt
argument_list|)
expr_stmt|;
name|PF_LOCK
argument_list|()
expr_stmt|;
goto|goto
name|done
goto|;
block|}
else|#
directive|else
comment|/* Copied from ip_output. */
ifdef|#
directive|ifdef
name|IPSEC
comment|/* 	 * If deferred crypto processing is needed, check that the 	 * interface supports it. 	 */
if|if
condition|(
operator|(
name|mtag
operator|=
name|m_tag_find
argument_list|(
name|m0
argument_list|,
name|PACKET_TAG_IPSEC_OUT_CRYPTO_NEEDED
argument_list|,
name|NULL
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
operator|(
name|ifp
operator|->
name|if_capabilities
operator|&
name|IFCAP_IPSEC
operator|)
operator|==
literal|0
condition|)
block|{
comment|/* Notify IPsec to do its own crypto. */
name|ipsp_skipcrypto_unmark
argument_list|(
operator|(
expr|struct
name|tdb_ident
operator|*
operator|)
operator|(
name|mtag
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
endif|#
directive|endif
comment|/* IPSEC */
comment|/* Catch routing changes wrt. hardware checksumming for TCP or UDP. */
if|if
condition|(
name|m0
operator|->
name|m_pkthdr
operator|.
name|csum
operator|&
name|M_TCPV4_CSUM_OUT
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_capabilities
operator|&
name|IFCAP_CSUM_TCPv4
operator|)
operator|||
name|ifp
operator|->
name|if_bridge
operator|!=
name|NULL
condition|)
block|{
name|in_delayed_cksum
argument_list|(
name|m0
argument_list|)
expr_stmt|;
name|m0
operator|->
name|m_pkthdr
operator|.
name|csum
operator|&=
operator|~
name|M_TCPV4_CSUM_OUT
expr_stmt|;
comment|/* Clear */
block|}
block|}
elseif|else
if|if
condition|(
name|m0
operator|->
name|m_pkthdr
operator|.
name|csum
operator|&
name|M_UDPV4_CSUM_OUT
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|ifp
operator|->
name|if_capabilities
operator|&
name|IFCAP_CSUM_UDPv4
operator|)
operator|||
name|ifp
operator|->
name|if_bridge
operator|!=
name|NULL
condition|)
block|{
name|in_delayed_cksum
argument_list|(
name|m0
argument_list|)
expr_stmt|;
name|m0
operator|->
name|m_pkthdr
operator|.
name|csum
operator|&=
operator|~
name|M_UDPV4_CSUM_OUT
expr_stmt|;
comment|/* Clear */
block|}
block|}
if|if
condition|(
name|ntohs
argument_list|(
name|ip
operator|->
name|ip_len
argument_list|)
operator|<=
name|ifp
operator|->
name|if_mtu
condition|)
block|{
if|if
condition|(
operator|(
name|ifp
operator|->
name|if_capabilities
operator|&
name|IFCAP_CSUM_IPv4
operator|)
operator|&&
name|ifp
operator|->
name|if_bridge
operator|==
name|NULL
condition|)
block|{
name|m0
operator|->
name|m_pkthdr
operator|.
name|csum
operator||=
name|M_IPV4_CSUM_OUT
expr_stmt|;
name|ipstat
operator|.
name|ips_outhwcsum
operator|++
expr_stmt|;
block|}
else|else
block|{
name|ip
operator|->
name|ip_sum
operator|=
literal|0
expr_stmt|;
name|ip
operator|->
name|ip_sum
operator|=
name|in_cksum
argument_list|(
name|m0
argument_list|,
name|ip
operator|->
name|ip_hl
operator|<<
literal|2
argument_list|)
expr_stmt|;
block|}
comment|/* Update relevant hardware checksum stats for TCP/UDP */
if|if
condition|(
name|m0
operator|->
name|m_pkthdr
operator|.
name|csum
operator|&
name|M_TCPV4_CSUM_OUT
condition|)
name|tcpstat
operator|.
name|tcps_outhwcsum
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|m0
operator|->
name|m_pkthdr
operator|.
name|csum
operator|&
name|M_UDPV4_CSUM_OUT
condition|)
name|udpstat
operator|.
name|udps_outhwcsum
operator|++
expr_stmt|;
name|error
operator|=
call|(
modifier|*
name|ifp
operator|->
name|if_output
call|)
argument_list|(
name|ifp
argument_list|,
name|m0
argument_list|,
name|sintosa
argument_list|(
name|dst
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
endif|#
directive|endif
comment|/* 	 * Too large for interface; fragment if possible. 	 * Must be able to put at least 8 bytes per fragment. 	 */
if|if
condition|(
name|ip
operator|->
name|ip_off
operator|&
name|htons
argument_list|(
name|IP_DF
argument_list|)
condition|)
block|{
name|ipstat
operator|.
name|ips_cantfrag
operator|++
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|rt
operator|!=
name|PF_DUPTO
condition|)
block|{
ifdef|#
directive|ifdef
name|__FreeBSD__
comment|/* icmp_error() expects host byte ordering */
name|NTOHS
argument_list|(
name|ip
operator|->
name|ip_len
argument_list|)
expr_stmt|;
name|NTOHS
argument_list|(
name|ip
operator|->
name|ip_off
argument_list|)
expr_stmt|;
name|PF_UNLOCK
argument_list|()
expr_stmt|;
name|icmp_error
argument_list|(
name|m0
argument_list|,
name|ICMP_UNREACH
argument_list|,
name|ICMP_UNREACH_NEEDFRAG
argument_list|,
literal|0
argument_list|,
name|ifp
operator|->
name|if_mtu
argument_list|)
expr_stmt|;
name|PF_LOCK
argument_list|()
expr_stmt|;
else|#
directive|else
name|icmp_error
argument_list|(
name|m0
argument_list|,
name|ICMP_UNREACH
argument_list|,
name|ICMP_UNREACH_NEEDFRAG
argument_list|,
literal|0
argument_list|,
name|ifp
argument_list|)
expr_stmt|;
endif|#
directive|endif
goto|goto
name|done
goto|;
block|}
else|else
goto|goto
name|bad
goto|;
block|}
name|m1
operator|=
name|m0
expr_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
comment|/* 	 * XXX: is cheaper + less error prone than own function 	 */
name|NTOHS
argument_list|(
name|ip
operator|->
name|ip_len
argument_list|)
expr_stmt|;
name|NTOHS
argument_list|(
name|ip
operator|->
name|ip_off
argument_list|)
expr_stmt|;
name|error
operator|=
name|ip_fragment
argument_list|(
name|ip
argument_list|,
operator|&
name|m0
argument_list|,
name|ifp
operator|->
name|if_mtu
argument_list|,
name|ifp
operator|->
name|if_hwassist
argument_list|,
name|sw_csum
argument_list|)
expr_stmt|;
else|#
directive|else
name|error
operator|=
name|ip_fragment
argument_list|(
name|m0
argument_list|,
name|ifp
argument_list|,
name|ifp
operator|->
name|if_mtu
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|error
condition|)
block|{
ifndef|#
directive|ifndef
name|__FreeBSD__
comment|/* ip_fragment does not do m_freem() on FreeBSD */
name|m0
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
goto|goto
name|bad
goto|;
block|}
for|for
control|(
name|m0
operator|=
name|m1
init|;
name|m0
condition|;
name|m0
operator|=
name|m1
control|)
block|{
name|m1
operator|=
name|m0
operator|->
name|m_nextpkt
expr_stmt|;
name|m0
operator|->
name|m_nextpkt
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
if|if
condition|(
name|error
operator|==
literal|0
condition|)
block|{
name|PF_UNLOCK
argument_list|()
expr_stmt|;
name|error
operator|=
call|(
modifier|*
name|ifp
operator|->
name|if_output
call|)
argument_list|(
name|ifp
argument_list|,
name|m0
argument_list|,
name|sintosa
argument_list|(
name|dst
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|PF_LOCK
argument_list|()
expr_stmt|;
block|}
elseif|else
else|#
directive|else
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|error
operator|=
call|(
modifier|*
name|ifp
operator|->
name|if_output
call|)
argument_list|(
name|ifp
argument_list|,
name|m0
argument_list|,
name|sintosa
argument_list|(
name|dst
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
name|m_freem
argument_list|(
name|m0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|ipstat
operator|.
name|ips_fragmented
operator|++
expr_stmt|;
name|done
label|:
if|if
condition|(
name|r
operator|->
name|rt
operator|!=
name|PF_DUPTO
condition|)
operator|*
name|m
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ro
operator|==
operator|&
name|iproute
operator|&&
name|ro
operator|->
name|ro_rt
condition|)
name|RTFREE
argument_list|(
name|ro
operator|->
name|ro_rt
argument_list|)
expr_stmt|;
return|return;
name|bad
label|:
name|m_freem
argument_list|(
name|m0
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* INET */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|INET6
end_ifdef

begin_function
name|void
name|pf_route6
parameter_list|(
name|struct
name|mbuf
modifier|*
modifier|*
name|m
parameter_list|,
name|struct
name|pf_rule
modifier|*
name|r
parameter_list|,
name|int
name|dir
parameter_list|,
name|struct
name|ifnet
modifier|*
name|oifp
parameter_list|,
name|struct
name|pf_state
modifier|*
name|s
parameter_list|)
block|{
name|struct
name|mbuf
modifier|*
name|m0
decl_stmt|;
name|struct
name|m_tag
modifier|*
name|mtag
decl_stmt|;
name|struct
name|route_in6
name|ip6route
decl_stmt|;
name|struct
name|route_in6
modifier|*
name|ro
decl_stmt|;
name|struct
name|sockaddr_in6
modifier|*
name|dst
decl_stmt|;
name|struct
name|ip6_hdr
modifier|*
name|ip6
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_addr
name|naddr
decl_stmt|;
name|struct
name|pf_src_node
modifier|*
name|sn
init|=
name|NULL
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
operator|||
operator|*
name|m
operator|==
name|NULL
operator|||
name|r
operator|==
name|NULL
operator|||
operator|(
name|dir
operator|!=
name|PF_IN
operator|&&
name|dir
operator|!=
name|PF_OUT
operator|)
operator|||
name|oifp
operator|==
name|NULL
condition|)
name|panic
argument_list|(
literal|"pf_route6: invalid parameters"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|mtag
operator|=
name|m_tag_find
argument_list|(
operator|*
name|m
argument_list|,
name|PACKET_TAG_PF_ROUTED
argument_list|,
name|NULL
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|mtag
operator|=
name|m_tag_get
argument_list|(
name|PACKET_TAG_PF_ROUTED
argument_list|,
literal|1
argument_list|,
name|M_NOWAIT
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|m0
operator|=
operator|*
name|m
expr_stmt|;
operator|*
name|m
operator|=
name|NULL
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
operator|*
operator|(
name|char
operator|*
operator|)
operator|(
name|mtag
operator|+
literal|1
operator|)
operator|=
literal|1
expr_stmt|;
name|m_tag_prepend
argument_list|(
operator|*
name|m
argument_list|,
name|mtag
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|*
operator|(
name|char
operator|*
operator|)
operator|(
name|mtag
operator|+
literal|1
operator|)
operator|>
literal|3
condition|)
block|{
name|m0
operator|=
operator|*
name|m
expr_stmt|;
operator|*
name|m
operator|=
name|NULL
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
operator|(
operator|*
operator|(
name|char
operator|*
operator|)
operator|(
name|mtag
operator|+
literal|1
operator|)
operator|)
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|r
operator|->
name|rt
operator|==
name|PF_DUPTO
condition|)
block|{
ifdef|#
directive|ifdef
name|__FreeBSD__
if|if
condition|(
operator|(
name|m0
operator|=
name|m_dup
argument_list|(
operator|*
name|m
argument_list|,
name|M_DONTWAIT
argument_list|)
operator|)
operator|==
name|NULL
condition|)
else|#
directive|else
if|if
condition|(
operator|(
name|m0
operator|=
name|m_copym2
argument_list|(
operator|*
name|m
argument_list|,
literal|0
argument_list|,
name|M_COPYALL
argument_list|,
name|M_NOWAIT
argument_list|)
operator|)
operator|==
name|NULL
condition|)
endif|#
directive|endif
return|return;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|r
operator|->
name|rt
operator|==
name|PF_REPLYTO
operator|)
operator|==
operator|(
name|r
operator|->
name|direction
operator|==
name|dir
operator|)
condition|)
return|return;
name|m0
operator|=
operator|*
name|m
expr_stmt|;
block|}
if|if
condition|(
name|m0
operator|->
name|m_len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
condition|)
block|{
name|DPFPRINTF
argument_list|(
name|PF_DEBUG_URGENT
argument_list|,
operator|(
literal|"pf_route6: m0->m_len< sizeof(struct ip6_hdr)\n"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|ip6
operator|=
name|mtod
argument_list|(
name|m0
argument_list|,
expr|struct
name|ip6_hdr
operator|*
argument_list|)
expr_stmt|;
name|ro
operator|=
operator|&
name|ip6route
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|caddr_t
operator|)
name|ro
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ro
argument_list|)
argument_list|)
expr_stmt|;
name|dst
operator|=
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
operator|&
name|ro
operator|->
name|ro_dst
expr_stmt|;
name|dst
operator|->
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|dst
operator|->
name|sin6_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|dst
argument_list|)
expr_stmt|;
name|dst
operator|->
name|sin6_addr
operator|=
name|ip6
operator|->
name|ip6_dst
expr_stmt|;
comment|/* Cheat. */
if|if
condition|(
name|r
operator|->
name|rt
operator|==
name|PF_FASTROUTE
condition|)
block|{
ifdef|#
directive|ifdef
name|__FreeBSD__
name|m0
operator|->
name|m_flags
operator||=
name|M_SKIP_FIREWALL
expr_stmt|;
name|PF_UNLOCK
argument_list|()
expr_stmt|;
name|ip6_output
argument_list|(
name|m0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|PF_LOCK
argument_list|()
expr_stmt|;
else|#
directive|else
name|mtag
operator|=
name|m_tag_get
argument_list|(
name|PACKET_TAG_PF_GENERATED
argument_list|,
literal|0
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|mtag
operator|==
name|NULL
condition|)
goto|goto
name|bad
goto|;
name|m_tag_prepend
argument_list|(
name|m0
argument_list|,
name|mtag
argument_list|)
expr_stmt|;
name|ip6_output
argument_list|(
name|m0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return;
block|}
if|if
condition|(
name|TAILQ_EMPTY
argument_list|(
operator|&
name|r
operator|->
name|rpool
operator|.
name|list
argument_list|)
condition|)
block|{
name|DPFPRINTF
argument_list|(
name|PF_DEBUG_URGENT
argument_list|,
operator|(
literal|"pf_route6: TAILQ_EMPTY(&r->rpool.list)\n"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
name|pf_map_addr
argument_list|(
name|AF_INET6
argument_list|,
name|r
argument_list|,
operator|(
expr|struct
name|pf_addr
operator|*
operator|)
operator|&
name|ip6
operator|->
name|ip6_src
argument_list|,
operator|&
name|naddr
argument_list|,
name|NULL
argument_list|,
operator|&
name|sn
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|PF_AZERO
argument_list|(
operator|&
name|naddr
argument_list|,
name|AF_INET6
argument_list|)
condition|)
name|PF_ACPY
argument_list|(
operator|(
expr|struct
name|pf_addr
operator|*
operator|)
operator|&
name|dst
operator|->
name|sin6_addr
argument_list|,
operator|&
name|naddr
argument_list|,
name|AF_INET6
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|r
operator|->
name|rpool
operator|.
name|cur
operator|->
name|kif
condition|?
name|r
operator|->
name|rpool
operator|.
name|cur
operator|->
name|kif
operator|->
name|pfik_ifp
else|:
name|NULL
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|PF_AZERO
argument_list|(
operator|&
name|s
operator|->
name|rt_addr
argument_list|,
name|AF_INET6
argument_list|)
condition|)
name|PF_ACPY
argument_list|(
operator|(
expr|struct
name|pf_addr
operator|*
operator|)
operator|&
name|dst
operator|->
name|sin6_addr
argument_list|,
operator|&
name|s
operator|->
name|rt_addr
argument_list|,
name|AF_INET6
argument_list|)
expr_stmt|;
name|ifp
operator|=
name|s
operator|->
name|rt_kif
condition|?
name|s
operator|->
name|rt_kif
operator|->
name|pfik_ifp
else|:
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
goto|goto
name|bad
goto|;
if|if
condition|(
name|oifp
operator|!=
name|ifp
condition|)
block|{
ifdef|#
directive|ifdef
name|__FreeBSD__
name|PF_UNLOCK
argument_list|()
expr_stmt|;
if|if
condition|(
name|pf_test6
argument_list|(
name|PF_OUT
argument_list|,
name|ifp
argument_list|,
operator|&
name|m0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
name|PF_PASS
condition|)
block|{
name|PF_LOCK
argument_list|()
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
elseif|else
if|if
condition|(
name|m0
operator|==
name|NULL
condition|)
block|{
name|PF_LOCK
argument_list|()
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|PF_LOCK
argument_list|()
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|pf_test6
argument_list|(
name|PF_OUT
argument_list|,
name|ifp
argument_list|,
operator|&
name|m0
argument_list|,
name|NULL
argument_list|)
operator|!=
name|PF_PASS
condition|)
goto|goto
name|bad
goto|;
elseif|else
if|if
condition|(
name|m0
operator|==
name|NULL
condition|)
goto|goto
name|done
goto|;
endif|#
directive|endif
if|if
condition|(
name|m0
operator|->
name|m_len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
condition|)
block|{
name|DPFPRINTF
argument_list|(
name|PF_DEBUG_URGENT
argument_list|,
operator|(
literal|"pf_route6: m0->m_len< sizeof(struct ip6_hdr)\n"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|ip6
operator|=
name|mtod
argument_list|(
name|m0
argument_list|,
expr|struct
name|ip6_hdr
operator|*
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * If the packet is too large for the outgoing interface, 	 * send back an icmp6 error. 	 */
if|if
condition|(
name|IN6_IS_ADDR_LINKLOCAL
argument_list|(
operator|&
name|dst
operator|->
name|sin6_addr
argument_list|)
condition|)
name|dst
operator|->
name|sin6_addr
operator|.
name|s6_addr16
index|[
literal|1
index|]
operator|=
name|htons
argument_list|(
name|ifp
operator|->
name|if_index
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|u_long
operator|)
name|m0
operator|->
name|m_pkthdr
operator|.
name|len
operator|<=
name|ifp
operator|->
name|if_mtu
condition|)
block|{
ifdef|#
directive|ifdef
name|__FreeBSD__
name|PF_UNLOCK
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|error
operator|=
name|nd6_output
argument_list|(
name|ifp
argument_list|,
name|ifp
argument_list|,
name|m0
argument_list|,
name|dst
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
name|PF_LOCK
argument_list|()
expr_stmt|;
endif|#
directive|endif
block|}
else|else
block|{
name|in6_ifstat_inc
argument_list|(
name|ifp
argument_list|,
name|ifs6_in_toobig
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
if|if
condition|(
name|r
operator|->
name|rt
operator|!=
name|PF_DUPTO
condition|)
block|{
name|PF_UNLOCK
argument_list|()
expr_stmt|;
name|icmp6_error
argument_list|(
name|m0
argument_list|,
name|ICMP6_PACKET_TOO_BIG
argument_list|,
literal|0
argument_list|,
name|ifp
operator|->
name|if_mtu
argument_list|)
expr_stmt|;
name|PF_LOCK
argument_list|()
expr_stmt|;
block|}
elseif|else
else|#
directive|else
if|if
condition|(
name|r
operator|->
name|rt
operator|!=
name|PF_DUPTO
condition|)
name|icmp6_error
argument_list|(
name|m0
argument_list|,
name|ICMP6_PACKET_TOO_BIG
argument_list|,
literal|0
argument_list|,
name|ifp
operator|->
name|if_mtu
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
goto|goto
name|bad
goto|;
block|}
name|done
label|:
if|if
condition|(
name|r
operator|->
name|rt
operator|!=
name|PF_DUPTO
condition|)
operator|*
name|m
operator|=
name|NULL
expr_stmt|;
return|return;
name|bad
label|:
name|m_freem
argument_list|(
name|m0
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* INET6 */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__FreeBSD__
end_ifdef

begin_comment
comment|/*  * FreeBSD supports cksum offloads for the following drivers.  *  em(4), fxp(4), ixgb(4), lge(4), ndis(4), nge(4), re(4),  *   ti(4), txp(4), xl(4)  *  * CSUM_DATA_VALID | CSUM_PSEUDO_HDR :  *  network driver performed cksum including pseudo header, need to verify  *   csum_data  * CSUM_DATA_VALID :  *  network driver performed cksum, needs to additional pseudo header  *  cksum computation with partial csum_data(i.e. lack of H/W support for  *  pseudo header, for instance hme(4), sk(4) and possibly gem(4))  *  * After validating the cksum of packet, set both flag CSUM_DATA_VALID and  * CSUM_PSEUDO_HDR in order to avoid recomputation of the cksum in upper  * TCP/UDP layer.  * Also, set csum_data to 0xffff to force cksum validation.  */
end_comment

begin_function
name|int
name|pf_check_proto_cksum
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|int
name|off
parameter_list|,
name|int
name|len
parameter_list|,
name|u_int8_t
name|p
parameter_list|,
name|sa_family_t
name|af
parameter_list|)
block|{
name|u_int16_t
name|sum
init|=
literal|0
decl_stmt|;
name|int
name|hw_assist
init|=
literal|0
decl_stmt|;
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
if|if
condition|(
name|off
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
operator|||
name|len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|udphdr
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|<
name|off
operator|+
name|len
condition|)
return|return
operator|(
literal|1
operator|)
return|;
switch|switch
condition|(
name|p
condition|)
block|{
case|case
name|IPPROTO_TCP
case|:
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_DATA_VALID
condition|)
block|{
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_PSEUDO_HDR
condition|)
block|{
name|sum
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_data
expr_stmt|;
block|}
else|else
block|{
name|ip
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ip
operator|*
argument_list|)
expr_stmt|;
name|sum
operator|=
name|in_pseudo
argument_list|(
name|ip
operator|->
name|ip_src
operator|.
name|s_addr
argument_list|,
name|ip
operator|->
name|ip_dst
operator|.
name|s_addr
argument_list|,
name|htonl
argument_list|(
operator|(
name|u_short
operator|)
name|len
operator|+
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_data
operator|+
name|IPPROTO_TCP
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|sum
operator|^=
literal|0xffff
expr_stmt|;
operator|++
name|hw_assist
expr_stmt|;
block|}
break|break;
case|case
name|IPPROTO_UDP
case|:
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_DATA_VALID
condition|)
block|{
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator|&
name|CSUM_PSEUDO_HDR
condition|)
block|{
name|sum
operator|=
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_data
expr_stmt|;
block|}
else|else
block|{
name|ip
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ip
operator|*
argument_list|)
expr_stmt|;
name|sum
operator|=
name|in_pseudo
argument_list|(
name|ip
operator|->
name|ip_src
operator|.
name|s_addr
argument_list|,
name|ip
operator|->
name|ip_dst
operator|.
name|s_addr
argument_list|,
name|htonl
argument_list|(
operator|(
name|u_short
operator|)
name|len
operator|+
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_data
operator|+
name|IPPROTO_UDP
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|sum
operator|^=
literal|0xffff
expr_stmt|;
operator|++
name|hw_assist
expr_stmt|;
block|}
break|break;
case|case
name|IPPROTO_ICMP
case|:
ifdef|#
directive|ifdef
name|INET6
case|case
name|IPPROTO_ICMPV6
case|:
endif|#
directive|endif
comment|/* INET6 */
break|break;
default|default:
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|hw_assist
condition|)
block|{
switch|switch
condition|(
name|af
condition|)
block|{
case|case
name|AF_INET
case|:
if|if
condition|(
name|p
operator|==
name|IPPROTO_ICMP
condition|)
block|{
if|if
condition|(
name|m
operator|->
name|m_len
operator|<
name|off
condition|)
return|return
operator|(
literal|1
operator|)
return|;
name|m
operator|->
name|m_data
operator|+=
name|off
expr_stmt|;
name|m
operator|->
name|m_len
operator|-=
name|off
expr_stmt|;
name|sum
operator|=
name|in_cksum
argument_list|(
name|m
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_data
operator|-=
name|off
expr_stmt|;
name|m
operator|->
name|m_len
operator|+=
name|off
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|m
operator|->
name|m_len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
name|sum
operator|=
name|in4_cksum
argument_list|(
name|m
argument_list|,
name|p
argument_list|,
name|off
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
if|if
condition|(
name|m
operator|->
name|m_len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
name|sum
operator|=
name|in6_cksum
argument_list|(
name|m
argument_list|,
name|p
argument_list|,
name|off
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
default|default:
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
if|if
condition|(
name|sum
condition|)
block|{
switch|switch
condition|(
name|p
condition|)
block|{
case|case
name|IPPROTO_TCP
case|:
name|tcpstat
operator|.
name|tcps_rcvbadsum
operator|++
expr_stmt|;
break|break;
case|case
name|IPPROTO_UDP
case|:
name|udpstat
operator|.
name|udps_badsum
operator|++
expr_stmt|;
break|break;
case|case
name|IPPROTO_ICMP
case|:
name|icmpstat
operator|.
name|icps_checksum
operator|++
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
name|IPPROTO_ICMPV6
case|:
name|icmp6stat
operator|.
name|icp6s_checksum
operator|++
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|p
operator|==
name|IPPROTO_TCP
operator|||
name|p
operator|==
name|IPPROTO_UDP
condition|)
block|{
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_flags
operator||=
operator|(
name|CSUM_DATA_VALID
operator||
name|CSUM_PSEUDO_HDR
operator|)
expr_stmt|;
name|m
operator|->
name|m_pkthdr
operator|.
name|csum_data
operator|=
literal|0xffff
expr_stmt|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/*  * check protocol (tcp/udp/icmp/icmp6) checksum and set mbuf flag  *   off is the offset where the protocol header starts  *   len is the total length of protocol header plus payload  * returns 0 when the checksum is valid, otherwise returns 1.  */
end_comment

begin_function
name|int
name|pf_check_proto_cksum
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|int
name|off
parameter_list|,
name|int
name|len
parameter_list|,
name|u_int8_t
name|p
parameter_list|,
name|sa_family_t
name|af
parameter_list|)
block|{
name|u_int16_t
name|flag_ok
decl_stmt|,
name|flag_bad
decl_stmt|;
name|u_int16_t
name|sum
decl_stmt|;
switch|switch
condition|(
name|p
condition|)
block|{
case|case
name|IPPROTO_TCP
case|:
name|flag_ok
operator|=
name|M_TCP_CSUM_IN_OK
expr_stmt|;
name|flag_bad
operator|=
name|M_TCP_CSUM_IN_BAD
expr_stmt|;
break|break;
case|case
name|IPPROTO_UDP
case|:
name|flag_ok
operator|=
name|M_UDP_CSUM_IN_OK
expr_stmt|;
name|flag_bad
operator|=
name|M_UDP_CSUM_IN_BAD
expr_stmt|;
break|break;
case|case
name|IPPROTO_ICMP
case|:
ifdef|#
directive|ifdef
name|INET6
case|case
name|IPPROTO_ICMPV6
case|:
endif|#
directive|endif
comment|/* INET6 */
name|flag_ok
operator|=
name|flag_bad
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|csum
operator|&
name|flag_ok
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|csum
operator|&
name|flag_bad
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|off
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
operator|||
name|len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|udphdr
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|<
name|off
operator|+
name|len
condition|)
return|return
operator|(
literal|1
operator|)
return|;
switch|switch
condition|(
name|af
condition|)
block|{
ifdef|#
directive|ifdef
name|INET
case|case
name|AF_INET
case|:
if|if
condition|(
name|p
operator|==
name|IPPROTO_ICMP
condition|)
block|{
if|if
condition|(
name|m
operator|->
name|m_len
operator|<
name|off
condition|)
return|return
operator|(
literal|1
operator|)
return|;
name|m
operator|->
name|m_data
operator|+=
name|off
expr_stmt|;
name|m
operator|->
name|m_len
operator|-=
name|off
expr_stmt|;
name|sum
operator|=
name|in_cksum
argument_list|(
name|m
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|m
operator|->
name|m_data
operator|-=
name|off
expr_stmt|;
name|m
operator|->
name|m_len
operator|+=
name|off
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|m
operator|->
name|m_len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|ip
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
name|sum
operator|=
name|in4_cksum
argument_list|(
name|m
argument_list|,
name|p
argument_list|,
name|off
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
break|break;
endif|#
directive|endif
comment|/* INET */
ifdef|#
directive|ifdef
name|INET6
case|case
name|AF_INET6
case|:
if|if
condition|(
name|m
operator|->
name|m_len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
condition|)
return|return
operator|(
literal|1
operator|)
return|;
name|sum
operator|=
name|in6_cksum
argument_list|(
name|m
argument_list|,
name|p
argument_list|,
name|off
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
default|default:
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|sum
condition|)
block|{
name|m
operator|->
name|m_pkthdr
operator|.
name|csum
operator||=
name|flag_bad
expr_stmt|;
switch|switch
condition|(
name|p
condition|)
block|{
case|case
name|IPPROTO_TCP
case|:
name|tcpstat
operator|.
name|tcps_rcvbadsum
operator|++
expr_stmt|;
break|break;
case|case
name|IPPROTO_UDP
case|:
name|udpstat
operator|.
name|udps_badsum
operator|++
expr_stmt|;
break|break;
case|case
name|IPPROTO_ICMP
case|:
name|icmpstat
operator|.
name|icps_checksum
operator|++
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|INET6
case|case
name|IPPROTO_ICMPV6
case|:
name|icmp6stat
operator|.
name|icp6s_checksum
operator|++
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* INET6 */
block|}
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|m
operator|->
name|m_pkthdr
operator|.
name|csum
operator||=
name|flag_ok
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|pf_add_mbuf_tag
parameter_list|(
name|struct
name|mbuf
modifier|*
name|m
parameter_list|,
name|u_int
name|tag
parameter_list|)
block|{
name|struct
name|m_tag
modifier|*
name|mtag
decl_stmt|;
if|if
condition|(
name|m_tag_find
argument_list|(
name|m
argument_list|,
name|tag
argument_list|,
name|NULL
argument_list|)
operator|!=
name|NULL
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|mtag
operator|=
name|m_tag_get
argument_list|(
name|tag
argument_list|,
literal|0
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|mtag
operator|==
name|NULL
condition|)
return|return
operator|(
literal|1
operator|)
return|;
name|m_tag_prepend
argument_list|(
name|m
argument_list|,
name|mtag
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|INET
end_ifdef

begin_function
name|int
ifdef|#
directive|ifdef
name|__FreeBSD__
name|pf_test
parameter_list|(
name|int
name|dir
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|m0
parameter_list|,
name|struct
name|ether_header
modifier|*
name|eh
parameter_list|,
name|struct
name|inpcb
modifier|*
name|inp
parameter_list|)
else|#
directive|else
function|pf_test
parameter_list|(
name|int
name|dir
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|m0
parameter_list|,
name|struct
name|ether_header
modifier|*
name|eh
parameter_list|)
endif|#
directive|endif
block|{
name|struct
name|pfi_kif
modifier|*
name|kif
decl_stmt|;
name|u_short
name|action
decl_stmt|,
name|reason
init|=
literal|0
decl_stmt|,
name|log
init|=
literal|0
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
operator|*
name|m0
decl_stmt|;
name|struct
name|ip
modifier|*
name|h
init|=
name|NULL
decl_stmt|;
comment|/* make the compiler happy */
name|struct
name|pf_rule
modifier|*
name|a
init|=
name|NULL
decl_stmt|,
modifier|*
name|r
init|=
operator|&
name|pf_default_rule
decl_stmt|,
modifier|*
name|tr
decl_stmt|,
modifier|*
name|nr
decl_stmt|;
name|struct
name|pf_state
modifier|*
name|s
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_ruleset
modifier|*
name|ruleset
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_pdesc
name|pd
decl_stmt|;
name|int
name|off
decl_stmt|,
name|dirndx
decl_stmt|,
name|pqid
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
name|PF_LOCK
argument_list|()
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pf_status
operator|.
name|running
operator|||
ifdef|#
directive|ifdef
name|__FreeBSD__
operator|(
name|m
operator|->
name|m_flags
operator|&
name|M_SKIP_FIREWALL
operator|)
condition|)
block|{
name|PF_UNLOCK
argument_list|()
expr_stmt|;
else|#
directive|else
operator|(
name|m_tag_find
argument_list|(
name|m
argument_list|,
name|PACKET_TAG_PF_GENERATED
argument_list|,
name|NULL
argument_list|)
operator|!=
name|NULL
operator|)
block|)
block|{
endif|#
directive|endif
return|return
operator|(
name|PF_PASS
operator|)
return|;
block|}
ifdef|#
directive|ifdef
name|__FreeBSD__
comment|/* XXX_IMPORT: later */
else|#
directive|else
if|if
condition|(
name|ifp
operator|->
name|if_type
operator|==
name|IFT_CARP
operator|&&
name|ifp
operator|->
name|if_carpdev
condition|)
name|ifp
operator|=
name|ifp
operator|->
name|if_carpdev
expr_stmt|;
endif|#
directive|endif
name|kif
operator|=
name|pfi_index2kif
index|[
name|ifp
operator|->
name|if_index
index|]
expr_stmt|;
if|if
condition|(
name|kif
operator|==
name|NULL
condition|)
block|{
ifdef|#
directive|ifdef
name|__FreeBSD__
name|PF_UNLOCK
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|DPFPRINTF
argument_list|(
name|PF_DEBUG_URGENT
argument_list|,
operator|(
literal|"pf_test: kif == NULL, if_xname %s\n"
operator|,
name|ifp
operator|->
name|if_xname
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
if|if
condition|(
name|kif
operator|->
name|pfik_flags
operator|&
name|PFI_IFLAG_SKIP
condition|)
block|{
ifdef|#
directive|ifdef
name|__FreeBSD__
name|PF_UNLOCK
argument_list|()
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|PF_PASS
operator|)
return|;
block|}
ifdef|#
directive|ifdef
name|__FreeBSD__
name|M_ASSERTPKTHDR
argument_list|(
name|m
argument_list|)
expr_stmt|;
else|#
directive|else
ifdef|#
directive|ifdef
name|DIAGNOSTIC
if|if
condition|(
operator|(
name|m
operator|->
name|m_flags
operator|&
name|M_PKTHDR
operator|)
operator|==
literal|0
condition|)
name|panic
argument_list|(
literal|"non-M_PKTHDR is passed to pf_test"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DIAGNOSTIC */
endif|#
directive|endif
comment|/* __FreeBSD__ */
name|memset
argument_list|(
operator|&
name|pd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pd
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|<
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
operator|*
name|h
argument_list|)
condition|)
block|{
name|action
operator|=
name|PF_DROP
expr_stmt|;
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_SHORT
argument_list|)
expr_stmt|;
name|log
operator|=
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* We do IP header normalization and packet reassembly here */
if|if
condition|(
name|pf_normalize_ip
argument_list|(
name|m0
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
operator|&
name|reason
argument_list|,
operator|&
name|pd
argument_list|)
operator|!=
name|PF_PASS
condition|)
block|{
name|action
operator|=
name|PF_DROP
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|m
operator|=
operator|*
name|m0
expr_stmt|;
name|h
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ip
operator|*
argument_list|)
expr_stmt|;
name|off
operator|=
name|h
operator|->
name|ip_hl
operator|<<
literal|2
expr_stmt|;
if|if
condition|(
name|off
operator|<
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
operator|*
name|h
argument_list|)
condition|)
block|{
name|action
operator|=
name|PF_DROP
expr_stmt|;
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_SHORT
argument_list|)
expr_stmt|;
name|log
operator|=
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|pd
operator|.
name|src
operator|=
operator|(
expr|struct
name|pf_addr
operator|*
operator|)
operator|&
name|h
operator|->
name|ip_src
expr_stmt|;
name|pd
operator|.
name|dst
operator|=
operator|(
expr|struct
name|pf_addr
operator|*
operator|)
operator|&
name|h
operator|->
name|ip_dst
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|pd
operator|.
name|baddr
argument_list|,
name|dir
operator|==
name|PF_OUT
condition|?
name|pd
operator|.
name|src
else|:
name|pd
operator|.
name|dst
argument_list|,
name|AF_INET
argument_list|)
expr_stmt|;
name|pd
operator|.
name|ip_sum
operator|=
operator|&
name|h
operator|->
name|ip_sum
expr_stmt|;
name|pd
operator|.
name|proto
operator|=
name|h
operator|->
name|ip_p
expr_stmt|;
name|pd
operator|.
name|af
operator|=
name|AF_INET
expr_stmt|;
name|pd
operator|.
name|tos
operator|=
name|h
operator|->
name|ip_tos
expr_stmt|;
name|pd
operator|.
name|tot_len
operator|=
name|ntohs
argument_list|(
name|h
operator|->
name|ip_len
argument_list|)
expr_stmt|;
name|pd
operator|.
name|eh
operator|=
name|eh
expr_stmt|;
comment|/* handle fragments that didn't get reassembled by normalization */
if|if
condition|(
name|h
operator|->
name|ip_off
operator|&
name|htons
argument_list|(
name|IP_MF
operator||
name|IP_OFFMASK
argument_list|)
condition|)
block|{
name|action
operator|=
name|pf_test_fragment
argument_list|(
operator|&
name|r
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
name|m
argument_list|,
name|h
argument_list|,
operator|&
name|pd
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|ruleset
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
switch|switch
condition|(
name|h
operator|->
name|ip_p
condition|)
block|{
case|case
name|IPPROTO_TCP
case|:
block|{
name|struct
name|tcphdr
name|th
decl_stmt|;
name|pd
operator|.
name|hdr
operator|.
name|tcp
operator|=
operator|&
name|th
expr_stmt|;
if|if
condition|(
operator|!
name|pf_pull_hdr
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
operator|&
name|th
argument_list|,
sizeof|sizeof
argument_list|(
name|th
argument_list|)
argument_list|,
operator|&
name|action
argument_list|,
operator|&
name|reason
argument_list|,
name|AF_INET
argument_list|)
condition|)
block|{
name|log
operator|=
name|action
operator|!=
name|PF_PASS
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|dir
operator|==
name|PF_IN
operator|&&
name|pf_check_proto_cksum
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
name|ntohs
argument_list|(
name|h
operator|->
name|ip_len
argument_list|)
operator|-
name|off
argument_list|,
name|IPPROTO_TCP
argument_list|,
name|AF_INET
argument_list|)
condition|)
block|{
name|action
operator|=
name|PF_DROP
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|pd
operator|.
name|p_len
operator|=
name|pd
operator|.
name|tot_len
operator|-
name|off
operator|-
operator|(
name|th
operator|.
name|th_off
operator|<<
literal|2
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|th
operator|.
name|th_flags
operator|&
name|TH_ACK
operator|)
operator|&&
name|pd
operator|.
name|p_len
operator|==
literal|0
condition|)
name|pqid
operator|=
literal|1
expr_stmt|;
name|action
operator|=
name|pf_normalize_tcp
argument_list|(
name|dir
argument_list|,
name|kif
argument_list|,
name|m
argument_list|,
literal|0
argument_list|,
name|off
argument_list|,
name|h
argument_list|,
operator|&
name|pd
argument_list|)
expr_stmt|;
if|if
condition|(
name|action
operator|==
name|PF_DROP
condition|)
goto|goto
name|done
goto|;
name|action
operator|=
name|pf_test_state_tcp
argument_list|(
operator|&
name|s
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|h
argument_list|,
operator|&
name|pd
argument_list|,
operator|&
name|reason
argument_list|)
expr_stmt|;
if|if
condition|(
name|action
operator|==
name|PF_PASS
condition|)
block|{
if|#
directive|if
name|NPFSYNC
name|pfsync_update_state
argument_list|(
name|s
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* NPFSYNC */
name|r
operator|=
name|s
operator|->
name|rule
operator|.
name|ptr
expr_stmt|;
name|a
operator|=
name|s
operator|->
name|anchor
operator|.
name|ptr
expr_stmt|;
name|log
operator|=
name|s
operator|->
name|log
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
ifdef|#
directive|ifdef
name|__FreeBSD__
name|action
operator|=
name|pf_test_tcp
argument_list|(
operator|&
name|r
argument_list|,
operator|&
name|s
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|h
argument_list|,
operator|&
name|pd
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|ruleset
argument_list|,
name|NULL
argument_list|,
name|inp
argument_list|)
expr_stmt|;
else|#
directive|else
name|action
operator|=
name|pf_test_tcp
argument_list|(
operator|&
name|r
argument_list|,
operator|&
name|s
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|h
argument_list|,
operator|&
name|pd
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|ruleset
argument_list|,
operator|&
name|ipintrq
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
case|case
name|IPPROTO_UDP
case|:
block|{
name|struct
name|udphdr
name|uh
decl_stmt|;
name|pd
operator|.
name|hdr
operator|.
name|udp
operator|=
operator|&
name|uh
expr_stmt|;
if|if
condition|(
operator|!
name|pf_pull_hdr
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
operator|&
name|uh
argument_list|,
sizeof|sizeof
argument_list|(
name|uh
argument_list|)
argument_list|,
operator|&
name|action
argument_list|,
operator|&
name|reason
argument_list|,
name|AF_INET
argument_list|)
condition|)
block|{
name|log
operator|=
name|action
operator|!=
name|PF_PASS
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|dir
operator|==
name|PF_IN
operator|&&
name|uh
operator|.
name|uh_sum
operator|&&
name|pf_check_proto_cksum
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
name|ntohs
argument_list|(
name|h
operator|->
name|ip_len
argument_list|)
operator|-
name|off
argument_list|,
name|IPPROTO_UDP
argument_list|,
name|AF_INET
argument_list|)
condition|)
block|{
name|action
operator|=
name|PF_DROP
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|uh
operator|.
name|uh_dport
operator|==
literal|0
operator|||
name|ntohs
argument_list|(
name|uh
operator|.
name|uh_ulen
argument_list|)
operator|>
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|-
name|off
operator|||
name|ntohs
argument_list|(
name|uh
operator|.
name|uh_ulen
argument_list|)
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|udphdr
argument_list|)
condition|)
block|{
name|action
operator|=
name|PF_DROP
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|action
operator|=
name|pf_test_state_udp
argument_list|(
operator|&
name|s
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|h
argument_list|,
operator|&
name|pd
argument_list|)
expr_stmt|;
if|if
condition|(
name|action
operator|==
name|PF_PASS
condition|)
block|{
if|#
directive|if
name|NPFSYNC
name|pfsync_update_state
argument_list|(
name|s
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* NPFSYNC */
name|r
operator|=
name|s
operator|->
name|rule
operator|.
name|ptr
expr_stmt|;
name|a
operator|=
name|s
operator|->
name|anchor
operator|.
name|ptr
expr_stmt|;
name|log
operator|=
name|s
operator|->
name|log
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
ifdef|#
directive|ifdef
name|__FreeBSD__
name|action
operator|=
name|pf_test_udp
argument_list|(
operator|&
name|r
argument_list|,
operator|&
name|s
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|h
argument_list|,
operator|&
name|pd
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|ruleset
argument_list|,
name|NULL
argument_list|,
name|inp
argument_list|)
expr_stmt|;
else|#
directive|else
name|action
operator|=
name|pf_test_udp
argument_list|(
operator|&
name|r
argument_list|,
operator|&
name|s
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|h
argument_list|,
operator|&
name|pd
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|ruleset
argument_list|,
operator|&
name|ipintrq
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
case|case
name|IPPROTO_ICMP
case|:
block|{
name|struct
name|icmp
name|ih
decl_stmt|;
name|pd
operator|.
name|hdr
operator|.
name|icmp
operator|=
operator|&
name|ih
expr_stmt|;
if|if
condition|(
operator|!
name|pf_pull_hdr
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
operator|&
name|ih
argument_list|,
name|ICMP_MINLEN
argument_list|,
operator|&
name|action
argument_list|,
operator|&
name|reason
argument_list|,
name|AF_INET
argument_list|)
condition|)
block|{
name|log
operator|=
name|action
operator|!=
name|PF_PASS
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|dir
operator|==
name|PF_IN
operator|&&
name|pf_check_proto_cksum
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
name|ntohs
argument_list|(
name|h
operator|->
name|ip_len
argument_list|)
operator|-
name|off
argument_list|,
name|IPPROTO_ICMP
argument_list|,
name|AF_INET
argument_list|)
condition|)
block|{
name|action
operator|=
name|PF_DROP
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|action
operator|=
name|pf_test_state_icmp
argument_list|(
operator|&
name|s
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|h
argument_list|,
operator|&
name|pd
argument_list|,
operator|&
name|reason
argument_list|)
expr_stmt|;
if|if
condition|(
name|action
operator|==
name|PF_PASS
condition|)
block|{
if|#
directive|if
name|NPFSYNC
name|pfsync_update_state
argument_list|(
name|s
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* NPFSYNC */
name|r
operator|=
name|s
operator|->
name|rule
operator|.
name|ptr
expr_stmt|;
name|a
operator|=
name|s
operator|->
name|anchor
operator|.
name|ptr
expr_stmt|;
name|log
operator|=
name|s
operator|->
name|log
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
ifdef|#
directive|ifdef
name|__FreeBSD__
name|action
operator|=
name|pf_test_icmp
argument_list|(
operator|&
name|r
argument_list|,
operator|&
name|s
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|h
argument_list|,
operator|&
name|pd
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|ruleset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|#
directive|else
name|action
operator|=
name|pf_test_icmp
argument_list|(
operator|&
name|r
argument_list|,
operator|&
name|s
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|h
argument_list|,
operator|&
name|pd
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|ruleset
argument_list|,
operator|&
name|ipintrq
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
default|default:
name|action
operator|=
name|pf_test_state_other
argument_list|(
operator|&
name|s
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
operator|&
name|pd
argument_list|)
expr_stmt|;
if|if
condition|(
name|action
operator|==
name|PF_PASS
condition|)
block|{
if|#
directive|if
name|NPFSYNC
name|pfsync_update_state
argument_list|(
name|s
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* NPFSYNC */
name|r
operator|=
name|s
operator|->
name|rule
operator|.
name|ptr
expr_stmt|;
name|a
operator|=
name|s
operator|->
name|anchor
operator|.
name|ptr
expr_stmt|;
name|log
operator|=
name|s
operator|->
name|log
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
ifdef|#
directive|ifdef
name|__FreeBSD__
name|action
operator|=
name|pf_test_other
argument_list|(
operator|&
name|r
argument_list|,
operator|&
name|s
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|h
argument_list|,
operator|&
name|pd
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|ruleset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|#
directive|else
name|action
operator|=
name|pf_test_other
argument_list|(
operator|&
name|r
argument_list|,
operator|&
name|s
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|h
argument_list|,
operator|&
name|pd
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|ruleset
argument_list|,
operator|&
name|ipintrq
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
name|done
label|:
if|if
condition|(
name|action
operator|==
name|PF_PASS
operator|&&
name|h
operator|->
name|ip_hl
operator|>
literal|5
operator|&&
operator|!
operator|(
operator|(
name|s
operator|&&
name|s
operator|->
name|allow_opts
operator|)
operator|||
name|r
operator|->
name|allow_opts
operator|)
condition|)
block|{
name|action
operator|=
name|PF_DROP
expr_stmt|;
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_IPOPTIONS
argument_list|)
expr_stmt|;
name|log
operator|=
literal|1
expr_stmt|;
name|DPFPRINTF
argument_list|(
name|PF_DEBUG_MISC
argument_list|,
operator|(
literal|"pf: dropping packet with ip options\n"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|s
operator|&&
name|s
operator|->
name|tag
condition|)
name|pf_tag_packet
argument_list|(
name|m
argument_list|,
name|pf_get_tag
argument_list|(
name|m
argument_list|)
argument_list|,
name|s
operator|->
name|tag
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ALTQ
if|if
condition|(
name|action
operator|==
name|PF_PASS
operator|&&
name|r
operator|->
name|qid
condition|)
block|{
name|struct
name|m_tag
modifier|*
name|mtag
decl_stmt|;
name|struct
name|altq_tag
modifier|*
name|atag
decl_stmt|;
name|mtag
operator|=
name|m_tag_get
argument_list|(
name|PACKET_TAG_PF_QID
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|atag
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|mtag
operator|!=
name|NULL
condition|)
block|{
name|atag
operator|=
operator|(
expr|struct
name|altq_tag
operator|*
operator|)
operator|(
name|mtag
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|pqid
operator|||
name|pd
operator|.
name|tos
operator|==
name|IPTOS_LOWDELAY
condition|)
name|atag
operator|->
name|qid
operator|=
name|r
operator|->
name|pqid
expr_stmt|;
else|else
name|atag
operator|->
name|qid
operator|=
name|r
operator|->
name|qid
expr_stmt|;
comment|/* add hints for ecn */
name|atag
operator|->
name|af
operator|=
name|AF_INET
expr_stmt|;
name|atag
operator|->
name|hdr
operator|=
name|h
expr_stmt|;
name|m_tag_prepend
argument_list|(
name|m
argument_list|,
name|mtag
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* ALTQ */
comment|/* 	 * connections redirected to loopback should not match sockets 	 * bound specifically to loopback due to security implications, 	 * see tcp_input() and in_pcblookup_listen(). 	 */
if|if
condition|(
name|dir
operator|==
name|PF_IN
operator|&&
name|action
operator|==
name|PF_PASS
operator|&&
operator|(
name|pd
operator|.
name|proto
operator|==
name|IPPROTO_TCP
operator|||
name|pd
operator|.
name|proto
operator|==
name|IPPROTO_UDP
operator|)
operator|&&
name|s
operator|!=
name|NULL
operator|&&
name|s
operator|->
name|nat_rule
operator|.
name|ptr
operator|!=
name|NULL
operator|&&
operator|(
name|s
operator|->
name|nat_rule
operator|.
name|ptr
operator|->
name|action
operator|==
name|PF_RDR
operator|||
name|s
operator|->
name|nat_rule
operator|.
name|ptr
operator|->
name|action
operator|==
name|PF_BINAT
operator|)
operator|&&
operator|(
name|ntohl
argument_list|(
name|pd
operator|.
name|dst
operator|->
name|v4
operator|.
name|s_addr
argument_list|)
operator|>>
name|IN_CLASSA_NSHIFT
operator|)
operator|==
name|IN_LOOPBACKNET
operator|&&
name|pf_add_mbuf_tag
argument_list|(
name|m
argument_list|,
name|PACKET_TAG_PF_TRANSLATE_LOCALHOST
argument_list|)
condition|)
block|{
name|action
operator|=
name|PF_DROP
expr_stmt|;
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_MEMORY
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|log
condition|)
name|PFLOG_PACKET
argument_list|(
name|kif
argument_list|,
name|h
argument_list|,
name|m
argument_list|,
name|AF_INET
argument_list|,
name|dir
argument_list|,
name|reason
argument_list|,
name|r
argument_list|,
name|a
argument_list|,
name|ruleset
argument_list|)
expr_stmt|;
name|kif
operator|->
name|pfik_bytes
index|[
literal|0
index|]
index|[
name|dir
operator|==
name|PF_OUT
index|]
index|[
name|action
operator|!=
name|PF_PASS
index|]
operator|+=
name|pd
operator|.
name|tot_len
expr_stmt|;
name|kif
operator|->
name|pfik_packets
index|[
literal|0
index|]
index|[
name|dir
operator|==
name|PF_OUT
index|]
index|[
name|action
operator|!=
name|PF_PASS
index|]
operator|++
expr_stmt|;
if|if
condition|(
name|action
operator|==
name|PF_PASS
operator|||
name|r
operator|->
name|action
operator|==
name|PF_DROP
condition|)
block|{
name|r
operator|->
name|packets
operator|++
expr_stmt|;
name|r
operator|->
name|bytes
operator|+=
name|pd
operator|.
name|tot_len
expr_stmt|;
if|if
condition|(
name|a
operator|!=
name|NULL
condition|)
block|{
name|a
operator|->
name|packets
operator|++
expr_stmt|;
name|a
operator|->
name|bytes
operator|+=
name|pd
operator|.
name|tot_len
expr_stmt|;
block|}
if|if
condition|(
name|s
operator|!=
name|NULL
condition|)
block|{
name|dirndx
operator|=
operator|(
name|dir
operator|==
name|s
operator|->
name|direction
operator|)
condition|?
literal|0
else|:
literal|1
expr_stmt|;
name|s
operator|->
name|packets
index|[
name|dirndx
index|]
operator|++
expr_stmt|;
name|s
operator|->
name|bytes
index|[
name|dirndx
index|]
operator|+=
name|pd
operator|.
name|tot_len
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|nat_rule
operator|.
name|ptr
operator|!=
name|NULL
condition|)
block|{
name|s
operator|->
name|nat_rule
operator|.
name|ptr
operator|->
name|packets
operator|++
expr_stmt|;
name|s
operator|->
name|nat_rule
operator|.
name|ptr
operator|->
name|bytes
operator|+=
name|pd
operator|.
name|tot_len
expr_stmt|;
block|}
if|if
condition|(
name|s
operator|->
name|src_node
operator|!=
name|NULL
condition|)
block|{
name|s
operator|->
name|src_node
operator|->
name|packets
operator|++
expr_stmt|;
name|s
operator|->
name|src_node
operator|->
name|bytes
operator|+=
name|pd
operator|.
name|tot_len
expr_stmt|;
block|}
if|if
condition|(
name|s
operator|->
name|nat_src_node
operator|!=
name|NULL
condition|)
block|{
name|s
operator|->
name|nat_src_node
operator|->
name|packets
operator|++
expr_stmt|;
name|s
operator|->
name|nat_src_node
operator|->
name|bytes
operator|+=
name|pd
operator|.
name|tot_len
expr_stmt|;
block|}
block|}
name|tr
operator|=
name|r
expr_stmt|;
name|nr
operator|=
operator|(
name|s
operator|!=
name|NULL
operator|)
condition|?
name|s
operator|->
name|nat_rule
operator|.
name|ptr
else|:
name|pd
operator|.
name|nat_rule
expr_stmt|;
if|if
condition|(
name|nr
operator|!=
name|NULL
condition|)
block|{
name|struct
name|pf_addr
modifier|*
name|x
decl_stmt|;
comment|/* 			 * XXX: we need to make sure that the addresses 			 * passed to pfr_update_stats() are the same than 			 * the addresses used during matching (pfr_match) 			 */
if|if
condition|(
name|r
operator|==
operator|&
name|pf_default_rule
condition|)
block|{
name|tr
operator|=
name|nr
expr_stmt|;
name|x
operator|=
operator|(
name|s
operator|==
name|NULL
operator|||
name|s
operator|->
name|direction
operator|==
name|dir
operator|)
condition|?
operator|&
name|pd
operator|.
name|baddr
else|:
operator|&
name|pd
operator|.
name|naddr
expr_stmt|;
block|}
else|else
name|x
operator|=
operator|(
name|s
operator|==
name|NULL
operator|||
name|s
operator|->
name|direction
operator|==
name|dir
operator|)
condition|?
operator|&
name|pd
operator|.
name|naddr
else|:
operator|&
name|pd
operator|.
name|baddr
expr_stmt|;
if|if
condition|(
name|x
operator|==
operator|&
name|pd
operator|.
name|baddr
operator|||
name|s
operator|==
name|NULL
condition|)
block|{
comment|/* we need to change the address */
if|if
condition|(
name|dir
operator|==
name|PF_OUT
condition|)
name|pd
operator|.
name|src
operator|=
name|x
expr_stmt|;
else|else
name|pd
operator|.
name|dst
operator|=
name|x
expr_stmt|;
block|}
block|}
if|if
condition|(
name|tr
operator|->
name|src
operator|.
name|addr
operator|.
name|type
operator|==
name|PF_ADDR_TABLE
condition|)
name|pfr_update_stats
argument_list|(
name|tr
operator|->
name|src
operator|.
name|addr
operator|.
name|p
operator|.
name|tbl
argument_list|,
operator|(
name|s
operator|==
name|NULL
operator|||
name|s
operator|->
name|direction
operator|==
name|dir
operator|)
condition|?
name|pd
operator|.
name|src
else|:
name|pd
operator|.
name|dst
argument_list|,
name|pd
operator|.
name|af
argument_list|,
name|pd
operator|.
name|tot_len
argument_list|,
name|dir
operator|==
name|PF_OUT
argument_list|,
name|r
operator|->
name|action
operator|==
name|PF_PASS
argument_list|,
name|tr
operator|->
name|src
operator|.
name|neg
argument_list|)
expr_stmt|;
if|if
condition|(
name|tr
operator|->
name|dst
operator|.
name|addr
operator|.
name|type
operator|==
name|PF_ADDR_TABLE
condition|)
name|pfr_update_stats
argument_list|(
name|tr
operator|->
name|dst
operator|.
name|addr
operator|.
name|p
operator|.
name|tbl
argument_list|,
operator|(
name|s
operator|==
name|NULL
operator|||
name|s
operator|->
name|direction
operator|==
name|dir
operator|)
condition|?
name|pd
operator|.
name|dst
else|:
name|pd
operator|.
name|src
argument_list|,
name|pd
operator|.
name|af
argument_list|,
name|pd
operator|.
name|tot_len
argument_list|,
name|dir
operator|==
name|PF_OUT
argument_list|,
name|r
operator|->
name|action
operator|==
name|PF_PASS
argument_list|,
name|tr
operator|->
name|dst
operator|.
name|neg
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|action
operator|==
name|PF_SYNPROXY_DROP
condition|)
block|{
name|m_freem
argument_list|(
operator|*
name|m0
argument_list|)
expr_stmt|;
operator|*
name|m0
operator|=
name|NULL
expr_stmt|;
name|action
operator|=
name|PF_PASS
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|r
operator|->
name|rt
condition|)
comment|/* pf_route can free the mbuf causing *m0 to become NULL */
name|pf_route
argument_list|(
name|m0
argument_list|,
name|r
argument_list|,
name|dir
argument_list|,
name|ifp
argument_list|,
name|s
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
name|PF_UNLOCK
argument_list|()
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|action
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* INET */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|INET6
end_ifdef

begin_function
name|int
ifdef|#
directive|ifdef
name|__FreeBSD__
name|pf_test6
parameter_list|(
name|int
name|dir
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|m0
parameter_list|,
name|struct
name|ether_header
modifier|*
name|eh
parameter_list|,
name|struct
name|inpcb
modifier|*
name|inp
parameter_list|)
else|#
directive|else
function|pf_test6
parameter_list|(
name|int
name|dir
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|mbuf
modifier|*
modifier|*
name|m0
parameter_list|,
name|struct
name|ether_header
modifier|*
name|eh
parameter_list|)
endif|#
directive|endif
block|{
name|struct
name|pfi_kif
modifier|*
name|kif
decl_stmt|;
name|u_short
name|action
decl_stmt|,
name|reason
init|=
literal|0
decl_stmt|,
name|log
init|=
literal|0
decl_stmt|;
name|struct
name|mbuf
modifier|*
name|m
init|=
operator|*
name|m0
decl_stmt|;
name|struct
name|ip6_hdr
modifier|*
name|h
init|=
name|NULL
decl_stmt|;
comment|/* make the compiler happy */
name|struct
name|pf_rule
modifier|*
name|a
init|=
name|NULL
decl_stmt|,
modifier|*
name|r
init|=
operator|&
name|pf_default_rule
decl_stmt|,
modifier|*
name|tr
decl_stmt|,
modifier|*
name|nr
decl_stmt|;
name|struct
name|pf_state
modifier|*
name|s
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_ruleset
modifier|*
name|ruleset
init|=
name|NULL
decl_stmt|;
name|struct
name|pf_pdesc
name|pd
decl_stmt|;
name|int
name|off
decl_stmt|,
name|terminal
init|=
literal|0
decl_stmt|,
name|dirndx
decl_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
name|PF_LOCK
argument_list|()
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|pf_status
operator|.
name|running
operator|||
ifdef|#
directive|ifdef
name|__FreeBSD__
operator|(
name|m
operator|->
name|m_flags
operator|&
name|M_SKIP_FIREWALL
operator|)
condition|)
block|{
name|PF_UNLOCK
argument_list|()
expr_stmt|;
else|#
directive|else
operator|(
name|m_tag_find
argument_list|(
name|m
argument_list|,
name|PACKET_TAG_PF_GENERATED
argument_list|,
name|NULL
argument_list|)
operator|!=
name|NULL
operator|)
block|)
block|{
endif|#
directive|endif
return|return
operator|(
name|PF_PASS
operator|)
return|;
block|}
ifdef|#
directive|ifdef
name|__FreeBSD__
comment|/* XXX_IMPORT: later */
else|#
directive|else
if|if
condition|(
name|ifp
operator|->
name|if_type
operator|==
name|IFT_CARP
operator|&&
name|ifp
operator|->
name|if_carpdev
condition|)
name|ifp
operator|=
name|ifp
operator|->
name|if_carpdev
expr_stmt|;
endif|#
directive|endif
name|kif
operator|=
name|pfi_index2kif
index|[
name|ifp
operator|->
name|if_index
index|]
expr_stmt|;
if|if
condition|(
name|kif
operator|==
name|NULL
condition|)
block|{
ifdef|#
directive|ifdef
name|__FreeBSD__
name|PF_UNLOCK
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|DPFPRINTF
argument_list|(
name|PF_DEBUG_URGENT
argument_list|,
operator|(
literal|"pf_test6: kif == NULL, if_xname %s\n"
operator|,
name|ifp
operator|->
name|if_xname
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|PF_DROP
operator|)
return|;
block|}
if|if
condition|(
name|kif
operator|->
name|pfik_flags
operator|&
name|PFI_IFLAG_SKIP
condition|)
block|{
ifdef|#
directive|ifdef
name|__FreeBSD__
name|PF_UNLOCK
argument_list|()
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|PF_PASS
operator|)
return|;
block|}
ifdef|#
directive|ifdef
name|__FreeBSD__
name|M_ASSERTPKTHDR
argument_list|(
name|m
argument_list|)
expr_stmt|;
else|#
directive|else
ifdef|#
directive|ifdef
name|DIAGNOSTIC
if|if
condition|(
operator|(
name|m
operator|->
name|m_flags
operator|&
name|M_PKTHDR
operator|)
operator|==
literal|0
condition|)
name|panic
argument_list|(
literal|"non-M_PKTHDR is passed to pf_test6"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DIAGNOSTIC */
endif|#
directive|endif
name|memset
argument_list|(
operator|&
name|pd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pd
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|<
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
operator|*
name|h
argument_list|)
condition|)
block|{
name|action
operator|=
name|PF_DROP
expr_stmt|;
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_SHORT
argument_list|)
expr_stmt|;
name|log
operator|=
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* We do IP header normalization and packet reassembly here */
if|if
condition|(
name|pf_normalize_ip6
argument_list|(
name|m0
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
operator|&
name|reason
argument_list|,
operator|&
name|pd
argument_list|)
operator|!=
name|PF_PASS
condition|)
block|{
name|action
operator|=
name|PF_DROP
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|m
operator|=
operator|*
name|m0
expr_stmt|;
name|h
operator|=
name|mtod
argument_list|(
name|m
argument_list|,
expr|struct
name|ip6_hdr
operator|*
argument_list|)
expr_stmt|;
name|pd
operator|.
name|src
operator|=
operator|(
expr|struct
name|pf_addr
operator|*
operator|)
operator|&
name|h
operator|->
name|ip6_src
expr_stmt|;
name|pd
operator|.
name|dst
operator|=
operator|(
expr|struct
name|pf_addr
operator|*
operator|)
operator|&
name|h
operator|->
name|ip6_dst
expr_stmt|;
name|PF_ACPY
argument_list|(
operator|&
name|pd
operator|.
name|baddr
argument_list|,
name|dir
operator|==
name|PF_OUT
condition|?
name|pd
operator|.
name|src
else|:
name|pd
operator|.
name|dst
argument_list|,
name|AF_INET6
argument_list|)
expr_stmt|;
name|pd
operator|.
name|ip_sum
operator|=
name|NULL
expr_stmt|;
name|pd
operator|.
name|af
operator|=
name|AF_INET6
expr_stmt|;
name|pd
operator|.
name|tos
operator|=
literal|0
expr_stmt|;
name|pd
operator|.
name|tot_len
operator|=
name|ntohs
argument_list|(
name|h
operator|->
name|ip6_plen
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
expr_stmt|;
name|pd
operator|.
name|eh
operator|=
name|eh
expr_stmt|;
name|off
operator|=
operator|(
operator|(
name|caddr_t
operator|)
name|h
operator|-
name|m
operator|->
name|m_data
operator|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
expr_stmt|;
name|pd
operator|.
name|proto
operator|=
name|h
operator|->
name|ip6_nxt
expr_stmt|;
do|do
block|{
switch|switch
condition|(
name|pd
operator|.
name|proto
condition|)
block|{
case|case
name|IPPROTO_FRAGMENT
case|:
name|action
operator|=
name|pf_test_fragment
argument_list|(
operator|&
name|r
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
name|m
argument_list|,
name|h
argument_list|,
operator|&
name|pd
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|ruleset
argument_list|)
expr_stmt|;
if|if
condition|(
name|action
operator|==
name|PF_DROP
condition|)
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_FRAG
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
case|case
name|IPPROTO_AH
case|:
case|case
name|IPPROTO_HOPOPTS
case|:
case|case
name|IPPROTO_ROUTING
case|:
case|case
name|IPPROTO_DSTOPTS
case|:
block|{
comment|/* get next header and header length */
name|struct
name|ip6_ext
name|opt6
decl_stmt|;
if|if
condition|(
operator|!
name|pf_pull_hdr
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
operator|&
name|opt6
argument_list|,
sizeof|sizeof
argument_list|(
name|opt6
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|reason
argument_list|,
name|pd
operator|.
name|af
argument_list|)
condition|)
block|{
name|DPFPRINTF
argument_list|(
name|PF_DEBUG_MISC
argument_list|,
operator|(
literal|"pf: IPv6 short opt\n"
operator|)
argument_list|)
expr_stmt|;
name|action
operator|=
name|PF_DROP
expr_stmt|;
name|log
operator|=
literal|1
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|pd
operator|.
name|proto
operator|==
name|IPPROTO_AH
condition|)
name|off
operator|+=
operator|(
name|opt6
operator|.
name|ip6e_len
operator|+
literal|2
operator|)
operator|*
literal|4
expr_stmt|;
else|else
name|off
operator|+=
operator|(
name|opt6
operator|.
name|ip6e_len
operator|+
literal|1
operator|)
operator|*
literal|8
expr_stmt|;
name|pd
operator|.
name|proto
operator|=
name|opt6
operator|.
name|ip6e_nxt
expr_stmt|;
comment|/* goto the next header */
break|break;
block|}
default|default:
name|terminal
operator|++
expr_stmt|;
break|break;
block|}
block|}
do|while
condition|(
operator|!
name|terminal
condition|)
do|;
switch|switch
condition|(
name|pd
operator|.
name|proto
condition|)
block|{
case|case
name|IPPROTO_TCP
case|:
block|{
name|struct
name|tcphdr
name|th
decl_stmt|;
name|pd
operator|.
name|hdr
operator|.
name|tcp
operator|=
operator|&
name|th
expr_stmt|;
if|if
condition|(
operator|!
name|pf_pull_hdr
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
operator|&
name|th
argument_list|,
sizeof|sizeof
argument_list|(
name|th
argument_list|)
argument_list|,
operator|&
name|action
argument_list|,
operator|&
name|reason
argument_list|,
name|AF_INET6
argument_list|)
condition|)
block|{
name|log
operator|=
name|action
operator|!=
name|PF_PASS
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|dir
operator|==
name|PF_IN
operator|&&
name|pf_check_proto_cksum
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
name|ntohs
argument_list|(
name|h
operator|->
name|ip6_plen
argument_list|)
operator|-
operator|(
name|off
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
operator|)
argument_list|,
name|IPPROTO_TCP
argument_list|,
name|AF_INET6
argument_list|)
condition|)
block|{
name|action
operator|=
name|PF_DROP
expr_stmt|;
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_PROTCKSUM
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|pd
operator|.
name|p_len
operator|=
name|pd
operator|.
name|tot_len
operator|-
name|off
operator|-
operator|(
name|th
operator|.
name|th_off
operator|<<
literal|2
operator|)
expr_stmt|;
name|action
operator|=
name|pf_normalize_tcp
argument_list|(
name|dir
argument_list|,
name|kif
argument_list|,
name|m
argument_list|,
literal|0
argument_list|,
name|off
argument_list|,
name|h
argument_list|,
operator|&
name|pd
argument_list|)
expr_stmt|;
if|if
condition|(
name|action
operator|==
name|PF_DROP
condition|)
goto|goto
name|done
goto|;
name|action
operator|=
name|pf_test_state_tcp
argument_list|(
operator|&
name|s
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|h
argument_list|,
operator|&
name|pd
argument_list|,
operator|&
name|reason
argument_list|)
expr_stmt|;
if|if
condition|(
name|action
operator|==
name|PF_PASS
condition|)
block|{
if|#
directive|if
name|NPFSYNC
name|pfsync_update_state
argument_list|(
name|s
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* NPFSYNC */
name|r
operator|=
name|s
operator|->
name|rule
operator|.
name|ptr
expr_stmt|;
name|a
operator|=
name|s
operator|->
name|anchor
operator|.
name|ptr
expr_stmt|;
name|log
operator|=
name|s
operator|->
name|log
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
ifdef|#
directive|ifdef
name|__FreeBSD__
name|action
operator|=
name|pf_test_tcp
argument_list|(
operator|&
name|r
argument_list|,
operator|&
name|s
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|h
argument_list|,
operator|&
name|pd
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|ruleset
argument_list|,
name|NULL
argument_list|,
name|inp
argument_list|)
expr_stmt|;
else|#
directive|else
name|action
operator|=
name|pf_test_tcp
argument_list|(
operator|&
name|r
argument_list|,
operator|&
name|s
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|h
argument_list|,
operator|&
name|pd
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|ruleset
argument_list|,
operator|&
name|ip6intrq
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
case|case
name|IPPROTO_UDP
case|:
block|{
name|struct
name|udphdr
name|uh
decl_stmt|;
name|pd
operator|.
name|hdr
operator|.
name|udp
operator|=
operator|&
name|uh
expr_stmt|;
if|if
condition|(
operator|!
name|pf_pull_hdr
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
operator|&
name|uh
argument_list|,
sizeof|sizeof
argument_list|(
name|uh
argument_list|)
argument_list|,
operator|&
name|action
argument_list|,
operator|&
name|reason
argument_list|,
name|AF_INET6
argument_list|)
condition|)
block|{
name|log
operator|=
name|action
operator|!=
name|PF_PASS
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|dir
operator|==
name|PF_IN
operator|&&
name|uh
operator|.
name|uh_sum
operator|&&
name|pf_check_proto_cksum
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
name|ntohs
argument_list|(
name|h
operator|->
name|ip6_plen
argument_list|)
operator|-
operator|(
name|off
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
operator|)
argument_list|,
name|IPPROTO_UDP
argument_list|,
name|AF_INET6
argument_list|)
condition|)
block|{
name|action
operator|=
name|PF_DROP
expr_stmt|;
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_PROTCKSUM
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|uh
operator|.
name|uh_dport
operator|==
literal|0
operator|||
name|ntohs
argument_list|(
name|uh
operator|.
name|uh_ulen
argument_list|)
operator|>
name|m
operator|->
name|m_pkthdr
operator|.
name|len
operator|-
name|off
operator|||
name|ntohs
argument_list|(
name|uh
operator|.
name|uh_ulen
argument_list|)
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|udphdr
argument_list|)
condition|)
block|{
name|action
operator|=
name|PF_DROP
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|action
operator|=
name|pf_test_state_udp
argument_list|(
operator|&
name|s
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|h
argument_list|,
operator|&
name|pd
argument_list|)
expr_stmt|;
if|if
condition|(
name|action
operator|==
name|PF_PASS
condition|)
block|{
if|#
directive|if
name|NPFSYNC
name|pfsync_update_state
argument_list|(
name|s
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* NPFSYNC */
name|r
operator|=
name|s
operator|->
name|rule
operator|.
name|ptr
expr_stmt|;
name|a
operator|=
name|s
operator|->
name|anchor
operator|.
name|ptr
expr_stmt|;
name|log
operator|=
name|s
operator|->
name|log
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
ifdef|#
directive|ifdef
name|__FreeBSD__
name|action
operator|=
name|pf_test_udp
argument_list|(
operator|&
name|r
argument_list|,
operator|&
name|s
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|h
argument_list|,
operator|&
name|pd
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|ruleset
argument_list|,
name|NULL
argument_list|,
name|inp
argument_list|)
expr_stmt|;
else|#
directive|else
name|action
operator|=
name|pf_test_udp
argument_list|(
operator|&
name|r
argument_list|,
operator|&
name|s
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|h
argument_list|,
operator|&
name|pd
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|ruleset
argument_list|,
operator|&
name|ip6intrq
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
case|case
name|IPPROTO_ICMPV6
case|:
block|{
name|struct
name|icmp6_hdr
name|ih
decl_stmt|;
name|pd
operator|.
name|hdr
operator|.
name|icmp6
operator|=
operator|&
name|ih
expr_stmt|;
if|if
condition|(
operator|!
name|pf_pull_hdr
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
operator|&
name|ih
argument_list|,
sizeof|sizeof
argument_list|(
name|ih
argument_list|)
argument_list|,
operator|&
name|action
argument_list|,
operator|&
name|reason
argument_list|,
name|AF_INET6
argument_list|)
condition|)
block|{
name|log
operator|=
name|action
operator|!=
name|PF_PASS
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|dir
operator|==
name|PF_IN
operator|&&
name|pf_check_proto_cksum
argument_list|(
name|m
argument_list|,
name|off
argument_list|,
name|ntohs
argument_list|(
name|h
operator|->
name|ip6_plen
argument_list|)
operator|-
operator|(
name|off
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|ip6_hdr
argument_list|)
operator|)
argument_list|,
name|IPPROTO_ICMPV6
argument_list|,
name|AF_INET6
argument_list|)
condition|)
block|{
name|action
operator|=
name|PF_DROP
expr_stmt|;
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_PROTCKSUM
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|action
operator|=
name|pf_test_state_icmp
argument_list|(
operator|&
name|s
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|h
argument_list|,
operator|&
name|pd
argument_list|,
operator|&
name|reason
argument_list|)
expr_stmt|;
if|if
condition|(
name|action
operator|==
name|PF_PASS
condition|)
block|{
if|#
directive|if
name|NPFSYNC
name|pfsync_update_state
argument_list|(
name|s
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* NPFSYNC */
name|r
operator|=
name|s
operator|->
name|rule
operator|.
name|ptr
expr_stmt|;
name|a
operator|=
name|s
operator|->
name|anchor
operator|.
name|ptr
expr_stmt|;
name|log
operator|=
name|s
operator|->
name|log
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
ifdef|#
directive|ifdef
name|__FreeBSD__
name|action
operator|=
name|pf_test_icmp
argument_list|(
operator|&
name|r
argument_list|,
operator|&
name|s
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|h
argument_list|,
operator|&
name|pd
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|ruleset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|#
directive|else
name|action
operator|=
name|pf_test_icmp
argument_list|(
operator|&
name|r
argument_list|,
operator|&
name|s
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|h
argument_list|,
operator|&
name|pd
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|ruleset
argument_list|,
operator|&
name|ip6intrq
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
default|default:
name|action
operator|=
name|pf_test_state_other
argument_list|(
operator|&
name|s
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
operator|&
name|pd
argument_list|)
expr_stmt|;
if|if
condition|(
name|action
operator|==
name|PF_PASS
condition|)
block|{
if|#
directive|if
name|NPFSYNC
name|pfsync_update_state
argument_list|(
name|s
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* NPFSYNC */
name|r
operator|=
name|s
operator|->
name|rule
operator|.
name|ptr
expr_stmt|;
name|a
operator|=
name|s
operator|->
name|anchor
operator|.
name|ptr
expr_stmt|;
name|log
operator|=
name|s
operator|->
name|log
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
ifdef|#
directive|ifdef
name|__FreeBSD__
name|action
operator|=
name|pf_test_other
argument_list|(
operator|&
name|r
argument_list|,
operator|&
name|s
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|h
argument_list|,
operator|&
name|pd
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|ruleset
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|#
directive|else
name|action
operator|=
name|pf_test_other
argument_list|(
operator|&
name|r
argument_list|,
operator|&
name|s
argument_list|,
name|dir
argument_list|,
name|kif
argument_list|,
name|m
argument_list|,
name|off
argument_list|,
name|h
argument_list|,
operator|&
name|pd
argument_list|,
operator|&
name|a
argument_list|,
operator|&
name|ruleset
argument_list|,
operator|&
name|ip6intrq
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
block|}
name|done
label|:
comment|/* XXX handle IPv6 options, if not allowed. not implemented. */
if|if
condition|(
name|s
operator|&&
name|s
operator|->
name|tag
condition|)
name|pf_tag_packet
argument_list|(
name|m
argument_list|,
name|pf_get_tag
argument_list|(
name|m
argument_list|)
argument_list|,
name|s
operator|->
name|tag
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ALTQ
if|if
condition|(
name|action
operator|==
name|PF_PASS
operator|&&
name|r
operator|->
name|qid
condition|)
block|{
name|struct
name|m_tag
modifier|*
name|mtag
decl_stmt|;
name|struct
name|altq_tag
modifier|*
name|atag
decl_stmt|;
name|mtag
operator|=
name|m_tag_get
argument_list|(
name|PACKET_TAG_PF_QID
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|atag
argument_list|)
argument_list|,
name|M_NOWAIT
argument_list|)
expr_stmt|;
if|if
condition|(
name|mtag
operator|!=
name|NULL
condition|)
block|{
name|atag
operator|=
operator|(
expr|struct
name|altq_tag
operator|*
operator|)
operator|(
name|mtag
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|pd
operator|.
name|tos
operator|==
name|IPTOS_LOWDELAY
condition|)
name|atag
operator|->
name|qid
operator|=
name|r
operator|->
name|pqid
expr_stmt|;
else|else
name|atag
operator|->
name|qid
operator|=
name|r
operator|->
name|qid
expr_stmt|;
comment|/* add hints for ecn */
name|atag
operator|->
name|af
operator|=
name|AF_INET6
expr_stmt|;
name|atag
operator|->
name|hdr
operator|=
name|h
expr_stmt|;
name|m_tag_prepend
argument_list|(
name|m
argument_list|,
name|mtag
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* ALTQ */
if|if
condition|(
name|dir
operator|==
name|PF_IN
operator|&&
name|action
operator|==
name|PF_PASS
operator|&&
operator|(
name|pd
operator|.
name|proto
operator|==
name|IPPROTO_TCP
operator|||
name|pd
operator|.
name|proto
operator|==
name|IPPROTO_UDP
operator|)
operator|&&
name|s
operator|!=
name|NULL
operator|&&
name|s
operator|->
name|nat_rule
operator|.
name|ptr
operator|!=
name|NULL
operator|&&
operator|(
name|s
operator|->
name|nat_rule
operator|.
name|ptr
operator|->
name|action
operator|==
name|PF_RDR
operator|||
name|s
operator|->
name|nat_rule
operator|.
name|ptr
operator|->
name|action
operator|==
name|PF_BINAT
operator|)
operator|&&
name|IN6_IS_ADDR_LOOPBACK
argument_list|(
operator|&
name|pd
operator|.
name|dst
operator|->
name|v6
argument_list|)
operator|&&
name|pf_add_mbuf_tag
argument_list|(
name|m
argument_list|,
name|PACKET_TAG_PF_TRANSLATE_LOCALHOST
argument_list|)
condition|)
block|{
name|action
operator|=
name|PF_DROP
expr_stmt|;
name|REASON_SET
argument_list|(
operator|&
name|reason
argument_list|,
name|PFRES_MEMORY
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|log
condition|)
name|PFLOG_PACKET
argument_list|(
name|kif
argument_list|,
name|h
argument_list|,
name|m
argument_list|,
name|AF_INET6
argument_list|,
name|dir
argument_list|,
name|reason
argument_list|,
name|r
argument_list|,
name|a
argument_list|,
name|ruleset
argument_list|)
expr_stmt|;
name|kif
operator|->
name|pfik_bytes
index|[
literal|1
index|]
index|[
name|dir
operator|==
name|PF_OUT
index|]
index|[
name|action
operator|!=
name|PF_PASS
index|]
operator|+=
name|pd
operator|.
name|tot_len
expr_stmt|;
name|kif
operator|->
name|pfik_packets
index|[
literal|1
index|]
index|[
name|dir
operator|==
name|PF_OUT
index|]
index|[
name|action
operator|!=
name|PF_PASS
index|]
operator|++
expr_stmt|;
if|if
condition|(
name|action
operator|==
name|PF_PASS
operator|||
name|r
operator|->
name|action
operator|==
name|PF_DROP
condition|)
block|{
name|r
operator|->
name|packets
operator|++
expr_stmt|;
name|r
operator|->
name|bytes
operator|+=
name|pd
operator|.
name|tot_len
expr_stmt|;
if|if
condition|(
name|a
operator|!=
name|NULL
condition|)
block|{
name|a
operator|->
name|packets
operator|++
expr_stmt|;
name|a
operator|->
name|bytes
operator|+=
name|pd
operator|.
name|tot_len
expr_stmt|;
block|}
if|if
condition|(
name|s
operator|!=
name|NULL
condition|)
block|{
name|dirndx
operator|=
operator|(
name|dir
operator|==
name|s
operator|->
name|direction
operator|)
condition|?
literal|0
else|:
literal|1
expr_stmt|;
name|s
operator|->
name|packets
index|[
name|dirndx
index|]
operator|++
expr_stmt|;
name|s
operator|->
name|bytes
index|[
name|dirndx
index|]
operator|+=
name|pd
operator|.
name|tot_len
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|nat_rule
operator|.
name|ptr
operator|!=
name|NULL
condition|)
block|{
name|s
operator|->
name|nat_rule
operator|.
name|ptr
operator|->
name|packets
operator|++
expr_stmt|;
name|s
operator|->
name|nat_rule
operator|.
name|ptr
operator|->
name|bytes
operator|+=
name|pd
operator|.
name|tot_len
expr_stmt|;
block|}
if|if
condition|(
name|s
operator|->
name|src_node
operator|!=
name|NULL
condition|)
block|{
name|s
operator|->
name|src_node
operator|->
name|packets
operator|++
expr_stmt|;
name|s
operator|->
name|src_node
operator|->
name|bytes
operator|+=
name|pd
operator|.
name|tot_len
expr_stmt|;
block|}
if|if
condition|(
name|s
operator|->
name|nat_src_node
operator|!=
name|NULL
condition|)
block|{
name|s
operator|->
name|nat_src_node
operator|->
name|packets
operator|++
expr_stmt|;
name|s
operator|->
name|nat_src_node
operator|->
name|bytes
operator|+=
name|pd
operator|.
name|tot_len
expr_stmt|;
block|}
block|}
name|tr
operator|=
name|r
expr_stmt|;
name|nr
operator|=
operator|(
name|s
operator|!=
name|NULL
operator|)
condition|?
name|s
operator|->
name|nat_rule
operator|.
name|ptr
else|:
name|pd
operator|.
name|nat_rule
expr_stmt|;
if|if
condition|(
name|nr
operator|!=
name|NULL
condition|)
block|{
name|struct
name|pf_addr
modifier|*
name|x
decl_stmt|;
comment|/* 			 * XXX: we need to make sure that the addresses 			 * passed to pfr_update_stats() are the same than 			 * the addresses used during matching (pfr_match) 			 */
if|if
condition|(
name|r
operator|==
operator|&
name|pf_default_rule
condition|)
block|{
name|tr
operator|=
name|nr
expr_stmt|;
name|x
operator|=
operator|(
name|s
operator|==
name|NULL
operator|||
name|s
operator|->
name|direction
operator|==
name|dir
operator|)
condition|?
operator|&
name|pd
operator|.
name|baddr
else|:
operator|&
name|pd
operator|.
name|naddr
expr_stmt|;
block|}
else|else
block|{
name|x
operator|=
operator|(
name|s
operator|==
name|NULL
operator|||
name|s
operator|->
name|direction
operator|==
name|dir
operator|)
condition|?
operator|&
name|pd
operator|.
name|naddr
else|:
operator|&
name|pd
operator|.
name|baddr
expr_stmt|;
block|}
if|if
condition|(
name|x
operator|==
operator|&
name|pd
operator|.
name|baddr
operator|||
name|s
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|dir
operator|==
name|PF_OUT
condition|)
name|pd
operator|.
name|src
operator|=
name|x
expr_stmt|;
else|else
name|pd
operator|.
name|dst
operator|=
name|x
expr_stmt|;
block|}
block|}
if|if
condition|(
name|tr
operator|->
name|src
operator|.
name|addr
operator|.
name|type
operator|==
name|PF_ADDR_TABLE
condition|)
name|pfr_update_stats
argument_list|(
name|tr
operator|->
name|src
operator|.
name|addr
operator|.
name|p
operator|.
name|tbl
argument_list|,
operator|(
name|s
operator|==
name|NULL
operator|||
name|s
operator|->
name|direction
operator|==
name|dir
operator|)
condition|?
name|pd
operator|.
name|src
else|:
name|pd
operator|.
name|dst
argument_list|,
name|pd
operator|.
name|af
argument_list|,
name|pd
operator|.
name|tot_len
argument_list|,
name|dir
operator|==
name|PF_OUT
argument_list|,
name|r
operator|->
name|action
operator|==
name|PF_PASS
argument_list|,
name|tr
operator|->
name|src
operator|.
name|neg
argument_list|)
expr_stmt|;
if|if
condition|(
name|tr
operator|->
name|dst
operator|.
name|addr
operator|.
name|type
operator|==
name|PF_ADDR_TABLE
condition|)
name|pfr_update_stats
argument_list|(
name|tr
operator|->
name|dst
operator|.
name|addr
operator|.
name|p
operator|.
name|tbl
argument_list|,
operator|(
name|s
operator|==
name|NULL
operator|||
name|s
operator|->
name|direction
operator|==
name|dir
operator|)
condition|?
name|pd
operator|.
name|dst
else|:
name|pd
operator|.
name|src
argument_list|,
name|pd
operator|.
name|af
argument_list|,
name|pd
operator|.
name|tot_len
argument_list|,
name|dir
operator|==
name|PF_OUT
argument_list|,
name|r
operator|->
name|action
operator|==
name|PF_PASS
argument_list|,
name|tr
operator|->
name|dst
operator|.
name|neg
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|action
operator|==
name|PF_SYNPROXY_DROP
condition|)
block|{
name|m_freem
argument_list|(
operator|*
name|m0
argument_list|)
expr_stmt|;
operator|*
name|m0
operator|=
name|NULL
expr_stmt|;
name|action
operator|=
name|PF_PASS
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|r
operator|->
name|rt
condition|)
comment|/* pf_route6 can free the mbuf causing *m0 to become NULL */
name|pf_route6
argument_list|(
name|m0
argument_list|,
name|r
argument_list|,
name|dir
argument_list|,
name|ifp
argument_list|,
name|s
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
name|PF_UNLOCK
argument_list|()
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|action
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* INET6 */
end_comment

begin_function
name|int
name|pf_check_congestion
parameter_list|(
name|struct
name|ifqueue
modifier|*
name|ifq
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|__FreeBSD__
comment|/* XXX_IMPORT: later */
return|return
operator|(
literal|0
operator|)
return|;
else|#
directive|else
if|if
condition|(
name|ifq
operator|->
name|ifq_congestion
condition|)
return|return
operator|(
literal|1
operator|)
return|;
else|else
return|return
operator|(
literal|0
operator|)
return|;
endif|#
directive|endif
block|}
end_function

end_unit


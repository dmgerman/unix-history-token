begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*- ******************************************************************************* Copyright (C) 2015 Annapurna Labs Ltd.  This file may be licensed under the terms of the Annapurna Labs Commercial License Agreement.  Alternatively, this file can be distributed under the terms of the GNU General Public License V2 as published by the Free Software Foundation and can be found at http://www.gnu.org/licenses/gpl-2.0.html  Alternatively, redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:      *     Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.      *     Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *******************************************************************************/
end_comment

begin_comment
comment|/**  * @file   al_hal_udma_config.c  *  * @brief  Universal DMA HAL driver for configurations  *  */
end_comment

begin_include
include|#
directive|include
file|<al_hal_common.h>
end_include

begin_include
include|#
directive|include
file|<al_hal_udma_regs.h>
end_include

begin_include
include|#
directive|include
file|<al_hal_udma_config.h>
end_include

begin_comment
comment|/**************** Misc configurations *********************/
end_comment

begin_comment
comment|/** Configure AXI generic configuration */
end_comment

begin_function
name|int
name|al_udma_axi_set
parameter_list|(
name|struct
name|udma_gen_axi
modifier|*
name|axi_regs
parameter_list|,
name|struct
name|al_udma_axi_conf
modifier|*
name|axi
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|axi_regs
operator|->
name|cfg_1
argument_list|,
name|axi
operator|->
name|axi_timeout
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|axi_regs
operator|->
name|cfg_2
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_GEN_AXI_CFG_2_ARB_PROMOTION_MASK
expr_stmt|;
name|reg
operator||=
name|axi
operator|->
name|arb_promotion
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|axi_regs
operator|->
name|cfg_2
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|axi_regs
operator|->
name|endian_cfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|axi
operator|->
name|swap_8_bytes
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_GEN_AXI_ENDIAN_CFG_SWAP_64B_EN
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_GEN_AXI_ENDIAN_CFG_SWAP_64B_EN
expr_stmt|;
if|if
condition|(
name|axi
operator|->
name|swap_s2m_data
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_GEN_AXI_ENDIAN_CFG_SWAP_S2M_DATA
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_GEN_AXI_ENDIAN_CFG_SWAP_S2M_DATA
expr_stmt|;
if|if
condition|(
name|axi
operator|->
name|swap_s2m_desc
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_GEN_AXI_ENDIAN_CFG_SWAP_S2M_DESC
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_GEN_AXI_ENDIAN_CFG_SWAP_S2M_DESC
expr_stmt|;
if|if
condition|(
name|axi
operator|->
name|swap_m2s_data
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_GEN_AXI_ENDIAN_CFG_SWAP_M2S_DATA
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_GEN_AXI_ENDIAN_CFG_SWAP_M2S_DATA
expr_stmt|;
if|if
condition|(
name|axi
operator|->
name|swap_m2s_desc
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_GEN_AXI_ENDIAN_CFG_SWAP_M2S_DESC
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_GEN_AXI_ENDIAN_CFG_SWAP_M2S_DESC
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|axi_regs
operator|->
name|endian_cfg
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Configure UDMA AXI M2S configuration */
end_comment

begin_comment
comment|/** Configure AXI M2S submaster */
end_comment

begin_function
specifier|static
name|int
name|al_udma_m2s_axi_sm_set
parameter_list|(
name|struct
name|al_udma_axi_submaster
modifier|*
name|m2s_sm
parameter_list|,
name|uint32_t
modifier|*
name|cfg_1
parameter_list|,
name|uint32_t
modifier|*
name|cfg_2
parameter_list|,
name|uint32_t
modifier|*
name|cfg_max_beats
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
name|cfg_1
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_M2S_COMP_WR_CFG_1_AWID_MASK
expr_stmt|;
name|reg
operator||=
name|m2s_sm
operator|->
name|id
operator|&
name|UDMA_AXI_M2S_COMP_WR_CFG_1_AWID_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_M2S_COMP_WR_CFG_1_AWCACHE_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|m2s_sm
operator|->
name|cache_type
operator|<<
name|UDMA_AXI_M2S_COMP_WR_CFG_1_AWCACHE_SHIFT
operator|)
operator|&
name|UDMA_AXI_M2S_COMP_WR_CFG_1_AWCACHE_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_M2S_COMP_WR_CFG_1_AWBURST_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|m2s_sm
operator|->
name|burst
operator|<<
name|UDMA_AXI_M2S_COMP_WR_CFG_1_AWBURST_SHIFT
operator|)
operator|&
name|UDMA_AXI_M2S_COMP_WR_CFG_1_AWBURST_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
name|cfg_1
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
name|cfg_2
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_M2S_COMP_WR_CFG_2_AWUSER_MASK
expr_stmt|;
name|reg
operator||=
name|m2s_sm
operator|->
name|used_ext
operator|&
name|UDMA_AXI_M2S_COMP_WR_CFG_2_AWUSER_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_M2S_COMP_WR_CFG_2_AWSIZE_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|m2s_sm
operator|->
name|bus_size
operator|<<
name|UDMA_AXI_M2S_COMP_WR_CFG_2_AWSIZE_SHIFT
operator|)
operator|&
name|UDMA_AXI_M2S_COMP_WR_CFG_2_AWSIZE_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_M2S_COMP_WR_CFG_2_AWQOS_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|m2s_sm
operator|->
name|qos
operator|<<
name|UDMA_AXI_M2S_COMP_WR_CFG_2_AWQOS_SHIFT
operator|)
operator|&
name|UDMA_AXI_M2S_COMP_WR_CFG_2_AWQOS_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_M2S_COMP_WR_CFG_2_AWPROT_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|m2s_sm
operator|->
name|prot
operator|<<
name|UDMA_AXI_M2S_COMP_WR_CFG_2_AWPROT_SHIFT
operator|)
operator|&
name|UDMA_AXI_M2S_COMP_WR_CFG_2_AWPROT_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
name|cfg_2
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
name|cfg_max_beats
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_M2S_DESC_WR_CFG_1_MAX_AXI_BEATS_MASK
expr_stmt|;
name|reg
operator||=
name|m2s_sm
operator|->
name|max_beats
operator|&
name|UDMA_AXI_M2S_DESC_WR_CFG_1_MAX_AXI_BEATS_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
name|cfg_max_beats
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** Configure UDMA AXI M2S configuration */
end_comment

begin_function
name|int
name|al_udma_m2s_axi_set
parameter_list|(
name|struct
name|al_udma
modifier|*
name|udma
parameter_list|,
name|struct
name|al_udma_m2s_axi_conf
modifier|*
name|axi_m2s
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|al_udma_m2s_axi_sm_set
argument_list|(
operator|&
name|axi_m2s
operator|->
name|comp_write
argument_list|,
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|axi_m2s
operator|.
name|comp_wr_cfg_1
argument_list|,
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|axi_m2s
operator|.
name|comp_wr_cfg_2
argument_list|,
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|axi_m2s
operator|.
name|desc_wr_cfg_1
argument_list|)
expr_stmt|;
name|al_udma_m2s_axi_sm_set
argument_list|(
operator|&
name|axi_m2s
operator|->
name|data_read
argument_list|,
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|axi_m2s
operator|.
name|data_rd_cfg_1
argument_list|,
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|axi_m2s
operator|.
name|data_rd_cfg_2
argument_list|,
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|axi_m2s
operator|.
name|data_rd_cfg
argument_list|)
expr_stmt|;
name|al_udma_m2s_axi_sm_set
argument_list|(
operator|&
name|axi_m2s
operator|->
name|desc_read
argument_list|,
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|axi_m2s
operator|.
name|desc_rd_cfg_1
argument_list|,
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|axi_m2s
operator|.
name|desc_rd_cfg_2
argument_list|,
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|axi_m2s
operator|.
name|desc_rd_cfg_3
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|axi_m2s
operator|.
name|data_rd_cfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|axi_m2s
operator|->
name|break_on_max_boundary
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_AXI_M2S_DATA_RD_CFG_ALWAYS_BREAK_ON_MAX_BOUDRY
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_AXI_M2S_DATA_RD_CFG_ALWAYS_BREAK_ON_MAX_BOUDRY
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|axi_m2s
operator|.
name|data_rd_cfg
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|axi_m2s
operator|.
name|desc_wr_cfg_1
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_M2S_DESC_WR_CFG_1_MIN_AXI_BEATS_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|axi_m2s
operator|->
name|min_axi_beats
operator|<<
name|UDMA_AXI_M2S_DESC_WR_CFG_1_MIN_AXI_BEATS_SHIFT
operator|)
operator|&
name|UDMA_AXI_M2S_DESC_WR_CFG_1_MIN_AXI_BEATS_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|axi_m2s
operator|.
name|desc_wr_cfg_1
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|axi_m2s
operator|.
name|ostand_cfg
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_M2S_OSTAND_CFG_MAX_DATA_RD_MASK
expr_stmt|;
name|reg
operator||=
name|axi_m2s
operator|->
name|ostand_max_data_read
operator|&
name|UDMA_AXI_M2S_OSTAND_CFG_MAX_DATA_RD_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_M2S_OSTAND_CFG_MAX_DESC_RD_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|axi_m2s
operator|->
name|ostand_max_desc_read
operator|<<
name|UDMA_AXI_M2S_OSTAND_CFG_MAX_DESC_RD_SHIFT
operator|)
operator|&
name|UDMA_AXI_M2S_OSTAND_CFG_MAX_DESC_RD_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_M2S_OSTAND_CFG_MAX_COMP_REQ_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|axi_m2s
operator|->
name|ostand_max_comp_req
operator|<<
name|UDMA_AXI_M2S_OSTAND_CFG_MAX_COMP_REQ_SHIFT
operator|)
operator|&
name|UDMA_AXI_M2S_OSTAND_CFG_MAX_COMP_REQ_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_M2S_OSTAND_CFG_MAX_COMP_DATA_WR_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|axi_m2s
operator|->
name|ostand_max_comp_write
operator|<<
name|UDMA_AXI_M2S_OSTAND_CFG_MAX_COMP_DATA_WR_SHIFT
operator|)
operator|&
name|UDMA_AXI_M2S_OSTAND_CFG_MAX_COMP_DATA_WR_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|axi_m2s
operator|.
name|ostand_cfg
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** Configure AXI S2M submaster */
end_comment

begin_function
specifier|static
name|int
name|al_udma_s2m_axi_sm_set
parameter_list|(
name|struct
name|al_udma_axi_submaster
modifier|*
name|s2m_sm
parameter_list|,
name|uint32_t
modifier|*
name|cfg_1
parameter_list|,
name|uint32_t
modifier|*
name|cfg_2
parameter_list|,
name|uint32_t
modifier|*
name|cfg_max_beats
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
name|cfg_1
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_S2M_COMP_WR_CFG_1_AWID_MASK
expr_stmt|;
name|reg
operator||=
name|s2m_sm
operator|->
name|id
operator|&
name|UDMA_AXI_S2M_COMP_WR_CFG_1_AWID_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_S2M_COMP_WR_CFG_1_AWCACHE_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|s2m_sm
operator|->
name|cache_type
operator|<<
name|UDMA_AXI_S2M_COMP_WR_CFG_1_AWCACHE_SHIFT
operator|)
operator|&
name|UDMA_AXI_S2M_COMP_WR_CFG_1_AWCACHE_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_S2M_COMP_WR_CFG_1_AWBURST_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|s2m_sm
operator|->
name|burst
operator|<<
name|UDMA_AXI_S2M_COMP_WR_CFG_1_AWBURST_SHIFT
operator|)
operator|&
name|UDMA_AXI_S2M_COMP_WR_CFG_1_AWBURST_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
name|cfg_1
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
name|cfg_2
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_S2M_COMP_WR_CFG_2_AWUSER_MASK
expr_stmt|;
name|reg
operator||=
name|s2m_sm
operator|->
name|used_ext
operator|&
name|UDMA_AXI_S2M_COMP_WR_CFG_2_AWUSER_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_S2M_COMP_WR_CFG_2_AWSIZE_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|s2m_sm
operator|->
name|bus_size
operator|<<
name|UDMA_AXI_S2M_COMP_WR_CFG_2_AWSIZE_SHIFT
operator|)
operator|&
name|UDMA_AXI_S2M_COMP_WR_CFG_2_AWSIZE_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_S2M_COMP_WR_CFG_2_AWQOS_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|s2m_sm
operator|->
name|qos
operator|<<
name|UDMA_AXI_S2M_COMP_WR_CFG_2_AWQOS_SHIFT
operator|)
operator|&
name|UDMA_AXI_S2M_COMP_WR_CFG_2_AWQOS_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_S2M_COMP_WR_CFG_2_AWPROT_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|s2m_sm
operator|->
name|prot
operator|<<
name|UDMA_AXI_S2M_COMP_WR_CFG_2_AWPROT_SHIFT
operator|)
operator|&
name|UDMA_AXI_S2M_COMP_WR_CFG_2_AWPROT_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
name|cfg_2
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
name|cfg_max_beats
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_S2M_DESC_WR_CFG_1_MAX_AXI_BEATS_MASK
expr_stmt|;
name|reg
operator||=
name|s2m_sm
operator|->
name|max_beats
operator|&
name|UDMA_AXI_S2M_DESC_WR_CFG_1_MAX_AXI_BEATS_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
name|cfg_max_beats
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** Configure UDMA AXI S2M configuration */
end_comment

begin_function
name|int
name|al_udma_s2m_axi_set
parameter_list|(
name|struct
name|al_udma
modifier|*
name|udma
parameter_list|,
name|struct
name|al_udma_s2m_axi_conf
modifier|*
name|axi_s2m
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|al_udma_s2m_axi_sm_set
argument_list|(
operator|&
name|axi_s2m
operator|->
name|data_write
argument_list|,
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|axi_s2m
operator|.
name|data_wr_cfg_1
argument_list|,
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|axi_s2m
operator|.
name|data_wr_cfg_2
argument_list|,
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|axi_s2m
operator|.
name|data_wr_cfg
argument_list|)
expr_stmt|;
name|al_udma_s2m_axi_sm_set
argument_list|(
operator|&
name|axi_s2m
operator|->
name|desc_read
argument_list|,
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|axi_s2m
operator|.
name|desc_rd_cfg_4
argument_list|,
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|axi_s2m
operator|.
name|desc_rd_cfg_5
argument_list|,
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|axi_s2m
operator|.
name|desc_rd_cfg_3
argument_list|)
expr_stmt|;
name|al_udma_s2m_axi_sm_set
argument_list|(
operator|&
name|axi_s2m
operator|->
name|comp_write
argument_list|,
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|axi_s2m
operator|.
name|comp_wr_cfg_1
argument_list|,
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|axi_s2m
operator|.
name|comp_wr_cfg_2
argument_list|,
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|axi_s2m
operator|.
name|desc_wr_cfg_1
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|axi_s2m
operator|.
name|desc_rd_cfg_3
argument_list|)
expr_stmt|;
if|if
condition|(
name|axi_s2m
operator|->
name|break_on_max_boundary
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_AXI_S2M_DESC_RD_CFG_3_ALWAYS_BREAK_ON_MAX_BOUDRY
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_AXI_S2M_DESC_RD_CFG_3_ALWAYS_BREAK_ON_MAX_BOUDRY
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|axi_s2m
operator|.
name|desc_rd_cfg_3
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|axi_s2m
operator|.
name|desc_wr_cfg_1
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_S2M_DESC_WR_CFG_1_MIN_AXI_BEATS_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|axi_s2m
operator|->
name|min_axi_beats
operator|<<
name|UDMA_AXI_S2M_DESC_WR_CFG_1_MIN_AXI_BEATS_SHIFT
operator|)
operator|&
name|UDMA_AXI_S2M_DESC_WR_CFG_1_MIN_AXI_BEATS_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|axi_s2m
operator|.
name|desc_wr_cfg_1
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|axi_s2m
operator|.
name|ostand_cfg_rd
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_S2M_OSTAND_CFG_RD_MAX_DESC_RD_OSTAND_MASK
expr_stmt|;
name|reg
operator||=
name|axi_s2m
operator|->
name|ostand_max_desc_read
operator|&
name|UDMA_AXI_S2M_OSTAND_CFG_RD_MAX_DESC_RD_OSTAND_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_S2M_OSTAND_CFG_RD_MAX_STREAM_ACK_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|axi_s2m
operator|->
name|ack_fifo_depth
operator|<<
name|UDMA_AXI_S2M_OSTAND_CFG_RD_MAX_STREAM_ACK_SHIFT
operator|)
operator|&
name|UDMA_AXI_S2M_OSTAND_CFG_RD_MAX_STREAM_ACK_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|axi_s2m
operator|.
name|ostand_cfg_rd
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|axi_s2m
operator|.
name|ostand_cfg_wr
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_S2M_OSTAND_CFG_WR_MAX_DATA_WR_OSTAND_MASK
expr_stmt|;
name|reg
operator||=
name|axi_s2m
operator|->
name|ostand_max_data_req
operator|&
name|UDMA_AXI_S2M_OSTAND_CFG_WR_MAX_DATA_WR_OSTAND_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_S2M_OSTAND_CFG_WR_MAX_DATA_BEATS_WR_OSTAND_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|axi_s2m
operator|->
name|ostand_max_data_write
operator|<<
name|UDMA_AXI_S2M_OSTAND_CFG_WR_MAX_DATA_BEATS_WR_OSTAND_SHIFT
operator|)
operator|&
name|UDMA_AXI_S2M_OSTAND_CFG_WR_MAX_DATA_BEATS_WR_OSTAND_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_S2M_OSTAND_CFG_WR_MAX_COMP_REQ_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|axi_s2m
operator|->
name|ostand_max_comp_req
operator|<<
name|UDMA_AXI_S2M_OSTAND_CFG_WR_MAX_COMP_REQ_SHIFT
operator|)
operator|&
name|UDMA_AXI_S2M_OSTAND_CFG_WR_MAX_COMP_REQ_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_AXI_S2M_OSTAND_CFG_WR_MAX_COMP_DATA_WR_OSTAND_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|axi_s2m
operator|->
name|ostand_max_comp_write
operator|<<
name|UDMA_AXI_S2M_OSTAND_CFG_WR_MAX_COMP_DATA_WR_OSTAND_SHIFT
operator|)
operator|&
name|UDMA_AXI_S2M_OSTAND_CFG_WR_MAX_COMP_DATA_WR_OSTAND_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|axi_s2m
operator|.
name|ostand_cfg_wr
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** M2S packet len configuration */
end_comment

begin_function
name|int
name|al_udma_m2s_packet_size_cfg_set
parameter_list|(
name|struct
name|al_udma
modifier|*
name|udma
parameter_list|,
name|struct
name|al_udma_m2s_pkt_len_conf
modifier|*
name|conf
parameter_list|)
block|{
name|uint32_t
name|reg
init|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s
operator|.
name|cfg_len
argument_list|)
decl_stmt|;
name|uint32_t
name|max_supported_size
init|=
name|UDMA_M2S_CFG_LEN_MAX_PKT_SIZE_MASK
decl_stmt|;
name|al_assert
argument_list|(
name|udma
operator|->
name|type
operator|==
name|UDMA_TX
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|encode_64k_as_zero
operator|==
name|AL_TRUE
condition|)
name|max_supported_size
operator|+=
literal|1
expr_stmt|;
comment|/* 64K */
if|if
condition|(
name|conf
operator|->
name|max_pkt_size
operator|>
name|max_supported_size
condition|)
block|{
name|al_err
argument_list|(
literal|"udma [%s]: requested max_pkt_size (0x%x) exceeds the"
literal|"supported limit (0x%x)\n"
argument_list|,
name|udma
operator|->
name|name
argument_list|,
name|conf
operator|->
name|max_pkt_size
argument_list|,
name|max_supported_size
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|reg
operator|&=
operator|~
name|UDMA_M2S_CFG_LEN_ENCODE_64K
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|encode_64k_as_zero
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_M2S_CFG_LEN_ENCODE_64K
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_M2S_CFG_LEN_ENCODE_64K
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_M2S_CFG_LEN_MAX_PKT_SIZE_MASK
expr_stmt|;
name|reg
operator||=
name|conf
operator|->
name|max_pkt_size
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s
operator|.
name|cfg_len
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** Report Error - to be used for abort */
end_comment

begin_decl_stmt
name|void
name|al_udma_err_report
argument_list|(
expr|struct
name|al_udma
operator|*
name|udma
name|__attribute__
argument_list|(
operator|(
name|__unused__
operator|)
argument_list|)
argument_list|)
block|{
return|return;
block|}
end_decl_stmt

begin_comment
comment|/** Statistics - TBD */
end_comment

begin_decl_stmt
name|void
name|al_udma_stats_get
argument_list|(
expr|struct
name|al_udma
operator|*
name|udma
name|__attribute__
argument_list|(
operator|(
name|__unused__
operator|)
argument_list|)
argument_list|)
block|{
return|return;
block|}
end_decl_stmt

begin_comment
comment|/** Configure UDMA M2S descriptor prefetch */
end_comment

begin_function
name|int
name|al_udma_m2s_pref_set
parameter_list|(
name|struct
name|al_udma
modifier|*
name|udma
parameter_list|,
name|struct
name|al_udma_m2s_desc_pref_conf
modifier|*
name|conf
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_rd
operator|.
name|desc_pref_cfg_1
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_M2S_RD_DESC_PREF_CFG_1_FIFO_DEPTH_MASK
expr_stmt|;
name|reg
operator||=
name|conf
operator|->
name|desc_fifo_depth
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_rd
operator|.
name|desc_pref_cfg_1
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_rd
operator|.
name|desc_pref_cfg_2
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|sch_mode
operator|==
name|SRR
condition|)
name|reg
operator||=
name|UDMA_M2S_RD_DESC_PREF_CFG_2_PREF_FORCE_RR
expr_stmt|;
elseif|else
if|if
condition|(
name|conf
operator|->
name|sch_mode
operator|==
name|STRICT
condition|)
name|reg
operator|&=
operator|~
name|UDMA_M2S_RD_DESC_PREF_CFG_2_PREF_FORCE_RR
expr_stmt|;
else|else
block|{
name|al_err
argument_list|(
literal|"udma [%s]: requested descriptor preferch arbiter "
literal|"mode (%d) is invalid\n"
argument_list|,
name|udma
operator|->
name|name
argument_list|,
name|conf
operator|->
name|sch_mode
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|reg
operator|&=
operator|~
name|UDMA_M2S_RD_DESC_PREF_CFG_2_MAX_DESC_PER_PKT_MASK
expr_stmt|;
name|reg
operator||=
name|conf
operator|->
name|max_desc_per_packet
operator|&
name|UDMA_M2S_RD_DESC_PREF_CFG_2_MAX_DESC_PER_PKT_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_rd
operator|.
name|desc_pref_cfg_2
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_rd
operator|.
name|desc_pref_cfg_3
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_M2S_RD_DESC_PREF_CFG_3_MIN_BURST_BELOW_THR_MASK
expr_stmt|;
name|reg
operator||=
name|conf
operator|->
name|min_burst_below_thr
operator|&
name|UDMA_M2S_RD_DESC_PREF_CFG_3_MIN_BURST_BELOW_THR_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_M2S_RD_DESC_PREF_CFG_3_MIN_BURST_ABOVE_THR_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|conf
operator|->
name|min_burst_above_thr
operator|<<
name|UDMA_M2S_RD_DESC_PREF_CFG_3_MIN_BURST_ABOVE_THR_SHIFT
operator|)
operator|&
name|UDMA_M2S_RD_DESC_PREF_CFG_3_MIN_BURST_ABOVE_THR_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_M2S_RD_DESC_PREF_CFG_3_PREF_THR_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|conf
operator|->
name|pref_thr
operator|<<
name|UDMA_M2S_RD_DESC_PREF_CFG_3_PREF_THR_SHIFT
operator|)
operator|&
name|UDMA_M2S_RD_DESC_PREF_CFG_3_PREF_THR_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_rd
operator|.
name|desc_pref_cfg_3
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_rd
operator|.
name|data_cfg
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_M2S_RD_DATA_CFG_DATA_FIFO_DEPTH_MASK
expr_stmt|;
name|reg
operator||=
name|conf
operator|->
name|data_fifo_depth
operator|&
name|UDMA_M2S_RD_DATA_CFG_DATA_FIFO_DEPTH_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_M2S_RD_DATA_CFG_MAX_PKT_LIMIT_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|conf
operator|->
name|max_pkt_limit
operator|<<
name|UDMA_M2S_RD_DATA_CFG_MAX_PKT_LIMIT_SHIFT
operator|)
operator|&
name|UDMA_M2S_RD_DATA_CFG_MAX_PKT_LIMIT_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_rd
operator|.
name|data_cfg
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** Ger the M2S UDMA descriptor prefetch */
end_comment

begin_function
name|int
name|al_udma_m2s_pref_get
parameter_list|(
name|struct
name|al_udma
modifier|*
name|udma
parameter_list|,
name|struct
name|al_udma_m2s_desc_pref_conf
modifier|*
name|conf
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_rd
operator|.
name|desc_pref_cfg_1
argument_list|)
expr_stmt|;
name|conf
operator|->
name|desc_fifo_depth
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|UDMA_M2S_RD_DESC_PREF_CFG_1_FIFO_DEPTH_MASK
argument_list|,
name|UDMA_M2S_RD_DESC_PREF_CFG_1_FIFO_DEPTH_SHIFT
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_rd
operator|.
name|desc_pref_cfg_2
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|UDMA_M2S_RD_DESC_PREF_CFG_2_MAX_DESC_PER_PKT_MASK
condition|)
name|conf
operator|->
name|sch_mode
operator|=
name|SRR
expr_stmt|;
else|else
name|conf
operator|->
name|sch_mode
operator|=
name|STRICT
expr_stmt|;
name|conf
operator|->
name|max_desc_per_packet
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|UDMA_M2S_RD_DESC_PREF_CFG_2_MAX_DESC_PER_PKT_MASK
argument_list|,
name|UDMA_M2S_RD_DESC_PREF_CFG_2_MAX_DESC_PER_PKT_SHIFT
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_rd
operator|.
name|desc_pref_cfg_3
argument_list|)
expr_stmt|;
name|conf
operator|->
name|min_burst_below_thr
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|UDMA_M2S_RD_DESC_PREF_CFG_3_MIN_BURST_BELOW_THR_MASK
argument_list|,
name|UDMA_M2S_RD_DESC_PREF_CFG_3_MIN_BURST_BELOW_THR_SHIFT
argument_list|)
expr_stmt|;
name|conf
operator|->
name|min_burst_above_thr
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|UDMA_M2S_RD_DESC_PREF_CFG_3_MIN_BURST_ABOVE_THR_MASK
argument_list|,
name|UDMA_M2S_RD_DESC_PREF_CFG_3_MIN_BURST_ABOVE_THR_SHIFT
argument_list|)
expr_stmt|;
name|conf
operator|->
name|pref_thr
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|UDMA_M2S_RD_DESC_PREF_CFG_3_PREF_THR_MASK
argument_list|,
name|UDMA_M2S_RD_DESC_PREF_CFG_3_PREF_THR_SHIFT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* set max descriptors */
end_comment

begin_function
name|int
name|al_udma_m2s_max_descs_set
parameter_list|(
name|struct
name|al_udma
modifier|*
name|udma
parameter_list|,
name|uint8_t
name|max_descs
parameter_list|)
block|{
name|uint32_t
name|pref_thr
init|=
name|max_descs
decl_stmt|;
name|uint32_t
name|min_burst_above_thr
init|=
literal|4
decl_stmt|;
name|al_assert
argument_list|(
name|max_descs
operator|<=
name|AL_UDMA_M2S_MAX_ALLOWED_DESCS_PER_PACKET
argument_list|)
expr_stmt|;
name|al_assert
argument_list|(
name|max_descs
operator|>
literal|0
argument_list|)
expr_stmt|;
comment|/* increase min_burst_above_thr so larger burst can be used to fetch 	 * descriptors */
if|if
condition|(
name|pref_thr
operator|>=
literal|8
condition|)
name|min_burst_above_thr
operator|=
literal|8
expr_stmt|;
else|else
block|{
comment|/* don't set prefetch threshold too low so we can have the 	 * min_burst_above_thr>= 4 */
name|pref_thr
operator|=
literal|4
expr_stmt|;
block|}
name|al_reg_write32_masked
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_rd
operator|.
name|desc_pref_cfg_2
argument_list|,
name|UDMA_M2S_RD_DESC_PREF_CFG_2_MAX_DESC_PER_PKT_MASK
argument_list|,
name|max_descs
operator|<<
name|UDMA_M2S_RD_DESC_PREF_CFG_2_MAX_DESC_PER_PKT_SHIFT
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_rd
operator|.
name|desc_pref_cfg_3
argument_list|,
name|UDMA_M2S_RD_DESC_PREF_CFG_3_PREF_THR_MASK
operator||
name|UDMA_M2S_RD_DESC_PREF_CFG_3_MIN_BURST_ABOVE_THR_MASK
argument_list|,
operator|(
name|pref_thr
operator|<<
name|UDMA_M2S_RD_DESC_PREF_CFG_3_PREF_THR_SHIFT
operator|)
operator||
operator|(
name|min_burst_above_thr
operator|<<
name|UDMA_M2S_RD_DESC_PREF_CFG_3_MIN_BURST_ABOVE_THR_SHIFT
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* set s2m max descriptors */
end_comment

begin_function
name|int
name|al_udma_s2m_max_descs_set
parameter_list|(
name|struct
name|al_udma
modifier|*
name|udma
parameter_list|,
name|uint8_t
name|max_descs
parameter_list|)
block|{
name|uint32_t
name|pref_thr
init|=
name|max_descs
decl_stmt|;
name|uint32_t
name|min_burst_above_thr
init|=
literal|4
decl_stmt|;
name|al_assert
argument_list|(
name|max_descs
operator|<=
name|AL_UDMA_S2M_MAX_ALLOWED_DESCS_PER_PACKET
argument_list|)
expr_stmt|;
name|al_assert
argument_list|(
name|max_descs
operator|>
literal|0
argument_list|)
expr_stmt|;
comment|/* increase min_burst_above_thr so larger burst can be used to fetch 	 * descriptors */
if|if
condition|(
name|pref_thr
operator|>=
literal|8
condition|)
name|min_burst_above_thr
operator|=
literal|8
expr_stmt|;
else|else
comment|/* don't set prefetch threshold too low so we can have the 	 * min_burst_above_thr>= 4 */
name|pref_thr
operator|=
literal|4
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|s2m_rd
operator|.
name|desc_pref_cfg_3
argument_list|,
name|UDMA_S2M_RD_DESC_PREF_CFG_3_PREF_THR_MASK
operator||
name|UDMA_S2M_RD_DESC_PREF_CFG_3_MIN_BURST_ABOVE_THR_MASK
argument_list|,
operator|(
name|pref_thr
operator|<<
name|UDMA_S2M_RD_DESC_PREF_CFG_3_PREF_THR_SHIFT
operator|)
operator||
operator|(
name|min_burst_above_thr
operator|<<
name|UDMA_S2M_RD_DESC_PREF_CFG_3_MIN_BURST_ABOVE_THR_SHIFT
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_udma_s2m_full_line_write_set
parameter_list|(
name|struct
name|al_udma
modifier|*
name|udma
parameter_list|,
name|al_bool
name|enable
parameter_list|)
block|{
name|uint32_t
name|val
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|enable
operator|==
name|AL_TRUE
condition|)
block|{
name|val
operator|=
name|UDMA_S2M_WR_DATA_CFG_2_FULL_LINE_MODE
expr_stmt|;
name|al_info
argument_list|(
literal|"udma [%s]: full line write enabled\n"
argument_list|,
name|udma
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
name|al_reg_write32_masked
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|s2m_wr
operator|.
name|data_cfg_2
argument_list|,
name|UDMA_S2M_WR_DATA_CFG_2_FULL_LINE_MODE
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** Configure S2M UDMA descriptor prefetch */
end_comment

begin_function
name|int
name|al_udma_s2m_pref_set
parameter_list|(
name|struct
name|al_udma
modifier|*
name|udma
parameter_list|,
name|struct
name|al_udma_s2m_desc_pref_conf
modifier|*
name|conf
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|s2m_rd
operator|.
name|desc_pref_cfg_1
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_S2M_RD_DESC_PREF_CFG_1_FIFO_DEPTH_MASK
expr_stmt|;
name|reg
operator||=
name|conf
operator|->
name|desc_fifo_depth
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|s2m_rd
operator|.
name|desc_pref_cfg_1
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|s2m_rd
operator|.
name|desc_pref_cfg_2
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|sch_mode
operator|==
name|SRR
condition|)
name|reg
operator||=
name|UDMA_S2M_RD_DESC_PREF_CFG_2_PREF_FORCE_RR
expr_stmt|;
elseif|else
if|if
condition|(
name|conf
operator|->
name|sch_mode
operator|==
name|STRICT
condition|)
name|reg
operator|&=
operator|~
name|UDMA_S2M_RD_DESC_PREF_CFG_2_PREF_FORCE_RR
expr_stmt|;
else|else
block|{
name|al_err
argument_list|(
literal|"udma [%s]: requested descriptor preferch arbiter "
literal|"mode (%d) is invalid\n"
argument_list|,
name|udma
operator|->
name|name
argument_list|,
name|conf
operator|->
name|sch_mode
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|conf
operator|->
name|q_promotion
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_S2M_RD_DESC_PREF_CFG_2_Q_PROMOTION
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_S2M_RD_DESC_PREF_CFG_2_Q_PROMOTION
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|force_promotion
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_S2M_RD_DESC_PREF_CFG_2_FORCE_PROMOTION
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_S2M_RD_DESC_PREF_CFG_2_FORCE_PROMOTION
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|en_pref_prediction
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_S2M_RD_DESC_PREF_CFG_2_EN_PREF_PREDICTION
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_S2M_RD_DESC_PREF_CFG_2_EN_PREF_PREDICTION
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_S2M_RD_DESC_PREF_CFG_2_PROMOTION_TH_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|conf
operator|->
name|promotion_th
operator|<<
name|UDMA_S2M_RD_DESC_PREF_CFG_2_PROMOTION_TH_SHIFT
operator|)
operator|&
name|UDMA_S2M_RD_DESC_PREF_CFG_2_PROMOTION_TH_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|s2m_rd
operator|.
name|desc_pref_cfg_2
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|s2m_rd
operator|.
name|desc_pref_cfg_3
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_S2M_RD_DESC_PREF_CFG_3_PREF_THR_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|conf
operator|->
name|pref_thr
operator|<<
name|UDMA_S2M_RD_DESC_PREF_CFG_3_PREF_THR_SHIFT
operator|)
operator|&
name|UDMA_S2M_RD_DESC_PREF_CFG_3_PREF_THR_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_S2M_RD_DESC_PREF_CFG_3_MIN_BURST_BELOW_THR_MASK
expr_stmt|;
name|reg
operator||=
name|conf
operator|->
name|min_burst_below_thr
operator|&
name|UDMA_S2M_RD_DESC_PREF_CFG_3_MIN_BURST_BELOW_THR_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_S2M_RD_DESC_PREF_CFG_3_MIN_BURST_ABOVE_THR_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|conf
operator|->
name|min_burst_above_thr
operator|<<
name|UDMA_S2M_RD_DESC_PREF_CFG_3_MIN_BURST_ABOVE_THR_SHIFT
operator|)
operator|&
name|UDMA_S2M_RD_DESC_PREF_CFG_3_MIN_BURST_ABOVE_THR_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|s2m_rd
operator|.
name|desc_pref_cfg_3
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|s2m_rd
operator|.
name|desc_pref_cfg_4
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_S2M_RD_DESC_PREF_CFG_4_A_FULL_THR_MASK
expr_stmt|;
name|reg
operator||=
name|conf
operator|->
name|a_full_thr
operator|&
name|UDMA_S2M_RD_DESC_PREF_CFG_4_A_FULL_THR_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|s2m_rd
operator|.
name|desc_pref_cfg_4
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Configure S2M UDMA data write */
end_comment

begin_function
name|int
name|al_udma_s2m_data_write_set
parameter_list|(
name|struct
name|al_udma
modifier|*
name|udma
parameter_list|,
name|struct
name|al_udma_s2m_data_write_conf
modifier|*
name|conf
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|s2m_wr
operator|.
name|data_cfg_1
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_S2M_WR_DATA_CFG_1_DATA_FIFO_DEPTH_MASK
expr_stmt|;
name|reg
operator||=
name|conf
operator|->
name|data_fifo_depth
operator|&
name|UDMA_S2M_WR_DATA_CFG_1_DATA_FIFO_DEPTH_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_S2M_WR_DATA_CFG_1_MAX_PKT_LIMIT_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|conf
operator|->
name|max_pkt_limit
operator|<<
name|UDMA_S2M_WR_DATA_CFG_1_MAX_PKT_LIMIT_SHIFT
operator|)
operator|&
name|UDMA_S2M_WR_DATA_CFG_1_MAX_PKT_LIMIT_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_S2M_WR_DATA_CFG_1_FIFO_MARGIN_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|conf
operator|->
name|fifo_margin
operator|<<
name|UDMA_S2M_WR_DATA_CFG_1_FIFO_MARGIN_SHIFT
operator|)
operator|&
name|UDMA_S2M_WR_DATA_CFG_1_FIFO_MARGIN_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|s2m_wr
operator|.
name|data_cfg_1
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|s2m_wr
operator|.
name|data_cfg_2
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_S2M_WR_DATA_CFG_2_DESC_WAIT_TIMER_MASK
expr_stmt|;
name|reg
operator||=
name|conf
operator|->
name|desc_wait_timer
operator|&
name|UDMA_S2M_WR_DATA_CFG_2_DESC_WAIT_TIMER_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
operator|(
name|UDMA_S2M_WR_DATA_CFG_2_DROP_IF_NO_DESC
operator||
name|UDMA_S2M_WR_DATA_CFG_2_HINT_IF_NO_DESC
operator||
name|UDMA_S2M_WR_DATA_CFG_2_WAIT_FOR_PREF
operator||
name|UDMA_S2M_WR_DATA_CFG_2_FULL_LINE_MODE
operator||
name|UDMA_S2M_WR_DATA_CFG_2_DIRECT_HDR_USE_BUF1
operator|)
expr_stmt|;
name|reg
operator||=
name|conf
operator|->
name|flags
operator|&
operator|(
name|UDMA_S2M_WR_DATA_CFG_2_DROP_IF_NO_DESC
operator||
name|UDMA_S2M_WR_DATA_CFG_2_HINT_IF_NO_DESC
operator||
name|UDMA_S2M_WR_DATA_CFG_2_WAIT_FOR_PREF
operator||
name|UDMA_S2M_WR_DATA_CFG_2_FULL_LINE_MODE
operator||
name|UDMA_S2M_WR_DATA_CFG_2_DIRECT_HDR_USE_BUF1
operator|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|s2m_wr
operator|.
name|data_cfg_2
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Configure S2M UDMA completion */
end_comment

begin_function
name|int
name|al_udma_s2m_completion_set
parameter_list|(
name|struct
name|al_udma
modifier|*
name|udma
parameter_list|,
name|struct
name|al_udma_s2m_completion_conf
modifier|*
name|conf
parameter_list|)
block|{
name|uint32_t
name|reg
init|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|s2m_comp
operator|.
name|cfg_1c
argument_list|)
decl_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_S2M_COMP_CFG_1C_DESC_SIZE_MASK
expr_stmt|;
name|reg
operator||=
name|conf
operator|->
name|desc_size
operator|&
name|UDMA_S2M_COMP_CFG_1C_DESC_SIZE_MASK
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|cnt_words
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_S2M_COMP_CFG_1C_CNT_WORDS
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_S2M_COMP_CFG_1C_CNT_WORDS
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|q_promotion
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_S2M_COMP_CFG_1C_Q_PROMOTION
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_S2M_COMP_CFG_1C_Q_PROMOTION
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|force_rr
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_S2M_COMP_CFG_1C_FORCE_RR
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_S2M_COMP_CFG_1C_FORCE_RR
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_S2M_COMP_CFG_1C_Q_FREE_MIN_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|conf
operator|->
name|q_free_min
operator|<<
name|UDMA_S2M_COMP_CFG_1C_Q_FREE_MIN_SHIFT
operator|)
operator|&
name|UDMA_S2M_COMP_CFG_1C_Q_FREE_MIN_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|s2m_comp
operator|.
name|cfg_1c
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|s2m_comp
operator|.
name|cfg_2c
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_S2M_COMP_CFG_2C_COMP_FIFO_DEPTH_MASK
expr_stmt|;
name|reg
operator||=
name|conf
operator|->
name|comp_fifo_depth
operator|&
name|UDMA_S2M_COMP_CFG_2C_COMP_FIFO_DEPTH_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_S2M_COMP_CFG_2C_UNACK_FIFO_DEPTH_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|conf
operator|->
name|unack_fifo_depth
operator|<<
name|UDMA_S2M_COMP_CFG_2C_UNACK_FIFO_DEPTH_SHIFT
operator|)
operator|&
name|UDMA_S2M_COMP_CFG_2C_UNACK_FIFO_DEPTH_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|s2m_comp
operator|.
name|cfg_2c
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|s2m_comp
operator|.
name|cfg_application_ack
argument_list|,
name|conf
operator|->
name|timeout
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** Configure the M2S UDMA scheduling mode */
end_comment

begin_function
name|int
name|al_udma_m2s_sc_set
parameter_list|(
name|struct
name|al_udma
modifier|*
name|udma
parameter_list|,
name|struct
name|al_udma_m2s_dwrr_conf
modifier|*
name|sched
parameter_list|)
block|{
name|uint32_t
name|reg
init|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_dwrr
operator|.
name|cfg_sched
argument_list|)
decl_stmt|;
if|if
condition|(
name|sched
operator|->
name|enable_dwrr
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_M2S_DWRR_CFG_SCHED_EN_DWRR
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_M2S_DWRR_CFG_SCHED_EN_DWRR
expr_stmt|;
if|if
condition|(
name|sched
operator|->
name|pkt_mode
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_M2S_DWRR_CFG_SCHED_PKT_MODE_EN
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_M2S_DWRR_CFG_SCHED_PKT_MODE_EN
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_M2S_DWRR_CFG_SCHED_WEIGHT_INC_MASK
expr_stmt|;
name|reg
operator||=
name|sched
operator|->
name|weight
operator|<<
name|UDMA_M2S_DWRR_CFG_SCHED_WEIGHT_INC_SHIFT
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_M2S_DWRR_CFG_SCHED_INC_FACTOR_MASK
expr_stmt|;
name|reg
operator||=
name|sched
operator|->
name|inc_factor
operator|<<
name|UDMA_M2S_DWRR_CFG_SCHED_INC_FACTOR_SHIFT
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_dwrr
operator|.
name|cfg_sched
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_dwrr
operator|.
name|ctrl_deficit_cnt
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_M2S_DWRR_CTRL_DEFICIT_CNT_INIT_MASK
expr_stmt|;
name|reg
operator||=
name|sched
operator|->
name|deficit_init_val
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_dwrr
operator|.
name|ctrl_deficit_cnt
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** Configure the M2S UDMA rate limitation */
end_comment

begin_function
name|int
name|al_udma_m2s_rlimit_set
parameter_list|(
name|struct
name|al_udma
modifier|*
name|udma
parameter_list|,
name|struct
name|al_udma_m2s_rlimit_mode
modifier|*
name|mode
parameter_list|)
block|{
name|uint32_t
name|reg
init|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_rate_limiter
operator|.
name|gen_cfg
argument_list|)
decl_stmt|;
if|if
condition|(
name|mode
operator|->
name|pkt_mode_en
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_M2S_RATE_LIMITER_GEN_CFG_PKT_MODE_EN
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_M2S_RATE_LIMITER_GEN_CFG_PKT_MODE_EN
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_M2S_RATE_LIMITER_GEN_CFG_SHORT_CYCLE_SIZE_MASK
expr_stmt|;
name|reg
operator||=
name|mode
operator|->
name|short_cycle_sz
operator|&
name|UDMA_M2S_RATE_LIMITER_GEN_CFG_SHORT_CYCLE_SIZE_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_rate_limiter
operator|.
name|gen_cfg
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_rate_limiter
operator|.
name|ctrl_token
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_M2S_RATE_LIMITER_CTRL_TOKEN_RST_MASK
expr_stmt|;
name|reg
operator||=
name|mode
operator|->
name|token_init_val
operator|&
name|UDMA_M2S_RATE_LIMITER_CTRL_TOKEN_RST_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_rate_limiter
operator|.
name|ctrl_token
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_udma_m2s_rlimit_reset
parameter_list|(
name|struct
name|al_udma
modifier|*
name|udma
parameter_list|)
block|{
name|uint32_t
name|reg
init|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_rate_limiter
operator|.
name|ctrl_cycle_cnt
argument_list|)
decl_stmt|;
name|reg
operator||=
name|UDMA_M2S_RATE_LIMITER_CTRL_CYCLE_CNT_RST
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_rate_limiter
operator|.
name|ctrl_cycle_cnt
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** Configure the Stream/Q rate limitation */
end_comment

begin_function
specifier|static
name|int
name|al_udma_common_rlimit_set
parameter_list|(
name|struct
name|udma_rlimit_common
modifier|*
name|regs
parameter_list|,
name|struct
name|al_udma_m2s_rlimit_cfg
modifier|*
name|conf
parameter_list|)
block|{
name|uint32_t
name|reg
init|=
name|al_reg_read32
argument_list|(
operator|&
name|regs
operator|->
name|cfg_1s
argument_list|)
decl_stmt|;
comment|/* mask max burst size, and enable/pause control bits */
name|reg
operator|&=
operator|~
name|UDMA_M2S_STREAM_RATE_LIMITER_CFG_1S_MAX_BURST_SIZE_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_M2S_STREAM_RATE_LIMITER_CFG_1S_EN
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_M2S_STREAM_RATE_LIMITER_CFG_1S_PAUSE
expr_stmt|;
name|reg
operator||=
name|conf
operator|->
name|max_burst_sz
operator|&
name|UDMA_M2S_STREAM_RATE_LIMITER_CFG_1S_MAX_BURST_SIZE_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|regs
operator|->
name|cfg_1s
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|regs
operator|->
name|cfg_cycle
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_M2S_STREAM_RATE_LIMITER_CFG_CYCLE_LONG_CYCLE_SIZE_MASK
expr_stmt|;
name|reg
operator||=
name|conf
operator|->
name|long_cycle_sz
operator|&
name|UDMA_M2S_STREAM_RATE_LIMITER_CFG_CYCLE_LONG_CYCLE_SIZE_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|regs
operator|->
name|cfg_cycle
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|regs
operator|->
name|cfg_token_size_1
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_M2S_STREAM_RATE_LIMITER_CFG_TOKEN_SIZE_1_LONG_CYCLE_MASK
expr_stmt|;
name|reg
operator||=
name|conf
operator|->
name|long_cycle
operator|&
name|UDMA_M2S_STREAM_RATE_LIMITER_CFG_TOKEN_SIZE_1_LONG_CYCLE_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|regs
operator|->
name|cfg_token_size_1
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|regs
operator|->
name|cfg_token_size_2
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_M2S_STREAM_RATE_LIMITER_CFG_TOKEN_SIZE_2_SHORT_CYCLE_MASK
expr_stmt|;
name|reg
operator||=
name|conf
operator|->
name|short_cycle
operator|&
name|UDMA_M2S_STREAM_RATE_LIMITER_CFG_TOKEN_SIZE_2_SHORT_CYCLE_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|regs
operator|->
name|cfg_token_size_2
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|regs
operator|->
name|mask
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
literal|0xf
expr_stmt|;
comment|/* only bits 0-3 defined */
name|reg
operator||=
name|conf
operator|->
name|mask
operator|&
literal|0xf
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|regs
operator|->
name|mask
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|al_udma_common_rlimit_act
parameter_list|(
name|struct
name|udma_rlimit_common
modifier|*
name|regs
parameter_list|,
name|enum
name|al_udma_m2s_rlimit_action
name|act
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
switch|switch
condition|(
name|act
condition|)
block|{
case|case
name|AL_UDMA_STRM_RLIMIT_ENABLE
case|:
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|regs
operator|->
name|cfg_1s
argument_list|)
expr_stmt|;
name|reg
operator||=
name|UDMA_M2S_STREAM_RATE_LIMITER_CFG_1S_EN
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|regs
operator|->
name|cfg_1s
argument_list|,
name|reg
argument_list|)
expr_stmt|;
break|break;
case|case
name|AL_UDMA_STRM_RLIMIT_PAUSE
case|:
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|regs
operator|->
name|cfg_1s
argument_list|)
expr_stmt|;
name|reg
operator||=
name|UDMA_M2S_STREAM_RATE_LIMITER_CFG_1S_PAUSE
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|regs
operator|->
name|cfg_1s
argument_list|,
name|reg
argument_list|)
expr_stmt|;
break|break;
case|case
name|AL_UDMA_STRM_RLIMIT_RESET
case|:
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|regs
operator|->
name|sw_ctrl
argument_list|)
expr_stmt|;
name|reg
operator||=
name|UDMA_M2S_STREAM_RATE_LIMITER_SW_CTRL_RST_TOKEN_CNT
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|regs
operator|->
name|sw_ctrl
argument_list|,
name|reg
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** Configure the M2S Stream rate limitation */
end_comment

begin_function
name|int
name|al_udma_m2s_strm_rlimit_set
parameter_list|(
name|struct
name|al_udma
modifier|*
name|udma
parameter_list|,
name|struct
name|al_udma_m2s_rlimit_cfg
modifier|*
name|conf
parameter_list|)
block|{
name|struct
name|udma_rlimit_common
modifier|*
name|rlimit_regs
init|=
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_stream_rate_limiter
operator|.
name|rlimit
decl_stmt|;
return|return
name|al_udma_common_rlimit_set
argument_list|(
name|rlimit_regs
argument_list|,
name|conf
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|al_udma_m2s_strm_rlimit_act
parameter_list|(
name|struct
name|al_udma
modifier|*
name|udma
parameter_list|,
name|enum
name|al_udma_m2s_rlimit_action
name|act
parameter_list|)
block|{
name|struct
name|udma_rlimit_common
modifier|*
name|rlimit_regs
init|=
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_stream_rate_limiter
operator|.
name|rlimit
decl_stmt|;
if|if
condition|(
name|al_udma_common_rlimit_act
argument_list|(
name|rlimit_regs
argument_list|,
name|act
argument_list|)
operator|==
operator|-
name|EINVAL
condition|)
block|{
name|al_err
argument_list|(
literal|"udma [%s]: udma stream rate limit invalid action "
literal|"(%d)\n"
argument_list|,
name|udma
operator|->
name|name
argument_list|,
name|act
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** Configure the M2S UDMA Q rate limitation */
end_comment

begin_function
name|int
name|al_udma_m2s_q_rlimit_set
parameter_list|(
name|struct
name|al_udma_q
modifier|*
name|udma_q
parameter_list|,
name|struct
name|al_udma_m2s_rlimit_cfg
modifier|*
name|conf
parameter_list|)
block|{
name|struct
name|udma_rlimit_common
modifier|*
name|rlimit_regs
init|=
operator|&
name|udma_q
operator|->
name|q_regs
operator|->
name|m2s_q
operator|.
name|rlimit
decl_stmt|;
return|return
name|al_udma_common_rlimit_set
argument_list|(
name|rlimit_regs
argument_list|,
name|conf
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|al_udma_m2s_q_rlimit_act
parameter_list|(
name|struct
name|al_udma_q
modifier|*
name|udma_q
parameter_list|,
name|enum
name|al_udma_m2s_rlimit_action
name|act
parameter_list|)
block|{
name|struct
name|udma_rlimit_common
modifier|*
name|rlimit_regs
init|=
operator|&
name|udma_q
operator|->
name|q_regs
operator|->
name|m2s_q
operator|.
name|rlimit
decl_stmt|;
if|if
condition|(
name|al_udma_common_rlimit_act
argument_list|(
name|rlimit_regs
argument_list|,
name|act
argument_list|)
operator|==
operator|-
name|EINVAL
condition|)
block|{
name|al_err
argument_list|(
literal|"udma [%s %d]: udma stream rate limit invalid action "
literal|"(%d)\n"
argument_list|,
name|udma_q
operator|->
name|udma
operator|->
name|name
argument_list|,
name|udma_q
operator|->
name|qid
argument_list|,
name|act
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** Configure the M2S UDMA Q scheduling mode */
end_comment

begin_function
name|int
name|al_udma_m2s_q_sc_set
parameter_list|(
name|struct
name|al_udma_q
modifier|*
name|udma_q
parameter_list|,
name|struct
name|al_udma_m2s_q_dwrr_conf
modifier|*
name|conf
parameter_list|)
block|{
name|uint32_t
name|reg
init|=
name|al_reg_read32
argument_list|(
operator|&
name|udma_q
operator|->
name|q_regs
operator|->
name|m2s_q
operator|.
name|dwrr_cfg_1
argument_list|)
decl_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_M2S_Q_DWRR_CFG_1_MAX_DEFICIT_CNT_SIZE_MASK
expr_stmt|;
name|reg
operator||=
name|conf
operator|->
name|max_deficit_cnt_sz
operator|&
name|UDMA_M2S_Q_DWRR_CFG_1_MAX_DEFICIT_CNT_SIZE_MASK
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|strict
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_M2S_Q_DWRR_CFG_1_STRICT
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_M2S_Q_DWRR_CFG_1_STRICT
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma_q
operator|->
name|q_regs
operator|->
name|m2s_q
operator|.
name|dwrr_cfg_1
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma_q
operator|->
name|q_regs
operator|->
name|m2s_q
operator|.
name|dwrr_cfg_2
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_M2S_Q_DWRR_CFG_2_Q_QOS_MASK
expr_stmt|;
name|reg
operator||=
operator|(
name|conf
operator|->
name|axi_qos
operator|<<
name|UDMA_M2S_Q_DWRR_CFG_2_Q_QOS_SHIFT
operator|)
operator|&
name|UDMA_M2S_Q_DWRR_CFG_2_Q_QOS_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_M2S_Q_DWRR_CFG_2_Q_QOS_MASK
expr_stmt|;
name|reg
operator||=
name|conf
operator|->
name|q_qos
operator|&
name|UDMA_M2S_Q_DWRR_CFG_2_Q_QOS_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma_q
operator|->
name|q_regs
operator|->
name|m2s_q
operator|.
name|dwrr_cfg_2
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma_q
operator|->
name|q_regs
operator|->
name|m2s_q
operator|.
name|dwrr_cfg_3
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_M2S_Q_DWRR_CFG_3_WEIGHT_MASK
expr_stmt|;
name|reg
operator||=
name|conf
operator|->
name|weight
operator|&
name|UDMA_M2S_Q_DWRR_CFG_3_WEIGHT_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma_q
operator|->
name|q_regs
operator|->
name|m2s_q
operator|.
name|dwrr_cfg_3
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_udma_m2s_q_sc_pause
parameter_list|(
name|struct
name|al_udma_q
modifier|*
name|udma_q
parameter_list|,
name|al_bool
name|set
parameter_list|)
block|{
name|uint32_t
name|reg
init|=
name|al_reg_read32
argument_list|(
operator|&
name|udma_q
operator|->
name|q_regs
operator|->
name|m2s_q
operator|.
name|dwrr_cfg_1
argument_list|)
decl_stmt|;
if|if
condition|(
name|set
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_M2S_Q_DWRR_CFG_1_PAUSE
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_M2S_Q_DWRR_CFG_1_PAUSE
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma_q
operator|->
name|q_regs
operator|->
name|m2s_q
operator|.
name|dwrr_cfg_1
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_udma_m2s_q_sc_reset
parameter_list|(
name|struct
name|al_udma_q
modifier|*
name|udma_q
parameter_list|)
block|{
name|uint32_t
name|reg
init|=
name|al_reg_read32
argument_list|(
operator|&
name|udma_q
operator|->
name|q_regs
operator|->
name|m2s_q
operator|.
name|dwrr_sw_ctrl
argument_list|)
decl_stmt|;
name|reg
operator||=
name|UDMA_M2S_Q_DWRR_SW_CTRL_RST_CNT
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma_q
operator|->
name|q_regs
operator|->
name|m2s_q
operator|.
name|dwrr_sw_ctrl
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** M2S UDMA completion and application timeouts */
end_comment

begin_function
name|int
name|al_udma_m2s_comp_timeouts_set
parameter_list|(
name|struct
name|al_udma
modifier|*
name|udma
parameter_list|,
name|struct
name|al_udma_m2s_comp_timeouts
modifier|*
name|conf
parameter_list|)
block|{
name|uint32_t
name|reg
init|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_comp
operator|.
name|cfg_1c
argument_list|)
decl_stmt|;
if|if
condition|(
name|conf
operator|->
name|sch_mode
operator|==
name|SRR
condition|)
name|reg
operator||=
name|UDMA_M2S_COMP_CFG_1C_FORCE_RR
expr_stmt|;
elseif|else
if|if
condition|(
name|conf
operator|->
name|sch_mode
operator|==
name|STRICT
condition|)
name|reg
operator|&=
operator|~
name|UDMA_M2S_COMP_CFG_1C_FORCE_RR
expr_stmt|;
else|else
block|{
name|al_err
argument_list|(
literal|"udma [%s]: requested completion descriptor preferch "
literal|"arbiter mode (%d) is invalid\n"
argument_list|,
name|udma
operator|->
name|name
argument_list|,
name|conf
operator|->
name|sch_mode
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|conf
operator|->
name|enable_q_promotion
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_M2S_COMP_CFG_1C_Q_PROMOTION
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_M2S_COMP_CFG_1C_Q_PROMOTION
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_M2S_COMP_CFG_1C_COMP_FIFO_DEPTH_MASK
expr_stmt|;
name|reg
operator||=
name|conf
operator|->
name|comp_fifo_depth
operator|<<
name|UDMA_M2S_COMP_CFG_1C_COMP_FIFO_DEPTH_SHIFT
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_M2S_COMP_CFG_1C_UNACK_FIFO_DEPTH_MASK
expr_stmt|;
name|reg
operator||=
name|conf
operator|->
name|unack_fifo_depth
operator|<<
name|UDMA_M2S_COMP_CFG_1C_UNACK_FIFO_DEPTH_SHIFT
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_comp
operator|.
name|cfg_1c
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_comp
operator|.
name|cfg_coal
argument_list|,
name|conf
operator|->
name|coal_timeout
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_comp
operator|.
name|cfg_application_ack
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_M2S_COMP_CFG_APPLICATION_ACK_TOUT_MASK
expr_stmt|;
name|reg
operator||=
name|conf
operator|->
name|app_timeout
operator|<<
name|UDMA_M2S_COMP_CFG_APPLICATION_ACK_TOUT_SHIFT
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_comp
operator|.
name|cfg_application_ack
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_udma_m2s_comp_timeouts_get
parameter_list|(
name|struct
name|al_udma
modifier|*
name|udma
parameter_list|,
name|struct
name|al_udma_m2s_comp_timeouts
modifier|*
name|conf
parameter_list|)
block|{
name|uint32_t
name|reg
init|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_comp
operator|.
name|cfg_1c
argument_list|)
decl_stmt|;
if|if
condition|(
name|reg
operator|&
name|UDMA_M2S_COMP_CFG_1C_FORCE_RR
condition|)
name|conf
operator|->
name|sch_mode
operator|=
name|SRR
expr_stmt|;
else|else
name|conf
operator|->
name|sch_mode
operator|=
name|STRICT
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|UDMA_M2S_COMP_CFG_1C_Q_PROMOTION
condition|)
name|conf
operator|->
name|enable_q_promotion
operator|=
name|AL_TRUE
expr_stmt|;
else|else
name|conf
operator|->
name|enable_q_promotion
operator|=
name|AL_FALSE
expr_stmt|;
name|conf
operator|->
name|comp_fifo_depth
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|UDMA_M2S_COMP_CFG_1C_COMP_FIFO_DEPTH_MASK
argument_list|,
name|UDMA_M2S_COMP_CFG_1C_COMP_FIFO_DEPTH_SHIFT
argument_list|)
expr_stmt|;
name|conf
operator|->
name|unack_fifo_depth
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|UDMA_M2S_COMP_CFG_1C_UNACK_FIFO_DEPTH_MASK
argument_list|,
name|UDMA_M2S_COMP_CFG_1C_UNACK_FIFO_DEPTH_SHIFT
argument_list|)
expr_stmt|;
name|conf
operator|->
name|coal_timeout
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_comp
operator|.
name|cfg_coal
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|m2s
operator|.
name|m2s_comp
operator|.
name|cfg_application_ack
argument_list|)
expr_stmt|;
name|conf
operator|->
name|app_timeout
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|UDMA_M2S_COMP_CFG_APPLICATION_ACK_TOUT_MASK
argument_list|,
name|UDMA_M2S_COMP_CFG_APPLICATION_ACK_TOUT_SHIFT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * S2M UDMA configure no descriptors behaviour  */
end_comment

begin_function
name|int
name|al_udma_s2m_no_desc_cfg_set
parameter_list|(
name|struct
name|al_udma
modifier|*
name|udma
parameter_list|,
name|al_bool
name|drop_packet
parameter_list|,
name|al_bool
name|gen_interrupt
parameter_list|,
name|uint32_t
name|wait_for_desc_timeout
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|s2m_wr
operator|.
name|data_cfg_2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|drop_packet
operator|==
name|AL_TRUE
operator|)
operator|&&
operator|(
name|wait_for_desc_timeout
operator|==
literal|0
operator|)
condition|)
block|{
name|al_err
argument_list|(
literal|"udam [%s]: setting timeout to 0 will cause the udma to wait forever instead of dropping the packet"
argument_list|,
name|udma
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|drop_packet
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_S2M_WR_DATA_CFG_2_DROP_IF_NO_DESC
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_S2M_WR_DATA_CFG_2_DROP_IF_NO_DESC
expr_stmt|;
if|if
condition|(
name|gen_interrupt
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_S2M_WR_DATA_CFG_2_HINT_IF_NO_DESC
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_S2M_WR_DATA_CFG_2_HINT_IF_NO_DESC
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|UDMA_S2M_WR_DATA_CFG_2_DESC_WAIT_TIMER_MASK
argument_list|,
name|UDMA_S2M_WR_DATA_CFG_2_DESC_WAIT_TIMER_SHIFT
argument_list|,
name|wait_for_desc_timeout
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|s2m_wr
operator|.
name|data_cfg_2
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* S2M UDMA configure a queue's completion update */
end_comment

begin_function
name|int
name|al_udma_s2m_q_compl_updade_config
parameter_list|(
name|struct
name|al_udma_q
modifier|*
name|udma_q
parameter_list|,
name|al_bool
name|enable
parameter_list|)
block|{
name|uint32_t
name|reg
init|=
name|al_reg_read32
argument_list|(
operator|&
name|udma_q
operator|->
name|q_regs
operator|->
name|s2m_q
operator|.
name|comp_cfg
argument_list|)
decl_stmt|;
if|if
condition|(
name|enable
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_S2M_Q_COMP_CFG_EN_COMP_RING_UPDATE
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_S2M_Q_COMP_CFG_EN_COMP_RING_UPDATE
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma_q
operator|->
name|q_regs
operator|->
name|s2m_q
operator|.
name|comp_cfg
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* S2M UDMA configure a queue's completion descriptors coalescing */
end_comment

begin_function
name|int
name|al_udma_s2m_q_compl_coal_config
parameter_list|(
name|struct
name|al_udma_q
modifier|*
name|udma_q
parameter_list|,
name|al_bool
name|enable
parameter_list|,
name|uint32_t
name|coal_timeout
parameter_list|)
block|{
name|uint32_t
name|reg
init|=
name|al_reg_read32
argument_list|(
operator|&
name|udma_q
operator|->
name|q_regs
operator|->
name|s2m_q
operator|.
name|comp_cfg
argument_list|)
decl_stmt|;
if|if
condition|(
name|enable
operator|==
name|AL_TRUE
condition|)
name|reg
operator|&=
operator|~
name|UDMA_S2M_Q_COMP_CFG_DIS_COMP_COAL
expr_stmt|;
else|else
name|reg
operator||=
name|UDMA_S2M_Q_COMP_CFG_DIS_COMP_COAL
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma_q
operator|->
name|q_regs
operator|->
name|s2m_q
operator|.
name|comp_cfg
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma_q
operator|->
name|q_regs
operator|->
name|s2m_q
operator|.
name|comp_cfg_2
argument_list|,
name|coal_timeout
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* S2M UDMA configure completion descriptors write burst parameters */
end_comment

begin_function
name|int
name|al_udma_s2m_compl_desc_burst_config
parameter_list|(
name|struct
name|al_udma
modifier|*
name|udma
parameter_list|,
name|uint16_t
name|burst_size
parameter_list|)
block|{
if|if
condition|(
operator|(
name|burst_size
operator|!=
literal|64
operator|)
operator|&&
operator|(
name|burst_size
operator|!=
literal|128
operator|)
operator|&&
operator|(
name|burst_size
operator|!=
literal|256
operator|)
condition|)
block|{
name|al_err
argument_list|(
literal|"%s: invalid burst_size value (%d)\n"
argument_list|,
name|__func__
argument_list|,
name|burst_size
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* convert burst size from bytes to beats (16 byte) */
name|burst_size
operator|=
name|burst_size
operator|/
literal|16
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|&
name|udma
operator|->
name|udma_regs
operator|->
name|s2m
operator|.
name|axi_s2m
operator|.
name|desc_wr_cfg_1
argument_list|,
name|UDMA_AXI_S2M_DESC_WR_CFG_1_MIN_AXI_BEATS_MASK
operator||
name|UDMA_AXI_S2M_DESC_WR_CFG_1_MAX_AXI_BEATS_MASK
argument_list|,
name|burst_size
operator|<<
name|UDMA_AXI_S2M_DESC_WR_CFG_1_MIN_AXI_BEATS_SHIFT
operator||
name|burst_size
operator|<<
name|UDMA_AXI_S2M_DESC_WR_CFG_1_MAX_AXI_BEATS_SHIFT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* S2M UDMA configure a queue's completion descriptors header split */
end_comment

begin_function
name|int
name|al_udma_s2m_q_compl_hdr_split_config
parameter_list|(
name|struct
name|al_udma_q
modifier|*
name|udma_q
parameter_list|,
name|al_bool
name|enable
parameter_list|,
name|al_bool
name|force_hdr_split
parameter_list|,
name|uint32_t
name|hdr_len
parameter_list|)
block|{
name|uint32_t
name|reg
init|=
name|al_reg_read32
argument_list|(
operator|&
name|udma_q
operator|->
name|q_regs
operator|->
name|s2m_q
operator|.
name|pkt_cfg
argument_list|)
decl_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_S2M_Q_PKT_CFG_HDR_SPLIT_SIZE_MASK
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_S2M_Q_PKT_CFG_EN_HDR_SPLIT
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_S2M_Q_PKT_CFG_FORCE_HDR_SPLIT
expr_stmt|;
if|if
condition|(
name|enable
operator|==
name|AL_TRUE
condition|)
block|{
name|reg
operator||=
name|hdr_len
operator|&
name|UDMA_S2M_Q_PKT_CFG_HDR_SPLIT_SIZE_MASK
expr_stmt|;
name|reg
operator||=
name|UDMA_S2M_Q_PKT_CFG_EN_HDR_SPLIT
expr_stmt|;
if|if
condition|(
name|force_hdr_split
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_S2M_Q_PKT_CFG_FORCE_HDR_SPLIT
expr_stmt|;
block|}
name|al_reg_write32
argument_list|(
operator|&
name|udma_q
operator|->
name|q_regs
operator|->
name|s2m_q
operator|.
name|pkt_cfg
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* S2M UDMA per queue completion configuration */
end_comment

begin_function
name|int
name|al_udma_s2m_q_comp_set
parameter_list|(
name|struct
name|al_udma_q
modifier|*
name|udma_q
parameter_list|,
name|struct
name|al_udma_s2m_q_comp_conf
modifier|*
name|conf
parameter_list|)
block|{
name|uint32_t
name|reg
init|=
name|al_reg_read32
argument_list|(
operator|&
name|udma_q
operator|->
name|q_regs
operator|->
name|s2m_q
operator|.
name|comp_cfg
argument_list|)
decl_stmt|;
if|if
condition|(
name|conf
operator|->
name|en_comp_ring_update
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_S2M_Q_COMP_CFG_EN_COMP_RING_UPDATE
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_S2M_Q_COMP_CFG_EN_COMP_RING_UPDATE
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|dis_comp_coal
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_S2M_Q_COMP_CFG_DIS_COMP_COAL
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_S2M_Q_COMP_CFG_DIS_COMP_COAL
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma_q
operator|->
name|q_regs
operator|->
name|s2m_q
operator|.
name|comp_cfg
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma_q
operator|->
name|q_regs
operator|->
name|s2m_q
operator|.
name|comp_cfg_2
argument_list|,
name|conf
operator|->
name|comp_timer
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma_q
operator|->
name|q_regs
operator|->
name|s2m_q
operator|.
name|pkt_cfg
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_S2M_Q_PKT_CFG_HDR_SPLIT_SIZE_MASK
expr_stmt|;
name|reg
operator||=
name|conf
operator|->
name|hdr_split_size
operator|&
name|UDMA_S2M_Q_PKT_CFG_HDR_SPLIT_SIZE_MASK
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|force_hdr_split
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_S2M_Q_PKT_CFG_FORCE_HDR_SPLIT
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_S2M_Q_PKT_CFG_FORCE_HDR_SPLIT
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|en_hdr_split
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|UDMA_S2M_Q_PKT_CFG_EN_HDR_SPLIT
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|UDMA_S2M_Q_PKT_CFG_EN_HDR_SPLIT
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma_q
operator|->
name|q_regs
operator|->
name|s2m_q
operator|.
name|pkt_cfg
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|udma_q
operator|->
name|q_regs
operator|->
name|s2m_q
operator|.
name|qos_cfg
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
name|UDMA_S2M_QOS_CFG_Q_QOS_MASK
expr_stmt|;
name|reg
operator||=
name|conf
operator|->
name|q_qos
operator|&
name|UDMA_S2M_QOS_CFG_Q_QOS_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|udma_q
operator|->
name|q_regs
operator|->
name|s2m_q
operator|.
name|qos_cfg
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* UDMA Target-ID control configuration per queue */
end_comment

begin_function
name|void
name|al_udma_gen_tgtid_conf_queue_set
parameter_list|(
name|struct
name|unit_regs
modifier|*
name|unit_regs
parameter_list|,
name|struct
name|al_udma_gen_tgtid_conf
modifier|*
name|conf
parameter_list|,
name|uint32_t
name|qid
parameter_list|)
block|{
name|uint32_t
modifier|*
name|tx_tgtid_reg
decl_stmt|,
modifier|*
name|rx_tgtid_reg
decl_stmt|,
modifier|*
name|tx_tgtaddr_reg
decl_stmt|,
modifier|*
name|rx_tgtaddr_reg
decl_stmt|;
name|unsigned
name|int
name|rev_id
decl_stmt|;
name|al_assert
argument_list|(
name|qid
operator|<
name|DMA_MAX_Q
argument_list|)
expr_stmt|;
name|rev_id
operator|=
name|al_udma_get_revision
argument_list|(
name|unit_regs
argument_list|)
expr_stmt|;
comment|/* Target-ID TX DESC EN */
name|al_reg_write32_masked
argument_list|(
operator|&
name|unit_regs
operator|->
name|gen
operator|.
name|tgtid
operator|.
name|cfg_tgtid_0
argument_list|,
operator|(
name|conf
operator|->
name|tx_q_conf
index|[
name|qid
index|]
operator|.
name|desc_en
operator|<<
name|qid
operator|)
operator|<<
name|UDMA_GEN_TGTID_CFG_TGTID_0_TX_Q_TGTID_DESC_EN_SHIFT
argument_list|,
operator|(
name|conf
operator|->
name|tx_q_conf
index|[
name|qid
index|]
operator|.
name|desc_en
operator|<<
name|qid
operator|)
operator|<<
name|UDMA_GEN_TGTID_CFG_TGTID_0_TX_Q_TGTID_DESC_EN_SHIFT
argument_list|)
expr_stmt|;
comment|/* Target-ID TX QUEUE EN */
name|al_reg_write32_masked
argument_list|(
operator|&
name|unit_regs
operator|->
name|gen
operator|.
name|tgtid
operator|.
name|cfg_tgtid_0
argument_list|,
operator|(
name|conf
operator|->
name|tx_q_conf
index|[
name|qid
index|]
operator|.
name|queue_en
operator|<<
name|qid
operator|)
operator|<<
name|UDMA_GEN_TGTID_CFG_TGTID_0_TX_Q_TGTID_QUEUE_EN_SHIFT
argument_list|,
operator|(
name|conf
operator|->
name|tx_q_conf
index|[
name|qid
index|]
operator|.
name|queue_en
operator|<<
name|qid
operator|)
operator|<<
name|UDMA_GEN_TGTID_CFG_TGTID_0_TX_Q_TGTID_QUEUE_EN_SHIFT
argument_list|)
expr_stmt|;
comment|/* Target-ID RX DESC EN */
name|al_reg_write32_masked
argument_list|(
operator|&
name|unit_regs
operator|->
name|gen
operator|.
name|tgtid
operator|.
name|cfg_tgtid_0
argument_list|,
operator|(
name|conf
operator|->
name|rx_q_conf
index|[
name|qid
index|]
operator|.
name|desc_en
operator|<<
name|qid
operator|)
operator|<<
name|UDMA_GEN_TGTID_CFG_TGTID_0_RX_Q_TGTID_DESC_EN_SHIFT
argument_list|,
operator|(
name|conf
operator|->
name|rx_q_conf
index|[
name|qid
index|]
operator|.
name|desc_en
operator|<<
name|qid
operator|)
operator|<<
name|UDMA_GEN_TGTID_CFG_TGTID_0_RX_Q_TGTID_DESC_EN_SHIFT
argument_list|)
expr_stmt|;
comment|/* Target-ID RX QUEUE EN */
name|al_reg_write32_masked
argument_list|(
operator|&
name|unit_regs
operator|->
name|gen
operator|.
name|tgtid
operator|.
name|cfg_tgtid_0
argument_list|,
operator|(
name|conf
operator|->
name|rx_q_conf
index|[
name|qid
index|]
operator|.
name|queue_en
operator|<<
name|qid
operator|)
operator|<<
name|UDMA_GEN_TGTID_CFG_TGTID_0_RX_Q_TGTID_QUEUE_EN_SHIFT
argument_list|,
operator|(
name|conf
operator|->
name|rx_q_conf
index|[
name|qid
index|]
operator|.
name|queue_en
operator|<<
name|qid
operator|)
operator|<<
name|UDMA_GEN_TGTID_CFG_TGTID_0_RX_Q_TGTID_QUEUE_EN_SHIFT
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|qid
condition|)
block|{
case|case
literal|0
case|:
case|case
literal|1
case|:
name|tx_tgtid_reg
operator|=
operator|&
name|unit_regs
operator|->
name|gen
operator|.
name|tgtid
operator|.
name|cfg_tgtid_1
expr_stmt|;
name|rx_tgtid_reg
operator|=
operator|&
name|unit_regs
operator|->
name|gen
operator|.
name|tgtid
operator|.
name|cfg_tgtid_3
expr_stmt|;
name|tx_tgtaddr_reg
operator|=
operator|&
name|unit_regs
operator|->
name|gen
operator|.
name|tgtaddr
operator|.
name|cfg_tgtaddr_0
expr_stmt|;
name|rx_tgtaddr_reg
operator|=
operator|&
name|unit_regs
operator|->
name|gen
operator|.
name|tgtaddr
operator|.
name|cfg_tgtaddr_2
expr_stmt|;
break|break;
case|case
literal|2
case|:
case|case
literal|3
case|:
name|tx_tgtid_reg
operator|=
operator|&
name|unit_regs
operator|->
name|gen
operator|.
name|tgtid
operator|.
name|cfg_tgtid_2
expr_stmt|;
name|rx_tgtid_reg
operator|=
operator|&
name|unit_regs
operator|->
name|gen
operator|.
name|tgtid
operator|.
name|cfg_tgtid_4
expr_stmt|;
name|tx_tgtaddr_reg
operator|=
operator|&
name|unit_regs
operator|->
name|gen
operator|.
name|tgtaddr
operator|.
name|cfg_tgtaddr_1
expr_stmt|;
name|rx_tgtaddr_reg
operator|=
operator|&
name|unit_regs
operator|->
name|gen
operator|.
name|tgtaddr
operator|.
name|cfg_tgtaddr_3
expr_stmt|;
break|break;
default|default:
name|al_assert
argument_list|(
name|AL_FALSE
argument_list|)
expr_stmt|;
return|return;
block|}
name|al_reg_write32_masked
argument_list|(
name|tx_tgtid_reg
argument_list|,
name|UDMA_GEN_TGTID_CFG_TGTID_MASK
argument_list|(
name|qid
argument_list|)
argument_list|,
name|conf
operator|->
name|tx_q_conf
index|[
name|qid
index|]
operator|.
name|tgtid
operator|<<
name|UDMA_GEN_TGTID_CFG_TGTID_SHIFT
argument_list|(
name|qid
argument_list|)
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
name|rx_tgtid_reg
argument_list|,
name|UDMA_GEN_TGTID_CFG_TGTID_MASK
argument_list|(
name|qid
argument_list|)
argument_list|,
name|conf
operator|->
name|rx_q_conf
index|[
name|qid
index|]
operator|.
name|tgtid
operator|<<
name|UDMA_GEN_TGTID_CFG_TGTID_SHIFT
argument_list|(
name|qid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rev_id
operator|>=
name|AL_UDMA_REV_ID_REV2
condition|)
block|{
name|al_reg_write32_masked
argument_list|(
name|tx_tgtaddr_reg
argument_list|,
name|UDMA_GEN_TGTADDR_CFG_MASK
argument_list|(
name|qid
argument_list|)
argument_list|,
name|conf
operator|->
name|tx_q_conf
index|[
name|qid
index|]
operator|.
name|tgtaddr
operator|<<
name|UDMA_GEN_TGTADDR_CFG_SHIFT
argument_list|(
name|qid
argument_list|)
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
name|rx_tgtaddr_reg
argument_list|,
name|UDMA_GEN_TGTADDR_CFG_MASK
argument_list|(
name|qid
argument_list|)
argument_list|,
name|conf
operator|->
name|rx_q_conf
index|[
name|qid
index|]
operator|.
name|tgtaddr
operator|<<
name|UDMA_GEN_TGTADDR_CFG_SHIFT
argument_list|(
name|qid
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* UDMA Target-ID control configuration */
end_comment

begin_function
name|void
name|al_udma_gen_tgtid_conf_set
parameter_list|(
name|struct
name|unit_regs
modifier|*
name|unit_regs
parameter_list|,
name|struct
name|al_udma_gen_tgtid_conf
modifier|*
name|conf
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|DMA_MAX_Q
condition|;
name|i
operator|++
control|)
name|al_udma_gen_tgtid_conf_queue_set
argument_list|(
name|unit_regs
argument_list|,
name|conf
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* UDMA Target-ID MSIX control configuration */
end_comment

begin_function
name|void
name|al_udma_gen_tgtid_msix_conf_set
parameter_list|(
name|struct
name|unit_regs
modifier|*
name|unit_regs
parameter_list|,
name|struct
name|al_udma_gen_tgtid_msix_conf
modifier|*
name|conf
parameter_list|)
block|{
name|al_reg_write32_masked
argument_list|(
operator|&
name|unit_regs
operator|->
name|gen
operator|.
name|tgtid
operator|.
name|cfg_tgtid_0
argument_list|,
name|UDMA_GEN_TGTID_CFG_TGTID_0_MSIX_TGTID_ACCESS_EN
operator||
name|UDMA_GEN_TGTID_CFG_TGTID_0_MSIX_TGTID_SEL
argument_list|,
operator|(
name|conf
operator|->
name|access_en
condition|?
name|UDMA_GEN_TGTID_CFG_TGTID_0_MSIX_TGTID_ACCESS_EN
else|:
literal|0
operator|)
operator||
operator|(
name|conf
operator|->
name|sel
condition|?
name|UDMA_GEN_TGTID_CFG_TGTID_0_MSIX_TGTID_SEL
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*- ******************************************************************************** Copyright (C) 2015 Annapurna Labs Ltd.  This file may be licensed under the terms of the Annapurna Labs Commercial License Agreement.  Alternatively, this file can be distributed under the terms of the GNU General Public License V2 as published by the Free Software Foundation and can be found at http://www.gnu.org/licenses/gpl-2.0.html  Alternatively, redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:      *     Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.      *     Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *******************************************************************************/
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|"al_hal_pcie.h"
end_include

begin_include
include|#
directive|include
file|"al_hal_pbs_regs.h"
end_include

begin_include
include|#
directive|include
file|"al_hal_unit_adapter_regs.h"
end_include

begin_comment
comment|/**  * Parameter definitions  */
end_comment

begin_define
define|#
directive|define
name|AL_PCIE_AXI_REGS_OFFSET
value|0x0
end_define

begin_define
define|#
directive|define
name|AL_PCIE_LTSSM_STATE_L0
value|0x11
end_define

begin_define
define|#
directive|define
name|AL_PCIE_LTSSM_STATE_L0S
value|0x12
end_define

begin_define
define|#
directive|define
name|AL_PCIE_DEVCTL_PAYLOAD_128B
value|0x00
end_define

begin_define
define|#
directive|define
name|AL_PCIE_DEVCTL_PAYLOAD_256B
value|0x20
end_define

begin_define
define|#
directive|define
name|AL_PCIE_SECBUS_DEFAULT
value|0x1
end_define

begin_define
define|#
directive|define
name|AL_PCIE_SUBBUS_DEFAULT
value|0x1
end_define

begin_define
define|#
directive|define
name|AL_PCIE_LINKUP_WAIT_INTERVAL
value|50
end_define

begin_comment
comment|/* measured in usec */
end_comment

begin_define
define|#
directive|define
name|AL_PCIE_LINKUP_WAIT_INTERVALS_PER_SEC
value|20
end_define

begin_define
define|#
directive|define
name|AL_PCIE_LINKUP_RETRIES
value|8
end_define

begin_define
define|#
directive|define
name|AL_PCIE_MAX_32_MEMORY_BAR_SIZE
value|(0x100000000ULL)
end_define

begin_define
define|#
directive|define
name|AL_PCIE_MIN_MEMORY_BAR_SIZE
value|(1<< 12)
end_define

begin_define
define|#
directive|define
name|AL_PCIE_MIN_IO_BAR_SIZE
value|(1<< 8)
end_define

begin_comment
comment|/**  * inbound header credits and outstanding outbound reads defaults  */
end_comment

begin_comment
comment|/** RC - Revisions 1/2 */
end_comment

begin_define
define|#
directive|define
name|AL_PCIE_REV_1_2_RC_OB_OS_READS_DEFAULT
value|(8)
end_define

begin_define
define|#
directive|define
name|AL_PCIE_REV_1_2_RC_NOF_CPL_HDR_DEFAULT
value|(41)
end_define

begin_define
define|#
directive|define
name|AL_PCIE_REV_1_2_RC_NOF_NP_HDR_DEFAULT
value|(25)
end_define

begin_define
define|#
directive|define
name|AL_PCIE_REV_1_2_RC_NOF_P_HDR_DEFAULT
value|(31)
end_define

begin_comment
comment|/** EP - Revisions 1/2 */
end_comment

begin_define
define|#
directive|define
name|AL_PCIE_REV_1_2_EP_OB_OS_READS_DEFAULT
value|(15)
end_define

begin_define
define|#
directive|define
name|AL_PCIE_REV_1_2_EP_NOF_CPL_HDR_DEFAULT
value|(76)
end_define

begin_define
define|#
directive|define
name|AL_PCIE_REV_1_2_EP_NOF_NP_HDR_DEFAULT
value|(6)
end_define

begin_define
define|#
directive|define
name|AL_PCIE_REV_1_2_EP_NOF_P_HDR_DEFAULT
value|(15)
end_define

begin_comment
comment|/** RC - Revision 3 */
end_comment

begin_define
define|#
directive|define
name|AL_PCIE_REV_3_RC_OB_OS_READS_DEFAULT
value|(32)
end_define

begin_define
define|#
directive|define
name|AL_PCIE_REV_3_RC_NOF_CPL_HDR_DEFAULT
value|(161)
end_define

begin_define
define|#
directive|define
name|AL_PCIE_REV_3_RC_NOF_NP_HDR_DEFAULT
value|(38)
end_define

begin_define
define|#
directive|define
name|AL_PCIE_REV_3_RC_NOF_P_HDR_DEFAULT
value|(60)
end_define

begin_comment
comment|/** EP - Revision 3 */
end_comment

begin_define
define|#
directive|define
name|AL_PCIE_REV_3_EP_OB_OS_READS_DEFAULT
value|(32)
end_define

begin_define
define|#
directive|define
name|AL_PCIE_REV_3_EP_NOF_CPL_HDR_DEFAULT
value|(161)
end_define

begin_define
define|#
directive|define
name|AL_PCIE_REV_3_EP_NOF_NP_HDR_DEFAULT
value|(38)
end_define

begin_define
define|#
directive|define
name|AL_PCIE_REV_3_EP_NOF_P_HDR_DEFAULT
value|(60)
end_define

begin_comment
comment|/**  * MACROS  */
end_comment

begin_define
define|#
directive|define
name|AL_PCIE_PARSE_LANES
parameter_list|(
name|v
parameter_list|)
value|(((1<< v) - 1)<< \ 		PCIE_REVX_AXI_MISC_PCIE_GLOBAL_CONF_NOF_ACT_LANES_SHIFT)
end_define

begin_comment
comment|/**  * Static functions  */
end_comment

begin_function
specifier|static
name|void
name|al_pcie_port_wr_to_ro_set
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|al_bool
name|enable
parameter_list|)
block|{
comment|/* when disabling writes to RO, make sure any previous writes to 	 * config space were committed 	 */
if|if
condition|(
name|enable
operator|==
name|AL_FALSE
condition|)
name|al_local_data_memory_barrier
argument_list|()
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|pcie_port
operator|->
name|regs
operator|->
name|port_regs
operator|->
name|rd_only_wr_en
argument_list|,
operator|(
name|enable
operator|==
name|AL_TRUE
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
comment|/* when enabling writes to RO, make sure it is committed before trying 	 * to write to RO config space 	 */
if|if
condition|(
name|enable
operator|==
name|AL_TRUE
condition|)
name|al_local_data_memory_barrier
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/** helper function to access dbi_cs2 registers */
end_comment

begin_function
specifier|static
name|void
name|al_reg_write32_dbi_cs2
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|uint32_t
modifier|*
name|offset
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|uintptr_t
name|cs2_bit
init|=
operator|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_3
operator|)
condition|?
literal|0x4000
else|:
literal|0x1000
decl_stmt|;
name|al_reg_write32
argument_list|(
operator|(
name|uint32_t
operator|*
operator|)
operator|(
operator|(
name|uintptr_t
operator|)
name|offset
operator||
name|cs2_bit
operator|)
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|int
name|al_pcie_speed_gen_code
parameter_list|(
name|enum
name|al_pcie_link_speed
name|speed
parameter_list|)
block|{
if|if
condition|(
name|speed
operator|==
name|AL_PCIE_LINK_SPEED_GEN1
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|speed
operator|==
name|AL_PCIE_LINK_SPEED_GEN2
condition|)
return|return
literal|2
return|;
if|if
condition|(
name|speed
operator|==
name|AL_PCIE_LINK_SPEED_GEN3
condition|)
return|return
literal|3
return|;
comment|/* must not be reached */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|void
name|al_pcie_port_link_speed_ctrl_set
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|enum
name|al_pcie_link_speed
name|max_speed
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|al_pcie_port_wr_to_ro_set
argument_list|(
name|pcie_port
argument_list|,
name|AL_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|max_speed
operator|!=
name|AL_PCIE_LINK_SPEED_DEFAULT
condition|)
block|{
name|uint16_t
name|max_speed_val
init|=
operator|(
name|uint16_t
operator|)
name|al_pcie_speed_gen_code
argument_list|(
name|max_speed
argument_list|)
decl_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|(
name|uint32_t
name|__iomem
operator|*
operator|)
operator|(
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|pcie_link_cap_base
operator|)
argument_list|,
literal|0xF
argument_list|,
name|max_speed_val
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|(
name|uint32_t
name|__iomem
operator|*
operator|)
operator|(
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|pcie_cap_base
operator|+
operator|(
name|AL_PCI_EXP_LNKCTL2
operator|>>
literal|2
operator|)
operator|)
argument_list|,
literal|0xF
argument_list|,
name|max_speed_val
argument_list|)
expr_stmt|;
block|}
name|al_pcie_port_wr_to_ro_set
argument_list|(
name|pcie_port
argument_list|,
name|AL_FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|al_pcie_port_link_config
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
specifier|const
name|struct
name|al_pcie_link_params
modifier|*
name|link_params
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|uint8_t
name|max_lanes
init|=
name|pcie_port
operator|->
name|max_lanes
decl_stmt|;
if|if
condition|(
operator|(
name|link_params
operator|->
name|max_payload_size
operator|!=
name|AL_PCIE_MPS_DEFAULT
operator|)
operator|&&
operator|(
name|link_params
operator|->
name|max_payload_size
operator|!=
name|AL_PCIE_MPS_128
operator|)
operator|&&
operator|(
name|link_params
operator|->
name|max_payload_size
operator|!=
name|AL_PCIE_MPS_256
operator|)
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: unsupported Max Payload Size (%u)\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
name|link_params
operator|->
name|max_payload_size
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|al_dbg
argument_list|(
literal|"PCIe %d: link config: max speed gen %d, max lanes %d, reversal %s\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
name|link_params
operator|->
name|max_speed
argument_list|,
name|pcie_port
operator|->
name|max_lanes
argument_list|,
name|link_params
operator|->
name|enable_reversal
condition|?
literal|"enable"
else|:
literal|"disable"
argument_list|)
expr_stmt|;
name|al_pcie_port_link_speed_ctrl_set
argument_list|(
name|pcie_port
argument_list|,
name|link_params
operator|->
name|max_speed
argument_list|)
expr_stmt|;
comment|/* Change Max Payload Size, if needed. 	 * The Max Payload Size is only valid for PF0. 	 */
if|if
condition|(
name|link_params
operator|->
name|max_payload_size
operator|!=
name|AL_PCIE_MPS_DEFAULT
condition|)
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|pcie_dev_ctrl_status
argument_list|,
name|PCIE_PORT_DEV_CTRL_STATUS_MPS_MASK
argument_list|,
name|link_params
operator|->
name|max_payload_size
operator|<<
name|PCIE_PORT_DEV_CTRL_STATUS_MPS_SHIFT
argument_list|)
expr_stmt|;
comment|/** Snap from PCIe core spec: 	 * Link Mode Enable. Sets the number of lanes in the link that you want 	 * to connect to the link partner. When you have unused lanes in your 	 * system, then you must change the value in this register to reflect 	 * the number of lanes. You must also change the value in the 	 * "Predetermined Number of Lanes" field of the "Link Width and Speed 	 * Change Control Register". 	 * 000001: x1 	 * 000011: x2 	 * 000111: x4 	 * 001111: x8 	 * 011111: x16 	 * 111111: x32 (not supported) 	 */
name|al_reg_write32_masked
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|gen2_ctrl
argument_list|,
name|PCIE_PORT_GEN2_CTRL_NUM_OF_LANES_MASK
argument_list|,
name|max_lanes
operator|<<
name|PCIE_PORT_GEN2_CTRL_NUM_OF_LANES_SHIFT
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|port_link_ctrl
argument_list|,
name|PCIE_PORT_LINK_CTRL_LINK_CAPABLE_MASK
argument_list|,
operator|(
name|max_lanes
operator|+
operator|(
name|max_lanes
operator|-
literal|1
operator|)
operator|)
operator|<<
name|PCIE_PORT_LINK_CTRL_LINK_CAPABLE_SHIFT
argument_list|)
expr_stmt|;
comment|/* TODO: add support for reversal mode */
if|if
condition|(
name|link_params
operator|->
name|enable_reversal
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: enabling reversal mode not implemented\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOSYS
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|al_pcie_port_ram_parity_int_config
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|al_bool
name|enable
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|regs
operator|->
name|app
operator|.
name|parity
operator|->
name|en_core
argument_list|,
operator|(
name|enable
operator|==
name|AL_TRUE
operator|)
condition|?
literal|0xffffffff
else|:
literal|0x0
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|&
name|regs
operator|->
name|app
operator|.
name|int_grp_b
operator|->
name|mask
argument_list|,
name|PCIE_W_INT_GRP_B_CAUSE_B_PARITY_ERROR_CORE
argument_list|,
operator|(
name|enable
operator|!=
name|AL_TRUE
operator|)
condition|?
name|PCIE_W_INT_GRP_B_CAUSE_B_PARITY_ERROR_CORE
else|:
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|al_pcie_port_axi_parity_int_config
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|al_bool
name|enable
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|uint32_t
name|parity_enable_mask
init|=
literal|0xffffffff
decl_stmt|;
comment|/** 	 * Addressing RMN: 5603 	 * 	 * RMN description: 	 * u4_ram2p signal false parity error 	 * 	 * Software flow: 	 * Disable parity check for this memory 	 */
if|if
condition|(
name|pcie_port
operator|->
name|rev_id
operator|>=
name|AL_PCIE_REV_ID_3
condition|)
name|parity_enable_mask
operator|&=
operator|~
name|PCIE_AXI_PARITY_EN_AXI_U4_RAM2P
expr_stmt|;
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|parity
operator|.
name|en_axi
argument_list|,
operator|(
name|enable
operator|==
name|AL_TRUE
operator|)
condition|?
name|parity_enable_mask
else|:
literal|0x0
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_3
condition|)
block|{
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|global
argument_list|,
name|PCIE_REV3_AXI_CTRL_GLOBAL_PARITY_CALC_EN_MSTR
operator||
name|PCIE_REV3_AXI_CTRL_GLOBAL_PARITY_ERR_EN_RD
operator||
name|PCIE_REV3_AXI_CTRL_GLOBAL_PARITY_CALC_EN_SLV
operator||
name|PCIE_REV3_AXI_CTRL_GLOBAL_PARITY_ERR_EN_WR
argument_list|,
operator|(
name|enable
operator|==
name|AL_TRUE
operator|)
condition|?
name|PCIE_REV3_AXI_CTRL_GLOBAL_PARITY_CALC_EN_MSTR
operator||
name|PCIE_REV3_AXI_CTRL_GLOBAL_PARITY_ERR_EN_RD
operator||
name|PCIE_REV3_AXI_CTRL_GLOBAL_PARITY_CALC_EN_SLV
operator||
name|PCIE_REV3_AXI_CTRL_GLOBAL_PARITY_ERR_EN_WR
else|:
name|PCIE_REV3_AXI_CTRL_GLOBAL_PARITY_CALC_EN_SLV
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|global
argument_list|,
name|PCIE_REV1_2_AXI_CTRL_GLOBAL_PARITY_CALC_EN_MSTR
operator||
name|PCIE_REV1_2_AXI_CTRL_GLOBAL_PARITY_ERR_EN_RD
operator||
name|PCIE_REV1_2_AXI_CTRL_GLOBAL_PARITY_CALC_EN_SLV
operator||
name|PCIE_REV1_2_AXI_CTRL_GLOBAL_PARITY_ERR_EN_WR
argument_list|,
operator|(
name|enable
operator|==
name|AL_TRUE
operator|)
condition|?
name|PCIE_REV1_2_AXI_CTRL_GLOBAL_PARITY_CALC_EN_MSTR
operator||
name|PCIE_REV1_2_AXI_CTRL_GLOBAL_PARITY_ERR_EN_RD
operator||
name|PCIE_REV1_2_AXI_CTRL_GLOBAL_PARITY_CALC_EN_SLV
operator||
name|PCIE_REV1_2_AXI_CTRL_GLOBAL_PARITY_ERR_EN_WR
else|:
name|PCIE_REV1_2_AXI_CTRL_GLOBAL_PARITY_CALC_EN_SLV
argument_list|)
expr_stmt|;
block|}
name|al_reg_write32_masked
argument_list|(
operator|&
name|regs
operator|->
name|axi
operator|.
name|int_grp_a
operator|->
name|mask
argument_list|,
name|PCIE_AXI_INT_GRP_A_CAUSE_PARITY_ERR_DATA_PATH_RD
operator||
name|PCIE_AXI_INT_GRP_A_CAUSE_PARITY_ERR_OUT_ADDR_RD
operator||
name|PCIE_AXI_INT_GRP_A_CAUSE_PARITY_ERR_OUT_ADDR_WR
operator||
name|PCIE_AXI_INT_GRP_A_CAUSE_PARITY_ERR_OUT_DATA_WR
operator||
name|PCIE_AXI_INT_GRP_A_CAUSE_PARITY_ERROR_AXI
argument_list|,
operator|(
name|enable
operator|!=
name|AL_TRUE
operator|)
condition|?
operator|(
name|PCIE_AXI_INT_GRP_A_CAUSE_PARITY_ERR_DATA_PATH_RD
operator||
name|PCIE_AXI_INT_GRP_A_CAUSE_PARITY_ERR_OUT_ADDR_RD
operator||
name|PCIE_AXI_INT_GRP_A_CAUSE_PARITY_ERR_OUT_ADDR_WR
operator||
name|PCIE_AXI_INT_GRP_A_CAUSE_PARITY_ERR_OUT_DATA_WR
operator||
name|PCIE_AXI_INT_GRP_A_CAUSE_PARITY_ERROR_AXI
operator|)
else|:
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|al_pcie_port_relaxed_pcie_ordering_config
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|struct
name|al_pcie_relaxed_ordering_params
modifier|*
name|relaxed_ordering_params
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|enum
name|al_pcie_operating_mode
name|op_mode
init|=
name|al_pcie_operating_mode_get
argument_list|(
name|pcie_port
argument_list|)
decl_stmt|;
comment|/** 	 * Default: 	 *  - RC: Rx relaxed ordering only 	 *  - EP: TX relaxed ordering only 	 */
name|al_bool
name|tx_relaxed_ordering
init|=
operator|(
name|op_mode
operator|==
name|AL_PCIE_OPERATING_MODE_RC
condition|?
name|AL_FALSE
else|:
name|AL_TRUE
operator|)
decl_stmt|;
name|al_bool
name|rx_relaxed_ordering
init|=
operator|(
name|op_mode
operator|==
name|AL_PCIE_OPERATING_MODE_RC
condition|?
name|AL_TRUE
else|:
name|AL_FALSE
operator|)
decl_stmt|;
if|if
condition|(
name|relaxed_ordering_params
condition|)
block|{
name|tx_relaxed_ordering
operator|=
name|relaxed_ordering_params
operator|->
name|enable_tx_relaxed_ordering
expr_stmt|;
name|rx_relaxed_ordering
operator|=
name|relaxed_ordering_params
operator|->
name|enable_rx_relaxed_ordering
expr_stmt|;
block|}
comment|/** PCIe ordering: 	 *  - disable outbound completion must be stalled behind outbound write 	 *    ordering rule enforcement is disabled for root-port 	 *  - disables read completion on the master port push slave writes for end-point 	 */
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|ordering
operator|.
name|pos_cntl
argument_list|,
name|PCIE_AXI_POS_ORDER_BYPASS_CMPL_AFTER_WR_FIX
operator||
name|PCIE_AXI_POS_ORDER_EP_CMPL_AFTER_WR_DIS
operator||
name|PCIE_AXI_POS_ORDER_EP_CMPL_AFTER_WR_SUPPORT_INTERLV_DIS
operator||
name|PCIE_AXI_POS_ORDER_SEGMENT_BUFFER_DONT_WAIT_FOR_P_WRITES
argument_list|,
operator|(
name|tx_relaxed_ordering
condition|?
operator|(
name|PCIE_AXI_POS_ORDER_BYPASS_CMPL_AFTER_WR_FIX
operator||
name|PCIE_AXI_POS_ORDER_SEGMENT_BUFFER_DONT_WAIT_FOR_P_WRITES
operator|)
else|:
literal|0
operator|)
operator||
operator|(
name|rx_relaxed_ordering
condition|?
operator|(
name|PCIE_AXI_POS_ORDER_EP_CMPL_AFTER_WR_DIS
operator||
name|PCIE_AXI_POS_ORDER_EP_CMPL_AFTER_WR_SUPPORT_INTERLV_DIS
operator|)
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|al_pcie_rev_id_get
parameter_list|(
name|void
name|__iomem
modifier|*
name|pbs_reg_base
parameter_list|,
name|void
name|__iomem
modifier|*
name|pcie_reg_base
parameter_list|)
block|{
name|uint32_t
name|chip_id
decl_stmt|;
name|uint16_t
name|chip_id_dev
decl_stmt|;
name|uint8_t
name|rev_id
decl_stmt|;
name|struct
name|al_pbs_regs
modifier|*
name|pbs_regs
init|=
name|pbs_reg_base
decl_stmt|;
comment|/* get revision ID from PBS' chip_id register */
name|chip_id
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|pbs_regs
operator|->
name|unit
operator|.
name|chip_id
argument_list|)
expr_stmt|;
name|chip_id_dev
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|chip_id
argument_list|,
name|PBS_UNIT_CHIP_ID_DEV_ID_MASK
argument_list|,
name|PBS_UNIT_CHIP_ID_DEV_ID_SHIFT
argument_list|)
expr_stmt|;
if|if
condition|(
name|chip_id_dev
operator|==
name|PBS_UNIT_CHIP_ID_DEV_ID_ALPINE
condition|)
block|{
name|rev_id
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|chip_id
argument_list|,
name|PBS_UNIT_CHIP_ID_DEV_REV_ID_MASK
argument_list|,
name|PBS_UNIT_CHIP_ID_DEV_REV_ID_SHIFT
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|chip_id_dev
operator|==
name|PBS_UNIT_CHIP_ID_DEV_ID_PEAKROCK
condition|)
block|{
name|struct
name|al_pcie_revx_regs
name|__iomem
modifier|*
name|regs
init|=
operator|(
expr|struct
name|al_pcie_revx_regs
name|__iomem
operator|*
operator|)
name|pcie_reg_base
decl_stmt|;
name|uint32_t
name|dev_id
decl_stmt|;
name|dev_id
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|regs
operator|->
name|axi
operator|.
name|device_id
operator|.
name|device_rev_id
argument_list|)
operator|&
name|PCIE_AXI_DEVICE_ID_REG_DEV_ID_MASK
expr_stmt|;
if|if
condition|(
name|dev_id
operator|==
name|PCIE_AXI_DEVICE_ID_REG_DEV_ID_X4
condition|)
block|{
name|rev_id
operator|=
name|AL_PCIE_REV_ID_2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dev_id
operator|==
name|PCIE_AXI_DEVICE_ID_REG_DEV_ID_X8
condition|)
block|{
name|rev_id
operator|=
name|AL_PCIE_REV_ID_3
expr_stmt|;
block|}
else|else
block|{
name|al_warn
argument_list|(
literal|"%s: Revision ID is unknown\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
else|else
block|{
name|al_warn
argument_list|(
literal|"%s: Revision ID is unknown\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
name|rev_id
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|al_pcie_port_lat_rply_timers_config
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
specifier|const
name|struct
name|al_pcie_latency_replay_timers
modifier|*
name|lat_rply_timers
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|uint32_t
name|reg
init|=
literal|0
decl_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
literal|0xFFFF
argument_list|,
literal|0
argument_list|,
name|lat_rply_timers
operator|->
name|round_trip_lat_limit
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
literal|0xFFFF0000
argument_list|,
literal|16
argument_list|,
name|lat_rply_timers
operator|->
name|replay_timer_limit
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|ack_lat_rply_timer
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|al_pcie_ib_hcrd_os_ob_reads_config_default
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|)
block|{
name|struct
name|al_pcie_ib_hcrd_os_ob_reads_config
name|ib_hcrd_os_ob_reads_config
decl_stmt|;
switch|switch
condition|(
name|al_pcie_operating_mode_get
argument_list|(
name|pcie_port
argument_list|)
condition|)
block|{
case|case
name|AL_PCIE_OPERATING_MODE_RC
case|:
if|if
condition|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_3
condition|)
block|{
name|ib_hcrd_os_ob_reads_config
operator|.
name|nof_outstanding_ob_reads
operator|=
name|AL_PCIE_REV_3_RC_OB_OS_READS_DEFAULT
expr_stmt|;
name|ib_hcrd_os_ob_reads_config
operator|.
name|nof_cpl_hdr
operator|=
name|AL_PCIE_REV_3_RC_NOF_CPL_HDR_DEFAULT
expr_stmt|;
name|ib_hcrd_os_ob_reads_config
operator|.
name|nof_np_hdr
operator|=
name|AL_PCIE_REV_3_RC_NOF_NP_HDR_DEFAULT
expr_stmt|;
name|ib_hcrd_os_ob_reads_config
operator|.
name|nof_p_hdr
operator|=
name|AL_PCIE_REV_3_RC_NOF_P_HDR_DEFAULT
expr_stmt|;
block|}
else|else
block|{
name|ib_hcrd_os_ob_reads_config
operator|.
name|nof_outstanding_ob_reads
operator|=
name|AL_PCIE_REV_1_2_RC_OB_OS_READS_DEFAULT
expr_stmt|;
name|ib_hcrd_os_ob_reads_config
operator|.
name|nof_cpl_hdr
operator|=
name|AL_PCIE_REV_1_2_RC_NOF_CPL_HDR_DEFAULT
expr_stmt|;
name|ib_hcrd_os_ob_reads_config
operator|.
name|nof_np_hdr
operator|=
name|AL_PCIE_REV_1_2_RC_NOF_NP_HDR_DEFAULT
expr_stmt|;
name|ib_hcrd_os_ob_reads_config
operator|.
name|nof_p_hdr
operator|=
name|AL_PCIE_REV_1_2_RC_NOF_P_HDR_DEFAULT
expr_stmt|;
block|}
break|break;
case|case
name|AL_PCIE_OPERATING_MODE_EP
case|:
if|if
condition|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_3
condition|)
block|{
name|ib_hcrd_os_ob_reads_config
operator|.
name|nof_outstanding_ob_reads
operator|=
name|AL_PCIE_REV_3_EP_OB_OS_READS_DEFAULT
expr_stmt|;
name|ib_hcrd_os_ob_reads_config
operator|.
name|nof_cpl_hdr
operator|=
name|AL_PCIE_REV_3_EP_NOF_CPL_HDR_DEFAULT
expr_stmt|;
name|ib_hcrd_os_ob_reads_config
operator|.
name|nof_np_hdr
operator|=
name|AL_PCIE_REV_3_EP_NOF_NP_HDR_DEFAULT
expr_stmt|;
name|ib_hcrd_os_ob_reads_config
operator|.
name|nof_p_hdr
operator|=
name|AL_PCIE_REV_3_EP_NOF_P_HDR_DEFAULT
expr_stmt|;
block|}
else|else
block|{
name|ib_hcrd_os_ob_reads_config
operator|.
name|nof_outstanding_ob_reads
operator|=
name|AL_PCIE_REV_1_2_EP_OB_OS_READS_DEFAULT
expr_stmt|;
name|ib_hcrd_os_ob_reads_config
operator|.
name|nof_cpl_hdr
operator|=
name|AL_PCIE_REV_1_2_EP_NOF_CPL_HDR_DEFAULT
expr_stmt|;
name|ib_hcrd_os_ob_reads_config
operator|.
name|nof_np_hdr
operator|=
name|AL_PCIE_REV_1_2_EP_NOF_NP_HDR_DEFAULT
expr_stmt|;
name|ib_hcrd_os_ob_reads_config
operator|.
name|nof_p_hdr
operator|=
name|AL_PCIE_REV_1_2_EP_NOF_P_HDR_DEFAULT
expr_stmt|;
block|}
break|break;
default|default:
name|al_err
argument_list|(
literal|"PCIe %d: outstanding outbound transactions could not be configured - unknown operating mode\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
name|al_assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|al_pcie_port_ib_hcrd_os_ob_reads_config
argument_list|(
name|pcie_port
argument_list|,
operator|&
name|ib_hcrd_os_ob_reads_config
argument_list|)
expr_stmt|;
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_comment
comment|/** return AL_TRUE is link started (LTSSM enabled) and AL_FALSE otherwise */
end_comment

begin_function
specifier|static
name|al_bool
name|al_pcie_is_link_started
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
operator|(
expr|struct
name|al_pcie_regs
operator|*
operator|)
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|uint32_t
name|port_init
init|=
name|al_reg_read32
argument_list|(
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|port_init
argument_list|)
decl_stmt|;
name|uint8_t
name|ltssm_en
init|=
name|AL_REG_FIELD_GET
argument_list|(
name|port_init
argument_list|,
name|PCIE_W_GLOBAL_CTRL_PORT_INIT_APP_LTSSM_EN_MASK
argument_list|,
name|PCIE_W_GLOBAL_CTRL_PORT_INIT_APP_LTSSM_EN_SHIFT
argument_list|)
decl_stmt|;
return|return
name|ltssm_en
return|;
block|}
end_function

begin_comment
comment|/** return AL_TRUE if link is up, AL_FALSE otherwise */
end_comment

begin_function
specifier|static
name|al_bool
name|al_pcie_check_link
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|uint8_t
modifier|*
name|ltssm_ret
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
operator|(
expr|struct
name|al_pcie_regs
operator|*
operator|)
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|uint32_t
name|info_0
decl_stmt|;
name|uint8_t
name|ltssm_state
decl_stmt|;
name|info_0
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|regs
operator|->
name|app
operator|.
name|debug
operator|->
name|info_0
argument_list|)
expr_stmt|;
name|ltssm_state
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|info_0
argument_list|,
name|PCIE_W_DEBUG_INFO_0_LTSSM_STATE_MASK
argument_list|,
name|PCIE_W_DEBUG_INFO_0_LTSSM_STATE_SHIFT
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"PCIe %d: Port Debug 0: 0x%08x. LTSSM state :0x%x\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
name|info_0
argument_list|,
name|ltssm_state
argument_list|)
expr_stmt|;
if|if
condition|(
name|ltssm_ret
condition|)
operator|*
name|ltssm_ret
operator|=
name|ltssm_state
expr_stmt|;
if|if
condition|(
operator|(
name|ltssm_state
operator|==
name|AL_PCIE_LTSSM_STATE_L0
operator|)
operator|||
operator|(
name|ltssm_state
operator|==
name|AL_PCIE_LTSSM_STATE_L0S
operator|)
condition|)
return|return
name|AL_TRUE
return|;
return|return
name|AL_FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|al_pcie_port_gen2_params_config
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
specifier|const
name|struct
name|al_pcie_gen2_params
modifier|*
name|gen2_params
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|uint32_t
name|gen2_ctrl
decl_stmt|;
name|al_dbg
argument_list|(
literal|"PCIe %d: Gen2 params config: Tx Swing %s, interrupt on link Eq %s, set Deemphasis %s\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
name|gen2_params
operator|->
name|tx_swing_low
condition|?
literal|"Low"
else|:
literal|"Full"
argument_list|,
name|gen2_params
operator|->
name|tx_compliance_receive_enable
condition|?
literal|"enable"
else|:
literal|"disable"
argument_list|,
name|gen2_params
operator|->
name|set_deemphasis
condition|?
literal|"enable"
else|:
literal|"disable"
argument_list|)
expr_stmt|;
name|gen2_ctrl
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|gen2_ctrl
argument_list|)
expr_stmt|;
if|if
condition|(
name|gen2_params
operator|->
name|tx_swing_low
condition|)
name|AL_REG_BIT_SET
argument_list|(
name|gen2_ctrl
argument_list|,
name|PCIE_PORT_GEN2_CTRL_TX_SWING_LOW_SHIFT
argument_list|)
expr_stmt|;
else|else
name|AL_REG_BIT_CLEAR
argument_list|(
name|gen2_ctrl
argument_list|,
name|PCIE_PORT_GEN2_CTRL_TX_SWING_LOW_SHIFT
argument_list|)
expr_stmt|;
if|if
condition|(
name|gen2_params
operator|->
name|tx_compliance_receive_enable
condition|)
name|AL_REG_BIT_SET
argument_list|(
name|gen2_ctrl
argument_list|,
name|PCIE_PORT_GEN2_CTRL_TX_COMPLIANCE_RCV_SHIFT
argument_list|)
expr_stmt|;
else|else
name|AL_REG_BIT_CLEAR
argument_list|(
name|gen2_ctrl
argument_list|,
name|PCIE_PORT_GEN2_CTRL_TX_COMPLIANCE_RCV_SHIFT
argument_list|)
expr_stmt|;
if|if
condition|(
name|gen2_params
operator|->
name|set_deemphasis
condition|)
name|AL_REG_BIT_SET
argument_list|(
name|gen2_ctrl
argument_list|,
name|PCIE_PORT_GEN2_CTRL_DEEMPHASIS_SET_SHIFT
argument_list|)
expr_stmt|;
else|else
name|AL_REG_BIT_CLEAR
argument_list|(
name|gen2_ctrl
argument_list|,
name|PCIE_PORT_GEN2_CTRL_DEEMPHASIS_SET_SHIFT
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|gen2_ctrl
argument_list|,
name|gen2_ctrl
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|uint16_t
name|gen3_lane_eq_param_to_val
parameter_list|(
specifier|const
name|struct
name|al_pcie_gen3_lane_eq_params
modifier|*
name|eq_params
parameter_list|)
block|{
name|uint16_t
name|eq_control
init|=
literal|0
decl_stmt|;
name|eq_control
operator|=
name|eq_params
operator|->
name|downstream_port_transmitter_preset
operator|&
literal|0xF
expr_stmt|;
name|eq_control
operator||=
operator|(
name|eq_params
operator|->
name|downstream_port_receiver_preset_hint
operator|&
literal|0x7
operator|)
operator|<<
literal|4
expr_stmt|;
name|eq_control
operator||=
operator|(
name|eq_params
operator|->
name|upstream_port_transmitter_preset
operator|&
literal|0xF
operator|)
operator|<<
literal|8
expr_stmt|;
name|eq_control
operator||=
operator|(
name|eq_params
operator|->
name|upstream_port_receiver_preset_hint
operator|&
literal|0x7
operator|)
operator|<<
literal|12
expr_stmt|;
return|return
name|eq_control
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|al_pcie_port_gen3_params_config
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
specifier|const
name|struct
name|al_pcie_gen3_params
modifier|*
name|gen3_params
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|uint32_t
name|reg
init|=
literal|0
decl_stmt|;
name|uint16_t
name|__iomem
modifier|*
name|lanes_eq_base
init|=
operator|(
name|uint16_t
name|__iomem
operator|*
operator|)
operator|(
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|pcie_sec_ext_cap_base
operator|+
operator|(
literal|0xC
operator|>>
literal|2
operator|)
operator|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|al_dbg
argument_list|(
literal|"PCIe %d: Gen3 params config: Equalization %s, interrupt on link Eq %s\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
name|gen3_params
operator|->
name|perform_eq
condition|?
literal|"enable"
else|:
literal|"disable"
argument_list|,
name|gen3_params
operator|->
name|interrupt_enable_on_link_eq_request
condition|?
literal|"enable"
else|:
literal|"disable"
argument_list|)
expr_stmt|;
if|if
condition|(
name|gen3_params
operator|->
name|perform_eq
condition|)
name|AL_REG_BIT_SET
argument_list|(
name|reg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|gen3_params
operator|->
name|interrupt_enable_on_link_eq_request
condition|)
name|AL_REG_BIT_SET
argument_list|(
name|reg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|pcie_sec_ext_cap_base
operator|+
operator|(
literal|4
operator|>>
literal|2
operator|)
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_pcie_port_wr_to_ro_set
argument_list|(
name|pcie_port
argument_list|,
name|AL_TRUE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|gen3_params
operator|->
name|eq_params_elements
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|uint32_t
name|eq_control
init|=
operator|(
name|uint32_t
operator|)
name|gen3_lane_eq_param_to_val
argument_list|(
name|gen3_params
operator|->
name|eq_params
operator|+
name|i
argument_list|)
operator||
operator|(
name|uint32_t
operator|)
name|gen3_lane_eq_param_to_val
argument_list|(
name|gen3_params
operator|->
name|eq_params
operator|+
name|i
operator|+
literal|1
argument_list|)
operator|<<
literal|16
decl_stmt|;
name|al_dbg
argument_list|(
literal|"PCIe %d: Set EQ (0x%08x) for lane %d, %d\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
name|eq_control
argument_list|,
name|i
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|(
name|uint32_t
operator|*
operator|)
operator|(
name|lanes_eq_base
operator|+
name|i
operator|)
argument_list|,
name|eq_control
argument_list|)
expr_stmt|;
block|}
name|al_pcie_port_wr_to_ro_set
argument_list|(
name|pcie_port
argument_list|,
name|AL_FALSE
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|gen3_ctrl
argument_list|)
expr_stmt|;
if|if
condition|(
name|gen3_params
operator|->
name|eq_disable
condition|)
name|AL_REG_BIT_SET
argument_list|(
name|reg
argument_list|,
name|PCIE_PORT_GEN3_CTRL_EQ_DISABLE_SHIFT
argument_list|)
expr_stmt|;
else|else
name|AL_REG_BIT_CLEAR
argument_list|(
name|reg
argument_list|,
name|PCIE_PORT_GEN3_CTRL_EQ_DISABLE_SHIFT
argument_list|)
expr_stmt|;
if|if
condition|(
name|gen3_params
operator|->
name|eq_phase2_3_disable
condition|)
name|AL_REG_BIT_SET
argument_list|(
name|reg
argument_list|,
name|PCIE_PORT_GEN3_CTRL_EQ_PHASE_2_3_DISABLE_SHIFT
argument_list|)
expr_stmt|;
else|else
name|AL_REG_BIT_CLEAR
argument_list|(
name|reg
argument_list|,
name|PCIE_PORT_GEN3_CTRL_EQ_PHASE_2_3_DISABLE_SHIFT
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|gen3_ctrl
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
literal|0
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|PCIE_PORT_GEN3_EQ_LF_MASK
argument_list|,
name|PCIE_PORT_GEN3_EQ_LF_SHIFT
argument_list|,
name|gen3_params
operator|->
name|local_lf
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|PCIE_PORT_GEN3_EQ_FS_MASK
argument_list|,
name|PCIE_PORT_GEN3_EQ_FS_SHIFT
argument_list|,
name|gen3_params
operator|->
name|local_fs
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|gen3_eq_fs_lf
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
literal|0
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|PCIE_AXI_MISC_ZERO_LANEX_PHY_MAC_LOCAL_LF_MASK
argument_list|,
name|PCIE_AXI_MISC_ZERO_LANEX_PHY_MAC_LOCAL_LF_SHIFT
argument_list|,
name|gen3_params
operator|->
name|local_lf
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|PCIE_AXI_MISC_ZERO_LANEX_PHY_MAC_LOCAL_FS_MASK
argument_list|,
name|PCIE_AXI_MISC_ZERO_LANEX_PHY_MAC_LOCAL_FS_SHIFT
argument_list|,
name|gen3_params
operator|->
name|local_fs
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane0
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane1
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane2
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane3
argument_list|,
name|reg
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_3
condition|)
block|{
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane4
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane5
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane6
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane7
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Gen3 EQ Control Register: 	 * - Preset Request Vector - request 9 	 * - Behavior After 24 ms Timeout (when optimal settings are not 	 *   found): Recovery.Equalization.RcvrLock 	 * - Phase2_3 2 ms Timeout Disable 	 * - Feedback Mode - Figure Of Merit 	 */
name|reg
operator|=
literal|0x00020031
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|gen3_eq_ctrl
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|int
name|al_pcie_port_tl_credits_config
argument_list|(
expr|struct
name|al_pcie_port
operator|*
name|pcie_port
argument_list|,
specifier|const
expr|struct
name|al_pcie_tl_credits_params
operator|*
name|tl_credits
name|__attribute__
argument_list|(
operator|(
name|__unused__
operator|)
argument_list|)
argument_list|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: transport layer credits config not implemented\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOSYS
return|;
block|}
end_decl_stmt

begin_function
specifier|static
name|int
name|al_pcie_port_pf_params_config
parameter_list|(
name|struct
name|al_pcie_pf
modifier|*
name|pcie_pf
parameter_list|,
specifier|const
name|struct
name|al_pcie_pf_config_params
modifier|*
name|pf_params
parameter_list|)
block|{
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
init|=
name|pcie_pf
operator|->
name|pcie_port
decl_stmt|;
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|unsigned
name|int
name|pf_num
init|=
name|pcie_pf
operator|->
name|pf_num
decl_stmt|;
name|int
name|bar_idx
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|al_pcie_port_wr_to_ro_set
argument_list|(
name|pcie_port
argument_list|,
name|AL_TRUE
argument_list|)
expr_stmt|;
comment|/* Disable D1 and D3hot capabilities */
if|if
condition|(
name|pf_params
operator|->
name|cap_d1_d3hot_dis
condition|)
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|core_space
index|[
name|pf_num
index|]
operator|.
name|pcie_pm_cap_base
argument_list|,
name|AL_FIELD_MASK
argument_list|(
literal|26
argument_list|,
literal|25
argument_list|)
operator||
name|AL_FIELD_MASK
argument_list|(
literal|31
argument_list|,
literal|28
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Disable FLR capability */
if|if
condition|(
name|pf_params
operator|->
name|cap_flr_dis
condition|)
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|core_space
index|[
name|pf_num
index|]
operator|.
name|pcie_dev_cap_base
argument_list|,
name|AL_BIT
argument_list|(
literal|28
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Disable ASPM capability */
if|if
condition|(
name|pf_params
operator|->
name|cap_aspm_dis
condition|)
block|{
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|core_space
index|[
name|pf_num
index|]
operator|.
name|pcie_cap_base
operator|+
operator|(
name|AL_PCI_EXP_LNKCAP
operator|>>
literal|2
operator|)
argument_list|,
name|AL_PCI_EXP_LNKCAP_ASPMS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_0
condition|)
block|{
name|al_warn
argument_list|(
literal|"%s: ASPM support is enabled, please disable it\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
operator|!
name|pf_params
operator|->
name|bar_params_valid
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
goto|goto
name|done
goto|;
block|}
for|for
control|(
name|bar_idx
operator|=
literal|0
init|;
name|bar_idx
operator|<
literal|6
condition|;
control|)
block|{
comment|/* bar_idx will be incremented depending on bar type */
specifier|const
name|struct
name|al_pcie_ep_bar_params
modifier|*
name|params
init|=
name|pf_params
operator|->
name|bar_params
operator|+
name|bar_idx
decl_stmt|;
name|uint32_t
name|mask
init|=
literal|0
decl_stmt|;
name|uint32_t
name|ctrl
init|=
literal|0
decl_stmt|;
name|uint32_t
name|__iomem
modifier|*
name|bar_addr
init|=
operator|&
name|regs
operator|->
name|core_space
index|[
name|pf_num
index|]
operator|.
name|config_header
index|[
operator|(
name|AL_PCI_BASE_ADDRESS_0
operator|>>
literal|2
operator|)
operator|+
name|bar_idx
index|]
decl_stmt|;
if|if
condition|(
name|params
operator|->
name|enable
condition|)
block|{
name|uint64_t
name|size
init|=
name|params
operator|->
name|size
decl_stmt|;
if|if
condition|(
name|params
operator|->
name|memory_64_bit
condition|)
block|{
specifier|const
name|struct
name|al_pcie_ep_bar_params
modifier|*
name|next_params
init|=
name|params
operator|+
literal|1
decl_stmt|;
comment|/* 64 bars start at even index (BAR0, BAR 2 or BAR 4) */
if|if
condition|(
name|bar_idx
operator|&
literal|1
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* next BAR must be disabled */
if|if
condition|(
name|next_params
operator|->
name|enable
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* 64 bar must be memory bar */
if|if
condition|(
operator|!
name|params
operator|->
name|memory_space
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|size
operator|>
name|AL_PCIE_MAX_32_MEMORY_BAR_SIZE
condition|)
return|return
operator|-
name|EINVAL
return|;
comment|/* 32 bit space can't be prefetchable */
if|if
condition|(
name|params
operator|->
name|memory_is_prefetchable
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
if|if
condition|(
name|params
operator|->
name|memory_space
condition|)
block|{
if|if
condition|(
name|size
operator|<
name|AL_PCIE_MIN_MEMORY_BAR_SIZE
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: memory BAR %d: size (0x%llx) less that minimal allowed value\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
name|bar_idx
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
else|else
block|{
comment|/* IO can't be prefetchable */
if|if
condition|(
name|params
operator|->
name|memory_is_prefetchable
condition|)
block|{
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|size
operator|<
name|AL_PCIE_MIN_IO_BAR_SIZE
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: IO BAR %d: size (0x%llx) less that minimal allowed value\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
name|bar_idx
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
comment|/* size must be power of 2 */
if|if
condition|(
name|size
operator|&
operator|(
name|size
operator|-
literal|1
operator|)
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: BAR %d:size (0x%llx) must be "
literal|"power of 2\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
name|bar_idx
argument_list|,
name|size
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* If BAR is 64-bit, disable the next BAR before 			 * configuring this one 			 */
if|if
condition|(
name|params
operator|->
name|memory_64_bit
condition|)
name|al_reg_write32_dbi_cs2
argument_list|(
name|pcie_port
argument_list|,
name|bar_addr
operator|+
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mask
operator|=
literal|1
expr_stmt|;
comment|/* enable bit*/
name|mask
operator||=
operator|(
name|params
operator|->
name|size
operator|-
literal|1
operator|)
operator|&
literal|0xFFFFFFFF
expr_stmt|;
name|al_reg_write32_dbi_cs2
argument_list|(
name|pcie_port
argument_list|,
name|bar_addr
argument_list|,
name|mask
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|memory_space
operator|==
name|AL_FALSE
condition|)
name|ctrl
operator|=
name|AL_PCI_BASE_ADDRESS_SPACE_IO
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|memory_64_bit
condition|)
name|ctrl
operator||=
name|AL_PCI_BASE_ADDRESS_MEM_TYPE_64
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|memory_is_prefetchable
condition|)
name|ctrl
operator||=
name|AL_PCI_BASE_ADDRESS_MEM_PREFETCH
expr_stmt|;
name|al_reg_write32
argument_list|(
name|bar_addr
argument_list|,
name|ctrl
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|memory_64_bit
condition|)
block|{
name|mask
operator|=
operator|(
operator|(
name|params
operator|->
name|size
operator|-
literal|1
operator|)
operator|>>
literal|32
operator|)
operator|&
literal|0xFFFFFFFF
expr_stmt|;
name|al_reg_write32_dbi_cs2
argument_list|(
name|pcie_port
argument_list|,
name|bar_addr
operator|+
literal|1
argument_list|,
name|mask
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|al_reg_write32_dbi_cs2
argument_list|(
name|pcie_port
argument_list|,
name|bar_addr
argument_list|,
name|mask
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|params
operator|->
name|enable
operator|&&
name|params
operator|->
name|memory_64_bit
condition|)
name|bar_idx
operator|+=
literal|2
expr_stmt|;
else|else
name|bar_idx
operator|+=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|pf_params
operator|->
name|exp_bar_params
operator|.
name|enable
condition|)
block|{
if|if
condition|(
name|pcie_port
operator|->
name|rev_id
operator|!=
name|AL_PCIE_REV_ID_3
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: Expansion BAR enable not supported\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|ENOSYS
expr_stmt|;
goto|goto
name|done
goto|;
block|}
else|else
block|{
comment|/* Enable exp ROM */
name|uint32_t
name|__iomem
modifier|*
name|exp_rom_bar_addr
init|=
operator|&
name|regs
operator|->
name|core_space
index|[
name|pf_num
index|]
operator|.
name|config_header
index|[
name|AL_PCI_EXP_ROM_BASE_ADDRESS
operator|>>
literal|2
index|]
decl_stmt|;
name|uint32_t
name|mask
init|=
literal|1
decl_stmt|;
comment|/* enable bit*/
name|mask
operator||=
operator|(
name|pf_params
operator|->
name|exp_bar_params
operator|.
name|size
operator|-
literal|1
operator|)
operator|&
literal|0xFFFFFFFF
expr_stmt|;
name|al_reg_write32_dbi_cs2
argument_list|(
name|pcie_port
argument_list|,
name|exp_rom_bar_addr
argument_list|,
name|mask
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_3
condition|)
block|{
comment|/* Disable exp ROM */
name|uint32_t
name|__iomem
modifier|*
name|exp_rom_bar_addr
init|=
operator|&
name|regs
operator|->
name|core_space
index|[
name|pf_num
index|]
operator|.
name|config_header
index|[
name|AL_PCI_EXP_ROM_BASE_ADDRESS
operator|>>
literal|2
index|]
decl_stmt|;
name|al_reg_write32_dbi_cs2
argument_list|(
name|pcie_port
argument_list|,
name|exp_rom_bar_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
comment|/* Open CPU generated msi and legacy interrupts in pcie wrapper logic */
if|if
condition|(
operator|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_0
operator|)
operator|||
operator|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_1
operator|)
condition|)
block|{
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|app
operator|.
name|soc_int
index|[
name|pf_num
index|]
operator|.
name|mask_inta_leg_0
argument_list|,
operator|(
literal|1
operator|<<
literal|21
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_2
operator|)
operator|||
operator|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_3
operator|)
condition|)
block|{
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|app
operator|.
name|soc_int
index|[
name|pf_num
index|]
operator|.
name|mask_inta_leg_3
argument_list|,
operator|(
literal|1
operator|<<
literal|18
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|al_assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|ENOSYS
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/** 	 * Addressing RMN: 1547 	 * 	 * RMN description: 	 * 1. Whenever writing to 0x2xx offset, the write also happens to 	 * 0x3xx address, meaning two registers are written instead of one. 	 * 2. Read and write from 0x3xx work ok. 	 * 	 * Software flow: 	 * Backup the value of the app.int_grp_a.mask_a register, because 	 * app.int_grp_a.mask_clear_a gets overwritten during the write to 	 * app.soc.mask_msi_leg_0 register. 	 * Restore the original value after the write to app.soc.mask_msi_leg_0 	 * register. 	 */
if|if
condition|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_0
condition|)
block|{
name|uint32_t
name|backup
decl_stmt|;
name|backup
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|regs
operator|->
name|app
operator|.
name|int_grp_a
operator|->
name|mask
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|app
operator|.
name|soc_int
index|[
name|pf_num
index|]
operator|.
name|mask_msi_leg_0
argument_list|,
operator|(
literal|1
operator|<<
literal|22
operator|)
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|regs
operator|->
name|app
operator|.
name|int_grp_a
operator|->
name|mask
argument_list|,
name|backup
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_1
condition|)
block|{
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|app
operator|.
name|soc_int
index|[
name|pf_num
index|]
operator|.
name|mask_msi_leg_0
argument_list|,
operator|(
literal|1
operator|<<
literal|22
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_2
operator|)
operator|||
operator|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_3
operator|)
condition|)
block|{
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|app
operator|.
name|soc_int
index|[
name|pf_num
index|]
operator|.
name|mask_msi_leg_3
argument_list|,
operator|(
literal|1
operator|<<
literal|19
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|al_assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|ENOSYS
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|ret
operator|=
literal|0
expr_stmt|;
name|done
label|:
name|al_pcie_port_wr_to_ro_set
argument_list|(
name|pcie_port
argument_list|,
name|AL_FALSE
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|al_pcie_port_features_config
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
specifier|const
name|struct
name|al_pcie_features
modifier|*
name|features
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|al_assert
argument_list|(
name|pcie_port
operator|->
name|rev_id
operator|>
name|AL_PCIE_REV_ID_0
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|&
name|regs
operator|->
name|app
operator|.
name|ctrl_gen
operator|->
name|features
argument_list|,
name|PCIE_W_CTRL_GEN_FEATURES_SATA_EP_MSI_FIX
argument_list|,
name|features
operator|->
name|sata_ep_msi_fix
condition|?
name|PCIE_W_CTRL_GEN_FEATURES_SATA_EP_MSI_FIX
else|:
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|al_pcie_port_sris_config
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|struct
name|al_pcie_sris_params
modifier|*
name|sris_params
parameter_list|,
name|enum
name|al_pcie_link_speed
name|link_speed
parameter_list|)
block|{
name|int
name|rc
init|=
literal|0
decl_stmt|;
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
if|if
condition|(
name|sris_params
operator|->
name|use_defaults
condition|)
block|{
name|sris_params
operator|->
name|kp_counter_gen3
operator|=
operator|(
name|pcie_port
operator|->
name|rev_id
operator|>
name|AL_PCIE_REV_ID_1
operator|)
condition|?
name|PCIE_SRIS_KP_COUNTER_GEN3_DEFAULT_VAL
else|:
literal|0
expr_stmt|;
name|sris_params
operator|->
name|kp_counter_gen21
operator|=
name|PCIE_SRIS_KP_COUNTER_GEN21_DEFAULT_VAL
expr_stmt|;
name|al_dbg
argument_list|(
literal|"PCIe %d: configuring SRIS with default values kp_gen3[%d] kp_gen21[%d]\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
name|sris_params
operator|->
name|kp_counter_gen3
argument_list|,
name|sris_params
operator|->
name|kp_counter_gen21
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|pcie_port
operator|->
name|rev_id
condition|)
block|{
case|case
name|AL_PCIE_REV_ID_3
case|:
case|case
name|AL_PCIE_REV_ID_2
case|:
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|sris_kp_counter
argument_list|,
name|PCIE_W_GLOBAL_CTRL_SRIS_KP_COUNTER_VALUE_GEN3_SRIS_MASK
operator||
name|PCIE_W_GLOBAL_CTRL_SRIS_KP_COUNTER_VALUE_GEN21_SRIS_MASK
operator||
name|PCIE_W_GLOBAL_CTRL_SRIS_KP_COUNTER_VALUE_PCIE_X4_SRIS_EN
argument_list|,
operator|(
name|sris_params
operator|->
name|kp_counter_gen3
operator|<<
name|PCIE_W_GLOBAL_CTRL_SRIS_KP_COUNTER_VALUE_GEN3_SRIS_SHIFT
operator|)
operator||
operator|(
name|sris_params
operator|->
name|kp_counter_gen21
operator|<<
name|PCIE_W_GLOBAL_CTRL_SRIS_KP_COUNTER_VALUE_GEN21_SRIS_SHIFT
operator|)
operator||
name|PCIE_W_GLOBAL_CTRL_SRIS_KP_COUNTER_VALUE_PCIE_X4_SRIS_EN
argument_list|)
expr_stmt|;
break|break;
case|case
name|AL_PCIE_REV_ID_1
case|:
if|if
condition|(
operator|(
name|link_speed
operator|==
name|AL_PCIE_LINK_SPEED_GEN3
operator|)
operator|&&
operator|(
name|sris_params
operator|->
name|kp_counter_gen3
operator|)
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: cannot config Gen%d SRIS with rev_id[%d]\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
name|al_pcie_speed_gen_code
argument_list|(
name|link_speed
argument_list|)
argument_list|,
name|pcie_port
operator|->
name|rev_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|al_reg_write32_masked
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|filter_mask_reg_1
argument_list|,
name|PCIE_FLT_MASK_SKP_INT_VAL_MASK
argument_list|,
name|sris_params
operator|->
name|kp_counter_gen21
argument_list|)
expr_stmt|;
break|break;
default|default:
name|al_err
argument_list|(
literal|"PCIe %d: SRIS config is not supported in rev_id[%d]\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
name|pcie_port
operator|->
name|rev_id
argument_list|)
expr_stmt|;
name|al_assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|al_pcie_port_ib_hcrd_config
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|vc0_posted_rcv_q_ctrl
argument_list|,
name|RADM_PQ_HCRD_VC0_MASK
argument_list|,
operator|(
name|pcie_port
operator|->
name|ib_hcrd_config
operator|.
name|nof_p_hdr
operator|-
literal|1
operator|)
operator|<<
name|RADM_PQ_HCRD_VC0_SHIFT
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|vc0_non_posted_rcv_q_ctrl
argument_list|,
name|RADM_NPQ_HCRD_VC0_MASK
argument_list|,
operator|(
name|pcie_port
operator|->
name|ib_hcrd_config
operator|.
name|nof_np_hdr
operator|-
literal|1
operator|)
operator|<<
name|RADM_NPQ_HCRD_VC0_SHIFT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|int
name|al_pcie_port_max_num_of_pfs_get
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|uint32_t
name|max_func_num
decl_stmt|;
name|uint32_t
name|max_num_of_pfs
decl_stmt|;
comment|/** 	 * Only in REV3, when port is already enabled, max_num_of_pfs is already 	 * initialized, return it. Otherwise, return default: 1 PF 	 */
if|if
condition|(
operator|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_3
operator|)
operator|&&
name|al_pcie_port_is_enabled
argument_list|(
name|pcie_port
argument_list|)
condition|)
block|{
name|max_func_num
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|timer_ctrl_max_func_num
argument_list|)
expr_stmt|;
name|max_num_of_pfs
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|max_func_num
argument_list|,
name|PCIE_PORT_GEN3_MAX_FUNC_NUM
argument_list|,
literal|0
argument_list|)
operator|+
literal|1
expr_stmt|;
return|return
name|max_num_of_pfs
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/***************************** API Implementation *****************************/
end_comment

begin_comment
comment|/******************************************************************************/
end_comment

begin_comment
comment|/*************************** PCIe Initialization API **************************/
end_comment

begin_comment
comment|/**  * Initializes a PCIe port handle structure  * Caution: this function should not read/write to any register except for  * reading RO register (REV_ID for example)  */
end_comment

begin_function
name|int
name|al_pcie_port_handle_init
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|void
name|__iomem
modifier|*
name|pcie_reg_base
parameter_list|,
name|void
name|__iomem
modifier|*
name|pbs_reg_base
parameter_list|,
name|unsigned
name|int
name|port_id
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|pcie_port
operator|->
name|pcie_reg_base
operator|=
name|pcie_reg_base
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|=
operator|&
name|pcie_port
operator|->
name|regs_ptrs
expr_stmt|;
name|pcie_port
operator|->
name|ex_regs
operator|=
name|NULL
expr_stmt|;
name|pcie_port
operator|->
name|pbs_regs
operator|=
name|pbs_reg_base
expr_stmt|;
name|pcie_port
operator|->
name|port_id
operator|=
name|port_id
expr_stmt|;
name|pcie_port
operator|->
name|max_lanes
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|al_pcie_rev_id_get
argument_list|(
name|pbs_reg_base
argument_list|,
name|pcie_reg_base
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
return|return
name|ret
return|;
name|pcie_port
operator|->
name|rev_id
operator|=
name|ret
expr_stmt|;
comment|/* Zero all regs */
name|al_memset
argument_list|(
name|pcie_port
operator|->
name|regs
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|al_pcie_regs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_0
operator|)
operator|||
operator|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_1
operator|)
condition|)
block|{
name|struct
name|al_pcie_rev1_regs
name|__iomem
modifier|*
name|regs
init|=
operator|(
expr|struct
name|al_pcie_rev1_regs
name|__iomem
operator|*
operator|)
name|pcie_reg_base
decl_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|global
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|global
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|master_arctl
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|master_arctl
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|master_awctl
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|master_awctl
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|slv_ctl
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|slv_ctl
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|cfg_target_bus
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|cfg_target_bus
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|cfg_control
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|cfg_control
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_start_l
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_start_l
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_start_h
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_start_h
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_limit_l
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_limit_l
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_limit_h
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_limit_h
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|pcie_global
operator|.
name|conf
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|pcie_global
operator|.
name|conf
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane0
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane0
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane1
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane1
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane2
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane2
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane3
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane3
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane
index|[
literal|0
index|]
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane0
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane
index|[
literal|1
index|]
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane1
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane
index|[
literal|2
index|]
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane2
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane
index|[
literal|3
index|]
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane3
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|parity
operator|.
name|en_axi
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|parity
operator|.
name|en_axi
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ordering
operator|.
name|pos_cntl
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ordering
operator|.
name|pos_cntl
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|pre_configuration
operator|.
name|pcie_core_setup
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|pre_configuration
operator|.
name|pcie_core_setup
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|init_fc
operator|.
name|cfg
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|init_fc
operator|.
name|cfg
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|int_grp_a
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|int_grp_a
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|port_init
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|port_init
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|pm_control
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|pm_control
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|events_gen
index|[
literal|0
index|]
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|events_gen
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|debug
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|debug
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|soc_int
index|[
literal|0
index|]
operator|.
name|mask_inta_leg_0
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|soc_int
operator|.
name|mask_inta_leg_0
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|soc_int
index|[
literal|0
index|]
operator|.
name|mask_msi_leg_0
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|soc_int
operator|.
name|mask_msi_leg_0
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|ctrl_gen
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|ctrl_gen
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|parity
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|parity
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|atu
operator|.
name|in_mask_pair
operator|=
name|regs
operator|->
name|app
operator|.
name|atu
operator|.
name|in_mask_pair
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|atu
operator|.
name|out_mask_pair
operator|=
name|regs
operator|->
name|app
operator|.
name|atu
operator|.
name|out_mask_pair
expr_stmt|;
if|if
condition|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_0
condition|)
block|{
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|int_grp_a
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|int_grp_a_m0
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|int_grp_b
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|int_grp_b_m0
expr_stmt|;
block|}
else|else
block|{
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|int_grp_a
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|int_grp_a
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|int_grp_b
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|int_grp_b
expr_stmt|;
block|}
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|config_header
operator|=
name|regs
operator|->
name|core_space
operator|.
name|config_header
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|pcie_pm_cap_base
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|pcie_pm_cap_base
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|pcie_cap_base
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|pcie_cap_base
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|pcie_dev_cap_base
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|pcie_dev_cap_base
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|pcie_dev_ctrl_status
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|pcie_dev_ctrl_status
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|pcie_link_cap_base
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|pcie_link_cap_base
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|msix_cap_base
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|msix_cap_base
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|aer
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|aer
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|pcie_sec_ext_cap_base
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|pcie_sec_ext_cap_base
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|port_regs
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|port_regs
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_2
condition|)
block|{
name|struct
name|al_pcie_rev2_regs
name|__iomem
modifier|*
name|regs
init|=
operator|(
expr|struct
name|al_pcie_rev2_regs
name|__iomem
operator|*
operator|)
name|pcie_reg_base
decl_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|global
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|global
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|master_arctl
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|master_arctl
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|master_awctl
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|master_awctl
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|slv_ctl
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|slv_ctl
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|cfg_target_bus
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|cfg_target_bus
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|cfg_control
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|cfg_control
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_start_l
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_start_l
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_start_h
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_start_h
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_limit_l
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_limit_l
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_limit_h
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_limit_h
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|pcie_global
operator|.
name|conf
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|pcie_global
operator|.
name|conf
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane0
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane0
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane1
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane1
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane2
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane2
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane3
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane3
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane
index|[
literal|0
index|]
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane0
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane
index|[
literal|1
index|]
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane1
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane
index|[
literal|2
index|]
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane2
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane
index|[
literal|3
index|]
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane3
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|parity
operator|.
name|en_axi
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|parity
operator|.
name|en_axi
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ordering
operator|.
name|pos_cntl
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ordering
operator|.
name|pos_cntl
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|pre_configuration
operator|.
name|pcie_core_setup
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|pre_configuration
operator|.
name|pcie_core_setup
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|init_fc
operator|.
name|cfg
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|init_fc
operator|.
name|cfg
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|int_grp_a
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|int_grp_a
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|port_init
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|port_init
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|pm_control
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|pm_control
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|events_gen
index|[
literal|0
index|]
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|events_gen
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|corr_err_sts_int
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|pended_corr_err_sts_int
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|uncorr_err_sts_int
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|pended_uncorr_err_sts_int
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|debug
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|debug
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|ap_user_send_msg
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|ap_user_send_msg
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|soc_int
index|[
literal|0
index|]
operator|.
name|mask_inta_leg_0
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|soc_int
operator|.
name|mask_inta_leg_0
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|soc_int
index|[
literal|0
index|]
operator|.
name|mask_inta_leg_3
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|soc_int
operator|.
name|mask_inta_leg_3
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|soc_int
index|[
literal|0
index|]
operator|.
name|mask_msi_leg_0
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|soc_int
operator|.
name|mask_msi_leg_0
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|soc_int
index|[
literal|0
index|]
operator|.
name|mask_msi_leg_3
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|soc_int
operator|.
name|mask_msi_leg_3
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|ctrl_gen
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|ctrl_gen
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|parity
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|parity
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|atu
operator|.
name|in_mask_pair
operator|=
name|regs
operator|->
name|app
operator|.
name|atu
operator|.
name|in_mask_pair
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|atu
operator|.
name|out_mask_pair
operator|=
name|regs
operator|->
name|app
operator|.
name|atu
operator|.
name|out_mask_pair
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|status_per_func
index|[
literal|0
index|]
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|status_per_func
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|int_grp_a
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|int_grp_a
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|int_grp_b
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|int_grp_b
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|config_header
operator|=
name|regs
operator|->
name|core_space
operator|.
name|config_header
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|pcie_pm_cap_base
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|pcie_pm_cap_base
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|pcie_cap_base
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|pcie_cap_base
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|pcie_dev_cap_base
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|pcie_dev_cap_base
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|pcie_dev_ctrl_status
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|pcie_dev_ctrl_status
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|pcie_link_cap_base
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|pcie_link_cap_base
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|msix_cap_base
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|msix_cap_base
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|aer
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|aer
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|pcie_sec_ext_cap_base
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|pcie_sec_ext_cap_base
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|port_regs
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|port_regs
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_3
condition|)
block|{
name|struct
name|al_pcie_rev3_regs
name|__iomem
modifier|*
name|regs
init|=
operator|(
expr|struct
name|al_pcie_rev3_regs
name|__iomem
operator|*
operator|)
name|pcie_reg_base
decl_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|global
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|global
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|master_arctl
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|master_arctl
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|master_awctl
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|master_awctl
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|slv_ctl
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|slv_ctl
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|cfg_target_bus
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|cfg_target_bus
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|cfg_control
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|cfg_control
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_start_l
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_start_l
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_start_h
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_start_h
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_limit_l
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_limit_l
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_limit_h
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_limit_h
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|pcie_global
operator|.
name|conf
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|pcie_global
operator|.
name|conf
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane0
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane0
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane1
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane1
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane2
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane2
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane3
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane3
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane4
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane4
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane5
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane5
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane6
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane6
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane7
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|conf
operator|.
name|zero_lane7
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane
index|[
literal|0
index|]
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane0
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane
index|[
literal|1
index|]
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane1
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane
index|[
literal|2
index|]
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane2
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane
index|[
literal|3
index|]
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane3
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane
index|[
literal|4
index|]
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane4
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane
index|[
literal|5
index|]
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane5
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane
index|[
literal|6
index|]
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane6
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane
index|[
literal|7
index|]
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane7
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|parity
operator|.
name|en_axi
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|parity
operator|.
name|en_axi
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|ordering
operator|.
name|pos_cntl
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|ordering
operator|.
name|pos_cntl
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|pre_configuration
operator|.
name|pcie_core_setup
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|pre_configuration
operator|.
name|pcie_core_setup
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|init_fc
operator|.
name|cfg
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|init_fc
operator|.
name|cfg
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|int_grp_a
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|int_grp_a
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|axi_attr_ovrd
operator|.
name|write_msg_ctrl_0
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|axi_attr_ovrd
operator|.
name|write_msg_ctrl_0
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|axi_attr_ovrd
operator|.
name|write_msg_ctrl_1
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|axi_attr_ovrd
operator|.
name|write_msg_ctrl_1
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|axi_attr_ovrd
operator|.
name|pf_sel
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|axi_attr_ovrd
operator|.
name|pf_sel
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|AL_MAX_NUM_OF_PFS
condition|;
name|i
operator|++
control|)
block|{
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|pf_axi_attr_ovrd
index|[
name|i
index|]
operator|.
name|func_ctrl_0
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|pf_axi_attr_ovrd
index|[
name|i
index|]
operator|.
name|func_ctrl_0
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|pf_axi_attr_ovrd
index|[
name|i
index|]
operator|.
name|func_ctrl_1
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|pf_axi_attr_ovrd
index|[
name|i
index|]
operator|.
name|func_ctrl_1
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|pf_axi_attr_ovrd
index|[
name|i
index|]
operator|.
name|func_ctrl_2
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|pf_axi_attr_ovrd
index|[
name|i
index|]
operator|.
name|func_ctrl_2
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|pf_axi_attr_ovrd
index|[
name|i
index|]
operator|.
name|func_ctrl_3
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|pf_axi_attr_ovrd
index|[
name|i
index|]
operator|.
name|func_ctrl_3
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|pf_axi_attr_ovrd
index|[
name|i
index|]
operator|.
name|func_ctrl_4
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|pf_axi_attr_ovrd
index|[
name|i
index|]
operator|.
name|func_ctrl_4
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|pf_axi_attr_ovrd
index|[
name|i
index|]
operator|.
name|func_ctrl_5
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|pf_axi_attr_ovrd
index|[
name|i
index|]
operator|.
name|func_ctrl_5
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|pf_axi_attr_ovrd
index|[
name|i
index|]
operator|.
name|func_ctrl_6
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|pf_axi_attr_ovrd
index|[
name|i
index|]
operator|.
name|func_ctrl_6
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|pf_axi_attr_ovrd
index|[
name|i
index|]
operator|.
name|func_ctrl_7
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|pf_axi_attr_ovrd
index|[
name|i
index|]
operator|.
name|func_ctrl_7
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|pf_axi_attr_ovrd
index|[
name|i
index|]
operator|.
name|func_ctrl_8
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|pf_axi_attr_ovrd
index|[
name|i
index|]
operator|.
name|func_ctrl_8
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|pf_axi_attr_ovrd
index|[
name|i
index|]
operator|.
name|func_ctrl_9
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|pf_axi_attr_ovrd
index|[
name|i
index|]
operator|.
name|func_ctrl_9
expr_stmt|;
block|}
name|pcie_port
operator|->
name|regs
operator|->
name|axi
operator|.
name|msg_attr_axuser_table
operator|.
name|entry_vec
operator|=
operator|&
name|regs
operator|->
name|axi
operator|.
name|msg_attr_axuser_table
operator|.
name|entry_vec
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|port_init
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|port_init
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|pm_control
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|pm_control
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|corr_err_sts_int
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|pended_corr_err_sts_int
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|uncorr_err_sts_int
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|pended_uncorr_err_sts_int
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|AL_MAX_NUM_OF_PFS
condition|;
name|i
operator|++
control|)
block|{
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|events_gen
index|[
name|i
index|]
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|events_gen_per_func
index|[
name|i
index|]
operator|.
name|events_gen
expr_stmt|;
block|}
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|sris_kp_counter
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|sris_kp_counter_value
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|debug
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|debug
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|AL_MAX_NUM_OF_PFS
condition|;
name|i
operator|++
control|)
block|{
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|soc_int
index|[
name|i
index|]
operator|.
name|mask_inta_leg_0
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|soc_int_per_func
index|[
name|i
index|]
operator|.
name|mask_inta_leg_0
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|soc_int
index|[
name|i
index|]
operator|.
name|mask_inta_leg_3
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|soc_int_per_func
index|[
name|i
index|]
operator|.
name|mask_inta_leg_3
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|soc_int
index|[
name|i
index|]
operator|.
name|mask_msi_leg_0
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|soc_int_per_func
index|[
name|i
index|]
operator|.
name|mask_msi_leg_0
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|soc_int
index|[
name|i
index|]
operator|.
name|mask_msi_leg_3
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|soc_int_per_func
index|[
name|i
index|]
operator|.
name|mask_msi_leg_3
expr_stmt|;
block|}
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|ap_user_send_msg
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|ap_user_send_msg
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|ctrl_gen
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|ctrl_gen
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|parity
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|parity
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|atu
operator|.
name|in_mask_pair
operator|=
name|regs
operator|->
name|app
operator|.
name|atu
operator|.
name|in_mask_pair
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|atu
operator|.
name|out_mask_pair
operator|=
name|regs
operator|->
name|app
operator|.
name|atu
operator|.
name|out_mask_pair
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|AL_MAX_NUM_OF_PFS
condition|;
name|i
operator|++
control|)
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|status_per_func
index|[
name|i
index|]
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|status_per_func
index|[
name|i
index|]
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|int_grp_a
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|int_grp_a
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|int_grp_b
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|int_grp_b
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|int_grp_c
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|int_grp_c
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|app
operator|.
name|int_grp_d
operator|=
operator|&
name|regs
operator|->
name|app
operator|.
name|int_grp_d
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|AL_MAX_NUM_OF_PFS
condition|;
name|i
operator|++
control|)
block|{
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
name|i
index|]
operator|.
name|config_header
operator|=
name|regs
operator|->
name|core_space
operator|.
name|func
index|[
name|i
index|]
operator|.
name|config_header
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
name|i
index|]
operator|.
name|pcie_pm_cap_base
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|func
index|[
name|i
index|]
operator|.
name|pcie_pm_cap_base
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
name|i
index|]
operator|.
name|pcie_cap_base
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|func
index|[
name|i
index|]
operator|.
name|pcie_cap_base
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
name|i
index|]
operator|.
name|pcie_dev_cap_base
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|func
index|[
name|i
index|]
operator|.
name|pcie_dev_cap_base
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
name|i
index|]
operator|.
name|pcie_dev_ctrl_status
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|func
index|[
name|i
index|]
operator|.
name|pcie_dev_ctrl_status
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
name|i
index|]
operator|.
name|pcie_link_cap_base
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|func
index|[
name|i
index|]
operator|.
name|pcie_link_cap_base
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
name|i
index|]
operator|.
name|msix_cap_base
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|func
index|[
name|i
index|]
operator|.
name|msix_cap_base
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
name|i
index|]
operator|.
name|aer
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|func
index|[
name|i
index|]
operator|.
name|aer
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
name|i
index|]
operator|.
name|tph_cap_base
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|func
index|[
name|i
index|]
operator|.
name|tph_cap_base
expr_stmt|;
block|}
comment|/* secondary extension capability only for PF0 */
name|pcie_port
operator|->
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|pcie_sec_ext_cap_base
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|func
index|[
literal|0
index|]
operator|.
name|pcie_sec_ext_cap_base
expr_stmt|;
name|pcie_port
operator|->
name|regs
operator|->
name|port_regs
operator|=
operator|&
name|regs
operator|->
name|core_space
operator|.
name|func
index|[
literal|0
index|]
operator|.
name|port_regs
expr_stmt|;
block|}
else|else
block|{
name|al_warn
argument_list|(
literal|"%s: Revision ID is unknown\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* set maximum number of physical functions */
name|pcie_port
operator|->
name|max_num_of_pfs
operator|=
name|al_pcie_port_max_num_of_pfs_get
argument_list|(
name|pcie_port
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"pcie port handle initialized. port id: %d, rev_id %d, regs base %p\n"
argument_list|,
name|port_id
argument_list|,
name|pcie_port
operator|->
name|rev_id
argument_list|,
name|pcie_reg_base
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * Initializes a PCIe Physical function handle structure  * Caution: this function should not read/write to any register except for  * reading RO register (REV_ID for example)  */
end_comment

begin_function
name|int
name|al_pcie_pf_handle_init
parameter_list|(
name|struct
name|al_pcie_pf
modifier|*
name|pcie_pf
parameter_list|,
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|unsigned
name|int
name|pf_num
parameter_list|)
block|{
name|enum
name|al_pcie_operating_mode
name|op_mode
init|=
name|al_pcie_operating_mode_get
argument_list|(
name|pcie_port
argument_list|)
decl_stmt|;
name|al_assert
argument_list|(
name|pf_num
operator|<
name|pcie_port
operator|->
name|max_num_of_pfs
argument_list|)
expr_stmt|;
if|if
condition|(
name|op_mode
operator|!=
name|AL_PCIE_OPERATING_MODE_EP
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: can't init PF handle with operating mode [%d]\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
name|op_mode
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|pcie_pf
operator|->
name|pf_num
operator|=
name|pf_num
expr_stmt|;
name|pcie_pf
operator|->
name|pcie_port
operator|=
name|pcie_port
expr_stmt|;
name|al_dbg
argument_list|(
literal|"PCIe %d: pf handle initialized. pf number: %d, rev_id %d, regs %p\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
name|pcie_pf
operator|->
name|pf_num
argument_list|,
name|pcie_port
operator|->
name|rev_id
argument_list|,
name|pcie_port
operator|->
name|regs
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/************************** Pre PCIe Port Enable API **************************/
end_comment

begin_comment
comment|/** configure pcie operating mode (root complex or endpoint) */
end_comment

begin_function
name|int
name|al_pcie_port_operating_mode_config
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|enum
name|al_pcie_operating_mode
name|mode
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|,
name|device_type
decl_stmt|,
name|new_device_type
decl_stmt|;
if|if
condition|(
name|al_pcie_port_is_enabled
argument_list|(
name|pcie_port
argument_list|)
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: already enabled, cannot set operating mode\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|reg
operator|=
name|al_reg_read32
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|pcie_global
operator|.
name|conf
argument_list|)
expr_stmt|;
name|device_type
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|PCIE_AXI_MISC_PCIE_GLOBAL_CONF_DEV_TYPE_MASK
argument_list|,
name|PCIE_AXI_MISC_PCIE_GLOBAL_CONF_DEV_TYPE_SHIFT
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|==
name|AL_PCIE_OPERATING_MODE_EP
condition|)
block|{
name|new_device_type
operator|=
name|PCIE_AXI_MISC_PCIE_GLOBAL_CONF_DEV_TYPE_EP
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mode
operator|==
name|AL_PCIE_OPERATING_MODE_RC
condition|)
block|{
name|new_device_type
operator|=
name|PCIE_AXI_MISC_PCIE_GLOBAL_CONF_DEV_TYPE_RC
expr_stmt|;
if|if
condition|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_3
condition|)
block|{
comment|/* config 1 PF in RC mode */
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|axi_attr_ovrd
operator|.
name|pf_sel
argument_list|,
name|PCIE_AXI_AXI_ATTR_OVRD_PF_SEL_PF_BIT0_OVRD_FROM_AXUSER
operator||
name|PCIE_AXI_AXI_ATTR_OVRD_PF_SEL_PF_BIT0_OVRD_FROM_REG
operator||
name|PCIE_AXI_AXI_ATTR_OVRD_PF_SEL_PF_BIT0_ADDR_OFFSET_MASK
operator||
name|PCIE_AXI_AXI_ATTR_OVRD_PF_SEL_CFG_PF_BIT0_OVRD
operator||
name|PCIE_AXI_AXI_ATTR_OVRD_PF_SEL_PF_BIT1_OVRD_FROM_AXUSER
operator||
name|PCIE_AXI_AXI_ATTR_OVRD_PF_SEL_PF_BIT1_OVRD_FROM_REG
operator||
name|PCIE_AXI_AXI_ATTR_OVRD_PF_SEL_PF_BIT1_ADDR_OFFSET_MASK
operator||
name|PCIE_AXI_AXI_ATTR_OVRD_PF_SEL_CFG_PF_BIT1_OVRD
argument_list|,
name|PCIE_AXI_AXI_ATTR_OVRD_PF_SEL_PF_BIT0_OVRD_FROM_REG
operator||
name|PCIE_AXI_AXI_ATTR_OVRD_PF_SEL_PF_BIT1_OVRD_FROM_REG
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|al_err
argument_list|(
literal|"PCIe %d: unknown operating mode: %d\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
name|mode
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|new_device_type
operator|==
name|device_type
condition|)
block|{
name|al_dbg
argument_list|(
literal|"PCIe %d: operating mode already set to %s\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
operator|(
name|mode
operator|==
name|AL_PCIE_OPERATING_MODE_EP
operator|)
condition|?
literal|"EndPoint"
else|:
literal|"Root Complex"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|al_info
argument_list|(
literal|"PCIe %d: set operating mode to %s\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
operator|(
name|mode
operator|==
name|AL_PCIE_OPERATING_MODE_EP
operator|)
condition|?
literal|"EndPoint"
else|:
literal|"Root Complex"
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|PCIE_AXI_MISC_PCIE_GLOBAL_CONF_DEV_TYPE_MASK
argument_list|,
name|PCIE_AXI_MISC_PCIE_GLOBAL_CONF_DEV_TYPE_SHIFT
argument_list|,
name|new_device_type
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|pcie_global
operator|.
name|conf
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_pcie_port_max_lanes_set
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|uint8_t
name|lanes
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
if|if
condition|(
name|al_pcie_port_is_enabled
argument_list|(
name|pcie_port
argument_list|)
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: already enabled, cannot set max lanes\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* convert to bitmask format (4 ->'b1111, 2 ->'b11, 1 -> 'b1) */
name|uint32_t
name|active_lanes_val
init|=
name|AL_PCIE_PARSE_LANES
argument_list|(
name|lanes
argument_list|)
decl_stmt|;
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|pcie_global
operator|.
name|conf
argument_list|,
operator|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_3
operator|)
condition|?
name|PCIE_REV3_AXI_MISC_PCIE_GLOBAL_CONF_NOF_ACT_LANES_MASK
else|:
name|PCIE_REV1_2_AXI_MISC_PCIE_GLOBAL_CONF_NOF_ACT_LANES_MASK
argument_list|,
name|active_lanes_val
argument_list|)
expr_stmt|;
name|pcie_port
operator|->
name|max_lanes
operator|=
name|lanes
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_pcie_port_max_num_of_pfs_set
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|uint8_t
name|max_num_of_pfs
parameter_list|)
block|{
if|if
condition|(
name|al_pcie_port_is_enabled
argument_list|(
name|pcie_port
argument_list|)
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: already enabled, cannot set max num of PFs\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_3
condition|)
name|al_assert
argument_list|(
name|max_num_of_pfs
operator|<=
name|REV3_MAX_NUM_OF_PFS
argument_list|)
expr_stmt|;
else|else
name|al_assert
argument_list|(
name|max_num_of_pfs
operator|==
name|REV1_2_MAX_NUM_OF_PFS
argument_list|)
expr_stmt|;
name|pcie_port
operator|->
name|max_num_of_pfs
operator|=
name|max_num_of_pfs
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Inbound header credits and outstanding outbound reads configuration */
end_comment

begin_function
name|int
name|al_pcie_port_ib_hcrd_os_ob_reads_config
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|struct
name|al_pcie_ib_hcrd_os_ob_reads_config
modifier|*
name|ib_hcrd_os_ob_reads_config
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
if|if
condition|(
name|al_pcie_port_is_enabled
argument_list|(
name|pcie_port
argument_list|)
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: already enabled, cannot configure IB credits and OB OS reads\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|al_assert
argument_list|(
name|ib_hcrd_os_ob_reads_config
operator|->
name|nof_np_hdr
operator|>
literal|0
argument_list|)
expr_stmt|;
name|al_assert
argument_list|(
name|ib_hcrd_os_ob_reads_config
operator|->
name|nof_p_hdr
operator|>
literal|0
argument_list|)
expr_stmt|;
name|al_assert
argument_list|(
name|ib_hcrd_os_ob_reads_config
operator|->
name|nof_cpl_hdr
operator|>
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_3
condition|)
block|{
name|al_assert
argument_list|(
operator|(
name|ib_hcrd_os_ob_reads_config
operator|->
name|nof_cpl_hdr
operator|+
name|ib_hcrd_os_ob_reads_config
operator|->
name|nof_np_hdr
operator|+
name|ib_hcrd_os_ob_reads_config
operator|->
name|nof_p_hdr
operator|)
operator|==
name|AL_PCIE_REV3_IB_HCRD_SUM
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|init_fc
operator|.
name|cfg
argument_list|,
name|PCIE_AXI_REV3_INIT_FC_CFG_NOF_P_HDR_MASK
operator||
name|PCIE_AXI_REV3_INIT_FC_CFG_NOF_NP_HDR_MASK
operator||
name|PCIE_AXI_REV3_INIT_FC_CFG_NOF_CPL_HDR_MASK
argument_list|,
operator|(
name|ib_hcrd_os_ob_reads_config
operator|->
name|nof_p_hdr
operator|<<
name|PCIE_AXI_REV3_INIT_FC_CFG_NOF_P_HDR_SHIFT
operator|)
operator||
operator|(
name|ib_hcrd_os_ob_reads_config
operator|->
name|nof_np_hdr
operator|<<
name|PCIE_AXI_REV3_INIT_FC_CFG_NOF_NP_HDR_SHIFT
operator|)
operator||
operator|(
name|ib_hcrd_os_ob_reads_config
operator|->
name|nof_cpl_hdr
operator|<<
name|PCIE_AXI_REV3_INIT_FC_CFG_NOF_CPL_HDR_SHIFT
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|al_assert
argument_list|(
operator|(
name|ib_hcrd_os_ob_reads_config
operator|->
name|nof_cpl_hdr
operator|+
name|ib_hcrd_os_ob_reads_config
operator|->
name|nof_np_hdr
operator|+
name|ib_hcrd_os_ob_reads_config
operator|->
name|nof_p_hdr
operator|)
operator|==
name|AL_PCIE_REV_1_2_IB_HCRD_SUM
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|init_fc
operator|.
name|cfg
argument_list|,
name|PCIE_AXI_REV1_2_INIT_FC_CFG_NOF_P_HDR_MASK
operator||
name|PCIE_AXI_REV1_2_INIT_FC_CFG_NOF_NP_HDR_MASK
operator||
name|PCIE_AXI_REV1_2_INIT_FC_CFG_NOF_CPL_HDR_MASK
argument_list|,
operator|(
name|ib_hcrd_os_ob_reads_config
operator|->
name|nof_p_hdr
operator|<<
name|PCIE_AXI_REV1_2_INIT_FC_CFG_NOF_P_HDR_SHIFT
operator|)
operator||
operator|(
name|ib_hcrd_os_ob_reads_config
operator|->
name|nof_np_hdr
operator|<<
name|PCIE_AXI_REV1_2_INIT_FC_CFG_NOF_NP_HDR_SHIFT
operator|)
operator||
operator|(
name|ib_hcrd_os_ob_reads_config
operator|->
name|nof_cpl_hdr
operator|<<
name|PCIE_AXI_REV1_2_INIT_FC_CFG_NOF_CPL_HDR_SHIFT
operator|)
argument_list|)
expr_stmt|;
block|}
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|pre_configuration
operator|.
name|pcie_core_setup
argument_list|,
name|PCIE_AXI_CORE_SETUP_NOF_READS_ONSLAVE_INTRF_PCIE_CORE_MASK
argument_list|,
name|ib_hcrd_os_ob_reads_config
operator|->
name|nof_outstanding_ob_reads
operator|<<
name|PCIE_AXI_CORE_SETUP_NOF_READS_ONSLAVE_INTRF_PCIE_CORE_SHIFT
argument_list|)
expr_stmt|;
comment|/* Store 'nof_p_hdr' and 'nof_np_hdr' to be set in the core later */
name|pcie_port
operator|->
name|ib_hcrd_config
operator|.
name|nof_np_hdr
operator|=
name|ib_hcrd_os_ob_reads_config
operator|->
name|nof_np_hdr
expr_stmt|;
name|pcie_port
operator|->
name|ib_hcrd_config
operator|.
name|nof_p_hdr
operator|=
name|ib_hcrd_os_ob_reads_config
operator|->
name|nof_p_hdr
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|enum
name|al_pcie_operating_mode
name|al_pcie_operating_mode_get
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|,
name|device_type
decl_stmt|;
name|al_assert
argument_list|(
name|pcie_port
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|pcie_global
operator|.
name|conf
argument_list|)
expr_stmt|;
name|device_type
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|PCIE_AXI_MISC_PCIE_GLOBAL_CONF_DEV_TYPE_MASK
argument_list|,
name|PCIE_AXI_MISC_PCIE_GLOBAL_CONF_DEV_TYPE_SHIFT
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|device_type
condition|)
block|{
case|case
name|PCIE_AXI_MISC_PCIE_GLOBAL_CONF_DEV_TYPE_EP
case|:
return|return
name|AL_PCIE_OPERATING_MODE_EP
return|;
case|case
name|PCIE_AXI_MISC_PCIE_GLOBAL_CONF_DEV_TYPE_RC
case|:
return|return
name|AL_PCIE_OPERATING_MODE_RC
return|;
default|default:
name|al_err
argument_list|(
literal|"PCIe %d: unknown device type (%d) in global conf register.\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
name|device_type
argument_list|)
expr_stmt|;
block|}
return|return
name|AL_PCIE_OPERATING_MODE_UNKNOWN
return|;
block|}
end_function

begin_comment
comment|/**************************** PCIe Port Enable API ****************************/
end_comment

begin_comment
comment|/** Enable PCIe port (deassert reset) */
end_comment

begin_function
name|int
name|al_pcie_port_enable
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|)
block|{
name|struct
name|al_pbs_regs
modifier|*
name|pbs_reg_base
init|=
operator|(
expr|struct
name|al_pbs_regs
operator|*
operator|)
name|pcie_port
operator|->
name|pbs_regs
decl_stmt|;
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|unsigned
name|int
name|port_id
init|=
name|pcie_port
operator|->
name|port_id
decl_stmt|;
comment|/* pre-port-enable default functionality should be here */
comment|/** 	 * Set inbound header credit and outstanding outbound reads defaults 	 * Must be called before port enable (PCIE_EXIST) 	 */
name|al_pcie_ib_hcrd_os_ob_reads_config_default
argument_list|(
name|pcie_port
argument_list|)
expr_stmt|;
comment|/* 	 * Disable ATS capability 	 * - must be done before core reset deasserted 	 * - rev_id 0 - no effect, but no harm 	 */
if|if
condition|(
operator|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_0
operator|)
operator|||
operator|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_1
operator|)
operator|||
operator|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_2
operator|)
condition|)
block|{
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|ordering
operator|.
name|pos_cntl
argument_list|,
name|PCIE_AXI_CORE_SETUP_ATS_CAP_DIS
argument_list|,
name|PCIE_AXI_CORE_SETUP_ATS_CAP_DIS
argument_list|)
expr_stmt|;
block|}
comment|/* Deassert core reset */
name|al_reg_write32_masked
argument_list|(
operator|&
name|pbs_reg_base
operator|->
name|unit
operator|.
name|pcie_conf_1
argument_list|,
literal|1
operator|<<
operator|(
name|port_id
operator|+
name|PBS_UNIT_PCIE_CONF_1_PCIE_EXIST_SHIFT
operator|)
argument_list|,
literal|1
operator|<<
operator|(
name|port_id
operator|+
name|PBS_UNIT_PCIE_CONF_1_PCIE_EXIST_SHIFT
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** Disable PCIe port (assert reset) */
end_comment

begin_function
name|void
name|al_pcie_port_disable
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|)
block|{
name|struct
name|al_pbs_regs
modifier|*
name|pbs_reg_base
init|=
operator|(
expr|struct
name|al_pbs_regs
operator|*
operator|)
name|pcie_port
operator|->
name|pbs_regs
decl_stmt|;
name|unsigned
name|int
name|port_id
init|=
name|pcie_port
operator|->
name|port_id
decl_stmt|;
if|if
condition|(
operator|!
name|al_pcie_port_is_enabled
argument_list|(
name|pcie_port
argument_list|)
condition|)
block|{
name|al_warn
argument_list|(
literal|"PCIe %d: trying to disable a non-enabled port\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
block|}
comment|/* Assert core reset */
name|al_reg_write32_masked
argument_list|(
operator|&
name|pbs_reg_base
operator|->
name|unit
operator|.
name|pcie_conf_1
argument_list|,
literal|1
operator|<<
operator|(
name|port_id
operator|+
name|PBS_UNIT_PCIE_CONF_1_PCIE_EXIST_SHIFT
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|al_pcie_port_memory_shutdown_set
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|al_bool
name|enable
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|uint32_t
name|mask
init|=
operator|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_3
operator|)
condition|?
name|PCIE_REV3_AXI_MISC_PCIE_GLOBAL_CONF_MEM_SHUTDOWN
else|:
name|PCIE_REV1_2_AXI_MISC_PCIE_GLOBAL_CONF_MEM_SHUTDOWN
decl_stmt|;
if|if
condition|(
operator|!
name|al_pcie_port_is_enabled
argument_list|(
name|pcie_port
argument_list|)
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: not enabled, cannot shutdown memory\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|pcie_global
operator|.
name|conf
argument_list|,
name|mask
argument_list|,
name|enable
operator|==
name|AL_TRUE
condition|?
name|mask
else|:
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|al_bool
name|al_pcie_port_is_enabled
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|)
block|{
name|struct
name|al_pbs_regs
modifier|*
name|pbs_reg_base
init|=
operator|(
expr|struct
name|al_pbs_regs
operator|*
operator|)
name|pcie_port
operator|->
name|pbs_regs
decl_stmt|;
name|uint32_t
name|pcie_exist
init|=
name|al_reg_read32
argument_list|(
operator|&
name|pbs_reg_base
operator|->
name|unit
operator|.
name|pcie_conf_1
argument_list|)
decl_stmt|;
name|uint32_t
name|ports_enabled
init|=
name|AL_REG_FIELD_GET
argument_list|(
name|pcie_exist
argument_list|,
name|PBS_UNIT_PCIE_CONF_1_PCIE_EXIST_MASK
argument_list|,
name|PBS_UNIT_PCIE_CONF_1_PCIE_EXIST_SHIFT
argument_list|)
decl_stmt|;
return|return
operator|(
name|AL_REG_FIELD_GET
argument_list|(
name|ports_enabled
argument_list|,
name|AL_BIT
argument_list|(
name|pcie_port
operator|->
name|port_id
argument_list|)
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
operator|==
literal|1
operator|)
return|;
block|}
end_function

begin_comment
comment|/*************************** PCIe Configuration API ***************************/
end_comment

begin_comment
comment|/** configure pcie port (link params, etc..) */
end_comment

begin_function
name|int
name|al_pcie_port_config
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
specifier|const
name|struct
name|al_pcie_port_config_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|enum
name|al_pcie_operating_mode
name|op_mode
decl_stmt|;
name|int
name|status
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|al_pcie_port_is_enabled
argument_list|(
name|pcie_port
argument_list|)
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: port not enabled, cannot configure port\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|al_pcie_is_link_started
argument_list|(
name|pcie_port
argument_list|)
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: link already started, cannot configure port\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|al_assert
argument_list|(
name|pcie_port
argument_list|)
expr_stmt|;
name|al_assert
argument_list|(
name|params
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"PCIe %d: port config\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
name|op_mode
operator|=
name|al_pcie_operating_mode_get
argument_list|(
name|pcie_port
argument_list|)
expr_stmt|;
comment|/* if max lanes not specifies, read it from register */
if|if
condition|(
name|pcie_port
operator|->
name|max_lanes
operator|==
literal|0
condition|)
block|{
name|uint32_t
name|global_conf
init|=
name|al_reg_read32
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|pcie_global
operator|.
name|conf
argument_list|)
decl_stmt|;
name|uint32_t
name|act_lanes
init|=
name|AL_REG_FIELD_GET
argument_list|(
name|global_conf
argument_list|,
operator|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_3
operator|)
condition|?
name|PCIE_REV3_AXI_MISC_PCIE_GLOBAL_CONF_NOF_ACT_LANES_MASK
else|:
name|PCIE_REV1_2_AXI_MISC_PCIE_GLOBAL_CONF_NOF_ACT_LANES_MASK
argument_list|,
name|PCIE_REVX_AXI_MISC_PCIE_GLOBAL_CONF_NOF_ACT_LANES_SHIFT
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|act_lanes
condition|)
block|{
case|case
literal|0x1
case|:
name|pcie_port
operator|->
name|max_lanes
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|0x3
case|:
name|pcie_port
operator|->
name|max_lanes
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|0xf
case|:
name|pcie_port
operator|->
name|max_lanes
operator|=
literal|4
expr_stmt|;
break|break;
case|case
literal|0xff
case|:
name|pcie_port
operator|->
name|max_lanes
operator|=
literal|8
expr_stmt|;
break|break;
default|default:
name|pcie_port
operator|->
name|max_lanes
operator|=
literal|0
expr_stmt|;
name|al_err
argument_list|(
literal|"PCIe %d: invalid max lanes val (0x%x)\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
name|act_lanes
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|params
operator|->
name|link_params
condition|)
name|status
operator|=
name|al_pcie_port_link_config
argument_list|(
name|pcie_port
argument_list|,
name|params
operator|->
name|link_params
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
goto|goto
name|done
goto|;
comment|/* Change max read request size to 256 bytes 	 * Max Payload Size is remained untouched- it is the responsibility of 	 * the host to change the MPS, if needed. 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|AL_MAX_NUM_OF_PFS
condition|;
name|i
operator|++
control|)
block|{
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|core_space
index|[
name|i
index|]
operator|.
name|pcie_dev_ctrl_status
argument_list|,
name|PCIE_PORT_DEV_CTRL_STATUS_MRRS_MASK
argument_list|,
name|PCIE_PORT_DEV_CTRL_STATUS_MRRS_VAL_256
argument_list|)
expr_stmt|;
if|if
condition|(
name|pcie_port
operator|->
name|rev_id
operator|!=
name|AL_PCIE_REV_ID_3
condition|)
break|break;
block|}
if|if
condition|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_3
condition|)
block|{
comment|/* Set maximum physical function numbers */
name|al_reg_write32_masked
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|timer_ctrl_max_func_num
argument_list|,
name|PCIE_PORT_GEN3_MAX_FUNC_NUM
argument_list|,
name|pcie_port
operator|->
name|max_num_of_pfs
operator|-
literal|1
argument_list|)
expr_stmt|;
name|al_pcie_port_wr_to_ro_set
argument_list|(
name|pcie_port
argument_list|,
name|AL_TRUE
argument_list|)
expr_stmt|;
comment|/** 		 * in EP mode, when we have more than 1 PF we need to assert 		 * multi-pf support so the host scan all PFs 		 */
if|if
condition|(
operator|(
name|op_mode
operator|==
name|AL_PCIE_OPERATING_MODE_EP
operator|)
operator|&&
operator|(
name|pcie_port
operator|->
name|max_num_of_pfs
operator|>
literal|1
operator|)
condition|)
block|{
name|al_reg_write32_masked
argument_list|(
operator|(
name|uint32_t
name|__iomem
operator|*
operator|)
operator|(
operator|&
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|config_header
index|[
literal|0
index|]
operator|+
operator|(
name|PCIE_BIST_HEADER_TYPE_BASE
operator|>>
literal|2
operator|)
operator|)
argument_list|,
name|PCIE_BIST_HEADER_TYPE_MULTI_FUNC_MASK
argument_list|,
name|PCIE_BIST_HEADER_TYPE_MULTI_FUNC_MASK
argument_list|)
expr_stmt|;
block|}
comment|/* Disable TPH next pointer */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|AL_MAX_NUM_OF_PFS
condition|;
name|i
operator|++
control|)
block|{
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|core_space
index|[
name|i
index|]
operator|.
name|tph_cap_base
argument_list|,
name|PCIE_TPH_NEXT_POINTER
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|al_pcie_port_wr_to_ro_set
argument_list|(
name|pcie_port
argument_list|,
name|AL_FALSE
argument_list|)
expr_stmt|;
block|}
name|status
operator|=
name|al_pcie_port_snoop_config
argument_list|(
name|pcie_port
argument_list|,
name|params
operator|->
name|enable_axi_snoop
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
goto|goto
name|done
goto|;
name|al_pcie_port_ram_parity_int_config
argument_list|(
name|pcie_port
argument_list|,
name|params
operator|->
name|enable_ram_parity_int
argument_list|)
expr_stmt|;
name|al_pcie_port_axi_parity_int_config
argument_list|(
name|pcie_port
argument_list|,
name|params
operator|->
name|enable_axi_parity_int
argument_list|)
expr_stmt|;
name|al_pcie_port_relaxed_pcie_ordering_config
argument_list|(
name|pcie_port
argument_list|,
name|params
operator|->
name|relaxed_ordering_params
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|lat_rply_timers
condition|)
name|status
operator|=
name|al_pcie_port_lat_rply_timers_config
argument_list|(
name|pcie_port
argument_list|,
name|params
operator|->
name|lat_rply_timers
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
goto|goto
name|done
goto|;
if|if
condition|(
name|params
operator|->
name|gen2_params
condition|)
name|status
operator|=
name|al_pcie_port_gen2_params_config
argument_list|(
name|pcie_port
argument_list|,
name|params
operator|->
name|gen2_params
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
goto|goto
name|done
goto|;
if|if
condition|(
name|params
operator|->
name|gen3_params
condition|)
name|status
operator|=
name|al_pcie_port_gen3_params_config
argument_list|(
name|pcie_port
argument_list|,
name|params
operator|->
name|gen3_params
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
goto|goto
name|done
goto|;
if|if
condition|(
name|params
operator|->
name|tl_credits
condition|)
name|status
operator|=
name|al_pcie_port_tl_credits_config
argument_list|(
name|pcie_port
argument_list|,
name|params
operator|->
name|tl_credits
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
goto|goto
name|done
goto|;
if|if
condition|(
name|params
operator|->
name|features
condition|)
name|al_pcie_port_features_config
argument_list|(
name|pcie_port
argument_list|,
name|params
operator|->
name|features
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|sris_params
condition|)
name|status
operator|=
name|al_pcie_port_sris_config
argument_list|(
name|pcie_port
argument_list|,
name|params
operator|->
name|sris_params
argument_list|,
name|params
operator|->
name|link_params
operator|->
name|max_speed
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
goto|goto
name|done
goto|;
name|al_pcie_port_ib_hcrd_config
argument_list|(
name|pcie_port
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|fast_link_mode
condition|)
block|{
name|al_reg_write32_masked
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|port_link_ctrl
argument_list|,
literal|1
operator|<<
name|PCIE_PORT_LINK_CTRL_FAST_LINK_EN_SHIFT
argument_list|,
literal|1
operator|<<
name|PCIE_PORT_LINK_CTRL_FAST_LINK_EN_SHIFT
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|params
operator|->
name|enable_axi_slave_err_resp
condition|)
name|al_reg_write32_masked
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|axi_slave_err_resp
argument_list|,
literal|1
operator|<<
name|PCIE_PORT_AXI_SLAVE_ERR_RESP_ALL_MAPPING_SHIFT
argument_list|,
literal|1
operator|<<
name|PCIE_PORT_AXI_SLAVE_ERR_RESP_ALL_MAPPING_SHIFT
argument_list|)
expr_stmt|;
comment|/** 	 * Addressing RMN: 5477 	 * 	 * RMN description: 	 * address-decoder logic performs sub-target decoding even for transactions 	 * which undergo target enforcement. thus, in case transaction's address is 	 * inside any ECAM bar, the sub-target decoding will be set to ECAM, which 	 * causes wrong handling by PCIe unit 	 * 	 * Software flow: 	 * on EP mode only, turning on the iATU-enable bit (with the relevant mask 	 * below) allows the PCIe unit to discard the ECAM bit which was asserted 	 * by-mistake in the address-decoder 	 */
if|if
condition|(
name|op_mode
operator|==
name|AL_PCIE_OPERATING_MODE_EP
condition|)
block|{
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|cfg_target_bus
argument_list|,
name|PCIE_AXI_MISC_OB_CTRL_CFG_TARGET_BUS_MASK_MASK
argument_list|,
operator|(
literal|0
operator|)
operator|<<
name|PCIE_AXI_MISC_OB_CTRL_CFG_TARGET_BUS_MASK_SHIFT
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|cfg_control
argument_list|,
name|PCIE_AXI_MISC_OB_CTRL_CFG_CONTROL_IATU_EN
argument_list|,
name|PCIE_AXI_MISC_OB_CTRL_CFG_CONTROL_IATU_EN
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|op_mode
operator|==
name|AL_PCIE_OPERATING_MODE_RC
condition|)
block|{
comment|/** 		 * enable memory and I/O access from port when in RC mode 		 * in RC mode, only core_space[0] is valid. 		 */
name|al_reg_write16_masked
argument_list|(
operator|(
name|uint16_t
name|__iomem
operator|*
operator|)
operator|(
operator|&
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|config_header
index|[
literal|0
index|]
operator|+
operator|(
literal|0x4
operator|>>
literal|2
operator|)
operator|)
argument_list|,
literal|0x7
argument_list|,
comment|/* Mem, MSE, IO */
literal|0x7
argument_list|)
expr_stmt|;
comment|/* change the class code to match pci bridge */
name|al_pcie_port_wr_to_ro_set
argument_list|(
name|pcie_port
argument_list|,
name|AL_TRUE
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|(
name|uint32_t
name|__iomem
operator|*
operator|)
operator|(
operator|&
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|config_header
index|[
literal|0
index|]
operator|+
operator|(
name|PCI_CLASS_REVISION
operator|>>
literal|2
operator|)
operator|)
argument_list|,
literal|0xFFFFFF00
argument_list|,
literal|0x06040000
argument_list|)
expr_stmt|;
name|al_pcie_port_wr_to_ro_set
argument_list|(
name|pcie_port
argument_list|,
name|AL_FALSE
argument_list|)
expr_stmt|;
comment|/** 		 * Addressing RMN: 5702 		 * 		 * RMN description: 		 * target bus mask default value in HW is: 0xFE, this enforces 		 * setting the target bus for ports 1 and 3 when running on RC 		 * mode since bit[20] in ECAM address in these cases is set 		 * 		 * Software flow: 		 * on RC mode only, set target-bus value to 0xFF to prevent this 		 * enforcement 		 */
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|cfg_target_bus
argument_list|,
name|PCIE_AXI_MISC_OB_CTRL_CFG_TARGET_BUS_MASK_MASK
argument_list|,
name|PCIE_AXI_MISC_OB_CTRL_CFG_TARGET_BUS_MASK_MASK
argument_list|)
expr_stmt|;
block|}
name|done
label|:
name|al_dbg
argument_list|(
literal|"PCIe %d: port config %s\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
name|status
condition|?
literal|"failed"
else|:
literal|"done"
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|int
name|al_pcie_pf_config
parameter_list|(
name|struct
name|al_pcie_pf
modifier|*
name|pcie_pf
parameter_list|,
specifier|const
name|struct
name|al_pcie_pf_config_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
decl_stmt|;
name|int
name|status
init|=
literal|0
decl_stmt|;
name|al_assert
argument_list|(
name|pcie_pf
argument_list|)
expr_stmt|;
name|al_assert
argument_list|(
name|params
argument_list|)
expr_stmt|;
name|pcie_port
operator|=
name|pcie_pf
operator|->
name|pcie_port
expr_stmt|;
if|if
condition|(
operator|!
name|al_pcie_port_is_enabled
argument_list|(
name|pcie_port
argument_list|)
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: port not enabled, cannot configure port\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|al_dbg
argument_list|(
literal|"PCIe %d: pf %d config\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
name|pcie_pf
operator|->
name|pf_num
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
condition|)
name|status
operator|=
name|al_pcie_port_pf_params_config
argument_list|(
name|pcie_pf
argument_list|,
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
condition|)
goto|goto
name|done
goto|;
name|done
label|:
name|al_dbg
argument_list|(
literal|"PCIe %d: pf %d config %s\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
name|pcie_pf
operator|->
name|pf_num
argument_list|,
name|status
condition|?
literal|"failed"
else|:
literal|"done"
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/************************** PCIe Link Operations API **************************/
end_comment

begin_comment
comment|/* start pcie link */
end_comment

begin_function
name|int
name|al_pcie_link_start
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
operator|(
expr|struct
name|al_pcie_regs
operator|*
operator|)
name|pcie_port
operator|->
name|regs
decl_stmt|;
if|if
condition|(
operator|!
name|al_pcie_port_is_enabled
argument_list|(
name|pcie_port
argument_list|)
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: port not enabled, cannot start link\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|al_dbg
argument_list|(
literal|"PCIe_%d: start port link.\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|port_init
argument_list|,
name|PCIE_W_GLOBAL_CTRL_PORT_INIT_APP_LTSSM_EN_MASK
argument_list|,
name|PCIE_W_GLOBAL_CTRL_PORT_INIT_APP_LTSSM_EN_MASK
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* stop pcie link */
end_comment

begin_function
name|int
name|al_pcie_link_stop
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
operator|(
expr|struct
name|al_pcie_regs
operator|*
operator|)
name|pcie_port
operator|->
name|regs
decl_stmt|;
if|if
condition|(
operator|!
name|al_pcie_is_link_started
argument_list|(
name|pcie_port
argument_list|)
condition|)
block|{
name|al_warn
argument_list|(
literal|"PCIe %d: trying to stop a non-started link\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
block|}
name|al_dbg
argument_list|(
literal|"PCIe_%d: stop port link.\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|port_init
argument_list|,
name|PCIE_W_GLOBAL_CTRL_PORT_INIT_APP_LTSSM_EN_MASK
argument_list|,
operator|~
name|PCIE_W_GLOBAL_CTRL_PORT_INIT_APP_LTSSM_EN_MASK
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* wait for link up indication */
end_comment

begin_function
name|int
name|al_pcie_link_up_wait
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|uint32_t
name|timeout_ms
parameter_list|)
block|{
name|int
name|wait_count
init|=
name|timeout_ms
operator|*
name|AL_PCIE_LINKUP_WAIT_INTERVALS_PER_SEC
decl_stmt|;
while|while
condition|(
name|wait_count
operator|--
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|al_pcie_check_link
argument_list|(
name|pcie_port
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|al_info
argument_list|(
literal|"PCIe_%d:<<<<<<<<< Link up>>>>>>>>>\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
name|al_dbg
argument_list|(
literal|"PCIe_%d: No link up, %d attempts remaining\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
name|wait_count
argument_list|)
expr_stmt|;
name|al_udelay
argument_list|(
name|AL_PCIE_LINKUP_WAIT_INTERVAL
argument_list|)
expr_stmt|;
block|}
name|al_info
argument_list|(
literal|"PCIE_%d: link is not established in time\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
return|return
name|ETIMEDOUT
return|;
block|}
end_function

begin_comment
comment|/** get link status */
end_comment

begin_function
name|int
name|al_pcie_link_status
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|struct
name|al_pcie_link_status
modifier|*
name|status
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|uint16_t
name|pcie_lnksta
decl_stmt|;
name|al_assert
argument_list|(
name|status
argument_list|)
expr_stmt|;
name|status
operator|->
name|link_up
operator|=
name|al_pcie_check_link
argument_list|(
name|pcie_port
argument_list|,
operator|&
name|status
operator|->
name|ltssm_state
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|status
operator|->
name|link_up
condition|)
block|{
name|status
operator|->
name|speed
operator|=
name|AL_PCIE_LINK_SPEED_DEFAULT
expr_stmt|;
name|status
operator|->
name|lanes
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
name|pcie_lnksta
operator|=
name|al_reg_read16
argument_list|(
operator|(
name|uint16_t
name|__iomem
operator|*
operator|)
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|pcie_cap_base
operator|+
operator|(
name|AL_PCI_EXP_LNKSTA
operator|>>
literal|1
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|pcie_lnksta
operator|&
name|AL_PCI_EXP_LNKSTA_CLS
condition|)
block|{
case|case
name|AL_PCI_EXP_LNKSTA_CLS_2_5GB
case|:
name|status
operator|->
name|speed
operator|=
name|AL_PCIE_LINK_SPEED_GEN1
expr_stmt|;
break|break;
case|case
name|AL_PCI_EXP_LNKSTA_CLS_5_0GB
case|:
name|status
operator|->
name|speed
operator|=
name|AL_PCIE_LINK_SPEED_GEN2
expr_stmt|;
break|break;
case|case
name|AL_PCI_EXP_LNKSTA_CLS_8_0GB
case|:
name|status
operator|->
name|speed
operator|=
name|AL_PCIE_LINK_SPEED_GEN3
expr_stmt|;
break|break;
default|default:
name|status
operator|->
name|speed
operator|=
name|AL_PCIE_LINK_SPEED_DEFAULT
expr_stmt|;
name|al_err
argument_list|(
literal|"PCIe %d: unknown link speed indication. PCIE LINK STATUS %x\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
name|pcie_lnksta
argument_list|)
expr_stmt|;
block|}
name|status
operator|->
name|lanes
operator|=
operator|(
name|pcie_lnksta
operator|&
name|AL_PCI_EXP_LNKSTA_NLW
operator|)
operator|>>
name|AL_PCI_EXP_LNKSTA_NLW_SHIFT
expr_stmt|;
name|al_info
argument_list|(
literal|"PCIe %d: Link up. speed gen%d negotiated width %d\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
name|status
operator|->
name|speed
argument_list|,
name|status
operator|->
name|lanes
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** get lane status */
end_comment

begin_function
name|void
name|al_pcie_lane_status_get
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|unsigned
name|int
name|lane
parameter_list|,
name|struct
name|al_pcie_lane_status
modifier|*
name|status
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|uint32_t
name|lane_status
decl_stmt|;
name|uint32_t
modifier|*
name|reg_ptr
decl_stmt|;
name|al_assert
argument_list|(
name|pcie_port
argument_list|)
expr_stmt|;
name|al_assert
argument_list|(
name|status
argument_list|)
expr_stmt|;
name|al_assert
argument_list|(
operator|(
name|pcie_port
operator|->
name|rev_id
operator|!=
name|AL_PCIE_REV_ID_1
operator|)
operator|||
operator|(
name|lane
operator|<
name|REV1_2_MAX_NUM_LANES
operator|)
argument_list|)
expr_stmt|;
name|al_assert
argument_list|(
operator|(
name|pcie_port
operator|->
name|rev_id
operator|!=
name|AL_PCIE_REV_ID_2
operator|)
operator|||
operator|(
name|lane
operator|<
name|REV1_2_MAX_NUM_LANES
operator|)
argument_list|)
expr_stmt|;
name|al_assert
argument_list|(
operator|(
name|pcie_port
operator|->
name|rev_id
operator|!=
name|AL_PCIE_REV_ID_3
operator|)
operator|||
operator|(
name|lane
operator|<
name|REV3_MAX_NUM_LANES
operator|)
argument_list|)
expr_stmt|;
name|reg_ptr
operator|=
name|regs
operator|->
name|axi
operator|.
name|status
operator|.
name|lane
index|[
name|lane
index|]
expr_stmt|;
comment|/* Reset field is valid only when same value is read twice */
do|do
block|{
name|lane_status
operator|=
name|al_reg_read32
argument_list|(
name|reg_ptr
argument_list|)
expr_stmt|;
name|status
operator|->
name|is_reset
operator|=
operator|!
operator|!
operator|(
name|lane_status
operator|&
name|PCIE_AXI_STATUS_LANE_IS_RESET
operator|)
expr_stmt|;
block|}
do|while
condition|(
name|status
operator|->
name|is_reset
operator|!=
operator|(
operator|!
operator|!
operator|(
name|al_reg_read32
argument_list|(
name|reg_ptr
argument_list|)
operator|&
name|PCIE_AXI_STATUS_LANE_IS_RESET
operator|)
operator|)
condition|)
do|;
name|status
operator|->
name|requested_speed
operator|=
operator|(
name|lane_status
operator|&
name|PCIE_AXI_STATUS_LANE_REQUESTED_SPEED_MASK
operator|)
operator|>>
name|PCIE_AXI_STATUS_LANE_REQUESTED_SPEED_SHIFT
expr_stmt|;
block|}
end_function

begin_comment
comment|/** trigger hot reset */
end_comment

begin_function
name|int
name|al_pcie_link_hot_reset
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|al_bool
name|enable
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|uint32_t
name|events_gen
decl_stmt|;
name|al_bool
name|app_reset_state
decl_stmt|;
name|enum
name|al_pcie_operating_mode
name|op_mode
init|=
name|al_pcie_operating_mode_get
argument_list|(
name|pcie_port
argument_list|)
decl_stmt|;
if|if
condition|(
name|op_mode
operator|!=
name|AL_PCIE_OPERATING_MODE_RC
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: hot-reset is applicable only for RC mode\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|!
name|al_pcie_is_link_started
argument_list|(
name|pcie_port
argument_list|)
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: link not started, cannot trigger hot-reset\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|events_gen
operator|=
name|al_reg_read32
argument_list|(
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|events_gen
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|app_reset_state
operator|=
name|events_gen
operator|&
name|PCIE_W_GLOBAL_CTRL_EVENTS_GEN_APP_RST_INIT
expr_stmt|;
if|if
condition|(
name|enable
operator|&&
name|app_reset_state
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: link is already in hot-reset state\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|!
name|enable
operator|)
operator|&&
operator|(
operator|!
operator|(
name|app_reset_state
operator|)
operator|)
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: link is already in non-hot-reset state\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
else|else
block|{
name|al_dbg
argument_list|(
literal|"PCIe %d: %s hot-reset\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
operator|(
name|enable
condition|?
literal|"enabling"
else|:
literal|"disabling"
operator|)
argument_list|)
expr_stmt|;
comment|/* hot-reset functionality is implemented only for function 0 */
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|events_gen
index|[
literal|0
index|]
argument_list|,
name|PCIE_W_GLOBAL_CTRL_EVENTS_GEN_APP_RST_INIT
argument_list|,
operator|(
name|enable
condition|?
name|PCIE_W_GLOBAL_CTRL_EVENTS_GEN_APP_RST_INIT
else|:
operator|~
name|PCIE_W_GLOBAL_CTRL_EVENTS_GEN_APP_RST_INIT
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
end_function

begin_comment
comment|/** disable port link */
end_comment

begin_function
name|int
name|al_pcie_link_disable
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|al_bool
name|disable
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|uint32_t
name|pcie_lnkctl
decl_stmt|;
name|al_bool
name|link_disable_state
decl_stmt|;
name|enum
name|al_pcie_operating_mode
name|op_mode
init|=
name|al_pcie_operating_mode_get
argument_list|(
name|pcie_port
argument_list|)
decl_stmt|;
if|if
condition|(
name|op_mode
operator|!=
name|AL_PCIE_OPERATING_MODE_RC
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: hot-reset is applicable only for RC mode\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|!
name|al_pcie_is_link_started
argument_list|(
name|pcie_port
argument_list|)
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: link not started, cannot disable link\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|pcie_lnkctl
operator|=
name|al_reg_read32
argument_list|(
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|pcie_cap_base
operator|+
operator|(
name|AL_PCI_EXP_LNKCTL
operator|>>
literal|1
operator|)
argument_list|)
expr_stmt|;
name|link_disable_state
operator|=
name|pcie_lnkctl
operator|&
name|AL_PCI_EXP_LNKCTL_LNK_DIS
expr_stmt|;
if|if
condition|(
name|disable
operator|&&
name|link_disable_state
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: link is already in disable state\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
elseif|else
if|if
condition|(
operator|(
operator|!
name|disable
operator|)
operator|&&
operator|(
operator|!
operator|(
name|link_disable_state
operator|)
operator|)
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: link is already in enable state\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|al_dbg
argument_list|(
literal|"PCIe %d: %s port\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
operator|(
name|disable
condition|?
literal|"disabling"
else|:
literal|"enabling"
operator|)
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|pcie_cap_base
operator|+
operator|(
name|AL_PCI_EXP_LNKCTL
operator|>>
literal|1
operator|)
argument_list|,
name|AL_PCI_EXP_LNKCTL_LNK_DIS
argument_list|,
operator|(
name|disable
condition|?
name|AL_PCI_EXP_LNKCTL_LNK_DIS
else|:
operator|~
name|AL_PCI_EXP_LNKCTL_LNK_DIS
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** retrain link */
end_comment

begin_function
name|int
name|al_pcie_link_retrain
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|enum
name|al_pcie_operating_mode
name|op_mode
init|=
name|al_pcie_operating_mode_get
argument_list|(
name|pcie_port
argument_list|)
decl_stmt|;
if|if
condition|(
name|op_mode
operator|!=
name|AL_PCIE_OPERATING_MODE_RC
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: link-retrain is applicable only for RC mode\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|!
name|al_pcie_is_link_started
argument_list|(
name|pcie_port
argument_list|)
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: link not started, cannot link-retrain\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|core_space
index|[
literal|0
index|]
operator|.
name|pcie_cap_base
operator|+
operator|(
name|AL_PCI_EXP_LNKCTL
operator|>>
literal|1
operator|)
argument_list|,
name|AL_PCI_EXP_LNKCTL_LNK_RTRN
argument_list|,
name|AL_PCI_EXP_LNKCTL_LNK_RTRN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* trigger speed change */
end_comment

begin_function
name|int
name|al_pcie_link_change_speed
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|enum
name|al_pcie_link_speed
name|new_speed
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
if|if
condition|(
operator|!
name|al_pcie_is_link_started
argument_list|(
name|pcie_port
argument_list|)
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: link not started, cannot change speed\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|al_dbg
argument_list|(
literal|"PCIe %d: changing speed to %d\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
name|new_speed
argument_list|)
expr_stmt|;
name|al_pcie_port_link_speed_ctrl_set
argument_list|(
name|pcie_port
argument_list|,
name|new_speed
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|gen2_ctrl
argument_list|,
name|PCIE_PORT_GEN2_CTRL_DIRECT_SPEED_CHANGE
argument_list|,
name|PCIE_PORT_GEN2_CTRL_DIRECT_SPEED_CHANGE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* TODO: check if this function needed */
end_comment

begin_decl_stmt
name|int
name|al_pcie_link_change_width
argument_list|(
expr|struct
name|al_pcie_port
operator|*
name|pcie_port
argument_list|,
name|uint8_t
name|width
name|__attribute__
argument_list|(
operator|(
name|__unused__
operator|)
argument_list|)
argument_list|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: link change width not implemented\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOSYS
return|;
block|}
end_decl_stmt

begin_comment
comment|/**************************** Post Link Start API *****************************/
end_comment

begin_comment
comment|/************************** Snoop Configuration API ***************************/
end_comment

begin_function
name|int
name|al_pcie_port_snoop_config
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|al_bool
name|enable_axi_snoop
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
comment|/* Set snoop mode */
name|al_info
argument_list|(
literal|"PCIE_%d: snoop mode %s\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|,
name|enable_axi_snoop
condition|?
literal|"enable"
else|:
literal|"disable"
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable_axi_snoop
condition|)
block|{
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|master_arctl
argument_list|,
name|PCIE_AXI_CTRL_MASTER_ARCTL_OVR_SNOOP
operator||
name|PCIE_AXI_CTRL_MASTER_ARCTL_SNOOP
argument_list|,
name|PCIE_AXI_CTRL_MASTER_ARCTL_OVR_SNOOP
operator||
name|PCIE_AXI_CTRL_MASTER_ARCTL_SNOOP
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|master_awctl
argument_list|,
name|PCIE_AXI_CTRL_MASTER_AWCTL_OVR_SNOOP
operator||
name|PCIE_AXI_CTRL_MASTER_AWCTL_SNOOP
argument_list|,
name|PCIE_AXI_CTRL_MASTER_AWCTL_OVR_SNOOP
operator||
name|PCIE_AXI_CTRL_MASTER_AWCTL_SNOOP
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|master_arctl
argument_list|,
name|PCIE_AXI_CTRL_MASTER_ARCTL_OVR_SNOOP
operator||
name|PCIE_AXI_CTRL_MASTER_ARCTL_SNOOP
argument_list|,
name|PCIE_AXI_CTRL_MASTER_ARCTL_OVR_SNOOP
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|master_awctl
argument_list|,
name|PCIE_AXI_CTRL_MASTER_AWCTL_OVR_SNOOP
operator||
name|PCIE_AXI_CTRL_MASTER_AWCTL_SNOOP
argument_list|,
name|PCIE_AXI_CTRL_MASTER_AWCTL_OVR_SNOOP
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/************************** Configuration Space API ***************************/
end_comment

begin_comment
comment|/** get base address of pci configuration space header */
end_comment

begin_function
name|int
name|al_pcie_config_space_get
parameter_list|(
name|struct
name|al_pcie_pf
modifier|*
name|pcie_pf
parameter_list|,
name|uint8_t
name|__iomem
modifier|*
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_pf
operator|->
name|pcie_port
operator|->
name|regs
decl_stmt|;
operator|*
name|addr
operator|=
operator|(
name|uint8_t
name|__iomem
operator|*
operator|)
operator|&
name|regs
operator|->
name|core_space
index|[
name|pcie_pf
operator|->
name|pf_num
index|]
operator|.
name|config_header
index|[
literal|0
index|]
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Read data from the local configuration space */
end_comment

begin_function
name|uint32_t
name|al_pcie_local_cfg_space_read
parameter_list|(
name|struct
name|al_pcie_pf
modifier|*
name|pcie_pf
parameter_list|,
name|unsigned
name|int
name|reg_offset
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_pf
operator|->
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|uint32_t
name|data
decl_stmt|;
name|data
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|regs
operator|->
name|core_space
index|[
name|pcie_pf
operator|->
name|pf_num
index|]
operator|.
name|config_header
index|[
name|reg_offset
index|]
argument_list|)
expr_stmt|;
return|return
name|data
return|;
block|}
end_function

begin_comment
comment|/* Write data to the local configuration space */
end_comment

begin_function
name|void
name|al_pcie_local_cfg_space_write
parameter_list|(
name|struct
name|al_pcie_pf
modifier|*
name|pcie_pf
parameter_list|,
name|unsigned
name|int
name|reg_offset
parameter_list|,
name|uint32_t
name|data
parameter_list|,
name|al_bool
name|cs2
parameter_list|,
name|al_bool
name|allow_ro_wr
parameter_list|)
block|{
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
init|=
name|pcie_pf
operator|->
name|pcie_port
decl_stmt|;
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|unsigned
name|int
name|pf_num
init|=
name|pcie_pf
operator|->
name|pf_num
decl_stmt|;
name|uint32_t
modifier|*
name|offset
init|=
operator|&
name|regs
operator|->
name|core_space
index|[
name|pf_num
index|]
operator|.
name|config_header
index|[
name|reg_offset
index|]
decl_stmt|;
if|if
condition|(
name|allow_ro_wr
condition|)
name|al_pcie_port_wr_to_ro_set
argument_list|(
name|pcie_port
argument_list|,
name|AL_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|cs2
operator|==
name|AL_FALSE
condition|)
name|al_reg_write32
argument_list|(
name|offset
argument_list|,
name|data
argument_list|)
expr_stmt|;
else|else
name|al_reg_write32_dbi_cs2
argument_list|(
name|pcie_port
argument_list|,
name|offset
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|allow_ro_wr
condition|)
name|al_pcie_port_wr_to_ro_set
argument_list|(
name|pcie_port
argument_list|,
name|AL_FALSE
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/** set target_bus and mask_target_bus */
end_comment

begin_function
name|int
name|al_pcie_target_bus_set
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|uint8_t
name|target_bus
parameter_list|,
name|uint8_t
name|mask_target_bus
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
operator|(
expr|struct
name|al_pcie_regs
operator|*
operator|)
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|cfg_target_bus
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|PCIE_AXI_MISC_OB_CTRL_CFG_TARGET_BUS_MASK_MASK
argument_list|,
name|PCIE_AXI_MISC_OB_CTRL_CFG_TARGET_BUS_MASK_SHIFT
argument_list|,
name|mask_target_bus
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|PCIE_AXI_MISC_OB_CTRL_CFG_TARGET_BUS_BUSNUM_MASK
argument_list|,
name|PCIE_AXI_MISC_OB_CTRL_CFG_TARGET_BUS_BUSNUM_SHIFT
argument_list|,
name|target_bus
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|cfg_target_bus
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** get target_bus and mask_target_bus */
end_comment

begin_function
name|int
name|al_pcie_target_bus_get
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|uint8_t
modifier|*
name|target_bus
parameter_list|,
name|uint8_t
modifier|*
name|mask_target_bus
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
operator|(
expr|struct
name|al_pcie_regs
operator|*
operator|)
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|al_assert
argument_list|(
name|target_bus
argument_list|)
expr_stmt|;
name|al_assert
argument_list|(
name|mask_target_bus
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|cfg_target_bus
argument_list|)
expr_stmt|;
operator|*
name|mask_target_bus
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|PCIE_AXI_MISC_OB_CTRL_CFG_TARGET_BUS_MASK_MASK
argument_list|,
name|PCIE_AXI_MISC_OB_CTRL_CFG_TARGET_BUS_MASK_SHIFT
argument_list|)
expr_stmt|;
operator|*
name|target_bus
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|PCIE_AXI_MISC_OB_CTRL_CFG_TARGET_BUS_BUSNUM_MASK
argument_list|,
name|PCIE_AXI_MISC_OB_CTRL_CFG_TARGET_BUS_BUSNUM_SHIFT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** Set secondary bus number */
end_comment

begin_function
name|int
name|al_pcie_secondary_bus_set
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|uint8_t
name|secbus
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|uint32_t
name|secbus_val
init|=
operator|(
name|secbus
operator|<<
name|PCIE_AXI_MISC_OB_CTRL_CFG_CONTROL_SEC_BUS_SHIFT
operator|)
decl_stmt|;
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|cfg_control
argument_list|,
name|PCIE_AXI_MISC_OB_CTRL_CFG_CONTROL_SEC_BUS_MASK
argument_list|,
name|secbus_val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** Set sub-ordinary bus number */
end_comment

begin_function
name|int
name|al_pcie_subordinary_bus_set
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|uint8_t
name|subbus
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|uint32_t
name|subbus_val
init|=
operator|(
name|subbus
operator|<<
name|PCIE_AXI_MISC_OB_CTRL_CFG_CONTROL_SUBBUS_SHIFT
operator|)
decl_stmt|;
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|cfg_control
argument_list|,
name|PCIE_AXI_MISC_OB_CTRL_CFG_CONTROL_SUBBUS_MASK
argument_list|,
name|subbus_val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Enable/disable deferring incoming configuration requests */
end_comment

begin_function
name|void
name|al_pcie_app_req_retry_set
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|al_bool
name|en
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|uint32_t
name|mask
init|=
operator|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_3
operator|)
condition|?
name|PCIE_W_REV3_GLOBAL_CTRL_PM_CONTROL_APP_REQ_RETRY_EN
else|:
name|PCIE_W_REV1_2_GLOBAL_CTRL_PM_CONTROL_APP_REQ_RETRY_EN
decl_stmt|;
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|pm_control
argument_list|,
name|mask
argument_list|,
operator|(
name|en
operator|==
name|AL_TRUE
operator|)
condition|?
name|mask
else|:
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*************** Internal Address Translation Unit (ATU) API ******************/
end_comment

begin_comment
comment|/** program internal ATU region entry */
end_comment

begin_function
name|int
name|al_pcie_atu_region_set
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|struct
name|al_pcie_atu_region
modifier|*
name|atu_region
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|enum
name|al_pcie_operating_mode
name|op_mode
init|=
name|al_pcie_operating_mode_get
argument_list|(
name|pcie_port
argument_list|)
decl_stmt|;
name|uint32_t
name|reg
init|=
literal|0
decl_stmt|;
comment|/** 	 * Addressing RMN: 5384 	 * 	 * RMN description: 	 * From SNPS (also included in the data book) Dynamic iATU Programming 	 * With AHB/AXI Bridge Module When the bridge slave interface clock 	 * (hresetn or slv_aclk) is asynchronous to the PCIe native core clock 	 * (core_clk), you must not update the iATU registers while operations 	 * are in progress on the AHB/AXI bridge slave interface. The iATU 	 * registers are in the core_clk clock domain. The register outputs are 	 * used in the AHB/AXI bridge slave interface clock domain. There is no 	 * synchronization logic between these registers and the AHB/AXI bridge 	 * slave interface. 	 * 	 * Software flow: 	 * Do not allow configuring Outbound iATU after link is started 	 */
if|if
condition|(
operator|(
name|atu_region
operator|->
name|direction
operator|==
name|AL_PCIE_ATU_DIR_OUTBOUND
operator|)
operator|&&
operator|(
name|al_pcie_is_link_started
argument_list|(
name|pcie_port
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|atu_region
operator|->
name|enforce_ob_atu_region_set
condition|)
block|{
name|al_err
argument_list|(
literal|"PCIe %d: setting OB iATU after link is started is not allowed\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
else|else
block|{
name|al_info
argument_list|(
literal|"PCIe %d: setting OB iATU even after link is started\n"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*TODO : add sanity check */
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
literal|0xF
argument_list|,
literal|0
argument_list|,
name|atu_region
operator|->
name|index
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
literal|31
argument_list|,
name|atu_region
operator|->
name|direction
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|iatu
operator|.
name|index
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|iatu
operator|.
name|lower_base_addr
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|atu_region
operator|->
name|base_addr
operator|&
literal|0xFFFFFFFF
argument_list|)
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|iatu
operator|.
name|upper_base_addr
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|atu_region
operator|->
name|base_addr
operator|>>
literal|32
operator|)
operator|&
literal|0xFFFFFFFF
argument_list|)
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|iatu
operator|.
name|lower_target_addr
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|atu_region
operator|->
name|target_addr
operator|&
literal|0xFFFFFFFF
argument_list|)
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|iatu
operator|.
name|upper_target_addr
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|atu_region
operator|->
name|target_addr
operator|>>
literal|32
operator|)
operator|&
literal|0xFFFFFFFF
argument_list|)
argument_list|)
expr_stmt|;
comment|/* configure the limit, not needed when working in BAR match mode */
if|if
condition|(
name|atu_region
operator|->
name|match_mode
operator|==
literal|0
condition|)
block|{
name|uint32_t
name|limit_reg_val
decl_stmt|;
if|if
condition|(
name|pcie_port
operator|->
name|rev_id
operator|>
name|AL_PCIE_REV_ID_0
condition|)
block|{
name|uint32_t
modifier|*
name|limit_ext_reg
init|=
operator|(
name|atu_region
operator|->
name|direction
operator|==
name|AL_PCIE_ATU_DIR_OUTBOUND
operator|)
condition|?
operator|&
name|regs
operator|->
name|app
operator|.
name|atu
operator|.
name|out_mask_pair
index|[
name|atu_region
operator|->
name|index
operator|/
literal|2
index|]
else|:
operator|&
name|regs
operator|->
name|app
operator|.
name|atu
operator|.
name|in_mask_pair
index|[
name|atu_region
operator|->
name|index
operator|/
literal|2
index|]
decl_stmt|;
name|uint32_t
name|limit_ext_reg_mask
init|=
operator|(
name|atu_region
operator|->
name|index
operator|%
literal|2
operator|)
condition|?
name|PCIE_W_ATU_MASK_EVEN_ODD_ATU_MASK_40_32_ODD_MASK
else|:
name|PCIE_W_ATU_MASK_EVEN_ODD_ATU_MASK_40_32_EVEN_MASK
decl_stmt|;
name|unsigned
name|int
name|limit_ext_reg_shift
init|=
operator|(
name|atu_region
operator|->
name|index
operator|%
literal|2
operator|)
condition|?
name|PCIE_W_ATU_MASK_EVEN_ODD_ATU_MASK_40_32_ODD_SHIFT
else|:
name|PCIE_W_ATU_MASK_EVEN_ODD_ATU_MASK_40_32_EVEN_SHIFT
decl_stmt|;
name|uint64_t
name|limit_sz_msk
init|=
name|atu_region
operator|->
name|limit
operator|-
name|atu_region
operator|->
name|base_addr
decl_stmt|;
name|uint32_t
name|limit_ext_reg_val
init|=
call|(
name|uint32_t
call|)
argument_list|(
operator|(
operator|(
name|limit_sz_msk
operator|)
operator|>>
literal|32
operator|)
operator|&
literal|0xFFFFFFFF
argument_list|)
decl_stmt|;
if|if
condition|(
name|limit_ext_reg_val
condition|)
block|{
name|limit_reg_val
operator|=
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|limit_sz_msk
operator|)
operator|&
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
name|al_assert
argument_list|(
name|limit_reg_val
operator|==
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|limit_reg_val
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|atu_region
operator|->
name|limit
operator|&
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
block|}
name|al_reg_write32_masked
argument_list|(
name|limit_ext_reg
argument_list|,
name|limit_ext_reg_mask
argument_list|,
name|limit_ext_reg_val
operator|<<
name|limit_ext_reg_shift
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|limit_reg_val
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|atu_region
operator|->
name|limit
operator|&
literal|0xFFFFFFFF
argument_list|)
expr_stmt|;
block|}
name|al_reg_write32
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|iatu
operator|.
name|limit_addr
argument_list|,
name|limit_reg_val
argument_list|)
expr_stmt|;
block|}
name|reg
operator|=
literal|0
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
literal|0x1F
argument_list|,
literal|0
argument_list|,
name|atu_region
operator|->
name|tlp_type
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
literal|0x3
operator|<<
literal|9
argument_list|,
literal|9
argument_list|,
name|atu_region
operator|->
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|pcie_port
operator|->
name|rev_id
operator|==
name|AL_PCIE_REV_ID_3
operator|)
operator|&&
operator|(
name|op_mode
operator|==
name|AL_PCIE_OPERATING_MODE_EP
operator|)
operator|&&
operator|(
name|atu_region
operator|->
name|function_match_bypass_mode
operator|)
condition|)
block|{
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|PCIE_IATU_CR1_FUNC_NUM_MASK
argument_list|,
name|PCIE_IATU_CR1_FUNC_NUM_SHIFT
argument_list|,
name|atu_region
operator|->
name|function_match_bypass_mode_number
argument_list|)
expr_stmt|;
block|}
name|al_reg_write32
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|iatu
operator|.
name|cr1
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* Enable/disable the region. */
name|reg
operator|=
literal|0
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
literal|0xFF
argument_list|,
literal|0
argument_list|,
name|atu_region
operator|->
name|msg_code
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
literal|0x700
argument_list|,
literal|8
argument_list|,
name|atu_region
operator|->
name|bar_number
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
literal|0x3
operator|<<
literal|24
argument_list|,
literal|24
argument_list|,
name|atu_region
operator|->
name|response
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
literal|16
argument_list|,
name|atu_region
operator|->
name|enable_attr_match_mode
operator|==
name|AL_TRUE
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
literal|21
argument_list|,
name|atu_region
operator|->
name|enable_msg_match_mode
operator|==
name|AL_TRUE
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
literal|28
argument_list|,
name|atu_region
operator|->
name|cfg_shift_mode
operator|==
name|AL_TRUE
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
literal|29
argument_list|,
name|atu_region
operator|->
name|invert_matching
operator|==
name|AL_TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|atu_region
operator|->
name|tlp_type
operator|==
name|AL_PCIE_TLP_TYPE_MEM
operator|||
name|atu_region
operator|->
name|tlp_type
operator|==
name|AL_PCIE_TLP_TYPE_IO
condition|)
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
literal|30
argument_list|,
operator|!
operator|!
name|atu_region
operator|->
name|match_mode
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
literal|31
argument_list|,
operator|!
operator|!
name|atu_region
operator|->
name|enable
argument_list|)
expr_stmt|;
comment|/* In outbound, enable function bypass 	 * In inbound, enable function match mode 	 * Note: this is the same bit, has different meanings in ob/ib ATUs 	 */
if|if
condition|(
name|op_mode
operator|==
name|AL_PCIE_OPERATING_MODE_EP
condition|)
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|PCIE_IATU_CR2_FUNC_NUM_TRANS_BYPASS_FUNC_MATCH_ENABLE_MASK
argument_list|,
name|PCIE_IATU_CR2_FUNC_NUM_TRANS_BYPASS_FUNC_MATCH_ENABLE_SHIFT
argument_list|,
name|atu_region
operator|->
name|function_match_bypass_mode
condition|?
literal|0x1
else|:
literal|0x0
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|iatu
operator|.
name|cr2
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** obtains internal ATU region base/target addresses */
end_comment

begin_function
name|void
name|al_pcie_atu_region_get_fields
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|enum
name|al_pcie_atu_dir
name|direction
parameter_list|,
name|uint8_t
name|index
parameter_list|,
name|al_bool
modifier|*
name|enable
parameter_list|,
name|uint64_t
modifier|*
name|base_addr
parameter_list|,
name|uint64_t
modifier|*
name|target_addr
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|uint64_t
name|high_addr
decl_stmt|;
name|uint32_t
name|reg
init|=
literal|0
decl_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
literal|0xF
argument_list|,
literal|0
argument_list|,
name|index
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
literal|31
argument_list|,
name|direction
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|iatu
operator|.
name|index
argument_list|,
name|reg
argument_list|)
expr_stmt|;
operator|*
name|base_addr
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|iatu
operator|.
name|lower_base_addr
argument_list|)
expr_stmt|;
name|high_addr
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|iatu
operator|.
name|upper_base_addr
argument_list|)
expr_stmt|;
name|high_addr
operator|<<=
literal|32
expr_stmt|;
operator|*
name|base_addr
operator||=
name|high_addr
expr_stmt|;
operator|*
name|target_addr
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|iatu
operator|.
name|lower_target_addr
argument_list|)
expr_stmt|;
name|high_addr
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|iatu
operator|.
name|upper_target_addr
argument_list|)
expr_stmt|;
name|high_addr
operator|<<=
literal|32
expr_stmt|;
operator|*
name|target_addr
operator||=
name|high_addr
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|iatu
operator|.
name|cr1
argument_list|)
expr_stmt|;
operator|*
name|enable
operator|=
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
literal|31
argument_list|)
condition|?
name|AL_TRUE
else|:
name|AL_FALSE
expr_stmt|;
block|}
end_function

begin_function
name|void
name|al_pcie_axi_io_config
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|,
name|al_phys_addr_t
name|start
parameter_list|,
name|al_phys_addr_t
name|end
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_start_h
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|start
operator|>>
literal|32
operator|)
operator|&
literal|0xFFFFFFFF
argument_list|)
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_start_l
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|start
operator|&
literal|0xFFFFFFFF
argument_list|)
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_limit_h
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|end
operator|>>
literal|32
operator|)
operator|&
literal|0xFFFFFFFF
argument_list|)
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|ob_ctrl
operator|.
name|io_limit_l
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|end
operator|&
literal|0xFFFFFFFF
argument_list|)
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|axi
operator|.
name|ctrl
operator|.
name|slv_ctl
argument_list|,
name|PCIE_AXI_CTRL_SLV_CTRL_IO_BAR_EN
argument_list|,
name|PCIE_AXI_CTRL_SLV_CTRL_IO_BAR_EN
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/************** Interrupt generation (Endpoint mode Only) API *****************/
end_comment

begin_comment
comment|/** generate INTx Assert/DeAssert Message */
end_comment

begin_function
name|int
name|al_pcie_legacy_int_gen
parameter_list|(
name|struct
name|al_pcie_pf
modifier|*
name|pcie_pf
parameter_list|,
name|al_bool
name|assert
parameter_list|,
name|enum
name|al_pcie_legacy_int_type
name|type
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_pf
operator|->
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|unsigned
name|int
name|pf_num
init|=
name|pcie_pf
operator|->
name|pf_num
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|al_assert
argument_list|(
name|type
operator|==
name|AL_PCIE_LEGACY_INTA
argument_list|)
expr_stmt|;
comment|/* only INTA supported */
name|reg
operator|=
name|al_reg_read32
argument_list|(
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|events_gen
index|[
name|pf_num
index|]
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
literal|3
argument_list|,
operator|!
operator|!
name|assert
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|events_gen
index|[
name|pf_num
index|]
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** generate MSI interrupt */
end_comment

begin_function
name|int
name|al_pcie_msi_int_gen
parameter_list|(
name|struct
name|al_pcie_pf
modifier|*
name|pcie_pf
parameter_list|,
name|uint8_t
name|vector
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_pf
operator|->
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|unsigned
name|int
name|pf_num
init|=
name|pcie_pf
operator|->
name|pf_num
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
comment|/* set msi vector and clear MSI request */
name|reg
operator|=
name|al_reg_read32
argument_list|(
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|events_gen
index|[
name|pf_num
index|]
argument_list|)
expr_stmt|;
name|AL_REG_BIT_CLEAR
argument_list|(
name|reg
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|PCIE_W_GLOBAL_CTRL_EVENTS_GEN_MSI_VECTOR_MASK
argument_list|,
name|PCIE_W_GLOBAL_CTRL_EVENTS_GEN_MSI_VECTOR_SHIFT
argument_list|,
name|vector
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|events_gen
index|[
name|pf_num
index|]
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* set MSI request */
name|AL_REG_BIT_SET
argument_list|(
name|reg
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|app
operator|.
name|global_ctrl
operator|.
name|events_gen
index|[
name|pf_num
index|]
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** configure MSIX capability */
end_comment

begin_function
name|int
name|al_pcie_msix_config
parameter_list|(
name|struct
name|al_pcie_pf
modifier|*
name|pcie_pf
parameter_list|,
name|struct
name|al_pcie_msix_params
modifier|*
name|msix_params
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_pf
operator|->
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|unsigned
name|int
name|pf_num
init|=
name|pcie_pf
operator|->
name|pf_num
decl_stmt|;
name|uint32_t
name|msix_reg0
decl_stmt|;
name|al_pcie_port_wr_to_ro_set
argument_list|(
name|pcie_pf
operator|->
name|pcie_port
argument_list|,
name|AL_TRUE
argument_list|)
expr_stmt|;
name|msix_reg0
operator|=
name|al_reg_read32
argument_list|(
name|regs
operator|->
name|core_space
index|[
name|pf_num
index|]
operator|.
name|msix_cap_base
argument_list|)
expr_stmt|;
name|msix_reg0
operator|&=
operator|~
operator|(
name|AL_PCI_MSIX_MSGCTRL_TBL_SIZE
operator|<<
name|AL_PCI_MSIX_MSGCTRL_TBL_SIZE_SHIFT
operator|)
expr_stmt|;
name|msix_reg0
operator||=
operator|(
operator|(
name|msix_params
operator|->
name|table_size
operator|-
literal|1
operator|)
operator|&
name|AL_PCI_MSIX_MSGCTRL_TBL_SIZE
operator|)
operator|<<
name|AL_PCI_MSIX_MSGCTRL_TBL_SIZE_SHIFT
expr_stmt|;
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|core_space
index|[
name|pf_num
index|]
operator|.
name|msix_cap_base
argument_list|,
name|msix_reg0
argument_list|)
expr_stmt|;
comment|/* Table offset& BAR */
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|core_space
index|[
name|pf_num
index|]
operator|.
name|msix_cap_base
operator|+
operator|(
name|AL_PCI_MSIX_TABLE
operator|>>
literal|2
operator|)
argument_list|,
operator|(
name|msix_params
operator|->
name|table_offset
operator|&
name|AL_PCI_MSIX_TABLE_OFFSET
operator|)
operator||
operator|(
name|msix_params
operator|->
name|table_bar
operator|&
name|AL_PCI_MSIX_TABLE_BAR
operator|)
argument_list|)
expr_stmt|;
comment|/* PBA offset& BAR */
name|al_reg_write32
argument_list|(
name|regs
operator|->
name|core_space
index|[
name|pf_num
index|]
operator|.
name|msix_cap_base
operator|+
operator|(
name|AL_PCI_MSIX_PBA
operator|>>
literal|2
operator|)
argument_list|,
operator|(
name|msix_params
operator|->
name|pba_offset
operator|&
name|AL_PCI_MSIX_PBA_OFFSET
operator|)
operator||
operator|(
name|msix_params
operator|->
name|pba_bar
operator|&
name|AL_PCI_MSIX_PBA_BAR
operator|)
argument_list|)
expr_stmt|;
name|al_pcie_port_wr_to_ro_set
argument_list|(
name|pcie_pf
operator|->
name|pcie_port
argument_list|,
name|AL_FALSE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** check whether MSIX is enabled */
end_comment

begin_function
name|al_bool
name|al_pcie_msix_enabled
parameter_list|(
name|struct
name|al_pcie_pf
modifier|*
name|pcie_pf
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_pf
operator|->
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|uint32_t
name|msix_reg0
init|=
name|al_reg_read32
argument_list|(
name|regs
operator|->
name|core_space
index|[
name|pcie_pf
operator|->
name|pf_num
index|]
operator|.
name|msix_cap_base
argument_list|)
decl_stmt|;
if|if
condition|(
name|msix_reg0
operator|&
name|AL_PCI_MSIX_MSGCTRL_EN
condition|)
return|return
name|AL_TRUE
return|;
return|return
name|AL_FALSE
return|;
block|}
end_function

begin_comment
comment|/** check whether MSIX is masked */
end_comment

begin_function
name|al_bool
name|al_pcie_msix_masked
parameter_list|(
name|struct
name|al_pcie_pf
modifier|*
name|pcie_pf
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_pf
operator|->
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|uint32_t
name|msix_reg0
init|=
name|al_reg_read32
argument_list|(
name|regs
operator|->
name|core_space
index|[
name|pcie_pf
operator|->
name|pf_num
index|]
operator|.
name|msix_cap_base
argument_list|)
decl_stmt|;
if|if
condition|(
name|msix_reg0
operator|&
name|AL_PCI_MSIX_MSGCTRL_MASK
condition|)
return|return
name|AL_TRUE
return|;
return|return
name|AL_FALSE
return|;
block|}
end_function

begin_comment
comment|/******************** Advanced Error Reporting (AER) API **********************/
end_comment

begin_comment
comment|/** configure AER capability */
end_comment

begin_function
name|int
name|al_pcie_aer_config
parameter_list|(
name|struct
name|al_pcie_pf
modifier|*
name|pcie_pf
parameter_list|,
name|struct
name|al_pcie_aer_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_pf
operator|->
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|struct
name|al_pcie_core_aer_regs
modifier|*
name|aer_regs
init|=
name|regs
operator|->
name|core_space
index|[
name|pcie_pf
operator|->
name|pf_num
index|]
operator|.
name|aer
decl_stmt|;
name|uint32_t
name|reg_val
decl_stmt|;
name|reg_val
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|aer_regs
operator|->
name|header
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|reg_val
operator|&
name|PCIE_AER_CAP_ID_MASK
operator|)
operator|>>
name|PCIE_AER_CAP_ID_SHIFT
operator|)
operator|!=
name|PCIE_AER_CAP_ID_VAL
condition|)
return|return
operator|-
name|EIO
return|;
if|if
condition|(
operator|(
operator|(
name|reg_val
operator|&
name|PCIE_AER_CAP_VER_MASK
operator|)
operator|>>
name|PCIE_AER_CAP_VER_SHIFT
operator|)
operator|!=
name|PCIE_AER_CAP_VER_VAL
condition|)
return|return
operator|-
name|EIO
return|;
name|al_reg_write32
argument_list|(
operator|&
name|aer_regs
operator|->
name|corr_err_mask
argument_list|,
operator|~
name|params
operator|->
name|enabled_corr_err
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|aer_regs
operator|->
name|uncorr_err_mask
argument_list|,
operator|(
operator|~
name|params
operator|->
name|enabled_uncorr_non_fatal_err
operator|)
operator||
operator|(
operator|~
name|params
operator|->
name|enabled_uncorr_fatal_err
operator|)
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|aer_regs
operator|->
name|uncorr_err_severity
argument_list|,
name|params
operator|->
name|enabled_uncorr_fatal_err
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|aer_regs
operator|->
name|cap_and_ctrl
argument_list|,
operator|(
name|params
operator|->
name|ecrc_gen_en
condition|?
name|PCIE_AER_CTRL_STAT_ECRC_GEN_EN
else|:
literal|0
operator|)
operator||
operator|(
name|params
operator|->
name|ecrc_chk_en
condition|?
name|PCIE_AER_CTRL_STAT_ECRC_CHK_EN
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
name|regs
operator|->
name|core_space
index|[
name|pcie_pf
operator|->
name|pf_num
index|]
operator|.
name|pcie_dev_ctrl_status
argument_list|,
name|PCIE_PORT_DEV_CTRL_STATUS_CORR_ERR_REPORT_EN
operator||
name|PCIE_PORT_DEV_CTRL_STATUS_NON_FTL_ERR_REPORT_EN
operator||
name|PCIE_PORT_DEV_CTRL_STATUS_FTL_ERR_REPORT_EN
operator||
name|PCIE_PORT_DEV_CTRL_STATUS_UNSUP_REQ_REPORT_EN
argument_list|,
operator|(
name|params
operator|->
name|enabled_corr_err
condition|?
name|PCIE_PORT_DEV_CTRL_STATUS_CORR_ERR_REPORT_EN
else|:
literal|0
operator|)
operator||
operator|(
name|params
operator|->
name|enabled_uncorr_non_fatal_err
condition|?
name|PCIE_PORT_DEV_CTRL_STATUS_NON_FTL_ERR_REPORT_EN
else|:
literal|0
operator|)
operator||
operator|(
name|params
operator|->
name|enabled_uncorr_fatal_err
condition|?
name|PCIE_PORT_DEV_CTRL_STATUS_FTL_ERR_REPORT_EN
else|:
literal|0
operator|)
operator||
operator|(
operator|(
name|params
operator|->
name|enabled_uncorr_non_fatal_err
operator|&
name|AL_PCIE_AER_UNCORR_UNSUPRT_REQ_ERR
operator|)
condition|?
name|PCIE_PORT_DEV_CTRL_STATUS_UNSUP_REQ_REPORT_EN
else|:
literal|0
operator|)
operator||
operator|(
operator|(
name|params
operator|->
name|enabled_uncorr_fatal_err
operator|&
name|AL_PCIE_AER_UNCORR_UNSUPRT_REQ_ERR
operator|)
condition|?
name|PCIE_PORT_DEV_CTRL_STATUS_UNSUP_REQ_REPORT_EN
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** AER uncorretable errors get and clear */
end_comment

begin_function
name|unsigned
name|int
name|al_pcie_aer_uncorr_get_and_clear
parameter_list|(
name|struct
name|al_pcie_pf
modifier|*
name|pcie_pf
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_pf
operator|->
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|struct
name|al_pcie_core_aer_regs
modifier|*
name|aer_regs
init|=
name|regs
operator|->
name|core_space
index|[
name|pcie_pf
operator|->
name|pf_num
index|]
operator|.
name|aer
decl_stmt|;
name|uint32_t
name|reg_val
decl_stmt|;
name|reg_val
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|aer_regs
operator|->
name|uncorr_err_stat
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|aer_regs
operator|->
name|uncorr_err_stat
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
return|return
name|reg_val
return|;
block|}
end_function

begin_comment
comment|/** AER corretable errors get and clear */
end_comment

begin_function
name|unsigned
name|int
name|al_pcie_aer_corr_get_and_clear
parameter_list|(
name|struct
name|al_pcie_pf
modifier|*
name|pcie_pf
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_pf
operator|->
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|struct
name|al_pcie_core_aer_regs
modifier|*
name|aer_regs
init|=
name|regs
operator|->
name|core_space
index|[
name|pcie_pf
operator|->
name|pf_num
index|]
operator|.
name|aer
decl_stmt|;
name|uint32_t
name|reg_val
decl_stmt|;
name|reg_val
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|aer_regs
operator|->
name|corr_err_stat
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|aer_regs
operator|->
name|corr_err_stat
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
return|return
name|reg_val
return|;
block|}
end_function

begin_if
if|#
directive|if
operator|(
name|AL_PCIE_AER_ERR_TLP_HDR_NUM_DWORDS
operator|!=
literal|4
operator|)
end_if

begin_error
error|#
directive|error
error|Wrong assumption!
end_error

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/** AER get the header for the TLP corresponding to a detected error */
end_comment

begin_function
name|void
name|al_pcie_aer_err_tlp_hdr_get
parameter_list|(
name|struct
name|al_pcie_pf
modifier|*
name|pcie_pf
parameter_list|,
name|uint32_t
name|hdr
index|[
name|AL_PCIE_AER_ERR_TLP_HDR_NUM_DWORDS
index|]
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_pf
operator|->
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|struct
name|al_pcie_core_aer_regs
modifier|*
name|aer_regs
init|=
name|regs
operator|->
name|core_space
index|[
name|pcie_pf
operator|->
name|pf_num
index|]
operator|.
name|aer
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|AL_PCIE_AER_ERR_TLP_HDR_NUM_DWORDS
condition|;
name|i
operator|++
control|)
name|hdr
index|[
name|i
index|]
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|aer_regs
operator|->
name|header_log
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/********************** Loopback mode (RC and Endpoint modes) ************/
end_comment

begin_comment
comment|/** enter local pipe loopback mode */
end_comment

begin_function
name|int
name|al_pcie_local_pipe_loopback_enter
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|al_dbg
argument_list|(
literal|"PCIe %d: Enter LOCAL PIPE Loopback mode"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|pipe_loopback_ctrl
argument_list|,
literal|1
operator|<<
name|PCIE_PORT_PIPE_LOOPBACK_CTRL_PIPE_LB_EN_SHIFT
argument_list|,
literal|1
operator|<<
name|PCIE_PORT_PIPE_LOOPBACK_CTRL_PIPE_LB_EN_SHIFT
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|port_link_ctrl
argument_list|,
literal|1
operator|<<
name|PCIE_PORT_LINK_CTRL_LB_EN_SHIFT
argument_list|,
literal|1
operator|<<
name|PCIE_PORT_LINK_CTRL_LB_EN_SHIFT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * @brief exit local pipe loopback mode  *  * @param pcie_port	pcie port handle  * @return		0 if no error found  */
end_comment

begin_function
name|int
name|al_pcie_local_pipe_loopback_exit
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|al_dbg
argument_list|(
literal|"PCIe %d: Exit LOCAL PIPE Loopback mode"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|pipe_loopback_ctrl
argument_list|,
literal|1
operator|<<
name|PCIE_PORT_PIPE_LOOPBACK_CTRL_PIPE_LB_EN_SHIFT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|port_link_ctrl
argument_list|,
literal|1
operator|<<
name|PCIE_PORT_LINK_CTRL_LB_EN_SHIFT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** enter remote loopback mode */
end_comment

begin_function
name|int
name|al_pcie_remote_loopback_enter
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|al_dbg
argument_list|(
literal|"PCIe %d: Enter REMOTE Loopback mode"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|port_link_ctrl
argument_list|,
literal|1
operator|<<
name|PCIE_PORT_PIPE_LOOPBACK_CTRL_PIPE_LB_EN_SHIFT
argument_list|,
literal|1
operator|<<
name|PCIE_PORT_PIPE_LOOPBACK_CTRL_PIPE_LB_EN_SHIFT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * @brief   exit remote loopback mode  *  * @param   pcie_port pcie port handle  * @return  0 if no error found  */
end_comment

begin_function
name|int
name|al_pcie_remote_loopback_exit
parameter_list|(
name|struct
name|al_pcie_port
modifier|*
name|pcie_port
parameter_list|)
block|{
name|struct
name|al_pcie_regs
modifier|*
name|regs
init|=
name|pcie_port
operator|->
name|regs
decl_stmt|;
name|al_dbg
argument_list|(
literal|"PCIe %d: Exit REMOTE Loopback mode"
argument_list|,
name|pcie_port
operator|->
name|port_id
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|&
name|regs
operator|->
name|port_regs
operator|->
name|port_link_ctrl
argument_list|,
literal|1
operator|<<
name|PCIE_PORT_LINK_CTRL_LB_EN_SHIFT
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


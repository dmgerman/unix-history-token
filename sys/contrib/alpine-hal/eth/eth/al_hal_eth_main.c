begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*- ******************************************************************************* Copyright (C) 2015 Annapurna Labs Ltd.  This file may be licensed under the terms of the Annapurna Labs Commercial License Agreement.  Alternatively, this file can be distributed under the terms of the GNU General Public License V2 as published by the Free Software Foundation and can be found at http://www.gnu.org/licenses/gpl-2.0.html  Alternatively, redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:      *     Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.      *     Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *******************************************************************************/
end_comment

begin_comment
comment|/**  *  @{  * @file   al_hal_eth_main.c  *  * @brief  XG Ethernet unit HAL driver for main functions (initialization, data path)  *  */
end_comment

begin_include
include|#
directive|include
file|"al_hal_eth.h"
end_include

begin_include
include|#
directive|include
file|"al_hal_udma_iofic.h"
end_include

begin_include
include|#
directive|include
file|"al_hal_udma_config.h"
end_include

begin_include
include|#
directive|include
file|"al_hal_eth_ec_regs.h"
end_include

begin_include
include|#
directive|include
file|"al_hal_eth_mac_regs.h"
end_include

begin_include
include|#
directive|include
file|"al_hal_unit_adapter_regs.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|AL_ETH_EX
end_ifdef

begin_include
include|#
directive|include
file|"al_hal_eth_ex_internal.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Number of xfi_txclk cycles that accumulate into 100ns */
end_comment

begin_define
define|#
directive|define
name|ETH_MAC_KR_10_PCS_CFG_EEE_TIMER_VAL
value|52
end_define

begin_define
define|#
directive|define
name|ETH_MAC_KR_25_PCS_CFG_EEE_TIMER_VAL
value|80
end_define

begin_define
define|#
directive|define
name|ETH_MAC_XLG_40_PCS_CFG_EEE_TIMER_VAL
value|63
end_define

begin_define
define|#
directive|define
name|ETH_MAC_XLG_50_PCS_CFG_EEE_TIMER_VAL
value|85
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_PKT_UDMA_FLAGS
value|(AL_ETH_TX_FLAGS_NO_SNOOP | \ 					 AL_ETH_TX_FLAGS_INT)
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_PKT_META_FLAGS
value|(AL_ETH_TX_FLAGS_IPV4_L3_CSUM | \ 					 AL_ETH_TX_FLAGS_L4_CSUM |	\ 					 AL_ETH_TX_FLAGS_L4_PARTIAL_CSUM |	\ 					 AL_ETH_TX_FLAGS_L2_MACSEC_PKT | \ 					 AL_ETH_TX_FLAGS_L2_DIS_FCS |\ 					 AL_ETH_TX_FLAGS_TSO |\ 					 AL_ETH_TX_FLAGS_TS)
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_SRC_VLAN_CNT_MASK
value|3
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_SRC_VLAN_CNT_SHIFT
value|5
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_L4_PROTO_IDX_MASK
value|0x1F
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_L4_PROTO_IDX_SHIFT
value|8
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_TUNNEL_MODE_SHIFT
value|18
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_OUTER_L3_PROTO_SHIFT
value|20
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_VLAN_MOD_ADD_SHIFT
value|22
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_VLAN_MOD_DEL_SHIFT
value|24
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_VLAN_MOD_E_SEL_SHIFT
value|26
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_VLAN_MOD_VID_SEL_SHIFT
value|28
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_VLAN_MOD_PBIT_SEL_SHIFT
value|30
end_define

begin_comment
comment|/* tx Meta Descriptor defines */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_TX_META_STORE
value|(1<< 21)
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_META_L3_LEN_MASK
value|0xff
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_META_L3_OFF_MASK
value|0xff
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_META_L3_OFF_SHIFT
value|8
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_META_MSS_LSB_VAL_SHIFT
value|22
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_META_MSS_MSB_TS_VAL_SHIFT
value|16
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_META_OUTER_L3_LEN_MASK
value|0x1f
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_META_OUTER_L3_LEN_SHIFT
value|24
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_META_OUTER_L3_OFF_HIGH_MASK
value|0x18
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_META_OUTER_L3_OFF_HIGH_SHIFT
value|10
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_META_OUTER_L3_OFF_LOW_MASK
value|0x07
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_META_OUTER_L3_OFF_LOW_SHIFT
value|29
end_define

begin_comment
comment|/* tx Meta Descriptor defines - MacSec */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_TX_MACSEC_SIGN_SHIFT
value|0
end_define

begin_comment
comment|/* Sign TX pkt */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_TX_MACSEC_ENCRYPT_SHIFT
value|1
end_define

begin_comment
comment|/* Encrypt TX pkt */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_TX_MACSEC_AN_LSB_SHIFT
value|2
end_define

begin_comment
comment|/* Association Number */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_TX_MACSEC_AN_MSB_SHIFT
value|3
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_MACSEC_SC_LSB_SHIFT
value|4
end_define

begin_comment
comment|/* Secured Channel */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_TX_MACSEC_SC_MSB_SHIFT
value|9
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_MACSEC_SECURED_PYLD_LEN_LSB_SHIFT
value|10
end_define

begin_comment
comment|/* Secure Payload Length (0x3FFF for non-SL packets) */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_TX_MACSEC_SECURED_PYLD_LEN_MSB_SHIFT
value|23
end_define

begin_comment
comment|/* Rx Descriptor defines */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_RX_L3_PROTO_IDX_MASK
value|0x1F
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_SRC_VLAN_CNT_MASK
value|3
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_SRC_VLAN_CNT_SHIFT
value|5
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_L4_PROTO_IDX_MASK
value|0x1F
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_L4_PROTO_IDX_SHIFT
value|8
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_L3_OFFSET_SHIFT
value|9
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_L3_OFFSET_MASK
value|(0x7f<< AL_ETH_RX_L3_OFFSET_SHIFT)
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_HASH_SHIFT
value|16
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_HASH_MASK
value|(0xffff<< AL_ETH_RX_HASH_SHIFT)
end_define

begin_define
define|#
directive|define
name|ETH_MAC_GEN_LED_CFG_BLINK_TIMER_VAL
value|5
end_define

begin_define
define|#
directive|define
name|ETH_MAC_GEN_LED_CFG_ACT_TIMER_VAL
value|7
end_define

begin_comment
comment|/* Tx VID Table*/
end_comment

begin_define
define|#
directive|define
name|AL_ETH_TX_VLAN_TABLE_UDMA_MASK
value|0xF
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_VLAN_TABLE_FWD_TO_MAC
value|(1<< 4)
end_define

begin_comment
comment|/* tx gpd defines */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_TX_GPD_L3_PROTO_MASK
value|0x1f
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GPD_L3_PROTO_SHIFT
value|0
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GPD_L4_PROTO_MASK
value|0x1f
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GPD_L4_PROTO_SHIFT
value|5
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GPD_TUNNEL_CTRL_MASK
value|0x7
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GPD_TUNNEL_CTRL_SHIFT
value|10
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GPD_SRC_VLAN_CNT_MASK
value|0x3
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GPD_SRC_VLAN_CNT_SHIFT
value|13
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GPD_CAM_DATA_2_SHIFT
value|32
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GPD_CAM_MASK_2_SHIFT
value|32
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GPD_CAM_CTRL_VALID_SHIFT
value|31
end_define

begin_comment
comment|/* tx gcp defines */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_POLY_SEL_MASK
value|0x1
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_POLY_SEL_SHIFT
value|0
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_CRC32_BIT_COMP_MASK
value|0x1
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_CRC32_BIT_COMP_SHIFT
value|1
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_CRC32_BIT_SWAP_MASK
value|0x1
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_CRC32_BIT_SWAP_SHIFT
value|2
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_CRC32_BYTE_SWAP_MASK
value|0x1
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_CRC32_BYTE_SWAP_SHIFT
value|3
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_DATA_BIT_SWAP_MASK
value|0x1
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_DATA_BIT_SWAP_SHIFT
value|4
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_DATA_BYTE_SWAP_MASK
value|0x1
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_DATA_BYTE_SWAP_SHIFT
value|5
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_TRAIL_SIZE_MASK
value|0xF
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_TRAIL_SIZE_SHIFT
value|6
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_HEAD_SIZE_MASK
value|0xFF
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_HEAD_SIZE_SHIFT
value|16
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_HEAD_CALC_MASK
value|0x1
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_HEAD_CALC_SHIFT
value|24
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_MASK_POLARITY_MASK
value|0x1
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_MASK_POLARITY_SHIFT
value|25
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_OPCODE_1_MASK
value|0x3F
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_OPCODE_1_SHIFT
value|0
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_OPCODE_2_MASK
value|0x3F
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_OPCODE_2_SHIFT
value|6
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_OPCODE_3_MASK
value|0x3F
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_OPCODE_3_SHIFT
value|12
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_OPSEL_1_MASK
value|0xF
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_OPSEL_1_SHIFT
value|0
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_OPSEL_2_MASK
value|0xF
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_OPSEL_2_SHIFT
value|4
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_OPSEL_3_MASK
value|0xF
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_OPSEL_3_SHIFT
value|8
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_OPSEL_4_MASK
value|0xF
end_define

begin_define
define|#
directive|define
name|AL_ETH_TX_GCP_OPSEL_4_SHIFT
value|12
end_define

begin_comment
comment|/*  Tx crc_chksum_replace defines */
end_comment

begin_define
define|#
directive|define
name|L4_CHECKSUM_DIS_AND_L3_CHECKSUM_DIS
value|0x00
end_define

begin_define
define|#
directive|define
name|L4_CHECKSUM_DIS_AND_L3_CHECKSUM_EN
value|0x20
end_define

begin_define
define|#
directive|define
name|L4_CHECKSUM_EN_AND_L3_CHECKSUM_DIS
value|0x40
end_define

begin_define
define|#
directive|define
name|L4_CHECKSUM_EN_AND_L3_CHECKSUM_EN
value|0x60
end_define

begin_comment
comment|/* rx gpd defines */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_OUTER_L3_PROTO_MASK
value|0x1f
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_OUTER_L3_PROTO_SHIFT
value|(3 + 0)
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_OUTER_L4_PROTO_MASK
value|0x1f
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_OUTER_L4_PROTO_SHIFT
value|(3 + 8)
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_INNER_L3_PROTO_MASK
value|0x1f
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_INNER_L3_PROTO_SHIFT
value|(3 + 16)
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_INNER_L4_PROTO_MASK
value|0x1f
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_INNER_L4_PROTO_SHIFT
value|(3 + 24)
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_OUTER_PARSE_CTRL_MASK
value|0xFF
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_OUTER_PARSE_CTRL_SHIFT
value|32
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_INNER_PARSE_CTRL_MASK
value|0xFF
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_INNER_PARSE_CTRL_SHIFT
value|40
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_L3_PRIORITY_MASK
value|0xFF
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_L3_PRIORITY_SHIFT
value|48
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_L4_DST_PORT_LSB_MASK
value|0xFF
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_L4_DST_PORT_LSB_SHIFT
value|56
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_CAM_DATA_2_SHIFT
value|32
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_CAM_MASK_2_SHIFT
value|32
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_CAM_CTRL_VALID_SHIFT
value|31
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_PARSE_RESULT_OUTER_L3_PROTO_IDX_OFFSET
value|(106 + 5)
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_PARSE_RESULT_OUTER_L4_PROTO_IDX_OFFSET
value|(106 + 10)
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_PARSE_RESULT_INNER_L3_PROTO_IDX_OFFSET
value|(0 + 5)
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_PARSE_RESULT_INNER_L4_PROTO_IDX_OFFSET
value|(0 + 10)
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_PARSE_RESULT_OUTER_PARSE_CTRL
value|(106 + 4)
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_PARSE_RESULT_INNER_PARSE_CTRL
value|4
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_PARSE_RESULT_L3_PRIORITY
value|(106 + 13)
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GPD_PARSE_RESULT_OUTER_L4_DST_PORT_LSB
value|(106 + 65)
end_define

begin_comment
comment|/* rx gcp defines */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_POLY_SEL_MASK
value|0x1
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_POLY_SEL_SHIFT
value|0
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_CRC32_BIT_COMP_MASK
value|0x1
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_CRC32_BIT_COMP_SHIFT
value|1
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_CRC32_BIT_SWAP_MASK
value|0x1
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_CRC32_BIT_SWAP_SHIFT
value|2
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_CRC32_BYTE_SWAP_MASK
value|0x1
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_CRC32_BYTE_SWAP_SHIFT
value|3
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_DATA_BIT_SWAP_MASK
value|0x1
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_DATA_BIT_SWAP_SHIFT
value|4
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_DATA_BYTE_SWAP_MASK
value|0x1
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_DATA_BYTE_SWAP_SHIFT
value|5
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_TRAIL_SIZE_MASK
value|0xF
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_TRAIL_SIZE_SHIFT
value|6
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_HEAD_SIZE_MASK
value|0xFF
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_HEAD_SIZE_SHIFT
value|16
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_HEAD_CALC_MASK
value|0x1
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_HEAD_CALC_SHIFT
value|24
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_MASK_POLARITY_MASK
value|0x1
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_MASK_POLARITY_SHIFT
value|25
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_OPCODE_1_MASK
value|0x3F
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_OPCODE_1_SHIFT
value|0
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_OPCODE_2_MASK
value|0x3F
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_OPCODE_2_SHIFT
value|6
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_OPCODE_3_MASK
value|0x3F
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_OPCODE_3_SHIFT
value|12
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_OPSEL_1_MASK
value|0xF
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_OPSEL_1_SHIFT
value|0
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_OPSEL_2_MASK
value|0xF
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_OPSEL_2_SHIFT
value|4
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_OPSEL_3_MASK
value|0xF
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_OPSEL_3_SHIFT
value|8
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_OPSEL_4_MASK
value|0xF
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_GCP_OPSEL_4_SHIFT
value|12
end_define

begin_define
define|#
directive|define
name|AL_ETH_MDIO_DELAY_PERIOD
value|1
end_define

begin_comment
comment|/* micro seconds to wait when polling mdio status */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_MDIO_DELAY_COUNT
value|150
end_define

begin_comment
comment|/* number of times to poll */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_S2M_UDMA_COMP_COAL_TIMEOUT
value|200
end_define

begin_comment
comment|/* Rx descriptors coalescing timeout in SB clocks */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_EPE_ENTRIES_NUM
value|26
end_define

begin_decl_stmt
specifier|static
name|struct
name|al_eth_epe_p_reg_entry
name|al_eth_epe_p_regs
index|[
name|AL_ETH_EPE_ENTRIES_NUM
index|]
init|=
block|{
block|{
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
block|{
literal|0x0
block|,
literal|0x0
block|,
literal|0x1
block|}
block|,
block|{
literal|0x0
block|,
literal|0x0
block|,
literal|0x2
block|}
block|,
block|{
literal|0x0
block|,
literal|0x0
block|,
literal|0x3
block|}
block|,
block|{
literal|0x18100
block|,
literal|0xFFFFF
block|,
literal|0x80000004
block|}
block|,
block|{
literal|0x188A8
block|,
literal|0xFFFFF
block|,
literal|0x80000005
block|}
block|,
block|{
literal|0x99100
block|,
literal|0xFFFFF
block|,
literal|0x80000006
block|}
block|,
block|{
literal|0x98100
block|,
literal|0xFFFFF
block|,
literal|0x80000007
block|}
block|,
block|{
literal|0x10800
block|,
literal|0x7FFFF
block|,
literal|0x80000008
block|}
block|,
block|{
literal|0x20000
block|,
literal|0x73FFF
block|,
literal|0x80000009
block|}
block|,
block|{
literal|0x20000
block|,
literal|0x70000
block|,
literal|0x8000000A
block|}
block|,
block|{
literal|0x186DD
block|,
literal|0x7FFFF
block|,
literal|0x8000000B
block|}
block|,
block|{
literal|0x30600
block|,
literal|0x7FF00
block|,
literal|0x8000000C
block|}
block|,
block|{
literal|0x31100
block|,
literal|0x7FF00
block|,
literal|0x8000000D
block|}
block|,
block|{
literal|0x32F00
block|,
literal|0x7FF00
block|,
literal|0x8000000E
block|}
block|,
block|{
literal|0x32900
block|,
literal|0x7FF00
block|,
literal|0x8000000F
block|}
block|,
block|{
literal|0x105DC
block|,
literal|0x7FFFF
block|,
literal|0x80010010
block|}
block|,
block|{
literal|0x188E5
block|,
literal|0x7FFFF
block|,
literal|0x80000011
block|}
block|,
block|{
literal|0x72000
block|,
literal|0x72000
block|,
literal|0x80000012
block|}
block|,
block|{
literal|0x70000
block|,
literal|0x72000
block|,
literal|0x80000013
block|}
block|,
block|{
literal|0x46558
block|,
literal|0x7FFFF
block|,
literal|0x80000001
block|}
block|,
block|{
literal|0x18906
block|,
literal|0x7FFFF
block|,
literal|0x80000015
block|}
block|,
block|{
literal|0x18915
block|,
literal|0x7FFFF
block|,
literal|0x80000016
block|}
block|,
block|{
literal|0x31B00
block|,
literal|0x7FF00
block|,
literal|0x80000017
block|}
block|,
block|{
literal|0x30400
block|,
literal|0x7FF00
block|,
literal|0x80000018
block|}
block|,
block|{
literal|0x0
block|,
literal|0x0
block|,
literal|0x8000001F
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|al_eth_epe_control_entry
name|al_eth_epe_control_table
index|[
name|AL_ETH_EPE_ENTRIES_NUM
index|]
init|=
block|{
block|{
block|{
literal|0x2800000
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x1
block|,
literal|0x400000
block|}
block|}
block|,
block|{
block|{
literal|0x280004C
block|,
literal|0x746000
block|,
literal|0xA46030
block|,
literal|0xE00000
block|,
literal|0x2
block|,
literal|0x400000
block|}
block|}
block|,
block|{
block|{
literal|0x2800054
block|,
literal|0x746000
block|,
literal|0xA46030
block|,
literal|0x1600000
block|,
literal|0x2
block|,
literal|0x400000
block|}
block|}
block|,
block|{
block|{
literal|0x280005C
block|,
literal|0x746000
block|,
literal|0xA46030
block|,
literal|0x1E00000
block|,
literal|0x2
block|,
literal|0x400000
block|}
block|}
block|,
block|{
block|{
literal|0x2800042
block|,
literal|0xD42000
block|,
literal|0x0
block|,
literal|0x400000
block|,
literal|0x1010412
block|,
literal|0x400000
block|}
block|}
block|,
block|{
block|{
literal|0x2800042
block|,
literal|0xD42000
block|,
literal|0x0
block|,
literal|0x400000
block|,
literal|0x1010412
block|,
literal|0x400000
block|}
block|}
block|,
block|{
block|{
literal|0x2800042
block|,
literal|0xE42000
block|,
literal|0x0
block|,
literal|0x400000
block|,
literal|0x2020002
block|,
literal|0x400000
block|}
block|}
block|,
block|{
block|{
literal|0x2800042
block|,
literal|0xE42000
block|,
literal|0x0
block|,
literal|0x400000
block|,
literal|0x2020002
block|,
literal|0x400000
block|}
block|}
block|,
block|{
block|{
literal|0x280B046
block|,
literal|0x0
block|,
literal|0x6C1008
block|,
literal|0x0
block|,
literal|0x4
block|,
literal|0x406800
block|}
block|}
block|,
block|{
block|{
literal|0x2800049
block|,
literal|0xF44060
block|,
literal|0x1744080
block|,
literal|0x14404
block|,
literal|0x6
block|,
literal|0x400011
block|}
block|}
block|,
block|{
block|{
literal|0x2015049
block|,
literal|0xF44060
block|,
literal|0x1744080
block|,
literal|0x14404
block|,
literal|0x8080007
block|,
literal|0x400011
block|}
block|}
block|,
block|{
block|{
literal|0x280B046
block|,
literal|0xF60040
block|,
literal|0x6C1004
block|,
literal|0x2800000
block|,
literal|0x6
block|,
literal|0x406811
block|}
block|}
block|,
block|{
block|{
literal|0x2815042
block|,
literal|0x1F42000
block|,
literal|0x2042010
block|,
literal|0x1414460
block|,
literal|0x10100009
block|,
literal|0x40B800
block|}
block|}
block|,
block|{
block|{
literal|0x2815042
block|,
literal|0x1F42000
block|,
literal|0x2042010
block|,
literal|0x800000
block|,
literal|0x10100009
block|,
literal|0x40B800
block|}
block|}
block|,
block|{
block|{
literal|0x280B042
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x430400
block|,
literal|0x4040009
block|,
literal|0x0
block|}
block|}
block|,
block|{
block|{
literal|0x2815580
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x4040005
block|,
literal|0x0
block|}
block|}
block|,
block|{
block|{
literal|0x280B000
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x1
block|,
literal|0x400000
block|}
block|}
block|,
block|{
block|{
literal|0x2800040
block|,
literal|0x174E000
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0xE
block|,
literal|0x406800
block|}
block|}
block|,
block|{
block|{
literal|0x280B000
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x600000
block|,
literal|0x1
block|,
literal|0x406800
block|}
block|}
block|,
block|{
block|{
literal|0x280B000
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0xE00000
block|,
literal|0x1
block|,
literal|0x406800
block|}
block|}
block|,
block|{
block|{
literal|0x2800000
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x1
block|,
literal|0x400000
block|}
block|}
block|,
block|{
block|{
literal|0x280B046
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x2800000
block|,
literal|0x7
block|,
literal|0x400000
block|}
block|}
block|,
block|{
block|{
literal|0x280B046
block|,
literal|0xF60040
block|,
literal|0x6C1004
block|,
literal|0x2800000
block|,
literal|0x6
block|,
literal|0x406811
block|}
block|}
block|,
block|{
block|{
literal|0x2815042
block|,
literal|0x1F43028
block|,
literal|0x2000000
block|,
literal|0xC00000
block|,
literal|0x10100009
block|,
literal|0x40B800
block|}
block|}
block|,
block|{
block|{
literal|0x2815400
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x4040005
block|,
literal|0x0
block|}
block|}
block|,
block|{
block|{
literal|0x2800000
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x1
block|,
literal|0x400000
block|}
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|AL_ETH_IS_1G_MAC
parameter_list|(
name|mac_mode
parameter_list|)
value|(((mac_mode) == AL_ETH_MAC_MODE_RGMII) || ((mac_mode) == AL_ETH_MAC_MODE_SGMII))
end_define

begin_define
define|#
directive|define
name|AL_ETH_IS_10G_MAC
parameter_list|(
name|mac_mode
parameter_list|)
value|(((mac_mode) == AL_ETH_MAC_MODE_10GbE_Serial) ||	\ 					((mac_mode) == AL_ETH_MAC_MODE_10G_SGMII) ||		\ 					((mac_mode) == AL_ETH_MAC_MODE_SGMII_2_5G))
end_define

begin_define
define|#
directive|define
name|AL_ETH_IS_25G_MAC
parameter_list|(
name|mac_mode
parameter_list|)
value|((mac_mode) == AL_ETH_MAC_MODE_KR_LL_25G)
end_define

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|al_eth_mac_mode_str
parameter_list|(
name|enum
name|al_eth_mac_mode
name|mode
parameter_list|)
block|{
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|AL_ETH_MAC_MODE_RGMII
case|:
return|return
literal|"RGMII"
return|;
case|case
name|AL_ETH_MAC_MODE_SGMII
case|:
return|return
literal|"SGMII"
return|;
case|case
name|AL_ETH_MAC_MODE_SGMII_2_5G
case|:
return|return
literal|"SGMII_2_5G"
return|;
case|case
name|AL_ETH_MAC_MODE_10GbE_Serial
case|:
return|return
literal|"KR"
return|;
case|case
name|AL_ETH_MAC_MODE_KR_LL_25G
case|:
return|return
literal|"KR_LL_25G"
return|;
case|case
name|AL_ETH_MAC_MODE_10G_SGMII
case|:
return|return
literal|"10G_SGMII"
return|;
case|case
name|AL_ETH_MAC_MODE_XLG_LL_40G
case|:
return|return
literal|"40G_LL"
return|;
case|case
name|AL_ETH_MAC_MODE_XLG_LL_50G
case|:
return|return
literal|"50G_LL"
return|;
case|case
name|AL_ETH_MAC_MODE_XLG_LL_25G
case|:
return|return
literal|"25G_LL"
return|;
default|default:
return|return
literal|"N/A"
return|;
block|}
block|}
end_function

begin_comment
comment|/**  * change and wait udma state  *  * @param dma the udma to change its state  * @param new_state  *  * @return 0 on success. otherwise on failure.  */
end_comment

begin_function
specifier|static
name|int
name|al_udma_state_set_wait
parameter_list|(
name|struct
name|al_udma
modifier|*
name|dma
parameter_list|,
name|enum
name|al_udma_state
name|new_state
parameter_list|)
block|{
name|enum
name|al_udma_state
name|state
decl_stmt|;
name|enum
name|al_udma_state
name|expected_state
init|=
name|new_state
decl_stmt|;
name|int
name|count
init|=
literal|1000
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|rc
operator|=
name|al_udma_state_set
argument_list|(
name|dma
argument_list|,
name|new_state
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
name|al_warn
argument_list|(
literal|"[%s] warn: failed to change state, error %d\n"
argument_list|,
name|dma
operator|->
name|name
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
if|if
condition|(
operator|(
name|new_state
operator|==
name|UDMA_NORMAL
operator|)
operator|||
operator|(
name|new_state
operator|==
name|UDMA_DISABLE
operator|)
condition|)
name|expected_state
operator|=
name|UDMA_IDLE
expr_stmt|;
do|do
block|{
name|state
operator|=
name|al_udma_state_get
argument_list|(
name|dma
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|expected_state
condition|)
break|break;
name|al_udelay
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|--
operator|==
literal|0
condition|)
block|{
name|al_warn
argument_list|(
literal|"[%s] warn: dma state didn't change to %s\n"
argument_list|,
name|dma
operator|->
name|name
argument_list|,
name|al_udma_states_name
index|[
name|new_state
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
name|ETIMEDOUT
return|;
block|}
block|}
do|while
condition|(
literal|1
condition|)
do|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|al_eth_epe_entry_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|idx
parameter_list|,
name|struct
name|al_eth_epe_p_reg_entry
modifier|*
name|reg_entry
parameter_list|,
name|struct
name|al_eth_epe_control_entry
modifier|*
name|control_entry
parameter_list|)
block|{
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe_p
index|[
name|idx
index|]
operator|.
name|comp_data
argument_list|,
name|reg_entry
operator|->
name|data
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe_p
index|[
name|idx
index|]
operator|.
name|comp_mask
argument_list|,
name|reg_entry
operator|->
name|mask
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe_p
index|[
name|idx
index|]
operator|.
name|comp_ctrl
argument_list|,
name|reg_entry
operator|->
name|ctrl
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|msp_c
index|[
name|idx
index|]
operator|.
name|p_comp_data
argument_list|,
name|reg_entry
operator|->
name|data
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|msp_c
index|[
name|idx
index|]
operator|.
name|p_comp_mask
argument_list|,
name|reg_entry
operator|->
name|mask
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|msp_c
index|[
name|idx
index|]
operator|.
name|p_comp_ctrl
argument_list|,
name|reg_entry
operator|->
name|ctrl
argument_list|)
expr_stmt|;
comment|/*control table  0*/
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe
index|[
literal|0
index|]
operator|.
name|act_table_addr
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe
index|[
literal|0
index|]
operator|.
name|act_table_data_6
argument_list|,
name|control_entry
operator|->
name|data
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe
index|[
literal|0
index|]
operator|.
name|act_table_data_2
argument_list|,
name|control_entry
operator|->
name|data
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe
index|[
literal|0
index|]
operator|.
name|act_table_data_3
argument_list|,
name|control_entry
operator|->
name|data
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe
index|[
literal|0
index|]
operator|.
name|act_table_data_4
argument_list|,
name|control_entry
operator|->
name|data
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe
index|[
literal|0
index|]
operator|.
name|act_table_data_5
argument_list|,
name|control_entry
operator|->
name|data
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe
index|[
literal|0
index|]
operator|.
name|act_table_data_1
argument_list|,
name|control_entry
operator|->
name|data
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
comment|/*control table 1*/
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe
index|[
literal|1
index|]
operator|.
name|act_table_addr
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe
index|[
literal|1
index|]
operator|.
name|act_table_data_6
argument_list|,
name|control_entry
operator|->
name|data
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe
index|[
literal|1
index|]
operator|.
name|act_table_data_2
argument_list|,
name|control_entry
operator|->
name|data
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe
index|[
literal|1
index|]
operator|.
name|act_table_data_3
argument_list|,
name|control_entry
operator|->
name|data
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe
index|[
literal|1
index|]
operator|.
name|act_table_data_4
argument_list|,
name|control_entry
operator|->
name|data
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe
index|[
literal|1
index|]
operator|.
name|act_table_data_5
argument_list|,
name|control_entry
operator|->
name|data
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe
index|[
literal|1
index|]
operator|.
name|act_table_data_1
argument_list|,
name|control_entry
operator|->
name|data
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|al_eth_epe_init
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|)
block|{
name|int
name|idx
decl_stmt|;
if|if
condition|(
name|adapter
operator|->
name|enable_rx_parser
operator|==
literal|0
condition|)
block|{
name|al_dbg
argument_list|(
literal|"eth [%s]: disable rx parser\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe
index|[
literal|0
index|]
operator|.
name|res_def
argument_list|,
literal|0x08000000
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe
index|[
literal|0
index|]
operator|.
name|res_in
argument_list|,
literal|0x7
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe
index|[
literal|1
index|]
operator|.
name|res_def
argument_list|,
literal|0x08000000
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe
index|[
literal|1
index|]
operator|.
name|res_in
argument_list|,
literal|0x7
argument_list|)
expr_stmt|;
return|return;
block|}
name|al_dbg
argument_list|(
literal|"eth [%s]: enable rx parser\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|AL_ETH_EPE_ENTRIES_NUM
condition|;
name|idx
operator|++
control|)
name|al_eth_epe_entry_set
argument_list|(
name|adapter
argument_list|,
name|idx
argument_list|,
operator|&
name|al_eth_epe_p_regs
index|[
name|idx
index|]
argument_list|,
operator|&
name|al_eth_epe_control_table
index|[
name|idx
index|]
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe
index|[
literal|0
index|]
operator|.
name|res_def
argument_list|,
literal|0x08000080
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe
index|[
literal|0
index|]
operator|.
name|res_in
argument_list|,
literal|0x7
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe
index|[
literal|1
index|]
operator|.
name|res_def
argument_list|,
literal|0x08000080
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe
index|[
literal|1
index|]
operator|.
name|res_in
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* header length as function of 4 bits value, for GRE, when C bit is set, the header len should be increase by 4*/
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe_h
index|[
literal|8
index|]
operator|.
name|hdr_len
argument_list|,
operator|(
literal|4
operator|<<
literal|16
operator|)
operator||
literal|4
argument_list|)
expr_stmt|;
comment|/* select the outer information when writing the rx descriptor (l3 protocol index etc) */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|meta
argument_list|,
name|EC_RFW_META_L3_LEN_CALC
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|checksum
argument_list|,
name|EC_RFW_CHECKSUM_HDR_SEL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * read 40G MAC registers (indirect access)  *  * @param adapter pointer to the private structure  * @param reg_addr address in the an registers  *  * @return the register value  */
end_comment

begin_function
specifier|static
name|uint32_t
name|al_eth_40g_mac_reg_read
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|reg_addr
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
comment|/* indirect access */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_40g_ll_addr
argument_list|,
name|reg_addr
argument_list|)
expr_stmt|;
name|val
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_40g_ll_data
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"[%s]: %s - reg %d. val 0x%x"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|__func__
argument_list|,
name|reg_addr
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
name|val
return|;
block|}
end_function

begin_comment
comment|/**  * write 40G MAC registers (indirect access)  *  * @param adapter pointer to the private structure  * @param reg_addr address in the an registers  * @param reg_data value to write to the register  *  */
end_comment

begin_function
specifier|static
name|void
name|al_eth_40g_mac_reg_write
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|reg_addr
parameter_list|,
name|uint32_t
name|reg_data
parameter_list|)
block|{
comment|/* indirect access */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_40g_ll_addr
argument_list|,
name|reg_addr
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_40g_ll_data
argument_list|,
name|reg_data
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"[%s]: %s - reg %d. val 0x%x"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|__func__
argument_list|,
name|reg_addr
argument_list|,
name|reg_data
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * read 40G PCS registers (indirect access)  *  * @param adapter pointer to the private structure  * @param reg_addr address in the an registers  *  * @return the register value  */
end_comment

begin_function
specifier|static
name|uint32_t
name|al_eth_40g_pcs_reg_read
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|reg_addr
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
comment|/* indirect access */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|pcs_40g_ll_addr
argument_list|,
name|reg_addr
argument_list|)
expr_stmt|;
name|val
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|pcs_40g_ll_data
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"[%s]: %s - reg %d. val 0x%x"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|__func__
argument_list|,
name|reg_addr
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
name|val
return|;
block|}
end_function

begin_comment
comment|/**  * write 40G PCS registers (indirect access)  *  * @param adapter pointer to the private structure  * @param reg_addr address in the an registers  * @param reg_data value to write to the register  *  */
end_comment

begin_function
specifier|static
name|void
name|al_eth_40g_pcs_reg_write
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|reg_addr
parameter_list|,
name|uint32_t
name|reg_data
parameter_list|)
block|{
comment|/* indirect access */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|pcs_40g_ll_addr
argument_list|,
name|reg_addr
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|pcs_40g_ll_data
argument_list|,
name|reg_data
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"[%s]: %s - reg %d. val 0x%x"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|__func__
argument_list|,
name|reg_addr
argument_list|,
name|reg_data
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*****************************API Functions  **********************************/
end_comment

begin_comment
comment|/*adapter management */
end_comment

begin_comment
comment|/**  * initialize the ethernet adapter's DMA  */
end_comment

begin_function
name|int
name|al_eth_adapter_init
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|al_eth_adapter_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|al_udma_params
name|udma_params
decl_stmt|;
name|struct
name|al_udma_m2s_pkt_len_conf
name|conf
decl_stmt|;
name|int
name|i
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|al_dbg
argument_list|(
literal|"eth [%s]: initialize controller's UDMA. id = %d\n"
argument_list|,
name|params
operator|->
name|name
argument_list|,
name|params
operator|->
name|udma_id
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"eth [%s]: UDMA base regs: %p\n"
argument_list|,
name|params
operator|->
name|name
argument_list|,
name|params
operator|->
name|udma_regs_base
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"eth [%s]: EC base regs: %p\n"
argument_list|,
name|params
operator|->
name|name
argument_list|,
name|params
operator|->
name|ec_regs_base
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"eth [%s]: MAC base regs: %p\n"
argument_list|,
name|params
operator|->
name|name
argument_list|,
name|params
operator|->
name|mac_regs_base
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"eth [%s]: enable_rx_parser: %x\n"
argument_list|,
name|params
operator|->
name|name
argument_list|,
name|params
operator|->
name|enable_rx_parser
argument_list|)
expr_stmt|;
name|adapter
operator|->
name|name
operator|=
name|params
operator|->
name|name
expr_stmt|;
name|adapter
operator|->
name|rev_id
operator|=
name|params
operator|->
name|rev_id
expr_stmt|;
name|adapter
operator|->
name|udma_id
operator|=
name|params
operator|->
name|udma_id
expr_stmt|;
name|adapter
operator|->
name|udma_regs_base
operator|=
name|params
operator|->
name|udma_regs_base
expr_stmt|;
name|adapter
operator|->
name|ec_regs_base
operator|=
operator|(
expr|struct
name|al_ec_regs
name|__iomem
operator|*
operator|)
name|params
operator|->
name|ec_regs_base
expr_stmt|;
name|adapter
operator|->
name|mac_regs_base
operator|=
operator|(
expr|struct
name|al_eth_mac_regs
name|__iomem
operator|*
operator|)
name|params
operator|->
name|mac_regs_base
expr_stmt|;
name|adapter
operator|->
name|unit_regs
operator|=
operator|(
expr|struct
name|unit_regs
name|__iomem
operator|*
operator|)
name|params
operator|->
name|udma_regs_base
expr_stmt|;
name|adapter
operator|->
name|enable_rx_parser
operator|=
name|params
operator|->
name|enable_rx_parser
expr_stmt|;
name|adapter
operator|->
name|serdes_lane
operator|=
name|params
operator|->
name|serdes_lane
expr_stmt|;
name|adapter
operator|->
name|ec_ints_base
operator|=
operator|(
name|uint8_t
name|__iomem
operator|*
operator|)
name|adapter
operator|->
name|ec_regs_base
operator|+
literal|0x1c00
expr_stmt|;
name|adapter
operator|->
name|mac_ints_base
operator|=
operator|(
expr|struct
name|interrupt_controller_ctrl
name|__iomem
operator|*
operator|)
operator|(
operator|(
name|uint8_t
name|__iomem
operator|*
operator|)
name|adapter
operator|->
name|mac_regs_base
operator|+
literal|0x800
operator|)
expr_stmt|;
comment|/* initialize Tx udma */
name|udma_params
operator|.
name|udma_regs_base
operator|=
name|adapter
operator|->
name|unit_regs
expr_stmt|;
name|udma_params
operator|.
name|type
operator|=
name|UDMA_TX
expr_stmt|;
name|udma_params
operator|.
name|num_of_queues
operator|=
name|AL_ETH_UDMA_TX_QUEUES
expr_stmt|;
name|udma_params
operator|.
name|name
operator|=
literal|"eth tx"
expr_stmt|;
name|rc
operator|=
name|al_udma_init
argument_list|(
operator|&
name|adapter
operator|->
name|tx_udma
argument_list|,
operator|&
name|udma_params
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
name|al_err
argument_list|(
literal|"failed to initialize %s, error %d\n"
argument_list|,
name|udma_params
operator|.
name|name
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
name|rc
operator|=
name|al_udma_state_set_wait
argument_list|(
operator|&
name|adapter
operator|->
name|tx_udma
argument_list|,
name|UDMA_NORMAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
name|al_err
argument_list|(
literal|"[%s]: failed to change state, error %d\n"
argument_list|,
name|udma_params
operator|.
name|name
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
comment|/* initialize Rx udma */
name|udma_params
operator|.
name|udma_regs_base
operator|=
name|adapter
operator|->
name|unit_regs
expr_stmt|;
name|udma_params
operator|.
name|type
operator|=
name|UDMA_RX
expr_stmt|;
name|udma_params
operator|.
name|num_of_queues
operator|=
name|AL_ETH_UDMA_RX_QUEUES
expr_stmt|;
name|udma_params
operator|.
name|name
operator|=
literal|"eth rx"
expr_stmt|;
name|rc
operator|=
name|al_udma_init
argument_list|(
operator|&
name|adapter
operator|->
name|rx_udma
argument_list|,
operator|&
name|udma_params
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
name|al_err
argument_list|(
literal|"failed to initialize %s, error %d\n"
argument_list|,
name|udma_params
operator|.
name|name
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
name|rc
operator|=
name|al_udma_state_set_wait
argument_list|(
operator|&
name|adapter
operator|->
name|rx_udma
argument_list|,
name|UDMA_NORMAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
name|al_err
argument_list|(
literal|"[%s]: failed to change state, error %d\n"
argument_list|,
name|udma_params
operator|.
name|name
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
name|al_dbg
argument_list|(
literal|"eth [%s]: controller's UDMA successfully initialized\n"
argument_list|,
name|params
operator|->
name|name
argument_list|)
expr_stmt|;
comment|/* set max packet size to 1M (for TSO) */
name|conf
operator|.
name|encode_64k_as_zero
operator|=
name|AL_TRUE
expr_stmt|;
name|conf
operator|.
name|max_pkt_size
operator|=
literal|0xfffff
expr_stmt|;
name|al_udma_m2s_packet_size_cfg_set
argument_list|(
operator|&
name|adapter
operator|->
name|tx_udma
argument_list|,
operator|&
name|conf
argument_list|)
expr_stmt|;
comment|/* set m2s (tx) max descriptors to max data buffers number and one for 	 * meta descriptor 	 */
name|al_udma_m2s_max_descs_set
argument_list|(
operator|&
name|adapter
operator|->
name|tx_udma
argument_list|,
name|AL_ETH_PKT_MAX_BUFS
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* set s2m (rx) max descriptors to max data buffers */
name|al_udma_s2m_max_descs_set
argument_list|(
operator|&
name|adapter
operator|->
name|rx_udma
argument_list|,
name|AL_ETH_PKT_MAX_BUFS
argument_list|)
expr_stmt|;
comment|/* set s2m burst lenght when writing completion descriptors to 64 bytes 	 */
name|al_udma_s2m_compl_desc_burst_config
argument_list|(
operator|&
name|adapter
operator|->
name|rx_udma
argument_list|,
literal|64
argument_list|)
expr_stmt|;
comment|/* if pointer to ec regs provided, then init the tx meta cache of this udma*/
if|if
condition|(
name|adapter
operator|->
name|ec_regs_base
operator|!=
name|NULL
condition|)
block|{
comment|// INIT TX CACHE TABLE:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tso
operator|.
name|cache_table_addr
argument_list|,
name|i
operator|+
operator|(
name|adapter
operator|->
name|udma_id
operator|*
literal|4
operator|)
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tso
operator|.
name|cache_table_data_1
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tso
operator|.
name|cache_table_data_2
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tso
operator|.
name|cache_table_data_3
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tso
operator|.
name|cache_table_data_4
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
block|}
block|}
comment|// only udma 0 allowed to init ec
if|if
condition|(
name|adapter
operator|->
name|udma_id
operator|!=
literal|0
condition|)
block|{
return|return
literal|0
return|;
block|}
comment|/* enable Ethernet controller: */
comment|/* enable internal machines*/
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|gen
operator|.
name|en
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|gen
operator|.
name|fifo_en
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
if|if
condition|(
name|adapter
operator|->
name|rev_id
operator|>
name|AL_ETH_REV_ID_0
condition|)
block|{
comment|/* enable A0 descriptor structure */
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|gen
operator|.
name|en_ext
argument_list|,
name|EC_GEN_EN_EXT_CACHE_WORD_SPLIT
argument_list|,
name|EC_GEN_EN_EXT_CACHE_WORD_SPLIT
argument_list|)
expr_stmt|;
comment|/* use mss value in the descriptor */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tso
operator|.
name|cfg_add_0
argument_list|,
name|EC_TSO_CFG_ADD_0_MSS_SEL
argument_list|)
expr_stmt|;
comment|/* enable tunnel TSO */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tso
operator|.
name|cfg_tunnel
argument_list|,
operator|(
name|EC_TSO_CFG_TUNNEL_EN_TUNNEL_TSO
operator||
name|EC_TSO_CFG_TUNNEL_EN_UDP_CHKSUM
operator||
name|EC_TSO_CFG_TUNNEL_EN_UDP_LEN
operator||
name|EC_TSO_CFG_TUNNEL_EN_IPV6_PLEN
operator||
name|EC_TSO_CFG_TUNNEL_EN_IPV4_CHKSUM
operator||
name|EC_TSO_CFG_TUNNEL_EN_IPV4_IDEN
operator||
name|EC_TSO_CFG_TUNNEL_EN_IPV4_TLEN
operator|)
argument_list|)
expr_stmt|;
block|}
comment|/* swap input byts from MAC RX */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|mac
operator|.
name|gen
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
comment|/* swap output bytes to MAC TX*/
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tmi
operator|.
name|tx_cfg
argument_list|,
name|EC_TMI_TX_CFG_EN_FWD_TO_RX
operator||
name|EC_TMI_TX_CFG_SWAP_BYTES
argument_list|)
expr_stmt|;
comment|/* TODO: check if we need this line*/
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_udma
index|[
literal|0
index|]
operator|.
name|fwd_dec
argument_list|,
literal|0x000003fb
argument_list|)
expr_stmt|;
comment|/* RFW configuration: default 0 */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_default
index|[
literal|0
index|]
operator|.
name|opt_1
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
comment|/* VLAN table address*/
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|vid_table_addr
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
comment|/* VLAN table data*/
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|vid_table_data
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
comment|/* HASH config (select toeplitz and bits 7:0 of the thash result, enable 	 * symmetric hash) */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|thash_cfg_1
argument_list|,
name|EC_RFW_THASH_CFG_1_ENABLE_IP_SWAP
operator||
name|EC_RFW_THASH_CFG_1_ENABLE_PORT_SWAP
argument_list|)
expr_stmt|;
name|al_eth_epe_init
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
comment|/* disable TSO padding and use mac padding instead */
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tso
operator|.
name|in_cfg
argument_list|)
expr_stmt|;
name|reg
operator|&=
operator|~
literal|0x7F00
expr_stmt|;
comment|/*clear bits 14:8 */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tso
operator|.
name|in_cfg
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*****************************API Functions  **********************************/
end_comment

begin_comment
comment|/*adapter management */
end_comment

begin_comment
comment|/**  * enable the ec and mac interrupts  */
end_comment

begin_function
name|int
name|al_eth_ec_mac_ints_config
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|)
block|{
name|al_dbg
argument_list|(
literal|"eth [%s]: enable ethernet and mac interrupts\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
comment|// only udma 0 allowed to init ec
if|if
condition|(
name|adapter
operator|->
name|udma_id
operator|!=
literal|0
condition|)
return|return
operator|-
name|EPERM
return|;
comment|/* enable mac ints */
name|al_iofic_config
argument_list|(
name|adapter
operator|->
name|ec_ints_base
argument_list|,
name|AL_INT_GROUP_A
argument_list|,
name|INT_CONTROL_GRP_SET_ON_POSEDGE
operator||
name|INT_CONTROL_GRP_CLEAR_ON_READ
argument_list|)
expr_stmt|;
name|al_iofic_config
argument_list|(
name|adapter
operator|->
name|ec_ints_base
argument_list|,
name|AL_INT_GROUP_B
argument_list|,
name|INT_CONTROL_GRP_SET_ON_POSEDGE
operator||
name|INT_CONTROL_GRP_CLEAR_ON_READ
argument_list|)
expr_stmt|;
name|al_iofic_config
argument_list|(
name|adapter
operator|->
name|ec_ints_base
argument_list|,
name|AL_INT_GROUP_C
argument_list|,
name|INT_CONTROL_GRP_SET_ON_POSEDGE
operator||
name|INT_CONTROL_GRP_CLEAR_ON_READ
argument_list|)
expr_stmt|;
name|al_iofic_config
argument_list|(
name|adapter
operator|->
name|ec_ints_base
argument_list|,
name|AL_INT_GROUP_D
argument_list|,
name|INT_CONTROL_GRP_SET_ON_POSEDGE
operator||
name|INT_CONTROL_GRP_CLEAR_ON_READ
argument_list|)
expr_stmt|;
comment|/* unmask MAC int */
name|al_iofic_unmask
argument_list|(
name|adapter
operator|->
name|ec_ints_base
argument_list|,
name|AL_INT_GROUP_A
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/* enable ec interrupts */
name|al_iofic_config
argument_list|(
name|adapter
operator|->
name|mac_ints_base
argument_list|,
name|AL_INT_GROUP_A
argument_list|,
name|INT_CONTROL_GRP_SET_ON_POSEDGE
operator||
name|INT_CONTROL_GRP_CLEAR_ON_READ
argument_list|)
expr_stmt|;
name|al_iofic_config
argument_list|(
name|adapter
operator|->
name|mac_ints_base
argument_list|,
name|AL_INT_GROUP_B
argument_list|,
name|INT_CONTROL_GRP_SET_ON_POSEDGE
operator||
name|INT_CONTROL_GRP_CLEAR_ON_READ
argument_list|)
expr_stmt|;
name|al_iofic_config
argument_list|(
name|adapter
operator|->
name|mac_ints_base
argument_list|,
name|AL_INT_GROUP_C
argument_list|,
name|INT_CONTROL_GRP_SET_ON_POSEDGE
operator||
name|INT_CONTROL_GRP_CLEAR_ON_READ
argument_list|)
expr_stmt|;
name|al_iofic_config
argument_list|(
name|adapter
operator|->
name|mac_ints_base
argument_list|,
name|AL_INT_GROUP_D
argument_list|,
name|INT_CONTROL_GRP_SET_ON_POSEDGE
operator||
name|INT_CONTROL_GRP_CLEAR_ON_READ
argument_list|)
expr_stmt|;
comment|/* eee active */
name|al_iofic_unmask
argument_list|(
name|adapter
operator|->
name|mac_ints_base
argument_list|,
name|AL_INT_GROUP_B
argument_list|,
name|AL_BIT
argument_list|(
literal|14
argument_list|)
argument_list|)
expr_stmt|;
name|al_iofic_unmask
argument_list|(
name|adapter
operator|->
name|unit_regs
argument_list|,
name|AL_INT_GROUP_D
argument_list|,
name|AL_BIT
argument_list|(
literal|11
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ec and mac interrupt service routine  * read and print asserted interrupts  *  * @param adapter pointer to the private structure  *  * @return 0 on success. otherwise on failure.  */
end_comment

begin_function
name|int
name|al_eth_ec_mac_isr
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|)
block|{
name|uint32_t
name|cause
decl_stmt|;
name|al_dbg
argument_list|(
literal|"[%s]: ethernet interrupts handler\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
comment|// only udma 0 allowed to init ec
if|if
condition|(
name|adapter
operator|->
name|udma_id
operator|!=
literal|0
condition|)
return|return
operator|-
name|EPERM
return|;
comment|/* read ec cause */
name|cause
operator|=
name|al_iofic_read_cause
argument_list|(
name|adapter
operator|->
name|ec_ints_base
argument_list|,
name|AL_INT_GROUP_A
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"[%s]: ethernet group A cause 0x%08x\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|cause
argument_list|)
expr_stmt|;
if|if
condition|(
name|cause
operator|&
literal|1
condition|)
block|{
name|cause
operator|=
name|al_iofic_read_cause
argument_list|(
name|adapter
operator|->
name|mac_ints_base
argument_list|,
name|AL_INT_GROUP_A
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"[%s]: mac group A cause 0x%08x\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|cause
argument_list|)
expr_stmt|;
name|cause
operator|=
name|al_iofic_read_cause
argument_list|(
name|adapter
operator|->
name|mac_ints_base
argument_list|,
name|AL_INT_GROUP_B
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"[%s]: mac group B cause 0x%08x\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|cause
argument_list|)
expr_stmt|;
name|cause
operator|=
name|al_iofic_read_cause
argument_list|(
name|adapter
operator|->
name|mac_ints_base
argument_list|,
name|AL_INT_GROUP_C
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"[%s]: mac group C cause 0x%08x\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|cause
argument_list|)
expr_stmt|;
name|cause
operator|=
name|al_iofic_read_cause
argument_list|(
name|adapter
operator|->
name|mac_ints_base
argument_list|,
name|AL_INT_GROUP_D
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"[%s]: mac group D cause 0x%08x\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|cause
argument_list|)
expr_stmt|;
block|}
name|cause
operator|=
name|al_iofic_read_cause
argument_list|(
name|adapter
operator|->
name|ec_ints_base
argument_list|,
name|AL_INT_GROUP_B
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"[%s]: ethernet group B cause 0x%08x\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|cause
argument_list|)
expr_stmt|;
name|cause
operator|=
name|al_iofic_read_cause
argument_list|(
name|adapter
operator|->
name|ec_ints_base
argument_list|,
name|AL_INT_GROUP_C
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"[%s]: ethernet group C cause 0x%08x\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|cause
argument_list|)
expr_stmt|;
name|cause
operator|=
name|al_iofic_read_cause
argument_list|(
name|adapter
operator|->
name|ec_ints_base
argument_list|,
name|AL_INT_GROUP_D
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"[%s]: ethernet group D cause 0x%08x\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|cause
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * stop the DMA of the ethernet adapter  */
end_comment

begin_function
name|int
name|al_eth_adapter_stop
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|al_dbg
argument_list|(
literal|"eth [%s]: stop controller's UDMA\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
comment|/* disable Tx dma*/
name|rc
operator|=
name|al_udma_state_set_wait
argument_list|(
operator|&
name|adapter
operator|->
name|tx_udma
argument_list|,
name|UDMA_DISABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
name|al_warn
argument_list|(
literal|"[%s] warn: failed to change state, error %d\n"
argument_list|,
name|adapter
operator|->
name|tx_udma
operator|.
name|name
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
name|al_dbg
argument_list|(
literal|"eth [%s]: controller's TX UDMA stopped\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
comment|/* disable Rx dma*/
name|rc
operator|=
name|al_udma_state_set_wait
argument_list|(
operator|&
name|adapter
operator|->
name|rx_udma
argument_list|,
name|UDMA_DISABLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
name|al_warn
argument_list|(
literal|"[%s] warn: failed to change state, error %d\n"
argument_list|,
name|adapter
operator|->
name|rx_udma
operator|.
name|name
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
name|al_dbg
argument_list|(
literal|"eth [%s]: controller's RX UDMA stopped\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_adapter_reset
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|)
block|{
name|al_dbg
argument_list|(
literal|"eth [%s]: reset controller's UDMA\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
operator|-
name|EPERM
return|;
block|}
end_function

begin_comment
comment|/* Q management */
end_comment

begin_comment
comment|/**  * Configure and enable a queue ring  */
end_comment

begin_function
name|int
name|al_eth_queue_config
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|enum
name|al_udma_type
name|type
parameter_list|,
name|uint32_t
name|qid
parameter_list|,
name|struct
name|al_udma_q_params
modifier|*
name|q_params
parameter_list|)
block|{
name|struct
name|al_udma
modifier|*
name|udma
decl_stmt|;
name|int
name|rc
decl_stmt|;
name|al_dbg
argument_list|(
literal|"eth [%s]: config UDMA %s queue %d\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|type
operator|==
name|UDMA_TX
condition|?
literal|"Tx"
else|:
literal|"Rx"
argument_list|,
name|qid
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|UDMA_TX
condition|)
block|{
name|udma
operator|=
operator|&
name|adapter
operator|->
name|tx_udma
expr_stmt|;
block|}
else|else
block|{
name|udma
operator|=
operator|&
name|adapter
operator|->
name|rx_udma
expr_stmt|;
block|}
name|q_params
operator|->
name|adapter_rev_id
operator|=
name|adapter
operator|->
name|rev_id
expr_stmt|;
name|rc
operator|=
name|al_udma_q_init
argument_list|(
name|udma
argument_list|,
name|qid
argument_list|,
name|q_params
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return
name|rc
return|;
if|if
condition|(
name|type
operator|==
name|UDMA_RX
condition|)
block|{
name|rc
operator|=
name|al_udma_s2m_q_compl_coal_config
argument_list|(
operator|&
name|udma
operator|->
name|udma_q
index|[
name|qid
index|]
argument_list|,
name|AL_TRUE
argument_list|,
name|AL_ETH_S2M_UDMA_COMP_COAL_TIMEOUT
argument_list|)
expr_stmt|;
name|al_assert
argument_list|(
name|q_params
operator|->
name|cdesc_size
operator|<=
literal|32
argument_list|)
expr_stmt|;
if|if
condition|(
name|q_params
operator|->
name|cdesc_size
operator|>
literal|16
condition|)
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|out_cfg
argument_list|,
name|EC_RFW_OUT_CFG_META_CNT_MASK
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_decl_stmt
name|int
name|al_eth_queue_enable
argument_list|(
expr|struct
name|al_hal_eth_adapter
operator|*
name|adapter
name|__attribute__
argument_list|(
operator|(
name|__unused__
operator|)
argument_list|)
argument_list|,
expr|enum
name|al_udma_type
name|type
name|__attribute__
argument_list|(
operator|(
name|__unused__
operator|)
argument_list|)
argument_list|,
name|uint32_t
name|qid
name|__attribute__
argument_list|(
operator|(
name|__unused__
operator|)
argument_list|)
argument_list|)
block|{
return|return
operator|-
name|EPERM
return|;
block|}
end_decl_stmt

begin_decl_stmt
name|int
name|al_eth_queue_disable
argument_list|(
expr|struct
name|al_hal_eth_adapter
operator|*
name|adapter
name|__attribute__
argument_list|(
operator|(
name|__unused__
operator|)
argument_list|)
argument_list|,
expr|enum
name|al_udma_type
name|type
name|__attribute__
argument_list|(
operator|(
name|__unused__
operator|)
argument_list|)
argument_list|,
name|uint32_t
name|qid
name|__attribute__
argument_list|(
operator|(
name|__unused__
operator|)
argument_list|)
argument_list|)
block|{
return|return
operator|-
name|EPERM
return|;
block|}
end_decl_stmt

begin_comment
comment|/* MAC layer */
end_comment

begin_function
name|int
name|al_eth_rx_pkt_limit_config
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|min_rx_len
parameter_list|,
name|uint32_t
name|max_rx_len
parameter_list|)
block|{
name|al_assert
argument_list|(
name|max_rx_len
operator|<=
name|AL_ETH_MAX_FRAME_LEN
argument_list|)
expr_stmt|;
comment|/* EC minimum packet length [bytes] in RX */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|mac
operator|.
name|min_pkt
argument_list|,
name|min_rx_len
argument_list|)
expr_stmt|;
comment|/* EC maximum packet length [bytes] in RX */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|mac
operator|.
name|max_pkt
argument_list|,
name|max_rx_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|adapter
operator|->
name|rev_id
operator|>
name|AL_ETH_REV_ID_2
condition|)
block|{
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|rx_afifo_cfg_1
argument_list|,
name|min_rx_len
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|rx_afifo_cfg_2
argument_list|,
name|max_rx_len
argument_list|)
expr_stmt|;
block|}
comment|/* configure the MAC's max rx length, add 16 bytes so the packet get 	 * trimmed by the EC/Async_fifo rather by the MAC 	*/
if|if
condition|(
name|AL_ETH_IS_1G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
condition|)
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|frm_len
argument_list|,
name|max_rx_len
operator|+
literal|16
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|AL_ETH_IS_10G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
operator|||
name|AL_ETH_IS_25G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
condition|)
comment|/* 10G MAC control register  */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|frm_len
argument_list|,
operator|(
name|max_rx_len
operator|+
literal|16
operator|)
argument_list|)
expr_stmt|;
else|else
name|al_eth_40g_mac_reg_write
argument_list|(
name|adapter
argument_list|,
name|ETH_MAC_GEN_V3_MAC_40G_FRM_LENGTH_ADDR
argument_list|,
operator|(
name|max_rx_len
operator|+
literal|16
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* configure the mac media type. */
end_comment

begin_function
name|int
name|al_eth_mac_config
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|enum
name|al_eth_mac_mode
name|mode
parameter_list|)
block|{
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|AL_ETH_MAC_MODE_RGMII
case|:
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|clk_cfg
argument_list|,
literal|0x40003210
argument_list|)
expr_stmt|;
comment|/* 1G MAC control register */
comment|/* bit[0]  - TX_ENA - zeroed by default. Should be asserted by al_eth_mac_start 		 * bit[1]  - RX_ENA - zeroed by default. Should be asserted by al_eth_mac_start 		 * bit[3]  - ETH_SPEED - zeroed to enable 10/100 Mbps Ethernet 		 * bit[4]  - PROMIS_EN - asserted to enable MAC promiscuous mode 		 * bit[23] - CNTL_FRM-ENA - asserted to enable control frames 		 * bit[24] - NO_LGTH_CHECK - asserted to disable length checks, which is done in the controller 		 */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|cmd_cfg
argument_list|,
literal|0x01800010
argument_list|)
expr_stmt|;
comment|/* RX_SECTION_EMPTY,  */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|rx_section_empty
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
comment|/* RX_SECTION_FULL,  */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|rx_section_full
argument_list|,
literal|0x0000000c
argument_list|)
expr_stmt|;
comment|/* must be larger than almost empty */
comment|/* RX_ALMOST_EMPTY,  */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|rx_almost_empty
argument_list|,
literal|0x00000008
argument_list|)
expr_stmt|;
comment|/* RX_ALMOST_FULL,  */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|rx_almost_full
argument_list|,
literal|0x00000008
argument_list|)
expr_stmt|;
comment|/* TX_SECTION_EMPTY,  */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|tx_section_empty
argument_list|,
literal|0x00000008
argument_list|)
expr_stmt|;
comment|/* 8 ? */
comment|/* TX_SECTION_FULL, 0 - store and forward, */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|tx_section_full
argument_list|,
literal|0x0000000c
argument_list|)
expr_stmt|;
comment|/* TX_ALMOST_EMPTY,  */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|tx_almost_empty
argument_list|,
literal|0x00000008
argument_list|)
expr_stmt|;
comment|/* TX_ALMOST_FULL,  */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|tx_almost_full
argument_list|,
literal|0x00000008
argument_list|)
expr_stmt|;
comment|/* XAUI MAC control register */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|cfg
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
comment|/* 1G MACSET 1G */
comment|/* taking sel_1000/sel_10 inputs from rgmii PHY, and not from register. 		 * disabling magic_packets detection in mac */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|mac_1g_cfg
argument_list|,
literal|0x00000002
argument_list|)
expr_stmt|;
comment|/* RGMII set 1G */
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|mux_sel
argument_list|,
operator|~
name|ETH_MAC_GEN_MUX_SEL_KR_IN_MASK
argument_list|,
literal|0x00063910
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|rgmii_sel
argument_list|,
literal|0xF
argument_list|)
expr_stmt|;
break|break;
case|case
name|AL_ETH_MAC_MODE_SGMII
case|:
if|if
condition|(
name|adapter
operator|->
name|rev_id
operator|>
name|AL_ETH_REV_ID_2
condition|)
block|{
comment|/* configure and enable the ASYNC FIFO between the MACs and the EC */
comment|/* TX min packet size */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_1
argument_list|,
literal|0x00000010
argument_list|)
expr_stmt|;
comment|/* TX max packet size */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_2
argument_list|,
literal|0x00002800
argument_list|)
expr_stmt|;
comment|/* TX input bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_3
argument_list|,
literal|0x00000080
argument_list|)
expr_stmt|;
comment|/* TX output bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_4
argument_list|,
literal|0x00030020
argument_list|)
expr_stmt|;
comment|/* TX Valid/ready configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_5
argument_list|,
literal|0x00000121
argument_list|)
expr_stmt|;
comment|/* RX min packet size */
comment|/* al_reg_write32(&adapter->mac_regs_base->gen_v3.rx_afifo_cfg_1, 0x00000040); */
comment|/* RX max packet size */
comment|/* al_reg_write32(&adapter->mac_regs_base->gen_v3.rx_afifo_cfg_2, 0x00002800); */
comment|/* RX input bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|rx_afifo_cfg_3
argument_list|,
literal|0x00030020
argument_list|)
expr_stmt|;
comment|/* RX output bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|rx_afifo_cfg_4
argument_list|,
literal|0x00000080
argument_list|)
expr_stmt|;
comment|/* RX Valid/ready configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|rx_afifo_cfg_5
argument_list|,
literal|0x00000212
argument_list|)
expr_stmt|;
comment|/* V3 additional MAC selection */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_sel
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_10g_ll_cfg
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_10g_ll_ctrl
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|pcs_10g_ll_cfg
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
comment|/* ASYNC FIFO ENABLE */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|afifo_ctrl
argument_list|,
literal|0x00003333
argument_list|)
expr_stmt|;
comment|/* Timestamp_configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|spare
argument_list|,
name|ETH_MAC_GEN_V3_SPARE_CHICKEN_DISABLE_TIMESTAMP_STRETCH
argument_list|)
expr_stmt|;
block|}
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|clk_cfg
argument_list|,
literal|0x40053210
argument_list|)
expr_stmt|;
comment|/* 1G MAC control register */
comment|/* bit[0]  - TX_ENA - zeroed by default. Should be asserted by al_eth_mac_start 		 * bit[1]  - RX_ENA - zeroed by default. Should be asserted by al_eth_mac_start 		 * bit[3]  - ETH_SPEED - zeroed to enable 10/100 Mbps Ethernet 		 * bit[4]  - PROMIS_EN - asserted to enable MAC promiscuous mode 		 * bit[23] - CNTL_FRM-ENA - asserted to enable control frames 		 * bit[24] - NO_LGTH_CHECK - asserted to disable length checks, which is done in the controller 		 */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|cmd_cfg
argument_list|,
literal|0x01800010
argument_list|)
expr_stmt|;
comment|/* RX_SECTION_EMPTY,  */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|rx_section_empty
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
comment|/* RX_SECTION_FULL,  */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|rx_section_full
argument_list|,
literal|0x0000000c
argument_list|)
expr_stmt|;
comment|/* must be larger than almost empty */
comment|/* RX_ALMOST_EMPTY,  */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|rx_almost_empty
argument_list|,
literal|0x00000008
argument_list|)
expr_stmt|;
comment|/* RX_ALMOST_FULL,  */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|rx_almost_full
argument_list|,
literal|0x00000008
argument_list|)
expr_stmt|;
comment|/* TX_SECTION_EMPTY,  */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|tx_section_empty
argument_list|,
literal|0x00000008
argument_list|)
expr_stmt|;
comment|/* 8 ? */
comment|/* TX_SECTION_FULL, 0 - store and forward, */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|tx_section_full
argument_list|,
literal|0x0000000c
argument_list|)
expr_stmt|;
comment|/* TX_ALMOST_EMPTY,  */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|tx_almost_empty
argument_list|,
literal|0x00000008
argument_list|)
expr_stmt|;
comment|/* TX_ALMOST_FULL,  */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|tx_almost_full
argument_list|,
literal|0x00000008
argument_list|)
expr_stmt|;
comment|/* XAUI MAC control register */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|cfg
argument_list|,
literal|0x000000c0
argument_list|)
expr_stmt|;
comment|/* 1G MACSET 1G */
comment|/* taking sel_1000/sel_10 inputs from rgmii_converter, and not from register. 		 * disabling magic_packets detection in mac */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|mac_1g_cfg
argument_list|,
literal|0x00000002
argument_list|)
expr_stmt|;
comment|/* SerDes configuration */
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|mux_sel
argument_list|,
operator|~
name|ETH_MAC_GEN_MUX_SEL_KR_IN_MASK
argument_list|,
literal|0x00063910
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|sd_fifo_ctrl
argument_list|,
literal|0x000004f0
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|sd_fifo_ctrl
argument_list|,
literal|0x00000401
argument_list|)
expr_stmt|;
comment|// FAST AN -- Testing only
ifdef|#
directive|ifdef
name|AL_HAL_ETH_FAST_AN
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|sgmii
operator|.
name|reg_addr
argument_list|,
literal|0x00000012
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|sgmii
operator|.
name|reg_data
argument_list|,
literal|0x00000040
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|sgmii
operator|.
name|reg_addr
argument_list|,
literal|0x00000013
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|sgmii
operator|.
name|reg_data
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* Setting PCS i/f mode to SGMII (instead of default 1000Base-X) */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|sgmii
operator|.
name|reg_addr
argument_list|,
literal|0x00000014
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|sgmii
operator|.
name|reg_data
argument_list|,
literal|0x0000000b
argument_list|)
expr_stmt|;
comment|/* setting dev_ability to have speed of 1000Mb, [11:10] = 2'b10 */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|sgmii
operator|.
name|reg_addr
argument_list|,
literal|0x00000004
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|sgmii
operator|.
name|reg_data
argument_list|,
literal|0x000009A0
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|led_cfg
argument_list|,
name|ETH_MAC_GEN_LED_CFG_SEL_MASK
argument_list|,
name|ETH_MAC_GEN_LED_CFG_SEL_DEFAULT_REG
argument_list|)
expr_stmt|;
break|break;
case|case
name|AL_ETH_MAC_MODE_SGMII_2_5G
case|:
if|if
condition|(
name|adapter
operator|->
name|rev_id
operator|>
name|AL_ETH_REV_ID_2
condition|)
block|{
comment|/* configure and enable the ASYNC FIFO between the MACs and the EC */
comment|/* TX min packet size */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_1
argument_list|,
literal|0x00000010
argument_list|)
expr_stmt|;
comment|/* TX max packet size */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_2
argument_list|,
literal|0x00002800
argument_list|)
expr_stmt|;
comment|/* TX input bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_3
argument_list|,
literal|0x00000080
argument_list|)
expr_stmt|;
comment|/* TX output bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_4
argument_list|,
literal|0x00030020
argument_list|)
expr_stmt|;
comment|/* TX Valid/ready configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_5
argument_list|,
literal|0x00000023
argument_list|)
expr_stmt|;
comment|/* RX input bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|rx_afifo_cfg_3
argument_list|,
literal|0x00030020
argument_list|)
expr_stmt|;
comment|/* RX output bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|rx_afifo_cfg_4
argument_list|,
literal|0x00000080
argument_list|)
expr_stmt|;
comment|/* RX Valid/ready configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|rx_afifo_cfg_5
argument_list|,
literal|0x00000012
argument_list|)
expr_stmt|;
comment|/* V3 additional MAC selection */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_sel
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_10g_ll_cfg
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_10g_ll_ctrl
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|pcs_10g_ll_cfg
argument_list|,
literal|0x00000050
argument_list|)
expr_stmt|;
comment|/* ASYNC FIFO ENABLE */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|afifo_ctrl
argument_list|,
literal|0x00003333
argument_list|)
expr_stmt|;
block|}
comment|/* MAC register file */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|cmd_cfg
argument_list|,
literal|0x01022830
argument_list|)
expr_stmt|;
comment|/* XAUI MAC control register */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|cfg
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|if_mode
argument_list|,
literal|0x00000028
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|control
argument_list|,
literal|0x00001140
argument_list|)
expr_stmt|;
comment|/* RXAUI MAC control register */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|xgmii_dfifo_32_64
argument_list|,
literal|0x00000401
argument_list|)
expr_stmt|;
comment|/*		al_reg_write32(&adapter->mac_regs_base->gen.mac_res_1_out, 0x00000401); */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|xgmii_dfifo_64_32
argument_list|,
literal|0x00000401
argument_list|)
expr_stmt|;
comment|/*		al_reg_write32(&adapter->mac_regs_base->gen.mac_res_1_in, 0x00000401); */
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|mux_sel
argument_list|,
operator|~
name|ETH_MAC_GEN_MUX_SEL_KR_IN_MASK
argument_list|,
literal|0x00063910
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|clk_cfg
argument_list|,
literal|0x40003210
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|sd_fifo_ctrl
argument_list|,
literal|0x000004f0
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|sd_fifo_ctrl
argument_list|,
literal|0x00000401
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|led_cfg
argument_list|,
name|ETH_MAC_GEN_LED_CFG_SEL_MASK
argument_list|,
name|ETH_MAC_GEN_LED_CFG_SEL_DEFAULT_REG
argument_list|)
expr_stmt|;
break|break;
case|case
name|AL_ETH_MAC_MODE_10GbE_Serial
case|:
if|if
condition|(
name|adapter
operator|->
name|rev_id
operator|>
name|AL_ETH_REV_ID_2
condition|)
block|{
comment|/* configure and enable the ASYNC FIFO between the MACs and the EC */
comment|/* TX min packet size */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_1
argument_list|,
literal|0x00000010
argument_list|)
expr_stmt|;
comment|/* TX max packet size */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_2
argument_list|,
literal|0x00002800
argument_list|)
expr_stmt|;
comment|/* TX input bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_3
argument_list|,
literal|0x00000080
argument_list|)
expr_stmt|;
comment|/* TX output bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_4
argument_list|,
literal|0x00030020
argument_list|)
expr_stmt|;
comment|/* TX Valid/ready configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_5
argument_list|,
literal|0x00000023
argument_list|)
expr_stmt|;
comment|/* RX min packet size */
comment|/* al_reg_write32(&adapter->mac_regs_base->gen_v3.rx_afifo_cfg_1, 0x00000040); */
comment|/* RX max packet size */
comment|/* al_reg_write32(&adapter->mac_regs_base->gen_v3.rx_afifo_cfg_2, 0x00002800); */
comment|/* RX input bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|rx_afifo_cfg_3
argument_list|,
literal|0x00030020
argument_list|)
expr_stmt|;
comment|/* RX output bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|rx_afifo_cfg_4
argument_list|,
literal|0x00000080
argument_list|)
expr_stmt|;
comment|/* RX Valid/ready configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|rx_afifo_cfg_5
argument_list|,
literal|0x00000012
argument_list|)
expr_stmt|;
comment|/* V3 additional MAC selection */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_sel
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_10g_ll_cfg
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_10g_ll_ctrl
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|pcs_10g_ll_cfg
argument_list|,
literal|0x00000050
argument_list|)
expr_stmt|;
comment|/* ASYNC FIFO ENABLE */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|afifo_ctrl
argument_list|,
literal|0x00003333
argument_list|)
expr_stmt|;
block|}
comment|/* MAC register file */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|cmd_cfg
argument_list|,
literal|0x01022810
argument_list|)
expr_stmt|;
comment|/* XAUI MAC control register */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|cfg
argument_list|,
literal|0x00000005
argument_list|)
expr_stmt|;
comment|/* RXAUI MAC control register */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|rxaui_cfg
argument_list|,
literal|0x00000007
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|sd_cfg
argument_list|,
literal|0x000001F1
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|xgmii_dfifo_32_64
argument_list|,
literal|0x00000401
argument_list|)
expr_stmt|;
comment|/*		al_reg_write32(&adapter->mac_regs_base->gen.mac_res_1_out, 0x00000401); */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|xgmii_dfifo_64_32
argument_list|,
literal|0x00000401
argument_list|)
expr_stmt|;
comment|/*		al_reg_write32(&adapter->mac_regs_base->gen.mac_res_1_in, 0x00000401); */
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|mux_sel
argument_list|,
operator|~
name|ETH_MAC_GEN_MUX_SEL_KR_IN_MASK
argument_list|,
literal|0x00073910
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|clk_cfg
argument_list|,
literal|0x10003210
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|sd_fifo_ctrl
argument_list|,
literal|0x000004f0
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|sd_fifo_ctrl
argument_list|,
literal|0x00000401
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|led_cfg
argument_list|,
name|ETH_MAC_GEN_LED_CFG_SEL_MASK
argument_list|,
name|ETH_MAC_GEN_LED_CFG_SEL_DEFAULT_REG
argument_list|)
expr_stmt|;
break|break;
case|case
name|AL_ETH_MAC_MODE_KR_LL_25G
case|:
comment|/* select 25G SERDES lane 0 and lane 1 */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|ext_serdes_ctrl
argument_list|,
literal|0x0002110f
argument_list|)
expr_stmt|;
if|if
condition|(
name|adapter
operator|->
name|rev_id
operator|>
name|AL_ETH_REV_ID_2
condition|)
block|{
comment|/* configure and enable the ASYNC FIFO between the MACs and the EC */
comment|/* TX min packet size */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_1
argument_list|,
literal|0x00000010
argument_list|)
expr_stmt|;
comment|/* TX max packet size */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_2
argument_list|,
literal|0x00002800
argument_list|)
expr_stmt|;
comment|/* TX input bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_3
argument_list|,
literal|0x00000080
argument_list|)
expr_stmt|;
comment|/* TX output bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_4
argument_list|,
literal|0x00030020
argument_list|)
expr_stmt|;
comment|/* TX Valid/ready configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_5
argument_list|,
literal|0x00000023
argument_list|)
expr_stmt|;
comment|/* RX min packet size */
comment|/* al_reg_write32(&adapter->mac_regs_base->gen_v3.rx_afifo_cfg_1, 0x00000040); */
comment|/* RX max packet size */
comment|/* al_reg_write32(&adapter->mac_regs_base->gen_v3.rx_afifo_cfg_2, 0x00002800); */
comment|/* RX input bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|rx_afifo_cfg_3
argument_list|,
literal|0x00030020
argument_list|)
expr_stmt|;
comment|/* RX output bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|rx_afifo_cfg_4
argument_list|,
literal|0x00000080
argument_list|)
expr_stmt|;
comment|/* RX Valid/ready configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|rx_afifo_cfg_5
argument_list|,
literal|0x00000012
argument_list|)
expr_stmt|;
comment|/* V3 additional MAC selection */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_sel
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_10g_ll_cfg
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_10g_ll_ctrl
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|pcs_10g_ll_cfg
argument_list|,
literal|0x000000a0
argument_list|)
expr_stmt|;
comment|/* ASYNC FIFO ENABLE */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|afifo_ctrl
argument_list|,
literal|0x00003333
argument_list|)
expr_stmt|;
block|}
comment|/* MAC register file */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|cmd_cfg
argument_list|,
literal|0x01022810
argument_list|)
expr_stmt|;
comment|/* XAUI MAC control register */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|cfg
argument_list|,
literal|0x00000005
argument_list|)
expr_stmt|;
comment|/* RXAUI MAC control register */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|rxaui_cfg
argument_list|,
literal|0x00000007
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|sd_cfg
argument_list|,
literal|0x000001F1
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|xgmii_dfifo_32_64
argument_list|,
literal|0x00000401
argument_list|)
expr_stmt|;
comment|/*		al_reg_write32(&adapter->mac_regs_base->gen.mac_res_1_out, 0x00000401); */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|xgmii_dfifo_64_32
argument_list|,
literal|0x00000401
argument_list|)
expr_stmt|;
comment|/*		al_reg_write32(&adapter->mac_regs_base->gen.mac_res_1_in, 0x00000401); */
if|if
condition|(
name|adapter
operator|->
name|serdes_lane
operator|==
literal|0
condition|)
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|mux_sel
argument_list|,
operator|~
name|ETH_MAC_GEN_MUX_SEL_KR_IN_MASK
argument_list|,
literal|0x00073910
argument_list|)
expr_stmt|;
else|else
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|mux_sel
argument_list|,
literal|0x00077910
argument_list|)
expr_stmt|;
if|if
condition|(
name|adapter
operator|->
name|serdes_lane
operator|==
literal|0
condition|)
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|clk_cfg
argument_list|,
literal|0x10003210
argument_list|)
expr_stmt|;
else|else
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|clk_cfg
argument_list|,
literal|0x10000101
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|sd_fifo_ctrl
argument_list|,
literal|0x000004f0
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|sd_fifo_ctrl
argument_list|,
literal|0x00000401
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|led_cfg
argument_list|,
name|ETH_MAC_GEN_LED_CFG_SEL_MASK
argument_list|,
name|ETH_MAC_GEN_LED_CFG_SEL_DEFAULT_REG
argument_list|)
expr_stmt|;
if|if
condition|(
name|adapter
operator|->
name|serdes_lane
operator|==
literal|1
condition|)
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|los_sel
argument_list|,
literal|0x101
argument_list|)
expr_stmt|;
break|break;
case|case
name|AL_ETH_MAC_MODE_10G_SGMII
case|:
comment|/* MAC register file */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|cmd_cfg
argument_list|,
literal|0x01022810
argument_list|)
expr_stmt|;
comment|/* XAUI MAC control register */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|cfg
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|if_mode
argument_list|,
literal|0x0000002b
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|control
argument_list|,
literal|0x00009140
argument_list|)
expr_stmt|;
comment|// FAST AN -- Testing only
ifdef|#
directive|ifdef
name|AL_HAL_ETH_FAST_AN
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|link_timer_lo
argument_list|,
literal|0x00000040
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|link_timer_hi
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* RXAUI MAC control register */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|rxaui_cfg
argument_list|,
literal|0x00000007
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|xgmii_dfifo_32_64
argument_list|,
literal|0x00000401
argument_list|)
expr_stmt|;
comment|/*		al_reg_write32(&adapter->mac_regs_base->gen.mac_res_1_out, 0x00000401); */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|xgmii_dfifo_64_32
argument_list|,
literal|0x00000401
argument_list|)
expr_stmt|;
comment|/*		al_reg_write32(&adapter->mac_regs_base->gen.mac_res_1_in, 0x00000401); */
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|mux_sel
argument_list|,
operator|~
name|ETH_MAC_GEN_MUX_SEL_KR_IN_MASK
argument_list|,
literal|0x00063910
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|clk_cfg
argument_list|,
literal|0x40003210
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|sd_fifo_ctrl
argument_list|,
literal|0x00000401
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|led_cfg
argument_list|,
name|ETH_MAC_GEN_LED_CFG_SEL_MASK
argument_list|,
name|ETH_MAC_GEN_LED_CFG_SEL_DEFAULT_REG
argument_list|)
expr_stmt|;
break|break;
case|case
name|AL_ETH_MAC_MODE_XLG_LL_40G
case|:
comment|/* configure and enable the ASYNC FIFO between the MACs and the EC */
comment|/* TX min packet size */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_1
argument_list|,
literal|0x00000010
argument_list|)
expr_stmt|;
comment|/* TX max packet size */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_2
argument_list|,
literal|0x00002800
argument_list|)
expr_stmt|;
comment|/* TX input bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_3
argument_list|,
literal|0x00000080
argument_list|)
expr_stmt|;
comment|/* TX output bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_4
argument_list|,
literal|0x00010040
argument_list|)
expr_stmt|;
comment|/* TX Valid/ready configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_5
argument_list|,
literal|0x00000023
argument_list|)
expr_stmt|;
comment|/* RX min packet size */
comment|/* al_reg_write32(&adapter->mac_regs_base->gen_v3.rx_afifo_cfg_1, 0x00000040); */
comment|/* RX max packet size */
comment|/* al_reg_write32(&adapter->mac_regs_base->gen_v3.rx_afifo_cfg_2, 0x00002800); */
comment|/* RX input bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|rx_afifo_cfg_3
argument_list|,
literal|0x00010040
argument_list|)
expr_stmt|;
comment|/* RX output bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|rx_afifo_cfg_4
argument_list|,
literal|0x00000080
argument_list|)
expr_stmt|;
comment|/* RX Valid/ready configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|rx_afifo_cfg_5
argument_list|,
literal|0x00000112
argument_list|)
expr_stmt|;
comment|/* V3 additional MAC selection */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_sel
argument_list|,
literal|0x00000010
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_10g_ll_cfg
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_10g_ll_ctrl
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|pcs_10g_ll_cfg
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
comment|/* ASYNC FIFO ENABLE */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|afifo_ctrl
argument_list|,
literal|0x00003333
argument_list|)
expr_stmt|;
comment|/* cmd_cfg */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_40g_ll_addr
argument_list|,
literal|0x00000008
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_40g_ll_data
argument_list|,
literal|0x01022810
argument_list|)
expr_stmt|;
comment|/* speed_ability //Read-Only */
comment|/* al_reg_write32(&adapter->mac_regs_base->gen_v3.pcs_40g_ll_addr, 0x00000008); */
comment|/* 40G capable */
comment|/* al_reg_write32(&adapter->mac_regs_base->gen_v3.pcs_40g_ll_data, 0x00000002); */
ifdef|#
directive|ifdef
name|AL_HAL_ETH_FAST_AN
name|al_eth_40g_pcs_reg_write
argument_list|(
name|adapter
argument_list|,
literal|0x00010004
argument_list|,
literal|1023
argument_list|)
expr_stmt|;
name|al_eth_40g_pcs_reg_write
argument_list|(
name|adapter
argument_list|,
literal|0x00000000
argument_list|,
literal|0xA04c
argument_list|)
expr_stmt|;
name|al_eth_40g_pcs_reg_write
argument_list|(
name|adapter
argument_list|,
literal|0x00000000
argument_list|,
literal|0x204c
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* XAUI MAC control register */
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|mux_sel
argument_list|,
operator|~
name|ETH_MAC_GEN_MUX_SEL_KR_IN_MASK
argument_list|,
literal|0x06883910
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|sd_fifo_ctrl
argument_list|,
literal|0x0000040f
argument_list|)
expr_stmt|;
comment|/* MAC register file */
comment|/*		al_reg_write32(&adapter->mac_regs_base->mac_10g.cmd_cfg, 0x01022810); */
comment|/* XAUI MAC control register */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|cfg
argument_list|,
literal|0x00000005
argument_list|)
expr_stmt|;
comment|/* RXAUI MAC control register */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|rxaui_cfg
argument_list|,
literal|0x00000007
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|sd_cfg
argument_list|,
literal|0x000001F1
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|xgmii_dfifo_32_64
argument_list|,
literal|0x00000401
argument_list|)
expr_stmt|;
comment|/*		al_reg_write32(&adapter->mac_regs_base->gen.mac_res_1_out, 0x00000401); */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|xgmii_dfifo_64_32
argument_list|,
literal|0x00000401
argument_list|)
expr_stmt|;
comment|/*		al_reg_write32(&adapter->mac_regs_base->gen.mac_res_1_in, 0x00000401); */
comment|/*		al_reg_write32_masked(&adapter->mac_regs_base->gen.mux_sel, ~ETH_MAC_GEN_MUX_SEL_KR_IN_MASK, 0x00073910); */
comment|/* XLG_LL_40G change */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|clk_cfg
argument_list|,
literal|0x10003210
argument_list|)
expr_stmt|;
comment|/*		al_reg_write32(&adapter->mac_regs_base->gen.sd_fifo_ctrl, 0x000004f0); */
comment|/* XLG_LL_40G change */
comment|/*		al_reg_write32(&adapter->mac_regs_base->gen.sd_fifo_ctrl, 0x00000401); */
comment|/* XLG_LL_40G change */
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|led_cfg
argument_list|,
name|ETH_MAC_GEN_LED_CFG_SEL_MASK
argument_list|,
name|ETH_MAC_GEN_LED_CFG_SEL_DEFAULT_REG
argument_list|)
expr_stmt|;
break|break;
case|case
name|AL_ETH_MAC_MODE_XLG_LL_25G
case|:
comment|/* xgmii_mode: 0=xlgmii, 1=xgmii */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_40g_ll_addr
argument_list|,
literal|0x0080
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_40g_ll_data
argument_list|,
literal|0x00000001
argument_list|)
expr_stmt|;
comment|/* configure and enable the ASYNC FIFO between the MACs and the EC */
comment|/* TX min packet size */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_1
argument_list|,
literal|0x00000010
argument_list|)
expr_stmt|;
comment|/* TX max packet size */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_2
argument_list|,
literal|0x00002800
argument_list|)
expr_stmt|;
comment|/* TX input bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_3
argument_list|,
literal|0x00000080
argument_list|)
expr_stmt|;
comment|/* TX output bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_4
argument_list|,
literal|0x00010040
argument_list|)
expr_stmt|;
comment|/* TX Valid/ready configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_5
argument_list|,
literal|0x00000023
argument_list|)
expr_stmt|;
comment|/* RX min packet size */
comment|/* al_reg_write32(&adapter->mac_regs_base->gen_v3.rx_afifo_cfg_1, 0x00000040); */
comment|/* RX max packet size */
comment|/* al_reg_write32(&adapter->mac_regs_base->gen_v3.rx_afifo_cfg_2, 0x00002800); */
comment|/* RX input bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|rx_afifo_cfg_3
argument_list|,
literal|0x00010040
argument_list|)
expr_stmt|;
comment|/* RX output bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|rx_afifo_cfg_4
argument_list|,
literal|0x00000080
argument_list|)
expr_stmt|;
comment|/* RX Valid/ready configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|rx_afifo_cfg_5
argument_list|,
literal|0x00000112
argument_list|)
expr_stmt|;
comment|/* V3 additional MAC selection */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_sel
argument_list|,
literal|0x00000010
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_10g_ll_cfg
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_10g_ll_ctrl
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|pcs_10g_ll_cfg
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
comment|/* ASYNC FIFO ENABLE */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|afifo_ctrl
argument_list|,
literal|0x00003333
argument_list|)
expr_stmt|;
comment|/* cmd_cfg */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_40g_ll_addr
argument_list|,
literal|0x00000008
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_40g_ll_data
argument_list|,
literal|0x01022810
argument_list|)
expr_stmt|;
comment|/* speed_ability //Read-Only */
comment|/* al_reg_write32(&adapter->mac_regs_base->gen_v3.pcs_40g_ll_addr, 0x00000008); */
comment|/* 40G capable */
comment|/* al_reg_write32(&adapter->mac_regs_base->gen_v3.pcs_40g_ll_data, 0x00000002); */
comment|/* select the 25G serdes for lanes 0/1 */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|ext_serdes_ctrl
argument_list|,
literal|0x0002110f
argument_list|)
expr_stmt|;
comment|/* configure the PCS to work with 2 lanes */
comment|/* configure which two of the 4 PCS Lanes (VL) are combined to one RXLAUI lane */
comment|/* use VL 0-2 for RXLAUI lane 0, use VL 1-3 for RXLAUI lane 1 */
name|al_eth_40g_pcs_reg_write
argument_list|(
name|adapter
argument_list|,
literal|0x00010008
argument_list|,
literal|0x0d80
argument_list|)
expr_stmt|;
comment|/* configure the PCS to work 32 bit interface */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|pcs_40g_ll_cfg
argument_list|,
literal|0x00440000
argument_list|)
expr_stmt|;
comment|/* disable MLD and move to clause 49 PCS: */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|pcs_40g_ll_addr
argument_list|,
literal|0xE
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|pcs_40g_ll_data
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|AL_HAL_ETH_FAST_AN
name|al_eth_40g_pcs_reg_write
argument_list|(
name|adapter
argument_list|,
literal|0x00010004
argument_list|,
literal|1023
argument_list|)
expr_stmt|;
name|al_eth_40g_pcs_reg_write
argument_list|(
name|adapter
argument_list|,
literal|0x00000000
argument_list|,
literal|0xA04c
argument_list|)
expr_stmt|;
name|al_eth_40g_pcs_reg_write
argument_list|(
name|adapter
argument_list|,
literal|0x00000000
argument_list|,
literal|0x204c
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* XAUI MAC control register */
if|if
condition|(
name|adapter
operator|->
name|serdes_lane
operator|==
literal|0
condition|)
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|mux_sel
argument_list|,
operator|~
name|ETH_MAC_GEN_MUX_SEL_KR_IN_MASK
argument_list|,
literal|0x06883910
argument_list|)
expr_stmt|;
else|else
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|mux_sel
argument_list|,
literal|0x06803950
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|sd_fifo_ctrl
argument_list|,
literal|0x0000040f
argument_list|)
expr_stmt|;
comment|/* XAUI MAC control register */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|cfg
argument_list|,
literal|0x00000005
argument_list|)
expr_stmt|;
comment|/* RXAUI MAC control register */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|rxaui_cfg
argument_list|,
literal|0x00000007
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|sd_cfg
argument_list|,
literal|0x000001F1
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|xgmii_dfifo_32_64
argument_list|,
literal|0x00000401
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|xgmii_dfifo_64_32
argument_list|,
literal|0x00000401
argument_list|)
expr_stmt|;
if|if
condition|(
name|adapter
operator|->
name|serdes_lane
operator|==
literal|0
condition|)
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|clk_cfg
argument_list|,
literal|0x10003210
argument_list|)
expr_stmt|;
else|else
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|clk_cfg
argument_list|,
literal|0x10000101
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|led_cfg
argument_list|,
name|ETH_MAC_GEN_LED_CFG_SEL_MASK
argument_list|,
name|ETH_MAC_GEN_LED_CFG_SEL_DEFAULT_REG
argument_list|)
expr_stmt|;
if|if
condition|(
name|adapter
operator|->
name|serdes_lane
operator|==
literal|1
condition|)
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|los_sel
argument_list|,
literal|0x101
argument_list|)
expr_stmt|;
break|break;
case|case
name|AL_ETH_MAC_MODE_XLG_LL_50G
case|:
comment|/* configure and enable the ASYNC FIFO between the MACs and the EC */
comment|/* TX min packet size */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_1
argument_list|,
literal|0x00000010
argument_list|)
expr_stmt|;
comment|/* TX max packet size */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_2
argument_list|,
literal|0x00002800
argument_list|)
expr_stmt|;
comment|/* TX input bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_3
argument_list|,
literal|0x00000080
argument_list|)
expr_stmt|;
comment|/* TX output bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_4
argument_list|,
literal|0x00010040
argument_list|)
expr_stmt|;
comment|/* TX Valid/ready configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|tx_afifo_cfg_5
argument_list|,
literal|0x00000023
argument_list|)
expr_stmt|;
comment|/* RX min packet size */
comment|/* al_reg_write32(&adapter->mac_regs_base->gen_v3.rx_afifo_cfg_1, 0x00000040); */
comment|/* RX max packet size */
comment|/* al_reg_write32(&adapter->mac_regs_base->gen_v3.rx_afifo_cfg_2, 0x00002800); */
comment|/* RX input bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|rx_afifo_cfg_3
argument_list|,
literal|0x00010040
argument_list|)
expr_stmt|;
comment|/* RX output bus configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|rx_afifo_cfg_4
argument_list|,
literal|0x00000080
argument_list|)
expr_stmt|;
comment|/* RX Valid/ready configuration */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|rx_afifo_cfg_5
argument_list|,
literal|0x00000112
argument_list|)
expr_stmt|;
comment|/* V3 additional MAC selection */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_sel
argument_list|,
literal|0x00000010
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_10g_ll_cfg
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_10g_ll_ctrl
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|pcs_10g_ll_cfg
argument_list|,
literal|0x00000000
argument_list|)
expr_stmt|;
comment|/* ASYNC FIFO ENABLE */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|afifo_ctrl
argument_list|,
literal|0x00003333
argument_list|)
expr_stmt|;
comment|/* cmd_cfg */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_40g_ll_addr
argument_list|,
literal|0x00000008
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_40g_ll_data
argument_list|,
literal|0x01022810
argument_list|)
expr_stmt|;
comment|/* speed_ability //Read-Only */
comment|/* al_reg_write32(&adapter->mac_regs_base->gen_v3.pcs_40g_ll_addr, 0x00000008); */
comment|/* 40G capable */
comment|/* al_reg_write32(&adapter->mac_regs_base->gen_v3.pcs_40g_ll_data, 0x00000002); */
comment|/* select the 25G serdes for lanes 0/1 */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|ext_serdes_ctrl
argument_list|,
literal|0x0382110F
argument_list|)
expr_stmt|;
comment|/* configure the PCS to work with 2 lanes */
comment|/* configure which two of the 4 PCS Lanes (VL) are combined to one RXLAUI lane */
comment|/* use VL 0-2 for RXLAUI lane 0, use VL 1-3 for RXLAUI lane 1 */
name|al_eth_40g_pcs_reg_write
argument_list|(
name|adapter
argument_list|,
literal|0x00010008
argument_list|,
literal|0x0d81
argument_list|)
expr_stmt|;
comment|/* configure the PCS to work 32 bit interface */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|pcs_40g_ll_cfg
argument_list|,
literal|0x00440000
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|AL_HAL_ETH_FAST_AN
name|al_eth_40g_pcs_reg_write
argument_list|(
name|adapter
argument_list|,
literal|0x00010004
argument_list|,
literal|1023
argument_list|)
expr_stmt|;
name|al_eth_40g_pcs_reg_write
argument_list|(
name|adapter
argument_list|,
literal|0x00000000
argument_list|,
literal|0xA04c
argument_list|)
expr_stmt|;
name|al_eth_40g_pcs_reg_write
argument_list|(
name|adapter
argument_list|,
literal|0x00000000
argument_list|,
literal|0x204c
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* XAUI MAC control register */
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|mux_sel
argument_list|,
operator|~
name|ETH_MAC_GEN_MUX_SEL_KR_IN_MASK
argument_list|,
literal|0x06883910
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|sd_fifo_ctrl
argument_list|,
literal|0x0000040f
argument_list|)
expr_stmt|;
comment|/* MAC register file */
comment|/*		al_reg_write32(&adapter->mac_regs_base->mac_10g.cmd_cfg, 0x01022810); */
comment|/* XAUI MAC control register */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|cfg
argument_list|,
literal|0x00000005
argument_list|)
expr_stmt|;
comment|/* RXAUI MAC control register */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|rxaui_cfg
argument_list|,
literal|0x00000007
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|sd_cfg
argument_list|,
literal|0x000001F1
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|xgmii_dfifo_32_64
argument_list|,
literal|0x00000401
argument_list|)
expr_stmt|;
comment|/*		al_reg_write32(&adapter->mac_regs_base->gen.mac_res_1_out, 0x00000401); */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|xgmii_dfifo_64_32
argument_list|,
literal|0x00000401
argument_list|)
expr_stmt|;
comment|/*		al_reg_write32(&adapter->mac_regs_base->gen.mac_res_1_in, 0x00000401); */
comment|/*		al_reg_write32_masked(&adapter->mac_regs_base->gen.mux_sel, ~ETH_MAC_GEN_MUX_SEL_KR_IN_MASK, 0x00073910); */
comment|/* XLG_LL_40G change */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|clk_cfg
argument_list|,
literal|0x10003210
argument_list|)
expr_stmt|;
comment|/*		al_reg_write32(&adapter->mac_regs_base->gen.sd_fifo_ctrl, 0x000004f0); */
comment|/* XLG_LL_40G change */
comment|/*		al_reg_write32(&adapter->mac_regs_base->gen.sd_fifo_ctrl, 0x00000401); */
comment|/* XLG_LL_40G change */
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|led_cfg
argument_list|,
name|ETH_MAC_GEN_LED_CFG_SEL_MASK
argument_list|,
name|ETH_MAC_GEN_LED_CFG_SEL_DEFAULT_REG
argument_list|)
expr_stmt|;
break|break;
default|default:
name|al_err
argument_list|(
literal|"Eth: unsupported MAC mode %d"
argument_list|,
name|mode
argument_list|)
expr_stmt|;
return|return
operator|-
name|EPERM
return|;
block|}
name|adapter
operator|->
name|mac_mode
operator|=
name|mode
expr_stmt|;
name|al_info
argument_list|(
literal|"configured MAC to %s mode:\n"
argument_list|,
name|al_eth_mac_mode_str
argument_list|(
name|mode
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* start the mac */
end_comment

begin_function
name|int
name|al_eth_mac_start
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|)
block|{
if|if
condition|(
name|AL_ETH_IS_1G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
condition|)
block|{
comment|/* 1G MAC control register */
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|cmd_cfg
argument_list|,
name|ETH_1G_MAC_CMD_CFG_TX_ENA
operator||
name|ETH_1G_MAC_CMD_CFG_RX_ENA
argument_list|,
name|ETH_1G_MAC_CMD_CFG_TX_ENA
operator||
name|ETH_1G_MAC_CMD_CFG_RX_ENA
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|AL_ETH_IS_10G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
operator|||
name|AL_ETH_IS_25G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
condition|)
block|{
comment|/* 10G MAC control register  */
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|cmd_cfg
argument_list|,
name|ETH_10G_MAC_CMD_CFG_TX_ENA
operator||
name|ETH_10G_MAC_CMD_CFG_RX_ENA
argument_list|,
name|ETH_10G_MAC_CMD_CFG_TX_ENA
operator||
name|ETH_10G_MAC_CMD_CFG_RX_ENA
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|uint32_t
name|cmd_cfg
decl_stmt|;
name|cmd_cfg
operator|=
name|al_eth_40g_mac_reg_read
argument_list|(
name|adapter
argument_list|,
name|ETH_MAC_GEN_V3_MAC_40G_COMMAND_CONFIG_ADDR
argument_list|)
expr_stmt|;
name|cmd_cfg
operator||=
operator|(
name|ETH_MAC_GEN_V3_MAC_40G_COMMAND_CONFIG_TX_ENA
operator||
name|ETH_MAC_GEN_V3_MAC_40G_COMMAND_CONFIG_RX_ENA
operator|)
expr_stmt|;
name|al_eth_40g_mac_reg_write
argument_list|(
name|adapter
argument_list|,
name|ETH_MAC_GEN_V3_MAC_40G_COMMAND_CONFIG_ADDR
argument_list|,
name|cmd_cfg
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* stop the mac */
end_comment

begin_function
name|int
name|al_eth_mac_stop
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|)
block|{
if|if
condition|(
name|AL_ETH_IS_1G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
condition|)
comment|/* 1G MAC control register */
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|cmd_cfg
argument_list|,
name|ETH_1G_MAC_CMD_CFG_TX_ENA
operator||
name|ETH_1G_MAC_CMD_CFG_RX_ENA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|AL_ETH_IS_10G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
operator|||
name|AL_ETH_IS_25G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
condition|)
comment|/* 10G MAC control register  */
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|cmd_cfg
argument_list|,
name|ETH_10G_MAC_CMD_CFG_TX_ENA
operator||
name|ETH_10G_MAC_CMD_CFG_RX_ENA
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
block|{
name|uint32_t
name|cmd_cfg
decl_stmt|;
name|cmd_cfg
operator|=
name|al_eth_40g_mac_reg_read
argument_list|(
name|adapter
argument_list|,
name|ETH_MAC_GEN_V3_MAC_40G_COMMAND_CONFIG_ADDR
argument_list|)
expr_stmt|;
name|cmd_cfg
operator|&=
operator|~
operator|(
name|ETH_MAC_GEN_V3_MAC_40G_COMMAND_CONFIG_TX_ENA
operator||
name|ETH_MAC_GEN_V3_MAC_40G_COMMAND_CONFIG_RX_ENA
operator|)
expr_stmt|;
name|al_eth_40g_mac_reg_write
argument_list|(
name|adapter
argument_list|,
name|ETH_MAC_GEN_V3_MAC_40G_COMMAND_CONFIG_ADDR
argument_list|,
name|cmd_cfg
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|al_eth_gearbox_reset
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|al_bool
name|tx_reset
parameter_list|,
name|al_bool
name|rx_reset
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|,
name|orig_val
decl_stmt|;
comment|/* Gearbox is exist only from revision 3 */
name|al_assert
argument_list|(
name|adapter
operator|->
name|rev_id
operator|>
name|AL_ETH_REV_ID_2
argument_list|)
expr_stmt|;
name|orig_val
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|ext_serdes_ctrl
argument_list|)
expr_stmt|;
name|reg
operator|=
name|orig_val
expr_stmt|;
if|if
condition|(
name|tx_reset
condition|)
block|{
name|reg
operator||=
operator|(
name|ETH_MAC_GEN_V3_EXT_SERDES_CTRL_LANE_0_TX_25_GS_SW_RESET
operator||
name|ETH_MAC_GEN_V3_EXT_SERDES_CTRL_LANE_1_TX_25_GS_SW_RESET
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|rx_reset
condition|)
block|{
name|reg
operator||=
operator|(
name|ETH_MAC_GEN_V3_EXT_SERDES_CTRL_LANE_0_RX_25_GS_SW_RESET
operator||
name|ETH_MAC_GEN_V3_EXT_SERDES_CTRL_LANE_1_RX_25_GS_SW_RESET
operator|)
expr_stmt|;
block|}
name|al_dbg
argument_list|(
literal|"%s: perform gearbox reset (Tx %d, Rx %d) \n"
argument_list|,
name|__func__
argument_list|,
name|tx_reset
argument_list|,
name|rx_reset
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|ext_serdes_ctrl
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_udelay
argument_list|(
literal|10
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|ext_serdes_ctrl
argument_list|,
name|orig_val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|al_eth_fec_enable
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|al_bool
name|enable
parameter_list|)
block|{
if|if
condition|(
name|adapter
operator|->
name|rev_id
operator|<=
name|AL_ETH_REV_ID_2
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|enable
condition|)
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|pcs_10g_ll_cfg
argument_list|,
operator|(
name|ETH_MAC_GEN_V3_PCS_10G_LL_CFG_FEC_EN_RX
operator||
name|ETH_MAC_GEN_V3_PCS_10G_LL_CFG_FEC_EN_TX
operator|)
argument_list|,
operator|(
name|ETH_MAC_GEN_V3_PCS_10G_LL_CFG_FEC_EN_RX
operator||
name|ETH_MAC_GEN_V3_PCS_10G_LL_CFG_FEC_EN_TX
operator|)
argument_list|)
expr_stmt|;
else|else
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|pcs_10g_ll_cfg
argument_list|,
operator|(
name|ETH_MAC_GEN_V3_PCS_10G_LL_CFG_FEC_EN_RX
operator||
name|ETH_MAC_GEN_V3_PCS_10G_LL_CFG_FEC_EN_TX
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_fec_stats_get
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
modifier|*
name|corrected
parameter_list|,
name|uint32_t
modifier|*
name|uncorrectable
parameter_list|)
block|{
if|if
condition|(
name|adapter
operator|->
name|rev_id
operator|<=
name|AL_ETH_REV_ID_2
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|corrected
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|stat
operator|.
name|v3_pcs_10g_ll_cerr
argument_list|)
expr_stmt|;
operator|*
name|uncorrectable
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|stat
operator|.
name|v3_pcs_10g_ll_ncerr
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_capabilities_get
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|al_eth_capabilities
modifier|*
name|caps
parameter_list|)
block|{
name|al_assert
argument_list|(
name|caps
argument_list|)
expr_stmt|;
name|caps
operator|->
name|speed_10_HD
operator|=
name|AL_FALSE
expr_stmt|;
name|caps
operator|->
name|speed_10_FD
operator|=
name|AL_FALSE
expr_stmt|;
name|caps
operator|->
name|speed_100_HD
operator|=
name|AL_FALSE
expr_stmt|;
name|caps
operator|->
name|speed_100_FD
operator|=
name|AL_FALSE
expr_stmt|;
name|caps
operator|->
name|speed_1000_HD
operator|=
name|AL_FALSE
expr_stmt|;
name|caps
operator|->
name|speed_1000_FD
operator|=
name|AL_FALSE
expr_stmt|;
name|caps
operator|->
name|speed_10000_HD
operator|=
name|AL_FALSE
expr_stmt|;
name|caps
operator|->
name|speed_10000_FD
operator|=
name|AL_FALSE
expr_stmt|;
name|caps
operator|->
name|pfc
operator|=
name|AL_FALSE
expr_stmt|;
name|caps
operator|->
name|eee
operator|=
name|AL_FALSE
expr_stmt|;
switch|switch
condition|(
name|adapter
operator|->
name|mac_mode
condition|)
block|{
case|case
name|AL_ETH_MAC_MODE_RGMII
case|:
case|case
name|AL_ETH_MAC_MODE_SGMII
case|:
name|caps
operator|->
name|speed_10_HD
operator|=
name|AL_TRUE
expr_stmt|;
name|caps
operator|->
name|speed_10_FD
operator|=
name|AL_TRUE
expr_stmt|;
name|caps
operator|->
name|speed_100_HD
operator|=
name|AL_TRUE
expr_stmt|;
name|caps
operator|->
name|speed_100_FD
operator|=
name|AL_TRUE
expr_stmt|;
name|caps
operator|->
name|speed_1000_FD
operator|=
name|AL_TRUE
expr_stmt|;
name|caps
operator|->
name|eee
operator|=
name|AL_TRUE
expr_stmt|;
break|break;
case|case
name|AL_ETH_MAC_MODE_10GbE_Serial
case|:
name|caps
operator|->
name|speed_10000_FD
operator|=
name|AL_TRUE
expr_stmt|;
name|caps
operator|->
name|pfc
operator|=
name|AL_TRUE
expr_stmt|;
break|break;
default|default:
name|al_err
argument_list|(
literal|"Eth: unsupported MAC mode %d"
argument_list|,
name|adapter
operator|->
name|mac_mode
argument_list|)
expr_stmt|;
return|return
operator|-
name|EPERM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|al_eth_mac_link_config_1g_mac
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|al_bool
name|force_1000_base_x
parameter_list|,
name|al_bool
name|an_enable
parameter_list|,
name|uint32_t
name|speed
parameter_list|,
name|al_bool
name|full_duplex
parameter_list|)
block|{
name|uint32_t
name|mac_ctrl
decl_stmt|;
name|uint32_t
name|sgmii_ctrl
init|=
literal|0
decl_stmt|;
name|uint32_t
name|sgmii_if_mode
init|=
literal|0
decl_stmt|;
name|uint32_t
name|rgmii_ctrl
init|=
literal|0
decl_stmt|;
name|mac_ctrl
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|cmd_cfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|adapter
operator|->
name|mac_mode
operator|==
name|AL_ETH_MAC_MODE_SGMII
condition|)
block|{
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|sgmii
operator|.
name|reg_addr
argument_list|,
name|ETH_MAC_SGMII_REG_ADDR_CTRL_REG
argument_list|)
expr_stmt|;
name|sgmii_ctrl
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|sgmii
operator|.
name|reg_data
argument_list|)
expr_stmt|;
comment|/* 		 * in case bit 0 is off in sgmii_if_mode register all the other 		 * bits are ignored. 		 */
if|if
condition|(
name|force_1000_base_x
operator|==
name|AL_FALSE
condition|)
name|sgmii_if_mode
operator|=
name|ETH_MAC_SGMII_REG_DATA_IF_MODE_SGMII_EN
expr_stmt|;
if|if
condition|(
name|an_enable
operator|==
name|AL_TRUE
condition|)
block|{
name|sgmii_if_mode
operator||=
name|ETH_MAC_SGMII_REG_DATA_IF_MODE_SGMII_AN
expr_stmt|;
name|sgmii_ctrl
operator||=
name|ETH_MAC_SGMII_REG_DATA_CTRL_AN_ENABLE
expr_stmt|;
block|}
else|else
block|{
name|sgmii_ctrl
operator|&=
operator|~
operator|(
name|ETH_MAC_SGMII_REG_DATA_CTRL_AN_ENABLE
operator|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|adapter
operator|->
name|mac_mode
operator|==
name|AL_ETH_MAC_MODE_RGMII
condition|)
block|{
comment|/* 		 * Use the speed provided by the MAC instead of the PHY 		 */
name|rgmii_ctrl
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|rgmii_cfg
argument_list|)
expr_stmt|;
name|AL_REG_MASK_CLEAR
argument_list|(
name|rgmii_ctrl
argument_list|,
name|ETH_MAC_GEN_RGMII_CFG_ENA_AUTO
argument_list|)
expr_stmt|;
name|AL_REG_MASK_CLEAR
argument_list|(
name|rgmii_ctrl
argument_list|,
name|ETH_MAC_GEN_RGMII_CFG_SET_1000_SEL
argument_list|)
expr_stmt|;
name|AL_REG_MASK_CLEAR
argument_list|(
name|rgmii_ctrl
argument_list|,
name|ETH_MAC_GEN_RGMII_CFG_SET_10_SEL
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|rgmii_cfg
argument_list|,
name|rgmii_ctrl
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|full_duplex
operator|==
name|AL_TRUE
condition|)
block|{
name|AL_REG_MASK_CLEAR
argument_list|(
name|mac_ctrl
argument_list|,
name|ETH_1G_MAC_CMD_CFG_HD_EN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|AL_REG_MASK_SET
argument_list|(
name|mac_ctrl
argument_list|,
name|ETH_1G_MAC_CMD_CFG_HD_EN
argument_list|)
expr_stmt|;
name|sgmii_if_mode
operator||=
name|ETH_MAC_SGMII_REG_DATA_IF_MODE_SGMII_DUPLEX
expr_stmt|;
block|}
if|if
condition|(
name|speed
operator|==
literal|1000
condition|)
block|{
name|AL_REG_MASK_SET
argument_list|(
name|mac_ctrl
argument_list|,
name|ETH_1G_MAC_CMD_CFG_1G_SPD
argument_list|)
expr_stmt|;
name|sgmii_if_mode
operator||=
name|ETH_MAC_SGMII_REG_DATA_IF_MODE_SGMII_SPEED_1000
expr_stmt|;
block|}
else|else
block|{
name|AL_REG_MASK_CLEAR
argument_list|(
name|mac_ctrl
argument_list|,
name|ETH_1G_MAC_CMD_CFG_1G_SPD
argument_list|)
expr_stmt|;
if|if
condition|(
name|speed
operator|==
literal|10
condition|)
block|{
name|AL_REG_MASK_SET
argument_list|(
name|mac_ctrl
argument_list|,
name|ETH_1G_MAC_CMD_CFG_10M_SPD
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sgmii_if_mode
operator||=
name|ETH_MAC_SGMII_REG_DATA_IF_MODE_SGMII_SPEED_100
expr_stmt|;
name|AL_REG_MASK_CLEAR
argument_list|(
name|mac_ctrl
argument_list|,
name|ETH_1G_MAC_CMD_CFG_10M_SPD
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|adapter
operator|->
name|mac_mode
operator|==
name|AL_ETH_MAC_MODE_SGMII
condition|)
block|{
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|sgmii
operator|.
name|reg_addr
argument_list|,
name|ETH_MAC_SGMII_REG_ADDR_IF_MODE_REG
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|sgmii
operator|.
name|reg_data
argument_list|,
name|sgmii_if_mode
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|sgmii
operator|.
name|reg_addr
argument_list|,
name|ETH_MAC_SGMII_REG_ADDR_CTRL_REG
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|sgmii
operator|.
name|reg_data
argument_list|,
name|sgmii_ctrl
argument_list|)
expr_stmt|;
block|}
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|cmd_cfg
argument_list|,
name|mac_ctrl
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|al_eth_mac_link_config_10g_mac
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|al_bool
name|force_1000_base_x
parameter_list|,
name|al_bool
name|an_enable
parameter_list|,
name|uint32_t
name|speed
parameter_list|,
name|al_bool
name|full_duplex
parameter_list|)
block|{
name|uint32_t
name|if_mode
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|if_mode
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|if_mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|force_1000_base_x
condition|)
block|{
name|uint32_t
name|control
decl_stmt|;
name|AL_REG_MASK_CLEAR
argument_list|(
name|if_mode
argument_list|,
name|ETH_10G_MAC_IF_MODE_SGMII_EN_MASK
argument_list|)
expr_stmt|;
name|control
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|control
argument_list|)
expr_stmt|;
if|if
condition|(
name|an_enable
condition|)
name|AL_REG_MASK_SET
argument_list|(
name|control
argument_list|,
name|ETH_10G_MAC_CONTROL_AN_EN_MASK
argument_list|)
expr_stmt|;
else|else
name|AL_REG_MASK_CLEAR
argument_list|(
name|control
argument_list|,
name|ETH_10G_MAC_CONTROL_AN_EN_MASK
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|control
argument_list|,
name|control
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|AL_REG_MASK_SET
argument_list|(
name|if_mode
argument_list|,
name|ETH_10G_MAC_IF_MODE_SGMII_EN_MASK
argument_list|)
expr_stmt|;
if|if
condition|(
name|an_enable
condition|)
block|{
name|AL_REG_MASK_SET
argument_list|(
name|if_mode
argument_list|,
name|ETH_10G_MAC_IF_MODE_SGMII_AN_MASK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|AL_REG_MASK_CLEAR
argument_list|(
name|if_mode
argument_list|,
name|ETH_10G_MAC_IF_MODE_SGMII_AN_MASK
argument_list|)
expr_stmt|;
if|if
condition|(
name|speed
operator|==
literal|1000
condition|)
name|val
operator|=
name|ETH_10G_MAC_IF_MODE_SGMII_SPEED_1G
expr_stmt|;
elseif|else
if|if
condition|(
name|speed
operator|==
literal|100
condition|)
name|val
operator|=
name|ETH_10G_MAC_IF_MODE_SGMII_SPEED_100M
expr_stmt|;
else|else
name|val
operator|=
name|ETH_10G_MAC_IF_MODE_SGMII_SPEED_10M
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|if_mode
argument_list|,
name|ETH_10G_MAC_IF_MODE_SGMII_SPEED_MASK
argument_list|,
name|ETH_10G_MAC_IF_MODE_SGMII_SPEED_SHIFT
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|if_mode
argument_list|,
name|ETH_10G_MAC_IF_MODE_SGMII_DUPLEX_MASK
argument_list|,
name|ETH_10G_MAC_IF_MODE_SGMII_DUPLEX_SHIFT
argument_list|,
operator|(
operator|(
name|full_duplex
operator|)
condition|?
name|ETH_10G_MAC_IF_MODE_SGMII_DUPLEX_FULL
else|:
name|ETH_10G_MAC_IF_MODE_SGMII_DUPLEX_HALF
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|if_mode
argument_list|,
name|if_mode
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* update link speed and duplex mode */
end_comment

begin_function
name|int
name|al_eth_mac_link_config
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|al_bool
name|force_1000_base_x
parameter_list|,
name|al_bool
name|an_enable
parameter_list|,
name|uint32_t
name|speed
parameter_list|,
name|al_bool
name|full_duplex
parameter_list|)
block|{
if|if
condition|(
operator|(
operator|!
name|AL_ETH_IS_1G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
operator|)
operator|&&
operator|(
name|adapter
operator|->
name|mac_mode
operator|!=
name|AL_ETH_MAC_MODE_SGMII_2_5G
operator|)
condition|)
block|{
name|al_err
argument_list|(
literal|"eth [%s]: this function not supported in this mac mode.\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|adapter
operator|->
name|mac_mode
operator|!=
name|AL_ETH_MAC_MODE_RGMII
operator|)
operator|&&
operator|(
name|an_enable
operator|)
condition|)
block|{
comment|/* 		 * an_enable is not relevant to RGMII mode. 		 * in AN mode speed and duplex aren't relevant. 		 */
name|al_info
argument_list|(
literal|"eth [%s]: set auto negotiation to enable\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|al_info
argument_list|(
literal|"eth [%s]: set link speed to %dMbps. %s duplex.\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|speed
argument_list|,
name|full_duplex
operator|==
name|AL_TRUE
condition|?
literal|"full"
else|:
literal|"half"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|speed
operator|!=
literal|10
operator|)
operator|&&
operator|(
name|speed
operator|!=
literal|100
operator|)
operator|&&
operator|(
name|speed
operator|!=
literal|1000
operator|)
condition|)
block|{
name|al_err
argument_list|(
literal|"eth [%s]: bad speed parameter (%d).\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|speed
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|speed
operator|==
literal|1000
operator|)
operator|&&
operator|(
name|full_duplex
operator|==
name|AL_FALSE
operator|)
condition|)
block|{
name|al_err
argument_list|(
literal|"eth [%s]: half duplex in 1Gbps is not supported.\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
if|if
condition|(
name|AL_ETH_IS_1G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
condition|)
name|al_eth_mac_link_config_1g_mac
argument_list|(
name|adapter
argument_list|,
name|force_1000_base_x
argument_list|,
name|an_enable
argument_list|,
name|speed
argument_list|,
name|full_duplex
argument_list|)
expr_stmt|;
else|else
name|al_eth_mac_link_config_10g_mac
argument_list|(
name|adapter
argument_list|,
name|force_1000_base_x
argument_list|,
name|an_enable
argument_list|,
name|speed
argument_list|,
name|full_duplex
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_mac_loopback_config
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|int
name|enable
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|state
init|=
operator|(
name|enable
operator|)
condition|?
literal|"enable"
else|:
literal|"disable"
decl_stmt|;
name|al_dbg
argument_list|(
literal|"eth [%s]: loopback %s\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|state
argument_list|)
expr_stmt|;
if|if
condition|(
name|AL_ETH_IS_1G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
condition|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|cmd_cfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
condition|)
name|reg
operator||=
name|AL_BIT
argument_list|(
literal|15
argument_list|)
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|AL_BIT
argument_list|(
literal|15
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|cmd_cfg
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|AL_ETH_IS_10G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
operator|||
name|AL_ETH_IS_25G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
operator|)
operator|&&
operator|(
name|adapter
operator|->
name|rev_id
operator|==
name|AL_ETH_REV_ID_3
operator|)
condition|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|al_reg_write16
argument_list|(
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|kr
operator|.
name|pcs_addr
argument_list|,
name|ETH_MAC_KR_PCS_CONTROL_1_ADDR
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read16
argument_list|(
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|kr
operator|.
name|pcs_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
condition|)
name|reg
operator||=
name|AL_BIT
argument_list|(
literal|14
argument_list|)
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|AL_BIT
argument_list|(
literal|14
argument_list|)
expr_stmt|;
name|al_reg_write16
argument_list|(
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|kr
operator|.
name|pcs_addr
argument_list|,
name|ETH_MAC_KR_PCS_CONTROL_1_ADDR
argument_list|)
expr_stmt|;
name|al_reg_write16
argument_list|(
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|kr
operator|.
name|pcs_data
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|adapter
operator|->
name|mac_mode
operator|==
name|AL_ETH_MAC_MODE_XLG_LL_40G
operator|||
operator|(
name|adapter
operator|->
name|mac_mode
operator|==
name|AL_ETH_MAC_MODE_XLG_LL_50G
operator|)
condition|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|reg
operator|=
name|al_eth_40g_pcs_reg_read
argument_list|(
name|adapter
argument_list|,
name|ETH_MAC_GEN_V3_PCS_40G_CONTROL_STATUS_ADDR
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
condition|)
name|reg
operator||=
name|AL_BIT
argument_list|(
literal|14
argument_list|)
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|AL_BIT
argument_list|(
literal|14
argument_list|)
expr_stmt|;
name|al_eth_40g_pcs_reg_write
argument_list|(
name|adapter
argument_list|,
name|ETH_MAC_GEN_V3_PCS_40G_CONTROL_STATUS_ADDR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|al_err
argument_list|(
literal|"Eth: mac loopback not supported in this mode %d"
argument_list|,
name|adapter
operator|->
name|mac_mode
argument_list|)
expr_stmt|;
return|return
operator|-
name|EPERM
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* MDIO */
end_comment

begin_function
name|int
name|al_eth_mdio_config
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|enum
name|al_eth_mdio_type
name|mdio_type
parameter_list|,
name|al_bool
name|shared_mdio_if
parameter_list|,
name|enum
name|al_eth_ref_clk_freq
name|ref_clk_freq
parameter_list|,
name|unsigned
name|int
name|mdio_clk_freq_khz
parameter_list|)
block|{
name|enum
name|al_eth_mdio_if
name|mdio_if
init|=
name|AL_ETH_MDIO_IF_10G_MAC
decl_stmt|;
specifier|const
name|char
modifier|*
name|if_name
init|=
operator|(
name|mdio_if
operator|==
name|AL_ETH_MDIO_IF_1G_MAC
operator|)
condition|?
literal|"10/100/1G MAC"
else|:
literal|"10G MAC"
decl_stmt|;
specifier|const
name|char
modifier|*
name|type_name
init|=
operator|(
name|mdio_type
operator|==
name|AL_ETH_MDIO_TYPE_CLAUSE_22
operator|)
condition|?
literal|"Clause 22"
else|:
literal|"Clause 45"
decl_stmt|;
specifier|const
name|char
modifier|*
name|shared_name
init|=
operator|(
name|shared_mdio_if
operator|==
name|AL_TRUE
operator|)
condition|?
literal|"Yes"
else|:
literal|"No"
decl_stmt|;
name|unsigned
name|int
name|ref_clk_freq_khz
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|al_dbg
argument_list|(
literal|"eth [%s]: mdio config: interface %s. type %s. shared: %s\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|if_name
argument_list|,
name|type_name
argument_list|,
name|shared_name
argument_list|)
expr_stmt|;
name|adapter
operator|->
name|shared_mdio_if
operator|=
name|shared_mdio_if
expr_stmt|;
name|val
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|cfg
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"eth [%s]: mdio config: 10G mac \n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mdio_if
condition|)
block|{
case|case
name|AL_ETH_MDIO_IF_1G_MAC
case|:
name|val
operator|&=
operator|~
name|AL_BIT
argument_list|(
literal|10
argument_list|)
expr_stmt|;
break|break;
case|case
name|AL_ETH_MDIO_IF_10G_MAC
case|:
name|val
operator||=
name|AL_BIT
argument_list|(
literal|10
argument_list|)
expr_stmt|;
break|break;
block|}
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|cfg
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|adapter
operator|->
name|mdio_if
operator|=
name|mdio_if
expr_stmt|;
if|if
condition|(
name|mdio_if
operator|==
name|AL_ETH_MDIO_IF_10G_MAC
condition|)
block|{
name|val
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|mdio_cfg_status
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mdio_type
condition|)
block|{
case|case
name|AL_ETH_MDIO_TYPE_CLAUSE_22
case|:
name|val
operator|&=
operator|~
name|AL_BIT
argument_list|(
literal|6
argument_list|)
expr_stmt|;
break|break;
case|case
name|AL_ETH_MDIO_TYPE_CLAUSE_45
case|:
name|val
operator||=
name|AL_BIT
argument_list|(
literal|6
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* set clock div to get 'mdio_clk_freq_khz' */
switch|switch
condition|(
name|ref_clk_freq
condition|)
block|{
default|default:
name|al_err
argument_list|(
literal|"eth [%s]: %s: invalid reference clock frequency"
literal|" (%d)\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|__func__
argument_list|,
name|ref_clk_freq
argument_list|)
expr_stmt|;
case|case
name|AL_ETH_REF_FREQ_375_MHZ
case|:
name|ref_clk_freq_khz
operator|=
literal|375000
expr_stmt|;
break|break;
case|case
name|AL_ETH_REF_FREQ_187_5_MHZ
case|:
name|ref_clk_freq_khz
operator|=
literal|187500
expr_stmt|;
break|break;
case|case
name|AL_ETH_REF_FREQ_250_MHZ
case|:
name|ref_clk_freq_khz
operator|=
literal|250000
expr_stmt|;
break|break;
case|case
name|AL_ETH_REF_FREQ_500_MHZ
case|:
name|ref_clk_freq_khz
operator|=
literal|500000
expr_stmt|;
break|break;
case|case
name|AL_ETH_REF_FREQ_428_MHZ
case|:
name|ref_clk_freq_khz
operator|=
literal|428000
expr_stmt|;
break|break;
block|}
empty_stmt|;
name|val
operator|&=
operator|~
operator|(
literal|0x1FF
operator|<<
literal|7
operator|)
expr_stmt|;
name|val
operator||=
operator|(
name|ref_clk_freq_khz
operator|/
operator|(
literal|2
operator|*
name|mdio_clk_freq_khz
operator|)
operator|)
operator|<<
literal|7
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|val
argument_list|,
name|ETH_10G_MAC_MDIO_CFG_HOLD_TIME_MASK
argument_list|,
name|ETH_10G_MAC_MDIO_CFG_HOLD_TIME_SHIFT
argument_list|,
name|ETH_10G_MAC_MDIO_CFG_HOLD_TIME_7_CLK
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|mdio_cfg_status
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|mdio_type
operator|!=
name|AL_ETH_MDIO_TYPE_CLAUSE_22
condition|)
block|{
name|al_err
argument_list|(
literal|"eth [%s] mdio type not supported for this interface\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
name|adapter
operator|->
name|mdio_type
operator|=
name|mdio_type
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|int
name|al_eth_mdio_1g_mac_read
argument_list|(
expr|struct
name|al_hal_eth_adapter
operator|*
name|adapter
argument_list|,
name|uint32_t
name|phy_addr
name|__attribute__
argument_list|(
operator|(
name|__unused__
operator|)
argument_list|)
argument_list|,
name|uint32_t
name|reg
argument_list|,
name|uint16_t
operator|*
name|val
argument_list|)
block|{
operator|*
name|val
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|phy_regs_base
operator|+
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|al_eth_mdio_1g_mac_write
argument_list|(
expr|struct
name|al_hal_eth_adapter
operator|*
name|adapter
argument_list|,
name|uint32_t
name|phy_addr
name|__attribute__
argument_list|(
operator|(
name|__unused__
operator|)
argument_list|)
argument_list|,
name|uint32_t
name|reg
argument_list|,
name|uint16_t
name|val
argument_list|)
block|{
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|phy_regs_base
operator|+
name|reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_decl_stmt

begin_function
specifier|static
name|int
name|al_eth_mdio_10g_mac_wait_busy
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|)
block|{
name|int
name|count
init|=
literal|0
decl_stmt|;
name|uint32_t
name|mdio_cfg_status
decl_stmt|;
do|do
block|{
name|mdio_cfg_status
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|mdio_cfg_status
argument_list|)
expr_stmt|;
comment|/* 		if (mdio_cfg_status& AL_BIT(1)){ //error 			al_err(" %s mdio read failed on error. phy_addr 0x%x reg 0x%x\n", 				udma_params.name, phy_addr, reg); 			return -EIO; 		}*/
if|if
condition|(
name|mdio_cfg_status
operator|&
name|AL_BIT
argument_list|(
literal|0
argument_list|)
condition|)
block|{
if|if
condition|(
name|count
operator|>
literal|0
condition|)
name|al_dbg
argument_list|(
literal|"eth [%s] mdio: still busy!\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
return|return
literal|0
return|;
block|}
name|al_udelay
argument_list|(
name|AL_ETH_MDIO_DELAY_PERIOD
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|count
operator|++
operator|<
name|AL_ETH_MDIO_DELAY_COUNT
condition|)
do|;
return|return
operator|-
name|ETIMEDOUT
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|al_eth_mdio_10g_mac_type22
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|int
name|read
parameter_list|,
name|uint32_t
name|phy_addr
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint16_t
modifier|*
name|val
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
specifier|const
name|char
modifier|*
name|op
init|=
operator|(
name|read
operator|==
literal|1
operator|)
condition|?
literal|"read"
else|:
literal|"write"
decl_stmt|;
name|uint32_t
name|mdio_cfg_status
decl_stmt|;
name|uint16_t
name|mdio_cmd
decl_stmt|;
comment|//wait if the HW is busy
name|rc
operator|=
name|al_eth_mdio_10g_mac_wait_busy
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|al_err
argument_list|(
literal|" eth [%s] mdio %s failed. HW is busy\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|op
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
name|mdio_cmd
operator|=
call|(
name|uint16_t
call|)
argument_list|(
literal|0x1F
operator|&
name|reg
argument_list|)
expr_stmt|;
name|mdio_cmd
operator||=
operator|(
literal|0x1F
operator|&
name|phy_addr
operator|)
operator|<<
literal|5
expr_stmt|;
if|if
condition|(
name|read
condition|)
name|mdio_cmd
operator||=
name|AL_BIT
argument_list|(
literal|15
argument_list|)
expr_stmt|;
comment|//READ command
name|al_reg_write16
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|mdio_cmd
argument_list|,
name|mdio_cmd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|read
condition|)
name|al_reg_write16
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|mdio_data
argument_list|,
operator|*
name|val
argument_list|)
expr_stmt|;
comment|//wait for the busy to clear
name|rc
operator|=
name|al_eth_mdio_10g_mac_wait_busy
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
name|al_err
argument_list|(
literal|" %s mdio %s failed on timeout\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|op
argument_list|)
expr_stmt|;
return|return
operator|-
name|ETIMEDOUT
return|;
block|}
name|mdio_cfg_status
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|mdio_cfg_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|mdio_cfg_status
operator|&
name|AL_BIT
argument_list|(
literal|1
argument_list|)
condition|)
block|{
comment|//error
name|al_err
argument_list|(
literal|" %s mdio %s failed on error. phy_addr 0x%x reg 0x%x\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|op
argument_list|,
name|phy_addr
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EIO
return|;
block|}
if|if
condition|(
name|read
condition|)
operator|*
name|val
operator|=
name|al_reg_read16
argument_list|(
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|mdio_data
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|al_eth_mdio_10g_mac_type45
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|int
name|read
parameter_list|,
name|uint32_t
name|port_addr
parameter_list|,
name|uint32_t
name|device
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint16_t
modifier|*
name|val
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
specifier|const
name|char
modifier|*
name|op
init|=
operator|(
name|read
operator|==
literal|1
operator|)
condition|?
literal|"read"
else|:
literal|"write"
decl_stmt|;
name|uint32_t
name|mdio_cfg_status
decl_stmt|;
name|uint16_t
name|mdio_cmd
decl_stmt|;
comment|//wait if the HW is busy
name|rc
operator|=
name|al_eth_mdio_10g_mac_wait_busy
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|al_err
argument_list|(
literal|" %s mdio %s failed. HW is busy\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|op
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
comment|// set command register
name|mdio_cmd
operator|=
call|(
name|uint16_t
call|)
argument_list|(
literal|0x1F
operator|&
name|device
argument_list|)
expr_stmt|;
name|mdio_cmd
operator||=
operator|(
literal|0x1F
operator|&
name|port_addr
operator|)
operator|<<
literal|5
expr_stmt|;
name|al_reg_write16
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|mdio_cmd
argument_list|,
name|mdio_cmd
argument_list|)
expr_stmt|;
comment|// send address frame
name|al_reg_write16
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|mdio_regaddr
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|//wait for the busy to clear
name|rc
operator|=
name|al_eth_mdio_10g_mac_wait_busy
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|al_err
argument_list|(
literal|" %s mdio %s (address frame) failed on timeout\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|op
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
comment|// if read, write again to the command register with READ bit set
if|if
condition|(
name|read
condition|)
block|{
name|mdio_cmd
operator||=
name|AL_BIT
argument_list|(
literal|15
argument_list|)
expr_stmt|;
comment|//READ command
name|al_reg_write16
argument_list|(
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|mdio_cmd
argument_list|,
name|mdio_cmd
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|al_reg_write16
argument_list|(
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|mdio_data
argument_list|,
operator|*
name|val
argument_list|)
expr_stmt|;
block|}
comment|//wait for the busy to clear
name|rc
operator|=
name|al_eth_mdio_10g_mac_wait_busy
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
block|{
name|al_err
argument_list|(
literal|" %s mdio %s failed on timeout\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|op
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
name|mdio_cfg_status
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|mdio_cfg_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|mdio_cfg_status
operator|&
name|AL_BIT
argument_list|(
literal|1
argument_list|)
condition|)
block|{
comment|//error
name|al_err
argument_list|(
literal|" %s mdio %s failed on error. port 0x%x, device 0x%x reg 0x%x\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|op
argument_list|,
name|port_addr
argument_list|,
name|device
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
operator|-
name|EIO
return|;
block|}
if|if
condition|(
name|read
condition|)
operator|*
name|val
operator|=
name|al_reg_read16
argument_list|(
operator|(
name|uint16_t
operator|*
operator|)
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|mdio_data
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * acquire mdio interface ownership  * when mdio interface shared between multiple eth controllers, this function waits until the ownership granted for this controller.  * this function does nothing when the mdio interface is used only by this controller.  *  * @param adapter  * @return 0 on success, -ETIMEDOUT  on timeout.  */
end_comment

begin_function
specifier|static
name|int
name|al_eth_mdio_lock
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|)
block|{
name|int
name|count
init|=
literal|0
decl_stmt|;
name|uint32_t
name|mdio_ctrl_1
decl_stmt|;
if|if
condition|(
name|adapter
operator|->
name|shared_mdio_if
operator|==
name|AL_FALSE
condition|)
return|return
literal|0
return|;
comment|/* nothing to do when interface is not shared */
do|do
block|{
name|mdio_ctrl_1
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|mdio_ctrl_1
argument_list|)
expr_stmt|;
comment|/* 		if (mdio_cfg_status& AL_BIT(1)){ //error 			al_err(" %s mdio read failed on error. phy_addr 0x%x reg 0x%x\n", 				udma_params.name, phy_addr, reg); 			return -EIO; 		}*/
if|if
condition|(
name|mdio_ctrl_1
operator|&
name|AL_BIT
argument_list|(
literal|0
argument_list|)
condition|)
block|{
if|if
condition|(
name|count
operator|>
literal|0
condition|)
name|al_dbg
argument_list|(
literal|"eth %s mdio interface still busy!\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
return|return
literal|0
return|;
block|}
name|al_udelay
argument_list|(
name|AL_ETH_MDIO_DELAY_PERIOD
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|count
operator|++
operator|<
operator|(
name|AL_ETH_MDIO_DELAY_COUNT
operator|*
literal|4
operator|)
condition|)
do|;
name|al_err
argument_list|(
literal|" %s mdio failed to take ownership. MDIO info reg: 0x%08x\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|mdio_1
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
name|ETIMEDOUT
return|;
block|}
end_function

begin_comment
comment|/**  * free mdio interface ownership  * when mdio interface shared between multiple eth controllers, this function releases the ownership granted for this controller.  * this function does nothing when the mdio interface is used only by this controller.  *  * @param adapter  * @return 0.  */
end_comment

begin_function
specifier|static
name|int
name|al_eth_mdio_free
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|)
block|{
if|if
condition|(
name|adapter
operator|->
name|shared_mdio_if
operator|==
name|AL_FALSE
condition|)
return|return
literal|0
return|;
comment|/* nothing to do when interface is not shared */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|mdio_ctrl_1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * Addressing RMN: 2917 	 * 	 * RMN description: 	 * The HW spin-lock is stateless and doesn't maintain any scheduling 	 * policy. 	 * 	 * Software flow: 	 * After getting the lock wait 2 times the delay period in order to give 	 * the other port chance to take the lock and prevent starvation. 	 * This is not scalable to more than two ports. 	 */
name|al_udelay
argument_list|(
literal|2
operator|*
name|AL_ETH_MDIO_DELAY_PERIOD
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_mdio_read
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|phy_addr
parameter_list|,
name|uint32_t
name|device
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint16_t
modifier|*
name|val
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|rc
operator|=
name|al_eth_mdio_lock
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
comment|/*"interface ownership taken"*/
if|if
condition|(
name|rc
condition|)
return|return
name|rc
return|;
if|if
condition|(
name|adapter
operator|->
name|mdio_if
operator|==
name|AL_ETH_MDIO_IF_1G_MAC
condition|)
name|rc
operator|=
name|al_eth_mdio_1g_mac_read
argument_list|(
name|adapter
argument_list|,
name|phy_addr
argument_list|,
name|reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|adapter
operator|->
name|mdio_type
operator|==
name|AL_ETH_MDIO_TYPE_CLAUSE_22
condition|)
name|rc
operator|=
name|al_eth_mdio_10g_mac_type22
argument_list|(
name|adapter
argument_list|,
literal|1
argument_list|,
name|phy_addr
argument_list|,
name|reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
else|else
name|rc
operator|=
name|al_eth_mdio_10g_mac_type45
argument_list|(
name|adapter
argument_list|,
literal|1
argument_list|,
name|phy_addr
argument_list|,
name|device
argument_list|,
name|reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|al_eth_mdio_free
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"eth mdio read: phy_addr %x, device %x, reg %x val %x\n"
argument_list|,
name|phy_addr
argument_list|,
name|device
argument_list|,
name|reg
argument_list|,
operator|*
name|val
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|al_eth_mdio_write
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|phy_addr
parameter_list|,
name|uint32_t
name|device
parameter_list|,
name|uint32_t
name|reg
parameter_list|,
name|uint16_t
name|val
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|al_dbg
argument_list|(
literal|"eth mdio write: phy_addr %x, device %x, reg %x, val %x\n"
argument_list|,
name|phy_addr
argument_list|,
name|device
argument_list|,
name|reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|rc
operator|=
name|al_eth_mdio_lock
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
comment|/* interface ownership taken */
if|if
condition|(
name|rc
condition|)
return|return
name|rc
return|;
if|if
condition|(
name|adapter
operator|->
name|mdio_if
operator|==
name|AL_ETH_MDIO_IF_1G_MAC
condition|)
name|rc
operator|=
name|al_eth_mdio_1g_mac_write
argument_list|(
name|adapter
argument_list|,
name|phy_addr
argument_list|,
name|reg
argument_list|,
name|val
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|adapter
operator|->
name|mdio_type
operator|==
name|AL_ETH_MDIO_TYPE_CLAUSE_22
condition|)
name|rc
operator|=
name|al_eth_mdio_10g_mac_type22
argument_list|(
name|adapter
argument_list|,
literal|0
argument_list|,
name|phy_addr
argument_list|,
name|reg
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
else|else
name|rc
operator|=
name|al_eth_mdio_10g_mac_type45
argument_list|(
name|adapter
argument_list|,
literal|0
argument_list|,
name|phy_addr
argument_list|,
name|device
argument_list|,
name|reg
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
name|al_eth_mdio_free
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|al_dump_tx_desc
parameter_list|(
name|union
name|al_udma_desc
modifier|*
name|tx_desc
parameter_list|)
block|{
name|uint32_t
modifier|*
name|ptr
init|=
operator|(
name|uint32_t
operator|*
operator|)
name|tx_desc
decl_stmt|;
name|al_dbg
argument_list|(
literal|"eth tx desc:\n"
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"0x%08x\n"
argument_list|,
operator|*
operator|(
name|ptr
operator|++
operator|)
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"0x%08x\n"
argument_list|,
operator|*
operator|(
name|ptr
operator|++
operator|)
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"0x%08x\n"
argument_list|,
operator|*
operator|(
name|ptr
operator|++
operator|)
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"0x%08x\n"
argument_list|,
operator|*
operator|(
name|ptr
operator|++
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|al_dump_tx_pkt
parameter_list|(
name|struct
name|al_udma_q
modifier|*
name|tx_dma_q
parameter_list|,
name|struct
name|al_eth_pkt
modifier|*
name|pkt
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|tso
init|=
operator|(
name|pkt
operator|->
name|flags
operator|&
name|AL_ETH_TX_FLAGS_TSO
operator|)
condition|?
literal|"TSO"
else|:
literal|""
decl_stmt|;
specifier|const
name|char
modifier|*
name|l3_csum
init|=
operator|(
name|pkt
operator|->
name|flags
operator|&
name|AL_ETH_TX_FLAGS_IPV4_L3_CSUM
operator|)
condition|?
literal|"L3 CSUM"
else|:
literal|""
decl_stmt|;
specifier|const
name|char
modifier|*
name|l4_csum
init|=
operator|(
name|pkt
operator|->
name|flags
operator|&
name|AL_ETH_TX_FLAGS_L4_CSUM
operator|)
condition|?
operator|(
operator|(
name|pkt
operator|->
name|flags
operator|&
name|AL_ETH_TX_FLAGS_L4_PARTIAL_CSUM
operator|)
condition|?
literal|"L4 PARTIAL CSUM"
else|:
literal|"L4 FULL CSUM"
operator|)
else|:
literal|""
decl_stmt|;
specifier|const
name|char
modifier|*
name|fcs
init|=
operator|(
name|pkt
operator|->
name|flags
operator|&
name|AL_ETH_TX_FLAGS_L2_DIS_FCS
operator|)
condition|?
literal|"Disable FCS"
else|:
literal|""
decl_stmt|;
specifier|const
name|char
modifier|*
name|ptp
init|=
operator|(
name|pkt
operator|->
name|flags
operator|&
name|AL_ETH_TX_FLAGS_TS
operator|)
condition|?
literal|"TX_PTP"
else|:
literal|""
decl_stmt|;
specifier|const
name|char
modifier|*
name|l3_proto_name
init|=
literal|"unknown"
decl_stmt|;
specifier|const
name|char
modifier|*
name|l4_proto_name
init|=
literal|"unknown"
decl_stmt|;
specifier|const
name|char
modifier|*
name|outer_l3_proto_name
init|=
literal|"N/A"
decl_stmt|;
specifier|const
name|char
modifier|*
name|tunnel_mode
init|=
operator|(
operator|(
operator|(
name|pkt
operator|->
name|tunnel_mode
operator|&
name|AL_ETH_TUNNEL_WITH_UDP
operator|)
operator|==
name|AL_ETH_TUNNEL_WITH_UDP
operator|)
condition|?
literal|"TUNNEL_WITH_UDP"
else|:
operator|(
operator|(
operator|(
name|pkt
operator|->
name|tunnel_mode
operator|&
name|AL_ETH_TUNNEL_NO_UDP
operator|)
operator|==
name|AL_ETH_TUNNEL_NO_UDP
operator|)
condition|?
literal|"TUNNEL_NO_UDP"
else|:
literal|""
operator|)
operator|)
decl_stmt|;
name|uint32_t
name|total_len
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|al_dbg
argument_list|(
literal|"[%s %d]: flags: %s %s %s %s %s %s\n"
argument_list|,
name|tx_dma_q
operator|->
name|udma
operator|->
name|name
argument_list|,
name|tx_dma_q
operator|->
name|qid
argument_list|,
name|tso
argument_list|,
name|l3_csum
argument_list|,
name|l4_csum
argument_list|,
name|fcs
argument_list|,
name|ptp
argument_list|,
name|tunnel_mode
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|pkt
operator|->
name|l3_proto_idx
condition|)
block|{
case|case
name|AL_ETH_PROTO_ID_IPv4
case|:
name|l3_proto_name
operator|=
literal|"IPv4"
expr_stmt|;
break|break;
case|case
name|AL_ETH_PROTO_ID_IPv6
case|:
name|l3_proto_name
operator|=
literal|"IPv6"
expr_stmt|;
break|break;
default|default:
name|l3_proto_name
operator|=
literal|"unknown"
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|pkt
operator|->
name|l4_proto_idx
condition|)
block|{
case|case
name|AL_ETH_PROTO_ID_TCP
case|:
name|l4_proto_name
operator|=
literal|"TCP"
expr_stmt|;
break|break;
case|case
name|AL_ETH_PROTO_ID_UDP
case|:
name|l4_proto_name
operator|=
literal|"UDP"
expr_stmt|;
break|break;
default|default:
name|l4_proto_name
operator|=
literal|"unknown"
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|pkt
operator|->
name|outer_l3_proto_idx
condition|)
block|{
case|case
name|AL_ETH_PROTO_ID_IPv4
case|:
name|outer_l3_proto_name
operator|=
literal|"IPv4"
expr_stmt|;
break|break;
case|case
name|AL_ETH_PROTO_ID_IPv6
case|:
name|outer_l3_proto_name
operator|=
literal|"IPv6"
expr_stmt|;
break|break;
default|default:
name|outer_l3_proto_name
operator|=
literal|"N/A"
expr_stmt|;
break|break;
block|}
name|al_dbg
argument_list|(
literal|"[%s %d]: L3 proto: %d (%s). L4 proto: %d (%s). Outer_L3 proto: %d (%s). vlan source count %d. mod add %d. mod del %d\n"
argument_list|,
name|tx_dma_q
operator|->
name|udma
operator|->
name|name
argument_list|,
name|tx_dma_q
operator|->
name|qid
argument_list|,
name|pkt
operator|->
name|l3_proto_idx
argument_list|,
name|l3_proto_name
argument_list|,
name|pkt
operator|->
name|l4_proto_idx
argument_list|,
name|l4_proto_name
argument_list|,
name|pkt
operator|->
name|outer_l3_proto_idx
argument_list|,
name|outer_l3_proto_name
argument_list|,
name|pkt
operator|->
name|source_vlan_count
argument_list|,
name|pkt
operator|->
name|vlan_mod_add_count
argument_list|,
name|pkt
operator|->
name|vlan_mod_del_count
argument_list|)
expr_stmt|;
if|if
condition|(
name|pkt
operator|->
name|meta
condition|)
block|{
specifier|const
name|char
modifier|*
name|store
init|=
name|pkt
operator|->
name|meta
operator|->
name|store
condition|?
literal|"Yes"
else|:
literal|"No"
decl_stmt|;
specifier|const
name|char
modifier|*
name|ptp_val
init|=
operator|(
name|pkt
operator|->
name|flags
operator|&
name|AL_ETH_TX_FLAGS_TS
operator|)
condition|?
literal|"Yes"
else|:
literal|"No"
decl_stmt|;
name|al_dbg
argument_list|(
literal|"[%s %d]: tx pkt with meta data. words valid %x\n"
argument_list|,
name|tx_dma_q
operator|->
name|udma
operator|->
name|name
argument_list|,
name|tx_dma_q
operator|->
name|qid
argument_list|,
name|pkt
operator|->
name|meta
operator|->
name|words_valid
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"[%s %d]: meta: store to cache %s. l3 hdr len %d. l3 hdr offset %d. "
literal|"l4 hdr len %d. mss val %d ts_index %d ts_val:%s\n"
argument_list|,
name|tx_dma_q
operator|->
name|udma
operator|->
name|name
argument_list|,
name|tx_dma_q
operator|->
name|qid
argument_list|,
name|store
argument_list|,
name|pkt
operator|->
name|meta
operator|->
name|l3_header_len
argument_list|,
name|pkt
operator|->
name|meta
operator|->
name|l3_header_offset
argument_list|,
name|pkt
operator|->
name|meta
operator|->
name|l4_header_len
argument_list|,
name|pkt
operator|->
name|meta
operator|->
name|mss_val
argument_list|,
name|pkt
operator|->
name|meta
operator|->
name|ts_index
argument_list|,
name|ptp_val
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"outer_l3_hdr_offset %d. outer_l3_len %d.\n"
argument_list|,
name|pkt
operator|->
name|meta
operator|->
name|outer_l3_offset
argument_list|,
name|pkt
operator|->
name|meta
operator|->
name|outer_l3_len
argument_list|)
expr_stmt|;
block|}
name|al_dbg
argument_list|(
literal|"[%s %d]: num of bufs: %d\n"
argument_list|,
name|tx_dma_q
operator|->
name|udma
operator|->
name|name
argument_list|,
name|tx_dma_q
operator|->
name|qid
argument_list|,
name|pkt
operator|->
name|num_of_bufs
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pkt
operator|->
name|num_of_bufs
condition|;
name|i
operator|++
control|)
block|{
name|al_dbg
argument_list|(
literal|"eth [%s %d]: buf[%d]: len 0x%08x. address 0x%016llx\n"
argument_list|,
name|tx_dma_q
operator|->
name|udma
operator|->
name|name
argument_list|,
name|tx_dma_q
operator|->
name|qid
argument_list|,
name|i
argument_list|,
name|pkt
operator|->
name|bufs
index|[
name|i
index|]
operator|.
name|len
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|pkt
operator|->
name|bufs
index|[
name|i
index|]
operator|.
name|addr
argument_list|)
expr_stmt|;
name|total_len
operator|+=
name|pkt
operator|->
name|bufs
index|[
name|i
index|]
operator|.
name|len
expr_stmt|;
block|}
name|al_dbg
argument_list|(
literal|"[%s %d]: total len: 0x%08x\n"
argument_list|,
name|tx_dma_q
operator|->
name|udma
operator|->
name|name
argument_list|,
name|tx_dma_q
operator|->
name|qid
argument_list|,
name|total_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* TX */
end_comment

begin_comment
comment|/**  * add packet to transmission queue  */
end_comment

begin_function
name|int
name|al_eth_tx_pkt_prepare
parameter_list|(
name|struct
name|al_udma_q
modifier|*
name|tx_dma_q
parameter_list|,
name|struct
name|al_eth_pkt
modifier|*
name|pkt
parameter_list|)
block|{
name|union
name|al_udma_desc
modifier|*
name|tx_desc
decl_stmt|;
name|uint32_t
name|tx_descs
decl_stmt|;
name|uint32_t
name|flags
init|=
name|AL_M2S_DESC_FIRST
operator||
name|AL_M2S_DESC_CONCAT
operator||
operator|(
name|pkt
operator|->
name|flags
operator|&
name|AL_ETH_TX_FLAGS_INT
operator|)
decl_stmt|;
name|uint64_t
name|tgtid
init|=
operator|(
operator|(
name|uint64_t
operator|)
name|pkt
operator|->
name|tgtid
operator|)
operator|<<
name|AL_UDMA_DESC_TGTID_SHIFT
decl_stmt|;
name|uint32_t
name|meta_ctrl
decl_stmt|;
name|uint32_t
name|ring_id
decl_stmt|;
name|int
name|buf_idx
decl_stmt|;
name|al_dbg
argument_list|(
literal|"[%s %d]: new tx pkt\n"
argument_list|,
name|tx_dma_q
operator|->
name|udma
operator|->
name|name
argument_list|,
name|tx_dma_q
operator|->
name|qid
argument_list|)
expr_stmt|;
name|al_dump_tx_pkt
argument_list|(
name|tx_dma_q
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
name|tx_descs
operator|=
name|pkt
operator|->
name|num_of_bufs
expr_stmt|;
if|if
condition|(
name|pkt
operator|->
name|meta
condition|)
block|{
name|tx_descs
operator|+=
literal|1
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|AL_ETH_EX
name|al_assert
argument_list|(
operator|(
name|pkt
operator|->
name|ext_meta_data
operator|==
name|NULL
operator|)
operator|||
operator|(
name|tx_dma_q
operator|->
name|adapter_rev_id
operator|>
name|AL_ETH_REV_ID_2
operator|)
argument_list|)
expr_stmt|;
name|tx_descs
operator|+=
name|al_eth_ext_metadata_needed_descs
argument_list|(
name|pkt
operator|->
name|ext_meta_data
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"[%s %d]: %d Descriptors: ext_meta (%d). meta (%d). buffer (%d) "
argument_list|,
name|tx_dma_q
operator|->
name|udma
operator|->
name|name
argument_list|,
name|tx_dma_q
operator|->
name|qid
argument_list|,
name|tx_descs
argument_list|,
name|al_eth_ext_metadata_needed_descs
argument_list|(
name|pkt
operator|->
name|ext_meta_data
argument_list|)
argument_list|,
operator|(
name|pkt
operator|->
name|meta
operator|!=
name|NULL
operator|)
argument_list|,
name|pkt
operator|->
name|num_of_bufs
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|unlikely
argument_list|(
name|al_udma_available_get
argument_list|(
name|tx_dma_q
argument_list|)
operator|<
name|tx_descs
argument_list|)
condition|)
block|{
name|al_dbg
argument_list|(
literal|"[%s %d]: failed to allocate (%d) descriptors"
argument_list|,
name|tx_dma_q
operator|->
name|udma
operator|->
name|name
argument_list|,
name|tx_dma_q
operator|->
name|qid
argument_list|,
name|tx_descs
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
ifdef|#
directive|ifdef
name|AL_ETH_EX
if|if
condition|(
name|pkt
operator|->
name|ext_meta_data
operator|!=
name|NULL
condition|)
block|{
name|al_eth_ext_metadata_create
argument_list|(
name|tx_dma_q
argument_list|,
operator|&
name|flags
argument_list|,
name|pkt
operator|->
name|ext_meta_data
argument_list|)
expr_stmt|;
name|flags
operator|&=
operator|~
operator|(
name|AL_M2S_DESC_FIRST
operator||
name|AL_ETH_TX_FLAGS_INT
operator|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|pkt
operator|->
name|meta
condition|)
block|{
name|uint32_t
name|meta_word_0
init|=
literal|0
decl_stmt|;
name|uint32_t
name|meta_word_1
init|=
literal|0
decl_stmt|;
name|uint32_t
name|meta_word_2
init|=
literal|0
decl_stmt|;
name|uint32_t
name|meta_word_3
init|=
literal|0
decl_stmt|;
name|meta_word_0
operator||=
name|flags
operator||
name|AL_M2S_DESC_META_DATA
expr_stmt|;
name|meta_word_0
operator|&=
operator|~
name|AL_M2S_DESC_CONCAT
expr_stmt|;
name|flags
operator|&=
operator|~
operator|(
name|AL_M2S_DESC_FIRST
operator||
name|AL_ETH_TX_FLAGS_INT
operator|)
expr_stmt|;
name|tx_desc
operator|=
name|al_udma_desc_get
argument_list|(
name|tx_dma_q
argument_list|)
expr_stmt|;
comment|/* get ring id, and clear FIRST and Int flags */
name|ring_id
operator|=
name|al_udma_ring_id_get
argument_list|(
name|tx_dma_q
argument_list|)
operator|<<
name|AL_M2S_DESC_RING_ID_SHIFT
expr_stmt|;
name|meta_word_0
operator||=
name|ring_id
expr_stmt|;
name|meta_word_0
operator||=
name|pkt
operator|->
name|meta
operator|->
name|words_valid
operator|<<
literal|12
expr_stmt|;
if|if
condition|(
name|pkt
operator|->
name|meta
operator|->
name|store
condition|)
name|meta_word_0
operator||=
name|AL_ETH_TX_META_STORE
expr_stmt|;
if|if
condition|(
name|pkt
operator|->
name|meta
operator|->
name|words_valid
operator|&
literal|1
condition|)
block|{
name|meta_word_0
operator||=
name|pkt
operator|->
name|meta
operator|->
name|vlan1_cfi_sel
expr_stmt|;
name|meta_word_0
operator||=
name|pkt
operator|->
name|meta
operator|->
name|vlan2_vid_sel
operator|<<
literal|2
expr_stmt|;
name|meta_word_0
operator||=
name|pkt
operator|->
name|meta
operator|->
name|vlan2_cfi_sel
operator|<<
literal|4
expr_stmt|;
name|meta_word_0
operator||=
name|pkt
operator|->
name|meta
operator|->
name|vlan2_pbits_sel
operator|<<
literal|6
expr_stmt|;
name|meta_word_0
operator||=
name|pkt
operator|->
name|meta
operator|->
name|vlan2_ether_sel
operator|<<
literal|8
expr_stmt|;
block|}
if|if
condition|(
name|pkt
operator|->
name|meta
operator|->
name|words_valid
operator|&
literal|2
condition|)
block|{
name|meta_word_1
operator|=
name|pkt
operator|->
name|meta
operator|->
name|vlan1_new_vid
expr_stmt|;
name|meta_word_1
operator||=
name|pkt
operator|->
name|meta
operator|->
name|vlan1_new_cfi
operator|<<
literal|12
expr_stmt|;
name|meta_word_1
operator||=
name|pkt
operator|->
name|meta
operator|->
name|vlan1_new_pbits
operator|<<
literal|13
expr_stmt|;
name|meta_word_1
operator||=
name|pkt
operator|->
name|meta
operator|->
name|vlan2_new_vid
operator|<<
literal|16
expr_stmt|;
name|meta_word_1
operator||=
name|pkt
operator|->
name|meta
operator|->
name|vlan2_new_cfi
operator|<<
literal|28
expr_stmt|;
name|meta_word_1
operator||=
name|pkt
operator|->
name|meta
operator|->
name|vlan2_new_pbits
operator|<<
literal|29
expr_stmt|;
block|}
if|if
condition|(
name|pkt
operator|->
name|meta
operator|->
name|words_valid
operator|&
literal|4
condition|)
block|{
name|uint32_t
name|l3_offset
decl_stmt|;
name|meta_word_2
operator|=
name|pkt
operator|->
name|meta
operator|->
name|l3_header_len
operator|&
name|AL_ETH_TX_META_L3_LEN_MASK
expr_stmt|;
name|meta_word_2
operator||=
operator|(
name|pkt
operator|->
name|meta
operator|->
name|l3_header_offset
operator|&
name|AL_ETH_TX_META_L3_OFF_MASK
operator|)
operator|<<
name|AL_ETH_TX_META_L3_OFF_SHIFT
expr_stmt|;
name|meta_word_2
operator||=
operator|(
name|pkt
operator|->
name|meta
operator|->
name|l4_header_len
operator|&
literal|0x3f
operator|)
operator|<<
literal|16
expr_stmt|;
if|if
condition|(
name|unlikely
argument_list|(
name|pkt
operator|->
name|flags
operator|&
name|AL_ETH_TX_FLAGS_TS
argument_list|)
condition|)
name|meta_word_0
operator||=
name|pkt
operator|->
name|meta
operator|->
name|ts_index
operator|<<
name|AL_ETH_TX_META_MSS_MSB_TS_VAL_SHIFT
expr_stmt|;
else|else
name|meta_word_0
operator||=
operator|(
operator|(
operator|(
name|pkt
operator|->
name|meta
operator|->
name|mss_val
operator|&
literal|0x3c00
operator|)
operator|>>
literal|10
operator|)
operator|<<
name|AL_ETH_TX_META_MSS_MSB_TS_VAL_SHIFT
operator|)
expr_stmt|;
name|meta_word_2
operator||=
operator|(
operator|(
name|pkt
operator|->
name|meta
operator|->
name|mss_val
operator|&
literal|0x03ff
operator|)
operator|<<
name|AL_ETH_TX_META_MSS_LSB_VAL_SHIFT
operator|)
expr_stmt|;
comment|/* 			 * move from bytes to multiplication of 2 as the HW 			 * expect to get it 			 */
name|l3_offset
operator|=
operator|(
name|pkt
operator|->
name|meta
operator|->
name|outer_l3_offset
operator|>>
literal|1
operator|)
expr_stmt|;
name|meta_word_0
operator||=
operator|(
operator|(
operator|(
name|l3_offset
operator|&
name|AL_ETH_TX_META_OUTER_L3_OFF_HIGH_MASK
operator|)
operator|>>
literal|3
operator|)
operator|<<
name|AL_ETH_TX_META_OUTER_L3_OFF_HIGH_SHIFT
operator|)
expr_stmt|;
name|meta_word_3
operator||=
operator|(
operator|(
name|l3_offset
operator|&
name|AL_ETH_TX_META_OUTER_L3_OFF_LOW_MASK
operator|)
operator|<<
name|AL_ETH_TX_META_OUTER_L3_OFF_LOW_SHIFT
operator|)
expr_stmt|;
comment|/* 			 * shift right 2 bits to work in multiplication of 4 			 * as the HW expect to get it 			 */
name|meta_word_3
operator||=
operator|(
operator|(
operator|(
name|pkt
operator|->
name|meta
operator|->
name|outer_l3_len
operator|>>
literal|2
operator|)
operator|&
name|AL_ETH_TX_META_OUTER_L3_LEN_MASK
operator|)
operator|<<
name|AL_ETH_TX_META_OUTER_L3_LEN_SHIFT
operator|)
expr_stmt|;
block|}
name|tx_desc
operator|->
name|tx_meta
operator|.
name|len_ctrl
operator|=
name|swap32_to_le
argument_list|(
name|meta_word_0
argument_list|)
expr_stmt|;
name|tx_desc
operator|->
name|tx_meta
operator|.
name|meta_ctrl
operator|=
name|swap32_to_le
argument_list|(
name|meta_word_1
argument_list|)
expr_stmt|;
name|tx_desc
operator|->
name|tx_meta
operator|.
name|meta1
operator|=
name|swap32_to_le
argument_list|(
name|meta_word_2
argument_list|)
expr_stmt|;
name|tx_desc
operator|->
name|tx_meta
operator|.
name|meta2
operator|=
name|swap32_to_le
argument_list|(
name|meta_word_3
argument_list|)
expr_stmt|;
name|al_dump_tx_desc
argument_list|(
name|tx_desc
argument_list|)
expr_stmt|;
block|}
name|meta_ctrl
operator|=
name|pkt
operator|->
name|flags
operator|&
name|AL_ETH_TX_PKT_META_FLAGS
expr_stmt|;
comment|/* L4_PARTIAL_CSUM without L4_CSUM is invalid option  */
name|al_assert
argument_list|(
operator|(
name|pkt
operator|->
name|flags
operator|&
operator|(
name|AL_ETH_TX_FLAGS_L4_CSUM
operator||
name|AL_ETH_TX_FLAGS_L4_PARTIAL_CSUM
operator|)
operator|)
operator|!=
name|AL_ETH_TX_FLAGS_L4_PARTIAL_CSUM
argument_list|)
expr_stmt|;
comment|/* TSO packets can't have Timestamp enabled */
name|al_assert
argument_list|(
operator|(
name|pkt
operator|->
name|flags
operator|&
operator|(
name|AL_ETH_TX_FLAGS_TSO
operator||
name|AL_ETH_TX_FLAGS_TS
operator|)
operator|)
operator|!=
operator|(
name|AL_ETH_TX_FLAGS_TSO
operator||
name|AL_ETH_TX_FLAGS_TS
operator|)
argument_list|)
expr_stmt|;
name|meta_ctrl
operator||=
name|pkt
operator|->
name|l3_proto_idx
expr_stmt|;
name|meta_ctrl
operator||=
name|pkt
operator|->
name|l4_proto_idx
operator|<<
name|AL_ETH_TX_L4_PROTO_IDX_SHIFT
expr_stmt|;
name|meta_ctrl
operator||=
name|pkt
operator|->
name|source_vlan_count
operator|<<
name|AL_ETH_TX_SRC_VLAN_CNT_SHIFT
expr_stmt|;
name|meta_ctrl
operator||=
name|pkt
operator|->
name|vlan_mod_add_count
operator|<<
name|AL_ETH_TX_VLAN_MOD_ADD_SHIFT
expr_stmt|;
name|meta_ctrl
operator||=
name|pkt
operator|->
name|vlan_mod_del_count
operator|<<
name|AL_ETH_TX_VLAN_MOD_DEL_SHIFT
expr_stmt|;
name|meta_ctrl
operator||=
name|pkt
operator|->
name|vlan_mod_v1_ether_sel
operator|<<
name|AL_ETH_TX_VLAN_MOD_E_SEL_SHIFT
expr_stmt|;
name|meta_ctrl
operator||=
name|pkt
operator|->
name|vlan_mod_v1_vid_sel
operator|<<
name|AL_ETH_TX_VLAN_MOD_VID_SEL_SHIFT
expr_stmt|;
name|meta_ctrl
operator||=
name|pkt
operator|->
name|vlan_mod_v1_pbits_sel
operator|<<
name|AL_ETH_TX_VLAN_MOD_PBIT_SEL_SHIFT
expr_stmt|;
ifdef|#
directive|ifdef
name|AL_ETH_EX
if|if
condition|(
operator|(
name|pkt
operator|->
name|ext_meta_data
operator|!=
name|NULL
operator|)
operator|&&
operator|(
name|pkt
operator|->
name|ext_meta_data
operator|->
name|tx_crypto_data
operator|!=
name|NULL
operator|)
condition|)
name|meta_ctrl
operator||=
name|AL_ETH_TX_FLAGS_ENCRYPT
expr_stmt|;
endif|#
directive|endif
name|meta_ctrl
operator||=
name|pkt
operator|->
name|tunnel_mode
operator|<<
name|AL_ETH_TX_TUNNEL_MODE_SHIFT
expr_stmt|;
if|if
condition|(
name|pkt
operator|->
name|outer_l3_proto_idx
operator|==
name|AL_ETH_PROTO_ID_IPv4
condition|)
name|meta_ctrl
operator||=
literal|1
operator|<<
name|AL_ETH_TX_OUTER_L3_PROTO_SHIFT
expr_stmt|;
name|flags
operator||=
name|pkt
operator|->
name|flags
operator|&
name|AL_ETH_TX_PKT_UDMA_FLAGS
expr_stmt|;
for|for
control|(
name|buf_idx
operator|=
literal|0
init|;
name|buf_idx
operator|<
name|pkt
operator|->
name|num_of_bufs
condition|;
name|buf_idx
operator|++
control|)
block|{
name|uint32_t
name|flags_len
init|=
name|flags
decl_stmt|;
name|tx_desc
operator|=
name|al_udma_desc_get
argument_list|(
name|tx_dma_q
argument_list|)
expr_stmt|;
comment|/* get ring id, and clear FIRST and Int flags */
name|ring_id
operator|=
name|al_udma_ring_id_get
argument_list|(
name|tx_dma_q
argument_list|)
operator|<<
name|AL_M2S_DESC_RING_ID_SHIFT
expr_stmt|;
name|flags_len
operator||=
name|ring_id
expr_stmt|;
if|if
condition|(
name|buf_idx
operator|==
operator|(
name|pkt
operator|->
name|num_of_bufs
operator|-
literal|1
operator|)
condition|)
name|flags_len
operator||=
name|AL_M2S_DESC_LAST
expr_stmt|;
comment|/* clear First and Int flags */
name|flags
operator|&=
name|AL_ETH_TX_FLAGS_NO_SNOOP
expr_stmt|;
name|flags
operator||=
name|AL_M2S_DESC_CONCAT
expr_stmt|;
name|flags_len
operator||=
name|pkt
operator|->
name|bufs
index|[
name|buf_idx
index|]
operator|.
name|len
operator|&
name|AL_M2S_DESC_LEN_MASK
expr_stmt|;
name|tx_desc
operator|->
name|tx
operator|.
name|len_ctrl
operator|=
name|swap32_to_le
argument_list|(
name|flags_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf_idx
operator|==
literal|0
condition|)
name|tx_desc
operator|->
name|tx
operator|.
name|meta_ctrl
operator|=
name|swap32_to_le
argument_list|(
name|meta_ctrl
argument_list|)
expr_stmt|;
name|tx_desc
operator|->
name|tx
operator|.
name|buf_ptr
operator|=
name|swap64_to_le
argument_list|(
name|pkt
operator|->
name|bufs
index|[
name|buf_idx
index|]
operator|.
name|addr
operator||
name|tgtid
argument_list|)
expr_stmt|;
name|al_dump_tx_desc
argument_list|(
name|tx_desc
argument_list|)
expr_stmt|;
block|}
name|al_dbg
argument_list|(
literal|"[%s %d]: pkt descriptors written into the tx queue. descs num (%d)\n"
argument_list|,
name|tx_dma_q
operator|->
name|udma
operator|->
name|name
argument_list|,
name|tx_dma_q
operator|->
name|qid
argument_list|,
name|tx_descs
argument_list|)
expr_stmt|;
return|return
name|tx_descs
return|;
block|}
end_function

begin_function
name|void
name|al_eth_tx_dma_action
parameter_list|(
name|struct
name|al_udma_q
modifier|*
name|tx_dma_q
parameter_list|,
name|uint32_t
name|tx_descs
parameter_list|)
block|{
comment|/* add tx descriptors */
name|al_udma_desc_action_add
argument_list|(
name|tx_dma_q
argument_list|,
name|tx_descs
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * get number of completed tx descriptors, upper layer should derive from  */
end_comment

begin_function
name|int
name|al_eth_comp_tx_get
parameter_list|(
name|struct
name|al_udma_q
modifier|*
name|tx_dma_q
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|rc
operator|=
name|al_udma_cdesc_get_all
argument_list|(
name|tx_dma_q
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|!=
literal|0
condition|)
block|{
name|al_udma_cdesc_ack
argument_list|(
name|tx_dma_q
argument_list|,
name|rc
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"[%s %d]: tx completion: descs (%d)\n"
argument_list|,
name|tx_dma_q
operator|->
name|udma
operator|->
name|name
argument_list|,
name|tx_dma_q
operator|->
name|qid
argument_list|,
name|rc
argument_list|)
expr_stmt|;
block|}
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/**  * configure the TSO MSS val  */
end_comment

begin_function
name|int
name|al_eth_tso_mss_config
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint8_t
name|idx
parameter_list|,
name|uint32_t
name|mss_val
parameter_list|)
block|{
name|al_assert
argument_list|(
name|idx
operator|<=
literal|8
argument_list|)
expr_stmt|;
comment|/*valid MSS index*/
name|al_assert
argument_list|(
name|mss_val
operator|<=
name|AL_ETH_TSO_MSS_MAX_VAL
argument_list|)
expr_stmt|;
comment|/*valid MSS val*/
name|al_assert
argument_list|(
name|mss_val
operator|>=
name|AL_ETH_TSO_MSS_MIN_VAL
argument_list|)
expr_stmt|;
comment|/*valid MSS val*/
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tso_sel
index|[
name|idx
index|]
operator|.
name|mss
argument_list|,
name|mss_val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* RX */
end_comment

begin_comment
comment|/**  * config the rx descriptor fields  */
end_comment

begin_function
name|void
name|al_eth_rx_desc_config
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|enum
name|al_eth_rx_desc_lro_context_val_res
name|lro_sel
parameter_list|,
name|enum
name|al_eth_rx_desc_l4_offset_sel
name|l4_offset_sel
parameter_list|,
name|enum
name|al_eth_rx_desc_l3_offset_sel
name|l3_offset_sel
parameter_list|,
name|enum
name|al_eth_rx_desc_l4_chk_res_sel
name|l4_sel
parameter_list|,
name|enum
name|al_eth_rx_desc_l3_chk_res_sel
name|l3_sel
parameter_list|,
name|enum
name|al_eth_rx_desc_l3_proto_idx_sel
name|l3_proto_sel
parameter_list|,
name|enum
name|al_eth_rx_desc_l4_proto_idx_sel
name|l4_proto_sel
parameter_list|,
name|enum
name|al_eth_rx_desc_frag_sel
name|frag_sel
parameter_list|)
block|{
name|uint32_t
name|reg_val
init|=
literal|0
decl_stmt|;
name|reg_val
operator||=
operator|(
name|lro_sel
operator|==
name|AL_ETH_L4_OFFSET
operator|)
condition|?
name|EC_RFW_CFG_A_0_LRO_CONTEXT_SEL
else|:
literal|0
expr_stmt|;
name|reg_val
operator||=
operator|(
name|l4_sel
operator|==
name|AL_ETH_L4_INNER_OUTER_CHK
operator|)
condition|?
name|EC_RFW_CFG_A_0_META_L4_CHK_RES_SEL
else|:
literal|0
expr_stmt|;
name|reg_val
operator||=
name|l3_sel
operator|<<
name|EC_RFW_CFG_A_0_META_L3_CHK_RES_SEL_SHIFT
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|cfg_a_0
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
name|reg_val
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|meta
argument_list|)
expr_stmt|;
if|if
condition|(
name|l3_proto_sel
operator|==
name|AL_ETH_L3_PROTO_IDX_INNER
condition|)
name|reg_val
operator||=
name|EC_RFW_META_L3_PROT_SEL
expr_stmt|;
else|else
name|reg_val
operator|&=
operator|~
name|EC_RFW_META_L3_PROT_SEL
expr_stmt|;
if|if
condition|(
name|l4_proto_sel
operator|==
name|AL_ETH_L4_PROTO_IDX_INNER
condition|)
name|reg_val
operator||=
name|EC_RFW_META_L4_PROT_SEL
expr_stmt|;
else|else
name|reg_val
operator|&=
operator|~
name|EC_RFW_META_L4_PROT_SEL
expr_stmt|;
if|if
condition|(
name|l4_offset_sel
operator|==
name|AL_ETH_L4_OFFSET_INNER
condition|)
name|reg_val
operator||=
name|EC_RFW_META_L4_OFFSET_SEL
expr_stmt|;
else|else
name|reg_val
operator|&=
operator|~
name|EC_RFW_META_L4_OFFSET_SEL
expr_stmt|;
if|if
condition|(
name|l3_offset_sel
operator|==
name|AL_ETH_L3_OFFSET_INNER
condition|)
name|reg_val
operator||=
name|EC_RFW_META_L3_OFFSET_SEL
expr_stmt|;
else|else
name|reg_val
operator|&=
operator|~
name|EC_RFW_META_L3_OFFSET_SEL
expr_stmt|;
if|if
condition|(
name|frag_sel
operator|==
name|AL_ETH_FRAG_INNER
condition|)
name|reg_val
operator||=
name|EC_RFW_META_FRAG_SEL
expr_stmt|;
else|else
name|reg_val
operator|&=
operator|~
name|EC_RFW_META_FRAG_SEL
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|meta
argument_list|,
name|reg_val
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Configure RX header split  */
end_comment

begin_function
name|int
name|al_eth_rx_header_split_config
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|al_bool
name|enable
parameter_list|,
name|uint32_t
name|header_len
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|hdr_split
argument_list|)
expr_stmt|;
if|if
condition|(
name|enable
operator|==
name|AL_TRUE
condition|)
name|reg
operator||=
name|EC_RFW_HDR_SPLIT_EN
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|EC_RFW_HDR_SPLIT_EN
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|EC_RFW_HDR_SPLIT_DEF_LEN_MASK
argument_list|,
name|EC_RFW_HDR_SPLIT_DEF_LEN_SHIFT
argument_list|,
name|header_len
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|hdr_split
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * enable / disable header split in the udma queue.  * length will be taken from the udma configuration to enable different length per queue.  */
end_comment

begin_function
name|int
name|al_eth_rx_header_split_force_len_config
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|al_bool
name|enable
parameter_list|,
name|uint32_t
name|qid
parameter_list|,
name|uint32_t
name|header_len
parameter_list|)
block|{
name|al_udma_s2m_q_compl_hdr_split_config
argument_list|(
operator|&
operator|(
name|adapter
operator|->
name|rx_udma
operator|.
name|udma_q
index|[
name|qid
index|]
operator|)
argument_list|,
name|enable
argument_list|,
name|AL_TRUE
argument_list|,
name|header_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * add buffer to receive queue  */
end_comment

begin_function
name|int
name|al_eth_rx_buffer_add
parameter_list|(
name|struct
name|al_udma_q
modifier|*
name|rx_dma_q
parameter_list|,
name|struct
name|al_buf
modifier|*
name|buf
parameter_list|,
name|uint32_t
name|flags
parameter_list|,
name|struct
name|al_buf
modifier|*
name|header_buf
parameter_list|)
block|{
name|uint64_t
name|tgtid
init|=
operator|(
operator|(
name|uint64_t
operator|)
name|flags
operator|&
name|AL_ETH_RX_FLAGS_TGTID_MASK
operator|)
operator|<<
name|AL_UDMA_DESC_TGTID_SHIFT
decl_stmt|;
name|uint32_t
name|flags_len
init|=
name|flags
operator|&
operator|~
name|AL_ETH_RX_FLAGS_TGTID_MASK
decl_stmt|;
name|union
name|al_udma_desc
modifier|*
name|rx_desc
decl_stmt|;
name|al_dbg
argument_list|(
literal|"[%s %d]: add rx buffer.\n"
argument_list|,
name|rx_dma_q
operator|->
name|udma
operator|->
name|name
argument_list|,
name|rx_dma_q
operator|->
name|qid
argument_list|)
expr_stmt|;
if|#
directive|if
literal|1
if|if
condition|(
name|unlikely
argument_list|(
name|al_udma_available_get
argument_list|(
name|rx_dma_q
argument_list|)
operator|<
literal|1
argument_list|)
condition|)
block|{
name|al_dbg
argument_list|(
literal|"[%s]: rx q (%d) has no enough free descriptor"
argument_list|,
name|rx_dma_q
operator|->
name|udma
operator|->
name|name
argument_list|,
name|rx_dma_q
operator|->
name|qid
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOSPC
return|;
block|}
endif|#
directive|endif
name|rx_desc
operator|=
name|al_udma_desc_get
argument_list|(
name|rx_dma_q
argument_list|)
expr_stmt|;
name|flags_len
operator||=
name|al_udma_ring_id_get
argument_list|(
name|rx_dma_q
argument_list|)
operator|<<
name|AL_S2M_DESC_RING_ID_SHIFT
expr_stmt|;
name|flags_len
operator||=
name|buf
operator|->
name|len
operator|&
name|AL_S2M_DESC_LEN_MASK
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|AL_S2M_DESC_DUAL_BUF
condition|)
block|{
name|al_assert
argument_list|(
name|header_buf
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/*header valid in dual buf */
name|al_assert
argument_list|(
operator|(
name|rx_dma_q
operator|->
name|udma
operator|->
name|rev_id
operator|>=
name|AL_UDMA_REV_ID_2
operator|)
operator|||
operator|(
name|AL_ADDR_HIGH
argument_list|(
name|buf
operator|->
name|addr
argument_list|)
operator|==
name|AL_ADDR_HIGH
argument_list|(
name|header_buf
operator|->
name|addr
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|flags_len
operator||=
operator|(
operator|(
name|header_buf
operator|->
name|len
operator|>>
name|AL_S2M_DESC_LEN2_GRANULARITY_SHIFT
operator|)
operator|<<
name|AL_S2M_DESC_LEN2_SHIFT
operator|)
operator|&
name|AL_S2M_DESC_LEN2_MASK
expr_stmt|;
name|rx_desc
operator|->
name|rx
operator|.
name|buf2_ptr_lo
operator|=
name|swap32_to_le
argument_list|(
name|AL_ADDR_LOW
argument_list|(
name|header_buf
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|rx_desc
operator|->
name|rx
operator|.
name|len_ctrl
operator|=
name|swap32_to_le
argument_list|(
name|flags_len
argument_list|)
expr_stmt|;
name|rx_desc
operator|->
name|rx
operator|.
name|buf1_ptr
operator|=
name|swap64_to_le
argument_list|(
name|buf
operator|->
name|addr
operator||
name|tgtid
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * notify the hw engine about rx descriptors that were added to the receive queue  */
end_comment

begin_function
name|void
name|al_eth_rx_buffer_action
parameter_list|(
name|struct
name|al_udma_q
modifier|*
name|rx_dma_q
parameter_list|,
name|uint32_t
name|descs_num
parameter_list|)
block|{
name|al_dbg
argument_list|(
literal|"[%s]: update the rx engine tail pointer: queue %d. descs %d\n"
argument_list|,
name|rx_dma_q
operator|->
name|udma
operator|->
name|name
argument_list|,
name|rx_dma_q
operator|->
name|qid
argument_list|,
name|descs_num
argument_list|)
expr_stmt|;
comment|/* add rx descriptor */
name|al_udma_desc_action_add
argument_list|(
name|rx_dma_q
argument_list|,
name|descs_num
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * get packet from RX completion ring  */
end_comment

begin_function
name|uint32_t
name|al_eth_pkt_rx
parameter_list|(
name|struct
name|al_udma_q
modifier|*
name|rx_dma_q
parameter_list|,
name|struct
name|al_eth_pkt
modifier|*
name|pkt
parameter_list|)
block|{
specifier|volatile
name|union
name|al_udma_cdesc
modifier|*
name|cdesc
decl_stmt|;
specifier|volatile
name|al_eth_rx_cdesc
modifier|*
name|rx_desc
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
name|uint32_t
name|rc
decl_stmt|;
name|rc
operator|=
name|al_udma_cdesc_packet_get
argument_list|(
name|rx_dma_q
argument_list|,
operator|&
name|cdesc
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|al_assert
argument_list|(
name|rc
operator|<=
name|AL_ETH_PKT_MAX_BUFS
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"[%s]: fetch rx packet: queue %d.\n"
argument_list|,
name|rx_dma_q
operator|->
name|udma
operator|->
name|name
argument_list|,
name|rx_dma_q
operator|->
name|qid
argument_list|)
expr_stmt|;
name|pkt
operator|->
name|rx_header_len
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rc
condition|;
name|i
operator|++
control|)
block|{
name|uint32_t
name|buf1_len
decl_stmt|,
name|buf2_len
decl_stmt|;
comment|/* get next descriptor */
name|rx_desc
operator|=
operator|(
specifier|volatile
name|al_eth_rx_cdesc
operator|*
operator|)
name|al_cdesc_next
argument_list|(
name|rx_dma_q
argument_list|,
name|cdesc
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|buf1_len
operator|=
name|swap32_from_le
argument_list|(
name|rx_desc
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|==
literal|0
operator|)
operator|&&
operator|(
name|swap32_from_le
argument_list|(
name|rx_desc
operator|->
name|word2
argument_list|)
operator|&
name|AL_UDMA_CDESC_BUF2_USED
operator|)
condition|)
block|{
name|buf2_len
operator|=
name|swap32_from_le
argument_list|(
name|rx_desc
operator|->
name|word2
argument_list|)
expr_stmt|;
name|pkt
operator|->
name|rx_header_len
operator|=
operator|(
name|buf2_len
operator|&
name|AL_S2M_DESC_LEN2_MASK
operator|)
operator|>>
name|AL_S2M_DESC_LEN2_SHIFT
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|swap32_from_le
argument_list|(
name|rx_desc
operator|->
name|ctrl_meta
argument_list|)
operator|&
name|AL_UDMA_CDESC_BUF1_USED
operator|)
operator|&&
operator|(
operator|(
name|swap32_from_le
argument_list|(
name|rx_desc
operator|->
name|ctrl_meta
argument_list|)
operator|&
name|AL_UDMA_CDESC_DDP
operator|)
operator|==
literal|0
operator|)
condition|)
name|pkt
operator|->
name|bufs
index|[
name|i
index|]
operator|.
name|len
operator|=
name|buf1_len
operator|&
name|AL_S2M_DESC_LEN_MASK
expr_stmt|;
else|else
name|pkt
operator|->
name|bufs
index|[
name|i
index|]
operator|.
name|len
operator|=
literal|0
expr_stmt|;
block|}
comment|/* get flags from last desc */
name|pkt
operator|->
name|flags
operator|=
name|swap32_from_le
argument_list|(
name|rx_desc
operator|->
name|ctrl_meta
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|AL_ETH_RX_DESC_RAW_GET
name|pkt
operator|->
name|rx_desc_raw
index|[
literal|0
index|]
operator|=
name|pkt
operator|->
name|flags
expr_stmt|;
name|pkt
operator|->
name|rx_desc_raw
index|[
literal|1
index|]
operator|=
name|swap32_from_le
argument_list|(
name|rx_desc
operator|->
name|len
argument_list|)
expr_stmt|;
name|pkt
operator|->
name|rx_desc_raw
index|[
literal|2
index|]
operator|=
name|swap32_from_le
argument_list|(
name|rx_desc
operator|->
name|word2
argument_list|)
expr_stmt|;
name|pkt
operator|->
name|rx_desc_raw
index|[
literal|3
index|]
operator|=
name|swap32_from_le
argument_list|(
name|rx_desc
operator|->
name|word3
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* update L3/L4 proto index */
name|pkt
operator|->
name|l3_proto_idx
operator|=
name|pkt
operator|->
name|flags
operator|&
name|AL_ETH_RX_L3_PROTO_IDX_MASK
expr_stmt|;
name|pkt
operator|->
name|l4_proto_idx
operator|=
operator|(
name|pkt
operator|->
name|flags
operator|>>
name|AL_ETH_RX_L4_PROTO_IDX_SHIFT
operator|)
operator|&
name|AL_ETH_RX_L4_PROTO_IDX_MASK
expr_stmt|;
name|pkt
operator|->
name|rxhash
operator|=
operator|(
name|swap32_from_le
argument_list|(
name|rx_desc
operator|->
name|len
argument_list|)
operator|&
name|AL_ETH_RX_HASH_MASK
operator|)
operator|>>
name|AL_ETH_RX_HASH_SHIFT
expr_stmt|;
name|pkt
operator|->
name|l3_offset
operator|=
operator|(
name|swap32_from_le
argument_list|(
name|rx_desc
operator|->
name|word2
argument_list|)
operator|&
name|AL_ETH_RX_L3_OFFSET_MASK
operator|)
operator|>>
name|AL_ETH_RX_L3_OFFSET_SHIFT
expr_stmt|;
name|al_udma_cdesc_ack
argument_list|(
name|rx_dma_q
argument_list|,
name|rc
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_function
name|int
name|al_eth_rx_parser_entry_update
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|idx
parameter_list|,
name|struct
name|al_eth_epe_p_reg_entry
modifier|*
name|reg_entry
parameter_list|,
name|struct
name|al_eth_epe_control_entry
modifier|*
name|control_entry
parameter_list|)
block|{
name|al_eth_epe_entry_set
argument_list|(
name|adapter
argument_list|,
name|idx
argument_list|,
name|reg_entry
argument_list|,
name|control_entry
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_define
define|#
directive|define
name|AL_ETH_THASH_UDMA_SHIFT
value|0
end_define

begin_define
define|#
directive|define
name|AL_ETH_THASH_UDMA_MASK
value|(0xF<< AL_ETH_THASH_UDMA_SHIFT)
end_define

begin_define
define|#
directive|define
name|AL_ETH_THASH_Q_SHIFT
value|4
end_define

begin_define
define|#
directive|define
name|AL_ETH_THASH_Q_MASK
value|(0x3<< AL_ETH_THASH_Q_SHIFT)
end_define

begin_function
name|int
name|al_eth_thash_table_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|idx
parameter_list|,
name|uint8_t
name|udma
parameter_list|,
name|uint32_t
name|queue
parameter_list|)
block|{
name|uint32_t
name|entry
decl_stmt|;
name|al_assert
argument_list|(
name|idx
operator|<
name|AL_ETH_RX_THASH_TABLE_SIZE
argument_list|)
expr_stmt|;
comment|/*valid THASH index*/
name|entry
operator|=
operator|(
name|udma
operator|<<
name|AL_ETH_THASH_UDMA_SHIFT
operator|)
operator|&
name|AL_ETH_THASH_UDMA_MASK
expr_stmt|;
name|entry
operator||=
operator|(
name|queue
operator|<<
name|AL_ETH_THASH_Q_SHIFT
operator|)
operator|&
name|AL_ETH_THASH_Q_MASK
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|thash_table_addr
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|thash_table_data
argument_list|,
name|entry
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_fsm_table_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|idx
parameter_list|,
name|uint32_t
name|entry
parameter_list|)
block|{
name|al_assert
argument_list|(
name|idx
operator|<
name|AL_ETH_RX_FSM_TABLE_SIZE
argument_list|)
expr_stmt|;
comment|/*valid FSM index*/
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|fsm_table_addr
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|fsm_table_data
argument_list|,
name|entry
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|al_eth_fwd_ctrl_entry_to_val
parameter_list|(
name|struct
name|al_eth_fwd_ctrl_table_entry
modifier|*
name|entry
parameter_list|)
block|{
name|uint32_t
name|val
init|=
literal|0
decl_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|val
argument_list|,
name|AL_FIELD_MASK
argument_list|(
literal|3
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
name|entry
operator|->
name|prio_sel
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|val
argument_list|,
name|AL_FIELD_MASK
argument_list|(
literal|7
argument_list|,
literal|4
argument_list|)
argument_list|,
literal|4
argument_list|,
name|entry
operator|->
name|queue_sel_1
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|val
argument_list|,
name|AL_FIELD_MASK
argument_list|(
literal|9
argument_list|,
literal|8
argument_list|)
argument_list|,
literal|8
argument_list|,
name|entry
operator|->
name|queue_sel_2
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|val
argument_list|,
name|AL_FIELD_MASK
argument_list|(
literal|13
argument_list|,
literal|10
argument_list|)
argument_list|,
literal|10
argument_list|,
name|entry
operator|->
name|udma_sel
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|val
argument_list|,
name|AL_FIELD_MASK
argument_list|(
literal|17
argument_list|,
literal|15
argument_list|)
argument_list|,
literal|15
argument_list|,
name|entry
operator|->
name|hdr_split_len_sel
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|->
name|hdr_split_len_sel
operator|!=
name|AL_ETH_CTRL_TABLE_HDR_SPLIT_LEN_SEL_0
condition|)
name|val
operator||=
name|AL_BIT
argument_list|(
literal|18
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|val
argument_list|,
literal|19
argument_list|,
operator|!
operator|!
operator|(
name|entry
operator|->
name|filter
operator|==
name|AL_TRUE
operator|)
argument_list|)
expr_stmt|;
return|return
name|val
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|al_eth_ctrl_index_match
parameter_list|(
name|struct
name|al_eth_fwd_ctrl_table_index
modifier|*
name|index
parameter_list|,
name|uint32_t
name|i
parameter_list|)
block|{
if|if
condition|(
operator|(
name|index
operator|->
name|vlan_table_out
operator|!=
name|AL_ETH_FWD_CTRL_IDX_VLAN_TABLE_OUT_ANY
operator|)
operator|&&
operator|(
name|index
operator|->
name|vlan_table_out
operator|!=
name|AL_REG_BIT_GET
argument_list|(
name|i
argument_list|,
literal|0
argument_list|)
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|index
operator|->
name|tunnel_exist
operator|!=
name|AL_ETH_FWD_CTRL_IDX_TUNNEL_ANY
operator|)
operator|&&
operator|(
name|index
operator|->
name|tunnel_exist
operator|!=
name|AL_REG_BIT_GET
argument_list|(
name|i
argument_list|,
literal|1
argument_list|)
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|index
operator|->
name|vlan_exist
operator|!=
name|AL_ETH_FWD_CTRL_IDX_VLAN_ANY
operator|)
operator|&&
operator|(
name|index
operator|->
name|vlan_exist
operator|!=
name|AL_REG_BIT_GET
argument_list|(
name|i
argument_list|,
literal|2
argument_list|)
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|index
operator|->
name|mac_table_match
operator|!=
name|AL_ETH_FWD_CTRL_IDX_MAC_TABLE_ANY
operator|)
operator|&&
operator|(
name|index
operator|->
name|mac_table_match
operator|!=
name|AL_REG_BIT_GET
argument_list|(
name|i
argument_list|,
literal|3
argument_list|)
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|index
operator|->
name|protocol_id
operator|!=
name|AL_ETH_PROTO_ID_ANY
operator|)
operator|&&
operator|(
name|index
operator|->
name|protocol_id
operator|!=
name|AL_REG_FIELD_GET
argument_list|(
name|i
argument_list|,
name|AL_FIELD_MASK
argument_list|(
literal|8
argument_list|,
literal|4
argument_list|)
argument_list|,
literal|4
argument_list|)
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|index
operator|->
name|mac_type
operator|!=
name|AL_ETH_FWD_CTRL_IDX_MAC_DA_TYPE_ANY
operator|)
operator|&&
operator|(
name|index
operator|->
name|mac_type
operator|!=
name|AL_REG_FIELD_GET
argument_list|(
name|i
argument_list|,
name|AL_FIELD_MASK
argument_list|(
literal|10
argument_list|,
literal|9
argument_list|)
argument_list|,
literal|9
argument_list|)
operator|)
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|al_eth_ctrl_table_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|al_eth_fwd_ctrl_table_index
modifier|*
name|index
parameter_list|,
name|struct
name|al_eth_fwd_ctrl_table_entry
modifier|*
name|entry
parameter_list|)
block|{
name|uint32_t
name|val
init|=
name|al_eth_fwd_ctrl_entry_to_val
argument_list|(
name|entry
argument_list|)
decl_stmt|;
name|uint32_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|AL_ETH_RX_CTRL_TABLE_SIZE
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|al_eth_ctrl_index_match
argument_list|(
name|index
argument_list|,
name|i
argument_list|)
condition|)
block|{
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|ctrl_table_addr
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|ctrl_table_data
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_ctrl_table_def_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|al_bool
name|use_table
parameter_list|,
name|struct
name|al_eth_fwd_ctrl_table_entry
modifier|*
name|entry
parameter_list|)
block|{
name|uint32_t
name|val
init|=
name|al_eth_fwd_ctrl_entry_to_val
argument_list|(
name|entry
argument_list|)
decl_stmt|;
if|if
condition|(
name|use_table
condition|)
name|val
operator||=
name|EC_RFW_CTRL_TABLE_DEF_SEL
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|ctrl_table_def
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_ctrl_table_raw_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|idx
parameter_list|,
name|uint32_t
name|entry
parameter_list|)
block|{
name|al_assert
argument_list|(
name|idx
operator|<
name|AL_ETH_RX_CTRL_TABLE_SIZE
argument_list|)
expr_stmt|;
comment|/* valid CTRL index */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|ctrl_table_addr
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|ctrl_table_data
argument_list|,
name|entry
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_ctrl_table_def_raw_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|ctrl_table_def
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_hash_key_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|idx
parameter_list|,
name|uint32_t
name|val
parameter_list|)
block|{
name|al_assert
argument_list|(
name|idx
operator|<
name|AL_ETH_RX_HASH_KEY_NUM
argument_list|)
expr_stmt|;
comment|/*valid CTRL index*/
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_hash
index|[
name|idx
index|]
operator|.
name|key
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|al_eth_fwd_mac_table_entry_to_val
parameter_list|(
name|struct
name|al_eth_fwd_mac_table_entry
modifier|*
name|entry
parameter_list|)
block|{
name|uint32_t
name|val
init|=
literal|0
decl_stmt|;
name|val
operator||=
operator|(
name|entry
operator|->
name|filter
operator|==
name|AL_TRUE
operator|)
condition|?
name|EC_FWD_MAC_CTRL_RX_VAL_DROP
else|:
literal|0
expr_stmt|;
name|val
operator||=
operator|(
operator|(
name|entry
operator|->
name|udma_mask
operator|<<
name|EC_FWD_MAC_CTRL_RX_VAL_UDMA_SHIFT
operator|)
operator|&
name|EC_FWD_MAC_CTRL_RX_VAL_UDMA_MASK
operator|)
expr_stmt|;
name|val
operator||=
operator|(
operator|(
name|entry
operator|->
name|qid
operator|<<
name|EC_FWD_MAC_CTRL_RX_VAL_QID_SHIFT
operator|)
operator|&
name|EC_FWD_MAC_CTRL_RX_VAL_QID_MASK
operator|)
expr_stmt|;
name|val
operator||=
operator|(
name|entry
operator|->
name|rx_valid
operator|==
name|AL_TRUE
operator|)
condition|?
name|EC_FWD_MAC_CTRL_RX_VALID
else|:
literal|0
expr_stmt|;
name|val
operator||=
operator|(
operator|(
name|entry
operator|->
name|tx_target
operator|<<
name|EC_FWD_MAC_CTRL_TX_VAL_SHIFT
operator|)
operator|&
name|EC_FWD_MAC_CTRL_TX_VAL_MASK
operator|)
expr_stmt|;
name|val
operator||=
operator|(
name|entry
operator|->
name|tx_valid
operator|==
name|AL_TRUE
operator|)
condition|?
name|EC_FWD_MAC_CTRL_TX_VALID
else|:
literal|0
expr_stmt|;
return|return
name|val
return|;
block|}
end_function

begin_function
name|int
name|al_eth_fwd_mac_table_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|idx
parameter_list|,
name|struct
name|al_eth_fwd_mac_table_entry
modifier|*
name|entry
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|al_assert
argument_list|(
name|idx
operator|<
name|AL_ETH_FWD_MAC_NUM
argument_list|)
expr_stmt|;
comment|/*valid FWD MAC index */
name|val
operator|=
operator|(
name|entry
operator|->
name|addr
index|[
literal|2
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|entry
operator|->
name|addr
index|[
literal|3
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|entry
operator|->
name|addr
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator||
name|entry
operator|->
name|addr
index|[
literal|5
index|]
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|fwd_mac
index|[
name|idx
index|]
operator|.
name|data_l
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
name|entry
operator|->
name|addr
index|[
literal|0
index|]
operator|<<
literal|8
operator|)
operator||
name|entry
operator|->
name|addr
index|[
literal|1
index|]
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|fwd_mac
index|[
name|idx
index|]
operator|.
name|data_h
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
name|entry
operator|->
name|mask
index|[
literal|2
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|entry
operator|->
name|mask
index|[
literal|3
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|entry
operator|->
name|mask
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator||
name|entry
operator|->
name|mask
index|[
literal|5
index|]
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|fwd_mac
index|[
name|idx
index|]
operator|.
name|mask_l
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
name|entry
operator|->
name|mask
index|[
literal|0
index|]
operator|<<
literal|8
operator|)
operator||
name|entry
operator|->
name|mask
index|[
literal|1
index|]
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|fwd_mac
index|[
name|idx
index|]
operator|.
name|mask_h
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|al_eth_fwd_mac_table_entry_to_val
argument_list|(
name|entry
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|fwd_mac
index|[
name|idx
index|]
operator|.
name|ctrl
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_fwd_mac_addr_raw_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|idx
parameter_list|,
name|uint32_t
name|addr_lo
parameter_list|,
name|uint32_t
name|addr_hi
parameter_list|,
name|uint32_t
name|mask_lo
parameter_list|,
name|uint32_t
name|mask_hi
parameter_list|)
block|{
name|al_assert
argument_list|(
name|idx
operator|<
name|AL_ETH_FWD_MAC_NUM
argument_list|)
expr_stmt|;
comment|/*valid FWD MAC index */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|fwd_mac
index|[
name|idx
index|]
operator|.
name|data_l
argument_list|,
name|addr_lo
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|fwd_mac
index|[
name|idx
index|]
operator|.
name|data_h
argument_list|,
name|addr_hi
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|fwd_mac
index|[
name|idx
index|]
operator|.
name|mask_l
argument_list|,
name|mask_lo
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|fwd_mac
index|[
name|idx
index|]
operator|.
name|mask_h
argument_list|,
name|mask_hi
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_fwd_mac_ctrl_raw_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|idx
parameter_list|,
name|uint32_t
name|ctrl
parameter_list|)
block|{
name|al_assert
argument_list|(
name|idx
operator|<
name|AL_ETH_FWD_MAC_NUM
argument_list|)
expr_stmt|;
comment|/*valid FWD MAC index */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|fwd_mac
index|[
name|idx
index|]
operator|.
name|ctrl
argument_list|,
name|ctrl
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_mac_addr_store
parameter_list|(
name|void
modifier|*
name|__iomem
name|ec_base
parameter_list|,
name|uint32_t
name|idx
parameter_list|,
name|uint8_t
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|al_ec_regs
name|__iomem
modifier|*
name|ec_regs_base
init|=
operator|(
expr|struct
name|al_ec_regs
name|__iomem
operator|*
operator|)
name|ec_base
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|al_assert
argument_list|(
name|idx
operator|<
name|AL_ETH_FWD_MAC_NUM
argument_list|)
expr_stmt|;
comment|/*valid FWD MAC index */
name|val
operator|=
operator|(
name|addr
index|[
literal|2
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|addr
index|[
literal|3
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|addr
index|[
literal|4
index|]
operator|<<
literal|8
operator|)
operator||
name|addr
index|[
literal|5
index|]
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|ec_regs_base
operator|->
name|fwd_mac
index|[
name|idx
index|]
operator|.
name|data_l
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
operator|(
name|addr
index|[
literal|0
index|]
operator|<<
literal|8
operator|)
operator||
name|addr
index|[
literal|1
index|]
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|ec_regs_base
operator|->
name|fwd_mac
index|[
name|idx
index|]
operator|.
name|data_h
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_mac_addr_read
parameter_list|(
name|void
modifier|*
name|__iomem
name|ec_base
parameter_list|,
name|uint32_t
name|idx
parameter_list|,
name|uint8_t
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|al_ec_regs
name|__iomem
modifier|*
name|ec_regs_base
init|=
operator|(
expr|struct
name|al_ec_regs
name|__iomem
operator|*
operator|)
name|ec_base
decl_stmt|;
name|uint32_t
name|addr_lo
init|=
name|al_reg_read32
argument_list|(
operator|&
name|ec_regs_base
operator|->
name|fwd_mac
index|[
name|idx
index|]
operator|.
name|data_l
argument_list|)
decl_stmt|;
name|uint16_t
name|addr_hi
init|=
name|al_reg_read32
argument_list|(
operator|&
name|ec_regs_base
operator|->
name|fwd_mac
index|[
name|idx
index|]
operator|.
name|data_h
argument_list|)
decl_stmt|;
name|addr
index|[
literal|5
index|]
operator|=
name|addr_lo
operator|&
literal|0xff
expr_stmt|;
name|addr
index|[
literal|4
index|]
operator|=
operator|(
name|addr_lo
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
name|addr
index|[
literal|3
index|]
operator|=
operator|(
name|addr_lo
operator|>>
literal|16
operator|)
operator|&
literal|0xff
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
operator|(
name|addr_lo
operator|>>
literal|24
operator|)
operator|&
literal|0xff
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|addr_hi
operator|&
literal|0xff
expr_stmt|;
name|addr
index|[
literal|0
index|]
operator|=
operator|(
name|addr_hi
operator|>>
literal|8
operator|)
operator|&
literal|0xff
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_fwd_mhash_table_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|idx
parameter_list|,
name|uint8_t
name|udma_mask
parameter_list|,
name|uint8_t
name|qid
parameter_list|)
block|{
name|uint32_t
name|val
init|=
literal|0
decl_stmt|;
name|al_assert
argument_list|(
name|idx
operator|<
name|AL_ETH_FWD_MAC_HASH_NUM
argument_list|)
expr_stmt|;
comment|/* valid MHASH index */
name|AL_REG_FIELD_SET
argument_list|(
name|val
argument_list|,
name|AL_FIELD_MASK
argument_list|(
literal|3
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|0
argument_list|,
name|udma_mask
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|val
argument_list|,
name|AL_FIELD_MASK
argument_list|(
literal|5
argument_list|,
literal|4
argument_list|)
argument_list|,
literal|4
argument_list|,
name|qid
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|mhash_table_addr
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|mhash_table_data
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|uint32_t
name|al_eth_fwd_vid_entry_to_val
parameter_list|(
name|struct
name|al_eth_fwd_vid_table_entry
modifier|*
name|entry
parameter_list|)
block|{
name|uint32_t
name|val
init|=
literal|0
decl_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|val
argument_list|,
literal|0
argument_list|,
name|entry
operator|->
name|control
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|val
argument_list|,
literal|1
argument_list|,
name|entry
operator|->
name|filter
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|val
argument_list|,
name|AL_FIELD_MASK
argument_list|(
literal|5
argument_list|,
literal|2
argument_list|)
argument_list|,
literal|2
argument_list|,
name|entry
operator|->
name|udma_mask
argument_list|)
expr_stmt|;
return|return
name|val
return|;
block|}
end_function

begin_function
name|int
name|al_eth_fwd_vid_config_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|al_bool
name|use_table
parameter_list|,
name|struct
name|al_eth_fwd_vid_table_entry
modifier|*
name|default_entry
parameter_list|,
name|uint32_t
name|default_vlan
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|reg
operator|=
name|al_eth_fwd_vid_entry_to_val
argument_list|(
name|default_entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|use_table
condition|)
name|reg
operator||=
name|EC_RFW_VID_TABLE_DEF_SEL
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|EC_RFW_VID_TABLE_DEF_SEL
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|vid_table_def
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|default_vlan
argument_list|,
name|default_vlan
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_fwd_vid_table_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|idx
parameter_list|,
name|struct
name|al_eth_fwd_vid_table_entry
modifier|*
name|entry
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|al_assert
argument_list|(
name|idx
operator|<
name|AL_ETH_FWD_VID_TABLE_NUM
argument_list|)
expr_stmt|;
comment|/* valid VID index */
name|val
operator|=
name|al_eth_fwd_vid_entry_to_val
argument_list|(
name|entry
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|vid_table_addr
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|vid_table_data
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_fwd_pbits_table_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|idx
parameter_list|,
name|uint8_t
name|prio
parameter_list|)
block|{
name|al_assert
argument_list|(
name|idx
operator|<
name|AL_ETH_FWD_PBITS_TABLE_NUM
argument_list|)
expr_stmt|;
comment|/* valid PBIT index */
name|al_assert
argument_list|(
name|prio
operator|<
name|AL_ETH_FWD_PRIO_TABLE_NUM
argument_list|)
expr_stmt|;
comment|/* valid PRIO index */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|pbits_table_addr
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|pbits_table_data
argument_list|,
name|prio
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_fwd_priority_table_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint8_t
name|prio
parameter_list|,
name|uint8_t
name|qid
parameter_list|)
block|{
name|al_assert
argument_list|(
name|prio
operator|<
name|AL_ETH_FWD_PRIO_TABLE_NUM
argument_list|)
expr_stmt|;
comment|/* valid PRIO index */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_priority
index|[
name|prio
index|]
operator|.
name|queue
argument_list|,
name|qid
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_fwd_dscp_table_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|idx
parameter_list|,
name|uint8_t
name|prio
parameter_list|)
block|{
name|al_assert
argument_list|(
name|idx
operator|<
name|AL_ETH_FWD_DSCP_TABLE_NUM
argument_list|)
expr_stmt|;
comment|/* valid DSCP index */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|dscp_table_addr
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|dscp_table_data
argument_list|,
name|prio
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_fwd_tc_table_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|idx
parameter_list|,
name|uint8_t
name|prio
parameter_list|)
block|{
name|al_assert
argument_list|(
name|idx
operator|<
name|AL_ETH_FWD_TC_TABLE_NUM
argument_list|)
expr_stmt|;
comment|/* valid TC index */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|tc_table_addr
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|tc_table_data
argument_list|,
name|prio
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** Configure default UDMA register */
end_comment

begin_function
name|int
name|al_eth_fwd_default_udma_config
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|idx
parameter_list|,
name|uint8_t
name|udma_mask
parameter_list|)
block|{
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_default
index|[
name|idx
index|]
operator|.
name|opt_1
argument_list|,
name|EC_RFW_DEFAULT_OPT_1_UDMA_MASK
argument_list|,
name|udma_mask
operator|<<
name|EC_RFW_DEFAULT_OPT_1_UDMA_SHIFT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** Configure default queue register */
end_comment

begin_function
name|int
name|al_eth_fwd_default_queue_config
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|idx
parameter_list|,
name|uint8_t
name|qid
parameter_list|)
block|{
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_default
index|[
name|idx
index|]
operator|.
name|opt_1
argument_list|,
name|EC_RFW_DEFAULT_OPT_1_QUEUE_MASK
argument_list|,
name|qid
operator|<<
name|EC_RFW_DEFAULT_OPT_1_QUEUE_SHIFT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** Configure default priority register */
end_comment

begin_function
name|int
name|al_eth_fwd_default_priority_config
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|idx
parameter_list|,
name|uint8_t
name|prio
parameter_list|)
block|{
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_default
index|[
name|idx
index|]
operator|.
name|opt_1
argument_list|,
name|EC_RFW_DEFAULT_OPT_1_PRIORITY_MASK
argument_list|,
name|prio
operator|<<
name|EC_RFW_DEFAULT_OPT_1_PRIORITY_SHIFT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_switching_config_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint8_t
name|udma_id
parameter_list|,
name|uint8_t
name|forward_all_to_mac
parameter_list|,
name|uint8_t
name|enable_int_switching
parameter_list|,
name|enum
name|al_eth_tx_switch_vid_sel_type
name|vid_sel_type
parameter_list|,
name|enum
name|al_eth_tx_switch_dec_type
name|uc_dec
parameter_list|,
name|enum
name|al_eth_tx_switch_dec_type
name|mc_dec
parameter_list|,
name|enum
name|al_eth_tx_switch_dec_type
name|bc_dec
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
if|if
condition|(
name|udma_id
operator|==
literal|0
condition|)
block|{
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw
operator|.
name|tx_gen
argument_list|)
expr_stmt|;
if|if
condition|(
name|forward_all_to_mac
condition|)
name|reg
operator||=
name|EC_TFW_TX_GEN_FWD_ALL_TO_MAC
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|EC_TFW_TX_GEN_FWD_ALL_TO_MAC
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw
operator|.
name|tx_gen
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
name|reg
operator|=
name|enable_int_switching
expr_stmt|;
name|reg
operator||=
operator|(
name|vid_sel_type
operator|&
literal|7
operator|)
operator|<<
literal|1
expr_stmt|;
name|reg
operator||=
operator|(
name|bc_dec
operator|&
literal|3
operator|)
operator|<<
literal|4
expr_stmt|;
name|reg
operator||=
operator|(
name|mc_dec
operator|&
literal|3
operator|)
operator|<<
literal|6
expr_stmt|;
name|reg
operator||=
operator|(
name|uc_dec
operator|&
literal|3
operator|)
operator|<<
literal|8
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_udma
index|[
name|udma_id
index|]
operator|.
name|fwd_dec
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_define
define|#
directive|define
name|AL_ETH_RFW_FILTER_SUPPORTED
parameter_list|(
name|rev_id
parameter_list|)
define|\
value|(AL_ETH_RFW_FILTER_UNDET_MAC | \ 	AL_ETH_RFW_FILTER_DET_MAC | \ 	AL_ETH_RFW_FILTER_TAGGED | \ 	AL_ETH_RFW_FILTER_UNTAGGED | \ 	AL_ETH_RFW_FILTER_BC | \ 	AL_ETH_RFW_FILTER_MC | \ 	AL_ETH_RFW_FILTER_VLAN_VID | \ 	AL_ETH_RFW_FILTER_CTRL_TABLE | \ 	AL_ETH_RFW_FILTER_PROT_INDEX | \ 	AL_ETH_RFW_FILTER_WOL | \ 	AL_ETH_RFW_FILTER_PARSE)
end_define

begin_comment
comment|/* Configure the receive filters */
end_comment

begin_function
name|int
name|al_eth_filter_config
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|al_eth_filter_params
modifier|*
name|params
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|al_assert
argument_list|(
name|params
argument_list|)
expr_stmt|;
comment|/* valid params pointer */
if|if
condition|(
name|params
operator|->
name|filters
operator|&
operator|~
operator|(
name|AL_ETH_RFW_FILTER_SUPPORTED
argument_list|(
name|adapter
operator|->
name|rev_id
argument_list|)
operator|)
condition|)
block|{
name|al_err
argument_list|(
literal|"[%s]: unsupported filter options (0x%08x)\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|params
operator|->
name|filters
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|out_cfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|enable
operator|==
name|AL_TRUE
condition|)
name|AL_REG_MASK_SET
argument_list|(
name|reg
argument_list|,
name|EC_RFW_OUT_CFG_DROP_EN
argument_list|)
expr_stmt|;
else|else
name|AL_REG_MASK_CLEAR
argument_list|(
name|reg
argument_list|,
name|EC_RFW_OUT_CFG_DROP_EN
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|out_cfg
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|filter
argument_list|,
name|AL_ETH_RFW_FILTER_SUPPORTED
argument_list|(
name|adapter
operator|->
name|rev_id
argument_list|)
argument_list|,
name|params
operator|->
name|filters
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|filters
operator|&
name|AL_ETH_RFW_FILTER_PROT_INDEX
condition|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|AL_ETH_PROTOCOLS_NUM
condition|;
name|i
operator|++
control|)
block|{
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe_a
index|[
name|i
index|]
operator|.
name|prot_act
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|filter_proto
index|[
name|i
index|]
operator|==
name|AL_TRUE
condition|)
name|AL_REG_MASK_SET
argument_list|(
name|reg
argument_list|,
name|EC_EPE_A_PROT_ACT_DROP
argument_list|)
expr_stmt|;
else|else
name|AL_REG_MASK_CLEAR
argument_list|(
name|reg
argument_list|,
name|EC_EPE_A_PROT_ACT_DROP
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|epe_a
index|[
name|i
index|]
operator|.
name|prot_act
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Configure the receive override filters */
end_comment

begin_function
name|int
name|al_eth_filter_override_config
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|al_eth_filter_override_params
modifier|*
name|params
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|al_assert
argument_list|(
name|params
argument_list|)
expr_stmt|;
comment|/* valid params pointer */
if|if
condition|(
name|params
operator|->
name|filters
operator|&
operator|~
operator|(
name|AL_ETH_RFW_FILTER_SUPPORTED
argument_list|(
name|adapter
operator|->
name|rev_id
argument_list|)
operator|)
condition|)
block|{
name|al_err
argument_list|(
literal|"[%s]: unsupported override filter options (0x%08x)\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|params
operator|->
name|filters
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|filter
argument_list|,
name|AL_ETH_RFW_FILTER_SUPPORTED
argument_list|(
name|adapter
operator|->
name|rev_id
argument_list|)
operator|<<
literal|16
argument_list|,
name|params
operator|->
name|filters
operator|<<
literal|16
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|default_or
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|EC_RFW_DEFAULT_OR_UDMA_MASK
argument_list|,
name|EC_RFW_DEFAULT_OR_UDMA_SHIFT
argument_list|,
name|params
operator|->
name|udma
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|EC_RFW_DEFAULT_OR_QUEUE_MASK
argument_list|,
name|EC_RFW_DEFAULT_OR_QUEUE_SHIFT
argument_list|,
name|params
operator|->
name|qid
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw
operator|.
name|default_or
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_switching_default_bitmap_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint8_t
name|udma_id
parameter_list|,
name|uint8_t
name|udma_uc_bitmask
parameter_list|,
name|uint8_t
name|udma_mc_bitmask
parameter_list|,
name|uint8_t
name|udma_bc_bitmask
parameter_list|)
block|{
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_udma
index|[
name|udma_id
index|]
operator|.
name|uc_udma
argument_list|,
name|udma_uc_bitmask
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_udma
index|[
name|udma_id
index|]
operator|.
name|mc_udma
argument_list|,
name|udma_mc_bitmask
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_udma
index|[
name|udma_id
index|]
operator|.
name|bc_udma
argument_list|,
name|udma_bc_bitmask
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_flow_control_config
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|al_eth_flow_control_params
modifier|*
name|params
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|int
name|i
decl_stmt|;
name|al_assert
argument_list|(
name|params
argument_list|)
expr_stmt|;
comment|/* valid params pointer */
switch|switch
condition|(
name|params
operator|->
name|type
condition|)
block|{
case|case
name|AL_ETH_FLOW_CONTROL_TYPE_LINK_PAUSE
case|:
name|al_dbg
argument_list|(
literal|"[%s]: config flow control to link pause mode.\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
comment|/* config the mac */
if|if
condition|(
name|AL_ETH_IS_1G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
condition|)
block|{
comment|/* set quanta value */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|pause_quant
argument_list|,
name|params
operator|->
name|quanta
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|efc
operator|.
name|xoff_timer_1g
argument_list|,
name|params
operator|->
name|quanta_th
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|AL_ETH_IS_10G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
operator|||
name|AL_ETH_IS_25G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
condition|)
block|{
comment|/* set quanta value */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|cl01_pause_quanta
argument_list|,
name|params
operator|->
name|quanta
argument_list|)
expr_stmt|;
comment|/* set quanta threshold value */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|cl01_quanta_thresh
argument_list|,
name|params
operator|->
name|quanta_th
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* set quanta value */
name|al_eth_40g_mac_reg_write
argument_list|(
name|adapter
argument_list|,
name|ETH_MAC_GEN_V3_MAC_40G_CL01_PAUSE_QUANTA_ADDR
argument_list|,
name|params
operator|->
name|quanta
argument_list|)
expr_stmt|;
comment|/* set quanta threshold value */
name|al_eth_40g_mac_reg_write
argument_list|(
name|adapter
argument_list|,
name|ETH_MAC_GEN_V3_MAC_40G_CL01_QUANTA_THRESH_ADDR
argument_list|,
name|params
operator|->
name|quanta_th
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|params
operator|->
name|obay_enable
operator|==
name|AL_TRUE
condition|)
comment|/* Tx path FIFO, unmask pause_on from MAC when PAUSE packet received */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|efc
operator|.
name|ec_pause
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|efc
operator|.
name|ec_pause
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Rx path */
if|if
condition|(
name|params
operator|->
name|gen_enable
operator|==
name|AL_TRUE
condition|)
comment|/* enable generating xoff from ec fifo almost full indication in hysteresis mode */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|efc
operator|.
name|ec_xoff
argument_list|,
literal|1
operator|<<
name|EC_EFC_EC_XOFF_MASK_2_SHIFT
argument_list|)
expr_stmt|;
else|else
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|efc
operator|.
name|ec_xoff
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|AL_ETH_IS_1G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
condition|)
comment|/* in 1G mode, enable generating xon from ec fifo in hysteresis mode*/
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|efc
operator|.
name|xon
argument_list|,
name|EC_EFC_XON_MASK_2
operator||
name|EC_EFC_XON_MASK_1
argument_list|)
expr_stmt|;
comment|/* set hysteresis mode thresholds */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|efc
operator|.
name|rx_fifo_hyst
argument_list|,
name|params
operator|->
name|rx_fifo_th_low
operator||
operator|(
name|params
operator|->
name|rx_fifo_th_high
operator|<<
name|EC_EFC_RX_FIFO_HYST_TH_HIGH_SHIFT
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|params
operator|->
name|obay_enable
operator|==
name|AL_TRUE
condition|)
comment|/* Tx path UDMA, unmask pause_on for all queues */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|fc_udma
index|[
name|i
index|]
operator|.
name|q_pause_0
argument_list|,
name|params
operator|->
name|prio_q_map
index|[
name|i
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
else|else
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|fc_udma
index|[
name|i
index|]
operator|.
name|q_pause_0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|gen_enable
operator|==
name|AL_TRUE
condition|)
comment|/* Rx path UDMA, enable generating xoff from UDMA queue almost full indication */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|fc_udma
index|[
name|i
index|]
operator|.
name|q_xoff_0
argument_list|,
name|params
operator|->
name|prio_q_map
index|[
name|i
index|]
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
else|else
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|fc_udma
index|[
name|i
index|]
operator|.
name|q_xoff_0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|AL_ETH_FLOW_CONTROL_TYPE_PFC
case|:
name|al_dbg
argument_list|(
literal|"[%s]: config flow control to PFC mode.\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
name|al_assert
argument_list|(
operator|!
name|AL_ETH_IS_1G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
argument_list|)
expr_stmt|;
comment|/* pfc not available for RGMII mode */
empty_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|int
name|prio
decl_stmt|;
for|for
control|(
name|prio
operator|=
literal|0
init|;
name|prio
operator|<
literal|8
condition|;
name|prio
operator|++
control|)
block|{
if|if
condition|(
name|params
operator|->
name|obay_enable
operator|==
name|AL_TRUE
condition|)
comment|/* Tx path UDMA, unmask pause_on for all queues */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|fc_udma
index|[
name|i
index|]
operator|.
name|q_pause_0
operator|+
name|prio
argument_list|,
name|params
operator|->
name|prio_q_map
index|[
name|i
index|]
index|[
name|prio
index|]
argument_list|)
expr_stmt|;
else|else
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|fc_udma
index|[
name|i
index|]
operator|.
name|q_pause_0
operator|+
name|prio
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|gen_enable
operator|==
name|AL_TRUE
condition|)
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|fc_udma
index|[
name|i
index|]
operator|.
name|q_xoff_0
operator|+
name|prio
argument_list|,
name|params
operator|->
name|prio_q_map
index|[
name|i
index|]
index|[
name|prio
index|]
argument_list|)
expr_stmt|;
else|else
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|fc_udma
index|[
name|i
index|]
operator|.
name|q_xoff_0
operator|+
name|prio
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Rx path */
comment|/* enable generating xoff from ec fifo almost full indication in hysteresis mode */
if|if
condition|(
name|params
operator|->
name|gen_enable
operator|==
name|AL_TRUE
condition|)
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|efc
operator|.
name|ec_xoff
argument_list|,
literal|0xFF
operator|<<
name|EC_EFC_EC_XOFF_MASK_2_SHIFT
argument_list|)
expr_stmt|;
else|else
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|efc
operator|.
name|ec_xoff
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* set hysteresis mode thresholds */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|efc
operator|.
name|rx_fifo_hyst
argument_list|,
name|params
operator|->
name|rx_fifo_th_low
operator||
operator|(
name|params
operator|->
name|rx_fifo_th_high
operator|<<
name|EC_EFC_RX_FIFO_HYST_TH_HIGH_SHIFT
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|AL_ETH_IS_10G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
operator|||
name|AL_ETH_IS_25G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
condition|)
block|{
comment|/* config the 10g_mac */
comment|/* set quanta value (same value for all prios) */
name|reg
operator|=
name|params
operator|->
name|quanta
operator||
operator|(
name|params
operator|->
name|quanta
operator|<<
literal|16
operator|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|cl01_pause_quanta
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|cl23_pause_quanta
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|cl45_pause_quanta
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|cl67_pause_quanta
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* set quanta threshold value (same value for all prios) */
name|reg
operator|=
name|params
operator|->
name|quanta_th
operator||
operator|(
name|params
operator|->
name|quanta_th
operator|<<
literal|16
operator|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|cl01_quanta_thresh
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|cl23_quanta_thresh
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|cl45_quanta_thresh
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|cl67_quanta_thresh
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* enable PFC in the 10g_MAC */
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|cmd_cfg
argument_list|)
expr_stmt|;
name|reg
operator||=
literal|1
operator|<<
literal|19
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|cmd_cfg
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* config the 40g_mac */
comment|/* set quanta value (same value for all prios) */
name|reg
operator|=
name|params
operator|->
name|quanta
operator||
operator|(
name|params
operator|->
name|quanta
operator|<<
literal|16
operator|)
expr_stmt|;
name|al_eth_40g_mac_reg_write
argument_list|(
name|adapter
argument_list|,
name|ETH_MAC_GEN_V3_MAC_40G_CL01_PAUSE_QUANTA_ADDR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_eth_40g_mac_reg_write
argument_list|(
name|adapter
argument_list|,
name|ETH_MAC_GEN_V3_MAC_40G_CL23_PAUSE_QUANTA_ADDR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_eth_40g_mac_reg_write
argument_list|(
name|adapter
argument_list|,
name|ETH_MAC_GEN_V3_MAC_40G_CL45_PAUSE_QUANTA_ADDR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_eth_40g_mac_reg_write
argument_list|(
name|adapter
argument_list|,
name|ETH_MAC_GEN_V3_MAC_40G_CL67_PAUSE_QUANTA_ADDR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* set quanta threshold value (same value for all prios) */
name|reg
operator|=
name|params
operator|->
name|quanta_th
operator||
operator|(
name|params
operator|->
name|quanta_th
operator|<<
literal|16
operator|)
expr_stmt|;
name|al_eth_40g_mac_reg_write
argument_list|(
name|adapter
argument_list|,
name|ETH_MAC_GEN_V3_MAC_40G_CL01_QUANTA_THRESH_ADDR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_eth_40g_mac_reg_write
argument_list|(
name|adapter
argument_list|,
name|ETH_MAC_GEN_V3_MAC_40G_CL23_QUANTA_THRESH_ADDR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_eth_40g_mac_reg_write
argument_list|(
name|adapter
argument_list|,
name|ETH_MAC_GEN_V3_MAC_40G_CL45_QUANTA_THRESH_ADDR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_eth_40g_mac_reg_write
argument_list|(
name|adapter
argument_list|,
name|ETH_MAC_GEN_V3_MAC_40G_CL67_QUANTA_THRESH_ADDR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* enable PFC in the 40g_MAC */
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|cmd_cfg
argument_list|)
expr_stmt|;
name|reg
operator||=
literal|1
operator|<<
literal|19
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|cmd_cfg
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_eth_40g_mac_reg_read
argument_list|(
name|adapter
argument_list|,
name|ETH_MAC_GEN_V3_MAC_40G_COMMAND_CONFIG_ADDR
argument_list|)
expr_stmt|;
name|reg
operator||=
name|ETH_MAC_GEN_V3_MAC_40G_COMMAND_CONFIG_PFC_MODE
expr_stmt|;
name|al_eth_40g_mac_reg_write
argument_list|(
name|adapter
argument_list|,
name|ETH_MAC_GEN_V3_MAC_40G_COMMAND_CONFIG_ADDR
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|al_err
argument_list|(
literal|"[%s]: unsupported flow control type %d\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|params
operator|->
name|type
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_vlan_mod_config
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint8_t
name|udma_id
parameter_list|,
name|uint16_t
name|udma_etype
parameter_list|,
name|uint16_t
name|vlan1_data
parameter_list|,
name|uint16_t
name|vlan2_data
parameter_list|)
block|{
name|al_dbg
argument_list|(
literal|"[%s]: config vlan modification registers. udma id %d.\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|udma_id
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tpm_sel
index|[
name|udma_id
index|]
operator|.
name|etype
argument_list|,
name|udma_etype
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tpm_udma
index|[
name|udma_id
index|]
operator|.
name|vlan_data
argument_list|,
name|vlan1_data
operator||
operator|(
name|vlan2_data
operator|<<
literal|16
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_eee_get
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|al_eth_eee_params
modifier|*
name|params
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|al_dbg
argument_list|(
literal|"[%s]: getting eee.\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|eee
operator|.
name|cfg_e
argument_list|)
expr_stmt|;
name|params
operator|->
name|enable
operator|=
operator|(
name|reg
operator|&
name|EC_EEE_CFG_E_ENABLE
operator|)
condition|?
name|AL_TRUE
else|:
name|AL_FALSE
expr_stmt|;
name|params
operator|->
name|tx_eee_timer
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|eee
operator|.
name|pre_cnt
argument_list|)
expr_stmt|;
name|params
operator|->
name|min_interval
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|eee
operator|.
name|post_cnt
argument_list|)
expr_stmt|;
name|params
operator|->
name|stop_cnt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|eee
operator|.
name|stop_cnt
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_eee_config
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|al_eth_eee_params
modifier|*
name|params
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|al_dbg
argument_list|(
literal|"[%s]: config eee.\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|enable
operator|==
literal|0
condition|)
block|{
name|al_dbg
argument_list|(
literal|"[%s]: disable eee.\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|eee
operator|.
name|cfg_e
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|AL_ETH_IS_10G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
operator|||
name|AL_ETH_IS_25G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
condition|)
block|{
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|kr
operator|.
name|pcs_cfg
argument_list|,
name|ETH_MAC_KR_PCS_CFG_EEE_TIMER_VAL_MASK
argument_list|,
operator|(
operator|(
name|AL_ETH_IS_10G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
operator|)
condition|?
name|ETH_MAC_KR_10_PCS_CFG_EEE_TIMER_VAL
else|:
name|ETH_MAC_KR_25_PCS_CFG_EEE_TIMER_VAL
operator|)
operator|<<
name|ETH_MAC_KR_PCS_CFG_EEE_TIMER_VAL_SHIFT
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|adapter
operator|->
name|mac_mode
operator|==
name|AL_ETH_MAC_MODE_XLG_LL_40G
operator|)
operator|||
operator|(
name|adapter
operator|->
name|mac_mode
operator|==
name|AL_ETH_MAC_MODE_XLG_LL_50G
operator|)
condition|)
block|{
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|pcs_40g_ll_eee_cfg
argument_list|,
name|ETH_MAC_GEN_V3_PCS_40G_LL_EEE_CFG_TIMER_VAL_MASK
argument_list|,
operator|(
operator|(
name|adapter
operator|->
name|mac_mode
operator|==
name|AL_ETH_MAC_MODE_XLG_LL_40G
operator|)
condition|?
name|ETH_MAC_XLG_40_PCS_CFG_EEE_TIMER_VAL
else|:
name|ETH_MAC_XLG_50_PCS_CFG_EEE_TIMER_VAL
operator|)
operator|<<
name|ETH_MAC_GEN_V3_PCS_40G_LL_EEE_CFG_TIMER_VAL_SHIFT
argument_list|)
expr_stmt|;
comment|/* set Deep sleep mode as the LPI function (instead of Fast wake mode) */
name|al_eth_40g_pcs_reg_write
argument_list|(
name|adapter
argument_list|,
name|ETH_MAC_GEN_V3_PCS_40G_EEE_CONTROL_ADDR
argument_list|,
name|params
operator|->
name|fast_wake
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
block|}
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|eee
operator|.
name|pre_cnt
argument_list|,
name|params
operator|->
name|tx_eee_timer
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|eee
operator|.
name|post_cnt
argument_list|,
name|params
operator|->
name|min_interval
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|eee
operator|.
name|stop_cnt
argument_list|,
name|params
operator|->
name|stop_cnt
argument_list|)
expr_stmt|;
name|reg
operator|=
name|EC_EEE_CFG_E_MASK_EC_TMI_STOP
operator||
name|EC_EEE_CFG_E_MASK_MAC_EEE
operator||
name|EC_EEE_CFG_E_ENABLE
operator||
name|EC_EEE_CFG_E_USE_EC_TX_FIFO
operator||
name|EC_EEE_CFG_E_USE_EC_RX_FIFO
expr_stmt|;
comment|/* 	 * Addressing RMN: 3732 	 * 	 * RMN description: 	 * When the HW get into eee mode, it can't transmit any pause packet 	 * (when flow control policy is enabled). 	 * In such case, the HW has no way to handle extreme pushback from 	 * the Rx_path fifos. 	 * 	 * Software flow: 	 * Configure RX_FIFO empty as eee mode term. 	 * That way, nothing will prevent pause packet transmittion in 	 * case of extreme pushback from the Rx_path fifos. 	 * 	 */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|eee
operator|.
name|cfg_e
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Timestamp */
end_comment

begin_comment
comment|/* prepare the adapter for doing Timestamps for Rx packets. */
end_comment

begin_function
name|int
name|al_eth_ts_init
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
comment|/*TODO: 	 * return error when: 	 * - working in 1G mode and MACSEC enabled 	 * - RX completion descriptor is not 8 words 	 */
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|gen
operator|.
name|en_ext
argument_list|)
expr_stmt|;
if|if
condition|(
name|AL_ETH_IS_1G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
condition|)
name|reg
operator|&=
operator|~
name|EC_GEN_EN_EXT_PTH_1_10_SEL
expr_stmt|;
else|else
name|reg
operator||=
name|EC_GEN_EN_EXT_PTH_1_10_SEL
expr_stmt|;
comment|/* 	 * set completion bypass so tx timestamps won't be inserted to tx cmpl 	 * (in order to disable unverified flow) 	 */
name|reg
operator||=
name|EC_GEN_EN_EXT_PTH_COMPLETION_BYPASS
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|gen
operator|.
name|en_ext
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/*TODO: add the following when we have updated regs file: 	 * reg_rfw_out_cfg_timestamp_sample_out 		0 (default)  use the timestamp from the SOP info (10G MAC) 		1  use the timestamp from the EOP (1G MAC) (noly when MACSEC is disabled) 	 */
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* read Timestamp sample value of previously transmitted packet. */
end_comment

begin_function
name|int
name|al_eth_tx_ts_val_get
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint8_t
name|ts_index
parameter_list|,
name|uint32_t
modifier|*
name|timestamp
parameter_list|)
block|{
name|al_assert
argument_list|(
name|ts_index
operator|<
name|AL_ETH_PTH_TX_SAMPLES_NUM
argument_list|)
expr_stmt|;
comment|/* in 1G mode, only indexes 1-7 are allowed*/
if|if
condition|(
name|AL_ETH_IS_1G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
condition|)
block|{
name|al_assert
argument_list|(
name|ts_index
operator|<=
literal|7
argument_list|)
expr_stmt|;
name|al_assert
argument_list|(
name|ts_index
operator|>=
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/*TODO: check if sample is valid */
operator|*
name|timestamp
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth_db
index|[
name|ts_index
index|]
operator|.
name|ts
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Read the systime value */
end_comment

begin_function
name|int
name|al_eth_pth_systime_read
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|al_eth_pth_time
modifier|*
name|systime
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
comment|/* first we must read the subseconds MSB so the seconds register will be 	 * shadowed 	 */
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth
operator|.
name|system_time_subseconds_msb
argument_list|)
expr_stmt|;
name|systime
operator|->
name|femto
operator|=
operator|(
name|uint64_t
operator|)
name|reg
operator|<<
literal|18
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth
operator|.
name|system_time_seconds
argument_list|)
expr_stmt|;
name|systime
operator|->
name|seconds
operator|=
name|reg
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Set the clock period to a given value. */
end_comment

begin_function
name|int
name|al_eth_pth_clk_period_write
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint64_t
name|clk_period
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
comment|/* first write the LSB so it will be shadowed */
comment|/* bits 31:14 of the clock period lsb register contains bits 17:0 of the 	 * period. 	 */
name|reg
operator|=
operator|(
name|clk_period
operator|&
name|AL_BIT_MASK
argument_list|(
literal|18
argument_list|)
operator|)
operator|<<
name|EC_PTH_CLOCK_PERIOD_LSB_VAL_SHIFT
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth
operator|.
name|clock_period_lsb
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|clk_period
operator|>>
literal|18
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth
operator|.
name|clock_period_msb
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Configure the systime internal update */
end_comment

begin_function
name|int
name|al_eth_pth_int_update_config
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|al_eth_pth_int_update_params
modifier|*
name|params
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth
operator|.
name|int_update_ctrl
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|enable
operator|==
name|AL_FALSE
condition|)
block|{
name|reg
operator|&=
operator|~
name|EC_PTH_INT_UPDATE_CTRL_INT_TRIG_EN
expr_stmt|;
block|}
else|else
block|{
name|reg
operator||=
name|EC_PTH_INT_UPDATE_CTRL_INT_TRIG_EN
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|EC_PTH_INT_UPDATE_CTRL_UPDATE_METHOD_MASK
argument_list|,
name|EC_PTH_INT_UPDATE_CTRL_UPDATE_METHOD_SHIFT
argument_list|,
name|params
operator|->
name|method
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|trigger
operator|==
name|AL_ETH_PTH_INT_TRIG_REG_WRITE
condition|)
name|reg
operator||=
name|EC_PTH_INT_UPDATE_CTRL_UPDATE_TRIG
expr_stmt|;
else|else
name|reg
operator|&=
operator|~
name|EC_PTH_INT_UPDATE_CTRL_UPDATE_TRIG
expr_stmt|;
block|}
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth
operator|.
name|int_update_ctrl
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* set internal update time */
end_comment

begin_function
name|int
name|al_eth_pth_int_update_time_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|al_eth_pth_time
modifier|*
name|time
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth
operator|.
name|int_update_seconds
argument_list|,
name|time
operator|->
name|seconds
argument_list|)
expr_stmt|;
name|reg
operator|=
name|time
operator|->
name|femto
operator|&
name|AL_BIT_MASK
argument_list|(
literal|18
argument_list|)
expr_stmt|;
name|reg
operator|=
name|reg
operator|<<
name|EC_PTH_INT_UPDATE_SUBSECONDS_LSB_VAL_SHIFT
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth
operator|.
name|int_update_subseconds_lsb
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|time
operator|->
name|femto
operator|>>
literal|18
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth
operator|.
name|int_update_subseconds_msb
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Configure the systime external update */
end_comment

begin_function
name|int
name|al_eth_pth_ext_update_config
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|al_eth_pth_ext_update_params
modifier|*
name|params
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth
operator|.
name|int_update_ctrl
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|EC_PTH_INT_UPDATE_CTRL_UPDATE_METHOD_MASK
argument_list|,
name|EC_PTH_INT_UPDATE_CTRL_UPDATE_METHOD_SHIFT
argument_list|,
name|params
operator|->
name|method
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|EC_PTH_EXT_UPDATE_CTRL_EXT_TRIG_EN_MASK
argument_list|,
name|EC_PTH_EXT_UPDATE_CTRL_EXT_TRIG_EN_SHIFT
argument_list|,
name|params
operator|->
name|triggers
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth
operator|.
name|int_update_ctrl
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* set external update time */
end_comment

begin_function
name|int
name|al_eth_pth_ext_update_time_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|al_eth_pth_time
modifier|*
name|time
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth
operator|.
name|ext_update_seconds
argument_list|,
name|time
operator|->
name|seconds
argument_list|)
expr_stmt|;
name|reg
operator|=
name|time
operator|->
name|femto
operator|&
name|AL_BIT_MASK
argument_list|(
literal|18
argument_list|)
expr_stmt|;
name|reg
operator|=
name|reg
operator|<<
name|EC_PTH_EXT_UPDATE_SUBSECONDS_LSB_VAL_SHIFT
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth
operator|.
name|ext_update_subseconds_lsb
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|time
operator|->
name|femto
operator|>>
literal|18
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth
operator|.
name|ext_update_subseconds_msb
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_comment
comment|/* set the read compensation delay */
end_comment

begin_function
name|int
name|al_eth_pth_read_compensation_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint64_t
name|subseconds
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
comment|/* first write to lsb to ensure atomicity */
name|reg
operator|=
operator|(
name|subseconds
operator|&
name|AL_BIT_MASK
argument_list|(
literal|18
argument_list|)
operator|)
operator|<<
name|EC_PTH_READ_COMPENSATION_SUBSECONDS_LSB_VAL_SHIFT
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth
operator|.
name|read_compensation_subseconds_lsb
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|subseconds
operator|>>
literal|18
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth
operator|.
name|read_compensation_subseconds_msb
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* set the internal write compensation delay */
end_comment

begin_function
name|int
name|al_eth_pth_int_write_compensation_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint64_t
name|subseconds
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
comment|/* first write to lsb to ensure atomicity */
name|reg
operator|=
operator|(
name|subseconds
operator|&
name|AL_BIT_MASK
argument_list|(
literal|18
argument_list|)
operator|)
operator|<<
name|EC_PTH_INT_WRITE_COMPENSATION_SUBSECONDS_LSB_VAL_SHIFT
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth
operator|.
name|int_write_compensation_subseconds_lsb
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|subseconds
operator|>>
literal|18
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth
operator|.
name|int_write_compensation_subseconds_msb
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* set the external write compensation delay */
end_comment

begin_function
name|int
name|al_eth_pth_ext_write_compensation_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint64_t
name|subseconds
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
comment|/* first write to lsb to ensure atomicity */
name|reg
operator|=
operator|(
name|subseconds
operator|&
name|AL_BIT_MASK
argument_list|(
literal|18
argument_list|)
operator|)
operator|<<
name|EC_PTH_EXT_WRITE_COMPENSATION_SUBSECONDS_LSB_VAL_SHIFT
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth
operator|.
name|ext_write_compensation_subseconds_lsb
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|subseconds
operator|>>
literal|18
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth
operator|.
name|ext_write_compensation_subseconds_msb
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* set the sync compensation delay */
end_comment

begin_function
name|int
name|al_eth_pth_sync_compensation_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint64_t
name|subseconds
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
comment|/* first write to lsb to ensure atomicity */
name|reg
operator|=
operator|(
name|subseconds
operator|&
name|AL_BIT_MASK
argument_list|(
literal|18
argument_list|)
operator|)
operator|<<
name|EC_PTH_SYNC_COMPENSATION_SUBSECONDS_LSB_VAL_SHIFT
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth
operator|.
name|sync_compensation_subseconds_lsb
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|subseconds
operator|>>
literal|18
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth
operator|.
name|sync_compensation_subseconds_msb
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Configure an output pulse */
end_comment

begin_function
name|int
name|al_eth_pth_pulse_out_config
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|al_eth_pth_pulse_out_params
modifier|*
name|params
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
if|if
condition|(
name|params
operator|->
name|index
operator|>=
name|AL_ETH_PTH_PULSE_OUT_NUM
condition|)
block|{
name|al_err
argument_list|(
literal|"eth [%s] PTH out pulse index out of range\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth_egress
index|[
name|params
operator|->
name|index
index|]
operator|.
name|trigger_ctrl
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|enable
operator|==
name|AL_FALSE
condition|)
block|{
name|reg
operator|&=
operator|~
name|EC_PTH_EGRESS_TRIGGER_CTRL_EN
expr_stmt|;
block|}
else|else
block|{
name|reg
operator||=
name|EC_PTH_EGRESS_TRIGGER_CTRL_EN
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|periodic
operator|==
name|AL_FALSE
condition|)
name|reg
operator|&=
operator|~
name|EC_PTH_EGRESS_TRIGGER_CTRL_PERIODIC
expr_stmt|;
else|else
name|reg
operator||=
name|EC_PTH_EGRESS_TRIGGER_CTRL_PERIODIC
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|EC_PTH_EGRESS_TRIGGER_CTRL_PERIOD_SUBSEC_MASK
argument_list|,
name|EC_PTH_EGRESS_TRIGGER_CTRL_PERIOD_SUBSEC_SHIFT
argument_list|,
name|params
operator|->
name|period_us
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|EC_PTH_EGRESS_TRIGGER_CTRL_PERIOD_SEC_MASK
argument_list|,
name|EC_PTH_EGRESS_TRIGGER_CTRL_PERIOD_SEC_SHIFT
argument_list|,
name|params
operator|->
name|period_sec
argument_list|)
expr_stmt|;
block|}
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth_egress
index|[
name|params
operator|->
name|index
index|]
operator|.
name|trigger_ctrl
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* set trigger time */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth_egress
index|[
name|params
operator|->
name|index
index|]
operator|.
name|trigger_seconds
argument_list|,
name|params
operator|->
name|start_time
operator|.
name|seconds
argument_list|)
expr_stmt|;
name|reg
operator|=
name|params
operator|->
name|start_time
operator|.
name|femto
operator|&
name|AL_BIT_MASK
argument_list|(
literal|18
argument_list|)
expr_stmt|;
name|reg
operator|=
name|reg
operator|<<
name|EC_PTH_EGRESS_TRIGGER_SUBSECONDS_LSB_VAL_SHIFT
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth_egress
index|[
name|params
operator|->
name|index
index|]
operator|.
name|trigger_subseconds_lsb
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|params
operator|->
name|start_time
operator|.
name|femto
operator|>>
literal|18
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth_egress
index|[
name|params
operator|->
name|index
index|]
operator|.
name|trigger_subseconds_msb
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* set pulse width */
name|reg
operator|=
name|params
operator|->
name|pulse_width
operator|&
name|AL_BIT_MASK
argument_list|(
literal|18
argument_list|)
expr_stmt|;
name|reg
operator|=
name|reg
operator|<<
name|EC_PTH_EGRESS_PULSE_WIDTH_SUBSECONDS_LSB_VAL_SHIFT
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth_egress
index|[
name|params
operator|->
name|index
index|]
operator|.
name|pulse_width_subseconds_lsb
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|params
operator|->
name|pulse_width
operator|>>
literal|18
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|pth_egress
index|[
name|params
operator|->
name|index
index|]
operator|.
name|pulse_width_subseconds_msb
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** get link status */
end_comment

begin_function
name|int
name|al_eth_link_status_get
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|al_eth_link_status
modifier|*
name|status
parameter_list|)
block|{
name|uint32_t
name|reg
decl_stmt|;
if|if
condition|(
name|AL_ETH_IS_10G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
operator|||
name|AL_ETH_IS_25G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
condition|)
block|{
name|status
operator|->
name|link_up
operator|=
name|AL_FALSE
expr_stmt|;
name|status
operator|->
name|local_fault
operator|=
name|AL_TRUE
expr_stmt|;
name|status
operator|->
name|remote_fault
operator|=
name|AL_TRUE
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|kr
operator|.
name|pcs_addr
argument_list|,
name|ETH_MAC_KR_PCS_BASE_R_STATUS2
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|kr
operator|.
name|pcs_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|AL_BIT
argument_list|(
literal|15
argument_list|)
condition|)
block|{
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|status
argument_list|)
expr_stmt|;
name|status
operator|->
name|remote_fault
operator|=
operator|(
operator|(
name|reg
operator|&
name|ETH_MAC_GEN_MAC_10G_STAT_REM_FAULT
operator|)
condition|?
name|AL_TRUE
else|:
name|AL_FALSE
operator|)
expr_stmt|;
name|status
operator|->
name|local_fault
operator|=
operator|(
operator|(
name|reg
operator|&
name|ETH_MAC_GEN_MAC_10G_STAT_LOC_FAULT
operator|)
condition|?
name|AL_TRUE
else|:
name|AL_FALSE
operator|)
expr_stmt|;
name|status
operator|->
name|link_up
operator|=
operator|(
operator|(
name|status
operator|->
name|remote_fault
operator|==
name|AL_FALSE
operator|)
operator|&&
operator|(
name|status
operator|->
name|local_fault
operator|==
name|AL_FALSE
operator|)
operator|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|adapter
operator|->
name|mac_mode
operator|==
name|AL_ETH_MAC_MODE_SGMII
condition|)
block|{
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|sgmii
operator|.
name|reg_addr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* 		 * This register is latched low so need to read twice to get 		 * the current link status 		 */
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|sgmii
operator|.
name|reg_data
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|sgmii
operator|.
name|reg_data
argument_list|)
expr_stmt|;
name|status
operator|->
name|link_up
operator|=
name|AL_FALSE
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|AL_BIT
argument_list|(
literal|2
argument_list|)
condition|)
name|status
operator|->
name|link_up
operator|=
name|AL_TRUE
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|sgmii
operator|.
name|link_stat
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|reg
operator|&
name|AL_BIT
argument_list|(
literal|3
argument_list|)
operator|)
operator|==
literal|0
condition|)
name|status
operator|->
name|link_up
operator|=
name|AL_FALSE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|adapter
operator|->
name|mac_mode
operator|==
name|AL_ETH_MAC_MODE_RGMII
condition|)
block|{
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|rgmii_stat
argument_list|)
expr_stmt|;
name|status
operator|->
name|link_up
operator|=
name|AL_FALSE
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|AL_BIT
argument_list|(
literal|4
argument_list|)
condition|)
name|status
operator|->
name|link_up
operator|=
name|AL_TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|adapter
operator|->
name|mac_mode
operator|==
name|AL_ETH_MAC_MODE_XLG_LL_25G
condition|)
block|{
name|status
operator|->
name|link_up
operator|=
name|AL_FALSE
expr_stmt|;
name|status
operator|->
name|local_fault
operator|=
name|AL_TRUE
expr_stmt|;
name|status
operator|->
name|remote_fault
operator|=
name|AL_TRUE
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|pcs_40g_ll_status
argument_list|)
expr_stmt|;
name|status
operator|->
name|link_up
operator|=
name|AL_FALSE
expr_stmt|;
if|if
condition|(
operator|(
name|reg
operator|&
literal|0xF
operator|)
operator|==
literal|0xF
condition|)
block|{
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_40g_ll_status
argument_list|)
expr_stmt|;
name|status
operator|->
name|remote_fault
operator|=
operator|(
operator|(
name|reg
operator|&
name|ETH_MAC_GEN_V3_MAC_40G_LL_STATUS_REM_FAULT
operator|)
condition|?
name|AL_TRUE
else|:
name|AL_FALSE
operator|)
expr_stmt|;
name|status
operator|->
name|local_fault
operator|=
operator|(
operator|(
name|reg
operator|&
name|ETH_MAC_GEN_V3_MAC_40G_LL_STATUS_LOC_FAULT
operator|)
condition|?
name|AL_TRUE
else|:
name|AL_FALSE
operator|)
expr_stmt|;
name|status
operator|->
name|link_up
operator|=
operator|(
operator|(
name|status
operator|->
name|remote_fault
operator|==
name|AL_FALSE
operator|)
operator|&&
operator|(
name|status
operator|->
name|local_fault
operator|==
name|AL_FALSE
operator|)
operator|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|adapter
operator|->
name|mac_mode
operator|==
name|AL_ETH_MAC_MODE_XLG_LL_40G
operator|)
operator|||
operator|(
name|adapter
operator|->
name|mac_mode
operator|==
name|AL_ETH_MAC_MODE_XLG_LL_50G
operator|)
condition|)
block|{
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|pcs_40g_ll_status
argument_list|)
expr_stmt|;
name|status
operator|->
name|link_up
operator|=
name|AL_FALSE
expr_stmt|;
if|if
condition|(
operator|(
name|reg
operator|&
literal|0x1F
operator|)
operator|==
literal|0x1F
condition|)
block|{
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|mac_40g_ll_status
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|reg
operator|&
operator|(
name|ETH_MAC_GEN_V3_MAC_40G_LL_STATUS_REM_FAULT
operator||
name|ETH_MAC_GEN_V3_MAC_40G_LL_STATUS_LOC_FAULT
operator|)
operator|)
operator|==
literal|0
condition|)
name|status
operator|->
name|link_up
operator|=
name|AL_TRUE
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* not implemented yet */
return|return
operator|-
name|EPERM
return|;
block|}
name|al_dbg
argument_list|(
literal|"[%s]: mac %s port. link_status: %s.\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|al_eth_mac_mode_str
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
argument_list|,
operator|(
name|status
operator|->
name|link_up
operator|==
name|AL_TRUE
operator|)
condition|?
literal|"LINK_UP"
else|:
literal|"LINK_DOWN"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_link_status_clear
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|)
block|{
name|int
name|status
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|AL_ETH_IS_10G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
operator|||
name|AL_ETH_IS_25G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
condition|)
block|{
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|kr
operator|.
name|pcs_addr
argument_list|,
name|ETH_MAC_KR_PCS_BASE_R_STATUS2
argument_list|)
expr_stmt|;
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|kr
operator|.
name|pcs_data
argument_list|)
expr_stmt|;
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|status
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
operator|-
literal|1
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_comment
comment|/** set LED mode and value */
end_comment

begin_function
name|int
name|al_eth_led_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|al_bool
name|link_is_up
parameter_list|)
block|{
name|uint32_t
name|reg
init|=
literal|0
decl_stmt|;
name|uint32_t
name|mode
init|=
name|ETH_MAC_GEN_LED_CFG_SEL_DEFAULT_REG
decl_stmt|;
if|if
condition|(
name|link_is_up
condition|)
name|mode
operator|=
name|ETH_MAC_GEN_LED_CFG_SEL_LINK_ACTIVITY
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|ETH_MAC_GEN_LED_CFG_SEL_MASK
argument_list|,
name|ETH_MAC_GEN_LED_CFG_SEL_SHIFT
argument_list|,
name|mode
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|ETH_MAC_GEN_LED_CFG_BLINK_TIMER_MASK
argument_list|,
name|ETH_MAC_GEN_LED_CFG_BLINK_TIMER_SHIFT
argument_list|,
name|ETH_MAC_GEN_LED_CFG_BLINK_TIMER_VAL
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|ETH_MAC_GEN_LED_CFG_ACT_TIMER_MASK
argument_list|,
name|ETH_MAC_GEN_LED_CFG_ACT_TIMER_SHIFT
argument_list|,
name|ETH_MAC_GEN_LED_CFG_ACT_TIMER_VAL
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen
operator|.
name|led_cfg
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* get statistics */
end_comment

begin_function
name|int
name|al_eth_mac_stats_get
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|al_eth_mac_stats
modifier|*
name|stats
parameter_list|)
block|{
name|al_assert
argument_list|(
name|stats
argument_list|)
expr_stmt|;
name|al_memset
argument_list|(
name|stats
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|al_eth_mac_stats
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|AL_ETH_IS_1G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
condition|)
block|{
name|struct
name|al_eth_mac_1g_stats
name|__iomem
modifier|*
name|reg_stats
init|=
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|stats
decl_stmt|;
name|stats
operator|->
name|ifInUcastPkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|ifInUcastPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifInMulticastPkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|ifInMulticastPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifInBroadcastPkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|ifInBroadcastPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifOutUcastPkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|ifOutUcastPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifOutMulticastPkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|ifOutMulticastPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifOutBroadcastPkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|ifOutBroadcastPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifInErrors
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|ifInErrors
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifOutErrors
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|ifOutErrors
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aFramesReceivedOK
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|aFramesReceivedOK
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aFramesTransmittedOK
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|aFramesTransmittedOK
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aOctetsReceivedOK
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|aOctetsReceivedOK
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aOctetsTransmittedOK
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|aOctetsTransmittedOK
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsUndersizePkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsUndersizePkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsFragments
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsFragments
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsJabbers
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsJabbers
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsOversizePkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsOversizePkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aFrameCheckSequenceErrors
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|aFrameCheckSequenceErrors
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aAlignmentErrors
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|aAlignmentErrors
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsDropEvents
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsDropEvents
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aPAUSEMACCtrlFramesTransmitted
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|aPAUSEMACCtrlFramesTransmitted
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aPAUSEMACCtrlFramesReceived
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|aPAUSEMACCtrlFramesReceived
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aFrameTooLongErrors
operator|=
literal|0
expr_stmt|;
comment|/* N/A */
name|stats
operator|->
name|aInRangeLengthErrors
operator|=
literal|0
expr_stmt|;
comment|/* N/A */
name|stats
operator|->
name|VLANTransmittedOK
operator|=
literal|0
expr_stmt|;
comment|/* N/A */
name|stats
operator|->
name|VLANReceivedOK
operator|=
literal|0
expr_stmt|;
comment|/* N/A */
name|stats
operator|->
name|etherStatsOctets
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsOctets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts64Octets
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsPkts64Octets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts65to127Octets
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsPkts65to127Octets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts128to255Octets
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsPkts128to255Octets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts256to511Octets
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsPkts256to511Octets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts512to1023Octets
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsPkts512to1023Octets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts1024to1518Octets
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsPkts1024to1518Octets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts1519toX
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsPkts1519toX
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|AL_ETH_IS_10G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
operator|||
name|AL_ETH_IS_25G_MAC
argument_list|(
name|adapter
operator|->
name|mac_mode
argument_list|)
condition|)
block|{
if|if
condition|(
name|adapter
operator|->
name|rev_id
operator|<
name|AL_ETH_REV_ID_3
condition|)
block|{
name|struct
name|al_eth_mac_10g_stats_v2
name|__iomem
modifier|*
name|reg_stats
init|=
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|stats
operator|.
name|v2
decl_stmt|;
name|uint64_t
name|octets
decl_stmt|;
name|stats
operator|->
name|ifInUcastPkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|ifInUcastPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifInMulticastPkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|ifInMulticastPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifInBroadcastPkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|ifInBroadcastPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifOutUcastPkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|ifOutUcastPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifOutMulticastPkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|ifOutMulticastPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifOutBroadcastPkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|ifOutBroadcastPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifInErrors
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|ifInErrors
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifOutErrors
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|ifOutErrors
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aFramesReceivedOK
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|aFramesReceivedOK
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aFramesTransmittedOK
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|aFramesTransmittedOK
argument_list|)
expr_stmt|;
comment|/* aOctetsReceivedOK = ifInOctets - 18 * aFramesReceivedOK - 4 * VLANReceivedOK */
name|octets
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|ifInOctetsL
argument_list|)
expr_stmt|;
name|octets
operator||=
call|(
name|uint64_t
call|)
argument_list|(
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|ifInOctetsH
argument_list|)
argument_list|)
operator|<<
literal|32
expr_stmt|;
name|octets
operator|-=
literal|18
operator|*
name|stats
operator|->
name|aFramesReceivedOK
expr_stmt|;
name|octets
operator|-=
literal|4
operator|*
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|VLANReceivedOK
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aOctetsReceivedOK
operator|=
name|octets
expr_stmt|;
comment|/* aOctetsTransmittedOK = ifOutOctets - 18 * aFramesTransmittedOK - 4 * VLANTransmittedOK */
name|octets
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|ifOutOctetsL
argument_list|)
expr_stmt|;
name|octets
operator||=
call|(
name|uint64_t
call|)
argument_list|(
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|ifOutOctetsH
argument_list|)
argument_list|)
operator|<<
literal|32
expr_stmt|;
name|octets
operator|-=
literal|18
operator|*
name|stats
operator|->
name|aFramesTransmittedOK
expr_stmt|;
name|octets
operator|-=
literal|4
operator|*
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|VLANTransmittedOK
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aOctetsTransmittedOK
operator|=
name|octets
expr_stmt|;
name|stats
operator|->
name|etherStatsUndersizePkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsUndersizePkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsFragments
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsFragments
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsJabbers
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsJabbers
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsOversizePkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsOversizePkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aFrameCheckSequenceErrors
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|aFrameCheckSequenceErrors
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aAlignmentErrors
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|aAlignmentErrors
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsDropEvents
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsDropEvents
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aPAUSEMACCtrlFramesTransmitted
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|aPAUSEMACCtrlFramesTransmitted
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aPAUSEMACCtrlFramesReceived
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|aPAUSEMACCtrlFramesReceived
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aFrameTooLongErrors
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|aFrameTooLongErrors
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aInRangeLengthErrors
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|aInRangeLengthErrors
argument_list|)
expr_stmt|;
name|stats
operator|->
name|VLANTransmittedOK
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|VLANTransmittedOK
argument_list|)
expr_stmt|;
name|stats
operator|->
name|VLANReceivedOK
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|VLANReceivedOK
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsOctets
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsOctets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts64Octets
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsPkts64Octets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts65to127Octets
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsPkts65to127Octets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts128to255Octets
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsPkts128to255Octets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts256to511Octets
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsPkts256to511Octets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts512to1023Octets
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsPkts512to1023Octets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts1024to1518Octets
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsPkts1024to1518Octets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts1519toX
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_stats
operator|->
name|etherStatsPkts1519toX
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|al_eth_mac_10g_stats_v3_rx
name|__iomem
modifier|*
name|reg_rx_stats
init|=
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|stats
operator|.
name|v3
operator|.
name|rx
decl_stmt|;
name|struct
name|al_eth_mac_10g_stats_v3_tx
name|__iomem
modifier|*
name|reg_tx_stats
init|=
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|stats
operator|.
name|v3
operator|.
name|tx
decl_stmt|;
name|uint64_t
name|octets
decl_stmt|;
name|stats
operator|->
name|ifInUcastPkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|ifInUcastPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifInMulticastPkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|ifInMulticastPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifInBroadcastPkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|ifInBroadcastPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifOutUcastPkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_tx_stats
operator|->
name|ifUcastPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifOutMulticastPkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_tx_stats
operator|->
name|ifMulticastPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifOutBroadcastPkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_tx_stats
operator|->
name|ifBroadcastPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifInErrors
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|ifInErrors
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifOutErrors
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_tx_stats
operator|->
name|ifOutErrors
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aFramesReceivedOK
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|FramesOK
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aFramesTransmittedOK
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_tx_stats
operator|->
name|FramesOK
argument_list|)
expr_stmt|;
comment|/* aOctetsReceivedOK = ifInOctets - 18 * aFramesReceivedOK - 4 * VLANReceivedOK */
name|octets
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|ifOctetsL
argument_list|)
expr_stmt|;
name|octets
operator||=
call|(
name|uint64_t
call|)
argument_list|(
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|ifOctetsH
argument_list|)
argument_list|)
operator|<<
literal|32
expr_stmt|;
name|octets
operator|-=
literal|18
operator|*
name|stats
operator|->
name|aFramesReceivedOK
expr_stmt|;
name|octets
operator|-=
literal|4
operator|*
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|VLANOK
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aOctetsReceivedOK
operator|=
name|octets
expr_stmt|;
comment|/* aOctetsTransmittedOK = ifOutOctets - 18 * aFramesTransmittedOK - 4 * VLANTransmittedOK */
name|octets
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_tx_stats
operator|->
name|ifOctetsL
argument_list|)
expr_stmt|;
name|octets
operator||=
call|(
name|uint64_t
call|)
argument_list|(
name|al_reg_read32
argument_list|(
operator|&
name|reg_tx_stats
operator|->
name|ifOctetsH
argument_list|)
argument_list|)
operator|<<
literal|32
expr_stmt|;
name|octets
operator|-=
literal|18
operator|*
name|stats
operator|->
name|aFramesTransmittedOK
expr_stmt|;
name|octets
operator|-=
literal|4
operator|*
name|al_reg_read32
argument_list|(
operator|&
name|reg_tx_stats
operator|->
name|VLANOK
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aOctetsTransmittedOK
operator|=
name|octets
expr_stmt|;
name|stats
operator|->
name|etherStatsUndersizePkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsUndersizePkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsFragments
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsFragments
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsJabbers
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsJabbers
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsOversizePkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsOversizePkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aFrameCheckSequenceErrors
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|CRCErrors
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aAlignmentErrors
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|aAlignmentErrors
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsDropEvents
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsDropEvents
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aPAUSEMACCtrlFramesTransmitted
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_tx_stats
operator|->
name|aPAUSEMACCtrlFrames
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aPAUSEMACCtrlFramesReceived
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|aPAUSEMACCtrlFrames
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aFrameTooLongErrors
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|aFrameTooLong
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aInRangeLengthErrors
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|aInRangeLengthErrors
argument_list|)
expr_stmt|;
name|stats
operator|->
name|VLANTransmittedOK
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_tx_stats
operator|->
name|VLANOK
argument_list|)
expr_stmt|;
name|stats
operator|->
name|VLANReceivedOK
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|VLANOK
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsOctets
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsOctets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts64Octets
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsPkts64Octets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts65to127Octets
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsPkts65to127Octets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts128to255Octets
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsPkts128to255Octets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts256to511Octets
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsPkts256to511Octets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts512to1023Octets
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsPkts512to1023Octets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts1024to1518Octets
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsPkts1024to1518Octets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts1519toX
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsPkts1519toMax
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|struct
name|al_eth_mac_10g_stats_v3_rx
name|__iomem
modifier|*
name|reg_rx_stats
init|=
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|stats
operator|.
name|v3
operator|.
name|rx
decl_stmt|;
name|struct
name|al_eth_mac_10g_stats_v3_tx
name|__iomem
modifier|*
name|reg_tx_stats
init|=
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|stats
operator|.
name|v3
operator|.
name|tx
decl_stmt|;
name|uint64_t
name|octets
decl_stmt|;
comment|/* 40G MAC statistics registers are the same, only read indirectly */
define|#
directive|define
name|_40g_mac_reg_read32
parameter_list|(
name|field
parameter_list|)
value|al_eth_40g_mac_reg_read(adapter,	\ 			((uint8_t *)(field)) - ((uint8_t *)&adapter->mac_regs_base->mac_10g))
name|stats
operator|->
name|ifInUcastPkts
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|ifInUcastPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifInMulticastPkts
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|ifInMulticastPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifInBroadcastPkts
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|ifInBroadcastPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifOutUcastPkts
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_tx_stats
operator|->
name|ifUcastPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifOutMulticastPkts
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_tx_stats
operator|->
name|ifMulticastPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifOutBroadcastPkts
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_tx_stats
operator|->
name|ifBroadcastPkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifInErrors
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|ifInErrors
argument_list|)
expr_stmt|;
name|stats
operator|->
name|ifOutErrors
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_tx_stats
operator|->
name|ifOutErrors
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aFramesReceivedOK
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|FramesOK
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aFramesTransmittedOK
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_tx_stats
operator|->
name|FramesOK
argument_list|)
expr_stmt|;
comment|/* aOctetsReceivedOK = ifInOctets - 18 * aFramesReceivedOK - 4 * VLANReceivedOK */
name|octets
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|ifOctetsL
argument_list|)
expr_stmt|;
name|octets
operator||=
call|(
name|uint64_t
call|)
argument_list|(
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|ifOctetsH
argument_list|)
argument_list|)
operator|<<
literal|32
expr_stmt|;
name|octets
operator|-=
literal|18
operator|*
name|stats
operator|->
name|aFramesReceivedOK
expr_stmt|;
name|octets
operator|-=
literal|4
operator|*
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|VLANOK
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aOctetsReceivedOK
operator|=
name|octets
expr_stmt|;
comment|/* aOctetsTransmittedOK = ifOutOctets - 18 * aFramesTransmittedOK - 4 * VLANTransmittedOK */
name|octets
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_tx_stats
operator|->
name|ifOctetsL
argument_list|)
expr_stmt|;
name|octets
operator||=
call|(
name|uint64_t
call|)
argument_list|(
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_tx_stats
operator|->
name|ifOctetsH
argument_list|)
argument_list|)
operator|<<
literal|32
expr_stmt|;
name|octets
operator|-=
literal|18
operator|*
name|stats
operator|->
name|aFramesTransmittedOK
expr_stmt|;
name|octets
operator|-=
literal|4
operator|*
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_tx_stats
operator|->
name|VLANOK
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aOctetsTransmittedOK
operator|=
name|octets
expr_stmt|;
name|stats
operator|->
name|etherStatsUndersizePkts
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsUndersizePkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsFragments
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsFragments
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsJabbers
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsJabbers
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsOversizePkts
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsOversizePkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aFrameCheckSequenceErrors
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|CRCErrors
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aAlignmentErrors
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|aAlignmentErrors
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsDropEvents
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsDropEvents
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aPAUSEMACCtrlFramesTransmitted
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_tx_stats
operator|->
name|aPAUSEMACCtrlFrames
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aPAUSEMACCtrlFramesReceived
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|aPAUSEMACCtrlFrames
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aFrameTooLongErrors
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|aFrameTooLong
argument_list|)
expr_stmt|;
name|stats
operator|->
name|aInRangeLengthErrors
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|aInRangeLengthErrors
argument_list|)
expr_stmt|;
name|stats
operator|->
name|VLANTransmittedOK
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_tx_stats
operator|->
name|VLANOK
argument_list|)
expr_stmt|;
name|stats
operator|->
name|VLANReceivedOK
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|VLANOK
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsOctets
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsOctets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts64Octets
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsPkts64Octets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts65to127Octets
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsPkts65to127Octets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts128to255Octets
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsPkts128to255Octets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts256to511Octets
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsPkts256to511Octets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts512to1023Octets
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsPkts512to1023Octets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts1024to1518Octets
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsPkts1024to1518Octets
argument_list|)
expr_stmt|;
name|stats
operator|->
name|etherStatsPkts1519toX
operator|=
name|_40g_mac_reg_read32
argument_list|(
operator|&
name|reg_rx_stats
operator|->
name|etherStatsPkts1519toMax
argument_list|)
expr_stmt|;
block|}
name|stats
operator|->
name|eee_in
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|stat
operator|.
name|eee_in
argument_list|)
expr_stmt|;
name|stats
operator|->
name|eee_out
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|stat
operator|.
name|eee_out
argument_list|)
expr_stmt|;
comment|/*	stats->etherStatsPkts = 1; */
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** * read ec_stat_counters */
end_comment

begin_function
name|int
name|al_eth_ec_stats_get
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|al_eth_ec_stats
modifier|*
name|stats
parameter_list|)
block|{
name|al_assert
argument_list|(
name|stats
argument_list|)
expr_stmt|;
name|stats
operator|->
name|faf_in_rx_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|faf_in_rx_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|faf_in_rx_short
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|faf_in_rx_short
argument_list|)
expr_stmt|;
name|stats
operator|->
name|faf_in_rx_long
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|faf_in_rx_long
argument_list|)
expr_stmt|;
name|stats
operator|->
name|faf_out_rx_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|faf_out_rx_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|faf_out_rx_short
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|faf_out_rx_short
argument_list|)
expr_stmt|;
name|stats
operator|->
name|faf_out_rx_long
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|faf_out_rx_long
argument_list|)
expr_stmt|;
name|stats
operator|->
name|faf_out_drop
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|faf_out_drop
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rxf_in_rx_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|rxf_in_rx_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rxf_in_fifo_err
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|rxf_in_fifo_err
argument_list|)
expr_stmt|;
name|stats
operator|->
name|lbf_in_rx_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|lbf_in_rx_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|lbf_in_fifo_err
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|lbf_in_fifo_err
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rxf_out_rx_1_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|rxf_out_rx_1_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rxf_out_rx_2_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|rxf_out_rx_2_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rxf_out_drop_1_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|rxf_out_drop_1_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rxf_out_drop_2_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|rxf_out_drop_2_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rpe_1_in_rx_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|rpe_1_in_rx_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rpe_1_out_rx_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|rpe_1_out_rx_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rpe_2_in_rx_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|rpe_2_in_rx_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rpe_2_out_rx_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|rpe_2_out_rx_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rpe_3_in_rx_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|rpe_3_in_rx_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rpe_3_out_rx_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|rpe_3_out_rx_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tpe_in_tx_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|tpe_in_tx_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tpe_out_tx_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|tpe_out_tx_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tpm_tx_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|tpm_tx_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tfw_in_tx_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|tfw_in_tx_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tfw_out_tx_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|tfw_out_tx_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rfw_in_rx_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|rfw_in_rx_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rfw_in_vlan_drop
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|rfw_in_vlan_drop
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rfw_in_parse_drop
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|rfw_in_parse_drop
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rfw_in_mc
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|rfw_in_mc
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rfw_in_bc
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|rfw_in_bc
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rfw_in_vlan_exist
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|rfw_in_vlan_exist
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rfw_in_vlan_nexist
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|rfw_in_vlan_nexist
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rfw_in_mac_drop
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|rfw_in_mac_drop
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rfw_in_mac_ndet_drop
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|rfw_in_mac_ndet_drop
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rfw_in_ctrl_drop
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|rfw_in_ctrl_drop
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rfw_in_prot_i_drop
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|rfw_in_prot_i_drop
argument_list|)
expr_stmt|;
name|stats
operator|->
name|eee_in
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat
operator|.
name|eee_in
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * read per_udma_counters  */
end_comment

begin_function
name|int
name|al_eth_ec_stat_udma_get
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint8_t
name|idx
parameter_list|,
name|struct
name|al_eth_ec_stat_udma
modifier|*
name|stats
parameter_list|)
block|{
name|al_assert
argument_list|(
name|idx
operator|<=
literal|3
argument_list|)
expr_stmt|;
comment|/*valid udma_id*/
name|al_assert
argument_list|(
name|stats
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rfw_out_rx_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat_udma
index|[
name|idx
index|]
operator|.
name|rfw_out_rx_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|rfw_out_drop
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat_udma
index|[
name|idx
index|]
operator|.
name|rfw_out_drop
argument_list|)
expr_stmt|;
name|stats
operator|->
name|msw_in_rx_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat_udma
index|[
name|idx
index|]
operator|.
name|msw_in_rx_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|msw_drop_q_full
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat_udma
index|[
name|idx
index|]
operator|.
name|msw_drop_q_full
argument_list|)
expr_stmt|;
name|stats
operator|->
name|msw_drop_sop
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat_udma
index|[
name|idx
index|]
operator|.
name|msw_drop_sop
argument_list|)
expr_stmt|;
name|stats
operator|->
name|msw_drop_eop
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat_udma
index|[
name|idx
index|]
operator|.
name|msw_drop_eop
argument_list|)
expr_stmt|;
name|stats
operator|->
name|msw_wr_eop
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat_udma
index|[
name|idx
index|]
operator|.
name|msw_wr_eop
argument_list|)
expr_stmt|;
name|stats
operator|->
name|msw_out_rx_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat_udma
index|[
name|idx
index|]
operator|.
name|msw_out_rx_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tso_no_tso_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat_udma
index|[
name|idx
index|]
operator|.
name|tso_no_tso_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tso_tso_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat_udma
index|[
name|idx
index|]
operator|.
name|tso_tso_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tso_seg_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat_udma
index|[
name|idx
index|]
operator|.
name|tso_seg_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tso_pad_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat_udma
index|[
name|idx
index|]
operator|.
name|tso_pad_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tpm_tx_spoof
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat_udma
index|[
name|idx
index|]
operator|.
name|tpm_tx_spoof
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tmi_in_tx_pkt
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat_udma
index|[
name|idx
index|]
operator|.
name|tmi_in_tx_pkt
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tmi_out_to_mac
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat_udma
index|[
name|idx
index|]
operator|.
name|tmi_out_to_mac
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tmi_out_to_rx
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat_udma
index|[
name|idx
index|]
operator|.
name|tmi_out_to_rx
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_q0_bytes
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat_udma
index|[
name|idx
index|]
operator|.
name|tx_q0_bytes
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_q1_bytes
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat_udma
index|[
name|idx
index|]
operator|.
name|tx_q1_bytes
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_q2_bytes
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat_udma
index|[
name|idx
index|]
operator|.
name|tx_q2_bytes
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_q3_bytes
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat_udma
index|[
name|idx
index|]
operator|.
name|tx_q3_bytes
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_q0_pkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat_udma
index|[
name|idx
index|]
operator|.
name|tx_q0_pkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_q1_pkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat_udma
index|[
name|idx
index|]
operator|.
name|tx_q1_pkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_q2_pkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat_udma
index|[
name|idx
index|]
operator|.
name|tx_q2_pkts
argument_list|)
expr_stmt|;
name|stats
operator|->
name|tx_q3_pkts
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|stat_udma
index|[
name|idx
index|]
operator|.
name|tx_q3_pkts
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Traffic control */
end_comment

begin_function
name|int
name|al_eth_flr_rmn
parameter_list|(
name|int
function_decl|(
modifier|*
name|pci_read_config_u32
function_decl|)
parameter_list|(
name|void
modifier|*
name|handle
parameter_list|,
name|int
name|where
parameter_list|,
name|uint32_t
modifier|*
name|val
parameter_list|)
parameter_list|,
name|int
function_decl|(
modifier|*
name|pci_write_config_u32
function_decl|)
parameter_list|(
name|void
modifier|*
name|handle
parameter_list|,
name|int
name|where
parameter_list|,
name|uint32_t
name|val
parameter_list|)
parameter_list|,
name|void
modifier|*
name|handle
parameter_list|,
name|void
name|__iomem
modifier|*
name|mac_base
parameter_list|)
block|{
name|struct
name|al_eth_mac_regs
name|__iomem
modifier|*
name|mac_regs_base
init|=
operator|(
expr|struct
name|al_eth_mac_regs
name|__iomem
operator|*
operator|)
name|mac_base
decl_stmt|;
name|uint32_t
name|cfg_reg_store
index|[
literal|6
index|]
decl_stmt|;
name|uint32_t
name|reg
decl_stmt|;
name|uint32_t
name|mux_sel
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
call|(
modifier|*
name|pci_read_config_u32
call|)
argument_list|(
name|handle
argument_list|,
name|AL_ADAPTER_GENERIC_CONTROL_0
argument_list|,
operator|&
name|reg
argument_list|)
expr_stmt|;
comment|/* reset 1G mac */
name|AL_REG_MASK_SET
argument_list|(
name|reg
argument_list|,
name|AL_ADAPTER_GENERIC_CONTROL_0_ETH_RESET_1GMAC
argument_list|)
expr_stmt|;
call|(
modifier|*
name|pci_write_config_u32
call|)
argument_list|(
name|handle
argument_list|,
name|AL_ADAPTER_GENERIC_CONTROL_0
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_udelay
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
comment|/* don't reset 1G mac */
name|AL_REG_MASK_CLEAR
argument_list|(
name|reg
argument_list|,
name|AL_ADAPTER_GENERIC_CONTROL_0_ETH_RESET_1GMAC
argument_list|)
expr_stmt|;
comment|/* prevent 1G mac reset on FLR */
name|AL_REG_MASK_CLEAR
argument_list|(
name|reg
argument_list|,
name|AL_ADAPTER_GENERIC_CONTROL_0_ETH_RESET_1GMAC_ON_FLR
argument_list|)
expr_stmt|;
comment|/* prevent adapter reset */
call|(
modifier|*
name|pci_write_config_u32
call|)
argument_list|(
name|handle
argument_list|,
name|AL_ADAPTER_GENERIC_CONTROL_0
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|mux_sel
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|mac_regs_base
operator|->
name|gen
operator|.
name|mux_sel
argument_list|)
expr_stmt|;
comment|/* save pci register that get reset due to flr*/
call|(
modifier|*
name|pci_read_config_u32
call|)
argument_list|(
name|handle
argument_list|,
name|AL_PCI_COMMAND
argument_list|,
operator|&
name|cfg_reg_store
index|[
name|i
operator|++
index|]
argument_list|)
expr_stmt|;
call|(
modifier|*
name|pci_read_config_u32
call|)
argument_list|(
name|handle
argument_list|,
literal|0xC
argument_list|,
operator|&
name|cfg_reg_store
index|[
name|i
operator|++
index|]
argument_list|)
expr_stmt|;
call|(
modifier|*
name|pci_read_config_u32
call|)
argument_list|(
name|handle
argument_list|,
literal|0x10
argument_list|,
operator|&
name|cfg_reg_store
index|[
name|i
operator|++
index|]
argument_list|)
expr_stmt|;
call|(
modifier|*
name|pci_read_config_u32
call|)
argument_list|(
name|handle
argument_list|,
literal|0x18
argument_list|,
operator|&
name|cfg_reg_store
index|[
name|i
operator|++
index|]
argument_list|)
expr_stmt|;
call|(
modifier|*
name|pci_read_config_u32
call|)
argument_list|(
name|handle
argument_list|,
literal|0x20
argument_list|,
operator|&
name|cfg_reg_store
index|[
name|i
operator|++
index|]
argument_list|)
expr_stmt|;
call|(
modifier|*
name|pci_read_config_u32
call|)
argument_list|(
name|handle
argument_list|,
literal|0x110
argument_list|,
operator|&
name|cfg_reg_store
index|[
name|i
operator|++
index|]
argument_list|)
expr_stmt|;
comment|/* do flr */
call|(
modifier|*
name|pci_write_config_u32
call|)
argument_list|(
name|handle
argument_list|,
name|AL_PCI_EXP_CAP_BASE
operator|+
name|AL_PCI_EXP_DEVCTL
argument_list|,
name|AL_PCI_EXP_DEVCTL_BCR_FLR
argument_list|)
expr_stmt|;
name|al_udelay
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
comment|/* restore command */
name|i
operator|=
literal|0
expr_stmt|;
call|(
modifier|*
name|pci_write_config_u32
call|)
argument_list|(
name|handle
argument_list|,
name|AL_PCI_COMMAND
argument_list|,
name|cfg_reg_store
index|[
name|i
operator|++
index|]
argument_list|)
expr_stmt|;
call|(
modifier|*
name|pci_write_config_u32
call|)
argument_list|(
name|handle
argument_list|,
literal|0xC
argument_list|,
name|cfg_reg_store
index|[
name|i
operator|++
index|]
argument_list|)
expr_stmt|;
call|(
modifier|*
name|pci_write_config_u32
call|)
argument_list|(
name|handle
argument_list|,
literal|0x10
argument_list|,
name|cfg_reg_store
index|[
name|i
operator|++
index|]
argument_list|)
expr_stmt|;
call|(
modifier|*
name|pci_write_config_u32
call|)
argument_list|(
name|handle
argument_list|,
literal|0x18
argument_list|,
name|cfg_reg_store
index|[
name|i
operator|++
index|]
argument_list|)
expr_stmt|;
call|(
modifier|*
name|pci_write_config_u32
call|)
argument_list|(
name|handle
argument_list|,
literal|0x20
argument_list|,
name|cfg_reg_store
index|[
name|i
operator|++
index|]
argument_list|)
expr_stmt|;
call|(
modifier|*
name|pci_write_config_u32
call|)
argument_list|(
name|handle
argument_list|,
literal|0x110
argument_list|,
name|cfg_reg_store
index|[
name|i
operator|++
index|]
argument_list|)
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|&
name|mac_regs_base
operator|->
name|gen
operator|.
name|mux_sel
argument_list|,
name|ETH_MAC_GEN_MUX_SEL_KR_IN_MASK
argument_list|,
name|mux_sel
argument_list|)
expr_stmt|;
comment|/* set SGMII clock to 125MHz */
name|al_reg_write32
argument_list|(
operator|&
name|mac_regs_base
operator|->
name|sgmii
operator|.
name|clk_div
argument_list|,
literal|0x03320501
argument_list|)
expr_stmt|;
comment|/* reset 1G mac */
name|AL_REG_MASK_SET
argument_list|(
name|reg
argument_list|,
name|AL_ADAPTER_GENERIC_CONTROL_0_ETH_RESET_1GMAC
argument_list|)
expr_stmt|;
call|(
modifier|*
name|pci_write_config_u32
call|)
argument_list|(
name|handle
argument_list|,
name|AL_ADAPTER_GENERIC_CONTROL_0
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_udelay
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
comment|/* clear 1G mac reset */
name|AL_REG_MASK_CLEAR
argument_list|(
name|reg
argument_list|,
name|AL_ADAPTER_GENERIC_CONTROL_0_ETH_RESET_1GMAC
argument_list|)
expr_stmt|;
call|(
modifier|*
name|pci_write_config_u32
call|)
argument_list|(
name|handle
argument_list|,
name|AL_ADAPTER_GENERIC_CONTROL_0
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* reset SGMII mac clock to default */
name|al_reg_write32
argument_list|(
operator|&
name|mac_regs_base
operator|->
name|sgmii
operator|.
name|clk_div
argument_list|,
literal|0x00320501
argument_list|)
expr_stmt|;
name|al_udelay
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
comment|/* reset async fifo */
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|mac_regs_base
operator|->
name|gen
operator|.
name|sd_fifo_ctrl
argument_list|)
expr_stmt|;
name|AL_REG_MASK_SET
argument_list|(
name|reg
argument_list|,
literal|0xF0
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|mac_regs_base
operator|->
name|gen
operator|.
name|sd_fifo_ctrl
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|mac_regs_base
operator|->
name|gen
operator|.
name|sd_fifo_ctrl
argument_list|)
expr_stmt|;
name|AL_REG_MASK_CLEAR
argument_list|(
name|reg
argument_list|,
literal|0xF0
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|mac_regs_base
operator|->
name|gen
operator|.
name|sd_fifo_ctrl
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_flr_rmn_restore_params
parameter_list|(
name|int
function_decl|(
modifier|*
name|pci_read_config_u32
function_decl|)
parameter_list|(
name|void
modifier|*
name|handle
parameter_list|,
name|int
name|where
parameter_list|,
name|uint32_t
modifier|*
name|val
parameter_list|)
parameter_list|,
name|int
function_decl|(
modifier|*
name|pci_write_config_u32
function_decl|)
parameter_list|(
name|void
modifier|*
name|handle
parameter_list|,
name|int
name|where
parameter_list|,
name|uint32_t
name|val
parameter_list|)
parameter_list|,
name|void
modifier|*
name|handle
parameter_list|,
name|void
name|__iomem
modifier|*
name|mac_base
parameter_list|,
name|void
name|__iomem
modifier|*
name|ec_base
parameter_list|,
name|int
name|mac_addresses_num
parameter_list|)
block|{
name|struct
name|al_eth_board_params
name|params
init|=
block|{
operator|.
name|media_type
operator|=
literal|0
block|}
decl_stmt|;
name|uint8_t
name|mac_addr
index|[
literal|6
index|]
decl_stmt|;
name|int
name|rc
decl_stmt|;
comment|/* not implemented yet */
if|if
condition|(
name|mac_addresses_num
operator|>
literal|1
condition|)
return|return
operator|-
name|EPERM
return|;
comment|/* save board params so we restore it after reset */
name|al_eth_board_params_get
argument_list|(
name|mac_base
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
name|al_eth_mac_addr_read
argument_list|(
name|ec_base
argument_list|,
literal|0
argument_list|,
name|mac_addr
argument_list|)
expr_stmt|;
name|rc
operator|=
name|al_eth_flr_rmn
argument_list|(
name|pci_read_config_u32
argument_list|,
name|pci_write_config_u32
argument_list|,
name|handle
argument_list|,
name|mac_base
argument_list|)
expr_stmt|;
name|al_eth_board_params_set
argument_list|(
name|mac_base
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
name|al_eth_mac_addr_store
argument_list|(
name|ec_base
argument_list|,
literal|0
argument_list|,
name|mac_addr
argument_list|)
expr_stmt|;
return|return
name|rc
return|;
block|}
end_function

begin_comment
comment|/* board params register 1 */
end_comment

begin_define
define|#
directive|define
name|AL_HAL_ETH_MEDIA_TYPE_MASK
value|(AL_FIELD_MASK(3, 0))
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_MEDIA_TYPE_SHIFT
value|0
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_EXT_PHY_SHIFT
value|4
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_PHY_ADDR_MASK
value|(AL_FIELD_MASK(9, 5))
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_PHY_ADDR_SHIFT
value|5
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_SFP_EXIST_SHIFT
value|10
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_AN_ENABLE_SHIFT
value|11
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_KR_LT_ENABLE_SHIFT
value|12
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_KR_FEC_ENABLE_SHIFT
value|13
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_MDIO_FREQ_MASK
value|(AL_FIELD_MASK(15, 14))
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_MDIO_FREQ_SHIFT
value|14
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_I2C_ADAPTER_ID_MASK
value|(AL_FIELD_MASK(19, 16))
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_I2C_ADAPTER_ID_SHIFT
value|16
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_EXT_PHY_IF_MASK
value|(AL_FIELD_MASK(21, 20))
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_EXT_PHY_IF_SHIFT
value|20
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_AUTO_NEG_MODE_SHIFT
value|22
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_SERDES_GRP_2_SHIFT
value|23
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_SERDES_GRP_MASK
value|(AL_FIELD_MASK(26, 25))
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_SERDES_GRP_SHIFT
value|25
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_SERDES_LANE_MASK
value|(AL_FIELD_MASK(28, 27))
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_SERDES_LANE_SHIFT
value|27
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_REF_CLK_FREQ_MASK
value|(AL_FIELD_MASK(31, 29))
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_REF_CLK_FREQ_SHIFT
value|29
end_define

begin_comment
comment|/* board params register 2 */
end_comment

begin_define
define|#
directive|define
name|AL_HAL_ETH_DONT_OVERRIDE_SERDES_SHIFT
value|0
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_1000_BASE_X_SHIFT
value|1
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_1G_AN_DISABLE_SHIFT
value|2
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_1G_SPEED_MASK
value|(AL_FIELD_MASK(4, 3))
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_1G_SPEED_SHIFT
value|3
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_1G_HALF_DUPLEX_SHIFT
value|5
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_1G_FC_DISABLE_SHIFT
value|6
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_RETIMER_EXIST_SHIFT
value|7
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_RETIMER_BUS_ID_MASK
value|(AL_FIELD_MASK(11, 8))
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_RETIMER_BUS_ID_SHIFT
value|8
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_RETIMER_I2C_ADDR_MASK
value|(AL_FIELD_MASK(18, 12))
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_RETIMER_I2C_ADDR_SHIFT
value|12
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_RETIMER_CHANNEL_SHIFT
value|19
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_DAC_LENGTH_MASK
value|(AL_FIELD_MASK(23, 20))
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_DAC_LENGTH_SHIFT
value|20
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_DAC_SHIFT
value|24
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_RETIMER_TYPE_MASK
value|(AL_FIELD_MASK(26, 25))
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_RETIMER_TYPE_SHIFT
value|25
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_RETIMER_CHANNEL_2_MASK
value|(AL_FIELD_MASK(28, 27))
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_RETIMER_CHANNEL_2_SHIFT
value|27
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_RETIMER_TX_CHANNEL_MASK
value|(AL_FIELD_MASK(31, 29))
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_RETIMER_TX_CHANNEL_SHIFT
value|29
end_define

begin_comment
comment|/* board params register 3 */
end_comment

begin_define
define|#
directive|define
name|AL_HAL_ETH_GPIO_SFP_PRESENT_MASK
value|(AL_FIELD_MASK(5, 0))
end_define

begin_define
define|#
directive|define
name|AL_HAL_ETH_GPIO_SFP_PRESENT_SHIFT
value|0
end_define

begin_function
name|int
name|al_eth_board_params_set
parameter_list|(
name|void
modifier|*
name|__iomem
name|mac_base
parameter_list|,
name|struct
name|al_eth_board_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|al_eth_mac_regs
name|__iomem
modifier|*
name|mac_regs_base
init|=
operator|(
expr|struct
name|al_eth_mac_regs
name|__iomem
operator|*
operator|)
name|mac_base
decl_stmt|;
name|uint32_t
name|reg
init|=
literal|0
decl_stmt|;
comment|/* ************* Setting Board params register 1 **************** */
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_MEDIA_TYPE_MASK
argument_list|,
name|AL_HAL_ETH_MEDIA_TYPE_SHIFT
argument_list|,
name|params
operator|->
name|media_type
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_EXT_PHY_SHIFT
argument_list|,
name|params
operator|->
name|phy_exist
operator|==
name|AL_TRUE
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_PHY_ADDR_MASK
argument_list|,
name|AL_HAL_ETH_PHY_ADDR_SHIFT
argument_list|,
name|params
operator|->
name|phy_mdio_addr
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_SFP_EXIST_SHIFT
argument_list|,
name|params
operator|->
name|sfp_plus_module_exist
operator|==
name|AL_TRUE
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_AN_ENABLE_SHIFT
argument_list|,
name|params
operator|->
name|autoneg_enable
operator|==
name|AL_TRUE
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_KR_LT_ENABLE_SHIFT
argument_list|,
name|params
operator|->
name|kr_lt_enable
operator|==
name|AL_TRUE
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_KR_FEC_ENABLE_SHIFT
argument_list|,
name|params
operator|->
name|kr_fec_enable
operator|==
name|AL_TRUE
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_MDIO_FREQ_MASK
argument_list|,
name|AL_HAL_ETH_MDIO_FREQ_SHIFT
argument_list|,
name|params
operator|->
name|mdio_freq
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_I2C_ADAPTER_ID_MASK
argument_list|,
name|AL_HAL_ETH_I2C_ADAPTER_ID_SHIFT
argument_list|,
name|params
operator|->
name|i2c_adapter_id
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_EXT_PHY_IF_MASK
argument_list|,
name|AL_HAL_ETH_EXT_PHY_IF_SHIFT
argument_list|,
name|params
operator|->
name|phy_if
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_AUTO_NEG_MODE_SHIFT
argument_list|,
name|params
operator|->
name|an_mode
operator|==
name|AL_ETH_BOARD_AUTONEG_IN_BAND
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_SERDES_GRP_MASK
argument_list|,
name|AL_HAL_ETH_SERDES_GRP_SHIFT
argument_list|,
name|params
operator|->
name|serdes_grp
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_SERDES_GRP_2_SHIFT
argument_list|,
operator|(
name|params
operator|->
name|serdes_grp
operator|&
name|AL_BIT
argument_list|(
literal|2
argument_list|)
operator|)
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_SERDES_LANE_MASK
argument_list|,
name|AL_HAL_ETH_SERDES_LANE_SHIFT
argument_list|,
name|params
operator|->
name|serdes_lane
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_REF_CLK_FREQ_MASK
argument_list|,
name|AL_HAL_ETH_REF_CLK_FREQ_SHIFT
argument_list|,
name|params
operator|->
name|ref_clk_freq
argument_list|)
expr_stmt|;
name|al_assert
argument_list|(
name|reg
operator|!=
literal|0
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|scratch
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* ************* Setting Board params register 2 **************** */
name|reg
operator|=
literal|0
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_DONT_OVERRIDE_SERDES_SHIFT
argument_list|,
name|params
operator|->
name|dont_override_serdes
operator|==
name|AL_TRUE
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_1000_BASE_X_SHIFT
argument_list|,
name|params
operator|->
name|force_1000_base_x
operator|==
name|AL_TRUE
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_1G_AN_DISABLE_SHIFT
argument_list|,
name|params
operator|->
name|an_disable
operator|==
name|AL_TRUE
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_1G_SPEED_MASK
argument_list|,
name|AL_HAL_ETH_1G_SPEED_SHIFT
argument_list|,
name|params
operator|->
name|speed
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_1G_HALF_DUPLEX_SHIFT
argument_list|,
name|params
operator|->
name|half_duplex
operator|==
name|AL_TRUE
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_1G_FC_DISABLE_SHIFT
argument_list|,
name|params
operator|->
name|fc_disable
operator|==
name|AL_TRUE
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_RETIMER_EXIST_SHIFT
argument_list|,
name|params
operator|->
name|retimer_exist
operator|==
name|AL_TRUE
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_RETIMER_BUS_ID_MASK
argument_list|,
name|AL_HAL_ETH_RETIMER_BUS_ID_SHIFT
argument_list|,
name|params
operator|->
name|retimer_bus_id
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_RETIMER_I2C_ADDR_MASK
argument_list|,
name|AL_HAL_ETH_RETIMER_I2C_ADDR_SHIFT
argument_list|,
name|params
operator|->
name|retimer_i2c_addr
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_RETIMER_CHANNEL_SHIFT
argument_list|,
operator|(
name|params
operator|->
name|retimer_channel
operator|&
name|AL_BIT
argument_list|(
literal|0
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_RETIMER_CHANNEL_2_MASK
argument_list|,
name|AL_HAL_ETH_RETIMER_CHANNEL_2_SHIFT
argument_list|,
operator|(
name|AL_REG_FIELD_GET
argument_list|(
name|params
operator|->
name|retimer_channel
argument_list|,
literal|0x6
argument_list|,
literal|1
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_DAC_LENGTH_MASK
argument_list|,
name|AL_HAL_ETH_DAC_LENGTH_SHIFT
argument_list|,
name|params
operator|->
name|dac_len
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_DAC_SHIFT
argument_list|,
name|params
operator|->
name|dac
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_RETIMER_TYPE_MASK
argument_list|,
name|AL_HAL_ETH_RETIMER_TYPE_SHIFT
argument_list|,
name|params
operator|->
name|retimer_type
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_RETIMER_TX_CHANNEL_MASK
argument_list|,
name|AL_HAL_ETH_RETIMER_TX_CHANNEL_SHIFT
argument_list|,
name|params
operator|->
name|retimer_tx_channel
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|scratch
argument_list|,
name|reg
argument_list|)
expr_stmt|;
comment|/* ************* Setting Board params register 3 **************** */
name|reg
operator|=
literal|0
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_GPIO_SFP_PRESENT_MASK
argument_list|,
name|AL_HAL_ETH_GPIO_SFP_PRESENT_SHIFT
argument_list|,
name|params
operator|->
name|gpio_sfp_present
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|mac_0
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_board_params_get
parameter_list|(
name|void
modifier|*
name|__iomem
name|mac_base
parameter_list|,
name|struct
name|al_eth_board_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|al_eth_mac_regs
name|__iomem
modifier|*
name|mac_regs_base
init|=
operator|(
expr|struct
name|al_eth_mac_regs
name|__iomem
operator|*
operator|)
name|mac_base
decl_stmt|;
name|uint32_t
name|reg
init|=
name|al_reg_read32
argument_list|(
operator|&
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|scratch
argument_list|)
decl_stmt|;
comment|/* check if the register was initialized, 0 is not a valid value */
if|if
condition|(
name|reg
operator|==
literal|0
condition|)
return|return
operator|-
name|ENOENT
return|;
comment|/* ************* Getting Board params register 1 **************** */
name|params
operator|->
name|media_type
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_MEDIA_TYPE_MASK
argument_list|,
name|AL_HAL_ETH_MEDIA_TYPE_SHIFT
argument_list|)
expr_stmt|;
if|if
condition|(
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_EXT_PHY_SHIFT
argument_list|)
condition|)
name|params
operator|->
name|phy_exist
operator|=
name|AL_TRUE
expr_stmt|;
else|else
name|params
operator|->
name|phy_exist
operator|=
name|AL_FALSE
expr_stmt|;
name|params
operator|->
name|phy_mdio_addr
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_PHY_ADDR_MASK
argument_list|,
name|AL_HAL_ETH_PHY_ADDR_SHIFT
argument_list|)
expr_stmt|;
if|if
condition|(
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_SFP_EXIST_SHIFT
argument_list|)
condition|)
name|params
operator|->
name|sfp_plus_module_exist
operator|=
name|AL_TRUE
expr_stmt|;
else|else
name|params
operator|->
name|sfp_plus_module_exist
operator|=
name|AL_FALSE
expr_stmt|;
if|if
condition|(
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_AN_ENABLE_SHIFT
argument_list|)
condition|)
name|params
operator|->
name|autoneg_enable
operator|=
name|AL_TRUE
expr_stmt|;
else|else
name|params
operator|->
name|autoneg_enable
operator|=
name|AL_FALSE
expr_stmt|;
if|if
condition|(
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_KR_LT_ENABLE_SHIFT
argument_list|)
condition|)
name|params
operator|->
name|kr_lt_enable
operator|=
name|AL_TRUE
expr_stmt|;
else|else
name|params
operator|->
name|kr_lt_enable
operator|=
name|AL_FALSE
expr_stmt|;
if|if
condition|(
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_KR_FEC_ENABLE_SHIFT
argument_list|)
condition|)
name|params
operator|->
name|kr_fec_enable
operator|=
name|AL_TRUE
expr_stmt|;
else|else
name|params
operator|->
name|kr_fec_enable
operator|=
name|AL_FALSE
expr_stmt|;
name|params
operator|->
name|mdio_freq
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_MDIO_FREQ_MASK
argument_list|,
name|AL_HAL_ETH_MDIO_FREQ_SHIFT
argument_list|)
expr_stmt|;
name|params
operator|->
name|i2c_adapter_id
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_I2C_ADAPTER_ID_MASK
argument_list|,
name|AL_HAL_ETH_I2C_ADAPTER_ID_SHIFT
argument_list|)
expr_stmt|;
name|params
operator|->
name|phy_if
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_EXT_PHY_IF_MASK
argument_list|,
name|AL_HAL_ETH_EXT_PHY_IF_SHIFT
argument_list|)
expr_stmt|;
if|if
condition|(
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_AUTO_NEG_MODE_SHIFT
argument_list|)
condition|)
name|params
operator|->
name|an_mode
operator|=
name|AL_TRUE
expr_stmt|;
else|else
name|params
operator|->
name|an_mode
operator|=
name|AL_FALSE
expr_stmt|;
name|params
operator|->
name|serdes_grp
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_SERDES_GRP_MASK
argument_list|,
name|AL_HAL_ETH_SERDES_GRP_SHIFT
argument_list|)
expr_stmt|;
name|params
operator|->
name|serdes_grp
operator||=
operator|(
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_SERDES_GRP_2_SHIFT
argument_list|)
condition|?
name|AL_BIT
argument_list|(
literal|2
argument_list|)
else|:
literal|0
operator|)
expr_stmt|;
name|params
operator|->
name|serdes_lane
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_SERDES_LANE_MASK
argument_list|,
name|AL_HAL_ETH_SERDES_LANE_SHIFT
argument_list|)
expr_stmt|;
name|params
operator|->
name|ref_clk_freq
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_REF_CLK_FREQ_MASK
argument_list|,
name|AL_HAL_ETH_REF_CLK_FREQ_SHIFT
argument_list|)
expr_stmt|;
comment|/* ************* Getting Board params register 2 **************** */
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|mac_regs_base
operator|->
name|mac_10g
operator|.
name|scratch
argument_list|)
expr_stmt|;
if|if
condition|(
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_DONT_OVERRIDE_SERDES_SHIFT
argument_list|)
condition|)
name|params
operator|->
name|dont_override_serdes
operator|=
name|AL_TRUE
expr_stmt|;
else|else
name|params
operator|->
name|dont_override_serdes
operator|=
name|AL_FALSE
expr_stmt|;
if|if
condition|(
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_1000_BASE_X_SHIFT
argument_list|)
condition|)
name|params
operator|->
name|force_1000_base_x
operator|=
name|AL_TRUE
expr_stmt|;
else|else
name|params
operator|->
name|force_1000_base_x
operator|=
name|AL_FALSE
expr_stmt|;
if|if
condition|(
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_1G_AN_DISABLE_SHIFT
argument_list|)
condition|)
name|params
operator|->
name|an_disable
operator|=
name|AL_TRUE
expr_stmt|;
else|else
name|params
operator|->
name|an_disable
operator|=
name|AL_FALSE
expr_stmt|;
name|params
operator|->
name|speed
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_1G_SPEED_MASK
argument_list|,
name|AL_HAL_ETH_1G_SPEED_SHIFT
argument_list|)
expr_stmt|;
if|if
condition|(
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_1G_HALF_DUPLEX_SHIFT
argument_list|)
condition|)
name|params
operator|->
name|half_duplex
operator|=
name|AL_TRUE
expr_stmt|;
else|else
name|params
operator|->
name|half_duplex
operator|=
name|AL_FALSE
expr_stmt|;
if|if
condition|(
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_1G_FC_DISABLE_SHIFT
argument_list|)
condition|)
name|params
operator|->
name|fc_disable
operator|=
name|AL_TRUE
expr_stmt|;
else|else
name|params
operator|->
name|fc_disable
operator|=
name|AL_FALSE
expr_stmt|;
if|if
condition|(
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_RETIMER_EXIST_SHIFT
argument_list|)
condition|)
name|params
operator|->
name|retimer_exist
operator|=
name|AL_TRUE
expr_stmt|;
else|else
name|params
operator|->
name|retimer_exist
operator|=
name|AL_FALSE
expr_stmt|;
name|params
operator|->
name|retimer_bus_id
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_RETIMER_BUS_ID_MASK
argument_list|,
name|AL_HAL_ETH_RETIMER_BUS_ID_SHIFT
argument_list|)
expr_stmt|;
name|params
operator|->
name|retimer_i2c_addr
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_RETIMER_I2C_ADDR_MASK
argument_list|,
name|AL_HAL_ETH_RETIMER_I2C_ADDR_SHIFT
argument_list|)
expr_stmt|;
name|params
operator|->
name|retimer_channel
operator|=
operator|(
operator|(
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_RETIMER_CHANNEL_SHIFT
argument_list|)
operator|)
operator||
operator|(
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_RETIMER_CHANNEL_2_MASK
argument_list|,
name|AL_HAL_ETH_RETIMER_CHANNEL_2_SHIFT
argument_list|)
operator|<<
literal|1
operator|)
operator|)
expr_stmt|;
name|params
operator|->
name|dac_len
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_DAC_LENGTH_MASK
argument_list|,
name|AL_HAL_ETH_DAC_LENGTH_SHIFT
argument_list|)
expr_stmt|;
if|if
condition|(
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_DAC_SHIFT
argument_list|)
condition|)
name|params
operator|->
name|dac
operator|=
name|AL_TRUE
expr_stmt|;
else|else
name|params
operator|->
name|dac
operator|=
name|AL_FALSE
expr_stmt|;
name|params
operator|->
name|retimer_type
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_RETIMER_TYPE_MASK
argument_list|,
name|AL_HAL_ETH_RETIMER_TYPE_SHIFT
argument_list|)
expr_stmt|;
name|params
operator|->
name|retimer_tx_channel
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_RETIMER_TX_CHANNEL_MASK
argument_list|,
name|AL_HAL_ETH_RETIMER_TX_CHANNEL_SHIFT
argument_list|)
expr_stmt|;
comment|/* ************* Getting Board params register 3 **************** */
name|reg
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|mac_regs_base
operator|->
name|mac_1g
operator|.
name|mac_0
argument_list|)
expr_stmt|;
name|params
operator|->
name|gpio_sfp_present
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_HAL_ETH_GPIO_SFP_PRESENT_MASK
argument_list|,
name|AL_HAL_ETH_GPIO_SFP_PRESENT_SHIFT
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Wake-On-Lan (WoL) */
end_comment

begin_function
specifier|static
specifier|inline
name|void
name|al_eth_byte_arr_to_reg
parameter_list|(
name|uint32_t
modifier|*
name|reg
parameter_list|,
name|uint8_t
modifier|*
name|arr
parameter_list|,
name|unsigned
name|int
name|num_bytes
parameter_list|)
block|{
name|uint32_t
name|mask
init|=
literal|0xff
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|al_assert
argument_list|(
name|num_bytes
operator|<=
literal|4
argument_list|)
expr_stmt|;
operator|*
name|reg
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_bytes
condition|;
name|i
operator|++
control|)
block|{
name|AL_REG_FIELD_SET
argument_list|(
operator|*
name|reg
argument_list|,
name|mask
argument_list|,
operator|(
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
operator|*
name|i
operator|)
argument_list|,
name|arr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|mask
operator|=
name|mask
operator|<<
sizeof|sizeof
argument_list|(
name|uint8_t
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|al_eth_wol_enable
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|al_eth_wol_params
modifier|*
name|wol
parameter_list|)
block|{
name|uint32_t
name|reg
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|wol
operator|->
name|int_mask
operator|&
name|AL_ETH_WOL_INT_MAGIC_PSWD
condition|)
block|{
name|al_assert
argument_list|(
name|wol
operator|->
name|pswd
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|al_eth_byte_arr_to_reg
argument_list|(
operator|&
name|reg
argument_list|,
operator|&
name|wol
operator|->
name|pswd
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|wol
operator|.
name|magic_pswd_l
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_eth_byte_arr_to_reg
argument_list|(
operator|&
name|reg
argument_list|,
operator|&
name|wol
operator|->
name|pswd
index|[
literal|4
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|wol
operator|.
name|magic_pswd_h
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wol
operator|->
name|int_mask
operator|&
name|AL_ETH_WOL_INT_IPV4
condition|)
block|{
name|al_assert
argument_list|(
name|wol
operator|->
name|ipv4
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|al_eth_byte_arr_to_reg
argument_list|(
operator|&
name|reg
argument_list|,
operator|&
name|wol
operator|->
name|ipv4
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|wol
operator|.
name|ipv4_dip
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wol
operator|->
name|int_mask
operator|&
name|AL_ETH_WOL_INT_IPV6
condition|)
block|{
name|al_assert
argument_list|(
name|wol
operator|->
name|ipv6
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|al_eth_byte_arr_to_reg
argument_list|(
operator|&
name|reg
argument_list|,
operator|&
name|wol
operator|->
name|ipv6
index|[
literal|0
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|wol
operator|.
name|ipv6_dip_word0
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_eth_byte_arr_to_reg
argument_list|(
operator|&
name|reg
argument_list|,
operator|&
name|wol
operator|->
name|ipv6
index|[
literal|4
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|wol
operator|.
name|ipv6_dip_word1
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_eth_byte_arr_to_reg
argument_list|(
operator|&
name|reg
argument_list|,
operator|&
name|wol
operator|->
name|ipv6
index|[
literal|8
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|wol
operator|.
name|ipv6_dip_word2
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_eth_byte_arr_to_reg
argument_list|(
operator|&
name|reg
argument_list|,
operator|&
name|wol
operator|->
name|ipv6
index|[
literal|12
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|wol
operator|.
name|ipv6_dip_word3
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wol
operator|->
name|int_mask
operator|&
operator|(
name|AL_ETH_WOL_INT_ETHERTYPE_BC
operator||
name|AL_ETH_WOL_INT_ETHERTYPE_DA
operator|)
condition|)
block|{
name|reg
operator|=
operator|(
operator|(
name|uint32_t
operator|)
name|wol
operator|->
name|ethr_type2
operator|<<
literal|16
operator|)
expr_stmt|;
name|reg
operator||=
name|wol
operator|->
name|ethr_type1
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|wol
operator|.
name|ethertype
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
comment|/* make sure we dont forwarding packets without interrupt */
name|al_assert
argument_list|(
operator|(
name|wol
operator|->
name|forward_mask
operator||
name|wol
operator|->
name|int_mask
operator|)
operator|==
name|wol
operator|->
name|int_mask
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|(
operator|(
name|uint32_t
operator|)
name|wol
operator|->
name|forward_mask
operator|<<
literal|16
operator|)
expr_stmt|;
name|reg
operator||=
name|wol
operator|->
name|int_mask
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|wol
operator|.
name|wol_en
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_wol_disable
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|)
block|{
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|wol
operator|.
name|wol_en
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_tx_fwd_vid_table_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|idx
parameter_list|,
name|uint8_t
name|udma_mask
parameter_list|,
name|al_bool
name|fwd_to_mac
parameter_list|)
block|{
name|uint32_t
name|val
init|=
literal|0
decl_stmt|;
name|al_assert
argument_list|(
name|idx
operator|<
name|AL_ETH_FWD_VID_TABLE_NUM
argument_list|)
expr_stmt|;
comment|/* valid VID index */
name|AL_REG_FIELD_SET
argument_list|(
name|val
argument_list|,
name|AL_ETH_TX_VLAN_TABLE_UDMA_MASK
argument_list|,
literal|0
argument_list|,
name|udma_mask
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|val
argument_list|,
name|AL_ETH_TX_VLAN_TABLE_FWD_TO_MAC
argument_list|,
literal|4
argument_list|,
name|fwd_to_mac
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw
operator|.
name|tx_vid_table_addr
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw
operator|.
name|tx_vid_table_data
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_tx_protocol_detect_table_entry_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|idx
parameter_list|,
name|struct
name|al_eth_tx_gpd_cam_entry
modifier|*
name|tx_gpd_entry
parameter_list|)
block|{
name|uint64_t
name|gpd_data
decl_stmt|;
name|uint64_t
name|gpd_mask
decl_stmt|;
name|gpd_data
operator|=
operator|(
operator|(
name|uint64_t
operator|)
name|tx_gpd_entry
operator|->
name|l3_proto_idx
operator|&
name|AL_ETH_TX_GPD_L3_PROTO_MASK
operator|)
operator|<<
name|AL_ETH_TX_GPD_L3_PROTO_SHIFT
expr_stmt|;
name|gpd_data
operator||=
operator|(
operator|(
name|uint64_t
operator|)
name|tx_gpd_entry
operator|->
name|l4_proto_idx
operator|&
name|AL_ETH_TX_GPD_L4_PROTO_MASK
operator|)
operator|<<
name|AL_ETH_TX_GPD_L4_PROTO_SHIFT
expr_stmt|;
name|gpd_data
operator||=
operator|(
operator|(
name|uint64_t
operator|)
name|tx_gpd_entry
operator|->
name|tunnel_control
operator|&
name|AL_ETH_TX_GPD_TUNNEL_CTRL_MASK
operator|)
operator|<<
name|AL_ETH_TX_GPD_TUNNEL_CTRL_SHIFT
expr_stmt|;
name|gpd_data
operator||=
operator|(
operator|(
name|uint64_t
operator|)
name|tx_gpd_entry
operator|->
name|source_vlan_count
operator|&
name|AL_ETH_TX_GPD_SRC_VLAN_CNT_MASK
operator|)
operator|<<
name|AL_ETH_TX_GPD_SRC_VLAN_CNT_SHIFT
expr_stmt|;
name|gpd_mask
operator|=
operator|(
operator|(
name|uint64_t
operator|)
name|tx_gpd_entry
operator|->
name|l3_proto_idx_mask
operator|&
name|AL_ETH_TX_GPD_L3_PROTO_MASK
operator|)
operator|<<
name|AL_ETH_TX_GPD_L3_PROTO_SHIFT
expr_stmt|;
name|gpd_mask
operator||=
operator|(
operator|(
name|uint64_t
operator|)
name|tx_gpd_entry
operator|->
name|l4_proto_idx_mask
operator|&
name|AL_ETH_TX_GPD_L4_PROTO_MASK
operator|)
operator|<<
name|AL_ETH_TX_GPD_L4_PROTO_SHIFT
expr_stmt|;
name|gpd_mask
operator||=
operator|(
operator|(
name|uint64_t
operator|)
name|tx_gpd_entry
operator|->
name|tunnel_control_mask
operator|&
name|AL_ETH_TX_GPD_TUNNEL_CTRL_MASK
operator|)
operator|<<
name|AL_ETH_TX_GPD_TUNNEL_CTRL_SHIFT
expr_stmt|;
name|gpd_mask
operator||=
operator|(
operator|(
name|uint64_t
operator|)
name|tx_gpd_entry
operator|->
name|source_vlan_count_mask
operator|&
name|AL_ETH_TX_GPD_SRC_VLAN_CNT_MASK
operator|)
operator|<<
name|AL_ETH_TX_GPD_SRC_VLAN_CNT_SHIFT
expr_stmt|;
comment|/* Tx Generic protocol detect Cam compare table */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|tx_gpd_cam_addr
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|tx_gpd_cam_ctrl
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|tx_gpd_entry
operator|->
name|tx_gpd_cam_ctrl
operator|)
operator|<<
name|AL_ETH_TX_GPD_CAM_CTRL_VALID_SHIFT
argument_list|)
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"al_eth_tx_generic_crc_entry_set, line [%d], tx_gpd_cam_ctrl: %#x"
argument_list|,
name|idx
argument_list|,
name|tx_gpd_entry
operator|->
name|tx_gpd_cam_ctrl
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|tx_gpd_cam_mask_2
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|gpd_mask
operator|>>
name|AL_ETH_TX_GPD_CAM_MASK_2_SHIFT
argument_list|)
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"al_eth_tx_generic_crc_entry_set, line [%d], tx_gpd_cam_mask_2: %#x"
argument_list|,
name|idx
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|gpd_mask
operator|>>
name|AL_ETH_TX_GPD_CAM_MASK_2_SHIFT
argument_list|)
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|tx_gpd_cam_mask_1
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|gpd_mask
argument_list|)
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"al_eth_tx_generic_crc_entry_set, line [%d], tx_gpd_cam_mask_1: %#x"
argument_list|,
name|idx
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|gpd_mask
argument_list|)
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|tx_gpd_cam_data_2
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|gpd_data
operator|>>
name|AL_ETH_TX_GPD_CAM_DATA_2_SHIFT
argument_list|)
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"al_eth_tx_generic_crc_entry_set, line [%d], tx_gpd_cam_data_2: %#x"
argument_list|,
name|idx
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|gpd_data
operator|>>
name|AL_ETH_TX_GPD_CAM_DATA_2_SHIFT
argument_list|)
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|tx_gpd_cam_data_1
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|gpd_data
argument_list|)
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"al_eth_tx_generic_crc_entry_set, line [%d], tx_gpd_cam_data_1: %#x"
argument_list|,
name|idx
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|gpd_data
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_tx_generic_crc_table_entry_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|idx
parameter_list|,
name|struct
name|al_eth_tx_gcp_table_entry
modifier|*
name|tx_gcp_entry
parameter_list|)
block|{
name|uint32_t
name|gcp_table_gen
decl_stmt|;
name|uint32_t
name|tx_alu_opcode
decl_stmt|;
name|uint32_t
name|tx_alu_opsel
decl_stmt|;
name|gcp_table_gen
operator|=
operator|(
name|tx_gcp_entry
operator|->
name|poly_sel
operator|&
name|AL_ETH_TX_GCP_POLY_SEL_MASK
operator|)
operator|<<
name|AL_ETH_TX_GCP_POLY_SEL_SHIFT
expr_stmt|;
name|gcp_table_gen
operator||=
operator|(
name|tx_gcp_entry
operator|->
name|crc32_bit_comp
operator|&
name|AL_ETH_TX_GCP_CRC32_BIT_COMP_MASK
operator|)
operator|<<
name|AL_ETH_TX_GCP_CRC32_BIT_COMP_SHIFT
expr_stmt|;
name|gcp_table_gen
operator||=
operator|(
name|tx_gcp_entry
operator|->
name|crc32_bit_swap
operator|&
name|AL_ETH_TX_GCP_CRC32_BIT_SWAP_MASK
operator|)
operator|<<
name|AL_ETH_TX_GCP_CRC32_BIT_SWAP_SHIFT
expr_stmt|;
name|gcp_table_gen
operator||=
operator|(
name|tx_gcp_entry
operator|->
name|crc32_byte_swap
operator|&
name|AL_ETH_TX_GCP_CRC32_BYTE_SWAP_MASK
operator|)
operator|<<
name|AL_ETH_TX_GCP_CRC32_BYTE_SWAP_SHIFT
expr_stmt|;
name|gcp_table_gen
operator||=
operator|(
name|tx_gcp_entry
operator|->
name|data_bit_swap
operator|&
name|AL_ETH_TX_GCP_DATA_BIT_SWAP_MASK
operator|)
operator|<<
name|AL_ETH_TX_GCP_DATA_BIT_SWAP_SHIFT
expr_stmt|;
name|gcp_table_gen
operator||=
operator|(
name|tx_gcp_entry
operator|->
name|data_byte_swap
operator|&
name|AL_ETH_TX_GCP_DATA_BYTE_SWAP_MASK
operator|)
operator|<<
name|AL_ETH_TX_GCP_DATA_BYTE_SWAP_SHIFT
expr_stmt|;
name|gcp_table_gen
operator||=
operator|(
name|tx_gcp_entry
operator|->
name|trail_size
operator|&
name|AL_ETH_TX_GCP_TRAIL_SIZE_MASK
operator|)
operator|<<
name|AL_ETH_TX_GCP_TRAIL_SIZE_SHIFT
expr_stmt|;
name|gcp_table_gen
operator||=
operator|(
name|tx_gcp_entry
operator|->
name|head_size
operator|&
name|AL_ETH_TX_GCP_HEAD_SIZE_MASK
operator|)
operator|<<
name|AL_ETH_TX_GCP_HEAD_SIZE_SHIFT
expr_stmt|;
name|gcp_table_gen
operator||=
operator|(
name|tx_gcp_entry
operator|->
name|head_calc
operator|&
name|AL_ETH_TX_GCP_HEAD_CALC_MASK
operator|)
operator|<<
name|AL_ETH_TX_GCP_HEAD_CALC_SHIFT
expr_stmt|;
name|gcp_table_gen
operator||=
operator|(
name|tx_gcp_entry
operator|->
name|mask_polarity
operator|&
name|AL_ETH_TX_GCP_MASK_POLARITY_MASK
operator|)
operator|<<
name|AL_ETH_TX_GCP_MASK_POLARITY_SHIFT
expr_stmt|;
name|al_dbg
argument_list|(
literal|"al_eth_tx_generic_crc_entry_set, line [%d], gcp_table_gen: %#x"
argument_list|,
name|idx
argument_list|,
name|gcp_table_gen
argument_list|)
expr_stmt|;
name|tx_alu_opcode
operator|=
operator|(
name|tx_gcp_entry
operator|->
name|tx_alu_opcode_1
operator|&
name|AL_ETH_TX_GCP_OPCODE_1_MASK
operator|)
operator|<<
name|AL_ETH_TX_GCP_OPCODE_1_SHIFT
expr_stmt|;
name|tx_alu_opcode
operator||=
operator|(
name|tx_gcp_entry
operator|->
name|tx_alu_opcode_2
operator|&
name|AL_ETH_TX_GCP_OPCODE_2_MASK
operator|)
operator|<<
name|AL_ETH_TX_GCP_OPCODE_2_SHIFT
expr_stmt|;
name|tx_alu_opcode
operator||=
operator|(
name|tx_gcp_entry
operator|->
name|tx_alu_opcode_3
operator|&
name|AL_ETH_TX_GCP_OPCODE_3_MASK
operator|)
operator|<<
name|AL_ETH_TX_GCP_OPCODE_3_SHIFT
expr_stmt|;
name|tx_alu_opsel
operator|=
operator|(
name|tx_gcp_entry
operator|->
name|tx_alu_opsel_1
operator|&
name|AL_ETH_TX_GCP_OPSEL_1_MASK
operator|)
operator|<<
name|AL_ETH_TX_GCP_OPSEL_1_SHIFT
expr_stmt|;
name|tx_alu_opsel
operator||=
operator|(
name|tx_gcp_entry
operator|->
name|tx_alu_opsel_2
operator|&
name|AL_ETH_TX_GCP_OPSEL_2_MASK
operator|)
operator|<<
name|AL_ETH_TX_GCP_OPSEL_2_SHIFT
expr_stmt|;
name|tx_alu_opsel
operator||=
operator|(
name|tx_gcp_entry
operator|->
name|tx_alu_opsel_3
operator|&
name|AL_ETH_TX_GCP_OPSEL_3_MASK
operator|)
operator|<<
name|AL_ETH_TX_GCP_OPSEL_3_SHIFT
expr_stmt|;
name|tx_alu_opsel
operator||=
operator|(
name|tx_gcp_entry
operator|->
name|tx_alu_opsel_4
operator|&
name|AL_ETH_TX_GCP_OPSEL_4_MASK
operator|)
operator|<<
name|AL_ETH_TX_GCP_OPSEL_4_SHIFT
expr_stmt|;
comment|/*  Tx Generic crc prameters table general */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|tx_gcp_table_addr
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|tx_gcp_table_gen
argument_list|,
name|gcp_table_gen
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|tx_gcp_table_mask_1
argument_list|,
name|tx_gcp_entry
operator|->
name|gcp_mask
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|tx_gcp_table_mask_2
argument_list|,
name|tx_gcp_entry
operator|->
name|gcp_mask
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|tx_gcp_table_mask_3
argument_list|,
name|tx_gcp_entry
operator|->
name|gcp_mask
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|tx_gcp_table_mask_4
argument_list|,
name|tx_gcp_entry
operator|->
name|gcp_mask
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|tx_gcp_table_mask_5
argument_list|,
name|tx_gcp_entry
operator|->
name|gcp_mask
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|tx_gcp_table_mask_6
argument_list|,
name|tx_gcp_entry
operator|->
name|gcp_mask
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|tx_gcp_table_crc_init
argument_list|,
name|tx_gcp_entry
operator|->
name|crc_init
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|tx_gcp_table_res
argument_list|,
name|tx_gcp_entry
operator|->
name|gcp_table_res
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|tx_gcp_table_alu_opcode
argument_list|,
name|tx_alu_opcode
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|tx_gcp_table_alu_opsel
argument_list|,
name|tx_alu_opsel
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|tx_gcp_table_alu_val
argument_list|,
name|tx_gcp_entry
operator|->
name|alu_val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_tx_crc_chksum_replace_cmd_entry_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|idx
parameter_list|,
name|struct
name|al_eth_tx_crc_chksum_replace_cmd_for_protocol_num_entry
modifier|*
name|tx_replace_entry
parameter_list|)
block|{
name|uint32_t
name|replace_table_address
decl_stmt|;
name|uint32_t
name|tx_replace_cmd
decl_stmt|;
comment|/*  Tx crc_chksum_replace_cmd */
name|replace_table_address
operator|=
name|L4_CHECKSUM_DIS_AND_L3_CHECKSUM_DIS
operator||
name|idx
expr_stmt|;
name|tx_replace_cmd
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|tx_replace_entry
operator|->
name|l3_csum_en_00
argument_list|)
operator|<<
literal|0
expr_stmt|;
name|tx_replace_cmd
operator||=
call|(
name|uint32_t
call|)
argument_list|(
name|tx_replace_entry
operator|->
name|l4_csum_en_00
argument_list|)
operator|<<
literal|1
expr_stmt|;
name|tx_replace_cmd
operator||=
call|(
name|uint32_t
call|)
argument_list|(
name|tx_replace_entry
operator|->
name|crc_en_00
argument_list|)
operator|<<
literal|2
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|crc_csum_replace_table_addr
argument_list|,
name|replace_table_address
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|crc_csum_replace_table
argument_list|,
name|tx_replace_cmd
argument_list|)
expr_stmt|;
name|replace_table_address
operator|=
name|L4_CHECKSUM_DIS_AND_L3_CHECKSUM_EN
operator||
name|idx
expr_stmt|;
name|tx_replace_cmd
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|tx_replace_entry
operator|->
name|l3_csum_en_01
argument_list|)
operator|<<
literal|0
expr_stmt|;
name|tx_replace_cmd
operator||=
call|(
name|uint32_t
call|)
argument_list|(
name|tx_replace_entry
operator|->
name|l4_csum_en_01
argument_list|)
operator|<<
literal|1
expr_stmt|;
name|tx_replace_cmd
operator||=
call|(
name|uint32_t
call|)
argument_list|(
name|tx_replace_entry
operator|->
name|crc_en_01
argument_list|)
operator|<<
literal|2
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|crc_csum_replace_table_addr
argument_list|,
name|replace_table_address
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|crc_csum_replace_table
argument_list|,
name|tx_replace_cmd
argument_list|)
expr_stmt|;
name|replace_table_address
operator|=
name|L4_CHECKSUM_EN_AND_L3_CHECKSUM_DIS
operator||
name|idx
expr_stmt|;
name|tx_replace_cmd
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|tx_replace_entry
operator|->
name|l3_csum_en_10
argument_list|)
operator|<<
literal|0
expr_stmt|;
name|tx_replace_cmd
operator||=
call|(
name|uint32_t
call|)
argument_list|(
name|tx_replace_entry
operator|->
name|l4_csum_en_10
argument_list|)
operator|<<
literal|1
expr_stmt|;
name|tx_replace_cmd
operator||=
call|(
name|uint32_t
call|)
argument_list|(
name|tx_replace_entry
operator|->
name|crc_en_10
argument_list|)
operator|<<
literal|2
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|crc_csum_replace_table_addr
argument_list|,
name|replace_table_address
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|crc_csum_replace_table
argument_list|,
name|tx_replace_cmd
argument_list|)
expr_stmt|;
name|replace_table_address
operator|=
name|L4_CHECKSUM_EN_AND_L3_CHECKSUM_EN
operator||
name|idx
expr_stmt|;
name|tx_replace_cmd
operator|=
call|(
name|uint32_t
call|)
argument_list|(
name|tx_replace_entry
operator|->
name|l3_csum_en_11
argument_list|)
operator|<<
literal|0
expr_stmt|;
name|tx_replace_cmd
operator||=
call|(
name|uint32_t
call|)
argument_list|(
name|tx_replace_entry
operator|->
name|l4_csum_en_11
argument_list|)
operator|<<
literal|1
expr_stmt|;
name|tx_replace_cmd
operator||=
call|(
name|uint32_t
call|)
argument_list|(
name|tx_replace_entry
operator|->
name|crc_en_11
argument_list|)
operator|<<
literal|2
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|crc_csum_replace_table_addr
argument_list|,
name|replace_table_address
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|crc_csum_replace_table
argument_list|,
name|tx_replace_cmd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_rx_protocol_detect_table_entry_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|idx
parameter_list|,
name|struct
name|al_eth_rx_gpd_cam_entry
modifier|*
name|rx_gpd_entry
parameter_list|)
block|{
name|uint64_t
name|gpd_data
decl_stmt|;
name|uint64_t
name|gpd_mask
decl_stmt|;
name|gpd_data
operator|=
operator|(
operator|(
name|uint64_t
operator|)
name|rx_gpd_entry
operator|->
name|outer_l3_proto_idx
operator|&
name|AL_ETH_RX_GPD_OUTER_L3_PROTO_MASK
operator|)
operator|<<
name|AL_ETH_RX_GPD_OUTER_L3_PROTO_SHIFT
expr_stmt|;
name|gpd_data
operator||=
operator|(
operator|(
name|uint64_t
operator|)
name|rx_gpd_entry
operator|->
name|outer_l4_proto_idx
operator|&
name|AL_ETH_RX_GPD_OUTER_L4_PROTO_MASK
operator|)
operator|<<
name|AL_ETH_RX_GPD_OUTER_L4_PROTO_SHIFT
expr_stmt|;
name|gpd_data
operator||=
operator|(
operator|(
name|uint64_t
operator|)
name|rx_gpd_entry
operator|->
name|inner_l3_proto_idx
operator|&
name|AL_ETH_RX_GPD_INNER_L3_PROTO_MASK
operator|)
operator|<<
name|AL_ETH_RX_GPD_INNER_L3_PROTO_SHIFT
expr_stmt|;
name|gpd_data
operator||=
operator|(
operator|(
name|uint64_t
operator|)
name|rx_gpd_entry
operator|->
name|inner_l4_proto_idx
operator|&
name|AL_ETH_RX_GPD_INNER_L4_PROTO_MASK
operator|)
operator|<<
name|AL_ETH_RX_GPD_INNER_L4_PROTO_SHIFT
expr_stmt|;
name|gpd_data
operator||=
operator|(
operator|(
name|uint64_t
operator|)
name|rx_gpd_entry
operator|->
name|parse_ctrl
operator|&
name|AL_ETH_RX_GPD_OUTER_PARSE_CTRL_MASK
operator|)
operator|<<
name|AL_ETH_RX_GPD_OUTER_PARSE_CTRL_SHIFT
expr_stmt|;
name|gpd_data
operator||=
operator|(
operator|(
name|uint64_t
operator|)
name|rx_gpd_entry
operator|->
name|outer_l3_len
operator|&
name|AL_ETH_RX_GPD_INNER_PARSE_CTRL_MASK
operator|)
operator|<<
name|AL_ETH_RX_GPD_INNER_PARSE_CTRL_SHIFT
expr_stmt|;
name|gpd_data
operator||=
operator|(
operator|(
name|uint64_t
operator|)
name|rx_gpd_entry
operator|->
name|l3_priority
operator|&
name|AL_ETH_RX_GPD_L3_PRIORITY_MASK
operator|)
operator|<<
name|AL_ETH_RX_GPD_L3_PRIORITY_SHIFT
expr_stmt|;
name|gpd_data
operator||=
operator|(
operator|(
name|uint64_t
operator|)
name|rx_gpd_entry
operator|->
name|l4_dst_port_lsb
operator|&
name|AL_ETH_RX_GPD_L4_DST_PORT_LSB_MASK
operator|)
operator|<<
name|AL_ETH_RX_GPD_L4_DST_PORT_LSB_SHIFT
expr_stmt|;
name|gpd_mask
operator|=
operator|(
operator|(
name|uint64_t
operator|)
name|rx_gpd_entry
operator|->
name|outer_l3_proto_idx_mask
operator|&
name|AL_ETH_RX_GPD_OUTER_L3_PROTO_MASK
operator|)
operator|<<
name|AL_ETH_RX_GPD_OUTER_L3_PROTO_SHIFT
expr_stmt|;
name|gpd_mask
operator||=
operator|(
operator|(
name|uint64_t
operator|)
name|rx_gpd_entry
operator|->
name|outer_l4_proto_idx_mask
operator|&
name|AL_ETH_RX_GPD_OUTER_L4_PROTO_MASK
operator|)
operator|<<
name|AL_ETH_RX_GPD_OUTER_L4_PROTO_SHIFT
expr_stmt|;
name|gpd_mask
operator||=
operator|(
operator|(
name|uint64_t
operator|)
name|rx_gpd_entry
operator|->
name|inner_l3_proto_idx_mask
operator|&
name|AL_ETH_RX_GPD_INNER_L3_PROTO_MASK
operator|)
operator|<<
name|AL_ETH_RX_GPD_INNER_L3_PROTO_SHIFT
expr_stmt|;
name|gpd_mask
operator||=
operator|(
operator|(
name|uint64_t
operator|)
name|rx_gpd_entry
operator|->
name|inner_l4_proto_idx_mask
operator|&
name|AL_ETH_RX_GPD_INNER_L4_PROTO_MASK
operator|)
operator|<<
name|AL_ETH_RX_GPD_INNER_L4_PROTO_SHIFT
expr_stmt|;
name|gpd_mask
operator||=
operator|(
operator|(
name|uint64_t
operator|)
name|rx_gpd_entry
operator|->
name|parse_ctrl_mask
operator|&
name|AL_ETH_RX_GPD_OUTER_PARSE_CTRL_MASK
operator|)
operator|<<
name|AL_ETH_RX_GPD_OUTER_PARSE_CTRL_SHIFT
expr_stmt|;
name|gpd_mask
operator||=
operator|(
operator|(
name|uint64_t
operator|)
name|rx_gpd_entry
operator|->
name|outer_l3_len_mask
operator|&
name|AL_ETH_RX_GPD_INNER_PARSE_CTRL_MASK
operator|)
operator|<<
name|AL_ETH_RX_GPD_INNER_PARSE_CTRL_SHIFT
expr_stmt|;
name|gpd_mask
operator||=
operator|(
operator|(
name|uint64_t
operator|)
name|rx_gpd_entry
operator|->
name|l3_priority_mask
operator|&
name|AL_ETH_RX_GPD_L3_PRIORITY_MASK
operator|)
operator|<<
name|AL_ETH_RX_GPD_L3_PRIORITY_SHIFT
expr_stmt|;
name|gpd_mask
operator||=
operator|(
operator|(
name|uint64_t
operator|)
name|rx_gpd_entry
operator|->
name|l4_dst_port_lsb_mask
operator|&
name|AL_ETH_RX_GPD_L4_DST_PORT_LSB_MASK
operator|)
operator|<<
name|AL_ETH_RX_GPD_L4_DST_PORT_LSB_SHIFT
expr_stmt|;
comment|/* Rx Generic protocol detect Cam compare table */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|rx_gpd_cam_addr
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|rx_gpd_cam_ctrl
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
operator|(
name|rx_gpd_entry
operator|->
name|rx_gpd_cam_ctrl
operator|)
operator|<<
name|AL_ETH_RX_GPD_CAM_CTRL_VALID_SHIFT
argument_list|)
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|rx_gpd_cam_mask_2
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|gpd_mask
operator|>>
name|AL_ETH_RX_GPD_CAM_MASK_2_SHIFT
argument_list|)
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|rx_gpd_cam_mask_1
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|gpd_mask
argument_list|)
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|rx_gpd_cam_data_2
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|gpd_data
operator|>>
name|AL_ETH_RX_GPD_CAM_DATA_2_SHIFT
argument_list|)
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|rx_gpd_cam_data_1
argument_list|,
call|(
name|uint32_t
call|)
argument_list|(
name|gpd_data
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_rx_generic_crc_table_entry_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|uint32_t
name|idx
parameter_list|,
name|struct
name|al_eth_rx_gcp_table_entry
modifier|*
name|rx_gcp_entry
parameter_list|)
block|{
name|uint32_t
name|gcp_table_gen
decl_stmt|;
name|uint32_t
name|rx_alu_opcode
decl_stmt|;
name|uint32_t
name|rx_alu_opsel
decl_stmt|;
name|gcp_table_gen
operator|=
operator|(
name|rx_gcp_entry
operator|->
name|poly_sel
operator|&
name|AL_ETH_RX_GCP_POLY_SEL_MASK
operator|)
operator|<<
name|AL_ETH_RX_GCP_POLY_SEL_SHIFT
expr_stmt|;
name|gcp_table_gen
operator||=
operator|(
name|rx_gcp_entry
operator|->
name|crc32_bit_comp
operator|&
name|AL_ETH_RX_GCP_CRC32_BIT_COMP_MASK
operator|)
operator|<<
name|AL_ETH_RX_GCP_CRC32_BIT_COMP_SHIFT
expr_stmt|;
name|gcp_table_gen
operator||=
operator|(
name|rx_gcp_entry
operator|->
name|crc32_bit_swap
operator|&
name|AL_ETH_RX_GCP_CRC32_BIT_SWAP_MASK
operator|)
operator|<<
name|AL_ETH_RX_GCP_CRC32_BIT_SWAP_SHIFT
expr_stmt|;
name|gcp_table_gen
operator||=
operator|(
name|rx_gcp_entry
operator|->
name|crc32_byte_swap
operator|&
name|AL_ETH_RX_GCP_CRC32_BYTE_SWAP_MASK
operator|)
operator|<<
name|AL_ETH_RX_GCP_CRC32_BYTE_SWAP_SHIFT
expr_stmt|;
name|gcp_table_gen
operator||=
operator|(
name|rx_gcp_entry
operator|->
name|data_bit_swap
operator|&
name|AL_ETH_RX_GCP_DATA_BIT_SWAP_MASK
operator|)
operator|<<
name|AL_ETH_RX_GCP_DATA_BIT_SWAP_SHIFT
expr_stmt|;
name|gcp_table_gen
operator||=
operator|(
name|rx_gcp_entry
operator|->
name|data_byte_swap
operator|&
name|AL_ETH_RX_GCP_DATA_BYTE_SWAP_MASK
operator|)
operator|<<
name|AL_ETH_RX_GCP_DATA_BYTE_SWAP_SHIFT
expr_stmt|;
name|gcp_table_gen
operator||=
operator|(
name|rx_gcp_entry
operator|->
name|trail_size
operator|&
name|AL_ETH_RX_GCP_TRAIL_SIZE_MASK
operator|)
operator|<<
name|AL_ETH_RX_GCP_TRAIL_SIZE_SHIFT
expr_stmt|;
name|gcp_table_gen
operator||=
operator|(
name|rx_gcp_entry
operator|->
name|head_size
operator|&
name|AL_ETH_RX_GCP_HEAD_SIZE_MASK
operator|)
operator|<<
name|AL_ETH_RX_GCP_HEAD_SIZE_SHIFT
expr_stmt|;
name|gcp_table_gen
operator||=
operator|(
name|rx_gcp_entry
operator|->
name|head_calc
operator|&
name|AL_ETH_RX_GCP_HEAD_CALC_MASK
operator|)
operator|<<
name|AL_ETH_RX_GCP_HEAD_CALC_SHIFT
expr_stmt|;
name|gcp_table_gen
operator||=
operator|(
name|rx_gcp_entry
operator|->
name|mask_polarity
operator|&
name|AL_ETH_RX_GCP_MASK_POLARITY_MASK
operator|)
operator|<<
name|AL_ETH_RX_GCP_MASK_POLARITY_SHIFT
expr_stmt|;
name|rx_alu_opcode
operator|=
operator|(
name|rx_gcp_entry
operator|->
name|rx_alu_opcode_1
operator|&
name|AL_ETH_RX_GCP_OPCODE_1_MASK
operator|)
operator|<<
name|AL_ETH_RX_GCP_OPCODE_1_SHIFT
expr_stmt|;
name|rx_alu_opcode
operator||=
operator|(
name|rx_gcp_entry
operator|->
name|rx_alu_opcode_2
operator|&
name|AL_ETH_RX_GCP_OPCODE_2_MASK
operator|)
operator|<<
name|AL_ETH_RX_GCP_OPCODE_2_SHIFT
expr_stmt|;
name|rx_alu_opcode
operator||=
operator|(
name|rx_gcp_entry
operator|->
name|rx_alu_opcode_3
operator|&
name|AL_ETH_RX_GCP_OPCODE_3_MASK
operator|)
operator|<<
name|AL_ETH_RX_GCP_OPCODE_3_SHIFT
expr_stmt|;
name|rx_alu_opsel
operator|=
operator|(
name|rx_gcp_entry
operator|->
name|rx_alu_opsel_1
operator|&
name|AL_ETH_RX_GCP_OPSEL_1_MASK
operator|)
operator|<<
name|AL_ETH_RX_GCP_OPSEL_1_SHIFT
expr_stmt|;
name|rx_alu_opsel
operator||=
operator|(
name|rx_gcp_entry
operator|->
name|rx_alu_opsel_2
operator|&
name|AL_ETH_RX_GCP_OPSEL_2_MASK
operator|)
operator|<<
name|AL_ETH_RX_GCP_OPSEL_2_SHIFT
expr_stmt|;
name|rx_alu_opsel
operator||=
operator|(
name|rx_gcp_entry
operator|->
name|rx_alu_opsel_3
operator|&
name|AL_ETH_RX_GCP_OPSEL_3_MASK
operator|)
operator|<<
name|AL_ETH_RX_GCP_OPSEL_3_SHIFT
expr_stmt|;
name|rx_alu_opsel
operator||=
operator|(
name|rx_gcp_entry
operator|->
name|rx_alu_opsel_4
operator|&
name|AL_ETH_RX_GCP_OPSEL_4_MASK
operator|)
operator|<<
name|AL_ETH_RX_GCP_OPSEL_4_SHIFT
expr_stmt|;
comment|/*  Rx Generic crc prameters table general */
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|rx_gcp_table_addr
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|rx_gcp_table_gen
argument_list|,
name|gcp_table_gen
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|rx_gcp_table_mask_1
argument_list|,
name|rx_gcp_entry
operator|->
name|gcp_mask
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|rx_gcp_table_mask_2
argument_list|,
name|rx_gcp_entry
operator|->
name|gcp_mask
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|rx_gcp_table_mask_3
argument_list|,
name|rx_gcp_entry
operator|->
name|gcp_mask
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|rx_gcp_table_mask_4
argument_list|,
name|rx_gcp_entry
operator|->
name|gcp_mask
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|rx_gcp_table_mask_5
argument_list|,
name|rx_gcp_entry
operator|->
name|gcp_mask
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|rx_gcp_table_mask_6
argument_list|,
name|rx_gcp_entry
operator|->
name|gcp_mask
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|rx_gcp_table_crc_init
argument_list|,
name|rx_gcp_entry
operator|->
name|crc_init
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|rx_gcp_table_res
argument_list|,
name|rx_gcp_entry
operator|->
name|gcp_table_res
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|rx_gcp_table_alu_opcode
argument_list|,
name|rx_alu_opcode
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|rx_gcp_table_alu_opsel
argument_list|,
name|rx_alu_opsel
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|rx_gcp_table_alu_val
argument_list|,
name|rx_gcp_entry
operator|->
name|alu_val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_define
define|#
directive|define
name|AL_ETH_TX_GENERIC_CRC_ENTRIES_NUM
value|9
end_define

begin_define
define|#
directive|define
name|AL_ETH_RX_PROTOCOL_DETECT_ENTRIES_NUM
value|32
end_define

begin_decl_stmt
specifier|static
name|struct
name|al_eth_tx_gpd_cam_entry
name|al_eth_generic_tx_crc_gpd
index|[
name|AL_ETH_TX_GENERIC_CRC_ENTRIES_NUM
index|]
init|=
block|{
comment|/* [0] roce (with grh, bth) */
block|{
literal|22
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,		}
block|,
comment|/* [1] fcoe */
block|{
literal|21
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,		}
block|,
comment|/* [2] routable_roce that is refered as l4_protocol, over IPV4 (and udp) */
block|{
literal|8
block|,
literal|23
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x0
block|,		}
block|,
comment|/* [3] routable_roce that is refered as l4_protocol, over IPV6 (and udp) */
block|{
literal|11
block|,
literal|23
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x0
block|,		}
block|,
comment|/* [4] routable_roce that is refered as tunneled_packet, over outer IPV4 and udp */
block|{
literal|23
block|,
literal|0
block|,
literal|5
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x5
block|,
literal|0x0
block|,		}
block|,
comment|/* [5] routable_roce that is refered as tunneled_packet, over outer IPV6 and udp */
block|{
literal|23
block|,
literal|0
block|,
literal|3
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x5
block|,
literal|0x0
block|}
block|,
comment|/* [6] GENERIC_STORAGE_READ over IPV4 (and udp) */
block|{
literal|8
block|,
literal|2
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x0
block|,		}
block|,
comment|/* [7] GENERIC_STORAGE_READ over IPV6 (and udp) */
block|{
literal|11
block|,
literal|2
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x0
block|,		}
block|,
comment|/* [8] default match */
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|al_eth_tx_gcp_table_entry
name|al_eth_generic_tx_crc_gcp
index|[
name|AL_ETH_TX_GENERIC_CRC_ENTRIES_NUM
index|]
init|=
block|{
comment|/* [0] roce (with grh, bth) */
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|4
block|,
literal|8
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0xffff7f03
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00c00000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0xffffffff
block|,
literal|0x0
block|,
literal|0
block|}
block|,
comment|/* [1] fcoe */
block|{
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|8
block|,
literal|14
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0xffffffff
block|,
literal|0x0
block|,
literal|0
block|}
block|,
comment|/* [2] routable_roce that is refered as l4_protocol, over IPV4 (and udp) */
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x3000cf00
block|,
literal|0x00000f00
block|,
literal|0xc0000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0xffffffff
block|,
literal|0x0
block|,
literal|0
block|}
block|,
comment|/* [3] routable_roce that is refered as l4_protocol, over IPV6 (and udp) */
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x7f030000
block|,
literal|0x00000000
block|,
literal|0x00000003
block|,
literal|0x00c00000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0xffffffff
block|,
literal|0x0
block|,
literal|0
block|}
block|,
comment|/* [4] routable_roce that is refered as tunneled_packet, over outer IPV4 and udp */
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|10
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x3000cf00
block|,
literal|0x00000f00
block|,
literal|0xc0000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0xffffffff
block|,
literal|0x0
block|,
literal|28
block|}
block|,
comment|/* [5] routable_roce that is refered as tunneled_packet, over outer IPV6 and udp */
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|10
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x7f030000
block|,
literal|0x00000000
block|,
literal|0x00000003
block|,
literal|0x00c00000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0xffffffff
block|,
literal|0x0
block|,
literal|48
block|}
block|,
comment|/* [6] GENERIC_STORAGE_READ over IPV4 (and udp) */
block|{
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|2
block|,
literal|10
block|,
literal|0
block|,
block|{
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0xffffffff
block|,
literal|0x0
block|,
literal|8
block|}
block|,
comment|/* [7] GENERIC_STORAGE_READ over IPV6 (and udp) */
block|{
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|2
block|,
literal|10
block|,
literal|0
block|,
block|{
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0xffffffff
block|,
literal|0x0
block|,
literal|8
block|}
block|,
comment|/* [8] default match */
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0x00000000
block|,
literal|0x0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|al_eth_tx_crc_chksum_replace_cmd_for_protocol_num_entry
name|al_eth_tx_crc_chksum_replace_cmd
index|[
name|AL_ETH_TX_GENERIC_CRC_ENTRIES_NUM
index|]
init|=
block|{
comment|/* [0] roce (with grh, bth) */
block|{
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* [1] fcoe */
block|{
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* [2] routable_roce that is refered as l4_protocol, over IPV4 (and udp) */
block|{
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|}
block|,
comment|/* [3] routable_roce that is refered as l4_protocol, over IPV6 (and udp) */
block|{
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* [4] routable_roce that is refered as tunneled_packet, over outer IPV4 and udp */
block|{
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* [5] routable_roce that is refered as tunneled_packet, over outer IPV6 and udp */
block|{
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* [6] GENERIC_STORAGE_READ over IPV4 (and udp) */
block|{
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|}
block|,
comment|/* [7] GENERIC_STORAGE_READ over IPV6 (and udp) */
block|{
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|,
comment|/* [8] default match */
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|al_eth_rx_gpd_cam_entry
name|al_eth_generic_rx_crc_gpd
index|[
name|AL_ETH_RX_PROTOCOL_DETECT_ENTRIES_NUM
index|]
init|=
block|{
comment|/* [0] roce (with grh, bth) */
block|{
literal|22
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [1] fcoe */
block|{
literal|21
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [2] routable_roce that is refered as l4_protocol, over IPV4 (and udp) */
block|{
literal|8
block|,
literal|23
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [3] routable_roce that is refered as l4_protocol, over IPV6 (and udp) */
block|{
literal|11
block|,
literal|23
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [4] routable_roce that is refered as tunneled_packet, over outer IPV4 and udp */
block|{
literal|8
block|,
literal|13
block|,
literal|23
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x1f
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [5] routable_roce that is refered as tunneled_packet, over outer IPV6 and udp */
block|{
literal|11
block|,
literal|13
block|,
literal|23
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x1f
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [6] tunneled roce (with grh, bth) over GRE over IPV4 */
block|{
literal|8
block|,
literal|0
block|,
literal|22
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [7] tunneled roce (with grh, bth) over GRE over IPV6 */
block|{
literal|11
block|,
literal|0
block|,
literal|22
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [8] tunneled fcoe over IPV4 */
block|{
literal|8
block|,
literal|0
block|,
literal|21
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [9] tunneled fcoe over IPV6 */
block|{
literal|11
block|,
literal|0
block|,
literal|21
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [10] tunneled routable_roce that is refered as l4_protocol, over IPV4 (and udp) over IPV4 */
block|{
literal|8
block|,
literal|0
block|,
literal|8
block|,
literal|23
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x1f
block|,
literal|0x1f
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [11] tunneled routable_roce that is refered as l4_protocol, over IPV4 (and udp) over IPV6 */
block|{
literal|11
block|,
literal|0
block|,
literal|8
block|,
literal|23
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x1f
block|,
literal|0x1f
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [12] tunneled routable_roce that is refered as l4_protocol, over IPV6 (and udp) over IPV4 */
block|{
literal|8
block|,
literal|0
block|,
literal|11
block|,
literal|23
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x1f
block|,
literal|0x1f
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [13] tunneled routable_roce that is refered as l4_protocol, over IPV6 (and udp) over IPV6 */
block|{
literal|11
block|,
literal|0
block|,
literal|11
block|,
literal|23
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x1f
block|,
literal|0x1f
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [14] l3_pkt - IPV4 */
block|{
literal|8
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [15] l4_hdr over IPV4 */
block|{
literal|8
block|,
literal|12
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x1e
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [16] l3_pkt - IPV6 */
block|{
literal|11
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [17] l4_hdr over IPV6 */
block|{
literal|11
block|,
literal|12
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x1e
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [18] IPV4 over IPV4 */
block|{
literal|8
block|,
literal|0
block|,
literal|8
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x1f
block|,
literal|0x1f
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [19] l4_hdr over IPV4 over IPV4 */
block|{
literal|8
block|,
literal|0
block|,
literal|8
block|,
literal|12
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x1f
block|,
literal|0x1e
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [20] IPV4 over IPV6 */
block|{
literal|11
block|,
literal|0
block|,
literal|8
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x1f
block|,
literal|0x1f
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [21] l4_hdr over IPV4 over IPV6 */
block|{
literal|11
block|,
literal|0
block|,
literal|8
block|,
literal|12
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x1f
block|,
literal|0x1e
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [22] IPV6 over IPV4 */
block|{
literal|8
block|,
literal|0
block|,
literal|11
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x1f
block|,
literal|0x1f
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [23] l4_hdr over IPV6 over IPV4 */
block|{
literal|8
block|,
literal|0
block|,
literal|11
block|,
literal|12
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x1f
block|,
literal|0x1e
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [24] IPV6 over IPV6 */
block|{
literal|11
block|,
literal|0
block|,
literal|11
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x1f
block|,
literal|0x1f
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [25] l4_hdr over IPV6 over IPV6 */
block|{
literal|11
block|,
literal|0
block|,
literal|11
block|,
literal|12
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x1f
block|,
literal|0x1e
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [26] GENERIC_STORAGE_READ, over IPV4 (and udp) */
block|{
literal|8
block|,
literal|2
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [27] GENERIC_STORAGE_READ, over IPV6 (and udp) */
block|{
literal|11
block|,
literal|2
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [28] tunneled GENERIC_STORAGE_READ over IPV4 (and udp) over IPV4/IPV6 */
block|{
literal|8
block|,
literal|0
block|,
literal|8
block|,
literal|2
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x18
block|,
literal|0x0
block|,
literal|0x1f
block|,
literal|0x1f
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [29] tunneled GENERIC_STORAGE_READ over IPV6 (and udp)  over IPV4/IPV6 */
block|{
literal|8
block|,
literal|0
block|,
literal|11
block|,
literal|2
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x18
block|,
literal|0x0
block|,
literal|0x1f
block|,
literal|0x1f
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [30] tunneled L2 over GRE over IPV4 */
block|{
literal|8
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x1f
block|,
literal|0x0
block|,
literal|0x4
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|,
comment|/* [31] default match */
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|,
literal|0x0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|al_eth_rx_gcp_table_entry
name|al_eth_generic_rx_crc_gcp
index|[
name|AL_ETH_RX_PROTOCOL_DETECT_ENTRIES_NUM
index|]
init|=
block|{
comment|/* [0] roce (with grh, bth) */
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|4
block|,
literal|8
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0xffff7f03
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00c00000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0xffffffff
block|,
literal|0x03000010
block|,
literal|0
block|}
block|,
comment|/* [1] fcoe */
block|{
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|8
block|,
literal|14
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0xffffffff
block|,
literal|0x03000010
block|,
literal|0
block|}
block|,
comment|/* [2] routable_roce that is refered as l4_protocol, over IPV4 (and udp) */
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x3000cf00
block|,
literal|0x00000f00
block|,
literal|0xc0000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0xffffffff
block|,
literal|0x03000011
block|,
literal|0
block|}
block|,
comment|/* [3] routable_roce that is refered as l4_protocol, over IPV6 (and udp) */
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x7f030000
block|,
literal|0x00000000
block|,
literal|0x00000003
block|,
literal|0x00c00000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0xffffffff
block|,
literal|0x03000010
block|,
literal|0
block|}
block|,
comment|/* [4] routable_roce that is refered as tunneled_packet, over outer IPV4 and udp */
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|10
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x3000cf00
block|,
literal|0x00000f00
block|,
literal|0xc0000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0xffffffff
block|,
literal|0x0302201c
block|,
literal|28
block|}
block|,
comment|/* [5] routable_roce that is refered as tunneled_packet, over outer IPV6 and udp */
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|2
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|10
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x7f030000
block|,
literal|0x00000000
block|,
literal|0x00000003
block|,
literal|0x00c00000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0xffffffff
block|,
literal|0x03002018
block|,
literal|48
block|}
block|,
comment|/* [6] tunneled roce (with grh, bth) over IPV4 */
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|4
block|,
literal|8
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0xffff7f03
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00c00000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0xffffffff
block|,
literal|0x03020014
block|,
literal|0
block|}
block|,
comment|/* [7] tunneled roce (with grh, bth) over IPV6 */
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|4
block|,
literal|8
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0xffff7f03
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00c00000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0xffffffff
block|,
literal|0x03000010
block|,
literal|0
block|}
block|,
comment|/* [8] tunneled fcoe over IPV4 */
block|{
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|8
block|,
literal|14
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0xffffffff
block|,
literal|0x03020014
block|,
literal|0
block|}
block|,
comment|/* [9] tunneled fcoe over IPV6 */
block|{
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|8
block|,
literal|14
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0xffffffff
block|,
literal|0x03000010
block|,
literal|0
block|}
block|,
comment|/* [10] tunneled routable_roce that is refered as l4_protocol, over IPV4 (and udp) over IPV4 */
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x3000cf00
block|,
literal|0x00000f00
block|,
literal|0xc0000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0xffffffff
block|,
literal|0x03020015
block|,
literal|0
block|}
block|,
comment|/* [11] tunneled routable_roce that is refered as l4_protocol, over IPV4 (and udp) over IPV6 */
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x3000cf00
block|,
literal|0x00000f00
block|,
literal|0xc0000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0xffffffff
block|,
literal|0x03000011
block|,
literal|0
block|}
block|,
comment|/* [12] tunneled routable_roce that is refered as l4_protocol, over IPV6 (and udp) over IPV4 */
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x7f030000
block|,
literal|0x00000000
block|,
literal|0x00000003
block|,
literal|0x00c00000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0xffffffff
block|,
literal|0x03020014
block|,
literal|0
block|}
block|,
comment|/* [13] tunneled routable_roce that is refered as l4_protocol, over IPV6 (and udp) over IPV6 */
block|{
literal|0
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x7f030000
block|,
literal|0x00000000
block|,
literal|0x00000003
block|,
literal|0x00c00000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0xffffffff
block|,
literal|0x03000010
block|,
literal|0
block|}
block|,
comment|/* [14] l3_pkt - IPV4 */
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0x00000000
block|,
literal|0x00000001
block|,
literal|0
block|}
block|,
comment|/* [15] l4_hdr over IPV4 */
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0x00000000
block|,
literal|0x00000003
block|,
literal|0
block|}
block|,
comment|/* [16] l3_pkt - IPV6 */
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0
block|}
block|,
comment|/* [17] l4_hdr over IPV6 */
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0x00000000
block|,
literal|0x00000002
block|,
literal|0
block|}
block|,
comment|/* [18] IPV4 over IPV4 */
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0x00000000
block|,
literal|0x00020005
block|,
literal|0
block|}
block|,
comment|/* [19] l4_hdr over IPV4 over IPV4 */
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0x00000000
block|,
literal|0x00020007
block|,
literal|0
block|}
block|,
comment|/* [20] IPV4 over IPV6 */
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0x00000000
block|,
literal|0x00000001
block|,
literal|0
block|}
block|,
comment|/* [21] l4_hdr over IPV4 over IPV6 */
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0x00000000
block|,
literal|0x00000003
block|,
literal|0
block|}
block|,
comment|/* [22] IPV6 over IPV4 */
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0x00000000
block|,
literal|0x00020004
block|,
literal|0
block|}
block|,
comment|/* [23] l4_hdr over IPV6 over IPV4 */
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0x00000000
block|,
literal|0x00020006
block|,
literal|0
block|}
block|,
comment|/* [24] IPV6 over IPV6 */
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0
block|}
block|,
comment|/* [25] l4_hdr over IPV6 over IPV6 */
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0x00000000
block|,
literal|0x00000002
block|,
literal|0
block|}
block|,
comment|/* [26] GENERIC_STORAGE_READ, over IPV4 (and udp) */
block|{
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0xffffffff
block|,
literal|0x03000011
block|,
literal|0
block|}
block|,
comment|/* [27] GENERIC_STORAGE_READ, over IPV6 (and udp) */
block|{
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|2
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0xffffffff
block|,
literal|0x03000010
block|,
literal|0
block|}
block|,
comment|/* [28] tunneled GENERIC_STORAGE_READ over IPV4 (and udp) over IPV4/IPV6 */
block|{
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|3
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0xffffffff
block|,
literal|0x03000011
block|,
literal|0
block|}
block|,
comment|/* [29] tunneled GENERIC_STORAGE_READ over IPV6 (and udp)  over IPV4/IPV6 */
block|{
literal|1
block|,
literal|1
block|,
literal|1
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|4
block|,
literal|0
block|,
literal|0
block|,
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|3
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0xffffffff
block|,
literal|0x03000010
block|,
literal|0
block|}
block|,
comment|/* [30] tunneled L2 over GRE over IPV4 */
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0x00000000
block|,
literal|0x00020004
block|,
literal|0
block|}
block|,
comment|/* [31] default match */
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
block|{
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|,
literal|0x00000000
block|}
block|,
literal|0x00000000
block|,
literal|0x0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|al_eth_tx_protocol_detect_table_init
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|)
block|{
name|int
name|idx
decl_stmt|;
name|al_assert
argument_list|(
operator|(
name|adapter
operator|->
name|rev_id
operator|>
name|AL_ETH_REV_ID_2
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|AL_ETH_TX_GENERIC_CRC_ENTRIES_NUM
condition|;
name|idx
operator|++
control|)
name|al_eth_tx_protocol_detect_table_entry_set
argument_list|(
name|adapter
argument_list|,
name|idx
argument_list|,
operator|&
name|al_eth_generic_tx_crc_gpd
index|[
name|idx
index|]
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_tx_generic_crc_table_init
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|)
block|{
name|int
name|idx
decl_stmt|;
name|al_assert
argument_list|(
operator|(
name|adapter
operator|->
name|rev_id
operator|>
name|AL_ETH_REV_ID_2
operator|)
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"eth [%s]: enable tx_generic_crc\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|tx_gcp_legacy
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|tfw_v3
operator|.
name|crc_csum_replace
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|AL_ETH_TX_GENERIC_CRC_ENTRIES_NUM
condition|;
name|idx
operator|++
control|)
name|al_eth_tx_generic_crc_table_entry_set
argument_list|(
name|adapter
argument_list|,
name|idx
argument_list|,
operator|&
name|al_eth_generic_tx_crc_gcp
index|[
name|idx
index|]
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_tx_crc_chksum_replace_cmd_init
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|)
block|{
name|int
name|idx
decl_stmt|;
name|al_assert
argument_list|(
operator|(
name|adapter
operator|->
name|rev_id
operator|>
name|AL_ETH_REV_ID_2
operator|)
argument_list|)
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|AL_ETH_TX_GENERIC_CRC_ENTRIES_NUM
condition|;
name|idx
operator|++
control|)
name|al_eth_tx_crc_chksum_replace_cmd_entry_set
argument_list|(
name|adapter
argument_list|,
name|idx
argument_list|,
operator|&
name|al_eth_tx_crc_chksum_replace_cmd
index|[
name|idx
index|]
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_rx_protocol_detect_table_init
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|)
block|{
name|int
name|idx
decl_stmt|;
name|al_assert
argument_list|(
operator|(
name|adapter
operator|->
name|rev_id
operator|>
name|AL_ETH_REV_ID_2
operator|)
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|gpd_p1
argument_list|,
name|AL_ETH_RX_GPD_PARSE_RESULT_OUTER_L3_PROTO_IDX_OFFSET
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|gpd_p2
argument_list|,
name|AL_ETH_RX_GPD_PARSE_RESULT_OUTER_L4_PROTO_IDX_OFFSET
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|gpd_p3
argument_list|,
name|AL_ETH_RX_GPD_PARSE_RESULT_INNER_L3_PROTO_IDX_OFFSET
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|gpd_p4
argument_list|,
name|AL_ETH_RX_GPD_PARSE_RESULT_INNER_L4_PROTO_IDX_OFFSET
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|gpd_p5
argument_list|,
name|AL_ETH_RX_GPD_PARSE_RESULT_OUTER_PARSE_CTRL
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|gpd_p6
argument_list|,
name|AL_ETH_RX_GPD_PARSE_RESULT_INNER_PARSE_CTRL
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|gpd_p7
argument_list|,
name|AL_ETH_RX_GPD_PARSE_RESULT_L3_PRIORITY
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|gpd_p8
argument_list|,
name|AL_ETH_RX_GPD_PARSE_RESULT_OUTER_L4_DST_PORT_LSB
argument_list|)
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|AL_ETH_RX_PROTOCOL_DETECT_ENTRIES_NUM
condition|;
name|idx
operator|++
control|)
name|al_eth_rx_protocol_detect_table_entry_set
argument_list|(
name|adapter
argument_list|,
name|idx
argument_list|,
operator|&
name|al_eth_generic_rx_crc_gpd
index|[
name|idx
index|]
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_rx_generic_crc_table_init
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|)
block|{
name|int
name|idx
decl_stmt|;
name|uint32_t
name|val
decl_stmt|;
name|al_assert
argument_list|(
operator|(
name|adapter
operator|->
name|rev_id
operator|>
name|AL_ETH_REV_ID_2
operator|)
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"eth [%s]: enable rx_generic_crc\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|rfw_v3
operator|.
name|rx_gcp_legacy
argument_list|,
literal|0x0
argument_list|)
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|AL_ETH_RX_PROTOCOL_DETECT_ENTRIES_NUM
condition|;
name|idx
operator|++
control|)
name|al_eth_rx_generic_crc_table_entry_set
argument_list|(
name|adapter
argument_list|,
name|idx
argument_list|,
operator|&
name|al_eth_generic_rx_crc_gcp
index|[
name|idx
index|]
argument_list|)
expr_stmt|;
name|val
operator|=
name|EC_GEN_V3_RX_COMP_DESC_W3_DEC_STAT_15_CRC_RES_SEL
operator||
name|EC_GEN_V3_RX_COMP_DESC_W3_DEC_STAT_14_L3_CKS_RES_SEL
operator||
name|EC_GEN_V3_RX_COMP_DESC_W3_DEC_STAT_13_L4_CKS_RES_SEL
operator||
name|EC_GEN_V3_RX_COMP_DESC_W0_L3_CKS_RES_SEL
expr_stmt|;
name|al_reg_write32_masked
argument_list|(
operator|&
name|adapter
operator|->
name|ec_regs_base
operator|->
name|gen_v3
operator|.
name|rx_comp_desc
argument_list|,
name|val
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** @} end of Ethernet group */
end_comment

end_unit


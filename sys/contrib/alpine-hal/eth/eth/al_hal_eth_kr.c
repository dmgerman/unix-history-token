begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*- ******************************************************************************* Copyright (C) 2015 Annapurna Labs Ltd.  This file may be licensed under the terms of the Annapurna Labs Commercial License Agreement.  Alternatively, this file can be distributed under the terms of the GNU General Public License V2 as published by the Free Software Foundation and can be found at http://www.gnu.org/licenses/gpl-2.0.html  Alternatively, redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:      *     Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.      *     Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *******************************************************************************/
end_comment

begin_comment
comment|/**  *  Ethernet  *  @{  * @file   al_hal_eth_kr.c  *  * @brief  KR HAL driver for main functions (auto-neg, Link Training)  *  */
end_comment

begin_include
include|#
directive|include
file|"al_hal_eth_kr.h"
end_include

begin_include
include|#
directive|include
file|"al_hal_eth_mac_regs.h"
end_include

begin_include
include|#
directive|include
file|"al_hal_an_lt_wrapper_regs.h"
end_include

begin_enum
enum|enum
name|al_eth_lt_unit_rev
block|{
name|AL_ETH_LT_UNIT_REV_1
init|=
literal|0
block|,
name|AL_ETH_LT_UNIT_REV_2
block|,
name|AL_ETH_LT_UNIT_REV_MAX
block|}
enum|;
end_enum

begin_enum
enum|enum
name|al_eth_an_lt_regs_ids
block|{
name|AL_ETH_KR_AN_CONTROL
init|=
literal|0
block|,
name|AL_ETH_KR_AN_STATUS
block|,
name|AL_ETH_KR_AN_ADV0
block|,
name|AL_ETH_KR_AN_ADV1
block|,
name|AL_ETH_KR_AN_ADV2
block|,
name|AL_ETH_KR_AN_REM_ADV0
block|,
name|AL_ETH_KR_AN_REM_ADV1
block|,
name|AL_ETH_KR_AN_REM_ADV2
block|,
name|AL_ETH_KR_PMD_CONTROL
block|,
name|AL_ETH_KR_PMD_STATUS
block|,
name|AL_ETH_KR_PMD_LP_COEF_UP
block|,
name|AL_ETH_KR_PMD_LP_STATUS_REPORT
block|,
name|AL_ETH_KR_PMD_LD_COEF_UP
block|,
name|AL_ETH_KR_PMD_LD_STATUS_REPORT
block|,
name|AL_ETH_KR_AN_XNP_ADV0
block|,
name|AL_ETH_KR_AN_XNP_ADV1
block|,
name|AL_ETH_KR_AN_XNP_ADV2
block|,
name|AL_ETH_KR_AN_REM_XNP_ADV0
block|,
name|AL_ETH_KR_AN_REM_XNP_ADV1
block|,
name|AL_ETH_KR_AN_REM_XNP_ADV2
block|, }
enum|;
end_enum

begin_decl_stmt
specifier|static
name|uint32_t
name|al_eth_an_lt_regs_addr
index|[]
index|[
name|AL_ETH_LT_UNIT_REV_MAX
index|]
init|=
block|{
index|[
name|AL_ETH_KR_AN_CONTROL
index|]
operator|=
block|{
literal|0
block|,
literal|0x0
block|}
block|,
index|[
name|AL_ETH_KR_AN_STATUS
index|]
operator|=
block|{
literal|1
block|,
literal|0x4
block|}
block|,
index|[
name|AL_ETH_KR_AN_ADV0
index|]
operator|=
block|{
literal|16
block|,
literal|0x8
block|}
block|,
index|[
name|AL_ETH_KR_AN_ADV1
index|]
operator|=
block|{
literal|17
block|,
literal|0xc
block|}
block|,
index|[
name|AL_ETH_KR_AN_ADV2
index|]
operator|=
block|{
literal|18
block|,
literal|0x10
block|}
block|,
index|[
name|AL_ETH_KR_AN_REM_ADV0
index|]
operator|=
block|{
literal|19
block|,
literal|0x14
block|}
block|,
index|[
name|AL_ETH_KR_AN_REM_ADV1
index|]
operator|=
block|{
literal|20
block|,
literal|0x18
block|}
block|,
index|[
name|AL_ETH_KR_AN_REM_ADV2
index|]
operator|=
block|{
literal|21
block|,
literal|0x1c
block|}
block|,
index|[
name|AL_ETH_KR_PMD_CONTROL
index|]
operator|=
block|{
literal|150
block|,
literal|0x400
block|}
block|,
index|[
name|AL_ETH_KR_PMD_STATUS
index|]
operator|=
block|{
literal|151
block|,
literal|0x404
block|}
block|,
index|[
name|AL_ETH_KR_PMD_LP_COEF_UP
index|]
operator|=
block|{
literal|152
block|,
literal|0x408
block|}
block|,
index|[
name|AL_ETH_KR_PMD_LP_STATUS_REPORT
index|]
operator|=
block|{
literal|153
block|,
literal|0x40c
block|}
block|,
index|[
name|AL_ETH_KR_PMD_LD_COEF_UP
index|]
operator|=
block|{
literal|154
block|,
literal|0x410
block|}
block|,
index|[
name|AL_ETH_KR_PMD_LD_STATUS_REPORT
index|]
operator|=
block|{
literal|155
block|,
literal|0x414
block|}
block|,
index|[
name|AL_ETH_KR_AN_XNP_ADV0
index|]
operator|=
block|{
literal|22
block|,
literal|0x24
block|}
block|,
index|[
name|AL_ETH_KR_AN_XNP_ADV1
index|]
operator|=
block|{
literal|23
block|,
literal|0x28
block|}
block|,
index|[
name|AL_ETH_KR_AN_XNP_ADV2
index|]
operator|=
block|{
literal|24
block|,
literal|0x2c
block|}
block|,
index|[
name|AL_ETH_KR_AN_REM_XNP_ADV0
index|]
operator|=
block|{
literal|25
block|,
literal|0x30
block|}
block|,
index|[
name|AL_ETH_KR_AN_REM_XNP_ADV1
index|]
operator|=
block|{
literal|26
block|,
literal|0x34
block|}
block|,
index|[
name|AL_ETH_KR_AN_REM_XNP_ADV2
index|]
operator|=
block|{
literal|27
block|,
literal|0x38
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * AN(Auto Negotiation) registers  * (read / write indirect with al_eth_an_reg_read/write)  */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_CONTROL_RESTART
value|AL_BIT(9)
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_CONTROL_ENABLE
value|AL_BIT(12)
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_CONTROL_NP_ENABLE
value|AL_BIT(13)
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_STATUS_COMPLETED
value|AL_BIT(5)
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_STATUS_BASE_PAGE_RECEIVED
value|AL_BIT(6)
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_STATUS_CHECK_MASK
value|0xFF0A
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_STATUS_CHECK_NO_ERROR
value|0x0008
end_define

begin_comment
comment|/* AN advertising registers parsing */
end_comment

begin_comment
comment|/* register 1 */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_ADV1_SEL_FIELD_MASK
value|0x001f
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_ADV1_SEL_FIELD_SHIFT
value|0
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_ADV1_ECHOED_NONCE_MASK
value|0x03e0
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_ADV1_ECHOED_NONCE_SHIFT
value|5
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_ADV1_CAPABILITY_MASK
value|0x1c00
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_ADV1_CAPABILITY_SHIFT
value|10
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_ADV1_REM_FAULT_MASK
value|0x2000
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_ADV1_REM_FAULT_SHIFT
value|13
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_ADV1_ACK_MASK
value|0x4000
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_ADV1_ACK_SHIFT
value|14
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_ADV1_NEXT_PAGE_MASK
value|0x8000
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_ADV1_NEXT_PAGE_SHIFT
value|15
end_define

begin_comment
comment|/* register 2 */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_ADV2_TX_NONCE_MASK
value|0x001f
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_ADV2_TX_NONCE_SHIFT
value|0
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_ADV2_TECH_MASK
value|0xffe0
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_ADV2_TECH_SHIFT
value|5
end_define

begin_comment
comment|/* register 3 */
end_comment

begin_comment
comment|/* TECH field in the third register is extended to the field in the second  * register and it is currently reserved (should be always 0) */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_ADV3_TECH_MASK
value|0x1fff
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_ADV3_TECH_SHIFT
value|0
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_ADV3_FEC_MASK
value|0xc000
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_ADV3_FEC_SHIFT
value|14
end_define

begin_comment
comment|/* Next Page Fields */
end_comment

begin_comment
comment|/* register 1 */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_NP_ADV1_DATA1_MASK
value|0x07ff
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_NP_ADV1_DATA1_SHIFT
value|0
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_NP_ADV1_TOGGLE_MASK
value|0x0800
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_NP_ADV1_TOGGLE_SHIFT
value|11
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_NP_ADV1_ACK2_MASK
value|0x1000
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_NP_ADV1_ACK2_SHIFT
value|12
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_NP_ADV1_MSG_PAGE_MASK
value|0x2000
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_NP_ADV1_MSG_PAGE_SHIFT
value|13
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_NP_ADV1_NP_MASK
value|0x8000
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_AN_NP_ADV1_NP_SHIFT
value|15
end_define

begin_comment
comment|/*  * LT(Link Training) registers  * (read / write indirect with al_eth_pma_reg_read/write)  */
end_comment

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_CONTROL_RESTART
value|0
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_CONTROL_ENABLE
value|1
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_STATUS_RECEIVER_COMPLETED_SHIFT
value|0
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_STATUS_RECEIVER_FRAME_LOCK_SHIFT
value|1
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_STATUS_RECEIVER_START_UP_PROTO_PROG_SHIFT
value|2
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_STATUS_FAILURE_SHIFT
value|3
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LP_COEF_UP_MINUS_MASK
value|0x0003
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LP_COEF_UP_MINUS_SHIFT
value|0
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LP_COEF_UP_ZERO_MASK
value|0x000C
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LP_COEF_UP_ZERO_SHIFT
value|2
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LP_COEF_UP_PLUS_MASK
value|0x0030
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LP_COEF_UP_PLUS_SHIFT
value|4
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LP_COEF_UP_INITIALIZE_SHIFT
value|12
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LP_COEF_UP_PRESET_SHIFT
value|13
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LP_STATUS_REPORT_MINUS_MASK
value|0x0003
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LP_STATUS_REPORT_MINUS_SHIFT
value|0
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LP_STATUS_REPORT_ZERO_MASK
value|0x000C
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LP_STATUS_REPORT_ZERO_SHIFT
value|2
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LP_STATUS_REPORT_PLUS_MASK
value|0x0030
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LP_STATUS_REPORT_PLUS_SHIFT
value|4
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LP_STATUS_RECEIVER_READY_SHIFT
value|15
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LD_COEF_UP_MINUS_MASK
value|0x0003
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LD_COEF_UP_MINUS_SHIFT
value|0
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LD_COEF_UP_ZERO_MASK
value|0x000C
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LD_COEF_UP_ZERO_SHIFT
value|2
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LD_COEF_UP_PLUS_MASK
value|0x0030
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LD_COEF_UP_PLUS_SHIFT
value|4
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LD_COEF_UP_INITIALIZE_SHIFT
value|12
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LD_COEF_UP_PRESET_SHIFT
value|13
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LD_STATUS_REPORT_MINUS_MASK
value|0x0003
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LD_STATUS_REPORT_MINUS_SHIFT
value|0
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LD_STATUS_REPORT_ZERO_MASK
value|0x000C
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LD_STATUS_REPORT_ZERO_SHIFT
value|2
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LD_STATUS_REPORT_PLUS_MASK
value|0x0030
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LD_STATUS_REPORT_PLUS_SHIFT
value|4
end_define

begin_define
define|#
directive|define
name|AL_ETH_KR_PMD_LD_STATUS_REPORT_RECEIVER_READY_SHIFT
value|15
end_define

begin_enum
enum|enum
name|al_eth_an_lt_regs
block|{
name|AL_ETH_AN_REGS
block|,
name|AL_ETH_LT_REGS
block|, }
enum|;
end_enum

begin_function
specifier|static
name|uint16_t
name|al_eth_an_lt_reg_read
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|enum
name|al_eth_an_lt_regs_ids
name|reg_id
parameter_list|,
name|enum
name|al_eth_an_lt_regs
name|an_lt
parameter_list|,
name|enum
name|al_eth_an_lt_lane
name|lane
parameter_list|)
block|{
name|uint32_t
name|val
decl_stmt|;
name|uint16_t
name|reg_addr
decl_stmt|;
if|if
condition|(
name|adapter
operator|->
name|rev_id
operator|<
name|AL_ETH_REV_ID_3
condition|)
block|{
name|al_assert
argument_list|(
name|lane
operator|==
name|AL_ETH_AN__LT_LANE_0
argument_list|)
expr_stmt|;
name|reg_addr
operator|=
name|al_eth_an_lt_regs_addr
index|[
name|reg_id
index|]
index|[
name|AL_ETH_LT_UNIT_REV_1
index|]
expr_stmt|;
if|if
condition|(
name|an_lt
operator|==
name|AL_ETH_AN_REGS
condition|)
block|{
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|kr
operator|.
name|an_addr
argument_list|,
name|reg_addr
argument_list|)
expr_stmt|;
name|val
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|kr
operator|.
name|an_data
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|kr
operator|.
name|pma_addr
argument_list|,
name|reg_addr
argument_list|)
expr_stmt|;
name|val
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|kr
operator|.
name|pma_data
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|struct
name|al_an_lt_wrapper_regs
modifier|*
name|regs
init|=
name|NULL
decl_stmt|;
name|reg_addr
operator|=
name|al_eth_an_lt_regs_addr
index|[
name|reg_id
index|]
index|[
name|AL_ETH_LT_UNIT_REV_2
index|]
expr_stmt|;
switch|switch
condition|(
name|lane
condition|)
block|{
case|case
name|AL_ETH_AN__LT_LANE_0
case|:
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_0_addr
argument_list|,
operator|(
name|uintptr_t
operator|)
operator|&
name|regs
operator|->
name|an_lt
index|[
name|adapter
operator|->
name|curr_lt_unit
index|]
operator|.
name|addr
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_0_data
argument_list|,
name|reg_addr
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_0_addr
argument_list|,
operator|(
name|uintptr_t
operator|)
operator|&
name|regs
operator|->
name|an_lt
index|[
name|adapter
operator|->
name|curr_lt_unit
index|]
operator|.
name|data
argument_list|)
expr_stmt|;
name|val
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_0_data
argument_list|)
expr_stmt|;
break|break;
case|case
name|AL_ETH_AN__LT_LANE_1
case|:
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_1_addr
argument_list|,
operator|(
name|uintptr_t
operator|)
operator|&
name|regs
operator|->
name|an_lt
index|[
name|adapter
operator|->
name|curr_lt_unit
index|]
operator|.
name|addr
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_1_data
argument_list|,
name|reg_addr
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_1_addr
argument_list|,
operator|(
name|uintptr_t
operator|)
operator|&
name|regs
operator|->
name|an_lt
index|[
name|adapter
operator|->
name|curr_lt_unit
index|]
operator|.
name|data
argument_list|)
expr_stmt|;
name|val
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_1_data
argument_list|)
expr_stmt|;
break|break;
case|case
name|AL_ETH_AN__LT_LANE_2
case|:
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_2_addr
argument_list|,
operator|(
name|uintptr_t
operator|)
operator|&
name|regs
operator|->
name|an_lt
index|[
name|adapter
operator|->
name|curr_lt_unit
index|]
operator|.
name|addr
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_2_data
argument_list|,
name|reg_addr
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_2_addr
argument_list|,
operator|(
name|uintptr_t
operator|)
operator|&
name|regs
operator|->
name|an_lt
index|[
name|adapter
operator|->
name|curr_lt_unit
index|]
operator|.
name|data
argument_list|)
expr_stmt|;
name|val
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_2_data
argument_list|)
expr_stmt|;
break|break;
case|case
name|AL_ETH_AN__LT_LANE_3
case|:
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_3_addr
argument_list|,
operator|(
name|uintptr_t
operator|)
operator|&
name|regs
operator|->
name|an_lt
index|[
name|adapter
operator|->
name|curr_lt_unit
index|]
operator|.
name|addr
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_3_data
argument_list|,
name|reg_addr
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_3_addr
argument_list|,
operator|(
name|uintptr_t
operator|)
operator|&
name|regs
operator|->
name|an_lt
index|[
name|adapter
operator|->
name|curr_lt_unit
index|]
operator|.
name|data
argument_list|)
expr_stmt|;
name|val
operator|=
name|al_reg_read32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_3_data
argument_list|)
expr_stmt|;
break|break;
default|default:
name|al_err
argument_list|(
literal|"%s: Unknown Lane %d\n"
argument_list|,
name|__func__
argument_list|,
name|lane
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
name|al_dbg
argument_list|(
literal|"[%s]: %s - (%s) lane %d, reg %d, val 0x%x"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|__func__
argument_list|,
operator|(
name|an_lt
operator|==
name|AL_ETH_AN_REGS
operator|)
condition|?
literal|"AN"
else|:
literal|"LT"
argument_list|,
name|lane
argument_list|,
name|reg_addr
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
name|uint16_t
operator|)
name|val
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|al_eth_an_lt_reg_write
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|enum
name|al_eth_an_lt_regs_ids
name|reg_id
parameter_list|,
name|enum
name|al_eth_an_lt_regs
name|an_lt
parameter_list|,
name|enum
name|al_eth_an_lt_lane
name|lane
parameter_list|,
name|uint16_t
name|val
parameter_list|)
block|{
name|uint16_t
name|reg_addr
decl_stmt|;
if|if
condition|(
name|adapter
operator|->
name|rev_id
operator|<
name|AL_ETH_REV_ID_3
condition|)
block|{
name|reg_addr
operator|=
name|al_eth_an_lt_regs_addr
index|[
name|reg_id
index|]
index|[
name|AL_ETH_LT_UNIT_REV_1
index|]
expr_stmt|;
if|if
condition|(
name|an_lt
operator|==
name|AL_ETH_AN_REGS
condition|)
block|{
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|kr
operator|.
name|an_addr
argument_list|,
name|reg_addr
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|kr
operator|.
name|an_data
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|kr
operator|.
name|pma_addr
argument_list|,
name|reg_addr
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|kr
operator|.
name|pma_data
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|struct
name|al_an_lt_wrapper_regs
modifier|*
name|regs
init|=
name|NULL
decl_stmt|;
name|reg_addr
operator|=
name|al_eth_an_lt_regs_addr
index|[
name|reg_id
index|]
index|[
name|AL_ETH_LT_UNIT_REV_2
index|]
expr_stmt|;
switch|switch
condition|(
name|lane
condition|)
block|{
case|case
name|AL_ETH_AN__LT_LANE_0
case|:
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_0_addr
argument_list|,
operator|(
name|uintptr_t
operator|)
operator|&
name|regs
operator|->
name|an_lt
index|[
name|adapter
operator|->
name|curr_lt_unit
index|]
operator|.
name|addr
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_0_data
argument_list|,
name|reg_addr
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_0_addr
argument_list|,
operator|(
name|uintptr_t
operator|)
operator|&
name|regs
operator|->
name|an_lt
index|[
name|adapter
operator|->
name|curr_lt_unit
index|]
operator|.
name|data
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_0_data
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
name|AL_ETH_AN__LT_LANE_1
case|:
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_1_addr
argument_list|,
operator|(
name|uintptr_t
operator|)
operator|&
name|regs
operator|->
name|an_lt
index|[
name|adapter
operator|->
name|curr_lt_unit
index|]
operator|.
name|addr
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_1_data
argument_list|,
name|reg_addr
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_1_addr
argument_list|,
operator|(
name|uintptr_t
operator|)
operator|&
name|regs
operator|->
name|an_lt
index|[
name|adapter
operator|->
name|curr_lt_unit
index|]
operator|.
name|data
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_1_data
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
name|AL_ETH_AN__LT_LANE_2
case|:
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_2_addr
argument_list|,
operator|(
name|uintptr_t
operator|)
operator|&
name|regs
operator|->
name|an_lt
index|[
name|adapter
operator|->
name|curr_lt_unit
index|]
operator|.
name|addr
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_2_data
argument_list|,
name|reg_addr
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_2_addr
argument_list|,
operator|(
name|uintptr_t
operator|)
operator|&
name|regs
operator|->
name|an_lt
index|[
name|adapter
operator|->
name|curr_lt_unit
index|]
operator|.
name|data
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_2_data
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
case|case
name|AL_ETH_AN__LT_LANE_3
case|:
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_3_addr
argument_list|,
operator|(
name|uintptr_t
operator|)
operator|&
name|regs
operator|->
name|an_lt
index|[
name|adapter
operator|->
name|curr_lt_unit
index|]
operator|.
name|addr
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_3_data
argument_list|,
name|reg_addr
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_3_addr
argument_list|,
operator|(
name|uintptr_t
operator|)
operator|&
name|regs
operator|->
name|an_lt
index|[
name|adapter
operator|->
name|curr_lt_unit
index|]
operator|.
name|data
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_3_data
argument_list|,
name|val
argument_list|)
expr_stmt|;
break|break;
default|default:
name|al_err
argument_list|(
literal|"%s: Unknown Lane %d\n"
argument_list|,
name|__func__
argument_list|,
name|lane
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|al_dbg
argument_list|(
literal|"[%s]: %s - (%s) lane %d, reg %d, val 0x%x"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|__func__
argument_list|,
operator|(
name|an_lt
operator|==
name|AL_ETH_AN_REGS
operator|)
condition|?
literal|"AN"
else|:
literal|"LT"
argument_list|,
name|lane
argument_list|,
name|reg_addr
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|al_eth_an_lt_unit_config
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|)
block|{
name|struct
name|al_an_lt_wrapper_regs
modifier|*
name|regs
init|=
name|NULL
decl_stmt|;
name|uint32_t
name|cfg_lane_0
init|=
operator|(
name|AN_LT_WRAPPER_GEN_CFG_BYPASS_RX
operator||
name|AN_LT_WRAPPER_GEN_CFG_BYPASS_TX
operator|)
decl_stmt|;
name|uint32_t
name|cfg_lane_1
init|=
operator|(
name|AN_LT_WRAPPER_GEN_CFG_BYPASS_RX
operator||
name|AN_LT_WRAPPER_GEN_CFG_BYPASS_TX
operator|)
decl_stmt|;
name|uint32_t
name|cfg_lane_2
init|=
operator|(
name|AN_LT_WRAPPER_GEN_CFG_BYPASS_RX
operator||
name|AN_LT_WRAPPER_GEN_CFG_BYPASS_TX
operator|)
decl_stmt|;
name|uint32_t
name|cfg_lane_3
init|=
operator|(
name|AN_LT_WRAPPER_GEN_CFG_BYPASS_RX
operator||
name|AN_LT_WRAPPER_GEN_CFG_BYPASS_TX
operator|)
decl_stmt|;
switch|switch
condition|(
name|adapter
operator|->
name|mac_mode
condition|)
block|{
case|case
name|AL_ETH_MAC_MODE_10GbE_Serial
case|:
name|cfg_lane_0
operator|=
literal|0
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|cfg_lane_0
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_RX_MASK
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_RX_SHIFT
argument_list|,
name|AL_ETH_AN_LT_UNIT_20_BIT
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|cfg_lane_0
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_TX_MASK
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_TX_SHIFT
argument_list|,
name|AL_ETH_AN_LT_UNIT_20_BIT
argument_list|)
expr_stmt|;
name|adapter
operator|->
name|curr_lt_unit
operator|=
name|AL_ETH_AN_LT_UNIT_20_BIT
expr_stmt|;
break|break;
case|case
name|AL_ETH_MAC_MODE_KR_LL_25G
case|:
name|cfg_lane_0
operator|=
literal|0
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|cfg_lane_0
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_RX_MASK
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_RX_SHIFT
argument_list|,
name|AL_ETH_AN_LT_UNIT_32_BIT
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|cfg_lane_0
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_TX_MASK
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_TX_SHIFT
argument_list|,
name|AL_ETH_AN_LT_UNIT_32_BIT
argument_list|)
expr_stmt|;
name|adapter
operator|->
name|curr_lt_unit
operator|=
name|AL_ETH_AN_LT_UNIT_32_BIT
expr_stmt|;
break|break;
case|case
name|AL_ETH_MAC_MODE_XLG_LL_40G
case|:
name|cfg_lane_0
operator|=
literal|0
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|cfg_lane_0
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_RX_MASK
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_RX_SHIFT
argument_list|,
name|AL_ETH_AN_LT_UNIT_16_BIT
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|cfg_lane_0
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_TX_MASK
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_TX_SHIFT
argument_list|,
name|AL_ETH_AN_LT_UNIT_16_BIT
argument_list|)
expr_stmt|;
name|cfg_lane_1
operator|=
literal|0
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|cfg_lane_1
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_RX_MASK
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_RX_SHIFT
argument_list|,
name|AL_ETH_AN_LT_UNIT_16_BIT
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|cfg_lane_1
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_TX_MASK
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_TX_SHIFT
argument_list|,
name|AL_ETH_AN_LT_UNIT_16_BIT
argument_list|)
expr_stmt|;
name|cfg_lane_2
operator|=
literal|0
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|cfg_lane_2
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_RX_MASK
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_RX_SHIFT
argument_list|,
name|AL_ETH_AN_LT_UNIT_16_BIT
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|cfg_lane_2
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_TX_MASK
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_TX_SHIFT
argument_list|,
name|AL_ETH_AN_LT_UNIT_16_BIT
argument_list|)
expr_stmt|;
name|cfg_lane_3
operator|=
literal|0
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|cfg_lane_3
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_RX_MASK
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_RX_SHIFT
argument_list|,
name|AL_ETH_AN_LT_UNIT_16_BIT
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|cfg_lane_3
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_TX_MASK
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_TX_SHIFT
argument_list|,
name|AL_ETH_AN_LT_UNIT_16_BIT
argument_list|)
expr_stmt|;
name|adapter
operator|->
name|curr_lt_unit
operator|=
name|AL_ETH_AN_LT_UNIT_16_BIT
expr_stmt|;
break|break;
case|case
name|AL_ETH_MAC_MODE_XLG_LL_50G
case|:
name|cfg_lane_0
operator|=
literal|0
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|cfg_lane_0
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_RX_MASK
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_RX_SHIFT
argument_list|,
name|AL_ETH_AN_LT_UNIT_32_BIT
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|cfg_lane_0
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_TX_MASK
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_TX_SHIFT
argument_list|,
name|AL_ETH_AN_LT_UNIT_32_BIT
argument_list|)
expr_stmt|;
name|cfg_lane_1
operator|=
literal|0
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|cfg_lane_1
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_RX_MASK
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_RX_SHIFT
argument_list|,
name|AL_ETH_AN_LT_UNIT_32_BIT
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|cfg_lane_1
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_TX_MASK
argument_list|,
name|AN_LT_WRAPPER_GEN_CFG_AN_LT_SEL_TX_SHIFT
argument_list|,
name|AL_ETH_AN_LT_UNIT_32_BIT
argument_list|)
expr_stmt|;
name|adapter
operator|->
name|curr_lt_unit
operator|=
name|AL_ETH_AN_LT_UNIT_32_BIT
expr_stmt|;
break|break;
default|default:
name|al_err
argument_list|(
literal|"%s: Unknown mac_mode\n"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_0_addr
argument_list|,
operator|(
name|uintptr_t
operator|)
operator|&
name|regs
operator|->
name|gen
operator|.
name|cfg
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_0_data
argument_list|,
name|cfg_lane_0
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_1_addr
argument_list|,
operator|(
name|uintptr_t
operator|)
operator|&
name|regs
operator|->
name|gen
operator|.
name|cfg
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_1_data
argument_list|,
name|cfg_lane_1
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_2_addr
argument_list|,
operator|(
name|uintptr_t
operator|)
operator|&
name|regs
operator|->
name|gen
operator|.
name|cfg
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_2_data
argument_list|,
name|cfg_lane_2
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_3_addr
argument_list|,
operator|(
name|uintptr_t
operator|)
operator|&
name|regs
operator|->
name|gen
operator|.
name|cfg
argument_list|)
expr_stmt|;
name|al_reg_write32
argument_list|(
operator|&
name|adapter
operator|->
name|mac_regs_base
operator|->
name|gen_v3
operator|.
name|an_lt_3_data
argument_list|,
name|cfg_lane_3
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|al_eth_lp_coeff_up_get
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|enum
name|al_eth_an_lt_lane
name|lane
parameter_list|,
name|struct
name|al_eth_kr_coef_up_data
modifier|*
name|lpcoeff
parameter_list|)
block|{
name|uint16_t
name|reg
decl_stmt|;
name|reg
operator|=
name|al_eth_an_lt_reg_read
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_PMD_LP_COEF_UP
argument_list|,
name|AL_ETH_LT_REGS
argument_list|,
name|lane
argument_list|)
expr_stmt|;
name|lpcoeff
operator|->
name|preset
operator|=
operator|(
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_PMD_LP_COEF_UP_PRESET_SHIFT
argument_list|)
operator|!=
literal|0
operator|)
expr_stmt|;
name|lpcoeff
operator|->
name|initialize
operator|=
operator|(
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_PMD_LP_COEF_UP_INITIALIZE_SHIFT
argument_list|)
operator|!=
literal|0
operator|)
expr_stmt|;
name|lpcoeff
operator|->
name|c_minus
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_PMD_LP_COEF_UP_MINUS_MASK
argument_list|,
name|AL_ETH_KR_PMD_LP_COEF_UP_MINUS_SHIFT
argument_list|)
expr_stmt|;
name|lpcoeff
operator|->
name|c_zero
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_PMD_LP_COEF_UP_ZERO_MASK
argument_list|,
name|AL_ETH_KR_PMD_LP_COEF_UP_ZERO_SHIFT
argument_list|)
expr_stmt|;
name|lpcoeff
operator|->
name|c_plus
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_PMD_LP_COEF_UP_PLUS_MASK
argument_list|,
name|AL_ETH_KR_PMD_LP_COEF_UP_PLUS_SHIFT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|al_eth_lp_status_report_get
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|enum
name|al_eth_an_lt_lane
name|lane
parameter_list|,
name|struct
name|al_eth_kr_status_report_data
modifier|*
name|status
parameter_list|)
block|{
name|uint16_t
name|reg
decl_stmt|;
name|reg
operator|=
name|al_eth_an_lt_reg_read
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_PMD_LP_STATUS_REPORT
argument_list|,
name|AL_ETH_LT_REGS
argument_list|,
name|lane
argument_list|)
expr_stmt|;
name|status
operator|->
name|c_minus
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_PMD_LP_STATUS_REPORT_MINUS_MASK
argument_list|,
name|AL_ETH_KR_PMD_LP_STATUS_REPORT_MINUS_SHIFT
argument_list|)
expr_stmt|;
name|status
operator|->
name|c_zero
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_PMD_LP_STATUS_REPORT_ZERO_MASK
argument_list|,
name|AL_ETH_KR_PMD_LP_STATUS_REPORT_ZERO_SHIFT
argument_list|)
expr_stmt|;
name|status
operator|->
name|c_plus
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_PMD_LP_STATUS_REPORT_PLUS_MASK
argument_list|,
name|AL_ETH_KR_PMD_LP_STATUS_REPORT_PLUS_SHIFT
argument_list|)
expr_stmt|;
name|status
operator|->
name|receiver_ready
operator|=
operator|(
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_PMD_LP_STATUS_RECEIVER_READY_SHIFT
argument_list|)
operator|!=
literal|0
operator|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|al_eth_ld_coeff_up_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|enum
name|al_eth_an_lt_lane
name|lane
parameter_list|,
name|struct
name|al_eth_kr_coef_up_data
modifier|*
name|ldcoeff
parameter_list|)
block|{
name|uint16_t
name|reg
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ldcoeff
operator|->
name|preset
condition|)
name|AL_REG_BIT_SET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_PMD_LD_COEF_UP_PRESET_SHIFT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldcoeff
operator|->
name|initialize
condition|)
name|AL_REG_BIT_SET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_PMD_LD_COEF_UP_INITIALIZE_SHIFT
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_PMD_LD_COEF_UP_MINUS_MASK
argument_list|,
name|AL_ETH_KR_PMD_LD_COEF_UP_MINUS_SHIFT
argument_list|,
name|ldcoeff
operator|->
name|c_minus
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_PMD_LD_COEF_UP_ZERO_MASK
argument_list|,
name|AL_ETH_KR_PMD_LD_COEF_UP_ZERO_SHIFT
argument_list|,
name|ldcoeff
operator|->
name|c_zero
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_PMD_LD_COEF_UP_PLUS_MASK
argument_list|,
name|AL_ETH_KR_PMD_LD_COEF_UP_PLUS_SHIFT
argument_list|,
name|ldcoeff
operator|->
name|c_plus
argument_list|)
expr_stmt|;
name|al_eth_an_lt_reg_write
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_PMD_LD_COEF_UP
argument_list|,
name|AL_ETH_LT_REGS
argument_list|,
name|lane
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|al_eth_ld_status_report_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|enum
name|al_eth_an_lt_lane
name|lane
parameter_list|,
name|struct
name|al_eth_kr_status_report_data
modifier|*
name|status
parameter_list|)
block|{
name|uint16_t
name|reg
init|=
literal|0
decl_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_PMD_LD_STATUS_REPORT_MINUS_MASK
argument_list|,
name|AL_ETH_KR_PMD_LD_STATUS_REPORT_MINUS_SHIFT
argument_list|,
name|status
operator|->
name|c_minus
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_PMD_LD_STATUS_REPORT_ZERO_MASK
argument_list|,
name|AL_ETH_KR_PMD_LD_STATUS_REPORT_ZERO_SHIFT
argument_list|,
name|status
operator|->
name|c_zero
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_PMD_LD_STATUS_REPORT_PLUS_MASK
argument_list|,
name|AL_ETH_KR_PMD_LD_STATUS_REPORT_PLUS_SHIFT
argument_list|,
name|status
operator|->
name|c_plus
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|->
name|receiver_ready
condition|)
name|AL_REG_BIT_SET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_PMD_LD_STATUS_REPORT_RECEIVER_READY_SHIFT
argument_list|)
expr_stmt|;
name|al_eth_an_lt_reg_write
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_PMD_LD_STATUS_REPORT
argument_list|,
name|AL_ETH_LT_REGS
argument_list|,
name|lane
argument_list|,
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|al_bool
name|al_eth_kr_receiver_frame_lock_get
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|enum
name|al_eth_an_lt_lane
name|lane
parameter_list|)
block|{
name|uint16_t
name|reg
decl_stmt|;
name|reg
operator|=
name|al_eth_an_lt_reg_read
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_PMD_STATUS
argument_list|,
name|AL_ETH_LT_REGS
argument_list|,
name|lane
argument_list|)
expr_stmt|;
return|return
operator|(
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_PMD_STATUS_RECEIVER_FRAME_LOCK_SHIFT
argument_list|)
operator|!=
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|al_bool
name|al_eth_kr_startup_proto_prog_get
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|enum
name|al_eth_an_lt_lane
name|lane
parameter_list|)
block|{
name|uint16_t
name|reg
decl_stmt|;
name|reg
operator|=
name|al_eth_an_lt_reg_read
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_PMD_STATUS
argument_list|,
name|AL_ETH_LT_REGS
argument_list|,
name|lane
argument_list|)
expr_stmt|;
return|return
operator|(
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_PMD_STATUS_RECEIVER_START_UP_PROTO_PROG_SHIFT
argument_list|)
operator|!=
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|al_bool
name|al_eth_kr_training_status_fail_get
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|enum
name|al_eth_an_lt_lane
name|lane
parameter_list|)
block|{
name|uint16_t
name|reg
decl_stmt|;
name|reg
operator|=
name|al_eth_an_lt_reg_read
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_PMD_STATUS
argument_list|,
name|AL_ETH_LT_REGS
argument_list|,
name|lane
argument_list|)
expr_stmt|;
return|return
operator|(
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_PMD_STATUS_FAILURE_SHIFT
argument_list|)
operator|!=
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|al_eth_receiver_ready_set
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|enum
name|al_eth_an_lt_lane
name|lane
parameter_list|)
block|{
name|al_eth_an_lt_reg_write
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_PMD_STATUS
argument_list|,
name|AL_ETH_LT_REGS
argument_list|,
name|lane
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*************************** auto negotiation *********************************/
end_comment

begin_function
specifier|static
name|int
name|al_eth_kr_an_validate_adv
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|al_eth_an_adv
modifier|*
name|an_adv
parameter_list|)
block|{
name|al_assert
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
if|if
condition|(
name|an_adv
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|an_adv
operator|->
name|selector_field
operator|!=
literal|1
condition|)
block|{
name|al_err
argument_list|(
literal|"[%s]: %s failed on selector_field (%d)\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|__func__
argument_list|,
name|an_adv
operator|->
name|selector_field
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|an_adv
operator|->
name|capability
operator|&
name|AL_BIT
argument_list|(
literal|2
argument_list|)
condition|)
block|{
name|al_err
argument_list|(
literal|"[%s]: %s failed on capability bit 2 (%d)\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|__func__
argument_list|,
name|an_adv
operator|->
name|capability
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|an_adv
operator|->
name|remote_fault
condition|)
block|{
name|al_err
argument_list|(
literal|"[%s]: %s failed on remote_fault (%d)\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|__func__
argument_list|,
name|an_adv
operator|->
name|remote_fault
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
if|if
condition|(
name|an_adv
operator|->
name|acknowledge
condition|)
block|{
name|al_err
argument_list|(
literal|"[%s]: %s failed on acknowledge (%d)\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|__func__
argument_list|,
name|an_adv
operator|->
name|acknowledge
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|al_eth_kr_an_write_adv
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|al_eth_an_adv
modifier|*
name|an_adv
parameter_list|)
block|{
name|uint16_t
name|reg
decl_stmt|;
if|if
condition|(
name|an_adv
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|reg
operator|=
literal|0
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_ADV1_SEL_FIELD_MASK
argument_list|,
name|AL_ETH_KR_AN_ADV1_SEL_FIELD_SHIFT
argument_list|,
name|an_adv
operator|->
name|selector_field
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_ADV1_ECHOED_NONCE_MASK
argument_list|,
name|AL_ETH_KR_AN_ADV1_ECHOED_NONCE_SHIFT
argument_list|,
name|an_adv
operator|->
name|echoed_nonce
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_ADV1_CAPABILITY_MASK
argument_list|,
name|AL_ETH_KR_AN_ADV1_CAPABILITY_SHIFT
argument_list|,
name|an_adv
operator|->
name|capability
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_ADV1_REM_FAULT_SHIFT
argument_list|,
name|an_adv
operator|->
name|remote_fault
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_ADV1_ACK_SHIFT
argument_list|,
name|an_adv
operator|->
name|acknowledge
argument_list|)
expr_stmt|;
name|AL_REG_BIT_VAL_SET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_ADV1_NEXT_PAGE_SHIFT
argument_list|,
name|an_adv
operator|->
name|next_page
argument_list|)
expr_stmt|;
name|al_eth_an_lt_reg_write
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_AN_ADV0
argument_list|,
name|AL_ETH_AN_REGS
argument_list|,
name|AL_ETH_AN__LT_LANE_0
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
literal|0
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_ADV2_TX_NONCE_MASK
argument_list|,
name|AL_ETH_KR_AN_ADV2_TX_NONCE_SHIFT
argument_list|,
name|an_adv
operator|->
name|transmitted_nonce
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_ADV2_TECH_MASK
argument_list|,
name|AL_ETH_KR_AN_ADV2_TECH_SHIFT
argument_list|,
name|an_adv
operator|->
name|technology
argument_list|)
expr_stmt|;
name|al_eth_an_lt_reg_write
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_AN_ADV1
argument_list|,
name|AL_ETH_AN_REGS
argument_list|,
name|AL_ETH_AN__LT_LANE_0
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|reg
operator|=
literal|0
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_ADV3_TECH_MASK
argument_list|,
name|AL_ETH_KR_AN_ADV3_TECH_SHIFT
argument_list|,
name|an_adv
operator|->
name|technology
operator|>>
literal|11
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_ADV3_FEC_MASK
argument_list|,
name|AL_ETH_KR_AN_ADV3_FEC_SHIFT
argument_list|,
name|an_adv
operator|->
name|fec_capability
argument_list|)
expr_stmt|;
name|al_eth_an_lt_reg_write
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_AN_ADV2
argument_list|,
name|AL_ETH_AN_REGS
argument_list|,
name|AL_ETH_AN__LT_LANE_0
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|al_eth_kr_an_read_adv
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|al_eth_an_adv
modifier|*
name|an_adv
parameter_list|)
block|{
name|int16_t
name|reg
decl_stmt|;
name|al_assert
argument_list|(
name|an_adv
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_eth_an_lt_reg_read
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_AN_REM_ADV0
argument_list|,
name|AL_ETH_AN_REGS
argument_list|,
name|AL_ETH_AN__LT_LANE_0
argument_list|)
expr_stmt|;
name|an_adv
operator|->
name|selector_field
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_ADV1_SEL_FIELD_MASK
argument_list|,
name|AL_ETH_KR_AN_ADV1_SEL_FIELD_SHIFT
argument_list|)
expr_stmt|;
name|an_adv
operator|->
name|echoed_nonce
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_ADV1_ECHOED_NONCE_MASK
argument_list|,
name|AL_ETH_KR_AN_ADV1_ECHOED_NONCE_SHIFT
argument_list|)
expr_stmt|;
name|an_adv
operator|->
name|capability
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_ADV1_CAPABILITY_MASK
argument_list|,
name|AL_ETH_KR_AN_ADV1_CAPABILITY_SHIFT
argument_list|)
expr_stmt|;
name|an_adv
operator|->
name|remote_fault
operator|=
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_ADV1_REM_FAULT_SHIFT
argument_list|)
expr_stmt|;
name|an_adv
operator|->
name|acknowledge
operator|=
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_ADV1_ACK_SHIFT
argument_list|)
expr_stmt|;
name|an_adv
operator|->
name|next_page
operator|=
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_ADV1_NEXT_PAGE_SHIFT
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_eth_an_lt_reg_read
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_AN_REM_ADV1
argument_list|,
name|AL_ETH_AN_REGS
argument_list|,
name|AL_ETH_AN__LT_LANE_0
argument_list|)
expr_stmt|;
name|an_adv
operator|->
name|transmitted_nonce
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_ADV2_TX_NONCE_MASK
argument_list|,
name|AL_ETH_KR_AN_ADV2_TX_NONCE_SHIFT
argument_list|)
expr_stmt|;
name|an_adv
operator|->
name|technology
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_ADV2_TECH_MASK
argument_list|,
name|AL_ETH_KR_AN_ADV2_TECH_SHIFT
argument_list|)
expr_stmt|;
name|reg
operator|=
name|al_eth_an_lt_reg_read
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_AN_REM_ADV2
argument_list|,
name|AL_ETH_AN_REGS
argument_list|,
name|AL_ETH_AN__LT_LANE_0
argument_list|)
expr_stmt|;
name|an_adv
operator|->
name|technology
operator||=
operator|(
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_ADV3_TECH_MASK
argument_list|,
name|AL_ETH_KR_AN_ADV3_TECH_SHIFT
argument_list|)
operator|<<
literal|11
operator|)
expr_stmt|;
name|an_adv
operator|->
name|fec_capability
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_ADV3_FEC_MASK
argument_list|,
name|AL_ETH_KR_AN_ADV3_FEC_SHIFT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|al_eth_kr_next_page_read
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|al_eth_an_np
modifier|*
name|np
parameter_list|)
block|{
name|uint16_t
name|reg
decl_stmt|;
name|reg
operator|=
name|al_eth_an_lt_reg_read
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_AN_REM_XNP_ADV0
argument_list|,
name|AL_ETH_AN_REGS
argument_list|,
name|AL_ETH_AN__LT_LANE_0
argument_list|)
expr_stmt|;
name|np
operator|->
name|unformatted_code_field
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_NP_ADV1_DATA1_MASK
argument_list|,
name|AL_ETH_KR_AN_NP_ADV1_DATA1_SHIFT
argument_list|)
expr_stmt|;
name|np
operator|->
name|toggle
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_NP_ADV1_TOGGLE_MASK
argument_list|,
name|AL_ETH_KR_AN_NP_ADV1_TOGGLE_SHIFT
argument_list|)
expr_stmt|;
name|np
operator|->
name|ack2
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_NP_ADV1_ACK2_MASK
argument_list|,
name|AL_ETH_KR_AN_NP_ADV1_ACK2_SHIFT
argument_list|)
expr_stmt|;
name|np
operator|->
name|msg_page
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_NP_ADV1_MSG_PAGE_MASK
argument_list|,
name|AL_ETH_KR_AN_NP_ADV1_MSG_PAGE_SHIFT
argument_list|)
expr_stmt|;
name|np
operator|->
name|next_page
operator|=
name|AL_REG_FIELD_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_NP_ADV1_NP_MASK
argument_list|,
name|AL_ETH_KR_AN_NP_ADV1_NP_SHIFT
argument_list|)
expr_stmt|;
name|np
operator|->
name|unformatted_code_field1
operator|=
name|al_eth_an_lt_reg_read
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_AN_REM_XNP_ADV1
argument_list|,
name|AL_ETH_AN_REGS
argument_list|,
name|AL_ETH_AN__LT_LANE_0
argument_list|)
expr_stmt|;
name|np
operator|->
name|unformatted_code_field2
operator|=
name|al_eth_an_lt_reg_read
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_AN_REM_XNP_ADV2
argument_list|,
name|AL_ETH_AN_REGS
argument_list|,
name|AL_ETH_AN__LT_LANE_0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_kr_next_page_write
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|al_eth_an_np
modifier|*
name|np
parameter_list|)
block|{
name|uint16_t
name|reg
init|=
literal|0
decl_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_NP_ADV1_DATA1_MASK
argument_list|,
name|AL_ETH_KR_AN_NP_ADV1_DATA1_SHIFT
argument_list|,
name|np
operator|->
name|unformatted_code_field
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_NP_ADV1_TOGGLE_MASK
argument_list|,
name|AL_ETH_KR_AN_NP_ADV1_TOGGLE_SHIFT
argument_list|,
name|np
operator|->
name|toggle
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_NP_ADV1_ACK2_MASK
argument_list|,
name|AL_ETH_KR_AN_NP_ADV1_ACK2_SHIFT
argument_list|,
name|np
operator|->
name|ack2
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_NP_ADV1_MSG_PAGE_MASK
argument_list|,
name|AL_ETH_KR_AN_NP_ADV1_MSG_PAGE_SHIFT
argument_list|,
name|np
operator|->
name|msg_page
argument_list|)
expr_stmt|;
name|AL_REG_FIELD_SET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_AN_NP_ADV1_NP_MASK
argument_list|,
name|AL_ETH_KR_AN_NP_ADV1_NP_SHIFT
argument_list|,
name|np
operator|->
name|next_page
argument_list|)
expr_stmt|;
name|al_eth_an_lt_reg_write
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_AN_XNP_ADV0
argument_list|,
name|AL_ETH_AN_REGS
argument_list|,
name|AL_ETH_AN__LT_LANE_0
argument_list|,
name|reg
argument_list|)
expr_stmt|;
name|al_eth_an_lt_reg_write
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_AN_XNP_ADV1
argument_list|,
name|AL_ETH_AN_REGS
argument_list|,
name|AL_ETH_AN__LT_LANE_0
argument_list|,
name|np
operator|->
name|unformatted_code_field1
argument_list|)
expr_stmt|;
name|al_eth_an_lt_reg_write
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_AN_XNP_ADV2
argument_list|,
name|AL_ETH_AN_REGS
argument_list|,
name|AL_ETH_AN__LT_LANE_0
argument_list|,
name|np
operator|->
name|unformatted_code_field2
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_kr_an_init
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|struct
name|al_eth_an_adv
modifier|*
name|an_adv
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
if|if
condition|(
name|adapter
operator|->
name|rev_id
operator|>
name|AL_ETH_REV_ID_2
condition|)
name|al_eth_an_lt_unit_config
argument_list|(
name|adapter
argument_list|)
expr_stmt|;
name|rc
operator|=
name|al_eth_kr_an_validate_adv
argument_list|(
name|adapter
argument_list|,
name|an_adv
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return
name|rc
return|;
name|rc
operator|=
name|al_eth_kr_an_write_adv
argument_list|(
name|adapter
argument_list|,
name|an_adv
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
condition|)
return|return
name|rc
return|;
comment|/* clear status */
name|al_eth_an_lt_reg_read
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_AN_STATUS
argument_list|,
name|AL_ETH_AN_REGS
argument_list|,
name|AL_ETH_AN__LT_LANE_0
argument_list|)
expr_stmt|;
name|al_dbg
argument_list|(
literal|"[%s]: autonegotiation initialized successfully"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|al_eth_kr_an_start
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|enum
name|al_eth_an_lt_lane
name|lane
parameter_list|,
name|al_bool
name|next_page_enable
parameter_list|,
name|al_bool
name|lt_enable
parameter_list|)
block|{
name|uint16_t
name|control
init|=
name|AL_ETH_KR_AN_CONTROL_ENABLE
operator||
name|AL_ETH_KR_AN_CONTROL_RESTART
decl_stmt|;
name|al_dbg
argument_list|(
literal|"Eth [%s]: enable autonegotiation. lt_en %s"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
operator|(
name|lt_enable
operator|==
name|AL_TRUE
operator|)
condition|?
literal|"yes"
else|:
literal|"no"
argument_list|)
expr_stmt|;
name|al_eth_an_lt_reg_write
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_PMD_CONTROL
argument_list|,
name|AL_ETH_LT_REGS
argument_list|,
name|lane
argument_list|,
name|AL_BIT
argument_list|(
name|AL_ETH_KR_PMD_CONTROL_RESTART
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|next_page_enable
operator|==
name|AL_TRUE
condition|)
name|control
operator||=
name|AL_ETH_KR_AN_CONTROL_NP_ENABLE
expr_stmt|;
name|al_eth_an_lt_reg_write
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_AN_CONTROL
argument_list|,
name|AL_ETH_AN_REGS
argument_list|,
name|lane
argument_list|,
name|control
argument_list|)
expr_stmt|;
if|if
condition|(
name|lt_enable
operator|==
name|AL_TRUE
condition|)
block|{
name|al_eth_kr_lt_initialize
argument_list|(
name|adapter
argument_list|,
name|lane
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|al_eth_kr_an_stop
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|)
block|{
name|al_eth_an_lt_reg_write
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_AN_CONTROL
argument_list|,
name|AL_ETH_AN_REGS
argument_list|,
name|AL_ETH_AN__LT_LANE_0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|al_eth_kr_an_status_check
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|al_bool
modifier|*
name|page_received
parameter_list|,
name|al_bool
modifier|*
name|an_completed
parameter_list|,
name|al_bool
modifier|*
name|error
parameter_list|)
block|{
name|uint16_t
name|reg
decl_stmt|;
name|reg
operator|=
name|al_eth_an_lt_reg_read
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_AN_STATUS
argument_list|,
name|AL_ETH_AN_REGS
argument_list|,
name|AL_ETH_AN__LT_LANE_0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|reg
operator|&
name|AL_ETH_KR_AN_STATUS_CHECK_MASK
operator|)
operator|!=
name|AL_ETH_KR_AN_STATUS_CHECK_NO_ERROR
condition|)
block|{
name|al_err
argument_list|(
literal|"[%s]: %s AN_STATUS (0x%x) indicated error\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|__func__
argument_list|,
name|reg
argument_list|)
expr_stmt|;
operator|*
name|error
operator|=
name|AL_TRUE
expr_stmt|;
block|}
if|if
condition|(
name|reg
operator|&
name|AL_ETH_KR_AN_STATUS_BASE_PAGE_RECEIVED
condition|)
operator|*
name|page_received
operator|=
name|AL_TRUE
expr_stmt|;
else|else
operator|*
name|page_received
operator|=
name|AL_FALSE
expr_stmt|;
if|if
condition|(
name|reg
operator|&
name|AL_ETH_KR_AN_STATUS_COMPLETED
condition|)
operator|*
name|an_completed
operator|=
name|AL_TRUE
expr_stmt|;
else|else
operator|*
name|an_completed
operator|=
name|AL_FALSE
expr_stmt|;
block|}
end_function

begin_comment
comment|/****************************** KR Link Training *****************************/
end_comment

begin_function
name|void
name|al_eth_kr_lt_restart
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|enum
name|al_eth_an_lt_lane
name|lane
parameter_list|)
block|{
name|al_dbg
argument_list|(
literal|"[%s]: KR LT Restart Link Training.\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
name|al_eth_an_lt_reg_write
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_PMD_CONTROL
argument_list|,
name|AL_ETH_LT_REGS
argument_list|,
name|lane
argument_list|,
operator|(
name|AL_BIT
argument_list|(
name|AL_ETH_KR_PMD_CONTROL_ENABLE
argument_list|)
operator||
name|AL_BIT
argument_list|(
name|AL_ETH_KR_PMD_CONTROL_RESTART
argument_list|)
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|al_eth_kr_lt_stop
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|enum
name|al_eth_an_lt_lane
name|lane
parameter_list|)
block|{
name|al_dbg
argument_list|(
literal|"[%s]: KR LT Stop Link Training.\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
name|al_eth_an_lt_reg_write
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_PMD_CONTROL
argument_list|,
name|AL_ETH_LT_REGS
argument_list|,
name|lane
argument_list|,
name|AL_BIT
argument_list|(
name|AL_ETH_KR_PMD_CONTROL_RESTART
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|al_eth_kr_lt_initialize
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|enum
name|al_eth_an_lt_lane
name|lane
parameter_list|)
block|{
name|al_dbg
argument_list|(
literal|"[%s]: KR LT Initialize.\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|)
expr_stmt|;
comment|/* Reset LT state machine */
name|al_eth_kr_lt_stop
argument_list|(
name|adapter
argument_list|,
name|lane
argument_list|)
expr_stmt|;
comment|/* clear receiver status */
name|al_eth_an_lt_reg_write
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_PMD_STATUS
argument_list|,
name|AL_ETH_LT_REGS
argument_list|,
name|lane
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Coefficient Update to all zero (no command, hold) */
name|al_eth_an_lt_reg_write
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_PMD_LD_COEF_UP
argument_list|,
name|AL_ETH_LT_REGS
argument_list|,
name|lane
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Coefficient Status to all zero (not_updated) */
name|al_eth_an_lt_reg_write
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_PMD_LD_STATUS_REPORT
argument_list|,
name|AL_ETH_LT_REGS
argument_list|,
name|lane
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* start */
name|al_eth_kr_lt_restart
argument_list|(
name|adapter
argument_list|,
name|lane
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|al_bool
name|al_eth_kr_lt_frame_lock_wait
parameter_list|(
name|struct
name|al_hal_eth_adapter
modifier|*
name|adapter
parameter_list|,
name|enum
name|al_eth_an_lt_lane
name|lane
parameter_list|,
name|uint32_t
name|timeout
parameter_list|)
block|{
name|uint32_t
name|loop
decl_stmt|;
name|uint16_t
name|reg
init|=
literal|0
decl_stmt|;
for|for
control|(
name|loop
operator|=
literal|0
init|;
name|loop
operator|<
name|timeout
condition|;
name|loop
operator|++
control|)
block|{
name|reg
operator|=
name|al_eth_an_lt_reg_read
argument_list|(
name|adapter
argument_list|,
name|AL_ETH_KR_PMD_STATUS
argument_list|,
name|AL_ETH_LT_REGS
argument_list|,
name|lane
argument_list|)
expr_stmt|;
if|if
condition|(
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_PMD_STATUS_FAILURE_SHIFT
argument_list|)
condition|)
block|{
name|al_info
argument_list|(
literal|"[%s]: Failed on Training Failure."
literal|" loops %d PMD STATUS 0x%04x\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|loop
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
name|AL_FALSE
return|;
block|}
if|if
condition|(
name|AL_REG_BIT_GET
argument_list|(
name|reg
argument_list|,
name|AL_ETH_KR_PMD_STATUS_RECEIVER_FRAME_LOCK_SHIFT
argument_list|)
condition|)
block|{
name|al_dbg
argument_list|(
literal|"[%s]: Frame lock received."
literal|" loops %d PMD STATUS 0x%04x\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|loop
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
name|AL_TRUE
return|;
block|}
name|al_udelay
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|al_info
argument_list|(
literal|"[%s]: Failed on timeout. PMD STATUS 0x%04x\n"
argument_list|,
name|adapter
operator|->
name|name
argument_list|,
name|reg
argument_list|)
expr_stmt|;
return|return
name|AL_FALSE
return|;
block|}
end_function

end_unit


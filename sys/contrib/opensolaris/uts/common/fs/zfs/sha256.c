begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * The contents of this file are subject to the terms of the  * Common Development and Distribution License, Version 1.0 only  * (the "License").  You may not use this file except in compliance  * with the License.  *  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE  * or http://www.opensolaris.org/os/licensing.  * See the License for the specific language governing permissions  * and limitations under the License.  *  * When distributing Covered Code, include this CDDL HEADER in each  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.  * If applicable, add the following below this CDDL HEADER, with the  * fields enclosed by brackets "[]" replaced with your own identifying  * information: Portions Copyright [yyyy] [name of copyright owner]  *  * CDDL HEADER END  */
end_comment

begin_comment
comment|/*  * Copyright 2005 Sun Microsystems, Inc.  All rights reserved.  * Use is subject to license terms.  */
end_comment

begin_pragma
pragma|#
directive|pragma
name|ident
literal|"%Z%%M%	%I%	%E% SMI"
end_pragma

begin_include
include|#
directive|include
file|<sys/zfs_context.h>
end_include

begin_include
include|#
directive|include
file|<sys/zio.h>
end_include

begin_include
include|#
directive|include
file|<sys/zio_checksum.h>
end_include

begin_comment
comment|/*  * SHA-256 checksum, as specified in FIPS 180-2, available at:  * http://csrc.nist.gov/cryptval  *  * This is a very compact implementation of SHA-256.  * It is designed to be simple and portable, not to be fast.  */
end_comment

begin_comment
comment|/*  * The literal definitions according to FIPS180-2 would be:  *  * 	Ch(x, y, z)     (((x)& (y)) ^ ((~(x))& (z)))  * 	Maj(x, y, z)    (((x)& (y)) | ((x)& (z)) | ((y)& (z)))  *  * We use logical equivalents which require one less op.  */
end_comment

begin_define
define|#
directive|define
name|Ch
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|,
name|z
parameter_list|)
value|((z) ^ ((x)& ((y) ^ (z))))
end_define

begin_define
define|#
directive|define
name|Maj
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|,
name|z
parameter_list|)
value|(((x)& (y)) ^ ((z)& ((x) ^ (y))))
end_define

begin_define
define|#
directive|define
name|Rot32
parameter_list|(
name|x
parameter_list|,
name|s
parameter_list|)
value|(((x)>> s) | ((x)<< (32 - s)))
end_define

begin_define
define|#
directive|define
name|SIGMA0
parameter_list|(
name|x
parameter_list|)
value|(Rot32(x, 2) ^ Rot32(x, 13) ^ Rot32(x, 22))
end_define

begin_define
define|#
directive|define
name|SIGMA1
parameter_list|(
name|x
parameter_list|)
value|(Rot32(x, 6) ^ Rot32(x, 11) ^ Rot32(x, 25))
end_define

begin_define
define|#
directive|define
name|sigma0
parameter_list|(
name|x
parameter_list|)
value|(Rot32(x, 7) ^ Rot32(x, 18) ^ ((x)>> 3))
end_define

begin_define
define|#
directive|define
name|sigma1
parameter_list|(
name|x
parameter_list|)
value|(Rot32(x, 17) ^ Rot32(x, 19) ^ ((x)>> 10))
end_define

begin_decl_stmt
specifier|static
specifier|const
name|uint32_t
name|SHA256_K
index|[
literal|64
index|]
init|=
block|{
literal|0x428a2f98
block|,
literal|0x71374491
block|,
literal|0xb5c0fbcf
block|,
literal|0xe9b5dba5
block|,
literal|0x3956c25b
block|,
literal|0x59f111f1
block|,
literal|0x923f82a4
block|,
literal|0xab1c5ed5
block|,
literal|0xd807aa98
block|,
literal|0x12835b01
block|,
literal|0x243185be
block|,
literal|0x550c7dc3
block|,
literal|0x72be5d74
block|,
literal|0x80deb1fe
block|,
literal|0x9bdc06a7
block|,
literal|0xc19bf174
block|,
literal|0xe49b69c1
block|,
literal|0xefbe4786
block|,
literal|0x0fc19dc6
block|,
literal|0x240ca1cc
block|,
literal|0x2de92c6f
block|,
literal|0x4a7484aa
block|,
literal|0x5cb0a9dc
block|,
literal|0x76f988da
block|,
literal|0x983e5152
block|,
literal|0xa831c66d
block|,
literal|0xb00327c8
block|,
literal|0xbf597fc7
block|,
literal|0xc6e00bf3
block|,
literal|0xd5a79147
block|,
literal|0x06ca6351
block|,
literal|0x14292967
block|,
literal|0x27b70a85
block|,
literal|0x2e1b2138
block|,
literal|0x4d2c6dfc
block|,
literal|0x53380d13
block|,
literal|0x650a7354
block|,
literal|0x766a0abb
block|,
literal|0x81c2c92e
block|,
literal|0x92722c85
block|,
literal|0xa2bfe8a1
block|,
literal|0xa81a664b
block|,
literal|0xc24b8b70
block|,
literal|0xc76c51a3
block|,
literal|0xd192e819
block|,
literal|0xd6990624
block|,
literal|0xf40e3585
block|,
literal|0x106aa070
block|,
literal|0x19a4c116
block|,
literal|0x1e376c08
block|,
literal|0x2748774c
block|,
literal|0x34b0bcb5
block|,
literal|0x391c0cb3
block|,
literal|0x4ed8aa4a
block|,
literal|0x5b9cca4f
block|,
literal|0x682e6ff3
block|,
literal|0x748f82ee
block|,
literal|0x78a5636f
block|,
literal|0x84c87814
block|,
literal|0x8cc70208
block|,
literal|0x90befffa
block|,
literal|0xa4506ceb
block|,
literal|0xbef9a3f7
block|,
literal|0xc67178f2
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|SHA256Transform
parameter_list|(
name|uint32_t
modifier|*
name|H
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|cp
parameter_list|)
block|{
name|uint32_t
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|,
name|d
decl_stmt|,
name|e
decl_stmt|,
name|f
decl_stmt|,
name|g
decl_stmt|,
name|h
decl_stmt|,
name|t
decl_stmt|,
name|T1
decl_stmt|,
name|T2
decl_stmt|,
name|W
index|[
literal|64
index|]
decl_stmt|;
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
literal|16
condition|;
name|t
operator|++
operator|,
name|cp
operator|+=
literal|4
control|)
name|W
index|[
name|t
index|]
operator|=
operator|(
name|cp
index|[
literal|0
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|cp
index|[
literal|1
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|cp
index|[
literal|2
index|]
operator|<<
literal|8
operator|)
operator||
name|cp
index|[
literal|3
index|]
expr_stmt|;
for|for
control|(
name|t
operator|=
literal|16
init|;
name|t
operator|<
literal|64
condition|;
name|t
operator|++
control|)
name|W
index|[
name|t
index|]
operator|=
name|sigma1
argument_list|(
name|W
index|[
name|t
operator|-
literal|2
index|]
argument_list|)
operator|+
name|W
index|[
name|t
operator|-
literal|7
index|]
operator|+
name|sigma0
argument_list|(
name|W
index|[
name|t
operator|-
literal|15
index|]
argument_list|)
operator|+
name|W
index|[
name|t
operator|-
literal|16
index|]
expr_stmt|;
name|a
operator|=
name|H
index|[
literal|0
index|]
expr_stmt|;
name|b
operator|=
name|H
index|[
literal|1
index|]
expr_stmt|;
name|c
operator|=
name|H
index|[
literal|2
index|]
expr_stmt|;
name|d
operator|=
name|H
index|[
literal|3
index|]
expr_stmt|;
name|e
operator|=
name|H
index|[
literal|4
index|]
expr_stmt|;
name|f
operator|=
name|H
index|[
literal|5
index|]
expr_stmt|;
name|g
operator|=
name|H
index|[
literal|6
index|]
expr_stmt|;
name|h
operator|=
name|H
index|[
literal|7
index|]
expr_stmt|;
for|for
control|(
name|t
operator|=
literal|0
init|;
name|t
operator|<
literal|64
condition|;
name|t
operator|++
control|)
block|{
name|T1
operator|=
name|h
operator|+
name|SIGMA1
argument_list|(
name|e
argument_list|)
operator|+
name|Ch
argument_list|(
name|e
argument_list|,
name|f
argument_list|,
name|g
argument_list|)
operator|+
name|SHA256_K
index|[
name|t
index|]
operator|+
name|W
index|[
name|t
index|]
expr_stmt|;
name|T2
operator|=
name|SIGMA0
argument_list|(
name|a
argument_list|)
operator|+
name|Maj
argument_list|(
name|a
argument_list|,
name|b
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|h
operator|=
name|g
expr_stmt|;
name|g
operator|=
name|f
expr_stmt|;
name|f
operator|=
name|e
expr_stmt|;
name|e
operator|=
name|d
operator|+
name|T1
expr_stmt|;
name|d
operator|=
name|c
expr_stmt|;
name|c
operator|=
name|b
expr_stmt|;
name|b
operator|=
name|a
expr_stmt|;
name|a
operator|=
name|T1
operator|+
name|T2
expr_stmt|;
block|}
name|H
index|[
literal|0
index|]
operator|+=
name|a
expr_stmt|;
name|H
index|[
literal|1
index|]
operator|+=
name|b
expr_stmt|;
name|H
index|[
literal|2
index|]
operator|+=
name|c
expr_stmt|;
name|H
index|[
literal|3
index|]
operator|+=
name|d
expr_stmt|;
name|H
index|[
literal|4
index|]
operator|+=
name|e
expr_stmt|;
name|H
index|[
literal|5
index|]
operator|+=
name|f
expr_stmt|;
name|H
index|[
literal|6
index|]
operator|+=
name|g
expr_stmt|;
name|H
index|[
literal|7
index|]
operator|+=
name|h
expr_stmt|;
block|}
end_function

begin_function
name|void
name|zio_checksum_SHA256
parameter_list|(
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|uint64_t
name|size
parameter_list|,
name|zio_cksum_t
modifier|*
name|zcp
parameter_list|)
block|{
name|uint32_t
name|H
index|[
literal|8
index|]
init|=
block|{
literal|0x6a09e667
block|,
literal|0xbb67ae85
block|,
literal|0x3c6ef372
block|,
literal|0xa54ff53a
block|,
literal|0x510e527f
block|,
literal|0x9b05688c
block|,
literal|0x1f83d9ab
block|,
literal|0x5be0cd19
block|}
decl_stmt|;
name|uint8_t
name|pad
index|[
literal|128
index|]
decl_stmt|;
name|int
name|padsize
init|=
name|size
operator|&
literal|63
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
operator|-
name|padsize
condition|;
name|i
operator|+=
literal|64
control|)
name|SHA256Transform
argument_list|(
name|H
argument_list|,
operator|(
name|uint8_t
operator|*
operator|)
name|buf
operator|+
name|i
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|padsize
condition|;
name|i
operator|++
control|)
name|pad
index|[
name|i
index|]
operator|=
operator|(
operator|(
name|uint8_t
operator|*
operator|)
name|buf
operator|)
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|pad
index|[
name|padsize
operator|++
index|]
operator|=
literal|0x80
init|;
operator|(
name|padsize
operator|&
literal|63
operator|)
operator|!=
literal|56
condition|;
name|padsize
operator|++
control|)
name|pad
index|[
name|padsize
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|8
condition|;
name|i
operator|++
control|)
name|pad
index|[
name|padsize
operator|++
index|]
operator|=
operator|(
name|size
operator|<<
literal|3
operator|)
operator|>>
operator|(
literal|56
operator|-
literal|8
operator|*
name|i
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|padsize
condition|;
name|i
operator|+=
literal|64
control|)
name|SHA256Transform
argument_list|(
name|H
argument_list|,
name|pad
operator|+
name|i
argument_list|)
expr_stmt|;
name|ZIO_SET_CHECKSUM
argument_list|(
name|zcp
argument_list|,
operator|(
name|uint64_t
operator|)
name|H
index|[
literal|0
index|]
operator|<<
literal|32
operator||
name|H
index|[
literal|1
index|]
argument_list|,
operator|(
name|uint64_t
operator|)
name|H
index|[
literal|2
index|]
operator|<<
literal|32
operator||
name|H
index|[
literal|3
index|]
argument_list|,
operator|(
name|uint64_t
operator|)
name|H
index|[
literal|4
index|]
operator|<<
literal|32
operator||
name|H
index|[
literal|5
index|]
argument_list|,
operator|(
name|uint64_t
operator|)
name|H
index|[
literal|6
index|]
operator|<<
literal|32
operator||
name|H
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


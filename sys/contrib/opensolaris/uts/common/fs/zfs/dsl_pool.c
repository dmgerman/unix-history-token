begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * The contents of this file are subject to the terms of the  * Common Development and Distribution License (the "License").  * You may not use this file except in compliance with the License.  *  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE  * or http://www.opensolaris.org/os/licensing.  * See the License for the specific language governing permissions  * and limitations under the License.  *  * When distributing Covered Code, include this CDDL HEADER in each  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.  * If applicable, add the following below this CDDL HEADER, with the  * fields enclosed by brackets "[]" replaced with your own identifying  * information: Portions Copyright [yyyy] [name of copyright owner]  *  * CDDL HEADER END  */
end_comment

begin_comment
comment|/*  * Copyright 2007 Sun Microsystems, Inc.  All rights reserved.  * Use is subject to license terms.  */
end_comment

begin_pragma
pragma|#
directive|pragma
name|ident
literal|"%Z%%M%	%I%	%E% SMI"
end_pragma

begin_include
include|#
directive|include
file|<sys/dsl_pool.h>
end_include

begin_include
include|#
directive|include
file|<sys/dsl_dataset.h>
end_include

begin_include
include|#
directive|include
file|<sys/dsl_dir.h>
end_include

begin_include
include|#
directive|include
file|<sys/dsl_synctask.h>
end_include

begin_include
include|#
directive|include
file|<sys/dmu_tx.h>
end_include

begin_include
include|#
directive|include
file|<sys/dmu_objset.h>
end_include

begin_include
include|#
directive|include
file|<sys/arc.h>
end_include

begin_include
include|#
directive|include
file|<sys/zap.h>
end_include

begin_include
include|#
directive|include
file|<sys/zio.h>
end_include

begin_include
include|#
directive|include
file|<sys/zfs_context.h>
end_include

begin_include
include|#
directive|include
file|<sys/fs/zfs.h>
end_include

begin_function
specifier|static
name|int
name|dsl_pool_open_mos_dir
parameter_list|(
name|dsl_pool_t
modifier|*
name|dp
parameter_list|,
name|dsl_dir_t
modifier|*
modifier|*
name|ddp
parameter_list|)
block|{
name|uint64_t
name|obj
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|zap_lookup
argument_list|(
name|dp
operator|->
name|dp_meta_objset
argument_list|,
name|dp
operator|->
name|dp_root_dir
operator|->
name|dd_phys
operator|->
name|dd_child_dir_zapobj
argument_list|,
name|MOS_DIR_NAME
argument_list|,
sizeof|sizeof
argument_list|(
name|obj
argument_list|)
argument_list|,
literal|1
argument_list|,
operator|&
name|obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
operator|(
name|err
operator|)
return|;
return|return
operator|(
name|dsl_dir_open_obj
argument_list|(
name|dp
argument_list|,
name|obj
argument_list|,
name|MOS_DIR_NAME
argument_list|,
name|dp
argument_list|,
name|ddp
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|dsl_pool_t
modifier|*
name|dsl_pool_open_impl
parameter_list|(
name|spa_t
modifier|*
name|spa
parameter_list|,
name|uint64_t
name|txg
parameter_list|)
block|{
name|dsl_pool_t
modifier|*
name|dp
decl_stmt|;
name|blkptr_t
modifier|*
name|bp
init|=
name|spa_get_rootblkptr
argument_list|(
name|spa
argument_list|)
decl_stmt|;
name|dp
operator|=
name|kmem_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|dsl_pool_t
argument_list|)
argument_list|,
name|KM_SLEEP
argument_list|)
expr_stmt|;
name|dp
operator|->
name|dp_spa
operator|=
name|spa
expr_stmt|;
name|dp
operator|->
name|dp_meta_rootbp
operator|=
operator|*
name|bp
expr_stmt|;
name|rw_init
argument_list|(
operator|&
name|dp
operator|->
name|dp_config_rwlock
argument_list|,
name|NULL
argument_list|,
name|RW_DEFAULT
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|txg_init
argument_list|(
name|dp
argument_list|,
name|txg
argument_list|)
expr_stmt|;
name|txg_list_create
argument_list|(
operator|&
name|dp
operator|->
name|dp_dirty_datasets
argument_list|,
name|offsetof
argument_list|(
name|dsl_dataset_t
argument_list|,
name|ds_dirty_link
argument_list|)
argument_list|)
expr_stmt|;
name|txg_list_create
argument_list|(
operator|&
name|dp
operator|->
name|dp_dirty_dirs
argument_list|,
name|offsetof
argument_list|(
name|dsl_dir_t
argument_list|,
name|dd_dirty_link
argument_list|)
argument_list|)
expr_stmt|;
name|txg_list_create
argument_list|(
operator|&
name|dp
operator|->
name|dp_sync_tasks
argument_list|,
name|offsetof
argument_list|(
name|dsl_sync_task_group_t
argument_list|,
name|dstg_node
argument_list|)
argument_list|)
expr_stmt|;
name|list_create
argument_list|(
operator|&
name|dp
operator|->
name|dp_synced_objsets
argument_list|,
sizeof|sizeof
argument_list|(
name|dsl_dataset_t
argument_list|)
argument_list|,
name|offsetof
argument_list|(
name|dsl_dataset_t
argument_list|,
name|ds_synced_link
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|dp
operator|)
return|;
block|}
end_function

begin_function
name|int
name|dsl_pool_open
parameter_list|(
name|spa_t
modifier|*
name|spa
parameter_list|,
name|uint64_t
name|txg
parameter_list|,
name|dsl_pool_t
modifier|*
modifier|*
name|dpp
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|dsl_pool_t
modifier|*
name|dp
init|=
name|dsl_pool_open_impl
argument_list|(
name|spa
argument_list|,
name|txg
argument_list|)
decl_stmt|;
name|objset_impl_t
modifier|*
name|osi
decl_stmt|;
name|rw_enter
argument_list|(
operator|&
name|dp
operator|->
name|dp_config_rwlock
argument_list|,
name|RW_READER
argument_list|)
expr_stmt|;
name|err
operator|=
name|dmu_objset_open_impl
argument_list|(
name|spa
argument_list|,
name|NULL
argument_list|,
operator|&
name|dp
operator|->
name|dp_meta_rootbp
argument_list|,
operator|&
name|osi
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
name|dp
operator|->
name|dp_meta_objset
operator|=
operator|&
name|osi
operator|->
name|os
expr_stmt|;
name|err
operator|=
name|zap_lookup
argument_list|(
name|dp
operator|->
name|dp_meta_objset
argument_list|,
name|DMU_POOL_DIRECTORY_OBJECT
argument_list|,
name|DMU_POOL_ROOT_DATASET
argument_list|,
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
argument_list|,
literal|1
argument_list|,
operator|&
name|dp
operator|->
name|dp_root_dir_obj
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
name|err
operator|=
name|dsl_dir_open_obj
argument_list|(
name|dp
argument_list|,
name|dp
operator|->
name|dp_root_dir_obj
argument_list|,
name|NULL
argument_list|,
name|dp
argument_list|,
operator|&
name|dp
operator|->
name|dp_root_dir
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
name|err
operator|=
name|dsl_pool_open_mos_dir
argument_list|(
name|dp
argument_list|,
operator|&
name|dp
operator|->
name|dp_mos_dir
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
goto|goto
name|out
goto|;
name|out
label|:
name|rw_exit
argument_list|(
operator|&
name|dp
operator|->
name|dp_config_rwlock
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|dsl_pool_close
argument_list|(
name|dp
argument_list|)
expr_stmt|;
else|else
operator|*
name|dpp
operator|=
name|dp
expr_stmt|;
return|return
operator|(
name|err
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dsl_pool_close
parameter_list|(
name|dsl_pool_t
modifier|*
name|dp
parameter_list|)
block|{
comment|/* drop our reference from dsl_pool_open() */
if|if
condition|(
name|dp
operator|->
name|dp_mos_dir
condition|)
name|dsl_dir_close
argument_list|(
name|dp
operator|->
name|dp_mos_dir
argument_list|,
name|dp
argument_list|)
expr_stmt|;
if|if
condition|(
name|dp
operator|->
name|dp_root_dir
condition|)
name|dsl_dir_close
argument_list|(
name|dp
operator|->
name|dp_root_dir
argument_list|,
name|dp
argument_list|)
expr_stmt|;
comment|/* undo the dmu_objset_open_impl(mos) from dsl_pool_open() */
if|if
condition|(
name|dp
operator|->
name|dp_meta_objset
condition|)
name|dmu_objset_evict
argument_list|(
name|NULL
argument_list|,
name|dp
operator|->
name|dp_meta_objset
operator|->
name|os
argument_list|)
expr_stmt|;
name|txg_list_destroy
argument_list|(
operator|&
name|dp
operator|->
name|dp_dirty_datasets
argument_list|)
expr_stmt|;
name|txg_list_destroy
argument_list|(
operator|&
name|dp
operator|->
name|dp_dirty_dirs
argument_list|)
expr_stmt|;
name|list_destroy
argument_list|(
operator|&
name|dp
operator|->
name|dp_synced_objsets
argument_list|)
expr_stmt|;
name|arc_flush
argument_list|()
expr_stmt|;
name|txg_fini
argument_list|(
name|dp
argument_list|)
expr_stmt|;
name|rw_destroy
argument_list|(
operator|&
name|dp
operator|->
name|dp_config_rwlock
argument_list|)
expr_stmt|;
name|kmem_free
argument_list|(
name|dp
argument_list|,
sizeof|sizeof
argument_list|(
name|dsl_pool_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|dsl_pool_t
modifier|*
name|dsl_pool_create
parameter_list|(
name|spa_t
modifier|*
name|spa
parameter_list|,
name|uint64_t
name|txg
parameter_list|)
block|{
name|int
name|err
decl_stmt|;
name|dsl_pool_t
modifier|*
name|dp
init|=
name|dsl_pool_open_impl
argument_list|(
name|spa
argument_list|,
name|txg
argument_list|)
decl_stmt|;
name|dmu_tx_t
modifier|*
name|tx
init|=
name|dmu_tx_create_assigned
argument_list|(
name|dp
argument_list|,
name|txg
argument_list|)
decl_stmt|;
name|dp
operator|->
name|dp_meta_objset
operator|=
operator|&
name|dmu_objset_create_impl
argument_list|(
name|spa
argument_list|,
name|NULL
argument_list|,
operator|&
name|dp
operator|->
name|dp_meta_rootbp
argument_list|,
name|DMU_OST_META
argument_list|,
name|tx
argument_list|)
operator|->
name|os
expr_stmt|;
comment|/* create the pool directory */
name|err
operator|=
name|zap_create_claim
argument_list|(
name|dp
operator|->
name|dp_meta_objset
argument_list|,
name|DMU_POOL_DIRECTORY_OBJECT
argument_list|,
name|DMU_OT_OBJECT_DIRECTORY
argument_list|,
name|DMU_OT_NONE
argument_list|,
literal|0
argument_list|,
name|tx
argument_list|)
expr_stmt|;
name|ASSERT3U
argument_list|(
name|err
argument_list|,
operator|==
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* create and open the root dir */
name|dsl_dataset_create_root
argument_list|(
name|dp
argument_list|,
operator|&
name|dp
operator|->
name|dp_root_dir_obj
argument_list|,
name|tx
argument_list|)
expr_stmt|;
name|VERIFY
argument_list|(
literal|0
operator|==
name|dsl_dir_open_obj
argument_list|(
name|dp
argument_list|,
name|dp
operator|->
name|dp_root_dir_obj
argument_list|,
name|NULL
argument_list|,
name|dp
argument_list|,
operator|&
name|dp
operator|->
name|dp_root_dir
argument_list|)
argument_list|)
expr_stmt|;
comment|/* create and open the meta-objset dir */
operator|(
name|void
operator|)
name|dsl_dir_create_sync
argument_list|(
name|dp
operator|->
name|dp_root_dir
argument_list|,
name|MOS_DIR_NAME
argument_list|,
name|tx
argument_list|)
expr_stmt|;
name|VERIFY
argument_list|(
literal|0
operator|==
name|dsl_pool_open_mos_dir
argument_list|(
name|dp
argument_list|,
operator|&
name|dp
operator|->
name|dp_mos_dir
argument_list|)
argument_list|)
expr_stmt|;
name|dmu_tx_commit
argument_list|(
name|tx
argument_list|)
expr_stmt|;
return|return
operator|(
name|dp
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dsl_pool_sync
parameter_list|(
name|dsl_pool_t
modifier|*
name|dp
parameter_list|,
name|uint64_t
name|txg
parameter_list|)
block|{
name|zio_t
modifier|*
name|zio
decl_stmt|;
name|dmu_tx_t
modifier|*
name|tx
decl_stmt|;
name|dsl_dir_t
modifier|*
name|dd
decl_stmt|;
name|dsl_dataset_t
modifier|*
name|ds
decl_stmt|;
name|dsl_sync_task_group_t
modifier|*
name|dstg
decl_stmt|;
name|objset_impl_t
modifier|*
name|mosi
init|=
name|dp
operator|->
name|dp_meta_objset
operator|->
name|os
decl_stmt|;
name|int
name|err
decl_stmt|;
name|tx
operator|=
name|dmu_tx_create_assigned
argument_list|(
name|dp
argument_list|,
name|txg
argument_list|)
expr_stmt|;
name|zio
operator|=
name|zio_root
argument_list|(
name|dp
operator|->
name|dp_spa
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|ZIO_FLAG_MUSTSUCCEED
argument_list|)
expr_stmt|;
while|while
condition|(
name|ds
operator|=
name|txg_list_remove
argument_list|(
operator|&
name|dp
operator|->
name|dp_dirty_datasets
argument_list|,
name|txg
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|list_link_active
argument_list|(
operator|&
name|ds
operator|->
name|ds_synced_link
argument_list|)
condition|)
name|list_insert_tail
argument_list|(
operator|&
name|dp
operator|->
name|dp_synced_objsets
argument_list|,
name|ds
argument_list|)
expr_stmt|;
else|else
name|dmu_buf_rele
argument_list|(
name|ds
operator|->
name|ds_dbuf
argument_list|,
name|ds
argument_list|)
expr_stmt|;
name|dsl_dataset_sync
argument_list|(
name|ds
argument_list|,
name|zio
argument_list|,
name|tx
argument_list|)
expr_stmt|;
block|}
name|err
operator|=
name|zio_wait
argument_list|(
name|zio
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|err
operator|==
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|dstg
operator|=
name|txg_list_remove
argument_list|(
operator|&
name|dp
operator|->
name|dp_sync_tasks
argument_list|,
name|txg
argument_list|)
condition|)
name|dsl_sync_task_group_sync
argument_list|(
name|dstg
argument_list|,
name|tx
argument_list|)
expr_stmt|;
while|while
condition|(
name|dd
operator|=
name|txg_list_remove
argument_list|(
operator|&
name|dp
operator|->
name|dp_dirty_dirs
argument_list|,
name|txg
argument_list|)
condition|)
name|dsl_dir_sync
argument_list|(
name|dd
argument_list|,
name|tx
argument_list|)
expr_stmt|;
if|if
condition|(
name|list_head
argument_list|(
operator|&
name|mosi
operator|->
name|os_dirty_dnodes
index|[
name|txg
operator|&
name|TXG_MASK
index|]
argument_list|)
operator|!=
name|NULL
operator|||
name|list_head
argument_list|(
operator|&
name|mosi
operator|->
name|os_free_dnodes
index|[
name|txg
operator|&
name|TXG_MASK
index|]
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|zio
operator|=
name|zio_root
argument_list|(
name|dp
operator|->
name|dp_spa
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|ZIO_FLAG_MUSTSUCCEED
argument_list|)
expr_stmt|;
name|dmu_objset_sync
argument_list|(
name|mosi
argument_list|,
name|zio
argument_list|,
name|tx
argument_list|)
expr_stmt|;
name|err
operator|=
name|zio_wait
argument_list|(
name|zio
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|err
operator|==
literal|0
argument_list|)
expr_stmt|;
name|dprintf_bp
argument_list|(
operator|&
name|dp
operator|->
name|dp_meta_rootbp
argument_list|,
literal|"meta objset rootbp is %s"
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|spa_set_rootblkptr
argument_list|(
name|dp
operator|->
name|dp_spa
argument_list|,
operator|&
name|dp
operator|->
name|dp_meta_rootbp
argument_list|)
expr_stmt|;
block|}
name|dmu_tx_commit
argument_list|(
name|tx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dsl_pool_zil_clean
parameter_list|(
name|dsl_pool_t
modifier|*
name|dp
parameter_list|)
block|{
name|dsl_dataset_t
modifier|*
name|ds
decl_stmt|;
while|while
condition|(
name|ds
operator|=
name|list_head
argument_list|(
operator|&
name|dp
operator|->
name|dp_synced_objsets
argument_list|)
condition|)
block|{
name|list_remove
argument_list|(
operator|&
name|dp
operator|->
name|dp_synced_objsets
argument_list|,
name|ds
argument_list|)
expr_stmt|;
name|ASSERT
argument_list|(
name|ds
operator|->
name|ds_user_ptr
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|zil_clean
argument_list|(
operator|(
operator|(
name|objset_impl_t
operator|*
operator|)
name|ds
operator|->
name|ds_user_ptr
operator|)
operator|->
name|os_zil
argument_list|)
expr_stmt|;
name|dmu_buf_rele
argument_list|(
name|ds
operator|->
name|ds_dbuf
argument_list|,
name|ds
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*  * TRUE if the current thread is the tx_sync_thread or if we  * are being called from SPA context during pool initialization.  */
end_comment

begin_function
name|int
name|dsl_pool_sync_context
parameter_list|(
name|dsl_pool_t
modifier|*
name|dp
parameter_list|)
block|{
return|return
operator|(
name|curthread
operator|==
name|dp
operator|->
name|dp_tx
operator|.
name|tx_sync_thread
operator|||
name|spa_get_dsl
argument_list|(
name|dp
operator|->
name|dp_spa
argument_list|)
operator|==
name|NULL
operator|)
return|;
block|}
end_function

begin_function
name|uint64_t
name|dsl_pool_adjustedsize
parameter_list|(
name|dsl_pool_t
modifier|*
name|dp
parameter_list|,
name|boolean_t
name|netfree
parameter_list|)
block|{
name|uint64_t
name|space
decl_stmt|,
name|resv
decl_stmt|;
comment|/* 	 * Reserve about 1.6% (1/64), or at least 32MB, for allocation 	 * efficiency. 	 * XXX The intent log is not accounted for, so it must fit 	 * within this slop. 	 * 	 * If we're trying to assess whether it's OK to do a free, 	 * cut the reservation in half to allow forward progress 	 * (e.g. make it possible to rm(1) files from a full pool). 	 */
name|space
operator|=
name|spa_get_dspace
argument_list|(
name|dp
operator|->
name|dp_spa
argument_list|)
expr_stmt|;
name|resv
operator|=
name|MAX
argument_list|(
name|space
operator|>>
literal|6
argument_list|,
name|SPA_MINDEVSIZE
operator|>>
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|netfree
condition|)
name|resv
operator|>>=
literal|1
expr_stmt|;
return|return
operator|(
name|space
operator|-
name|resv
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * CDDL HEADER START  *  * The contents of this file are subject to the terms of the  * Common Development and Distribution License (the "License").  * You may not use this file except in compliance with the License.  *  * You can obtain a copy of the license at usr/src/OPENSOLARIS.LICENSE  * or http://www.opensolaris.org/os/licensing.  * See the License for the specific language governing permissions  * and limitations under the License.  *  * When distributing Covered Code, include this CDDL HEADER in each  * file and include the License file at usr/src/OPENSOLARIS.LICENSE.  * If applicable, add the following below this CDDL HEADER, with the  * fields enclosed by brackets "[]" replaced with your own identifying  * information: Portions Copyright [yyyy] [name of copyright owner]  *  * CDDL HEADER END  */
end_comment

begin_comment
comment|/*  * Copyright 2007 Sun Microsystems, Inc.  All rights reserved.  * Use is subject to license terms.  */
end_comment

begin_pragma
pragma|#
directive|pragma
name|ident
literal|"%Z%%M%	%I%	%E% SMI"
end_pragma

begin_comment
comment|/*  * Master property table.  *  * This table keeps track of all the properties supported by ZFS, and their  * various attributes.  Not all of these are needed by the kernel, and several  * are only used by a single libzfs client.  But having them here centralizes  * all property information in one location.  *  * 	name		The human-readable string representing this property  * 	proptype	Basic type (string, boolean, number)  * 	default		Default value for the property.  Sadly, C only allows  * 			you to initialize the first member of a union, so we  * 			have two default members for each property.  * 	attr		Attributes (readonly, inheritable) for the property  * 	types		Valid dataset types to which this applies  * 	values		String describing acceptable values for the property  * 	colname		The column header for 'zfs list'  *	colfmt		The column formatting for 'zfs list'  *  * This table must match the order of property types in libzfs.h.  */
end_comment

begin_include
include|#
directive|include
file|<sys/zio.h>
end_include

begin_include
include|#
directive|include
file|<sys/spa.h>
end_include

begin_include
include|#
directive|include
file|<sys/zfs_acl.h>
end_include

begin_include
include|#
directive|include
file|<sys/zfs_ioctl.h>
end_include

begin_include
include|#
directive|include
file|"zfs_prop.h"
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|_KERNEL
argument_list|)
end_if

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_typedef
typedef|typedef
enum|enum
block|{
name|prop_default
block|,
name|prop_readonly
block|,
name|prop_inherit
block|}
name|prop_attr_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
specifier|const
name|char
modifier|*
name|pd_name
decl_stmt|;
name|zfs_proptype_t
name|pd_proptype
decl_stmt|;
name|uint64_t
name|pd_numdefault
decl_stmt|;
specifier|const
name|char
modifier|*
name|pd_strdefault
decl_stmt|;
name|prop_attr_t
name|pd_attr
decl_stmt|;
name|int
name|pd_types
decl_stmt|;
specifier|const
name|char
modifier|*
name|pd_values
decl_stmt|;
specifier|const
name|char
modifier|*
name|pd_colname
decl_stmt|;
name|boolean_t
name|pd_rightalign
decl_stmt|;
name|boolean_t
name|pd_visible
decl_stmt|;
block|}
name|prop_desc_t
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|prop_desc_t
name|zfs_prop_table
index|[]
init|=
block|{
block|{
literal|"type"
block|,
name|prop_type_string
block|,
literal|0
block|,
name|NULL
block|,
name|prop_readonly
block|,
name|ZFS_TYPE_ANY
block|,
literal|"filesystem | volume | snapshot"
block|,
literal|"TYPE"
block|,
name|B_TRUE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"creation"
block|,
name|prop_type_number
block|,
literal|0
block|,
name|NULL
block|,
name|prop_readonly
block|,
name|ZFS_TYPE_ANY
block|,
literal|"<date>"
block|,
literal|"CREATION"
block|,
name|B_FALSE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"used"
block|,
name|prop_type_number
block|,
literal|0
block|,
name|NULL
block|,
name|prop_readonly
block|,
name|ZFS_TYPE_ANY
block|,
literal|"<size>"
block|,
literal|"USED"
block|,
name|B_TRUE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"available"
block|,
name|prop_type_number
block|,
literal|0
block|,
name|NULL
block|,
name|prop_readonly
block|,
name|ZFS_TYPE_FILESYSTEM
operator||
name|ZFS_TYPE_VOLUME
block|,
literal|"<size>"
block|,
literal|"AVAIL"
block|,
name|B_TRUE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"referenced"
block|,
name|prop_type_number
block|,
literal|0
block|,
name|NULL
block|,
name|prop_readonly
block|,
name|ZFS_TYPE_ANY
block|,
literal|"<size>"
block|,
literal|"REFER"
block|,
name|B_TRUE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"compressratio"
block|,
name|prop_type_number
block|,
literal|0
block|,
name|NULL
block|,
name|prop_readonly
block|,
name|ZFS_TYPE_ANY
block|,
literal|"<1.00x or higher if compressed>"
block|,
literal|"RATIO"
block|,
name|B_TRUE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"mounted"
block|,
name|prop_type_boolean
block|,
literal|0
block|,
name|NULL
block|,
name|prop_readonly
block|,
name|ZFS_TYPE_FILESYSTEM
block|,
literal|"yes | no | -"
block|,
literal|"MOUNTED"
block|,
name|B_TRUE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"origin"
block|,
name|prop_type_string
block|,
literal|0
block|,
name|NULL
block|,
name|prop_readonly
block|,
name|ZFS_TYPE_FILESYSTEM
operator||
name|ZFS_TYPE_VOLUME
block|,
literal|"<snapshot>"
block|,
literal|"ORIGIN"
block|,
name|B_FALSE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"quota"
block|,
name|prop_type_number
block|,
literal|0
block|,
name|NULL
block|,
name|prop_default
block|,
name|ZFS_TYPE_FILESYSTEM
block|,
literal|"<size> | none"
block|,
literal|"QUOTA"
block|,
name|B_TRUE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"reservation"
block|,
name|prop_type_number
block|,
literal|0
block|,
name|NULL
block|,
name|prop_default
block|,
name|ZFS_TYPE_FILESYSTEM
operator||
name|ZFS_TYPE_VOLUME
block|,
literal|"<size> | none"
block|,
literal|"RESERV"
block|,
name|B_TRUE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"volsize"
block|,
name|prop_type_number
block|,
literal|0
block|,
name|NULL
block|,
name|prop_default
block|,
name|ZFS_TYPE_VOLUME
block|,
literal|"<size>"
block|,
literal|"VOLSIZE"
block|,
name|B_TRUE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"volblocksize"
block|,
name|prop_type_number
block|,
literal|8192
block|,
name|NULL
block|,
name|prop_readonly
block|,
name|ZFS_TYPE_VOLUME
block|,
literal|"512 to 128k, power of 2"
block|,
literal|"VOLBLOCK"
block|,
name|B_TRUE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"recordsize"
block|,
name|prop_type_number
block|,
name|SPA_MAXBLOCKSIZE
block|,
name|NULL
block|,
name|prop_inherit
block|,
name|ZFS_TYPE_FILESYSTEM
block|,
literal|"512 to 128k, power of 2"
block|,
literal|"RECSIZE"
block|,
name|B_TRUE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"mountpoint"
block|,
name|prop_type_string
block|,
literal|0
block|,
literal|"/"
block|,
name|prop_inherit
block|,
name|ZFS_TYPE_FILESYSTEM
block|,
literal|"<path> | legacy | none"
block|,
literal|"MOUNTPOINT"
block|,
name|B_FALSE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"sharenfs"
block|,
name|prop_type_string
block|,
literal|0
block|,
literal|"off"
block|,
name|prop_inherit
block|,
name|ZFS_TYPE_FILESYSTEM
block|,
literal|"on | off | exports(5) options"
block|,
literal|"SHARENFS"
block|,
name|B_FALSE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"checksum"
block|,
name|prop_type_index
block|,
name|ZIO_CHECKSUM_DEFAULT
block|,
literal|"on"
block|,
name|prop_inherit
block|,
name|ZFS_TYPE_FILESYSTEM
operator||
name|ZFS_TYPE_VOLUME
block|,
literal|"on | off | fletcher2 | fletcher4 | sha256"
block|,
literal|"CHECKSUM"
block|,
name|B_TRUE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"compression"
block|,
name|prop_type_index
block|,
name|ZIO_COMPRESS_DEFAULT
block|,
literal|"off"
block|,
name|prop_inherit
block|,
name|ZFS_TYPE_FILESYSTEM
operator||
name|ZFS_TYPE_VOLUME
block|,
literal|"on | off | lzjb | gzip | gzip-[1-9]"
block|,
literal|"COMPRESS"
block|,
name|B_TRUE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"atime"
block|,
name|prop_type_boolean
block|,
literal|1
block|,
name|NULL
block|,
name|prop_inherit
block|,
name|ZFS_TYPE_FILESYSTEM
block|,
literal|"on | off"
block|,
literal|"ATIME"
block|,
name|B_TRUE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"devices"
block|,
name|prop_type_boolean
block|,
literal|1
block|,
name|NULL
block|,
name|prop_inherit
block|,
name|ZFS_TYPE_FILESYSTEM
operator||
name|ZFS_TYPE_SNAPSHOT
block|,
literal|"on | off"
block|,
literal|"DEVICES"
block|,
name|B_TRUE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"exec"
block|,
name|prop_type_boolean
block|,
literal|1
block|,
name|NULL
block|,
name|prop_inherit
block|,
name|ZFS_TYPE_FILESYSTEM
operator||
name|ZFS_TYPE_SNAPSHOT
block|,
literal|"on | off"
block|,
literal|"EXEC"
block|,
name|B_TRUE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"setuid"
block|,
name|prop_type_boolean
block|,
literal|1
block|,
name|NULL
block|,
name|prop_inherit
block|,
name|ZFS_TYPE_FILESYSTEM
operator||
name|ZFS_TYPE_SNAPSHOT
block|,
literal|"on | off"
block|,
literal|"SETUID"
block|,
name|B_TRUE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"readonly"
block|,
name|prop_type_boolean
block|,
literal|0
block|,
name|NULL
block|,
name|prop_inherit
block|,
name|ZFS_TYPE_FILESYSTEM
operator||
name|ZFS_TYPE_VOLUME
block|,
literal|"on | off"
block|,
literal|"RDONLY"
block|,
name|B_TRUE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"jailed"
block|,
name|prop_type_boolean
block|,
literal|0
block|,
name|NULL
block|,
name|prop_inherit
block|,
name|ZFS_TYPE_FILESYSTEM
block|,
literal|"on | off"
block|,
literal|"JAILED"
block|,
name|B_TRUE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"snapdir"
block|,
name|prop_type_index
block|,
name|ZFS_SNAPDIR_HIDDEN
block|,
literal|"hidden"
block|,
name|prop_inherit
block|,
name|ZFS_TYPE_FILESYSTEM
block|,
literal|"hidden | visible"
block|,
literal|"SNAPDIR"
block|,
name|B_TRUE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"aclmode"
block|,
name|prop_type_index
block|,
name|ZFS_ACL_GROUPMASK
block|,
literal|"groupmask"
block|,
name|prop_inherit
block|,
name|ZFS_TYPE_FILESYSTEM
block|,
literal|"discard | groupmask | passthrough"
block|,
literal|"ACLMODE"
block|,
name|B_TRUE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"aclinherit"
block|,
name|prop_type_index
block|,
name|ZFS_ACL_SECURE
block|,
literal|"secure"
block|,
name|prop_inherit
block|,
name|ZFS_TYPE_FILESYSTEM
block|,
literal|"discard | noallow | secure | passthrough"
block|,
literal|"ACLINHERIT"
block|,
name|B_TRUE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"createtxg"
block|,
name|prop_type_number
block|,
literal|0
block|,
name|NULL
block|,
name|prop_readonly
block|,
name|ZFS_TYPE_ANY
block|,
name|NULL
block|,
name|NULL
block|,
name|B_FALSE
block|,
name|B_FALSE
block|}
block|,
block|{
literal|"name"
block|,
name|prop_type_string
block|,
literal|0
block|,
name|NULL
block|,
name|prop_readonly
block|,
name|ZFS_TYPE_ANY
block|,
name|NULL
block|,
literal|"NAME"
block|,
name|B_FALSE
block|,
name|B_FALSE
block|}
block|,
block|{
literal|"canmount"
block|,
name|prop_type_boolean
block|,
literal|1
block|,
name|NULL
block|,
name|prop_default
block|,
name|ZFS_TYPE_FILESYSTEM
block|,
literal|"on | off"
block|,
literal|"CANMOUNT"
block|,
name|B_TRUE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"shareiscsi"
block|,
name|prop_type_string
block|,
literal|0
block|,
literal|"off"
block|,
name|prop_inherit
block|,
name|ZFS_TYPE_ANY
block|,
literal|"on | off | type=<type>"
block|,
literal|"SHAREISCSI"
block|,
name|B_FALSE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"iscsioptions"
block|,
name|prop_type_string
block|,
literal|0
block|,
name|NULL
block|,
name|prop_inherit
block|,
name|ZFS_TYPE_VOLUME
block|,
name|NULL
block|,
literal|"ISCSIOPTIONS"
block|,
name|B_FALSE
block|,
name|B_FALSE
block|}
block|,
block|{
literal|"xattr"
block|,
name|prop_type_boolean
block|,
literal|1
block|,
name|NULL
block|,
name|prop_inherit
block|,
name|ZFS_TYPE_FILESYSTEM
operator||
name|ZFS_TYPE_SNAPSHOT
block|,
literal|"on | off"
block|,
literal|"XATTR"
block|,
name|B_TRUE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"numclones"
block|,
name|prop_type_number
block|,
literal|0
block|,
name|NULL
block|,
name|prop_readonly
block|,
name|ZFS_TYPE_SNAPSHOT
block|,
name|NULL
block|,
name|NULL
block|,
name|B_FALSE
block|,
name|B_FALSE
block|}
block|,
block|{
literal|"copies"
block|,
name|prop_type_index
block|,
literal|1
block|,
literal|"1"
block|,
name|prop_inherit
block|,
name|ZFS_TYPE_FILESYSTEM
operator||
name|ZFS_TYPE_VOLUME
block|,
literal|"1 | 2 | 3"
block|,
literal|"COPIES"
block|,
name|B_TRUE
block|,
name|B_TRUE
block|}
block|,
block|{
literal|"bootfs"
block|,
name|prop_type_string
block|,
literal|0
block|,
name|NULL
block|,
name|prop_default
block|,
name|ZFS_TYPE_POOL
block|,
literal|"<filesystem>"
block|,
literal|"BOOTFS"
block|,
name|B_FALSE
block|,
name|B_TRUE
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|ZFS_PROP_COUNT
value|((sizeof (zfs_prop_table))/(sizeof (prop_desc_t)))
end_define

begin_comment
comment|/*  * Returns TRUE if the property applies to the given dataset types.  */
end_comment

begin_function
name|int
name|zfs_prop_valid_for_type
parameter_list|(
name|zfs_prop_t
name|prop
parameter_list|,
name|int
name|types
parameter_list|)
block|{
return|return
operator|(
operator|(
name|zfs_prop_table
index|[
name|prop
index|]
operator|.
name|pd_types
operator|&
name|types
operator|)
operator|!=
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Determine if the specified property is visible or not.  */
end_comment

begin_function
name|boolean_t
name|zfs_prop_is_visible
parameter_list|(
name|zfs_prop_t
name|prop
parameter_list|)
block|{
if|if
condition|(
name|prop
operator|<
literal|0
condition|)
return|return
operator|(
name|B_FALSE
operator|)
return|;
return|return
operator|(
name|zfs_prop_table
index|[
name|prop
index|]
operator|.
name|pd_visible
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Iterate over all properties, calling back into the specified function  * for each property. We will continue to iterate until we either  * reach the end or the callback function something other than  * ZFS_PROP_CONT.  */
end_comment

begin_function
name|zfs_prop_t
name|zfs_prop_iter_common
parameter_list|(
name|zfs_prop_f
name|func
parameter_list|,
name|void
modifier|*
name|cb
parameter_list|,
name|zfs_type_t
name|type
parameter_list|,
name|boolean_t
name|show_all
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ZFS_PROP_COUNT
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|zfs_prop_valid_for_type
argument_list|(
name|i
argument_list|,
name|type
argument_list|)
operator|&&
operator|(
name|zfs_prop_is_visible
argument_list|(
name|i
argument_list|)
operator|||
name|show_all
operator|)
condition|)
block|{
if|if
condition|(
name|func
argument_list|(
name|i
argument_list|,
name|cb
argument_list|)
operator|!=
name|ZFS_PROP_CONT
condition|)
return|return
operator|(
name|i
operator|)
return|;
block|}
block|}
return|return
operator|(
name|ZFS_PROP_CONT
operator|)
return|;
block|}
end_function

begin_function
name|zfs_prop_t
name|zfs_prop_iter
parameter_list|(
name|zfs_prop_f
name|func
parameter_list|,
name|void
modifier|*
name|cb
parameter_list|,
name|boolean_t
name|show_all
parameter_list|)
block|{
return|return
operator|(
name|zfs_prop_iter_common
argument_list|(
name|func
argument_list|,
name|cb
argument_list|,
name|ZFS_TYPE_ANY
argument_list|,
name|show_all
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|zpool_prop_t
name|zpool_prop_iter
parameter_list|(
name|zpool_prop_f
name|func
parameter_list|,
name|void
modifier|*
name|cb
parameter_list|,
name|boolean_t
name|show_all
parameter_list|)
block|{
return|return
operator|(
name|zfs_prop_iter_common
argument_list|(
name|func
argument_list|,
name|cb
argument_list|,
name|ZFS_TYPE_POOL
argument_list|,
name|show_all
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|zfs_proptype_t
name|zfs_prop_get_type
parameter_list|(
name|zfs_prop_t
name|prop
parameter_list|)
block|{
return|return
operator|(
name|zfs_prop_table
index|[
name|prop
index|]
operator|.
name|pd_proptype
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|boolean_t
name|propname_match
parameter_list|(
specifier|const
name|char
modifier|*
name|p
parameter_list|,
name|zfs_prop_t
name|prop
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|propname
init|=
name|zfs_prop_table
index|[
name|prop
index|]
operator|.
name|pd_name
decl_stmt|;
ifndef|#
directive|ifndef
name|_KERNEL
specifier|const
name|char
modifier|*
name|colname
init|=
name|zfs_prop_table
index|[
name|prop
index|]
operator|.
name|pd_colname
decl_stmt|;
name|int
name|c
decl_stmt|;
endif|#
directive|endif
ifndef|#
directive|ifndef
name|_KERNEL
if|if
condition|(
name|colname
operator|==
name|NULL
condition|)
return|return
operator|(
name|B_FALSE
operator|)
return|;
endif|#
directive|endif
if|if
condition|(
name|len
operator|==
name|strlen
argument_list|(
name|propname
argument_list|)
operator|&&
name|strncmp
argument_list|(
name|p
argument_list|,
name|propname
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
return|return
operator|(
name|B_TRUE
operator|)
return|;
ifndef|#
directive|ifndef
name|_KERNEL
if|if
condition|(
name|len
operator|!=
name|strlen
argument_list|(
name|colname
argument_list|)
condition|)
return|return
operator|(
name|B_FALSE
operator|)
return|;
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
name|len
condition|;
name|c
operator|++
control|)
if|if
condition|(
name|p
index|[
name|c
index|]
operator|!=
name|tolower
argument_list|(
name|colname
index|[
name|c
index|]
argument_list|)
condition|)
break|break;
return|return
operator|(
name|colname
index|[
name|c
index|]
operator|==
literal|'\0'
operator|)
return|;
else|#
directive|else
return|return
operator|(
name|B_FALSE
operator|)
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|zfs_prop_t
name|zfs_name_to_prop_cb
parameter_list|(
name|zfs_prop_t
name|prop
parameter_list|,
name|void
modifier|*
name|cb_data
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|propname
init|=
name|cb_data
decl_stmt|;
if|if
condition|(
name|propname_match
argument_list|(
name|propname
argument_list|,
name|prop
argument_list|,
name|strlen
argument_list|(
name|propname
argument_list|)
argument_list|)
condition|)
return|return
operator|(
name|prop
operator|)
return|;
return|return
operator|(
name|ZFS_PROP_CONT
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Given a property name and its type, returns the corresponding property ID.  */
end_comment

begin_function
name|zfs_prop_t
name|zfs_name_to_prop_common
parameter_list|(
specifier|const
name|char
modifier|*
name|propname
parameter_list|,
name|zfs_type_t
name|type
parameter_list|)
block|{
name|zfs_prop_t
name|prop
decl_stmt|;
name|prop
operator|=
name|zfs_prop_iter_common
argument_list|(
name|zfs_name_to_prop_cb
argument_list|,
operator|(
name|void
operator|*
operator|)
name|propname
argument_list|,
name|type
argument_list|,
name|B_TRUE
argument_list|)
expr_stmt|;
return|return
operator|(
name|prop
operator|==
name|ZFS_PROP_CONT
condition|?
name|ZFS_PROP_INVAL
else|:
name|prop
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Given a zfs dataset property name, returns the corresponding property ID.  */
end_comment

begin_function
name|zfs_prop_t
name|zfs_name_to_prop
parameter_list|(
specifier|const
name|char
modifier|*
name|propname
parameter_list|)
block|{
return|return
operator|(
name|zfs_name_to_prop_common
argument_list|(
name|propname
argument_list|,
name|ZFS_TYPE_ANY
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Given a pool property name, returns the corresponding property ID.  */
end_comment

begin_function
name|zpool_prop_t
name|zpool_name_to_prop
parameter_list|(
specifier|const
name|char
modifier|*
name|propname
parameter_list|)
block|{
return|return
operator|(
name|zfs_name_to_prop_common
argument_list|(
name|propname
argument_list|,
name|ZFS_TYPE_POOL
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * For user property names, we allow all lowercase alphanumeric characters, plus  * a few useful punctuation characters.  */
end_comment

begin_function
specifier|static
name|int
name|valid_char
parameter_list|(
name|char
name|c
parameter_list|)
block|{
return|return
operator|(
operator|(
name|c
operator|>=
literal|'a'
operator|&&
name|c
operator|<=
literal|'z'
operator|)
operator|||
operator|(
name|c
operator|>=
literal|'0'
operator|&&
name|c
operator|<=
literal|'9'
operator|)
operator|||
name|c
operator|==
literal|'-'
operator|||
name|c
operator|==
literal|'_'
operator|||
name|c
operator|==
literal|'.'
operator|||
name|c
operator|==
literal|':'
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Returns true if this is a valid user-defined property (one with a ':').  */
end_comment

begin_function
name|boolean_t
name|zfs_prop_user
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|char
name|c
decl_stmt|;
name|boolean_t
name|foundsep
init|=
name|B_FALSE
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|strlen
argument_list|(
name|name
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|c
operator|=
name|name
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|valid_char
argument_list|(
name|c
argument_list|)
condition|)
return|return
operator|(
name|B_FALSE
operator|)
return|;
if|if
condition|(
name|c
operator|==
literal|':'
condition|)
name|foundsep
operator|=
name|B_TRUE
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|foundsep
condition|)
return|return
operator|(
name|B_FALSE
operator|)
return|;
return|return
operator|(
name|B_TRUE
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Return the default value for the given property.  */
end_comment

begin_function
specifier|const
name|char
modifier|*
name|zfs_prop_default_string
parameter_list|(
name|zfs_prop_t
name|prop
parameter_list|)
block|{
return|return
operator|(
name|zfs_prop_table
index|[
name|prop
index|]
operator|.
name|pd_strdefault
operator|)
return|;
block|}
end_function

begin_function
name|uint64_t
name|zfs_prop_default_numeric
parameter_list|(
name|zfs_prop_t
name|prop
parameter_list|)
block|{
return|return
operator|(
name|zfs_prop_table
index|[
name|prop
index|]
operator|.
name|pd_numdefault
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Returns TRUE if the property is readonly.  */
end_comment

begin_function
name|int
name|zfs_prop_readonly
parameter_list|(
name|zfs_prop_t
name|prop
parameter_list|)
block|{
return|return
operator|(
name|zfs_prop_table
index|[
name|prop
index|]
operator|.
name|pd_attr
operator|==
name|prop_readonly
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Given a dataset property ID, returns the corresponding name.  * Assuming the zfs dataset propety ID is valid.  */
end_comment

begin_function
specifier|const
name|char
modifier|*
name|zfs_prop_to_name
parameter_list|(
name|zfs_prop_t
name|prop
parameter_list|)
block|{
return|return
operator|(
name|zfs_prop_table
index|[
name|prop
index|]
operator|.
name|pd_name
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Given a pool property ID, returns the corresponding name.  * Assuming the pool propety ID is valid.  */
end_comment

begin_function
specifier|const
name|char
modifier|*
name|zpool_prop_to_name
parameter_list|(
name|zpool_prop_t
name|prop
parameter_list|)
block|{
return|return
operator|(
name|zfs_prop_table
index|[
name|prop
index|]
operator|.
name|pd_name
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Returns TRUE if the property is inheritable.  */
end_comment

begin_function
name|int
name|zfs_prop_inheritable
parameter_list|(
name|zfs_prop_t
name|prop
parameter_list|)
block|{
return|return
operator|(
name|zfs_prop_table
index|[
name|prop
index|]
operator|.
name|pd_attr
operator|==
name|prop_inherit
operator|)
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
name|zfs_index
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|uint64_t
name|index
decl_stmt|;
block|}
name|zfs_index_t
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|zfs_index_t
name|checksum_table
index|[]
init|=
block|{
block|{
literal|"on"
block|,
name|ZIO_CHECKSUM_ON
block|}
block|,
block|{
literal|"off"
block|,
name|ZIO_CHECKSUM_OFF
block|}
block|,
block|{
literal|"fletcher2"
block|,
name|ZIO_CHECKSUM_FLETCHER_2
block|}
block|,
block|{
literal|"fletcher4"
block|,
name|ZIO_CHECKSUM_FLETCHER_4
block|}
block|,
block|{
literal|"sha256"
block|,
name|ZIO_CHECKSUM_SHA256
block|}
block|,
block|{
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|zfs_index_t
name|compress_table
index|[]
init|=
block|{
block|{
literal|"on"
block|,
name|ZIO_COMPRESS_ON
block|}
block|,
block|{
literal|"off"
block|,
name|ZIO_COMPRESS_OFF
block|}
block|,
block|{
literal|"lzjb"
block|,
name|ZIO_COMPRESS_LZJB
block|}
block|,
block|{
literal|"gzip"
block|,
name|ZIO_COMPRESS_GZIP_6
block|}
block|,
comment|/* the default gzip level */
block|{
literal|"gzip-1"
block|,
name|ZIO_COMPRESS_GZIP_1
block|}
block|,
block|{
literal|"gzip-2"
block|,
name|ZIO_COMPRESS_GZIP_2
block|}
block|,
block|{
literal|"gzip-3"
block|,
name|ZIO_COMPRESS_GZIP_3
block|}
block|,
block|{
literal|"gzip-4"
block|,
name|ZIO_COMPRESS_GZIP_4
block|}
block|,
block|{
literal|"gzip-5"
block|,
name|ZIO_COMPRESS_GZIP_5
block|}
block|,
block|{
literal|"gzip-6"
block|,
name|ZIO_COMPRESS_GZIP_6
block|}
block|,
block|{
literal|"gzip-7"
block|,
name|ZIO_COMPRESS_GZIP_7
block|}
block|,
block|{
literal|"gzip-8"
block|,
name|ZIO_COMPRESS_GZIP_8
block|}
block|,
block|{
literal|"gzip-9"
block|,
name|ZIO_COMPRESS_GZIP_9
block|}
block|,
block|{
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|zfs_index_t
name|snapdir_table
index|[]
init|=
block|{
block|{
literal|"hidden"
block|,
name|ZFS_SNAPDIR_HIDDEN
block|}
block|,
block|{
literal|"visible"
block|,
name|ZFS_SNAPDIR_VISIBLE
block|}
block|,
block|{
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|zfs_index_t
name|acl_mode_table
index|[]
init|=
block|{
block|{
literal|"discard"
block|,
name|ZFS_ACL_DISCARD
block|}
block|,
block|{
literal|"groupmask"
block|,
name|ZFS_ACL_GROUPMASK
block|}
block|,
block|{
literal|"passthrough"
block|,
name|ZFS_ACL_PASSTHROUGH
block|}
block|,
block|{
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|zfs_index_t
name|acl_inherit_table
index|[]
init|=
block|{
block|{
literal|"discard"
block|,
name|ZFS_ACL_DISCARD
block|}
block|,
block|{
literal|"noallow"
block|,
name|ZFS_ACL_NOALLOW
block|}
block|,
block|{
literal|"secure"
block|,
name|ZFS_ACL_SECURE
block|}
block|,
block|{
literal|"passthrough"
block|,
name|ZFS_ACL_PASSTHROUGH
block|}
block|,
block|{
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|zfs_index_t
name|copies_table
index|[]
init|=
block|{
block|{
literal|"1"
block|,
literal|1
block|}
block|,
block|{
literal|"2"
block|,
literal|2
block|}
block|,
block|{
literal|"3"
block|,
literal|3
block|}
block|,
block|{
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|zfs_index_t
modifier|*
name|zfs_prop_index_table
parameter_list|(
name|zfs_prop_t
name|prop
parameter_list|)
block|{
switch|switch
condition|(
name|prop
condition|)
block|{
case|case
name|ZFS_PROP_CHECKSUM
case|:
return|return
operator|(
name|checksum_table
operator|)
return|;
case|case
name|ZFS_PROP_COMPRESSION
case|:
return|return
operator|(
name|compress_table
operator|)
return|;
case|case
name|ZFS_PROP_SNAPDIR
case|:
return|return
operator|(
name|snapdir_table
operator|)
return|;
case|case
name|ZFS_PROP_ACLMODE
case|:
return|return
operator|(
name|acl_mode_table
operator|)
return|;
case|case
name|ZFS_PROP_ACLINHERIT
case|:
return|return
operator|(
name|acl_inherit_table
operator|)
return|;
case|case
name|ZFS_PROP_COPIES
case|:
return|return
operator|(
name|copies_table
operator|)
return|;
default|default:
return|return
operator|(
name|NULL
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/*  * Tables of index types, plus functions to convert between the user view  * (strings) and internal representation (uint64_t).  */
end_comment

begin_function
name|int
name|zfs_prop_string_to_index
parameter_list|(
name|zfs_prop_t
name|prop
parameter_list|,
specifier|const
name|char
modifier|*
name|string
parameter_list|,
name|uint64_t
modifier|*
name|index
parameter_list|)
block|{
name|zfs_index_t
modifier|*
name|table
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|table
operator|=
name|zfs_prop_index_table
argument_list|(
name|prop
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|table
index|[
name|i
index|]
operator|.
name|name
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|string
argument_list|,
name|table
index|[
name|i
index|]
operator|.
name|name
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|index
operator|=
name|table
index|[
name|i
index|]
operator|.
name|index
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_function
name|int
name|zfs_prop_index_to_string
parameter_list|(
name|zfs_prop_t
name|prop
parameter_list|,
name|uint64_t
name|index
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|string
parameter_list|)
block|{
name|zfs_index_t
modifier|*
name|table
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|table
operator|=
name|zfs_prop_index_table
argument_list|(
name|prop
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|table
index|[
name|i
index|]
operator|.
name|name
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|table
index|[
name|i
index|]
operator|.
name|index
operator|==
name|index
condition|)
block|{
operator|*
name|string
operator|=
name|table
index|[
name|i
index|]
operator|.
name|name
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|_KERNEL
end_ifndef

begin_comment
comment|/*  * Returns a string describing the set of acceptable values for the given  * zfs property, or NULL if it cannot be set.  */
end_comment

begin_function
specifier|const
name|char
modifier|*
name|zfs_prop_values
parameter_list|(
name|zfs_prop_t
name|prop
parameter_list|)
block|{
if|if
condition|(
name|zfs_prop_table
index|[
name|prop
index|]
operator|.
name|pd_types
operator|==
name|ZFS_TYPE_POOL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
return|return
operator|(
name|zfs_prop_table
index|[
name|prop
index|]
operator|.
name|pd_values
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Returns a string describing the set of acceptable values for the given  * zpool property, or NULL if it cannot be set.  */
end_comment

begin_function
specifier|const
name|char
modifier|*
name|zpool_prop_values
parameter_list|(
name|zfs_prop_t
name|prop
parameter_list|)
block|{
if|if
condition|(
name|zfs_prop_table
index|[
name|prop
index|]
operator|.
name|pd_types
operator|!=
name|ZFS_TYPE_POOL
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
return|return
operator|(
name|zfs_prop_table
index|[
name|prop
index|]
operator|.
name|pd_values
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Returns TRUE if this property is a string type.  Note that index types  * (compression, checksum) are treated as strings in userland, even though they  * are stored numerically on disk.  */
end_comment

begin_function
name|int
name|zfs_prop_is_string
parameter_list|(
name|zfs_prop_t
name|prop
parameter_list|)
block|{
return|return
operator|(
name|zfs_prop_table
index|[
name|prop
index|]
operator|.
name|pd_proptype
operator|==
name|prop_type_string
operator|||
name|zfs_prop_table
index|[
name|prop
index|]
operator|.
name|pd_proptype
operator|==
name|prop_type_index
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Returns the column header for the given property.  Used only in  * 'zfs list -o', but centralized here with the other property information.  */
end_comment

begin_function
specifier|const
name|char
modifier|*
name|zfs_prop_column_name
parameter_list|(
name|zfs_prop_t
name|prop
parameter_list|)
block|{
return|return
operator|(
name|zfs_prop_table
index|[
name|prop
index|]
operator|.
name|pd_colname
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Returns whether the given property should be displayed right-justified for  * 'zfs list'.  */
end_comment

begin_function
name|boolean_t
name|zfs_prop_align_right
parameter_list|(
name|zfs_prop_t
name|prop
parameter_list|)
block|{
return|return
operator|(
name|zfs_prop_table
index|[
name|prop
index|]
operator|.
name|pd_rightalign
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Determines the minimum width for the column, and indicates whether it's fixed  * or not.  Only string columns are non-fixed.  */
end_comment

begin_function
name|size_t
name|zfs_prop_width
parameter_list|(
name|zfs_prop_t
name|prop
parameter_list|,
name|boolean_t
modifier|*
name|fixed
parameter_list|)
block|{
name|prop_desc_t
modifier|*
name|pd
init|=
operator|&
name|zfs_prop_table
index|[
name|prop
index|]
decl_stmt|;
name|zfs_index_t
modifier|*
name|idx
decl_stmt|;
name|size_t
name|ret
decl_stmt|;
name|int
name|i
decl_stmt|;
operator|*
name|fixed
operator|=
name|B_TRUE
expr_stmt|;
comment|/* 	 * Start with the width of the column name. 	 */
name|ret
operator|=
name|strlen
argument_list|(
name|pd
operator|->
name|pd_colname
argument_list|)
expr_stmt|;
comment|/* 	 * For fixed-width values, make sure the width is large enough to hold 	 * any possible value. 	 */
switch|switch
condition|(
name|pd
operator|->
name|pd_proptype
condition|)
block|{
case|case
name|prop_type_number
case|:
comment|/* 		 * The maximum length of a human-readable number is 5 characters 		 * ("20.4M", for example). 		 */
if|if
condition|(
name|ret
operator|<
literal|5
condition|)
name|ret
operator|=
literal|5
expr_stmt|;
comment|/* 		 * 'creation' is handled specially because it's a number 		 * internally, but displayed as a date string. 		 */
if|if
condition|(
name|prop
operator|==
name|ZFS_PROP_CREATION
condition|)
operator|*
name|fixed
operator|=
name|B_FALSE
expr_stmt|;
break|break;
case|case
name|prop_type_boolean
case|:
comment|/* 		 * The maximum length of a boolean value is 3 characters, for 		 * "off". 		 */
if|if
condition|(
name|ret
operator|<
literal|3
condition|)
name|ret
operator|=
literal|3
expr_stmt|;
break|break;
case|case
name|prop_type_index
case|:
name|idx
operator|=
name|zfs_prop_index_table
argument_list|(
name|prop
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|idx
index|[
name|i
index|]
operator|.
name|name
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strlen
argument_list|(
name|idx
index|[
name|i
index|]
operator|.
name|name
argument_list|)
operator|>
name|ret
condition|)
name|ret
operator|=
name|strlen
argument_list|(
name|idx
index|[
name|i
index|]
operator|.
name|name
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|prop_type_string
case|:
operator|*
name|fixed
operator|=
name|B_FALSE
expr_stmt|;
break|break;
block|}
return|return
operator|(
name|ret
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (c) 2003-2006 Hewlett-Packard Development Company, L.P. Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:  The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. */
end_comment

begin_include
include|#
directive|include
file|"uwx_env.h"
end_include

begin_include
include|#
directive|include
file|"uwx_utable.h"
end_include

begin_include
include|#
directive|include
file|"uwx_uinfo.h"
end_include

begin_include
include|#
directive|include
file|"uwx_scoreboard.h"
end_include

begin_include
include|#
directive|include
file|"uwx_trace.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|UWX_TRACE_ENABLE
end_ifdef

begin_function
name|void
name|uwx_trace_init
parameter_list|(
name|struct
name|uwx_env
modifier|*
name|env
parameter_list|)
block|{
name|char
modifier|*
name|tstr
decl_stmt|;
name|tstr
operator|=
name|getenv
argument_list|(
literal|"UWX_TRACE"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tstr
operator|!=
name|NULL
condition|)
block|{
while|while
condition|(
operator|*
name|tstr
operator|!=
literal|'\0'
condition|)
block|{
switch|switch
condition|(
operator|*
name|tstr
condition|)
block|{
case|case
literal|'i'
case|:
name|env
operator|->
name|trace
operator||=
name|UWX_TRACE_UINFO
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|env
operator|->
name|trace
operator||=
name|UWX_TRACE_UTABLE
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|env
operator|->
name|trace
operator||=
name|UWX_TRACE_SB
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|env
operator|->
name|trace
operator||=
name|UWX_TRACE_RSTATE
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|env
operator|->
name|trace
operator||=
name|UWX_TRACE_STEP
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|env
operator|->
name|trace
operator||=
name|UWX_TRACE_CONTEXT
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
name|env
operator|->
name|trace
operator||=
name|UWX_TRACE_COPYIN
expr_stmt|;
break|break;
case|case
literal|'L'
case|:
name|env
operator|->
name|trace
operator||=
name|UWX_TRACE_LOOKUPIP
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
ifdef|#
directive|ifdef
name|_KERNEL
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"UWX_TRACE flag `%c' unknown.\n"
argument_list|,
operator|*
name|tstr
argument_list|)
expr_stmt|;
else|#
directive|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"UWX_TRACE flags:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  i: unwind info\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  t: unwind table searching\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  b: scoreboard management\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  r: register state vector\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  s: step\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  c: context\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  C: copyin callback\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  L: lookup ip callback\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
name|tstr
operator|++
expr_stmt|;
block|}
block|}
block|}
end_function

begin_decl_stmt
name|char
modifier|*
name|uwx_sb_rnames
index|[]
init|=
block|{
literal|"RP"
block|,
literal|"PSP"
block|,
literal|"PFS"
block|,
literal|"PREDS"
block|,
literal|"UNAT"
block|,
literal|"PRIUNAT"
block|,
literal|"RNAT"
block|,
literal|"LC"
block|,
literal|"FPSR"
block|,
literal|"GR4"
block|,
literal|"GR5"
block|,
literal|"GR6"
block|,
literal|"GR7"
block|,
literal|"BR1"
block|,
literal|"BR2"
block|,
literal|"BR3"
block|,
literal|"BR4"
block|,
literal|"BR5"
block|,
literal|"FR2"
block|,
literal|"FR3"
block|,
literal|"FR4"
block|,
literal|"FR5"
block|,
literal|"FR16"
block|,
literal|"FR17"
block|,
literal|"FR18"
block|,
literal|"FR19"
block|,
literal|"FR20"
block|,
literal|"FR21"
block|,
literal|"FR22"
block|,
literal|"FR23"
block|,
literal|"FR24"
block|,
literal|"FR25"
block|,
literal|"FR26"
block|,
literal|"FR27"
block|,
literal|"FR28"
block|,
literal|"FR29"
block|,
literal|"FR30"
block|,
literal|"FR31"
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|uwx_dump_rstate
parameter_list|(
name|int
name|regid
parameter_list|,
name|uint64_t
name|rstate
parameter_list|)
block|{
name|int
name|reg
decl_stmt|;
if|if
condition|(
name|rstate
operator|==
name|UWX_DISP_NONE
condition|)
return|return;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"    %-7s"
argument_list|,
name|uwx_sb_rnames
index|[
name|regid
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|UWX_GET_DISP_CODE
argument_list|(
name|rstate
argument_list|)
condition|)
block|{
case|case
name|UWX_DISP_NONE
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"    unchanged\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|UWX_DISP_SPPLUS
argument_list|(
literal|0
argument_list|)
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"    SP + %d\n"
argument_list|,
operator|(
name|int
operator|)
name|rstate
operator|&
operator|~
literal|0x07
argument_list|)
expr_stmt|;
break|break;
case|case
name|UWX_DISP_SPREL
argument_list|(
literal|0
argument_list|)
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"    [SP + %d]\n"
argument_list|,
operator|(
name|int
operator|)
name|rstate
operator|&
operator|~
literal|0x07
argument_list|)
expr_stmt|;
break|break;
case|case
name|UWX_DISP_PSPREL
argument_list|(
literal|0
argument_list|)
case|:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"    [PSP + 16 - %d]\n"
argument_list|,
operator|(
name|int
operator|)
name|rstate
operator|&
operator|~
literal|0x07
argument_list|)
expr_stmt|;
break|break;
case|case
name|UWX_DISP_REG
argument_list|(
literal|0
argument_list|)
case|:
name|reg
operator|=
name|UWX_GET_DISP_REGID
argument_list|(
name|rstate
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|==
name|UWX_REG_AR_PFS
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"    AR.PFS\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|reg
operator|==
name|UWX_REG_AR_UNAT
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"    AR.UNAT\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|reg
operator|>=
name|UWX_REG_GR
argument_list|(
literal|0
argument_list|)
operator|&&
name|reg
operator|<
name|UWX_REG_GR
argument_list|(
literal|128
argument_list|)
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"    GR%d\n"
argument_list|,
name|reg
operator|-
name|UWX_REG_GR
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|reg
operator|>=
name|UWX_REG_FR
argument_list|(
literal|0
argument_list|)
operator|&&
name|reg
operator|<
name|UWX_REG_FR
argument_list|(
literal|128
argument_list|)
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"    FR%d\n"
argument_list|,
name|reg
operator|-
name|UWX_REG_FR
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|reg
operator|>=
name|UWX_REG_BR
argument_list|(
literal|0
argument_list|)
operator|&&
name|reg
operator|<
name|UWX_REG_BR
argument_list|(
literal|8
argument_list|)
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"    BR%d\n"
argument_list|,
name|reg
operator|-
name|UWX_REG_BR
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"<reg %d>\n"
argument_list|,
name|reg
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"<%08lx>\n"
argument_list|,
operator|(
name|long
operator|)
name|rstate
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|uwx_dump_scoreboard
parameter_list|(
name|struct
name|uwx_scoreboard
modifier|*
name|scoreboard
parameter_list|,
name|int
name|nsbreg
parameter_list|,
name|struct
name|uwx_rhdr
modifier|*
name|rhdr
parameter_list|,
name|int
name|cur_slot
parameter_list|,
name|int
name|ip_slot
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|rhdr
operator|->
name|is_prologue
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  Prologue region (start = %d, length = %d)\n"
argument_list|,
operator|(
name|int
operator|)
name|cur_slot
argument_list|,
operator|(
name|int
operator|)
name|rhdr
operator|->
name|rlen
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  Body region (start = %d, length = %d, ecount = %d)\n"
argument_list|,
name|cur_slot
argument_list|,
operator|(
name|int
operator|)
name|rhdr
operator|->
name|rlen
argument_list|,
name|rhdr
operator|->
name|ecount
argument_list|)
expr_stmt|;
if|if
condition|(
name|ip_slot
operator|<
name|rhdr
operator|->
name|rlen
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"    IP is in this region (offset = %d)\n"
argument_list|,
name|ip_slot
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nsbreg
condition|;
name|i
operator|++
control|)
name|uwx_dump_rstate
argument_list|(
name|i
argument_list|,
name|scoreboard
operator|->
name|rstate
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|uwx_dump_uinfo_block
parameter_list|(
name|struct
name|uwx_utable_entry
modifier|*
name|uentry
parameter_list|,
name|unsigned
name|int
name|ulen
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|uint32_t
modifier|*
name|uinfo
init|=
operator|(
name|uint32_t
operator|*
operator|)
operator|(
name|intptr_t
operator|)
name|uentry
operator|->
name|unwind_info
decl_stmt|;
name|ulen
operator|+=
name|DWORDSZ
expr_stmt|;
comment|/* Include unwind info header */
if|if
condition|(
name|uentry
operator|->
name|unwind_flags
operator|&
name|UNWIND_TBL_32BIT
condition|)
comment|/* and personality routine */
name|ulen
operator|+=
name|WORDSZ
expr_stmt|;
else|else
name|ulen
operator|+=
name|DWORDSZ
expr_stmt|;
while|while
condition|(
name|ulen
operator|>=
name|WORDSZ
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"  %08lx: "
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|uinfo
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
operator|*
name|WORDSZ
operator|&&
name|ulen
operator|>=
name|WORDSZ
condition|;
name|i
operator|+=
name|WORDSZ
control|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" %04x"
argument_list|,
operator|*
name|uinfo
operator|++
argument_list|)
expr_stmt|;
name|ulen
operator|-=
name|WORDSZ
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* UWX_TRACE_ENABLE */
end_comment

end_unit


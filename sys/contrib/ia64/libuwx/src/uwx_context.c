begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (c) 2003 Hewlett-Packard Development Company, L.P. Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:  The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. */
end_comment

begin_include
include|#
directive|include
file|"uwx_env.h"
end_include

begin_include
include|#
directive|include
file|"uwx_context.h"
end_include

begin_include
include|#
directive|include
file|"uwx_scoreboard.h"
end_include

begin_include
include|#
directive|include
file|"uwx_step.h"
end_include

begin_include
include|#
directive|include
file|"uwx_trace.h"
end_include

begin_function
name|int
name|uwx_init_context
parameter_list|(
name|struct
name|uwx_env
modifier|*
name|env
parameter_list|,
name|uint64_t
name|ip
parameter_list|,
name|uint64_t
name|sp
parameter_list|,
name|uint64_t
name|bsp
parameter_list|,
name|uint64_t
name|cfm
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|env
operator|==
literal|0
condition|)
return|return
name|UWX_ERR_NOENV
return|;
name|env
operator|->
name|context
operator|.
name|special
index|[
name|UWX_REG_IP
index|]
operator|=
name|ip
expr_stmt|;
name|env
operator|->
name|context
operator|.
name|special
index|[
name|UWX_REG_SP
index|]
operator|=
name|sp
expr_stmt|;
name|env
operator|->
name|context
operator|.
name|special
index|[
name|UWX_REG_BSP
index|]
operator|=
name|bsp
expr_stmt|;
name|env
operator|->
name|context
operator|.
name|special
index|[
name|UWX_REG_CFM
index|]
operator|=
name|cfm
expr_stmt|;
for|for
control|(
name|i
operator|=
name|UWX_REG_RP
init|;
name|i
operator|<
name|NSPECIALREG
condition|;
name|i
operator|++
control|)
name|env
operator|->
name|context
operator|.
name|special
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NPRESERVEDGR
condition|;
name|i
operator|++
control|)
name|env
operator|->
name|context
operator|.
name|gr
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|env
operator|->
name|context
operator|.
name|valid_regs
operator|=
name|VALID_BASIC4
expr_stmt|;
name|env
operator|->
name|context
operator|.
name|valid_frs
operator|=
literal|0
expr_stmt|;
name|env
operator|->
name|rstate
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|uwx_init_history
argument_list|(
name|env
argument_list|)
expr_stmt|;
return|return
name|UWX_OK
return|;
block|}
end_function

begin_function
name|int
name|uwx_get_reg
parameter_list|(
name|struct
name|uwx_env
modifier|*
name|env
parameter_list|,
name|int
name|regid
parameter_list|,
name|uint64_t
modifier|*
name|valp
parameter_list|)
block|{
name|int
name|status
decl_stmt|;
name|int
name|sor
decl_stmt|;
name|int
name|rrb_gr
decl_stmt|;
name|uint64_t
name|bsp
decl_stmt|;
name|int
name|n
decl_stmt|;
if|if
condition|(
name|env
operator|==
literal|0
condition|)
return|return
name|UWX_ERR_NOENV
return|;
name|status
operator|=
name|UWX_OK
expr_stmt|;
if|if
condition|(
name|regid
operator|==
name|UWX_REG_GR
argument_list|(
literal|12
argument_list|)
condition|)
name|regid
operator|=
name|UWX_REG_SP
expr_stmt|;
if|if
condition|(
name|regid
operator|<
name|NSPECIALREG
operator|&&
operator|(
name|env
operator|->
name|context
operator|.
name|valid_regs
operator|&
operator|(
literal|1
operator|<<
name|regid
operator|)
operator|)
condition|)
operator|*
name|valp
operator|=
name|env
operator|->
name|context
operator|.
name|special
index|[
name|regid
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|regid
operator|==
name|UWX_REG_PSP
operator|||
name|regid
operator|==
name|UWX_REG_RP
operator|||
name|regid
operator|==
name|UWX_REG_PFS
condition|)
block|{
name|status
operator|=
name|uwx_restore_markers
argument_list|(
name|env
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|UWX_OK
condition|)
return|return
name|status
return|;
operator|*
name|valp
operator|=
name|env
operator|->
name|context
operator|.
name|special
index|[
name|regid
index|]
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|regid
operator|>=
name|UWX_REG_GR
argument_list|(
literal|4
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_GR
argument_list|(
literal|7
argument_list|)
operator|&&
operator|(
name|env
operator|->
name|context
operator|.
name|valid_regs
operator|&
operator|(
literal|1
operator|<<
operator|(
name|regid
operator|-
name|UWX_REG_GR
argument_list|(
literal|4
argument_list|)
operator|+
name|VALID_GR_SHIFT
operator|)
operator|)
operator|)
condition|)
operator|*
name|valp
operator|=
name|env
operator|->
name|context
operator|.
name|gr
index|[
name|regid
operator|-
name|UWX_REG_GR
argument_list|(
literal|4
argument_list|)
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|regid
operator|>=
name|UWX_REG_GR
argument_list|(
literal|32
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_GR
argument_list|(
literal|127
argument_list|)
condition|)
block|{
if|if
condition|(
name|env
operator|->
name|copyin
operator|==
literal|0
condition|)
return|return
name|UWX_ERR_NOCALLBACKS
return|;
name|bsp
operator|=
name|env
operator|->
name|context
operator|.
name|special
index|[
name|UWX_REG_BSP
index|]
expr_stmt|;
name|TRACE_C_GET_REG
argument_list|(
argument|regid
argument_list|,
argument|bsp
argument_list|)
name|regid
operator|-=
name|UWX_REG_GR
argument_list|(
literal|32
argument_list|)
expr_stmt|;
name|sor
operator|=
operator|(
operator|(
operator|(
name|int
operator|)
name|env
operator|->
name|context
operator|.
name|special
index|[
name|UWX_REG_CFM
index|]
operator|>>
literal|14
operator|)
operator|&
literal|0x0f
operator|)
operator|*
literal|8
expr_stmt|;
name|rrb_gr
operator|=
operator|(
operator|(
name|int
operator|)
name|env
operator|->
name|context
operator|.
name|special
index|[
name|UWX_REG_CFM
index|]
operator|>>
literal|18
operator|)
operator|&
literal|0x7f
expr_stmt|;
if|if
condition|(
name|sor
operator|!=
literal|0
operator|&&
name|rrb_gr
operator|!=
literal|0
operator|&&
name|regid
operator|<
name|sor
condition|)
block|{
name|TRACE_C_ROTATE_GR
argument_list|(
argument|regid
argument_list|,
argument|sor
argument_list|,
argument|rrb_gr
argument_list|,
argument|(regid+rrb_gr)%sor
argument_list|)
name|regid
operator|=
operator|(
name|regid
operator|+
name|rrb_gr
operator|)
operator|%
name|sor
expr_stmt|;
block|}
name|bsp
operator|=
name|uwx_add_to_bsp
argument_list|(
name|bsp
argument_list|,
name|regid
argument_list|)
expr_stmt|;
name|n
operator|=
call|(
modifier|*
name|env
operator|->
name|copyin
call|)
argument_list|(
name|UWX_COPYIN_RSTACK
argument_list|,
operator|(
name|char
operator|*
operator|)
name|valp
argument_list|,
name|bsp
argument_list|,
name|DWORDSZ
argument_list|,
name|env
operator|->
name|cb_token
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|!=
name|DWORDSZ
condition|)
name|status
operator|=
name|UWX_ERR_COPYIN_RSTK
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|regid
operator|==
name|UWX_REG_GR
argument_list|(
literal|0
argument_list|)
condition|)
operator|*
name|valp
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|regid
operator|>=
name|UWX_REG_BR
argument_list|(
literal|1
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_BR
argument_list|(
literal|5
argument_list|)
operator|&&
operator|(
name|env
operator|->
name|context
operator|.
name|valid_regs
operator|&
operator|(
literal|1
operator|<<
operator|(
name|regid
operator|-
name|UWX_REG_BR
argument_list|(
literal|1
argument_list|)
operator|+
name|VALID_BR_SHIFT
operator|)
operator|)
operator|)
condition|)
operator|*
name|valp
operator|=
name|env
operator|->
name|context
operator|.
name|br
index|[
name|regid
operator|-
name|UWX_REG_BR
argument_list|(
literal|1
argument_list|)
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|regid
operator|>=
name|UWX_REG_FR
argument_list|(
literal|2
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_FR
argument_list|(
literal|5
argument_list|)
operator|&&
operator|(
name|env
operator|->
name|context
operator|.
name|valid_frs
operator|&
operator|(
literal|1
operator|<<
operator|(
name|regid
operator|-
name|UWX_REG_FR
argument_list|(
literal|2
argument_list|)
operator|)
operator|)
operator|)
condition|)
block|{
name|valp
index|[
literal|0
index|]
operator|=
name|env
operator|->
name|context
operator|.
name|fr
index|[
name|regid
operator|-
name|UWX_REG_FR
argument_list|(
literal|2
argument_list|)
index|]
operator|.
name|part0
expr_stmt|;
name|valp
index|[
literal|1
index|]
operator|=
name|env
operator|->
name|context
operator|.
name|fr
index|[
name|regid
operator|-
name|UWX_REG_FR
argument_list|(
literal|2
argument_list|)
index|]
operator|.
name|part1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|regid
operator|>=
name|UWX_REG_FR
argument_list|(
literal|16
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_FR
argument_list|(
literal|31
argument_list|)
operator|&&
operator|(
name|env
operator|->
name|context
operator|.
name|valid_frs
operator|&
operator|(
literal|1
operator|<<
operator|(
name|regid
operator|-
name|UWX_REG_FR
argument_list|(
literal|16
argument_list|)
operator|+
literal|4
operator|)
operator|)
operator|)
condition|)
block|{
name|valp
index|[
literal|0
index|]
operator|=
name|env
operator|->
name|context
operator|.
name|fr
index|[
name|regid
operator|-
name|UWX_REG_FR
argument_list|(
literal|16
argument_list|)
operator|+
literal|4
index|]
operator|.
name|part0
expr_stmt|;
name|valp
index|[
literal|1
index|]
operator|=
name|env
operator|->
name|context
operator|.
name|fr
index|[
name|regid
operator|-
name|UWX_REG_FR
argument_list|(
literal|16
argument_list|)
operator|+
literal|4
index|]
operator|.
name|part1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|regid
operator|<
name|NSPECIALREG
operator|)
operator|||
operator|(
name|regid
operator|>=
name|UWX_REG_GR
argument_list|(
literal|1
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_GR
argument_list|(
literal|31
argument_list|)
operator|)
operator|||
operator|(
name|regid
operator|>=
name|UWX_REG_BR
argument_list|(
literal|0
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_BR
argument_list|(
literal|7
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|env
operator|->
name|copyin
operator|==
literal|0
condition|)
return|return
name|UWX_ERR_NOCALLBACKS
return|;
name|n
operator|=
call|(
modifier|*
name|env
operator|->
name|copyin
call|)
argument_list|(
name|UWX_COPYIN_REG
argument_list|,
operator|(
name|char
operator|*
operator|)
name|valp
argument_list|,
name|regid
argument_list|,
name|DWORDSZ
argument_list|,
name|env
operator|->
name|cb_token
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|!=
name|DWORDSZ
condition|)
name|status
operator|=
name|UWX_ERR_COPYIN_REG
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|regid
operator|>=
name|UWX_REG_FR
argument_list|(
literal|2
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_FR
argument_list|(
literal|127
argument_list|)
condition|)
block|{
if|if
condition|(
name|env
operator|->
name|copyin
operator|==
literal|0
condition|)
return|return
name|UWX_ERR_NOCALLBACKS
return|;
name|n
operator|=
call|(
modifier|*
name|env
operator|->
name|copyin
call|)
argument_list|(
name|UWX_COPYIN_REG
argument_list|,
operator|(
name|char
operator|*
operator|)
name|valp
argument_list|,
name|regid
argument_list|,
literal|2
operator|*
name|DWORDSZ
argument_list|,
name|env
operator|->
name|cb_token
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|!=
literal|2
operator|*
name|DWORDSZ
condition|)
name|status
operator|=
name|UWX_ERR_COPYIN_REG
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|regid
operator|==
name|UWX_REG_FR
argument_list|(
literal|0
argument_list|)
condition|)
block|{
name|valp
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|valp
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|regid
operator|==
name|UWX_REG_FR
argument_list|(
literal|1
argument_list|)
condition|)
block|{
name|valp
index|[
literal|0
index|]
operator|=
literal|0x000000000000ffffULL
expr_stmt|;
name|valp
index|[
literal|1
index|]
operator|=
literal|0x8000000000000000ULL
expr_stmt|;
block|}
else|else
name|status
operator|=
name|UWX_ERR_BADREGID
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|int
name|uwx_get_nat
parameter_list|(
name|struct
name|uwx_env
modifier|*
name|env
parameter_list|,
name|int
name|regid
parameter_list|,
name|int
modifier|*
name|natp
parameter_list|)
block|{
name|int
name|status
decl_stmt|;
name|int
name|sor
decl_stmt|;
name|int
name|rrb_gr
decl_stmt|;
name|uint64_t
name|bsp
decl_stmt|;
name|uint64_t
name|natcollp
decl_stmt|;
name|uint64_t
name|natcoll
decl_stmt|;
name|int
name|n
decl_stmt|;
if|if
condition|(
name|env
operator|==
literal|0
condition|)
return|return
name|UWX_ERR_NOENV
return|;
name|status
operator|=
name|UWX_OK
expr_stmt|;
if|if
condition|(
name|regid
operator|>=
name|UWX_REG_GR
argument_list|(
literal|4
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_GR
argument_list|(
literal|7
argument_list|)
operator|&&
operator|(
name|env
operator|->
name|context
operator|.
name|valid_regs
operator|&
operator|(
literal|1
operator|<<
operator|(
name|regid
operator|-
name|UWX_REG_GR
argument_list|(
literal|4
argument_list|)
operator|+
name|VALID_GR_SHIFT
operator|)
operator|)
operator|)
condition|)
block|{
operator|*
name|natp
operator|=
operator|(
name|env
operator|->
name|context
operator|.
name|special
index|[
name|UWX_REG_PRIUNAT
index|]
operator|>>
operator|(
name|regid
operator|-
name|UWX_REG_GR
argument_list|(
literal|4
argument_list|)
operator|)
operator|)
operator|&
literal|0x01
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|regid
operator|>=
name|UWX_REG_GR
argument_list|(
literal|32
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_GR
argument_list|(
literal|127
argument_list|)
condition|)
block|{
if|if
condition|(
name|env
operator|->
name|copyin
operator|==
literal|0
condition|)
return|return
name|UWX_ERR_NOCALLBACKS
return|;
name|bsp
operator|=
name|env
operator|->
name|context
operator|.
name|special
index|[
name|UWX_REG_BSP
index|]
expr_stmt|;
name|regid
operator|-=
name|UWX_REG_GR
argument_list|(
literal|32
argument_list|)
expr_stmt|;
name|sor
operator|=
operator|(
operator|(
operator|(
name|int
operator|)
name|env
operator|->
name|context
operator|.
name|special
index|[
name|UWX_REG_CFM
index|]
operator|>>
literal|14
operator|)
operator|&
literal|0x0f
operator|)
operator|*
literal|8
expr_stmt|;
name|rrb_gr
operator|=
operator|(
operator|(
name|int
operator|)
name|env
operator|->
name|context
operator|.
name|special
index|[
name|UWX_REG_CFM
index|]
operator|>>
literal|18
operator|)
operator|&
literal|0x7f
expr_stmt|;
if|if
condition|(
name|sor
operator|!=
literal|0
operator|&&
name|rrb_gr
operator|!=
literal|0
operator|&&
name|regid
operator|<
name|sor
condition|)
block|{
name|regid
operator|=
operator|(
name|regid
operator|+
name|rrb_gr
operator|)
operator|%
name|sor
expr_stmt|;
block|}
name|bsp
operator|=
name|uwx_add_to_bsp
argument_list|(
name|bsp
argument_list|,
name|regid
argument_list|)
expr_stmt|;
name|natcollp
operator|=
name|bsp
operator||
literal|0x01f8
expr_stmt|;
name|n
operator|=
call|(
modifier|*
name|env
operator|->
name|copyin
call|)
argument_list|(
name|UWX_COPYIN_RSTACK
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|natcoll
argument_list|,
name|bsp
argument_list|,
name|DWORDSZ
argument_list|,
name|env
operator|->
name|cb_token
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|!=
name|DWORDSZ
condition|)
return|return
name|UWX_ERR_COPYIN_RSTK
return|;
operator|*
name|natp
operator|=
call|(
name|int
call|)
argument_list|(
name|natcoll
operator|>>
operator|(
operator|(
operator|(
name|int
operator|)
name|bsp
operator|>>
literal|3
operator|)
operator|&
literal|0x3f
operator|)
argument_list|)
operator|&
literal|0x01
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|regid
operator|==
name|UWX_REG_GR
argument_list|(
literal|0
argument_list|)
condition|)
operator|*
name|natp
operator|=
literal|0
expr_stmt|;
else|else
name|status
operator|=
name|UWX_ERR_BADREGID
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|int
name|uwx_get_spill_loc
parameter_list|(
name|struct
name|uwx_env
modifier|*
name|env
parameter_list|,
name|int
name|regid
parameter_list|,
name|uint64_t
modifier|*
name|dispp
parameter_list|)
block|{
name|int
name|status
decl_stmt|;
name|int
name|sor
decl_stmt|;
name|int
name|rrb_gr
decl_stmt|;
name|uint64_t
name|bsp
decl_stmt|;
if|if
condition|(
name|env
operator|==
literal|0
condition|)
return|return
name|UWX_ERR_NOENV
return|;
name|status
operator|=
name|UWX_OK
expr_stmt|;
if|if
condition|(
name|regid
operator|==
name|UWX_REG_GR
argument_list|(
literal|12
argument_list|)
condition|)
name|regid
operator|=
name|UWX_REG_SP
expr_stmt|;
if|if
condition|(
name|regid
operator|<
name|NSPECIALREG
condition|)
operator|*
name|dispp
operator|=
name|env
operator|->
name|history
operator|.
name|special
index|[
name|regid
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|regid
operator|>=
name|UWX_REG_GR
argument_list|(
literal|4
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_GR
argument_list|(
literal|7
argument_list|)
condition|)
operator|*
name|dispp
operator|=
name|env
operator|->
name|history
operator|.
name|gr
index|[
name|regid
operator|-
name|UWX_REG_GR
argument_list|(
literal|4
argument_list|)
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|regid
operator|>=
name|UWX_REG_GR
argument_list|(
literal|32
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_GR
argument_list|(
literal|127
argument_list|)
condition|)
block|{
name|bsp
operator|=
name|env
operator|->
name|context
operator|.
name|special
index|[
name|UWX_REG_BSP
index|]
expr_stmt|;
name|regid
operator|-=
name|UWX_REG_GR
argument_list|(
literal|32
argument_list|)
expr_stmt|;
name|sor
operator|=
operator|(
operator|(
operator|(
name|int
operator|)
name|env
operator|->
name|context
operator|.
name|special
index|[
name|UWX_REG_CFM
index|]
operator|>>
literal|14
operator|)
operator|&
literal|0x0f
operator|)
operator|*
literal|8
expr_stmt|;
name|rrb_gr
operator|=
operator|(
operator|(
name|int
operator|)
name|env
operator|->
name|context
operator|.
name|special
index|[
name|UWX_REG_CFM
index|]
operator|>>
literal|18
operator|)
operator|&
literal|0x7f
expr_stmt|;
if|if
condition|(
name|sor
operator|!=
literal|0
operator|&&
name|rrb_gr
operator|!=
literal|0
operator|&&
name|regid
operator|<
name|sor
condition|)
name|regid
operator|=
operator|(
name|regid
operator|+
name|rrb_gr
operator|)
operator|%
name|sor
expr_stmt|;
name|bsp
operator|=
name|uwx_add_to_bsp
argument_list|(
name|bsp
argument_list|,
name|regid
argument_list|)
expr_stmt|;
operator|*
name|dispp
operator|=
name|UWX_DISP_RSTK
argument_list|(
name|bsp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|regid
operator|>=
name|UWX_REG_BR
argument_list|(
literal|1
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_GR
argument_list|(
literal|5
argument_list|)
condition|)
operator|*
name|dispp
operator|=
name|env
operator|->
name|history
operator|.
name|br
index|[
name|regid
operator|-
name|UWX_REG_BR
argument_list|(
literal|1
argument_list|)
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|regid
operator|>=
name|UWX_REG_FR
argument_list|(
literal|2
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_FR
argument_list|(
literal|5
argument_list|)
condition|)
operator|*
name|dispp
operator|=
name|env
operator|->
name|history
operator|.
name|fr
index|[
name|regid
operator|-
name|UWX_REG_FR
argument_list|(
literal|2
argument_list|)
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|regid
operator|>=
name|UWX_REG_FR
argument_list|(
literal|16
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_FR
argument_list|(
literal|31
argument_list|)
condition|)
operator|*
name|dispp
operator|=
name|env
operator|->
name|history
operator|.
name|fr
index|[
name|regid
operator|-
name|UWX_REG_FR
argument_list|(
literal|16
argument_list|)
operator|+
literal|4
index|]
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|regid
operator|>=
name|UWX_REG_GR
argument_list|(
literal|1
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_GR
argument_list|(
literal|31
argument_list|)
operator|)
operator|||
operator|(
name|regid
operator|>=
name|UWX_REG_BR
argument_list|(
literal|0
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_BR
argument_list|(
literal|7
argument_list|)
operator|)
operator|||
operator|(
name|regid
operator|>=
name|UWX_REG_FR
argument_list|(
literal|2
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_FR
argument_list|(
literal|127
argument_list|)
operator|)
condition|)
operator|*
name|dispp
operator|=
name|UWX_DISP_REG
argument_list|(
name|regid
argument_list|)
expr_stmt|;
else|else
name|status
operator|=
name|UWX_ERR_BADREGID
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|int
name|uwx_set_reg
parameter_list|(
name|struct
name|uwx_env
modifier|*
name|env
parameter_list|,
name|int
name|regid
parameter_list|,
name|uint64_t
name|val
parameter_list|)
block|{
name|int
name|status
decl_stmt|;
if|if
condition|(
name|env
operator|==
literal|0
condition|)
return|return
name|UWX_ERR_NOENV
return|;
if|if
condition|(
name|regid
operator|==
name|UWX_REG_GR
argument_list|(
literal|12
argument_list|)
condition|)
name|regid
operator|=
name|UWX_REG_SP
expr_stmt|;
if|if
condition|(
name|regid
operator|<
name|NSPECIALREG
condition|)
block|{
name|env
operator|->
name|context
operator|.
name|special
index|[
name|regid
index|]
operator|=
name|val
expr_stmt|;
name|env
operator|->
name|context
operator|.
name|valid_regs
operator||=
literal|1
operator|<<
name|regid
expr_stmt|;
name|status
operator|=
name|UWX_OK
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|regid
operator|>=
name|UWX_REG_GR
argument_list|(
literal|4
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_GR
argument_list|(
literal|7
argument_list|)
condition|)
block|{
name|env
operator|->
name|context
operator|.
name|gr
index|[
name|regid
operator|-
name|UWX_REG_GR
argument_list|(
literal|4
argument_list|)
index|]
operator|=
name|val
expr_stmt|;
name|env
operator|->
name|context
operator|.
name|valid_regs
operator||=
literal|1
operator|<<
operator|(
name|regid
operator|-
name|UWX_REG_GR
argument_list|(
literal|4
argument_list|)
operator|+
name|VALID_GR_SHIFT
operator|)
expr_stmt|;
name|status
operator|=
name|UWX_OK
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|regid
operator|>=
name|UWX_REG_GR
argument_list|(
literal|32
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_GR
argument_list|(
literal|127
argument_list|)
condition|)
block|{
name|status
operator|=
name|UWX_ERR_BADREGID
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|regid
operator|>=
name|UWX_REG_BR
argument_list|(
literal|1
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_BR
argument_list|(
literal|5
argument_list|)
condition|)
block|{
name|env
operator|->
name|context
operator|.
name|br
index|[
name|regid
operator|-
name|UWX_REG_BR
argument_list|(
literal|1
argument_list|)
index|]
operator|=
name|val
expr_stmt|;
name|env
operator|->
name|context
operator|.
name|valid_regs
operator||=
literal|1
operator|<<
operator|(
name|regid
operator|-
name|UWX_REG_BR
argument_list|(
literal|1
argument_list|)
operator|+
name|VALID_BR_SHIFT
operator|)
expr_stmt|;
name|status
operator|=
name|UWX_OK
expr_stmt|;
block|}
else|else
name|status
operator|=
name|UWX_ERR_BADREGID
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|int
name|uwx_set_fr
parameter_list|(
name|struct
name|uwx_env
modifier|*
name|env
parameter_list|,
name|int
name|regid
parameter_list|,
name|uint64_t
modifier|*
name|val
parameter_list|)
block|{
if|if
condition|(
name|regid
operator|>=
name|UWX_REG_FR
argument_list|(
literal|2
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_FR
argument_list|(
literal|5
argument_list|)
condition|)
name|regid
operator|-=
name|UWX_REG_FR
argument_list|(
literal|2
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|regid
operator|>=
name|UWX_REG_FR
argument_list|(
literal|16
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_FR
argument_list|(
literal|31
argument_list|)
condition|)
name|regid
operator|-=
name|UWX_REG_FR
argument_list|(
literal|16
argument_list|)
operator|-
literal|4
expr_stmt|;
else|else
return|return
name|UWX_ERR_BADREGID
return|;
name|env
operator|->
name|context
operator|.
name|fr
index|[
name|regid
index|]
operator|.
name|part0
operator|=
name|val
index|[
literal|0
index|]
expr_stmt|;
name|env
operator|->
name|context
operator|.
name|fr
index|[
name|regid
index|]
operator|.
name|part1
operator|=
name|val
index|[
literal|1
index|]
expr_stmt|;
name|env
operator|->
name|context
operator|.
name|valid_frs
operator||=
literal|1
operator|<<
name|regid
expr_stmt|;
name|env
operator|->
name|nsbreg
operator|=
name|NSBREG
expr_stmt|;
return|return
name|UWX_OK
return|;
block|}
end_function

begin_function
name|uint64_t
name|uwx_add_to_bsp
parameter_list|(
name|uint64_t
name|bsp
parameter_list|,
name|int
name|nslots
parameter_list|)
block|{
name|int
name|bias
decl_stmt|;
comment|/*      *  Here's a picture of the backing store as modeled in      *  the computations below. "X" marks NaT collections at      *  every 0x1f8 mod 0x200 address.      *      *  To make the NaT adjustments easier, we bias the current bsp      *  by enough slots to place it at the previous NaT collection.      *  Then we need to add the bias to the number of slots,      *  then add 1 for every 63 slots to account for NaT collections.      *  Then we can remove the bias again and add the adjusted      *  number of slots to the bsp.      *      *   0                           1f8                             3f8      *  +---------------------------------------------------------------+      *  |                              X                               X|      *  +---------------------------------------------------------------+      *<-------- bias -------->      *<--- nslots --->      *                           ^      *                           |      *                          bsp      *<------- adjusted (nslots + bias) ------->       *  When subtracting from bsp, we avoid depending on the sign of      *  the quotient by adding 63*8 before division and subtracting 8      *  after division. (Assumes that we will never be called upon      *  to subtract more than 504 slots from bsp.)      *      *   0                           1f8                             3f8      *  +---------------------------------------------------------------+      *  |                              X                               X|      *  +---------------------------------------------------------------+      *<-- bias -->      *<--- |nslots| --->      *                                              ^      *                                              |      *                                             bsp      *<----------------->      *                        adjusted |nslots + bias|      */
name|bias
operator|=
operator|(
operator|(
name|unsigned
name|int
operator|)
name|bsp
operator|&
literal|0x1f8
operator|)
operator|/
name|DWORDSZ
expr_stmt|;
name|nslots
operator|+=
operator|(
name|nslots
operator|+
name|bias
operator|+
literal|63
operator|*
literal|8
operator|)
operator|/
literal|63
operator|-
literal|8
expr_stmt|;
return|return
name|bsp
operator|+
name|nslots
operator|*
name|DWORDSZ
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|int uwx_selftest_bsp_arithmetic() {     int i;     int j;     int r;     uint64_t bstore[161];     uint64_t *bsp;     uint64_t *p;     int failed = 0;      printf("uwx_selftest_bsp_arithmetic: bsp at %08lx\n", (unsigned int)bstore);     r = 0;     bsp = bstore;     for (i = 0; i< 161; i++) { 	if (((unsigned int)bsp& 0x1f8) == 0x1f8) 	    *bsp++ = 1000 + r; 	else 	    *bsp++ = r++;     }      printf("uwx_selftest_bsp_arithmetic: plus tests...\n");     bsp = bstore;     for (i = 0; i< 64; i++) { 	r = (int)*bsp; 	if (r>= 1000) 	    r -= 1000; 	for (j = 0; j< 96; j++) { 	    p = (uint64_t *)uwx_add_to_bsp((uint64_t)bsp, j); 	    if (*p != (r + j)) { 		failed++; 		printf("%d [%08lx] + %d -> %08lx ", 				i, (unsigned int)bsp, j, (unsigned int)p); 		printf("(read %d instead of %d)\n", (int)*p, r + j); 	    } 	} 	bsp++;     }      printf("uwx_selftest_bsp_arithmetic: minus tests...\n");     bsp =&bstore[161];     for (i = 63; i>= 0; i--) { 	bsp--; 	r = (int)*bsp; 	if (r>= 1000) 	    r -= 1000; 	for (j = 0; j< 96; j++) { 	    p = (uint64_t *)uwx_add_to_bsp((uint64_t)bsp, -j); 	    if (*p != (r - j)) { 		failed++; 		printf("%d [%08lx] - %d -> %08lx ", 				i, (unsigned int)bsp, j, (unsigned int)p); 		printf("(read %d instead of %d)\n", (int)*p, r - j); 	    } 	}     }      return failed; }
endif|#
directive|endif
end_endif

end_unit


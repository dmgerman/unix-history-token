begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2002,2003 Hewlett-Packard Company  *  * Permission is hereby granted, free of charge, to any person obtaining a  * copy of this software and associated documentation files (the "Software"),  * to deal in the Software without restriction, including without limitation  * the rights to use, copy, modify, merge, publish, distribute, sublicense,  * and/or sell copies of the Software, and to permit persons to whom the  * Software is furnished to do so, subject to the following conditions:  *  * The above copyright notice and this permission notice shall be included  * in all copies or substantial portions of the Software.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,  * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL  * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER  * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING  * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER  * DEALINGS IN THE SOFTWARE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|_KERNEL
end_ifndef

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<dlfcn.h>
end_include

begin_include
include|#
directive|include
file|<sys/ttrace.h>
end_include

begin_include
include|#
directive|include
file|<sys/uc_access.h>
end_include

begin_include
include|#
directive|include
file|<machine/sys/uregs.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"uwx_env.h"
end_include

begin_include
include|#
directive|include
file|"uwx_context.h"
end_include

begin_include
include|#
directive|include
file|"uwx_trace.h"
end_include

begin_include
include|#
directive|include
file|"uwx_ttrace.h"
end_include

begin_struct
struct|struct
name|uwx_ttrace_info
block|{
name|uint64_t
name|bspstore
decl_stmt|;
name|uint64_t
name|load_map
decl_stmt|;
name|uint64_t
name|rvec
index|[
literal|10
index|]
decl_stmt|;
name|alloc_cb
name|allocate_cb
decl_stmt|;
name|free_cb
name|free_cb
decl_stmt|;
name|int
name|have_ucontext
decl_stmt|;
name|pid_t
name|pid
decl_stmt|;
name|lwpid_t
name|lwpid
decl_stmt|;
name|int
name|trace
decl_stmt|;
name|ucontext_t
name|ucontext
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|void
modifier|*
name|uwx_ttrace_memcpy
parameter_list|(
name|void
modifier|*
name|buffer
parameter_list|,
name|uint64_t
name|ptr
parameter_list|,
name|size_t
name|bufsiz
parameter_list|,
name|int
name|ident
parameter_list|)
block|{
name|uint64_t
modifier|*
name|dest
decl_stmt|;
name|uint64_t
name|val
decl_stmt|;
name|int
name|status
decl_stmt|;
name|status
operator|=
name|ttrace
argument_list|(
name|TT_PROC_RDDATA
argument_list|,
operator|(
name|pid_t
operator|)
name|ident
argument_list|,
literal|0
argument_list|,
name|ptr
argument_list|,
name|bufsiz
argument_list|,
operator|(
name|uint64_t
operator|)
name|buffer
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
literal|0
condition|)
return|return
name|NULL
return|;
return|return
name|buffer
return|;
block|}
end_function

begin_function
name|struct
name|uwx_ttrace_info
modifier|*
name|uwx_ttrace_init_info
parameter_list|(
name|struct
name|uwx_env
modifier|*
name|env
parameter_list|,
name|pid_t
name|pid
parameter_list|,
name|lwpid_t
name|lwpid
parameter_list|,
name|uint64_t
name|load_map
parameter_list|)
block|{
name|struct
name|uwx_ttrace_info
modifier|*
name|info
decl_stmt|;
if|if
condition|(
name|env
operator|->
name|allocate_cb
operator|==
literal|0
condition|)
name|info
operator|=
operator|(
expr|struct
name|uwx_ttrace_info
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|uwx_ttrace_info
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|info
operator|=
operator|(
expr|struct
name|uwx_ttrace_info
operator|*
operator|)
call|(
modifier|*
name|env
operator|->
name|allocate_cb
call|)
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|uwx_ttrace_info
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|info
operator|->
name|bspstore
operator|=
literal|0
expr_stmt|;
name|info
operator|->
name|load_map
operator|=
name|load_map
expr_stmt|;
name|info
operator|->
name|allocate_cb
operator|=
name|env
operator|->
name|allocate_cb
expr_stmt|;
name|info
operator|->
name|free_cb
operator|=
name|env
operator|->
name|free_cb
expr_stmt|;
name|info
operator|->
name|have_ucontext
operator|=
literal|0
expr_stmt|;
name|info
operator|->
name|pid
operator|=
name|pid
expr_stmt|;
name|info
operator|->
name|lwpid
operator|=
name|lwpid
expr_stmt|;
name|info
operator|->
name|trace
operator|=
name|env
operator|->
name|trace
expr_stmt|;
return|return
name|info
return|;
block|}
end_function

begin_function
name|int
name|uwx_ttrace_free_info
parameter_list|(
name|struct
name|uwx_ttrace_info
modifier|*
name|info
parameter_list|)
block|{
if|if
condition|(
name|info
operator|->
name|free_cb
operator|==
literal|0
condition|)
name|free
argument_list|(
operator|(
name|void
operator|*
operator|)
name|info
argument_list|)
expr_stmt|;
else|else
call|(
modifier|*
name|info
operator|->
name|free_cb
call|)
argument_list|(
operator|(
name|void
operator|*
operator|)
name|info
argument_list|)
expr_stmt|;
return|return
name|UWX_OK
return|;
block|}
end_function

begin_function
name|int
name|uwx_ttrace_init_context
parameter_list|(
name|struct
name|uwx_env
modifier|*
name|env
parameter_list|,
name|struct
name|uwx_ttrace_info
modifier|*
name|info
parameter_list|)
block|{
name|uint64_t
name|reason
decl_stmt|;
name|uint64_t
name|ip
decl_stmt|;
name|uint64_t
name|sp
decl_stmt|;
name|uint64_t
name|bsp
decl_stmt|;
name|uint64_t
name|cfm
decl_stmt|;
name|uint64_t
name|ec
decl_stmt|;
name|int
name|status
decl_stmt|;
name|status
operator|=
name|ttrace
argument_list|(
name|TT_LWP_RUREGS
argument_list|,
name|info
operator|->
name|pid
argument_list|,
name|info
operator|->
name|lwpid
argument_list|,
operator|(
name|uint64_t
operator|)
name|__reason
argument_list|,
operator|(
name|uint64_t
operator|)
literal|8
argument_list|,
operator|(
name|uint64_t
operator|)
operator|&
name|reason
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
literal|0
condition|)
return|return
name|UWX_TT_ERR_TTRACE
return|;
name|status
operator|=
name|ttrace
argument_list|(
name|TT_LWP_RUREGS
argument_list|,
name|info
operator|->
name|pid
argument_list|,
name|info
operator|->
name|lwpid
argument_list|,
operator|(
name|uint64_t
operator|)
name|__ip
argument_list|,
operator|(
name|uint64_t
operator|)
literal|8
argument_list|,
operator|(
name|uint64_t
operator|)
operator|&
name|ip
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
literal|0
condition|)
return|return
name|UWX_TT_ERR_TTRACE
return|;
name|status
operator|=
name|ttrace
argument_list|(
name|TT_LWP_RUREGS
argument_list|,
name|info
operator|->
name|pid
argument_list|,
name|info
operator|->
name|lwpid
argument_list|,
operator|(
name|uint64_t
operator|)
name|__r12
argument_list|,
operator|(
name|uint64_t
operator|)
literal|8
argument_list|,
operator|(
name|uint64_t
operator|)
operator|&
name|sp
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
literal|0
condition|)
return|return
name|UWX_TT_ERR_TTRACE
return|;
name|status
operator|=
name|ttrace
argument_list|(
name|TT_LWP_RUREGS
argument_list|,
name|info
operator|->
name|pid
argument_list|,
name|info
operator|->
name|lwpid
argument_list|,
operator|(
name|uint64_t
operator|)
name|__ar_bsp
argument_list|,
operator|(
name|uint64_t
operator|)
literal|8
argument_list|,
operator|(
name|uint64_t
operator|)
operator|&
name|bsp
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
literal|0
condition|)
return|return
name|UWX_TT_ERR_TTRACE
return|;
name|status
operator|=
name|ttrace
argument_list|(
name|TT_LWP_RUREGS
argument_list|,
name|info
operator|->
name|pid
argument_list|,
name|info
operator|->
name|lwpid
argument_list|,
operator|(
name|uint64_t
operator|)
name|__ar_bspstore
argument_list|,
operator|(
name|uint64_t
operator|)
literal|8
argument_list|,
operator|(
name|uint64_t
operator|)
operator|&
name|info
operator|->
name|bspstore
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
literal|0
condition|)
return|return
name|UWX_TT_ERR_TTRACE
return|;
name|status
operator|=
name|ttrace
argument_list|(
name|TT_LWP_RUREGS
argument_list|,
name|info
operator|->
name|pid
argument_list|,
name|info
operator|->
name|lwpid
argument_list|,
operator|(
name|uint64_t
operator|)
name|__cfm
argument_list|,
operator|(
name|uint64_t
operator|)
literal|8
argument_list|,
operator|(
name|uint64_t
operator|)
operator|&
name|cfm
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
literal|0
condition|)
return|return
name|UWX_TT_ERR_TTRACE
return|;
name|status
operator|=
name|ttrace
argument_list|(
name|TT_LWP_RUREGS
argument_list|,
name|info
operator|->
name|pid
argument_list|,
name|info
operator|->
name|lwpid
argument_list|,
operator|(
name|uint64_t
operator|)
name|__ar_ec
argument_list|,
operator|(
name|uint64_t
operator|)
literal|8
argument_list|,
operator|(
name|uint64_t
operator|)
operator|&
name|ec
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
literal|0
condition|)
return|return
name|UWX_TT_ERR_TTRACE
return|;
name|cfm
operator||=
name|ec
operator|<<
literal|52
expr_stmt|;
if|if
condition|(
name|reason
operator|!=
literal|0
condition|)
name|bsp
operator|=
name|uwx_add_to_bsp
argument_list|(
name|bsp
argument_list|,
operator|-
operator|(
operator|(
name|unsigned
name|int
operator|)
name|cfm
operator|&
literal|0x7f
operator|)
argument_list|)
expr_stmt|;
return|return
name|uwx_init_context
argument_list|(
name|env
argument_list|,
name|ip
argument_list|,
name|sp
argument_list|,
name|bsp
argument_list|,
name|cfm
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|uwx_ttrace_init_from_sigcontext
parameter_list|(
name|struct
name|uwx_env
modifier|*
name|env
parameter_list|,
name|struct
name|uwx_ttrace_info
modifier|*
name|info
parameter_list|,
name|uint64_t
name|ucontext
parameter_list|)
block|{
name|int
name|status
decl_stmt|;
name|uint16_t
name|reason
decl_stmt|;
name|uint64_t
name|ip
decl_stmt|;
name|uint64_t
name|sp
decl_stmt|;
name|uint64_t
name|bsp
decl_stmt|;
name|uint64_t
name|cfm
decl_stmt|;
name|unsigned
name|int
name|nat
decl_stmt|;
name|uint64_t
name|ec
decl_stmt|;
name|info
operator|->
name|have_ucontext
operator|=
literal|1
expr_stmt|;
name|uwx_ttrace_memcpy
argument_list|(
operator|&
name|info
operator|->
name|ucontext
argument_list|,
name|ucontext
argument_list|,
sizeof|sizeof
argument_list|(
name|__uc_misc_t
argument_list|)
argument_list|,
name|info
operator|->
name|pid
argument_list|)
expr_stmt|;
name|uwx_ttrace_memcpy
argument_list|(
operator|&
name|info
operator|->
name|ucontext
operator|.
name|__uc_mcontext
argument_list|,
operator|(
name|uint64_t
operator|)
operator|&
operator|(
operator|(
name|ucontext_t
operator|*
operator|)
name|ucontext
operator|)
operator|->
name|__uc_mcontext
argument_list|,
sizeof|sizeof
argument_list|(
name|mcontext_t
argument_list|)
argument_list|,
name|info
operator|->
name|pid
argument_list|)
expr_stmt|;
name|status
operator|=
name|__uc_get_reason
argument_list|(
operator|&
name|info
operator|->
name|ucontext
argument_list|,
operator|&
name|reason
argument_list|)
expr_stmt|;
name|status
operator|=
name|__uc_get_ip
argument_list|(
operator|&
name|info
operator|->
name|ucontext
argument_list|,
operator|&
name|ip
argument_list|)
expr_stmt|;
name|status
operator|=
name|__uc_get_grs
argument_list|(
operator|&
name|info
operator|->
name|ucontext
argument_list|,
literal|12
argument_list|,
literal|1
argument_list|,
operator|&
name|sp
argument_list|,
operator|&
name|nat
argument_list|)
expr_stmt|;
name|status
operator|=
name|__uc_get_ar
argument_list|(
operator|&
name|info
operator|->
name|ucontext
argument_list|,
literal|17
argument_list|,
operator|&
name|bsp
argument_list|)
expr_stmt|;
name|status
operator|=
name|__uc_get_ar
argument_list|(
operator|&
name|info
operator|->
name|ucontext
argument_list|,
literal|18
argument_list|,
operator|&
name|info
operator|->
name|bspstore
argument_list|)
expr_stmt|;
name|status
operator|=
name|__uc_get_ar
argument_list|(
operator|&
name|info
operator|->
name|ucontext
argument_list|,
literal|66
argument_list|,
operator|&
name|ec
argument_list|)
expr_stmt|;
name|status
operator|=
name|__uc_get_cfm
argument_list|(
operator|&
name|info
operator|->
name|ucontext
argument_list|,
operator|&
name|cfm
argument_list|)
expr_stmt|;
name|cfm
operator||=
name|ec
operator|<<
literal|52
expr_stmt|;
if|if
condition|(
name|reason
operator|!=
literal|0
condition|)
name|bsp
operator|=
name|uwx_add_to_bsp
argument_list|(
name|bsp
argument_list|,
operator|-
operator|(
operator|(
name|unsigned
name|int
operator|)
name|cfm
operator|&
literal|0x7f
operator|)
argument_list|)
expr_stmt|;
name|uwx_init_context
argument_list|(
name|env
argument_list|,
name|ip
argument_list|,
name|sp
argument_list|,
name|bsp
argument_list|,
name|cfm
argument_list|)
expr_stmt|;
return|return
name|UWX_OK
return|;
block|}
end_function

begin_function
name|int
name|uwx_ttrace_do_context_frame
parameter_list|(
name|struct
name|uwx_env
modifier|*
name|env
parameter_list|,
name|struct
name|uwx_ttrace_info
modifier|*
name|info
parameter_list|)
block|{
name|int
name|abi_context
decl_stmt|;
name|int
name|status
decl_stmt|;
name|uint64_t
name|ucontext
decl_stmt|;
name|abi_context
operator|=
name|uwx_get_abi_context_code
argument_list|(
name|env
argument_list|)
expr_stmt|;
if|if
condition|(
name|abi_context
operator|!=
literal|0x0101
condition|)
comment|/* abi = HP-UX, context = 1 */
return|return
name|UWX_TT_ERR_BADABICONTEXT
return|;
name|status
operator|=
name|uwx_get_reg
argument_list|(
name|env
argument_list|,
name|UWX_REG_GR
argument_list|(
literal|32
argument_list|)
argument_list|,
operator|&
name|ucontext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
literal|0
condition|)
return|return
name|status
return|;
return|return
name|uwx_ttrace_init_from_sigcontext
argument_list|(
name|env
argument_list|,
name|info
argument_list|,
name|ucontext
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|uwx_ttrace_copyin
parameter_list|(
name|int
name|request
parameter_list|,
name|char
modifier|*
name|loc
parameter_list|,
name|uint64_t
name|rem
parameter_list|,
name|int
name|len
parameter_list|,
name|intptr_t
name|tok
parameter_list|)
block|{
name|int
name|status
decl_stmt|;
name|int
name|regid
decl_stmt|;
name|unsigned
name|int
name|nat
decl_stmt|;
name|struct
name|uwx_ttrace_info
modifier|*
name|info
init|=
operator|(
expr|struct
name|uwx_ttrace_info
operator|*
operator|)
name|tok
decl_stmt|;
name|unsigned
name|long
modifier|*
name|wp
decl_stmt|;
name|uint64_t
modifier|*
name|dp
decl_stmt|;
name|int
name|ttreg
decl_stmt|;
name|dp
operator|=
operator|(
name|uint64_t
operator|*
operator|)
name|loc
expr_stmt|;
if|if
condition|(
name|request
operator|==
name|UWX_COPYIN_UINFO
condition|)
block|{
if|if
condition|(
name|len
operator|==
literal|4
condition|)
block|{
name|status
operator|=
name|ttrace
argument_list|(
name|TT_PROC_RDTEXT
argument_list|,
name|info
operator|->
name|pid
argument_list|,
literal|0
argument_list|,
name|rem
argument_list|,
literal|4
argument_list|,
operator|(
name|uint64_t
operator|)
name|loc
argument_list|)
expr_stmt|;
name|wp
operator|=
operator|(
name|unsigned
name|long
operator|*
operator|)
name|loc
expr_stmt|;
name|TRACE_SELF_COPYIN4
argument_list|(
argument|rem
argument_list|,
argument|len
argument_list|,
argument|wp
argument_list|)
block|}
elseif|else
if|if
condition|(
name|len
operator|==
literal|8
condition|)
block|{
name|status
operator|=
name|ttrace
argument_list|(
name|TT_PROC_RDTEXT
argument_list|,
name|info
operator|->
name|pid
argument_list|,
literal|0
argument_list|,
name|rem
argument_list|,
literal|8
argument_list|,
operator|(
name|uint64_t
operator|)
name|loc
argument_list|)
expr_stmt|;
name|TRACE_SELF_COPYIN4
argument_list|(
argument|rem
argument_list|,
argument|len
argument_list|,
argument|dp
argument_list|)
block|}
else|else
return|return
literal|0
return|;
block|}
elseif|else
if|if
condition|(
name|request
operator|==
name|UWX_COPYIN_MSTACK
operator|&&
name|len
operator|==
literal|8
condition|)
block|{
name|status
operator|=
name|ttrace
argument_list|(
name|TT_PROC_RDDATA
argument_list|,
name|info
operator|->
name|pid
argument_list|,
literal|0
argument_list|,
name|rem
argument_list|,
literal|8
argument_list|,
operator|(
name|uint64_t
operator|)
name|loc
argument_list|)
expr_stmt|;
name|TRACE_SELF_COPYIN4
argument_list|(
argument|rem
argument_list|,
argument|len
argument_list|,
argument|dp
argument_list|)
block|}
elseif|else
if|if
condition|(
name|request
operator|==
name|UWX_COPYIN_RSTACK
operator|&&
name|len
operator|==
literal|8
condition|)
block|{
if|if
condition|(
name|info
operator|->
name|have_ucontext
operator|==
literal|0
operator|||
name|rem
operator|<
name|info
operator|->
name|bspstore
condition|)
block|{
name|status
operator|=
name|ttrace
argument_list|(
name|TT_PROC_RDDATA
argument_list|,
name|info
operator|->
name|pid
argument_list|,
literal|0
argument_list|,
name|rem
argument_list|,
literal|8
argument_list|,
operator|(
name|uint64_t
operator|)
name|loc
argument_list|)
expr_stmt|;
name|TRACE_SELF_COPYIN4
argument_list|(
argument|rem
argument_list|,
argument|len
argument_list|,
argument|dp
argument_list|)
block|}
else|else
block|{
name|status
operator|=
name|__uc_get_rsebs
argument_list|(
operator|&
name|info
operator|->
name|ucontext
argument_list|,
operator|(
name|uint64_t
operator|*
operator|)
name|rem
argument_list|,
literal|1
argument_list|,
name|dp
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|request
operator|==
name|UWX_COPYIN_REG
operator|&&
name|len
operator|==
literal|8
condition|)
block|{
name|regid
operator|=
operator|(
name|int
operator|)
name|rem
expr_stmt|;
if|if
condition|(
name|info
operator|->
name|have_ucontext
condition|)
block|{
if|if
condition|(
name|regid
operator|<
name|UWX_REG_GR
argument_list|(
literal|0
argument_list|)
condition|)
block|{
switch|switch
condition|(
name|regid
condition|)
block|{
case|case
name|UWX_REG_PFS
case|:
name|status
operator|=
name|__uc_get_ar
argument_list|(
operator|&
name|info
operator|->
name|ucontext
argument_list|,
literal|64
argument_list|,
name|dp
argument_list|)
expr_stmt|;
break|break;
case|case
name|UWX_REG_PREDS
case|:
name|status
operator|=
name|__uc_get_prs
argument_list|(
operator|&
name|info
operator|->
name|ucontext
argument_list|,
name|dp
argument_list|)
expr_stmt|;
break|break;
case|case
name|UWX_REG_RNAT
case|:
name|status
operator|=
name|__uc_get_ar
argument_list|(
operator|&
name|info
operator|->
name|ucontext
argument_list|,
literal|19
argument_list|,
name|dp
argument_list|)
expr_stmt|;
break|break;
case|case
name|UWX_REG_UNAT
case|:
name|status
operator|=
name|__uc_get_ar
argument_list|(
operator|&
name|info
operator|->
name|ucontext
argument_list|,
literal|36
argument_list|,
name|dp
argument_list|)
expr_stmt|;
break|break;
case|case
name|UWX_REG_FPSR
case|:
name|status
operator|=
name|__uc_get_ar
argument_list|(
operator|&
name|info
operator|->
name|ucontext
argument_list|,
literal|40
argument_list|,
name|dp
argument_list|)
expr_stmt|;
break|break;
case|case
name|UWX_REG_LC
case|:
name|status
operator|=
name|__uc_get_ar
argument_list|(
operator|&
name|info
operator|->
name|ucontext
argument_list|,
literal|65
argument_list|,
name|dp
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
literal|0
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|regid
operator|>=
name|UWX_REG_GR
argument_list|(
literal|1
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_GR
argument_list|(
literal|31
argument_list|)
condition|)
block|{
name|status
operator|=
name|__uc_get_grs
argument_list|(
operator|&
name|info
operator|->
name|ucontext
argument_list|,
name|regid
operator|-
name|UWX_REG_GR
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|1
argument_list|,
name|dp
argument_list|,
operator|&
name|nat
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|regid
operator|>=
name|UWX_REG_BR
argument_list|(
literal|0
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_BR
argument_list|(
literal|7
argument_list|)
condition|)
block|{
name|status
operator|=
name|__uc_get_brs
argument_list|(
operator|&
name|info
operator|->
name|ucontext
argument_list|,
name|regid
operator|-
name|UWX_REG_BR
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|1
argument_list|,
name|dp
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|regid
operator|<
name|UWX_REG_GR
argument_list|(
literal|0
argument_list|)
condition|)
block|{
switch|switch
condition|(
name|regid
condition|)
block|{
case|case
name|UWX_REG_PFS
case|:
name|ttreg
operator|=
name|__ar_pfs
expr_stmt|;
break|break;
case|case
name|UWX_REG_PREDS
case|:
name|ttreg
operator|=
name|__pr
expr_stmt|;
break|break;
case|case
name|UWX_REG_RNAT
case|:
name|ttreg
operator|=
name|__ar_rnat
expr_stmt|;
break|break;
case|case
name|UWX_REG_UNAT
case|:
name|ttreg
operator|=
name|__ar_unat
expr_stmt|;
break|break;
case|case
name|UWX_REG_FPSR
case|:
name|ttreg
operator|=
name|__ar_fpsr
expr_stmt|;
break|break;
case|case
name|UWX_REG_LC
case|:
name|ttreg
operator|=
name|__ar_lc
expr_stmt|;
break|break;
default|default:
return|return
literal|0
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|regid
operator|>=
name|UWX_REG_GR
argument_list|(
literal|1
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_GR
argument_list|(
literal|31
argument_list|)
condition|)
block|{
name|ttreg
operator|=
name|regid
operator|-
name|UWX_REG_GR
argument_list|(
literal|1
argument_list|)
operator|+
name|__r1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|regid
operator|>=
name|UWX_REG_BR
argument_list|(
literal|0
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_BR
argument_list|(
literal|7
argument_list|)
condition|)
block|{
name|ttreg
operator|=
name|regid
operator|-
name|UWX_REG_BR
argument_list|(
literal|0
argument_list|)
operator|+
name|__b0
expr_stmt|;
block|}
else|else
return|return
literal|0
return|;
name|status
operator|==
name|ttrace
argument_list|(
name|TT_LWP_RUREGS
argument_list|,
name|info
operator|->
name|pid
argument_list|,
name|info
operator|->
name|lwpid
argument_list|,
name|ttreg
argument_list|,
literal|8
argument_list|,
operator|(
name|uint64_t
operator|)
name|loc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
block|}
return|return
name|len
return|;
block|}
end_function

begin_function
name|int
name|uwx_ttrace_lookupip
parameter_list|(
name|int
name|request
parameter_list|,
name|uint64_t
name|ip
parameter_list|,
name|intptr_t
name|tok
parameter_list|,
name|uint64_t
modifier|*
modifier|*
name|resultp
parameter_list|)
block|{
name|struct
name|uwx_ttrace_info
modifier|*
name|info
init|=
operator|(
expr|struct
name|uwx_ttrace_info
operator|*
operator|)
name|tok
decl_stmt|;
name|UINT64
name|handle
decl_stmt|;
name|struct
name|load_module_desc
name|desc
decl_stmt|;
name|uint64_t
modifier|*
name|unwind_base
decl_stmt|;
name|uint64_t
modifier|*
name|rvec
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|request
operator|==
name|UWX_LKUP_LOOKUP
condition|)
block|{
name|TRACE_SELF_LOOKUP
argument_list|(
argument|ip
argument_list|)
name|handle
operator|=
name|dlmodinfo
argument_list|(
operator|(
name|unsigned
name|long
operator|)
name|ip
argument_list|,
operator|&
name|desc
argument_list|,
sizeof|sizeof
argument_list|(
name|desc
argument_list|)
argument_list|,
name|uwx_ttrace_memcpy
argument_list|,
name|info
operator|->
name|pid
argument_list|,
name|info
operator|->
name|load_map
argument_list|)
expr_stmt|;
if|if
condition|(
name|handle
operator|==
literal|0
condition|)
return|return
name|UWX_LKUP_ERR
return|;
name|unwind_base
operator|=
operator|(
name|uint64_t
operator|*
operator|)
name|desc
operator|.
name|unwind_base
expr_stmt|;
name|TRACE_SELF_LOOKUP_DESC
argument_list|(
argument|desc.text_base
argument_list|,
argument|unwind_base
argument_list|)
name|i
operator|=
literal|0
expr_stmt|;
name|rvec
operator|=
name|info
operator|->
name|rvec
expr_stmt|;
name|rvec
index|[
name|i
operator|++
index|]
operator|=
name|UWX_KEY_TBASE
expr_stmt|;
name|rvec
index|[
name|i
operator|++
index|]
operator|=
name|desc
operator|.
name|text_base
expr_stmt|;
name|rvec
index|[
name|i
operator|++
index|]
operator|=
name|UWX_KEY_UFLAGS
expr_stmt|;
name|rvec
index|[
name|i
operator|++
index|]
operator|=
name|unwind_base
index|[
literal|0
index|]
expr_stmt|;
name|rvec
index|[
name|i
operator|++
index|]
operator|=
name|UWX_KEY_USTART
expr_stmt|;
name|rvec
index|[
name|i
operator|++
index|]
operator|=
name|desc
operator|.
name|text_base
operator|+
name|unwind_base
index|[
literal|1
index|]
expr_stmt|;
name|rvec
index|[
name|i
operator|++
index|]
operator|=
name|UWX_KEY_UEND
expr_stmt|;
name|rvec
index|[
name|i
operator|++
index|]
operator|=
name|desc
operator|.
name|text_base
operator|+
name|unwind_base
index|[
literal|2
index|]
expr_stmt|;
name|rvec
index|[
name|i
operator|++
index|]
operator|=
literal|0
expr_stmt|;
name|rvec
index|[
name|i
operator|++
index|]
operator|=
literal|0
expr_stmt|;
operator|*
name|resultp
operator|=
name|rvec
expr_stmt|;
return|return
name|UWX_LKUP_UTABLE
return|;
block|}
elseif|else
if|if
condition|(
name|request
operator|==
name|UWX_LKUP_FREE
condition|)
block|{
return|return
literal|0
return|;
block|}
block|}
end_function

end_unit


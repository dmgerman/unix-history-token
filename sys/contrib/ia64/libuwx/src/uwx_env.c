begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (c) 2003 Hewlett-Packard Development Company, L.P. Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:  The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|_KERNEL
end_ifndef

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"uwx_env.h"
end_include

begin_include
include|#
directive|include
file|"uwx_scoreboard.h"
end_include

begin_include
include|#
directive|include
file|"uwx_str.h"
end_include

begin_include
include|#
directive|include
file|"uwx_trace.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|_KERNEL
end_ifdef

begin_decl_stmt
specifier|static
name|struct
name|uwx_env
name|uwx_env
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|free
parameter_list|(
name|p
parameter_list|)
end_define

begin_comment
comment|/* nullified */
end_comment

begin_define
define|#
directive|define
name|malloc
parameter_list|(
name|sz
parameter_list|)
value|((sz == sizeof(uwx_env)) ?&uwx_env : NULL)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|alloc_cb
name|uwx_allocate_cb
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|free_cb
name|uwx_free_cb
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|uwx_register_alloc_cb
parameter_list|(
name|alloc_cb
name|alloc
parameter_list|,
name|free_cb
name|free
parameter_list|)
block|{
name|uwx_allocate_cb
operator|=
name|alloc
expr_stmt|;
name|uwx_free_cb
operator|=
name|free
expr_stmt|;
return|return
name|UWX_OK
return|;
block|}
end_function

begin_function
name|int
name|uwx_init_history
parameter_list|(
name|struct
name|uwx_env
modifier|*
name|env
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|env
operator|==
literal|0
condition|)
return|return
name|UWX_ERR_NOENV
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NSPECIALREG
condition|;
name|i
operator|++
control|)
name|env
operator|->
name|history
operator|.
name|special
index|[
name|i
index|]
operator|=
name|UWX_DISP_REG
argument_list|(
name|i
argument_list|)
expr_stmt|;
empty_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NPRESERVEDGR
condition|;
name|i
operator|++
control|)
name|env
operator|->
name|history
operator|.
name|gr
index|[
name|i
index|]
operator|=
name|UWX_DISP_REG
argument_list|(
name|UWX_REG_GR
argument_list|(
literal|4
operator|+
name|i
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NPRESERVEDBR
condition|;
name|i
operator|++
control|)
name|env
operator|->
name|history
operator|.
name|br
index|[
name|i
index|]
operator|=
name|UWX_DISP_REG
argument_list|(
name|UWX_REG_BR
argument_list|(
literal|1
operator|+
name|i
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|env
operator|->
name|history
operator|.
name|fr
index|[
name|i
index|]
operator|=
name|UWX_DISP_REG
argument_list|(
name|UWX_REG_FR
argument_list|(
literal|2
operator|+
name|i
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|i
operator|<
name|NPRESERVEDFR
condition|;
name|i
operator|++
control|)
name|env
operator|->
name|history
operator|.
name|fr
index|[
name|i
index|]
operator|=
name|UWX_DISP_REG
argument_list|(
name|UWX_REG_FR
argument_list|(
literal|12
operator|+
name|i
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|UWX_OK
return|;
block|}
end_function

begin_function
name|struct
name|uwx_env
modifier|*
name|uwx_init
parameter_list|()
block|{
name|int
name|i
decl_stmt|;
name|struct
name|uwx_env
modifier|*
name|env
decl_stmt|;
if|if
condition|(
name|uwx_allocate_cb
operator|==
literal|0
condition|)
name|env
operator|=
operator|(
expr|struct
name|uwx_env
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|uwx_env
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|env
operator|=
operator|(
expr|struct
name|uwx_env
operator|*
operator|)
call|(
modifier|*
name|uwx_allocate_cb
call|)
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|uwx_env
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|env
operator|!=
literal|0
condition|)
block|{
name|env
operator|->
name|context
operator|.
name|valid_regs
operator|=
literal|0
expr_stmt|;
name|env
operator|->
name|context
operator|.
name|valid_frs
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NSPECIALREG
condition|;
name|i
operator|++
control|)
name|env
operator|->
name|context
operator|.
name|special
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NPRESERVEDGR
condition|;
name|i
operator|++
control|)
name|env
operator|->
name|context
operator|.
name|gr
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NPRESERVEDBR
condition|;
name|i
operator|++
control|)
name|env
operator|->
name|context
operator|.
name|br
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NPRESERVEDFR
condition|;
name|i
operator|++
control|)
block|{
name|env
operator|->
name|context
operator|.
name|fr
index|[
name|i
index|]
operator|.
name|part0
operator|=
literal|0
expr_stmt|;
name|env
operator|->
name|context
operator|.
name|fr
index|[
name|i
index|]
operator|.
name|part1
operator|=
literal|0
expr_stmt|;
block|}
name|env
operator|->
name|rstate
operator|=
literal|0
expr_stmt|;
name|env
operator|->
name|remapped_ip
operator|=
literal|0
expr_stmt|;
name|env
operator|->
name|function_offset
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|uwx_init_history
argument_list|(
name|env
argument_list|)
expr_stmt|;
name|env
operator|->
name|allocate_cb
operator|=
name|uwx_allocate_cb
expr_stmt|;
name|env
operator|->
name|free_cb
operator|=
name|uwx_free_cb
expr_stmt|;
name|env
operator|->
name|free_scoreboards
operator|=
literal|0
expr_stmt|;
name|env
operator|->
name|used_scoreboards
operator|=
literal|0
expr_stmt|;
name|env
operator|->
name|labeled_scoreboards
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|uwx_init_str_pool
argument_list|(
name|env
argument_list|)
expr_stmt|;
name|env
operator|->
name|module_name
operator|=
literal|0
expr_stmt|;
name|env
operator|->
name|function_name
operator|=
literal|0
expr_stmt|;
name|env
operator|->
name|cb_token
operator|=
literal|0
expr_stmt|;
name|env
operator|->
name|copyin
operator|=
literal|0
expr_stmt|;
name|env
operator|->
name|lookupip
operator|=
literal|0
expr_stmt|;
name|env
operator|->
name|remote
operator|=
literal|0
expr_stmt|;
name|env
operator|->
name|byte_swap
operator|=
literal|0
expr_stmt|;
name|env
operator|->
name|abi_context
operator|=
literal|0
expr_stmt|;
name|env
operator|->
name|nsbreg
operator|=
name|NSBREG_NOFR
expr_stmt|;
name|env
operator|->
name|nscoreboards
operator|=
literal|0
expr_stmt|;
name|env
operator|->
name|trace
operator|=
literal|0
expr_stmt|;
name|TRACE_INIT
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NSCOREBOARDS
condition|;
name|i
operator|++
control|)
operator|(
name|void
operator|)
name|uwx_alloc_scoreboard
argument_list|(
name|env
argument_list|)
expr_stmt|;
block|}
return|return
name|env
return|;
block|}
end_function

begin_function
name|int
name|uwx_set_remote
parameter_list|(
name|struct
name|uwx_env
modifier|*
name|env
parameter_list|,
name|int
name|is_big_endian_target
parameter_list|)
block|{
name|int
name|is_big_endian_host
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
if|if
condition|(
name|env
operator|==
literal|0
condition|)
return|return
name|UWX_ERR_NOENV
return|;
name|env
operator|->
name|remote
operator|=
literal|1
expr_stmt|;
name|is_big_endian_host
operator|=
literal|1
expr_stmt|;
name|p
operator|=
operator|(
name|char
operator|*
operator|)
operator|&
name|is_big_endian_host
expr_stmt|;
operator|*
name|p
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|is_big_endian_target
operator|==
name|is_big_endian_host
condition|)
name|env
operator|->
name|byte_swap
operator|=
literal|0
expr_stmt|;
else|else
name|env
operator|->
name|byte_swap
operator|=
literal|1
expr_stmt|;
return|return
name|UWX_OK
return|;
block|}
end_function

begin_function
name|int
name|uwx_register_callbacks
parameter_list|(
name|struct
name|uwx_env
modifier|*
name|env
parameter_list|,
name|intptr_t
name|tok
parameter_list|,
name|copyin_cb
name|copyin
parameter_list|,
name|lookupip_cb
name|lookupip
parameter_list|)
block|{
if|if
condition|(
name|env
operator|==
literal|0
condition|)
return|return
name|UWX_ERR_NOENV
return|;
name|env
operator|->
name|cb_token
operator|=
name|tok
expr_stmt|;
name|env
operator|->
name|copyin
operator|=
name|copyin
expr_stmt|;
name|env
operator|->
name|lookupip
operator|=
name|lookupip
expr_stmt|;
return|return
name|UWX_OK
return|;
block|}
end_function

begin_function
name|int
name|uwx_get_abi_context_code
parameter_list|(
name|struct
name|uwx_env
modifier|*
name|env
parameter_list|)
block|{
if|if
condition|(
name|env
operator|==
literal|0
condition|)
return|return
name|UWX_ERR_NOENV
return|;
return|return
name|env
operator|->
name|abi_context
return|;
block|}
end_function

begin_function
name|int
name|uwx_free
parameter_list|(
name|struct
name|uwx_env
modifier|*
name|env
parameter_list|)
block|{
if|if
condition|(
name|env
operator|!=
literal|0
condition|)
block|{
name|uwx_free_scoreboards
argument_list|(
name|env
argument_list|)
expr_stmt|;
name|uwx_free_str_pool
argument_list|(
name|env
argument_list|)
expr_stmt|;
if|if
condition|(
name|env
operator|->
name|free_cb
operator|==
literal|0
condition|)
name|free
argument_list|(
operator|(
name|void
operator|*
operator|)
name|env
argument_list|)
expr_stmt|;
else|else
call|(
modifier|*
name|env
operator|->
name|free_cb
call|)
argument_list|(
operator|(
name|void
operator|*
operator|)
name|env
argument_list|)
expr_stmt|;
block|}
return|return
name|UWX_OK
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (c) 2003 Hewlett-Packard Development Company, L.P. Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:  The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<crt0.h>
end_include

begin_include
include|#
directive|include
file|<dlfcn.h>
end_include

begin_include
include|#
directive|include
file|<sys/uc_access.h>
end_include

begin_include
include|#
directive|include
file|"uwx_env.h"
end_include

begin_include
include|#
directive|include
file|"uwx_context.h"
end_include

begin_include
include|#
directive|include
file|"uwx_trace.h"
end_include

begin_include
include|#
directive|include
file|"uwx_self.h"
end_include

begin_define
define|#
directive|define
name|MODULE_CACHE_SIZE
value|10
end_define

begin_define
define|#
directive|define
name|UWX_ABI_HPUX_SIGCONTEXT
value|0x0101
end_define

begin_comment
comment|/* abi = HP-UX, context = 1 */
end_comment

begin_struct
struct|struct
name|uwx_self_module_info
block|{
name|uint64_t
name|text_base
decl_stmt|;
name|uint64_t
name|text_size
decl_stmt|;
name|uint64_t
modifier|*
name|unwind_base
decl_stmt|;
name|uint64_t
name|last_access
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|struct
name|uwx_self_module_info
modifier|*
name|next
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|uwx_self_info
block|{
name|struct
name|uwx_env
modifier|*
name|env
decl_stmt|;
name|ucontext_t
modifier|*
name|ucontext
decl_stmt|;
name|uint64_t
name|bspstore
decl_stmt|;
name|uint64_t
name|rvec
index|[
literal|10
index|]
decl_stmt|;
name|uint64_t
name|sendsig_start
decl_stmt|;
name|uint64_t
name|sendsig_end
decl_stmt|;
name|alloc_cb
name|allocate_cb
decl_stmt|;
name|free_cb
name|free_cb
decl_stmt|;
name|int
name|trace
decl_stmt|;
name|struct
name|load_module_desc
name|desc
decl_stmt|;
name|struct
name|uwx_self_module_info
modifier|*
name|module_cache
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|struct
name|uwx_self_info
modifier|*
name|uwx_self_init_info
parameter_list|(
name|struct
name|uwx_env
modifier|*
name|env
parameter_list|)
block|{
name|struct
name|uwx_self_info
modifier|*
name|info
decl_stmt|;
name|struct
name|uwx_self_module_info
modifier|*
name|modules
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|size
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|uwx_self_info
argument_list|)
operator|+
name|MODULE_CACHE_SIZE
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|uwx_self_module_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|env
operator|->
name|allocate_cb
operator|==
literal|0
condition|)
name|info
operator|=
operator|(
expr|struct
name|uwx_self_info
operator|*
operator|)
name|malloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
else|else
name|info
operator|=
operator|(
expr|struct
name|uwx_self_info
operator|*
operator|)
call|(
modifier|*
name|env
operator|->
name|allocate_cb
call|)
argument_list|(
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|modules
operator|=
operator|(
expr|struct
name|uwx_self_module_info
operator|*
operator|)
operator|(
name|info
operator|+
literal|1
operator|)
expr_stmt|;
name|info
operator|->
name|env
operator|=
name|env
expr_stmt|;
name|info
operator|->
name|ucontext
operator|=
literal|0
expr_stmt|;
name|info
operator|->
name|bspstore
operator|=
literal|0
expr_stmt|;
name|info
operator|->
name|sendsig_start
operator|=
name|__load_info
operator|->
name|li_sendsig_txt
expr_stmt|;
name|info
operator|->
name|sendsig_end
operator|=
name|__load_info
operator|->
name|li_sendsig_txt
operator|+
name|__load_info
operator|->
name|li_sendsig_tsz
expr_stmt|;
name|info
operator|->
name|allocate_cb
operator|=
name|env
operator|->
name|allocate_cb
expr_stmt|;
name|info
operator|->
name|free_cb
operator|=
name|env
operator|->
name|free_cb
expr_stmt|;
name|info
operator|->
name|trace
operator|=
name|env
operator|->
name|trace
expr_stmt|;
name|info
operator|->
name|module_cache
operator|=
name|modules
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MODULE_CACHE_SIZE
condition|;
name|i
operator|++
control|)
block|{
name|modules
index|[
name|i
index|]
operator|.
name|text_base
operator|=
literal|0
expr_stmt|;
name|modules
index|[
name|i
index|]
operator|.
name|text_size
operator|=
literal|0
expr_stmt|;
name|modules
index|[
name|i
index|]
operator|.
name|unwind_base
operator|=
literal|0
expr_stmt|;
name|modules
index|[
name|i
index|]
operator|.
name|last_access
operator|=
literal|0
expr_stmt|;
name|modules
index|[
name|i
index|]
operator|.
name|name
operator|=
literal|0
expr_stmt|;
name|modules
index|[
name|i
index|]
operator|.
name|next
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|info
return|;
block|}
end_function

begin_function
name|int
name|uwx_self_free_info
parameter_list|(
name|struct
name|uwx_self_info
modifier|*
name|info
parameter_list|)
block|{
if|if
condition|(
name|info
operator|->
name|free_cb
operator|==
literal|0
condition|)
name|free
argument_list|(
operator|(
name|void
operator|*
operator|)
name|info
argument_list|)
expr_stmt|;
else|else
call|(
modifier|*
name|info
operator|->
name|free_cb
call|)
argument_list|(
operator|(
name|void
operator|*
operator|)
name|info
argument_list|)
expr_stmt|;
return|return
name|UWX_OK
return|;
block|}
end_function

begin_function
name|int
name|uwx_self_init_from_sigcontext
parameter_list|(
name|struct
name|uwx_env
modifier|*
name|env
parameter_list|,
name|struct
name|uwx_self_info
modifier|*
name|info
parameter_list|,
name|ucontext_t
modifier|*
name|ucontext
parameter_list|)
block|{
name|int
name|status
decl_stmt|;
name|uint16_t
name|reason
decl_stmt|;
name|uint64_t
name|ip
decl_stmt|;
name|uint64_t
name|sp
decl_stmt|;
name|uint64_t
name|bsp
decl_stmt|;
name|uint64_t
name|cfm
decl_stmt|;
name|unsigned
name|int
name|nat
decl_stmt|;
name|uint64_t
name|ec
decl_stmt|;
name|int
name|adj
decl_stmt|;
name|info
operator|->
name|ucontext
operator|=
name|ucontext
expr_stmt|;
name|status
operator|=
name|__uc_get_reason
argument_list|(
name|ucontext
argument_list|,
operator|&
name|reason
argument_list|)
expr_stmt|;
name|status
operator|=
name|__uc_get_ip
argument_list|(
name|ucontext
argument_list|,
operator|&
name|ip
argument_list|)
expr_stmt|;
name|status
operator|=
name|__uc_get_grs
argument_list|(
name|ucontext
argument_list|,
literal|12
argument_list|,
literal|1
argument_list|,
operator|&
name|sp
argument_list|,
operator|&
name|nat
argument_list|)
expr_stmt|;
name|status
operator|=
name|__uc_get_cfm
argument_list|(
name|ucontext
argument_list|,
operator|&
name|cfm
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NEW_UC_GET_AR
name|status
operator|=
name|__uc_get_ar_bsp
argument_list|(
name|ucontext
argument_list|,
operator|&
name|bsp
argument_list|)
expr_stmt|;
name|status
operator|=
name|__uc_get_ar_bspstore
argument_list|(
name|ucontext
argument_list|,
operator|&
name|info
operator|->
name|bspstore
argument_list|)
expr_stmt|;
name|status
operator|=
name|__uc_get_ar_ec
argument_list|(
name|ucontext
argument_list|,
operator|&
name|ec
argument_list|)
expr_stmt|;
else|#
directive|else
name|status
operator|=
name|__uc_get_ar
argument_list|(
name|ucontext
argument_list|,
literal|17
argument_list|,
operator|&
name|bsp
argument_list|)
expr_stmt|;
name|status
operator|=
name|__uc_get_ar
argument_list|(
name|ucontext
argument_list|,
literal|18
argument_list|,
operator|&
name|info
operator|->
name|bspstore
argument_list|)
expr_stmt|;
name|status
operator|=
name|__uc_get_ar
argument_list|(
name|ucontext
argument_list|,
literal|66
argument_list|,
operator|&
name|ec
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* The returned bsp needs to be adjusted. */
comment|/* For interrupt frames, where bsp was advanced by a cover */
comment|/* instruction, subtract sof (size of frame). For non-interrupt */
comment|/* frames, where bsp was advanced by br.call, subtract sol */
comment|/* (size of locals). */
if|if
condition|(
name|reason
operator|!=
literal|0
condition|)
name|adj
operator|=
operator|(
name|unsigned
name|int
operator|)
name|cfm
operator|&
literal|0x7f
expr_stmt|;
comment|/* interrupt frame */
else|else
name|adj
operator|=
operator|(
operator|(
name|unsigned
name|int
operator|)
name|cfm
operator|>>
literal|7
operator|)
operator|&
literal|0x7f
expr_stmt|;
comment|/* non-interrupt frame */
name|bsp
operator|=
name|uwx_add_to_bsp
argument_list|(
name|bsp
argument_list|,
operator|-
name|adj
argument_list|)
expr_stmt|;
name|cfm
operator||=
name|ec
operator|<<
literal|52
expr_stmt|;
name|uwx_init_context
argument_list|(
name|env
argument_list|,
name|ip
argument_list|,
name|sp
argument_list|,
name|bsp
argument_list|,
name|cfm
argument_list|)
expr_stmt|;
return|return
name|UWX_OK
return|;
block|}
end_function

begin_function
name|int
name|uwx_self_do_context_frame
parameter_list|(
name|struct
name|uwx_env
modifier|*
name|env
parameter_list|,
name|struct
name|uwx_self_info
modifier|*
name|info
parameter_list|)
block|{
name|int
name|abi_context
decl_stmt|;
name|int
name|status
decl_stmt|;
name|uint64_t
name|ucontext
decl_stmt|;
name|abi_context
operator|=
name|uwx_get_abi_context_code
argument_list|(
name|env
argument_list|)
expr_stmt|;
if|if
condition|(
name|abi_context
operator|!=
name|UWX_ABI_HPUX_SIGCONTEXT
condition|)
return|return
name|UWX_SELF_ERR_BADABICONTEXT
return|;
name|status
operator|=
name|uwx_get_reg
argument_list|(
name|env
argument_list|,
name|UWX_REG_GR
argument_list|(
literal|32
argument_list|)
argument_list|,
operator|(
name|uint64_t
operator|*
operator|)
operator|&
name|ucontext
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
literal|0
condition|)
return|return
name|status
return|;
return|return
name|uwx_self_init_from_sigcontext
argument_list|(
name|env
argument_list|,
name|info
argument_list|,
operator|(
name|ucontext_t
operator|*
operator|)
name|ucontext
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|uwx_self_copyin
parameter_list|(
name|int
name|request
parameter_list|,
name|char
modifier|*
name|loc
parameter_list|,
name|uint64_t
name|rem
parameter_list|,
name|int
name|len
parameter_list|,
name|intptr_t
name|tok
parameter_list|)
block|{
name|int
name|status
decl_stmt|;
name|int
name|regid
decl_stmt|;
name|unsigned
name|int
name|nat
decl_stmt|;
name|struct
name|uwx_self_info
modifier|*
name|info
init|=
operator|(
expr|struct
name|uwx_self_info
operator|*
operator|)
name|tok
decl_stmt|;
name|unsigned
name|long
modifier|*
name|wp
decl_stmt|;
name|uint64_t
modifier|*
name|dp
decl_stmt|;
name|status
operator|=
operator|-
literal|1
expr_stmt|;
name|dp
operator|=
operator|(
name|uint64_t
operator|*
operator|)
name|loc
expr_stmt|;
switch|switch
condition|(
name|request
condition|)
block|{
case|case
name|UWX_COPYIN_UINFO
case|:
case|case
name|UWX_COPYIN_MSTACK
case|:
if|if
condition|(
name|len
operator|==
literal|4
condition|)
block|{
name|wp
operator|=
operator|(
name|unsigned
name|long
operator|*
operator|)
name|loc
expr_stmt|;
operator|*
name|wp
operator|=
operator|*
operator|(
name|unsigned
name|long
operator|*
operator|)
name|rem
expr_stmt|;
name|TRACE_SELF_COPYIN4
argument_list|(
argument|rem
argument_list|,
argument|len
argument_list|,
argument|wp
argument_list|)
name|status
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|len
operator|==
literal|8
condition|)
block|{
operator|*
name|dp
operator|=
operator|*
operator|(
name|uint64_t
operator|*
operator|)
name|rem
expr_stmt|;
name|TRACE_SELF_COPYIN8
argument_list|(
argument|rem
argument_list|,
argument|len
argument_list|,
argument|dp
argument_list|)
name|status
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
name|UWX_COPYIN_RSTACK
case|:
if|if
condition|(
name|len
operator|==
literal|8
condition|)
block|{
if|if
condition|(
name|info
operator|->
name|ucontext
operator|==
literal|0
operator|&&
name|rem
operator|==
operator|(
name|info
operator|->
name|bspstore
operator||
literal|0x1f8
operator|)
condition|)
block|{
operator|*
name|dp
operator|=
name|info
operator|->
name|env
operator|->
name|context
operator|.
name|special
index|[
name|UWX_REG_AR_RNAT
index|]
expr_stmt|;
name|status
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|info
operator|->
name|ucontext
operator|==
literal|0
operator|||
name|rem
operator|<
name|info
operator|->
name|bspstore
condition|)
block|{
operator|*
name|dp
operator|=
operator|*
operator|(
name|uint64_t
operator|*
operator|)
name|rem
expr_stmt|;
name|TRACE_SELF_COPYIN8
argument_list|(
argument|rem
argument_list|,
argument|len
argument_list|,
argument|dp
argument_list|)
name|status
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|status
operator|=
name|__uc_get_rsebs
argument_list|(
name|info
operator|->
name|ucontext
argument_list|,
operator|(
name|uint64_t
operator|*
operator|)
name|rem
argument_list|,
literal|1
argument_list|,
name|dp
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|UWX_COPYIN_REG
case|:
name|regid
operator|=
operator|(
name|int
operator|)
name|rem
expr_stmt|;
if|if
condition|(
name|info
operator|->
name|ucontext
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|len
operator|==
literal|8
condition|)
block|{
if|if
condition|(
name|rem
operator|==
name|UWX_REG_PREDS
condition|)
name|status
operator|=
name|__uc_get_prs
argument_list|(
name|info
operator|->
name|ucontext
argument_list|,
name|dp
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|rem
operator|==
name|UWX_REG_AR_PFS
condition|)
name|status
operator|=
name|__uc_get_ar
argument_list|(
name|info
operator|->
name|ucontext
argument_list|,
literal|64
argument_list|,
name|dp
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|rem
operator|==
name|UWX_REG_AR_RNAT
condition|)
name|status
operator|=
name|__uc_get_ar
argument_list|(
name|info
operator|->
name|ucontext
argument_list|,
literal|19
argument_list|,
name|dp
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|rem
operator|==
name|UWX_REG_AR_UNAT
condition|)
name|status
operator|=
name|__uc_get_ar
argument_list|(
name|info
operator|->
name|ucontext
argument_list|,
literal|36
argument_list|,
name|dp
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|rem
operator|==
name|UWX_REG_AR_FPSR
condition|)
name|status
operator|=
name|__uc_get_ar
argument_list|(
name|info
operator|->
name|ucontext
argument_list|,
literal|40
argument_list|,
name|dp
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|rem
operator|==
name|UWX_REG_AR_LC
condition|)
name|status
operator|=
name|__uc_get_ar
argument_list|(
name|info
operator|->
name|ucontext
argument_list|,
literal|65
argument_list|,
name|dp
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|regid
operator|>=
name|UWX_REG_GR
argument_list|(
literal|1
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_GR
argument_list|(
literal|31
argument_list|)
condition|)
name|status
operator|=
name|__uc_get_grs
argument_list|(
name|info
operator|->
name|ucontext
argument_list|,
name|regid
operator|-
name|UWX_REG_GR
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|1
argument_list|,
name|dp
argument_list|,
operator|&
name|nat
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|regid
operator|>=
name|UWX_REG_BR
argument_list|(
literal|0
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_BR
argument_list|(
literal|7
argument_list|)
condition|)
name|status
operator|=
name|__uc_get_brs
argument_list|(
name|info
operator|->
name|ucontext
argument_list|,
name|regid
operator|-
name|UWX_REG_BR
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|1
argument_list|,
name|dp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|len
operator|==
literal|16
condition|)
block|{
if|if
condition|(
name|regid
operator|>=
name|UWX_REG_FR
argument_list|(
literal|2
argument_list|)
operator|&&
name|regid
operator|<=
name|UWX_REG_FR
argument_list|(
literal|127
argument_list|)
condition|)
block|{
name|status
operator|=
name|__uc_get_frs
argument_list|(
name|info
operator|->
name|ucontext
argument_list|,
name|regid
operator|-
name|UWX_REG_FR
argument_list|(
literal|0
argument_list|)
argument_list|,
literal|1
argument_list|,
operator|(
name|fp_regval_t
operator|*
operator|)
name|dp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
break|break;
block|}
if|if
condition|(
name|status
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
return|return
name|len
return|;
block|}
end_function

begin_function
name|int
name|uwx_self_find_module
parameter_list|(
name|uint64_t
name|ip
parameter_list|,
name|struct
name|uwx_self_info
modifier|*
name|info
parameter_list|,
name|uint64_t
modifier|*
name|text_base
parameter_list|,
name|uint64_t
modifier|*
modifier|*
name|unwind_base
parameter_list|)
block|{
name|UINT64
name|handle
decl_stmt|;
comment|/* Search our cache for the module containing the IP */
comment|/* Not in the cache -- call dlmodinfo */
name|handle
operator|=
name|dlmodinfo
argument_list|(
name|ip
argument_list|,
operator|&
name|info
operator|->
name|desc
argument_list|,
sizeof|sizeof
argument_list|(
name|info
operator|->
name|desc
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|handle
operator|==
literal|0
condition|)
return|return
name|UWX_ERR_IPNOTFOUND
return|;
comment|/* Store it in the cache */
operator|*
name|text_base
operator|=
name|info
operator|->
name|desc
operator|.
name|text_base
expr_stmt|;
operator|*
name|unwind_base
operator|=
operator|(
name|uint64_t
operator|*
operator|)
name|info
operator|->
name|desc
operator|.
name|unwind_base
expr_stmt|;
return|return
name|UWX_OK
return|;
block|}
end_function

begin_function
name|int
name|uwx_self_lookupip
parameter_list|(
name|int
name|request
parameter_list|,
name|uint64_t
name|ip
parameter_list|,
name|intptr_t
name|tok
parameter_list|,
name|uint64_t
modifier|*
modifier|*
name|resultp
parameter_list|)
block|{
name|struct
name|uwx_self_info
modifier|*
name|info
init|=
operator|(
expr|struct
name|uwx_self_info
operator|*
operator|)
name|tok
decl_stmt|;
name|uint64_t
name|text_base
decl_stmt|;
name|uint64_t
modifier|*
name|unwind_base
decl_stmt|;
name|uint64_t
modifier|*
name|rvec
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|request
operator|==
name|UWX_LKUP_LOOKUP
condition|)
block|{
name|TRACE_SELF_LOOKUP
argument_list|(
argument|ip
argument_list|)
if|if
condition|(
name|ip
operator|>=
name|info
operator|->
name|sendsig_start
operator|&&
name|ip
operator|<
name|info
operator|->
name|sendsig_end
condition|)
block|{
name|i
operator|=
literal|0
expr_stmt|;
name|rvec
operator|=
name|info
operator|->
name|rvec
expr_stmt|;
name|rvec
index|[
name|i
operator|++
index|]
operator|=
name|UWX_KEY_CONTEXT
expr_stmt|;
name|rvec
index|[
name|i
operator|++
index|]
operator|=
name|UWX_ABI_HPUX_SIGCONTEXT
expr_stmt|;
name|rvec
index|[
name|i
operator|++
index|]
operator|=
literal|0
expr_stmt|;
name|rvec
index|[
name|i
operator|++
index|]
operator|=
literal|0
expr_stmt|;
operator|*
name|resultp
operator|=
name|rvec
expr_stmt|;
return|return
name|UWX_LKUP_FDESC
return|;
block|}
else|else
block|{
if|if
condition|(
name|uwx_self_find_module
argument_list|(
name|ip
argument_list|,
name|info
argument_list|,
operator|&
name|text_base
argument_list|,
operator|&
name|unwind_base
argument_list|)
operator|!=
name|UWX_OK
condition|)
return|return
name|UWX_LKUP_ERR
return|;
name|TRACE_SELF_LOOKUP_DESC
argument_list|(
argument|text_base
argument_list|,
argument|unwind_base
argument_list|)
name|i
operator|=
literal|0
expr_stmt|;
name|rvec
operator|=
name|info
operator|->
name|rvec
expr_stmt|;
name|rvec
index|[
name|i
operator|++
index|]
operator|=
name|UWX_KEY_TBASE
expr_stmt|;
name|rvec
index|[
name|i
operator|++
index|]
operator|=
name|text_base
expr_stmt|;
name|rvec
index|[
name|i
operator|++
index|]
operator|=
name|UWX_KEY_UFLAGS
expr_stmt|;
name|rvec
index|[
name|i
operator|++
index|]
operator|=
name|unwind_base
index|[
literal|0
index|]
expr_stmt|;
name|rvec
index|[
name|i
operator|++
index|]
operator|=
name|UWX_KEY_USTART
expr_stmt|;
name|rvec
index|[
name|i
operator|++
index|]
operator|=
name|text_base
operator|+
name|unwind_base
index|[
literal|1
index|]
expr_stmt|;
name|rvec
index|[
name|i
operator|++
index|]
operator|=
name|UWX_KEY_UEND
expr_stmt|;
name|rvec
index|[
name|i
operator|++
index|]
operator|=
name|text_base
operator|+
name|unwind_base
index|[
literal|2
index|]
expr_stmt|;
name|rvec
index|[
name|i
operator|++
index|]
operator|=
literal|0
expr_stmt|;
name|rvec
index|[
name|i
operator|++
index|]
operator|=
literal|0
expr_stmt|;
operator|*
name|resultp
operator|=
name|rvec
expr_stmt|;
return|return
name|UWX_LKUP_UTABLE
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|request
operator|==
name|UWX_LKUP_FREE
condition|)
block|{
return|return
literal|0
return|;
block|}
elseif|else
if|if
condition|(
name|request
operator|==
name|UWX_LKUP_SYMBOLS
condition|)
block|{
return|return
name|UWX_LKUP_ERR
return|;
block|}
block|}
end_function

end_unit


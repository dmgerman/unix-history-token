begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2017-present, Facebook, Inc.  * All rights reserved.  *  * This source code is licensed under both the BSD-style license (found in the  * LICENSE file in the root directory of this source tree) and the GPLv2 (found  * in the COPYING file in the root directory of this source tree).  */
end_comment

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_comment
comment|/* malloc, free */
end_comment

begin_define
define|#
directive|define
name|XXH_STATIC_LINKING_ONLY
end_define

begin_define
define|#
directive|define
name|XXH_NAMESPACE
value|ZSTD_
end_define

begin_include
include|#
directive|include
file|"xxhash.h"
end_include

begin_define
define|#
directive|define
name|ZSTD_STATIC_LINKING_ONLY
end_define

begin_include
include|#
directive|include
file|"zstd.h"
end_include

begin_include
include|#
directive|include
file|"zstd_errors.h"
end_include

begin_include
include|#
directive|include
file|"mem.h"
end_include

begin_include
include|#
directive|include
file|"zstd_seekable.h"
end_include

begin_define
define|#
directive|define
name|CHECK_Z
parameter_list|(
name|f
parameter_list|)
value|{ size_t const ret = (f); if (ret != 0) return ret; }
end_define

begin_undef
undef|#
directive|undef
name|ERROR
end_undef

begin_define
define|#
directive|define
name|ERROR
parameter_list|(
name|name
parameter_list|)
value|((size_t)-ZSTD_error_##name)
end_define

begin_undef
undef|#
directive|undef
name|MIN
end_undef

begin_undef
undef|#
directive|undef
name|MAX
end_undef

begin_define
define|#
directive|define
name|MIN
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|((a)< (b) ? (a) : (b))
end_define

begin_define
define|#
directive|define
name|MAX
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|((a)> (b) ? (a) : (b))
end_define

begin_typedef
typedef|typedef
struct|struct
block|{
name|U32
name|cSize
decl_stmt|;
name|U32
name|dSize
decl_stmt|;
name|U32
name|checksum
decl_stmt|;
block|}
name|framelogEntry_t
typedef|;
end_typedef

begin_struct
struct|struct
name|ZSTD_frameLog_s
block|{
name|framelogEntry_t
modifier|*
name|entries
decl_stmt|;
name|U32
name|size
decl_stmt|;
name|U32
name|capacity
decl_stmt|;
name|int
name|checksumFlag
decl_stmt|;
comment|/* for use when streaming out the seek table */
name|U32
name|seekTablePos
decl_stmt|;
name|U32
name|seekTableIndex
decl_stmt|;
block|}
name|framelog_t
struct|;
end_struct

begin_struct
struct|struct
name|ZSTD_seekable_CStream_s
block|{
name|ZSTD_CStream
modifier|*
name|cstream
decl_stmt|;
name|ZSTD_frameLog
name|framelog
decl_stmt|;
name|U32
name|frameCSize
decl_stmt|;
name|U32
name|frameDSize
decl_stmt|;
name|XXH64_state_t
name|xxhState
decl_stmt|;
name|U32
name|maxFrameSize
decl_stmt|;
name|int
name|writingSeekTable
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|size_t
name|ZSTD_seekable_frameLog_allocVec
parameter_list|(
name|ZSTD_frameLog
modifier|*
name|fl
parameter_list|)
block|{
comment|/* allocate some initial space */
name|size_t
specifier|const
name|FRAMELOG_STARTING_CAPACITY
init|=
literal|16
decl_stmt|;
name|fl
operator|->
name|entries
operator|=
operator|(
name|framelogEntry_t
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|framelogEntry_t
argument_list|)
operator|*
name|FRAMELOG_STARTING_CAPACITY
argument_list|)
expr_stmt|;
if|if
condition|(
name|fl
operator|->
name|entries
operator|==
name|NULL
condition|)
return|return
name|ERROR
argument_list|(
name|memory_allocation
argument_list|)
return|;
name|fl
operator|->
name|capacity
operator|=
name|FRAMELOG_STARTING_CAPACITY
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_seekable_frameLog_freeVec
parameter_list|(
name|ZSTD_frameLog
modifier|*
name|fl
parameter_list|)
block|{
if|if
condition|(
name|fl
operator|!=
name|NULL
condition|)
name|free
argument_list|(
name|fl
operator|->
name|entries
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|ZSTD_frameLog
modifier|*
name|ZSTD_seekable_createFrameLog
parameter_list|(
name|int
name|checksumFlag
parameter_list|)
block|{
name|ZSTD_frameLog
modifier|*
name|fl
init|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|ZSTD_frameLog
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|fl
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|ZSTD_seekable_frameLog_allocVec
argument_list|(
name|fl
argument_list|)
argument_list|)
condition|)
block|{
name|free
argument_list|(
name|fl
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|fl
operator|->
name|checksumFlag
operator|=
name|checksumFlag
expr_stmt|;
name|fl
operator|->
name|seekTablePos
operator|=
literal|0
expr_stmt|;
name|fl
operator|->
name|seekTableIndex
operator|=
literal|0
expr_stmt|;
name|fl
operator|->
name|size
operator|=
literal|0
expr_stmt|;
return|return
name|fl
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_seekable_freeFrameLog
parameter_list|(
name|ZSTD_frameLog
modifier|*
name|fl
parameter_list|)
block|{
name|ZSTD_seekable_frameLog_freeVec
argument_list|(
name|fl
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fl
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|ZSTD_seekable_CStream
modifier|*
name|ZSTD_seekable_createCStream
parameter_list|()
block|{
name|ZSTD_seekable_CStream
modifier|*
name|zcs
init|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|ZSTD_seekable_CStream
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|zcs
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|memset
argument_list|(
name|zcs
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|zcs
argument_list|)
argument_list|)
expr_stmt|;
name|zcs
operator|->
name|cstream
operator|=
name|ZSTD_createCStream
argument_list|()
expr_stmt|;
if|if
condition|(
name|zcs
operator|->
name|cstream
operator|==
name|NULL
condition|)
goto|goto
name|failed1
goto|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|ZSTD_seekable_frameLog_allocVec
argument_list|(
operator|&
name|zcs
operator|->
name|framelog
argument_list|)
argument_list|)
condition|)
goto|goto
name|failed2
goto|;
return|return
name|zcs
return|;
name|failed2
label|:
name|ZSTD_freeCStream
argument_list|(
name|zcs
operator|->
name|cstream
argument_list|)
expr_stmt|;
name|failed1
label|:
name|free
argument_list|(
name|zcs
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_seekable_freeCStream
parameter_list|(
name|ZSTD_seekable_CStream
modifier|*
name|zcs
parameter_list|)
block|{
if|if
condition|(
name|zcs
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
comment|/* support free on null */
name|ZSTD_freeCStream
argument_list|(
name|zcs
operator|->
name|cstream
argument_list|)
expr_stmt|;
name|ZSTD_seekable_frameLog_freeVec
argument_list|(
operator|&
name|zcs
operator|->
name|framelog
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|zcs
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_seekable_initCStream
parameter_list|(
name|ZSTD_seekable_CStream
modifier|*
name|zcs
parameter_list|,
name|int
name|compressionLevel
parameter_list|,
name|int
name|checksumFlag
parameter_list|,
name|U32
name|maxFrameSize
parameter_list|)
block|{
name|zcs
operator|->
name|framelog
operator|.
name|size
operator|=
literal|0
expr_stmt|;
name|zcs
operator|->
name|frameCSize
operator|=
literal|0
expr_stmt|;
name|zcs
operator|->
name|frameDSize
operator|=
literal|0
expr_stmt|;
comment|/* make sure maxFrameSize has a reasonable value */
if|if
condition|(
name|maxFrameSize
operator|>
name|ZSTD_SEEKABLE_MAX_FRAME_DECOMPRESSED_SIZE
condition|)
block|{
return|return
name|ERROR
argument_list|(
name|compressionParameter_unsupported
argument_list|)
return|;
block|}
name|zcs
operator|->
name|maxFrameSize
operator|=
name|maxFrameSize
condition|?
name|maxFrameSize
else|:
name|ZSTD_SEEKABLE_MAX_FRAME_DECOMPRESSED_SIZE
expr_stmt|;
name|zcs
operator|->
name|framelog
operator|.
name|checksumFlag
operator|=
name|checksumFlag
expr_stmt|;
if|if
condition|(
name|zcs
operator|->
name|framelog
operator|.
name|checksumFlag
condition|)
block|{
name|XXH64_reset
argument_list|(
operator|&
name|zcs
operator|->
name|xxhState
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|zcs
operator|->
name|framelog
operator|.
name|seekTablePos
operator|=
literal|0
expr_stmt|;
name|zcs
operator|->
name|framelog
operator|.
name|seekTableIndex
operator|=
literal|0
expr_stmt|;
name|zcs
operator|->
name|writingSeekTable
operator|=
literal|0
expr_stmt|;
return|return
name|ZSTD_initCStream
argument_list|(
name|zcs
operator|->
name|cstream
argument_list|,
name|compressionLevel
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_seekable_logFrame
parameter_list|(
name|ZSTD_frameLog
modifier|*
name|fl
parameter_list|,
name|unsigned
name|compressedSize
parameter_list|,
name|unsigned
name|decompressedSize
parameter_list|,
name|unsigned
name|checksum
parameter_list|)
block|{
if|if
condition|(
name|fl
operator|->
name|size
operator|==
name|ZSTD_SEEKABLE_MAXFRAMES
condition|)
return|return
name|ERROR
argument_list|(
name|frameIndex_tooLarge
argument_list|)
return|;
comment|/* grow the buffer if required */
if|if
condition|(
name|fl
operator|->
name|size
operator|==
name|fl
operator|->
name|capacity
condition|)
block|{
comment|/* exponential size increase for constant amortized runtime */
name|size_t
specifier|const
name|newCapacity
init|=
name|fl
operator|->
name|capacity
operator|*
literal|2
decl_stmt|;
name|framelogEntry_t
modifier|*
specifier|const
name|newEntries
init|=
name|realloc
argument_list|(
name|fl
operator|->
name|entries
argument_list|,
sizeof|sizeof
argument_list|(
name|framelogEntry_t
argument_list|)
operator|*
name|newCapacity
argument_list|)
decl_stmt|;
if|if
condition|(
name|newEntries
operator|==
name|NULL
condition|)
return|return
name|ERROR
argument_list|(
name|memory_allocation
argument_list|)
return|;
name|fl
operator|->
name|entries
operator|=
name|newEntries
expr_stmt|;
name|fl
operator|->
name|capacity
operator|=
name|newCapacity
expr_stmt|;
block|}
name|fl
operator|->
name|entries
index|[
name|fl
operator|->
name|size
index|]
operator|=
operator|(
name|framelogEntry_t
operator|)
block|{
name|compressedSize
block|,
name|decompressedSize
block|,
name|checksum
block|}
expr_stmt|;
name|fl
operator|->
name|size
operator|++
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_seekable_endFrame
parameter_list|(
name|ZSTD_seekable_CStream
modifier|*
name|zcs
parameter_list|,
name|ZSTD_outBuffer
modifier|*
name|output
parameter_list|)
block|{
name|size_t
specifier|const
name|prevOutPos
init|=
name|output
operator|->
name|pos
decl_stmt|;
comment|/* end the frame */
name|size_t
name|ret
init|=
name|ZSTD_endStream
argument_list|(
name|zcs
operator|->
name|cstream
argument_list|,
name|output
argument_list|)
decl_stmt|;
name|zcs
operator|->
name|frameCSize
operator|+=
name|output
operator|->
name|pos
operator|-
name|prevOutPos
expr_stmt|;
comment|/* need to flush before doing the rest */
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
comment|/* frame done */
comment|/* store the frame data for later */
name|ret
operator|=
name|ZSTD_seekable_logFrame
argument_list|(
operator|&
name|zcs
operator|->
name|framelog
argument_list|,
name|zcs
operator|->
name|frameCSize
argument_list|,
name|zcs
operator|->
name|frameDSize
argument_list|,
name|zcs
operator|->
name|framelog
operator|.
name|checksumFlag
condition|?
name|XXH64_digest
argument_list|(
operator|&
name|zcs
operator|->
name|xxhState
argument_list|)
operator|&
literal|0xFFFFFFFFU
else|:
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
comment|/* reset for the next frame */
name|zcs
operator|->
name|frameCSize
operator|=
literal|0
expr_stmt|;
name|zcs
operator|->
name|frameDSize
operator|=
literal|0
expr_stmt|;
name|ZSTD_resetCStream
argument_list|(
name|zcs
operator|->
name|cstream
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|zcs
operator|->
name|framelog
operator|.
name|checksumFlag
condition|)
name|XXH64_reset
argument_list|(
operator|&
name|zcs
operator|->
name|xxhState
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_seekable_compressStream
parameter_list|(
name|ZSTD_seekable_CStream
modifier|*
name|zcs
parameter_list|,
name|ZSTD_outBuffer
modifier|*
name|output
parameter_list|,
name|ZSTD_inBuffer
modifier|*
name|input
parameter_list|)
block|{
specifier|const
name|BYTE
modifier|*
specifier|const
name|inBase
init|=
operator|(
specifier|const
name|BYTE
operator|*
operator|)
name|input
operator|->
name|src
operator|+
name|input
operator|->
name|pos
decl_stmt|;
name|size_t
name|inLen
init|=
name|input
operator|->
name|size
operator|-
name|input
operator|->
name|pos
decl_stmt|;
name|inLen
operator|=
name|MIN
argument_list|(
name|inLen
argument_list|,
call|(
name|size_t
call|)
argument_list|(
name|zcs
operator|->
name|maxFrameSize
operator|-
name|zcs
operator|->
name|frameDSize
argument_list|)
argument_list|)
expr_stmt|;
comment|/* if we haven't finished flushing the last frame, don't start writing a new one */
if|if
condition|(
name|inLen
operator|>
literal|0
condition|)
block|{
name|ZSTD_inBuffer
name|inTmp
init|=
block|{
name|inBase
block|,
name|inLen
block|,
literal|0
block|}
decl_stmt|;
name|size_t
specifier|const
name|prevOutPos
init|=
name|output
operator|->
name|pos
decl_stmt|;
name|size_t
specifier|const
name|ret
init|=
name|ZSTD_compressStream
argument_list|(
name|zcs
operator|->
name|cstream
argument_list|,
name|output
argument_list|,
operator|&
name|inTmp
argument_list|)
decl_stmt|;
if|if
condition|(
name|zcs
operator|->
name|framelog
operator|.
name|checksumFlag
condition|)
block|{
name|XXH64_update
argument_list|(
operator|&
name|zcs
operator|->
name|xxhState
argument_list|,
name|inBase
argument_list|,
name|inTmp
operator|.
name|pos
argument_list|)
expr_stmt|;
block|}
name|zcs
operator|->
name|frameCSize
operator|+=
name|output
operator|->
name|pos
operator|-
name|prevOutPos
expr_stmt|;
name|zcs
operator|->
name|frameDSize
operator|+=
name|inTmp
operator|.
name|pos
expr_stmt|;
name|input
operator|->
name|pos
operator|+=
name|inTmp
operator|.
name|pos
expr_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|ret
argument_list|)
condition|)
return|return
name|ret
return|;
block|}
if|if
condition|(
name|zcs
operator|->
name|maxFrameSize
operator|==
name|zcs
operator|->
name|frameDSize
condition|)
block|{
comment|/* log the frame and start over */
name|size_t
specifier|const
name|ret
init|=
name|ZSTD_seekable_endFrame
argument_list|(
name|zcs
argument_list|,
name|output
argument_list|)
decl_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|ret
argument_list|)
condition|)
return|return
name|ret
return|;
comment|/* get the client ready for the next frame */
return|return
operator|(
name|size_t
operator|)
name|zcs
operator|->
name|maxFrameSize
return|;
block|}
return|return
call|(
name|size_t
call|)
argument_list|(
name|zcs
operator|->
name|maxFrameSize
operator|-
name|zcs
operator|->
name|frameDSize
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|size_t
name|ZSTD_seekable_seekTableSize
parameter_list|(
specifier|const
name|ZSTD_frameLog
modifier|*
name|fl
parameter_list|)
block|{
name|size_t
specifier|const
name|sizePerFrame
init|=
literal|8
operator|+
operator|(
name|fl
operator|->
name|checksumFlag
condition|?
literal|4
else|:
literal|0
operator|)
decl_stmt|;
name|size_t
specifier|const
name|seekTableLen
init|=
name|ZSTD_skippableHeaderSize
operator|+
name|sizePerFrame
operator|*
name|fl
operator|->
name|size
operator|+
name|ZSTD_seekTableFooterSize
decl_stmt|;
return|return
name|seekTableLen
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|size_t
name|ZSTD_stwrite32
parameter_list|(
name|ZSTD_frameLog
modifier|*
name|fl
parameter_list|,
name|ZSTD_outBuffer
modifier|*
name|output
parameter_list|,
name|U32
specifier|const
name|value
parameter_list|,
name|U32
specifier|const
name|offset
parameter_list|)
block|{
if|if
condition|(
name|fl
operator|->
name|seekTablePos
operator|<
name|offset
operator|+
literal|4
condition|)
block|{
name|BYTE
name|tmp
index|[
literal|4
index|]
decl_stmt|;
comment|/* so that we can work with buffers too small to write a whole word to */
name|size_t
specifier|const
name|lenWrite
init|=
name|MIN
argument_list|(
name|output
operator|->
name|size
operator|-
name|output
operator|->
name|pos
argument_list|,
name|offset
operator|+
literal|4
operator|-
name|fl
operator|->
name|seekTablePos
argument_list|)
decl_stmt|;
name|MEM_writeLE32
argument_list|(
name|tmp
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|BYTE
operator|*
operator|)
name|output
operator|->
name|dst
operator|+
name|output
operator|->
name|pos
argument_list|,
name|tmp
operator|+
operator|(
name|fl
operator|->
name|seekTablePos
operator|-
name|offset
operator|)
argument_list|,
name|lenWrite
argument_list|)
expr_stmt|;
name|output
operator|->
name|pos
operator|+=
name|lenWrite
expr_stmt|;
name|fl
operator|->
name|seekTablePos
operator|+=
name|lenWrite
expr_stmt|;
if|if
condition|(
name|lenWrite
operator|<
literal|4
condition|)
return|return
name|ZSTD_seekable_seekTableSize
argument_list|(
name|fl
argument_list|)
operator|-
name|fl
operator|->
name|seekTablePos
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_seekable_writeSeekTable
parameter_list|(
name|ZSTD_frameLog
modifier|*
name|fl
parameter_list|,
name|ZSTD_outBuffer
modifier|*
name|output
parameter_list|)
block|{
comment|/* seekTableIndex: the current index in the table and      * seekTableSize: the amount of the table written so far      *      * This function is written this way so that if it has to return early      * because of a small buffer, it can keep going where it left off.      */
name|size_t
specifier|const
name|sizePerFrame
init|=
literal|8
operator|+
operator|(
name|fl
operator|->
name|checksumFlag
condition|?
literal|4
else|:
literal|0
operator|)
decl_stmt|;
name|size_t
specifier|const
name|seekTableLen
init|=
name|ZSTD_seekable_seekTableSize
argument_list|(
name|fl
argument_list|)
decl_stmt|;
name|CHECK_Z
argument_list|(
name|ZSTD_stwrite32
argument_list|(
name|fl
argument_list|,
name|output
argument_list|,
name|ZSTD_MAGIC_SKIPPABLE_START
operator||
literal|0xE
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK_Z
argument_list|(
name|ZSTD_stwrite32
argument_list|(
name|fl
argument_list|,
name|output
argument_list|,
name|seekTableLen
operator|-
name|ZSTD_skippableHeaderSize
argument_list|,
literal|4
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|fl
operator|->
name|seekTableIndex
operator|<
name|fl
operator|->
name|size
condition|)
block|{
name|CHECK_Z
argument_list|(
name|ZSTD_stwrite32
argument_list|(
name|fl
argument_list|,
name|output
argument_list|,
name|fl
operator|->
name|entries
index|[
name|fl
operator|->
name|seekTableIndex
index|]
operator|.
name|cSize
argument_list|,
name|ZSTD_skippableHeaderSize
operator|+
name|sizePerFrame
operator|*
name|fl
operator|->
name|seekTableIndex
operator|+
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK_Z
argument_list|(
name|ZSTD_stwrite32
argument_list|(
name|fl
argument_list|,
name|output
argument_list|,
name|fl
operator|->
name|entries
index|[
name|fl
operator|->
name|seekTableIndex
index|]
operator|.
name|dSize
argument_list|,
name|ZSTD_skippableHeaderSize
operator|+
name|sizePerFrame
operator|*
name|fl
operator|->
name|seekTableIndex
operator|+
literal|4
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fl
operator|->
name|checksumFlag
condition|)
block|{
name|CHECK_Z
argument_list|(
name|ZSTD_stwrite32
argument_list|(
name|fl
argument_list|,
name|output
argument_list|,
name|fl
operator|->
name|entries
index|[
name|fl
operator|->
name|seekTableIndex
index|]
operator|.
name|checksum
argument_list|,
name|ZSTD_skippableHeaderSize
operator|+
name|sizePerFrame
operator|*
name|fl
operator|->
name|seekTableIndex
operator|+
literal|8
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|fl
operator|->
name|seekTableIndex
operator|++
expr_stmt|;
block|}
name|CHECK_Z
argument_list|(
name|ZSTD_stwrite32
argument_list|(
name|fl
argument_list|,
name|output
argument_list|,
name|fl
operator|->
name|size
argument_list|,
name|seekTableLen
operator|-
name|ZSTD_seekTableFooterSize
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|output
operator|->
name|size
operator|-
name|output
operator|->
name|pos
operator|<
literal|1
condition|)
return|return
name|seekTableLen
operator|-
name|fl
operator|->
name|seekTablePos
return|;
if|if
condition|(
name|fl
operator|->
name|seekTablePos
operator|<
name|seekTableLen
operator|-
literal|4
condition|)
block|{
name|BYTE
name|sfd
init|=
literal|0
decl_stmt|;
name|sfd
operator||=
operator|(
name|fl
operator|->
name|checksumFlag
operator|)
operator|<<
literal|7
expr_stmt|;
operator|(
operator|(
name|BYTE
operator|*
operator|)
name|output
operator|->
name|dst
operator|)
index|[
name|output
operator|->
name|pos
index|]
operator|=
name|sfd
expr_stmt|;
name|output
operator|->
name|pos
operator|++
expr_stmt|;
name|fl
operator|->
name|seekTablePos
operator|++
expr_stmt|;
block|}
name|CHECK_Z
argument_list|(
name|ZSTD_stwrite32
argument_list|(
name|fl
argument_list|,
name|output
argument_list|,
name|ZSTD_SEEKABLE_MAGICNUMBER
argument_list|,
name|seekTableLen
operator|-
literal|4
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|fl
operator|->
name|seekTablePos
operator|!=
name|seekTableLen
condition|)
return|return
name|ERROR
argument_list|(
name|GENERIC
argument_list|)
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_seekable_endStream
parameter_list|(
name|ZSTD_seekable_CStream
modifier|*
name|zcs
parameter_list|,
name|ZSTD_outBuffer
modifier|*
name|output
parameter_list|)
block|{
if|if
condition|(
operator|!
name|zcs
operator|->
name|writingSeekTable
operator|&&
name|zcs
operator|->
name|frameDSize
condition|)
block|{
specifier|const
name|size_t
name|endFrame
init|=
name|ZSTD_seekable_endFrame
argument_list|(
name|zcs
argument_list|,
name|output
argument_list|)
decl_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|endFrame
argument_list|)
condition|)
return|return
name|endFrame
return|;
comment|/* return an accurate size hint */
if|if
condition|(
name|endFrame
condition|)
return|return
name|endFrame
operator|+
name|ZSTD_seekable_seekTableSize
argument_list|(
operator|&
name|zcs
operator|->
name|framelog
argument_list|)
return|;
block|}
name|zcs
operator|->
name|writingSeekTable
operator|=
literal|1
expr_stmt|;
return|return
name|ZSTD_seekable_writeSeekTable
argument_list|(
operator|&
name|zcs
operator|->
name|framelog
argument_list|,
name|output
argument_list|)
return|;
block|}
end_function

end_unit


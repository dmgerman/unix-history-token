begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2017-present, Facebook, Inc.  * All rights reserved.  *  * This source code is licensed under both the BSD-style license (found in the  * LICENSE file in the root directory of this source tree) and the GPLv2 (found  * in the COPYING file in the root directory of this source tree).  * You may select, at your option, one of the above-listed licenses.  */
end_comment

begin_comment
comment|/* ********************************************************* *  Turn on Large Files support (>4GB) for 32-bit Linux/Unix ***********************************************************/
end_comment

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|__64BIT__
argument_list|)
operator|||
name|defined
argument_list|(
name|__MINGW32__
argument_list|)
end_if

begin_comment
comment|/* No point defining Large file for 64 bit but MinGW-w64 requires it */
end_comment

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|_FILE_OFFSET_BITS
argument_list|)
end_if

begin_define
define|#
directive|define
name|_FILE_OFFSET_BITS
value|64
end_define

begin_comment
comment|/* turn off_t into a 64-bit type for ftello, fseeko */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|_LARGEFILE_SOURCE
argument_list|)
end_if

begin_comment
comment|/* obsolete macro, replaced with _FILE_OFFSET_BITS */
end_comment

begin_define
define|#
directive|define
name|_LARGEFILE_SOURCE
value|1
end_define

begin_comment
comment|/* Large File Support extension (LFS) - fseeko, ftello */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|_AIX
argument_list|)
operator|||
name|defined
argument_list|(
name|__hpux
argument_list|)
end_if

begin_define
define|#
directive|define
name|_LARGE_FILES
end_define

begin_comment
comment|/* Large file support on 32-bits AIX and HP-UX */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ************************************************************ * Avoid fseek()'s 2GiB barrier with MSVC, MacOS, *BSD, MinGW ***************************************************************/
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|_MSC_VER
argument_list|)
operator|&&
name|_MSC_VER
operator|>=
literal|1400
end_if

begin_define
define|#
directive|define
name|LONG_SEEK
value|_fseeki64
end_define

begin_elif
elif|#
directive|elif
operator|!
name|defined
argument_list|(
name|__64BIT__
argument_list|)
operator|&&
operator|(
name|PLATFORM_POSIX_VERSION
operator|>=
literal|200112L
operator|)
end_elif

begin_comment
comment|/* No point defining Large file for 64 bit */
end_comment

begin_define
define|#
directive|define
name|LONG_SEEK
value|fseeko
end_define

begin_elif
elif|#
directive|elif
name|defined
argument_list|(
name|__MINGW32__
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__STRICT_ANSI__
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__NO_MINGW_LFS
argument_list|)
operator|&&
name|defined
argument_list|(
name|__MSVCRT__
argument_list|)
end_elif

begin_define
define|#
directive|define
name|LONG_SEEK
value|fseeko64
end_define

begin_elif
elif|#
directive|elif
name|defined
argument_list|(
name|_WIN32
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__DJGPP__
argument_list|)
end_elif

begin_include
include|#
directive|include
file|<windows.h>
end_include

begin_function
specifier|static
name|int
name|LONG_SEEK
parameter_list|(
name|FILE
modifier|*
name|file
parameter_list|,
name|__int64
name|offset
parameter_list|,
name|int
name|origin
parameter_list|)
block|{
name|LARGE_INTEGER
name|off
decl_stmt|;
name|DWORD
name|method
decl_stmt|;
name|off
operator|.
name|QuadPart
operator|=
name|offset
expr_stmt|;
if|if
condition|(
name|origin
operator|==
name|SEEK_END
condition|)
name|method
operator|=
name|FILE_END
expr_stmt|;
elseif|else
if|if
condition|(
name|origin
operator|==
name|SEEK_CUR
condition|)
name|method
operator|=
name|FILE_CURRENT
expr_stmt|;
else|else
name|method
operator|=
name|FILE_BEGIN
expr_stmt|;
if|if
condition|(
name|SetFilePointerEx
argument_list|(
operator|(
name|HANDLE
operator|)
name|_get_osfhandle
argument_list|(
name|_fileno
argument_list|(
name|file
argument_list|)
argument_list|)
argument_list|,
name|off
argument_list|,
name|NULL
argument_list|,
name|method
argument_list|)
condition|)
return|return
literal|0
return|;
else|else
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|LONG_SEEK
value|fseek
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_comment
comment|/* malloc, free */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_comment
comment|/* FILE* */
end_comment

begin_define
define|#
directive|define
name|XXH_STATIC_LINKING_ONLY
end_define

begin_define
define|#
directive|define
name|XXH_NAMESPACE
value|ZSTD_
end_define

begin_include
include|#
directive|include
file|"xxhash.h"
end_include

begin_define
define|#
directive|define
name|ZSTD_STATIC_LINKING_ONLY
end_define

begin_include
include|#
directive|include
file|"zstd.h"
end_include

begin_include
include|#
directive|include
file|"zstd_errors.h"
end_include

begin_include
include|#
directive|include
file|"mem.h"
end_include

begin_include
include|#
directive|include
file|"zstd_seekable.h"
end_include

begin_undef
undef|#
directive|undef
name|ERROR
end_undef

begin_define
define|#
directive|define
name|ERROR
parameter_list|(
name|name
parameter_list|)
value|((size_t)-ZSTD_error_##name)
end_define

begin_define
define|#
directive|define
name|CHECK_IO
parameter_list|(
name|f
parameter_list|)
value|{ int const errcod = (f); if (errcod< 0) return ERROR(seekableIO); }
end_define

begin_undef
undef|#
directive|undef
name|MIN
end_undef

begin_undef
undef|#
directive|undef
name|MAX
end_undef

begin_define
define|#
directive|define
name|MIN
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|((a)< (b) ? (a) : (b))
end_define

begin_define
define|#
directive|define
name|MAX
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|((a)> (b) ? (a) : (b))
end_define

begin_comment
comment|/* Special-case callbacks for FILE* and in-memory modes, so that we can treat  * them the same way as the advanced API */
end_comment

begin_function
specifier|static
name|int
name|ZSTD_seekable_read_FILE
parameter_list|(
name|void
modifier|*
name|opaque
parameter_list|,
name|void
modifier|*
name|buffer
parameter_list|,
name|size_t
name|n
parameter_list|)
block|{
name|size_t
specifier|const
name|result
init|=
name|fread
argument_list|(
name|buffer
argument_list|,
literal|1
argument_list|,
name|n
argument_list|,
operator|(
name|FILE
operator|*
operator|)
name|opaque
argument_list|)
decl_stmt|;
if|if
condition|(
name|result
operator|!=
name|n
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ZSTD_seekable_seek_FILE
parameter_list|(
name|void
modifier|*
name|opaque
parameter_list|,
name|S64
name|offset
parameter_list|,
name|int
name|origin
parameter_list|)
block|{
name|int
specifier|const
name|ret
init|=
name|LONG_SEEK
argument_list|(
operator|(
name|FILE
operator|*
operator|)
name|opaque
argument_list|,
name|offset
argument_list|,
name|origin
argument_list|)
decl_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
name|fflush
argument_list|(
operator|(
name|FILE
operator|*
operator|)
name|opaque
argument_list|)
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
block|{
specifier|const
name|void
modifier|*
name|ptr
decl_stmt|;
name|size_t
name|size
decl_stmt|;
name|size_t
name|pos
decl_stmt|;
block|}
name|buffWrapper_t
typedef|;
end_typedef

begin_function
specifier|static
name|int
name|ZSTD_seekable_read_buff
parameter_list|(
name|void
modifier|*
name|opaque
parameter_list|,
name|void
modifier|*
name|buffer
parameter_list|,
name|size_t
name|n
parameter_list|)
block|{
name|buffWrapper_t
modifier|*
name|buff
init|=
operator|(
name|buffWrapper_t
operator|*
operator|)
name|opaque
decl_stmt|;
if|if
condition|(
name|buff
operator|->
name|size
operator|+
name|n
operator|>
name|buff
operator|->
name|pos
condition|)
return|return
operator|-
literal|1
return|;
name|memcpy
argument_list|(
name|buffer
argument_list|,
operator|(
specifier|const
name|BYTE
operator|*
operator|)
name|buff
operator|->
name|ptr
operator|+
name|buff
operator|->
name|pos
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|buff
operator|->
name|pos
operator|+=
name|n
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ZSTD_seekable_seek_buff
parameter_list|(
name|void
modifier|*
name|opaque
parameter_list|,
name|S64
name|offset
parameter_list|,
name|int
name|origin
parameter_list|)
block|{
name|buffWrapper_t
modifier|*
name|buff
init|=
operator|(
name|buffWrapper_t
operator|*
operator|)
name|opaque
decl_stmt|;
name|unsigned
name|long
name|long
name|newOffset
decl_stmt|;
switch|switch
condition|(
name|origin
condition|)
block|{
case|case
name|SEEK_SET
case|:
name|newOffset
operator|=
name|offset
expr_stmt|;
break|break;
case|case
name|SEEK_CUR
case|:
name|newOffset
operator|=
operator|(
name|unsigned
name|long
name|long
operator|)
name|buff
operator|->
name|pos
operator|+
name|offset
expr_stmt|;
break|break;
case|case
name|SEEK_END
case|:
name|newOffset
operator|=
operator|(
name|unsigned
name|long
name|long
operator|)
name|buff
operator|->
name|size
operator|-
name|offset
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|newOffset
operator|<
literal|0
operator|||
name|newOffset
operator|>
name|buff
operator|->
name|size
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
name|buff
operator|->
name|pos
operator|=
name|newOffset
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_typedef
typedef|typedef
struct|struct
block|{
name|U64
name|cOffset
decl_stmt|;
name|U64
name|dOffset
decl_stmt|;
name|U32
name|checksum
decl_stmt|;
block|}
name|seekEntry_t
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
name|seekEntry_t
modifier|*
name|entries
decl_stmt|;
name|size_t
name|tableLen
decl_stmt|;
name|int
name|checksumFlag
decl_stmt|;
block|}
name|seekTable_t
typedef|;
end_typedef

begin_define
define|#
directive|define
name|SEEKABLE_BUFF_SIZE
value|ZSTD_BLOCKSIZE_ABSOLUTEMAX
end_define

begin_struct
struct|struct
name|ZSTD_seekable_s
block|{
name|ZSTD_DStream
modifier|*
name|dstream
decl_stmt|;
name|seekTable_t
name|seekTable
decl_stmt|;
name|ZSTD_seekable_customFile
name|src
decl_stmt|;
name|U64
name|decompressedOffset
decl_stmt|;
name|U32
name|curFrame
decl_stmt|;
name|BYTE
name|inBuff
index|[
name|SEEKABLE_BUFF_SIZE
index|]
decl_stmt|;
comment|/* need to do our own input buffering */
name|BYTE
name|outBuff
index|[
name|SEEKABLE_BUFF_SIZE
index|]
decl_stmt|;
comment|/* so we can efficiently decompress the                                          starts of chunks before we get to the                                          desired section */
name|ZSTD_inBuffer
name|in
decl_stmt|;
comment|/* maintain continuity across ZSTD_seekable_decompress operations */
name|buffWrapper_t
name|buffWrapper
decl_stmt|;
comment|/* for `src.opaque` in in-memory mode */
name|XXH64_state_t
name|xxhState
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|ZSTD_seekable
modifier|*
name|ZSTD_seekable_create
parameter_list|(
name|void
parameter_list|)
block|{
name|ZSTD_seekable
modifier|*
name|zs
init|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|ZSTD_seekable
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|zs
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
comment|/* also initializes stage to zsds_init */
name|memset
argument_list|(
name|zs
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|zs
argument_list|)
argument_list|)
expr_stmt|;
name|zs
operator|->
name|dstream
operator|=
name|ZSTD_createDStream
argument_list|()
expr_stmt|;
if|if
condition|(
name|zs
operator|->
name|dstream
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|zs
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|zs
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_seekable_free
parameter_list|(
name|ZSTD_seekable
modifier|*
name|zs
parameter_list|)
block|{
if|if
condition|(
name|zs
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
comment|/* support free on null */
name|ZSTD_freeDStream
argument_list|(
name|zs
operator|->
name|dstream
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|zs
operator|->
name|seekTable
operator|.
name|entries
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|zs
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** ZSTD_seekable_offsetToFrameIndex() :  *  Performs a binary search to find the last frame with a decompressed offset  *<= pos  *  @return : the frame's index */
end_comment

begin_function
name|U32
name|ZSTD_seekable_offsetToFrameIndex
parameter_list|(
name|ZSTD_seekable
modifier|*
specifier|const
name|zs
parameter_list|,
name|U64
name|pos
parameter_list|)
block|{
name|U32
name|lo
init|=
literal|0
decl_stmt|;
name|U32
name|hi
init|=
name|zs
operator|->
name|seekTable
operator|.
name|tableLen
decl_stmt|;
if|if
condition|(
name|pos
operator|>=
name|zs
operator|->
name|seekTable
operator|.
name|entries
index|[
name|zs
operator|->
name|seekTable
operator|.
name|tableLen
index|]
operator|.
name|dOffset
condition|)
block|{
return|return
name|zs
operator|->
name|seekTable
operator|.
name|tableLen
return|;
block|}
while|while
condition|(
name|lo
operator|+
literal|1
operator|<
name|hi
condition|)
block|{
name|U32
specifier|const
name|mid
init|=
name|lo
operator|+
operator|(
operator|(
name|hi
operator|-
name|lo
operator|)
operator|>>
literal|1
operator|)
decl_stmt|;
if|if
condition|(
name|zs
operator|->
name|seekTable
operator|.
name|entries
index|[
name|mid
index|]
operator|.
name|dOffset
operator|<=
name|pos
condition|)
block|{
name|lo
operator|=
name|mid
expr_stmt|;
block|}
else|else
block|{
name|hi
operator|=
name|mid
expr_stmt|;
block|}
block|}
return|return
name|lo
return|;
block|}
end_function

begin_function
name|U32
name|ZSTD_seekable_getNumFrames
parameter_list|(
name|ZSTD_seekable
modifier|*
specifier|const
name|zs
parameter_list|)
block|{
return|return
name|zs
operator|->
name|seekTable
operator|.
name|tableLen
return|;
block|}
end_function

begin_function
name|U64
name|ZSTD_seekable_getFrameCompressedOffset
parameter_list|(
name|ZSTD_seekable
modifier|*
specifier|const
name|zs
parameter_list|,
name|U32
name|frameIndex
parameter_list|)
block|{
if|if
condition|(
name|frameIndex
operator|>=
name|zs
operator|->
name|seekTable
operator|.
name|tableLen
condition|)
return|return
name|ZSTD_SEEKABLE_FRAMEINDEX_TOOLARGE
return|;
return|return
name|zs
operator|->
name|seekTable
operator|.
name|entries
index|[
name|frameIndex
index|]
operator|.
name|cOffset
return|;
block|}
end_function

begin_function
name|U64
name|ZSTD_seekable_getFrameDecompressedOffset
parameter_list|(
name|ZSTD_seekable
modifier|*
specifier|const
name|zs
parameter_list|,
name|U32
name|frameIndex
parameter_list|)
block|{
if|if
condition|(
name|frameIndex
operator|>=
name|zs
operator|->
name|seekTable
operator|.
name|tableLen
condition|)
return|return
name|ZSTD_SEEKABLE_FRAMEINDEX_TOOLARGE
return|;
return|return
name|zs
operator|->
name|seekTable
operator|.
name|entries
index|[
name|frameIndex
index|]
operator|.
name|dOffset
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_seekable_getFrameCompressedSize
parameter_list|(
name|ZSTD_seekable
modifier|*
specifier|const
name|zs
parameter_list|,
name|U32
name|frameIndex
parameter_list|)
block|{
if|if
condition|(
name|frameIndex
operator|>=
name|zs
operator|->
name|seekTable
operator|.
name|tableLen
condition|)
return|return
name|ERROR
argument_list|(
name|frameIndex_tooLarge
argument_list|)
return|;
return|return
name|zs
operator|->
name|seekTable
operator|.
name|entries
index|[
name|frameIndex
operator|+
literal|1
index|]
operator|.
name|cOffset
operator|-
name|zs
operator|->
name|seekTable
operator|.
name|entries
index|[
name|frameIndex
index|]
operator|.
name|cOffset
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_seekable_getFrameDecompressedSize
parameter_list|(
name|ZSTD_seekable
modifier|*
specifier|const
name|zs
parameter_list|,
name|U32
name|frameIndex
parameter_list|)
block|{
if|if
condition|(
name|frameIndex
operator|>
name|zs
operator|->
name|seekTable
operator|.
name|tableLen
condition|)
return|return
name|ERROR
argument_list|(
name|frameIndex_tooLarge
argument_list|)
return|;
return|return
name|zs
operator|->
name|seekTable
operator|.
name|entries
index|[
name|frameIndex
operator|+
literal|1
index|]
operator|.
name|dOffset
operator|-
name|zs
operator|->
name|seekTable
operator|.
name|entries
index|[
name|frameIndex
index|]
operator|.
name|dOffset
return|;
block|}
end_function

begin_function
specifier|static
name|size_t
name|ZSTD_seekable_loadSeekTable
parameter_list|(
name|ZSTD_seekable
modifier|*
name|zs
parameter_list|)
block|{
name|int
name|checksumFlag
decl_stmt|;
name|ZSTD_seekable_customFile
name|src
init|=
name|zs
operator|->
name|src
decl_stmt|;
comment|/* read the footer, fixed size */
name|CHECK_IO
argument_list|(
name|src
operator|.
name|seek
argument_list|(
name|src
operator|.
name|opaque
argument_list|,
operator|-
operator|(
name|int
operator|)
name|ZSTD_seekTableFooterSize
argument_list|,
name|SEEK_END
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK_IO
argument_list|(
name|src
operator|.
name|read
argument_list|(
name|src
operator|.
name|opaque
argument_list|,
name|zs
operator|->
name|inBuff
argument_list|,
name|ZSTD_seekTableFooterSize
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|MEM_readLE32
argument_list|(
name|zs
operator|->
name|inBuff
operator|+
literal|5
argument_list|)
operator|!=
name|ZSTD_SEEKABLE_MAGICNUMBER
condition|)
block|{
return|return
name|ERROR
argument_list|(
name|prefix_unknown
argument_list|)
return|;
block|}
block|{
name|BYTE
specifier|const
name|sfd
init|=
name|zs
operator|->
name|inBuff
index|[
literal|4
index|]
decl_stmt|;
name|checksumFlag
operator|=
name|sfd
operator|>>
literal|7
expr_stmt|;
comment|/* check reserved bits */
if|if
condition|(
operator|(
name|checksumFlag
operator|>>
literal|2
operator|)
operator|&
literal|0x1f
condition|)
block|{
return|return
name|ERROR
argument_list|(
name|corruption_detected
argument_list|)
return|;
block|}
block|}
block|{
name|U32
specifier|const
name|numFrames
init|=
name|MEM_readLE32
argument_list|(
name|zs
operator|->
name|inBuff
argument_list|)
decl_stmt|;
name|U32
specifier|const
name|sizePerEntry
init|=
literal|8
operator|+
operator|(
name|checksumFlag
condition|?
literal|4
else|:
literal|0
operator|)
decl_stmt|;
name|U32
specifier|const
name|tableSize
init|=
name|sizePerEntry
operator|*
name|numFrames
decl_stmt|;
name|U32
specifier|const
name|frameSize
init|=
name|tableSize
operator|+
name|ZSTD_seekTableFooterSize
operator|+
name|ZSTD_skippableHeaderSize
decl_stmt|;
name|U32
name|remaining
init|=
name|frameSize
operator|-
name|ZSTD_seekTableFooterSize
decl_stmt|;
comment|/* don't need to re-read footer */
block|{
name|U32
specifier|const
name|toRead
init|=
name|MIN
argument_list|(
name|remaining
argument_list|,
name|SEEKABLE_BUFF_SIZE
argument_list|)
decl_stmt|;
name|CHECK_IO
argument_list|(
name|src
operator|.
name|seek
argument_list|(
name|src
operator|.
name|opaque
argument_list|,
operator|-
operator|(
name|S64
operator|)
name|frameSize
argument_list|,
name|SEEK_END
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK_IO
argument_list|(
name|src
operator|.
name|read
argument_list|(
name|src
operator|.
name|opaque
argument_list|,
name|zs
operator|->
name|inBuff
argument_list|,
name|toRead
argument_list|)
argument_list|)
expr_stmt|;
name|remaining
operator|-=
name|toRead
expr_stmt|;
block|}
if|if
condition|(
name|MEM_readLE32
argument_list|(
name|zs
operator|->
name|inBuff
argument_list|)
operator|!=
operator|(
name|ZSTD_MAGIC_SKIPPABLE_START
operator||
literal|0xE
operator|)
condition|)
block|{
return|return
name|ERROR
argument_list|(
name|prefix_unknown
argument_list|)
return|;
block|}
if|if
condition|(
name|MEM_readLE32
argument_list|(
name|zs
operator|->
name|inBuff
operator|+
literal|4
argument_list|)
operator|+
name|ZSTD_skippableHeaderSize
operator|!=
name|frameSize
condition|)
block|{
return|return
name|ERROR
argument_list|(
name|prefix_unknown
argument_list|)
return|;
block|}
block|{
comment|/* Allocate an extra entry at the end so that we can do size              * computations on the last element without special case */
name|seekEntry_t
modifier|*
name|entries
init|=
operator|(
name|seekEntry_t
operator|*
operator|)
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|seekEntry_t
argument_list|)
operator|*
operator|(
name|numFrames
operator|+
literal|1
operator|)
argument_list|)
decl_stmt|;
specifier|const
name|BYTE
modifier|*
name|tableBase
init|=
name|zs
operator|->
name|inBuff
operator|+
name|ZSTD_skippableHeaderSize
decl_stmt|;
name|U32
name|idx
init|=
literal|0
decl_stmt|;
name|U32
name|pos
init|=
literal|8
decl_stmt|;
name|U64
name|cOffset
init|=
literal|0
decl_stmt|;
name|U64
name|dOffset
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|entries
condition|)
block|{
name|free
argument_list|(
name|entries
argument_list|)
expr_stmt|;
return|return
name|ERROR
argument_list|(
name|memory_allocation
argument_list|)
return|;
block|}
comment|/* compute cumulative positions */
for|for
control|(
init|;
name|idx
operator|<
name|numFrames
condition|;
name|idx
operator|++
control|)
block|{
if|if
condition|(
name|pos
operator|+
name|sizePerEntry
operator|>
name|SEEKABLE_BUFF_SIZE
condition|)
block|{
name|U32
specifier|const
name|toRead
init|=
name|MIN
argument_list|(
name|remaining
argument_list|,
name|SEEKABLE_BUFF_SIZE
argument_list|)
decl_stmt|;
name|U32
specifier|const
name|offset
init|=
name|SEEKABLE_BUFF_SIZE
operator|-
name|pos
decl_stmt|;
name|memmove
argument_list|(
name|zs
operator|->
name|inBuff
argument_list|,
name|zs
operator|->
name|inBuff
operator|+
name|pos
argument_list|,
name|offset
argument_list|)
expr_stmt|;
comment|/* move any data we haven't read yet */
name|CHECK_IO
argument_list|(
name|src
operator|.
name|read
argument_list|(
name|src
operator|.
name|opaque
argument_list|,
name|zs
operator|->
name|inBuff
operator|+
name|offset
argument_list|,
name|toRead
argument_list|)
argument_list|)
expr_stmt|;
name|remaining
operator|-=
name|toRead
expr_stmt|;
name|pos
operator|=
literal|0
expr_stmt|;
block|}
name|entries
index|[
name|idx
index|]
operator|.
name|cOffset
operator|=
name|cOffset
expr_stmt|;
name|entries
index|[
name|idx
index|]
operator|.
name|dOffset
operator|=
name|dOffset
expr_stmt|;
name|cOffset
operator|+=
name|MEM_readLE32
argument_list|(
name|zs
operator|->
name|inBuff
operator|+
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|4
expr_stmt|;
name|dOffset
operator|+=
name|MEM_readLE32
argument_list|(
name|zs
operator|->
name|inBuff
operator|+
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|4
expr_stmt|;
if|if
condition|(
name|checksumFlag
condition|)
block|{
name|entries
index|[
name|idx
index|]
operator|.
name|checksum
operator|=
name|MEM_readLE32
argument_list|(
name|zs
operator|->
name|inBuff
operator|+
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|4
expr_stmt|;
block|}
block|}
name|entries
index|[
name|numFrames
index|]
operator|.
name|cOffset
operator|=
name|cOffset
expr_stmt|;
name|entries
index|[
name|numFrames
index|]
operator|.
name|dOffset
operator|=
name|dOffset
expr_stmt|;
name|zs
operator|->
name|seekTable
operator|.
name|entries
operator|=
name|entries
expr_stmt|;
name|zs
operator|->
name|seekTable
operator|.
name|tableLen
operator|=
name|numFrames
expr_stmt|;
name|zs
operator|->
name|seekTable
operator|.
name|checksumFlag
operator|=
name|checksumFlag
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
block|}
end_function

begin_function
name|size_t
name|ZSTD_seekable_initBuff
parameter_list|(
name|ZSTD_seekable
modifier|*
name|zs
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|)
block|{
name|zs
operator|->
name|buffWrapper
operator|=
operator|(
name|buffWrapper_t
operator|)
block|{
name|src
block|,
name|srcSize
block|,
literal|0
block|}
expr_stmt|;
block|{
name|ZSTD_seekable_customFile
name|srcFile
init|=
block|{
operator|&
name|zs
operator|->
name|buffWrapper
block|,
operator|&
name|ZSTD_seekable_read_buff
block|,
operator|&
name|ZSTD_seekable_seek_buff
block|}
decl_stmt|;
return|return
name|ZSTD_seekable_initAdvanced
argument_list|(
name|zs
argument_list|,
name|srcFile
argument_list|)
return|;
block|}
block|}
end_function

begin_function
name|size_t
name|ZSTD_seekable_initFile
parameter_list|(
name|ZSTD_seekable
modifier|*
name|zs
parameter_list|,
name|FILE
modifier|*
name|src
parameter_list|)
block|{
name|ZSTD_seekable_customFile
name|srcFile
init|=
block|{
name|src
block|,
operator|&
name|ZSTD_seekable_read_FILE
block|,
operator|&
name|ZSTD_seekable_seek_FILE
block|}
decl_stmt|;
return|return
name|ZSTD_seekable_initAdvanced
argument_list|(
name|zs
argument_list|,
name|srcFile
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_seekable_initAdvanced
parameter_list|(
name|ZSTD_seekable
modifier|*
name|zs
parameter_list|,
name|ZSTD_seekable_customFile
name|src
parameter_list|)
block|{
name|zs
operator|->
name|src
operator|=
name|src
expr_stmt|;
block|{
specifier|const
name|size_t
name|seekTableInit
init|=
name|ZSTD_seekable_loadSeekTable
argument_list|(
name|zs
argument_list|)
decl_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|seekTableInit
argument_list|)
condition|)
return|return
name|seekTableInit
return|;
block|}
name|zs
operator|->
name|decompressedOffset
operator|=
operator|(
name|U64
operator|)
operator|-
literal|1
expr_stmt|;
name|zs
operator|->
name|curFrame
operator|=
operator|(
name|U32
operator|)
operator|-
literal|1
expr_stmt|;
block|{
specifier|const
name|size_t
name|dstreamInit
init|=
name|ZSTD_initDStream
argument_list|(
name|zs
operator|->
name|dstream
argument_list|)
decl_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|dstreamInit
argument_list|)
condition|)
return|return
name|dstreamInit
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_seekable_decompress
parameter_list|(
name|ZSTD_seekable
modifier|*
name|zs
parameter_list|,
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|len
parameter_list|,
name|U64
name|offset
parameter_list|)
block|{
name|U32
name|targetFrame
init|=
name|ZSTD_seekable_offsetToFrameIndex
argument_list|(
name|zs
argument_list|,
name|offset
argument_list|)
decl_stmt|;
do|do
block|{
comment|/* check if we can continue from a previous decompress job */
if|if
condition|(
name|targetFrame
operator|!=
name|zs
operator|->
name|curFrame
operator|||
name|offset
operator|!=
name|zs
operator|->
name|decompressedOffset
condition|)
block|{
name|zs
operator|->
name|decompressedOffset
operator|=
name|zs
operator|->
name|seekTable
operator|.
name|entries
index|[
name|targetFrame
index|]
operator|.
name|dOffset
expr_stmt|;
name|zs
operator|->
name|curFrame
operator|=
name|targetFrame
expr_stmt|;
name|CHECK_IO
argument_list|(
name|zs
operator|->
name|src
operator|.
name|seek
argument_list|(
name|zs
operator|->
name|src
operator|.
name|opaque
argument_list|,
name|zs
operator|->
name|seekTable
operator|.
name|entries
index|[
name|targetFrame
index|]
operator|.
name|cOffset
argument_list|,
name|SEEK_SET
argument_list|)
argument_list|)
expr_stmt|;
name|zs
operator|->
name|in
operator|=
operator|(
name|ZSTD_inBuffer
operator|)
block|{
name|zs
operator|->
name|inBuff
block|,
literal|0
block|,
literal|0
block|}
expr_stmt|;
name|XXH64_reset
argument_list|(
operator|&
name|zs
operator|->
name|xxhState
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ZSTD_resetDStream
argument_list|(
name|zs
operator|->
name|dstream
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|zs
operator|->
name|decompressedOffset
operator|<
name|offset
operator|+
name|len
condition|)
block|{
name|size_t
name|toRead
decl_stmt|;
name|ZSTD_outBuffer
name|outTmp
decl_stmt|;
name|size_t
name|prevOutPos
decl_stmt|;
if|if
condition|(
name|zs
operator|->
name|decompressedOffset
operator|<
name|offset
condition|)
block|{
comment|/* dummy decompressions until we get to the target offset */
name|outTmp
operator|=
operator|(
name|ZSTD_outBuffer
operator|)
block|{
name|zs
operator|->
name|outBuff
block|,
name|MIN
argument_list|(
name|SEEKABLE_BUFF_SIZE
argument_list|,
name|offset
operator|-
name|zs
operator|->
name|decompressedOffset
argument_list|)
block|,
literal|0
block|}
expr_stmt|;
block|}
else|else
block|{
name|outTmp
operator|=
operator|(
name|ZSTD_outBuffer
operator|)
block|{
name|dst
block|,
name|len
block|,
name|zs
operator|->
name|decompressedOffset
operator|-
name|offset
block|}
expr_stmt|;
block|}
name|prevOutPos
operator|=
name|outTmp
operator|.
name|pos
expr_stmt|;
name|toRead
operator|=
name|ZSTD_decompressStream
argument_list|(
name|zs
operator|->
name|dstream
argument_list|,
operator|&
name|outTmp
argument_list|,
operator|&
name|zs
operator|->
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|toRead
argument_list|)
condition|)
block|{
return|return
name|toRead
return|;
block|}
if|if
condition|(
name|zs
operator|->
name|seekTable
operator|.
name|checksumFlag
condition|)
block|{
name|XXH64_update
argument_list|(
operator|&
name|zs
operator|->
name|xxhState
argument_list|,
operator|(
name|BYTE
operator|*
operator|)
name|outTmp
operator|.
name|dst
operator|+
name|prevOutPos
argument_list|,
name|outTmp
operator|.
name|pos
operator|-
name|prevOutPos
argument_list|)
expr_stmt|;
block|}
name|zs
operator|->
name|decompressedOffset
operator|+=
name|outTmp
operator|.
name|pos
operator|-
name|prevOutPos
expr_stmt|;
if|if
condition|(
name|toRead
operator|==
literal|0
condition|)
block|{
comment|/* frame complete */
comment|/* verify checksum */
if|if
condition|(
name|zs
operator|->
name|seekTable
operator|.
name|checksumFlag
operator|&&
operator|(
name|XXH64_digest
argument_list|(
operator|&
name|zs
operator|->
name|xxhState
argument_list|)
operator|&
literal|0xFFFFFFFFU
operator|)
operator|!=
name|zs
operator|->
name|seekTable
operator|.
name|entries
index|[
name|targetFrame
index|]
operator|.
name|checksum
condition|)
block|{
return|return
name|ERROR
argument_list|(
name|corruption_detected
argument_list|)
return|;
block|}
if|if
condition|(
name|zs
operator|->
name|decompressedOffset
operator|<
name|offset
operator|+
name|len
condition|)
block|{
comment|/* go back to the start and force a reset of the stream */
name|targetFrame
operator|=
name|ZSTD_seekable_offsetToFrameIndex
argument_list|(
name|zs
argument_list|,
name|zs
operator|->
name|decompressedOffset
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
comment|/* read in more data if we're done with this buffer */
if|if
condition|(
name|zs
operator|->
name|in
operator|.
name|pos
operator|==
name|zs
operator|->
name|in
operator|.
name|size
condition|)
block|{
name|toRead
operator|=
name|MIN
argument_list|(
name|toRead
argument_list|,
name|SEEKABLE_BUFF_SIZE
argument_list|)
expr_stmt|;
name|CHECK_IO
argument_list|(
name|zs
operator|->
name|src
operator|.
name|read
argument_list|(
name|zs
operator|->
name|src
operator|.
name|opaque
argument_list|,
name|zs
operator|->
name|inBuff
argument_list|,
name|toRead
argument_list|)
argument_list|)
expr_stmt|;
name|zs
operator|->
name|in
operator|.
name|size
operator|=
name|toRead
expr_stmt|;
name|zs
operator|->
name|in
operator|.
name|pos
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
do|while
condition|(
name|zs
operator|->
name|decompressedOffset
operator|!=
name|offset
operator|+
name|len
condition|)
do|;
return|return
name|len
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_seekable_decompressFrame
parameter_list|(
name|ZSTD_seekable
modifier|*
name|zs
parameter_list|,
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstSize
parameter_list|,
name|U32
name|frameIndex
parameter_list|)
block|{
if|if
condition|(
name|frameIndex
operator|>=
name|zs
operator|->
name|seekTable
operator|.
name|tableLen
condition|)
block|{
return|return
name|ERROR
argument_list|(
name|frameIndex_tooLarge
argument_list|)
return|;
block|}
block|{
name|size_t
specifier|const
name|decompressedSize
init|=
name|zs
operator|->
name|seekTable
operator|.
name|entries
index|[
name|frameIndex
operator|+
literal|1
index|]
operator|.
name|dOffset
operator|-
name|zs
operator|->
name|seekTable
operator|.
name|entries
index|[
name|frameIndex
index|]
operator|.
name|dOffset
decl_stmt|;
if|if
condition|(
name|dstSize
operator|<
name|decompressedSize
condition|)
block|{
return|return
name|ERROR
argument_list|(
name|dstSize_tooSmall
argument_list|)
return|;
block|}
return|return
name|ZSTD_seekable_decompress
argument_list|(
name|zs
argument_list|,
name|dst
argument_list|,
name|decompressedSize
argument_list|,
name|zs
operator|->
name|seekTable
operator|.
name|entries
index|[
name|frameIndex
index|]
operator|.
name|dOffset
argument_list|)
return|;
block|}
block|}
end_function

end_unit


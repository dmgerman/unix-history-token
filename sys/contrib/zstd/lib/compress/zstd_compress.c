begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2016-present, Yann Collet, Facebook, Inc.  * All rights reserved.  *  * This source code is licensed under both the BSD-style license (found in the  * LICENSE file in the root directory of this source tree) and the GPLv2 (found  * in the COPYING file in the root directory of this source tree).  * You may select, at your option, one of the above-listed licenses.  */
end_comment

begin_comment
comment|/*-************************************* *  Tuning parameters ***************************************/
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|ZSTD_CLEVEL_DEFAULT
end_ifndef

begin_define
define|#
directive|define
name|ZSTD_CLEVEL_DEFAULT
value|3
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*-************************************* *  Dependencies ***************************************/
end_comment

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_comment
comment|/* memset */
end_comment

begin_include
include|#
directive|include
file|"mem.h"
end_include

begin_define
define|#
directive|define
name|FSE_STATIC_LINKING_ONLY
end_define

begin_comment
comment|/* FSE_encodeSymbol */
end_comment

begin_include
include|#
directive|include
file|"fse.h"
end_include

begin_define
define|#
directive|define
name|HUF_STATIC_LINKING_ONLY
end_define

begin_include
include|#
directive|include
file|"huf.h"
end_include

begin_include
include|#
directive|include
file|"zstd_compress.h"
end_include

begin_include
include|#
directive|include
file|"zstd_fast.h"
end_include

begin_include
include|#
directive|include
file|"zstd_double_fast.h"
end_include

begin_include
include|#
directive|include
file|"zstd_lazy.h"
end_include

begin_include
include|#
directive|include
file|"zstd_opt.h"
end_include

begin_include
include|#
directive|include
file|"zstd_ldm.h"
end_include

begin_comment
comment|/*-************************************* *  Helper functions ***************************************/
end_comment

begin_function
name|size_t
name|ZSTD_compressBound
parameter_list|(
name|size_t
name|srcSize
parameter_list|)
block|{
return|return
name|ZSTD_COMPRESSBOUND
argument_list|(
name|srcSize
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*-************************************* *  Sequence storage ***************************************/
end_comment

begin_function
specifier|static
name|void
name|ZSTD_resetSeqStore
parameter_list|(
name|seqStore_t
modifier|*
name|ssPtr
parameter_list|)
block|{
name|ssPtr
operator|->
name|lit
operator|=
name|ssPtr
operator|->
name|litStart
expr_stmt|;
name|ssPtr
operator|->
name|sequences
operator|=
name|ssPtr
operator|->
name|sequencesStart
expr_stmt|;
name|ssPtr
operator|->
name|longLengthID
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*-************************************* *  Context memory management ***************************************/
end_comment

begin_struct
struct|struct
name|ZSTD_CDict_s
block|{
name|void
modifier|*
name|dictBuffer
decl_stmt|;
specifier|const
name|void
modifier|*
name|dictContent
decl_stmt|;
name|size_t
name|dictContentSize
decl_stmt|;
name|ZSTD_CCtx
modifier|*
name|refContext
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* typedef'd to ZSTD_CDict within "zstd.h" */
end_comment

begin_function
name|ZSTD_CCtx
modifier|*
name|ZSTD_createCCtx
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|ZSTD_createCCtx_advanced
argument_list|(
name|ZSTD_defaultCMem
argument_list|)
return|;
block|}
end_function

begin_function
name|ZSTD_CCtx
modifier|*
name|ZSTD_createCCtx_advanced
parameter_list|(
name|ZSTD_customMem
name|customMem
parameter_list|)
block|{
name|ZSTD_CCtx
modifier|*
name|cctx
decl_stmt|;
if|if
condition|(
operator|!
name|customMem
operator|.
name|customAlloc
operator|^
operator|!
name|customMem
operator|.
name|customFree
condition|)
return|return
name|NULL
return|;
name|cctx
operator|=
operator|(
name|ZSTD_CCtx
operator|*
operator|)
name|ZSTD_calloc
argument_list|(
sizeof|sizeof
argument_list|(
name|ZSTD_CCtx
argument_list|)
argument_list|,
name|customMem
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cctx
condition|)
return|return
name|NULL
return|;
name|cctx
operator|->
name|customMem
operator|=
name|customMem
expr_stmt|;
name|cctx
operator|->
name|requestedParams
operator|.
name|compressionLevel
operator|=
name|ZSTD_CLEVEL_DEFAULT
expr_stmt|;
name|ZSTD_STATIC_ASSERT
argument_list|(
name|zcss_init
operator|==
literal|0
argument_list|)
expr_stmt|;
name|ZSTD_STATIC_ASSERT
argument_list|(
name|ZSTD_CONTENTSIZE_UNKNOWN
operator|==
operator|(
literal|0ULL
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
return|return
name|cctx
return|;
block|}
end_function

begin_function
name|ZSTD_CCtx
modifier|*
name|ZSTD_initStaticCCtx
parameter_list|(
name|void
modifier|*
name|workspace
parameter_list|,
name|size_t
name|workspaceSize
parameter_list|)
block|{
name|ZSTD_CCtx
modifier|*
specifier|const
name|cctx
init|=
operator|(
name|ZSTD_CCtx
operator|*
operator|)
name|workspace
decl_stmt|;
if|if
condition|(
name|workspaceSize
operator|<=
sizeof|sizeof
argument_list|(
name|ZSTD_CCtx
argument_list|)
condition|)
return|return
name|NULL
return|;
comment|/* minimum size */
if|if
condition|(
operator|(
name|size_t
operator|)
name|workspace
operator|&
literal|7
condition|)
return|return
name|NULL
return|;
comment|/* must be 8-aligned */
name|memset
argument_list|(
name|workspace
argument_list|,
literal|0
argument_list|,
name|workspaceSize
argument_list|)
expr_stmt|;
comment|/* may be a bit generous, could memset be smaller ? */
name|cctx
operator|->
name|staticSize
operator|=
name|workspaceSize
expr_stmt|;
name|cctx
operator|->
name|workSpace
operator|=
operator|(
name|void
operator|*
operator|)
operator|(
name|cctx
operator|+
literal|1
operator|)
expr_stmt|;
name|cctx
operator|->
name|workSpaceSize
operator|=
name|workspaceSize
operator|-
sizeof|sizeof
argument_list|(
name|ZSTD_CCtx
argument_list|)
expr_stmt|;
comment|/* entropy space (never moves) */
if|if
condition|(
name|cctx
operator|->
name|workSpaceSize
operator|<
sizeof|sizeof
argument_list|(
name|ZSTD_entropyCTables_t
argument_list|)
condition|)
return|return
name|NULL
return|;
name|assert
argument_list|(
operator|(
operator|(
name|size_t
operator|)
name|cctx
operator|->
name|workSpace
operator|&
operator|(
sizeof|sizeof
argument_list|(
name|void
operator|*
argument_list|)
operator|-
literal|1
operator|)
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* ensure correct alignment */
name|cctx
operator|->
name|entropy
operator|=
operator|(
name|ZSTD_entropyCTables_t
operator|*
operator|)
name|cctx
operator|->
name|workSpace
expr_stmt|;
return|return
name|cctx
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_freeCCtx
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|)
block|{
if|if
condition|(
name|cctx
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
comment|/* support free on NULL */
if|if
condition|(
name|cctx
operator|->
name|staticSize
condition|)
return|return
name|ERROR
argument_list|(
name|memory_allocation
argument_list|)
return|;
comment|/* not compatible with static CCtx */
name|ZSTD_free
argument_list|(
name|cctx
operator|->
name|workSpace
argument_list|,
name|cctx
operator|->
name|customMem
argument_list|)
expr_stmt|;
name|cctx
operator|->
name|workSpace
operator|=
name|NULL
expr_stmt|;
name|ZSTD_freeCDict
argument_list|(
name|cctx
operator|->
name|cdictLocal
argument_list|)
expr_stmt|;
name|cctx
operator|->
name|cdictLocal
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|ZSTD_MULTITHREAD
name|ZSTDMT_freeCCtx
argument_list|(
name|cctx
operator|->
name|mtctx
argument_list|)
expr_stmt|;
name|cctx
operator|->
name|mtctx
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
name|ZSTD_free
argument_list|(
name|cctx
argument_list|,
name|cctx
operator|->
name|customMem
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
comment|/* reserved as a potential error code in the future */
block|}
end_function

begin_function
specifier|static
name|size_t
name|ZSTD_sizeof_mtctx
parameter_list|(
specifier|const
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|ZSTD_MULTITHREAD
return|return
name|ZSTDMT_sizeof_CCtx
argument_list|(
name|cctx
operator|->
name|mtctx
argument_list|)
return|;
else|#
directive|else
operator|(
name|void
operator|)
name|cctx
expr_stmt|;
return|return
literal|0
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|size_t
name|ZSTD_sizeof_CCtx
parameter_list|(
specifier|const
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|)
block|{
if|if
condition|(
name|cctx
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
comment|/* support sizeof on NULL */
name|DEBUGLOG
argument_list|(
literal|3
argument_list|,
literal|"sizeof(*cctx) : %u"
argument_list|,
operator|(
name|U32
operator|)
sizeof|sizeof
argument_list|(
operator|*
name|cctx
argument_list|)
argument_list|)
expr_stmt|;
name|DEBUGLOG
argument_list|(
literal|3
argument_list|,
literal|"workSpaceSize (including streaming buffers): %u"
argument_list|,
operator|(
name|U32
operator|)
name|cctx
operator|->
name|workSpaceSize
argument_list|)
expr_stmt|;
name|DEBUGLOG
argument_list|(
literal|3
argument_list|,
literal|"inner cdict : %u"
argument_list|,
operator|(
name|U32
operator|)
name|ZSTD_sizeof_CDict
argument_list|(
name|cctx
operator|->
name|cdictLocal
argument_list|)
argument_list|)
expr_stmt|;
name|DEBUGLOG
argument_list|(
literal|3
argument_list|,
literal|"inner MTCTX : %u"
argument_list|,
operator|(
name|U32
operator|)
name|ZSTD_sizeof_mtctx
argument_list|(
name|cctx
argument_list|)
argument_list|)
expr_stmt|;
return|return
sizeof|sizeof
argument_list|(
operator|*
name|cctx
argument_list|)
operator|+
name|cctx
operator|->
name|workSpaceSize
operator|+
name|ZSTD_sizeof_CDict
argument_list|(
name|cctx
operator|->
name|cdictLocal
argument_list|)
operator|+
name|ZSTD_sizeof_mtctx
argument_list|(
name|cctx
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_sizeof_CStream
parameter_list|(
specifier|const
name|ZSTD_CStream
modifier|*
name|zcs
parameter_list|)
block|{
return|return
name|ZSTD_sizeof_CCtx
argument_list|(
name|zcs
argument_list|)
return|;
comment|/* same object */
block|}
end_function

begin_comment
comment|/* private API call, for dictBuilder only */
end_comment

begin_function
specifier|const
name|seqStore_t
modifier|*
name|ZSTD_getSeqStore
parameter_list|(
specifier|const
name|ZSTD_CCtx
modifier|*
name|ctx
parameter_list|)
block|{
return|return
operator|&
operator|(
name|ctx
operator|->
name|seqStore
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|ZSTD_CLEVEL_CUSTOM
value|999
end_define

begin_function
specifier|static
name|ZSTD_compressionParameters
name|ZSTD_getCParamsFromCCtxParams
parameter_list|(
name|ZSTD_CCtx_params
name|params
parameter_list|,
name|U64
name|srcSizeHint
parameter_list|,
name|size_t
name|dictSize
parameter_list|)
block|{
return|return
operator|(
name|params
operator|.
name|compressionLevel
operator|==
name|ZSTD_CLEVEL_CUSTOM
condition|?
name|params
operator|.
name|cParams
else|:
name|ZSTD_getCParams
argument_list|(
name|params
operator|.
name|compressionLevel
argument_list|,
name|srcSizeHint
argument_list|,
name|dictSize
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ZSTD_cLevelToCCtxParams_srcSize
parameter_list|(
name|ZSTD_CCtx_params
modifier|*
name|params
parameter_list|,
name|U64
name|srcSize
parameter_list|)
block|{
name|params
operator|->
name|cParams
operator|=
name|ZSTD_getCParamsFromCCtxParams
argument_list|(
operator|*
name|params
argument_list|,
name|srcSize
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|params
operator|->
name|compressionLevel
operator|=
name|ZSTD_CLEVEL_CUSTOM
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ZSTD_cLevelToCParams
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|)
block|{
name|ZSTD_cLevelToCCtxParams_srcSize
argument_list|(
operator|&
name|cctx
operator|->
name|requestedParams
argument_list|,
name|cctx
operator|->
name|pledgedSrcSizePlusOne
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ZSTD_cLevelToCCtxParams
parameter_list|(
name|ZSTD_CCtx_params
modifier|*
name|params
parameter_list|)
block|{
name|ZSTD_cLevelToCCtxParams_srcSize
argument_list|(
name|params
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|ZSTD_CCtx_params
name|ZSTD_makeCCtxParamsFromCParams
parameter_list|(
name|ZSTD_compressionParameters
name|cParams
parameter_list|)
block|{
name|ZSTD_CCtx_params
name|cctxParams
decl_stmt|;
name|memset
argument_list|(
operator|&
name|cctxParams
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cctxParams
argument_list|)
argument_list|)
expr_stmt|;
name|cctxParams
operator|.
name|cParams
operator|=
name|cParams
expr_stmt|;
name|cctxParams
operator|.
name|compressionLevel
operator|=
name|ZSTD_CLEVEL_CUSTOM
expr_stmt|;
return|return
name|cctxParams
return|;
block|}
end_function

begin_function
specifier|static
name|ZSTD_CCtx_params
modifier|*
name|ZSTD_createCCtxParams_advanced
parameter_list|(
name|ZSTD_customMem
name|customMem
parameter_list|)
block|{
name|ZSTD_CCtx_params
modifier|*
name|params
decl_stmt|;
if|if
condition|(
operator|!
name|customMem
operator|.
name|customAlloc
operator|^
operator|!
name|customMem
operator|.
name|customFree
condition|)
return|return
name|NULL
return|;
name|params
operator|=
operator|(
name|ZSTD_CCtx_params
operator|*
operator|)
name|ZSTD_calloc
argument_list|(
sizeof|sizeof
argument_list|(
name|ZSTD_CCtx_params
argument_list|)
argument_list|,
name|customMem
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|params
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|params
operator|->
name|customMem
operator|=
name|customMem
expr_stmt|;
name|params
operator|->
name|compressionLevel
operator|=
name|ZSTD_CLEVEL_DEFAULT
expr_stmt|;
return|return
name|params
return|;
block|}
end_function

begin_function
name|ZSTD_CCtx_params
modifier|*
name|ZSTD_createCCtxParams
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|ZSTD_createCCtxParams_advanced
argument_list|(
name|ZSTD_defaultCMem
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_freeCCtxParams
parameter_list|(
name|ZSTD_CCtx_params
modifier|*
name|params
parameter_list|)
block|{
if|if
condition|(
name|params
operator|==
name|NULL
condition|)
block|{
return|return
literal|0
return|;
block|}
name|ZSTD_free
argument_list|(
name|params
argument_list|,
name|params
operator|->
name|customMem
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_resetCCtxParams
parameter_list|(
name|ZSTD_CCtx_params
modifier|*
name|params
parameter_list|)
block|{
return|return
name|ZSTD_initCCtxParams
argument_list|(
name|params
argument_list|,
name|ZSTD_CLEVEL_DEFAULT
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_initCCtxParams
parameter_list|(
name|ZSTD_CCtx_params
modifier|*
name|cctxParams
parameter_list|,
name|int
name|compressionLevel
parameter_list|)
block|{
if|if
condition|(
operator|!
name|cctxParams
condition|)
block|{
return|return
name|ERROR
argument_list|(
name|GENERIC
argument_list|)
return|;
block|}
name|memset
argument_list|(
name|cctxParams
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cctxParams
argument_list|)
argument_list|)
expr_stmt|;
name|cctxParams
operator|->
name|compressionLevel
operator|=
name|compressionLevel
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_initCCtxParams_advanced
parameter_list|(
name|ZSTD_CCtx_params
modifier|*
name|cctxParams
parameter_list|,
name|ZSTD_parameters
name|params
parameter_list|)
block|{
if|if
condition|(
operator|!
name|cctxParams
condition|)
block|{
return|return
name|ERROR
argument_list|(
name|GENERIC
argument_list|)
return|;
block|}
name|CHECK_F
argument_list|(
name|ZSTD_checkCParams
argument_list|(
name|params
operator|.
name|cParams
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|cctxParams
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cctxParams
argument_list|)
argument_list|)
expr_stmt|;
name|cctxParams
operator|->
name|cParams
operator|=
name|params
operator|.
name|cParams
expr_stmt|;
name|cctxParams
operator|->
name|fParams
operator|=
name|params
operator|.
name|fParams
expr_stmt|;
name|cctxParams
operator|->
name|compressionLevel
operator|=
name|ZSTD_CLEVEL_CUSTOM
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|ZSTD_CCtx_params
name|ZSTD_assignParamsToCCtxParams
parameter_list|(
name|ZSTD_CCtx_params
name|cctxParams
parameter_list|,
name|ZSTD_parameters
name|params
parameter_list|)
block|{
name|ZSTD_CCtx_params
name|ret
init|=
name|cctxParams
decl_stmt|;
name|ret
operator|.
name|cParams
operator|=
name|params
operator|.
name|cParams
expr_stmt|;
name|ret
operator|.
name|fParams
operator|=
name|params
operator|.
name|fParams
expr_stmt|;
name|ret
operator|.
name|compressionLevel
operator|=
name|ZSTD_CLEVEL_CUSTOM
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_define
define|#
directive|define
name|CLAMPCHECK
parameter_list|(
name|val
parameter_list|,
name|min
parameter_list|,
name|max
parameter_list|)
value|{            \     if (((val)<(min)) | ((val)>(max))) {     \         return ERROR(parameter_outOfBound);  \ }   }
end_define

begin_function
name|size_t
name|ZSTD_CCtx_setParameter
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
name|ZSTD_cParameter
name|param
parameter_list|,
name|unsigned
name|value
parameter_list|)
block|{
if|if
condition|(
name|cctx
operator|->
name|streamStage
operator|!=
name|zcss_init
condition|)
return|return
name|ERROR
argument_list|(
name|stage_wrong
argument_list|)
return|;
switch|switch
condition|(
name|param
condition|)
block|{
case|case
name|ZSTD_p_format
case|:
return|return
name|ZSTD_CCtxParam_setParameter
argument_list|(
operator|&
name|cctx
operator|->
name|requestedParams
argument_list|,
name|param
argument_list|,
name|value
argument_list|)
return|;
case|case
name|ZSTD_p_compressionLevel
case|:
if|if
condition|(
name|value
operator|==
literal|0
condition|)
return|return
literal|0
return|;
comment|/* special value : 0 means "don't change anything" */
if|if
condition|(
name|cctx
operator|->
name|cdict
condition|)
return|return
name|ERROR
argument_list|(
name|stage_wrong
argument_list|)
return|;
return|return
name|ZSTD_CCtxParam_setParameter
argument_list|(
operator|&
name|cctx
operator|->
name|requestedParams
argument_list|,
name|param
argument_list|,
name|value
argument_list|)
return|;
case|case
name|ZSTD_p_windowLog
case|:
case|case
name|ZSTD_p_hashLog
case|:
case|case
name|ZSTD_p_chainLog
case|:
case|case
name|ZSTD_p_searchLog
case|:
case|case
name|ZSTD_p_minMatch
case|:
case|case
name|ZSTD_p_targetLength
case|:
case|case
name|ZSTD_p_compressionStrategy
case|:
if|if
condition|(
name|value
operator|==
literal|0
condition|)
return|return
literal|0
return|;
comment|/* special value : 0 means "don't change anything" */
if|if
condition|(
name|cctx
operator|->
name|cdict
condition|)
return|return
name|ERROR
argument_list|(
name|stage_wrong
argument_list|)
return|;
name|ZSTD_cLevelToCParams
argument_list|(
name|cctx
argument_list|)
expr_stmt|;
comment|/* Can optimize if srcSize is known */
return|return
name|ZSTD_CCtxParam_setParameter
argument_list|(
operator|&
name|cctx
operator|->
name|requestedParams
argument_list|,
name|param
argument_list|,
name|value
argument_list|)
return|;
case|case
name|ZSTD_p_contentSizeFlag
case|:
case|case
name|ZSTD_p_checksumFlag
case|:
case|case
name|ZSTD_p_dictIDFlag
case|:
return|return
name|ZSTD_CCtxParam_setParameter
argument_list|(
operator|&
name|cctx
operator|->
name|requestedParams
argument_list|,
name|param
argument_list|,
name|value
argument_list|)
return|;
case|case
name|ZSTD_p_forceMaxWindow
case|:
comment|/* Force back-references to remain< windowSize,                                    * even when referencing into Dictionary content                                    * default : 0 when using a CDict, 1 when using a Prefix */
name|cctx
operator|->
name|loadedDictEnd
operator|=
literal|0
expr_stmt|;
return|return
name|ZSTD_CCtxParam_setParameter
argument_list|(
operator|&
name|cctx
operator|->
name|requestedParams
argument_list|,
name|param
argument_list|,
name|value
argument_list|)
return|;
case|case
name|ZSTD_p_nbThreads
case|:
if|if
condition|(
name|value
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|" setting nbThreads : %u"
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|>
literal|1
operator|&&
name|cctx
operator|->
name|staticSize
condition|)
block|{
return|return
name|ERROR
argument_list|(
name|parameter_unsupported
argument_list|)
return|;
comment|/* MT not compatible with static alloc */
block|}
return|return
name|ZSTD_CCtxParam_setParameter
argument_list|(
operator|&
name|cctx
operator|->
name|requestedParams
argument_list|,
name|param
argument_list|,
name|value
argument_list|)
return|;
case|case
name|ZSTD_p_jobSize
case|:
return|return
name|ZSTD_CCtxParam_setParameter
argument_list|(
operator|&
name|cctx
operator|->
name|requestedParams
argument_list|,
name|param
argument_list|,
name|value
argument_list|)
return|;
case|case
name|ZSTD_p_overlapSizeLog
case|:
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|" setting overlap with nbThreads == %u"
argument_list|,
name|cctx
operator|->
name|requestedParams
operator|.
name|nbThreads
argument_list|)
expr_stmt|;
return|return
name|ZSTD_CCtxParam_setParameter
argument_list|(
operator|&
name|cctx
operator|->
name|requestedParams
argument_list|,
name|param
argument_list|,
name|value
argument_list|)
return|;
case|case
name|ZSTD_p_enableLongDistanceMatching
case|:
if|if
condition|(
name|cctx
operator|->
name|cdict
condition|)
return|return
name|ERROR
argument_list|(
name|stage_wrong
argument_list|)
return|;
if|if
condition|(
name|value
operator|!=
literal|0
condition|)
block|{
name|ZSTD_cLevelToCParams
argument_list|(
name|cctx
argument_list|)
expr_stmt|;
block|}
return|return
name|ZSTD_CCtxParam_setParameter
argument_list|(
operator|&
name|cctx
operator|->
name|requestedParams
argument_list|,
name|param
argument_list|,
name|value
argument_list|)
return|;
case|case
name|ZSTD_p_ldmHashLog
case|:
case|case
name|ZSTD_p_ldmMinMatch
case|:
if|if
condition|(
name|value
operator|==
literal|0
condition|)
return|return
literal|0
return|;
comment|/* special value : 0 means "don't change anything" */
if|if
condition|(
name|cctx
operator|->
name|cdict
condition|)
return|return
name|ERROR
argument_list|(
name|stage_wrong
argument_list|)
return|;
return|return
name|ZSTD_CCtxParam_setParameter
argument_list|(
operator|&
name|cctx
operator|->
name|requestedParams
argument_list|,
name|param
argument_list|,
name|value
argument_list|)
return|;
case|case
name|ZSTD_p_ldmBucketSizeLog
case|:
case|case
name|ZSTD_p_ldmHashEveryLog
case|:
if|if
condition|(
name|cctx
operator|->
name|cdict
condition|)
return|return
name|ERROR
argument_list|(
name|stage_wrong
argument_list|)
return|;
return|return
name|ZSTD_CCtxParam_setParameter
argument_list|(
operator|&
name|cctx
operator|->
name|requestedParams
argument_list|,
name|param
argument_list|,
name|value
argument_list|)
return|;
default|default:
return|return
name|ERROR
argument_list|(
name|parameter_unsupported
argument_list|)
return|;
block|}
block|}
end_function

begin_function
name|size_t
name|ZSTD_CCtxParam_setParameter
parameter_list|(
name|ZSTD_CCtx_params
modifier|*
name|params
parameter_list|,
name|ZSTD_cParameter
name|param
parameter_list|,
name|unsigned
name|value
parameter_list|)
block|{
switch|switch
condition|(
name|param
condition|)
block|{
case|case
name|ZSTD_p_format
case|:
if|if
condition|(
name|value
operator|>
operator|(
name|unsigned
operator|)
name|ZSTD_f_zstd1_magicless
condition|)
return|return
name|ERROR
argument_list|(
name|parameter_unsupported
argument_list|)
return|;
name|params
operator|->
name|format
operator|=
operator|(
name|ZSTD_format_e
operator|)
name|value
expr_stmt|;
return|return
literal|0
return|;
case|case
name|ZSTD_p_compressionLevel
case|:
if|if
condition|(
operator|(
name|int
operator|)
name|value
operator|>
name|ZSTD_maxCLevel
argument_list|()
condition|)
name|value
operator|=
name|ZSTD_maxCLevel
argument_list|()
expr_stmt|;
if|if
condition|(
name|value
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|params
operator|->
name|compressionLevel
operator|=
name|value
expr_stmt|;
return|return
literal|0
return|;
case|case
name|ZSTD_p_windowLog
case|:
if|if
condition|(
name|value
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|CLAMPCHECK
argument_list|(
name|value
argument_list|,
name|ZSTD_WINDOWLOG_MIN
argument_list|,
name|ZSTD_WINDOWLOG_MAX
argument_list|)
expr_stmt|;
name|ZSTD_cLevelToCCtxParams
argument_list|(
name|params
argument_list|)
expr_stmt|;
name|params
operator|->
name|cParams
operator|.
name|windowLog
operator|=
name|value
expr_stmt|;
return|return
literal|0
return|;
case|case
name|ZSTD_p_hashLog
case|:
if|if
condition|(
name|value
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|CLAMPCHECK
argument_list|(
name|value
argument_list|,
name|ZSTD_HASHLOG_MIN
argument_list|,
name|ZSTD_HASHLOG_MAX
argument_list|)
expr_stmt|;
name|ZSTD_cLevelToCCtxParams
argument_list|(
name|params
argument_list|)
expr_stmt|;
name|params
operator|->
name|cParams
operator|.
name|hashLog
operator|=
name|value
expr_stmt|;
return|return
literal|0
return|;
case|case
name|ZSTD_p_chainLog
case|:
if|if
condition|(
name|value
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|CLAMPCHECK
argument_list|(
name|value
argument_list|,
name|ZSTD_CHAINLOG_MIN
argument_list|,
name|ZSTD_CHAINLOG_MAX
argument_list|)
expr_stmt|;
name|ZSTD_cLevelToCCtxParams
argument_list|(
name|params
argument_list|)
expr_stmt|;
name|params
operator|->
name|cParams
operator|.
name|chainLog
operator|=
name|value
expr_stmt|;
return|return
literal|0
return|;
case|case
name|ZSTD_p_searchLog
case|:
if|if
condition|(
name|value
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|CLAMPCHECK
argument_list|(
name|value
argument_list|,
name|ZSTD_SEARCHLOG_MIN
argument_list|,
name|ZSTD_SEARCHLOG_MAX
argument_list|)
expr_stmt|;
name|ZSTD_cLevelToCCtxParams
argument_list|(
name|params
argument_list|)
expr_stmt|;
name|params
operator|->
name|cParams
operator|.
name|searchLog
operator|=
name|value
expr_stmt|;
return|return
literal|0
return|;
case|case
name|ZSTD_p_minMatch
case|:
if|if
condition|(
name|value
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|CLAMPCHECK
argument_list|(
name|value
argument_list|,
name|ZSTD_SEARCHLENGTH_MIN
argument_list|,
name|ZSTD_SEARCHLENGTH_MAX
argument_list|)
expr_stmt|;
name|ZSTD_cLevelToCCtxParams
argument_list|(
name|params
argument_list|)
expr_stmt|;
name|params
operator|->
name|cParams
operator|.
name|searchLength
operator|=
name|value
expr_stmt|;
return|return
literal|0
return|;
case|case
name|ZSTD_p_targetLength
case|:
if|if
condition|(
name|value
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|CLAMPCHECK
argument_list|(
name|value
argument_list|,
name|ZSTD_TARGETLENGTH_MIN
argument_list|,
name|ZSTD_TARGETLENGTH_MAX
argument_list|)
expr_stmt|;
name|ZSTD_cLevelToCCtxParams
argument_list|(
name|params
argument_list|)
expr_stmt|;
name|params
operator|->
name|cParams
operator|.
name|targetLength
operator|=
name|value
expr_stmt|;
return|return
literal|0
return|;
case|case
name|ZSTD_p_compressionStrategy
case|:
if|if
condition|(
name|value
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|CLAMPCHECK
argument_list|(
name|value
argument_list|,
operator|(
name|unsigned
operator|)
name|ZSTD_fast
argument_list|,
operator|(
name|unsigned
operator|)
name|ZSTD_btultra
argument_list|)
expr_stmt|;
name|ZSTD_cLevelToCCtxParams
argument_list|(
name|params
argument_list|)
expr_stmt|;
name|params
operator|->
name|cParams
operator|.
name|strategy
operator|=
operator|(
name|ZSTD_strategy
operator|)
name|value
expr_stmt|;
return|return
literal|0
return|;
case|case
name|ZSTD_p_contentSizeFlag
case|:
comment|/* Content size written in frame header _when known_ (default:1) */
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"set content size flag = %u"
argument_list|,
operator|(
name|value
operator|>
literal|0
operator|)
argument_list|)
expr_stmt|;
name|params
operator|->
name|fParams
operator|.
name|contentSizeFlag
operator|=
name|value
operator|>
literal|0
expr_stmt|;
return|return
literal|0
return|;
case|case
name|ZSTD_p_checksumFlag
case|:
comment|/* A 32-bits content checksum will be calculated and written at end of frame (default:0) */
name|params
operator|->
name|fParams
operator|.
name|checksumFlag
operator|=
name|value
operator|>
literal|0
expr_stmt|;
return|return
literal|0
return|;
case|case
name|ZSTD_p_dictIDFlag
case|:
comment|/* When applicable, dictionary's dictID is provided in frame header (default:1) */
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"set dictIDFlag = %u"
argument_list|,
operator|(
name|value
operator|>
literal|0
operator|)
argument_list|)
expr_stmt|;
name|params
operator|->
name|fParams
operator|.
name|noDictIDFlag
operator|=
operator|(
name|value
operator|==
literal|0
operator|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|ZSTD_p_forceMaxWindow
case|:
name|params
operator|->
name|forceWindow
operator|=
name|value
operator|>
literal|0
expr_stmt|;
return|return
literal|0
return|;
case|case
name|ZSTD_p_nbThreads
case|:
if|if
condition|(
name|value
operator|==
literal|0
condition|)
return|return
literal|0
return|;
ifndef|#
directive|ifndef
name|ZSTD_MULTITHREAD
if|if
condition|(
name|value
operator|>
literal|1
condition|)
return|return
name|ERROR
argument_list|(
name|parameter_unsupported
argument_list|)
return|;
return|return
literal|0
return|;
else|#
directive|else
return|return
name|ZSTDMT_initializeCCtxParameters
argument_list|(
name|params
argument_list|,
name|value
argument_list|)
return|;
endif|#
directive|endif
case|case
name|ZSTD_p_jobSize
case|:
ifndef|#
directive|ifndef
name|ZSTD_MULTITHREAD
return|return
name|ERROR
argument_list|(
name|parameter_unsupported
argument_list|)
return|;
else|#
directive|else
if|if
condition|(
name|params
operator|->
name|nbThreads
operator|<=
literal|1
condition|)
return|return
name|ERROR
argument_list|(
name|parameter_unsupported
argument_list|)
return|;
return|return
name|ZSTDMT_CCtxParam_setMTCtxParameter
argument_list|(
name|params
argument_list|,
name|ZSTDMT_p_sectionSize
argument_list|,
name|value
argument_list|)
return|;
endif|#
directive|endif
case|case
name|ZSTD_p_overlapSizeLog
case|:
ifndef|#
directive|ifndef
name|ZSTD_MULTITHREAD
return|return
name|ERROR
argument_list|(
name|parameter_unsupported
argument_list|)
return|;
else|#
directive|else
if|if
condition|(
name|params
operator|->
name|nbThreads
operator|<=
literal|1
condition|)
return|return
name|ERROR
argument_list|(
name|parameter_unsupported
argument_list|)
return|;
return|return
name|ZSTDMT_CCtxParam_setMTCtxParameter
argument_list|(
name|params
argument_list|,
name|ZSTDMT_p_overlapSectionLog
argument_list|,
name|value
argument_list|)
return|;
endif|#
directive|endif
case|case
name|ZSTD_p_enableLongDistanceMatching
case|:
if|if
condition|(
name|value
operator|!=
literal|0
condition|)
block|{
name|ZSTD_cLevelToCCtxParams
argument_list|(
name|params
argument_list|)
expr_stmt|;
name|params
operator|->
name|cParams
operator|.
name|windowLog
operator|=
name|ZSTD_LDM_DEFAULT_WINDOW_LOG
expr_stmt|;
block|}
return|return
name|ZSTD_ldm_initializeParameters
argument_list|(
operator|&
name|params
operator|->
name|ldmParams
argument_list|,
name|value
argument_list|)
return|;
case|case
name|ZSTD_p_ldmHashLog
case|:
if|if
condition|(
name|value
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|CLAMPCHECK
argument_list|(
name|value
argument_list|,
name|ZSTD_HASHLOG_MIN
argument_list|,
name|ZSTD_HASHLOG_MAX
argument_list|)
expr_stmt|;
name|params
operator|->
name|ldmParams
operator|.
name|hashLog
operator|=
name|value
expr_stmt|;
return|return
literal|0
return|;
case|case
name|ZSTD_p_ldmMinMatch
case|:
if|if
condition|(
name|value
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|CLAMPCHECK
argument_list|(
name|value
argument_list|,
name|ZSTD_LDM_MINMATCH_MIN
argument_list|,
name|ZSTD_LDM_MINMATCH_MAX
argument_list|)
expr_stmt|;
name|params
operator|->
name|ldmParams
operator|.
name|minMatchLength
operator|=
name|value
expr_stmt|;
return|return
literal|0
return|;
case|case
name|ZSTD_p_ldmBucketSizeLog
case|:
if|if
condition|(
name|value
operator|>
name|ZSTD_LDM_BUCKETSIZELOG_MAX
condition|)
block|{
return|return
name|ERROR
argument_list|(
name|parameter_outOfBound
argument_list|)
return|;
block|}
name|params
operator|->
name|ldmParams
operator|.
name|bucketSizeLog
operator|=
name|value
expr_stmt|;
return|return
literal|0
return|;
case|case
name|ZSTD_p_ldmHashEveryLog
case|:
if|if
condition|(
name|value
operator|>
name|ZSTD_WINDOWLOG_MAX
operator|-
name|ZSTD_HASHLOG_MIN
condition|)
block|{
return|return
name|ERROR
argument_list|(
name|parameter_outOfBound
argument_list|)
return|;
block|}
name|params
operator|->
name|ldmParams
operator|.
name|hashEveryLog
operator|=
name|value
expr_stmt|;
return|return
literal|0
return|;
default|default:
return|return
name|ERROR
argument_list|(
name|parameter_unsupported
argument_list|)
return|;
block|}
block|}
end_function

begin_comment
comment|/**  * This function should be updated whenever ZSTD_CCtx_params is updated.  * Parameters are copied manually before the dictionary is loaded.  * The multithreading parameters jobSize and overlapSizeLog are set only if  * nbThreads> 1.  *  * Pledged srcSize is treated as unknown.  */
end_comment

begin_function
name|size_t
name|ZSTD_CCtx_setParametersUsingCCtxParams
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
specifier|const
name|ZSTD_CCtx_params
modifier|*
name|params
parameter_list|)
block|{
if|if
condition|(
name|cctx
operator|->
name|streamStage
operator|!=
name|zcss_init
condition|)
return|return
name|ERROR
argument_list|(
name|stage_wrong
argument_list|)
return|;
if|if
condition|(
name|cctx
operator|->
name|cdict
condition|)
return|return
name|ERROR
argument_list|(
name|stage_wrong
argument_list|)
return|;
comment|/* Assume the compression and frame parameters are validated */
name|cctx
operator|->
name|requestedParams
operator|.
name|cParams
operator|=
name|params
operator|->
name|cParams
expr_stmt|;
name|cctx
operator|->
name|requestedParams
operator|.
name|fParams
operator|=
name|params
operator|->
name|fParams
expr_stmt|;
name|cctx
operator|->
name|requestedParams
operator|.
name|compressionLevel
operator|=
name|params
operator|->
name|compressionLevel
expr_stmt|;
comment|/* Set force window explicitly since it sets cctx->loadedDictEnd */
name|CHECK_F
argument_list|(
name|ZSTD_CCtx_setParameter
argument_list|(
name|cctx
argument_list|,
name|ZSTD_p_forceMaxWindow
argument_list|,
name|params
operator|->
name|forceWindow
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Set multithreading parameters explicitly */
name|CHECK_F
argument_list|(
name|ZSTD_CCtx_setParameter
argument_list|(
name|cctx
argument_list|,
name|ZSTD_p_nbThreads
argument_list|,
name|params
operator|->
name|nbThreads
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|nbThreads
operator|>
literal|1
condition|)
block|{
name|CHECK_F
argument_list|(
name|ZSTD_CCtx_setParameter
argument_list|(
name|cctx
argument_list|,
name|ZSTD_p_jobSize
argument_list|,
name|params
operator|->
name|jobSize
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK_F
argument_list|(
name|ZSTD_CCtx_setParameter
argument_list|(
name|cctx
argument_list|,
name|ZSTD_p_overlapSizeLog
argument_list|,
name|params
operator|->
name|overlapSizeLog
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Copy long distance matching parameters */
name|cctx
operator|->
name|requestedParams
operator|.
name|ldmParams
operator|=
name|params
operator|->
name|ldmParams
expr_stmt|;
comment|/* customMem is used only for create/free params and can be ignored */
return|return
literal|0
return|;
block|}
end_function

begin_function
name|ZSTDLIB_API
name|size_t
name|ZSTD_CCtx_setPledgedSrcSize
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
name|unsigned
name|long
name|long
name|pledgedSrcSize
parameter_list|)
block|{
name|DEBUGLOG
argument_list|(
literal|4
argument_list|,
literal|" setting pledgedSrcSize to %u"
argument_list|,
operator|(
name|U32
operator|)
name|pledgedSrcSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|cctx
operator|->
name|streamStage
operator|!=
name|zcss_init
condition|)
return|return
name|ERROR
argument_list|(
name|stage_wrong
argument_list|)
return|;
name|cctx
operator|->
name|pledgedSrcSizePlusOne
operator|=
name|pledgedSrcSize
operator|+
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_CCtx_loadDictionary_advanced
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
specifier|const
name|void
modifier|*
name|dict
parameter_list|,
name|size_t
name|dictSize
parameter_list|,
name|ZSTD_dictLoadMethod_e
name|dictLoadMethod
parameter_list|,
name|ZSTD_dictMode_e
name|dictMode
parameter_list|)
block|{
if|if
condition|(
name|cctx
operator|->
name|streamStage
operator|!=
name|zcss_init
condition|)
return|return
name|ERROR
argument_list|(
name|stage_wrong
argument_list|)
return|;
if|if
condition|(
name|cctx
operator|->
name|staticSize
condition|)
return|return
name|ERROR
argument_list|(
name|memory_allocation
argument_list|)
return|;
comment|/* no malloc for static CCtx */
name|DEBUGLOG
argument_list|(
literal|4
argument_list|,
literal|"load dictionary of size %u"
argument_list|,
operator|(
name|U32
operator|)
name|dictSize
argument_list|)
expr_stmt|;
name|ZSTD_freeCDict
argument_list|(
name|cctx
operator|->
name|cdictLocal
argument_list|)
expr_stmt|;
comment|/* in case one already exists */
if|if
condition|(
name|dict
operator|==
name|NULL
operator|||
name|dictSize
operator|==
literal|0
condition|)
block|{
comment|/* no dictionary mode */
name|cctx
operator|->
name|cdictLocal
operator|=
name|NULL
expr_stmt|;
name|cctx
operator|->
name|cdict
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|ZSTD_compressionParameters
specifier|const
name|cParams
init|=
name|ZSTD_getCParamsFromCCtxParams
argument_list|(
name|cctx
operator|->
name|requestedParams
argument_list|,
literal|0
argument_list|,
name|dictSize
argument_list|)
decl_stmt|;
name|cctx
operator|->
name|cdictLocal
operator|=
name|ZSTD_createCDict_advanced
argument_list|(
name|dict
argument_list|,
name|dictSize
argument_list|,
name|dictLoadMethod
argument_list|,
name|dictMode
argument_list|,
name|cParams
argument_list|,
name|cctx
operator|->
name|customMem
argument_list|)
expr_stmt|;
name|cctx
operator|->
name|cdict
operator|=
name|cctx
operator|->
name|cdictLocal
expr_stmt|;
if|if
condition|(
name|cctx
operator|->
name|cdictLocal
operator|==
name|NULL
condition|)
return|return
name|ERROR
argument_list|(
name|memory_allocation
argument_list|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|ZSTDLIB_API
name|size_t
name|ZSTD_CCtx_loadDictionary_byReference
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
specifier|const
name|void
modifier|*
name|dict
parameter_list|,
name|size_t
name|dictSize
parameter_list|)
block|{
return|return
name|ZSTD_CCtx_loadDictionary_advanced
argument_list|(
name|cctx
argument_list|,
name|dict
argument_list|,
name|dictSize
argument_list|,
name|ZSTD_dlm_byRef
argument_list|,
name|ZSTD_dm_auto
argument_list|)
return|;
block|}
end_function

begin_function
name|ZSTDLIB_API
name|size_t
name|ZSTD_CCtx_loadDictionary
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
specifier|const
name|void
modifier|*
name|dict
parameter_list|,
name|size_t
name|dictSize
parameter_list|)
block|{
return|return
name|ZSTD_CCtx_loadDictionary_advanced
argument_list|(
name|cctx
argument_list|,
name|dict
argument_list|,
name|dictSize
argument_list|,
name|ZSTD_dlm_byCopy
argument_list|,
name|ZSTD_dm_auto
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_CCtx_refCDict
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
specifier|const
name|ZSTD_CDict
modifier|*
name|cdict
parameter_list|)
block|{
if|if
condition|(
name|cctx
operator|->
name|streamStage
operator|!=
name|zcss_init
condition|)
return|return
name|ERROR
argument_list|(
name|stage_wrong
argument_list|)
return|;
name|cctx
operator|->
name|cdict
operator|=
name|cdict
expr_stmt|;
name|memset
argument_list|(
operator|&
name|cctx
operator|->
name|prefixDict
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cctx
operator|->
name|prefixDict
argument_list|)
argument_list|)
expr_stmt|;
comment|/* exclusive */
return|return
literal|0
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_CCtx_refPrefix
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
specifier|const
name|void
modifier|*
name|prefix
parameter_list|,
name|size_t
name|prefixSize
parameter_list|)
block|{
return|return
name|ZSTD_CCtx_refPrefix_advanced
argument_list|(
name|cctx
argument_list|,
name|prefix
argument_list|,
name|prefixSize
argument_list|,
name|ZSTD_dm_rawContent
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_CCtx_refPrefix_advanced
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
specifier|const
name|void
modifier|*
name|prefix
parameter_list|,
name|size_t
name|prefixSize
parameter_list|,
name|ZSTD_dictMode_e
name|dictMode
parameter_list|)
block|{
if|if
condition|(
name|cctx
operator|->
name|streamStage
operator|!=
name|zcss_init
condition|)
return|return
name|ERROR
argument_list|(
name|stage_wrong
argument_list|)
return|;
name|cctx
operator|->
name|cdict
operator|=
name|NULL
expr_stmt|;
comment|/* prefix discards any prior cdict */
name|cctx
operator|->
name|prefixDict
operator|.
name|dict
operator|=
name|prefix
expr_stmt|;
name|cctx
operator|->
name|prefixDict
operator|.
name|dictSize
operator|=
name|prefixSize
expr_stmt|;
name|cctx
operator|->
name|prefixDict
operator|.
name|dictMode
operator|=
name|dictMode
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ZSTD_startNewCompression
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|)
block|{
name|cctx
operator|->
name|streamStage
operator|=
name|zcss_init
expr_stmt|;
name|cctx
operator|->
name|pledgedSrcSizePlusOne
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*! ZSTD_CCtx_reset() :  *  Also dumps dictionary */
end_comment

begin_function
name|void
name|ZSTD_CCtx_reset
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|)
block|{
name|ZSTD_startNewCompression
argument_list|(
name|cctx
argument_list|)
expr_stmt|;
name|cctx
operator|->
name|cdict
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/** ZSTD_checkCParams() :     control CParam values remain within authorized range.     @return : 0, or an error code if one value is beyond authorized range */
end_comment

begin_function
name|size_t
name|ZSTD_checkCParams
parameter_list|(
name|ZSTD_compressionParameters
name|cParams
parameter_list|)
block|{
name|CLAMPCHECK
argument_list|(
name|cParams
operator|.
name|windowLog
argument_list|,
name|ZSTD_WINDOWLOG_MIN
argument_list|,
name|ZSTD_WINDOWLOG_MAX
argument_list|)
expr_stmt|;
name|CLAMPCHECK
argument_list|(
name|cParams
operator|.
name|chainLog
argument_list|,
name|ZSTD_CHAINLOG_MIN
argument_list|,
name|ZSTD_CHAINLOG_MAX
argument_list|)
expr_stmt|;
name|CLAMPCHECK
argument_list|(
name|cParams
operator|.
name|hashLog
argument_list|,
name|ZSTD_HASHLOG_MIN
argument_list|,
name|ZSTD_HASHLOG_MAX
argument_list|)
expr_stmt|;
name|CLAMPCHECK
argument_list|(
name|cParams
operator|.
name|searchLog
argument_list|,
name|ZSTD_SEARCHLOG_MIN
argument_list|,
name|ZSTD_SEARCHLOG_MAX
argument_list|)
expr_stmt|;
name|CLAMPCHECK
argument_list|(
name|cParams
operator|.
name|searchLength
argument_list|,
name|ZSTD_SEARCHLENGTH_MIN
argument_list|,
name|ZSTD_SEARCHLENGTH_MAX
argument_list|)
expr_stmt|;
name|CLAMPCHECK
argument_list|(
name|cParams
operator|.
name|targetLength
argument_list|,
name|ZSTD_TARGETLENGTH_MIN
argument_list|,
name|ZSTD_TARGETLENGTH_MAX
argument_list|)
expr_stmt|;
if|if
condition|(
call|(
name|U32
call|)
argument_list|(
name|cParams
operator|.
name|strategy
argument_list|)
operator|>
operator|(
name|U32
operator|)
name|ZSTD_btultra
condition|)
return|return
name|ERROR
argument_list|(
name|parameter_unsupported
argument_list|)
return|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/** ZSTD_clampCParams() :  *  make CParam values within valid range.  *  @return : valid CParams */
end_comment

begin_function
specifier|static
name|ZSTD_compressionParameters
name|ZSTD_clampCParams
parameter_list|(
name|ZSTD_compressionParameters
name|cParams
parameter_list|)
block|{
define|#
directive|define
name|CLAMP
parameter_list|(
name|val
parameter_list|,
name|min
parameter_list|,
name|max
parameter_list|)
value|{      \         if (val<min) val=min;        \         else if (val>max) val=max;   \     }
name|CLAMP
argument_list|(
name|cParams
operator|.
name|windowLog
argument_list|,
name|ZSTD_WINDOWLOG_MIN
argument_list|,
name|ZSTD_WINDOWLOG_MAX
argument_list|)
expr_stmt|;
name|CLAMP
argument_list|(
name|cParams
operator|.
name|chainLog
argument_list|,
name|ZSTD_CHAINLOG_MIN
argument_list|,
name|ZSTD_CHAINLOG_MAX
argument_list|)
expr_stmt|;
name|CLAMP
argument_list|(
name|cParams
operator|.
name|hashLog
argument_list|,
name|ZSTD_HASHLOG_MIN
argument_list|,
name|ZSTD_HASHLOG_MAX
argument_list|)
expr_stmt|;
name|CLAMP
argument_list|(
name|cParams
operator|.
name|searchLog
argument_list|,
name|ZSTD_SEARCHLOG_MIN
argument_list|,
name|ZSTD_SEARCHLOG_MAX
argument_list|)
expr_stmt|;
name|CLAMP
argument_list|(
name|cParams
operator|.
name|searchLength
argument_list|,
name|ZSTD_SEARCHLENGTH_MIN
argument_list|,
name|ZSTD_SEARCHLENGTH_MAX
argument_list|)
expr_stmt|;
name|CLAMP
argument_list|(
name|cParams
operator|.
name|targetLength
argument_list|,
name|ZSTD_TARGETLENGTH_MIN
argument_list|,
name|ZSTD_TARGETLENGTH_MAX
argument_list|)
expr_stmt|;
if|if
condition|(
call|(
name|U32
call|)
argument_list|(
name|cParams
operator|.
name|strategy
argument_list|)
operator|>
operator|(
name|U32
operator|)
name|ZSTD_btultra
condition|)
name|cParams
operator|.
name|strategy
operator|=
name|ZSTD_btultra
expr_stmt|;
return|return
name|cParams
return|;
block|}
end_function

begin_comment
comment|/** ZSTD_cycleLog() :  *  condition for correct operation : hashLog> 1 */
end_comment

begin_function
specifier|static
name|U32
name|ZSTD_cycleLog
parameter_list|(
name|U32
name|hashLog
parameter_list|,
name|ZSTD_strategy
name|strat
parameter_list|)
block|{
name|U32
specifier|const
name|btScale
init|=
operator|(
operator|(
name|U32
operator|)
name|strat
operator|>=
operator|(
name|U32
operator|)
name|ZSTD_btlazy2
operator|)
decl_stmt|;
return|return
name|hashLog
operator|-
name|btScale
return|;
block|}
end_function

begin_comment
comment|/** ZSTD_adjustCParams_internal() :     optimize `cPar` for a given input (`srcSize` and `dictSize`).     mostly downsizing to reduce memory consumption and initialization latency.     Both `srcSize` and `dictSize` are optional (use 0 if unknown).     Note : cPar is considered validated at this stage. Use ZSTD_checkCParams() to ensure that condition. */
end_comment

begin_function
name|ZSTD_compressionParameters
name|ZSTD_adjustCParams_internal
parameter_list|(
name|ZSTD_compressionParameters
name|cPar
parameter_list|,
name|unsigned
name|long
name|long
name|srcSize
parameter_list|,
name|size_t
name|dictSize
parameter_list|)
block|{
specifier|static
specifier|const
name|U64
name|minSrcSize
init|=
literal|513
decl_stmt|;
comment|/* (1<<9) + 1 */
specifier|static
specifier|const
name|U64
name|maxWindowResize
init|=
literal|1ULL
operator|<<
operator|(
name|ZSTD_WINDOWLOG_MAX
operator|-
literal|1
operator|)
decl_stmt|;
name|assert
argument_list|(
name|ZSTD_checkCParams
argument_list|(
name|cPar
argument_list|)
operator|==
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|dictSize
operator|&&
operator|(
name|srcSize
operator|+
literal|1
operator|<
literal|2
operator|)
comment|/* srcSize unknown */
condition|)
name|srcSize
operator|=
name|minSrcSize
expr_stmt|;
comment|/* presumed small when there is a dictionary */
elseif|else
if|if
condition|(
name|srcSize
operator|==
literal|0
condition|)
name|srcSize
operator|=
name|ZSTD_CONTENTSIZE_UNKNOWN
expr_stmt|;
comment|/* 0 == unknown : presumed large */
comment|/* resize windowLog if input is small enough, to use less memory */
if|if
condition|(
operator|(
name|srcSize
operator|<
name|maxWindowResize
operator|)
operator|&&
operator|(
name|dictSize
operator|<
name|maxWindowResize
operator|)
condition|)
block|{
name|U32
specifier|const
name|tSize
init|=
call|(
name|U32
call|)
argument_list|(
name|srcSize
operator|+
name|dictSize
argument_list|)
decl_stmt|;
specifier|static
name|U32
specifier|const
name|hashSizeMin
init|=
literal|1
operator|<<
name|ZSTD_HASHLOG_MIN
decl_stmt|;
name|U32
specifier|const
name|srcLog
init|=
operator|(
name|tSize
operator|<
name|hashSizeMin
operator|)
condition|?
name|ZSTD_HASHLOG_MIN
else|:
name|ZSTD_highbit32
argument_list|(
name|tSize
operator|-
literal|1
argument_list|)
operator|+
literal|1
decl_stmt|;
if|if
condition|(
name|cPar
operator|.
name|windowLog
operator|>
name|srcLog
condition|)
name|cPar
operator|.
name|windowLog
operator|=
name|srcLog
expr_stmt|;
block|}
if|if
condition|(
name|cPar
operator|.
name|hashLog
operator|>
name|cPar
operator|.
name|windowLog
condition|)
name|cPar
operator|.
name|hashLog
operator|=
name|cPar
operator|.
name|windowLog
expr_stmt|;
block|{
name|U32
specifier|const
name|cycleLog
init|=
name|ZSTD_cycleLog
argument_list|(
name|cPar
operator|.
name|chainLog
argument_list|,
name|cPar
operator|.
name|strategy
argument_list|)
decl_stmt|;
if|if
condition|(
name|cycleLog
operator|>
name|cPar
operator|.
name|windowLog
condition|)
name|cPar
operator|.
name|chainLog
operator|-=
operator|(
name|cycleLog
operator|-
name|cPar
operator|.
name|windowLog
operator|)
expr_stmt|;
block|}
if|if
condition|(
name|cPar
operator|.
name|windowLog
operator|<
name|ZSTD_WINDOWLOG_ABSOLUTEMIN
condition|)
name|cPar
operator|.
name|windowLog
operator|=
name|ZSTD_WINDOWLOG_ABSOLUTEMIN
expr_stmt|;
comment|/* required for frame header */
return|return
name|cPar
return|;
block|}
end_function

begin_function
name|ZSTD_compressionParameters
name|ZSTD_adjustCParams
parameter_list|(
name|ZSTD_compressionParameters
name|cPar
parameter_list|,
name|unsigned
name|long
name|long
name|srcSize
parameter_list|,
name|size_t
name|dictSize
parameter_list|)
block|{
name|cPar
operator|=
name|ZSTD_clampCParams
argument_list|(
name|cPar
argument_list|)
expr_stmt|;
return|return
name|ZSTD_adjustCParams_internal
argument_list|(
name|cPar
argument_list|,
name|srcSize
argument_list|,
name|dictSize
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_estimateCCtxSize_usingCCtxParams
parameter_list|(
specifier|const
name|ZSTD_CCtx_params
modifier|*
name|params
parameter_list|)
block|{
comment|/* Estimate CCtx size is supported for single-threaded compression only. */
if|if
condition|(
name|params
operator|->
name|nbThreads
operator|>
literal|1
condition|)
block|{
return|return
name|ERROR
argument_list|(
name|GENERIC
argument_list|)
return|;
block|}
block|{
name|ZSTD_compressionParameters
specifier|const
name|cParams
init|=
name|ZSTD_getCParamsFromCCtxParams
argument_list|(
operator|*
name|params
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|size_t
specifier|const
name|blockSize
init|=
name|MIN
argument_list|(
name|ZSTD_BLOCKSIZE_MAX
argument_list|,
operator|(
name|size_t
operator|)
literal|1
operator|<<
name|cParams
operator|.
name|windowLog
argument_list|)
decl_stmt|;
name|U32
specifier|const
name|divider
init|=
operator|(
name|cParams
operator|.
name|searchLength
operator|==
literal|3
operator|)
condition|?
literal|3
else|:
literal|4
decl_stmt|;
name|size_t
specifier|const
name|maxNbSeq
init|=
name|blockSize
operator|/
name|divider
decl_stmt|;
name|size_t
specifier|const
name|tokenSpace
init|=
name|blockSize
operator|+
literal|11
operator|*
name|maxNbSeq
decl_stmt|;
name|size_t
specifier|const
name|chainSize
init|=
operator|(
name|cParams
operator|.
name|strategy
operator|==
name|ZSTD_fast
operator|)
condition|?
literal|0
else|:
operator|(
operator|(
name|size_t
operator|)
literal|1
operator|<<
name|cParams
operator|.
name|chainLog
operator|)
decl_stmt|;
name|size_t
specifier|const
name|hSize
init|=
operator|(
operator|(
name|size_t
operator|)
literal|1
operator|)
operator|<<
name|cParams
operator|.
name|hashLog
decl_stmt|;
name|U32
specifier|const
name|hashLog3
init|=
operator|(
name|cParams
operator|.
name|searchLength
operator|>
literal|3
operator|)
condition|?
literal|0
else|:
name|MIN
argument_list|(
name|ZSTD_HASHLOG3_MAX
argument_list|,
name|cParams
operator|.
name|windowLog
argument_list|)
decl_stmt|;
name|size_t
specifier|const
name|h3Size
init|=
operator|(
operator|(
name|size_t
operator|)
literal|1
operator|)
operator|<<
name|hashLog3
decl_stmt|;
name|size_t
specifier|const
name|entropySpace
init|=
sizeof|sizeof
argument_list|(
name|ZSTD_entropyCTables_t
argument_list|)
decl_stmt|;
name|size_t
specifier|const
name|tableSpace
init|=
operator|(
name|chainSize
operator|+
name|hSize
operator|+
name|h3Size
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|U32
argument_list|)
decl_stmt|;
name|size_t
specifier|const
name|optBudget
init|=
operator|(
operator|(
name|MaxML
operator|+
literal|1
operator|)
operator|+
operator|(
name|MaxLL
operator|+
literal|1
operator|)
operator|+
operator|(
name|MaxOff
operator|+
literal|1
operator|)
operator|+
operator|(
literal|1
operator|<<
name|Litbits
operator|)
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|U32
argument_list|)
operator|+
operator|(
name|ZSTD_OPT_NUM
operator|+
literal|1
operator|)
operator|*
operator|(
sizeof|sizeof
argument_list|(
name|ZSTD_match_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|ZSTD_optimal_t
argument_list|)
operator|)
decl_stmt|;
name|size_t
specifier|const
name|optSpace
init|=
operator|(
operator|(
name|cParams
operator|.
name|strategy
operator|==
name|ZSTD_btopt
operator|)
operator|||
operator|(
name|cParams
operator|.
name|strategy
operator|==
name|ZSTD_btultra
operator|)
operator|)
condition|?
name|optBudget
else|:
literal|0
decl_stmt|;
name|size_t
specifier|const
name|ldmSpace
init|=
name|params
operator|->
name|ldmParams
operator|.
name|enableLdm
condition|?
name|ZSTD_ldm_getTableSize
argument_list|(
name|params
operator|->
name|ldmParams
operator|.
name|hashLog
argument_list|,
name|params
operator|->
name|ldmParams
operator|.
name|bucketSizeLog
argument_list|)
else|:
literal|0
decl_stmt|;
name|size_t
specifier|const
name|neededSpace
init|=
name|entropySpace
operator|+
name|tableSpace
operator|+
name|tokenSpace
operator|+
name|optSpace
operator|+
name|ldmSpace
decl_stmt|;
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"sizeof(ZSTD_CCtx) : %u"
argument_list|,
operator|(
name|U32
operator|)
sizeof|sizeof
argument_list|(
name|ZSTD_CCtx
argument_list|)
argument_list|)
expr_stmt|;
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"estimate workSpace : %u"
argument_list|,
operator|(
name|U32
operator|)
name|neededSpace
argument_list|)
expr_stmt|;
return|return
sizeof|sizeof
argument_list|(
name|ZSTD_CCtx
argument_list|)
operator|+
name|neededSpace
return|;
block|}
block|}
end_function

begin_function
name|size_t
name|ZSTD_estimateCCtxSize_usingCParams
parameter_list|(
name|ZSTD_compressionParameters
name|cParams
parameter_list|)
block|{
name|ZSTD_CCtx_params
specifier|const
name|params
init|=
name|ZSTD_makeCCtxParamsFromCParams
argument_list|(
name|cParams
argument_list|)
decl_stmt|;
return|return
name|ZSTD_estimateCCtxSize_usingCCtxParams
argument_list|(
operator|&
name|params
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_estimateCCtxSize
parameter_list|(
name|int
name|compressionLevel
parameter_list|)
block|{
name|ZSTD_compressionParameters
specifier|const
name|cParams
init|=
name|ZSTD_getCParams
argument_list|(
name|compressionLevel
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
decl_stmt|;
return|return
name|ZSTD_estimateCCtxSize_usingCParams
argument_list|(
name|cParams
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_estimateCStreamSize_usingCCtxParams
parameter_list|(
specifier|const
name|ZSTD_CCtx_params
modifier|*
name|params
parameter_list|)
block|{
if|if
condition|(
name|params
operator|->
name|nbThreads
operator|>
literal|1
condition|)
block|{
return|return
name|ERROR
argument_list|(
name|GENERIC
argument_list|)
return|;
block|}
block|{
name|size_t
specifier|const
name|CCtxSize
init|=
name|ZSTD_estimateCCtxSize_usingCCtxParams
argument_list|(
name|params
argument_list|)
decl_stmt|;
name|size_t
specifier|const
name|blockSize
init|=
name|MIN
argument_list|(
name|ZSTD_BLOCKSIZE_MAX
argument_list|,
operator|(
name|size_t
operator|)
literal|1
operator|<<
name|params
operator|->
name|cParams
operator|.
name|windowLog
argument_list|)
decl_stmt|;
name|size_t
specifier|const
name|inBuffSize
init|=
operator|(
operator|(
name|size_t
operator|)
literal|1
operator|<<
name|params
operator|->
name|cParams
operator|.
name|windowLog
operator|)
operator|+
name|blockSize
decl_stmt|;
name|size_t
specifier|const
name|outBuffSize
init|=
name|ZSTD_compressBound
argument_list|(
name|blockSize
argument_list|)
operator|+
literal|1
decl_stmt|;
name|size_t
specifier|const
name|streamingSize
init|=
name|inBuffSize
operator|+
name|outBuffSize
decl_stmt|;
return|return
name|CCtxSize
operator|+
name|streamingSize
return|;
block|}
block|}
end_function

begin_function
name|size_t
name|ZSTD_estimateCStreamSize_usingCParams
parameter_list|(
name|ZSTD_compressionParameters
name|cParams
parameter_list|)
block|{
name|ZSTD_CCtx_params
specifier|const
name|params
init|=
name|ZSTD_makeCCtxParamsFromCParams
argument_list|(
name|cParams
argument_list|)
decl_stmt|;
return|return
name|ZSTD_estimateCStreamSize_usingCCtxParams
argument_list|(
operator|&
name|params
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_estimateCStreamSize
parameter_list|(
name|int
name|compressionLevel
parameter_list|)
block|{
name|ZSTD_compressionParameters
specifier|const
name|cParams
init|=
name|ZSTD_getCParams
argument_list|(
name|compressionLevel
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
decl_stmt|;
return|return
name|ZSTD_estimateCStreamSize_usingCParams
argument_list|(
name|cParams
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|U32
name|ZSTD_equivalentCParams
parameter_list|(
name|ZSTD_compressionParameters
name|cParams1
parameter_list|,
name|ZSTD_compressionParameters
name|cParams2
parameter_list|)
block|{
name|U32
name|bslog1
init|=
name|MIN
argument_list|(
name|cParams1
operator|.
name|windowLog
argument_list|,
name|ZSTD_BLOCKSIZELOG_MAX
argument_list|)
decl_stmt|;
name|U32
name|bslog2
init|=
name|MIN
argument_list|(
name|cParams2
operator|.
name|windowLog
argument_list|,
name|ZSTD_BLOCKSIZELOG_MAX
argument_list|)
decl_stmt|;
return|return
operator|(
name|bslog1
operator|==
name|bslog2
operator|)
comment|/* same block size */
operator|&
operator|(
name|cParams1
operator|.
name|hashLog
operator|==
name|cParams2
operator|.
name|hashLog
operator|)
operator|&
operator|(
name|cParams1
operator|.
name|chainLog
operator|==
name|cParams2
operator|.
name|chainLog
operator|)
operator|&
operator|(
name|cParams1
operator|.
name|strategy
operator|==
name|cParams2
operator|.
name|strategy
operator|)
comment|/* opt parser space */
operator|&
operator|(
operator|(
name|cParams1
operator|.
name|searchLength
operator|==
literal|3
operator|)
operator|==
operator|(
name|cParams2
operator|.
name|searchLength
operator|==
literal|3
operator|)
operator|)
return|;
comment|/* hashlog3 space */
block|}
end_function

begin_comment
comment|/** The parameters are equivalent if ldm is not enabled in both sets or  *  all the parameters are equivalent. */
end_comment

begin_function
specifier|static
name|U32
name|ZSTD_equivalentLdmParams
parameter_list|(
name|ldmParams_t
name|ldmParams1
parameter_list|,
name|ldmParams_t
name|ldmParams2
parameter_list|)
block|{
return|return
operator|(
operator|!
name|ldmParams1
operator|.
name|enableLdm
operator|&&
operator|!
name|ldmParams2
operator|.
name|enableLdm
operator|)
operator|||
operator|(
name|ldmParams1
operator|.
name|enableLdm
operator|==
name|ldmParams2
operator|.
name|enableLdm
operator|&&
name|ldmParams1
operator|.
name|hashLog
operator|==
name|ldmParams2
operator|.
name|hashLog
operator|&&
name|ldmParams1
operator|.
name|bucketSizeLog
operator|==
name|ldmParams2
operator|.
name|bucketSizeLog
operator|&&
name|ldmParams1
operator|.
name|minMatchLength
operator|==
name|ldmParams2
operator|.
name|minMatchLength
operator|&&
name|ldmParams1
operator|.
name|hashEveryLog
operator|==
name|ldmParams2
operator|.
name|hashEveryLog
operator|)
return|;
block|}
end_function

begin_comment
comment|/** Equivalence for resetCCtx purposes */
end_comment

begin_function
specifier|static
name|U32
name|ZSTD_equivalentParams
parameter_list|(
name|ZSTD_CCtx_params
name|params1
parameter_list|,
name|ZSTD_CCtx_params
name|params2
parameter_list|)
block|{
return|return
name|ZSTD_equivalentCParams
argument_list|(
name|params1
operator|.
name|cParams
argument_list|,
name|params2
operator|.
name|cParams
argument_list|)
operator|&&
name|ZSTD_equivalentLdmParams
argument_list|(
name|params1
operator|.
name|ldmParams
argument_list|,
name|params2
operator|.
name|ldmParams
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*! ZSTD_continueCCtx() :  *  reuse CCtx without reset (note : requires no dictionary) */
end_comment

begin_function
specifier|static
name|size_t
name|ZSTD_continueCCtx
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
name|ZSTD_CCtx_params
name|params
parameter_list|,
name|U64
name|pledgedSrcSize
parameter_list|)
block|{
name|U32
specifier|const
name|end
init|=
call|(
name|U32
call|)
argument_list|(
name|cctx
operator|->
name|nextSrc
operator|-
name|cctx
operator|->
name|base
argument_list|)
decl_stmt|;
name|DEBUGLOG
argument_list|(
literal|4
argument_list|,
literal|"continue mode"
argument_list|)
expr_stmt|;
name|cctx
operator|->
name|appliedParams
operator|=
name|params
expr_stmt|;
name|cctx
operator|->
name|pledgedSrcSizePlusOne
operator|=
name|pledgedSrcSize
operator|+
literal|1
expr_stmt|;
name|cctx
operator|->
name|consumedSrcSize
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pledgedSrcSize
operator|==
name|ZSTD_CONTENTSIZE_UNKNOWN
condition|)
name|cctx
operator|->
name|appliedParams
operator|.
name|fParams
operator|.
name|contentSizeFlag
operator|=
literal|0
expr_stmt|;
name|DEBUGLOG
argument_list|(
literal|4
argument_list|,
literal|"pledged content size : %u ; flag : %u"
argument_list|,
operator|(
name|U32
operator|)
name|pledgedSrcSize
argument_list|,
name|cctx
operator|->
name|appliedParams
operator|.
name|fParams
operator|.
name|contentSizeFlag
argument_list|)
expr_stmt|;
name|cctx
operator|->
name|lowLimit
operator|=
name|end
expr_stmt|;
name|cctx
operator|->
name|dictLimit
operator|=
name|end
expr_stmt|;
name|cctx
operator|->
name|nextToUpdate
operator|=
name|end
operator|+
literal|1
expr_stmt|;
name|cctx
operator|->
name|stage
operator|=
name|ZSTDcs_init
expr_stmt|;
name|cctx
operator|->
name|dictID
operator|=
literal|0
expr_stmt|;
name|cctx
operator|->
name|loadedDictEnd
operator|=
literal|0
expr_stmt|;
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ZSTD_REP_NUM
condition|;
name|i
operator|++
control|)
name|cctx
operator|->
name|seqStore
operator|.
name|rep
index|[
name|i
index|]
operator|=
name|repStartValue
index|[
name|i
index|]
expr_stmt|;
block|}
name|cctx
operator|->
name|optState
operator|.
name|litLengthSum
operator|=
literal|0
expr_stmt|;
comment|/* force reset of btopt stats */
name|XXH64_reset
argument_list|(
operator|&
name|cctx
operator|->
name|xxhState
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_typedef
typedef|typedef
enum|enum
block|{
name|ZSTDcrp_continue
block|,
name|ZSTDcrp_noMemset
block|}
name|ZSTD_compResetPolicy_e
typedef|;
end_typedef

begin_typedef
typedef|typedef
enum|enum
block|{
name|ZSTDb_not_buffered
block|,
name|ZSTDb_buffered
block|}
name|ZSTD_buffered_policy_e
typedef|;
end_typedef

begin_comment
comment|/*! ZSTD_resetCCtx_internal() :     note : `params` are assumed fully validated at this stage */
end_comment

begin_function
specifier|static
name|size_t
name|ZSTD_resetCCtx_internal
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|zc
parameter_list|,
name|ZSTD_CCtx_params
name|params
parameter_list|,
name|U64
name|pledgedSrcSize
parameter_list|,
name|ZSTD_compResetPolicy_e
specifier|const
name|crp
parameter_list|,
name|ZSTD_buffered_policy_e
specifier|const
name|zbuff
parameter_list|)
block|{
name|DEBUGLOG
argument_list|(
literal|4
argument_list|,
literal|"ZSTD_resetCCtx_internal"
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|!
name|ZSTD_isError
argument_list|(
name|ZSTD_checkCParams
argument_list|(
name|params
operator|.
name|cParams
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|DEBUGLOG
argument_list|(
literal|4
argument_list|,
literal|"pledgedSrcSize: %u"
argument_list|,
operator|(
name|U32
operator|)
name|pledgedSrcSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|crp
operator|==
name|ZSTDcrp_continue
condition|)
block|{
if|if
condition|(
name|ZSTD_equivalentParams
argument_list|(
name|params
argument_list|,
name|zc
operator|->
name|appliedParams
argument_list|)
condition|)
block|{
name|DEBUGLOG
argument_list|(
literal|4
argument_list|,
literal|"ZSTD_equivalentParams()==1"
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|!
operator|(
name|params
operator|.
name|ldmParams
operator|.
name|enableLdm
operator|&&
name|params
operator|.
name|ldmParams
operator|.
name|hashEveryLog
operator|==
name|ZSTD_LDM_HASHEVERYLOG_NOTSET
operator|)
argument_list|)
expr_stmt|;
name|zc
operator|->
name|entropy
operator|->
name|hufCTable_repeatMode
operator|=
name|HUF_repeat_none
expr_stmt|;
name|zc
operator|->
name|entropy
operator|->
name|offcode_repeatMode
operator|=
name|FSE_repeat_none
expr_stmt|;
name|zc
operator|->
name|entropy
operator|->
name|matchlength_repeatMode
operator|=
name|FSE_repeat_none
expr_stmt|;
name|zc
operator|->
name|entropy
operator|->
name|litlength_repeatMode
operator|=
name|FSE_repeat_none
expr_stmt|;
return|return
name|ZSTD_continueCCtx
argument_list|(
name|zc
argument_list|,
name|params
argument_list|,
name|pledgedSrcSize
argument_list|)
return|;
block|}
block|}
if|if
condition|(
name|params
operator|.
name|ldmParams
operator|.
name|enableLdm
condition|)
block|{
comment|/* Adjust long distance matching parameters */
name|ZSTD_ldm_adjustParameters
argument_list|(
operator|&
name|params
operator|.
name|ldmParams
argument_list|,
name|params
operator|.
name|cParams
operator|.
name|windowLog
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|params
operator|.
name|ldmParams
operator|.
name|hashLog
operator|>=
name|params
operator|.
name|ldmParams
operator|.
name|bucketSizeLog
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|params
operator|.
name|ldmParams
operator|.
name|hashEveryLog
operator|<
literal|32
argument_list|)
expr_stmt|;
name|zc
operator|->
name|ldmState
operator|.
name|hashPower
operator|=
name|ZSTD_ldm_getHashPower
argument_list|(
name|params
operator|.
name|ldmParams
operator|.
name|minMatchLength
argument_list|)
expr_stmt|;
block|}
block|{
name|size_t
specifier|const
name|blockSize
init|=
name|MIN
argument_list|(
name|ZSTD_BLOCKSIZE_MAX
argument_list|,
operator|(
name|size_t
operator|)
literal|1
operator|<<
name|params
operator|.
name|cParams
operator|.
name|windowLog
argument_list|)
decl_stmt|;
name|U32
specifier|const
name|divider
init|=
operator|(
name|params
operator|.
name|cParams
operator|.
name|searchLength
operator|==
literal|3
operator|)
condition|?
literal|3
else|:
literal|4
decl_stmt|;
name|size_t
specifier|const
name|maxNbSeq
init|=
name|blockSize
operator|/
name|divider
decl_stmt|;
name|size_t
specifier|const
name|tokenSpace
init|=
name|blockSize
operator|+
literal|11
operator|*
name|maxNbSeq
decl_stmt|;
name|size_t
specifier|const
name|chainSize
init|=
operator|(
name|params
operator|.
name|cParams
operator|.
name|strategy
operator|==
name|ZSTD_fast
operator|)
condition|?
literal|0
else|:
operator|(
operator|(
name|size_t
operator|)
literal|1
operator|<<
name|params
operator|.
name|cParams
operator|.
name|chainLog
operator|)
decl_stmt|;
name|size_t
specifier|const
name|hSize
init|=
operator|(
operator|(
name|size_t
operator|)
literal|1
operator|)
operator|<<
name|params
operator|.
name|cParams
operator|.
name|hashLog
decl_stmt|;
name|U32
specifier|const
name|hashLog3
init|=
operator|(
name|params
operator|.
name|cParams
operator|.
name|searchLength
operator|>
literal|3
operator|)
condition|?
literal|0
else|:
name|MIN
argument_list|(
name|ZSTD_HASHLOG3_MAX
argument_list|,
name|params
operator|.
name|cParams
operator|.
name|windowLog
argument_list|)
decl_stmt|;
name|size_t
specifier|const
name|h3Size
init|=
operator|(
operator|(
name|size_t
operator|)
literal|1
operator|)
operator|<<
name|hashLog3
decl_stmt|;
name|size_t
specifier|const
name|tableSpace
init|=
operator|(
name|chainSize
operator|+
name|hSize
operator|+
name|h3Size
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|U32
argument_list|)
decl_stmt|;
name|size_t
specifier|const
name|buffOutSize
init|=
operator|(
name|zbuff
operator|==
name|ZSTDb_buffered
operator|)
condition|?
name|ZSTD_compressBound
argument_list|(
name|blockSize
argument_list|)
operator|+
literal|1
else|:
literal|0
decl_stmt|;
name|size_t
specifier|const
name|buffInSize
init|=
operator|(
name|zbuff
operator|==
name|ZSTDb_buffered
operator|)
condition|?
operator|(
operator|(
name|size_t
operator|)
literal|1
operator|<<
name|params
operator|.
name|cParams
operator|.
name|windowLog
operator|)
operator|+
name|blockSize
else|:
literal|0
decl_stmt|;
name|void
modifier|*
name|ptr
decl_stmt|;
comment|/* Check if workSpace is large enough, alloc a new one if needed */
block|{
name|size_t
specifier|const
name|entropySpace
init|=
sizeof|sizeof
argument_list|(
name|ZSTD_entropyCTables_t
argument_list|)
decl_stmt|;
name|size_t
specifier|const
name|optPotentialSpace
init|=
operator|(
operator|(
name|MaxML
operator|+
literal|1
operator|)
operator|+
operator|(
name|MaxLL
operator|+
literal|1
operator|)
operator|+
operator|(
name|MaxOff
operator|+
literal|1
operator|)
operator|+
operator|(
literal|1
operator|<<
name|Litbits
operator|)
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|U32
argument_list|)
operator|+
operator|(
name|ZSTD_OPT_NUM
operator|+
literal|1
operator|)
operator|*
operator|(
sizeof|sizeof
argument_list|(
name|ZSTD_match_t
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|ZSTD_optimal_t
argument_list|)
operator|)
decl_stmt|;
name|size_t
specifier|const
name|optSpace
init|=
operator|(
operator|(
name|params
operator|.
name|cParams
operator|.
name|strategy
operator|==
name|ZSTD_btopt
operator|)
operator|||
operator|(
name|params
operator|.
name|cParams
operator|.
name|strategy
operator|==
name|ZSTD_btultra
operator|)
operator|)
condition|?
name|optPotentialSpace
else|:
literal|0
decl_stmt|;
name|size_t
specifier|const
name|bufferSpace
init|=
name|buffInSize
operator|+
name|buffOutSize
decl_stmt|;
name|size_t
specifier|const
name|ldmSpace
init|=
name|params
operator|.
name|ldmParams
operator|.
name|enableLdm
condition|?
name|ZSTD_ldm_getTableSize
argument_list|(
name|params
operator|.
name|ldmParams
operator|.
name|hashLog
argument_list|,
name|params
operator|.
name|ldmParams
operator|.
name|bucketSizeLog
argument_list|)
else|:
literal|0
decl_stmt|;
name|size_t
specifier|const
name|neededSpace
init|=
name|entropySpace
operator|+
name|optSpace
operator|+
name|ldmSpace
operator|+
name|tableSpace
operator|+
name|tokenSpace
operator|+
name|bufferSpace
decl_stmt|;
if|if
condition|(
name|zc
operator|->
name|workSpaceSize
operator|<
name|neededSpace
condition|)
block|{
comment|/* too small : resize */
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"Need to update workSpaceSize from %uK to %uK \n"
argument_list|,
operator|(
name|unsigned
operator|)
name|zc
operator|->
name|workSpaceSize
operator|>>
literal|10
argument_list|,
operator|(
name|unsigned
operator|)
name|neededSpace
operator|>>
literal|10
argument_list|)
expr_stmt|;
comment|/* static cctx : no resize, error out */
if|if
condition|(
name|zc
operator|->
name|staticSize
condition|)
return|return
name|ERROR
argument_list|(
name|memory_allocation
argument_list|)
return|;
name|zc
operator|->
name|workSpaceSize
operator|=
literal|0
expr_stmt|;
name|ZSTD_free
argument_list|(
name|zc
operator|->
name|workSpace
argument_list|,
name|zc
operator|->
name|customMem
argument_list|)
expr_stmt|;
name|zc
operator|->
name|workSpace
operator|=
name|ZSTD_malloc
argument_list|(
name|neededSpace
argument_list|,
name|zc
operator|->
name|customMem
argument_list|)
expr_stmt|;
if|if
condition|(
name|zc
operator|->
name|workSpace
operator|==
name|NULL
condition|)
return|return
name|ERROR
argument_list|(
name|memory_allocation
argument_list|)
return|;
name|zc
operator|->
name|workSpaceSize
operator|=
name|neededSpace
expr_stmt|;
name|ptr
operator|=
name|zc
operator|->
name|workSpace
expr_stmt|;
comment|/* entropy space */
name|assert
argument_list|(
operator|(
operator|(
name|size_t
operator|)
name|zc
operator|->
name|workSpace
operator|&
literal|3
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* ensure correct alignment */
name|assert
argument_list|(
name|zc
operator|->
name|workSpaceSize
operator|>=
sizeof|sizeof
argument_list|(
name|ZSTD_entropyCTables_t
argument_list|)
argument_list|)
expr_stmt|;
name|zc
operator|->
name|entropy
operator|=
operator|(
name|ZSTD_entropyCTables_t
operator|*
operator|)
name|zc
operator|->
name|workSpace
expr_stmt|;
block|}
block|}
comment|/* init params */
name|zc
operator|->
name|appliedParams
operator|=
name|params
expr_stmt|;
name|zc
operator|->
name|pledgedSrcSizePlusOne
operator|=
name|pledgedSrcSize
operator|+
literal|1
expr_stmt|;
name|zc
operator|->
name|consumedSrcSize
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pledgedSrcSize
operator|==
name|ZSTD_CONTENTSIZE_UNKNOWN
condition|)
name|zc
operator|->
name|appliedParams
operator|.
name|fParams
operator|.
name|contentSizeFlag
operator|=
literal|0
expr_stmt|;
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"pledged content size : %u ; flag : %u"
argument_list|,
operator|(
name|U32
operator|)
name|pledgedSrcSize
argument_list|,
name|zc
operator|->
name|appliedParams
operator|.
name|fParams
operator|.
name|contentSizeFlag
argument_list|)
expr_stmt|;
name|zc
operator|->
name|blockSize
operator|=
name|blockSize
expr_stmt|;
name|XXH64_reset
argument_list|(
operator|&
name|zc
operator|->
name|xxhState
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|zc
operator|->
name|stage
operator|=
name|ZSTDcs_init
expr_stmt|;
name|zc
operator|->
name|dictID
operator|=
literal|0
expr_stmt|;
name|zc
operator|->
name|loadedDictEnd
operator|=
literal|0
expr_stmt|;
name|zc
operator|->
name|entropy
operator|->
name|hufCTable_repeatMode
operator|=
name|HUF_repeat_none
expr_stmt|;
name|zc
operator|->
name|entropy
operator|->
name|offcode_repeatMode
operator|=
name|FSE_repeat_none
expr_stmt|;
name|zc
operator|->
name|entropy
operator|->
name|matchlength_repeatMode
operator|=
name|FSE_repeat_none
expr_stmt|;
name|zc
operator|->
name|entropy
operator|->
name|litlength_repeatMode
operator|=
name|FSE_repeat_none
expr_stmt|;
name|zc
operator|->
name|nextToUpdate
operator|=
literal|1
expr_stmt|;
name|zc
operator|->
name|nextSrc
operator|=
name|NULL
expr_stmt|;
name|zc
operator|->
name|base
operator|=
name|NULL
expr_stmt|;
name|zc
operator|->
name|dictBase
operator|=
name|NULL
expr_stmt|;
name|zc
operator|->
name|dictLimit
operator|=
literal|0
expr_stmt|;
name|zc
operator|->
name|lowLimit
operator|=
literal|0
expr_stmt|;
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ZSTD_REP_NUM
condition|;
name|i
operator|++
control|)
name|zc
operator|->
name|seqStore
operator|.
name|rep
index|[
name|i
index|]
operator|=
name|repStartValue
index|[
name|i
index|]
expr_stmt|;
block|}
name|zc
operator|->
name|hashLog3
operator|=
name|hashLog3
expr_stmt|;
name|zc
operator|->
name|optState
operator|.
name|litLengthSum
operator|=
literal|0
expr_stmt|;
name|ptr
operator|=
name|zc
operator|->
name|entropy
operator|+
literal|1
expr_stmt|;
comment|/* opt parser space */
if|if
condition|(
operator|(
name|params
operator|.
name|cParams
operator|.
name|strategy
operator|==
name|ZSTD_btopt
operator|)
operator|||
operator|(
name|params
operator|.
name|cParams
operator|.
name|strategy
operator|==
name|ZSTD_btultra
operator|)
condition|)
block|{
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"reserving optimal parser space"
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|(
operator|(
name|size_t
operator|)
name|ptr
operator|&
literal|3
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* ensure ptr is properly aligned */
name|zc
operator|->
name|optState
operator|.
name|litFreq
operator|=
operator|(
name|U32
operator|*
operator|)
name|ptr
expr_stmt|;
name|zc
operator|->
name|optState
operator|.
name|litLengthFreq
operator|=
name|zc
operator|->
name|optState
operator|.
name|litFreq
operator|+
operator|(
literal|1
operator|<<
name|Litbits
operator|)
expr_stmt|;
name|zc
operator|->
name|optState
operator|.
name|matchLengthFreq
operator|=
name|zc
operator|->
name|optState
operator|.
name|litLengthFreq
operator|+
operator|(
name|MaxLL
operator|+
literal|1
operator|)
expr_stmt|;
name|zc
operator|->
name|optState
operator|.
name|offCodeFreq
operator|=
name|zc
operator|->
name|optState
operator|.
name|matchLengthFreq
operator|+
operator|(
name|MaxML
operator|+
literal|1
operator|)
expr_stmt|;
name|ptr
operator|=
name|zc
operator|->
name|optState
operator|.
name|offCodeFreq
operator|+
operator|(
name|MaxOff
operator|+
literal|1
operator|)
expr_stmt|;
name|zc
operator|->
name|optState
operator|.
name|matchTable
operator|=
operator|(
name|ZSTD_match_t
operator|*
operator|)
name|ptr
expr_stmt|;
name|ptr
operator|=
name|zc
operator|->
name|optState
operator|.
name|matchTable
operator|+
name|ZSTD_OPT_NUM
operator|+
literal|1
expr_stmt|;
name|zc
operator|->
name|optState
operator|.
name|priceTable
operator|=
operator|(
name|ZSTD_optimal_t
operator|*
operator|)
name|ptr
expr_stmt|;
name|ptr
operator|=
name|zc
operator|->
name|optState
operator|.
name|priceTable
operator|+
name|ZSTD_OPT_NUM
operator|+
literal|1
expr_stmt|;
block|}
comment|/* ldm hash table */
comment|/* initialize bucketOffsets table later for pointer alignment */
if|if
condition|(
name|params
operator|.
name|ldmParams
operator|.
name|enableLdm
condition|)
block|{
name|size_t
specifier|const
name|ldmHSize
init|=
operator|(
operator|(
name|size_t
operator|)
literal|1
operator|)
operator|<<
name|params
operator|.
name|ldmParams
operator|.
name|hashLog
decl_stmt|;
name|memset
argument_list|(
name|ptr
argument_list|,
literal|0
argument_list|,
name|ldmHSize
operator|*
sizeof|sizeof
argument_list|(
name|ldmEntry_t
argument_list|)
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|(
operator|(
name|size_t
operator|)
name|ptr
operator|&
literal|3
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* ensure ptr is properly aligned */
name|zc
operator|->
name|ldmState
operator|.
name|hashTable
operator|=
operator|(
name|ldmEntry_t
operator|*
operator|)
name|ptr
expr_stmt|;
name|ptr
operator|=
name|zc
operator|->
name|ldmState
operator|.
name|hashTable
operator|+
name|ldmHSize
expr_stmt|;
block|}
comment|/* table Space */
if|if
condition|(
name|crp
operator|!=
name|ZSTDcrp_noMemset
condition|)
name|memset
argument_list|(
name|ptr
argument_list|,
literal|0
argument_list|,
name|tableSpace
argument_list|)
expr_stmt|;
comment|/* reset tables only */
name|assert
argument_list|(
operator|(
operator|(
name|size_t
operator|)
name|ptr
operator|&
literal|3
operator|)
operator|==
literal|0
argument_list|)
expr_stmt|;
comment|/* ensure ptr is properly aligned */
name|zc
operator|->
name|hashTable
operator|=
operator|(
name|U32
operator|*
operator|)
operator|(
name|ptr
operator|)
expr_stmt|;
name|zc
operator|->
name|chainTable
operator|=
name|zc
operator|->
name|hashTable
operator|+
name|hSize
expr_stmt|;
name|zc
operator|->
name|hashTable3
operator|=
name|zc
operator|->
name|chainTable
operator|+
name|chainSize
expr_stmt|;
name|ptr
operator|=
name|zc
operator|->
name|hashTable3
operator|+
name|h3Size
expr_stmt|;
comment|/* sequences storage */
name|zc
operator|->
name|seqStore
operator|.
name|sequencesStart
operator|=
operator|(
name|seqDef
operator|*
operator|)
name|ptr
expr_stmt|;
name|ptr
operator|=
name|zc
operator|->
name|seqStore
operator|.
name|sequencesStart
operator|+
name|maxNbSeq
expr_stmt|;
name|zc
operator|->
name|seqStore
operator|.
name|llCode
operator|=
operator|(
name|BYTE
operator|*
operator|)
name|ptr
expr_stmt|;
name|zc
operator|->
name|seqStore
operator|.
name|mlCode
operator|=
name|zc
operator|->
name|seqStore
operator|.
name|llCode
operator|+
name|maxNbSeq
expr_stmt|;
name|zc
operator|->
name|seqStore
operator|.
name|ofCode
operator|=
name|zc
operator|->
name|seqStore
operator|.
name|mlCode
operator|+
name|maxNbSeq
expr_stmt|;
name|zc
operator|->
name|seqStore
operator|.
name|litStart
operator|=
name|zc
operator|->
name|seqStore
operator|.
name|ofCode
operator|+
name|maxNbSeq
expr_stmt|;
name|ptr
operator|=
name|zc
operator|->
name|seqStore
operator|.
name|litStart
operator|+
name|blockSize
expr_stmt|;
comment|/* ldm bucketOffsets table */
if|if
condition|(
name|params
operator|.
name|ldmParams
operator|.
name|enableLdm
condition|)
block|{
name|size_t
specifier|const
name|ldmBucketSize
init|=
operator|(
operator|(
name|size_t
operator|)
literal|1
operator|)
operator|<<
operator|(
name|params
operator|.
name|ldmParams
operator|.
name|hashLog
operator|-
name|params
operator|.
name|ldmParams
operator|.
name|bucketSizeLog
operator|)
decl_stmt|;
name|memset
argument_list|(
name|ptr
argument_list|,
literal|0
argument_list|,
name|ldmBucketSize
argument_list|)
expr_stmt|;
name|zc
operator|->
name|ldmState
operator|.
name|bucketOffsets
operator|=
operator|(
name|BYTE
operator|*
operator|)
name|ptr
expr_stmt|;
name|ptr
operator|=
name|zc
operator|->
name|ldmState
operator|.
name|bucketOffsets
operator|+
name|ldmBucketSize
expr_stmt|;
block|}
comment|/* buffers */
name|zc
operator|->
name|inBuffSize
operator|=
name|buffInSize
expr_stmt|;
name|zc
operator|->
name|inBuff
operator|=
operator|(
name|char
operator|*
operator|)
name|ptr
expr_stmt|;
name|zc
operator|->
name|outBuffSize
operator|=
name|buffOutSize
expr_stmt|;
name|zc
operator|->
name|outBuff
operator|=
name|zc
operator|->
name|inBuff
operator|+
name|buffInSize
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
end_function

begin_comment
comment|/* ZSTD_invalidateRepCodes() :  * ensures next compression will not use repcodes from previous block.  * Note : only works with regular variant;  *        do not use with extDict variant ! */
end_comment

begin_function
name|void
name|ZSTD_invalidateRepCodes
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ZSTD_REP_NUM
condition|;
name|i
operator|++
control|)
name|cctx
operator|->
name|seqStore
operator|.
name|rep
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*! ZSTD_copyCCtx_internal() :  *  Duplicate an existing context `srcCCtx` into another one `dstCCtx`.  *  The "context", in this case, refers to the hash and chain tables, entropy  *  tables, and dictionary offsets.  *  Only works during stage ZSTDcs_init (i.e. after creation, but before first call to ZSTD_compressContinue()).  *  pledgedSrcSize=0 means "empty" if fParams.contentSizeFlag=1  *  @return : 0, or an error code */
end_comment

begin_function
specifier|static
name|size_t
name|ZSTD_copyCCtx_internal
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|dstCCtx
parameter_list|,
specifier|const
name|ZSTD_CCtx
modifier|*
name|srcCCtx
parameter_list|,
name|ZSTD_frameParameters
name|fParams
parameter_list|,
name|unsigned
name|long
name|long
name|pledgedSrcSize
parameter_list|,
name|ZSTD_buffered_policy_e
name|zbuff
parameter_list|)
block|{
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"ZSTD_copyCCtx_internal"
argument_list|)
expr_stmt|;
if|if
condition|(
name|srcCCtx
operator|->
name|stage
operator|!=
name|ZSTDcs_init
condition|)
return|return
name|ERROR
argument_list|(
name|stage_wrong
argument_list|)
return|;
name|memcpy
argument_list|(
operator|&
name|dstCCtx
operator|->
name|customMem
argument_list|,
operator|&
name|srcCCtx
operator|->
name|customMem
argument_list|,
sizeof|sizeof
argument_list|(
name|ZSTD_customMem
argument_list|)
argument_list|)
expr_stmt|;
block|{
name|ZSTD_CCtx_params
name|params
init|=
name|dstCCtx
operator|->
name|requestedParams
decl_stmt|;
comment|/* Copy only compression parameters related to tables. */
name|params
operator|.
name|cParams
operator|=
name|srcCCtx
operator|->
name|appliedParams
operator|.
name|cParams
expr_stmt|;
name|params
operator|.
name|fParams
operator|=
name|fParams
expr_stmt|;
name|ZSTD_resetCCtx_internal
argument_list|(
name|dstCCtx
argument_list|,
name|params
argument_list|,
name|pledgedSrcSize
argument_list|,
name|ZSTDcrp_noMemset
argument_list|,
name|zbuff
argument_list|)
expr_stmt|;
block|}
comment|/* copy tables */
block|{
name|size_t
specifier|const
name|chainSize
init|=
operator|(
name|srcCCtx
operator|->
name|appliedParams
operator|.
name|cParams
operator|.
name|strategy
operator|==
name|ZSTD_fast
operator|)
condition|?
literal|0
else|:
operator|(
operator|(
name|size_t
operator|)
literal|1
operator|<<
name|srcCCtx
operator|->
name|appliedParams
operator|.
name|cParams
operator|.
name|chainLog
operator|)
decl_stmt|;
name|size_t
specifier|const
name|hSize
init|=
operator|(
name|size_t
operator|)
literal|1
operator|<<
name|srcCCtx
operator|->
name|appliedParams
operator|.
name|cParams
operator|.
name|hashLog
decl_stmt|;
name|size_t
specifier|const
name|h3Size
init|=
operator|(
name|size_t
operator|)
literal|1
operator|<<
name|srcCCtx
operator|->
name|hashLog3
decl_stmt|;
name|size_t
specifier|const
name|tableSpace
init|=
operator|(
name|chainSize
operator|+
name|hSize
operator|+
name|h3Size
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|U32
argument_list|)
decl_stmt|;
name|assert
argument_list|(
operator|(
name|U32
operator|*
operator|)
name|dstCCtx
operator|->
name|chainTable
operator|==
operator|(
name|U32
operator|*
operator|)
name|dstCCtx
operator|->
name|hashTable
operator|+
name|hSize
argument_list|)
expr_stmt|;
comment|/* chainTable must follow hashTable */
name|assert
argument_list|(
operator|(
name|U32
operator|*
operator|)
name|dstCCtx
operator|->
name|hashTable3
operator|==
operator|(
name|U32
operator|*
operator|)
name|dstCCtx
operator|->
name|chainTable
operator|+
name|chainSize
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|dstCCtx
operator|->
name|hashTable
argument_list|,
name|srcCCtx
operator|->
name|hashTable
argument_list|,
name|tableSpace
argument_list|)
expr_stmt|;
comment|/* presumes all tables follow each other */
block|}
comment|/* copy dictionary offsets */
name|dstCCtx
operator|->
name|nextToUpdate
operator|=
name|srcCCtx
operator|->
name|nextToUpdate
expr_stmt|;
name|dstCCtx
operator|->
name|nextToUpdate3
operator|=
name|srcCCtx
operator|->
name|nextToUpdate3
expr_stmt|;
name|dstCCtx
operator|->
name|nextSrc
operator|=
name|srcCCtx
operator|->
name|nextSrc
expr_stmt|;
name|dstCCtx
operator|->
name|base
operator|=
name|srcCCtx
operator|->
name|base
expr_stmt|;
name|dstCCtx
operator|->
name|dictBase
operator|=
name|srcCCtx
operator|->
name|dictBase
expr_stmt|;
name|dstCCtx
operator|->
name|dictLimit
operator|=
name|srcCCtx
operator|->
name|dictLimit
expr_stmt|;
name|dstCCtx
operator|->
name|lowLimit
operator|=
name|srcCCtx
operator|->
name|lowLimit
expr_stmt|;
name|dstCCtx
operator|->
name|loadedDictEnd
operator|=
name|srcCCtx
operator|->
name|loadedDictEnd
expr_stmt|;
name|dstCCtx
operator|->
name|dictID
operator|=
name|srcCCtx
operator|->
name|dictID
expr_stmt|;
comment|/* copy entropy tables */
name|memcpy
argument_list|(
name|dstCCtx
operator|->
name|entropy
argument_list|,
name|srcCCtx
operator|->
name|entropy
argument_list|,
sizeof|sizeof
argument_list|(
name|ZSTD_entropyCTables_t
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*! ZSTD_copyCCtx() :  *  Duplicate an existing context `srcCCtx` into another one `dstCCtx`.  *  Only works during stage ZSTDcs_init (i.e. after creation, but before first call to ZSTD_compressContinue()).  *  pledgedSrcSize==0 means "unknown". *   @return : 0, or an error code */
end_comment

begin_function
name|size_t
name|ZSTD_copyCCtx
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|dstCCtx
parameter_list|,
specifier|const
name|ZSTD_CCtx
modifier|*
name|srcCCtx
parameter_list|,
name|unsigned
name|long
name|long
name|pledgedSrcSize
parameter_list|)
block|{
name|ZSTD_frameParameters
name|fParams
init|=
block|{
literal|1
comment|/*content*/
block|,
literal|0
comment|/*checksum*/
block|,
literal|0
comment|/*noDictID*/
block|}
decl_stmt|;
name|ZSTD_buffered_policy_e
specifier|const
name|zbuff
init|=
call|(
name|ZSTD_buffered_policy_e
call|)
argument_list|(
name|srcCCtx
operator|->
name|inBuffSize
operator|>
literal|0
argument_list|)
decl_stmt|;
name|ZSTD_STATIC_ASSERT
argument_list|(
operator|(
name|U32
operator|)
name|ZSTDb_buffered
operator|==
literal|1
argument_list|)
expr_stmt|;
name|fParams
operator|.
name|contentSizeFlag
operator|=
name|pledgedSrcSize
operator|>
literal|0
expr_stmt|;
return|return
name|ZSTD_copyCCtx_internal
argument_list|(
name|dstCCtx
argument_list|,
name|srcCCtx
argument_list|,
name|fParams
argument_list|,
name|pledgedSrcSize
argument_list|,
name|zbuff
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*! ZSTD_reduceTable() :  *  reduce table indexes by `reducerValue` */
end_comment

begin_function
specifier|static
name|void
name|ZSTD_reduceTable
parameter_list|(
name|U32
modifier|*
specifier|const
name|table
parameter_list|,
name|U32
specifier|const
name|size
parameter_list|,
name|U32
specifier|const
name|reducerValue
parameter_list|)
block|{
name|U32
name|u
decl_stmt|;
for|for
control|(
name|u
operator|=
literal|0
init|;
name|u
operator|<
name|size
condition|;
name|u
operator|++
control|)
block|{
if|if
condition|(
name|table
index|[
name|u
index|]
operator|<
name|reducerValue
condition|)
name|table
index|[
name|u
index|]
operator|=
literal|0
expr_stmt|;
else|else
name|table
index|[
name|u
index|]
operator|-=
name|reducerValue
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*! ZSTD_ldm_reduceTable() :  *  reduce table indexes by `reducerValue` */
end_comment

begin_function
specifier|static
name|void
name|ZSTD_ldm_reduceTable
parameter_list|(
name|ldmEntry_t
modifier|*
specifier|const
name|table
parameter_list|,
name|U32
specifier|const
name|size
parameter_list|,
name|U32
specifier|const
name|reducerValue
parameter_list|)
block|{
name|U32
name|u
decl_stmt|;
for|for
control|(
name|u
operator|=
literal|0
init|;
name|u
operator|<
name|size
condition|;
name|u
operator|++
control|)
block|{
if|if
condition|(
name|table
index|[
name|u
index|]
operator|.
name|offset
operator|<
name|reducerValue
condition|)
name|table
index|[
name|u
index|]
operator|.
name|offset
operator|=
literal|0
expr_stmt|;
else|else
name|table
index|[
name|u
index|]
operator|.
name|offset
operator|-=
name|reducerValue
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*! ZSTD_reduceIndex() : *   rescale all indexes to avoid future overflow (indexes are U32) */
end_comment

begin_function
specifier|static
name|void
name|ZSTD_reduceIndex
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|zc
parameter_list|,
specifier|const
name|U32
name|reducerValue
parameter_list|)
block|{
block|{
name|U32
specifier|const
name|hSize
init|=
operator|(
name|U32
operator|)
literal|1
operator|<<
name|zc
operator|->
name|appliedParams
operator|.
name|cParams
operator|.
name|hashLog
decl_stmt|;
name|ZSTD_reduceTable
argument_list|(
name|zc
operator|->
name|hashTable
argument_list|,
name|hSize
argument_list|,
name|reducerValue
argument_list|)
expr_stmt|;
block|}
block|{
name|U32
specifier|const
name|chainSize
init|=
operator|(
name|zc
operator|->
name|appliedParams
operator|.
name|cParams
operator|.
name|strategy
operator|==
name|ZSTD_fast
operator|)
condition|?
literal|0
else|:
operator|(
operator|(
name|U32
operator|)
literal|1
operator|<<
name|zc
operator|->
name|appliedParams
operator|.
name|cParams
operator|.
name|chainLog
operator|)
decl_stmt|;
name|ZSTD_reduceTable
argument_list|(
name|zc
operator|->
name|chainTable
argument_list|,
name|chainSize
argument_list|,
name|reducerValue
argument_list|)
expr_stmt|;
block|}
block|{
name|U32
specifier|const
name|h3Size
init|=
operator|(
name|zc
operator|->
name|hashLog3
operator|)
condition|?
operator|(
name|U32
operator|)
literal|1
operator|<<
name|zc
operator|->
name|hashLog3
else|:
literal|0
decl_stmt|;
name|ZSTD_reduceTable
argument_list|(
name|zc
operator|->
name|hashTable3
argument_list|,
name|h3Size
argument_list|,
name|reducerValue
argument_list|)
expr_stmt|;
block|}
block|{
if|if
condition|(
name|zc
operator|->
name|appliedParams
operator|.
name|ldmParams
operator|.
name|enableLdm
condition|)
block|{
name|U32
specifier|const
name|ldmHSize
init|=
operator|(
name|U32
operator|)
literal|1
operator|<<
name|zc
operator|->
name|appliedParams
operator|.
name|ldmParams
operator|.
name|hashLog
decl_stmt|;
name|ZSTD_ldm_reduceTable
argument_list|(
name|zc
operator|->
name|ldmState
operator|.
name|hashTable
argument_list|,
name|ldmHSize
argument_list|,
name|reducerValue
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*-******************************************************* *  Block entropic compression *********************************************************/
end_comment

begin_comment
comment|/* See doc/zstd_compression_format.md for detailed format description */
end_comment

begin_function
name|size_t
name|ZSTD_noCompressBlock
parameter_list|(
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstCapacity
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|)
block|{
if|if
condition|(
name|srcSize
operator|+
name|ZSTD_blockHeaderSize
operator|>
name|dstCapacity
condition|)
return|return
name|ERROR
argument_list|(
name|dstSize_tooSmall
argument_list|)
return|;
name|memcpy
argument_list|(
operator|(
name|BYTE
operator|*
operator|)
name|dst
operator|+
name|ZSTD_blockHeaderSize
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|)
expr_stmt|;
name|MEM_writeLE24
argument_list|(
name|dst
argument_list|,
call|(
name|U32
call|)
argument_list|(
name|srcSize
operator|<<
literal|2
argument_list|)
operator|+
operator|(
name|U32
operator|)
name|bt_raw
argument_list|)
expr_stmt|;
return|return
name|ZSTD_blockHeaderSize
operator|+
name|srcSize
return|;
block|}
end_function

begin_function
specifier|static
name|size_t
name|ZSTD_noCompressLiterals
parameter_list|(
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstCapacity
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|)
block|{
name|BYTE
modifier|*
specifier|const
name|ostart
init|=
operator|(
name|BYTE
operator|*
specifier|const
operator|)
name|dst
decl_stmt|;
name|U32
specifier|const
name|flSize
init|=
literal|1
operator|+
operator|(
name|srcSize
operator|>
literal|31
operator|)
operator|+
operator|(
name|srcSize
operator|>
literal|4095
operator|)
decl_stmt|;
if|if
condition|(
name|srcSize
operator|+
name|flSize
operator|>
name|dstCapacity
condition|)
return|return
name|ERROR
argument_list|(
name|dstSize_tooSmall
argument_list|)
return|;
switch|switch
condition|(
name|flSize
condition|)
block|{
case|case
literal|1
case|:
comment|/* 2 - 1 - 5 */
name|ostart
index|[
literal|0
index|]
operator|=
call|(
name|BYTE
call|)
argument_list|(
operator|(
name|U32
operator|)
name|set_basic
operator|+
operator|(
name|srcSize
operator|<<
literal|3
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* 2 - 2 - 12 */
name|MEM_writeLE16
argument_list|(
name|ostart
argument_list|,
call|(
name|U16
call|)
argument_list|(
operator|(
name|U32
operator|)
name|set_basic
operator|+
operator|(
literal|1
operator|<<
literal|2
operator|)
operator|+
operator|(
name|srcSize
operator|<<
literal|4
operator|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
comment|/* 2 - 2 - 20 */
name|MEM_writeLE32
argument_list|(
name|ostart
argument_list|,
call|(
name|U32
call|)
argument_list|(
operator|(
name|U32
operator|)
name|set_basic
operator|+
operator|(
literal|3
operator|<<
literal|2
operator|)
operator|+
operator|(
name|srcSize
operator|<<
literal|4
operator|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* not necessary : flSize is {1,2,3} */
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|ostart
operator|+
name|flSize
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|)
expr_stmt|;
return|return
name|srcSize
operator|+
name|flSize
return|;
block|}
end_function

begin_function
specifier|static
name|size_t
name|ZSTD_compressRleLiteralsBlock
parameter_list|(
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstCapacity
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|)
block|{
name|BYTE
modifier|*
specifier|const
name|ostart
init|=
operator|(
name|BYTE
operator|*
specifier|const
operator|)
name|dst
decl_stmt|;
name|U32
specifier|const
name|flSize
init|=
literal|1
operator|+
operator|(
name|srcSize
operator|>
literal|31
operator|)
operator|+
operator|(
name|srcSize
operator|>
literal|4095
operator|)
decl_stmt|;
operator|(
name|void
operator|)
name|dstCapacity
expr_stmt|;
comment|/* dstCapacity already guaranteed to be>=4, hence large enough */
switch|switch
condition|(
name|flSize
condition|)
block|{
case|case
literal|1
case|:
comment|/* 2 - 1 - 5 */
name|ostart
index|[
literal|0
index|]
operator|=
call|(
name|BYTE
call|)
argument_list|(
operator|(
name|U32
operator|)
name|set_rle
operator|+
operator|(
name|srcSize
operator|<<
literal|3
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* 2 - 2 - 12 */
name|MEM_writeLE16
argument_list|(
name|ostart
argument_list|,
call|(
name|U16
call|)
argument_list|(
operator|(
name|U32
operator|)
name|set_rle
operator|+
operator|(
literal|1
operator|<<
literal|2
operator|)
operator|+
operator|(
name|srcSize
operator|<<
literal|4
operator|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
comment|/* 2 - 2 - 20 */
name|MEM_writeLE32
argument_list|(
name|ostart
argument_list|,
call|(
name|U32
call|)
argument_list|(
operator|(
name|U32
operator|)
name|set_rle
operator|+
operator|(
literal|3
operator|<<
literal|2
operator|)
operator|+
operator|(
name|srcSize
operator|<<
literal|4
operator|)
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* not necessary : flSize is {1,2,3} */
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|ostart
index|[
name|flSize
index|]
operator|=
operator|*
operator|(
specifier|const
name|BYTE
operator|*
operator|)
name|src
expr_stmt|;
return|return
name|flSize
operator|+
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|size_t
name|ZSTD_minGain
parameter_list|(
name|size_t
name|srcSize
parameter_list|)
block|{
return|return
operator|(
name|srcSize
operator|>>
literal|6
operator|)
operator|+
literal|2
return|;
block|}
end_function

begin_function
specifier|static
name|size_t
name|ZSTD_compressLiterals
parameter_list|(
name|ZSTD_entropyCTables_t
modifier|*
name|entropy
parameter_list|,
name|ZSTD_strategy
name|strategy
parameter_list|,
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstCapacity
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|)
block|{
name|size_t
specifier|const
name|minGain
init|=
name|ZSTD_minGain
argument_list|(
name|srcSize
argument_list|)
decl_stmt|;
name|size_t
specifier|const
name|lhSize
init|=
literal|3
operator|+
operator|(
name|srcSize
operator|>=
literal|1
name|KB
operator|)
operator|+
operator|(
name|srcSize
operator|>=
literal|16
name|KB
operator|)
decl_stmt|;
name|BYTE
modifier|*
specifier|const
name|ostart
init|=
operator|(
name|BYTE
operator|*
operator|)
name|dst
decl_stmt|;
name|U32
name|singleStream
init|=
name|srcSize
operator|<
literal|256
decl_stmt|;
name|symbolEncodingType_e
name|hType
init|=
name|set_compressed
decl_stmt|;
name|size_t
name|cLitSize
decl_stmt|;
comment|/* small ? don't even attempt compression (speed opt) */
define|#
directive|define
name|LITERAL_NOENTROPY
value|63
block|{
name|size_t
specifier|const
name|minLitSize
init|=
name|entropy
operator|->
name|hufCTable_repeatMode
operator|==
name|HUF_repeat_valid
condition|?
literal|6
else|:
name|LITERAL_NOENTROPY
decl_stmt|;
if|if
condition|(
name|srcSize
operator|<=
name|minLitSize
condition|)
return|return
name|ZSTD_noCompressLiterals
argument_list|(
name|dst
argument_list|,
name|dstCapacity
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|)
return|;
block|}
if|if
condition|(
name|dstCapacity
operator|<
name|lhSize
operator|+
literal|1
condition|)
return|return
name|ERROR
argument_list|(
name|dstSize_tooSmall
argument_list|)
return|;
comment|/* not enough space for compression */
block|{
name|HUF_repeat
name|repeat
init|=
name|entropy
operator|->
name|hufCTable_repeatMode
decl_stmt|;
name|int
specifier|const
name|preferRepeat
init|=
name|strategy
operator|<
name|ZSTD_lazy
condition|?
name|srcSize
operator|<=
literal|1024
else|:
literal|0
decl_stmt|;
if|if
condition|(
name|repeat
operator|==
name|HUF_repeat_valid
operator|&&
name|lhSize
operator|==
literal|3
condition|)
name|singleStream
operator|=
literal|1
expr_stmt|;
name|cLitSize
operator|=
name|singleStream
condition|?
name|HUF_compress1X_repeat
argument_list|(
name|ostart
operator|+
name|lhSize
argument_list|,
name|dstCapacity
operator|-
name|lhSize
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|,
literal|255
argument_list|,
literal|11
argument_list|,
name|entropy
operator|->
name|workspace
argument_list|,
sizeof|sizeof
argument_list|(
name|entropy
operator|->
name|workspace
argument_list|)
argument_list|,
operator|(
name|HUF_CElt
operator|*
operator|)
name|entropy
operator|->
name|hufCTable
argument_list|,
operator|&
name|repeat
argument_list|,
name|preferRepeat
argument_list|)
else|:
name|HUF_compress4X_repeat
argument_list|(
name|ostart
operator|+
name|lhSize
argument_list|,
name|dstCapacity
operator|-
name|lhSize
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|,
literal|255
argument_list|,
literal|11
argument_list|,
name|entropy
operator|->
name|workspace
argument_list|,
sizeof|sizeof
argument_list|(
name|entropy
operator|->
name|workspace
argument_list|)
argument_list|,
operator|(
name|HUF_CElt
operator|*
operator|)
name|entropy
operator|->
name|hufCTable
argument_list|,
operator|&
name|repeat
argument_list|,
name|preferRepeat
argument_list|)
expr_stmt|;
if|if
condition|(
name|repeat
operator|!=
name|HUF_repeat_none
condition|)
block|{
name|hType
operator|=
name|set_repeat
expr_stmt|;
block|}
comment|/* reused the existing table */
else|else
block|{
name|entropy
operator|->
name|hufCTable_repeatMode
operator|=
name|HUF_repeat_check
expr_stmt|;
block|}
comment|/* now have a table to reuse */
block|}
if|if
condition|(
operator|(
name|cLitSize
operator|==
literal|0
operator|)
operator||
operator|(
name|cLitSize
operator|>=
name|srcSize
operator|-
name|minGain
operator|)
operator||
name|ERR_isError
argument_list|(
name|cLitSize
argument_list|)
condition|)
block|{
name|entropy
operator|->
name|hufCTable_repeatMode
operator|=
name|HUF_repeat_none
expr_stmt|;
return|return
name|ZSTD_noCompressLiterals
argument_list|(
name|dst
argument_list|,
name|dstCapacity
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|)
return|;
block|}
if|if
condition|(
name|cLitSize
operator|==
literal|1
condition|)
block|{
name|entropy
operator|->
name|hufCTable_repeatMode
operator|=
name|HUF_repeat_none
expr_stmt|;
return|return
name|ZSTD_compressRleLiteralsBlock
argument_list|(
name|dst
argument_list|,
name|dstCapacity
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|)
return|;
block|}
comment|/* Build header */
switch|switch
condition|(
name|lhSize
condition|)
block|{
case|case
literal|3
case|:
comment|/* 2 - 2 - 10 - 10 */
block|{
name|U32
specifier|const
name|lhc
init|=
name|hType
operator|+
operator|(
operator|(
operator|!
name|singleStream
operator|)
operator|<<
literal|2
operator|)
operator|+
operator|(
operator|(
name|U32
operator|)
name|srcSize
operator|<<
literal|4
operator|)
operator|+
operator|(
operator|(
name|U32
operator|)
name|cLitSize
operator|<<
literal|14
operator|)
decl_stmt|;
name|MEM_writeLE24
argument_list|(
name|ostart
argument_list|,
name|lhc
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|4
case|:
comment|/* 2 - 2 - 14 - 14 */
block|{
name|U32
specifier|const
name|lhc
init|=
name|hType
operator|+
operator|(
literal|2
operator|<<
literal|2
operator|)
operator|+
operator|(
operator|(
name|U32
operator|)
name|srcSize
operator|<<
literal|4
operator|)
operator|+
operator|(
operator|(
name|U32
operator|)
name|cLitSize
operator|<<
literal|18
operator|)
decl_stmt|;
name|MEM_writeLE32
argument_list|(
name|ostart
argument_list|,
name|lhc
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
literal|5
case|:
comment|/* 2 - 2 - 18 - 18 */
block|{
name|U32
specifier|const
name|lhc
init|=
name|hType
operator|+
operator|(
literal|3
operator|<<
literal|2
operator|)
operator|+
operator|(
operator|(
name|U32
operator|)
name|srcSize
operator|<<
literal|4
operator|)
operator|+
operator|(
operator|(
name|U32
operator|)
name|cLitSize
operator|<<
literal|22
operator|)
decl_stmt|;
name|MEM_writeLE32
argument_list|(
name|ostart
argument_list|,
name|lhc
argument_list|)
expr_stmt|;
name|ostart
index|[
literal|4
index|]
operator|=
call|(
name|BYTE
call|)
argument_list|(
name|cLitSize
operator|>>
literal|10
argument_list|)
expr_stmt|;
break|break;
block|}
default|default:
comment|/* not possible : lhSize is {3,4,5} */
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
return|return
name|lhSize
operator|+
name|cLitSize
return|;
block|}
end_function

begin_function
name|void
name|ZSTD_seqToCodes
parameter_list|(
specifier|const
name|seqStore_t
modifier|*
name|seqStorePtr
parameter_list|)
block|{
name|BYTE
specifier|const
name|LL_deltaCode
init|=
literal|19
decl_stmt|;
name|BYTE
specifier|const
name|ML_deltaCode
init|=
literal|36
decl_stmt|;
specifier|const
name|seqDef
modifier|*
specifier|const
name|sequences
init|=
name|seqStorePtr
operator|->
name|sequencesStart
decl_stmt|;
name|BYTE
modifier|*
specifier|const
name|llCodeTable
init|=
name|seqStorePtr
operator|->
name|llCode
decl_stmt|;
name|BYTE
modifier|*
specifier|const
name|ofCodeTable
init|=
name|seqStorePtr
operator|->
name|ofCode
decl_stmt|;
name|BYTE
modifier|*
specifier|const
name|mlCodeTable
init|=
name|seqStorePtr
operator|->
name|mlCode
decl_stmt|;
name|U32
specifier|const
name|nbSeq
init|=
call|(
name|U32
call|)
argument_list|(
name|seqStorePtr
operator|->
name|sequences
operator|-
name|seqStorePtr
operator|->
name|sequencesStart
argument_list|)
decl_stmt|;
name|U32
name|u
decl_stmt|;
for|for
control|(
name|u
operator|=
literal|0
init|;
name|u
operator|<
name|nbSeq
condition|;
name|u
operator|++
control|)
block|{
name|U32
specifier|const
name|llv
init|=
name|sequences
index|[
name|u
index|]
operator|.
name|litLength
decl_stmt|;
name|U32
specifier|const
name|mlv
init|=
name|sequences
index|[
name|u
index|]
operator|.
name|matchLength
decl_stmt|;
name|llCodeTable
index|[
name|u
index|]
operator|=
operator|(
name|llv
operator|>
literal|63
operator|)
condition|?
operator|(
name|BYTE
operator|)
name|ZSTD_highbit32
argument_list|(
name|llv
argument_list|)
operator|+
name|LL_deltaCode
else|:
name|LL_Code
index|[
name|llv
index|]
expr_stmt|;
name|ofCodeTable
index|[
name|u
index|]
operator|=
operator|(
name|BYTE
operator|)
name|ZSTD_highbit32
argument_list|(
name|sequences
index|[
name|u
index|]
operator|.
name|offset
argument_list|)
expr_stmt|;
name|mlCodeTable
index|[
name|u
index|]
operator|=
operator|(
name|mlv
operator|>
literal|127
operator|)
condition|?
operator|(
name|BYTE
operator|)
name|ZSTD_highbit32
argument_list|(
name|mlv
argument_list|)
operator|+
name|ML_deltaCode
else|:
name|ML_Code
index|[
name|mlv
index|]
expr_stmt|;
block|}
if|if
condition|(
name|seqStorePtr
operator|->
name|longLengthID
operator|==
literal|1
condition|)
name|llCodeTable
index|[
name|seqStorePtr
operator|->
name|longLengthPos
index|]
operator|=
name|MaxLL
expr_stmt|;
if|if
condition|(
name|seqStorePtr
operator|->
name|longLengthID
operator|==
literal|2
condition|)
name|mlCodeTable
index|[
name|seqStorePtr
operator|->
name|longLengthPos
index|]
operator|=
name|MaxML
expr_stmt|;
block|}
end_function

begin_typedef
typedef|typedef
enum|enum
block|{
name|ZSTD_defaultDisallowed
init|=
literal|0
block|,
name|ZSTD_defaultAllowed
init|=
literal|1
block|}
name|ZSTD_defaultPolicy_e
typedef|;
end_typedef

begin_function
name|MEM_STATIC
name|symbolEncodingType_e
name|ZSTD_selectEncodingType
parameter_list|(
name|FSE_repeat
modifier|*
name|repeatMode
parameter_list|,
name|size_t
specifier|const
name|mostFrequent
parameter_list|,
name|size_t
name|nbSeq
parameter_list|,
name|U32
name|defaultNormLog
parameter_list|,
name|ZSTD_defaultPolicy_e
specifier|const
name|isDefaultAllowed
parameter_list|)
block|{
define|#
directive|define
name|MIN_SEQ_FOR_DYNAMIC_FSE
value|64
define|#
directive|define
name|MAX_SEQ_FOR_STATIC_FSE
value|1000
name|ZSTD_STATIC_ASSERT
argument_list|(
name|ZSTD_defaultDisallowed
operator|==
literal|0
operator|&&
name|ZSTD_defaultAllowed
operator|!=
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|mostFrequent
operator|==
name|nbSeq
operator|)
operator|&&
operator|(
operator|!
name|isDefaultAllowed
operator|||
name|nbSeq
operator|>
literal|2
operator|)
condition|)
block|{
comment|/* Prefer set_basic over set_rle when there are 2 or less symbols,          * since RLE uses 1 byte, but set_basic uses 5-6 bits per symbol.          * If basic encoding isn't possible, always choose RLE.          */
operator|*
name|repeatMode
operator|=
name|FSE_repeat_check
expr_stmt|;
return|return
name|set_rle
return|;
block|}
if|if
condition|(
name|isDefaultAllowed
operator|&&
operator|(
operator|*
name|repeatMode
operator|==
name|FSE_repeat_valid
operator|)
operator|&&
operator|(
name|nbSeq
operator|<
name|MAX_SEQ_FOR_STATIC_FSE
operator|)
condition|)
block|{
return|return
name|set_repeat
return|;
block|}
if|if
condition|(
name|isDefaultAllowed
operator|&&
operator|(
operator|(
name|nbSeq
operator|<
name|MIN_SEQ_FOR_DYNAMIC_FSE
operator|)
operator|||
operator|(
name|mostFrequent
operator|<
operator|(
name|nbSeq
operator|>>
operator|(
name|defaultNormLog
operator|-
literal|1
operator|)
operator|)
operator|)
operator|)
condition|)
block|{
operator|*
name|repeatMode
operator|=
name|FSE_repeat_valid
expr_stmt|;
return|return
name|set_basic
return|;
block|}
operator|*
name|repeatMode
operator|=
name|FSE_repeat_check
expr_stmt|;
return|return
name|set_compressed
return|;
block|}
end_function

begin_function
name|MEM_STATIC
name|size_t
name|ZSTD_buildCTable
parameter_list|(
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstCapacity
parameter_list|,
name|FSE_CTable
modifier|*
name|CTable
parameter_list|,
name|U32
name|FSELog
parameter_list|,
name|symbolEncodingType_e
name|type
parameter_list|,
name|U32
modifier|*
name|count
parameter_list|,
name|U32
name|max
parameter_list|,
name|BYTE
specifier|const
modifier|*
name|codeTable
parameter_list|,
name|size_t
name|nbSeq
parameter_list|,
name|S16
specifier|const
modifier|*
name|defaultNorm
parameter_list|,
name|U32
name|defaultNormLog
parameter_list|,
name|U32
name|defaultMax
parameter_list|,
name|void
modifier|*
name|workspace
parameter_list|,
name|size_t
name|workspaceSize
parameter_list|)
block|{
name|BYTE
modifier|*
name|op
init|=
operator|(
name|BYTE
operator|*
operator|)
name|dst
decl_stmt|;
name|BYTE
specifier|const
modifier|*
specifier|const
name|oend
init|=
name|op
operator|+
name|dstCapacity
decl_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|set_rle
case|:
operator|*
name|op
operator|=
name|codeTable
index|[
literal|0
index|]
expr_stmt|;
name|CHECK_F
argument_list|(
name|FSE_buildCTable_rle
argument_list|(
name|CTable
argument_list|,
operator|(
name|BYTE
operator|)
name|max
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
case|case
name|set_repeat
case|:
return|return
literal|0
return|;
case|case
name|set_basic
case|:
name|CHECK_F
argument_list|(
name|FSE_buildCTable_wksp
argument_list|(
name|CTable
argument_list|,
name|defaultNorm
argument_list|,
name|defaultMax
argument_list|,
name|defaultNormLog
argument_list|,
name|workspace
argument_list|,
name|workspaceSize
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|set_compressed
case|:
block|{
name|S16
name|norm
index|[
name|MaxSeq
operator|+
literal|1
index|]
decl_stmt|;
name|size_t
name|nbSeq_1
init|=
name|nbSeq
decl_stmt|;
specifier|const
name|U32
name|tableLog
init|=
name|FSE_optimalTableLog
argument_list|(
name|FSELog
argument_list|,
name|nbSeq
argument_list|,
name|max
argument_list|)
decl_stmt|;
if|if
condition|(
name|count
index|[
name|codeTable
index|[
name|nbSeq
operator|-
literal|1
index|]
index|]
operator|>
literal|1
condition|)
block|{
name|count
index|[
name|codeTable
index|[
name|nbSeq
operator|-
literal|1
index|]
index|]
operator|--
expr_stmt|;
name|nbSeq_1
operator|--
expr_stmt|;
block|}
name|assert
argument_list|(
name|nbSeq_1
operator|>
literal|1
argument_list|)
expr_stmt|;
name|CHECK_F
argument_list|(
name|FSE_normalizeCount
argument_list|(
name|norm
argument_list|,
name|tableLog
argument_list|,
name|count
argument_list|,
name|nbSeq_1
argument_list|,
name|max
argument_list|)
argument_list|)
expr_stmt|;
block|{
name|size_t
specifier|const
name|NCountSize
init|=
name|FSE_writeNCount
argument_list|(
name|op
argument_list|,
name|oend
operator|-
name|op
argument_list|,
name|norm
argument_list|,
name|max
argument_list|,
name|tableLog
argument_list|)
decl_stmt|;
comment|/* overflow protected */
if|if
condition|(
name|FSE_isError
argument_list|(
name|NCountSize
argument_list|)
condition|)
return|return
name|NCountSize
return|;
name|CHECK_F
argument_list|(
name|FSE_buildCTable_wksp
argument_list|(
name|CTable
argument_list|,
name|norm
argument_list|,
name|max
argument_list|,
name|tableLog
argument_list|,
name|workspace
argument_list|,
name|workspaceSize
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NCountSize
return|;
block|}
block|}
default|default:
return|return
name|assert
argument_list|(
literal|0
argument_list|)
operator|,
name|ERROR
argument_list|(
name|GENERIC
argument_list|)
return|;
block|}
block|}
end_function

begin_function
name|MEM_STATIC
name|size_t
name|ZSTD_encodeSequences
parameter_list|(
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstCapacity
parameter_list|,
name|FSE_CTable
specifier|const
modifier|*
name|CTable_MatchLength
parameter_list|,
name|BYTE
specifier|const
modifier|*
name|mlCodeTable
parameter_list|,
name|FSE_CTable
specifier|const
modifier|*
name|CTable_OffsetBits
parameter_list|,
name|BYTE
specifier|const
modifier|*
name|ofCodeTable
parameter_list|,
name|FSE_CTable
specifier|const
modifier|*
name|CTable_LitLength
parameter_list|,
name|BYTE
specifier|const
modifier|*
name|llCodeTable
parameter_list|,
name|seqDef
specifier|const
modifier|*
name|sequences
parameter_list|,
name|size_t
name|nbSeq
parameter_list|,
name|int
name|longOffsets
parameter_list|)
block|{
name|BIT_CStream_t
name|blockStream
decl_stmt|;
name|FSE_CState_t
name|stateMatchLength
decl_stmt|;
name|FSE_CState_t
name|stateOffsetBits
decl_stmt|;
name|FSE_CState_t
name|stateLitLength
decl_stmt|;
name|CHECK_E
argument_list|(
name|BIT_initCStream
argument_list|(
operator|&
name|blockStream
argument_list|,
name|dst
argument_list|,
name|dstCapacity
argument_list|)
argument_list|,
name|dstSize_tooSmall
argument_list|)
expr_stmt|;
comment|/* not enough space remaining */
comment|/* first symbols */
name|FSE_initCState2
argument_list|(
operator|&
name|stateMatchLength
argument_list|,
name|CTable_MatchLength
argument_list|,
name|mlCodeTable
index|[
name|nbSeq
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|FSE_initCState2
argument_list|(
operator|&
name|stateOffsetBits
argument_list|,
name|CTable_OffsetBits
argument_list|,
name|ofCodeTable
index|[
name|nbSeq
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|FSE_initCState2
argument_list|(
operator|&
name|stateLitLength
argument_list|,
name|CTable_LitLength
argument_list|,
name|llCodeTable
index|[
name|nbSeq
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|BIT_addBits
argument_list|(
operator|&
name|blockStream
argument_list|,
name|sequences
index|[
name|nbSeq
operator|-
literal|1
index|]
operator|.
name|litLength
argument_list|,
name|LL_bits
index|[
name|llCodeTable
index|[
name|nbSeq
operator|-
literal|1
index|]
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|MEM_32bits
argument_list|()
condition|)
name|BIT_flushBits
argument_list|(
operator|&
name|blockStream
argument_list|)
expr_stmt|;
name|BIT_addBits
argument_list|(
operator|&
name|blockStream
argument_list|,
name|sequences
index|[
name|nbSeq
operator|-
literal|1
index|]
operator|.
name|matchLength
argument_list|,
name|ML_bits
index|[
name|mlCodeTable
index|[
name|nbSeq
operator|-
literal|1
index|]
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|MEM_32bits
argument_list|()
condition|)
name|BIT_flushBits
argument_list|(
operator|&
name|blockStream
argument_list|)
expr_stmt|;
if|if
condition|(
name|longOffsets
condition|)
block|{
name|U32
specifier|const
name|ofBits
init|=
name|ofCodeTable
index|[
name|nbSeq
operator|-
literal|1
index|]
decl_stmt|;
name|int
specifier|const
name|extraBits
init|=
name|ofBits
operator|-
name|MIN
argument_list|(
name|ofBits
argument_list|,
name|STREAM_ACCUMULATOR_MIN
operator|-
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
name|extraBits
condition|)
block|{
name|BIT_addBits
argument_list|(
operator|&
name|blockStream
argument_list|,
name|sequences
index|[
name|nbSeq
operator|-
literal|1
index|]
operator|.
name|offset
argument_list|,
name|extraBits
argument_list|)
expr_stmt|;
name|BIT_flushBits
argument_list|(
operator|&
name|blockStream
argument_list|)
expr_stmt|;
block|}
name|BIT_addBits
argument_list|(
operator|&
name|blockStream
argument_list|,
name|sequences
index|[
name|nbSeq
operator|-
literal|1
index|]
operator|.
name|offset
operator|>>
name|extraBits
argument_list|,
name|ofBits
operator|-
name|extraBits
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BIT_addBits
argument_list|(
operator|&
name|blockStream
argument_list|,
name|sequences
index|[
name|nbSeq
operator|-
literal|1
index|]
operator|.
name|offset
argument_list|,
name|ofCodeTable
index|[
name|nbSeq
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
name|BIT_flushBits
argument_list|(
operator|&
name|blockStream
argument_list|)
expr_stmt|;
block|{
name|size_t
name|n
decl_stmt|;
for|for
control|(
name|n
operator|=
name|nbSeq
operator|-
literal|2
init|;
name|n
operator|<
name|nbSeq
condition|;
name|n
operator|--
control|)
block|{
comment|/* intentional underflow */
name|BYTE
specifier|const
name|llCode
init|=
name|llCodeTable
index|[
name|n
index|]
decl_stmt|;
name|BYTE
specifier|const
name|ofCode
init|=
name|ofCodeTable
index|[
name|n
index|]
decl_stmt|;
name|BYTE
specifier|const
name|mlCode
init|=
name|mlCodeTable
index|[
name|n
index|]
decl_stmt|;
name|U32
specifier|const
name|llBits
init|=
name|LL_bits
index|[
name|llCode
index|]
decl_stmt|;
name|U32
specifier|const
name|ofBits
init|=
name|ofCode
decl_stmt|;
comment|/* 32b*/
comment|/* 64b*/
name|U32
specifier|const
name|mlBits
init|=
name|ML_bits
index|[
name|mlCode
index|]
decl_stmt|;
comment|/* (7)*/
comment|/* (7)*/
name|FSE_encodeSymbol
argument_list|(
operator|&
name|blockStream
argument_list|,
operator|&
name|stateOffsetBits
argument_list|,
name|ofCode
argument_list|)
expr_stmt|;
comment|/* 15 */
comment|/* 15 */
name|FSE_encodeSymbol
argument_list|(
operator|&
name|blockStream
argument_list|,
operator|&
name|stateMatchLength
argument_list|,
name|mlCode
argument_list|)
expr_stmt|;
comment|/* 24 */
comment|/* 24 */
if|if
condition|(
name|MEM_32bits
argument_list|()
condition|)
name|BIT_flushBits
argument_list|(
operator|&
name|blockStream
argument_list|)
expr_stmt|;
comment|/* (7)*/
name|FSE_encodeSymbol
argument_list|(
operator|&
name|blockStream
argument_list|,
operator|&
name|stateLitLength
argument_list|,
name|llCode
argument_list|)
expr_stmt|;
comment|/* 16 */
comment|/* 33 */
if|if
condition|(
name|MEM_32bits
argument_list|()
operator|||
operator|(
name|ofBits
operator|+
name|mlBits
operator|+
name|llBits
operator|>=
literal|64
operator|-
literal|7
operator|-
operator|(
name|LLFSELog
operator|+
name|MLFSELog
operator|+
name|OffFSELog
operator|)
operator|)
condition|)
name|BIT_flushBits
argument_list|(
operator|&
name|blockStream
argument_list|)
expr_stmt|;
comment|/* (7)*/
name|BIT_addBits
argument_list|(
operator|&
name|blockStream
argument_list|,
name|sequences
index|[
name|n
index|]
operator|.
name|litLength
argument_list|,
name|llBits
argument_list|)
expr_stmt|;
if|if
condition|(
name|MEM_32bits
argument_list|()
operator|&&
operator|(
operator|(
name|llBits
operator|+
name|mlBits
operator|)
operator|>
literal|24
operator|)
condition|)
name|BIT_flushBits
argument_list|(
operator|&
name|blockStream
argument_list|)
expr_stmt|;
name|BIT_addBits
argument_list|(
operator|&
name|blockStream
argument_list|,
name|sequences
index|[
name|n
index|]
operator|.
name|matchLength
argument_list|,
name|mlBits
argument_list|)
expr_stmt|;
if|if
condition|(
name|MEM_32bits
argument_list|()
operator|||
operator|(
name|ofBits
operator|+
name|mlBits
operator|+
name|llBits
operator|>
literal|56
operator|)
condition|)
name|BIT_flushBits
argument_list|(
operator|&
name|blockStream
argument_list|)
expr_stmt|;
if|if
condition|(
name|longOffsets
condition|)
block|{
name|int
specifier|const
name|extraBits
init|=
name|ofBits
operator|-
name|MIN
argument_list|(
name|ofBits
argument_list|,
name|STREAM_ACCUMULATOR_MIN
operator|-
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
name|extraBits
condition|)
block|{
name|BIT_addBits
argument_list|(
operator|&
name|blockStream
argument_list|,
name|sequences
index|[
name|n
index|]
operator|.
name|offset
argument_list|,
name|extraBits
argument_list|)
expr_stmt|;
name|BIT_flushBits
argument_list|(
operator|&
name|blockStream
argument_list|)
expr_stmt|;
comment|/* (7)*/
block|}
name|BIT_addBits
argument_list|(
operator|&
name|blockStream
argument_list|,
name|sequences
index|[
name|n
index|]
operator|.
name|offset
operator|>>
name|extraBits
argument_list|,
name|ofBits
operator|-
name|extraBits
argument_list|)
expr_stmt|;
comment|/* 31 */
block|}
else|else
block|{
name|BIT_addBits
argument_list|(
operator|&
name|blockStream
argument_list|,
name|sequences
index|[
name|n
index|]
operator|.
name|offset
argument_list|,
name|ofBits
argument_list|)
expr_stmt|;
comment|/* 31 */
block|}
name|BIT_flushBits
argument_list|(
operator|&
name|blockStream
argument_list|)
expr_stmt|;
comment|/* (7)*/
block|}
block|}
name|FSE_flushCState
argument_list|(
operator|&
name|blockStream
argument_list|,
operator|&
name|stateMatchLength
argument_list|)
expr_stmt|;
name|FSE_flushCState
argument_list|(
operator|&
name|blockStream
argument_list|,
operator|&
name|stateOffsetBits
argument_list|)
expr_stmt|;
name|FSE_flushCState
argument_list|(
operator|&
name|blockStream
argument_list|,
operator|&
name|stateLitLength
argument_list|)
expr_stmt|;
block|{
name|size_t
specifier|const
name|streamSize
init|=
name|BIT_closeCStream
argument_list|(
operator|&
name|blockStream
argument_list|)
decl_stmt|;
if|if
condition|(
name|streamSize
operator|==
literal|0
condition|)
return|return
name|ERROR
argument_list|(
name|dstSize_tooSmall
argument_list|)
return|;
comment|/* not enough space */
return|return
name|streamSize
return|;
block|}
block|}
end_function

begin_function
name|MEM_STATIC
name|size_t
name|ZSTD_compressSequences_internal
parameter_list|(
name|seqStore_t
modifier|*
name|seqStorePtr
parameter_list|,
name|ZSTD_entropyCTables_t
modifier|*
name|entropy
parameter_list|,
name|ZSTD_compressionParameters
specifier|const
modifier|*
name|cParams
parameter_list|,
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstCapacity
parameter_list|)
block|{
specifier|const
name|int
name|longOffsets
init|=
name|cParams
operator|->
name|windowLog
operator|>
name|STREAM_ACCUMULATOR_MIN
decl_stmt|;
name|U32
name|count
index|[
name|MaxSeq
operator|+
literal|1
index|]
decl_stmt|;
name|FSE_CTable
modifier|*
name|CTable_LitLength
init|=
name|entropy
operator|->
name|litlengthCTable
decl_stmt|;
name|FSE_CTable
modifier|*
name|CTable_OffsetBits
init|=
name|entropy
operator|->
name|offcodeCTable
decl_stmt|;
name|FSE_CTable
modifier|*
name|CTable_MatchLength
init|=
name|entropy
operator|->
name|matchlengthCTable
decl_stmt|;
name|U32
name|LLtype
decl_stmt|,
name|Offtype
decl_stmt|,
name|MLtype
decl_stmt|;
comment|/* compressed, raw or rle */
specifier|const
name|seqDef
modifier|*
specifier|const
name|sequences
init|=
name|seqStorePtr
operator|->
name|sequencesStart
decl_stmt|;
specifier|const
name|BYTE
modifier|*
specifier|const
name|ofCodeTable
init|=
name|seqStorePtr
operator|->
name|ofCode
decl_stmt|;
specifier|const
name|BYTE
modifier|*
specifier|const
name|llCodeTable
init|=
name|seqStorePtr
operator|->
name|llCode
decl_stmt|;
specifier|const
name|BYTE
modifier|*
specifier|const
name|mlCodeTable
init|=
name|seqStorePtr
operator|->
name|mlCode
decl_stmt|;
name|BYTE
modifier|*
specifier|const
name|ostart
init|=
operator|(
name|BYTE
operator|*
operator|)
name|dst
decl_stmt|;
name|BYTE
modifier|*
specifier|const
name|oend
init|=
name|ostart
operator|+
name|dstCapacity
decl_stmt|;
name|BYTE
modifier|*
name|op
init|=
name|ostart
decl_stmt|;
name|size_t
specifier|const
name|nbSeq
init|=
name|seqStorePtr
operator|->
name|sequences
operator|-
name|seqStorePtr
operator|->
name|sequencesStart
decl_stmt|;
name|BYTE
modifier|*
name|seqHead
decl_stmt|;
name|ZSTD_STATIC_ASSERT
argument_list|(
sizeof|sizeof
argument_list|(
name|entropy
operator|->
name|workspace
argument_list|)
operator|>=
operator|(
literal|1
operator|<<
name|MAX
argument_list|(
name|MLFSELog
argument_list|,
name|LLFSELog
argument_list|)
operator|)
argument_list|)
expr_stmt|;
comment|/* Compress literals */
block|{
specifier|const
name|BYTE
modifier|*
specifier|const
name|literals
init|=
name|seqStorePtr
operator|->
name|litStart
decl_stmt|;
name|size_t
specifier|const
name|litSize
init|=
name|seqStorePtr
operator|->
name|lit
operator|-
name|literals
decl_stmt|;
name|size_t
specifier|const
name|cSize
init|=
name|ZSTD_compressLiterals
argument_list|(
name|entropy
argument_list|,
name|cParams
operator|->
name|strategy
argument_list|,
name|op
argument_list|,
name|dstCapacity
argument_list|,
name|literals
argument_list|,
name|litSize
argument_list|)
decl_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|cSize
argument_list|)
condition|)
return|return
name|cSize
return|;
name|op
operator|+=
name|cSize
expr_stmt|;
block|}
comment|/* Sequences Header */
if|if
condition|(
operator|(
name|oend
operator|-
name|op
operator|)
operator|<
literal|3
comment|/*max nbSeq Size*/
operator|+
literal|1
comment|/*seqHead */
condition|)
return|return
name|ERROR
argument_list|(
name|dstSize_tooSmall
argument_list|)
return|;
if|if
condition|(
name|nbSeq
operator|<
literal|0x7F
condition|)
operator|*
name|op
operator|++
operator|=
operator|(
name|BYTE
operator|)
name|nbSeq
expr_stmt|;
elseif|else
if|if
condition|(
name|nbSeq
operator|<
name|LONGNBSEQ
condition|)
name|op
index|[
literal|0
index|]
operator|=
call|(
name|BYTE
call|)
argument_list|(
operator|(
name|nbSeq
operator|>>
literal|8
operator|)
operator|+
literal|0x80
argument_list|)
operator|,
name|op
index|[
literal|1
index|]
operator|=
operator|(
name|BYTE
operator|)
name|nbSeq
operator|,
name|op
operator|+=
literal|2
expr_stmt|;
else|else
name|op
index|[
literal|0
index|]
operator|=
literal|0xFF
operator|,
name|MEM_writeLE16
argument_list|(
name|op
operator|+
literal|1
argument_list|,
call|(
name|U16
call|)
argument_list|(
name|nbSeq
operator|-
name|LONGNBSEQ
argument_list|)
argument_list|)
operator|,
name|op
operator|+=
literal|3
expr_stmt|;
if|if
condition|(
name|nbSeq
operator|==
literal|0
condition|)
return|return
name|op
operator|-
name|ostart
return|;
comment|/* seqHead : flags for FSE encoding type */
name|seqHead
operator|=
name|op
operator|++
expr_stmt|;
comment|/* convert length/distances into codes */
name|ZSTD_seqToCodes
argument_list|(
name|seqStorePtr
argument_list|)
expr_stmt|;
comment|/* CTable for Literal Lengths */
block|{
name|U32
name|max
init|=
name|MaxLL
decl_stmt|;
name|size_t
specifier|const
name|mostFrequent
init|=
name|FSE_countFast_wksp
argument_list|(
name|count
argument_list|,
operator|&
name|max
argument_list|,
name|llCodeTable
argument_list|,
name|nbSeq
argument_list|,
name|entropy
operator|->
name|workspace
argument_list|)
decl_stmt|;
name|LLtype
operator|=
name|ZSTD_selectEncodingType
argument_list|(
operator|&
name|entropy
operator|->
name|litlength_repeatMode
argument_list|,
name|mostFrequent
argument_list|,
name|nbSeq
argument_list|,
name|LL_defaultNormLog
argument_list|,
name|ZSTD_defaultAllowed
argument_list|)
expr_stmt|;
block|{
name|size_t
specifier|const
name|countSize
init|=
name|ZSTD_buildCTable
argument_list|(
name|op
argument_list|,
name|oend
operator|-
name|op
argument_list|,
name|CTable_LitLength
argument_list|,
name|LLFSELog
argument_list|,
operator|(
name|symbolEncodingType_e
operator|)
name|LLtype
argument_list|,
name|count
argument_list|,
name|max
argument_list|,
name|llCodeTable
argument_list|,
name|nbSeq
argument_list|,
name|LL_defaultNorm
argument_list|,
name|LL_defaultNormLog
argument_list|,
name|MaxLL
argument_list|,
name|entropy
operator|->
name|workspace
argument_list|,
sizeof|sizeof
argument_list|(
name|entropy
operator|->
name|workspace
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|countSize
argument_list|)
condition|)
return|return
name|countSize
return|;
name|op
operator|+=
name|countSize
expr_stmt|;
block|}
block|}
comment|/* CTable for Offsets */
block|{
name|U32
name|max
init|=
name|MaxOff
decl_stmt|;
name|size_t
specifier|const
name|mostFrequent
init|=
name|FSE_countFast_wksp
argument_list|(
name|count
argument_list|,
operator|&
name|max
argument_list|,
name|ofCodeTable
argument_list|,
name|nbSeq
argument_list|,
name|entropy
operator|->
name|workspace
argument_list|)
decl_stmt|;
comment|/* We can only use the basic table if max<= DefaultMaxOff, otherwise the offsets are too large */
name|ZSTD_defaultPolicy_e
specifier|const
name|defaultPolicy
init|=
name|max
operator|<=
name|DefaultMaxOff
condition|?
name|ZSTD_defaultAllowed
else|:
name|ZSTD_defaultDisallowed
decl_stmt|;
name|Offtype
operator|=
name|ZSTD_selectEncodingType
argument_list|(
operator|&
name|entropy
operator|->
name|offcode_repeatMode
argument_list|,
name|mostFrequent
argument_list|,
name|nbSeq
argument_list|,
name|OF_defaultNormLog
argument_list|,
name|defaultPolicy
argument_list|)
expr_stmt|;
block|{
name|size_t
specifier|const
name|countSize
init|=
name|ZSTD_buildCTable
argument_list|(
name|op
argument_list|,
name|oend
operator|-
name|op
argument_list|,
name|CTable_OffsetBits
argument_list|,
name|OffFSELog
argument_list|,
operator|(
name|symbolEncodingType_e
operator|)
name|Offtype
argument_list|,
name|count
argument_list|,
name|max
argument_list|,
name|ofCodeTable
argument_list|,
name|nbSeq
argument_list|,
name|OF_defaultNorm
argument_list|,
name|OF_defaultNormLog
argument_list|,
name|DefaultMaxOff
argument_list|,
name|entropy
operator|->
name|workspace
argument_list|,
sizeof|sizeof
argument_list|(
name|entropy
operator|->
name|workspace
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|countSize
argument_list|)
condition|)
return|return
name|countSize
return|;
name|op
operator|+=
name|countSize
expr_stmt|;
block|}
block|}
comment|/* CTable for MatchLengths */
block|{
name|U32
name|max
init|=
name|MaxML
decl_stmt|;
name|size_t
specifier|const
name|mostFrequent
init|=
name|FSE_countFast_wksp
argument_list|(
name|count
argument_list|,
operator|&
name|max
argument_list|,
name|mlCodeTable
argument_list|,
name|nbSeq
argument_list|,
name|entropy
operator|->
name|workspace
argument_list|)
decl_stmt|;
name|MLtype
operator|=
name|ZSTD_selectEncodingType
argument_list|(
operator|&
name|entropy
operator|->
name|matchlength_repeatMode
argument_list|,
name|mostFrequent
argument_list|,
name|nbSeq
argument_list|,
name|ML_defaultNormLog
argument_list|,
name|ZSTD_defaultAllowed
argument_list|)
expr_stmt|;
block|{
name|size_t
specifier|const
name|countSize
init|=
name|ZSTD_buildCTable
argument_list|(
name|op
argument_list|,
name|oend
operator|-
name|op
argument_list|,
name|CTable_MatchLength
argument_list|,
name|MLFSELog
argument_list|,
operator|(
name|symbolEncodingType_e
operator|)
name|MLtype
argument_list|,
name|count
argument_list|,
name|max
argument_list|,
name|mlCodeTable
argument_list|,
name|nbSeq
argument_list|,
name|ML_defaultNorm
argument_list|,
name|ML_defaultNormLog
argument_list|,
name|MaxML
argument_list|,
name|entropy
operator|->
name|workspace
argument_list|,
sizeof|sizeof
argument_list|(
name|entropy
operator|->
name|workspace
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|countSize
argument_list|)
condition|)
return|return
name|countSize
return|;
name|op
operator|+=
name|countSize
expr_stmt|;
block|}
block|}
operator|*
name|seqHead
operator|=
call|(
name|BYTE
call|)
argument_list|(
operator|(
name|LLtype
operator|<<
literal|6
operator|)
operator|+
operator|(
name|Offtype
operator|<<
literal|4
operator|)
operator|+
operator|(
name|MLtype
operator|<<
literal|2
operator|)
argument_list|)
expr_stmt|;
block|{
name|size_t
specifier|const
name|streamSize
init|=
name|ZSTD_encodeSequences
argument_list|(
name|op
argument_list|,
name|oend
operator|-
name|op
argument_list|,
name|CTable_MatchLength
argument_list|,
name|mlCodeTable
argument_list|,
name|CTable_OffsetBits
argument_list|,
name|ofCodeTable
argument_list|,
name|CTable_LitLength
argument_list|,
name|llCodeTable
argument_list|,
name|sequences
argument_list|,
name|nbSeq
argument_list|,
name|longOffsets
argument_list|)
decl_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|streamSize
argument_list|)
condition|)
return|return
name|streamSize
return|;
name|op
operator|+=
name|streamSize
expr_stmt|;
block|}
return|return
name|op
operator|-
name|ostart
return|;
block|}
end_function

begin_function
name|MEM_STATIC
name|size_t
name|ZSTD_compressSequences
parameter_list|(
name|seqStore_t
modifier|*
name|seqStorePtr
parameter_list|,
name|ZSTD_entropyCTables_t
modifier|*
name|entropy
parameter_list|,
name|ZSTD_compressionParameters
specifier|const
modifier|*
name|cParams
parameter_list|,
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstCapacity
parameter_list|,
name|size_t
name|srcSize
parameter_list|)
block|{
name|size_t
specifier|const
name|cSize
init|=
name|ZSTD_compressSequences_internal
argument_list|(
name|seqStorePtr
argument_list|,
name|entropy
argument_list|,
name|cParams
argument_list|,
name|dst
argument_list|,
name|dstCapacity
argument_list|)
decl_stmt|;
name|size_t
specifier|const
name|minGain
init|=
name|ZSTD_minGain
argument_list|(
name|srcSize
argument_list|)
decl_stmt|;
name|size_t
specifier|const
name|maxCSize
init|=
name|srcSize
operator|-
name|minGain
decl_stmt|;
comment|/* If the srcSize<= dstCapacity, then there is enough space to write a      * raw uncompressed block. Since we ran out of space, the block must not      * be compressible, so fall back to a raw uncompressed block.      */
name|int
specifier|const
name|uncompressibleError
init|=
name|cSize
operator|==
name|ERROR
argument_list|(
name|dstSize_tooSmall
argument_list|)
operator|&&
name|srcSize
operator|<=
name|dstCapacity
decl_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|cSize
argument_list|)
operator|&&
operator|!
name|uncompressibleError
condition|)
return|return
name|cSize
return|;
comment|/* Check compressibility */
if|if
condition|(
name|cSize
operator|>=
name|maxCSize
operator|||
name|uncompressibleError
condition|)
block|{
name|entropy
operator|->
name|hufCTable_repeatMode
operator|=
name|HUF_repeat_none
expr_stmt|;
name|entropy
operator|->
name|offcode_repeatMode
operator|=
name|FSE_repeat_none
expr_stmt|;
name|entropy
operator|->
name|matchlength_repeatMode
operator|=
name|FSE_repeat_none
expr_stmt|;
name|entropy
operator|->
name|litlength_repeatMode
operator|=
name|FSE_repeat_none
expr_stmt|;
return|return
literal|0
return|;
block|}
name|assert
argument_list|(
operator|!
name|ZSTD_isError
argument_list|(
name|cSize
argument_list|)
argument_list|)
expr_stmt|;
comment|/* confirm repcodes */
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ZSTD_REP_NUM
condition|;
name|i
operator|++
control|)
name|seqStorePtr
operator|->
name|rep
index|[
name|i
index|]
operator|=
name|seqStorePtr
operator|->
name|repToConfirm
index|[
name|i
index|]
expr_stmt|;
block|}
return|return
name|cSize
return|;
block|}
end_function

begin_comment
comment|/* ZSTD_selectBlockCompressor() :  * Not static, but internal use only (used by long distance matcher)  * assumption : strat is a valid strategy */
end_comment

begin_typedef
typedef|typedef
name|size_t
function_decl|(
modifier|*
name|ZSTD_blockCompressor
function_decl|)
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|ctx
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|)
function_decl|;
end_typedef

begin_function
name|ZSTD_blockCompressor
name|ZSTD_selectBlockCompressor
parameter_list|(
name|ZSTD_strategy
name|strat
parameter_list|,
name|int
name|extDict
parameter_list|)
block|{
specifier|static
specifier|const
name|ZSTD_blockCompressor
name|blockCompressor
index|[
literal|2
index|]
index|[
operator|(
name|unsigned
operator|)
name|ZSTD_btultra
operator|+
literal|1
index|]
init|=
block|{
block|{
name|ZSTD_compressBlock_fast
comment|/* default for 0 */
block|,
name|ZSTD_compressBlock_fast
block|,
name|ZSTD_compressBlock_doubleFast
block|,
name|ZSTD_compressBlock_greedy
block|,
name|ZSTD_compressBlock_lazy
block|,
name|ZSTD_compressBlock_lazy2
block|,
name|ZSTD_compressBlock_btlazy2
block|,
name|ZSTD_compressBlock_btopt
block|,
name|ZSTD_compressBlock_btultra
block|}
block|,
block|{
name|ZSTD_compressBlock_fast_extDict
comment|/* default for 0 */
block|,
name|ZSTD_compressBlock_fast_extDict
block|,
name|ZSTD_compressBlock_doubleFast_extDict
block|,
name|ZSTD_compressBlock_greedy_extDict
block|,
name|ZSTD_compressBlock_lazy_extDict
block|,
name|ZSTD_compressBlock_lazy2_extDict
block|,
name|ZSTD_compressBlock_btlazy2_extDict
block|,
name|ZSTD_compressBlock_btopt_extDict
block|,
name|ZSTD_compressBlock_btultra_extDict
block|}
block|}
decl_stmt|;
name|ZSTD_STATIC_ASSERT
argument_list|(
operator|(
name|unsigned
operator|)
name|ZSTD_fast
operator|==
literal|1
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|(
name|U32
operator|)
name|strat
operator|>=
operator|(
name|U32
operator|)
name|ZSTD_fast
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|(
name|U32
operator|)
name|strat
operator|<=
operator|(
name|U32
operator|)
name|ZSTD_btultra
argument_list|)
expr_stmt|;
return|return
name|blockCompressor
index|[
name|extDict
operator|!=
literal|0
index|]
index|[
operator|(
name|U32
operator|)
name|strat
index|]
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ZSTD_storeLastLiterals
parameter_list|(
name|seqStore_t
modifier|*
name|seqStorePtr
parameter_list|,
specifier|const
name|BYTE
modifier|*
name|anchor
parameter_list|,
name|size_t
name|lastLLSize
parameter_list|)
block|{
name|memcpy
argument_list|(
name|seqStorePtr
operator|->
name|lit
argument_list|,
name|anchor
argument_list|,
name|lastLLSize
argument_list|)
expr_stmt|;
name|seqStorePtr
operator|->
name|lit
operator|+=
name|lastLLSize
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|size_t
name|ZSTD_compressBlock_internal
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|zc
parameter_list|,
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstCapacity
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|)
block|{
specifier|const
name|BYTE
modifier|*
specifier|const
name|base
init|=
name|zc
operator|->
name|base
decl_stmt|;
specifier|const
name|BYTE
modifier|*
specifier|const
name|istart
init|=
operator|(
specifier|const
name|BYTE
operator|*
operator|)
name|src
decl_stmt|;
specifier|const
name|U32
name|current
init|=
call|(
name|U32
call|)
argument_list|(
name|istart
operator|-
name|base
argument_list|)
decl_stmt|;
name|size_t
name|lastLLSize
decl_stmt|;
specifier|const
name|BYTE
modifier|*
name|anchor
decl_stmt|;
name|U32
specifier|const
name|extDict
init|=
name|zc
operator|->
name|lowLimit
operator|<
name|zc
operator|->
name|dictLimit
decl_stmt|;
specifier|const
name|ZSTD_blockCompressor
name|blockCompressor
init|=
name|zc
operator|->
name|appliedParams
operator|.
name|ldmParams
operator|.
name|enableLdm
condition|?
operator|(
name|extDict
condition|?
name|ZSTD_compressBlock_ldm_extDict
else|:
name|ZSTD_compressBlock_ldm
operator|)
else|:
name|ZSTD_selectBlockCompressor
argument_list|(
name|zc
operator|->
name|appliedParams
operator|.
name|cParams
operator|.
name|strategy
argument_list|,
name|extDict
argument_list|)
decl_stmt|;
if|if
condition|(
name|srcSize
operator|<
name|MIN_CBLOCK_SIZE
operator|+
name|ZSTD_blockHeaderSize
operator|+
literal|1
condition|)
return|return
literal|0
return|;
comment|/* don't even attempt compression below a certain srcSize */
name|ZSTD_resetSeqStore
argument_list|(
operator|&
operator|(
name|zc
operator|->
name|seqStore
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|current
operator|>
name|zc
operator|->
name|nextToUpdate
operator|+
literal|384
condition|)
name|zc
operator|->
name|nextToUpdate
operator|=
name|current
operator|-
name|MIN
argument_list|(
literal|192
argument_list|,
call|(
name|U32
call|)
argument_list|(
name|current
operator|-
name|zc
operator|->
name|nextToUpdate
operator|-
literal|384
argument_list|)
argument_list|)
expr_stmt|;
comment|/* limited update after finding a very long match */
name|lastLLSize
operator|=
name|blockCompressor
argument_list|(
name|zc
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|)
expr_stmt|;
comment|/* Last literals */
name|anchor
operator|=
operator|(
specifier|const
name|BYTE
operator|*
operator|)
name|src
operator|+
name|srcSize
operator|-
name|lastLLSize
expr_stmt|;
name|ZSTD_storeLastLiterals
argument_list|(
operator|&
name|zc
operator|->
name|seqStore
argument_list|,
name|anchor
argument_list|,
name|lastLLSize
argument_list|)
expr_stmt|;
return|return
name|ZSTD_compressSequences
argument_list|(
operator|&
name|zc
operator|->
name|seqStore
argument_list|,
name|zc
operator|->
name|entropy
argument_list|,
operator|&
name|zc
operator|->
name|appliedParams
operator|.
name|cParams
argument_list|,
name|dst
argument_list|,
name|dstCapacity
argument_list|,
name|srcSize
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*! ZSTD_compress_frameChunk() : *   Compress a chunk of data into one or multiple blocks. *   All blocks will be terminated, all input will be consumed. *   Function will issue an error if there is not enough `dstCapacity` to hold the compressed content. *   Frame is supposed already started (header already produced) *   @return : compressed size, or an error code */
end_comment

begin_function
specifier|static
name|size_t
name|ZSTD_compress_frameChunk
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstCapacity
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|,
name|U32
name|lastFrameChunk
parameter_list|)
block|{
name|size_t
name|blockSize
init|=
name|cctx
operator|->
name|blockSize
decl_stmt|;
name|size_t
name|remaining
init|=
name|srcSize
decl_stmt|;
specifier|const
name|BYTE
modifier|*
name|ip
init|=
operator|(
specifier|const
name|BYTE
operator|*
operator|)
name|src
decl_stmt|;
name|BYTE
modifier|*
specifier|const
name|ostart
init|=
operator|(
name|BYTE
operator|*
operator|)
name|dst
decl_stmt|;
name|BYTE
modifier|*
name|op
init|=
name|ostart
decl_stmt|;
name|U32
specifier|const
name|maxDist
init|=
operator|(
name|U32
operator|)
literal|1
operator|<<
name|cctx
operator|->
name|appliedParams
operator|.
name|cParams
operator|.
name|windowLog
decl_stmt|;
if|if
condition|(
name|cctx
operator|->
name|appliedParams
operator|.
name|fParams
operator|.
name|checksumFlag
operator|&&
name|srcSize
condition|)
name|XXH64_update
argument_list|(
operator|&
name|cctx
operator|->
name|xxhState
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|)
expr_stmt|;
while|while
condition|(
name|remaining
condition|)
block|{
name|U32
specifier|const
name|lastBlock
init|=
name|lastFrameChunk
operator|&
operator|(
name|blockSize
operator|>=
name|remaining
operator|)
decl_stmt|;
name|size_t
name|cSize
decl_stmt|;
if|if
condition|(
name|dstCapacity
operator|<
name|ZSTD_blockHeaderSize
operator|+
name|MIN_CBLOCK_SIZE
condition|)
return|return
name|ERROR
argument_list|(
name|dstSize_tooSmall
argument_list|)
return|;
comment|/* not enough space to store compressed block */
if|if
condition|(
name|remaining
operator|<
name|blockSize
condition|)
name|blockSize
operator|=
name|remaining
expr_stmt|;
comment|/* preemptive overflow correction:          * 1. correction is large enough:          *    lowLimit> (3<<29) ==> current> 3<<29 + 1<<windowLog - blockSize          *    1<<windowLog<= newCurrent< 1<<chainLog + 1<<windowLog          *          *    current - newCurrent          *> (3<<29 + 1<<windowLog - blockSize) - (1<<windowLog + 1<<chainLog)          *> (3<<29 - blockSize) - (1<<chainLog)          *> (3<<29 - blockSize) - (1<<30)             (NOTE: chainLog<= 30)          *> 1<<29 - 1<<17          *          * 2. (ip+blockSize - cctx->base) doesn't overflow:          *    In 32 bit mode we limit windowLog to 30 so we don't get          *    differences larger than 1<<31-1.          * 3. cctx->lowLimit< 1<<32:          *    windowLog<= 31 ==> 3<<29 + 1<<windowLog< 7<<29< 1<<32.          */
if|if
condition|(
name|cctx
operator|->
name|lowLimit
operator|>
operator|(
literal|3U
operator|<<
literal|29
operator|)
condition|)
block|{
name|U32
specifier|const
name|cycleMask
init|=
operator|(
operator|(
name|U32
operator|)
literal|1
operator|<<
name|ZSTD_cycleLog
argument_list|(
name|cctx
operator|->
name|appliedParams
operator|.
name|cParams
operator|.
name|chainLog
argument_list|,
name|cctx
operator|->
name|appliedParams
operator|.
name|cParams
operator|.
name|strategy
argument_list|)
operator|)
operator|-
literal|1
decl_stmt|;
name|U32
specifier|const
name|current
init|=
call|(
name|U32
call|)
argument_list|(
name|ip
operator|-
name|cctx
operator|->
name|base
argument_list|)
decl_stmt|;
name|U32
specifier|const
name|newCurrent
init|=
operator|(
name|current
operator|&
name|cycleMask
operator|)
operator|+
operator|(
operator|(
name|U32
operator|)
literal|1
operator|<<
name|cctx
operator|->
name|appliedParams
operator|.
name|cParams
operator|.
name|windowLog
operator|)
decl_stmt|;
name|U32
specifier|const
name|correction
init|=
name|current
operator|-
name|newCurrent
decl_stmt|;
name|ZSTD_STATIC_ASSERT
argument_list|(
name|ZSTD_CHAINLOG_MAX
operator|<=
literal|30
argument_list|)
expr_stmt|;
name|ZSTD_STATIC_ASSERT
argument_list|(
name|ZSTD_WINDOWLOG_MAX_32
operator|<=
literal|30
argument_list|)
expr_stmt|;
name|ZSTD_STATIC_ASSERT
argument_list|(
name|ZSTD_WINDOWLOG_MAX
operator|<=
literal|31
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|current
operator|>
name|newCurrent
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|correction
operator|>
literal|1
operator|<<
literal|28
argument_list|)
expr_stmt|;
comment|/* Loose bound, should be about 1<<29 */
name|ZSTD_reduceIndex
argument_list|(
name|cctx
argument_list|,
name|correction
argument_list|)
expr_stmt|;
name|cctx
operator|->
name|base
operator|+=
name|correction
expr_stmt|;
name|cctx
operator|->
name|dictBase
operator|+=
name|correction
expr_stmt|;
name|cctx
operator|->
name|lowLimit
operator|-=
name|correction
expr_stmt|;
name|cctx
operator|->
name|dictLimit
operator|-=
name|correction
expr_stmt|;
if|if
condition|(
name|cctx
operator|->
name|nextToUpdate
operator|<
name|correction
condition|)
name|cctx
operator|->
name|nextToUpdate
operator|=
literal|0
expr_stmt|;
else|else
name|cctx
operator|->
name|nextToUpdate
operator|-=
name|correction
expr_stmt|;
name|DEBUGLOG
argument_list|(
literal|4
argument_list|,
literal|"Correction of 0x%x bytes to lowLimit=0x%x\n"
argument_list|,
name|correction
argument_list|,
name|cctx
operator|->
name|lowLimit
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
call|(
name|U32
call|)
argument_list|(
name|ip
operator|+
name|blockSize
operator|-
name|cctx
operator|->
name|base
argument_list|)
operator|>
name|cctx
operator|->
name|loadedDictEnd
operator|+
name|maxDist
condition|)
block|{
comment|/* enforce maxDist */
name|U32
specifier|const
name|newLowLimit
init|=
call|(
name|U32
call|)
argument_list|(
name|ip
operator|+
name|blockSize
operator|-
name|cctx
operator|->
name|base
argument_list|)
operator|-
name|maxDist
decl_stmt|;
if|if
condition|(
name|cctx
operator|->
name|lowLimit
operator|<
name|newLowLimit
condition|)
name|cctx
operator|->
name|lowLimit
operator|=
name|newLowLimit
expr_stmt|;
if|if
condition|(
name|cctx
operator|->
name|dictLimit
operator|<
name|cctx
operator|->
name|lowLimit
condition|)
name|cctx
operator|->
name|dictLimit
operator|=
name|cctx
operator|->
name|lowLimit
expr_stmt|;
block|}
name|cSize
operator|=
name|ZSTD_compressBlock_internal
argument_list|(
name|cctx
argument_list|,
name|op
operator|+
name|ZSTD_blockHeaderSize
argument_list|,
name|dstCapacity
operator|-
name|ZSTD_blockHeaderSize
argument_list|,
name|ip
argument_list|,
name|blockSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|cSize
argument_list|)
condition|)
return|return
name|cSize
return|;
if|if
condition|(
name|cSize
operator|==
literal|0
condition|)
block|{
comment|/* block is not compressible */
name|U32
specifier|const
name|cBlockHeader24
init|=
name|lastBlock
operator|+
operator|(
operator|(
operator|(
name|U32
operator|)
name|bt_raw
operator|)
operator|<<
literal|1
operator|)
operator|+
call|(
name|U32
call|)
argument_list|(
name|blockSize
operator|<<
literal|3
argument_list|)
decl_stmt|;
if|if
condition|(
name|blockSize
operator|+
name|ZSTD_blockHeaderSize
operator|>
name|dstCapacity
condition|)
return|return
name|ERROR
argument_list|(
name|dstSize_tooSmall
argument_list|)
return|;
name|MEM_writeLE32
argument_list|(
name|op
argument_list|,
name|cBlockHeader24
argument_list|)
expr_stmt|;
comment|/* no pb, 4th byte will be overwritten */
name|memcpy
argument_list|(
name|op
operator|+
name|ZSTD_blockHeaderSize
argument_list|,
name|ip
argument_list|,
name|blockSize
argument_list|)
expr_stmt|;
name|cSize
operator|=
name|ZSTD_blockHeaderSize
operator|+
name|blockSize
expr_stmt|;
block|}
else|else
block|{
name|U32
specifier|const
name|cBlockHeader24
init|=
name|lastBlock
operator|+
operator|(
operator|(
operator|(
name|U32
operator|)
name|bt_compressed
operator|)
operator|<<
literal|1
operator|)
operator|+
call|(
name|U32
call|)
argument_list|(
name|cSize
operator|<<
literal|3
argument_list|)
decl_stmt|;
name|MEM_writeLE24
argument_list|(
name|op
argument_list|,
name|cBlockHeader24
argument_list|)
expr_stmt|;
name|cSize
operator|+=
name|ZSTD_blockHeaderSize
expr_stmt|;
block|}
name|remaining
operator|-=
name|blockSize
expr_stmt|;
name|dstCapacity
operator|-=
name|cSize
expr_stmt|;
name|ip
operator|+=
name|blockSize
expr_stmt|;
name|op
operator|+=
name|cSize
expr_stmt|;
block|}
if|if
condition|(
name|lastFrameChunk
operator|&&
operator|(
name|op
operator|>
name|ostart
operator|)
condition|)
name|cctx
operator|->
name|stage
operator|=
name|ZSTDcs_ending
expr_stmt|;
return|return
name|op
operator|-
name|ostart
return|;
block|}
end_function

begin_function
specifier|static
name|size_t
name|ZSTD_writeFrameHeader
parameter_list|(
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstCapacity
parameter_list|,
name|ZSTD_CCtx_params
name|params
parameter_list|,
name|U64
name|pledgedSrcSize
parameter_list|,
name|U32
name|dictID
parameter_list|)
block|{
name|BYTE
modifier|*
specifier|const
name|op
init|=
operator|(
name|BYTE
operator|*
operator|)
name|dst
decl_stmt|;
name|U32
specifier|const
name|dictIDSizeCodeLength
init|=
operator|(
name|dictID
operator|>
literal|0
operator|)
operator|+
operator|(
name|dictID
operator|>=
literal|256
operator|)
operator|+
operator|(
name|dictID
operator|>=
literal|65536
operator|)
decl_stmt|;
comment|/* 0-3 */
name|U32
specifier|const
name|dictIDSizeCode
init|=
name|params
operator|.
name|fParams
operator|.
name|noDictIDFlag
condition|?
literal|0
else|:
name|dictIDSizeCodeLength
decl_stmt|;
comment|/* 0-3 */
name|U32
specifier|const
name|checksumFlag
init|=
name|params
operator|.
name|fParams
operator|.
name|checksumFlag
operator|>
literal|0
decl_stmt|;
name|U32
specifier|const
name|windowSize
init|=
operator|(
name|U32
operator|)
literal|1
operator|<<
name|params
operator|.
name|cParams
operator|.
name|windowLog
decl_stmt|;
name|U32
specifier|const
name|singleSegment
init|=
name|params
operator|.
name|fParams
operator|.
name|contentSizeFlag
operator|&&
operator|(
name|windowSize
operator|>=
name|pledgedSrcSize
operator|)
decl_stmt|;
name|BYTE
specifier|const
name|windowLogByte
init|=
call|(
name|BYTE
call|)
argument_list|(
operator|(
name|params
operator|.
name|cParams
operator|.
name|windowLog
operator|-
name|ZSTD_WINDOWLOG_ABSOLUTEMIN
operator|)
operator|<<
literal|3
argument_list|)
decl_stmt|;
name|U32
specifier|const
name|fcsCode
init|=
name|params
operator|.
name|fParams
operator|.
name|contentSizeFlag
condition|?
operator|(
name|pledgedSrcSize
operator|>=
literal|256
operator|)
operator|+
operator|(
name|pledgedSrcSize
operator|>=
literal|65536
operator|+
literal|256
operator|)
operator|+
operator|(
name|pledgedSrcSize
operator|>=
literal|0xFFFFFFFFU
operator|)
else|:
literal|0
decl_stmt|;
comment|/* 0-3 */
name|BYTE
specifier|const
name|frameHeaderDecriptionByte
init|=
call|(
name|BYTE
call|)
argument_list|(
name|dictIDSizeCode
operator|+
operator|(
name|checksumFlag
operator|<<
literal|2
operator|)
operator|+
operator|(
name|singleSegment
operator|<<
literal|5
operator|)
operator|+
operator|(
name|fcsCode
operator|<<
literal|6
operator|)
argument_list|)
decl_stmt|;
name|size_t
name|pos
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|dstCapacity
operator|<
name|ZSTD_frameHeaderSize_max
condition|)
return|return
name|ERROR
argument_list|(
name|dstSize_tooSmall
argument_list|)
return|;
name|DEBUGLOG
argument_list|(
literal|4
argument_list|,
literal|"ZSTD_writeFrameHeader : dictIDFlag : %u ; dictID : %u ; dictIDSizeCode : %u"
argument_list|,
operator|!
name|params
operator|.
name|fParams
operator|.
name|noDictIDFlag
argument_list|,
name|dictID
argument_list|,
name|dictIDSizeCode
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|.
name|format
operator|==
name|ZSTD_f_zstd1
condition|)
block|{
name|DEBUGLOG
argument_list|(
literal|4
argument_list|,
literal|"writing zstd magic number"
argument_list|)
expr_stmt|;
name|MEM_writeLE32
argument_list|(
name|dst
argument_list|,
name|ZSTD_MAGICNUMBER
argument_list|)
expr_stmt|;
name|pos
operator|=
literal|4
expr_stmt|;
block|}
name|op
index|[
name|pos
operator|++
index|]
operator|=
name|frameHeaderDecriptionByte
expr_stmt|;
if|if
condition|(
operator|!
name|singleSegment
condition|)
name|op
index|[
name|pos
operator|++
index|]
operator|=
name|windowLogByte
expr_stmt|;
switch|switch
condition|(
name|dictIDSizeCode
condition|)
block|{
default|default:
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* impossible */
case|case
literal|0
case|:
break|break;
case|case
literal|1
case|:
name|op
index|[
name|pos
index|]
operator|=
call|(
name|BYTE
call|)
argument_list|(
name|dictID
argument_list|)
expr_stmt|;
name|pos
operator|++
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|MEM_writeLE16
argument_list|(
name|op
operator|+
name|pos
argument_list|,
operator|(
name|U16
operator|)
name|dictID
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|MEM_writeLE32
argument_list|(
name|op
operator|+
name|pos
argument_list|,
name|dictID
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|4
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|fcsCode
condition|)
block|{
default|default:
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* impossible */
case|case
literal|0
case|:
if|if
condition|(
name|singleSegment
condition|)
name|op
index|[
name|pos
operator|++
index|]
operator|=
call|(
name|BYTE
call|)
argument_list|(
name|pledgedSrcSize
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|MEM_writeLE16
argument_list|(
name|op
operator|+
name|pos
argument_list|,
call|(
name|U16
call|)
argument_list|(
name|pledgedSrcSize
operator|-
literal|256
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|MEM_writeLE32
argument_list|(
name|op
operator|+
name|pos
argument_list|,
call|(
name|U32
call|)
argument_list|(
name|pledgedSrcSize
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|4
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|MEM_writeLE64
argument_list|(
name|op
operator|+
name|pos
argument_list|,
call|(
name|U64
call|)
argument_list|(
name|pledgedSrcSize
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|8
expr_stmt|;
break|break;
block|}
return|return
name|pos
return|;
block|}
end_function

begin_function
specifier|static
name|size_t
name|ZSTD_compressContinue_internal
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstCapacity
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|,
name|U32
name|frame
parameter_list|,
name|U32
name|lastFrameChunk
parameter_list|)
block|{
specifier|const
name|BYTE
modifier|*
specifier|const
name|ip
init|=
operator|(
specifier|const
name|BYTE
operator|*
operator|)
name|src
decl_stmt|;
name|size_t
name|fhSize
init|=
literal|0
decl_stmt|;
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"ZSTD_compressContinue_internal"
argument_list|)
expr_stmt|;
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"stage: %u"
argument_list|,
name|cctx
operator|->
name|stage
argument_list|)
expr_stmt|;
if|if
condition|(
name|cctx
operator|->
name|stage
operator|==
name|ZSTDcs_created
condition|)
return|return
name|ERROR
argument_list|(
name|stage_wrong
argument_list|)
return|;
comment|/* missing init (ZSTD_compressBegin) */
if|if
condition|(
name|frame
operator|&&
operator|(
name|cctx
operator|->
name|stage
operator|==
name|ZSTDcs_init
operator|)
condition|)
block|{
name|fhSize
operator|=
name|ZSTD_writeFrameHeader
argument_list|(
name|dst
argument_list|,
name|dstCapacity
argument_list|,
name|cctx
operator|->
name|appliedParams
argument_list|,
name|cctx
operator|->
name|pledgedSrcSizePlusOne
operator|-
literal|1
argument_list|,
name|cctx
operator|->
name|dictID
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|fhSize
argument_list|)
condition|)
return|return
name|fhSize
return|;
name|dstCapacity
operator|-=
name|fhSize
expr_stmt|;
name|dst
operator|=
operator|(
name|char
operator|*
operator|)
name|dst
operator|+
name|fhSize
expr_stmt|;
name|cctx
operator|->
name|stage
operator|=
name|ZSTDcs_ongoing
expr_stmt|;
block|}
comment|/* Check if blocks follow each other */
if|if
condition|(
name|src
operator|!=
name|cctx
operator|->
name|nextSrc
condition|)
block|{
comment|/* not contiguous */
name|ptrdiff_t
specifier|const
name|delta
init|=
name|cctx
operator|->
name|nextSrc
operator|-
name|ip
decl_stmt|;
name|cctx
operator|->
name|lowLimit
operator|=
name|cctx
operator|->
name|dictLimit
expr_stmt|;
name|cctx
operator|->
name|dictLimit
operator|=
call|(
name|U32
call|)
argument_list|(
name|cctx
operator|->
name|nextSrc
operator|-
name|cctx
operator|->
name|base
argument_list|)
expr_stmt|;
name|cctx
operator|->
name|dictBase
operator|=
name|cctx
operator|->
name|base
expr_stmt|;
name|cctx
operator|->
name|base
operator|-=
name|delta
expr_stmt|;
name|cctx
operator|->
name|nextToUpdate
operator|=
name|cctx
operator|->
name|dictLimit
expr_stmt|;
if|if
condition|(
name|cctx
operator|->
name|dictLimit
operator|-
name|cctx
operator|->
name|lowLimit
operator|<
name|HASH_READ_SIZE
condition|)
name|cctx
operator|->
name|lowLimit
operator|=
name|cctx
operator|->
name|dictLimit
expr_stmt|;
comment|/* too small extDict */
block|}
comment|/* if input and dictionary overlap : reduce dictionary (area presumed modified by input) */
if|if
condition|(
operator|(
name|ip
operator|+
name|srcSize
operator|>
name|cctx
operator|->
name|dictBase
operator|+
name|cctx
operator|->
name|lowLimit
operator|)
operator|&
operator|(
name|ip
operator|<
name|cctx
operator|->
name|dictBase
operator|+
name|cctx
operator|->
name|dictLimit
operator|)
condition|)
block|{
name|ptrdiff_t
specifier|const
name|highInputIdx
init|=
operator|(
name|ip
operator|+
name|srcSize
operator|)
operator|-
name|cctx
operator|->
name|dictBase
decl_stmt|;
name|U32
specifier|const
name|lowLimitMax
init|=
operator|(
name|highInputIdx
operator|>
operator|(
name|ptrdiff_t
operator|)
name|cctx
operator|->
name|dictLimit
operator|)
condition|?
name|cctx
operator|->
name|dictLimit
else|:
operator|(
name|U32
operator|)
name|highInputIdx
decl_stmt|;
name|cctx
operator|->
name|lowLimit
operator|=
name|lowLimitMax
expr_stmt|;
block|}
name|cctx
operator|->
name|nextSrc
operator|=
name|ip
operator|+
name|srcSize
expr_stmt|;
if|if
condition|(
name|srcSize
condition|)
block|{
name|size_t
specifier|const
name|cSize
init|=
name|frame
condition|?
name|ZSTD_compress_frameChunk
argument_list|(
name|cctx
argument_list|,
name|dst
argument_list|,
name|dstCapacity
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|,
name|lastFrameChunk
argument_list|)
else|:
name|ZSTD_compressBlock_internal
argument_list|(
name|cctx
argument_list|,
name|dst
argument_list|,
name|dstCapacity
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|)
decl_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|cSize
argument_list|)
condition|)
return|return
name|cSize
return|;
name|cctx
operator|->
name|consumedSrcSize
operator|+=
name|srcSize
expr_stmt|;
return|return
name|cSize
operator|+
name|fhSize
return|;
block|}
else|else
return|return
name|fhSize
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_compressContinue
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstCapacity
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|)
block|{
return|return
name|ZSTD_compressContinue_internal
argument_list|(
name|cctx
argument_list|,
name|dst
argument_list|,
name|dstCapacity
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|,
literal|1
comment|/* frame mode */
argument_list|,
literal|0
comment|/* last chunk */
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_getBlockSize
parameter_list|(
specifier|const
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|)
block|{
name|ZSTD_compressionParameters
specifier|const
name|cParams
init|=
name|ZSTD_getCParamsFromCCtxParams
argument_list|(
name|cctx
operator|->
name|appliedParams
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
decl_stmt|;
return|return
name|MIN
argument_list|(
name|ZSTD_BLOCKSIZE_MAX
argument_list|,
operator|(
name|U32
operator|)
literal|1
operator|<<
name|cParams
operator|.
name|windowLog
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_compressBlock
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstCapacity
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|)
block|{
name|size_t
specifier|const
name|blockSizeMax
init|=
name|ZSTD_getBlockSize
argument_list|(
name|cctx
argument_list|)
decl_stmt|;
if|if
condition|(
name|srcSize
operator|>
name|blockSizeMax
condition|)
return|return
name|ERROR
argument_list|(
name|srcSize_wrong
argument_list|)
return|;
return|return
name|ZSTD_compressContinue_internal
argument_list|(
name|cctx
argument_list|,
name|dst
argument_list|,
name|dstCapacity
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|,
literal|0
comment|/* frame mode */
argument_list|,
literal|0
comment|/* last chunk */
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*! ZSTD_loadDictionaryContent() :  *  @return : 0, or an error code  */
end_comment

begin_function
specifier|static
name|size_t
name|ZSTD_loadDictionaryContent
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|zc
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|)
block|{
specifier|const
name|BYTE
modifier|*
specifier|const
name|ip
init|=
operator|(
specifier|const
name|BYTE
operator|*
operator|)
name|src
decl_stmt|;
specifier|const
name|BYTE
modifier|*
specifier|const
name|iend
init|=
name|ip
operator|+
name|srcSize
decl_stmt|;
comment|/* input becomes current prefix */
name|zc
operator|->
name|lowLimit
operator|=
name|zc
operator|->
name|dictLimit
expr_stmt|;
name|zc
operator|->
name|dictLimit
operator|=
call|(
name|U32
call|)
argument_list|(
name|zc
operator|->
name|nextSrc
operator|-
name|zc
operator|->
name|base
argument_list|)
expr_stmt|;
name|zc
operator|->
name|dictBase
operator|=
name|zc
operator|->
name|base
expr_stmt|;
name|zc
operator|->
name|base
operator|+=
name|ip
operator|-
name|zc
operator|->
name|nextSrc
expr_stmt|;
name|zc
operator|->
name|nextToUpdate
operator|=
name|zc
operator|->
name|dictLimit
expr_stmt|;
name|zc
operator|->
name|loadedDictEnd
operator|=
name|zc
operator|->
name|appliedParams
operator|.
name|forceWindow
condition|?
literal|0
else|:
call|(
name|U32
call|)
argument_list|(
name|iend
operator|-
name|zc
operator|->
name|base
argument_list|)
expr_stmt|;
name|zc
operator|->
name|nextSrc
operator|=
name|iend
expr_stmt|;
if|if
condition|(
name|srcSize
operator|<=
name|HASH_READ_SIZE
condition|)
return|return
literal|0
return|;
switch|switch
condition|(
name|zc
operator|->
name|appliedParams
operator|.
name|cParams
operator|.
name|strategy
condition|)
block|{
case|case
name|ZSTD_fast
case|:
name|ZSTD_fillHashTable
argument_list|(
name|zc
argument_list|,
name|iend
argument_list|,
name|zc
operator|->
name|appliedParams
operator|.
name|cParams
operator|.
name|searchLength
argument_list|)
expr_stmt|;
break|break;
case|case
name|ZSTD_dfast
case|:
name|ZSTD_fillDoubleHashTable
argument_list|(
name|zc
argument_list|,
name|iend
argument_list|,
name|zc
operator|->
name|appliedParams
operator|.
name|cParams
operator|.
name|searchLength
argument_list|)
expr_stmt|;
break|break;
case|case
name|ZSTD_greedy
case|:
case|case
name|ZSTD_lazy
case|:
case|case
name|ZSTD_lazy2
case|:
if|if
condition|(
name|srcSize
operator|>=
name|HASH_READ_SIZE
condition|)
name|ZSTD_insertAndFindFirstIndex
argument_list|(
name|zc
argument_list|,
name|iend
operator|-
name|HASH_READ_SIZE
argument_list|,
name|zc
operator|->
name|appliedParams
operator|.
name|cParams
operator|.
name|searchLength
argument_list|)
expr_stmt|;
break|break;
case|case
name|ZSTD_btlazy2
case|:
case|case
name|ZSTD_btopt
case|:
case|case
name|ZSTD_btultra
case|:
if|if
condition|(
name|srcSize
operator|>=
name|HASH_READ_SIZE
condition|)
name|ZSTD_updateTree
argument_list|(
name|zc
argument_list|,
name|iend
operator|-
name|HASH_READ_SIZE
argument_list|,
name|iend
argument_list|,
operator|(
name|U32
operator|)
literal|1
operator|<<
name|zc
operator|->
name|appliedParams
operator|.
name|cParams
operator|.
name|searchLog
argument_list|,
name|zc
operator|->
name|appliedParams
operator|.
name|cParams
operator|.
name|searchLength
argument_list|)
expr_stmt|;
break|break;
default|default:
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* not possible : not a valid strategy id */
block|}
name|zc
operator|->
name|nextToUpdate
operator|=
call|(
name|U32
call|)
argument_list|(
name|iend
operator|-
name|zc
operator|->
name|base
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Dictionaries that assign zero probability to symbols that show up causes problems    when FSE encoding.  Refuse dictionaries that assign zero probability to symbols    that we may encounter during compression.    NOTE: This behavior is not standard and could be improved in the future. */
end_comment

begin_function
specifier|static
name|size_t
name|ZSTD_checkDictNCount
parameter_list|(
name|short
modifier|*
name|normalizedCounter
parameter_list|,
name|unsigned
name|dictMaxSymbolValue
parameter_list|,
name|unsigned
name|maxSymbolValue
parameter_list|)
block|{
name|U32
name|s
decl_stmt|;
if|if
condition|(
name|dictMaxSymbolValue
operator|<
name|maxSymbolValue
condition|)
return|return
name|ERROR
argument_list|(
name|dictionary_corrupted
argument_list|)
return|;
for|for
control|(
name|s
operator|=
literal|0
init|;
name|s
operator|<=
name|maxSymbolValue
condition|;
operator|++
name|s
control|)
block|{
if|if
condition|(
name|normalizedCounter
index|[
name|s
index|]
operator|==
literal|0
condition|)
return|return
name|ERROR
argument_list|(
name|dictionary_corrupted
argument_list|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Dictionary format :  * See :  * https://github.com/facebook/zstd/blob/master/doc/zstd_compression_format.md#dictionary-format  */
end_comment

begin_comment
comment|/*! ZSTD_loadZstdDictionary() :  * @return : 0, or an error code  *  assumptions : magic number supposed already checked  *                dictSize supposed> 8  */
end_comment

begin_function
specifier|static
name|size_t
name|ZSTD_loadZstdDictionary
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
specifier|const
name|void
modifier|*
name|dict
parameter_list|,
name|size_t
name|dictSize
parameter_list|)
block|{
specifier|const
name|BYTE
modifier|*
name|dictPtr
init|=
operator|(
specifier|const
name|BYTE
operator|*
operator|)
name|dict
decl_stmt|;
specifier|const
name|BYTE
modifier|*
specifier|const
name|dictEnd
init|=
name|dictPtr
operator|+
name|dictSize
decl_stmt|;
name|short
name|offcodeNCount
index|[
name|MaxOff
operator|+
literal|1
index|]
decl_stmt|;
name|unsigned
name|offcodeMaxValue
init|=
name|MaxOff
decl_stmt|;
name|ZSTD_STATIC_ASSERT
argument_list|(
sizeof|sizeof
argument_list|(
name|cctx
operator|->
name|entropy
operator|->
name|workspace
argument_list|)
operator|>=
operator|(
literal|1
operator|<<
name|MAX
argument_list|(
name|MLFSELog
argument_list|,
name|LLFSELog
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|dictPtr
operator|+=
literal|4
expr_stmt|;
comment|/* skip magic number */
name|cctx
operator|->
name|dictID
operator|=
name|cctx
operator|->
name|appliedParams
operator|.
name|fParams
operator|.
name|noDictIDFlag
condition|?
literal|0
else|:
name|MEM_readLE32
argument_list|(
name|dictPtr
argument_list|)
expr_stmt|;
name|dictPtr
operator|+=
literal|4
expr_stmt|;
block|{
name|unsigned
name|maxSymbolValue
init|=
literal|255
decl_stmt|;
name|size_t
specifier|const
name|hufHeaderSize
init|=
name|HUF_readCTable
argument_list|(
operator|(
name|HUF_CElt
operator|*
operator|)
name|cctx
operator|->
name|entropy
operator|->
name|hufCTable
argument_list|,
operator|&
name|maxSymbolValue
argument_list|,
name|dictPtr
argument_list|,
name|dictEnd
operator|-
name|dictPtr
argument_list|)
decl_stmt|;
if|if
condition|(
name|HUF_isError
argument_list|(
name|hufHeaderSize
argument_list|)
condition|)
return|return
name|ERROR
argument_list|(
name|dictionary_corrupted
argument_list|)
return|;
if|if
condition|(
name|maxSymbolValue
operator|<
literal|255
condition|)
return|return
name|ERROR
argument_list|(
name|dictionary_corrupted
argument_list|)
return|;
name|dictPtr
operator|+=
name|hufHeaderSize
expr_stmt|;
block|}
block|{
name|unsigned
name|offcodeLog
decl_stmt|;
name|size_t
specifier|const
name|offcodeHeaderSize
init|=
name|FSE_readNCount
argument_list|(
name|offcodeNCount
argument_list|,
operator|&
name|offcodeMaxValue
argument_list|,
operator|&
name|offcodeLog
argument_list|,
name|dictPtr
argument_list|,
name|dictEnd
operator|-
name|dictPtr
argument_list|)
decl_stmt|;
if|if
condition|(
name|FSE_isError
argument_list|(
name|offcodeHeaderSize
argument_list|)
condition|)
return|return
name|ERROR
argument_list|(
name|dictionary_corrupted
argument_list|)
return|;
if|if
condition|(
name|offcodeLog
operator|>
name|OffFSELog
condition|)
return|return
name|ERROR
argument_list|(
name|dictionary_corrupted
argument_list|)
return|;
comment|/* Defer checking offcodeMaxValue because we need to know the size of the dictionary content */
name|CHECK_E
argument_list|(
name|FSE_buildCTable_wksp
argument_list|(
name|cctx
operator|->
name|entropy
operator|->
name|offcodeCTable
argument_list|,
name|offcodeNCount
argument_list|,
name|offcodeMaxValue
argument_list|,
name|offcodeLog
argument_list|,
name|cctx
operator|->
name|entropy
operator|->
name|workspace
argument_list|,
sizeof|sizeof
argument_list|(
name|cctx
operator|->
name|entropy
operator|->
name|workspace
argument_list|)
argument_list|)
argument_list|,
name|dictionary_corrupted
argument_list|)
expr_stmt|;
name|dictPtr
operator|+=
name|offcodeHeaderSize
expr_stmt|;
block|}
block|{
name|short
name|matchlengthNCount
index|[
name|MaxML
operator|+
literal|1
index|]
decl_stmt|;
name|unsigned
name|matchlengthMaxValue
init|=
name|MaxML
decl_stmt|,
name|matchlengthLog
decl_stmt|;
name|size_t
specifier|const
name|matchlengthHeaderSize
init|=
name|FSE_readNCount
argument_list|(
name|matchlengthNCount
argument_list|,
operator|&
name|matchlengthMaxValue
argument_list|,
operator|&
name|matchlengthLog
argument_list|,
name|dictPtr
argument_list|,
name|dictEnd
operator|-
name|dictPtr
argument_list|)
decl_stmt|;
if|if
condition|(
name|FSE_isError
argument_list|(
name|matchlengthHeaderSize
argument_list|)
condition|)
return|return
name|ERROR
argument_list|(
name|dictionary_corrupted
argument_list|)
return|;
if|if
condition|(
name|matchlengthLog
operator|>
name|MLFSELog
condition|)
return|return
name|ERROR
argument_list|(
name|dictionary_corrupted
argument_list|)
return|;
comment|/* Every match length code must have non-zero probability */
name|CHECK_F
argument_list|(
name|ZSTD_checkDictNCount
argument_list|(
name|matchlengthNCount
argument_list|,
name|matchlengthMaxValue
argument_list|,
name|MaxML
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK_E
argument_list|(
name|FSE_buildCTable_wksp
argument_list|(
name|cctx
operator|->
name|entropy
operator|->
name|matchlengthCTable
argument_list|,
name|matchlengthNCount
argument_list|,
name|matchlengthMaxValue
argument_list|,
name|matchlengthLog
argument_list|,
name|cctx
operator|->
name|entropy
operator|->
name|workspace
argument_list|,
sizeof|sizeof
argument_list|(
name|cctx
operator|->
name|entropy
operator|->
name|workspace
argument_list|)
argument_list|)
argument_list|,
name|dictionary_corrupted
argument_list|)
expr_stmt|;
name|dictPtr
operator|+=
name|matchlengthHeaderSize
expr_stmt|;
block|}
block|{
name|short
name|litlengthNCount
index|[
name|MaxLL
operator|+
literal|1
index|]
decl_stmt|;
name|unsigned
name|litlengthMaxValue
init|=
name|MaxLL
decl_stmt|,
name|litlengthLog
decl_stmt|;
name|size_t
specifier|const
name|litlengthHeaderSize
init|=
name|FSE_readNCount
argument_list|(
name|litlengthNCount
argument_list|,
operator|&
name|litlengthMaxValue
argument_list|,
operator|&
name|litlengthLog
argument_list|,
name|dictPtr
argument_list|,
name|dictEnd
operator|-
name|dictPtr
argument_list|)
decl_stmt|;
if|if
condition|(
name|FSE_isError
argument_list|(
name|litlengthHeaderSize
argument_list|)
condition|)
return|return
name|ERROR
argument_list|(
name|dictionary_corrupted
argument_list|)
return|;
if|if
condition|(
name|litlengthLog
operator|>
name|LLFSELog
condition|)
return|return
name|ERROR
argument_list|(
name|dictionary_corrupted
argument_list|)
return|;
comment|/* Every literal length code must have non-zero probability */
name|CHECK_F
argument_list|(
name|ZSTD_checkDictNCount
argument_list|(
name|litlengthNCount
argument_list|,
name|litlengthMaxValue
argument_list|,
name|MaxLL
argument_list|)
argument_list|)
expr_stmt|;
name|CHECK_E
argument_list|(
name|FSE_buildCTable_wksp
argument_list|(
name|cctx
operator|->
name|entropy
operator|->
name|litlengthCTable
argument_list|,
name|litlengthNCount
argument_list|,
name|litlengthMaxValue
argument_list|,
name|litlengthLog
argument_list|,
name|cctx
operator|->
name|entropy
operator|->
name|workspace
argument_list|,
sizeof|sizeof
argument_list|(
name|cctx
operator|->
name|entropy
operator|->
name|workspace
argument_list|)
argument_list|)
argument_list|,
name|dictionary_corrupted
argument_list|)
expr_stmt|;
name|dictPtr
operator|+=
name|litlengthHeaderSize
expr_stmt|;
block|}
if|if
condition|(
name|dictPtr
operator|+
literal|12
operator|>
name|dictEnd
condition|)
return|return
name|ERROR
argument_list|(
name|dictionary_corrupted
argument_list|)
return|;
name|cctx
operator|->
name|seqStore
operator|.
name|rep
index|[
literal|0
index|]
operator|=
name|MEM_readLE32
argument_list|(
name|dictPtr
operator|+
literal|0
argument_list|)
expr_stmt|;
name|cctx
operator|->
name|seqStore
operator|.
name|rep
index|[
literal|1
index|]
operator|=
name|MEM_readLE32
argument_list|(
name|dictPtr
operator|+
literal|4
argument_list|)
expr_stmt|;
name|cctx
operator|->
name|seqStore
operator|.
name|rep
index|[
literal|2
index|]
operator|=
name|MEM_readLE32
argument_list|(
name|dictPtr
operator|+
literal|8
argument_list|)
expr_stmt|;
name|dictPtr
operator|+=
literal|12
expr_stmt|;
block|{
name|size_t
specifier|const
name|dictContentSize
init|=
call|(
name|size_t
call|)
argument_list|(
name|dictEnd
operator|-
name|dictPtr
argument_list|)
decl_stmt|;
name|U32
name|offcodeMax
init|=
name|MaxOff
decl_stmt|;
if|if
condition|(
name|dictContentSize
operator|<=
operator|(
operator|(
name|U32
operator|)
operator|-
literal|1
operator|)
operator|-
literal|128
name|KB
condition|)
block|{
name|U32
specifier|const
name|maxOffset
init|=
operator|(
name|U32
operator|)
name|dictContentSize
operator|+
literal|128
name|KB
decl_stmt|;
comment|/* The maximum offset that must be supported */
name|offcodeMax
operator|=
name|ZSTD_highbit32
argument_list|(
name|maxOffset
argument_list|)
expr_stmt|;
comment|/* Calculate minimum offset code required to represent maxOffset */
block|}
comment|/* All offset values<= dictContentSize + 128 KB must be representable */
name|CHECK_F
argument_list|(
name|ZSTD_checkDictNCount
argument_list|(
name|offcodeNCount
argument_list|,
name|offcodeMaxValue
argument_list|,
name|MIN
argument_list|(
name|offcodeMax
argument_list|,
name|MaxOff
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/* All repCodes must be<= dictContentSize and != 0*/
block|{
name|U32
name|u
decl_stmt|;
for|for
control|(
name|u
operator|=
literal|0
init|;
name|u
operator|<
literal|3
condition|;
name|u
operator|++
control|)
block|{
if|if
condition|(
name|cctx
operator|->
name|seqStore
operator|.
name|rep
index|[
name|u
index|]
operator|==
literal|0
condition|)
return|return
name|ERROR
argument_list|(
name|dictionary_corrupted
argument_list|)
return|;
if|if
condition|(
name|cctx
operator|->
name|seqStore
operator|.
name|rep
index|[
name|u
index|]
operator|>
name|dictContentSize
condition|)
return|return
name|ERROR
argument_list|(
name|dictionary_corrupted
argument_list|)
return|;
block|}
block|}
name|cctx
operator|->
name|entropy
operator|->
name|hufCTable_repeatMode
operator|=
name|HUF_repeat_valid
expr_stmt|;
name|cctx
operator|->
name|entropy
operator|->
name|offcode_repeatMode
operator|=
name|FSE_repeat_valid
expr_stmt|;
name|cctx
operator|->
name|entropy
operator|->
name|matchlength_repeatMode
operator|=
name|FSE_repeat_valid
expr_stmt|;
name|cctx
operator|->
name|entropy
operator|->
name|litlength_repeatMode
operator|=
name|FSE_repeat_valid
expr_stmt|;
return|return
name|ZSTD_loadDictionaryContent
argument_list|(
name|cctx
argument_list|,
name|dictPtr
argument_list|,
name|dictContentSize
argument_list|)
return|;
block|}
block|}
end_function

begin_comment
comment|/** ZSTD_compress_insertDictionary() : *   @return : 0, or an error code */
end_comment

begin_function
specifier|static
name|size_t
name|ZSTD_compress_insertDictionary
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
specifier|const
name|void
modifier|*
name|dict
parameter_list|,
name|size_t
name|dictSize
parameter_list|,
name|ZSTD_dictMode_e
name|dictMode
parameter_list|)
block|{
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"ZSTD_compress_insertDictionary"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dict
operator|==
name|NULL
operator|)
operator|||
operator|(
name|dictSize
operator|<=
literal|8
operator|)
condition|)
return|return
literal|0
return|;
comment|/* dict restricted modes */
if|if
condition|(
name|dictMode
operator|==
name|ZSTD_dm_rawContent
condition|)
return|return
name|ZSTD_loadDictionaryContent
argument_list|(
name|cctx
argument_list|,
name|dict
argument_list|,
name|dictSize
argument_list|)
return|;
if|if
condition|(
name|MEM_readLE32
argument_list|(
name|dict
argument_list|)
operator|!=
name|ZSTD_MAGIC_DICTIONARY
condition|)
block|{
if|if
condition|(
name|dictMode
operator|==
name|ZSTD_dm_auto
condition|)
block|{
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"raw content dictionary detected"
argument_list|)
expr_stmt|;
return|return
name|ZSTD_loadDictionaryContent
argument_list|(
name|cctx
argument_list|,
name|dict
argument_list|,
name|dictSize
argument_list|)
return|;
block|}
if|if
condition|(
name|dictMode
operator|==
name|ZSTD_dm_fullDict
condition|)
return|return
name|ERROR
argument_list|(
name|dictionary_wrong
argument_list|)
return|;
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
comment|/* impossible */
block|}
comment|/* dict as full zstd dictionary */
return|return
name|ZSTD_loadZstdDictionary
argument_list|(
name|cctx
argument_list|,
name|dict
argument_list|,
name|dictSize
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*! ZSTD_compressBegin_internal() :  * @return : 0, or an error code */
end_comment

begin_function
specifier|static
name|size_t
name|ZSTD_compressBegin_internal
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
specifier|const
name|void
modifier|*
name|dict
parameter_list|,
name|size_t
name|dictSize
parameter_list|,
name|ZSTD_dictMode_e
name|dictMode
parameter_list|,
specifier|const
name|ZSTD_CDict
modifier|*
name|cdict
parameter_list|,
name|ZSTD_CCtx_params
name|params
parameter_list|,
name|U64
name|pledgedSrcSize
parameter_list|,
name|ZSTD_buffered_policy_e
name|zbuff
parameter_list|)
block|{
name|DEBUGLOG
argument_list|(
literal|4
argument_list|,
literal|"ZSTD_compressBegin_internal"
argument_list|)
expr_stmt|;
comment|/* params are supposed to be fully validated at this point */
name|assert
argument_list|(
operator|!
name|ZSTD_isError
argument_list|(
name|ZSTD_checkCParams
argument_list|(
name|params
operator|.
name|cParams
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|!
operator|(
operator|(
name|dict
operator|)
operator|&&
operator|(
name|cdict
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|/* either dict or cdict, not both */
if|if
condition|(
name|cdict
operator|&&
name|cdict
operator|->
name|dictContentSize
operator|>
literal|0
condition|)
block|{
return|return
name|ZSTD_copyCCtx_internal
argument_list|(
name|cctx
argument_list|,
name|cdict
operator|->
name|refContext
argument_list|,
name|params
operator|.
name|fParams
argument_list|,
name|pledgedSrcSize
argument_list|,
name|zbuff
argument_list|)
return|;
block|}
name|CHECK_F
argument_list|(
name|ZSTD_resetCCtx_internal
argument_list|(
name|cctx
argument_list|,
name|params
argument_list|,
name|pledgedSrcSize
argument_list|,
name|ZSTDcrp_continue
argument_list|,
name|zbuff
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ZSTD_compress_insertDictionary
argument_list|(
name|cctx
argument_list|,
name|dict
argument_list|,
name|dictSize
argument_list|,
name|dictMode
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_compressBegin_advanced_internal
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
specifier|const
name|void
modifier|*
name|dict
parameter_list|,
name|size_t
name|dictSize
parameter_list|,
name|ZSTD_dictMode_e
name|dictMode
parameter_list|,
name|ZSTD_CCtx_params
name|params
parameter_list|,
name|unsigned
name|long
name|long
name|pledgedSrcSize
parameter_list|)
block|{
comment|/* compression parameters verification and optimization */
name|CHECK_F
argument_list|(
name|ZSTD_checkCParams
argument_list|(
name|params
operator|.
name|cParams
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ZSTD_compressBegin_internal
argument_list|(
name|cctx
argument_list|,
name|dict
argument_list|,
name|dictSize
argument_list|,
name|dictMode
argument_list|,
name|NULL
argument_list|,
name|params
argument_list|,
name|pledgedSrcSize
argument_list|,
name|ZSTDb_not_buffered
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*! ZSTD_compressBegin_advanced() : *   @return : 0, or an error code */
end_comment

begin_function
name|size_t
name|ZSTD_compressBegin_advanced
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
specifier|const
name|void
modifier|*
name|dict
parameter_list|,
name|size_t
name|dictSize
parameter_list|,
name|ZSTD_parameters
name|params
parameter_list|,
name|unsigned
name|long
name|long
name|pledgedSrcSize
parameter_list|)
block|{
name|ZSTD_CCtx_params
specifier|const
name|cctxParams
init|=
name|ZSTD_assignParamsToCCtxParams
argument_list|(
name|cctx
operator|->
name|requestedParams
argument_list|,
name|params
argument_list|)
decl_stmt|;
return|return
name|ZSTD_compressBegin_advanced_internal
argument_list|(
name|cctx
argument_list|,
name|dict
argument_list|,
name|dictSize
argument_list|,
name|ZSTD_dm_auto
argument_list|,
name|cctxParams
argument_list|,
name|pledgedSrcSize
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_compressBegin_usingDict
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
specifier|const
name|void
modifier|*
name|dict
parameter_list|,
name|size_t
name|dictSize
parameter_list|,
name|int
name|compressionLevel
parameter_list|)
block|{
name|ZSTD_parameters
specifier|const
name|params
init|=
name|ZSTD_getParams
argument_list|(
name|compressionLevel
argument_list|,
literal|0
argument_list|,
name|dictSize
argument_list|)
decl_stmt|;
name|ZSTD_CCtx_params
specifier|const
name|cctxParams
init|=
name|ZSTD_assignParamsToCCtxParams
argument_list|(
name|cctx
operator|->
name|requestedParams
argument_list|,
name|params
argument_list|)
decl_stmt|;
return|return
name|ZSTD_compressBegin_internal
argument_list|(
name|cctx
argument_list|,
name|dict
argument_list|,
name|dictSize
argument_list|,
name|ZSTD_dm_auto
argument_list|,
name|NULL
argument_list|,
name|cctxParams
argument_list|,
literal|0
argument_list|,
name|ZSTDb_not_buffered
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_compressBegin
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
name|int
name|compressionLevel
parameter_list|)
block|{
return|return
name|ZSTD_compressBegin_usingDict
argument_list|(
name|cctx
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|compressionLevel
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*! ZSTD_writeEpilogue() : *   Ends a frame. *   @return : nb of bytes written into dst (or an error code) */
end_comment

begin_function
specifier|static
name|size_t
name|ZSTD_writeEpilogue
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstCapacity
parameter_list|)
block|{
name|BYTE
modifier|*
specifier|const
name|ostart
init|=
operator|(
name|BYTE
operator|*
operator|)
name|dst
decl_stmt|;
name|BYTE
modifier|*
name|op
init|=
name|ostart
decl_stmt|;
name|size_t
name|fhSize
init|=
literal|0
decl_stmt|;
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"ZSTD_writeEpilogue"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cctx
operator|->
name|stage
operator|==
name|ZSTDcs_created
condition|)
return|return
name|ERROR
argument_list|(
name|stage_wrong
argument_list|)
return|;
comment|/* init missing */
comment|/* special case : empty frame */
if|if
condition|(
name|cctx
operator|->
name|stage
operator|==
name|ZSTDcs_init
condition|)
block|{
name|fhSize
operator|=
name|ZSTD_writeFrameHeader
argument_list|(
name|dst
argument_list|,
name|dstCapacity
argument_list|,
name|cctx
operator|->
name|appliedParams
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|fhSize
argument_list|)
condition|)
return|return
name|fhSize
return|;
name|dstCapacity
operator|-=
name|fhSize
expr_stmt|;
name|op
operator|+=
name|fhSize
expr_stmt|;
name|cctx
operator|->
name|stage
operator|=
name|ZSTDcs_ongoing
expr_stmt|;
block|}
if|if
condition|(
name|cctx
operator|->
name|stage
operator|!=
name|ZSTDcs_ending
condition|)
block|{
comment|/* write one last empty block, make it the "last" block */
name|U32
specifier|const
name|cBlockHeader24
init|=
literal|1
comment|/* last block */
operator|+
operator|(
operator|(
operator|(
name|U32
operator|)
name|bt_raw
operator|)
operator|<<
literal|1
operator|)
operator|+
literal|0
decl_stmt|;
if|if
condition|(
name|dstCapacity
operator|<
literal|4
condition|)
return|return
name|ERROR
argument_list|(
name|dstSize_tooSmall
argument_list|)
return|;
name|MEM_writeLE32
argument_list|(
name|op
argument_list|,
name|cBlockHeader24
argument_list|)
expr_stmt|;
name|op
operator|+=
name|ZSTD_blockHeaderSize
expr_stmt|;
name|dstCapacity
operator|-=
name|ZSTD_blockHeaderSize
expr_stmt|;
block|}
if|if
condition|(
name|cctx
operator|->
name|appliedParams
operator|.
name|fParams
operator|.
name|checksumFlag
condition|)
block|{
name|U32
specifier|const
name|checksum
init|=
operator|(
name|U32
operator|)
name|XXH64_digest
argument_list|(
operator|&
name|cctx
operator|->
name|xxhState
argument_list|)
decl_stmt|;
if|if
condition|(
name|dstCapacity
operator|<
literal|4
condition|)
return|return
name|ERROR
argument_list|(
name|dstSize_tooSmall
argument_list|)
return|;
name|MEM_writeLE32
argument_list|(
name|op
argument_list|,
name|checksum
argument_list|)
expr_stmt|;
name|op
operator|+=
literal|4
expr_stmt|;
block|}
name|cctx
operator|->
name|stage
operator|=
name|ZSTDcs_created
expr_stmt|;
comment|/* return to "created but no init" status */
return|return
name|op
operator|-
name|ostart
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_compressEnd
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstCapacity
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|)
block|{
name|size_t
name|endResult
decl_stmt|;
name|size_t
specifier|const
name|cSize
init|=
name|ZSTD_compressContinue_internal
argument_list|(
name|cctx
argument_list|,
name|dst
argument_list|,
name|dstCapacity
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|,
literal|1
comment|/* frame mode */
argument_list|,
literal|1
comment|/* last chunk */
argument_list|)
decl_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|cSize
argument_list|)
condition|)
return|return
name|cSize
return|;
name|endResult
operator|=
name|ZSTD_writeEpilogue
argument_list|(
name|cctx
argument_list|,
operator|(
name|char
operator|*
operator|)
name|dst
operator|+
name|cSize
argument_list|,
name|dstCapacity
operator|-
name|cSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|endResult
argument_list|)
condition|)
return|return
name|endResult
return|;
if|if
condition|(
name|cctx
operator|->
name|appliedParams
operator|.
name|fParams
operator|.
name|contentSizeFlag
condition|)
block|{
comment|/* control src size */
name|DEBUGLOG
argument_list|(
literal|4
argument_list|,
literal|"end of frame : controlling src size"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cctx
operator|->
name|pledgedSrcSizePlusOne
operator|!=
name|cctx
operator|->
name|consumedSrcSize
operator|+
literal|1
condition|)
block|{
name|DEBUGLOG
argument_list|(
literal|4
argument_list|,
literal|"error : pledgedSrcSize = %u, while realSrcSize = %u"
argument_list|,
operator|(
name|U32
operator|)
name|cctx
operator|->
name|pledgedSrcSizePlusOne
operator|-
literal|1
argument_list|,
operator|(
name|U32
operator|)
name|cctx
operator|->
name|consumedSrcSize
argument_list|)
expr_stmt|;
return|return
name|ERROR
argument_list|(
name|srcSize_wrong
argument_list|)
return|;
block|}
block|}
return|return
name|cSize
operator|+
name|endResult
return|;
block|}
end_function

begin_function
specifier|static
name|size_t
name|ZSTD_compress_internal
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstCapacity
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|,
specifier|const
name|void
modifier|*
name|dict
parameter_list|,
name|size_t
name|dictSize
parameter_list|,
name|ZSTD_parameters
name|params
parameter_list|)
block|{
name|ZSTD_CCtx_params
specifier|const
name|cctxParams
init|=
name|ZSTD_assignParamsToCCtxParams
argument_list|(
name|cctx
operator|->
name|requestedParams
argument_list|,
name|params
argument_list|)
decl_stmt|;
return|return
name|ZSTD_compress_advanced_internal
argument_list|(
name|cctx
argument_list|,
name|dst
argument_list|,
name|dstCapacity
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|,
name|dict
argument_list|,
name|dictSize
argument_list|,
name|cctxParams
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_compress_advanced
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|ctx
parameter_list|,
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstCapacity
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|,
specifier|const
name|void
modifier|*
name|dict
parameter_list|,
name|size_t
name|dictSize
parameter_list|,
name|ZSTD_parameters
name|params
parameter_list|)
block|{
name|CHECK_F
argument_list|(
name|ZSTD_checkCParams
argument_list|(
name|params
operator|.
name|cParams
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ZSTD_compress_internal
argument_list|(
name|ctx
argument_list|,
name|dst
argument_list|,
name|dstCapacity
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|,
name|dict
argument_list|,
name|dictSize
argument_list|,
name|params
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Internal */
end_comment

begin_function
name|size_t
name|ZSTD_compress_advanced_internal
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstCapacity
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|,
specifier|const
name|void
modifier|*
name|dict
parameter_list|,
name|size_t
name|dictSize
parameter_list|,
name|ZSTD_CCtx_params
name|params
parameter_list|)
block|{
name|CHECK_F
argument_list|(
name|ZSTD_compressBegin_internal
argument_list|(
name|cctx
argument_list|,
name|dict
argument_list|,
name|dictSize
argument_list|,
name|ZSTD_dm_auto
argument_list|,
name|NULL
argument_list|,
name|params
argument_list|,
name|srcSize
argument_list|,
name|ZSTDb_not_buffered
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ZSTD_compressEnd
argument_list|(
name|cctx
argument_list|,
name|dst
argument_list|,
name|dstCapacity
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_compress_usingDict
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|ctx
parameter_list|,
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstCapacity
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|,
specifier|const
name|void
modifier|*
name|dict
parameter_list|,
name|size_t
name|dictSize
parameter_list|,
name|int
name|compressionLevel
parameter_list|)
block|{
name|ZSTD_parameters
name|params
init|=
name|ZSTD_getParams
argument_list|(
name|compressionLevel
argument_list|,
name|srcSize
argument_list|,
name|dict
condition|?
name|dictSize
else|:
literal|0
argument_list|)
decl_stmt|;
name|params
operator|.
name|fParams
operator|.
name|contentSizeFlag
operator|=
literal|1
expr_stmt|;
return|return
name|ZSTD_compress_internal
argument_list|(
name|ctx
argument_list|,
name|dst
argument_list|,
name|dstCapacity
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|,
name|dict
argument_list|,
name|dictSize
argument_list|,
name|params
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_compressCCtx
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|ctx
parameter_list|,
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstCapacity
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|,
name|int
name|compressionLevel
parameter_list|)
block|{
return|return
name|ZSTD_compress_usingDict
argument_list|(
name|ctx
argument_list|,
name|dst
argument_list|,
name|dstCapacity
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|compressionLevel
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_compress
parameter_list|(
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstCapacity
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|,
name|int
name|compressionLevel
parameter_list|)
block|{
name|size_t
name|result
decl_stmt|;
name|ZSTD_CCtx
name|ctxBody
decl_stmt|;
name|memset
argument_list|(
operator|&
name|ctxBody
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ctxBody
argument_list|)
argument_list|)
expr_stmt|;
name|ctxBody
operator|.
name|customMem
operator|=
name|ZSTD_defaultCMem
expr_stmt|;
name|result
operator|=
name|ZSTD_compressCCtx
argument_list|(
operator|&
name|ctxBody
argument_list|,
name|dst
argument_list|,
name|dstCapacity
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|,
name|compressionLevel
argument_list|)
expr_stmt|;
name|ZSTD_free
argument_list|(
name|ctxBody
operator|.
name|workSpace
argument_list|,
name|ZSTD_defaultCMem
argument_list|)
expr_stmt|;
comment|/* can't free ctxBody itself, as it's on stack; free only heap content */
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/* =====  Dictionary API  ===== */
end_comment

begin_comment
comment|/*! ZSTD_estimateCDictSize_advanced() :  *  Estimate amount of memory that will be needed to create a dictionary with following arguments */
end_comment

begin_function
name|size_t
name|ZSTD_estimateCDictSize_advanced
parameter_list|(
name|size_t
name|dictSize
parameter_list|,
name|ZSTD_compressionParameters
name|cParams
parameter_list|,
name|ZSTD_dictLoadMethod_e
name|dictLoadMethod
parameter_list|)
block|{
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"sizeof(ZSTD_CDict) : %u"
argument_list|,
operator|(
name|U32
operator|)
sizeof|sizeof
argument_list|(
name|ZSTD_CDict
argument_list|)
argument_list|)
expr_stmt|;
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"CCtx estimate : %u"
argument_list|,
operator|(
name|U32
operator|)
name|ZSTD_estimateCCtxSize_usingCParams
argument_list|(
name|cParams
argument_list|)
argument_list|)
expr_stmt|;
return|return
sizeof|sizeof
argument_list|(
name|ZSTD_CDict
argument_list|)
operator|+
name|ZSTD_estimateCCtxSize_usingCParams
argument_list|(
name|cParams
argument_list|)
operator|+
operator|(
name|dictLoadMethod
operator|==
name|ZSTD_dlm_byRef
condition|?
literal|0
else|:
name|dictSize
operator|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_estimateCDictSize
parameter_list|(
name|size_t
name|dictSize
parameter_list|,
name|int
name|compressionLevel
parameter_list|)
block|{
name|ZSTD_compressionParameters
specifier|const
name|cParams
init|=
name|ZSTD_getCParams
argument_list|(
name|compressionLevel
argument_list|,
literal|0
argument_list|,
name|dictSize
argument_list|)
decl_stmt|;
return|return
name|ZSTD_estimateCDictSize_advanced
argument_list|(
name|dictSize
argument_list|,
name|cParams
argument_list|,
name|ZSTD_dlm_byCopy
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_sizeof_CDict
parameter_list|(
specifier|const
name|ZSTD_CDict
modifier|*
name|cdict
parameter_list|)
block|{
if|if
condition|(
name|cdict
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
comment|/* support sizeof on NULL */
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"sizeof(*cdict) : %u"
argument_list|,
operator|(
name|U32
operator|)
sizeof|sizeof
argument_list|(
operator|*
name|cdict
argument_list|)
argument_list|)
expr_stmt|;
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"ZSTD_sizeof_CCtx : %u"
argument_list|,
operator|(
name|U32
operator|)
name|ZSTD_sizeof_CCtx
argument_list|(
name|cdict
operator|->
name|refContext
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ZSTD_sizeof_CCtx
argument_list|(
name|cdict
operator|->
name|refContext
argument_list|)
operator|+
operator|(
name|cdict
operator|->
name|dictBuffer
condition|?
name|cdict
operator|->
name|dictContentSize
else|:
literal|0
operator|)
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|cdict
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|size_t
name|ZSTD_initCDict_internal
parameter_list|(
name|ZSTD_CDict
modifier|*
name|cdict
parameter_list|,
specifier|const
name|void
modifier|*
name|dictBuffer
parameter_list|,
name|size_t
name|dictSize
parameter_list|,
name|ZSTD_dictLoadMethod_e
name|dictLoadMethod
parameter_list|,
name|ZSTD_dictMode_e
name|dictMode
parameter_list|,
name|ZSTD_compressionParameters
name|cParams
parameter_list|)
block|{
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"ZSTD_initCDict_internal, mode %u"
argument_list|,
operator|(
name|U32
operator|)
name|dictMode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dictLoadMethod
operator|==
name|ZSTD_dlm_byRef
operator|)
operator|||
operator|(
operator|!
name|dictBuffer
operator|)
operator|||
operator|(
operator|!
name|dictSize
operator|)
condition|)
block|{
name|cdict
operator|->
name|dictBuffer
operator|=
name|NULL
expr_stmt|;
name|cdict
operator|->
name|dictContent
operator|=
name|dictBuffer
expr_stmt|;
block|}
else|else
block|{
name|void
modifier|*
specifier|const
name|internalBuffer
init|=
name|ZSTD_malloc
argument_list|(
name|dictSize
argument_list|,
name|cdict
operator|->
name|refContext
operator|->
name|customMem
argument_list|)
decl_stmt|;
name|cdict
operator|->
name|dictBuffer
operator|=
name|internalBuffer
expr_stmt|;
name|cdict
operator|->
name|dictContent
operator|=
name|internalBuffer
expr_stmt|;
if|if
condition|(
operator|!
name|internalBuffer
condition|)
return|return
name|ERROR
argument_list|(
name|memory_allocation
argument_list|)
return|;
name|memcpy
argument_list|(
name|internalBuffer
argument_list|,
name|dictBuffer
argument_list|,
name|dictSize
argument_list|)
expr_stmt|;
block|}
name|cdict
operator|->
name|dictContentSize
operator|=
name|dictSize
expr_stmt|;
block|{
name|ZSTD_CCtx_params
name|cctxParams
init|=
name|cdict
operator|->
name|refContext
operator|->
name|requestedParams
decl_stmt|;
name|cctxParams
operator|.
name|cParams
operator|=
name|cParams
expr_stmt|;
name|CHECK_F
argument_list|(
name|ZSTD_compressBegin_internal
argument_list|(
name|cdict
operator|->
name|refContext
argument_list|,
name|cdict
operator|->
name|dictContent
argument_list|,
name|dictSize
argument_list|,
name|dictMode
argument_list|,
name|NULL
argument_list|,
name|cctxParams
argument_list|,
name|ZSTD_CONTENTSIZE_UNKNOWN
argument_list|,
name|ZSTDb_not_buffered
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|ZSTD_CDict
modifier|*
name|ZSTD_createCDict_advanced
parameter_list|(
specifier|const
name|void
modifier|*
name|dictBuffer
parameter_list|,
name|size_t
name|dictSize
parameter_list|,
name|ZSTD_dictLoadMethod_e
name|dictLoadMethod
parameter_list|,
name|ZSTD_dictMode_e
name|dictMode
parameter_list|,
name|ZSTD_compressionParameters
name|cParams
parameter_list|,
name|ZSTD_customMem
name|customMem
parameter_list|)
block|{
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"ZSTD_createCDict_advanced, mode %u"
argument_list|,
operator|(
name|U32
operator|)
name|dictMode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|customMem
operator|.
name|customAlloc
operator|^
operator|!
name|customMem
operator|.
name|customFree
condition|)
return|return
name|NULL
return|;
block|{
name|ZSTD_CDict
modifier|*
specifier|const
name|cdict
init|=
operator|(
name|ZSTD_CDict
operator|*
operator|)
name|ZSTD_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|ZSTD_CDict
argument_list|)
argument_list|,
name|customMem
argument_list|)
decl_stmt|;
name|ZSTD_CCtx
modifier|*
specifier|const
name|cctx
init|=
name|ZSTD_createCCtx_advanced
argument_list|(
name|customMem
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|cdict
operator|||
operator|!
name|cctx
condition|)
block|{
name|ZSTD_free
argument_list|(
name|cdict
argument_list|,
name|customMem
argument_list|)
expr_stmt|;
name|ZSTD_freeCCtx
argument_list|(
name|cctx
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|cdict
operator|->
name|refContext
operator|=
name|cctx
expr_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|ZSTD_initCDict_internal
argument_list|(
name|cdict
argument_list|,
name|dictBuffer
argument_list|,
name|dictSize
argument_list|,
name|dictLoadMethod
argument_list|,
name|dictMode
argument_list|,
name|cParams
argument_list|)
argument_list|)
condition|)
block|{
name|ZSTD_freeCDict
argument_list|(
name|cdict
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|cdict
return|;
block|}
block|}
end_function

begin_function
name|ZSTD_CDict
modifier|*
name|ZSTD_createCDict
parameter_list|(
specifier|const
name|void
modifier|*
name|dict
parameter_list|,
name|size_t
name|dictSize
parameter_list|,
name|int
name|compressionLevel
parameter_list|)
block|{
name|ZSTD_compressionParameters
name|cParams
init|=
name|ZSTD_getCParams
argument_list|(
name|compressionLevel
argument_list|,
literal|0
argument_list|,
name|dictSize
argument_list|)
decl_stmt|;
return|return
name|ZSTD_createCDict_advanced
argument_list|(
name|dict
argument_list|,
name|dictSize
argument_list|,
name|ZSTD_dlm_byCopy
argument_list|,
name|ZSTD_dm_auto
argument_list|,
name|cParams
argument_list|,
name|ZSTD_defaultCMem
argument_list|)
return|;
block|}
end_function

begin_function
name|ZSTD_CDict
modifier|*
name|ZSTD_createCDict_byReference
parameter_list|(
specifier|const
name|void
modifier|*
name|dict
parameter_list|,
name|size_t
name|dictSize
parameter_list|,
name|int
name|compressionLevel
parameter_list|)
block|{
name|ZSTD_compressionParameters
name|cParams
init|=
name|ZSTD_getCParams
argument_list|(
name|compressionLevel
argument_list|,
literal|0
argument_list|,
name|dictSize
argument_list|)
decl_stmt|;
return|return
name|ZSTD_createCDict_advanced
argument_list|(
name|dict
argument_list|,
name|dictSize
argument_list|,
name|ZSTD_dlm_byRef
argument_list|,
name|ZSTD_dm_auto
argument_list|,
name|cParams
argument_list|,
name|ZSTD_defaultCMem
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_freeCDict
parameter_list|(
name|ZSTD_CDict
modifier|*
name|cdict
parameter_list|)
block|{
if|if
condition|(
name|cdict
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
comment|/* support free on NULL */
block|{
name|ZSTD_customMem
specifier|const
name|cMem
init|=
name|cdict
operator|->
name|refContext
operator|->
name|customMem
decl_stmt|;
name|ZSTD_freeCCtx
argument_list|(
name|cdict
operator|->
name|refContext
argument_list|)
expr_stmt|;
name|ZSTD_free
argument_list|(
name|cdict
operator|->
name|dictBuffer
argument_list|,
name|cMem
argument_list|)
expr_stmt|;
name|ZSTD_free
argument_list|(
name|cdict
argument_list|,
name|cMem
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
end_function

begin_comment
comment|/*! ZSTD_initStaticCDict_advanced() :  *  Generate a digested dictionary in provided memory area.  *  workspace: The memory area to emplace the dictionary into.  *             Provided pointer must 8-bytes aligned.  *             It must outlive dictionary usage.  *  workspaceSize: Use ZSTD_estimateCDictSize()  *                 to determine how large workspace must be.  *  cParams : use ZSTD_getCParams() to transform a compression level  *            into its relevants cParams.  * @return : pointer to ZSTD_CDict*, or NULL if error (size too small)  *  Note : there is no corresponding "free" function.  *         Since workspace was allocated externally, it must be freed externally.  */
end_comment

begin_function
name|ZSTD_CDict
modifier|*
name|ZSTD_initStaticCDict
parameter_list|(
name|void
modifier|*
name|workspace
parameter_list|,
name|size_t
name|workspaceSize
parameter_list|,
specifier|const
name|void
modifier|*
name|dict
parameter_list|,
name|size_t
name|dictSize
parameter_list|,
name|ZSTD_dictLoadMethod_e
name|dictLoadMethod
parameter_list|,
name|ZSTD_dictMode_e
name|dictMode
parameter_list|,
name|ZSTD_compressionParameters
name|cParams
parameter_list|)
block|{
name|size_t
specifier|const
name|cctxSize
init|=
name|ZSTD_estimateCCtxSize_usingCParams
argument_list|(
name|cParams
argument_list|)
decl_stmt|;
name|size_t
specifier|const
name|neededSize
init|=
sizeof|sizeof
argument_list|(
name|ZSTD_CDict
argument_list|)
operator|+
operator|(
name|dictLoadMethod
operator|==
name|ZSTD_dlm_byRef
condition|?
literal|0
else|:
name|dictSize
operator|)
operator|+
name|cctxSize
decl_stmt|;
name|ZSTD_CDict
modifier|*
specifier|const
name|cdict
init|=
operator|(
name|ZSTD_CDict
operator|*
operator|)
name|workspace
decl_stmt|;
name|void
modifier|*
name|ptr
decl_stmt|;
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"(size_t)workspace& 7 : %u"
argument_list|,
operator|(
name|U32
operator|)
operator|(
name|size_t
operator|)
name|workspace
operator|&
literal|7
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|size_t
operator|)
name|workspace
operator|&
literal|7
condition|)
return|return
name|NULL
return|;
comment|/* 8-aligned */
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"(workspaceSize< neededSize) : (%u< %u) => %u"
argument_list|,
operator|(
name|U32
operator|)
name|workspaceSize
argument_list|,
operator|(
name|U32
operator|)
name|neededSize
argument_list|,
call|(
name|U32
call|)
argument_list|(
name|workspaceSize
operator|<
name|neededSize
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|workspaceSize
operator|<
name|neededSize
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|dictLoadMethod
operator|==
name|ZSTD_dlm_byCopy
condition|)
block|{
name|memcpy
argument_list|(
name|cdict
operator|+
literal|1
argument_list|,
name|dict
argument_list|,
name|dictSize
argument_list|)
expr_stmt|;
name|dict
operator|=
name|cdict
operator|+
literal|1
expr_stmt|;
name|ptr
operator|=
operator|(
name|char
operator|*
operator|)
name|workspace
operator|+
sizeof|sizeof
argument_list|(
name|ZSTD_CDict
argument_list|)
operator|+
name|dictSize
expr_stmt|;
block|}
else|else
block|{
name|ptr
operator|=
name|cdict
operator|+
literal|1
expr_stmt|;
block|}
name|cdict
operator|->
name|refContext
operator|=
name|ZSTD_initStaticCCtx
argument_list|(
name|ptr
argument_list|,
name|cctxSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|ZSTD_initCDict_internal
argument_list|(
name|cdict
argument_list|,
name|dict
argument_list|,
name|dictSize
argument_list|,
name|ZSTD_dlm_byRef
argument_list|,
name|dictMode
argument_list|,
name|cParams
argument_list|)
argument_list|)
condition|)
return|return
name|NULL
return|;
return|return
name|cdict
return|;
block|}
end_function

begin_function
name|ZSTD_compressionParameters
name|ZSTD_getCParamsFromCDict
parameter_list|(
specifier|const
name|ZSTD_CDict
modifier|*
name|cdict
parameter_list|)
block|{
return|return
name|cdict
operator|->
name|refContext
operator|->
name|appliedParams
operator|.
name|cParams
return|;
block|}
end_function

begin_comment
comment|/* ZSTD_compressBegin_usingCDict_advanced() :  * cdict must be != NULL */
end_comment

begin_function
name|size_t
name|ZSTD_compressBegin_usingCDict_advanced
parameter_list|(
name|ZSTD_CCtx
modifier|*
specifier|const
name|cctx
parameter_list|,
specifier|const
name|ZSTD_CDict
modifier|*
specifier|const
name|cdict
parameter_list|,
name|ZSTD_frameParameters
specifier|const
name|fParams
parameter_list|,
name|unsigned
name|long
name|long
specifier|const
name|pledgedSrcSize
parameter_list|)
block|{
if|if
condition|(
name|cdict
operator|==
name|NULL
condition|)
return|return
name|ERROR
argument_list|(
name|dictionary_wrong
argument_list|)
return|;
block|{
name|ZSTD_CCtx_params
name|params
init|=
name|cctx
operator|->
name|requestedParams
decl_stmt|;
name|params
operator|.
name|cParams
operator|=
name|ZSTD_getCParamsFromCDict
argument_list|(
name|cdict
argument_list|)
expr_stmt|;
name|params
operator|.
name|fParams
operator|=
name|fParams
expr_stmt|;
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"ZSTD_compressBegin_usingCDict_advanced"
argument_list|)
expr_stmt|;
return|return
name|ZSTD_compressBegin_internal
argument_list|(
name|cctx
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|ZSTD_dm_auto
argument_list|,
name|cdict
argument_list|,
name|params
argument_list|,
name|pledgedSrcSize
argument_list|,
name|ZSTDb_not_buffered
argument_list|)
return|;
block|}
block|}
end_function

begin_comment
comment|/* ZSTD_compressBegin_usingCDict() :  * pledgedSrcSize=0 means "unknown"  * if pledgedSrcSize>0, it will enable contentSizeFlag */
end_comment

begin_function
name|size_t
name|ZSTD_compressBegin_usingCDict
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
specifier|const
name|ZSTD_CDict
modifier|*
name|cdict
parameter_list|)
block|{
name|ZSTD_frameParameters
specifier|const
name|fParams
init|=
block|{
literal|0
comment|/*content*/
block|,
literal|0
comment|/*checksum*/
block|,
literal|0
comment|/*noDictID*/
block|}
decl_stmt|;
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"ZSTD_compressBegin_usingCDict : dictIDFlag == %u"
argument_list|,
operator|!
name|fParams
operator|.
name|noDictIDFlag
argument_list|)
expr_stmt|;
return|return
name|ZSTD_compressBegin_usingCDict_advanced
argument_list|(
name|cctx
argument_list|,
name|cdict
argument_list|,
name|fParams
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_compress_usingCDict_advanced
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstCapacity
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|,
specifier|const
name|ZSTD_CDict
modifier|*
name|cdict
parameter_list|,
name|ZSTD_frameParameters
name|fParams
parameter_list|)
block|{
name|CHECK_F
argument_list|(
name|ZSTD_compressBegin_usingCDict_advanced
argument_list|(
name|cctx
argument_list|,
name|cdict
argument_list|,
name|fParams
argument_list|,
name|srcSize
argument_list|)
argument_list|)
expr_stmt|;
comment|/* will check if cdict != NULL */
return|return
name|ZSTD_compressEnd
argument_list|(
name|cctx
argument_list|,
name|dst
argument_list|,
name|dstCapacity
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*! ZSTD_compress_usingCDict() :  *  Compression using a digested Dictionary.  *  Faster startup than ZSTD_compress_usingDict(), recommended when same dictionary is used multiple times.  *  Note that compression parameters are decided at CDict creation time  *  while frame parameters are hardcoded */
end_comment

begin_function
name|size_t
name|ZSTD_compress_usingCDict
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstCapacity
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|,
specifier|const
name|ZSTD_CDict
modifier|*
name|cdict
parameter_list|)
block|{
name|ZSTD_frameParameters
specifier|const
name|fParams
init|=
block|{
literal|1
comment|/*content*/
block|,
literal|0
comment|/*checksum*/
block|,
literal|0
comment|/*noDictID*/
block|}
decl_stmt|;
return|return
name|ZSTD_compress_usingCDict_advanced
argument_list|(
name|cctx
argument_list|,
name|dst
argument_list|,
name|dstCapacity
argument_list|,
name|src
argument_list|,
name|srcSize
argument_list|,
name|cdict
argument_list|,
name|fParams
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ****************************************************************** *  Streaming ********************************************************************/
end_comment

begin_function
name|ZSTD_CStream
modifier|*
name|ZSTD_createCStream
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|ZSTD_createCStream_advanced
argument_list|(
name|ZSTD_defaultCMem
argument_list|)
return|;
block|}
end_function

begin_function
name|ZSTD_CStream
modifier|*
name|ZSTD_initStaticCStream
parameter_list|(
name|void
modifier|*
name|workspace
parameter_list|,
name|size_t
name|workspaceSize
parameter_list|)
block|{
return|return
name|ZSTD_initStaticCCtx
argument_list|(
name|workspace
argument_list|,
name|workspaceSize
argument_list|)
return|;
block|}
end_function

begin_function
name|ZSTD_CStream
modifier|*
name|ZSTD_createCStream_advanced
parameter_list|(
name|ZSTD_customMem
name|customMem
parameter_list|)
block|{
comment|/* CStream and CCtx are now same object */
return|return
name|ZSTD_createCCtx_advanced
argument_list|(
name|customMem
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_freeCStream
parameter_list|(
name|ZSTD_CStream
modifier|*
name|zcs
parameter_list|)
block|{
return|return
name|ZSTD_freeCCtx
argument_list|(
name|zcs
argument_list|)
return|;
comment|/* same object */
block|}
end_function

begin_comment
comment|/*======   Initialization   ======*/
end_comment

begin_function
name|size_t
name|ZSTD_CStreamInSize
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|ZSTD_BLOCKSIZE_MAX
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_CStreamOutSize
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|ZSTD_compressBound
argument_list|(
name|ZSTD_BLOCKSIZE_MAX
argument_list|)
operator|+
name|ZSTD_blockHeaderSize
operator|+
literal|4
comment|/* 32-bits hash */
return|;
block|}
end_function

begin_function
specifier|static
name|size_t
name|ZSTD_resetCStream_internal
parameter_list|(
name|ZSTD_CStream
modifier|*
name|zcs
parameter_list|,
specifier|const
name|void
modifier|*
name|dict
parameter_list|,
name|size_t
name|dictSize
parameter_list|,
name|ZSTD_dictMode_e
name|dictMode
parameter_list|,
specifier|const
name|ZSTD_CDict
modifier|*
name|cdict
parameter_list|,
specifier|const
name|ZSTD_CCtx_params
name|params
parameter_list|,
name|unsigned
name|long
name|long
name|pledgedSrcSize
parameter_list|)
block|{
name|DEBUGLOG
argument_list|(
literal|4
argument_list|,
literal|"ZSTD_resetCStream_internal"
argument_list|)
expr_stmt|;
comment|/* params are supposed to be fully validated at this point */
name|assert
argument_list|(
operator|!
name|ZSTD_isError
argument_list|(
name|ZSTD_checkCParams
argument_list|(
name|params
operator|.
name|cParams
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|!
operator|(
operator|(
name|dict
operator|)
operator|&&
operator|(
name|cdict
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|/* either dict or cdict, not both */
name|CHECK_F
argument_list|(
name|ZSTD_compressBegin_internal
argument_list|(
name|zcs
argument_list|,
name|dict
argument_list|,
name|dictSize
argument_list|,
name|dictMode
argument_list|,
name|cdict
argument_list|,
name|params
argument_list|,
name|pledgedSrcSize
argument_list|,
name|ZSTDb_buffered
argument_list|)
argument_list|)
expr_stmt|;
name|zcs
operator|->
name|inToCompress
operator|=
literal|0
expr_stmt|;
name|zcs
operator|->
name|inBuffPos
operator|=
literal|0
expr_stmt|;
name|zcs
operator|->
name|inBuffTarget
operator|=
name|zcs
operator|->
name|blockSize
expr_stmt|;
name|zcs
operator|->
name|outBuffContentSize
operator|=
name|zcs
operator|->
name|outBuffFlushedSize
operator|=
literal|0
expr_stmt|;
name|zcs
operator|->
name|streamStage
operator|=
name|zcss_load
expr_stmt|;
name|zcs
operator|->
name|frameEnded
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
comment|/* ready to go */
block|}
end_function

begin_function
name|size_t
name|ZSTD_resetCStream
parameter_list|(
name|ZSTD_CStream
modifier|*
name|zcs
parameter_list|,
name|unsigned
name|long
name|long
name|pledgedSrcSize
parameter_list|)
block|{
name|ZSTD_CCtx_params
name|params
init|=
name|zcs
operator|->
name|requestedParams
decl_stmt|;
name|params
operator|.
name|fParams
operator|.
name|contentSizeFlag
operator|=
operator|(
name|pledgedSrcSize
operator|>
literal|0
operator|)
expr_stmt|;
name|params
operator|.
name|cParams
operator|=
name|ZSTD_getCParamsFromCCtxParams
argument_list|(
name|params
argument_list|,
name|pledgedSrcSize
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DEBUGLOG
argument_list|(
literal|4
argument_list|,
literal|"ZSTD_resetCStream"
argument_list|)
expr_stmt|;
return|return
name|ZSTD_resetCStream_internal
argument_list|(
name|zcs
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|ZSTD_dm_auto
argument_list|,
name|zcs
operator|->
name|cdict
argument_list|,
name|params
argument_list|,
name|pledgedSrcSize
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*! ZSTD_initCStream_internal() :  *  Note : not static, but hidden (not exposed). Used by zstdmt_compress.c  *  Assumption 1 : params are valid  *  Assumption 2 : either dict, or cdict, is defined, not both */
end_comment

begin_function
name|size_t
name|ZSTD_initCStream_internal
parameter_list|(
name|ZSTD_CStream
modifier|*
name|zcs
parameter_list|,
specifier|const
name|void
modifier|*
name|dict
parameter_list|,
name|size_t
name|dictSize
parameter_list|,
specifier|const
name|ZSTD_CDict
modifier|*
name|cdict
parameter_list|,
name|ZSTD_CCtx_params
name|params
parameter_list|,
name|unsigned
name|long
name|long
name|pledgedSrcSize
parameter_list|)
block|{
name|DEBUGLOG
argument_list|(
literal|4
argument_list|,
literal|"ZSTD_initCStream_internal"
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|!
name|ZSTD_isError
argument_list|(
name|ZSTD_checkCParams
argument_list|(
name|params
operator|.
name|cParams
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|assert
argument_list|(
operator|!
operator|(
operator|(
name|dict
operator|)
operator|&&
operator|(
name|cdict
operator|)
operator|)
argument_list|)
expr_stmt|;
comment|/* either dict or cdict, not both */
if|if
condition|(
name|dict
operator|&&
name|dictSize
operator|>=
literal|8
condition|)
block|{
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"loading dictionary of size %u"
argument_list|,
operator|(
name|U32
operator|)
name|dictSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|zcs
operator|->
name|staticSize
condition|)
block|{
comment|/* static CCtx : never uses malloc */
comment|/* incompatible with internal cdict creation */
return|return
name|ERROR
argument_list|(
name|memory_allocation
argument_list|)
return|;
block|}
name|ZSTD_freeCDict
argument_list|(
name|zcs
operator|->
name|cdictLocal
argument_list|)
expr_stmt|;
name|zcs
operator|->
name|cdictLocal
operator|=
name|ZSTD_createCDict_advanced
argument_list|(
name|dict
argument_list|,
name|dictSize
argument_list|,
name|ZSTD_dlm_byCopy
argument_list|,
name|ZSTD_dm_auto
argument_list|,
name|params
operator|.
name|cParams
argument_list|,
name|zcs
operator|->
name|customMem
argument_list|)
expr_stmt|;
name|zcs
operator|->
name|cdict
operator|=
name|zcs
operator|->
name|cdictLocal
expr_stmt|;
if|if
condition|(
name|zcs
operator|->
name|cdictLocal
operator|==
name|NULL
condition|)
return|return
name|ERROR
argument_list|(
name|memory_allocation
argument_list|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|cdict
condition|)
block|{
name|params
operator|.
name|cParams
operator|=
name|ZSTD_getCParamsFromCDict
argument_list|(
name|cdict
argument_list|)
expr_stmt|;
comment|/* cParams are enforced from cdict */
block|}
name|ZSTD_freeCDict
argument_list|(
name|zcs
operator|->
name|cdictLocal
argument_list|)
expr_stmt|;
name|zcs
operator|->
name|cdictLocal
operator|=
name|NULL
expr_stmt|;
name|zcs
operator|->
name|cdict
operator|=
name|cdict
expr_stmt|;
block|}
name|params
operator|.
name|compressionLevel
operator|=
name|ZSTD_CLEVEL_CUSTOM
expr_stmt|;
name|zcs
operator|->
name|requestedParams
operator|=
name|params
expr_stmt|;
return|return
name|ZSTD_resetCStream_internal
argument_list|(
name|zcs
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|ZSTD_dm_auto
argument_list|,
name|zcs
operator|->
name|cdict
argument_list|,
name|params
argument_list|,
name|pledgedSrcSize
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ZSTD_initCStream_usingCDict_advanced() :  * same as ZSTD_initCStream_usingCDict(), with control over frame parameters */
end_comment

begin_function
name|size_t
name|ZSTD_initCStream_usingCDict_advanced
parameter_list|(
name|ZSTD_CStream
modifier|*
name|zcs
parameter_list|,
specifier|const
name|ZSTD_CDict
modifier|*
name|cdict
parameter_list|,
name|ZSTD_frameParameters
name|fParams
parameter_list|,
name|unsigned
name|long
name|long
name|pledgedSrcSize
parameter_list|)
block|{
comment|/* cannot handle NULL cdict (does not know what to do) */
if|if
condition|(
operator|!
name|cdict
condition|)
return|return
name|ERROR
argument_list|(
name|dictionary_wrong
argument_list|)
return|;
block|{
name|ZSTD_CCtx_params
name|params
init|=
name|zcs
operator|->
name|requestedParams
decl_stmt|;
name|params
operator|.
name|cParams
operator|=
name|ZSTD_getCParamsFromCDict
argument_list|(
name|cdict
argument_list|)
expr_stmt|;
name|params
operator|.
name|fParams
operator|=
name|fParams
expr_stmt|;
return|return
name|ZSTD_initCStream_internal
argument_list|(
name|zcs
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|cdict
argument_list|,
name|params
argument_list|,
name|pledgedSrcSize
argument_list|)
return|;
block|}
block|}
end_function

begin_comment
comment|/* note : cdict must outlive compression session */
end_comment

begin_function
name|size_t
name|ZSTD_initCStream_usingCDict
parameter_list|(
name|ZSTD_CStream
modifier|*
name|zcs
parameter_list|,
specifier|const
name|ZSTD_CDict
modifier|*
name|cdict
parameter_list|)
block|{
name|ZSTD_frameParameters
specifier|const
name|fParams
init|=
block|{
literal|0
comment|/* contentSize */
block|,
literal|0
comment|/* checksum */
block|,
literal|0
comment|/* hideDictID */
block|}
decl_stmt|;
return|return
name|ZSTD_initCStream_usingCDict_advanced
argument_list|(
name|zcs
argument_list|,
name|cdict
argument_list|,
name|fParams
argument_list|,
literal|0
argument_list|)
return|;
comment|/* note : will check that cdict != NULL */
block|}
end_function

begin_function
name|size_t
name|ZSTD_initCStream_advanced
parameter_list|(
name|ZSTD_CStream
modifier|*
name|zcs
parameter_list|,
specifier|const
name|void
modifier|*
name|dict
parameter_list|,
name|size_t
name|dictSize
parameter_list|,
name|ZSTD_parameters
name|params
parameter_list|,
name|unsigned
name|long
name|long
name|pledgedSrcSize
parameter_list|)
block|{
name|ZSTD_CCtx_params
specifier|const
name|cctxParams
init|=
name|ZSTD_assignParamsToCCtxParams
argument_list|(
name|zcs
operator|->
name|requestedParams
argument_list|,
name|params
argument_list|)
decl_stmt|;
name|CHECK_F
argument_list|(
name|ZSTD_checkCParams
argument_list|(
name|params
operator|.
name|cParams
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ZSTD_initCStream_internal
argument_list|(
name|zcs
argument_list|,
name|dict
argument_list|,
name|dictSize
argument_list|,
name|NULL
argument_list|,
name|cctxParams
argument_list|,
name|pledgedSrcSize
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_initCStream_usingDict
parameter_list|(
name|ZSTD_CStream
modifier|*
name|zcs
parameter_list|,
specifier|const
name|void
modifier|*
name|dict
parameter_list|,
name|size_t
name|dictSize
parameter_list|,
name|int
name|compressionLevel
parameter_list|)
block|{
name|ZSTD_parameters
specifier|const
name|params
init|=
name|ZSTD_getParams
argument_list|(
name|compressionLevel
argument_list|,
literal|0
argument_list|,
name|dictSize
argument_list|)
decl_stmt|;
name|ZSTD_CCtx_params
specifier|const
name|cctxParams
init|=
name|ZSTD_assignParamsToCCtxParams
argument_list|(
name|zcs
operator|->
name|requestedParams
argument_list|,
name|params
argument_list|)
decl_stmt|;
return|return
name|ZSTD_initCStream_internal
argument_list|(
name|zcs
argument_list|,
name|dict
argument_list|,
name|dictSize
argument_list|,
name|NULL
argument_list|,
name|cctxParams
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_initCStream_srcSize
parameter_list|(
name|ZSTD_CStream
modifier|*
name|zcs
parameter_list|,
name|int
name|compressionLevel
parameter_list|,
name|unsigned
name|long
name|long
name|pledgedSrcSize
parameter_list|)
block|{
name|ZSTD_CCtx_params
name|cctxParams
decl_stmt|;
name|ZSTD_parameters
specifier|const
name|params
init|=
name|ZSTD_getParams
argument_list|(
name|compressionLevel
argument_list|,
name|pledgedSrcSize
argument_list|,
literal|0
argument_list|)
decl_stmt|;
name|cctxParams
operator|=
name|ZSTD_assignParamsToCCtxParams
argument_list|(
name|zcs
operator|->
name|requestedParams
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|cctxParams
operator|.
name|fParams
operator|.
name|contentSizeFlag
operator|=
operator|(
name|pledgedSrcSize
operator|>
literal|0
operator|)
expr_stmt|;
return|return
name|ZSTD_initCStream_internal
argument_list|(
name|zcs
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|cctxParams
argument_list|,
name|pledgedSrcSize
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_initCStream
parameter_list|(
name|ZSTD_CStream
modifier|*
name|zcs
parameter_list|,
name|int
name|compressionLevel
parameter_list|)
block|{
return|return
name|ZSTD_initCStream_srcSize
argument_list|(
name|zcs
argument_list|,
name|compressionLevel
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*======   Compression   ======*/
end_comment

begin_function
name|MEM_STATIC
name|size_t
name|ZSTD_limitCopy
parameter_list|(
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstCapacity
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|)
block|{
name|size_t
specifier|const
name|length
init|=
name|MIN
argument_list|(
name|dstCapacity
argument_list|,
name|srcSize
argument_list|)
decl_stmt|;
if|if
condition|(
name|length
condition|)
name|memcpy
argument_list|(
name|dst
argument_list|,
name|src
argument_list|,
name|length
argument_list|)
expr_stmt|;
return|return
name|length
return|;
block|}
end_function

begin_comment
comment|/** ZSTD_compressStream_generic():  *  internal function for all *compressStream*() variants and *compress_generic()  *  non-static, because can be called from zstdmt.c  * @return : hint size for next input */
end_comment

begin_function
name|size_t
name|ZSTD_compressStream_generic
parameter_list|(
name|ZSTD_CStream
modifier|*
name|zcs
parameter_list|,
name|ZSTD_outBuffer
modifier|*
name|output
parameter_list|,
name|ZSTD_inBuffer
modifier|*
name|input
parameter_list|,
name|ZSTD_EndDirective
specifier|const
name|flushMode
parameter_list|)
block|{
specifier|const
name|char
modifier|*
specifier|const
name|istart
init|=
operator|(
specifier|const
name|char
operator|*
operator|)
name|input
operator|->
name|src
decl_stmt|;
specifier|const
name|char
modifier|*
specifier|const
name|iend
init|=
name|istart
operator|+
name|input
operator|->
name|size
decl_stmt|;
specifier|const
name|char
modifier|*
name|ip
init|=
name|istart
operator|+
name|input
operator|->
name|pos
decl_stmt|;
name|char
modifier|*
specifier|const
name|ostart
init|=
operator|(
name|char
operator|*
operator|)
name|output
operator|->
name|dst
decl_stmt|;
name|char
modifier|*
specifier|const
name|oend
init|=
name|ostart
operator|+
name|output
operator|->
name|size
decl_stmt|;
name|char
modifier|*
name|op
init|=
name|ostart
operator|+
name|output
operator|->
name|pos
decl_stmt|;
name|U32
name|someMoreWork
init|=
literal|1
decl_stmt|;
comment|/* check expectations */
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"ZSTD_compressStream_generic, flush=%u"
argument_list|,
operator|(
name|U32
operator|)
name|flushMode
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|zcs
operator|->
name|inBuff
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|zcs
operator|->
name|inBuffSize
operator|>
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|zcs
operator|->
name|outBuff
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|zcs
operator|->
name|outBuffSize
operator|>
literal|0
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|output
operator|->
name|pos
operator|<=
name|output
operator|->
name|size
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|input
operator|->
name|pos
operator|<=
name|input
operator|->
name|size
argument_list|)
expr_stmt|;
while|while
condition|(
name|someMoreWork
condition|)
block|{
switch|switch
condition|(
name|zcs
operator|->
name|streamStage
condition|)
block|{
case|case
name|zcss_init
case|:
comment|/* call ZSTD_initCStream() first ! */
return|return
name|ERROR
argument_list|(
name|init_missing
argument_list|)
return|;
case|case
name|zcss_load
case|:
if|if
condition|(
operator|(
name|flushMode
operator|==
name|ZSTD_e_end
operator|)
operator|&&
operator|(
call|(
name|size_t
call|)
argument_list|(
name|oend
operator|-
name|op
argument_list|)
operator|>=
name|ZSTD_compressBound
argument_list|(
name|iend
operator|-
name|ip
argument_list|)
operator|)
comment|/* enough dstCapacity */
operator|&&
operator|(
name|zcs
operator|->
name|inBuffPos
operator|==
literal|0
operator|)
condition|)
block|{
comment|/* shortcut to compression pass directly into output buffer */
name|size_t
specifier|const
name|cSize
init|=
name|ZSTD_compressEnd
argument_list|(
name|zcs
argument_list|,
name|op
argument_list|,
name|oend
operator|-
name|op
argument_list|,
name|ip
argument_list|,
name|iend
operator|-
name|ip
argument_list|)
decl_stmt|;
name|DEBUGLOG
argument_list|(
literal|4
argument_list|,
literal|"ZSTD_compressEnd : %u"
argument_list|,
operator|(
name|U32
operator|)
name|cSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|cSize
argument_list|)
condition|)
return|return
name|cSize
return|;
name|ip
operator|=
name|iend
expr_stmt|;
name|op
operator|+=
name|cSize
expr_stmt|;
name|zcs
operator|->
name|frameEnded
operator|=
literal|1
expr_stmt|;
name|ZSTD_startNewCompression
argument_list|(
name|zcs
argument_list|)
expr_stmt|;
name|someMoreWork
operator|=
literal|0
expr_stmt|;
break|break;
block|}
comment|/* complete loading into inBuffer */
block|{
name|size_t
specifier|const
name|toLoad
init|=
name|zcs
operator|->
name|inBuffTarget
operator|-
name|zcs
operator|->
name|inBuffPos
decl_stmt|;
name|size_t
specifier|const
name|loaded
init|=
name|ZSTD_limitCopy
argument_list|(
name|zcs
operator|->
name|inBuff
operator|+
name|zcs
operator|->
name|inBuffPos
argument_list|,
name|toLoad
argument_list|,
name|ip
argument_list|,
name|iend
operator|-
name|ip
argument_list|)
decl_stmt|;
name|zcs
operator|->
name|inBuffPos
operator|+=
name|loaded
expr_stmt|;
name|ip
operator|+=
name|loaded
expr_stmt|;
if|if
condition|(
operator|(
name|flushMode
operator|==
name|ZSTD_e_continue
operator|)
operator|&&
operator|(
name|zcs
operator|->
name|inBuffPos
operator|<
name|zcs
operator|->
name|inBuffTarget
operator|)
condition|)
block|{
comment|/* not enough input to fill full block : stop here */
name|someMoreWork
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|flushMode
operator|==
name|ZSTD_e_flush
operator|)
operator|&&
operator|(
name|zcs
operator|->
name|inBuffPos
operator|==
name|zcs
operator|->
name|inToCompress
operator|)
condition|)
block|{
comment|/* empty */
name|someMoreWork
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
comment|/* compress current block (note : this stage cannot be stopped in the middle) */
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"stream compression stage (flushMode==%u)"
argument_list|,
name|flushMode
argument_list|)
expr_stmt|;
block|{
name|void
modifier|*
name|cDst
decl_stmt|;
name|size_t
name|cSize
decl_stmt|;
name|size_t
specifier|const
name|iSize
init|=
name|zcs
operator|->
name|inBuffPos
operator|-
name|zcs
operator|->
name|inToCompress
decl_stmt|;
name|size_t
name|oSize
init|=
name|oend
operator|-
name|op
decl_stmt|;
name|unsigned
specifier|const
name|lastBlock
init|=
operator|(
name|flushMode
operator|==
name|ZSTD_e_end
operator|)
operator|&&
operator|(
name|ip
operator|==
name|iend
operator|)
decl_stmt|;
if|if
condition|(
name|oSize
operator|>=
name|ZSTD_compressBound
argument_list|(
name|iSize
argument_list|)
condition|)
name|cDst
operator|=
name|op
expr_stmt|;
comment|/* compress into output buffer, to skip flush stage */
else|else
name|cDst
operator|=
name|zcs
operator|->
name|outBuff
operator|,
name|oSize
operator|=
name|zcs
operator|->
name|outBuffSize
expr_stmt|;
name|cSize
operator|=
name|lastBlock
condition|?
name|ZSTD_compressEnd
argument_list|(
name|zcs
argument_list|,
name|cDst
argument_list|,
name|oSize
argument_list|,
name|zcs
operator|->
name|inBuff
operator|+
name|zcs
operator|->
name|inToCompress
argument_list|,
name|iSize
argument_list|)
else|:
name|ZSTD_compressContinue
argument_list|(
name|zcs
argument_list|,
name|cDst
argument_list|,
name|oSize
argument_list|,
name|zcs
operator|->
name|inBuff
operator|+
name|zcs
operator|->
name|inToCompress
argument_list|,
name|iSize
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|cSize
argument_list|)
condition|)
return|return
name|cSize
return|;
name|zcs
operator|->
name|frameEnded
operator|=
name|lastBlock
expr_stmt|;
comment|/* prepare next block */
name|zcs
operator|->
name|inBuffTarget
operator|=
name|zcs
operator|->
name|inBuffPos
operator|+
name|zcs
operator|->
name|blockSize
expr_stmt|;
if|if
condition|(
name|zcs
operator|->
name|inBuffTarget
operator|>
name|zcs
operator|->
name|inBuffSize
condition|)
name|zcs
operator|->
name|inBuffPos
operator|=
literal|0
operator|,
name|zcs
operator|->
name|inBuffTarget
operator|=
name|zcs
operator|->
name|blockSize
expr_stmt|;
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"inBuffTarget:%u / inBuffSize:%u"
argument_list|,
operator|(
name|U32
operator|)
name|zcs
operator|->
name|inBuffTarget
argument_list|,
operator|(
name|U32
operator|)
name|zcs
operator|->
name|inBuffSize
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|lastBlock
condition|)
name|assert
argument_list|(
name|zcs
operator|->
name|inBuffTarget
operator|<=
name|zcs
operator|->
name|inBuffSize
argument_list|)
expr_stmt|;
name|zcs
operator|->
name|inToCompress
operator|=
name|zcs
operator|->
name|inBuffPos
expr_stmt|;
if|if
condition|(
name|cDst
operator|==
name|op
condition|)
block|{
comment|/* no need to flush */
name|op
operator|+=
name|cSize
expr_stmt|;
if|if
condition|(
name|zcs
operator|->
name|frameEnded
condition|)
block|{
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"Frame completed directly in outBuffer"
argument_list|)
expr_stmt|;
name|someMoreWork
operator|=
literal|0
expr_stmt|;
name|ZSTD_startNewCompression
argument_list|(
name|zcs
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
name|zcs
operator|->
name|outBuffContentSize
operator|=
name|cSize
expr_stmt|;
name|zcs
operator|->
name|outBuffFlushedSize
operator|=
literal|0
expr_stmt|;
name|zcs
operator|->
name|streamStage
operator|=
name|zcss_flush
expr_stmt|;
comment|/* pass-through to flush stage */
block|}
comment|/* fall-through */
case|case
name|zcss_flush
case|:
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"flush stage"
argument_list|)
expr_stmt|;
block|{
name|size_t
specifier|const
name|toFlush
init|=
name|zcs
operator|->
name|outBuffContentSize
operator|-
name|zcs
operator|->
name|outBuffFlushedSize
decl_stmt|;
name|size_t
specifier|const
name|flushed
init|=
name|ZSTD_limitCopy
argument_list|(
name|op
argument_list|,
name|oend
operator|-
name|op
argument_list|,
name|zcs
operator|->
name|outBuff
operator|+
name|zcs
operator|->
name|outBuffFlushedSize
argument_list|,
name|toFlush
argument_list|)
decl_stmt|;
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"toFlush: %u into %u ==> flushed: %u"
argument_list|,
operator|(
name|U32
operator|)
name|toFlush
argument_list|,
call|(
name|U32
call|)
argument_list|(
name|oend
operator|-
name|op
argument_list|)
argument_list|,
operator|(
name|U32
operator|)
name|flushed
argument_list|)
expr_stmt|;
name|op
operator|+=
name|flushed
expr_stmt|;
name|zcs
operator|->
name|outBuffFlushedSize
operator|+=
name|flushed
expr_stmt|;
if|if
condition|(
name|toFlush
operator|!=
name|flushed
condition|)
block|{
comment|/* flush not fully completed, presumably because dst is too small */
name|assert
argument_list|(
name|op
operator|==
name|oend
argument_list|)
expr_stmt|;
name|someMoreWork
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|zcs
operator|->
name|outBuffContentSize
operator|=
name|zcs
operator|->
name|outBuffFlushedSize
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|zcs
operator|->
name|frameEnded
condition|)
block|{
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"Frame completed on flush"
argument_list|)
expr_stmt|;
name|someMoreWork
operator|=
literal|0
expr_stmt|;
name|ZSTD_startNewCompression
argument_list|(
name|zcs
argument_list|)
expr_stmt|;
break|break;
block|}
name|zcs
operator|->
name|streamStage
operator|=
name|zcss_load
expr_stmt|;
break|break;
block|}
default|default:
comment|/* impossible */
name|assert
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
name|input
operator|->
name|pos
operator|=
name|ip
operator|-
name|istart
expr_stmt|;
name|output
operator|->
name|pos
operator|=
name|op
operator|-
name|ostart
expr_stmt|;
if|if
condition|(
name|zcs
operator|->
name|frameEnded
condition|)
return|return
literal|0
return|;
block|{
name|size_t
name|hintInSize
init|=
name|zcs
operator|->
name|inBuffTarget
operator|-
name|zcs
operator|->
name|inBuffPos
decl_stmt|;
if|if
condition|(
name|hintInSize
operator|==
literal|0
condition|)
name|hintInSize
operator|=
name|zcs
operator|->
name|blockSize
expr_stmt|;
return|return
name|hintInSize
return|;
block|}
block|}
end_function

begin_function
name|size_t
name|ZSTD_compressStream
parameter_list|(
name|ZSTD_CStream
modifier|*
name|zcs
parameter_list|,
name|ZSTD_outBuffer
modifier|*
name|output
parameter_list|,
name|ZSTD_inBuffer
modifier|*
name|input
parameter_list|)
block|{
comment|/* check conditions */
if|if
condition|(
name|output
operator|->
name|pos
operator|>
name|output
operator|->
name|size
condition|)
return|return
name|ERROR
argument_list|(
name|GENERIC
argument_list|)
return|;
if|if
condition|(
name|input
operator|->
name|pos
operator|>
name|input
operator|->
name|size
condition|)
return|return
name|ERROR
argument_list|(
name|GENERIC
argument_list|)
return|;
return|return
name|ZSTD_compressStream_generic
argument_list|(
name|zcs
argument_list|,
name|output
argument_list|,
name|input
argument_list|,
name|ZSTD_e_continue
argument_list|)
return|;
block|}
end_function

begin_function
name|size_t
name|ZSTD_compress_generic
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
name|ZSTD_outBuffer
modifier|*
name|output
parameter_list|,
name|ZSTD_inBuffer
modifier|*
name|input
parameter_list|,
name|ZSTD_EndDirective
name|endOp
parameter_list|)
block|{
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"ZSTD_compress_generic"
argument_list|)
expr_stmt|;
comment|/* check conditions */
if|if
condition|(
name|output
operator|->
name|pos
operator|>
name|output
operator|->
name|size
condition|)
return|return
name|ERROR
argument_list|(
name|GENERIC
argument_list|)
return|;
if|if
condition|(
name|input
operator|->
name|pos
operator|>
name|input
operator|->
name|size
condition|)
return|return
name|ERROR
argument_list|(
name|GENERIC
argument_list|)
return|;
name|assert
argument_list|(
name|cctx
operator|!=
name|NULL
argument_list|)
expr_stmt|;
comment|/* transparent initialization stage */
if|if
condition|(
name|cctx
operator|->
name|streamStage
operator|==
name|zcss_init
condition|)
block|{
name|ZSTD_prefixDict
specifier|const
name|prefixDict
init|=
name|cctx
operator|->
name|prefixDict
decl_stmt|;
name|ZSTD_CCtx_params
name|params
init|=
name|cctx
operator|->
name|requestedParams
decl_stmt|;
name|params
operator|.
name|cParams
operator|=
name|ZSTD_getCParamsFromCCtxParams
argument_list|(
name|cctx
operator|->
name|requestedParams
argument_list|,
name|cctx
operator|->
name|pledgedSrcSizePlusOne
operator|-
literal|1
argument_list|,
literal|0
comment|/*dictSize*/
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|cctx
operator|->
name|prefixDict
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cctx
operator|->
name|prefixDict
argument_list|)
argument_list|)
expr_stmt|;
comment|/* single usage */
name|assert
argument_list|(
name|prefixDict
operator|.
name|dict
operator|==
name|NULL
operator|||
name|cctx
operator|->
name|cdict
operator|==
name|NULL
argument_list|)
expr_stmt|;
comment|/* only one can be set */
name|DEBUGLOG
argument_list|(
literal|4
argument_list|,
literal|"ZSTD_compress_generic : transparent init stage"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ZSTD_MULTITHREAD
if|if
condition|(
name|params
operator|.
name|nbThreads
operator|>
literal|1
condition|)
block|{
if|if
condition|(
name|cctx
operator|->
name|mtctx
operator|==
name|NULL
operator|||
name|cctx
operator|->
name|appliedParams
operator|.
name|nbThreads
operator|!=
name|params
operator|.
name|nbThreads
condition|)
block|{
name|ZSTDMT_freeCCtx
argument_list|(
name|cctx
operator|->
name|mtctx
argument_list|)
expr_stmt|;
name|cctx
operator|->
name|mtctx
operator|=
name|ZSTDMT_createCCtx_advanced
argument_list|(
name|params
operator|.
name|nbThreads
argument_list|,
name|cctx
operator|->
name|customMem
argument_list|)
expr_stmt|;
if|if
condition|(
name|cctx
operator|->
name|mtctx
operator|==
name|NULL
condition|)
return|return
name|ERROR
argument_list|(
name|memory_allocation
argument_list|)
return|;
block|}
name|DEBUGLOG
argument_list|(
literal|4
argument_list|,
literal|"call ZSTDMT_initCStream_internal as nbThreads=%u"
argument_list|,
name|params
operator|.
name|nbThreads
argument_list|)
expr_stmt|;
name|CHECK_F
argument_list|(
name|ZSTDMT_initCStream_internal
argument_list|(
name|cctx
operator|->
name|mtctx
argument_list|,
name|prefixDict
operator|.
name|dict
argument_list|,
name|prefixDict
operator|.
name|dictSize
argument_list|,
name|ZSTD_dm_rawContent
argument_list|,
name|cctx
operator|->
name|cdict
argument_list|,
name|params
argument_list|,
name|cctx
operator|->
name|pledgedSrcSizePlusOne
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|cctx
operator|->
name|streamStage
operator|=
name|zcss_load
expr_stmt|;
name|cctx
operator|->
name|appliedParams
operator|.
name|nbThreads
operator|=
name|params
operator|.
name|nbThreads
expr_stmt|;
block|}
else|else
endif|#
directive|endif
block|{
name|CHECK_F
argument_list|(
name|ZSTD_resetCStream_internal
argument_list|(
name|cctx
argument_list|,
name|prefixDict
operator|.
name|dict
argument_list|,
name|prefixDict
operator|.
name|dictSize
argument_list|,
name|prefixDict
operator|.
name|dictMode
argument_list|,
name|cctx
operator|->
name|cdict
argument_list|,
name|params
argument_list|,
name|cctx
operator|->
name|pledgedSrcSizePlusOne
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* compression stage */
ifdef|#
directive|ifdef
name|ZSTD_MULTITHREAD
if|if
condition|(
name|cctx
operator|->
name|appliedParams
operator|.
name|nbThreads
operator|>
literal|1
condition|)
block|{
name|size_t
specifier|const
name|flushMin
init|=
name|ZSTDMT_compressStream_generic
argument_list|(
name|cctx
operator|->
name|mtctx
argument_list|,
name|output
argument_list|,
name|input
argument_list|,
name|endOp
argument_list|)
decl_stmt|;
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"ZSTDMT_compressStream_generic result : %u"
argument_list|,
operator|(
name|U32
operator|)
name|flushMin
argument_list|)
expr_stmt|;
if|if
condition|(
name|ZSTD_isError
argument_list|(
name|flushMin
argument_list|)
operator|||
operator|(
name|endOp
operator|==
name|ZSTD_e_end
operator|&&
name|flushMin
operator|==
literal|0
operator|)
condition|)
block|{
comment|/* compression completed */
name|ZSTD_startNewCompression
argument_list|(
name|cctx
argument_list|)
expr_stmt|;
block|}
return|return
name|flushMin
return|;
block|}
endif|#
directive|endif
name|CHECK_F
argument_list|(
name|ZSTD_compressStream_generic
argument_list|(
name|cctx
argument_list|,
name|output
argument_list|,
name|input
argument_list|,
name|endOp
argument_list|)
argument_list|)
expr_stmt|;
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"completed ZSTD_compress_generic"
argument_list|)
expr_stmt|;
return|return
name|cctx
operator|->
name|outBuffContentSize
operator|-
name|cctx
operator|->
name|outBuffFlushedSize
return|;
comment|/* remaining to flush */
block|}
end_function

begin_function
name|size_t
name|ZSTD_compress_generic_simpleArgs
parameter_list|(
name|ZSTD_CCtx
modifier|*
name|cctx
parameter_list|,
name|void
modifier|*
name|dst
parameter_list|,
name|size_t
name|dstCapacity
parameter_list|,
name|size_t
modifier|*
name|dstPos
parameter_list|,
specifier|const
name|void
modifier|*
name|src
parameter_list|,
name|size_t
name|srcSize
parameter_list|,
name|size_t
modifier|*
name|srcPos
parameter_list|,
name|ZSTD_EndDirective
name|endOp
parameter_list|)
block|{
name|ZSTD_outBuffer
name|output
init|=
block|{
name|dst
block|,
name|dstCapacity
block|,
operator|*
name|dstPos
block|}
decl_stmt|;
name|ZSTD_inBuffer
name|input
init|=
block|{
name|src
block|,
name|srcSize
block|,
operator|*
name|srcPos
block|}
decl_stmt|;
comment|/* ZSTD_compress_generic() will check validity of dstPos and srcPos */
name|size_t
specifier|const
name|cErr
init|=
name|ZSTD_compress_generic
argument_list|(
name|cctx
argument_list|,
operator|&
name|output
argument_list|,
operator|&
name|input
argument_list|,
name|endOp
argument_list|)
decl_stmt|;
operator|*
name|dstPos
operator|=
name|output
operator|.
name|pos
expr_stmt|;
operator|*
name|srcPos
operator|=
name|input
operator|.
name|pos
expr_stmt|;
return|return
name|cErr
return|;
block|}
end_function

begin_comment
comment|/*======   Finalize   ======*/
end_comment

begin_comment
comment|/*! ZSTD_flushStream() : *   @return : amount of data remaining to flush */
end_comment

begin_function
name|size_t
name|ZSTD_flushStream
parameter_list|(
name|ZSTD_CStream
modifier|*
name|zcs
parameter_list|,
name|ZSTD_outBuffer
modifier|*
name|output
parameter_list|)
block|{
name|ZSTD_inBuffer
name|input
init|=
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
if|if
condition|(
name|output
operator|->
name|pos
operator|>
name|output
operator|->
name|size
condition|)
return|return
name|ERROR
argument_list|(
name|GENERIC
argument_list|)
return|;
name|CHECK_F
argument_list|(
name|ZSTD_compressStream_generic
argument_list|(
name|zcs
argument_list|,
name|output
argument_list|,
operator|&
name|input
argument_list|,
name|ZSTD_e_flush
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|zcs
operator|->
name|outBuffContentSize
operator|-
name|zcs
operator|->
name|outBuffFlushedSize
return|;
comment|/* remaining to flush */
block|}
end_function

begin_function
name|size_t
name|ZSTD_endStream
parameter_list|(
name|ZSTD_CStream
modifier|*
name|zcs
parameter_list|,
name|ZSTD_outBuffer
modifier|*
name|output
parameter_list|)
block|{
name|ZSTD_inBuffer
name|input
init|=
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|}
decl_stmt|;
if|if
condition|(
name|output
operator|->
name|pos
operator|>
name|output
operator|->
name|size
condition|)
return|return
name|ERROR
argument_list|(
name|GENERIC
argument_list|)
return|;
name|CHECK_F
argument_list|(
name|ZSTD_compressStream_generic
argument_list|(
name|zcs
argument_list|,
name|output
argument_list|,
operator|&
name|input
argument_list|,
name|ZSTD_e_end
argument_list|)
argument_list|)
expr_stmt|;
block|{
name|size_t
specifier|const
name|lastBlockSize
init|=
name|zcs
operator|->
name|frameEnded
condition|?
literal|0
else|:
name|ZSTD_BLOCKHEADERSIZE
decl_stmt|;
name|size_t
specifier|const
name|checksumSize
init|=
name|zcs
operator|->
name|frameEnded
condition|?
literal|0
else|:
name|zcs
operator|->
name|appliedParams
operator|.
name|fParams
operator|.
name|checksumFlag
operator|*
literal|4
decl_stmt|;
name|size_t
specifier|const
name|toFlush
init|=
name|zcs
operator|->
name|outBuffContentSize
operator|-
name|zcs
operator|->
name|outBuffFlushedSize
operator|+
name|lastBlockSize
operator|+
name|checksumSize
decl_stmt|;
name|DEBUGLOG
argument_list|(
literal|5
argument_list|,
literal|"ZSTD_endStream : remaining to flush : %u"
argument_list|,
operator|(
name|unsigned
operator|)
name|toFlush
argument_list|)
expr_stmt|;
return|return
name|toFlush
return|;
block|}
block|}
end_function

begin_comment
comment|/*-=====  Pre-defined compression levels  =====-*/
end_comment

begin_define
define|#
directive|define
name|ZSTD_MAX_CLEVEL
value|22
end_define

begin_function
name|int
name|ZSTD_maxCLevel
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|ZSTD_MAX_CLEVEL
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|ZSTD_compressionParameters
name|ZSTD_defaultCParameters
index|[
literal|4
index|]
index|[
name|ZSTD_MAX_CLEVEL
operator|+
literal|1
index|]
init|=
block|{
block|{
comment|/* "default" - guarantees a monotonically increasing memory budget */
comment|/* W,  C,  H,  S,  L, TL, strat */
block|{
literal|18
block|,
literal|12
block|,
literal|12
block|,
literal|1
block|,
literal|7
block|,
literal|16
block|,
name|ZSTD_fast
block|}
block|,
comment|/* level  0 - never used */
block|{
literal|19
block|,
literal|13
block|,
literal|14
block|,
literal|1
block|,
literal|7
block|,
literal|16
block|,
name|ZSTD_fast
block|}
block|,
comment|/* level  1 */
block|{
literal|19
block|,
literal|15
block|,
literal|16
block|,
literal|1
block|,
literal|6
block|,
literal|16
block|,
name|ZSTD_fast
block|}
block|,
comment|/* level  2 */
block|{
literal|20
block|,
literal|16
block|,
literal|17
block|,
literal|1
block|,
literal|5
block|,
literal|16
block|,
name|ZSTD_dfast
block|}
block|,
comment|/* level  3 */
block|{
literal|20
block|,
literal|17
block|,
literal|18
block|,
literal|1
block|,
literal|5
block|,
literal|16
block|,
name|ZSTD_dfast
block|}
block|,
comment|/* level  4 */
block|{
literal|20
block|,
literal|17
block|,
literal|18
block|,
literal|2
block|,
literal|5
block|,
literal|16
block|,
name|ZSTD_greedy
block|}
block|,
comment|/* level  5 */
block|{
literal|21
block|,
literal|17
block|,
literal|19
block|,
literal|2
block|,
literal|5
block|,
literal|16
block|,
name|ZSTD_lazy
block|}
block|,
comment|/* level  6 */
block|{
literal|21
block|,
literal|18
block|,
literal|19
block|,
literal|3
block|,
literal|5
block|,
literal|16
block|,
name|ZSTD_lazy
block|}
block|,
comment|/* level  7 */
block|{
literal|21
block|,
literal|18
block|,
literal|20
block|,
literal|3
block|,
literal|5
block|,
literal|16
block|,
name|ZSTD_lazy2
block|}
block|,
comment|/* level  8 */
block|{
literal|21
block|,
literal|19
block|,
literal|20
block|,
literal|3
block|,
literal|5
block|,
literal|16
block|,
name|ZSTD_lazy2
block|}
block|,
comment|/* level  9 */
block|{
literal|21
block|,
literal|19
block|,
literal|21
block|,
literal|4
block|,
literal|5
block|,
literal|16
block|,
name|ZSTD_lazy2
block|}
block|,
comment|/* level 10 */
block|{
literal|22
block|,
literal|20
block|,
literal|22
block|,
literal|4
block|,
literal|5
block|,
literal|16
block|,
name|ZSTD_lazy2
block|}
block|,
comment|/* level 11 */
block|{
literal|22
block|,
literal|20
block|,
literal|22
block|,
literal|5
block|,
literal|5
block|,
literal|16
block|,
name|ZSTD_lazy2
block|}
block|,
comment|/* level 12 */
block|{
literal|22
block|,
literal|21
block|,
literal|22
block|,
literal|5
block|,
literal|5
block|,
literal|16
block|,
name|ZSTD_lazy2
block|}
block|,
comment|/* level 13 */
block|{
literal|22
block|,
literal|21
block|,
literal|22
block|,
literal|6
block|,
literal|5
block|,
literal|16
block|,
name|ZSTD_lazy2
block|}
block|,
comment|/* level 14 */
block|{
literal|22
block|,
literal|21
block|,
literal|22
block|,
literal|5
block|,
literal|5
block|,
literal|16
block|,
name|ZSTD_btlazy2
block|}
block|,
comment|/* level 15 */
block|{
literal|23
block|,
literal|22
block|,
literal|22
block|,
literal|5
block|,
literal|5
block|,
literal|16
block|,
name|ZSTD_btlazy2
block|}
block|,
comment|/* level 16 */
block|{
literal|23
block|,
literal|22
block|,
literal|22
block|,
literal|4
block|,
literal|5
block|,
literal|24
block|,
name|ZSTD_btopt
block|}
block|,
comment|/* level 17 */
block|{
literal|23
block|,
literal|22
block|,
literal|22
block|,
literal|5
block|,
literal|4
block|,
literal|32
block|,
name|ZSTD_btopt
block|}
block|,
comment|/* level 18 */
block|{
literal|23
block|,
literal|23
block|,
literal|22
block|,
literal|6
block|,
literal|3
block|,
literal|48
block|,
name|ZSTD_btopt
block|}
block|,
comment|/* level 19 */
block|{
literal|25
block|,
literal|25
block|,
literal|23
block|,
literal|7
block|,
literal|3
block|,
literal|64
block|,
name|ZSTD_btultra
block|}
block|,
comment|/* level 20 */
block|{
literal|26
block|,
literal|26
block|,
literal|24
block|,
literal|7
block|,
literal|3
block|,
literal|256
block|,
name|ZSTD_btultra
block|}
block|,
comment|/* level 21 */
block|{
literal|27
block|,
literal|27
block|,
literal|25
block|,
literal|9
block|,
literal|3
block|,
literal|512
block|,
name|ZSTD_btultra
block|}
block|,
comment|/* level 22 */
block|}
block|,
block|{
comment|/* for srcSize<= 256 KB */
comment|/* W,  C,  H,  S,  L,  T, strat */
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|ZSTD_fast
block|}
block|,
comment|/* level  0 - not used */
block|{
literal|18
block|,
literal|13
block|,
literal|14
block|,
literal|1
block|,
literal|6
block|,
literal|8
block|,
name|ZSTD_fast
block|}
block|,
comment|/* level  1 */
block|{
literal|18
block|,
literal|14
block|,
literal|13
block|,
literal|1
block|,
literal|5
block|,
literal|8
block|,
name|ZSTD_dfast
block|}
block|,
comment|/* level  2 */
block|{
literal|18
block|,
literal|16
block|,
literal|15
block|,
literal|1
block|,
literal|5
block|,
literal|8
block|,
name|ZSTD_dfast
block|}
block|,
comment|/* level  3 */
block|{
literal|18
block|,
literal|15
block|,
literal|17
block|,
literal|1
block|,
literal|5
block|,
literal|8
block|,
name|ZSTD_greedy
block|}
block|,
comment|/* level  4.*/
block|{
literal|18
block|,
literal|16
block|,
literal|17
block|,
literal|4
block|,
literal|5
block|,
literal|8
block|,
name|ZSTD_greedy
block|}
block|,
comment|/* level  5.*/
block|{
literal|18
block|,
literal|16
block|,
literal|17
block|,
literal|3
block|,
literal|5
block|,
literal|8
block|,
name|ZSTD_lazy
block|}
block|,
comment|/* level  6.*/
block|{
literal|18
block|,
literal|17
block|,
literal|17
block|,
literal|4
block|,
literal|4
block|,
literal|8
block|,
name|ZSTD_lazy
block|}
block|,
comment|/* level  7 */
block|{
literal|18
block|,
literal|17
block|,
literal|17
block|,
literal|4
block|,
literal|4
block|,
literal|8
block|,
name|ZSTD_lazy2
block|}
block|,
comment|/* level  8 */
block|{
literal|18
block|,
literal|17
block|,
literal|17
block|,
literal|5
block|,
literal|4
block|,
literal|8
block|,
name|ZSTD_lazy2
block|}
block|,
comment|/* level  9 */
block|{
literal|18
block|,
literal|17
block|,
literal|17
block|,
literal|6
block|,
literal|4
block|,
literal|8
block|,
name|ZSTD_lazy2
block|}
block|,
comment|/* level 10 */
block|{
literal|18
block|,
literal|18
block|,
literal|17
block|,
literal|6
block|,
literal|4
block|,
literal|8
block|,
name|ZSTD_lazy2
block|}
block|,
comment|/* level 11.*/
block|{
literal|18
block|,
literal|18
block|,
literal|17
block|,
literal|7
block|,
literal|4
block|,
literal|8
block|,
name|ZSTD_lazy2
block|}
block|,
comment|/* level 12.*/
block|{
literal|18
block|,
literal|19
block|,
literal|17
block|,
literal|6
block|,
literal|4
block|,
literal|8
block|,
name|ZSTD_btlazy2
block|}
block|,
comment|/* level 13 */
block|{
literal|18
block|,
literal|18
block|,
literal|18
block|,
literal|4
block|,
literal|4
block|,
literal|16
block|,
name|ZSTD_btopt
block|}
block|,
comment|/* level 14.*/
block|{
literal|18
block|,
literal|18
block|,
literal|18
block|,
literal|4
block|,
literal|3
block|,
literal|16
block|,
name|ZSTD_btopt
block|}
block|,
comment|/* level 15.*/
block|{
literal|18
block|,
literal|19
block|,
literal|18
block|,
literal|6
block|,
literal|3
block|,
literal|32
block|,
name|ZSTD_btopt
block|}
block|,
comment|/* level 16.*/
block|{
literal|18
block|,
literal|19
block|,
literal|18
block|,
literal|8
block|,
literal|3
block|,
literal|64
block|,
name|ZSTD_btopt
block|}
block|,
comment|/* level 17.*/
block|{
literal|18
block|,
literal|19
block|,
literal|18
block|,
literal|9
block|,
literal|3
block|,
literal|128
block|,
name|ZSTD_btopt
block|}
block|,
comment|/* level 18.*/
block|{
literal|18
block|,
literal|19
block|,
literal|18
block|,
literal|10
block|,
literal|3
block|,
literal|256
block|,
name|ZSTD_btopt
block|}
block|,
comment|/* level 19.*/
block|{
literal|18
block|,
literal|19
block|,
literal|18
block|,
literal|11
block|,
literal|3
block|,
literal|512
block|,
name|ZSTD_btultra
block|}
block|,
comment|/* level 20.*/
block|{
literal|18
block|,
literal|19
block|,
literal|18
block|,
literal|12
block|,
literal|3
block|,
literal|512
block|,
name|ZSTD_btultra
block|}
block|,
comment|/* level 21.*/
block|{
literal|18
block|,
literal|19
block|,
literal|18
block|,
literal|13
block|,
literal|3
block|,
literal|512
block|,
name|ZSTD_btultra
block|}
block|,
comment|/* level 22.*/
block|}
block|,
block|{
comment|/* for srcSize<= 128 KB */
comment|/* W,  C,  H,  S,  L,  T, strat */
block|{
literal|17
block|,
literal|12
block|,
literal|12
block|,
literal|1
block|,
literal|7
block|,
literal|8
block|,
name|ZSTD_fast
block|}
block|,
comment|/* level  0 - not used */
block|{
literal|17
block|,
literal|12
block|,
literal|13
block|,
literal|1
block|,
literal|6
block|,
literal|8
block|,
name|ZSTD_fast
block|}
block|,
comment|/* level  1 */
block|{
literal|17
block|,
literal|13
block|,
literal|16
block|,
literal|1
block|,
literal|5
block|,
literal|8
block|,
name|ZSTD_fast
block|}
block|,
comment|/* level  2 */
block|{
literal|17
block|,
literal|16
block|,
literal|16
block|,
literal|2
block|,
literal|5
block|,
literal|8
block|,
name|ZSTD_dfast
block|}
block|,
comment|/* level  3 */
block|{
literal|17
block|,
literal|13
block|,
literal|15
block|,
literal|3
block|,
literal|4
block|,
literal|8
block|,
name|ZSTD_greedy
block|}
block|,
comment|/* level  4 */
block|{
literal|17
block|,
literal|15
block|,
literal|17
block|,
literal|4
block|,
literal|4
block|,
literal|8
block|,
name|ZSTD_greedy
block|}
block|,
comment|/* level  5 */
block|{
literal|17
block|,
literal|16
block|,
literal|17
block|,
literal|3
block|,
literal|4
block|,
literal|8
block|,
name|ZSTD_lazy
block|}
block|,
comment|/* level  6 */
block|{
literal|17
block|,
literal|15
block|,
literal|17
block|,
literal|4
block|,
literal|4
block|,
literal|8
block|,
name|ZSTD_lazy2
block|}
block|,
comment|/* level  7 */
block|{
literal|17
block|,
literal|17
block|,
literal|17
block|,
literal|4
block|,
literal|4
block|,
literal|8
block|,
name|ZSTD_lazy2
block|}
block|,
comment|/* level  8 */
block|{
literal|17
block|,
literal|17
block|,
literal|17
block|,
literal|5
block|,
literal|4
block|,
literal|8
block|,
name|ZSTD_lazy2
block|}
block|,
comment|/* level  9 */
block|{
literal|17
block|,
literal|17
block|,
literal|17
block|,
literal|6
block|,
literal|4
block|,
literal|8
block|,
name|ZSTD_lazy2
block|}
block|,
comment|/* level 10 */
block|{
literal|17
block|,
literal|17
block|,
literal|17
block|,
literal|7
block|,
literal|4
block|,
literal|8
block|,
name|ZSTD_lazy2
block|}
block|,
comment|/* level 11 */
block|{
literal|17
block|,
literal|17
block|,
literal|17
block|,
literal|8
block|,
literal|4
block|,
literal|8
block|,
name|ZSTD_lazy2
block|}
block|,
comment|/* level 12 */
block|{
literal|17
block|,
literal|18
block|,
literal|17
block|,
literal|6
block|,
literal|4
block|,
literal|8
block|,
name|ZSTD_btlazy2
block|}
block|,
comment|/* level 13.*/
block|{
literal|17
block|,
literal|17
block|,
literal|17
block|,
literal|7
block|,
literal|3
block|,
literal|8
block|,
name|ZSTD_btopt
block|}
block|,
comment|/* level 14.*/
block|{
literal|17
block|,
literal|17
block|,
literal|17
block|,
literal|7
block|,
literal|3
block|,
literal|16
block|,
name|ZSTD_btopt
block|}
block|,
comment|/* level 15.*/
block|{
literal|17
block|,
literal|18
block|,
literal|17
block|,
literal|7
block|,
literal|3
block|,
literal|32
block|,
name|ZSTD_btopt
block|}
block|,
comment|/* level 16.*/
block|{
literal|17
block|,
literal|18
block|,
literal|17
block|,
literal|7
block|,
literal|3
block|,
literal|64
block|,
name|ZSTD_btopt
block|}
block|,
comment|/* level 17.*/
block|{
literal|17
block|,
literal|18
block|,
literal|17
block|,
literal|7
block|,
literal|3
block|,
literal|256
block|,
name|ZSTD_btopt
block|}
block|,
comment|/* level 18.*/
block|{
literal|17
block|,
literal|18
block|,
literal|17
block|,
literal|8
block|,
literal|3
block|,
literal|256
block|,
name|ZSTD_btopt
block|}
block|,
comment|/* level 19.*/
block|{
literal|17
block|,
literal|18
block|,
literal|17
block|,
literal|9
block|,
literal|3
block|,
literal|256
block|,
name|ZSTD_btultra
block|}
block|,
comment|/* level 20.*/
block|{
literal|17
block|,
literal|18
block|,
literal|17
block|,
literal|10
block|,
literal|3
block|,
literal|256
block|,
name|ZSTD_btultra
block|}
block|,
comment|/* level 21.*/
block|{
literal|17
block|,
literal|18
block|,
literal|17
block|,
literal|11
block|,
literal|3
block|,
literal|512
block|,
name|ZSTD_btultra
block|}
block|,
comment|/* level 22.*/
block|}
block|,
block|{
comment|/* for srcSize<= 16 KB */
comment|/* W,  C,  H,  S,  L,  T, strat */
block|{
literal|14
block|,
literal|12
block|,
literal|12
block|,
literal|1
block|,
literal|7
block|,
literal|6
block|,
name|ZSTD_fast
block|}
block|,
comment|/* level  0 - not used */
block|{
literal|14
block|,
literal|14
block|,
literal|14
block|,
literal|1
block|,
literal|6
block|,
literal|6
block|,
name|ZSTD_fast
block|}
block|,
comment|/* level  1 */
block|{
literal|14
block|,
literal|14
block|,
literal|14
block|,
literal|1
block|,
literal|4
block|,
literal|6
block|,
name|ZSTD_fast
block|}
block|,
comment|/* level  2 */
block|{
literal|14
block|,
literal|14
block|,
literal|14
block|,
literal|1
block|,
literal|4
block|,
literal|6
block|,
name|ZSTD_dfast
block|}
block|,
comment|/* level  3.*/
block|{
literal|14
block|,
literal|14
block|,
literal|14
block|,
literal|4
block|,
literal|4
block|,
literal|6
block|,
name|ZSTD_greedy
block|}
block|,
comment|/* level  4.*/
block|{
literal|14
block|,
literal|14
block|,
literal|14
block|,
literal|3
block|,
literal|4
block|,
literal|6
block|,
name|ZSTD_lazy
block|}
block|,
comment|/* level  5.*/
block|{
literal|14
block|,
literal|14
block|,
literal|14
block|,
literal|4
block|,
literal|4
block|,
literal|6
block|,
name|ZSTD_lazy2
block|}
block|,
comment|/* level  6 */
block|{
literal|14
block|,
literal|14
block|,
literal|14
block|,
literal|5
block|,
literal|4
block|,
literal|6
block|,
name|ZSTD_lazy2
block|}
block|,
comment|/* level  7 */
block|{
literal|14
block|,
literal|14
block|,
literal|14
block|,
literal|6
block|,
literal|4
block|,
literal|6
block|,
name|ZSTD_lazy2
block|}
block|,
comment|/* level  8.*/
block|{
literal|14
block|,
literal|15
block|,
literal|14
block|,
literal|6
block|,
literal|4
block|,
literal|6
block|,
name|ZSTD_btlazy2
block|}
block|,
comment|/* level  9.*/
block|{
literal|14
block|,
literal|15
block|,
literal|14
block|,
literal|3
block|,
literal|3
block|,
literal|6
block|,
name|ZSTD_btopt
block|}
block|,
comment|/* level 10.*/
block|{
literal|14
block|,
literal|15
block|,
literal|14
block|,
literal|6
block|,
literal|3
block|,
literal|8
block|,
name|ZSTD_btopt
block|}
block|,
comment|/* level 11.*/
block|{
literal|14
block|,
literal|15
block|,
literal|14
block|,
literal|6
block|,
literal|3
block|,
literal|16
block|,
name|ZSTD_btopt
block|}
block|,
comment|/* level 12.*/
block|{
literal|14
block|,
literal|15
block|,
literal|14
block|,
literal|6
block|,
literal|3
block|,
literal|24
block|,
name|ZSTD_btopt
block|}
block|,
comment|/* level 13.*/
block|{
literal|14
block|,
literal|15
block|,
literal|15
block|,
literal|6
block|,
literal|3
block|,
literal|48
block|,
name|ZSTD_btopt
block|}
block|,
comment|/* level 14.*/
block|{
literal|14
block|,
literal|15
block|,
literal|15
block|,
literal|6
block|,
literal|3
block|,
literal|64
block|,
name|ZSTD_btopt
block|}
block|,
comment|/* level 15.*/
block|{
literal|14
block|,
literal|15
block|,
literal|15
block|,
literal|6
block|,
literal|3
block|,
literal|96
block|,
name|ZSTD_btopt
block|}
block|,
comment|/* level 16.*/
block|{
literal|14
block|,
literal|15
block|,
literal|15
block|,
literal|6
block|,
literal|3
block|,
literal|128
block|,
name|ZSTD_btopt
block|}
block|,
comment|/* level 17.*/
block|{
literal|14
block|,
literal|15
block|,
literal|15
block|,
literal|6
block|,
literal|3
block|,
literal|256
block|,
name|ZSTD_btopt
block|}
block|,
comment|/* level 18.*/
block|{
literal|14
block|,
literal|15
block|,
literal|15
block|,
literal|7
block|,
literal|3
block|,
literal|256
block|,
name|ZSTD_btopt
block|}
block|,
comment|/* level 19.*/
block|{
literal|14
block|,
literal|15
block|,
literal|15
block|,
literal|8
block|,
literal|3
block|,
literal|256
block|,
name|ZSTD_btultra
block|}
block|,
comment|/* level 20.*/
block|{
literal|14
block|,
literal|15
block|,
literal|15
block|,
literal|9
block|,
literal|3
block|,
literal|256
block|,
name|ZSTD_btultra
block|}
block|,
comment|/* level 21.*/
block|{
literal|14
block|,
literal|15
block|,
literal|15
block|,
literal|10
block|,
literal|3
block|,
literal|256
block|,
name|ZSTD_btultra
block|}
block|,
comment|/* level 22.*/
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
name|defined
argument_list|(
name|ZSTD_DEBUG
argument_list|)
operator|&&
operator|(
name|ZSTD_DEBUG
operator|>=
literal|1
operator|)
end_if

begin_comment
comment|/* This function just controls  * the monotonic memory budget increase of ZSTD_defaultCParameters[0].  * Run once, on first ZSTD_getCParams() usage, if ZSTD_DEBUG is enabled  */
end_comment

begin_function
name|MEM_STATIC
name|void
name|ZSTD_check_compressionLevel_monotonicIncrease_memoryBudget
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|level
decl_stmt|;
for|for
control|(
name|level
operator|=
literal|1
init|;
name|level
operator|<
name|ZSTD_maxCLevel
argument_list|()
condition|;
name|level
operator|++
control|)
block|{
name|ZSTD_compressionParameters
specifier|const
name|c1
init|=
name|ZSTD_defaultCParameters
index|[
literal|0
index|]
index|[
name|level
index|]
decl_stmt|;
name|ZSTD_compressionParameters
specifier|const
name|c2
init|=
name|ZSTD_defaultCParameters
index|[
literal|0
index|]
index|[
name|level
operator|+
literal|1
index|]
decl_stmt|;
name|assert
argument_list|(
name|c1
operator|.
name|windowLog
operator|<=
name|c2
operator|.
name|windowLog
argument_list|)
expr_stmt|;
define|#
directive|define
name|ZSTD_TABLECOST
parameter_list|(
name|h
parameter_list|,
name|c
parameter_list|)
value|((1<<(h)) + (1<<(c)))
name|assert
argument_list|(
name|ZSTD_TABLECOST
argument_list|(
name|c1
operator|.
name|hashLog
argument_list|,
name|c1
operator|.
name|chainLog
argument_list|)
operator|<=
name|ZSTD_TABLECOST
argument_list|(
name|c2
operator|.
name|hashLog
argument_list|,
name|c2
operator|.
name|chainLog
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*! ZSTD_getCParams() : *   @return ZSTD_compressionParameters structure for a selected compression level, `srcSize` and `dictSize`. *   Size values are optional, provide 0 if not known or unused */
end_comment

begin_function
name|ZSTD_compressionParameters
name|ZSTD_getCParams
parameter_list|(
name|int
name|compressionLevel
parameter_list|,
name|unsigned
name|long
name|long
name|srcSizeHint
parameter_list|,
name|size_t
name|dictSize
parameter_list|)
block|{
name|size_t
specifier|const
name|addedSize
init|=
name|srcSizeHint
condition|?
literal|0
else|:
literal|500
decl_stmt|;
name|U64
specifier|const
name|rSize
init|=
name|srcSizeHint
operator|+
name|dictSize
condition|?
name|srcSizeHint
operator|+
name|dictSize
operator|+
name|addedSize
else|:
operator|(
name|U64
operator|)
operator|-
literal|1
decl_stmt|;
name|U32
specifier|const
name|tableID
init|=
operator|(
name|rSize
operator|<=
literal|256
name|KB
operator|)
operator|+
operator|(
name|rSize
operator|<=
literal|128
name|KB
operator|)
operator|+
operator|(
name|rSize
operator|<=
literal|16
name|KB
operator|)
decl_stmt|;
comment|/* intentional underflow for srcSizeHint == 0 */
if|#
directive|if
name|defined
argument_list|(
name|ZSTD_DEBUG
argument_list|)
operator|&&
operator|(
name|ZSTD_DEBUG
operator|>=
literal|1
operator|)
specifier|static
name|int
name|g_monotonicTest
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|g_monotonicTest
condition|)
block|{
name|ZSTD_check_compressionLevel_monotonicIncrease_memoryBudget
argument_list|()
expr_stmt|;
name|g_monotonicTest
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|compressionLevel
operator|<=
literal|0
condition|)
name|compressionLevel
operator|=
name|ZSTD_CLEVEL_DEFAULT
expr_stmt|;
comment|/* 0 == default; no negative compressionLevel yet */
if|if
condition|(
name|compressionLevel
operator|>
name|ZSTD_MAX_CLEVEL
condition|)
name|compressionLevel
operator|=
name|ZSTD_MAX_CLEVEL
expr_stmt|;
block|{
name|ZSTD_compressionParameters
specifier|const
name|cp
init|=
name|ZSTD_defaultCParameters
index|[
name|tableID
index|]
index|[
name|compressionLevel
index|]
decl_stmt|;
return|return
name|ZSTD_adjustCParams_internal
argument_list|(
name|cp
argument_list|,
name|srcSizeHint
argument_list|,
name|dictSize
argument_list|)
return|;
block|}
block|}
end_function

begin_comment
comment|/*! ZSTD_getParams() : *   same as ZSTD_getCParams(), but @return a `ZSTD_parameters` object (instead of `ZSTD_compressionParameters`). *   All fields of `ZSTD_frameParameters` are set to default (0) */
end_comment

begin_function
name|ZSTD_parameters
name|ZSTD_getParams
parameter_list|(
name|int
name|compressionLevel
parameter_list|,
name|unsigned
name|long
name|long
name|srcSizeHint
parameter_list|,
name|size_t
name|dictSize
parameter_list|)
block|{
name|ZSTD_parameters
name|params
decl_stmt|;
name|ZSTD_compressionParameters
specifier|const
name|cParams
init|=
name|ZSTD_getCParams
argument_list|(
name|compressionLevel
argument_list|,
name|srcSizeHint
argument_list|,
name|dictSize
argument_list|)
decl_stmt|;
name|memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|cParams
operator|=
name|cParams
expr_stmt|;
return|return
name|params
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2005 Ammasso, Inc. All rights reserved.  * Copyright (c) 2006-2009 Open Grid Computing, Inc. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<linux/module.h>
end_include

begin_include
include|#
directive|include
file|<linux/moduleparam.h>
end_include

begin_include
include|#
directive|include
file|<linux/slab.h>
end_include

begin_include
include|#
directive|include
file|<linux/err.h>
end_include

begin_include
include|#
directive|include
file|<linux/string.h>
end_include

begin_include
include|#
directive|include
file|<linux/list.h>
end_include

begin_include
include|#
directive|include
file|<linux/in.h>
end_include

begin_include
include|#
directive|include
file|<linux/device.h>
end_include

begin_include
include|#
directive|include
file|<linux/pci.h>
end_include

begin_include
include|#
directive|include
file|<linux/sched.h>
end_include

begin_include
include|#
directive|include
file|<asm/atomic.h>
end_include

begin_include
include|#
directive|include
file|<rdma/ib_verbs.h>
end_include

begin_include
include|#
directive|include
file|<rdma/rdma_cm.h>
end_include

begin_include
include|#
directive|include
file|"krping.h"
end_include

begin_include
include|#
directive|include
file|"getopt.h"
end_include

begin_define
define|#
directive|define
name|PFX
value|"krping: "
end_define

begin_decl_stmt
specifier|extern
name|int
name|krping_debug
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|DEBUG_LOG
parameter_list|(
modifier|...
parameter_list|)
value|do { if (krping_debug) log(LOG_INFO, __VA_ARGS__); } while (0)
end_define

begin_define
define|#
directive|define
name|BIND_INFO
value|1
end_define

begin_expr_stmt
name|MODULE_AUTHOR
argument_list|(
literal|"Steve Wise"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DESCRIPTION
argument_list|(
literal|"RDMA ping server"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_LICENSE
argument_list|(
literal|"Dual BSD/GPL"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_VERSION
argument_list|(
name|krping
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|MODULE_DEPEND
argument_list|(
name|krping
argument_list|,
name|linuxkpi
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
end_expr_stmt

begin_function
specifier|static
name|__inline
name|uint64_t
name|get_cycles
parameter_list|(
name|void
parameter_list|)
block|{
name|uint32_t
name|low
decl_stmt|,
name|high
decl_stmt|;
asm|__asm __volatile("rdtsc" : "=a" (low), "=d" (high));
return|return
operator|(
name|low
operator||
operator|(
operator|(
name|u_int64_t
operator|)
name|high
operator|<<
literal|32
operator|)
operator|)
return|;
block|}
end_function

begin_typedef
typedef|typedef
name|uint64_t
name|cycles_t
typedef|;
end_typedef

begin_enum
enum|enum
name|mem_type
block|{
name|DMA
init|=
literal|1
block|,
name|REG
init|=
literal|2
block|, }
enum|;
end_enum

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|krping_option
name|krping_opts
index|[]
init|=
block|{
block|{
literal|"count"
block|,
name|OPT_INT
block|,
literal|'C'
block|}
block|,
block|{
literal|"size"
block|,
name|OPT_INT
block|,
literal|'S'
block|}
block|,
block|{
literal|"addr"
block|,
name|OPT_STRING
block|,
literal|'a'
block|}
block|,
block|{
literal|"addr6"
block|,
name|OPT_STRING
block|,
literal|'A'
block|}
block|,
block|{
literal|"port"
block|,
name|OPT_INT
block|,
literal|'p'
block|}
block|,
block|{
literal|"verbose"
block|,
name|OPT_NOPARAM
block|,
literal|'v'
block|}
block|,
block|{
literal|"validate"
block|,
name|OPT_NOPARAM
block|,
literal|'V'
block|}
block|,
block|{
literal|"server"
block|,
name|OPT_NOPARAM
block|,
literal|'s'
block|}
block|,
block|{
literal|"client"
block|,
name|OPT_NOPARAM
block|,
literal|'c'
block|}
block|,
block|{
literal|"server_inv"
block|,
name|OPT_NOPARAM
block|,
literal|'I'
block|}
block|,
block|{
literal|"wlat"
block|,
name|OPT_NOPARAM
block|,
literal|'l'
block|}
block|,
block|{
literal|"rlat"
block|,
name|OPT_NOPARAM
block|,
literal|'L'
block|}
block|,
block|{
literal|"bw"
block|,
name|OPT_NOPARAM
block|,
literal|'B'
block|}
block|,
block|{
literal|"duplex"
block|,
name|OPT_NOPARAM
block|,
literal|'d'
block|}
block|,
block|{
literal|"txdepth"
block|,
name|OPT_INT
block|,
literal|'T'
block|}
block|,
block|{
literal|"poll"
block|,
name|OPT_NOPARAM
block|,
literal|'P'
block|}
block|,
block|{
literal|"local_dma_lkey"
block|,
name|OPT_NOPARAM
block|,
literal|'Z'
block|}
block|,
block|{
literal|"read_inv"
block|,
name|OPT_NOPARAM
block|,
literal|'R'
block|}
block|,
block|{
literal|"fr"
block|,
name|OPT_NOPARAM
block|,
literal|'f'
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|htonll
parameter_list|(
name|x
parameter_list|)
value|cpu_to_be64((x))
end_define

begin_define
define|#
directive|define
name|ntohll
parameter_list|(
name|x
parameter_list|)
value|cpu_to_be64((x))
end_define

begin_expr_stmt
specifier|static
name|DEFINE_MUTEX
argument_list|(
name|krping_mutex
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * List of running krping threads.  */
end_comment

begin_expr_stmt
specifier|static
name|LIST_HEAD
argument_list|(
name|krping_cbs
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * Invoke like this, one on each side, using the server's address on  * the RDMA device (iw%d):  *  * /bin/echo server,port=9999,addr=192.168.69.142,validate> /proc/krping    * /bin/echo client,port=9999,addr=192.168.69.142,validate> /proc/krping    * /bin/echo client,port=9999,addr6=2001:db8:0:f101::1,validate> /proc/krping  *  * krping "ping/pong" loop:  * 	client sends source rkey/addr/len  *	server receives source rkey/add/len  *	server rdma reads "ping" data from source  * 	server sends "go ahead" on rdma read completion  *	client sends sink rkey/addr/len  * 	server receives sink rkey/addr/len  * 	server rdma writes "pong" data to sink  * 	server sends "go ahead" on rdma write completion  *<repeat loop>  */
end_comment

begin_comment
comment|/*  * These states are used to signal events between the completion handler  * and the main client or server thread.  *  * Once CONNECTED, they cycle through RDMA_READ_ADV, RDMA_WRITE_ADV,  * and RDMA_WRITE_COMPLETE for each ping.  */
end_comment

begin_enum
enum|enum
name|test_state
block|{
name|IDLE
init|=
literal|1
block|,
name|CONNECT_REQUEST
block|,
name|ADDR_RESOLVED
block|,
name|ROUTE_RESOLVED
block|,
name|CONNECTED
block|,
name|RDMA_READ_ADV
block|,
name|RDMA_READ_COMPLETE
block|,
name|RDMA_WRITE_ADV
block|,
name|RDMA_WRITE_COMPLETE
block|,
name|ERROR
block|}
enum|;
end_enum

begin_struct
struct|struct
name|krping_rdma_info
block|{
name|uint64_t
name|buf
decl_stmt|;
name|uint32_t
name|rkey
decl_stmt|;
name|uint32_t
name|size
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * Default max buffer size for IO...  */
end_comment

begin_define
define|#
directive|define
name|RPING_BUFSIZE
value|128*1024
end_define

begin_define
define|#
directive|define
name|RPING_SQ_DEPTH
value|64
end_define

begin_comment
comment|/*  * Control block struct.  */
end_comment

begin_struct
struct|struct
name|krping_cb
block|{
name|int
name|server
decl_stmt|;
comment|/* 0 iff client */
name|struct
name|ib_cq
modifier|*
name|cq
decl_stmt|;
name|struct
name|ib_pd
modifier|*
name|pd
decl_stmt|;
name|struct
name|ib_qp
modifier|*
name|qp
decl_stmt|;
name|struct
name|ib_mr
modifier|*
name|dma_mr
decl_stmt|;
name|struct
name|ib_fast_reg_page_list
modifier|*
name|page_list
decl_stmt|;
name|int
name|page_list_len
decl_stmt|;
name|struct
name|ib_reg_wr
name|reg_mr_wr
decl_stmt|;
name|struct
name|ib_send_wr
name|invalidate_wr
decl_stmt|;
name|struct
name|ib_mr
modifier|*
name|reg_mr
decl_stmt|;
name|int
name|server_invalidate
decl_stmt|;
name|int
name|read_inv
decl_stmt|;
name|u8
name|key
decl_stmt|;
name|struct
name|ib_recv_wr
name|rq_wr
decl_stmt|;
comment|/* recv work request record */
name|struct
name|ib_sge
name|recv_sgl
decl_stmt|;
comment|/* recv single SGE */
name|struct
name|krping_rdma_info
name|recv_buf
name|__aligned
argument_list|(
literal|16
argument_list|)
decl_stmt|;
comment|/* malloc'd buffer */
name|u64
name|recv_dma_addr
decl_stmt|;
name|DECLARE_PCI_UNMAP_ADDR
argument_list|(
argument|recv_mapping
argument_list|)
name|struct
name|ib_send_wr
name|sq_wr
decl_stmt|;
comment|/* send work requrest record */
name|struct
name|ib_sge
name|send_sgl
decl_stmt|;
name|struct
name|krping_rdma_info
name|send_buf
name|__aligned
argument_list|(
literal|16
argument_list|)
decl_stmt|;
comment|/* single send buf */
name|u64
name|send_dma_addr
decl_stmt|;
name|DECLARE_PCI_UNMAP_ADDR
argument_list|(
argument|send_mapping
argument_list|)
name|struct
name|ib_rdma_wr
name|rdma_sq_wr
decl_stmt|;
comment|/* rdma work request record */
name|struct
name|ib_sge
name|rdma_sgl
decl_stmt|;
comment|/* rdma single SGE */
name|char
modifier|*
name|rdma_buf
decl_stmt|;
comment|/* used as rdma sink */
name|u64
name|rdma_dma_addr
decl_stmt|;
name|DECLARE_PCI_UNMAP_ADDR
argument_list|(
argument|rdma_mapping
argument_list|)
name|struct
name|ib_mr
modifier|*
name|rdma_mr
decl_stmt|;
name|uint32_t
name|remote_rkey
decl_stmt|;
comment|/* remote guys RKEY */
name|uint64_t
name|remote_addr
decl_stmt|;
comment|/* remote guys TO */
name|uint32_t
name|remote_len
decl_stmt|;
comment|/* remote guys LEN */
name|char
modifier|*
name|start_buf
decl_stmt|;
comment|/* rdma read src */
name|u64
name|start_dma_addr
decl_stmt|;
name|DECLARE_PCI_UNMAP_ADDR
argument_list|(
argument|start_mapping
argument_list|)
name|struct
name|ib_mr
modifier|*
name|start_mr
decl_stmt|;
name|enum
name|test_state
name|state
decl_stmt|;
comment|/* used for cond/signalling */
name|wait_queue_head_t
name|sem
decl_stmt|;
name|struct
name|krping_stats
name|stats
decl_stmt|;
name|uint16_t
name|port
decl_stmt|;
comment|/* dst port in NBO */
name|u8
name|addr
index|[
literal|16
index|]
decl_stmt|;
comment|/* dst addr in NBO */
name|char
modifier|*
name|addr_str
decl_stmt|;
comment|/* dst addr string */
name|uint8_t
name|addr_type
decl_stmt|;
comment|/* ADDR_FAMILY - IPv4/V6 */
name|int
name|verbose
decl_stmt|;
comment|/* verbose logging */
name|int
name|count
decl_stmt|;
comment|/* ping count */
name|int
name|size
decl_stmt|;
comment|/* ping data size */
name|int
name|validate
decl_stmt|;
comment|/* validate ping data */
name|int
name|wlat
decl_stmt|;
comment|/* run wlat test */
name|int
name|rlat
decl_stmt|;
comment|/* run rlat test */
name|int
name|bw
decl_stmt|;
comment|/* run bw test */
name|int
name|duplex
decl_stmt|;
comment|/* run bw full duplex test */
name|int
name|poll
decl_stmt|;
comment|/* poll or block for rlat test */
name|int
name|txdepth
decl_stmt|;
comment|/* SQ depth */
name|int
name|local_dma_lkey
decl_stmt|;
comment|/* use 0 for lkey */
name|int
name|frtest
decl_stmt|;
comment|/* reg test */
comment|/* CM stuff */
name|struct
name|rdma_cm_id
modifier|*
name|cm_id
decl_stmt|;
comment|/* connection on client side,*/
comment|/* listener on server side. */
name|struct
name|rdma_cm_id
modifier|*
name|child_cm_id
decl_stmt|;
comment|/* connection on server side */
name|struct
name|list_head
name|list
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|krping_cma_event_handler
parameter_list|(
name|struct
name|rdma_cm_id
modifier|*
name|cma_id
parameter_list|,
name|struct
name|rdma_cm_event
modifier|*
name|event
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|krping_cb
modifier|*
name|cb
init|=
name|cma_id
operator|->
name|context
decl_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"cma_event type %d cma_id %p (%s)\n"
argument_list|,
name|event
operator|->
name|event
argument_list|,
name|cma_id
argument_list|,
operator|(
name|cma_id
operator|==
name|cb
operator|->
name|cm_id
operator|)
condition|?
literal|"parent"
else|:
literal|"child"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|event
operator|->
name|event
condition|)
block|{
case|case
name|RDMA_CM_EVENT_ADDR_RESOLVED
case|:
name|cb
operator|->
name|state
operator|=
name|ADDR_RESOLVED
expr_stmt|;
name|ret
operator|=
name|rdma_resolve_route
argument_list|(
name|cma_id
argument_list|,
literal|2000
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"rdma_resolve_route error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
name|wake_up_interruptible
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|RDMA_CM_EVENT_ROUTE_RESOLVED
case|:
name|cb
operator|->
name|state
operator|=
name|ROUTE_RESOLVED
expr_stmt|;
name|wake_up_interruptible
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
break|break;
case|case
name|RDMA_CM_EVENT_CONNECT_REQUEST
case|:
name|cb
operator|->
name|state
operator|=
name|CONNECT_REQUEST
expr_stmt|;
name|cb
operator|->
name|child_cm_id
operator|=
name|cma_id
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"child cma %p\n"
argument_list|,
name|cb
operator|->
name|child_cm_id
argument_list|)
expr_stmt|;
name|wake_up_interruptible
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
break|break;
case|case
name|RDMA_CM_EVENT_ESTABLISHED
case|:
name|DEBUG_LOG
argument_list|(
literal|"ESTABLISHED\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
operator|->
name|server
condition|)
block|{
name|cb
operator|->
name|state
operator|=
name|CONNECTED
expr_stmt|;
block|}
name|wake_up_interruptible
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
break|break;
case|case
name|RDMA_CM_EVENT_ADDR_ERROR
case|:
case|case
name|RDMA_CM_EVENT_ROUTE_ERROR
case|:
case|case
name|RDMA_CM_EVENT_CONNECT_ERROR
case|:
case|case
name|RDMA_CM_EVENT_UNREACHABLE
case|:
case|case
name|RDMA_CM_EVENT_REJECTED
case|:
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"cma event %d, error %d\n"
argument_list|,
argument|event->event
argument_list|,
argument|event->status
argument_list|)
empty_stmt|;
name|cb
operator|->
name|state
operator|=
name|ERROR
expr_stmt|;
name|wake_up_interruptible
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
break|break;
case|case
name|RDMA_CM_EVENT_DISCONNECTED
case|:
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"DISCONNECT EVENT...\n"
argument_list|)
empty_stmt|;
name|cb
operator|->
name|state
operator|=
name|ERROR
expr_stmt|;
name|wake_up_interruptible
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
break|break;
case|case
name|RDMA_CM_EVENT_DEVICE_REMOVAL
case|:
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"cma detected device removal!!!!\n"
argument_list|)
empty_stmt|;
break|break;
default|default:
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"oof bad type!\n"
argument_list|)
empty_stmt|;
name|wake_up_interruptible
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|server_recv
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|,
name|struct
name|ib_wc
modifier|*
name|wc
parameter_list|)
block|{
if|if
condition|(
name|wc
operator|->
name|byte_len
operator|!=
sizeof|sizeof
argument_list|(
name|cb
operator|->
name|recv_buf
argument_list|)
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"Received bogus data, size %d\n"
argument_list|,
argument|wc->byte_len
argument_list|)
empty_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|cb
operator|->
name|remote_rkey
operator|=
name|ntohl
argument_list|(
name|cb
operator|->
name|recv_buf
operator|.
name|rkey
argument_list|)
expr_stmt|;
name|cb
operator|->
name|remote_addr
operator|=
name|ntohll
argument_list|(
name|cb
operator|->
name|recv_buf
operator|.
name|buf
argument_list|)
expr_stmt|;
name|cb
operator|->
name|remote_len
operator|=
name|ntohl
argument_list|(
name|cb
operator|->
name|recv_buf
operator|.
name|size
argument_list|)
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"Received rkey %x addr %llx len %d from peer\n"
argument_list|,
name|cb
operator|->
name|remote_rkey
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|cb
operator|->
name|remote_addr
argument_list|,
name|cb
operator|->
name|remote_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|<=
name|CONNECTED
operator|||
name|cb
operator|->
name|state
operator|==
name|RDMA_WRITE_COMPLETE
condition|)
name|cb
operator|->
name|state
operator|=
name|RDMA_READ_ADV
expr_stmt|;
else|else
name|cb
operator|->
name|state
operator|=
name|RDMA_WRITE_ADV
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|client_recv
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|,
name|struct
name|ib_wc
modifier|*
name|wc
parameter_list|)
block|{
if|if
condition|(
name|wc
operator|->
name|byte_len
operator|!=
sizeof|sizeof
argument_list|(
name|cb
operator|->
name|recv_buf
argument_list|)
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"Received bogus data, size %d\n"
argument_list|,
argument|wc->byte_len
argument_list|)
empty_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|cb
operator|->
name|state
operator|==
name|RDMA_READ_ADV
condition|)
name|cb
operator|->
name|state
operator|=
name|RDMA_WRITE_ADV
expr_stmt|;
else|else
name|cb
operator|->
name|state
operator|=
name|RDMA_WRITE_COMPLETE
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_cq_event_handler
parameter_list|(
name|struct
name|ib_cq
modifier|*
name|cq
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|krping_cb
modifier|*
name|cb
init|=
name|ctx
decl_stmt|;
name|struct
name|ib_wc
name|wc
decl_stmt|;
name|struct
name|ib_recv_wr
modifier|*
name|bad_wr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|BUG_ON
argument_list|(
name|cb
operator|->
name|cq
operator|!=
name|cq
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|==
name|ERROR
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"cq completion in ERROR state\n"
argument_list|)
empty_stmt|;
return|return;
block|}
if|if
condition|(
name|cb
operator|->
name|frtest
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"cq completion event in frtest!\n"
argument_list|)
empty_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|cb
operator|->
name|wlat
operator|&&
operator|!
name|cb
operator|->
name|rlat
operator|&&
operator|!
name|cb
operator|->
name|bw
condition|)
name|ib_req_notify_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
name|IB_CQ_NEXT_COMP
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|ret
operator|=
name|ib_poll_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
literal|1
argument_list|,
operator|&
name|wc
argument_list|)
operator|)
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|wc
operator|.
name|status
condition|)
block|{
if|if
condition|(
name|wc
operator|.
name|status
operator|==
name|IB_WC_WR_FLUSH_ERR
condition|)
block|{
name|DEBUG_LOG
argument_list|(
literal|"cq flushed\n"
argument_list|)
expr_stmt|;
continue|continue;
block|}
else|else
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"cq completion failed with "
literal|"wr_id %jx status %d opcode %d vender_err %x\n"
argument_list|,
argument|(uintmax_t)wc.wr_id
argument_list|,
argument|wc.status
argument_list|,
argument|wc.opcode
argument_list|,
argument|wc.vendor_err
argument_list|)
empty_stmt|;
goto|goto
name|error
goto|;
block|}
block|}
switch|switch
condition|(
name|wc
operator|.
name|opcode
condition|)
block|{
case|case
name|IB_WC_SEND
case|:
name|DEBUG_LOG
argument_list|(
literal|"send completion\n"
argument_list|)
expr_stmt|;
name|cb
operator|->
name|stats
operator|.
name|send_bytes
operator|+=
name|cb
operator|->
name|send_sgl
operator|.
name|length
expr_stmt|;
name|cb
operator|->
name|stats
operator|.
name|send_msgs
operator|++
expr_stmt|;
break|break;
case|case
name|IB_WC_RDMA_WRITE
case|:
name|DEBUG_LOG
argument_list|(
literal|"rdma write completion\n"
argument_list|)
expr_stmt|;
name|cb
operator|->
name|stats
operator|.
name|write_bytes
operator|+=
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|sg_list
operator|->
name|length
expr_stmt|;
name|cb
operator|->
name|stats
operator|.
name|write_msgs
operator|++
expr_stmt|;
name|cb
operator|->
name|state
operator|=
name|RDMA_WRITE_COMPLETE
expr_stmt|;
name|wake_up_interruptible
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_WC_RDMA_READ
case|:
name|DEBUG_LOG
argument_list|(
literal|"rdma read completion\n"
argument_list|)
expr_stmt|;
name|cb
operator|->
name|stats
operator|.
name|read_bytes
operator|+=
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|sg_list
operator|->
name|length
expr_stmt|;
name|cb
operator|->
name|stats
operator|.
name|read_msgs
operator|++
expr_stmt|;
name|cb
operator|->
name|state
operator|=
name|RDMA_READ_COMPLETE
expr_stmt|;
name|wake_up_interruptible
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_WC_RECV
case|:
name|DEBUG_LOG
argument_list|(
literal|"recv completion\n"
argument_list|)
expr_stmt|;
name|cb
operator|->
name|stats
operator|.
name|recv_bytes
operator|+=
sizeof|sizeof
argument_list|(
name|cb
operator|->
name|recv_buf
argument_list|)
expr_stmt|;
name|cb
operator|->
name|stats
operator|.
name|recv_msgs
operator|++
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|wlat
operator|||
name|cb
operator|->
name|rlat
operator|||
name|cb
operator|->
name|bw
condition|)
name|ret
operator|=
name|server_recv
argument_list|(
name|cb
argument_list|,
operator|&
name|wc
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
name|cb
operator|->
name|server
condition|?
name|server_recv
argument_list|(
name|cb
argument_list|,
operator|&
name|wc
argument_list|)
else|:
name|client_recv
argument_list|(
name|cb
argument_list|,
operator|&
name|wc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"recv wc error: %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
goto|goto
name|error
goto|;
block|}
name|ret
operator|=
name|ib_post_recv
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|rq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"post recv error: %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
goto|goto
name|error
goto|;
block|}
name|wake_up_interruptible
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"%s:%d Unexpected opcode %d, Shutting down\n"
argument_list|,
argument|__func__
argument_list|,
argument|__LINE__
argument_list|,
argument|wc.opcode
argument_list|)
empty_stmt|;
goto|goto
name|error
goto|;
block|}
block|}
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"poll error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
goto|goto
name|error
goto|;
block|}
return|return;
name|error
label|:
name|cb
operator|->
name|state
operator|=
name|ERROR
expr_stmt|;
name|wake_up_interruptible
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|krping_accept
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|rdma_conn_param
name|conn_param
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"accepting client connection request\n"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|conn_param
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|conn_param
argument_list|)
expr_stmt|;
name|conn_param
operator|.
name|responder_resources
operator|=
literal|1
expr_stmt|;
name|conn_param
operator|.
name|initiator_depth
operator|=
literal|1
expr_stmt|;
name|ret
operator|=
name|rdma_accept
argument_list|(
name|cb
operator|->
name|child_cm_id
argument_list|,
operator|&
name|conn_param
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"rdma_accept error: %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
operator|!
name|cb
operator|->
name|wlat
operator|&&
operator|!
name|cb
operator|->
name|rlat
operator|&&
operator|!
name|cb
operator|->
name|bw
condition|)
block|{
name|wait_event_interruptible
argument_list|(
name|cb
operator|->
name|sem
argument_list|,
name|cb
operator|->
name|state
operator|>=
name|CONNECTED
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|==
name|ERROR
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"wait for CONNECTED state %d\n"
argument_list|,
argument|cb->state
argument_list|)
empty_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_setup_wr
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|cb
operator|->
name|recv_sgl
operator|.
name|addr
operator|=
name|cb
operator|->
name|recv_dma_addr
expr_stmt|;
name|cb
operator|->
name|recv_sgl
operator|.
name|length
operator|=
sizeof|sizeof
name|cb
operator|->
name|recv_buf
expr_stmt|;
name|cb
operator|->
name|recv_sgl
operator|.
name|lkey
operator|=
name|cb
operator|->
name|pd
operator|->
name|local_dma_lkey
expr_stmt|;
name|cb
operator|->
name|rq_wr
operator|.
name|sg_list
operator|=
operator|&
name|cb
operator|->
name|recv_sgl
expr_stmt|;
name|cb
operator|->
name|rq_wr
operator|.
name|num_sge
operator|=
literal|1
expr_stmt|;
name|cb
operator|->
name|send_sgl
operator|.
name|addr
operator|=
name|cb
operator|->
name|send_dma_addr
expr_stmt|;
name|cb
operator|->
name|send_sgl
operator|.
name|length
operator|=
sizeof|sizeof
name|cb
operator|->
name|send_buf
expr_stmt|;
name|cb
operator|->
name|send_sgl
operator|.
name|lkey
operator|=
name|cb
operator|->
name|pd
operator|->
name|local_dma_lkey
expr_stmt|;
name|cb
operator|->
name|sq_wr
operator|.
name|opcode
operator|=
name|IB_WR_SEND
expr_stmt|;
name|cb
operator|->
name|sq_wr
operator|.
name|send_flags
operator|=
name|IB_SEND_SIGNALED
expr_stmt|;
name|cb
operator|->
name|sq_wr
operator|.
name|sg_list
operator|=
operator|&
name|cb
operator|->
name|send_sgl
expr_stmt|;
name|cb
operator|->
name|sq_wr
operator|.
name|num_sge
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|server
operator|||
name|cb
operator|->
name|wlat
operator|||
name|cb
operator|->
name|rlat
operator|||
name|cb
operator|->
name|bw
condition|)
block|{
name|cb
operator|->
name|rdma_sgl
operator|.
name|addr
operator|=
name|cb
operator|->
name|rdma_dma_addr
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|send_flags
operator|=
name|IB_SEND_SIGNALED
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|sg_list
operator|=
operator|&
name|cb
operator|->
name|rdma_sgl
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|num_sge
operator|=
literal|1
expr_stmt|;
block|}
comment|/*  	 * A chain of 2 WRs, INVALDATE_MR + REG_MR. 	 * both unsignaled.  The client uses them to reregister 	 * the rdma buffers with a new key each iteration. 	 */
name|cb
operator|->
name|reg_mr_wr
operator|.
name|wr
operator|.
name|opcode
operator|=
name|IB_WR_REG_MR
expr_stmt|;
name|cb
operator|->
name|reg_mr_wr
operator|.
name|mr
operator|=
name|cb
operator|->
name|reg_mr
expr_stmt|;
name|cb
operator|->
name|invalidate_wr
operator|.
name|next
operator|=
operator|&
name|cb
operator|->
name|reg_mr_wr
operator|.
name|wr
expr_stmt|;
name|cb
operator|->
name|invalidate_wr
operator|.
name|opcode
operator|=
name|IB_WR_LOCAL_INV
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|krping_setup_buffers
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"krping_setup_buffers called on cb %p\n"
argument_list|,
name|cb
argument_list|)
expr_stmt|;
name|cb
operator|->
name|recv_dma_addr
operator|=
name|ib_dma_map_single
argument_list|(
name|cb
operator|->
name|pd
operator|->
name|device
argument_list|,
operator|&
name|cb
operator|->
name|recv_buf
argument_list|,
sizeof|sizeof
argument_list|(
name|cb
operator|->
name|recv_buf
argument_list|)
argument_list|,
name|DMA_BIDIRECTIONAL
argument_list|)
expr_stmt|;
name|pci_unmap_addr_set
argument_list|(
name|cb
argument_list|,
name|recv_mapping
argument_list|,
name|cb
operator|->
name|recv_dma_addr
argument_list|)
expr_stmt|;
name|cb
operator|->
name|send_dma_addr
operator|=
name|ib_dma_map_single
argument_list|(
name|cb
operator|->
name|pd
operator|->
name|device
argument_list|,
operator|&
name|cb
operator|->
name|send_buf
argument_list|,
sizeof|sizeof
argument_list|(
name|cb
operator|->
name|send_buf
argument_list|)
argument_list|,
name|DMA_BIDIRECTIONAL
argument_list|)
expr_stmt|;
name|pci_unmap_addr_set
argument_list|(
name|cb
argument_list|,
name|send_mapping
argument_list|,
name|cb
operator|->
name|send_dma_addr
argument_list|)
expr_stmt|;
name|cb
operator|->
name|rdma_buf
operator|=
name|ib_dma_alloc_coherent
argument_list|(
name|cb
operator|->
name|pd
operator|->
name|device
argument_list|,
name|cb
operator|->
name|size
argument_list|,
operator|&
name|cb
operator|->
name|rdma_dma_addr
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
operator|->
name|rdma_buf
condition|)
block|{
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"rdma_buf allocation failed\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|bail
goto|;
block|}
name|pci_unmap_addr_set
argument_list|(
name|cb
argument_list|,
name|rdma_mapping
argument_list|,
name|cb
operator|->
name|rdma_dma_addr
argument_list|)
expr_stmt|;
name|cb
operator|->
name|page_list_len
operator|=
operator|(
operator|(
operator|(
name|cb
operator|->
name|size
operator|-
literal|1
operator|)
operator|&
name|PAGE_MASK
operator|)
operator|+
name|PAGE_SIZE
operator|)
operator|>>
name|PAGE_SHIFT
expr_stmt|;
name|cb
operator|->
name|reg_mr
operator|=
name|ib_alloc_mr
argument_list|(
name|cb
operator|->
name|pd
argument_list|,
name|IB_MR_TYPE_MEM_REG
argument_list|,
name|cb
operator|->
name|page_list_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|cb
operator|->
name|reg_mr
argument_list|)
condition|)
block|{
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|cb
operator|->
name|reg_mr
argument_list|)
expr_stmt|;
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"recv_buf reg_mr failed %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|bail
goto|;
block|}
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"reg rkey 0x%x page_list_len %u\n"
argument_list|,
name|cb
operator|->
name|reg_mr
operator|->
name|rkey
argument_list|,
name|cb
operator|->
name|page_list_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
operator|->
name|server
operator|||
name|cb
operator|->
name|wlat
operator|||
name|cb
operator|->
name|rlat
operator|||
name|cb
operator|->
name|bw
condition|)
block|{
name|cb
operator|->
name|start_buf
operator|=
name|ib_dma_alloc_coherent
argument_list|(
name|cb
operator|->
name|pd
operator|->
name|device
argument_list|,
name|cb
operator|->
name|size
argument_list|,
operator|&
name|cb
operator|->
name|start_dma_addr
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
operator|->
name|start_buf
condition|)
block|{
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"start_buf malloc failed\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|bail
goto|;
block|}
name|pci_unmap_addr_set
argument_list|(
name|cb
argument_list|,
name|start_mapping
argument_list|,
name|cb
operator|->
name|start_dma_addr
argument_list|)
expr_stmt|;
block|}
name|krping_setup_wr
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"allocated& registered buffers...\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|bail
label|:
if|if
condition|(
name|cb
operator|->
name|reg_mr
operator|&&
operator|!
name|IS_ERR
argument_list|(
name|cb
operator|->
name|reg_mr
argument_list|)
condition|)
name|ib_dereg_mr
argument_list|(
name|cb
operator|->
name|reg_mr
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|rdma_mr
operator|&&
operator|!
name|IS_ERR
argument_list|(
name|cb
operator|->
name|rdma_mr
argument_list|)
condition|)
name|ib_dereg_mr
argument_list|(
name|cb
operator|->
name|rdma_mr
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|dma_mr
operator|&&
operator|!
name|IS_ERR
argument_list|(
name|cb
operator|->
name|dma_mr
argument_list|)
condition|)
name|ib_dereg_mr
argument_list|(
name|cb
operator|->
name|dma_mr
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|rdma_buf
condition|)
block|{
name|ib_dma_free_coherent
argument_list|(
name|cb
operator|->
name|pd
operator|->
name|device
argument_list|,
name|cb
operator|->
name|size
argument_list|,
name|cb
operator|->
name|rdma_buf
argument_list|,
name|cb
operator|->
name|rdma_dma_addr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cb
operator|->
name|start_buf
condition|)
block|{
name|ib_dma_free_coherent
argument_list|(
name|cb
operator|->
name|pd
operator|->
name|device
argument_list|,
name|cb
operator|->
name|size
argument_list|,
name|cb
operator|->
name|start_buf
argument_list|,
name|cb
operator|->
name|start_dma_addr
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_free_buffers
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|DEBUG_LOG
argument_list|(
literal|"krping_free_buffers called on cb %p\n"
argument_list|,
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|dma_mr
condition|)
name|ib_dereg_mr
argument_list|(
name|cb
operator|->
name|dma_mr
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|rdma_mr
condition|)
name|ib_dereg_mr
argument_list|(
name|cb
operator|->
name|rdma_mr
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|start_mr
condition|)
name|ib_dereg_mr
argument_list|(
name|cb
operator|->
name|start_mr
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|reg_mr
condition|)
name|ib_dereg_mr
argument_list|(
name|cb
operator|->
name|reg_mr
argument_list|)
expr_stmt|;
name|dma_unmap_single
argument_list|(
name|cb
operator|->
name|pd
operator|->
name|device
operator|->
name|dma_device
argument_list|,
name|pci_unmap_addr
argument_list|(
name|cb
argument_list|,
name|recv_mapping
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|cb
operator|->
name|recv_buf
argument_list|)
argument_list|,
name|DMA_BIDIRECTIONAL
argument_list|)
expr_stmt|;
name|dma_unmap_single
argument_list|(
name|cb
operator|->
name|pd
operator|->
name|device
operator|->
name|dma_device
argument_list|,
name|pci_unmap_addr
argument_list|(
name|cb
argument_list|,
name|send_mapping
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|cb
operator|->
name|send_buf
argument_list|)
argument_list|,
name|DMA_BIDIRECTIONAL
argument_list|)
expr_stmt|;
name|ib_dma_free_coherent
argument_list|(
name|cb
operator|->
name|pd
operator|->
name|device
argument_list|,
name|cb
operator|->
name|size
argument_list|,
name|cb
operator|->
name|rdma_buf
argument_list|,
name|cb
operator|->
name|rdma_dma_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|start_buf
condition|)
block|{
name|ib_dma_free_coherent
argument_list|(
name|cb
operator|->
name|pd
operator|->
name|device
argument_list|,
name|cb
operator|->
name|size
argument_list|,
name|cb
operator|->
name|start_buf
argument_list|,
name|cb
operator|->
name|start_dma_addr
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|krping_create_qp
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ib_qp_init_attr
name|init_attr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|memset
argument_list|(
operator|&
name|init_attr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|init_attr
argument_list|)
argument_list|)
expr_stmt|;
name|init_attr
operator|.
name|cap
operator|.
name|max_send_wr
operator|=
name|cb
operator|->
name|txdepth
expr_stmt|;
name|init_attr
operator|.
name|cap
operator|.
name|max_recv_wr
operator|=
literal|2
expr_stmt|;
comment|/* For flush_qp() */
name|init_attr
operator|.
name|cap
operator|.
name|max_send_wr
operator|++
expr_stmt|;
name|init_attr
operator|.
name|cap
operator|.
name|max_recv_wr
operator|++
expr_stmt|;
name|init_attr
operator|.
name|cap
operator|.
name|max_recv_sge
operator|=
literal|1
expr_stmt|;
name|init_attr
operator|.
name|cap
operator|.
name|max_send_sge
operator|=
literal|1
expr_stmt|;
name|init_attr
operator|.
name|qp_type
operator|=
name|IB_QPT_RC
expr_stmt|;
name|init_attr
operator|.
name|send_cq
operator|=
name|cb
operator|->
name|cq
expr_stmt|;
name|init_attr
operator|.
name|recv_cq
operator|=
name|cb
operator|->
name|cq
expr_stmt|;
name|init_attr
operator|.
name|sq_sig_type
operator|=
name|IB_SIGNAL_REQ_WR
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|server
condition|)
block|{
name|ret
operator|=
name|rdma_create_qp
argument_list|(
name|cb
operator|->
name|child_cm_id
argument_list|,
name|cb
operator|->
name|pd
argument_list|,
operator|&
name|init_attr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|cb
operator|->
name|qp
operator|=
name|cb
operator|->
name|child_cm_id
operator|->
name|qp
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|rdma_create_qp
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|,
name|cb
operator|->
name|pd
argument_list|,
operator|&
name|init_attr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|cb
operator|->
name|qp
operator|=
name|cb
operator|->
name|cm_id
operator|->
name|qp
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_free_qp
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|ib_destroy_qp
argument_list|(
name|cb
operator|->
name|qp
argument_list|)
expr_stmt|;
name|ib_destroy_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|)
expr_stmt|;
name|ib_dealloc_pd
argument_list|(
name|cb
operator|->
name|pd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|krping_setup_qp
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|,
name|struct
name|rdma_cm_id
modifier|*
name|cm_id
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|ib_cq_init_attr
name|attr
init|=
block|{
literal|0
block|}
decl_stmt|;
name|cb
operator|->
name|pd
operator|=
name|ib_alloc_pd
argument_list|(
name|cm_id
operator|->
name|device
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|cb
operator|->
name|pd
argument_list|)
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"ib_alloc_pd failed\n"
argument_list|)
empty_stmt|;
return|return
name|PTR_ERR
argument_list|(
name|cb
operator|->
name|pd
argument_list|)
return|;
block|}
name|DEBUG_LOG
argument_list|(
literal|"created pd %p\n"
argument_list|,
name|cb
operator|->
name|pd
argument_list|)
expr_stmt|;
name|strlcpy
argument_list|(
name|cb
operator|->
name|stats
operator|.
name|name
argument_list|,
name|cb
operator|->
name|pd
operator|->
name|device
operator|->
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|cb
operator|->
name|stats
operator|.
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|attr
operator|.
name|cqe
operator|=
name|cb
operator|->
name|txdepth
operator|*
literal|2
expr_stmt|;
name|attr
operator|.
name|comp_vector
operator|=
literal|0
expr_stmt|;
name|cb
operator|->
name|cq
operator|=
name|ib_create_cq
argument_list|(
name|cm_id
operator|->
name|device
argument_list|,
name|krping_cq_event_handler
argument_list|,
name|NULL
argument_list|,
name|cb
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|cb
operator|->
name|cq
argument_list|)
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"ib_create_cq failed\n"
argument_list|)
empty_stmt|;
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|cb
operator|->
name|cq
argument_list|)
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
name|DEBUG_LOG
argument_list|(
literal|"created cq %p\n"
argument_list|,
name|cb
operator|->
name|cq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
operator|->
name|wlat
operator|&&
operator|!
name|cb
operator|->
name|rlat
operator|&&
operator|!
name|cb
operator|->
name|bw
operator|&&
operator|!
name|cb
operator|->
name|frtest
condition|)
block|{
name|ret
operator|=
name|ib_req_notify_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
name|IB_CQ_NEXT_COMP
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"ib_create_cq failed\n"
argument_list|)
empty_stmt|;
goto|goto
name|err2
goto|;
block|}
block|}
name|ret
operator|=
name|krping_create_qp
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"krping_create_qp failed: %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
goto|goto
name|err2
goto|;
block|}
name|DEBUG_LOG
argument_list|(
literal|"created qp %p\n"
argument_list|,
name|cb
operator|->
name|qp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|err2
label|:
name|ib_destroy_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|)
expr_stmt|;
name|err1
label|:
name|ib_dealloc_pd
argument_list|(
name|cb
operator|->
name|pd
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/*  * return the (possibly rebound) rkey for the rdma buffer.  * REG mode: invalidate and rebind via reg wr.  * other modes: just return the mr rkey.  */
end_comment

begin_function
specifier|static
name|u32
name|krping_rdma_rkey
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|,
name|u64
name|buf
parameter_list|,
name|int
name|post_inv
parameter_list|)
block|{
name|u32
name|rkey
decl_stmt|;
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|scatterlist
name|sg
init|=
block|{
literal|0
block|}
decl_stmt|;
name|cb
operator|->
name|invalidate_wr
operator|.
name|ex
operator|.
name|invalidate_rkey
operator|=
name|cb
operator|->
name|reg_mr
operator|->
name|rkey
expr_stmt|;
comment|/* 	 * Update the reg key. 	 */
name|ib_update_fast_reg_key
argument_list|(
name|cb
operator|->
name|reg_mr
argument_list|,
operator|++
name|cb
operator|->
name|key
argument_list|)
expr_stmt|;
name|cb
operator|->
name|reg_mr_wr
operator|.
name|key
operator|=
name|cb
operator|->
name|reg_mr
operator|->
name|rkey
expr_stmt|;
comment|/* 	 * Update the reg WR with new buf info. 	 */
if|if
condition|(
name|buf
operator|==
operator|(
name|u64
operator|)
name|cb
operator|->
name|start_dma_addr
condition|)
name|cb
operator|->
name|reg_mr_wr
operator|.
name|access
operator|=
name|IB_ACCESS_REMOTE_READ
expr_stmt|;
else|else
name|cb
operator|->
name|reg_mr_wr
operator|.
name|access
operator|=
name|IB_ACCESS_REMOTE_WRITE
operator||
name|IB_ACCESS_LOCAL_WRITE
expr_stmt|;
name|sg_dma_address
argument_list|(
operator|&
name|sg
argument_list|)
operator|=
name|buf
expr_stmt|;
name|sg_dma_len
argument_list|(
operator|&
name|sg
argument_list|)
operator|=
name|cb
operator|->
name|size
expr_stmt|;
name|ret
operator|=
name|ib_map_mr_sg
argument_list|(
name|cb
operator|->
name|reg_mr
argument_list|,
operator|&
name|sg
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|,
name|PAGE_SIZE
argument_list|)
expr_stmt|;
name|BUG_ON
argument_list|(
name|ret
operator|<=
literal|0
operator|||
name|ret
operator|>
name|cb
operator|->
name|page_list_len
argument_list|)
expr_stmt|;
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"post_inv = %d, reg_mr new rkey 0x%x pgsz %u len %u"
literal|" iova_start %llx\n"
argument_list|,
name|post_inv
argument_list|,
name|cb
operator|->
name|reg_mr_wr
operator|.
name|key
argument_list|,
name|cb
operator|->
name|reg_mr
operator|->
name|page_size
argument_list|,
name|cb
operator|->
name|reg_mr
operator|->
name|length
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|cb
operator|->
name|reg_mr
operator|->
name|iova
argument_list|)
expr_stmt|;
if|if
condition|(
name|post_inv
condition|)
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|invalidate_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|reg_mr_wr
operator|.
name|wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"post send error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
name|cb
operator|->
name|state
operator|=
name|ERROR
expr_stmt|;
block|}
name|rkey
operator|=
name|cb
operator|->
name|reg_mr
operator|->
name|rkey
expr_stmt|;
return|return
name|rkey
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_format_send
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|,
name|u64
name|buf
parameter_list|)
block|{
name|struct
name|krping_rdma_info
modifier|*
name|info
init|=
operator|&
name|cb
operator|->
name|send_buf
decl_stmt|;
name|u32
name|rkey
decl_stmt|;
comment|/* 	 * Client side will do reg or mw bind before 	 * advertising the rdma buffer.  Server side 	 * sends have no data. 	 */
if|if
condition|(
operator|!
name|cb
operator|->
name|server
operator|||
name|cb
operator|->
name|wlat
operator|||
name|cb
operator|->
name|rlat
operator|||
name|cb
operator|->
name|bw
condition|)
block|{
name|rkey
operator|=
name|krping_rdma_rkey
argument_list|(
name|cb
argument_list|,
name|buf
argument_list|,
operator|!
name|cb
operator|->
name|server_invalidate
argument_list|)
expr_stmt|;
name|info
operator|->
name|buf
operator|=
name|htonll
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|info
operator|->
name|rkey
operator|=
name|htonl
argument_list|(
name|rkey
argument_list|)
expr_stmt|;
name|info
operator|->
name|size
operator|=
name|htonl
argument_list|(
name|cb
operator|->
name|size
argument_list|)
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"RDMA addr %llx rkey %x len %d\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|buf
argument_list|,
name|rkey
argument_list|,
name|cb
operator|->
name|size
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|krping_test_server
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|,
name|inv
decl_stmt|;
name|int
name|ret
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
comment|/* Wait for client's Start STAG/TO/Len */
name|wait_event_interruptible
argument_list|(
name|cb
operator|->
name|sem
argument_list|,
name|cb
operator|->
name|state
operator|>=
name|RDMA_READ_ADV
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|!=
name|RDMA_READ_ADV
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"wait for RDMA_READ_ADV state %d\n"
argument_list|,
argument|cb->state
argument_list|)
empty_stmt|;
break|break;
block|}
name|DEBUG_LOG
argument_list|(
literal|"server received sink adv\n"
argument_list|)
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|rkey
operator|=
name|cb
operator|->
name|remote_rkey
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|remote_addr
operator|=
name|cb
operator|->
name|remote_addr
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|sg_list
operator|->
name|length
operator|=
name|cb
operator|->
name|remote_len
expr_stmt|;
name|cb
operator|->
name|rdma_sgl
operator|.
name|lkey
operator|=
name|krping_rdma_rkey
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|rdma_dma_addr
argument_list|,
operator|!
name|cb
operator|->
name|read_inv
argument_list|)
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
comment|/* Issue RDMA Read. */
if|if
condition|(
name|cb
operator|->
name|read_inv
condition|)
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|opcode
operator|=
name|IB_WR_RDMA_READ_WITH_INV
expr_stmt|;
else|else
block|{
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|opcode
operator|=
name|IB_WR_RDMA_READ
expr_stmt|;
comment|/*  			 * Immediately follow the read with a  			 * fenced LOCAL_INV. 			 */
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|next
operator|=
operator|&
name|inv
expr_stmt|;
name|memset
argument_list|(
operator|&
name|inv
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|inv
argument_list|)
expr_stmt|;
name|inv
operator|.
name|opcode
operator|=
name|IB_WR_LOCAL_INV
expr_stmt|;
name|inv
operator|.
name|ex
operator|.
name|invalidate_rkey
operator|=
name|cb
operator|->
name|reg_mr
operator|->
name|rkey
expr_stmt|;
name|inv
operator|.
name|send_flags
operator|=
name|IB_SEND_FENCE
expr_stmt|;
block|}
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"post send error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
break|break;
block|}
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|next
operator|=
name|NULL
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"server posted rdma read req \n"
argument_list|)
expr_stmt|;
comment|/* Wait for read completion */
name|wait_event_interruptible
argument_list|(
name|cb
operator|->
name|sem
argument_list|,
name|cb
operator|->
name|state
operator|>=
name|RDMA_READ_COMPLETE
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|!=
name|RDMA_READ_COMPLETE
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"wait for RDMA_READ_COMPLETE state %d\n"
argument_list|,
argument|cb->state
argument_list|)
empty_stmt|;
break|break;
block|}
name|DEBUG_LOG
argument_list|(
literal|"server received read complete\n"
argument_list|)
expr_stmt|;
comment|/* Display data in recv buf */
if|if
condition|(
name|cb
operator|->
name|verbose
condition|)
name|printk
argument_list|(
argument|KERN_INFO PFX
literal|"server ping data: %s\n"
argument_list|,
argument|cb->rdma_buf
argument_list|)
empty_stmt|;
comment|/* Tell client to continue */
if|if
condition|(
name|cb
operator|->
name|server
operator|&&
name|cb
operator|->
name|server_invalidate
condition|)
block|{
name|cb
operator|->
name|sq_wr
operator|.
name|ex
operator|.
name|invalidate_rkey
operator|=
name|cb
operator|->
name|remote_rkey
expr_stmt|;
name|cb
operator|->
name|sq_wr
operator|.
name|opcode
operator|=
name|IB_WR_SEND_WITH_INV
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"send-w-inv rkey 0x%x\n"
argument_list|,
name|cb
operator|->
name|remote_rkey
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"post send error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
break|break;
block|}
name|DEBUG_LOG
argument_list|(
literal|"server posted go ahead\n"
argument_list|)
expr_stmt|;
comment|/* Wait for client's RDMA STAG/TO/Len */
name|wait_event_interruptible
argument_list|(
name|cb
operator|->
name|sem
argument_list|,
name|cb
operator|->
name|state
operator|>=
name|RDMA_WRITE_ADV
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|!=
name|RDMA_WRITE_ADV
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"wait for RDMA_WRITE_ADV state %d\n"
argument_list|,
argument|cb->state
argument_list|)
empty_stmt|;
break|break;
block|}
name|DEBUG_LOG
argument_list|(
literal|"server received sink adv\n"
argument_list|)
expr_stmt|;
comment|/* RDMA Write echo data */
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|opcode
operator|=
name|IB_WR_RDMA_WRITE
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|rkey
operator|=
name|cb
operator|->
name|remote_rkey
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|remote_addr
operator|=
name|cb
operator|->
name|remote_addr
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|sg_list
operator|->
name|length
operator|=
name|strlen
argument_list|(
name|cb
operator|->
name|rdma_buf
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|local_dma_lkey
condition|)
name|cb
operator|->
name|rdma_sgl
operator|.
name|lkey
operator|=
name|cb
operator|->
name|pd
operator|->
name|local_dma_lkey
expr_stmt|;
else|else
name|cb
operator|->
name|rdma_sgl
operator|.
name|lkey
operator|=
name|krping_rdma_rkey
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|rdma_dma_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"rdma write from lkey %x laddr %llx len %d\n"
argument_list|,
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|sg_list
operator|->
name|lkey
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|sg_list
operator|->
name|addr
argument_list|,
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|sg_list
operator|->
name|length
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"post send error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
break|break;
block|}
comment|/* Wait for completion */
name|ret
operator|=
name|wait_event_interruptible
argument_list|(
name|cb
operator|->
name|sem
argument_list|,
name|cb
operator|->
name|state
operator|>=
name|RDMA_WRITE_COMPLETE
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|!=
name|RDMA_WRITE_COMPLETE
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"wait for RDMA_WRITE_COMPLETE state %d\n"
argument_list|,
argument|cb->state
argument_list|)
empty_stmt|;
break|break;
block|}
name|DEBUG_LOG
argument_list|(
literal|"server rdma write complete \n"
argument_list|)
expr_stmt|;
name|cb
operator|->
name|state
operator|=
name|CONNECTED
expr_stmt|;
comment|/* Tell client to begin again */
if|if
condition|(
name|cb
operator|->
name|server
operator|&&
name|cb
operator|->
name|server_invalidate
condition|)
block|{
name|cb
operator|->
name|sq_wr
operator|.
name|ex
operator|.
name|invalidate_rkey
operator|=
name|cb
operator|->
name|remote_rkey
expr_stmt|;
name|cb
operator|->
name|sq_wr
operator|.
name|opcode
operator|=
name|IB_WR_SEND_WITH_INV
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"send-w-inv rkey 0x%x\n"
argument_list|,
name|cb
operator|->
name|remote_rkey
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"post send error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
break|break;
block|}
name|DEBUG_LOG
argument_list|(
literal|"server posted go ahead\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rlat_test
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|int
name|scnt
decl_stmt|;
name|int
name|iters
init|=
name|cb
operator|->
name|count
decl_stmt|;
name|struct
name|timeval
name|start_tv
decl_stmt|,
name|stop_tv
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|ib_wc
name|wc
decl_stmt|;
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
name|int
name|ne
decl_stmt|;
name|scnt
operator|=
literal|0
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|opcode
operator|=
name|IB_WR_RDMA_READ
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|rkey
operator|=
name|cb
operator|->
name|remote_rkey
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|remote_addr
operator|=
name|cb
operator|->
name|remote_addr
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|sg_list
operator|->
name|length
operator|=
name|cb
operator|->
name|size
expr_stmt|;
name|microtime
argument_list|(
operator|&
name|start_tv
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
operator|->
name|poll
condition|)
block|{
name|cb
operator|->
name|state
operator|=
name|RDMA_READ_ADV
expr_stmt|;
name|ib_req_notify_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
name|IB_CQ_NEXT_COMP
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|scnt
operator|<
name|iters
condition|)
block|{
name|cb
operator|->
name|state
operator|=
name|RDMA_READ_ADV
expr_stmt|;
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"Couldn't post send: ret=%d scnt %d\n"
argument_list|,
argument|ret
argument_list|,
argument|scnt
argument_list|)
empty_stmt|;
return|return;
block|}
do|do
block|{
if|if
condition|(
operator|!
name|cb
operator|->
name|poll
condition|)
block|{
name|wait_event_interruptible
argument_list|(
name|cb
operator|->
name|sem
argument_list|,
name|cb
operator|->
name|state
operator|!=
name|RDMA_READ_ADV
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|==
name|RDMA_READ_COMPLETE
condition|)
block|{
name|ne
operator|=
literal|1
expr_stmt|;
name|ib_req_notify_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
name|IB_CQ_NEXT_COMP
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ne
operator|=
operator|-
literal|1
expr_stmt|;
block|}
block|}
else|else
name|ne
operator|=
name|ib_poll_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
literal|1
argument_list|,
operator|&
name|wc
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|==
name|ERROR
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"state == ERROR...bailing scnt %d\n"
argument_list|,
argument|scnt
argument_list|)
empty_stmt|;
return|return;
block|}
block|}
do|while
condition|(
name|ne
operator|==
literal|0
condition|)
do|;
if|if
condition|(
name|ne
operator|<
literal|0
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"poll CQ failed %d\n"
argument_list|,
argument|ne
argument_list|)
empty_stmt|;
return|return;
block|}
if|if
condition|(
name|cb
operator|->
name|poll
operator|&&
name|wc
operator|.
name|status
operator|!=
name|IB_WC_SUCCESS
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"Completion wth error at %s:\n"
argument_list|,
argument|cb->server ?
literal|"server"
argument|:
literal|"client"
argument_list|)
empty_stmt|;
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"Failed status %d: wr_id %d\n"
argument_list|,
argument|wc.status
argument_list|,
argument|(int) wc.wr_id
argument_list|)
empty_stmt|;
return|return;
block|}
operator|++
name|scnt
expr_stmt|;
block|}
name|microtime
argument_list|(
operator|&
name|stop_tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|stop_tv
operator|.
name|tv_usec
operator|<
name|start_tv
operator|.
name|tv_usec
condition|)
block|{
name|stop_tv
operator|.
name|tv_usec
operator|+=
literal|1000000
expr_stmt|;
name|stop_tv
operator|.
name|tv_sec
operator|-=
literal|1
expr_stmt|;
block|}
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"delta sec %lu delta usec %lu iter %d size %d\n"
argument_list|,
argument|(unsigned long)(stop_tv.tv_sec - start_tv.tv_sec)
argument_list|,
argument|(unsigned long)(stop_tv.tv_usec - start_tv.tv_usec)
argument_list|,
argument|scnt
argument_list|,
argument|cb->size
argument_list|)
empty_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wlat_test
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|int
name|ccnt
decl_stmt|,
name|scnt
decl_stmt|,
name|rcnt
decl_stmt|;
name|int
name|iters
init|=
name|cb
operator|->
name|count
decl_stmt|;
specifier|volatile
name|char
modifier|*
name|poll_buf
init|=
operator|(
name|char
operator|*
operator|)
name|cb
operator|->
name|start_buf
decl_stmt|;
name|char
modifier|*
name|buf
init|=
operator|(
name|char
operator|*
operator|)
name|cb
operator|->
name|rdma_buf
decl_stmt|;
name|struct
name|timeval
name|start_tv
decl_stmt|,
name|stop_tv
decl_stmt|;
name|cycles_t
modifier|*
name|post_cycles_start
decl_stmt|,
modifier|*
name|post_cycles_stop
decl_stmt|;
name|cycles_t
modifier|*
name|poll_cycles_start
decl_stmt|,
modifier|*
name|poll_cycles_stop
decl_stmt|;
name|cycles_t
modifier|*
name|last_poll_cycles_start
decl_stmt|;
name|cycles_t
name|sum_poll
init|=
literal|0
decl_stmt|,
name|sum_post
init|=
literal|0
decl_stmt|,
name|sum_last_poll
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|cycle_iters
init|=
literal|1000
decl_stmt|;
name|ccnt
operator|=
literal|0
expr_stmt|;
name|scnt
operator|=
literal|0
expr_stmt|;
name|rcnt
operator|=
literal|0
expr_stmt|;
name|post_cycles_start
operator|=
name|kmalloc
argument_list|(
name|cycle_iters
operator|*
sizeof|sizeof
argument_list|(
name|cycles_t
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|post_cycles_start
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"%s kmalloc failed\n"
argument_list|,
argument|__FUNCTION__
argument_list|)
empty_stmt|;
return|return;
block|}
name|post_cycles_stop
operator|=
name|kmalloc
argument_list|(
name|cycle_iters
operator|*
sizeof|sizeof
argument_list|(
name|cycles_t
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|post_cycles_stop
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"%s kmalloc failed\n"
argument_list|,
argument|__FUNCTION__
argument_list|)
empty_stmt|;
return|return;
block|}
name|poll_cycles_start
operator|=
name|kmalloc
argument_list|(
name|cycle_iters
operator|*
sizeof|sizeof
argument_list|(
name|cycles_t
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|poll_cycles_start
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"%s kmalloc failed\n"
argument_list|,
argument|__FUNCTION__
argument_list|)
empty_stmt|;
return|return;
block|}
name|poll_cycles_stop
operator|=
name|kmalloc
argument_list|(
name|cycle_iters
operator|*
sizeof|sizeof
argument_list|(
name|cycles_t
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|poll_cycles_stop
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"%s kmalloc failed\n"
argument_list|,
argument|__FUNCTION__
argument_list|)
empty_stmt|;
return|return;
block|}
name|last_poll_cycles_start
operator|=
name|kmalloc
argument_list|(
name|cycle_iters
operator|*
sizeof|sizeof
argument_list|(
name|cycles_t
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|last_poll_cycles_start
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"%s kmalloc failed\n"
argument_list|,
argument|__FUNCTION__
argument_list|)
empty_stmt|;
return|return;
block|}
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|opcode
operator|=
name|IB_WR_RDMA_WRITE
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|rkey
operator|=
name|cb
operator|->
name|remote_rkey
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|remote_addr
operator|=
name|cb
operator|->
name|remote_addr
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|sg_list
operator|->
name|length
operator|=
name|cb
operator|->
name|size
expr_stmt|;
if|if
condition|(
name|cycle_iters
operator|>
name|iters
condition|)
name|cycle_iters
operator|=
name|iters
expr_stmt|;
name|microtime
argument_list|(
operator|&
name|start_tv
argument_list|)
expr_stmt|;
while|while
condition|(
name|scnt
operator|<
name|iters
operator|||
name|ccnt
operator|<
name|iters
operator|||
name|rcnt
operator|<
name|iters
condition|)
block|{
comment|/* Wait till buffer changes. */
if|if
condition|(
name|rcnt
operator|<
name|iters
operator|&&
operator|!
operator|(
name|scnt
operator|<
literal|1
operator|&&
operator|!
name|cb
operator|->
name|server
operator|)
condition|)
block|{
operator|++
name|rcnt
expr_stmt|;
while|while
condition|(
operator|*
name|poll_buf
operator|!=
operator|(
name|char
operator|)
name|rcnt
condition|)
block|{
if|if
condition|(
name|cb
operator|->
name|state
operator|==
name|ERROR
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"state = ERROR, bailing\n"
argument_list|)
empty_stmt|;
return|return;
block|}
block|}
block|}
if|if
condition|(
name|scnt
operator|<
name|iters
condition|)
block|{
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
operator|*
name|buf
operator|=
operator|(
name|char
operator|)
name|scnt
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|scnt
operator|<
name|cycle_iters
condition|)
name|post_cycles_start
index|[
name|scnt
index|]
operator|=
name|get_cycles
argument_list|()
expr_stmt|;
if|if
condition|(
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"Couldn't post send: scnt=%d\n"
argument_list|,
argument|scnt
argument_list|)
empty_stmt|;
return|return;
block|}
if|if
condition|(
name|scnt
operator|<
name|cycle_iters
condition|)
name|post_cycles_stop
index|[
name|scnt
index|]
operator|=
name|get_cycles
argument_list|()
expr_stmt|;
name|scnt
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|ccnt
operator|<
name|iters
condition|)
block|{
name|struct
name|ib_wc
name|wc
decl_stmt|;
name|int
name|ne
decl_stmt|;
if|if
condition|(
name|ccnt
operator|<
name|cycle_iters
condition|)
name|poll_cycles_start
index|[
name|ccnt
index|]
operator|=
name|get_cycles
argument_list|()
expr_stmt|;
do|do
block|{
if|if
condition|(
name|ccnt
operator|<
name|cycle_iters
condition|)
name|last_poll_cycles_start
index|[
name|ccnt
index|]
operator|=
name|get_cycles
argument_list|()
expr_stmt|;
name|ne
operator|=
name|ib_poll_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
literal|1
argument_list|,
operator|&
name|wc
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|ne
operator|==
literal|0
condition|)
do|;
if|if
condition|(
name|ccnt
operator|<
name|cycle_iters
condition|)
name|poll_cycles_stop
index|[
name|ccnt
index|]
operator|=
name|get_cycles
argument_list|()
expr_stmt|;
operator|++
name|ccnt
expr_stmt|;
if|if
condition|(
name|ne
operator|<
literal|0
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"poll CQ failed %d\n"
argument_list|,
argument|ne
argument_list|)
empty_stmt|;
return|return;
block|}
if|if
condition|(
name|wc
operator|.
name|status
operator|!=
name|IB_WC_SUCCESS
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"Completion wth error at %s:\n"
argument_list|,
argument|cb->server ?
literal|"server"
argument|:
literal|"client"
argument_list|)
empty_stmt|;
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"Failed status %d: wr_id %d\n"
argument_list|,
argument|wc.status
argument_list|,
argument|(int) wc.wr_id
argument_list|)
empty_stmt|;
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"scnt=%d, rcnt=%d, ccnt=%d\n"
argument_list|,
argument|scnt
argument_list|,
argument|rcnt
argument_list|,
argument|ccnt
argument_list|)
empty_stmt|;
return|return;
block|}
block|}
block|}
name|microtime
argument_list|(
operator|&
name|stop_tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|stop_tv
operator|.
name|tv_usec
operator|<
name|start_tv
operator|.
name|tv_usec
condition|)
block|{
name|stop_tv
operator|.
name|tv_usec
operator|+=
literal|1000000
expr_stmt|;
name|stop_tv
operator|.
name|tv_sec
operator|-=
literal|1
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cycle_iters
condition|;
name|i
operator|++
control|)
block|{
name|sum_post
operator|+=
name|post_cycles_stop
index|[
name|i
index|]
operator|-
name|post_cycles_start
index|[
name|i
index|]
expr_stmt|;
name|sum_poll
operator|+=
name|poll_cycles_stop
index|[
name|i
index|]
operator|-
name|poll_cycles_start
index|[
name|i
index|]
expr_stmt|;
name|sum_last_poll
operator|+=
name|poll_cycles_stop
index|[
name|i
index|]
operator|-
name|last_poll_cycles_start
index|[
name|i
index|]
expr_stmt|;
block|}
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"delta sec %lu delta usec %lu iter %d size %d cycle_iters %d"
literal|" sum_post %llu sum_poll %llu sum_last_poll %llu\n"
argument_list|,
argument|(unsigned long)(stop_tv.tv_sec - start_tv.tv_sec)
argument_list|,
argument|(unsigned long)(stop_tv.tv_usec - start_tv.tv_usec)
argument_list|,
argument|scnt
argument_list|,
argument|cb->size
argument_list|,
argument|cycle_iters
argument_list|,
argument|(unsigned long long)sum_post
argument_list|,
argument|(unsigned long long)sum_poll
argument_list|,
argument|(unsigned long long)sum_last_poll
argument_list|)
empty_stmt|;
name|kfree
argument_list|(
name|post_cycles_start
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|post_cycles_stop
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|poll_cycles_start
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|poll_cycles_stop
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|last_poll_cycles_start
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bw_test
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|int
name|ccnt
decl_stmt|,
name|scnt
decl_stmt|,
name|rcnt
decl_stmt|;
name|int
name|iters
init|=
name|cb
operator|->
name|count
decl_stmt|;
name|struct
name|timeval
name|start_tv
decl_stmt|,
name|stop_tv
decl_stmt|;
name|cycles_t
modifier|*
name|post_cycles_start
decl_stmt|,
modifier|*
name|post_cycles_stop
decl_stmt|;
name|cycles_t
modifier|*
name|poll_cycles_start
decl_stmt|,
modifier|*
name|poll_cycles_stop
decl_stmt|;
name|cycles_t
modifier|*
name|last_poll_cycles_start
decl_stmt|;
name|cycles_t
name|sum_poll
init|=
literal|0
decl_stmt|,
name|sum_post
init|=
literal|0
decl_stmt|,
name|sum_last_poll
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|cycle_iters
init|=
literal|1000
decl_stmt|;
name|ccnt
operator|=
literal|0
expr_stmt|;
name|scnt
operator|=
literal|0
expr_stmt|;
name|rcnt
operator|=
literal|0
expr_stmt|;
name|post_cycles_start
operator|=
name|kmalloc
argument_list|(
name|cycle_iters
operator|*
sizeof|sizeof
argument_list|(
name|cycles_t
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|post_cycles_start
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"%s kmalloc failed\n"
argument_list|,
argument|__FUNCTION__
argument_list|)
empty_stmt|;
return|return;
block|}
name|post_cycles_stop
operator|=
name|kmalloc
argument_list|(
name|cycle_iters
operator|*
sizeof|sizeof
argument_list|(
name|cycles_t
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|post_cycles_stop
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"%s kmalloc failed\n"
argument_list|,
argument|__FUNCTION__
argument_list|)
empty_stmt|;
return|return;
block|}
name|poll_cycles_start
operator|=
name|kmalloc
argument_list|(
name|cycle_iters
operator|*
sizeof|sizeof
argument_list|(
name|cycles_t
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|poll_cycles_start
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"%s kmalloc failed\n"
argument_list|,
argument|__FUNCTION__
argument_list|)
empty_stmt|;
return|return;
block|}
name|poll_cycles_stop
operator|=
name|kmalloc
argument_list|(
name|cycle_iters
operator|*
sizeof|sizeof
argument_list|(
name|cycles_t
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|poll_cycles_stop
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"%s kmalloc failed\n"
argument_list|,
argument|__FUNCTION__
argument_list|)
empty_stmt|;
return|return;
block|}
name|last_poll_cycles_start
operator|=
name|kmalloc
argument_list|(
name|cycle_iters
operator|*
sizeof|sizeof
argument_list|(
name|cycles_t
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|last_poll_cycles_start
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"%s kmalloc failed\n"
argument_list|,
argument|__FUNCTION__
argument_list|)
empty_stmt|;
return|return;
block|}
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|opcode
operator|=
name|IB_WR_RDMA_WRITE
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|rkey
operator|=
name|cb
operator|->
name|remote_rkey
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|remote_addr
operator|=
name|cb
operator|->
name|remote_addr
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|sg_list
operator|->
name|length
operator|=
name|cb
operator|->
name|size
expr_stmt|;
if|if
condition|(
name|cycle_iters
operator|>
name|iters
condition|)
name|cycle_iters
operator|=
name|iters
expr_stmt|;
name|microtime
argument_list|(
operator|&
name|start_tv
argument_list|)
expr_stmt|;
while|while
condition|(
name|scnt
operator|<
name|iters
operator|||
name|ccnt
operator|<
name|iters
condition|)
block|{
while|while
condition|(
name|scnt
operator|<
name|iters
operator|&&
name|scnt
operator|-
name|ccnt
operator|<
name|cb
operator|->
name|txdepth
condition|)
block|{
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
if|if
condition|(
name|scnt
operator|<
name|cycle_iters
condition|)
name|post_cycles_start
index|[
name|scnt
index|]
operator|=
name|get_cycles
argument_list|()
expr_stmt|;
if|if
condition|(
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"Couldn't post send: scnt=%d\n"
argument_list|,
argument|scnt
argument_list|)
empty_stmt|;
return|return;
block|}
if|if
condition|(
name|scnt
operator|<
name|cycle_iters
condition|)
name|post_cycles_stop
index|[
name|scnt
index|]
operator|=
name|get_cycles
argument_list|()
expr_stmt|;
operator|++
name|scnt
expr_stmt|;
block|}
if|if
condition|(
name|ccnt
operator|<
name|iters
condition|)
block|{
name|int
name|ne
decl_stmt|;
name|struct
name|ib_wc
name|wc
decl_stmt|;
if|if
condition|(
name|ccnt
operator|<
name|cycle_iters
condition|)
name|poll_cycles_start
index|[
name|ccnt
index|]
operator|=
name|get_cycles
argument_list|()
expr_stmt|;
do|do
block|{
if|if
condition|(
name|ccnt
operator|<
name|cycle_iters
condition|)
name|last_poll_cycles_start
index|[
name|ccnt
index|]
operator|=
name|get_cycles
argument_list|()
expr_stmt|;
name|ne
operator|=
name|ib_poll_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
literal|1
argument_list|,
operator|&
name|wc
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|ne
operator|==
literal|0
condition|)
do|;
if|if
condition|(
name|ccnt
operator|<
name|cycle_iters
condition|)
name|poll_cycles_stop
index|[
name|ccnt
index|]
operator|=
name|get_cycles
argument_list|()
expr_stmt|;
name|ccnt
operator|+=
literal|1
expr_stmt|;
if|if
condition|(
name|ne
operator|<
literal|0
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"poll CQ failed %d\n"
argument_list|,
argument|ne
argument_list|)
empty_stmt|;
return|return;
block|}
if|if
condition|(
name|wc
operator|.
name|status
operator|!=
name|IB_WC_SUCCESS
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"Completion wth error at %s:\n"
argument_list|,
argument|cb->server ?
literal|"server"
argument|:
literal|"client"
argument_list|)
empty_stmt|;
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"Failed status %d: wr_id %d\n"
argument_list|,
argument|wc.status
argument_list|,
argument|(int) wc.wr_id
argument_list|)
empty_stmt|;
return|return;
block|}
block|}
block|}
name|microtime
argument_list|(
operator|&
name|stop_tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|stop_tv
operator|.
name|tv_usec
operator|<
name|start_tv
operator|.
name|tv_usec
condition|)
block|{
name|stop_tv
operator|.
name|tv_usec
operator|+=
literal|1000000
expr_stmt|;
name|stop_tv
operator|.
name|tv_sec
operator|-=
literal|1
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cycle_iters
condition|;
name|i
operator|++
control|)
block|{
name|sum_post
operator|+=
name|post_cycles_stop
index|[
name|i
index|]
operator|-
name|post_cycles_start
index|[
name|i
index|]
expr_stmt|;
name|sum_poll
operator|+=
name|poll_cycles_stop
index|[
name|i
index|]
operator|-
name|poll_cycles_start
index|[
name|i
index|]
expr_stmt|;
name|sum_last_poll
operator|+=
name|poll_cycles_stop
index|[
name|i
index|]
operator|-
name|last_poll_cycles_start
index|[
name|i
index|]
expr_stmt|;
block|}
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"delta sec %lu delta usec %lu iter %d size %d cycle_iters %d"
literal|" sum_post %llu sum_poll %llu sum_last_poll %llu\n"
argument_list|,
argument|(unsigned long)(stop_tv.tv_sec - start_tv.tv_sec)
argument_list|,
argument|(unsigned long)(stop_tv.tv_usec - start_tv.tv_usec)
argument_list|,
argument|scnt
argument_list|,
argument|cb->size
argument_list|,
argument|cycle_iters
argument_list|,
argument|(unsigned long long)sum_post
argument_list|,
argument|(unsigned long long)sum_poll
argument_list|,
argument|(unsigned long long)sum_last_poll
argument_list|)
empty_stmt|;
name|kfree
argument_list|(
name|post_cycles_start
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|post_cycles_stop
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|poll_cycles_start
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|poll_cycles_stop
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|last_poll_cycles_start
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_rlat_test_server
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
name|struct
name|ib_wc
name|wc
decl_stmt|;
name|int
name|ret
decl_stmt|;
comment|/* Spin waiting for client's Start STAG/TO/Len */
while|while
condition|(
name|cb
operator|->
name|state
operator|<
name|RDMA_READ_ADV
condition|)
block|{
name|krping_cq_event_handler
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
name|cb
argument_list|)
expr_stmt|;
block|}
comment|/* Send STAG/TO/Len to client */
name|krping_format_send
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|start_dma_addr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"post send error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
return|return;
block|}
comment|/* Spin waiting for send completion */
while|while
condition|(
operator|(
name|ret
operator|=
name|ib_poll_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
literal|1
argument_list|,
operator|&
name|wc
argument_list|)
operator|==
literal|0
operator|)
condition|)
empty_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"poll error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
return|return;
block|}
if|if
condition|(
name|wc
operator|.
name|status
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"send completiong error %d\n"
argument_list|,
argument|wc.status
argument_list|)
empty_stmt|;
return|return;
block|}
name|wait_event_interruptible
argument_list|(
name|cb
operator|->
name|sem
argument_list|,
name|cb
operator|->
name|state
operator|==
name|ERROR
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_wlat_test_server
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
name|struct
name|ib_wc
name|wc
decl_stmt|;
name|int
name|ret
decl_stmt|;
comment|/* Spin waiting for client's Start STAG/TO/Len */
while|while
condition|(
name|cb
operator|->
name|state
operator|<
name|RDMA_READ_ADV
condition|)
block|{
name|krping_cq_event_handler
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
name|cb
argument_list|)
expr_stmt|;
block|}
comment|/* Send STAG/TO/Len to client */
name|krping_format_send
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|start_dma_addr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"post send error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
return|return;
block|}
comment|/* Spin waiting for send completion */
while|while
condition|(
operator|(
name|ret
operator|=
name|ib_poll_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
literal|1
argument_list|,
operator|&
name|wc
argument_list|)
operator|==
literal|0
operator|)
condition|)
empty_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"poll error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
return|return;
block|}
if|if
condition|(
name|wc
operator|.
name|status
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"send completiong error %d\n"
argument_list|,
argument|wc.status
argument_list|)
empty_stmt|;
return|return;
block|}
name|wlat_test
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|wait_event_interruptible
argument_list|(
name|cb
operator|->
name|sem
argument_list|,
name|cb
operator|->
name|state
operator|==
name|ERROR
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_bw_test_server
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
name|struct
name|ib_wc
name|wc
decl_stmt|;
name|int
name|ret
decl_stmt|;
comment|/* Spin waiting for client's Start STAG/TO/Len */
while|while
condition|(
name|cb
operator|->
name|state
operator|<
name|RDMA_READ_ADV
condition|)
block|{
name|krping_cq_event_handler
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
name|cb
argument_list|)
expr_stmt|;
block|}
comment|/* Send STAG/TO/Len to client */
name|krping_format_send
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|start_dma_addr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"post send error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
return|return;
block|}
comment|/* Spin waiting for send completion */
while|while
condition|(
operator|(
name|ret
operator|=
name|ib_poll_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
literal|1
argument_list|,
operator|&
name|wc
argument_list|)
operator|==
literal|0
operator|)
condition|)
empty_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"poll error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
return|return;
block|}
if|if
condition|(
name|wc
operator|.
name|status
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"send completiong error %d\n"
argument_list|,
argument|wc.status
argument_list|)
empty_stmt|;
return|return;
block|}
if|if
condition|(
name|cb
operator|->
name|duplex
condition|)
name|bw_test
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|wait_event_interruptible
argument_list|(
name|cb
operator|->
name|sem
argument_list|,
name|cb
operator|->
name|state
operator|==
name|ERROR
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|reg_supported
parameter_list|(
name|struct
name|ib_device
modifier|*
name|dev
parameter_list|)
block|{
name|u64
name|needed_flags
init|=
name|IB_DEVICE_MEM_MGT_EXTENSIONS
decl_stmt|;
if|if
condition|(
operator|(
name|dev
operator|->
name|attrs
operator|.
name|device_cap_flags
operator|&
name|needed_flags
operator|)
operator|!=
name|needed_flags
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"Fastreg not supported - device_cap_flags 0x%llx\n"
argument_list|,
argument|(unsigned long long)dev->attrs.device_cap_flags
argument_list|)
empty_stmt|;
return|return
literal|0
return|;
block|}
name|DEBUG_LOG
argument_list|(
literal|"Fastreg supported - device_cap_flags 0x%llx\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|dev
operator|->
name|attrs
operator|.
name|device_cap_flags
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|fill_sockaddr
parameter_list|(
name|struct
name|sockaddr_storage
modifier|*
name|sin
parameter_list|,
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|memset
argument_list|(
name|sin
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sin
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|addr_type
operator|==
name|AF_INET
condition|)
block|{
name|struct
name|sockaddr_in
modifier|*
name|sin4
init|=
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|sin
decl_stmt|;
name|sin4
operator|->
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|&
name|sin4
operator|->
name|sin_addr
operator|.
name|s_addr
argument_list|,
name|cb
operator|->
name|addr
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|sin4
operator|->
name|sin_port
operator|=
name|cb
operator|->
name|port
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cb
operator|->
name|addr_type
operator|==
name|AF_INET6
condition|)
block|{
name|struct
name|sockaddr_in6
modifier|*
name|sin6
init|=
operator|(
expr|struct
name|sockaddr_in6
operator|*
operator|)
name|sin
decl_stmt|;
name|sin6
operator|->
name|sin6_family
operator|=
name|AF_INET6
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|&
name|sin6
operator|->
name|sin6_addr
argument_list|,
name|cb
operator|->
name|addr
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|sin6
operator|->
name|sin6_port
operator|=
name|cb
operator|->
name|port
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|krping_bind_server
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|sockaddr_storage
name|sin
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|fill_sockaddr
argument_list|(
operator|&
name|sin
argument_list|,
name|cb
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rdma_bind_addr
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sin
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"rdma_bind_addr error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
return|return
name|ret
return|;
block|}
name|DEBUG_LOG
argument_list|(
literal|"rdma_bind_addr successful\n"
argument_list|)
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"rdma_listen\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rdma_listen
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"rdma_listen failed: %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
return|return
name|ret
return|;
block|}
name|wait_event_interruptible
argument_list|(
name|cb
operator|->
name|sem
argument_list|,
name|cb
operator|->
name|state
operator|>=
name|CONNECT_REQUEST
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|!=
name|CONNECT_REQUEST
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"wait for CONNECT_REQUEST state %d\n"
argument_list|,
argument|cb->state
argument_list|)
empty_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|reg_supported
argument_list|(
name|cb
operator|->
name|child_cm_id
operator|->
name|device
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_run_server
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ib_recv_wr
modifier|*
name|bad_wr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|krping_bind_server
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return;
name|ret
operator|=
name|krping_setup_qp
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|child_cm_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"setup_qp failed: %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
goto|goto
name|err0
goto|;
block|}
name|ret
operator|=
name|krping_setup_buffers
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"krping_setup_buffers failed: %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
goto|goto
name|err1
goto|;
block|}
name|ret
operator|=
name|ib_post_recv
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|rq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"ib_post_recv failed: %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
goto|goto
name|err2
goto|;
block|}
name|ret
operator|=
name|krping_accept
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"connect error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
goto|goto
name|err2
goto|;
block|}
if|if
condition|(
name|cb
operator|->
name|wlat
condition|)
name|krping_wlat_test_server
argument_list|(
name|cb
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cb
operator|->
name|rlat
condition|)
name|krping_rlat_test_server
argument_list|(
name|cb
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cb
operator|->
name|bw
condition|)
name|krping_bw_test_server
argument_list|(
name|cb
argument_list|)
expr_stmt|;
else|else
name|krping_test_server
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|rdma_disconnect
argument_list|(
name|cb
operator|->
name|child_cm_id
argument_list|)
expr_stmt|;
name|err2
label|:
name|krping_free_buffers
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|err1
label|:
name|krping_free_qp
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|err0
label|:
name|rdma_destroy_id
argument_list|(
name|cb
operator|->
name|child_cm_id
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_test_client
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|int
name|ping
decl_stmt|,
name|start
decl_stmt|,
name|cc
decl_stmt|,
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
name|unsigned
name|char
name|c
decl_stmt|;
name|start
operator|=
literal|65
expr_stmt|;
for|for
control|(
name|ping
operator|=
literal|0
init|;
operator|!
name|cb
operator|->
name|count
operator|||
name|ping
operator|<
name|cb
operator|->
name|count
condition|;
name|ping
operator|++
control|)
block|{
name|cb
operator|->
name|state
operator|=
name|RDMA_READ_ADV
expr_stmt|;
comment|/* Put some ascii text in the buffer. */
name|cc
operator|=
name|sprintf
argument_list|(
name|cb
operator|->
name|start_buf
argument_list|,
literal|"rdma-ping-%d: "
argument_list|,
name|ping
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|cc
operator|,
name|c
operator|=
name|start
init|;
name|i
operator|<
name|cb
operator|->
name|size
condition|;
name|i
operator|++
control|)
block|{
name|cb
operator|->
name|start_buf
index|[
name|i
index|]
operator|=
name|c
expr_stmt|;
name|c
operator|++
expr_stmt|;
if|if
condition|(
name|c
operator|>
literal|122
condition|)
name|c
operator|=
literal|65
expr_stmt|;
block|}
name|start
operator|++
expr_stmt|;
if|if
condition|(
name|start
operator|>
literal|122
condition|)
name|start
operator|=
literal|65
expr_stmt|;
name|cb
operator|->
name|start_buf
index|[
name|cb
operator|->
name|size
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|krping_format_send
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|start_dma_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|==
name|ERROR
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"krping_format_send failed\n"
argument_list|)
empty_stmt|;
break|break;
block|}
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"post send error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
break|break;
block|}
comment|/* Wait for server to ACK */
name|wait_event_interruptible
argument_list|(
name|cb
operator|->
name|sem
argument_list|,
name|cb
operator|->
name|state
operator|>=
name|RDMA_WRITE_ADV
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|!=
name|RDMA_WRITE_ADV
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"wait for RDMA_WRITE_ADV state %d\n"
argument_list|,
argument|cb->state
argument_list|)
empty_stmt|;
break|break;
block|}
name|krping_format_send
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|rdma_dma_addr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"post send error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
break|break;
block|}
comment|/* Wait for the server to say the RDMA Write is complete. */
name|wait_event_interruptible
argument_list|(
name|cb
operator|->
name|sem
argument_list|,
name|cb
operator|->
name|state
operator|>=
name|RDMA_WRITE_COMPLETE
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|!=
name|RDMA_WRITE_COMPLETE
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"wait for RDMA_WRITE_COMPLETE state %d\n"
argument_list|,
argument|cb->state
argument_list|)
empty_stmt|;
break|break;
block|}
if|if
condition|(
name|cb
operator|->
name|validate
condition|)
if|if
condition|(
name|memcmp
argument_list|(
name|cb
operator|->
name|start_buf
argument_list|,
name|cb
operator|->
name|rdma_buf
argument_list|,
name|cb
operator|->
name|size
argument_list|)
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"data mismatch!\n"
argument_list|)
empty_stmt|;
break|break;
block|}
if|if
condition|(
name|cb
operator|->
name|verbose
condition|)
name|printk
argument_list|(
argument|KERN_INFO PFX
literal|"ping data: %s\n"
argument_list|,
argument|cb->rdma_buf
argument_list|)
empty_stmt|;
ifdef|#
directive|ifdef
name|SLOW_KRPING
name|wait_event_interruptible_timeout
argument_list|(
name|cb
operator|->
name|sem
argument_list|,
name|cb
operator|->
name|state
operator|==
name|ERROR
argument_list|,
name|HZ
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|krping_rlat_test_client
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
name|struct
name|ib_wc
name|wc
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|cb
operator|->
name|state
operator|=
name|RDMA_READ_ADV
expr_stmt|;
comment|/* Send STAG/TO/Len to client */
name|krping_format_send
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|start_dma_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|==
name|ERROR
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"krping_format_send failed\n"
argument_list|)
empty_stmt|;
return|return;
block|}
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"post send error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
return|return;
block|}
comment|/* Spin waiting for send completion */
while|while
condition|(
operator|(
name|ret
operator|=
name|ib_poll_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
literal|1
argument_list|,
operator|&
name|wc
argument_list|)
operator|==
literal|0
operator|)
condition|)
empty_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"poll error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
return|return;
block|}
if|if
condition|(
name|wc
operator|.
name|status
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"send completion error %d\n"
argument_list|,
argument|wc.status
argument_list|)
empty_stmt|;
return|return;
block|}
comment|/* Spin waiting for server's Start STAG/TO/Len */
while|while
condition|(
name|cb
operator|->
name|state
operator|<
name|RDMA_WRITE_ADV
condition|)
block|{
name|krping_cq_event_handler
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
name|cb
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
literal|0
block|{ 	int i; 	struct timeval start, stop; 	time_t sec; 	suseconds_t usec; 	unsigned long long elapsed; 	struct ib_wc wc; 	struct ib_send_wr *bad_wr; 	int ne; 	 	cb->rdma_sq_wr.wr.opcode = IB_WR_RDMA_WRITE; 	cb->rdma_sq_wr.rkey = cb->remote_rkey; 	cb->rdma_sq_wr.remote_addr = cb->remote_addr; 	cb->rdma_sq_wr.wr.sg_list->length = 0; 	cb->rdma_sq_wr.wr.num_sge = 0;  	microtime(&start); 	for (i=0; i< 100000; i++) { 		if (ib_post_send(cb->qp,&cb->rdma_sq_wr.wr,&bad_wr)) { 			printk(KERN_ERR PFX  "Couldn't post send\n"); 			return; 		} 		do { 			ne = ib_poll_cq(cb->cq, 1,&wc); 		} while (ne == 0); 		if (ne< 0) { 			printk(KERN_ERR PFX "poll CQ failed %d\n", ne); 			return; 		} 		if (wc.status != IB_WC_SUCCESS) { 			printk(KERN_ERR PFX "Completion wth error at %s:\n", 				cb->server ? "server" : "client"); 			printk(KERN_ERR PFX "Failed status %d: wr_id %d\n", 				wc.status, (int) wc.wr_id); 			return; 		} 	} 	microtime(&stop); 	 	if (stop.tv_usec< start.tv_usec) { 		stop.tv_usec += 1000000; 		stop.tv_sec  -= 1; 	} 	sec     = stop.tv_sec - start.tv_sec; 	usec    = stop.tv_usec - start.tv_usec; 	elapsed = sec * 1000000 + usec; 	printk(KERN_ERR PFX "0B-write-lat iters 100000 usec %llu\n", elapsed); }
endif|#
directive|endif
name|rlat_test
argument_list|(
name|cb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_wlat_test_client
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
name|struct
name|ib_wc
name|wc
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|cb
operator|->
name|state
operator|=
name|RDMA_READ_ADV
expr_stmt|;
comment|/* Send STAG/TO/Len to client */
name|krping_format_send
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|start_dma_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|==
name|ERROR
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"krping_format_send failed\n"
argument_list|)
empty_stmt|;
return|return;
block|}
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"post send error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
return|return;
block|}
comment|/* Spin waiting for send completion */
while|while
condition|(
operator|(
name|ret
operator|=
name|ib_poll_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
literal|1
argument_list|,
operator|&
name|wc
argument_list|)
operator|==
literal|0
operator|)
condition|)
empty_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"poll error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
return|return;
block|}
if|if
condition|(
name|wc
operator|.
name|status
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"send completion error %d\n"
argument_list|,
argument|wc.status
argument_list|)
empty_stmt|;
return|return;
block|}
comment|/* Spin waiting for server's Start STAG/TO/Len */
while|while
condition|(
name|cb
operator|->
name|state
operator|<
name|RDMA_WRITE_ADV
condition|)
block|{
name|krping_cq_event_handler
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
name|cb
argument_list|)
expr_stmt|;
block|}
name|wlat_test
argument_list|(
name|cb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_bw_test_client
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
name|struct
name|ib_wc
name|wc
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|cb
operator|->
name|state
operator|=
name|RDMA_READ_ADV
expr_stmt|;
comment|/* Send STAG/TO/Len to client */
name|krping_format_send
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|start_dma_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|==
name|ERROR
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"krping_format_send failed\n"
argument_list|)
empty_stmt|;
return|return;
block|}
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"post send error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
return|return;
block|}
comment|/* Spin waiting for send completion */
while|while
condition|(
operator|(
name|ret
operator|=
name|ib_poll_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
literal|1
argument_list|,
operator|&
name|wc
argument_list|)
operator|==
literal|0
operator|)
condition|)
empty_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"poll error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
return|return;
block|}
if|if
condition|(
name|wc
operator|.
name|status
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"send completion error %d\n"
argument_list|,
argument|wc.status
argument_list|)
empty_stmt|;
return|return;
block|}
comment|/* Spin waiting for server's Start STAG/TO/Len */
while|while
condition|(
name|cb
operator|->
name|state
operator|<
name|RDMA_WRITE_ADV
condition|)
block|{
name|krping_cq_event_handler
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
name|cb
argument_list|)
expr_stmt|;
block|}
name|bw_test
argument_list|(
name|cb
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Manual qp flush test  */
end_comment

begin_function
specifier|static
name|void
name|flush_qp
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ib_send_wr
name|wr
init|=
block|{
literal|0
block|}
decl_stmt|,
modifier|*
name|bad
decl_stmt|;
name|struct
name|ib_recv_wr
name|recv_wr
init|=
block|{
literal|0
block|}
decl_stmt|,
modifier|*
name|recv_bad
decl_stmt|;
name|struct
name|ib_wc
name|wc
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|flushed
init|=
literal|0
decl_stmt|;
name|int
name|ccnt
init|=
literal|0
decl_stmt|;
name|rdma_disconnect
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|)
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"disconnected!\n"
argument_list|)
expr_stmt|;
name|wr
operator|.
name|opcode
operator|=
name|IB_WR_SEND
expr_stmt|;
name|wr
operator|.
name|wr_id
operator|=
literal|0xdeadbeefcafebabe
expr_stmt|;
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|wr
argument_list|,
operator|&
name|bad
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"%s post_send failed ret %d\n"
argument_list|,
argument|__func__
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
return|return;
block|}
name|recv_wr
operator|.
name|wr_id
operator|=
literal|0xcafebabedeadbeef
expr_stmt|;
name|ret
operator|=
name|ib_post_recv
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|recv_wr
argument_list|,
operator|&
name|recv_bad
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"%s post_recv failed ret %d\n"
argument_list|,
argument|__func__
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
return|return;
block|}
comment|/* poll until the flush WRs complete */
do|do
block|{
name|ret
operator|=
name|ib_poll_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
literal|1
argument_list|,
operator|&
name|wc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"ib_poll_cq failed %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
return|return;
block|}
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
continue|continue;
name|ccnt
operator|++
expr_stmt|;
if|if
condition|(
name|wc
operator|.
name|wr_id
operator|==
literal|0xdeadbeefcafebabe
operator|||
name|wc
operator|.
name|wr_id
operator|==
literal|0xcafebabedeadbeef
condition|)
name|flushed
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|flushed
operator|!=
literal|2
condition|)
do|;
name|DEBUG_LOG
argument_list|(
literal|"qp_flushed! ccnt %u\n"
argument_list|,
name|ccnt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_fr_test
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ib_send_wr
name|inv
decl_stmt|,
modifier|*
name|bad
decl_stmt|;
name|struct
name|ib_reg_wr
name|fr
decl_stmt|;
name|struct
name|ib_wc
name|wc
decl_stmt|;
name|u8
name|key
init|=
literal|0
decl_stmt|;
name|struct
name|ib_mr
modifier|*
name|mr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|size
init|=
name|cb
operator|->
name|size
decl_stmt|;
name|int
name|plen
init|=
operator|(
operator|(
operator|(
name|size
operator|-
literal|1
operator|)
operator|&
name|PAGE_MASK
operator|)
operator|+
name|PAGE_SIZE
operator|)
operator|>>
name|PAGE_SHIFT
decl_stmt|;
name|unsigned
name|long
name|start
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
name|int
name|scnt
init|=
literal|0
decl_stmt|;
name|struct
name|scatterlist
name|sg
init|=
block|{
literal|0
block|}
decl_stmt|;
name|mr
operator|=
name|ib_alloc_mr
argument_list|(
name|cb
operator|->
name|pd
argument_list|,
name|IB_MR_TYPE_MEM_REG
argument_list|,
name|plen
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|mr
argument_list|)
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"ib_alloc_mr failed %ld\n"
argument_list|,
argument|PTR_ERR(mr)
argument_list|)
empty_stmt|;
return|return;
block|}
name|sg_dma_address
argument_list|(
operator|&
name|sg
argument_list|)
operator|=
literal|0xcafebabe0000UL
expr_stmt|;
name|sg_dma_len
argument_list|(
operator|&
name|sg
argument_list|)
operator|=
name|size
expr_stmt|;
name|ret
operator|=
name|ib_map_mr_sg
argument_list|(
name|mr
argument_list|,
operator|&
name|sg
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|,
name|PAGE_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<=
literal|0
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"ib_map_mr_sge err %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
goto|goto
name|err2
goto|;
block|}
name|memset
argument_list|(
operator|&
name|fr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|fr
argument_list|)
expr_stmt|;
name|fr
operator|.
name|wr
operator|.
name|opcode
operator|=
name|IB_WR_REG_MR
expr_stmt|;
name|fr
operator|.
name|access
operator|=
name|IB_ACCESS_REMOTE_WRITE
operator||
name|IB_ACCESS_LOCAL_WRITE
expr_stmt|;
name|fr
operator|.
name|mr
operator|=
name|mr
expr_stmt|;
name|fr
operator|.
name|wr
operator|.
name|next
operator|=
operator|&
name|inv
expr_stmt|;
name|memset
argument_list|(
operator|&
name|inv
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|inv
argument_list|)
expr_stmt|;
name|inv
operator|.
name|opcode
operator|=
name|IB_WR_LOCAL_INV
expr_stmt|;
name|inv
operator|.
name|send_flags
operator|=
name|IB_SEND_SIGNALED
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"fr_test: stag index 0x%x plen %u size %u depth %u\n"
argument_list|,
name|mr
operator|->
name|rkey
operator|>>
literal|8
argument_list|,
name|plen
argument_list|,
name|cb
operator|->
name|size
argument_list|,
name|cb
operator|->
name|txdepth
argument_list|)
expr_stmt|;
name|start
operator|=
name|time_uptime
expr_stmt|;
while|while
condition|(
operator|!
name|cb
operator|->
name|count
operator|||
name|count
operator|<=
name|cb
operator|->
name|count
condition|)
block|{
if|if
condition|(
name|SIGPENDING
argument_list|(
name|curthread
argument_list|)
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"signal!\n"
argument_list|)
empty_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|time_uptime
operator|-
name|start
operator|)
operator|>=
literal|9
condition|)
block|{
name|DEBUG_LOG
argument_list|(
literal|"fr_test: pausing 1 second! count %u latest size %u plen %u\n"
argument_list|,
name|count
argument_list|,
name|size
argument_list|,
name|plen
argument_list|)
expr_stmt|;
name|wait_event_interruptible_timeout
argument_list|(
name|cb
operator|->
name|sem
argument_list|,
name|cb
operator|->
name|state
operator|==
name|ERROR
argument_list|,
name|HZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|==
name|ERROR
condition|)
break|break;
name|start
operator|=
name|time_uptime
expr_stmt|;
block|}
while|while
condition|(
name|scnt
operator|<
operator|(
name|cb
operator|->
name|txdepth
operator|>>
literal|1
operator|)
condition|)
block|{
name|ib_update_fast_reg_key
argument_list|(
name|mr
argument_list|,
operator|++
name|key
argument_list|)
expr_stmt|;
name|fr
operator|.
name|key
operator|=
name|mr
operator|->
name|rkey
expr_stmt|;
name|inv
operator|.
name|ex
operator|.
name|invalidate_rkey
operator|=
name|mr
operator|->
name|rkey
expr_stmt|;
name|size
operator|=
name|arc4random
argument_list|()
operator|%
name|cb
operator|->
name|size
expr_stmt|;
if|if
condition|(
name|size
operator|==
literal|0
condition|)
name|size
operator|=
name|cb
operator|->
name|size
expr_stmt|;
name|sg_dma_len
argument_list|(
operator|&
name|sg
argument_list|)
operator|=
name|size
expr_stmt|;
name|ret
operator|=
name|ib_map_mr_sg
argument_list|(
name|mr
argument_list|,
operator|&
name|sg
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|,
name|PAGE_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<=
literal|0
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"ib_map_mr_sge err %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
goto|goto
name|err2
goto|;
block|}
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|fr
operator|.
name|wr
argument_list|,
operator|&
name|bad
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"ib_post_send failed %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
goto|goto
name|err2
goto|;
block|}
name|scnt
operator|++
expr_stmt|;
block|}
name|ret
operator|=
name|ib_poll_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
literal|1
argument_list|,
operator|&
name|wc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"ib_poll_cq failed %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
goto|goto
name|err2
goto|;
block|}
if|if
condition|(
name|ret
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|wc
operator|.
name|status
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"completion error %u\n"
argument_list|,
argument|wc.status
argument_list|)
empty_stmt|;
goto|goto
name|err2
goto|;
block|}
name|count
operator|++
expr_stmt|;
name|scnt
operator|--
expr_stmt|;
block|}
block|}
name|err2
label|:
name|flush_qp
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"fr_test: done!\n"
argument_list|)
expr_stmt|;
name|ib_dereg_mr
argument_list|(
name|mr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|krping_connect_client
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|rdma_conn_param
name|conn_param
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|memset
argument_list|(
operator|&
name|conn_param
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|conn_param
argument_list|)
expr_stmt|;
name|conn_param
operator|.
name|responder_resources
operator|=
literal|1
expr_stmt|;
name|conn_param
operator|.
name|initiator_depth
operator|=
literal|1
expr_stmt|;
name|conn_param
operator|.
name|retry_count
operator|=
literal|10
expr_stmt|;
name|ret
operator|=
name|rdma_connect
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|,
operator|&
name|conn_param
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"rdma_connect error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
return|return
name|ret
return|;
block|}
name|wait_event_interruptible
argument_list|(
name|cb
operator|->
name|sem
argument_list|,
name|cb
operator|->
name|state
operator|>=
name|CONNECTED
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|==
name|ERROR
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"wait for CONNECTED state %d\n"
argument_list|,
argument|cb->state
argument_list|)
empty_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|DEBUG_LOG
argument_list|(
literal|"rdma_connect successful\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|krping_bind_client
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|sockaddr_storage
name|sin
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|fill_sockaddr
argument_list|(
operator|&
name|sin
argument_list|,
name|cb
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rdma_resolve_addr
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|,
name|NULL
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sin
argument_list|,
literal|2000
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"rdma_resolve_addr error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
return|return
name|ret
return|;
block|}
name|wait_event_interruptible
argument_list|(
name|cb
operator|->
name|sem
argument_list|,
name|cb
operator|->
name|state
operator|>=
name|ROUTE_RESOLVED
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|!=
name|ROUTE_RESOLVED
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"addr/route resolution did not resolve: state %d\n"
argument_list|,
argument|cb->state
argument_list|)
empty_stmt|;
return|return
operator|-
name|EINTR
return|;
block|}
if|if
condition|(
operator|!
name|reg_supported
argument_list|(
name|cb
operator|->
name|cm_id
operator|->
name|device
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
name|DEBUG_LOG
argument_list|(
literal|"rdma_resolve_addr - rdma_resolve_route successful\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_run_client
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ib_recv_wr
modifier|*
name|bad_wr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|krping_bind_client
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return;
name|ret
operator|=
name|krping_setup_qp
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|cm_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"setup_qp failed: %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
return|return;
block|}
name|ret
operator|=
name|krping_setup_buffers
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"krping_setup_buffers failed: %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
goto|goto
name|err1
goto|;
block|}
name|ret
operator|=
name|ib_post_recv
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|rq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"ib_post_recv failed: %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
goto|goto
name|err2
goto|;
block|}
name|ret
operator|=
name|krping_connect_client
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"connect error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
goto|goto
name|err2
goto|;
block|}
if|if
condition|(
name|cb
operator|->
name|wlat
condition|)
name|krping_wlat_test_client
argument_list|(
name|cb
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cb
operator|->
name|rlat
condition|)
name|krping_rlat_test_client
argument_list|(
name|cb
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cb
operator|->
name|bw
condition|)
name|krping_bw_test_client
argument_list|(
name|cb
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cb
operator|->
name|frtest
condition|)
name|krping_fr_test
argument_list|(
name|cb
argument_list|)
expr_stmt|;
else|else
name|krping_test_client
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|rdma_disconnect
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|)
expr_stmt|;
name|err2
label|:
name|krping_free_buffers
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|err1
label|:
name|krping_free_qp
argument_list|(
name|cb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|krping_doit
parameter_list|(
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|struct
name|krping_cb
modifier|*
name|cb
decl_stmt|;
name|int
name|op
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|optarg
decl_stmt|;
name|unsigned
name|long
name|optint
decl_stmt|;
name|cb
operator|=
name|kzalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|cb
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|mutex_lock
argument_list|(
operator|&
name|krping_mutex
argument_list|)
expr_stmt|;
name|list_add_tail
argument_list|(
operator|&
name|cb
operator|->
name|list
argument_list|,
operator|&
name|krping_cbs
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|krping_mutex
argument_list|)
expr_stmt|;
name|cb
operator|->
name|server
operator|=
operator|-
literal|1
expr_stmt|;
name|cb
operator|->
name|state
operator|=
name|IDLE
expr_stmt|;
name|cb
operator|->
name|size
operator|=
literal|64
expr_stmt|;
name|cb
operator|->
name|txdepth
operator|=
name|RPING_SQ_DEPTH
expr_stmt|;
name|init_waitqueue_head
argument_list|(
operator|&
name|cb
operator|->
name|sem
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|op
operator|=
name|krping_getopt
argument_list|(
literal|"krping"
argument_list|,
operator|&
name|cmd
argument_list|,
name|krping_opts
argument_list|,
name|NULL
argument_list|,
operator|&
name|optarg
argument_list|,
operator|&
name|optint
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
switch|switch
condition|(
name|op
condition|)
block|{
name|struct
name|in_addr
name|in_addr
decl_stmt|;
case|case
literal|'a'
case|:
name|cb
operator|->
name|addr_str
operator|=
name|optarg
expr_stmt|;
name|cb
operator|->
name|addr_type
operator|=
name|AF_INET
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"ipaddr (%s)\n"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|inet_aton
argument_list|(
name|optarg
argument_list|,
operator|&
name|in_addr
argument_list|)
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"bad addr string %s\n"
argument_list|,
argument|optarg
argument_list|)
empty_stmt|;
name|ret
operator|=
name|EINVAL
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|cb
operator|->
name|addr
argument_list|,
operator|&
name|in_addr
operator|.
name|s_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|in_addr
operator|.
name|s_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'A'
case|:
name|cb
operator|->
name|addr_str
operator|=
name|optarg
expr_stmt|;
name|cb
operator|->
name|addr_type
operator|=
name|AF_INET6
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"ipv6addr (%s)\n"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EAFNOSUPPORT
expr_stmt|;
comment|/* XXX not supported */
break|break;
case|case
literal|'p'
case|:
name|cb
operator|->
name|port
operator|=
name|htons
argument_list|(
name|optint
argument_list|)
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"port %d\n"
argument_list|,
operator|(
name|int
operator|)
name|optint
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
name|cb
operator|->
name|poll
operator|=
literal|1
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"server\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|cb
operator|->
name|server
operator|=
literal|1
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"server\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|cb
operator|->
name|server
operator|=
literal|0
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"client\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
name|cb
operator|->
name|size
operator|=
name|optint
expr_stmt|;
if|if
condition|(
operator|(
name|cb
operator|->
name|size
operator|<
literal|1
operator|)
operator|||
operator|(
name|cb
operator|->
name|size
operator|>
name|RPING_BUFSIZE
operator|)
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"Invalid size %d "
literal|"(valid range is 1 to %d)\n"
argument_list|,
argument|cb->size
argument_list|,
argument|RPING_BUFSIZE
argument_list|)
empty_stmt|;
name|ret
operator|=
name|EINVAL
expr_stmt|;
block|}
else|else
name|DEBUG_LOG
argument_list|(
literal|"size %d\n"
argument_list|,
operator|(
name|int
operator|)
name|optint
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
name|cb
operator|->
name|count
operator|=
name|optint
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|count
operator|<
literal|0
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"Invalid count %d\n"
argument_list|,
argument|cb->count
argument_list|)
empty_stmt|;
name|ret
operator|=
name|EINVAL
expr_stmt|;
block|}
else|else
name|DEBUG_LOG
argument_list|(
literal|"count %d\n"
argument_list|,
operator|(
name|int
operator|)
name|cb
operator|->
name|count
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|cb
operator|->
name|verbose
operator|++
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"verbose\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'V'
case|:
name|cb
operator|->
name|validate
operator|++
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"validate data\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|cb
operator|->
name|wlat
operator|++
expr_stmt|;
break|break;
case|case
literal|'L'
case|:
name|cb
operator|->
name|rlat
operator|++
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
name|cb
operator|->
name|bw
operator|++
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|cb
operator|->
name|duplex
operator|++
expr_stmt|;
break|break;
case|case
literal|'I'
case|:
name|cb
operator|->
name|server_invalidate
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'T'
case|:
name|cb
operator|->
name|txdepth
operator|=
name|optint
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"txdepth %d\n"
argument_list|,
operator|(
name|int
operator|)
name|cb
operator|->
name|txdepth
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'Z'
case|:
name|cb
operator|->
name|local_dma_lkey
operator|=
literal|1
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"using local dma lkey\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'R'
case|:
name|cb
operator|->
name|read_inv
operator|=
literal|1
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"using read-with-inv\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|cb
operator|->
name|frtest
operator|=
literal|1
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"fast-reg test!\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"unknown opt %s\n"
argument_list|,
argument|optarg
argument_list|)
empty_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|cb
operator|->
name|server
operator|==
operator|-
literal|1
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"must be either client or server\n"
argument_list|)
empty_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|cb
operator|->
name|server
operator|&&
name|cb
operator|->
name|frtest
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"must be client to run frtest\n"
argument_list|)
empty_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|(
name|cb
operator|->
name|frtest
operator|+
name|cb
operator|->
name|bw
operator|+
name|cb
operator|->
name|rlat
operator|+
name|cb
operator|->
name|wlat
operator|)
operator|>
literal|1
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"Pick only one test: fr, bw, rlat, wlat\n"
argument_list|)
empty_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|cb
operator|->
name|wlat
operator|||
name|cb
operator|->
name|rlat
operator|||
name|cb
operator|->
name|bw
condition|)
block|{
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"wlat, rlat, and bw tests only support mem_mode MR - which is no longer supported\n"
argument_list|)
empty_stmt|;
name|ret
operator|=
operator|-
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|cb
operator|->
name|cm_id
operator|=
name|rdma_create_id
argument_list|(
operator|&
name|init_net
argument_list|,
name|krping_cma_event_handler
argument_list|,
name|cb
argument_list|,
name|RDMA_PS_TCP
argument_list|,
name|IB_QPT_RC
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|)
condition|)
block|{
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|)
expr_stmt|;
name|printk
argument_list|(
argument|KERN_ERR PFX
literal|"rdma_create_id error %d\n"
argument_list|,
argument|ret
argument_list|)
empty_stmt|;
goto|goto
name|out
goto|;
block|}
name|DEBUG_LOG
argument_list|(
literal|"created cm_id %p\n"
argument_list|,
name|cb
operator|->
name|cm_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|server
condition|)
name|krping_run_server
argument_list|(
name|cb
argument_list|)
expr_stmt|;
else|else
name|krping_run_client
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"destroy cm_id %p\n"
argument_list|,
name|cb
operator|->
name|cm_id
argument_list|)
expr_stmt|;
name|rdma_destroy_id
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|)
expr_stmt|;
name|out
label|:
name|mutex_lock
argument_list|(
operator|&
name|krping_mutex
argument_list|)
expr_stmt|;
name|list_del
argument_list|(
operator|&
name|cb
operator|->
name|list
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|krping_mutex
argument_list|)
expr_stmt|;
name|kfree
argument_list|(
name|cb
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|krping_walk_cb_list
parameter_list|(
name|void
function_decl|(
modifier|*
name|f
function_decl|)
parameter_list|(
name|struct
name|krping_stats
modifier|*
parameter_list|,
name|void
modifier|*
parameter_list|)
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|krping_cb
modifier|*
name|cb
decl_stmt|;
name|mutex_lock
argument_list|(
operator|&
name|krping_mutex
argument_list|)
expr_stmt|;
name|list_for_each_entry
argument_list|(
name|cb
argument_list|,
operator|&
name|krping_cbs
argument_list|,
name|list
argument_list|)
argument_list|(
operator|*
name|f
argument_list|)
argument_list|(
name|cb
operator|->
name|pd
condition|?
operator|&
name|cb
operator|->
name|stats
else|:
name|NULL
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|mutex_unlock
argument_list|(
operator|&
name|krping_mutex
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


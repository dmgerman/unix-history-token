begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2005 Ammasso, Inc. All rights reserved.  * Copyright (c) 2006 Open Grid Computing, Inc. All rights reserved.  *  * This software is available to you under a choice of one of two  * licenses.  You may choose to be licensed under the terms of the GNU  * General Public License (GPL) Version 2, available from the file  * COPYING in the main directory of this source tree, or the  * OpenIB.org BSD license below:  *  *     Redistribution and use in source and binary forms, with or  *     without modification, are permitted provided that the following  *     conditions are met:  *  *      - Redistributions of source code must retain the above  *        copyright notice, this list of conditions and the following  *        disclaimer.  *  *      - Redistributions in binary form must reproduce the above  *        copyright notice, this list of conditions and the following  *        disclaimer in the documentation and/or other materials  *        provided with the distribution.  *  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,  * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF  * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND  * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  * BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN  * ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE  * SOFTWARE.  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/ctype.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/condvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/module.h>
end_include

begin_include
include|#
directive|include
file|<sys/endian.h>
end_include

begin_include
include|#
directive|include
file|<sys/limits.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/signalvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/rwlock.h>
end_include

begin_include
include|#
directive|include
file|<sys/queue.h>
end_include

begin_include
include|#
directive|include
file|<sys/taskqueue.h>
end_include

begin_include
include|#
directive|include
file|<sys/syslog.h>
end_include

begin_include
include|#
directive|include
file|<vm/vm.h>
end_include

begin_include
include|#
directive|include
file|<vm/pmap.h>
end_include

begin_include
include|#
directive|include
file|<contrib/rdma/rdma_cm.h>
end_include

begin_include
include|#
directive|include
file|"getopt.h"
end_include

begin_include
include|#
directive|include
file|"krping.h"
end_include

begin_define
define|#
directive|define
name|PFX
value|"krping: "
end_define

begin_decl_stmt
specifier|static
name|int
name|debug
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|DEBUG_LOG
value|if (debug) printf
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|krping_option
name|krping_opts
index|[]
init|=
block|{
block|{
literal|"count"
block|,
name|OPT_INT
block|,
literal|'C'
block|}
block|,
block|{
literal|"size"
block|,
name|OPT_INT
block|,
literal|'S'
block|}
block|,
block|{
literal|"addr"
block|,
name|OPT_STRING
block|,
literal|'a'
block|}
block|,
block|{
literal|"port"
block|,
name|OPT_INT
block|,
literal|'p'
block|}
block|,
block|{
literal|"verbose"
block|,
name|OPT_NOPARAM
block|,
literal|'v'
block|}
block|,
block|{
literal|"validate"
block|,
name|OPT_NOPARAM
block|,
literal|'V'
block|}
block|,
block|{
literal|"server"
block|,
name|OPT_NOPARAM
block|,
literal|'s'
block|}
block|,
block|{
literal|"client"
block|,
name|OPT_NOPARAM
block|,
literal|'c'
block|}
block|,
block|{
literal|"dmamr"
block|,
name|OPT_NOPARAM
block|,
literal|'D'
block|}
block|,
block|{
literal|"debug"
block|,
name|OPT_NOPARAM
block|,
literal|'d'
block|}
block|,
block|{
literal|"wlat"
block|,
name|OPT_NOPARAM
block|,
literal|'l'
block|}
block|,
block|{
literal|"rlat"
block|,
name|OPT_NOPARAM
block|,
literal|'L'
block|}
block|,
block|{
literal|"bw"
block|,
name|OPT_NOPARAM
block|,
literal|'B'
block|}
block|,
block|{
literal|"tx-depth"
block|,
name|OPT_INT
block|,
literal|'t'
block|}
block|,
block|{
literal|"poll"
block|,
name|OPT_NOPARAM
block|,
literal|'P'
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|mtx
name|krping_mutex
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * List of running krping threads.  */
end_comment

begin_decl_stmt
name|struct
name|krping_cb_list
name|krping_cbs
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * krping "ping/pong" loop:  * 	client sends source rkey/addr/len  *	server receives source rkey/add/len  *	server rdma reads "ping" data from source  * 	server sends "go ahead" on rdma read completion  *	client sends sink rkey/addr/len  * 	server receives sink rkey/addr/len  * 	server rdma writes "pong" data to sink  * 	server sends "go ahead" on rdma write completion  *<repeat loop>  */
end_comment

begin_comment
comment|/*  * Default max buffer size for IO...  */
end_comment

begin_define
define|#
directive|define
name|RPING_BUFSIZE
value|128*1024
end_define

begin_define
define|#
directive|define
name|RPING_SQ_DEPTH
value|32
end_define

begin_comment
comment|/* lifted from netinet/libalias/alias_proxy.c */
end_comment

begin_function_decl
specifier|static
name|int
name|inet_aton
parameter_list|(
specifier|const
name|char
modifier|*
name|cp
parameter_list|,
name|struct
name|in_addr
modifier|*
name|addr
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|inet_aton
parameter_list|(
name|cp
parameter_list|,
name|addr
parameter_list|)
specifier|const
name|char
modifier|*
name|cp
decl_stmt|;
name|struct
name|in_addr
modifier|*
name|addr
decl_stmt|;
block|{
name|u_long
name|parts
index|[
literal|4
index|]
decl_stmt|;
name|in_addr_t
name|val
decl_stmt|;
specifier|const
name|char
modifier|*
name|c
decl_stmt|;
name|char
modifier|*
name|endptr
decl_stmt|;
name|int
name|gotend
decl_stmt|,
name|n
decl_stmt|;
name|c
operator|=
operator|(
specifier|const
name|char
operator|*
operator|)
name|cp
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Run through the string, grabbing numbers until 	 * the end of the string, or some error 	 */
name|gotend
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|!
name|gotend
condition|)
block|{
name|unsigned
name|long
name|l
decl_stmt|;
name|l
operator|=
name|strtoul
argument_list|(
name|c
argument_list|,
operator|&
name|endptr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|l
operator|==
name|ULONG_MAX
operator|||
operator|(
name|l
operator|==
literal|0
operator|&&
name|endptr
operator|==
name|c
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|val
operator|=
operator|(
name|in_addr_t
operator|)
name|l
expr_stmt|;
comment|/* 		 * If the whole string is invalid, endptr will equal 		 * c.. this way we can make sure someone hasn't 		 * gone '.12' or something which would get past 		 * the next check. 		 */
if|if
condition|(
name|endptr
operator|==
name|c
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|parts
index|[
name|n
index|]
operator|=
name|val
expr_stmt|;
name|c
operator|=
name|endptr
expr_stmt|;
comment|/* Check the next character past the previous number's end */
switch|switch
condition|(
operator|*
name|c
condition|)
block|{
case|case
literal|'.'
case|:
comment|/* Make sure we only do 3 dots .. */
if|if
condition|(
name|n
operator|==
literal|3
condition|)
comment|/* Whoops. Quit. */
return|return
operator|(
literal|0
operator|)
return|;
name|n
operator|++
expr_stmt|;
name|c
operator|++
expr_stmt|;
break|break;
case|case
literal|'\0'
case|:
name|gotend
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|isspace
argument_list|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|c
argument_list|)
condition|)
block|{
name|gotend
operator|=
literal|1
expr_stmt|;
break|break;
block|}
else|else
return|return
operator|(
literal|0
operator|)
return|;
comment|/* Invalid character, so fail */
block|}
block|}
comment|/* 	 * Concoct the address according to 	 * the number of parts specified. 	 */
switch|switch
condition|(
name|n
condition|)
block|{
case|case
literal|0
case|:
comment|/* a -- 32 bits */
comment|/* 		 * Nothing is necessary here.  Overflow checking was 		 * already done in strtoul(). 		 */
break|break;
case|case
literal|1
case|:
comment|/* a.b -- 8.24 bits */
if|if
condition|(
name|val
operator|>
literal|0xffffff
operator|||
name|parts
index|[
literal|0
index|]
operator|>
literal|0xff
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|val
operator||=
name|parts
index|[
literal|0
index|]
operator|<<
literal|24
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* a.b.c -- 8.8.16 bits */
if|if
condition|(
name|val
operator|>
literal|0xffff
operator|||
name|parts
index|[
literal|0
index|]
operator|>
literal|0xff
operator|||
name|parts
index|[
literal|1
index|]
operator|>
literal|0xff
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|val
operator||=
operator|(
name|parts
index|[
literal|0
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|parts
index|[
literal|1
index|]
operator|<<
literal|16
operator|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
comment|/* a.b.c.d -- 8.8.8.8 bits */
if|if
condition|(
name|val
operator|>
literal|0xff
operator|||
name|parts
index|[
literal|0
index|]
operator|>
literal|0xff
operator|||
name|parts
index|[
literal|1
index|]
operator|>
literal|0xff
operator|||
name|parts
index|[
literal|2
index|]
operator|>
literal|0xff
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|val
operator||=
operator|(
name|parts
index|[
literal|0
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|parts
index|[
literal|1
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|parts
index|[
literal|2
index|]
operator|<<
literal|8
operator|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|addr
operator|!=
name|NULL
condition|)
name|addr
operator|->
name|s_addr
operator|=
name|htonl
argument_list|(
name|val
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_wait
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|,
name|int
name|state
parameter_list|)
block|{
name|int
name|rc
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|cb
operator|->
name|lock
argument_list|)
expr_stmt|;
while|while
condition|(
name|cb
operator|->
name|state
operator|<
name|state
condition|)
block|{
name|rc
operator|=
name|msleep
argument_list|(
name|cb
argument_list|,
operator|&
name|cb
operator|->
name|lock
argument_list|,
literal|0
argument_list|,
literal|"krping"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|&&
name|rc
operator|!=
name|ERESTART
condition|)
block|{
name|cb
operator|->
name|state
operator|=
name|ERROR
expr_stmt|;
break|break;
block|}
block|}
name|mtx_unlock
argument_list|(
operator|&
name|cb
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|krping_cma_event_handler
parameter_list|(
name|struct
name|rdma_cm_id
modifier|*
name|cma_id
parameter_list|,
name|struct
name|rdma_cm_event
modifier|*
name|event
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|krping_cb
modifier|*
name|cb
init|=
name|cma_id
operator|->
name|context
decl_stmt|;
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"cma_event type %d cma_id %p (%s)\n"
argument_list|,
name|event
operator|->
name|event
argument_list|,
name|cma_id
argument_list|,
operator|(
name|cma_id
operator|==
name|cb
operator|->
name|cm_id
operator|)
condition|?
literal|"parent"
else|:
literal|"child"
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|cb
operator|->
name|lock
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|event
operator|->
name|event
condition|)
block|{
case|case
name|RDMA_CM_EVENT_ADDR_RESOLVED
case|:
name|cb
operator|->
name|state
operator|=
name|ADDR_RESOLVED
expr_stmt|;
name|ret
operator|=
name|rdma_resolve_route
argument_list|(
name|cma_id
argument_list|,
literal|2000
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"rdma_resolve_route error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|wakeup
argument_list|(
name|cb
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|RDMA_CM_EVENT_ROUTE_RESOLVED
case|:
name|cb
operator|->
name|state
operator|=
name|ROUTE_RESOLVED
expr_stmt|;
name|wakeup
argument_list|(
name|cb
argument_list|)
expr_stmt|;
break|break;
case|case
name|RDMA_CM_EVENT_CONNECT_REQUEST
case|:
name|cb
operator|->
name|state
operator|=
name|CONNECT_REQUEST
expr_stmt|;
name|cb
operator|->
name|child_cm_id
operator|=
name|cma_id
expr_stmt|;
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"child cma %p\n"
argument_list|,
name|cb
operator|->
name|child_cm_id
argument_list|)
expr_stmt|;
name|wakeup
argument_list|(
name|cb
argument_list|)
expr_stmt|;
break|break;
case|case
name|RDMA_CM_EVENT_ESTABLISHED
case|:
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"ESTABLISHED\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
operator|->
name|server
condition|)
block|{
name|cb
operator|->
name|state
operator|=
name|CONNECTED
expr_stmt|;
name|wakeup
argument_list|(
name|cb
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|RDMA_CM_EVENT_ADDR_ERROR
case|:
case|case
name|RDMA_CM_EVENT_ROUTE_ERROR
case|:
case|case
name|RDMA_CM_EVENT_CONNECT_ERROR
case|:
case|case
name|RDMA_CM_EVENT_UNREACHABLE
case|:
case|case
name|RDMA_CM_EVENT_REJECTED
case|:
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"cma event %d, error %d\n"
argument_list|,
name|event
operator|->
name|event
argument_list|,
name|event
operator|->
name|status
argument_list|)
expr_stmt|;
name|cb
operator|->
name|state
operator|=
name|ERROR
expr_stmt|;
name|wakeup
argument_list|(
name|cb
argument_list|)
expr_stmt|;
break|break;
case|case
name|RDMA_CM_EVENT_DISCONNECTED
case|:
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"DISCONNECT EVENT...\n"
argument_list|)
expr_stmt|;
name|cb
operator|->
name|state
operator|=
name|ERROR
expr_stmt|;
name|wakeup
argument_list|(
name|cb
argument_list|)
expr_stmt|;
break|break;
case|case
name|RDMA_CM_EVENT_DEVICE_REMOVAL
case|:
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"cma detected device removal!!!!\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"oof bad type!\n"
argument_list|)
expr_stmt|;
name|wakeup
argument_list|(
name|cb
argument_list|)
expr_stmt|;
break|break;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|cb
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|server_recv
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|,
name|struct
name|ib_wc
modifier|*
name|wc
parameter_list|)
block|{
if|if
condition|(
name|wc
operator|->
name|byte_len
operator|!=
sizeof|sizeof
argument_list|(
name|cb
operator|->
name|recv_buf
argument_list|)
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Received bogus data, size %d\n"
argument_list|,
name|wc
operator|->
name|byte_len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|cb
operator|->
name|remote_rkey
operator|=
name|ntohl
argument_list|(
name|cb
operator|->
name|recv_buf
operator|.
name|rkey
argument_list|)
expr_stmt|;
name|cb
operator|->
name|remote_addr
operator|=
name|ntohll
argument_list|(
name|cb
operator|->
name|recv_buf
operator|.
name|buf
argument_list|)
expr_stmt|;
name|cb
operator|->
name|remote_len
operator|=
name|ntohl
argument_list|(
name|cb
operator|->
name|recv_buf
operator|.
name|size
argument_list|)
expr_stmt|;
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"Received rkey %x addr %llx len %d from peer\n"
argument_list|,
name|cb
operator|->
name|remote_rkey
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|cb
operator|->
name|remote_addr
argument_list|,
name|cb
operator|->
name|remote_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|<=
name|CONNECTED
operator|||
name|cb
operator|->
name|state
operator|==
name|RDMA_WRITE_COMPLETE
condition|)
name|cb
operator|->
name|state
operator|=
name|RDMA_READ_ADV
expr_stmt|;
else|else
name|cb
operator|->
name|state
operator|=
name|RDMA_WRITE_ADV
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|client_recv
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|,
name|struct
name|ib_wc
modifier|*
name|wc
parameter_list|)
block|{
if|if
condition|(
name|wc
operator|->
name|byte_len
operator|!=
sizeof|sizeof
argument_list|(
name|cb
operator|->
name|recv_buf
argument_list|)
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Received bogus data, size %d\n"
argument_list|,
name|wc
operator|->
name|byte_len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|cb
operator|->
name|state
operator|==
name|RDMA_READ_ADV
condition|)
name|cb
operator|->
name|state
operator|=
name|RDMA_WRITE_ADV
expr_stmt|;
else|else
name|cb
operator|->
name|state
operator|=
name|RDMA_WRITE_COMPLETE
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_cq_event_handler
parameter_list|(
name|struct
name|ib_cq
modifier|*
name|cq
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|krping_cb
modifier|*
name|cb
init|=
name|ctx
decl_stmt|;
name|struct
name|ib_wc
name|wc
decl_stmt|;
name|struct
name|ib_recv_wr
modifier|*
name|bad_wr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|cb
operator|->
name|lock
argument_list|)
expr_stmt|;
name|KASSERT
argument_list|(
name|cb
operator|->
name|cq
operator|==
name|cq
argument_list|,
operator|(
literal|"bad condition"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|==
name|ERROR
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"cq completion in ERROR state\n"
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|cb
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|cb
operator|->
name|wlat
operator|&&
operator|!
name|cb
operator|->
name|rlat
operator|&&
operator|!
name|cb
operator|->
name|bw
condition|)
name|ib_req_notify_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
name|IB_CQ_NEXT_COMP
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|ret
operator|=
name|ib_poll_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
literal|1
argument_list|,
operator|&
name|wc
argument_list|)
operator|)
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|wc
operator|.
name|status
condition|)
block|{
if|if
condition|(
name|wc
operator|.
name|status
operator|!=
name|IB_WC_WR_FLUSH_ERR
condition|)
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"cq completion failed status %d\n"
argument_list|,
name|wc
operator|.
name|status
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
switch|switch
condition|(
name|wc
operator|.
name|opcode
condition|)
block|{
case|case
name|IB_WC_SEND
case|:
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"send completion\n"
argument_list|)
expr_stmt|;
name|cb
operator|->
name|stats
operator|.
name|send_bytes
operator|+=
name|cb
operator|->
name|send_sgl
operator|.
name|length
expr_stmt|;
name|cb
operator|->
name|stats
operator|.
name|send_msgs
operator|++
expr_stmt|;
break|break;
case|case
name|IB_WC_RDMA_WRITE
case|:
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"rdma write completion\n"
argument_list|)
expr_stmt|;
name|cb
operator|->
name|stats
operator|.
name|write_bytes
operator|+=
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|sg_list
operator|->
name|length
expr_stmt|;
name|cb
operator|->
name|stats
operator|.
name|write_msgs
operator|++
expr_stmt|;
name|cb
operator|->
name|state
operator|=
name|RDMA_WRITE_COMPLETE
expr_stmt|;
name|wakeup
argument_list|(
name|cb
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_WC_RDMA_READ
case|:
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"rdma read completion\n"
argument_list|)
expr_stmt|;
name|cb
operator|->
name|stats
operator|.
name|read_bytes
operator|+=
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|sg_list
operator|->
name|length
expr_stmt|;
name|cb
operator|->
name|stats
operator|.
name|read_msgs
operator|++
expr_stmt|;
name|cb
operator|->
name|state
operator|=
name|RDMA_READ_COMPLETE
expr_stmt|;
name|wakeup
argument_list|(
name|cb
argument_list|)
expr_stmt|;
break|break;
case|case
name|IB_WC_RECV
case|:
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"recv completion\n"
argument_list|)
expr_stmt|;
name|cb
operator|->
name|stats
operator|.
name|recv_bytes
operator|+=
sizeof|sizeof
argument_list|(
name|cb
operator|->
name|recv_buf
argument_list|)
expr_stmt|;
name|cb
operator|->
name|stats
operator|.
name|recv_msgs
operator|++
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|wlat
operator|||
name|cb
operator|->
name|rlat
operator|||
name|cb
operator|->
name|bw
condition|)
name|ret
operator|=
name|server_recv
argument_list|(
name|cb
argument_list|,
operator|&
name|wc
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
name|cb
operator|->
name|server
condition|?
name|server_recv
argument_list|(
name|cb
argument_list|,
operator|&
name|wc
argument_list|)
else|:
name|client_recv
argument_list|(
name|cb
argument_list|,
operator|&
name|wc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"recv wc error: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|ret
operator|=
name|ib_post_recv
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|rq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"post recv error: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|wakeup
argument_list|(
name|cb
argument_list|)
expr_stmt|;
break|break;
default|default:
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"unknown!!!!! completion\n"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
block|}
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"poll error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|cb
operator|->
name|lock
argument_list|)
expr_stmt|;
return|return;
name|error
label|:
name|cb
operator|->
name|state
operator|=
name|ERROR
expr_stmt|;
name|wakeup
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|cb
operator|->
name|lock
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|krping_accept
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|rdma_conn_param
name|conn_param
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"accepting client connection request\n"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|conn_param
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|conn_param
argument_list|)
expr_stmt|;
name|conn_param
operator|.
name|responder_resources
operator|=
literal|1
expr_stmt|;
name|conn_param
operator|.
name|initiator_depth
operator|=
literal|1
expr_stmt|;
name|ret
operator|=
name|rdma_accept
argument_list|(
name|cb
operator|->
name|child_cm_id
argument_list|,
operator|&
name|conn_param
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"rdma_accept error: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
operator|!
name|cb
operator|->
name|wlat
operator|&&
operator|!
name|cb
operator|->
name|rlat
operator|&&
operator|!
name|cb
operator|->
name|bw
condition|)
block|{
name|krping_wait
argument_list|(
name|cb
argument_list|,
name|CONNECTED
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|==
name|ERROR
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"wait for CONNECTED state %d\n"
argument_list|,
name|cb
operator|->
name|state
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_setup_wr
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
comment|/* XXX X86 only here... not mapping for dma! */
name|cb
operator|->
name|recv_sgl
operator|.
name|addr
operator|=
name|vtophys
argument_list|(
operator|&
name|cb
operator|->
name|recv_buf
argument_list|)
expr_stmt|;
name|cb
operator|->
name|recv_sgl
operator|.
name|length
operator|=
sizeof|sizeof
name|cb
operator|->
name|recv_buf
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|use_dmamr
condition|)
name|cb
operator|->
name|recv_sgl
operator|.
name|lkey
operator|=
name|cb
operator|->
name|dma_mr
operator|->
name|lkey
expr_stmt|;
else|else
name|cb
operator|->
name|recv_sgl
operator|.
name|lkey
operator|=
name|cb
operator|->
name|recv_mr
operator|->
name|lkey
expr_stmt|;
name|cb
operator|->
name|rq_wr
operator|.
name|sg_list
operator|=
operator|&
name|cb
operator|->
name|recv_sgl
expr_stmt|;
name|cb
operator|->
name|rq_wr
operator|.
name|num_sge
operator|=
literal|1
expr_stmt|;
name|cb
operator|->
name|send_sgl
operator|.
name|addr
operator|=
name|vtophys
argument_list|(
operator|&
name|cb
operator|->
name|send_buf
argument_list|)
expr_stmt|;
name|cb
operator|->
name|send_sgl
operator|.
name|length
operator|=
sizeof|sizeof
name|cb
operator|->
name|send_buf
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|use_dmamr
condition|)
name|cb
operator|->
name|send_sgl
operator|.
name|lkey
operator|=
name|cb
operator|->
name|dma_mr
operator|->
name|lkey
expr_stmt|;
else|else
name|cb
operator|->
name|send_sgl
operator|.
name|lkey
operator|=
name|cb
operator|->
name|send_mr
operator|->
name|lkey
expr_stmt|;
name|cb
operator|->
name|sq_wr
operator|.
name|opcode
operator|=
name|IB_WR_SEND
expr_stmt|;
name|cb
operator|->
name|sq_wr
operator|.
name|send_flags
operator|=
name|IB_SEND_SIGNALED
expr_stmt|;
name|cb
operator|->
name|sq_wr
operator|.
name|sg_list
operator|=
operator|&
name|cb
operator|->
name|send_sgl
expr_stmt|;
name|cb
operator|->
name|sq_wr
operator|.
name|num_sge
operator|=
literal|1
expr_stmt|;
name|cb
operator|->
name|rdma_addr
operator|=
name|vtophys
argument_list|(
name|cb
operator|->
name|rdma_buf
argument_list|)
expr_stmt|;
name|cb
operator|->
name|rdma_sgl
operator|.
name|addr
operator|=
name|cb
operator|->
name|rdma_addr
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|use_dmamr
condition|)
name|cb
operator|->
name|rdma_sgl
operator|.
name|lkey
operator|=
name|cb
operator|->
name|dma_mr
operator|->
name|lkey
expr_stmt|;
else|else
name|cb
operator|->
name|rdma_sgl
operator|.
name|lkey
operator|=
name|cb
operator|->
name|rdma_mr
operator|->
name|lkey
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|send_flags
operator|=
name|IB_SEND_SIGNALED
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|sg_list
operator|=
operator|&
name|cb
operator|->
name|rdma_sgl
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|num_sge
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|cb
operator|->
name|server
operator|||
name|cb
operator|->
name|wlat
operator|||
name|cb
operator|->
name|rlat
operator|||
name|cb
operator|->
name|bw
condition|)
block|{
name|cb
operator|->
name|start_addr
operator|=
name|vtophys
argument_list|(
name|cb
operator|->
name|start_buf
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|krping_setup_buffers
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|ib_phys_buf
name|buf
decl_stmt|;
name|u64
name|iovbase
decl_stmt|;
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"krping_setup_buffers called on cb %p\n"
argument_list|,
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|use_dmamr
condition|)
block|{
name|cb
operator|->
name|dma_mr
operator|=
name|ib_get_dma_mr
argument_list|(
name|cb
operator|->
name|pd
argument_list|,
name|IB_ACCESS_LOCAL_WRITE
operator||
name|IB_ACCESS_REMOTE_READ
operator||
name|IB_ACCESS_REMOTE_WRITE
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|cb
operator|->
name|dma_mr
argument_list|)
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"reg_dmamr failed\n"
argument_list|)
expr_stmt|;
return|return
name|PTR_ERR
argument_list|(
name|cb
operator|->
name|dma_mr
argument_list|)
return|;
block|}
block|}
else|else
block|{
name|buf
operator|.
name|addr
operator|=
name|vtophys
argument_list|(
operator|&
name|cb
operator|->
name|recv_buf
argument_list|)
expr_stmt|;
name|buf
operator|.
name|size
operator|=
sizeof|sizeof
name|cb
operator|->
name|recv_buf
expr_stmt|;
name|iovbase
operator|=
name|vtophys
argument_list|(
operator|&
name|cb
operator|->
name|recv_buf
argument_list|)
expr_stmt|;
name|cb
operator|->
name|recv_mr
operator|=
name|ib_reg_phys_mr
argument_list|(
name|cb
operator|->
name|pd
argument_list|,
operator|&
name|buf
argument_list|,
literal|1
argument_list|,
name|IB_ACCESS_LOCAL_WRITE
argument_list|,
operator|&
name|iovbase
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|cb
operator|->
name|recv_mr
argument_list|)
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"recv_buf reg_mr failed\n"
argument_list|)
expr_stmt|;
return|return
name|PTR_ERR
argument_list|(
name|cb
operator|->
name|recv_mr
argument_list|)
return|;
block|}
name|buf
operator|.
name|addr
operator|=
name|vtophys
argument_list|(
operator|&
name|cb
operator|->
name|send_buf
argument_list|)
expr_stmt|;
name|buf
operator|.
name|size
operator|=
sizeof|sizeof
name|cb
operator|->
name|send_buf
expr_stmt|;
name|iovbase
operator|=
name|vtophys
argument_list|(
operator|&
name|cb
operator|->
name|send_buf
argument_list|)
expr_stmt|;
name|cb
operator|->
name|send_mr
operator|=
name|ib_reg_phys_mr
argument_list|(
name|cb
operator|->
name|pd
argument_list|,
operator|&
name|buf
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
operator|&
name|iovbase
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|cb
operator|->
name|send_mr
argument_list|)
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"send_buf reg_mr failed\n"
argument_list|)
expr_stmt|;
name|ib_dereg_mr
argument_list|(
name|cb
operator|->
name|recv_mr
argument_list|)
expr_stmt|;
return|return
name|PTR_ERR
argument_list|(
name|cb
operator|->
name|send_mr
argument_list|)
return|;
block|}
block|}
name|cb
operator|->
name|rdma_buf
operator|=
name|contigmalloc
argument_list|(
name|cb
operator|->
name|size
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
argument_list|,
literal|0
argument_list|,
operator|-
literal|1UL
argument_list|,
name|PAGE_SIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
operator|->
name|rdma_buf
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"rdma_buf malloc failed\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
if|if
condition|(
operator|!
name|cb
operator|->
name|use_dmamr
condition|)
block|{
name|buf
operator|.
name|addr
operator|=
name|vtophys
argument_list|(
name|cb
operator|->
name|rdma_buf
argument_list|)
expr_stmt|;
name|buf
operator|.
name|size
operator|=
name|cb
operator|->
name|size
expr_stmt|;
name|iovbase
operator|=
name|vtophys
argument_list|(
name|cb
operator|->
name|rdma_buf
argument_list|)
expr_stmt|;
name|cb
operator|->
name|rdma_mr
operator|=
name|ib_reg_phys_mr
argument_list|(
name|cb
operator|->
name|pd
argument_list|,
operator|&
name|buf
argument_list|,
literal|1
argument_list|,
name|IB_ACCESS_REMOTE_READ
operator||
name|IB_ACCESS_REMOTE_WRITE
argument_list|,
operator|&
name|iovbase
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|cb
operator|->
name|rdma_mr
argument_list|)
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"rdma_buf reg_mr failed\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|cb
operator|->
name|rdma_mr
argument_list|)
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
block|}
if|if
condition|(
operator|!
name|cb
operator|->
name|server
operator|||
name|cb
operator|->
name|wlat
operator|||
name|cb
operator|->
name|rlat
operator|||
name|cb
operator|->
name|bw
condition|)
block|{
name|cb
operator|->
name|start_buf
operator|=
name|contigmalloc
argument_list|(
name|cb
operator|->
name|size
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
argument_list|,
literal|0
argument_list|,
operator|-
literal|1UL
argument_list|,
name|PAGE_SIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
operator|->
name|start_buf
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"start_buf malloc failed\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ENOMEM
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
if|if
condition|(
operator|!
name|cb
operator|->
name|use_dmamr
condition|)
block|{
name|unsigned
name|flags
init|=
name|IB_ACCESS_REMOTE_READ
decl_stmt|;
if|if
condition|(
name|cb
operator|->
name|wlat
operator|||
name|cb
operator|->
name|rlat
operator|||
name|cb
operator|->
name|bw
condition|)
name|flags
operator||=
name|IB_ACCESS_REMOTE_WRITE
expr_stmt|;
name|buf
operator|.
name|addr
operator|=
name|vtophys
argument_list|(
name|cb
operator|->
name|start_buf
argument_list|)
expr_stmt|;
name|buf
operator|.
name|size
operator|=
name|cb
operator|->
name|size
expr_stmt|;
name|iovbase
operator|=
name|vtophys
argument_list|(
name|cb
operator|->
name|start_buf
argument_list|)
expr_stmt|;
name|cb
operator|->
name|start_mr
operator|=
name|ib_reg_phys_mr
argument_list|(
name|cb
operator|->
name|pd
argument_list|,
operator|&
name|buf
argument_list|,
literal|1
argument_list|,
name|flags
argument_list|,
operator|&
name|iovbase
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|cb
operator|->
name|start_mr
argument_list|)
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"start_buf reg_mr failed\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|cb
operator|->
name|start_mr
argument_list|)
expr_stmt|;
goto|goto
name|err3
goto|;
block|}
block|}
block|}
name|krping_setup_wr
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"allocated& registered buffers...\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|err3
label|:
name|contigfree
argument_list|(
name|cb
operator|->
name|start_buf
argument_list|,
name|cb
operator|->
name|size
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
operator|->
name|use_dmamr
condition|)
name|ib_dereg_mr
argument_list|(
name|cb
operator|->
name|rdma_mr
argument_list|)
expr_stmt|;
name|err2
label|:
name|contigfree
argument_list|(
name|cb
operator|->
name|rdma_buf
argument_list|,
name|cb
operator|->
name|size
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|err1
label|:
if|if
condition|(
name|cb
operator|->
name|use_dmamr
condition|)
name|ib_dereg_mr
argument_list|(
name|cb
operator|->
name|dma_mr
argument_list|)
expr_stmt|;
else|else
block|{
name|ib_dereg_mr
argument_list|(
name|cb
operator|->
name|recv_mr
argument_list|)
expr_stmt|;
name|ib_dereg_mr
argument_list|(
name|cb
operator|->
name|send_mr
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_free_buffers
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"krping_free_buffers called on cb %p\n"
argument_list|,
name|cb
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
block|dma_unmap_single(cb->pd->device->dma_device, 			 pci_unmap_addr(cb, recv_mapping), 			 sizeof(cb->recv_buf), DMA_BIDIRECTIONAL); 	dma_unmap_single(cb->pd->device->dma_device, 			 pci_unmap_addr(cb, send_mapping), 			 sizeof(cb->send_buf), DMA_BIDIRECTIONAL); 	dma_unmap_single(cb->pd->device->dma_device, 			 pci_unmap_addr(cb, rdma_mapping), 			 cb->size, DMA_BIDIRECTIONAL);
endif|#
directive|endif
name|contigfree
argument_list|(
name|cb
operator|->
name|rdma_buf
argument_list|,
name|cb
operator|->
name|size
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
operator|->
name|server
operator|||
name|cb
operator|->
name|wlat
operator|||
name|cb
operator|->
name|rlat
operator|||
name|cb
operator|->
name|bw
condition|)
block|{
if|#
directive|if
literal|0
block|dma_unmap_single(cb->pd->device->dma_device, 			 pci_unmap_addr(cb, start_mapping), 			 cb->size, DMA_BIDIRECTIONAL);
endif|#
directive|endif
name|contigfree
argument_list|(
name|cb
operator|->
name|start_buf
argument_list|,
name|cb
operator|->
name|size
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cb
operator|->
name|use_dmamr
condition|)
name|ib_dereg_mr
argument_list|(
name|cb
operator|->
name|dma_mr
argument_list|)
expr_stmt|;
else|else
block|{
name|ib_dereg_mr
argument_list|(
name|cb
operator|->
name|send_mr
argument_list|)
expr_stmt|;
name|ib_dereg_mr
argument_list|(
name|cb
operator|->
name|recv_mr
argument_list|)
expr_stmt|;
name|ib_dereg_mr
argument_list|(
name|cb
operator|->
name|rdma_mr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
operator|->
name|server
condition|)
name|ib_dereg_mr
argument_list|(
name|cb
operator|->
name|start_mr
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|krping_create_qp
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ib_qp_init_attr
name|init_attr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|memset
argument_list|(
operator|&
name|init_attr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|init_attr
argument_list|)
argument_list|)
expr_stmt|;
name|init_attr
operator|.
name|cap
operator|.
name|max_send_wr
operator|=
name|cb
operator|->
name|txdepth
expr_stmt|;
name|init_attr
operator|.
name|cap
operator|.
name|max_recv_wr
operator|=
literal|2
expr_stmt|;
name|init_attr
operator|.
name|cap
operator|.
name|max_recv_sge
operator|=
literal|1
expr_stmt|;
name|init_attr
operator|.
name|cap
operator|.
name|max_send_sge
operator|=
literal|1
expr_stmt|;
name|init_attr
operator|.
name|qp_type
operator|=
name|IB_QPT_RC
expr_stmt|;
name|init_attr
operator|.
name|send_cq
operator|=
name|cb
operator|->
name|cq
expr_stmt|;
name|init_attr
operator|.
name|recv_cq
operator|=
name|cb
operator|->
name|cq
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|server
condition|)
block|{
name|ret
operator|=
name|rdma_create_qp
argument_list|(
name|cb
operator|->
name|child_cm_id
argument_list|,
name|cb
operator|->
name|pd
argument_list|,
operator|&
name|init_attr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|cb
operator|->
name|qp
operator|=
name|cb
operator|->
name|child_cm_id
operator|->
name|qp
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|rdma_create_qp
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|,
name|cb
operator|->
name|pd
argument_list|,
operator|&
name|init_attr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|cb
operator|->
name|qp
operator|=
name|cb
operator|->
name|cm_id
operator|->
name|qp
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_free_qp
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|ib_destroy_qp
argument_list|(
name|cb
operator|->
name|qp
argument_list|)
expr_stmt|;
name|ib_destroy_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|)
expr_stmt|;
name|ib_dealloc_pd
argument_list|(
name|cb
operator|->
name|pd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|krping_setup_qp
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|,
name|struct
name|rdma_cm_id
modifier|*
name|cm_id
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|cb
operator|->
name|pd
operator|=
name|ib_alloc_pd
argument_list|(
name|cm_id
operator|->
name|device
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|cb
operator|->
name|pd
argument_list|)
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"ib_alloc_pd failed\n"
argument_list|)
expr_stmt|;
return|return
name|PTR_ERR
argument_list|(
name|cb
operator|->
name|pd
argument_list|)
return|;
block|}
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"created pd %p\n"
argument_list|,
name|cb
operator|->
name|pd
argument_list|)
expr_stmt|;
name|cb
operator|->
name|cq
operator|=
name|ib_create_cq
argument_list|(
name|cm_id
operator|->
name|device
argument_list|,
name|krping_cq_event_handler
argument_list|,
name|NULL
argument_list|,
name|cb
argument_list|,
name|cb
operator|->
name|txdepth
operator|*
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|cb
operator|->
name|cq
argument_list|)
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"ib_create_cq failed\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|cb
operator|->
name|cq
argument_list|)
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"created cq %p\n"
argument_list|,
name|cb
operator|->
name|cq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
operator|->
name|wlat
operator|&&
operator|!
name|cb
operator|->
name|rlat
operator|&&
operator|!
name|cb
operator|->
name|bw
condition|)
block|{
name|ret
operator|=
name|ib_req_notify_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
name|IB_CQ_NEXT_COMP
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"ib_create_cq failed\n"
argument_list|)
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
block|}
name|ret
operator|=
name|krping_create_qp
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"krping_create_qp failed: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"created qp %p\n"
argument_list|,
name|cb
operator|->
name|qp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|err2
label|:
name|ib_destroy_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|)
expr_stmt|;
name|err1
label|:
name|ib_dealloc_pd
argument_list|(
name|cb
operator|->
name|pd
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_format_send
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|,
name|u64
name|buf
parameter_list|,
name|struct
name|ib_mr
modifier|*
name|mr
parameter_list|)
block|{
name|struct
name|krping_rdma_info
modifier|*
name|info
init|=
operator|&
name|cb
operator|->
name|send_buf
decl_stmt|;
name|info
operator|->
name|buf
operator|=
name|htonll
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|info
operator|->
name|rkey
operator|=
name|htonl
argument_list|(
name|mr
operator|->
name|rkey
argument_list|)
expr_stmt|;
name|info
operator|->
name|size
operator|=
name|htonl
argument_list|(
name|cb
operator|->
name|size
argument_list|)
expr_stmt|;
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"RDMA addr %llx rkey %x len %d\n"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|buf
argument_list|,
name|mr
operator|->
name|rkey
argument_list|,
name|cb
operator|->
name|size
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_test_server
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
name|int
name|ret
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
comment|/* Wait for client's Start STAG/TO/Len */
name|krping_wait
argument_list|(
name|cb
argument_list|,
name|RDMA_READ_ADV
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|!=
name|RDMA_READ_ADV
condition|)
block|{
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"wait for RDMA_READ_ADV state %d\n"
argument_list|,
name|cb
operator|->
name|state
argument_list|)
expr_stmt|;
break|break;
block|}
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"server received sink adv\n"
argument_list|)
expr_stmt|;
comment|/* Issue RDMA Read. */
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|opcode
operator|=
name|IB_WR_RDMA_READ
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|rdma
operator|.
name|rkey
operator|=
name|cb
operator|->
name|remote_rkey
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|rdma
operator|.
name|remote_addr
operator|=
name|cb
operator|->
name|remote_addr
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|sg_list
operator|->
name|length
operator|=
name|cb
operator|->
name|remote_len
expr_stmt|;
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|rdma_sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"post send error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
break|break;
block|}
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"server posted rdma read req \n"
argument_list|)
expr_stmt|;
comment|/* Wait for read completion */
name|krping_wait
argument_list|(
name|cb
argument_list|,
name|RDMA_READ_COMPLETE
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|!=
name|RDMA_READ_COMPLETE
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"wait for RDMA_READ_COMPLETE state %d\n"
argument_list|,
name|cb
operator|->
name|state
argument_list|)
expr_stmt|;
break|break;
block|}
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"server received read complete\n"
argument_list|)
expr_stmt|;
comment|/* Display data in recv buf */
if|if
condition|(
name|cb
operator|->
name|verbose
condition|)
name|DEBUG_LOG
argument_list|(
literal|"server ping data: %s\n"
argument_list|,
name|cb
operator|->
name|rdma_buf
argument_list|)
expr_stmt|;
comment|/* Tell client to continue */
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"post send error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
break|break;
block|}
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"server posted go ahead\n"
argument_list|)
expr_stmt|;
comment|/* Wait for client's RDMA STAG/TO/Len */
name|krping_wait
argument_list|(
name|cb
argument_list|,
name|RDMA_WRITE_ADV
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|!=
name|RDMA_WRITE_ADV
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"wait for RDMA_WRITE_ADV state %d\n"
argument_list|,
name|cb
operator|->
name|state
argument_list|)
expr_stmt|;
break|break;
block|}
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"server received sink adv\n"
argument_list|)
expr_stmt|;
comment|/* RDMA Write echo data */
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|opcode
operator|=
name|IB_WR_RDMA_WRITE
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|rdma
operator|.
name|rkey
operator|=
name|cb
operator|->
name|remote_rkey
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|rdma
operator|.
name|remote_addr
operator|=
name|cb
operator|->
name|remote_addr
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|sg_list
operator|->
name|length
operator|=
name|strlen
argument_list|(
name|cb
operator|->
name|rdma_buf
argument_list|)
operator|+
literal|1
expr_stmt|;
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"rdma write from lkey %x laddr %llx len %d\n"
argument_list|,
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|sg_list
operator|->
name|lkey
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|sg_list
operator|->
name|addr
argument_list|,
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|sg_list
operator|->
name|length
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|rdma_sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"post send error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Wait for completion */
name|krping_wait
argument_list|(
name|cb
argument_list|,
name|RDMA_WRITE_COMPLETE
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|!=
name|RDMA_WRITE_COMPLETE
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"wait for RDMA_WRITE_COMPLETE state %d\n"
argument_list|,
name|cb
operator|->
name|state
argument_list|)
expr_stmt|;
break|break;
block|}
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"server rdma write complete \n"
argument_list|)
expr_stmt|;
name|cb
operator|->
name|state
operator|=
name|CONNECTED
expr_stmt|;
comment|/* Tell client to begin again */
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"post send error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
break|break;
block|}
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"server posted go ahead\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|rlat_test
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|int
name|scnt
decl_stmt|;
name|int
name|iters
init|=
name|cb
operator|->
name|count
decl_stmt|;
name|struct
name|timeval
name|start_tv
decl_stmt|,
name|stop_tv
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|ib_wc
name|wc
decl_stmt|;
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
name|int
name|ne
decl_stmt|;
name|scnt
operator|=
literal|0
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|opcode
operator|=
name|IB_WR_RDMA_READ
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|rdma
operator|.
name|rkey
operator|=
name|cb
operator|->
name|remote_rkey
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|rdma
operator|.
name|remote_addr
operator|=
name|cb
operator|->
name|remote_addr
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|sg_list
operator|->
name|length
operator|=
name|cb
operator|->
name|size
expr_stmt|;
name|microtime
argument_list|(
operator|&
name|start_tv
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
operator|->
name|poll
condition|)
block|{
name|cb
operator|->
name|state
operator|=
name|RDMA_READ_ADV
expr_stmt|;
name|ib_req_notify_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
name|IB_CQ_NEXT_COMP
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|scnt
operator|<
name|iters
condition|)
block|{
name|cb
operator|->
name|state
operator|=
name|RDMA_READ_ADV
expr_stmt|;
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|rdma_sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Couldn't post send: ret=%d scnt %d\n"
argument_list|,
name|ret
argument_list|,
name|scnt
argument_list|)
expr_stmt|;
return|return;
block|}
do|do
block|{
if|if
condition|(
operator|!
name|cb
operator|->
name|poll
condition|)
block|{
name|krping_wait
argument_list|(
name|cb
argument_list|,
name|RDMA_READ_COMPLETE
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|==
name|RDMA_READ_COMPLETE
condition|)
block|{
name|ne
operator|=
literal|1
expr_stmt|;
name|ib_req_notify_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
name|IB_CQ_NEXT_COMP
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ne
operator|=
operator|-
literal|1
expr_stmt|;
block|}
block|}
else|else
name|ne
operator|=
name|ib_poll_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
literal|1
argument_list|,
operator|&
name|wc
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|==
name|ERROR
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"state == ERROR...bailing scnt %d\n"
argument_list|,
name|scnt
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
do|while
condition|(
name|ne
operator|==
literal|0
condition|)
do|;
if|if
condition|(
name|ne
operator|<
literal|0
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"poll CQ failed %d\n"
argument_list|,
name|ne
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|cb
operator|->
name|poll
operator|&&
name|wc
operator|.
name|status
operator|!=
name|IB_WC_SUCCESS
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Completion wth error at %s:\n"
argument_list|,
name|cb
operator|->
name|server
condition|?
literal|"server"
else|:
literal|"client"
argument_list|)
expr_stmt|;
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Failed status %d: wr_id %d\n"
argument_list|,
name|wc
operator|.
name|status
argument_list|,
operator|(
name|int
operator|)
name|wc
operator|.
name|wr_id
argument_list|)
expr_stmt|;
return|return;
block|}
operator|++
name|scnt
expr_stmt|;
block|}
name|microtime
argument_list|(
operator|&
name|stop_tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|stop_tv
operator|.
name|tv_usec
operator|<
name|start_tv
operator|.
name|tv_usec
condition|)
block|{
name|stop_tv
operator|.
name|tv_usec
operator|+=
literal|1000000
expr_stmt|;
name|stop_tv
operator|.
name|tv_sec
operator|-=
literal|1
expr_stmt|;
block|}
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"delta sec %lu delta usec %lu iter %d size %d\n"
argument_list|,
name|stop_tv
operator|.
name|tv_sec
operator|-
name|start_tv
operator|.
name|tv_sec
argument_list|,
name|stop_tv
operator|.
name|tv_usec
operator|-
name|start_tv
operator|.
name|tv_usec
argument_list|,
name|scnt
argument_list|,
name|cb
operator|->
name|size
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|alloc_cycle_mem
parameter_list|(
name|int
name|cycle_iters
parameter_list|,
name|cycles_t
modifier|*
modifier|*
name|post_cycles_start
parameter_list|,
name|cycles_t
modifier|*
modifier|*
name|post_cycles_stop
parameter_list|,
name|cycles_t
modifier|*
modifier|*
name|poll_cycles_start
parameter_list|,
name|cycles_t
modifier|*
modifier|*
name|poll_cycles_stop
parameter_list|,
name|cycles_t
modifier|*
modifier|*
name|last_poll_cycles_start
parameter_list|)
block|{
operator|*
name|post_cycles_start
operator|=
name|malloc
argument_list|(
name|cycle_iters
operator|*
sizeof|sizeof
argument_list|(
name|cycles_t
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|post_cycles_start
condition|)
block|{
goto|goto
name|fail1
goto|;
block|}
operator|*
name|post_cycles_stop
operator|=
name|malloc
argument_list|(
name|cycle_iters
operator|*
sizeof|sizeof
argument_list|(
name|cycles_t
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|post_cycles_stop
condition|)
block|{
goto|goto
name|fail2
goto|;
block|}
operator|*
name|poll_cycles_start
operator|=
name|malloc
argument_list|(
name|cycle_iters
operator|*
sizeof|sizeof
argument_list|(
name|cycles_t
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|poll_cycles_start
condition|)
block|{
goto|goto
name|fail3
goto|;
block|}
operator|*
name|poll_cycles_stop
operator|=
name|malloc
argument_list|(
name|cycle_iters
operator|*
sizeof|sizeof
argument_list|(
name|cycles_t
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|poll_cycles_stop
condition|)
block|{
goto|goto
name|fail4
goto|;
block|}
operator|*
name|last_poll_cycles_start
operator|=
name|malloc
argument_list|(
name|cycle_iters
operator|*
sizeof|sizeof
argument_list|(
name|cycles_t
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|last_poll_cycles_start
condition|)
block|{
goto|goto
name|fail5
goto|;
block|}
return|return
literal|0
return|;
name|fail5
label|:
name|free
argument_list|(
operator|*
name|poll_cycles_stop
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|fail4
label|:
name|free
argument_list|(
operator|*
name|poll_cycles_start
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|fail3
label|:
name|free
argument_list|(
operator|*
name|post_cycles_stop
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|fail2
label|:
name|free
argument_list|(
operator|*
name|post_cycles_start
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|fail1
label|:
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s malloc failed\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
return|return
name|ENOMEM
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|free_cycle_mem
parameter_list|(
name|cycles_t
modifier|*
name|post_cycles_start
parameter_list|,
name|cycles_t
modifier|*
name|post_cycles_stop
parameter_list|,
name|cycles_t
modifier|*
name|poll_cycles_start
parameter_list|,
name|cycles_t
modifier|*
name|poll_cycles_stop
parameter_list|,
name|cycles_t
modifier|*
name|last_poll_cycles_start
parameter_list|)
block|{
name|free
argument_list|(
name|last_poll_cycles_start
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|poll_cycles_stop
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|poll_cycles_start
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|post_cycles_stop
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|post_cycles_start
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wlat_test
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|int
name|ccnt
decl_stmt|,
name|scnt
decl_stmt|,
name|rcnt
decl_stmt|;
name|int
name|iters
init|=
name|cb
operator|->
name|count
decl_stmt|;
specifier|volatile
name|char
modifier|*
name|poll_buf
init|=
operator|(
name|char
operator|*
operator|)
name|cb
operator|->
name|start_buf
decl_stmt|;
name|char
modifier|*
name|buf
init|=
operator|(
name|char
operator|*
operator|)
name|cb
operator|->
name|rdma_buf
decl_stmt|;
name|ccnt
operator|=
literal|0
expr_stmt|;
name|scnt
operator|=
literal|0
expr_stmt|;
name|rcnt
operator|=
literal|0
expr_stmt|;
name|struct
name|timeval
name|start_tv
decl_stmt|,
name|stop_tv
decl_stmt|;
name|cycles_t
modifier|*
name|post_cycles_start
decl_stmt|,
modifier|*
name|post_cycles_stop
decl_stmt|;
name|cycles_t
modifier|*
name|poll_cycles_start
decl_stmt|,
modifier|*
name|poll_cycles_stop
decl_stmt|;
name|cycles_t
modifier|*
name|last_poll_cycles_start
decl_stmt|;
name|cycles_t
name|sum_poll
init|=
literal|0
decl_stmt|,
name|sum_post
init|=
literal|0
decl_stmt|,
name|sum_last_poll
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|cycle_iters
init|=
literal|1000
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|alloc_cycle_mem
argument_list|(
name|cycle_iters
argument_list|,
operator|&
name|post_cycles_start
argument_list|,
operator|&
name|post_cycles_stop
argument_list|,
operator|&
name|poll_cycles_start
argument_list|,
operator|&
name|poll_cycles_stop
argument_list|,
operator|&
name|last_poll_cycles_start
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s malloc failed\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
return|return;
block|}
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|opcode
operator|=
name|IB_WR_RDMA_WRITE
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|rdma
operator|.
name|rkey
operator|=
name|cb
operator|->
name|remote_rkey
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|rdma
operator|.
name|remote_addr
operator|=
name|cb
operator|->
name|remote_addr
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|sg_list
operator|->
name|length
operator|=
name|cb
operator|->
name|size
expr_stmt|;
if|if
condition|(
name|cycle_iters
operator|>
name|iters
condition|)
name|cycle_iters
operator|=
name|iters
expr_stmt|;
name|microtime
argument_list|(
operator|&
name|start_tv
argument_list|)
expr_stmt|;
while|while
condition|(
name|scnt
operator|<
name|iters
operator|||
name|ccnt
operator|<
name|iters
operator|||
name|rcnt
operator|<
name|iters
condition|)
block|{
comment|/* Wait till buffer changes. */
if|if
condition|(
name|rcnt
operator|<
name|iters
operator|&&
operator|!
operator|(
name|scnt
operator|<
literal|1
operator|&&
operator|!
name|cb
operator|->
name|server
operator|)
condition|)
block|{
operator|++
name|rcnt
expr_stmt|;
while|while
condition|(
operator|*
name|poll_buf
operator|!=
operator|(
name|char
operator|)
name|rcnt
condition|)
block|{
if|if
condition|(
name|cb
operator|->
name|state
operator|==
name|ERROR
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"state = ERROR, bailing\n"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
if|if
condition|(
name|scnt
operator|<
name|iters
condition|)
block|{
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
operator|*
name|buf
operator|=
operator|(
name|char
operator|)
name|scnt
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|scnt
operator|<
name|cycle_iters
condition|)
name|post_cycles_start
index|[
name|scnt
index|]
operator|=
name|get_cycles
argument_list|()
expr_stmt|;
if|if
condition|(
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|rdma_sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Couldn't post send: scnt=%d\n"
argument_list|,
name|scnt
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|scnt
operator|<
name|cycle_iters
condition|)
name|post_cycles_stop
index|[
name|scnt
index|]
operator|=
name|get_cycles
argument_list|()
expr_stmt|;
name|scnt
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|ccnt
operator|<
name|iters
condition|)
block|{
name|struct
name|ib_wc
name|wc
decl_stmt|;
name|int
name|ne
decl_stmt|;
if|if
condition|(
name|ccnt
operator|<
name|cycle_iters
condition|)
name|poll_cycles_start
index|[
name|ccnt
index|]
operator|=
name|get_cycles
argument_list|()
expr_stmt|;
do|do
block|{
if|if
condition|(
name|ccnt
operator|<
name|cycle_iters
condition|)
name|last_poll_cycles_start
index|[
name|ccnt
index|]
operator|=
name|get_cycles
argument_list|()
expr_stmt|;
name|ne
operator|=
name|ib_poll_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
literal|1
argument_list|,
operator|&
name|wc
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|ne
operator|==
literal|0
condition|)
do|;
if|if
condition|(
name|ccnt
operator|<
name|cycle_iters
condition|)
name|poll_cycles_stop
index|[
name|ccnt
index|]
operator|=
name|get_cycles
argument_list|()
expr_stmt|;
operator|++
name|ccnt
expr_stmt|;
if|if
condition|(
name|ne
operator|<
literal|0
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"poll CQ failed %d\n"
argument_list|,
name|ne
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wc
operator|.
name|status
operator|!=
name|IB_WC_SUCCESS
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Completion wth error at %s:\n"
argument_list|,
name|cb
operator|->
name|server
condition|?
literal|"server"
else|:
literal|"client"
argument_list|)
expr_stmt|;
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Failed status %d: wr_id %d\n"
argument_list|,
name|wc
operator|.
name|status
argument_list|,
operator|(
name|int
operator|)
name|wc
operator|.
name|wr_id
argument_list|)
expr_stmt|;
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"scnt=%d, rcnt=%d, ccnt=%d\n"
argument_list|,
name|scnt
argument_list|,
name|rcnt
argument_list|,
name|ccnt
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
name|microtime
argument_list|(
operator|&
name|stop_tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|stop_tv
operator|.
name|tv_usec
operator|<
name|start_tv
operator|.
name|tv_usec
condition|)
block|{
name|stop_tv
operator|.
name|tv_usec
operator|+=
literal|1000000
expr_stmt|;
name|stop_tv
operator|.
name|tv_sec
operator|-=
literal|1
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cycle_iters
condition|;
name|i
operator|++
control|)
block|{
name|sum_post
operator|+=
name|post_cycles_stop
index|[
name|i
index|]
operator|-
name|post_cycles_start
index|[
name|i
index|]
expr_stmt|;
name|sum_poll
operator|+=
name|poll_cycles_stop
index|[
name|i
index|]
operator|-
name|poll_cycles_start
index|[
name|i
index|]
expr_stmt|;
name|sum_last_poll
operator|+=
name|poll_cycles_stop
index|[
name|i
index|]
operator|-
name|last_poll_cycles_start
index|[
name|i
index|]
expr_stmt|;
block|}
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"delta sec %lu delta usec %lu iter %d size %d cycle_iters %d sum_post %llu sum_poll %llu sum_last_poll %llu\n"
argument_list|,
name|stop_tv
operator|.
name|tv_sec
operator|-
name|start_tv
operator|.
name|tv_sec
argument_list|,
name|stop_tv
operator|.
name|tv_usec
operator|-
name|start_tv
operator|.
name|tv_usec
argument_list|,
name|scnt
argument_list|,
name|cb
operator|->
name|size
argument_list|,
name|cycle_iters
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|sum_post
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|sum_poll
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|sum_last_poll
argument_list|)
expr_stmt|;
name|free_cycle_mem
argument_list|(
name|post_cycles_start
argument_list|,
name|post_cycles_stop
argument_list|,
name|poll_cycles_start
argument_list|,
name|poll_cycles_stop
argument_list|,
name|last_poll_cycles_start
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|bw_test
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|int
name|ccnt
decl_stmt|,
name|scnt
decl_stmt|,
name|rcnt
decl_stmt|;
name|int
name|iters
init|=
name|cb
operator|->
name|count
decl_stmt|;
name|ccnt
operator|=
literal|0
expr_stmt|;
name|scnt
operator|=
literal|0
expr_stmt|;
name|rcnt
operator|=
literal|0
expr_stmt|;
name|struct
name|timeval
name|start_tv
decl_stmt|,
name|stop_tv
decl_stmt|;
name|cycles_t
modifier|*
name|post_cycles_start
decl_stmt|,
modifier|*
name|post_cycles_stop
decl_stmt|;
name|cycles_t
modifier|*
name|poll_cycles_start
decl_stmt|,
modifier|*
name|poll_cycles_stop
decl_stmt|;
name|cycles_t
modifier|*
name|last_poll_cycles_start
decl_stmt|;
name|cycles_t
name|sum_poll
init|=
literal|0
decl_stmt|,
name|sum_post
init|=
literal|0
decl_stmt|,
name|sum_last_poll
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|cycle_iters
init|=
literal|1000
decl_stmt|;
name|int
name|err
decl_stmt|;
name|err
operator|=
name|alloc_cycle_mem
argument_list|(
name|cycle_iters
argument_list|,
operator|&
name|post_cycles_start
argument_list|,
operator|&
name|post_cycles_stop
argument_list|,
operator|&
name|poll_cycles_start
argument_list|,
operator|&
name|poll_cycles_stop
argument_list|,
operator|&
name|last_poll_cycles_start
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"%s kmalloc failed\n"
argument_list|,
name|__FUNCTION__
argument_list|)
expr_stmt|;
return|return;
block|}
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|opcode
operator|=
name|IB_WR_RDMA_WRITE
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|rdma
operator|.
name|rkey
operator|=
name|cb
operator|->
name|remote_rkey
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|wr
operator|.
name|rdma
operator|.
name|remote_addr
operator|=
name|cb
operator|->
name|remote_addr
expr_stmt|;
name|cb
operator|->
name|rdma_sq_wr
operator|.
name|sg_list
operator|->
name|length
operator|=
name|cb
operator|->
name|size
expr_stmt|;
if|if
condition|(
name|cycle_iters
operator|>
name|iters
condition|)
name|cycle_iters
operator|=
name|iters
expr_stmt|;
name|microtime
argument_list|(
operator|&
name|start_tv
argument_list|)
expr_stmt|;
while|while
condition|(
name|scnt
operator|<
name|iters
operator|||
name|ccnt
operator|<
name|iters
condition|)
block|{
while|while
condition|(
name|scnt
operator|<
name|iters
operator|&&
name|scnt
operator|-
name|ccnt
operator|<
name|cb
operator|->
name|txdepth
condition|)
block|{
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
if|if
condition|(
name|scnt
operator|<
name|cycle_iters
condition|)
name|post_cycles_start
index|[
name|scnt
index|]
operator|=
name|get_cycles
argument_list|()
expr_stmt|;
if|if
condition|(
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|rdma_sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Couldn't post send: scnt=%d\n"
argument_list|,
name|scnt
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|scnt
operator|<
name|cycle_iters
condition|)
name|post_cycles_stop
index|[
name|scnt
index|]
operator|=
name|get_cycles
argument_list|()
expr_stmt|;
operator|++
name|scnt
expr_stmt|;
block|}
if|if
condition|(
name|ccnt
operator|<
name|iters
condition|)
block|{
name|int
name|ne
decl_stmt|;
name|struct
name|ib_wc
name|wc
decl_stmt|;
if|if
condition|(
name|ccnt
operator|<
name|cycle_iters
condition|)
name|poll_cycles_start
index|[
name|ccnt
index|]
operator|=
name|get_cycles
argument_list|()
expr_stmt|;
do|do
block|{
if|if
condition|(
name|ccnt
operator|<
name|cycle_iters
condition|)
name|last_poll_cycles_start
index|[
name|ccnt
index|]
operator|=
name|get_cycles
argument_list|()
expr_stmt|;
name|ne
operator|=
name|ib_poll_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
literal|1
argument_list|,
operator|&
name|wc
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|ne
operator|==
literal|0
condition|)
do|;
if|if
condition|(
name|ccnt
operator|<
name|cycle_iters
condition|)
name|poll_cycles_stop
index|[
name|ccnt
index|]
operator|=
name|get_cycles
argument_list|()
expr_stmt|;
name|ccnt
operator|+=
literal|1
expr_stmt|;
if|if
condition|(
name|ne
operator|<
literal|0
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"poll CQ failed %d\n"
argument_list|,
name|ne
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wc
operator|.
name|status
operator|!=
name|IB_WC_SUCCESS
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Completion wth error at %s:\n"
argument_list|,
name|cb
operator|->
name|server
condition|?
literal|"server"
else|:
literal|"client"
argument_list|)
expr_stmt|;
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Failed status %d: wr_id %d\n"
argument_list|,
name|wc
operator|.
name|status
argument_list|,
operator|(
name|int
operator|)
name|wc
operator|.
name|wr_id
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
name|microtime
argument_list|(
operator|&
name|stop_tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|stop_tv
operator|.
name|tv_usec
operator|<
name|start_tv
operator|.
name|tv_usec
condition|)
block|{
name|stop_tv
operator|.
name|tv_usec
operator|+=
literal|1000000
expr_stmt|;
name|stop_tv
operator|.
name|tv_sec
operator|-=
literal|1
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cycle_iters
condition|;
name|i
operator|++
control|)
block|{
name|sum_post
operator|+=
name|post_cycles_stop
index|[
name|i
index|]
operator|-
name|post_cycles_start
index|[
name|i
index|]
expr_stmt|;
name|sum_poll
operator|+=
name|poll_cycles_stop
index|[
name|i
index|]
operator|-
name|poll_cycles_start
index|[
name|i
index|]
expr_stmt|;
name|sum_last_poll
operator|+=
name|poll_cycles_stop
index|[
name|i
index|]
operator|-
name|last_poll_cycles_start
index|[
name|i
index|]
expr_stmt|;
block|}
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"delta sec %lu delta usec %lu iter %d size %d cycle_iters %d sum_post %llu sum_poll %llu sum_last_poll %llu\n"
argument_list|,
name|stop_tv
operator|.
name|tv_sec
operator|-
name|start_tv
operator|.
name|tv_sec
argument_list|,
name|stop_tv
operator|.
name|tv_usec
operator|-
name|start_tv
operator|.
name|tv_usec
argument_list|,
name|scnt
argument_list|,
name|cb
operator|->
name|size
argument_list|,
name|cycle_iters
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|sum_post
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|sum_poll
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|sum_last_poll
argument_list|)
expr_stmt|;
name|free_cycle_mem
argument_list|(
name|post_cycles_start
argument_list|,
name|post_cycles_stop
argument_list|,
name|poll_cycles_start
argument_list|,
name|poll_cycles_stop
argument_list|,
name|last_poll_cycles_start
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_rlat_test_server
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
name|struct
name|ib_wc
name|wc
decl_stmt|;
name|int
name|ret
decl_stmt|;
comment|/* Spin waiting for client's Start STAG/TO/Len */
while|while
condition|(
name|cb
operator|->
name|state
operator|<
name|RDMA_READ_ADV
condition|)
block|{
name|krping_cq_event_handler
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
name|cb
argument_list|)
expr_stmt|;
block|}
comment|/* Send STAG/TO/Len to client */
if|if
condition|(
name|cb
operator|->
name|dma_mr
condition|)
name|krping_format_send
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|start_addr
argument_list|,
name|cb
operator|->
name|dma_mr
argument_list|)
expr_stmt|;
else|else
name|krping_format_send
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|start_addr
argument_list|,
name|cb
operator|->
name|start_mr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"post send error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Spin waiting for send completion */
while|while
condition|(
operator|(
name|ret
operator|=
name|ib_poll_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
literal|1
argument_list|,
operator|&
name|wc
argument_list|)
operator|==
literal|0
operator|)
condition|)
empty_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"poll error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wc
operator|.
name|status
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"send completiong error %d\n"
argument_list|,
name|wc
operator|.
name|status
argument_list|)
expr_stmt|;
return|return;
block|}
name|krping_wait
argument_list|(
name|cb
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_wlat_test_server
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
name|struct
name|ib_wc
name|wc
decl_stmt|;
name|int
name|ret
decl_stmt|;
comment|/* Spin waiting for client's Start STAG/TO/Len */
while|while
condition|(
name|cb
operator|->
name|state
operator|<
name|RDMA_READ_ADV
condition|)
block|{
name|krping_cq_event_handler
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
name|cb
argument_list|)
expr_stmt|;
block|}
comment|/* Send STAG/TO/Len to client */
if|if
condition|(
name|cb
operator|->
name|dma_mr
condition|)
name|krping_format_send
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|start_addr
argument_list|,
name|cb
operator|->
name|dma_mr
argument_list|)
expr_stmt|;
else|else
name|krping_format_send
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|start_addr
argument_list|,
name|cb
operator|->
name|start_mr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"post send error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Spin waiting for send completion */
while|while
condition|(
operator|(
name|ret
operator|=
name|ib_poll_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
literal|1
argument_list|,
operator|&
name|wc
argument_list|)
operator|==
literal|0
operator|)
condition|)
empty_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"poll error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wc
operator|.
name|status
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"send completiong error %d\n"
argument_list|,
name|wc
operator|.
name|status
argument_list|)
expr_stmt|;
return|return;
block|}
name|wlat_test
argument_list|(
name|cb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_bw_test_server
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
name|struct
name|ib_wc
name|wc
decl_stmt|;
name|int
name|ret
decl_stmt|;
comment|/* Spin waiting for client's Start STAG/TO/Len */
while|while
condition|(
name|cb
operator|->
name|state
operator|<
name|RDMA_READ_ADV
condition|)
block|{
name|krping_cq_event_handler
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
name|cb
argument_list|)
expr_stmt|;
block|}
comment|/* Send STAG/TO/Len to client */
if|if
condition|(
name|cb
operator|->
name|dma_mr
condition|)
name|krping_format_send
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|start_addr
argument_list|,
name|cb
operator|->
name|dma_mr
argument_list|)
expr_stmt|;
else|else
name|krping_format_send
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|start_addr
argument_list|,
name|cb
operator|->
name|start_mr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"post send error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Spin waiting for send completion */
while|while
condition|(
operator|(
name|ret
operator|=
name|ib_poll_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
literal|1
argument_list|,
operator|&
name|wc
argument_list|)
operator|==
literal|0
operator|)
condition|)
empty_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"poll error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wc
operator|.
name|status
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"send completiong error %d\n"
argument_list|,
name|wc
operator|.
name|status
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|cb
operator|->
name|duplex
condition|)
name|bw_test
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|krping_wait
argument_list|(
name|cb
argument_list|,
name|ERROR
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|krping_bind_server
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|sockaddr_in
name|sin
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|memset
argument_list|(
operator|&
name|sin
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sin
argument_list|)
argument_list|)
expr_stmt|;
name|sin
operator|.
name|sin_len
operator|=
sizeof|sizeof
name|sin
expr_stmt|;
name|sin
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|sin
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|cb
operator|->
name|addr
operator|.
name|s_addr
expr_stmt|;
name|sin
operator|.
name|sin_port
operator|=
name|cb
operator|->
name|port
expr_stmt|;
name|ret
operator|=
name|rdma_bind_addr
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sin
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"rdma_bind_addr error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"rdma_bind_addr successful\n"
argument_list|)
expr_stmt|;
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"rdma_listen\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|rdma_listen
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"rdma_listen failed: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|krping_wait
argument_list|(
name|cb
argument_list|,
name|CONNECT_REQUEST
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|!=
name|CONNECT_REQUEST
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"wait for CONNECT_REQUEST state %d\n"
argument_list|,
name|cb
operator|->
name|state
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_run_server
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ib_recv_wr
modifier|*
name|bad_wr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|krping_bind_server
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return;
name|ret
operator|=
name|krping_setup_qp
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|child_cm_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"setup_qp failed: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return;
block|}
name|ret
operator|=
name|krping_setup_buffers
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"krping_setup_buffers failed: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
name|ret
operator|=
name|ib_post_recv
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|rq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"ib_post_recv failed: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
name|ret
operator|=
name|krping_accept
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"connect error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
if|if
condition|(
name|cb
operator|->
name|wlat
condition|)
name|krping_wlat_test_server
argument_list|(
name|cb
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cb
operator|->
name|rlat
condition|)
name|krping_rlat_test_server
argument_list|(
name|cb
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cb
operator|->
name|bw
condition|)
name|krping_bw_test_server
argument_list|(
name|cb
argument_list|)
expr_stmt|;
else|else
name|krping_test_server
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|rdma_disconnect
argument_list|(
name|cb
operator|->
name|child_cm_id
argument_list|)
expr_stmt|;
name|rdma_destroy_id
argument_list|(
name|cb
operator|->
name|child_cm_id
argument_list|)
expr_stmt|;
name|err2
label|:
name|krping_free_buffers
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|err1
label|:
name|krping_free_qp
argument_list|(
name|cb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_test_client
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|int
name|ping
decl_stmt|,
name|start
decl_stmt|,
name|cc
decl_stmt|,
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
name|unsigned
name|char
name|c
decl_stmt|;
name|start
operator|=
literal|65
expr_stmt|;
for|for
control|(
name|ping
operator|=
literal|0
init|;
operator|!
name|cb
operator|->
name|count
operator|||
name|ping
operator|<
name|cb
operator|->
name|count
condition|;
name|ping
operator|++
control|)
block|{
name|cb
operator|->
name|state
operator|=
name|RDMA_READ_ADV
expr_stmt|;
comment|/* Put some ascii text in the buffer. */
name|cc
operator|=
name|sprintf
argument_list|(
name|cb
operator|->
name|start_buf
argument_list|,
literal|"rdma-ping-%d: "
argument_list|,
name|ping
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|cc
operator|,
name|c
operator|=
name|start
init|;
name|i
operator|<
name|cb
operator|->
name|size
condition|;
name|i
operator|++
control|)
block|{
name|cb
operator|->
name|start_buf
index|[
name|i
index|]
operator|=
name|c
expr_stmt|;
name|c
operator|++
expr_stmt|;
if|if
condition|(
name|c
operator|>
literal|122
condition|)
name|c
operator|=
literal|65
expr_stmt|;
block|}
name|start
operator|++
expr_stmt|;
if|if
condition|(
name|start
operator|>
literal|122
condition|)
name|start
operator|=
literal|65
expr_stmt|;
name|cb
operator|->
name|start_buf
index|[
name|cb
operator|->
name|size
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|dma_mr
condition|)
name|krping_format_send
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|start_addr
argument_list|,
name|cb
operator|->
name|dma_mr
argument_list|)
expr_stmt|;
else|else
name|krping_format_send
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|start_addr
argument_list|,
name|cb
operator|->
name|start_mr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"post send error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Wait for server to ACK */
name|krping_wait
argument_list|(
name|cb
argument_list|,
name|RDMA_WRITE_ADV
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|!=
name|RDMA_WRITE_ADV
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"wait for RDMA_WRITE_ADV state %d\n"
argument_list|,
name|cb
operator|->
name|state
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|cb
operator|->
name|dma_mr
condition|)
name|krping_format_send
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|rdma_addr
argument_list|,
name|cb
operator|->
name|dma_mr
argument_list|)
expr_stmt|;
else|else
name|krping_format_send
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|rdma_addr
argument_list|,
name|cb
operator|->
name|rdma_mr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"post send error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Wait for the server to say the RDMA Write is complete. */
name|krping_wait
argument_list|(
name|cb
argument_list|,
name|RDMA_WRITE_COMPLETE
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|!=
name|RDMA_WRITE_COMPLETE
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"wait for RDMA_WRITE_COMPLETE state %d\n"
argument_list|,
name|cb
operator|->
name|state
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|cb
operator|->
name|validate
condition|)
if|if
condition|(
name|memcmp
argument_list|(
name|cb
operator|->
name|start_buf
argument_list|,
name|cb
operator|->
name|rdma_buf
argument_list|,
name|cb
operator|->
name|size
argument_list|)
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"data mismatch!\n"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|cb
operator|->
name|verbose
condition|)
name|DEBUG_LOG
argument_list|(
literal|"ping data: %s\n"
argument_list|,
name|cb
operator|->
name|rdma_buf
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|krping_rlat_test_client
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
name|struct
name|ib_wc
name|wc
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|cb
operator|->
name|state
operator|=
name|RDMA_READ_ADV
expr_stmt|;
comment|/* Send STAG/TO/Len to client */
if|if
condition|(
name|cb
operator|->
name|dma_mr
condition|)
name|krping_format_send
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|start_addr
argument_list|,
name|cb
operator|->
name|dma_mr
argument_list|)
expr_stmt|;
else|else
name|krping_format_send
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|start_addr
argument_list|,
name|cb
operator|->
name|rdma_mr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"post send error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Spin waiting for send completion */
while|while
condition|(
operator|(
name|ret
operator|=
name|ib_poll_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
literal|1
argument_list|,
operator|&
name|wc
argument_list|)
operator|==
literal|0
operator|)
condition|)
empty_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"poll error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wc
operator|.
name|status
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"send completion error %d\n"
argument_list|,
name|wc
operator|.
name|status
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Spin waiting for server's Start STAG/TO/Len */
while|while
condition|(
name|cb
operator|->
name|state
operator|<
name|RDMA_WRITE_ADV
condition|)
block|{
name|krping_cq_event_handler
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
name|cb
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
literal|0
block|{ 	int i; 	struct timeval start, stop; 	time_t sec; 	suseconds_t usec; 	unsigned long long elapsed; 	struct ib_wc wc; 	struct ib_send_wr *bad_wr; 	int ne; 	 	cb->rdma_sq_wr.opcode = IB_WR_RDMA_WRITE; 	cb->rdma_sq_wr.wr.rdma.rkey = cb->remote_rkey; 	cb->rdma_sq_wr.wr.rdma.remote_addr = cb->remote_addr; 	cb->rdma_sq_wr.sg_list->length = 0; 	cb->rdma_sq_wr.num_sge = 0;  	microtime(&start); 	for (i=0; i< 100000; i++) { 		if (ib_post_send(cb->qp,&cb->rdma_sq_wr,&bad_wr)) { 			log(LOG_ERR,  "Couldn't post send\n"); 			return; 		} 		do { 			ne = ib_poll_cq(cb->cq, 1,&wc); 		} while (ne == 0); 		if (ne< 0) { 			log(LOG_ERR, "poll CQ failed %d\n", ne); 			return; 		} 		if (wc.status != IB_WC_SUCCESS) { 			log(LOG_ERR, "Completion wth error at %s:\n", 				cb->server ? "server" : "client"); 			log(LOG_ERR, "Failed status %d: wr_id %d\n", 				wc.status, (int) wc.wr_id); 			return; 		} 	} 	microtime(&stop); 	 	if (stop.tv_usec< start.tv_usec) { 		stop.tv_usec += 1000000; 		stop.tv_sec  -= 1; 	} 	sec     = stop.tv_sec - start.tv_sec; 	usec    = stop.tv_usec - start.tv_usec; 	elapsed = sec * 1000000 + usec; 	log(LOG_ERR, "0B-write-lat iters 100000 usec %llu\n", elapsed); }
endif|#
directive|endif
name|rlat_test
argument_list|(
name|cb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_wlat_test_client
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
name|struct
name|ib_wc
name|wc
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|cb
operator|->
name|state
operator|=
name|RDMA_READ_ADV
expr_stmt|;
comment|/* Send STAG/TO/Len to client */
if|if
condition|(
name|cb
operator|->
name|dma_mr
condition|)
name|krping_format_send
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|start_addr
argument_list|,
name|cb
operator|->
name|dma_mr
argument_list|)
expr_stmt|;
else|else
name|krping_format_send
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|start_addr
argument_list|,
name|cb
operator|->
name|start_mr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"post send error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Spin waiting for send completion */
while|while
condition|(
operator|(
name|ret
operator|=
name|ib_poll_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
literal|1
argument_list|,
operator|&
name|wc
argument_list|)
operator|==
literal|0
operator|)
condition|)
empty_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"poll error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wc
operator|.
name|status
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"send completion error %d\n"
argument_list|,
name|wc
operator|.
name|status
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Spin waiting for server's Start STAG/TO/Len */
while|while
condition|(
name|cb
operator|->
name|state
operator|<
name|RDMA_WRITE_ADV
condition|)
block|{
name|krping_cq_event_handler
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
name|cb
argument_list|)
expr_stmt|;
block|}
name|wlat_test
argument_list|(
name|cb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_bw_test_client
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ib_send_wr
modifier|*
name|bad_wr
decl_stmt|;
name|struct
name|ib_wc
name|wc
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|cb
operator|->
name|state
operator|=
name|RDMA_READ_ADV
expr_stmt|;
comment|/* Send STAG/TO/Len to client */
if|if
condition|(
name|cb
operator|->
name|dma_mr
condition|)
name|krping_format_send
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|start_addr
argument_list|,
name|cb
operator|->
name|dma_mr
argument_list|)
expr_stmt|;
else|else
name|krping_format_send
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|start_addr
argument_list|,
name|cb
operator|->
name|start_mr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ib_post_send
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|sq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"post send error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Spin waiting for send completion */
while|while
condition|(
operator|(
name|ret
operator|=
name|ib_poll_cq
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
literal|1
argument_list|,
operator|&
name|wc
argument_list|)
operator|==
literal|0
operator|)
condition|)
empty_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"poll error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wc
operator|.
name|status
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"send completion error %d\n"
argument_list|,
name|wc
operator|.
name|status
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Spin waiting for server's Start STAG/TO/Len */
while|while
condition|(
name|cb
operator|->
name|state
operator|<
name|RDMA_WRITE_ADV
condition|)
block|{
name|krping_cq_event_handler
argument_list|(
name|cb
operator|->
name|cq
argument_list|,
name|cb
argument_list|)
expr_stmt|;
block|}
name|bw_test
argument_list|(
name|cb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|krping_connect_client
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|rdma_conn_param
name|conn_param
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|memset
argument_list|(
operator|&
name|conn_param
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
name|conn_param
argument_list|)
expr_stmt|;
name|conn_param
operator|.
name|responder_resources
operator|=
literal|1
expr_stmt|;
name|conn_param
operator|.
name|initiator_depth
operator|=
literal|1
expr_stmt|;
name|conn_param
operator|.
name|retry_count
operator|=
literal|10
expr_stmt|;
name|ret
operator|=
name|rdma_connect
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|,
operator|&
name|conn_param
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"rdma_connect error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|krping_wait
argument_list|(
name|cb
argument_list|,
name|CONNECTED
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|==
name|ERROR
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"wait for CONNECTED state %d\n"
argument_list|,
name|cb
operator|->
name|state
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"rdma_connect successful\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|krping_bind_client
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|sockaddr_in
name|sin
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|memset
argument_list|(
operator|&
name|sin
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sin
argument_list|)
argument_list|)
expr_stmt|;
name|sin
operator|.
name|sin_len
operator|=
sizeof|sizeof
name|sin
expr_stmt|;
name|sin
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|sin
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|cb
operator|->
name|addr
operator|.
name|s_addr
expr_stmt|;
name|sin
operator|.
name|sin_port
operator|=
name|cb
operator|->
name|port
expr_stmt|;
name|ret
operator|=
name|rdma_resolve_addr
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|,
name|NULL
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sin
argument_list|,
literal|2000
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"rdma_resolve_addr error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|krping_wait
argument_list|(
name|cb
argument_list|,
name|ROUTE_RESOLVED
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|state
operator|!=
name|ROUTE_RESOLVED
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"addr/route resolution did not resolve: state %d\n"
argument_list|,
name|cb
operator|->
name|state
argument_list|)
expr_stmt|;
return|return
name|EINTR
return|;
block|}
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"rdma_resolve_addr - rdma_resolve_route successful\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|krping_run_client
parameter_list|(
name|struct
name|krping_cb
modifier|*
name|cb
parameter_list|)
block|{
name|struct
name|ib_recv_wr
modifier|*
name|bad_wr
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|krping_bind_client
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return;
name|ret
operator|=
name|krping_setup_qp
argument_list|(
name|cb
argument_list|,
name|cb
operator|->
name|cm_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"setup_qp failed: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return;
block|}
name|ret
operator|=
name|krping_setup_buffers
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"krping_setup_buffers failed: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|err1
goto|;
block|}
name|ret
operator|=
name|ib_post_recv
argument_list|(
name|cb
operator|->
name|qp
argument_list|,
operator|&
name|cb
operator|->
name|rq_wr
argument_list|,
operator|&
name|bad_wr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"ib_post_recv failed: %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
name|ret
operator|=
name|krping_connect_client
argument_list|(
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"connect error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|err2
goto|;
block|}
if|if
condition|(
name|cb
operator|->
name|wlat
condition|)
name|krping_wlat_test_client
argument_list|(
name|cb
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cb
operator|->
name|rlat
condition|)
name|krping_rlat_test_client
argument_list|(
name|cb
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|cb
operator|->
name|bw
condition|)
name|krping_bw_test_client
argument_list|(
name|cb
argument_list|)
expr_stmt|;
else|else
name|krping_test_client
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|rdma_disconnect
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|)
expr_stmt|;
name|err2
label|:
name|krping_free_buffers
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|err1
label|:
name|krping_free_qp
argument_list|(
name|cb
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|krping_doit
parameter_list|(
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|struct
name|krping_cb
modifier|*
name|cb
decl_stmt|;
name|int
name|op
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|optarg
decl_stmt|;
name|unsigned
name|long
name|optint
decl_stmt|;
name|debug
operator|=
literal|0
expr_stmt|;
name|cb
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|cb
argument_list|)
argument_list|,
name|M_DEVBUF
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cb
condition|)
return|return
name|ENOMEM
return|;
name|bzero
argument_list|(
name|cb
argument_list|,
sizeof|sizeof
expr|*
name|cb
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|krping_mutex
argument_list|)
expr_stmt|;
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|krping_cbs
argument_list|,
name|cb
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|krping_mutex
argument_list|)
expr_stmt|;
name|cb
operator|->
name|server
operator|=
operator|-
literal|1
expr_stmt|;
name|cb
operator|->
name|state
operator|=
name|IDLE
expr_stmt|;
name|cb
operator|->
name|size
operator|=
literal|64
expr_stmt|;
name|cb
operator|->
name|txdepth
operator|=
name|RPING_SQ_DEPTH
expr_stmt|;
name|mtx_init
argument_list|(
operator|&
name|cb
operator|->
name|lock
argument_list|,
literal|"krping mtx"
argument_list|,
name|NULL
argument_list|,
name|MTX_DUPOK
operator||
name|MTX_DEF
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|op
operator|=
name|krping_getopt
argument_list|(
literal|"krping"
argument_list|,
operator|&
name|cmd
argument_list|,
name|krping_opts
argument_list|,
name|NULL
argument_list|,
operator|&
name|optarg
argument_list|,
operator|&
name|optint
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
switch|switch
condition|(
name|op
condition|)
block|{
case|case
literal|'a'
case|:
name|cb
operator|->
name|addr_str
operator|=
name|optarg
expr_stmt|;
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"ipaddr (%s)\n"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|inet_aton
argument_list|(
name|optarg
argument_list|,
operator|&
name|cb
operator|->
name|addr
argument_list|)
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"bad addr string %s\n"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EINVAL
expr_stmt|;
block|}
break|break;
case|case
literal|'D'
case|:
name|cb
operator|->
name|use_dmamr
operator|=
literal|1
expr_stmt|;
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"using dma mr\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|cb
operator|->
name|port
operator|=
name|htons
argument_list|(
name|optint
argument_list|)
expr_stmt|;
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"port %d\n"
argument_list|,
operator|(
name|int
operator|)
name|optint
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
name|cb
operator|->
name|poll
operator|=
literal|1
expr_stmt|;
name|DEBUG_LOG
argument_list|(
literal|"server\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|cb
operator|->
name|server
operator|=
literal|1
expr_stmt|;
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"server\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|cb
operator|->
name|server
operator|=
literal|0
expr_stmt|;
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"client\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
name|cb
operator|->
name|size
operator|=
name|optint
expr_stmt|;
if|if
condition|(
operator|(
name|cb
operator|->
name|size
operator|<
literal|1
operator|)
operator|||
operator|(
name|cb
operator|->
name|size
operator|>
name|RPING_BUFSIZE
operator|)
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Invalid size %d "
literal|"(valid range is 1 to %d)\n"
argument_list|,
name|cb
operator|->
name|size
argument_list|,
name|RPING_BUFSIZE
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EINVAL
expr_stmt|;
block|}
else|else
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"size %d\n"
argument_list|,
operator|(
name|int
operator|)
name|optint
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
name|cb
operator|->
name|count
operator|=
name|optint
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|count
operator|<
literal|0
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Invalid count %d\n"
argument_list|,
name|cb
operator|->
name|count
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EINVAL
expr_stmt|;
block|}
else|else
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"count %d\n"
argument_list|,
operator|(
name|int
operator|)
name|cb
operator|->
name|count
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|cb
operator|->
name|verbose
operator|++
expr_stmt|;
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"verbose\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'V'
case|:
name|cb
operator|->
name|validate
operator|++
expr_stmt|;
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"validate data\n"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'L'
case|:
name|cb
operator|->
name|rlat
operator|++
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|cb
operator|->
name|wlat
operator|++
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
name|cb
operator|->
name|bw
operator|++
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|cb
operator|->
name|txdepth
operator|=
name|optint
expr_stmt|;
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"txdepth %d\n"
argument_list|,
name|cb
operator|->
name|txdepth
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|debug
operator|++
expr_stmt|;
break|break;
default|default:
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"unknown opt %s\n"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|ret
condition|)
goto|goto
name|out
goto|;
if|if
condition|(
name|cb
operator|->
name|server
operator|==
operator|-
literal|1
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"must be either client or server\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|(
name|cb
operator|->
name|bw
operator|+
name|cb
operator|->
name|rlat
operator|+
name|cb
operator|->
name|wlat
operator|)
operator|>
literal|1
condition|)
block|{
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"Pick only one test: bw, rlat, wlat\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|EINVAL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|cb
operator|->
name|cm_id
operator|=
name|rdma_create_id
argument_list|(
name|krping_cma_event_handler
argument_list|,
name|cb
argument_list|,
name|RDMA_PS_TCP
argument_list|)
expr_stmt|;
if|if
condition|(
name|IS_ERR
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|)
condition|)
block|{
name|ret
operator|=
name|PTR_ERR
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|)
expr_stmt|;
name|log
argument_list|(
name|LOG_ERR
argument_list|,
literal|"rdma_create_id error %d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"created cm_id %p\n"
argument_list|,
name|cb
operator|->
name|cm_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|cb
operator|->
name|server
condition|)
name|krping_run_server
argument_list|(
name|cb
argument_list|)
expr_stmt|;
else|else
name|krping_run_client
argument_list|(
name|cb
argument_list|)
expr_stmt|;
name|DEBUG_LOG
argument_list|(
name|PFX
literal|"destroy cm_id %p\n"
argument_list|,
name|cb
operator|->
name|cm_id
argument_list|)
expr_stmt|;
name|rdma_destroy_id
argument_list|(
name|cb
operator|->
name|cm_id
argument_list|)
expr_stmt|;
name|out
label|:
name|mtx_lock
argument_list|(
operator|&
name|krping_mutex
argument_list|)
expr_stmt|;
name|TAILQ_REMOVE
argument_list|(
operator|&
name|krping_cbs
argument_list|,
name|cb
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|krping_mutex
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cb
argument_list|,
name|M_DEVBUF
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|krping_init
parameter_list|(
name|void
parameter_list|)
block|{
name|mtx_init
argument_list|(
operator|&
name|krping_mutex
argument_list|,
literal|"krping lock"
argument_list|,
name|NULL
argument_list|,
name|MTX_DEF
argument_list|)
expr_stmt|;
name|TAILQ_INIT
argument_list|(
operator|&
name|krping_cbs
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1994-1995 SÃ¸ren Schmidt  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer  *    in this position and unchanged.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"opt_compat.h"
end_include

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysproto.h>
end_include

begin_include
include|#
directive|include
file|<sys/capsicum.h>
end_include

begin_include
include|#
directive|include
file|<sys/cdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/dvdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/disk.h>
end_include

begin_include
include|#
directive|include
file|<sys/consio.h>
end_include

begin_include
include|#
directive|include
file|<sys/ctype.h>
end_include

begin_include
include|#
directive|include
file|<sys/fcntl.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/filedesc.h>
end_include

begin_include
include|#
directive|include
file|<sys/filio.h>
end_include

begin_include
include|#
directive|include
file|<sys/jail.h>
end_include

begin_include
include|#
directive|include
file|<sys/kbio.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_include
include|#
directive|include
file|<sys/linker_set.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/sbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_include
include|#
directive|include
file|<sys/soundcard.h>
end_include

begin_include
include|#
directive|include
file|<sys/stdint.h>
end_include

begin_include
include|#
directive|include
file|<sys/sx.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysctl.h>
end_include

begin_include
include|#
directive|include
file|<sys/tty.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/mman.h>
end_include

begin_include
include|#
directive|include
file|<sys/resourcevar.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<net/if_var.h>
end_include

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_types.h>
end_include

begin_include
include|#
directive|include
file|<net/vnet.h>
end_include

begin_include
include|#
directive|include
file|<dev/usb/usb_ioctl.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|COMPAT_LINUX32
end_ifdef

begin_include
include|#
directive|include
file|<machine/../linux32/linux.h>
end_include

begin_include
include|#
directive|include
file|<machine/../linux32/linux32_proto.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<machine/../linux/linux.h>
end_include

begin_include
include|#
directive|include
file|<machine/../linux/linux_proto.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<compat/linux/linux_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<compat/linux/linux_mib.h>
end_include

begin_include
include|#
directive|include
file|<compat/linux/linux_socket.h>
end_include

begin_include
include|#
directive|include
file|<compat/linux/linux_util.h>
end_include

begin_include
include|#
directive|include
file|<contrib/v4l/videodev.h>
end_include

begin_include
include|#
directive|include
file|<compat/linux/linux_videodev_compat.h>
end_include

begin_include
include|#
directive|include
file|<contrib/v4l/videodev2.h>
end_include

begin_include
include|#
directive|include
file|<compat/linux/linux_videodev2_compat.h>
end_include

begin_expr_stmt
name|CTASSERT
argument_list|(
name|LINUX_IFNAMSIZ
operator|==
name|IFNAMSIZ
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FEATURE
argument_list|(
name|linuxulator_v4l
argument_list|,
literal|"V4L ioctl wrapper support in the linuxulator"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|FEATURE
argument_list|(
name|linuxulator_v4l2
argument_list|,
literal|"V4L2 ioctl wrapper support in the linuxulator"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|linux_ioctl_function_t
name|linux_ioctl_cdrom
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|linux_ioctl_function_t
name|linux_ioctl_vfat
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|linux_ioctl_function_t
name|linux_ioctl_console
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|linux_ioctl_function_t
name|linux_ioctl_hdio
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|linux_ioctl_function_t
name|linux_ioctl_disk
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|linux_ioctl_function_t
name|linux_ioctl_socket
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|linux_ioctl_function_t
name|linux_ioctl_sound
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|linux_ioctl_function_t
name|linux_ioctl_termio
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|linux_ioctl_function_t
name|linux_ioctl_private
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|linux_ioctl_function_t
name|linux_ioctl_drm
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|linux_ioctl_function_t
name|linux_ioctl_sg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|linux_ioctl_function_t
name|linux_ioctl_v4l
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|linux_ioctl_function_t
name|linux_ioctl_v4l2
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|linux_ioctl_function_t
name|linux_ioctl_special
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|linux_ioctl_function_t
name|linux_ioctl_fbsd_usb
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|linux_ioctl_handler
name|cdrom_handler
init|=
block|{
name|linux_ioctl_cdrom
block|,
name|LINUX_IOCTL_CDROM_MIN
block|,
name|LINUX_IOCTL_CDROM_MAX
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|linux_ioctl_handler
name|vfat_handler
init|=
block|{
name|linux_ioctl_vfat
block|,
name|LINUX_IOCTL_VFAT_MIN
block|,
name|LINUX_IOCTL_VFAT_MAX
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|linux_ioctl_handler
name|console_handler
init|=
block|{
name|linux_ioctl_console
block|,
name|LINUX_IOCTL_CONSOLE_MIN
block|,
name|LINUX_IOCTL_CONSOLE_MAX
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|linux_ioctl_handler
name|hdio_handler
init|=
block|{
name|linux_ioctl_hdio
block|,
name|LINUX_IOCTL_HDIO_MIN
block|,
name|LINUX_IOCTL_HDIO_MAX
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|linux_ioctl_handler
name|disk_handler
init|=
block|{
name|linux_ioctl_disk
block|,
name|LINUX_IOCTL_DISK_MIN
block|,
name|LINUX_IOCTL_DISK_MAX
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|linux_ioctl_handler
name|socket_handler
init|=
block|{
name|linux_ioctl_socket
block|,
name|LINUX_IOCTL_SOCKET_MIN
block|,
name|LINUX_IOCTL_SOCKET_MAX
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|linux_ioctl_handler
name|sound_handler
init|=
block|{
name|linux_ioctl_sound
block|,
name|LINUX_IOCTL_SOUND_MIN
block|,
name|LINUX_IOCTL_SOUND_MAX
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|linux_ioctl_handler
name|termio_handler
init|=
block|{
name|linux_ioctl_termio
block|,
name|LINUX_IOCTL_TERMIO_MIN
block|,
name|LINUX_IOCTL_TERMIO_MAX
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|linux_ioctl_handler
name|private_handler
init|=
block|{
name|linux_ioctl_private
block|,
name|LINUX_IOCTL_PRIVATE_MIN
block|,
name|LINUX_IOCTL_PRIVATE_MAX
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|linux_ioctl_handler
name|drm_handler
init|=
block|{
name|linux_ioctl_drm
block|,
name|LINUX_IOCTL_DRM_MIN
block|,
name|LINUX_IOCTL_DRM_MAX
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|linux_ioctl_handler
name|sg_handler
init|=
block|{
name|linux_ioctl_sg
block|,
name|LINUX_IOCTL_SG_MIN
block|,
name|LINUX_IOCTL_SG_MAX
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|linux_ioctl_handler
name|video_handler
init|=
block|{
name|linux_ioctl_v4l
block|,
name|LINUX_IOCTL_VIDEO_MIN
block|,
name|LINUX_IOCTL_VIDEO_MAX
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|linux_ioctl_handler
name|video2_handler
init|=
block|{
name|linux_ioctl_v4l2
block|,
name|LINUX_IOCTL_VIDEO2_MIN
block|,
name|LINUX_IOCTL_VIDEO2_MAX
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|linux_ioctl_handler
name|fbsd_usb
init|=
block|{
name|linux_ioctl_fbsd_usb
block|,
name|FBSD_LUSB_MIN
block|,
name|FBSD_LUSB_MAX
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|DATA_SET
argument_list|(
name|linux_ioctl_handler_set
argument_list|,
name|cdrom_handler
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DATA_SET
argument_list|(
name|linux_ioctl_handler_set
argument_list|,
name|vfat_handler
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DATA_SET
argument_list|(
name|linux_ioctl_handler_set
argument_list|,
name|console_handler
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DATA_SET
argument_list|(
name|linux_ioctl_handler_set
argument_list|,
name|hdio_handler
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DATA_SET
argument_list|(
name|linux_ioctl_handler_set
argument_list|,
name|disk_handler
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DATA_SET
argument_list|(
name|linux_ioctl_handler_set
argument_list|,
name|socket_handler
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DATA_SET
argument_list|(
name|linux_ioctl_handler_set
argument_list|,
name|sound_handler
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DATA_SET
argument_list|(
name|linux_ioctl_handler_set
argument_list|,
name|termio_handler
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DATA_SET
argument_list|(
name|linux_ioctl_handler_set
argument_list|,
name|private_handler
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DATA_SET
argument_list|(
name|linux_ioctl_handler_set
argument_list|,
name|drm_handler
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DATA_SET
argument_list|(
name|linux_ioctl_handler_set
argument_list|,
name|sg_handler
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DATA_SET
argument_list|(
name|linux_ioctl_handler_set
argument_list|,
name|video_handler
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DATA_SET
argument_list|(
name|linux_ioctl_handler_set
argument_list|,
name|video2_handler
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|DATA_SET
argument_list|(
name|linux_ioctl_handler_set
argument_list|,
name|fbsd_usb
argument_list|)
expr_stmt|;
end_expr_stmt

begin_struct
struct|struct
name|handler_element
block|{
name|TAILQ_ENTRY
argument_list|(
argument|handler_element
argument_list|)
name|list
expr_stmt|;
name|int
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|struct
name|thread
modifier|*
parameter_list|,
name|struct
name|linux_ioctl_args
modifier|*
parameter_list|)
function_decl|;
name|int
name|low
decl_stmt|,
name|high
decl_stmt|,
name|span
decl_stmt|;
block|}
struct|;
end_struct

begin_expr_stmt
specifier|static
name|TAILQ_HEAD
argument_list|(
argument_list|,
argument|handler_element
argument_list|)
name|handlers
operator|=
name|TAILQ_HEAD_INITIALIZER
argument_list|(
name|handlers
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|struct
name|sx
name|linux_ioctl_sx
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|SX_SYSINIT
argument_list|(
name|linux_ioctl
argument_list|,
operator|&
name|linux_ioctl_sx
argument_list|,
literal|"linux ioctl handlers"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  * hdio related ioctls for VMWare support  */
end_comment

begin_struct
struct|struct
name|linux_hd_geometry
block|{
name|u_int8_t
name|heads
decl_stmt|;
name|u_int8_t
name|sectors
decl_stmt|;
name|u_int16_t
name|cylinders
decl_stmt|;
name|u_int32_t
name|start
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|linux_hd_big_geometry
block|{
name|u_int8_t
name|heads
decl_stmt|;
name|u_int8_t
name|sectors
decl_stmt|;
name|u_int32_t
name|cylinders
decl_stmt|;
name|u_int32_t
name|start
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|linux_ioctl_hdio
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|struct
name|linux_ioctl_args
modifier|*
name|args
parameter_list|)
block|{
name|cap_rights_t
name|rights
decl_stmt|;
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|u_int
name|sectorsize
decl_stmt|,
name|fwcylinders
decl_stmt|,
name|fwheads
decl_stmt|,
name|fwsectors
decl_stmt|;
name|off_t
name|mediasize
decl_stmt|,
name|bytespercyl
decl_stmt|;
name|error
operator|=
name|fget
argument_list|(
name|td
argument_list|,
name|args
operator|->
name|fd
argument_list|,
name|cap_rights_init
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_IOCTL
argument_list|)
argument_list|,
operator|&
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
switch|switch
condition|(
name|args
operator|->
name|cmd
operator|&
literal|0xffff
condition|)
block|{
case|case
name|LINUX_HDIO_GET_GEO
case|:
case|case
name|LINUX_HDIO_GET_GEO_BIG
case|:
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|DIOCGMEDIASIZE
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|mediasize
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|DIOCGSECTORSIZE
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|sectorsize
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|DIOCGFWHEADS
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|fwheads
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|DIOCGFWSECTORS
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|fwsectors
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
comment|/* 		 * XXX: DIOCGFIRSTOFFSET is not yet implemented, so 		 * so pretend that GEOM always says 0. This is NOT VALID 		 * for slices or partitions, only the per-disk raw devices. 		 */
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
comment|/* 		 * 1. Calculate the number of bytes in a cylinder, 		 *    given the firmware's notion of heads and sectors 		 *    per cylinder. 		 * 2. Calculate the number of cylinders, given the total 		 *    size of the media. 		 * All internal calculations should have 64-bit precision. 		 */
name|bytespercyl
operator|=
operator|(
name|off_t
operator|)
name|sectorsize
operator|*
name|fwheads
operator|*
name|fwsectors
expr_stmt|;
name|fwcylinders
operator|=
name|mediasize
operator|/
name|bytespercyl
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|DEBUG
argument_list|)
name|linux_msg
argument_list|(
name|td
argument_list|,
literal|"HDIO_GET_GEO: mediasize %jd, c/h/s %d/%d/%d, "
literal|"bpc %jd"
argument_list|,
operator|(
name|intmax_t
operator|)
name|mediasize
argument_list|,
name|fwcylinders
argument_list|,
name|fwheads
argument_list|,
name|fwsectors
argument_list|,
operator|(
name|intmax_t
operator|)
name|bytespercyl
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|args
operator|->
name|cmd
operator|&
literal|0xffff
operator|)
operator|==
name|LINUX_HDIO_GET_GEO
condition|)
block|{
name|struct
name|linux_hd_geometry
name|hdg
decl_stmt|;
name|hdg
operator|.
name|cylinders
operator|=
name|fwcylinders
expr_stmt|;
name|hdg
operator|.
name|heads
operator|=
name|fwheads
expr_stmt|;
name|hdg
operator|.
name|sectors
operator|=
name|fwsectors
expr_stmt|;
name|hdg
operator|.
name|start
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|hdg
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|hdg
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|args
operator|->
name|cmd
operator|&
literal|0xffff
operator|)
operator|==
name|LINUX_HDIO_GET_GEO_BIG
condition|)
block|{
name|struct
name|linux_hd_big_geometry
name|hdbg
decl_stmt|;
name|hdbg
operator|.
name|cylinders
operator|=
name|fwcylinders
expr_stmt|;
name|hdbg
operator|.
name|heads
operator|=
name|fwheads
expr_stmt|;
name|hdbg
operator|.
name|sectors
operator|=
name|fwsectors
expr_stmt|;
name|hdbg
operator|.
name|start
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|hdbg
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|hdbg
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
break|break;
default|default:
comment|/* XXX */
name|linux_msg
argument_list|(
name|td
argument_list|,
literal|"ioctl fd=%d, cmd=0x%x ('%c',%d) is not implemented"
argument_list|,
name|args
operator|->
name|fd
argument_list|,
call|(
name|int
call|)
argument_list|(
name|args
operator|->
name|cmd
operator|&
literal|0xffff
argument_list|)
argument_list|,
call|(
name|int
call|)
argument_list|(
name|args
operator|->
name|cmd
operator|&
literal|0xff00
argument_list|)
operator|>>
literal|8
argument_list|,
call|(
name|int
call|)
argument_list|(
name|args
operator|->
name|cmd
operator|&
literal|0xff
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOIOCTL
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|linux_ioctl_disk
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|struct
name|linux_ioctl_args
modifier|*
name|args
parameter_list|)
block|{
name|cap_rights_t
name|rights
decl_stmt|;
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|u_int
name|sectorsize
decl_stmt|;
name|off_t
name|mediasize
decl_stmt|;
name|error
operator|=
name|fget
argument_list|(
name|td
argument_list|,
name|args
operator|->
name|fd
argument_list|,
name|cap_rights_init
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_IOCTL
argument_list|)
argument_list|,
operator|&
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
switch|switch
condition|(
name|args
operator|->
name|cmd
operator|&
literal|0xffff
condition|)
block|{
case|case
name|LINUX_BLKGETSIZE
case|:
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|DIOCGSECTORSIZE
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|sectorsize
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|DIOCGMEDIASIZE
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|mediasize
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|sectorsize
operator|=
name|mediasize
operator|/
name|sectorsize
expr_stmt|;
comment|/* 		 * XXX: How do we know we return the right size of integer ? 		 */
return|return
operator|(
name|copyout
argument_list|(
operator|&
name|sectorsize
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|sectorsize
argument_list|)
argument_list|)
operator|)
return|;
break|break;
block|}
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|ENOIOCTL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * termio related ioctls  */
end_comment

begin_struct
struct|struct
name|linux_termio
block|{
name|unsigned
name|short
name|c_iflag
decl_stmt|;
name|unsigned
name|short
name|c_oflag
decl_stmt|;
name|unsigned
name|short
name|c_cflag
decl_stmt|;
name|unsigned
name|short
name|c_lflag
decl_stmt|;
name|unsigned
name|char
name|c_line
decl_stmt|;
name|unsigned
name|char
name|c_cc
index|[
name|LINUX_NCC
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|linux_termios
block|{
name|unsigned
name|int
name|c_iflag
decl_stmt|;
name|unsigned
name|int
name|c_oflag
decl_stmt|;
name|unsigned
name|int
name|c_cflag
decl_stmt|;
name|unsigned
name|int
name|c_lflag
decl_stmt|;
name|unsigned
name|char
name|c_line
decl_stmt|;
name|unsigned
name|char
name|c_cc
index|[
name|LINUX_NCCS
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|linux_winsize
block|{
name|unsigned
name|short
name|ws_row
decl_stmt|,
name|ws_col
decl_stmt|;
name|unsigned
name|short
name|ws_xpixel
decl_stmt|,
name|ws_ypixel
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|speedtab
block|{
name|int
name|sp_speed
decl_stmt|;
comment|/* Speed. */
name|int
name|sp_code
decl_stmt|;
comment|/* Code. */
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|speedtab
name|sptab
index|[]
init|=
block|{
block|{
name|B0
block|,
name|LINUX_B0
block|}
block|,
block|{
name|B50
block|,
name|LINUX_B50
block|}
block|,
block|{
name|B75
block|,
name|LINUX_B75
block|}
block|,
block|{
name|B110
block|,
name|LINUX_B110
block|}
block|,
block|{
name|B134
block|,
name|LINUX_B134
block|}
block|,
block|{
name|B150
block|,
name|LINUX_B150
block|}
block|,
block|{
name|B200
block|,
name|LINUX_B200
block|}
block|,
block|{
name|B300
block|,
name|LINUX_B300
block|}
block|,
block|{
name|B600
block|,
name|LINUX_B600
block|}
block|,
block|{
name|B1200
block|,
name|LINUX_B1200
block|}
block|,
block|{
name|B1800
block|,
name|LINUX_B1800
block|}
block|,
block|{
name|B2400
block|,
name|LINUX_B2400
block|}
block|,
block|{
name|B4800
block|,
name|LINUX_B4800
block|}
block|,
block|{
name|B9600
block|,
name|LINUX_B9600
block|}
block|,
block|{
name|B19200
block|,
name|LINUX_B19200
block|}
block|,
block|{
name|B38400
block|,
name|LINUX_B38400
block|}
block|,
block|{
name|B57600
block|,
name|LINUX_B57600
block|}
block|,
block|{
name|B115200
block|,
name|LINUX_B115200
block|}
block|,
block|{
operator|-
literal|1
block|,
operator|-
literal|1
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|linux_serial_struct
block|{
name|int
name|type
decl_stmt|;
name|int
name|line
decl_stmt|;
name|int
name|port
decl_stmt|;
name|int
name|irq
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|int
name|xmit_fifo_size
decl_stmt|;
name|int
name|custom_divisor
decl_stmt|;
name|int
name|baud_base
decl_stmt|;
name|unsigned
name|short
name|close_delay
decl_stmt|;
name|char
name|reserved_char
index|[
literal|2
index|]
decl_stmt|;
name|int
name|hub6
decl_stmt|;
name|unsigned
name|short
name|closing_wait
decl_stmt|;
name|unsigned
name|short
name|closing_wait2
decl_stmt|;
name|int
name|reserved
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|linux_to_bsd_speed
parameter_list|(
name|int
name|code
parameter_list|,
name|struct
name|speedtab
modifier|*
name|table
parameter_list|)
block|{
for|for
control|(
init|;
name|table
operator|->
name|sp_code
operator|!=
operator|-
literal|1
condition|;
name|table
operator|++
control|)
if|if
condition|(
name|table
operator|->
name|sp_code
operator|==
name|code
condition|)
return|return
operator|(
name|table
operator|->
name|sp_speed
operator|)
return|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bsd_to_linux_speed
parameter_list|(
name|int
name|speed
parameter_list|,
name|struct
name|speedtab
modifier|*
name|table
parameter_list|)
block|{
for|for
control|(
init|;
name|table
operator|->
name|sp_speed
operator|!=
operator|-
literal|1
condition|;
name|table
operator|++
control|)
if|if
condition|(
name|table
operator|->
name|sp_speed
operator|==
name|speed
condition|)
return|return
operator|(
name|table
operator|->
name|sp_code
operator|)
return|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bsd_to_linux_termios
parameter_list|(
name|struct
name|termios
modifier|*
name|bios
parameter_list|,
name|struct
name|linux_termios
modifier|*
name|lios
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|ldebug
argument_list|(
name|ioctl
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"LINUX: BSD termios structure (input):\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"i=%08x o=%08x c=%08x l=%08x ispeed=%d ospeed=%d\n"
argument_list|,
name|bios
operator|->
name|c_iflag
argument_list|,
name|bios
operator|->
name|c_oflag
argument_list|,
name|bios
operator|->
name|c_cflag
argument_list|,
name|bios
operator|->
name|c_lflag
argument_list|,
name|bios
operator|->
name|c_ispeed
argument_list|,
name|bios
operator|->
name|c_ospeed
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"c_cc "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NCCS
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x "
argument_list|,
name|bios
operator|->
name|c_cc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|lios
operator|->
name|c_iflag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_iflag
operator|&
name|IGNBRK
condition|)
name|lios
operator|->
name|c_iflag
operator||=
name|LINUX_IGNBRK
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_iflag
operator|&
name|BRKINT
condition|)
name|lios
operator|->
name|c_iflag
operator||=
name|LINUX_BRKINT
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_iflag
operator|&
name|IGNPAR
condition|)
name|lios
operator|->
name|c_iflag
operator||=
name|LINUX_IGNPAR
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_iflag
operator|&
name|PARMRK
condition|)
name|lios
operator|->
name|c_iflag
operator||=
name|LINUX_PARMRK
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_iflag
operator|&
name|INPCK
condition|)
name|lios
operator|->
name|c_iflag
operator||=
name|LINUX_INPCK
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_iflag
operator|&
name|ISTRIP
condition|)
name|lios
operator|->
name|c_iflag
operator||=
name|LINUX_ISTRIP
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_iflag
operator|&
name|INLCR
condition|)
name|lios
operator|->
name|c_iflag
operator||=
name|LINUX_INLCR
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_iflag
operator|&
name|IGNCR
condition|)
name|lios
operator|->
name|c_iflag
operator||=
name|LINUX_IGNCR
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_iflag
operator|&
name|ICRNL
condition|)
name|lios
operator|->
name|c_iflag
operator||=
name|LINUX_ICRNL
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_iflag
operator|&
name|IXON
condition|)
name|lios
operator|->
name|c_iflag
operator||=
name|LINUX_IXON
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_iflag
operator|&
name|IXANY
condition|)
name|lios
operator|->
name|c_iflag
operator||=
name|LINUX_IXANY
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_iflag
operator|&
name|IXOFF
condition|)
name|lios
operator|->
name|c_iflag
operator||=
name|LINUX_IXOFF
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_iflag
operator|&
name|IMAXBEL
condition|)
name|lios
operator|->
name|c_iflag
operator||=
name|LINUX_IMAXBEL
expr_stmt|;
name|lios
operator|->
name|c_oflag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_oflag
operator|&
name|OPOST
condition|)
name|lios
operator|->
name|c_oflag
operator||=
name|LINUX_OPOST
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_oflag
operator|&
name|ONLCR
condition|)
name|lios
operator|->
name|c_oflag
operator||=
name|LINUX_ONLCR
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_oflag
operator|&
name|TAB3
condition|)
name|lios
operator|->
name|c_oflag
operator||=
name|LINUX_XTABS
expr_stmt|;
name|lios
operator|->
name|c_cflag
operator|=
name|bsd_to_linux_speed
argument_list|(
name|bios
operator|->
name|c_ispeed
argument_list|,
name|sptab
argument_list|)
expr_stmt|;
name|lios
operator|->
name|c_cflag
operator||=
operator|(
name|bios
operator|->
name|c_cflag
operator|&
name|CSIZE
operator|)
operator|>>
literal|4
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_cflag
operator|&
name|CSTOPB
condition|)
name|lios
operator|->
name|c_cflag
operator||=
name|LINUX_CSTOPB
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_cflag
operator|&
name|CREAD
condition|)
name|lios
operator|->
name|c_cflag
operator||=
name|LINUX_CREAD
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_cflag
operator|&
name|PARENB
condition|)
name|lios
operator|->
name|c_cflag
operator||=
name|LINUX_PARENB
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_cflag
operator|&
name|PARODD
condition|)
name|lios
operator|->
name|c_cflag
operator||=
name|LINUX_PARODD
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_cflag
operator|&
name|HUPCL
condition|)
name|lios
operator|->
name|c_cflag
operator||=
name|LINUX_HUPCL
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_cflag
operator|&
name|CLOCAL
condition|)
name|lios
operator|->
name|c_cflag
operator||=
name|LINUX_CLOCAL
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_cflag
operator|&
name|CRTSCTS
condition|)
name|lios
operator|->
name|c_cflag
operator||=
name|LINUX_CRTSCTS
expr_stmt|;
name|lios
operator|->
name|c_lflag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_lflag
operator|&
name|ISIG
condition|)
name|lios
operator|->
name|c_lflag
operator||=
name|LINUX_ISIG
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_lflag
operator|&
name|ICANON
condition|)
name|lios
operator|->
name|c_lflag
operator||=
name|LINUX_ICANON
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_lflag
operator|&
name|ECHO
condition|)
name|lios
operator|->
name|c_lflag
operator||=
name|LINUX_ECHO
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_lflag
operator|&
name|ECHOE
condition|)
name|lios
operator|->
name|c_lflag
operator||=
name|LINUX_ECHOE
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_lflag
operator|&
name|ECHOK
condition|)
name|lios
operator|->
name|c_lflag
operator||=
name|LINUX_ECHOK
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_lflag
operator|&
name|ECHONL
condition|)
name|lios
operator|->
name|c_lflag
operator||=
name|LINUX_ECHONL
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_lflag
operator|&
name|NOFLSH
condition|)
name|lios
operator|->
name|c_lflag
operator||=
name|LINUX_NOFLSH
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_lflag
operator|&
name|TOSTOP
condition|)
name|lios
operator|->
name|c_lflag
operator||=
name|LINUX_TOSTOP
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_lflag
operator|&
name|ECHOCTL
condition|)
name|lios
operator|->
name|c_lflag
operator||=
name|LINUX_ECHOCTL
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_lflag
operator|&
name|ECHOPRT
condition|)
name|lios
operator|->
name|c_lflag
operator||=
name|LINUX_ECHOPRT
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_lflag
operator|&
name|ECHOKE
condition|)
name|lios
operator|->
name|c_lflag
operator||=
name|LINUX_ECHOKE
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_lflag
operator|&
name|FLUSHO
condition|)
name|lios
operator|->
name|c_lflag
operator||=
name|LINUX_FLUSHO
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_lflag
operator|&
name|PENDIN
condition|)
name|lios
operator|->
name|c_lflag
operator||=
name|LINUX_PENDIN
expr_stmt|;
if|if
condition|(
name|bios
operator|->
name|c_lflag
operator|&
name|IEXTEN
condition|)
name|lios
operator|->
name|c_lflag
operator||=
name|LINUX_IEXTEN
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|LINUX_NCCS
condition|;
name|i
operator|++
control|)
name|lios
operator|->
name|c_cc
index|[
name|i
index|]
operator|=
name|LINUX_POSIX_VDISABLE
expr_stmt|;
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VINTR
index|]
operator|=
name|bios
operator|->
name|c_cc
index|[
name|VINTR
index|]
expr_stmt|;
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VQUIT
index|]
operator|=
name|bios
operator|->
name|c_cc
index|[
name|VQUIT
index|]
expr_stmt|;
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VERASE
index|]
operator|=
name|bios
operator|->
name|c_cc
index|[
name|VERASE
index|]
expr_stmt|;
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VKILL
index|]
operator|=
name|bios
operator|->
name|c_cc
index|[
name|VKILL
index|]
expr_stmt|;
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VEOF
index|]
operator|=
name|bios
operator|->
name|c_cc
index|[
name|VEOF
index|]
expr_stmt|;
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VEOL
index|]
operator|=
name|bios
operator|->
name|c_cc
index|[
name|VEOL
index|]
expr_stmt|;
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VMIN
index|]
operator|=
name|bios
operator|->
name|c_cc
index|[
name|VMIN
index|]
expr_stmt|;
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VTIME
index|]
operator|=
name|bios
operator|->
name|c_cc
index|[
name|VTIME
index|]
expr_stmt|;
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VEOL2
index|]
operator|=
name|bios
operator|->
name|c_cc
index|[
name|VEOL2
index|]
expr_stmt|;
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VSUSP
index|]
operator|=
name|bios
operator|->
name|c_cc
index|[
name|VSUSP
index|]
expr_stmt|;
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VSTART
index|]
operator|=
name|bios
operator|->
name|c_cc
index|[
name|VSTART
index|]
expr_stmt|;
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VSTOP
index|]
operator|=
name|bios
operator|->
name|c_cc
index|[
name|VSTOP
index|]
expr_stmt|;
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VREPRINT
index|]
operator|=
name|bios
operator|->
name|c_cc
index|[
name|VREPRINT
index|]
expr_stmt|;
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VDISCARD
index|]
operator|=
name|bios
operator|->
name|c_cc
index|[
name|VDISCARD
index|]
expr_stmt|;
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VWERASE
index|]
operator|=
name|bios
operator|->
name|c_cc
index|[
name|VWERASE
index|]
expr_stmt|;
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VLNEXT
index|]
operator|=
name|bios
operator|->
name|c_cc
index|[
name|VLNEXT
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|LINUX_NCCS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|!=
name|LINUX_VMIN
operator|&&
name|i
operator|!=
name|LINUX_VTIME
operator|&&
name|lios
operator|->
name|c_cc
index|[
name|i
index|]
operator|==
name|_POSIX_VDISABLE
condition|)
name|lios
operator|->
name|c_cc
index|[
name|i
index|]
operator|=
name|LINUX_POSIX_VDISABLE
expr_stmt|;
block|}
name|lios
operator|->
name|c_line
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|ldebug
argument_list|(
name|ioctl
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"LINUX: LINUX termios structure (output):\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"i=%08x o=%08x c=%08x l=%08x line=%d\n"
argument_list|,
name|lios
operator|->
name|c_iflag
argument_list|,
name|lios
operator|->
name|c_oflag
argument_list|,
name|lios
operator|->
name|c_cflag
argument_list|,
name|lios
operator|->
name|c_lflag
argument_list|,
operator|(
name|int
operator|)
name|lios
operator|->
name|c_line
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"c_cc "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|LINUX_NCCS
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x "
argument_list|,
name|lios
operator|->
name|c_cc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|linux_to_bsd_termios
parameter_list|(
name|struct
name|linux_termios
modifier|*
name|lios
parameter_list|,
name|struct
name|termios
modifier|*
name|bios
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|ldebug
argument_list|(
name|ioctl
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"LINUX: LINUX termios structure (input):\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"i=%08x o=%08x c=%08x l=%08x line=%d\n"
argument_list|,
name|lios
operator|->
name|c_iflag
argument_list|,
name|lios
operator|->
name|c_oflag
argument_list|,
name|lios
operator|->
name|c_cflag
argument_list|,
name|lios
operator|->
name|c_lflag
argument_list|,
operator|(
name|int
operator|)
name|lios
operator|->
name|c_line
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"c_cc "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|LINUX_NCCS
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x "
argument_list|,
name|lios
operator|->
name|c_cc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|bios
operator|->
name|c_iflag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_iflag
operator|&
name|LINUX_IGNBRK
condition|)
name|bios
operator|->
name|c_iflag
operator||=
name|IGNBRK
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_iflag
operator|&
name|LINUX_BRKINT
condition|)
name|bios
operator|->
name|c_iflag
operator||=
name|BRKINT
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_iflag
operator|&
name|LINUX_IGNPAR
condition|)
name|bios
operator|->
name|c_iflag
operator||=
name|IGNPAR
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_iflag
operator|&
name|LINUX_PARMRK
condition|)
name|bios
operator|->
name|c_iflag
operator||=
name|PARMRK
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_iflag
operator|&
name|LINUX_INPCK
condition|)
name|bios
operator|->
name|c_iflag
operator||=
name|INPCK
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_iflag
operator|&
name|LINUX_ISTRIP
condition|)
name|bios
operator|->
name|c_iflag
operator||=
name|ISTRIP
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_iflag
operator|&
name|LINUX_INLCR
condition|)
name|bios
operator|->
name|c_iflag
operator||=
name|INLCR
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_iflag
operator|&
name|LINUX_IGNCR
condition|)
name|bios
operator|->
name|c_iflag
operator||=
name|IGNCR
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_iflag
operator|&
name|LINUX_ICRNL
condition|)
name|bios
operator|->
name|c_iflag
operator||=
name|ICRNL
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_iflag
operator|&
name|LINUX_IXON
condition|)
name|bios
operator|->
name|c_iflag
operator||=
name|IXON
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_iflag
operator|&
name|LINUX_IXANY
condition|)
name|bios
operator|->
name|c_iflag
operator||=
name|IXANY
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_iflag
operator|&
name|LINUX_IXOFF
condition|)
name|bios
operator|->
name|c_iflag
operator||=
name|IXOFF
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_iflag
operator|&
name|LINUX_IMAXBEL
condition|)
name|bios
operator|->
name|c_iflag
operator||=
name|IMAXBEL
expr_stmt|;
name|bios
operator|->
name|c_oflag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_oflag
operator|&
name|LINUX_OPOST
condition|)
name|bios
operator|->
name|c_oflag
operator||=
name|OPOST
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_oflag
operator|&
name|LINUX_ONLCR
condition|)
name|bios
operator|->
name|c_oflag
operator||=
name|ONLCR
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_oflag
operator|&
name|LINUX_XTABS
condition|)
name|bios
operator|->
name|c_oflag
operator||=
name|TAB3
expr_stmt|;
name|bios
operator|->
name|c_cflag
operator|=
operator|(
name|lios
operator|->
name|c_cflag
operator|&
name|LINUX_CSIZE
operator|)
operator|<<
literal|4
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_cflag
operator|&
name|LINUX_CSTOPB
condition|)
name|bios
operator|->
name|c_cflag
operator||=
name|CSTOPB
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_cflag
operator|&
name|LINUX_CREAD
condition|)
name|bios
operator|->
name|c_cflag
operator||=
name|CREAD
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_cflag
operator|&
name|LINUX_PARENB
condition|)
name|bios
operator|->
name|c_cflag
operator||=
name|PARENB
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_cflag
operator|&
name|LINUX_PARODD
condition|)
name|bios
operator|->
name|c_cflag
operator||=
name|PARODD
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_cflag
operator|&
name|LINUX_HUPCL
condition|)
name|bios
operator|->
name|c_cflag
operator||=
name|HUPCL
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_cflag
operator|&
name|LINUX_CLOCAL
condition|)
name|bios
operator|->
name|c_cflag
operator||=
name|CLOCAL
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_cflag
operator|&
name|LINUX_CRTSCTS
condition|)
name|bios
operator|->
name|c_cflag
operator||=
name|CRTSCTS
expr_stmt|;
name|bios
operator|->
name|c_lflag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_lflag
operator|&
name|LINUX_ISIG
condition|)
name|bios
operator|->
name|c_lflag
operator||=
name|ISIG
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_lflag
operator|&
name|LINUX_ICANON
condition|)
name|bios
operator|->
name|c_lflag
operator||=
name|ICANON
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_lflag
operator|&
name|LINUX_ECHO
condition|)
name|bios
operator|->
name|c_lflag
operator||=
name|ECHO
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_lflag
operator|&
name|LINUX_ECHOE
condition|)
name|bios
operator|->
name|c_lflag
operator||=
name|ECHOE
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_lflag
operator|&
name|LINUX_ECHOK
condition|)
name|bios
operator|->
name|c_lflag
operator||=
name|ECHOK
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_lflag
operator|&
name|LINUX_ECHONL
condition|)
name|bios
operator|->
name|c_lflag
operator||=
name|ECHONL
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_lflag
operator|&
name|LINUX_NOFLSH
condition|)
name|bios
operator|->
name|c_lflag
operator||=
name|NOFLSH
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_lflag
operator|&
name|LINUX_TOSTOP
condition|)
name|bios
operator|->
name|c_lflag
operator||=
name|TOSTOP
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_lflag
operator|&
name|LINUX_ECHOCTL
condition|)
name|bios
operator|->
name|c_lflag
operator||=
name|ECHOCTL
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_lflag
operator|&
name|LINUX_ECHOPRT
condition|)
name|bios
operator|->
name|c_lflag
operator||=
name|ECHOPRT
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_lflag
operator|&
name|LINUX_ECHOKE
condition|)
name|bios
operator|->
name|c_lflag
operator||=
name|ECHOKE
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_lflag
operator|&
name|LINUX_FLUSHO
condition|)
name|bios
operator|->
name|c_lflag
operator||=
name|FLUSHO
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_lflag
operator|&
name|LINUX_PENDIN
condition|)
name|bios
operator|->
name|c_lflag
operator||=
name|PENDIN
expr_stmt|;
if|if
condition|(
name|lios
operator|->
name|c_lflag
operator|&
name|LINUX_IEXTEN
condition|)
name|bios
operator|->
name|c_lflag
operator||=
name|IEXTEN
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NCCS
condition|;
name|i
operator|++
control|)
name|bios
operator|->
name|c_cc
index|[
name|i
index|]
operator|=
name|_POSIX_VDISABLE
expr_stmt|;
name|bios
operator|->
name|c_cc
index|[
name|VINTR
index|]
operator|=
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VINTR
index|]
expr_stmt|;
name|bios
operator|->
name|c_cc
index|[
name|VQUIT
index|]
operator|=
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VQUIT
index|]
expr_stmt|;
name|bios
operator|->
name|c_cc
index|[
name|VERASE
index|]
operator|=
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VERASE
index|]
expr_stmt|;
name|bios
operator|->
name|c_cc
index|[
name|VKILL
index|]
operator|=
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VKILL
index|]
expr_stmt|;
name|bios
operator|->
name|c_cc
index|[
name|VEOF
index|]
operator|=
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VEOF
index|]
expr_stmt|;
name|bios
operator|->
name|c_cc
index|[
name|VEOL
index|]
operator|=
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VEOL
index|]
expr_stmt|;
name|bios
operator|->
name|c_cc
index|[
name|VMIN
index|]
operator|=
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VMIN
index|]
expr_stmt|;
name|bios
operator|->
name|c_cc
index|[
name|VTIME
index|]
operator|=
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VTIME
index|]
expr_stmt|;
name|bios
operator|->
name|c_cc
index|[
name|VEOL2
index|]
operator|=
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VEOL2
index|]
expr_stmt|;
name|bios
operator|->
name|c_cc
index|[
name|VSUSP
index|]
operator|=
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VSUSP
index|]
expr_stmt|;
name|bios
operator|->
name|c_cc
index|[
name|VSTART
index|]
operator|=
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VSTART
index|]
expr_stmt|;
name|bios
operator|->
name|c_cc
index|[
name|VSTOP
index|]
operator|=
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VSTOP
index|]
expr_stmt|;
name|bios
operator|->
name|c_cc
index|[
name|VREPRINT
index|]
operator|=
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VREPRINT
index|]
expr_stmt|;
name|bios
operator|->
name|c_cc
index|[
name|VDISCARD
index|]
operator|=
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VDISCARD
index|]
expr_stmt|;
name|bios
operator|->
name|c_cc
index|[
name|VWERASE
index|]
operator|=
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VWERASE
index|]
expr_stmt|;
name|bios
operator|->
name|c_cc
index|[
name|VLNEXT
index|]
operator|=
name|lios
operator|->
name|c_cc
index|[
name|LINUX_VLNEXT
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NCCS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|!=
name|VMIN
operator|&&
name|i
operator|!=
name|VTIME
operator|&&
name|bios
operator|->
name|c_cc
index|[
name|i
index|]
operator|==
name|LINUX_POSIX_VDISABLE
condition|)
name|bios
operator|->
name|c_cc
index|[
name|i
index|]
operator|=
name|_POSIX_VDISABLE
expr_stmt|;
block|}
name|bios
operator|->
name|c_ispeed
operator|=
name|bios
operator|->
name|c_ospeed
operator|=
name|linux_to_bsd_speed
argument_list|(
name|lios
operator|->
name|c_cflag
operator|&
name|LINUX_CBAUD
argument_list|,
name|sptab
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|ldebug
argument_list|(
name|ioctl
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"LINUX: BSD termios structure (output):\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"i=%08x o=%08x c=%08x l=%08x ispeed=%d ospeed=%d\n"
argument_list|,
name|bios
operator|->
name|c_iflag
argument_list|,
name|bios
operator|->
name|c_oflag
argument_list|,
name|bios
operator|->
name|c_cflag
argument_list|,
name|bios
operator|->
name|c_lflag
argument_list|,
name|bios
operator|->
name|c_ispeed
argument_list|,
name|bios
operator|->
name|c_ospeed
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"c_cc "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NCCS
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x "
argument_list|,
name|bios
operator|->
name|c_cc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|bsd_to_linux_termio
parameter_list|(
name|struct
name|termios
modifier|*
name|bios
parameter_list|,
name|struct
name|linux_termio
modifier|*
name|lio
parameter_list|)
block|{
name|struct
name|linux_termios
name|lios
decl_stmt|;
name|bsd_to_linux_termios
argument_list|(
name|bios
argument_list|,
operator|&
name|lios
argument_list|)
expr_stmt|;
name|lio
operator|->
name|c_iflag
operator|=
name|lios
operator|.
name|c_iflag
expr_stmt|;
name|lio
operator|->
name|c_oflag
operator|=
name|lios
operator|.
name|c_oflag
expr_stmt|;
name|lio
operator|->
name|c_cflag
operator|=
name|lios
operator|.
name|c_cflag
expr_stmt|;
name|lio
operator|->
name|c_lflag
operator|=
name|lios
operator|.
name|c_lflag
expr_stmt|;
name|lio
operator|->
name|c_line
operator|=
name|lios
operator|.
name|c_line
expr_stmt|;
name|memcpy
argument_list|(
name|lio
operator|->
name|c_cc
argument_list|,
name|lios
operator|.
name|c_cc
argument_list|,
name|LINUX_NCC
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|linux_to_bsd_termio
parameter_list|(
name|struct
name|linux_termio
modifier|*
name|lio
parameter_list|,
name|struct
name|termios
modifier|*
name|bios
parameter_list|)
block|{
name|struct
name|linux_termios
name|lios
decl_stmt|;
name|int
name|i
decl_stmt|;
name|lios
operator|.
name|c_iflag
operator|=
name|lio
operator|->
name|c_iflag
expr_stmt|;
name|lios
operator|.
name|c_oflag
operator|=
name|lio
operator|->
name|c_oflag
expr_stmt|;
name|lios
operator|.
name|c_cflag
operator|=
name|lio
operator|->
name|c_cflag
expr_stmt|;
name|lios
operator|.
name|c_lflag
operator|=
name|lio
operator|->
name|c_lflag
expr_stmt|;
for|for
control|(
name|i
operator|=
name|LINUX_NCC
init|;
name|i
operator|<
name|LINUX_NCCS
condition|;
name|i
operator|++
control|)
name|lios
operator|.
name|c_cc
index|[
name|i
index|]
operator|=
name|LINUX_POSIX_VDISABLE
expr_stmt|;
name|memcpy
argument_list|(
name|lios
operator|.
name|c_cc
argument_list|,
name|lio
operator|->
name|c_cc
argument_list|,
name|LINUX_NCC
argument_list|)
expr_stmt|;
name|linux_to_bsd_termios
argument_list|(
operator|&
name|lios
argument_list|,
name|bios
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|linux_ioctl_termio
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|struct
name|linux_ioctl_args
modifier|*
name|args
parameter_list|)
block|{
name|struct
name|termios
name|bios
decl_stmt|;
name|struct
name|linux_termios
name|lios
decl_stmt|;
name|struct
name|linux_termio
name|lio
decl_stmt|;
name|cap_rights_t
name|rights
decl_stmt|;
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|fget
argument_list|(
name|td
argument_list|,
name|args
operator|->
name|fd
argument_list|,
name|cap_rights_init
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_IOCTL
argument_list|)
argument_list|,
operator|&
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
switch|switch
condition|(
name|args
operator|->
name|cmd
operator|&
literal|0xffff
condition|)
block|{
case|case
name|LINUX_TCGETS
case|:
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|TIOCGETA
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bios
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|bsd_to_linux_termios
argument_list|(
operator|&
name|bios
argument_list|,
operator|&
name|lios
argument_list|)
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|lios
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|lios
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINUX_TCSETS
case|:
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
operator|&
name|lios
argument_list|,
sizeof|sizeof
argument_list|(
name|lios
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|linux_to_bsd_termios
argument_list|(
operator|&
name|lios
argument_list|,
operator|&
name|bios
argument_list|)
expr_stmt|;
name|error
operator|=
operator|(
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|TIOCSETA
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bios
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_TCSETSW
case|:
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
operator|&
name|lios
argument_list|,
sizeof|sizeof
argument_list|(
name|lios
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|linux_to_bsd_termios
argument_list|(
operator|&
name|lios
argument_list|,
operator|&
name|bios
argument_list|)
expr_stmt|;
name|error
operator|=
operator|(
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|TIOCSETAW
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bios
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_TCSETSF
case|:
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
operator|&
name|lios
argument_list|,
sizeof|sizeof
argument_list|(
name|lios
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|linux_to_bsd_termios
argument_list|(
operator|&
name|lios
argument_list|,
operator|&
name|bios
argument_list|)
expr_stmt|;
name|error
operator|=
operator|(
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|TIOCSETAF
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bios
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_TCGETA
case|:
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|TIOCGETA
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bios
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|bsd_to_linux_termio
argument_list|(
operator|&
name|bios
argument_list|,
operator|&
name|lio
argument_list|)
expr_stmt|;
name|error
operator|=
operator|(
name|copyout
argument_list|(
operator|&
name|lio
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|lio
argument_list|)
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_TCSETA
case|:
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
operator|&
name|lio
argument_list|,
sizeof|sizeof
argument_list|(
name|lio
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|linux_to_bsd_termio
argument_list|(
operator|&
name|lio
argument_list|,
operator|&
name|bios
argument_list|)
expr_stmt|;
name|error
operator|=
operator|(
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|TIOCSETA
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bios
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_TCSETAW
case|:
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
operator|&
name|lio
argument_list|,
sizeof|sizeof
argument_list|(
name|lio
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|linux_to_bsd_termio
argument_list|(
operator|&
name|lio
argument_list|,
operator|&
name|bios
argument_list|)
expr_stmt|;
name|error
operator|=
operator|(
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|TIOCSETAW
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bios
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_TCSETAF
case|:
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
operator|&
name|lio
argument_list|,
sizeof|sizeof
argument_list|(
name|lio
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|linux_to_bsd_termio
argument_list|(
operator|&
name|lio
argument_list|,
operator|&
name|bios
argument_list|)
expr_stmt|;
name|error
operator|=
operator|(
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|TIOCSETAF
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bios
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
operator|)
expr_stmt|;
break|break;
comment|/* LINUX_TCSBRK */
case|case
name|LINUX_TCXONC
case|:
block|{
switch|switch
condition|(
name|args
operator|->
name|arg
condition|)
block|{
case|case
name|LINUX_TCOOFF
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCSTOP
expr_stmt|;
break|break;
case|case
name|LINUX_TCOON
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCSTART
expr_stmt|;
break|break;
case|case
name|LINUX_TCIOFF
case|:
case|case
name|LINUX_TCION
case|:
block|{
name|int
name|c
decl_stmt|;
name|struct
name|write_args
name|wr
decl_stmt|;
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|TIOCGETA
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bios
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
name|c
operator|=
operator|(
name|args
operator|->
name|arg
operator|==
name|LINUX_TCIOFF
operator|)
condition|?
name|VSTOP
else|:
name|VSTART
expr_stmt|;
name|c
operator|=
name|bios
operator|.
name|c_cc
index|[
name|c
index|]
expr_stmt|;
if|if
condition|(
name|c
operator|!=
name|_POSIX_VDISABLE
condition|)
block|{
name|wr
operator|.
name|fd
operator|=
name|args
operator|->
name|fd
expr_stmt|;
name|wr
operator|.
name|buf
operator|=
operator|&
name|c
expr_stmt|;
name|wr
operator|.
name|nbyte
operator|=
sizeof|sizeof
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return
operator|(
name|sys_write
argument_list|(
name|td
argument_list|,
operator|&
name|wr
argument_list|)
operator|)
return|;
block|}
else|else
return|return
operator|(
literal|0
operator|)
return|;
block|}
default|default:
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|args
operator|->
name|arg
operator|=
literal|0
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
block|}
case|case
name|LINUX_TCFLSH
case|:
block|{
name|int
name|val
decl_stmt|;
switch|switch
condition|(
name|args
operator|->
name|arg
condition|)
block|{
case|case
name|LINUX_TCIFLUSH
case|:
name|val
operator|=
name|FREAD
expr_stmt|;
break|break;
case|case
name|LINUX_TCOFLUSH
case|:
name|val
operator|=
name|FWRITE
expr_stmt|;
break|break;
case|case
name|LINUX_TCIOFLUSH
case|:
name|val
operator|=
name|FREAD
operator||
name|FWRITE
expr_stmt|;
break|break;
default|default:
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|error
operator|=
operator|(
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|TIOCFLUSH
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|val
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
operator|)
expr_stmt|;
break|break;
block|}
case|case
name|LINUX_TIOCEXCL
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCEXCL
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_TIOCNXCL
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCNXCL
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_TIOCSCTTY
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCSCTTY
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_TIOCGPGRP
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCGPGRP
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_TIOCSPGRP
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCSPGRP
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
comment|/* LINUX_TIOCOUTQ */
comment|/* LINUX_TIOCSTI */
case|case
name|LINUX_TIOCGWINSZ
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCGWINSZ
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_TIOCSWINSZ
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCSWINSZ
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_TIOCMGET
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCMGET
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_TIOCMBIS
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCMBIS
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_TIOCMBIC
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCMBIC
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_TIOCMSET
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCMSET
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
comment|/* TIOCGSOFTCAR */
comment|/* TIOCSSOFTCAR */
case|case
name|LINUX_FIONREAD
case|:
comment|/* LINUX_TIOCINQ */
name|args
operator|->
name|cmd
operator|=
name|FIONREAD
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
comment|/* LINUX_TIOCLINUX */
case|case
name|LINUX_TIOCCONS
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCCONS
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_TIOCGSERIAL
case|:
block|{
name|struct
name|linux_serial_struct
name|lss
decl_stmt|;
name|lss
operator|.
name|type
operator|=
name|LINUX_PORT_16550A
expr_stmt|;
name|lss
operator|.
name|flags
operator|=
literal|0
expr_stmt|;
name|lss
operator|.
name|close_delay
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|lss
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|lss
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|LINUX_TIOCSSERIAL
case|:
block|{
name|struct
name|linux_serial_struct
name|lss
decl_stmt|;
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
operator|&
name|lss
argument_list|,
sizeof|sizeof
argument_list|(
name|lss
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
comment|/* XXX - It really helps to have an implementation that 		 * does nothing. NOT! 		 */
name|error
operator|=
literal|0
expr_stmt|;
break|break;
block|}
case|case
name|LINUX_TIOCPKT
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCPKT
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_FIONBIO
case|:
name|args
operator|->
name|cmd
operator|=
name|FIONBIO
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_TIOCNOTTY
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCNOTTY
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_TIOCSETD
case|:
block|{
name|int
name|line
decl_stmt|;
switch|switch
condition|(
name|args
operator|->
name|arg
condition|)
block|{
case|case
name|LINUX_N_TTY
case|:
name|line
operator|=
name|TTYDISC
expr_stmt|;
break|break;
case|case
name|LINUX_N_SLIP
case|:
name|line
operator|=
name|SLIPDISC
expr_stmt|;
break|break;
case|case
name|LINUX_N_PPP
case|:
name|line
operator|=
name|PPPDISC
expr_stmt|;
break|break;
default|default:
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|error
operator|=
operator|(
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|TIOCSETD
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|line
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
operator|)
expr_stmt|;
break|break;
block|}
case|case
name|LINUX_TIOCGETD
case|:
block|{
name|int
name|linux_line
decl_stmt|;
name|int
name|bsd_line
init|=
name|TTYDISC
decl_stmt|;
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|TIOCGETD
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bsd_line
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
switch|switch
condition|(
name|bsd_line
condition|)
block|{
case|case
name|TTYDISC
case|:
name|linux_line
operator|=
name|LINUX_N_TTY
expr_stmt|;
break|break;
case|case
name|SLIPDISC
case|:
name|linux_line
operator|=
name|LINUX_N_SLIP
expr_stmt|;
break|break;
case|case
name|PPPDISC
case|:
name|linux_line
operator|=
name|LINUX_N_PPP
expr_stmt|;
break|break;
default|default:
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|error
operator|=
operator|(
name|copyout
argument_list|(
operator|&
name|linux_line
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
operator|)
expr_stmt|;
break|break;
block|}
comment|/* LINUX_TCSBRKP */
comment|/* LINUX_TIOCTTYGSTRUCT */
case|case
name|LINUX_FIONCLEX
case|:
name|args
operator|->
name|cmd
operator|=
name|FIONCLEX
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_FIOCLEX
case|:
name|args
operator|->
name|cmd
operator|=
name|FIOCLEX
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_FIOASYNC
case|:
name|args
operator|->
name|cmd
operator|=
name|FIOASYNC
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
comment|/* LINUX_TIOCSERCONFIG */
comment|/* LINUX_TIOCSERGWILD */
comment|/* LINUX_TIOCSERSWILD */
comment|/* LINUX_TIOCGLCKTRMIOS */
comment|/* LINUX_TIOCSLCKTRMIOS */
case|case
name|LINUX_TIOCSBRK
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCSBRK
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_TIOCCBRK
case|:
name|args
operator|->
name|cmd
operator|=
name|TIOCCBRK
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_TIOCGPTN
case|:
block|{
name|int
name|nb
decl_stmt|;
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|TIOCGPTN
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|nb
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|nb
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|LINUX_TIOCSPTLCK
case|:
comment|/* Our unlockpt() does nothing. */
name|error
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|ENOIOCTL
expr_stmt|;
break|break;
block|}
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * CDROM related ioctls  */
end_comment

begin_struct
struct|struct
name|linux_cdrom_msf
block|{
name|u_char
name|cdmsf_min0
decl_stmt|;
name|u_char
name|cdmsf_sec0
decl_stmt|;
name|u_char
name|cdmsf_frame0
decl_stmt|;
name|u_char
name|cdmsf_min1
decl_stmt|;
name|u_char
name|cdmsf_sec1
decl_stmt|;
name|u_char
name|cdmsf_frame1
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|linux_cdrom_tochdr
block|{
name|u_char
name|cdth_trk0
decl_stmt|;
name|u_char
name|cdth_trk1
decl_stmt|;
block|}
struct|;
end_struct

begin_union
union|union
name|linux_cdrom_addr
block|{
struct|struct
block|{
name|u_char
name|minute
decl_stmt|;
name|u_char
name|second
decl_stmt|;
name|u_char
name|frame
decl_stmt|;
block|}
name|msf
struct|;
name|int
name|lba
decl_stmt|;
block|}
union|;
end_union

begin_struct
struct|struct
name|linux_cdrom_tocentry
block|{
name|u_char
name|cdte_track
decl_stmt|;
name|u_char
name|cdte_adr
range|:
literal|4
decl_stmt|;
name|u_char
name|cdte_ctrl
range|:
literal|4
decl_stmt|;
name|u_char
name|cdte_format
decl_stmt|;
name|union
name|linux_cdrom_addr
name|cdte_addr
decl_stmt|;
name|u_char
name|cdte_datamode
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|linux_cdrom_subchnl
block|{
name|u_char
name|cdsc_format
decl_stmt|;
name|u_char
name|cdsc_audiostatus
decl_stmt|;
name|u_char
name|cdsc_adr
range|:
literal|4
decl_stmt|;
name|u_char
name|cdsc_ctrl
range|:
literal|4
decl_stmt|;
name|u_char
name|cdsc_trk
decl_stmt|;
name|u_char
name|cdsc_ind
decl_stmt|;
name|union
name|linux_cdrom_addr
name|cdsc_absaddr
decl_stmt|;
name|union
name|linux_cdrom_addr
name|cdsc_reladdr
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|l_cdrom_read_audio
block|{
name|union
name|linux_cdrom_addr
name|addr
decl_stmt|;
name|u_char
name|addr_format
decl_stmt|;
name|l_int
name|nframes
decl_stmt|;
name|u_char
modifier|*
name|buf
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|l_dvd_layer
block|{
name|u_char
name|book_version
range|:
literal|4
decl_stmt|;
name|u_char
name|book_type
range|:
literal|4
decl_stmt|;
name|u_char
name|min_rate
range|:
literal|4
decl_stmt|;
name|u_char
name|disc_size
range|:
literal|4
decl_stmt|;
name|u_char
name|layer_type
range|:
literal|4
decl_stmt|;
name|u_char
name|track_path
range|:
literal|1
decl_stmt|;
name|u_char
name|nlayers
range|:
literal|2
decl_stmt|;
name|u_char
name|track_density
range|:
literal|4
decl_stmt|;
name|u_char
name|linear_density
range|:
literal|4
decl_stmt|;
name|u_char
name|bca
range|:
literal|1
decl_stmt|;
name|u_int32_t
name|start_sector
decl_stmt|;
name|u_int32_t
name|end_sector
decl_stmt|;
name|u_int32_t
name|end_sector_l0
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|l_dvd_physical
block|{
name|u_char
name|type
decl_stmt|;
name|u_char
name|layer_num
decl_stmt|;
name|struct
name|l_dvd_layer
name|layer
index|[
literal|4
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|l_dvd_copyright
block|{
name|u_char
name|type
decl_stmt|;
name|u_char
name|layer_num
decl_stmt|;
name|u_char
name|cpst
decl_stmt|;
name|u_char
name|rmi
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|l_dvd_disckey
block|{
name|u_char
name|type
decl_stmt|;
name|l_uint
name|agid
range|:
literal|2
decl_stmt|;
name|u_char
name|value
index|[
literal|2048
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|l_dvd_bca
block|{
name|u_char
name|type
decl_stmt|;
name|l_int
name|len
decl_stmt|;
name|u_char
name|value
index|[
literal|188
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|l_dvd_manufact
block|{
name|u_char
name|type
decl_stmt|;
name|u_char
name|layer_num
decl_stmt|;
name|l_int
name|len
decl_stmt|;
name|u_char
name|value
index|[
literal|2048
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
union|union
block|{
name|u_char
name|type
decl_stmt|;
name|struct
name|l_dvd_physical
name|physical
decl_stmt|;
name|struct
name|l_dvd_copyright
name|copyright
decl_stmt|;
name|struct
name|l_dvd_disckey
name|disckey
decl_stmt|;
name|struct
name|l_dvd_bca
name|bca
decl_stmt|;
name|struct
name|l_dvd_manufact
name|manufact
decl_stmt|;
block|}
name|l_dvd_struct
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|u_char
name|l_dvd_key
index|[
literal|5
index|]
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|u_char
name|l_dvd_challenge
index|[
literal|10
index|]
typedef|;
end_typedef

begin_struct
struct|struct
name|l_dvd_lu_send_agid
block|{
name|u_char
name|type
decl_stmt|;
name|l_uint
name|agid
range|:
literal|2
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|l_dvd_host_send_challenge
block|{
name|u_char
name|type
decl_stmt|;
name|l_uint
name|agid
range|:
literal|2
decl_stmt|;
name|l_dvd_challenge
name|chal
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|l_dvd_send_key
block|{
name|u_char
name|type
decl_stmt|;
name|l_uint
name|agid
range|:
literal|2
decl_stmt|;
name|l_dvd_key
name|key
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|l_dvd_lu_send_challenge
block|{
name|u_char
name|type
decl_stmt|;
name|l_uint
name|agid
range|:
literal|2
decl_stmt|;
name|l_dvd_challenge
name|chal
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|l_dvd_lu_send_title_key
block|{
name|u_char
name|type
decl_stmt|;
name|l_uint
name|agid
range|:
literal|2
decl_stmt|;
name|l_dvd_key
name|title_key
decl_stmt|;
name|l_int
name|lba
decl_stmt|;
name|l_uint
name|cpm
range|:
literal|1
decl_stmt|;
name|l_uint
name|cp_sec
range|:
literal|1
decl_stmt|;
name|l_uint
name|cgms
range|:
literal|2
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|l_dvd_lu_send_asf
block|{
name|u_char
name|type
decl_stmt|;
name|l_uint
name|agid
range|:
literal|2
decl_stmt|;
name|l_uint
name|asf
range|:
literal|1
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|l_dvd_host_send_rpcstate
block|{
name|u_char
name|type
decl_stmt|;
name|u_char
name|pdrc
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|l_dvd_lu_send_rpcstate
block|{
name|u_char
name|type
range|:
literal|2
decl_stmt|;
name|u_char
name|vra
range|:
literal|3
decl_stmt|;
name|u_char
name|ucca
range|:
literal|3
decl_stmt|;
name|u_char
name|region_mask
decl_stmt|;
name|u_char
name|rpc_scheme
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
union|union
block|{
name|u_char
name|type
decl_stmt|;
name|struct
name|l_dvd_lu_send_agid
name|lsa
decl_stmt|;
name|struct
name|l_dvd_host_send_challenge
name|hsc
decl_stmt|;
name|struct
name|l_dvd_send_key
name|lsk
decl_stmt|;
name|struct
name|l_dvd_lu_send_challenge
name|lsc
decl_stmt|;
name|struct
name|l_dvd_send_key
name|hsk
decl_stmt|;
name|struct
name|l_dvd_lu_send_title_key
name|lstk
decl_stmt|;
name|struct
name|l_dvd_lu_send_asf
name|lsasf
decl_stmt|;
name|struct
name|l_dvd_host_send_rpcstate
name|hrpcs
decl_stmt|;
name|struct
name|l_dvd_lu_send_rpcstate
name|lrpcs
decl_stmt|;
block|}
name|l_dvd_authinfo
typedef|;
end_typedef

begin_function
specifier|static
name|void
name|bsd_to_linux_msf_lba
parameter_list|(
name|u_char
name|af
parameter_list|,
name|union
name|msf_lba
modifier|*
name|bp
parameter_list|,
name|union
name|linux_cdrom_addr
modifier|*
name|lp
parameter_list|)
block|{
if|if
condition|(
name|af
operator|==
name|CD_LBA_FORMAT
condition|)
name|lp
operator|->
name|lba
operator|=
name|bp
operator|->
name|lba
expr_stmt|;
else|else
block|{
name|lp
operator|->
name|msf
operator|.
name|minute
operator|=
name|bp
operator|->
name|msf
operator|.
name|minute
expr_stmt|;
name|lp
operator|->
name|msf
operator|.
name|second
operator|=
name|bp
operator|->
name|msf
operator|.
name|second
expr_stmt|;
name|lp
operator|->
name|msf
operator|.
name|frame
operator|=
name|bp
operator|->
name|msf
operator|.
name|frame
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|set_linux_cdrom_addr
parameter_list|(
name|union
name|linux_cdrom_addr
modifier|*
name|addr
parameter_list|,
name|int
name|format
parameter_list|,
name|int
name|lba
parameter_list|)
block|{
if|if
condition|(
name|format
operator|==
name|LINUX_CDROM_MSF
condition|)
block|{
name|addr
operator|->
name|msf
operator|.
name|frame
operator|=
name|lba
operator|%
literal|75
expr_stmt|;
name|lba
operator|/=
literal|75
expr_stmt|;
name|lba
operator|+=
literal|2
expr_stmt|;
name|addr
operator|->
name|msf
operator|.
name|second
operator|=
name|lba
operator|%
literal|60
expr_stmt|;
name|addr
operator|->
name|msf
operator|.
name|minute
operator|=
name|lba
operator|/
literal|60
expr_stmt|;
block|}
else|else
name|addr
operator|->
name|lba
operator|=
name|lba
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|linux_to_bsd_dvd_struct
parameter_list|(
name|l_dvd_struct
modifier|*
name|lp
parameter_list|,
name|struct
name|dvd_struct
modifier|*
name|bp
parameter_list|)
block|{
name|bp
operator|->
name|format
operator|=
name|lp
operator|->
name|type
expr_stmt|;
switch|switch
condition|(
name|bp
operator|->
name|format
condition|)
block|{
case|case
name|DVD_STRUCT_PHYSICAL
case|:
if|if
condition|(
name|bp
operator|->
name|layer_num
operator|>=
literal|4
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|bp
operator|->
name|layer_num
operator|=
name|lp
operator|->
name|physical
operator|.
name|layer_num
expr_stmt|;
break|break;
case|case
name|DVD_STRUCT_COPYRIGHT
case|:
name|bp
operator|->
name|layer_num
operator|=
name|lp
operator|->
name|copyright
operator|.
name|layer_num
expr_stmt|;
break|break;
case|case
name|DVD_STRUCT_DISCKEY
case|:
name|bp
operator|->
name|agid
operator|=
name|lp
operator|->
name|disckey
operator|.
name|agid
expr_stmt|;
break|break;
case|case
name|DVD_STRUCT_BCA
case|:
case|case
name|DVD_STRUCT_MANUFACT
case|:
break|break;
default|default:
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bsd_to_linux_dvd_struct
parameter_list|(
name|struct
name|dvd_struct
modifier|*
name|bp
parameter_list|,
name|l_dvd_struct
modifier|*
name|lp
parameter_list|)
block|{
switch|switch
condition|(
name|bp
operator|->
name|format
condition|)
block|{
case|case
name|DVD_STRUCT_PHYSICAL
case|:
block|{
name|struct
name|dvd_layer
modifier|*
name|blp
init|=
operator|(
expr|struct
name|dvd_layer
operator|*
operator|)
name|bp
operator|->
name|data
decl_stmt|;
name|struct
name|l_dvd_layer
modifier|*
name|llp
init|=
operator|&
name|lp
operator|->
name|physical
operator|.
name|layer
index|[
name|bp
operator|->
name|layer_num
index|]
decl_stmt|;
name|memset
argument_list|(
name|llp
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|llp
argument_list|)
argument_list|)
expr_stmt|;
name|llp
operator|->
name|book_version
operator|=
name|blp
operator|->
name|book_version
expr_stmt|;
name|llp
operator|->
name|book_type
operator|=
name|blp
operator|->
name|book_type
expr_stmt|;
name|llp
operator|->
name|min_rate
operator|=
name|blp
operator|->
name|max_rate
expr_stmt|;
name|llp
operator|->
name|disc_size
operator|=
name|blp
operator|->
name|disc_size
expr_stmt|;
name|llp
operator|->
name|layer_type
operator|=
name|blp
operator|->
name|layer_type
expr_stmt|;
name|llp
operator|->
name|track_path
operator|=
name|blp
operator|->
name|track_path
expr_stmt|;
name|llp
operator|->
name|nlayers
operator|=
name|blp
operator|->
name|nlayers
expr_stmt|;
name|llp
operator|->
name|track_density
operator|=
name|blp
operator|->
name|track_density
expr_stmt|;
name|llp
operator|->
name|linear_density
operator|=
name|blp
operator|->
name|linear_density
expr_stmt|;
name|llp
operator|->
name|bca
operator|=
name|blp
operator|->
name|bca
expr_stmt|;
name|llp
operator|->
name|start_sector
operator|=
name|blp
operator|->
name|start_sector
expr_stmt|;
name|llp
operator|->
name|end_sector
operator|=
name|blp
operator|->
name|end_sector
expr_stmt|;
name|llp
operator|->
name|end_sector_l0
operator|=
name|blp
operator|->
name|end_sector_l0
expr_stmt|;
break|break;
block|}
case|case
name|DVD_STRUCT_COPYRIGHT
case|:
name|lp
operator|->
name|copyright
operator|.
name|cpst
operator|=
name|bp
operator|->
name|cpst
expr_stmt|;
name|lp
operator|->
name|copyright
operator|.
name|rmi
operator|=
name|bp
operator|->
name|rmi
expr_stmt|;
break|break;
case|case
name|DVD_STRUCT_DISCKEY
case|:
name|memcpy
argument_list|(
name|lp
operator|->
name|disckey
operator|.
name|value
argument_list|,
name|bp
operator|->
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|lp
operator|->
name|disckey
operator|.
name|value
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|DVD_STRUCT_BCA
case|:
name|lp
operator|->
name|bca
operator|.
name|len
operator|=
name|bp
operator|->
name|length
expr_stmt|;
name|memcpy
argument_list|(
name|lp
operator|->
name|bca
operator|.
name|value
argument_list|,
name|bp
operator|->
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|lp
operator|->
name|bca
operator|.
name|value
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|DVD_STRUCT_MANUFACT
case|:
name|lp
operator|->
name|manufact
operator|.
name|len
operator|=
name|bp
operator|->
name|length
expr_stmt|;
name|memcpy
argument_list|(
name|lp
operator|->
name|manufact
operator|.
name|value
argument_list|,
name|bp
operator|->
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|lp
operator|->
name|manufact
operator|.
name|value
argument_list|)
argument_list|)
expr_stmt|;
comment|/* lp->manufact.layer_num is unused in linux (redhat 7.0) */
break|break;
default|default:
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|linux_to_bsd_dvd_authinfo
parameter_list|(
name|l_dvd_authinfo
modifier|*
name|lp
parameter_list|,
name|int
modifier|*
name|bcode
parameter_list|,
name|struct
name|dvd_authinfo
modifier|*
name|bp
parameter_list|)
block|{
switch|switch
condition|(
name|lp
operator|->
name|type
condition|)
block|{
case|case
name|LINUX_DVD_LU_SEND_AGID
case|:
operator|*
name|bcode
operator|=
name|DVDIOCREPORTKEY
expr_stmt|;
name|bp
operator|->
name|format
operator|=
name|DVD_REPORT_AGID
expr_stmt|;
name|bp
operator|->
name|agid
operator|=
name|lp
operator|->
name|lsa
operator|.
name|agid
expr_stmt|;
break|break;
case|case
name|LINUX_DVD_HOST_SEND_CHALLENGE
case|:
operator|*
name|bcode
operator|=
name|DVDIOCSENDKEY
expr_stmt|;
name|bp
operator|->
name|format
operator|=
name|DVD_SEND_CHALLENGE
expr_stmt|;
name|bp
operator|->
name|agid
operator|=
name|lp
operator|->
name|hsc
operator|.
name|agid
expr_stmt|;
name|memcpy
argument_list|(
name|bp
operator|->
name|keychal
argument_list|,
name|lp
operator|->
name|hsc
operator|.
name|chal
argument_list|,
literal|10
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINUX_DVD_LU_SEND_KEY1
case|:
operator|*
name|bcode
operator|=
name|DVDIOCREPORTKEY
expr_stmt|;
name|bp
operator|->
name|format
operator|=
name|DVD_REPORT_KEY1
expr_stmt|;
name|bp
operator|->
name|agid
operator|=
name|lp
operator|->
name|lsk
operator|.
name|agid
expr_stmt|;
break|break;
case|case
name|LINUX_DVD_LU_SEND_CHALLENGE
case|:
operator|*
name|bcode
operator|=
name|DVDIOCREPORTKEY
expr_stmt|;
name|bp
operator|->
name|format
operator|=
name|DVD_REPORT_CHALLENGE
expr_stmt|;
name|bp
operator|->
name|agid
operator|=
name|lp
operator|->
name|lsc
operator|.
name|agid
expr_stmt|;
break|break;
case|case
name|LINUX_DVD_HOST_SEND_KEY2
case|:
operator|*
name|bcode
operator|=
name|DVDIOCSENDKEY
expr_stmt|;
name|bp
operator|->
name|format
operator|=
name|DVD_SEND_KEY2
expr_stmt|;
name|bp
operator|->
name|agid
operator|=
name|lp
operator|->
name|hsk
operator|.
name|agid
expr_stmt|;
name|memcpy
argument_list|(
name|bp
operator|->
name|keychal
argument_list|,
name|lp
operator|->
name|hsk
operator|.
name|key
argument_list|,
literal|5
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINUX_DVD_LU_SEND_TITLE_KEY
case|:
operator|*
name|bcode
operator|=
name|DVDIOCREPORTKEY
expr_stmt|;
name|bp
operator|->
name|format
operator|=
name|DVD_REPORT_TITLE_KEY
expr_stmt|;
name|bp
operator|->
name|agid
operator|=
name|lp
operator|->
name|lstk
operator|.
name|agid
expr_stmt|;
name|bp
operator|->
name|lba
operator|=
name|lp
operator|->
name|lstk
operator|.
name|lba
expr_stmt|;
break|break;
case|case
name|LINUX_DVD_LU_SEND_ASF
case|:
operator|*
name|bcode
operator|=
name|DVDIOCREPORTKEY
expr_stmt|;
name|bp
operator|->
name|format
operator|=
name|DVD_REPORT_ASF
expr_stmt|;
name|bp
operator|->
name|agid
operator|=
name|lp
operator|->
name|lsasf
operator|.
name|agid
expr_stmt|;
break|break;
case|case
name|LINUX_DVD_INVALIDATE_AGID
case|:
operator|*
name|bcode
operator|=
name|DVDIOCREPORTKEY
expr_stmt|;
name|bp
operator|->
name|format
operator|=
name|DVD_INVALIDATE_AGID
expr_stmt|;
name|bp
operator|->
name|agid
operator|=
name|lp
operator|->
name|lsa
operator|.
name|agid
expr_stmt|;
break|break;
case|case
name|LINUX_DVD_LU_SEND_RPC_STATE
case|:
operator|*
name|bcode
operator|=
name|DVDIOCREPORTKEY
expr_stmt|;
name|bp
operator|->
name|format
operator|=
name|DVD_REPORT_RPC
expr_stmt|;
break|break;
case|case
name|LINUX_DVD_HOST_SEND_RPC_STATE
case|:
operator|*
name|bcode
operator|=
name|DVDIOCSENDKEY
expr_stmt|;
name|bp
operator|->
name|format
operator|=
name|DVD_SEND_RPC
expr_stmt|;
name|bp
operator|->
name|region
operator|=
name|lp
operator|->
name|hrpcs
operator|.
name|pdrc
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bsd_to_linux_dvd_authinfo
parameter_list|(
name|struct
name|dvd_authinfo
modifier|*
name|bp
parameter_list|,
name|l_dvd_authinfo
modifier|*
name|lp
parameter_list|)
block|{
switch|switch
condition|(
name|lp
operator|->
name|type
condition|)
block|{
case|case
name|LINUX_DVD_LU_SEND_AGID
case|:
name|lp
operator|->
name|lsa
operator|.
name|agid
operator|=
name|bp
operator|->
name|agid
expr_stmt|;
break|break;
case|case
name|LINUX_DVD_HOST_SEND_CHALLENGE
case|:
name|lp
operator|->
name|type
operator|=
name|LINUX_DVD_LU_SEND_KEY1
expr_stmt|;
break|break;
case|case
name|LINUX_DVD_LU_SEND_KEY1
case|:
name|memcpy
argument_list|(
name|lp
operator|->
name|lsk
operator|.
name|key
argument_list|,
name|bp
operator|->
name|keychal
argument_list|,
sizeof|sizeof
argument_list|(
name|lp
operator|->
name|lsk
operator|.
name|key
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINUX_DVD_LU_SEND_CHALLENGE
case|:
name|memcpy
argument_list|(
name|lp
operator|->
name|lsc
operator|.
name|chal
argument_list|,
name|bp
operator|->
name|keychal
argument_list|,
sizeof|sizeof
argument_list|(
name|lp
operator|->
name|lsc
operator|.
name|chal
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINUX_DVD_HOST_SEND_KEY2
case|:
name|lp
operator|->
name|type
operator|=
name|LINUX_DVD_AUTH_ESTABLISHED
expr_stmt|;
break|break;
case|case
name|LINUX_DVD_LU_SEND_TITLE_KEY
case|:
name|memcpy
argument_list|(
name|lp
operator|->
name|lstk
operator|.
name|title_key
argument_list|,
name|bp
operator|->
name|keychal
argument_list|,
sizeof|sizeof
argument_list|(
name|lp
operator|->
name|lstk
operator|.
name|title_key
argument_list|)
argument_list|)
expr_stmt|;
name|lp
operator|->
name|lstk
operator|.
name|cpm
operator|=
name|bp
operator|->
name|cpm
expr_stmt|;
name|lp
operator|->
name|lstk
operator|.
name|cp_sec
operator|=
name|bp
operator|->
name|cp_sec
expr_stmt|;
name|lp
operator|->
name|lstk
operator|.
name|cgms
operator|=
name|bp
operator|->
name|cgms
expr_stmt|;
break|break;
case|case
name|LINUX_DVD_LU_SEND_ASF
case|:
name|lp
operator|->
name|lsasf
operator|.
name|asf
operator|=
name|bp
operator|->
name|asf
expr_stmt|;
break|break;
case|case
name|LINUX_DVD_INVALIDATE_AGID
case|:
break|break;
case|case
name|LINUX_DVD_LU_SEND_RPC_STATE
case|:
name|lp
operator|->
name|lrpcs
operator|.
name|type
operator|=
name|bp
operator|->
name|reg_type
expr_stmt|;
name|lp
operator|->
name|lrpcs
operator|.
name|vra
operator|=
name|bp
operator|->
name|vend_rsts
expr_stmt|;
name|lp
operator|->
name|lrpcs
operator|.
name|ucca
operator|=
name|bp
operator|->
name|user_rsts
expr_stmt|;
name|lp
operator|->
name|lrpcs
operator|.
name|region_mask
operator|=
name|bp
operator|->
name|region
expr_stmt|;
name|lp
operator|->
name|lrpcs
operator|.
name|rpc_scheme
operator|=
name|bp
operator|->
name|rpc_scheme
expr_stmt|;
break|break;
case|case
name|LINUX_DVD_HOST_SEND_RPC_STATE
case|:
break|break;
default|default:
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|linux_ioctl_cdrom
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|struct
name|linux_ioctl_args
modifier|*
name|args
parameter_list|)
block|{
name|cap_rights_t
name|rights
decl_stmt|;
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|fget
argument_list|(
name|td
argument_list|,
name|args
operator|->
name|fd
argument_list|,
name|cap_rights_init
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_IOCTL
argument_list|)
argument_list|,
operator|&
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
switch|switch
condition|(
name|args
operator|->
name|cmd
operator|&
literal|0xffff
condition|)
block|{
case|case
name|LINUX_CDROMPAUSE
case|:
name|args
operator|->
name|cmd
operator|=
name|CDIOCPAUSE
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_CDROMRESUME
case|:
name|args
operator|->
name|cmd
operator|=
name|CDIOCRESUME
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_CDROMPLAYMSF
case|:
name|args
operator|->
name|cmd
operator|=
name|CDIOCPLAYMSF
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_CDROMPLAYTRKIND
case|:
name|args
operator|->
name|cmd
operator|=
name|CDIOCPLAYTRACKS
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_CDROMREADTOCHDR
case|:
block|{
name|struct
name|ioc_toc_header
name|th
decl_stmt|;
name|struct
name|linux_cdrom_tochdr
name|lth
decl_stmt|;
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|CDIOREADTOCHEADER
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|th
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|lth
operator|.
name|cdth_trk0
operator|=
name|th
operator|.
name|starting_track
expr_stmt|;
name|lth
operator|.
name|cdth_trk1
operator|=
name|th
operator|.
name|ending_track
expr_stmt|;
name|copyout
argument_list|(
operator|&
name|lth
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|lth
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|LINUX_CDROMREADTOCENTRY
case|:
block|{
name|struct
name|linux_cdrom_tocentry
name|lte
decl_stmt|;
name|struct
name|ioc_read_toc_single_entry
name|irtse
decl_stmt|;
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
operator|&
name|lte
argument_list|,
sizeof|sizeof
argument_list|(
name|lte
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|irtse
operator|.
name|address_format
operator|=
name|lte
operator|.
name|cdte_format
expr_stmt|;
name|irtse
operator|.
name|track
operator|=
name|lte
operator|.
name|cdte_track
expr_stmt|;
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|CDIOREADTOCENTRY
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|irtse
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|lte
operator|.
name|cdte_ctrl
operator|=
name|irtse
operator|.
name|entry
operator|.
name|control
expr_stmt|;
name|lte
operator|.
name|cdte_adr
operator|=
name|irtse
operator|.
name|entry
operator|.
name|addr_type
expr_stmt|;
name|bsd_to_linux_msf_lba
argument_list|(
name|irtse
operator|.
name|address_format
argument_list|,
operator|&
name|irtse
operator|.
name|entry
operator|.
name|addr
argument_list|,
operator|&
name|lte
operator|.
name|cdte_addr
argument_list|)
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|lte
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|lte
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|LINUX_CDROMSTOP
case|:
name|args
operator|->
name|cmd
operator|=
name|CDIOCSTOP
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_CDROMSTART
case|:
name|args
operator|->
name|cmd
operator|=
name|CDIOCSTART
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_CDROMEJECT
case|:
name|args
operator|->
name|cmd
operator|=
name|CDIOCEJECT
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
comment|/* LINUX_CDROMVOLCTRL */
case|case
name|LINUX_CDROMSUBCHNL
case|:
block|{
name|struct
name|linux_cdrom_subchnl
name|sc
decl_stmt|;
name|struct
name|ioc_read_subchannel
name|bsdsc
decl_stmt|;
name|struct
name|cd_sub_channel_info
name|bsdinfo
decl_stmt|;
name|bsdsc
operator|.
name|address_format
operator|=
name|CD_LBA_FORMAT
expr_stmt|;
name|bsdsc
operator|.
name|data_format
operator|=
name|CD_CURRENT_POSITION
expr_stmt|;
name|bsdsc
operator|.
name|track
operator|=
literal|0
expr_stmt|;
name|bsdsc
operator|.
name|data_len
operator|=
sizeof|sizeof
argument_list|(
name|bsdinfo
argument_list|)
expr_stmt|;
name|bsdsc
operator|.
name|data
operator|=
operator|&
name|bsdinfo
expr_stmt|;
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|CDIOCREADSUBCHANNEL_SYSSPACE
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bsdsc
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
operator|&
name|sc
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|sc
operator|.
name|cdsc_audiostatus
operator|=
name|bsdinfo
operator|.
name|header
operator|.
name|audio_status
expr_stmt|;
name|sc
operator|.
name|cdsc_adr
operator|=
name|bsdinfo
operator|.
name|what
operator|.
name|position
operator|.
name|addr_type
expr_stmt|;
name|sc
operator|.
name|cdsc_ctrl
operator|=
name|bsdinfo
operator|.
name|what
operator|.
name|position
operator|.
name|control
expr_stmt|;
name|sc
operator|.
name|cdsc_trk
operator|=
name|bsdinfo
operator|.
name|what
operator|.
name|position
operator|.
name|track_number
expr_stmt|;
name|sc
operator|.
name|cdsc_ind
operator|=
name|bsdinfo
operator|.
name|what
operator|.
name|position
operator|.
name|index_number
expr_stmt|;
name|set_linux_cdrom_addr
argument_list|(
operator|&
name|sc
operator|.
name|cdsc_absaddr
argument_list|,
name|sc
operator|.
name|cdsc_format
argument_list|,
name|bsdinfo
operator|.
name|what
operator|.
name|position
operator|.
name|absaddr
operator|.
name|lba
argument_list|)
expr_stmt|;
name|set_linux_cdrom_addr
argument_list|(
operator|&
name|sc
operator|.
name|cdsc_reladdr
argument_list|,
name|sc
operator|.
name|cdsc_format
argument_list|,
name|bsdinfo
operator|.
name|what
operator|.
name|position
operator|.
name|reladdr
operator|.
name|lba
argument_list|)
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|sc
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* LINUX_CDROMREADMODE2 */
comment|/* LINUX_CDROMREADMODE1 */
comment|/* LINUX_CDROMREADAUDIO */
comment|/* LINUX_CDROMEJECT_SW */
comment|/* LINUX_CDROMMULTISESSION */
comment|/* LINUX_CDROM_GET_UPC */
case|case
name|LINUX_CDROMRESET
case|:
name|args
operator|->
name|cmd
operator|=
name|CDIOCRESET
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
comment|/* LINUX_CDROMVOLREAD */
comment|/* LINUX_CDROMREADRAW */
comment|/* LINUX_CDROMREADCOOKED */
comment|/* LINUX_CDROMSEEK */
comment|/* LINUX_CDROMPLAYBLK */
comment|/* LINUX_CDROMREADALL */
comment|/* LINUX_CDROMCLOSETRAY */
comment|/* LINUX_CDROMLOADFROMSLOT */
comment|/* LINUX_CDROMGETSPINDOWN */
comment|/* LINUX_CDROMSETSPINDOWN */
comment|/* LINUX_CDROM_SET_OPTIONS */
comment|/* LINUX_CDROM_CLEAR_OPTIONS */
comment|/* LINUX_CDROM_SELECT_SPEED */
comment|/* LINUX_CDROM_SELECT_DISC */
comment|/* LINUX_CDROM_MEDIA_CHANGED */
comment|/* LINUX_CDROM_DRIVE_STATUS */
comment|/* LINUX_CDROM_DISC_STATUS */
comment|/* LINUX_CDROM_CHANGER_NSLOTS */
comment|/* LINUX_CDROM_LOCKDOOR */
comment|/* LINUX_CDROM_DEBUG */
comment|/* LINUX_CDROM_GET_CAPABILITY */
comment|/* LINUX_CDROMAUDIOBUFSIZ */
case|case
name|LINUX_DVD_READ_STRUCT
case|:
block|{
name|l_dvd_struct
modifier|*
name|lds
decl_stmt|;
name|struct
name|dvd_struct
modifier|*
name|bds
decl_stmt|;
name|lds
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|lds
argument_list|)
argument_list|,
name|M_LINUX
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|bds
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|bds
argument_list|)
argument_list|,
name|M_LINUX
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
name|lds
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|lds
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|out
goto|;
name|error
operator|=
name|linux_to_bsd_dvd_struct
argument_list|(
name|lds
argument_list|,
name|bds
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|out
goto|;
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|DVDIOCREADSTRUCTURE
argument_list|,
operator|(
name|caddr_t
operator|)
name|bds
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|out
goto|;
name|error
operator|=
name|bsd_to_linux_dvd_struct
argument_list|(
name|bds
argument_list|,
name|lds
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
goto|goto
name|out
goto|;
name|error
operator|=
name|copyout
argument_list|(
name|lds
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|lds
argument_list|)
argument_list|)
expr_stmt|;
name|out
label|:
name|free
argument_list|(
name|bds
argument_list|,
name|M_LINUX
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|lds
argument_list|,
name|M_LINUX
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* LINUX_DVD_WRITE_STRUCT */
case|case
name|LINUX_DVD_AUTH
case|:
block|{
name|l_dvd_authinfo
name|lda
decl_stmt|;
name|struct
name|dvd_authinfo
name|bda
decl_stmt|;
name|int
name|bcode
decl_stmt|;
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
operator|&
name|lda
argument_list|,
sizeof|sizeof
argument_list|(
name|lda
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|error
operator|=
name|linux_to_bsd_dvd_authinfo
argument_list|(
operator|&
name|lda
argument_list|,
operator|&
name|bcode
argument_list|,
operator|&
name|bda
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|bcode
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|bda
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
if|if
condition|(
name|lda
operator|.
name|type
operator|==
name|LINUX_DVD_HOST_SEND_KEY2
condition|)
block|{
name|lda
operator|.
name|type
operator|=
name|LINUX_DVD_AUTH_FAILURE
expr_stmt|;
name|copyout
argument_list|(
operator|&
name|lda
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|lda
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
name|error
operator|=
name|bsd_to_linux_dvd_authinfo
argument_list|(
operator|&
name|bda
argument_list|,
operator|&
name|lda
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
break|break;
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|lda
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|lda
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|LINUX_SCSI_GET_BUS_NUMBER
case|:
case|case
name|LINUX_SCSI_GET_IDLUN
case|:
name|error
operator|=
name|linux_ioctl_sg
argument_list|(
name|td
argument_list|,
name|args
argument_list|)
expr_stmt|;
break|break;
comment|/* LINUX_CDROM_SEND_PACKET */
comment|/* LINUX_CDROM_NEXT_WRITABLE */
comment|/* LINUX_CDROM_LAST_WRITTEN */
default|default:
name|error
operator|=
name|ENOIOCTL
expr_stmt|;
break|break;
block|}
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|linux_ioctl_vfat
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|struct
name|linux_ioctl_args
modifier|*
name|args
parameter_list|)
block|{
return|return
operator|(
name|ENOTTY
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Sound related ioctls  */
end_comment

begin_struct
struct|struct
name|linux_mixer_info
block|{
name|char
name|id
index|[
literal|16
index|]
decl_stmt|;
name|char
name|name
index|[
literal|32
index|]
decl_stmt|;
name|int
name|modify_counter
decl_stmt|;
name|int
name|fillers
index|[
literal|10
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|linux_old_mixer_info
block|{
name|char
name|id
index|[
literal|16
index|]
decl_stmt|;
name|char
name|name
index|[
literal|32
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|u_int32_t
name|dirbits
index|[
literal|4
index|]
init|=
block|{
name|IOC_VOID
block|,
name|IOC_IN
block|,
name|IOC_OUT
block|,
name|IOC_INOUT
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|SETDIR
parameter_list|(
name|c
parameter_list|)
value|(((c)& ~IOC_DIRMASK) | dirbits[args->cmd>> 30])
end_define

begin_function
specifier|static
name|int
name|linux_ioctl_sound
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|struct
name|linux_ioctl_args
modifier|*
name|args
parameter_list|)
block|{
switch|switch
condition|(
name|args
operator|->
name|cmd
operator|&
literal|0xffff
condition|)
block|{
case|case
name|LINUX_SOUND_MIXER_WRITE_VOLUME
case|:
name|args
operator|->
name|cmd
operator|=
name|SETDIR
argument_list|(
name|SOUND_MIXER_WRITE_VOLUME
argument_list|)
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SOUND_MIXER_WRITE_BASS
case|:
name|args
operator|->
name|cmd
operator|=
name|SETDIR
argument_list|(
name|SOUND_MIXER_WRITE_BASS
argument_list|)
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SOUND_MIXER_WRITE_TREBLE
case|:
name|args
operator|->
name|cmd
operator|=
name|SETDIR
argument_list|(
name|SOUND_MIXER_WRITE_TREBLE
argument_list|)
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SOUND_MIXER_WRITE_SYNTH
case|:
name|args
operator|->
name|cmd
operator|=
name|SETDIR
argument_list|(
name|SOUND_MIXER_WRITE_SYNTH
argument_list|)
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SOUND_MIXER_WRITE_PCM
case|:
name|args
operator|->
name|cmd
operator|=
name|SETDIR
argument_list|(
name|SOUND_MIXER_WRITE_PCM
argument_list|)
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SOUND_MIXER_WRITE_SPEAKER
case|:
name|args
operator|->
name|cmd
operator|=
name|SETDIR
argument_list|(
name|SOUND_MIXER_WRITE_SPEAKER
argument_list|)
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SOUND_MIXER_WRITE_LINE
case|:
name|args
operator|->
name|cmd
operator|=
name|SETDIR
argument_list|(
name|SOUND_MIXER_WRITE_LINE
argument_list|)
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SOUND_MIXER_WRITE_MIC
case|:
name|args
operator|->
name|cmd
operator|=
name|SETDIR
argument_list|(
name|SOUND_MIXER_WRITE_MIC
argument_list|)
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SOUND_MIXER_WRITE_CD
case|:
name|args
operator|->
name|cmd
operator|=
name|SETDIR
argument_list|(
name|SOUND_MIXER_WRITE_CD
argument_list|)
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SOUND_MIXER_WRITE_IMIX
case|:
name|args
operator|->
name|cmd
operator|=
name|SETDIR
argument_list|(
name|SOUND_MIXER_WRITE_IMIX
argument_list|)
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SOUND_MIXER_WRITE_ALTPCM
case|:
name|args
operator|->
name|cmd
operator|=
name|SETDIR
argument_list|(
name|SOUND_MIXER_WRITE_ALTPCM
argument_list|)
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SOUND_MIXER_WRITE_RECLEV
case|:
name|args
operator|->
name|cmd
operator|=
name|SETDIR
argument_list|(
name|SOUND_MIXER_WRITE_RECLEV
argument_list|)
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SOUND_MIXER_WRITE_IGAIN
case|:
name|args
operator|->
name|cmd
operator|=
name|SETDIR
argument_list|(
name|SOUND_MIXER_WRITE_IGAIN
argument_list|)
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SOUND_MIXER_WRITE_OGAIN
case|:
name|args
operator|->
name|cmd
operator|=
name|SETDIR
argument_list|(
name|SOUND_MIXER_WRITE_OGAIN
argument_list|)
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SOUND_MIXER_WRITE_LINE1
case|:
name|args
operator|->
name|cmd
operator|=
name|SETDIR
argument_list|(
name|SOUND_MIXER_WRITE_LINE1
argument_list|)
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SOUND_MIXER_WRITE_LINE2
case|:
name|args
operator|->
name|cmd
operator|=
name|SETDIR
argument_list|(
name|SOUND_MIXER_WRITE_LINE2
argument_list|)
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SOUND_MIXER_WRITE_LINE3
case|:
name|args
operator|->
name|cmd
operator|=
name|SETDIR
argument_list|(
name|SOUND_MIXER_WRITE_LINE3
argument_list|)
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SOUND_MIXER_INFO
case|:
block|{
comment|/* Key on encoded length */
switch|switch
condition|(
operator|(
name|args
operator|->
name|cmd
operator|>>
literal|16
operator|)
operator|&
literal|0x1fff
condition|)
block|{
case|case
literal|0x005c
case|:
block|{
comment|/* SOUND_MIXER_INFO */
name|struct
name|linux_mixer_info
name|info
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|info
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|info
operator|.
name|id
argument_list|,
literal|"OSS"
argument_list|,
sizeof|sizeof
argument_list|(
name|info
operator|.
name|id
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|info
operator|.
name|name
argument_list|,
literal|"FreeBSD OSS Mixer"
argument_list|,
sizeof|sizeof
argument_list|(
name|info
operator|.
name|name
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|copyout
argument_list|(
operator|&
name|info
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
case|case
literal|0x0030
case|:
block|{
comment|/* SOUND_OLD_MIXER_INFO */
name|struct
name|linux_old_mixer_info
name|info
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|info
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|info
operator|.
name|id
argument_list|,
literal|"OSS"
argument_list|,
sizeof|sizeof
argument_list|(
name|info
operator|.
name|id
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|info
operator|.
name|name
argument_list|,
literal|"FreeBSD OSS Mixer"
argument_list|,
sizeof|sizeof
argument_list|(
name|info
operator|.
name|name
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
name|copyout
argument_list|(
operator|&
name|info
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
default|default:
return|return
operator|(
name|ENOIOCTL
operator|)
return|;
block|}
break|break;
block|}
case|case
name|LINUX_OSS_GETVERSION
case|:
block|{
name|int
name|version
init|=
name|linux_get_oss_version
argument_list|(
name|td
argument_list|)
decl_stmt|;
return|return
operator|(
name|copyout
argument_list|(
operator|&
name|version
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
operator|)
return|;
block|}
case|case
name|LINUX_SOUND_MIXER_READ_STEREODEVS
case|:
name|args
operator|->
name|cmd
operator|=
name|SOUND_MIXER_READ_STEREODEVS
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SOUND_MIXER_READ_CAPS
case|:
name|args
operator|->
name|cmd
operator|=
name|SOUND_MIXER_READ_CAPS
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SOUND_MIXER_READ_RECMASK
case|:
name|args
operator|->
name|cmd
operator|=
name|SOUND_MIXER_READ_RECMASK
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SOUND_MIXER_READ_DEVMASK
case|:
name|args
operator|->
name|cmd
operator|=
name|SOUND_MIXER_READ_DEVMASK
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SOUND_MIXER_WRITE_RECSRC
case|:
name|args
operator|->
name|cmd
operator|=
name|SETDIR
argument_list|(
name|SOUND_MIXER_WRITE_RECSRC
argument_list|)
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_DSP_RESET
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_DSP_RESET
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_DSP_SYNC
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_DSP_SYNC
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_DSP_SPEED
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_DSP_SPEED
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_DSP_STEREO
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_DSP_STEREO
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_DSP_GETBLKSIZE
case|:
comment|/* LINUX_SNDCTL_DSP_SETBLKSIZE */
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_DSP_GETBLKSIZE
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_DSP_SETFMT
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_DSP_SETFMT
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SOUND_PCM_WRITE_CHANNELS
case|:
name|args
operator|->
name|cmd
operator|=
name|SOUND_PCM_WRITE_CHANNELS
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SOUND_PCM_WRITE_FILTER
case|:
name|args
operator|->
name|cmd
operator|=
name|SOUND_PCM_WRITE_FILTER
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_DSP_POST
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_DSP_POST
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_DSP_SUBDIVIDE
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_DSP_SUBDIVIDE
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_DSP_SETFRAGMENT
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_DSP_SETFRAGMENT
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_DSP_GETFMTS
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_DSP_GETFMTS
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_DSP_GETOSPACE
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_DSP_GETOSPACE
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_DSP_GETISPACE
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_DSP_GETISPACE
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_DSP_NONBLOCK
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_DSP_NONBLOCK
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_DSP_GETCAPS
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_DSP_GETCAPS
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_DSP_SETTRIGGER
case|:
comment|/* LINUX_SNDCTL_GETTRIGGER */
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_DSP_SETTRIGGER
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_DSP_GETIPTR
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_DSP_GETIPTR
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_DSP_GETOPTR
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_DSP_GETOPTR
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_DSP_SETDUPLEX
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_DSP_SETDUPLEX
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_DSP_GETODELAY
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_DSP_GETODELAY
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_SEQ_RESET
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_SEQ_RESET
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_SEQ_SYNC
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_SEQ_SYNC
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_SYNTH_INFO
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_SYNTH_INFO
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_SEQ_CTRLRATE
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_SEQ_CTRLRATE
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_SEQ_GETOUTCOUNT
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_SEQ_GETOUTCOUNT
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_SEQ_GETINCOUNT
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_SEQ_GETINCOUNT
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_SEQ_PERCMODE
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_SEQ_PERCMODE
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_FM_LOAD_INSTR
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_FM_LOAD_INSTR
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_SEQ_TESTMIDI
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_SEQ_TESTMIDI
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_SEQ_RESETSAMPLES
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_SEQ_RESETSAMPLES
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_SEQ_NRSYNTHS
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_SEQ_NRSYNTHS
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_SEQ_NRMIDIS
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_SEQ_NRMIDIS
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_MIDI_INFO
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_MIDI_INFO
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_SEQ_TRESHOLD
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_SEQ_TRESHOLD
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
case|case
name|LINUX_SNDCTL_SYNTH_MEMAVL
case|:
name|args
operator|->
name|cmd
operator|=
name|SNDCTL_SYNTH_MEMAVL
expr_stmt|;
return|return
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
return|;
block|}
return|return
operator|(
name|ENOIOCTL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Console related ioctls  */
end_comment

begin_define
define|#
directive|define
name|ISSIGVALID
parameter_list|(
name|sig
parameter_list|)
value|((sig)> 0&& (sig)< NSIG)
end_define

begin_function
specifier|static
name|int
name|linux_ioctl_console
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|struct
name|linux_ioctl_args
modifier|*
name|args
parameter_list|)
block|{
name|cap_rights_t
name|rights
decl_stmt|;
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|fget
argument_list|(
name|td
argument_list|,
name|args
operator|->
name|fd
argument_list|,
name|cap_rights_init
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_IOCTL
argument_list|)
argument_list|,
operator|&
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
switch|switch
condition|(
name|args
operator|->
name|cmd
operator|&
literal|0xffff
condition|)
block|{
case|case
name|LINUX_KIOCSOUND
case|:
name|args
operator|->
name|cmd
operator|=
name|KIOCSOUND
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_KDMKTONE
case|:
name|args
operator|->
name|cmd
operator|=
name|KDMKTONE
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_KDGETLED
case|:
name|args
operator|->
name|cmd
operator|=
name|KDGETLED
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_KDSETLED
case|:
name|args
operator|->
name|cmd
operator|=
name|KDSETLED
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_KDSETMODE
case|:
name|args
operator|->
name|cmd
operator|=
name|KDSETMODE
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_KDGETMODE
case|:
name|args
operator|->
name|cmd
operator|=
name|KDGETMODE
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_KDGKBMODE
case|:
name|args
operator|->
name|cmd
operator|=
name|KDGKBMODE
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_KDSKBMODE
case|:
block|{
name|int
name|kbdmode
decl_stmt|;
switch|switch
condition|(
name|args
operator|->
name|arg
condition|)
block|{
case|case
name|LINUX_KBD_RAW
case|:
name|kbdmode
operator|=
name|K_RAW
expr_stmt|;
break|break;
case|case
name|LINUX_KBD_XLATE
case|:
name|kbdmode
operator|=
name|K_XLATE
expr_stmt|;
break|break;
case|case
name|LINUX_KBD_MEDIUMRAW
case|:
name|kbdmode
operator|=
name|K_RAW
expr_stmt|;
break|break;
default|default:
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|error
operator|=
operator|(
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|KDSKBMODE
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|kbdmode
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
operator|)
expr_stmt|;
break|break;
block|}
case|case
name|LINUX_VT_OPENQRY
case|:
name|args
operator|->
name|cmd
operator|=
name|VT_OPENQRY
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_VT_GETMODE
case|:
name|args
operator|->
name|cmd
operator|=
name|VT_GETMODE
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_VT_SETMODE
case|:
block|{
name|struct
name|vt_mode
name|mode
decl_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
operator|&
name|mode
argument_list|,
sizeof|sizeof
argument_list|(
name|mode
argument_list|)
argument_list|)
operator|)
condition|)
break|break;
if|if
condition|(
operator|!
name|ISSIGVALID
argument_list|(
name|mode
operator|.
name|frsig
argument_list|)
operator|&&
name|ISSIGVALID
argument_list|(
name|mode
operator|.
name|acqsig
argument_list|)
condition|)
name|mode
operator|.
name|frsig
operator|=
name|mode
operator|.
name|acqsig
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|mode
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|mode
argument_list|)
argument_list|)
operator|)
condition|)
break|break;
name|args
operator|->
name|cmd
operator|=
name|VT_SETMODE
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
block|}
case|case
name|LINUX_VT_GETSTATE
case|:
name|args
operator|->
name|cmd
operator|=
name|VT_GETACTIVE
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_VT_RELDISP
case|:
name|args
operator|->
name|cmd
operator|=
name|VT_RELDISP
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_VT_ACTIVATE
case|:
name|args
operator|->
name|cmd
operator|=
name|VT_ACTIVATE
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|LINUX_VT_WAITACTIVE
case|:
name|args
operator|->
name|cmd
operator|=
name|VT_WAITACTIVE
expr_stmt|;
name|error
operator|=
operator|(
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
operator|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|ENOIOCTL
expr_stmt|;
break|break;
block|}
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Criteria for interface name translation  */
end_comment

begin_define
define|#
directive|define
name|IFP_IS_ETH
parameter_list|(
name|ifp
parameter_list|)
value|(ifp->if_type == IFT_ETHER)
end_define

begin_comment
comment|/*  * Interface function used by linprocfs (at the time of writing). It's not  * used by the Linuxulator itself.  */
end_comment

begin_function
name|int
name|linux_ifname
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|char
modifier|*
name|buffer
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifscan
decl_stmt|;
name|int
name|ethno
decl_stmt|;
name|IFNET_RLOCK_ASSERT
argument_list|()
expr_stmt|;
comment|/* Short-circuit non ethernet interfaces */
if|if
condition|(
operator|!
name|IFP_IS_ETH
argument_list|(
name|ifp
argument_list|)
condition|)
return|return
operator|(
name|strlcpy
argument_list|(
name|buffer
argument_list|,
name|ifp
operator|->
name|if_xname
argument_list|,
name|buflen
argument_list|)
operator|)
return|;
comment|/* Determine the (relative) unit number for ethernet interfaces */
name|ethno
operator|=
literal|0
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|ifscan
argument_list|,
argument|&V_ifnet
argument_list|,
argument|if_link
argument_list|)
block|{
if|if
condition|(
name|ifscan
operator|==
name|ifp
condition|)
return|return
operator|(
name|snprintf
argument_list|(
name|buffer
argument_list|,
name|buflen
argument_list|,
literal|"eth%d"
argument_list|,
name|ethno
argument_list|)
operator|)
return|;
if|if
condition|(
name|IFP_IS_ETH
argument_list|(
name|ifscan
argument_list|)
condition|)
name|ethno
operator|++
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Translate a Linux interface name to a FreeBSD interface name,  * and return the associated ifnet structure  * bsdname and lxname need to be least IFNAMSIZ bytes long, but  * can point to the same buffer.  */
end_comment

begin_function
specifier|static
name|struct
name|ifnet
modifier|*
name|ifname_linux_to_bsd
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
specifier|const
name|char
modifier|*
name|lxname
parameter_list|,
name|char
modifier|*
name|bsdname
parameter_list|)
block|{
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|int
name|len
decl_stmt|,
name|unit
decl_stmt|;
name|char
modifier|*
name|ep
decl_stmt|;
name|int
name|is_eth
decl_stmt|,
name|index
decl_stmt|;
for|for
control|(
name|len
operator|=
literal|0
init|;
name|len
operator|<
name|LINUX_IFNAMSIZ
condition|;
operator|++
name|len
control|)
if|if
condition|(
operator|!
name|isalpha
argument_list|(
name|lxname
index|[
name|len
index|]
argument_list|)
condition|)
break|break;
if|if
condition|(
name|len
operator|==
literal|0
operator|||
name|len
operator|==
name|LINUX_IFNAMSIZ
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|unit
operator|=
operator|(
name|int
operator|)
name|strtoul
argument_list|(
name|lxname
operator|+
name|len
argument_list|,
operator|&
name|ep
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|ep
operator|==
name|NULL
operator|||
name|ep
operator|==
name|lxname
operator|+
name|len
operator|||
name|ep
operator|>=
name|lxname
operator|+
name|LINUX_IFNAMSIZ
condition|)
return|return
operator|(
name|NULL
operator|)
return|;
name|index
operator|=
literal|0
expr_stmt|;
name|is_eth
operator|=
operator|(
name|len
operator|==
literal|3
operator|&&
operator|!
name|strncmp
argument_list|(
name|lxname
argument_list|,
literal|"eth"
argument_list|,
name|len
argument_list|)
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|CURVNET_SET
argument_list|(
name|TD_TO_VNET
argument_list|(
name|td
argument_list|)
argument_list|)
expr_stmt|;
name|IFNET_RLOCK
argument_list|()
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|ifp
argument_list|,
argument|&V_ifnet
argument_list|,
argument|if_link
argument_list|)
block|{
comment|/* 		 * Allow Linux programs to use FreeBSD names. Don't presume 		 * we never have an interface named "eth", so don't make 		 * the test optional based on is_eth. 		 */
if|if
condition|(
name|strncmp
argument_list|(
name|ifp
operator|->
name|if_xname
argument_list|,
name|lxname
argument_list|,
name|LINUX_IFNAMSIZ
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|is_eth
operator|&&
name|IFP_IS_ETH
argument_list|(
name|ifp
argument_list|)
operator|&&
name|unit
operator|==
name|index
operator|++
condition|)
break|break;
block|}
name|IFNET_RUNLOCK
argument_list|()
expr_stmt|;
name|CURVNET_RESTORE
argument_list|()
expr_stmt|;
if|if
condition|(
name|ifp
operator|!=
name|NULL
condition|)
name|strlcpy
argument_list|(
name|bsdname
argument_list|,
name|ifp
operator|->
name|if_xname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
return|return
operator|(
name|ifp
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Implement the SIOCGIFCONF ioctl  */
end_comment

begin_function
specifier|static
name|int
name|linux_ifconf
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|struct
name|ifconf
modifier|*
name|uifc
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|COMPAT_LINUX32
name|struct
name|l_ifconf
name|ifc
decl_stmt|;
else|#
directive|else
name|struct
name|ifconf
name|ifc
decl_stmt|;
endif|#
directive|endif
name|struct
name|l_ifreq
name|ifr
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|ifaddr
modifier|*
name|ifa
decl_stmt|;
name|struct
name|sbuf
modifier|*
name|sb
decl_stmt|;
name|int
name|error
decl_stmt|,
name|ethno
decl_stmt|,
name|full
init|=
literal|0
decl_stmt|,
name|valid_len
decl_stmt|,
name|max_len
decl_stmt|;
name|error
operator|=
name|copyin
argument_list|(
name|uifc
argument_list|,
operator|&
name|ifc
argument_list|,
sizeof|sizeof
argument_list|(
name|ifc
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|max_len
operator|=
name|MAXPHYS
operator|-
literal|1
expr_stmt|;
name|CURVNET_SET
argument_list|(
name|TD_TO_VNET
argument_list|(
name|td
argument_list|)
argument_list|)
expr_stmt|;
comment|/* handle the 'request buffer size' case */
if|if
condition|(
operator|(
name|l_uintptr_t
operator|)
name|ifc
operator|.
name|ifc_buf
operator|==
name|PTROUT
argument_list|(
name|NULL
argument_list|)
condition|)
block|{
name|ifc
operator|.
name|ifc_len
operator|=
literal|0
expr_stmt|;
name|IFNET_RLOCK
argument_list|()
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|ifp
argument_list|,
argument|&V_ifnet
argument_list|,
argument|if_link
argument_list|)
block|{
name|TAILQ_FOREACH
argument_list|(
argument|ifa
argument_list|,
argument|&ifp->if_addrhead
argument_list|,
argument|ifa_link
argument_list|)
block|{
name|struct
name|sockaddr
modifier|*
name|sa
init|=
name|ifa
operator|->
name|ifa_addr
decl_stmt|;
if|if
condition|(
name|sa
operator|->
name|sa_family
operator|==
name|AF_INET
condition|)
name|ifc
operator|.
name|ifc_len
operator|+=
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
expr_stmt|;
block|}
block|}
name|IFNET_RUNLOCK
argument_list|()
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|ifc
argument_list|,
name|uifc
argument_list|,
sizeof|sizeof
argument_list|(
name|ifc
argument_list|)
argument_list|)
expr_stmt|;
name|CURVNET_RESTORE
argument_list|()
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
if|if
condition|(
name|ifc
operator|.
name|ifc_len
operator|<=
literal|0
condition|)
block|{
name|CURVNET_RESTORE
argument_list|()
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
name|again
label|:
comment|/* Keep track of eth interfaces */
name|ethno
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ifc
operator|.
name|ifc_len
operator|<=
name|max_len
condition|)
block|{
name|max_len
operator|=
name|ifc
operator|.
name|ifc_len
expr_stmt|;
name|full
operator|=
literal|1
expr_stmt|;
block|}
name|sb
operator|=
name|sbuf_new
argument_list|(
name|NULL
argument_list|,
name|NULL
argument_list|,
name|max_len
operator|+
literal|1
argument_list|,
name|SBUF_FIXEDLEN
argument_list|)
expr_stmt|;
name|max_len
operator|=
literal|0
expr_stmt|;
name|valid_len
operator|=
literal|0
expr_stmt|;
comment|/* Return all AF_INET addresses of all interfaces */
name|IFNET_RLOCK
argument_list|()
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|ifp
argument_list|,
argument|&V_ifnet
argument_list|,
argument|if_link
argument_list|)
block|{
name|int
name|addrs
init|=
literal|0
decl_stmt|;
name|bzero
argument_list|(
operator|&
name|ifr
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|IFP_IS_ETH
argument_list|(
name|ifp
argument_list|)
condition|)
name|snprintf
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|LINUX_IFNAMSIZ
argument_list|,
literal|"eth%d"
argument_list|,
name|ethno
operator|++
argument_list|)
expr_stmt|;
else|else
name|strlcpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|ifp
operator|->
name|if_xname
argument_list|,
name|LINUX_IFNAMSIZ
argument_list|)
expr_stmt|;
comment|/* Walk the address list */
name|TAILQ_FOREACH
argument_list|(
argument|ifa
argument_list|,
argument|&ifp->if_addrhead
argument_list|,
argument|ifa_link
argument_list|)
block|{
name|struct
name|sockaddr
modifier|*
name|sa
init|=
name|ifa
operator|->
name|ifa_addr
decl_stmt|;
if|if
condition|(
name|sa
operator|->
name|sa_family
operator|==
name|AF_INET
condition|)
block|{
name|ifr
operator|.
name|ifr_addr
operator|.
name|sa_family
operator|=
name|LINUX_AF_INET
expr_stmt|;
name|memcpy
argument_list|(
name|ifr
operator|.
name|ifr_addr
operator|.
name|sa_data
argument_list|,
name|sa
operator|->
name|sa_data
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
operator|.
name|ifr_addr
operator|.
name|sa_data
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_bcat
argument_list|(
name|sb
argument_list|,
operator|&
name|ifr
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
expr_stmt|;
name|max_len
operator|+=
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
expr_stmt|;
name|addrs
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|sbuf_error
argument_list|(
name|sb
argument_list|)
operator|==
literal|0
condition|)
name|valid_len
operator|=
name|sbuf_len
argument_list|(
name|sb
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|addrs
operator|==
literal|0
condition|)
block|{
name|bzero
argument_list|(
operator|(
name|caddr_t
operator|)
operator|&
name|ifr
operator|.
name|ifr_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
operator|.
name|ifr_addr
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_bcat
argument_list|(
name|sb
argument_list|,
operator|&
name|ifr
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
expr_stmt|;
name|max_len
operator|+=
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sbuf_error
argument_list|(
name|sb
argument_list|)
operator|==
literal|0
condition|)
name|valid_len
operator|=
name|sbuf_len
argument_list|(
name|sb
argument_list|)
expr_stmt|;
block|}
block|}
name|IFNET_RUNLOCK
argument_list|()
expr_stmt|;
if|if
condition|(
name|valid_len
operator|!=
name|max_len
operator|&&
operator|!
name|full
condition|)
block|{
name|sbuf_delete
argument_list|(
name|sb
argument_list|)
expr_stmt|;
goto|goto
name|again
goto|;
block|}
name|ifc
operator|.
name|ifc_len
operator|=
name|valid_len
expr_stmt|;
name|sbuf_finish
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
name|sbuf_data
argument_list|(
name|sb
argument_list|)
argument_list|,
name|PTRIN
argument_list|(
name|ifc
operator|.
name|ifc_buf
argument_list|)
argument_list|,
name|ifc
operator|.
name|ifc_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|ifc
argument_list|,
name|uifc
argument_list|,
sizeof|sizeof
argument_list|(
name|ifc
argument_list|)
argument_list|)
expr_stmt|;
name|sbuf_delete
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|CURVNET_RESTORE
argument_list|()
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|linux_gifflags
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|l_ifreq
modifier|*
name|ifr
parameter_list|)
block|{
name|l_short
name|flags
decl_stmt|;
name|flags
operator|=
operator|(
name|ifp
operator|->
name|if_flags
operator||
name|ifp
operator|->
name|if_drv_flags
operator|)
operator|&
literal|0xffff
expr_stmt|;
comment|/* these flags have no Linux equivalent */
name|flags
operator|&=
operator|~
operator|(
name|IFF_DRV_OACTIVE
operator||
name|IFF_SIMPLEX
operator||
name|IFF_LINK0
operator||
name|IFF_LINK1
operator||
name|IFF_LINK2
operator|)
expr_stmt|;
comment|/* Linux' multicast flag is in a different bit */
if|if
condition|(
name|flags
operator|&
name|IFF_MULTICAST
condition|)
block|{
name|flags
operator|&=
operator|~
name|IFF_MULTICAST
expr_stmt|;
name|flags
operator||=
literal|0x1000
expr_stmt|;
block|}
return|return
operator|(
name|copyout
argument_list|(
operator|&
name|flags
argument_list|,
operator|&
name|ifr
operator|->
name|ifr_flags
argument_list|,
sizeof|sizeof
argument_list|(
name|flags
argument_list|)
argument_list|)
operator|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|ARPHRD_ETHER
value|1
end_define

begin_define
define|#
directive|define
name|ARPHRD_LOOPBACK
value|772
end_define

begin_function
specifier|static
name|int
name|linux_gifhwaddr
parameter_list|(
name|struct
name|ifnet
modifier|*
name|ifp
parameter_list|,
name|struct
name|l_ifreq
modifier|*
name|ifr
parameter_list|)
block|{
name|struct
name|ifaddr
modifier|*
name|ifa
decl_stmt|;
name|struct
name|sockaddr_dl
modifier|*
name|sdl
decl_stmt|;
name|struct
name|l_sockaddr
name|lsa
decl_stmt|;
if|if
condition|(
name|ifp
operator|->
name|if_type
operator|==
name|IFT_LOOP
condition|)
block|{
name|bzero
argument_list|(
operator|&
name|lsa
argument_list|,
sizeof|sizeof
argument_list|(
name|lsa
argument_list|)
argument_list|)
expr_stmt|;
name|lsa
operator|.
name|sa_family
operator|=
name|ARPHRD_LOOPBACK
expr_stmt|;
return|return
operator|(
name|copyout
argument_list|(
operator|&
name|lsa
argument_list|,
operator|&
name|ifr
operator|->
name|ifr_hwaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|lsa
argument_list|)
argument_list|)
operator|)
return|;
block|}
if|if
condition|(
name|ifp
operator|->
name|if_type
operator|!=
name|IFT_ETHER
condition|)
return|return
operator|(
name|ENOENT
operator|)
return|;
name|TAILQ_FOREACH
argument_list|(
argument|ifa
argument_list|,
argument|&ifp->if_addrhead
argument_list|,
argument|ifa_link
argument_list|)
block|{
name|sdl
operator|=
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
name|ifa
operator|->
name|ifa_addr
expr_stmt|;
if|if
condition|(
name|sdl
operator|!=
name|NULL
operator|&&
operator|(
name|sdl
operator|->
name|sdl_family
operator|==
name|AF_LINK
operator|)
operator|&&
operator|(
name|sdl
operator|->
name|sdl_type
operator|==
name|IFT_ETHER
operator|)
condition|)
block|{
name|bzero
argument_list|(
operator|&
name|lsa
argument_list|,
sizeof|sizeof
argument_list|(
name|lsa
argument_list|)
argument_list|)
expr_stmt|;
name|lsa
operator|.
name|sa_family
operator|=
name|ARPHRD_ETHER
expr_stmt|;
name|bcopy
argument_list|(
name|LLADDR
argument_list|(
name|sdl
argument_list|)
argument_list|,
name|lsa
operator|.
name|sa_data
argument_list|,
name|LINUX_IFHWADDRLEN
argument_list|)
expr_stmt|;
return|return
operator|(
name|copyout
argument_list|(
operator|&
name|lsa
argument_list|,
operator|&
name|ifr
operator|->
name|ifr_hwaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|lsa
argument_list|)
argument_list|)
operator|)
return|;
block|}
block|}
return|return
operator|(
name|ENOENT
operator|)
return|;
block|}
end_function

begin_comment
comment|/* * If we fault in bsd_to_linux_ifreq() then we will fault when we call * the native ioctl().  Thus, we don't really need to check the return * value of this function. */
end_comment

begin_function
specifier|static
name|int
name|bsd_to_linux_ifreq
parameter_list|(
name|struct
name|ifreq
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|ifreq
name|ifr
decl_stmt|;
name|size_t
name|ifr_len
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|ifreq
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|arg
argument_list|,
operator|&
name|ifr
argument_list|,
name|ifr_len
argument_list|)
operator|)
condition|)
return|return
operator|(
name|error
operator|)
return|;
operator|*
operator|(
name|u_short
operator|*
operator|)
operator|&
name|ifr
operator|.
name|ifr_addr
operator|=
name|ifr
operator|.
name|ifr_addr
operator|.
name|sa_family
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|ifr
argument_list|,
name|arg
argument_list|,
name|ifr_len
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Socket related ioctls  */
end_comment

begin_function
specifier|static
name|int
name|linux_ioctl_socket
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|struct
name|linux_ioctl_args
modifier|*
name|args
parameter_list|)
block|{
name|char
name|lifname
index|[
name|LINUX_IFNAMSIZ
index|]
decl_stmt|,
name|ifname
index|[
name|IFNAMSIZ
index|]
decl_stmt|;
name|cap_rights_t
name|rights
decl_stmt|;
name|struct
name|ifnet
modifier|*
name|ifp
decl_stmt|;
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|int
name|error
decl_stmt|,
name|type
decl_stmt|;
name|ifp
operator|=
name|NULL
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|fget
argument_list|(
name|td
argument_list|,
name|args
operator|->
name|fd
argument_list|,
name|cap_rights_init
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_IOCTL
argument_list|)
argument_list|,
operator|&
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|type
operator|=
name|fp
operator|->
name|f_type
expr_stmt|;
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|!=
name|DTYPE_SOCKET
condition|)
block|{
comment|/* not a socket - probably a tap / vmnet device */
switch|switch
condition|(
name|args
operator|->
name|cmd
condition|)
block|{
case|case
name|LINUX_SIOCGIFADDR
case|:
case|case
name|LINUX_SIOCSIFADDR
case|:
case|case
name|LINUX_SIOCGIFFLAGS
case|:
return|return
operator|(
name|linux_ioctl_special
argument_list|(
name|td
argument_list|,
name|args
argument_list|)
operator|)
return|;
default|default:
return|return
operator|(
name|ENOIOCTL
operator|)
return|;
block|}
block|}
switch|switch
condition|(
name|args
operator|->
name|cmd
operator|&
literal|0xffff
condition|)
block|{
case|case
name|LINUX_FIOGETOWN
case|:
case|case
name|LINUX_FIOSETOWN
case|:
case|case
name|LINUX_SIOCADDMULTI
case|:
case|case
name|LINUX_SIOCATMARK
case|:
case|case
name|LINUX_SIOCDELMULTI
case|:
case|case
name|LINUX_SIOCGIFCONF
case|:
case|case
name|LINUX_SIOCGPGRP
case|:
case|case
name|LINUX_SIOCSPGRP
case|:
case|case
name|LINUX_SIOCGIFCOUNT
case|:
comment|/* these ioctls don't take an interface name */
ifdef|#
directive|ifdef
name|DEBUG
name|printf
argument_list|(
literal|"%s(): ioctl %d\n"
argument_list|,
name|__func__
argument_list|,
name|args
operator|->
name|cmd
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|LINUX_SIOCGIFFLAGS
case|:
case|case
name|LINUX_SIOCGIFADDR
case|:
case|case
name|LINUX_SIOCSIFADDR
case|:
case|case
name|LINUX_SIOCGIFDSTADDR
case|:
case|case
name|LINUX_SIOCGIFBRDADDR
case|:
case|case
name|LINUX_SIOCGIFNETMASK
case|:
case|case
name|LINUX_SIOCSIFNETMASK
case|:
case|case
name|LINUX_SIOCGIFMTU
case|:
case|case
name|LINUX_SIOCSIFMTU
case|:
case|case
name|LINUX_SIOCSIFNAME
case|:
case|case
name|LINUX_SIOCGIFHWADDR
case|:
case|case
name|LINUX_SIOCSIFHWADDR
case|:
case|case
name|LINUX_SIOCDEVPRIVATE
case|:
case|case
name|LINUX_SIOCDEVPRIVATE
operator|+
literal|1
case|:
case|case
name|LINUX_SIOCGIFINDEX
case|:
comment|/* copy in the interface name and translate it. */
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
name|lifname
argument_list|,
name|LINUX_IFNAMSIZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
ifdef|#
directive|ifdef
name|DEBUG
name|printf
argument_list|(
literal|"%s(): ioctl %d on %.*s\n"
argument_list|,
name|__func__
argument_list|,
name|args
operator|->
name|cmd
operator|&
literal|0xffff
argument_list|,
name|LINUX_IFNAMSIZ
argument_list|,
name|lifname
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|ifp
operator|=
name|ifname_linux_to_bsd
argument_list|(
name|td
argument_list|,
name|lifname
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifp
operator|==
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
comment|/* 		 * We need to copy it back out in case we pass the 		 * request on to our native ioctl(), which will expect 		 * the ifreq to be in user space and have the correct 		 * interface name. 		 */
name|error
operator|=
name|copyout
argument_list|(
name|ifname
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
ifdef|#
directive|ifdef
name|DEBUG
name|printf
argument_list|(
literal|"%s(): %s translated to %s\n"
argument_list|,
name|__func__
argument_list|,
name|lifname
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
endif|#
directive|endif
break|break;
default|default:
return|return
operator|(
name|ENOIOCTL
operator|)
return|;
block|}
switch|switch
condition|(
name|args
operator|->
name|cmd
operator|&
literal|0xffff
condition|)
block|{
case|case
name|LINUX_FIOSETOWN
case|:
name|args
operator|->
name|cmd
operator|=
name|FIOSETOWN
expr_stmt|;
name|error
operator|=
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINUX_SIOCSPGRP
case|:
name|args
operator|->
name|cmd
operator|=
name|SIOCSPGRP
expr_stmt|;
name|error
operator|=
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINUX_FIOGETOWN
case|:
name|args
operator|->
name|cmd
operator|=
name|FIOGETOWN
expr_stmt|;
name|error
operator|=
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINUX_SIOCGPGRP
case|:
name|args
operator|->
name|cmd
operator|=
name|SIOCGPGRP
expr_stmt|;
name|error
operator|=
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINUX_SIOCATMARK
case|:
name|args
operator|->
name|cmd
operator|=
name|SIOCATMARK
expr_stmt|;
name|error
operator|=
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
expr_stmt|;
break|break;
comment|/* LINUX_SIOCGSTAMP */
case|case
name|LINUX_SIOCGIFCONF
case|:
name|error
operator|=
name|linux_ifconf
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ifconf
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINUX_SIOCGIFFLAGS
case|:
name|args
operator|->
name|cmd
operator|=
name|SIOCGIFFLAGS
expr_stmt|;
name|error
operator|=
name|linux_gifflags
argument_list|(
name|td
argument_list|,
name|ifp
argument_list|,
operator|(
expr|struct
name|l_ifreq
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINUX_SIOCGIFADDR
case|:
name|args
operator|->
name|cmd
operator|=
name|SIOCGIFADDR
expr_stmt|;
name|error
operator|=
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
expr_stmt|;
name|bsd_to_linux_ifreq
argument_list|(
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINUX_SIOCSIFADDR
case|:
comment|/* XXX probably doesn't work, included for completeness */
name|args
operator|->
name|cmd
operator|=
name|SIOCSIFADDR
expr_stmt|;
name|error
operator|=
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINUX_SIOCGIFDSTADDR
case|:
name|args
operator|->
name|cmd
operator|=
name|SIOCGIFDSTADDR
expr_stmt|;
name|error
operator|=
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
expr_stmt|;
name|bsd_to_linux_ifreq
argument_list|(
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINUX_SIOCGIFBRDADDR
case|:
name|args
operator|->
name|cmd
operator|=
name|SIOCGIFBRDADDR
expr_stmt|;
name|error
operator|=
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
expr_stmt|;
name|bsd_to_linux_ifreq
argument_list|(
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINUX_SIOCGIFNETMASK
case|:
name|args
operator|->
name|cmd
operator|=
name|SIOCGIFNETMASK
expr_stmt|;
name|error
operator|=
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
expr_stmt|;
name|bsd_to_linux_ifreq
argument_list|(
operator|(
expr|struct
name|ifreq
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINUX_SIOCSIFNETMASK
case|:
name|error
operator|=
name|ENOIOCTL
expr_stmt|;
break|break;
case|case
name|LINUX_SIOCGIFMTU
case|:
name|args
operator|->
name|cmd
operator|=
name|SIOCGIFMTU
expr_stmt|;
name|error
operator|=
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINUX_SIOCSIFMTU
case|:
name|args
operator|->
name|cmd
operator|=
name|SIOCSIFMTU
expr_stmt|;
name|error
operator|=
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINUX_SIOCSIFNAME
case|:
name|error
operator|=
name|ENOIOCTL
expr_stmt|;
break|break;
case|case
name|LINUX_SIOCGIFHWADDR
case|:
name|error
operator|=
name|linux_gifhwaddr
argument_list|(
name|ifp
argument_list|,
operator|(
expr|struct
name|l_ifreq
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINUX_SIOCSIFHWADDR
case|:
name|error
operator|=
name|ENOIOCTL
expr_stmt|;
break|break;
case|case
name|LINUX_SIOCADDMULTI
case|:
name|args
operator|->
name|cmd
operator|=
name|SIOCADDMULTI
expr_stmt|;
name|error
operator|=
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINUX_SIOCDELMULTI
case|:
name|args
operator|->
name|cmd
operator|=
name|SIOCDELMULTI
expr_stmt|;
name|error
operator|=
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINUX_SIOCGIFINDEX
case|:
name|args
operator|->
name|cmd
operator|=
name|SIOCGIFINDEX
expr_stmt|;
name|error
operator|=
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINUX_SIOCGIFCOUNT
case|:
name|error
operator|=
literal|0
expr_stmt|;
break|break;
comment|/* 	 * XXX This is slightly bogus, but these ioctls are currently 	 * XXX only used by the aironet (if_an) network driver. 	 */
case|case
name|LINUX_SIOCDEVPRIVATE
case|:
name|args
operator|->
name|cmd
operator|=
name|SIOCGPRIVATE_0
expr_stmt|;
name|error
operator|=
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINUX_SIOCDEVPRIVATE
operator|+
literal|1
case|:
name|args
operator|->
name|cmd
operator|=
name|SIOCGPRIVATE_1
expr_stmt|;
name|error
operator|=
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ifp
operator|!=
name|NULL
condition|)
comment|/* restore the original interface name */
name|copyout
argument_list|(
name|lifname
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
name|LINUX_IFNAMSIZ
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
name|printf
argument_list|(
literal|"%s(): returning %d\n"
argument_list|,
name|__func__
argument_list|,
name|error
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Device private ioctl handler  */
end_comment

begin_function
specifier|static
name|int
name|linux_ioctl_private
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|struct
name|linux_ioctl_args
modifier|*
name|args
parameter_list|)
block|{
name|cap_rights_t
name|rights
decl_stmt|;
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|int
name|error
decl_stmt|,
name|type
decl_stmt|;
name|error
operator|=
name|fget
argument_list|(
name|td
argument_list|,
name|args
operator|->
name|fd
argument_list|,
name|cap_rights_init
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_IOCTL
argument_list|)
argument_list|,
operator|&
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|type
operator|=
name|fp
operator|->
name|f_type
expr_stmt|;
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|DTYPE_SOCKET
condition|)
return|return
operator|(
name|linux_ioctl_socket
argument_list|(
name|td
argument_list|,
name|args
argument_list|)
operator|)
return|;
return|return
operator|(
name|ENOIOCTL
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * DRM ioctl handler (sys/dev/drm)  */
end_comment

begin_function
specifier|static
name|int
name|linux_ioctl_drm
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|struct
name|linux_ioctl_args
modifier|*
name|args
parameter_list|)
block|{
name|args
operator|->
name|cmd
operator|=
name|SETDIR
argument_list|(
name|args
operator|->
name|cmd
argument_list|)
expr_stmt|;
return|return
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|linux_ioctl_sg
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|struct
name|linux_ioctl_args
modifier|*
name|args
parameter_list|)
block|{
name|cap_rights_t
name|rights
decl_stmt|;
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|u_long
name|cmd
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|fget
argument_list|(
name|td
argument_list|,
name|args
operator|->
name|fd
argument_list|,
name|cap_rights_init
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_IOCTL
argument_list|)
argument_list|,
operator|&
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"sg_linux_ioctl: fget returned %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|cmd
operator|=
name|args
operator|->
name|cmd
expr_stmt|;
name|error
operator|=
operator|(
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|cmd
argument_list|,
operator|(
name|caddr_t
operator|)
name|args
operator|->
name|arg
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
operator|)
expr_stmt|;
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Video4Linux (V4L) ioctl handler  */
end_comment

begin_function
specifier|static
name|int
name|linux_to_bsd_v4l_tuner
parameter_list|(
name|struct
name|l_video_tuner
modifier|*
name|lvt
parameter_list|,
name|struct
name|video_tuner
modifier|*
name|vt
parameter_list|)
block|{
name|vt
operator|->
name|tuner
operator|=
name|lvt
operator|->
name|tuner
expr_stmt|;
name|strlcpy
argument_list|(
name|vt
operator|->
name|name
argument_list|,
name|lvt
operator|->
name|name
argument_list|,
name|LINUX_VIDEO_TUNER_NAME_SIZE
argument_list|)
expr_stmt|;
name|vt
operator|->
name|rangelow
operator|=
name|lvt
operator|->
name|rangelow
expr_stmt|;
comment|/* possible long size conversion */
name|vt
operator|->
name|rangehigh
operator|=
name|lvt
operator|->
name|rangehigh
expr_stmt|;
comment|/* possible long size conversion */
name|vt
operator|->
name|flags
operator|=
name|lvt
operator|->
name|flags
expr_stmt|;
name|vt
operator|->
name|mode
operator|=
name|lvt
operator|->
name|mode
expr_stmt|;
name|vt
operator|->
name|signal
operator|=
name|lvt
operator|->
name|signal
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bsd_to_linux_v4l_tuner
parameter_list|(
name|struct
name|video_tuner
modifier|*
name|vt
parameter_list|,
name|struct
name|l_video_tuner
modifier|*
name|lvt
parameter_list|)
block|{
name|lvt
operator|->
name|tuner
operator|=
name|vt
operator|->
name|tuner
expr_stmt|;
name|strlcpy
argument_list|(
name|lvt
operator|->
name|name
argument_list|,
name|vt
operator|->
name|name
argument_list|,
name|LINUX_VIDEO_TUNER_NAME_SIZE
argument_list|)
expr_stmt|;
name|lvt
operator|->
name|rangelow
operator|=
name|vt
operator|->
name|rangelow
expr_stmt|;
comment|/* possible long size conversion */
name|lvt
operator|->
name|rangehigh
operator|=
name|vt
operator|->
name|rangehigh
expr_stmt|;
comment|/* possible long size conversion */
name|lvt
operator|->
name|flags
operator|=
name|vt
operator|->
name|flags
expr_stmt|;
name|lvt
operator|->
name|mode
operator|=
name|vt
operator|->
name|mode
expr_stmt|;
name|lvt
operator|->
name|signal
operator|=
name|vt
operator|->
name|signal
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|COMPAT_LINUX_V4L_CLIPLIST
end_ifdef

begin_function
specifier|static
name|int
name|linux_to_bsd_v4l_clip
parameter_list|(
name|struct
name|l_video_clip
modifier|*
name|lvc
parameter_list|,
name|struct
name|video_clip
modifier|*
name|vc
parameter_list|)
block|{
name|vc
operator|->
name|x
operator|=
name|lvc
operator|->
name|x
expr_stmt|;
name|vc
operator|->
name|y
operator|=
name|lvc
operator|->
name|y
expr_stmt|;
name|vc
operator|->
name|width
operator|=
name|lvc
operator|->
name|width
expr_stmt|;
name|vc
operator|->
name|height
operator|=
name|lvc
operator|->
name|height
expr_stmt|;
name|vc
operator|->
name|next
operator|=
name|PTRIN
argument_list|(
name|lvc
operator|->
name|next
argument_list|)
expr_stmt|;
comment|/* possible pointer size conversion */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|linux_to_bsd_v4l_window
parameter_list|(
name|struct
name|l_video_window
modifier|*
name|lvw
parameter_list|,
name|struct
name|video_window
modifier|*
name|vw
parameter_list|)
block|{
name|vw
operator|->
name|x
operator|=
name|lvw
operator|->
name|x
expr_stmt|;
name|vw
operator|->
name|y
operator|=
name|lvw
operator|->
name|y
expr_stmt|;
name|vw
operator|->
name|width
operator|=
name|lvw
operator|->
name|width
expr_stmt|;
name|vw
operator|->
name|height
operator|=
name|lvw
operator|->
name|height
expr_stmt|;
name|vw
operator|->
name|chromakey
operator|=
name|lvw
operator|->
name|chromakey
expr_stmt|;
name|vw
operator|->
name|flags
operator|=
name|lvw
operator|->
name|flags
expr_stmt|;
name|vw
operator|->
name|clips
operator|=
name|PTRIN
argument_list|(
name|lvw
operator|->
name|clips
argument_list|)
expr_stmt|;
comment|/* possible pointer size conversion */
name|vw
operator|->
name|clipcount
operator|=
name|lvw
operator|->
name|clipcount
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bsd_to_linux_v4l_window
parameter_list|(
name|struct
name|video_window
modifier|*
name|vw
parameter_list|,
name|struct
name|l_video_window
modifier|*
name|lvw
parameter_list|)
block|{
name|lvw
operator|->
name|x
operator|=
name|vw
operator|->
name|x
expr_stmt|;
name|lvw
operator|->
name|y
operator|=
name|vw
operator|->
name|y
expr_stmt|;
name|lvw
operator|->
name|width
operator|=
name|vw
operator|->
name|width
expr_stmt|;
name|lvw
operator|->
name|height
operator|=
name|vw
operator|->
name|height
expr_stmt|;
name|lvw
operator|->
name|chromakey
operator|=
name|vw
operator|->
name|chromakey
expr_stmt|;
name|lvw
operator|->
name|flags
operator|=
name|vw
operator|->
name|flags
expr_stmt|;
name|lvw
operator|->
name|clips
operator|=
name|PTROUT
argument_list|(
name|vw
operator|->
name|clips
argument_list|)
expr_stmt|;
comment|/* possible pointer size conversion */
name|lvw
operator|->
name|clipcount
operator|=
name|vw
operator|->
name|clipcount
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|linux_to_bsd_v4l_buffer
parameter_list|(
name|struct
name|l_video_buffer
modifier|*
name|lvb
parameter_list|,
name|struct
name|video_buffer
modifier|*
name|vb
parameter_list|)
block|{
name|vb
operator|->
name|base
operator|=
name|PTRIN
argument_list|(
name|lvb
operator|->
name|base
argument_list|)
expr_stmt|;
comment|/* possible pointer size conversion */
name|vb
operator|->
name|height
operator|=
name|lvb
operator|->
name|height
expr_stmt|;
name|vb
operator|->
name|width
operator|=
name|lvb
operator|->
name|width
expr_stmt|;
name|vb
operator|->
name|depth
operator|=
name|lvb
operator|->
name|depth
expr_stmt|;
name|vb
operator|->
name|bytesperline
operator|=
name|lvb
operator|->
name|bytesperline
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bsd_to_linux_v4l_buffer
parameter_list|(
name|struct
name|video_buffer
modifier|*
name|vb
parameter_list|,
name|struct
name|l_video_buffer
modifier|*
name|lvb
parameter_list|)
block|{
name|lvb
operator|->
name|base
operator|=
name|PTROUT
argument_list|(
name|vb
operator|->
name|base
argument_list|)
expr_stmt|;
comment|/* possible pointer size conversion */
name|lvb
operator|->
name|height
operator|=
name|vb
operator|->
name|height
expr_stmt|;
name|lvb
operator|->
name|width
operator|=
name|vb
operator|->
name|width
expr_stmt|;
name|lvb
operator|->
name|depth
operator|=
name|vb
operator|->
name|depth
expr_stmt|;
name|lvb
operator|->
name|bytesperline
operator|=
name|vb
operator|->
name|bytesperline
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|linux_to_bsd_v4l_code
parameter_list|(
name|struct
name|l_video_code
modifier|*
name|lvc
parameter_list|,
name|struct
name|video_code
modifier|*
name|vc
parameter_list|)
block|{
name|strlcpy
argument_list|(
name|vc
operator|->
name|loadwhat
argument_list|,
name|lvc
operator|->
name|loadwhat
argument_list|,
name|LINUX_VIDEO_CODE_LOADWHAT_SIZE
argument_list|)
expr_stmt|;
name|vc
operator|->
name|datasize
operator|=
name|lvc
operator|->
name|datasize
expr_stmt|;
name|vc
operator|->
name|data
operator|=
name|PTRIN
argument_list|(
name|lvc
operator|->
name|data
argument_list|)
expr_stmt|;
comment|/* possible pointer size conversion */
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|COMPAT_LINUX_V4L_CLIPLIST
end_ifdef

begin_function
specifier|static
name|int
name|linux_v4l_clip_copy
parameter_list|(
name|void
modifier|*
name|lvc
parameter_list|,
name|struct
name|video_clip
modifier|*
modifier|*
name|ppvc
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|struct
name|video_clip
name|vclip
decl_stmt|;
name|struct
name|l_video_clip
name|l_vclip
decl_stmt|;
name|error
operator|=
name|copyin
argument_list|(
name|lvc
argument_list|,
operator|&
name|l_vclip
argument_list|,
sizeof|sizeof
argument_list|(
name|l_vclip
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|linux_to_bsd_v4l_clip
argument_list|(
operator|&
name|l_vclip
argument_list|,
operator|&
name|vclip
argument_list|)
expr_stmt|;
comment|/* XXX: If there can be no concurrency: s/M_NOWAIT/M_WAITOK/ */
if|if
condition|(
operator|(
operator|*
name|ppvc
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
operator|*
name|ppvc
argument_list|)
argument_list|,
name|M_LINUX
argument_list|,
name|M_NOWAIT
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|ENOMEM
operator|)
return|;
comment|/* XXX: linux has no ENOMEM here */
name|memcpy
argument_list|(
operator|*
name|ppvc
argument_list|,
operator|&
name|vclip
argument_list|,
sizeof|sizeof
argument_list|(
name|vclip
argument_list|)
argument_list|)
expr_stmt|;
operator|(
operator|*
name|ppvc
operator|)
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|linux_v4l_cliplist_free
parameter_list|(
name|struct
name|video_window
modifier|*
name|vw
parameter_list|)
block|{
name|struct
name|video_clip
modifier|*
modifier|*
name|ppvc
decl_stmt|;
name|struct
name|video_clip
modifier|*
modifier|*
name|ppvc_next
decl_stmt|;
for|for
control|(
name|ppvc
operator|=
operator|&
operator|(
name|vw
operator|->
name|clips
operator|)
init|;
operator|*
name|ppvc
operator|!=
name|NULL
condition|;
name|ppvc
operator|=
name|ppvc_next
control|)
block|{
name|ppvc_next
operator|=
operator|&
operator|(
operator|(
operator|*
name|ppvc
operator|)
operator|->
name|next
operator|)
expr_stmt|;
name|free
argument_list|(
operator|*
name|ppvc
argument_list|,
name|M_LINUX
argument_list|)
expr_stmt|;
block|}
name|vw
operator|->
name|clips
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|linux_v4l_cliplist_copy
parameter_list|(
name|struct
name|l_video_window
modifier|*
name|lvw
parameter_list|,
name|struct
name|video_window
modifier|*
name|vw
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|int
name|clipcount
decl_stmt|;
name|void
modifier|*
name|plvc
decl_stmt|;
name|struct
name|video_clip
modifier|*
modifier|*
name|ppvc
decl_stmt|;
comment|/* 	 * XXX: The cliplist is used to pass in a list of clipping 	 *	rectangles or, if clipcount == VIDEO_CLIP_BITMAP, a 	 *	clipping bitmap.  Some Linux apps, however, appear to 	 *	leave cliplist and clips uninitialized.  In any case, 	 *	the cliplist is not used by pwc(4), at the time of 	 *	writing, FreeBSD's only V4L driver.  When a driver 	 *	that uses the cliplist is developed, this code may 	 *	need re-examiniation. 	 */
name|error
operator|=
literal|0
expr_stmt|;
name|clipcount
operator|=
name|vw
operator|->
name|clipcount
expr_stmt|;
if|if
condition|(
name|clipcount
operator|==
name|VIDEO_CLIP_BITMAP
condition|)
block|{
comment|/* 		 * In this case, the pointer (clips) is overloaded 		 * to be a "void *" to a bitmap, therefore there 		 * is no struct video_clip to copy now. 		 */
block|}
elseif|else
if|if
condition|(
name|clipcount
operator|>
literal|0
operator|&&
name|clipcount
operator|<=
literal|16384
condition|)
block|{
comment|/* 		 * Clips points to list of clip rectangles, so 		 * copy the list. 		 * 		 * XXX: Upper limit of 16384 was used here to try to 		 *	avoid cases when clipcount and clips pointer 		 *	are uninitialized and therefore have high random 		 *	values, as is the case in the Linux Skype 		 *	application.  The value 16384 was chosen as that 		 *	is what is used in the Linux stradis(4) MPEG 		 *	decoder driver, the only place we found an 		 *	example of cliplist use. 		 */
name|plvc
operator|=
name|PTRIN
argument_list|(
name|lvw
operator|->
name|clips
argument_list|)
expr_stmt|;
name|vw
operator|->
name|clips
operator|=
name|NULL
expr_stmt|;
name|ppvc
operator|=
operator|&
operator|(
name|vw
operator|->
name|clips
operator|)
expr_stmt|;
while|while
condition|(
name|clipcount
operator|--
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|plvc
operator|==
literal|0
condition|)
block|{
name|error
operator|=
name|EFAULT
expr_stmt|;
break|break;
block|}
else|else
block|{
name|error
operator|=
name|linux_v4l_clip_copy
argument_list|(
name|plvc
argument_list|,
name|ppvc
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|linux_v4l_cliplist_free
argument_list|(
name|vw
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|ppvc
operator|=
operator|&
operator|(
operator|(
operator|*
name|ppvc
operator|)
operator|->
name|next
operator|)
expr_stmt|;
name|plvc
operator|=
name|PTRIN
argument_list|(
operator|(
operator|(
expr|struct
name|l_video_clip
operator|*
operator|)
name|plvc
operator|)
operator|->
name|next
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* 		 * clipcount == 0 or negative (but not VIDEO_CLIP_BITMAP) 		 * Force cliplist to null. 		 */
name|vw
operator|->
name|clipcount
operator|=
literal|0
expr_stmt|;
name|vw
operator|->
name|clips
operator|=
name|NULL
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|linux_ioctl_v4l
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|struct
name|linux_ioctl_args
modifier|*
name|args
parameter_list|)
block|{
name|cap_rights_t
name|rights
decl_stmt|;
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|struct
name|video_tuner
name|vtun
decl_stmt|;
name|struct
name|video_window
name|vwin
decl_stmt|;
name|struct
name|video_buffer
name|vbuf
decl_stmt|;
name|struct
name|video_code
name|vcode
decl_stmt|;
name|struct
name|l_video_tuner
name|l_vtun
decl_stmt|;
name|struct
name|l_video_window
name|l_vwin
decl_stmt|;
name|struct
name|l_video_buffer
name|l_vbuf
decl_stmt|;
name|struct
name|l_video_code
name|l_vcode
decl_stmt|;
switch|switch
condition|(
name|args
operator|->
name|cmd
operator|&
literal|0xffff
condition|)
block|{
case|case
name|LINUX_VIDIOCGCAP
case|:
name|args
operator|->
name|cmd
operator|=
name|VIDIOCGCAP
expr_stmt|;
break|break;
case|case
name|LINUX_VIDIOCGCHAN
case|:
name|args
operator|->
name|cmd
operator|=
name|VIDIOCGCHAN
expr_stmt|;
break|break;
case|case
name|LINUX_VIDIOCSCHAN
case|:
name|args
operator|->
name|cmd
operator|=
name|VIDIOCSCHAN
expr_stmt|;
break|break;
case|case
name|LINUX_VIDIOCGTUNER
case|:
name|error
operator|=
name|fget
argument_list|(
name|td
argument_list|,
name|args
operator|->
name|fd
argument_list|,
name|cap_rights_init
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_IOCTL
argument_list|)
argument_list|,
operator|&
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
operator|&
name|l_vtun
argument_list|,
sizeof|sizeof
argument_list|(
name|l_vtun
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|linux_to_bsd_v4l_tuner
argument_list|(
operator|&
name|l_vtun
argument_list|,
operator|&
name|vtun
argument_list|)
expr_stmt|;
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|VIDIOCGTUNER
argument_list|,
operator|&
name|vtun
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|bsd_to_linux_v4l_tuner
argument_list|(
operator|&
name|vtun
argument_list|,
operator|&
name|l_vtun
argument_list|)
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|l_vtun
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|l_vtun
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
case|case
name|LINUX_VIDIOCSTUNER
case|:
name|error
operator|=
name|fget
argument_list|(
name|td
argument_list|,
name|args
operator|->
name|fd
argument_list|,
name|cap_rights_init
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_IOCTL
argument_list|)
argument_list|,
operator|&
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
operator|&
name|l_vtun
argument_list|,
sizeof|sizeof
argument_list|(
name|l_vtun
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|linux_to_bsd_v4l_tuner
argument_list|(
operator|&
name|l_vtun
argument_list|,
operator|&
name|vtun
argument_list|)
expr_stmt|;
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|VIDIOCSTUNER
argument_list|,
operator|&
name|vtun
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
case|case
name|LINUX_VIDIOCGPICT
case|:
name|args
operator|->
name|cmd
operator|=
name|VIDIOCGPICT
expr_stmt|;
break|break;
case|case
name|LINUX_VIDIOCSPICT
case|:
name|args
operator|->
name|cmd
operator|=
name|VIDIOCSPICT
expr_stmt|;
break|break;
case|case
name|LINUX_VIDIOCCAPTURE
case|:
name|args
operator|->
name|cmd
operator|=
name|VIDIOCCAPTURE
expr_stmt|;
break|break;
case|case
name|LINUX_VIDIOCGWIN
case|:
name|error
operator|=
name|fget
argument_list|(
name|td
argument_list|,
name|args
operator|->
name|fd
argument_list|,
name|cap_rights_init
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_IOCTL
argument_list|)
argument_list|,
operator|&
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|VIDIOCGWIN
argument_list|,
operator|&
name|vwin
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|bsd_to_linux_v4l_window
argument_list|(
operator|&
name|vwin
argument_list|,
operator|&
name|l_vwin
argument_list|)
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|l_vwin
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|l_vwin
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
case|case
name|LINUX_VIDIOCSWIN
case|:
name|error
operator|=
name|fget
argument_list|(
name|td
argument_list|,
name|args
operator|->
name|fd
argument_list|,
name|cap_rights_init
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_IOCTL
argument_list|)
argument_list|,
operator|&
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
operator|&
name|l_vwin
argument_list|,
sizeof|sizeof
argument_list|(
name|l_vwin
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|linux_to_bsd_v4l_window
argument_list|(
operator|&
name|l_vwin
argument_list|,
operator|&
name|vwin
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|COMPAT_LINUX_V4L_CLIPLIST
name|error
operator|=
name|linux_v4l_cliplist_copy
argument_list|(
operator|&
name|l_vwin
argument_list|,
operator|&
name|vwin
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
endif|#
directive|endif
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|VIDIOCSWIN
argument_list|,
operator|&
name|vwin
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|COMPAT_LINUX_V4L_CLIPLIST
name|linux_v4l_cliplist_free
argument_list|(
operator|&
name|vwin
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
operator|(
name|error
operator|)
return|;
case|case
name|LINUX_VIDIOCGFBUF
case|:
name|error
operator|=
name|fget
argument_list|(
name|td
argument_list|,
name|args
operator|->
name|fd
argument_list|,
name|cap_rights_init
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_IOCTL
argument_list|)
argument_list|,
operator|&
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|VIDIOCGFBUF
argument_list|,
operator|&
name|vbuf
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|error
condition|)
block|{
name|bsd_to_linux_v4l_buffer
argument_list|(
operator|&
name|vbuf
argument_list|,
operator|&
name|l_vbuf
argument_list|)
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|l_vbuf
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|l_vbuf
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
case|case
name|LINUX_VIDIOCSFBUF
case|:
name|error
operator|=
name|fget
argument_list|(
name|td
argument_list|,
name|args
operator|->
name|fd
argument_list|,
name|cap_rights_init
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_IOCTL
argument_list|)
argument_list|,
operator|&
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
operator|&
name|l_vbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|l_vbuf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|linux_to_bsd_v4l_buffer
argument_list|(
operator|&
name|l_vbuf
argument_list|,
operator|&
name|vbuf
argument_list|)
expr_stmt|;
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|VIDIOCSFBUF
argument_list|,
operator|&
name|vbuf
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
case|case
name|LINUX_VIDIOCKEY
case|:
name|args
operator|->
name|cmd
operator|=
name|VIDIOCKEY
expr_stmt|;
break|break;
case|case
name|LINUX_VIDIOCGFREQ
case|:
name|args
operator|->
name|cmd
operator|=
name|VIDIOCGFREQ
expr_stmt|;
break|break;
case|case
name|LINUX_VIDIOCSFREQ
case|:
name|args
operator|->
name|cmd
operator|=
name|VIDIOCSFREQ
expr_stmt|;
break|break;
case|case
name|LINUX_VIDIOCGAUDIO
case|:
name|args
operator|->
name|cmd
operator|=
name|VIDIOCGAUDIO
expr_stmt|;
break|break;
case|case
name|LINUX_VIDIOCSAUDIO
case|:
name|args
operator|->
name|cmd
operator|=
name|VIDIOCSAUDIO
expr_stmt|;
break|break;
case|case
name|LINUX_VIDIOCSYNC
case|:
name|args
operator|->
name|cmd
operator|=
name|VIDIOCSYNC
expr_stmt|;
break|break;
case|case
name|LINUX_VIDIOCMCAPTURE
case|:
name|args
operator|->
name|cmd
operator|=
name|VIDIOCMCAPTURE
expr_stmt|;
break|break;
case|case
name|LINUX_VIDIOCGMBUF
case|:
name|args
operator|->
name|cmd
operator|=
name|VIDIOCGMBUF
expr_stmt|;
break|break;
case|case
name|LINUX_VIDIOCGUNIT
case|:
name|args
operator|->
name|cmd
operator|=
name|VIDIOCGUNIT
expr_stmt|;
break|break;
case|case
name|LINUX_VIDIOCGCAPTURE
case|:
name|args
operator|->
name|cmd
operator|=
name|VIDIOCGCAPTURE
expr_stmt|;
break|break;
case|case
name|LINUX_VIDIOCSCAPTURE
case|:
name|args
operator|->
name|cmd
operator|=
name|VIDIOCSCAPTURE
expr_stmt|;
break|break;
case|case
name|LINUX_VIDIOCSPLAYMODE
case|:
name|args
operator|->
name|cmd
operator|=
name|VIDIOCSPLAYMODE
expr_stmt|;
break|break;
case|case
name|LINUX_VIDIOCSWRITEMODE
case|:
name|args
operator|->
name|cmd
operator|=
name|VIDIOCSWRITEMODE
expr_stmt|;
break|break;
case|case
name|LINUX_VIDIOCGPLAYINFO
case|:
name|args
operator|->
name|cmd
operator|=
name|VIDIOCGPLAYINFO
expr_stmt|;
break|break;
case|case
name|LINUX_VIDIOCSMICROCODE
case|:
name|error
operator|=
name|fget
argument_list|(
name|td
argument_list|,
name|args
operator|->
name|fd
argument_list|,
name|cap_rights_init
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_IOCTL
argument_list|)
argument_list|,
operator|&
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
operator|&
name|l_vcode
argument_list|,
sizeof|sizeof
argument_list|(
name|l_vcode
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|linux_to_bsd_v4l_code
argument_list|(
operator|&
name|l_vcode
argument_list|,
operator|&
name|vcode
argument_list|)
expr_stmt|;
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|VIDIOCSMICROCODE
argument_list|,
operator|&
name|vcode
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
case|case
name|LINUX_VIDIOCGVBIFMT
case|:
name|args
operator|->
name|cmd
operator|=
name|VIDIOCGVBIFMT
expr_stmt|;
break|break;
case|case
name|LINUX_VIDIOCSVBIFMT
case|:
name|args
operator|->
name|cmd
operator|=
name|VIDIOCSVBIFMT
expr_stmt|;
break|break;
default|default:
return|return
operator|(
name|ENOIOCTL
operator|)
return|;
block|}
name|error
operator|=
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Special ioctl handler  */
end_comment

begin_function
specifier|static
name|int
name|linux_ioctl_special
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|struct
name|linux_ioctl_args
modifier|*
name|args
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
switch|switch
condition|(
name|args
operator|->
name|cmd
condition|)
block|{
case|case
name|LINUX_SIOCGIFADDR
case|:
name|args
operator|->
name|cmd
operator|=
name|SIOCGIFADDR
expr_stmt|;
name|error
operator|=
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINUX_SIOCSIFADDR
case|:
name|args
operator|->
name|cmd
operator|=
name|SIOCSIFADDR
expr_stmt|;
name|error
operator|=
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
expr_stmt|;
break|break;
case|case
name|LINUX_SIOCGIFFLAGS
case|:
name|args
operator|->
name|cmd
operator|=
name|SIOCGIFFLAGS
expr_stmt|;
name|error
operator|=
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|ENOIOCTL
expr_stmt|;
block|}
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|linux_to_bsd_v4l2_standard
parameter_list|(
name|struct
name|l_v4l2_standard
modifier|*
name|lvstd
parameter_list|,
name|struct
name|v4l2_standard
modifier|*
name|vstd
parameter_list|)
block|{
name|vstd
operator|->
name|index
operator|=
name|lvstd
operator|->
name|index
expr_stmt|;
name|vstd
operator|->
name|id
operator|=
name|lvstd
operator|->
name|id
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|vstd
operator|->
name|name
argument_list|,
operator|&
name|lvstd
operator|->
name|name
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|lvstd
argument_list|)
operator|-
name|offsetof
argument_list|(
expr|struct
name|l_v4l2_standard
argument_list|,
name|name
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bsd_to_linux_v4l2_standard
parameter_list|(
name|struct
name|v4l2_standard
modifier|*
name|vstd
parameter_list|,
name|struct
name|l_v4l2_standard
modifier|*
name|lvstd
parameter_list|)
block|{
name|lvstd
operator|->
name|index
operator|=
name|vstd
operator|->
name|index
expr_stmt|;
name|lvstd
operator|->
name|id
operator|=
name|vstd
operator|->
name|id
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|lvstd
operator|->
name|name
argument_list|,
operator|&
name|vstd
operator|->
name|name
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|lvstd
argument_list|)
operator|-
name|offsetof
argument_list|(
expr|struct
name|l_v4l2_standard
argument_list|,
name|name
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|linux_to_bsd_v4l2_buffer
parameter_list|(
name|struct
name|l_v4l2_buffer
modifier|*
name|lvb
parameter_list|,
name|struct
name|v4l2_buffer
modifier|*
name|vb
parameter_list|)
block|{
name|vb
operator|->
name|index
operator|=
name|lvb
operator|->
name|index
expr_stmt|;
name|vb
operator|->
name|type
operator|=
name|lvb
operator|->
name|type
expr_stmt|;
name|vb
operator|->
name|bytesused
operator|=
name|lvb
operator|->
name|bytesused
expr_stmt|;
name|vb
operator|->
name|flags
operator|=
name|lvb
operator|->
name|flags
expr_stmt|;
name|vb
operator|->
name|field
operator|=
name|lvb
operator|->
name|field
expr_stmt|;
name|vb
operator|->
name|timestamp
operator|.
name|tv_sec
operator|=
name|lvb
operator|->
name|timestamp
operator|.
name|tv_sec
expr_stmt|;
name|vb
operator|->
name|timestamp
operator|.
name|tv_usec
operator|=
name|lvb
operator|->
name|timestamp
operator|.
name|tv_usec
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|vb
operator|->
name|timecode
argument_list|,
operator|&
name|lvb
operator|->
name|timecode
argument_list|,
sizeof|sizeof
argument_list|(
name|lvb
operator|->
name|timecode
argument_list|)
argument_list|)
expr_stmt|;
name|vb
operator|->
name|sequence
operator|=
name|lvb
operator|->
name|sequence
expr_stmt|;
name|vb
operator|->
name|memory
operator|=
name|lvb
operator|->
name|memory
expr_stmt|;
if|if
condition|(
name|lvb
operator|->
name|memory
operator|==
name|V4L2_MEMORY_USERPTR
condition|)
comment|/* possible pointer size conversion */
name|vb
operator|->
name|m
operator|.
name|userptr
operator|=
operator|(
name|unsigned
name|long
operator|)
name|PTRIN
argument_list|(
name|lvb
operator|->
name|m
operator|.
name|userptr
argument_list|)
expr_stmt|;
else|else
name|vb
operator|->
name|m
operator|.
name|offset
operator|=
name|lvb
operator|->
name|m
operator|.
name|offset
expr_stmt|;
name|vb
operator|->
name|length
operator|=
name|lvb
operator|->
name|length
expr_stmt|;
name|vb
operator|->
name|input
operator|=
name|lvb
operator|->
name|input
expr_stmt|;
name|vb
operator|->
name|reserved
operator|=
name|lvb
operator|->
name|reserved
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bsd_to_linux_v4l2_buffer
parameter_list|(
name|struct
name|v4l2_buffer
modifier|*
name|vb
parameter_list|,
name|struct
name|l_v4l2_buffer
modifier|*
name|lvb
parameter_list|)
block|{
name|lvb
operator|->
name|index
operator|=
name|vb
operator|->
name|index
expr_stmt|;
name|lvb
operator|->
name|type
operator|=
name|vb
operator|->
name|type
expr_stmt|;
name|lvb
operator|->
name|bytesused
operator|=
name|vb
operator|->
name|bytesused
expr_stmt|;
name|lvb
operator|->
name|flags
operator|=
name|vb
operator|->
name|flags
expr_stmt|;
name|lvb
operator|->
name|field
operator|=
name|vb
operator|->
name|field
expr_stmt|;
name|lvb
operator|->
name|timestamp
operator|.
name|tv_sec
operator|=
name|vb
operator|->
name|timestamp
operator|.
name|tv_sec
expr_stmt|;
name|lvb
operator|->
name|timestamp
operator|.
name|tv_usec
operator|=
name|vb
operator|->
name|timestamp
operator|.
name|tv_usec
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|lvb
operator|->
name|timecode
argument_list|,
operator|&
name|vb
operator|->
name|timecode
argument_list|,
sizeof|sizeof
argument_list|(
name|vb
operator|->
name|timecode
argument_list|)
argument_list|)
expr_stmt|;
name|lvb
operator|->
name|sequence
operator|=
name|vb
operator|->
name|sequence
expr_stmt|;
name|lvb
operator|->
name|memory
operator|=
name|vb
operator|->
name|memory
expr_stmt|;
if|if
condition|(
name|vb
operator|->
name|memory
operator|==
name|V4L2_MEMORY_USERPTR
condition|)
comment|/* possible pointer size conversion */
name|lvb
operator|->
name|m
operator|.
name|userptr
operator|=
name|PTROUT
argument_list|(
name|vb
operator|->
name|m
operator|.
name|userptr
argument_list|)
expr_stmt|;
else|else
name|lvb
operator|->
name|m
operator|.
name|offset
operator|=
name|vb
operator|->
name|m
operator|.
name|offset
expr_stmt|;
name|lvb
operator|->
name|length
operator|=
name|vb
operator|->
name|length
expr_stmt|;
name|lvb
operator|->
name|input
operator|=
name|vb
operator|->
name|input
expr_stmt|;
name|lvb
operator|->
name|reserved
operator|=
name|vb
operator|->
name|reserved
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|linux_to_bsd_v4l2_format
parameter_list|(
name|struct
name|l_v4l2_format
modifier|*
name|lvf
parameter_list|,
name|struct
name|v4l2_format
modifier|*
name|vf
parameter_list|)
block|{
name|vf
operator|->
name|type
operator|=
name|lvf
operator|->
name|type
expr_stmt|;
if|if
condition|(
name|lvf
operator|->
name|type
operator|==
name|V4L2_BUF_TYPE_VIDEO_OVERLAY
ifdef|#
directive|ifdef
name|V4L2_BUF_TYPE_VIDEO_OUTPUT_OVERLAY
operator|||
name|lvf
operator|->
name|type
operator|==
name|V4L2_BUF_TYPE_VIDEO_OUTPUT_OVERLAY
endif|#
directive|endif
condition|)
comment|/* 		 * XXX TODO - needs 32 -> 64 bit conversion: 		 * (unused by webcams?) 		 */
return|return
name|EINVAL
return|;
name|memcpy
argument_list|(
operator|&
name|vf
operator|->
name|fmt
argument_list|,
operator|&
name|lvf
operator|->
name|fmt
argument_list|,
sizeof|sizeof
argument_list|(
name|vf
operator|->
name|fmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bsd_to_linux_v4l2_format
parameter_list|(
name|struct
name|v4l2_format
modifier|*
name|vf
parameter_list|,
name|struct
name|l_v4l2_format
modifier|*
name|lvf
parameter_list|)
block|{
name|lvf
operator|->
name|type
operator|=
name|vf
operator|->
name|type
expr_stmt|;
if|if
condition|(
name|vf
operator|->
name|type
operator|==
name|V4L2_BUF_TYPE_VIDEO_OVERLAY
ifdef|#
directive|ifdef
name|V4L2_BUF_TYPE_VIDEO_OUTPUT_OVERLAY
operator|||
name|vf
operator|->
name|type
operator|==
name|V4L2_BUF_TYPE_VIDEO_OUTPUT_OVERLAY
endif|#
directive|endif
condition|)
comment|/* 		 * XXX TODO - needs 32 -> 64 bit conversion: 		 * (unused by webcams?) 		 */
return|return
name|EINVAL
return|;
name|memcpy
argument_list|(
operator|&
name|lvf
operator|->
name|fmt
argument_list|,
operator|&
name|vf
operator|->
name|fmt
argument_list|,
sizeof|sizeof
argument_list|(
name|vf
operator|->
name|fmt
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|linux_ioctl_v4l2
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|struct
name|linux_ioctl_args
modifier|*
name|args
parameter_list|)
block|{
name|cap_rights_t
name|rights
decl_stmt|;
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|int
name|error
decl_stmt|;
name|struct
name|v4l2_format
name|vformat
decl_stmt|;
name|struct
name|l_v4l2_format
name|l_vformat
decl_stmt|;
name|struct
name|v4l2_standard
name|vstd
decl_stmt|;
name|struct
name|l_v4l2_standard
name|l_vstd
decl_stmt|;
name|struct
name|l_v4l2_buffer
name|l_vbuf
decl_stmt|;
name|struct
name|v4l2_buffer
name|vbuf
decl_stmt|;
name|struct
name|v4l2_input
name|vinp
decl_stmt|;
switch|switch
condition|(
name|args
operator|->
name|cmd
operator|&
literal|0xffff
condition|)
block|{
case|case
name|LINUX_VIDIOC_RESERVED
case|:
case|case
name|LINUX_VIDIOC_LOG_STATUS
case|:
if|if
condition|(
operator|(
name|args
operator|->
name|cmd
operator|&
name|IOC_DIRMASK
operator|)
operator|!=
name|LINUX_IOC_VOID
condition|)
return|return
name|ENOIOCTL
return|;
name|args
operator|->
name|cmd
operator|=
operator|(
name|args
operator|->
name|cmd
operator|&
literal|0xffff
operator|)
operator||
name|IOC_VOID
expr_stmt|;
break|break;
case|case
name|LINUX_VIDIOC_OVERLAY
case|:
case|case
name|LINUX_VIDIOC_STREAMON
case|:
case|case
name|LINUX_VIDIOC_STREAMOFF
case|:
case|case
name|LINUX_VIDIOC_S_STD
case|:
case|case
name|LINUX_VIDIOC_S_TUNER
case|:
case|case
name|LINUX_VIDIOC_S_AUDIO
case|:
case|case
name|LINUX_VIDIOC_S_AUDOUT
case|:
case|case
name|LINUX_VIDIOC_S_MODULATOR
case|:
case|case
name|LINUX_VIDIOC_S_FREQUENCY
case|:
case|case
name|LINUX_VIDIOC_S_CROP
case|:
case|case
name|LINUX_VIDIOC_S_JPEGCOMP
case|:
case|case
name|LINUX_VIDIOC_S_PRIORITY
case|:
case|case
name|LINUX_VIDIOC_DBG_S_REGISTER
case|:
case|case
name|LINUX_VIDIOC_S_HW_FREQ_SEEK
case|:
case|case
name|LINUX_VIDIOC_SUBSCRIBE_EVENT
case|:
case|case
name|LINUX_VIDIOC_UNSUBSCRIBE_EVENT
case|:
name|args
operator|->
name|cmd
operator|=
operator|(
name|args
operator|->
name|cmd
operator|&
operator|~
name|IOC_DIRMASK
operator|)
operator||
name|IOC_IN
expr_stmt|;
break|break;
case|case
name|LINUX_VIDIOC_QUERYCAP
case|:
case|case
name|LINUX_VIDIOC_G_STD
case|:
case|case
name|LINUX_VIDIOC_G_AUDIO
case|:
case|case
name|LINUX_VIDIOC_G_INPUT
case|:
case|case
name|LINUX_VIDIOC_G_OUTPUT
case|:
case|case
name|LINUX_VIDIOC_G_AUDOUT
case|:
case|case
name|LINUX_VIDIOC_G_JPEGCOMP
case|:
case|case
name|LINUX_VIDIOC_QUERYSTD
case|:
case|case
name|LINUX_VIDIOC_G_PRIORITY
case|:
case|case
name|LINUX_VIDIOC_QUERY_DV_PRESET
case|:
name|args
operator|->
name|cmd
operator|=
operator|(
name|args
operator|->
name|cmd
operator|&
operator|~
name|IOC_DIRMASK
operator|)
operator||
name|IOC_OUT
expr_stmt|;
break|break;
case|case
name|LINUX_VIDIOC_ENUM_FMT
case|:
case|case
name|LINUX_VIDIOC_REQBUFS
case|:
case|case
name|LINUX_VIDIOC_G_PARM
case|:
case|case
name|LINUX_VIDIOC_S_PARM
case|:
case|case
name|LINUX_VIDIOC_G_CTRL
case|:
case|case
name|LINUX_VIDIOC_S_CTRL
case|:
case|case
name|LINUX_VIDIOC_G_TUNER
case|:
case|case
name|LINUX_VIDIOC_QUERYCTRL
case|:
case|case
name|LINUX_VIDIOC_QUERYMENU
case|:
case|case
name|LINUX_VIDIOC_S_INPUT
case|:
case|case
name|LINUX_VIDIOC_S_OUTPUT
case|:
case|case
name|LINUX_VIDIOC_ENUMOUTPUT
case|:
case|case
name|LINUX_VIDIOC_G_MODULATOR
case|:
case|case
name|LINUX_VIDIOC_G_FREQUENCY
case|:
case|case
name|LINUX_VIDIOC_CROPCAP
case|:
case|case
name|LINUX_VIDIOC_G_CROP
case|:
case|case
name|LINUX_VIDIOC_ENUMAUDIO
case|:
case|case
name|LINUX_VIDIOC_ENUMAUDOUT
case|:
case|case
name|LINUX_VIDIOC_G_SLICED_VBI_CAP
case|:
ifdef|#
directive|ifdef
name|VIDIOC_ENUM_FRAMESIZES
case|case
name|LINUX_VIDIOC_ENUM_FRAMESIZES
case|:
case|case
name|LINUX_VIDIOC_ENUM_FRAMEINTERVALS
case|:
case|case
name|LINUX_VIDIOC_ENCODER_CMD
case|:
case|case
name|LINUX_VIDIOC_TRY_ENCODER_CMD
case|:
endif|#
directive|endif
case|case
name|LINUX_VIDIOC_DBG_G_REGISTER
case|:
case|case
name|LINUX_VIDIOC_DBG_G_CHIP_IDENT
case|:
case|case
name|LINUX_VIDIOC_ENUM_DV_PRESETS
case|:
case|case
name|LINUX_VIDIOC_S_DV_PRESET
case|:
case|case
name|LINUX_VIDIOC_G_DV_PRESET
case|:
case|case
name|LINUX_VIDIOC_S_DV_TIMINGS
case|:
case|case
name|LINUX_VIDIOC_G_DV_TIMINGS
case|:
name|args
operator|->
name|cmd
operator|=
operator|(
name|args
operator|->
name|cmd
operator|&
operator|~
name|IOC_DIRMASK
operator|)
operator||
name|IOC_INOUT
expr_stmt|;
break|break;
case|case
name|LINUX_VIDIOC_G_FMT
case|:
case|case
name|LINUX_VIDIOC_S_FMT
case|:
case|case
name|LINUX_VIDIOC_TRY_FMT
case|:
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
operator|&
name|l_vformat
argument_list|,
sizeof|sizeof
argument_list|(
name|l_vformat
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|fget
argument_list|(
name|td
argument_list|,
name|args
operator|->
name|fd
argument_list|,
name|cap_rights_init
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_IOCTL
argument_list|)
argument_list|,
operator|&
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
name|linux_to_bsd_v4l2_format
argument_list|(
operator|&
name|l_vformat
argument_list|,
operator|&
name|vformat
argument_list|)
operator|!=
literal|0
condition|)
name|error
operator|=
name|EINVAL
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|args
operator|->
name|cmd
operator|&
literal|0xffff
operator|)
operator|==
name|LINUX_VIDIOC_G_FMT
condition|)
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|VIDIOC_G_FMT
argument_list|,
operator|&
name|vformat
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|args
operator|->
name|cmd
operator|&
literal|0xffff
operator|)
operator|==
name|LINUX_VIDIOC_S_FMT
condition|)
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|VIDIOC_S_FMT
argument_list|,
operator|&
name|vformat
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
else|else
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|VIDIOC_TRY_FMT
argument_list|,
operator|&
name|vformat
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
name|bsd_to_linux_v4l2_format
argument_list|(
operator|&
name|vformat
argument_list|,
operator|&
name|l_vformat
argument_list|)
expr_stmt|;
name|copyout
argument_list|(
operator|&
name|l_vformat
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|l_vformat
argument_list|)
argument_list|)
expr_stmt|;
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
case|case
name|LINUX_VIDIOC_ENUMSTD
case|:
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
operator|&
name|l_vstd
argument_list|,
sizeof|sizeof
argument_list|(
name|l_vstd
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|linux_to_bsd_v4l2_standard
argument_list|(
operator|&
name|l_vstd
argument_list|,
operator|&
name|vstd
argument_list|)
expr_stmt|;
name|error
operator|=
name|fget
argument_list|(
name|td
argument_list|,
name|args
operator|->
name|fd
argument_list|,
name|cap_rights_init
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_IOCTL
argument_list|)
argument_list|,
operator|&
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|VIDIOC_ENUMSTD
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|vstd
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|bsd_to_linux_v4l2_standard
argument_list|(
operator|&
name|vstd
argument_list|,
operator|&
name|l_vstd
argument_list|)
expr_stmt|;
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|l_vstd
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|l_vstd
argument_list|)
argument_list|)
expr_stmt|;
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
case|case
name|LINUX_VIDIOC_ENUMINPUT
case|:
comment|/* 		 * The Linux struct l_v4l2_input differs only in size, 		 * it has no padding at the end. 		 */
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
operator|&
name|vinp
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|l_v4l2_input
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|fget
argument_list|(
name|td
argument_list|,
name|args
operator|->
name|fd
argument_list|,
name|cap_rights_init
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_IOCTL
argument_list|)
argument_list|,
operator|&
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|VIDIOC_ENUMINPUT
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|vinp
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|vinp
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|l_v4l2_input
argument_list|)
argument_list|)
expr_stmt|;
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
case|case
name|LINUX_VIDIOC_QUERYBUF
case|:
case|case
name|LINUX_VIDIOC_QBUF
case|:
case|case
name|LINUX_VIDIOC_DQBUF
case|:
name|error
operator|=
name|copyin
argument_list|(
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
operator|&
name|l_vbuf
argument_list|,
sizeof|sizeof
argument_list|(
name|l_vbuf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|error
operator|=
name|fget
argument_list|(
name|td
argument_list|,
name|args
operator|->
name|fd
argument_list|,
name|cap_rights_init
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_IOCTL
argument_list|)
argument_list|,
operator|&
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|linux_to_bsd_v4l2_buffer
argument_list|(
operator|&
name|l_vbuf
argument_list|,
operator|&
name|vbuf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|args
operator|->
name|cmd
operator|&
literal|0xffff
operator|)
operator|==
name|LINUX_VIDIOC_QUERYBUF
condition|)
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|VIDIOC_QUERYBUF
argument_list|,
operator|&
name|vbuf
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|args
operator|->
name|cmd
operator|&
literal|0xffff
operator|)
operator|==
name|LINUX_VIDIOC_QBUF
condition|)
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|VIDIOC_QBUF
argument_list|,
operator|&
name|vbuf
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
else|else
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|VIDIOC_DQBUF
argument_list|,
operator|&
name|vbuf
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
expr_stmt|;
name|bsd_to_linux_v4l2_buffer
argument_list|(
operator|&
name|vbuf
argument_list|,
operator|&
name|l_vbuf
argument_list|)
expr_stmt|;
name|copyout
argument_list|(
operator|&
name|l_vbuf
argument_list|,
operator|(
name|void
operator|*
operator|)
name|args
operator|->
name|arg
argument_list|,
sizeof|sizeof
argument_list|(
name|l_vbuf
argument_list|)
argument_list|)
expr_stmt|;
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
comment|/* 	 * XXX TODO - these need 32 -> 64 bit conversion: 	 * (are any of them needed for webcams?) 	 */
case|case
name|LINUX_VIDIOC_G_FBUF
case|:
case|case
name|LINUX_VIDIOC_S_FBUF
case|:
case|case
name|LINUX_VIDIOC_G_EXT_CTRLS
case|:
case|case
name|LINUX_VIDIOC_S_EXT_CTRLS
case|:
case|case
name|LINUX_VIDIOC_TRY_EXT_CTRLS
case|:
case|case
name|LINUX_VIDIOC_DQEVENT
case|:
default|default:
return|return
operator|(
name|ENOIOCTL
operator|)
return|;
block|}
name|error
operator|=
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Support for emulators/linux-libusb. This port uses FBSD_LUSB* macros  * instead of USB* ones. This lets us to provide correct values for cmd.  * 0xffffffe0 -- 0xffffffff range seemed to be the least collision-prone.  */
end_comment

begin_function
specifier|static
name|int
name|linux_ioctl_fbsd_usb
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|struct
name|linux_ioctl_args
modifier|*
name|args
parameter_list|)
block|{
name|int
name|error
decl_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|args
operator|->
name|cmd
condition|)
block|{
case|case
name|FBSD_LUSB_DEVICEENUMERATE
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_DEVICEENUMERATE
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_DEV_QUIRK_ADD
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_DEV_QUIRK_ADD
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_DEV_QUIRK_GET
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_DEV_QUIRK_GET
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_DEV_QUIRK_REMOVE
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_DEV_QUIRK_REMOVE
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_DO_REQUEST
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_DO_REQUEST
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_FS_CLEAR_STALL_SYNC
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_FS_CLEAR_STALL_SYNC
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_FS_CLOSE
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_FS_CLOSE
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_FS_COMPLETE
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_FS_COMPLETE
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_FS_INIT
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_FS_INIT
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_FS_OPEN
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_FS_OPEN
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_FS_START
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_FS_START
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_FS_STOP
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_FS_STOP
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_FS_UNINIT
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_FS_UNINIT
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_GET_CONFIG
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_GET_CONFIG
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_GET_DEVICEINFO
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_GET_DEVICEINFO
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_GET_DEVICE_DESC
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_GET_DEVICE_DESC
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_GET_FULL_DESC
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_GET_FULL_DESC
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_GET_IFACE_DRIVER
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_GET_IFACE_DRIVER
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_GET_PLUGTIME
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_GET_PLUGTIME
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_GET_POWER_MODE
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_GET_POWER_MODE
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_GET_REPORT_DESC
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_GET_REPORT_DESC
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_GET_REPORT_ID
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_GET_REPORT_ID
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_GET_TEMPLATE
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_GET_TEMPLATE
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_IFACE_DRIVER_ACTIVE
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_IFACE_DRIVER_ACTIVE
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_IFACE_DRIVER_DETACH
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_IFACE_DRIVER_DETACH
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_QUIRK_NAME_GET
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_QUIRK_NAME_GET
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_READ_DIR
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_READ_DIR
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_SET_ALTINTERFACE
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_SET_ALTINTERFACE
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_SET_CONFIG
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_SET_CONFIG
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_SET_IMMED
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_SET_IMMED
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_SET_POWER_MODE
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_SET_POWER_MODE
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_SET_TEMPLATE
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_SET_TEMPLATE
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_FS_OPEN_STREAM
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_FS_OPEN_STREAM
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_GET_DEV_PORT_PATH
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_GET_DEV_PORT_PATH
expr_stmt|;
break|break;
case|case
name|FBSD_LUSB_GET_POWER_USAGE
case|:
name|args
operator|->
name|cmd
operator|=
name|USB_GET_POWER_USAGE
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|ENOIOCTL
expr_stmt|;
block|}
if|if
condition|(
name|error
operator|!=
name|ENOIOCTL
condition|)
name|error
operator|=
name|sys_ioctl
argument_list|(
name|td
argument_list|,
operator|(
expr|struct
name|ioctl_args
operator|*
operator|)
name|args
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * main ioctl syscall function  */
end_comment

begin_function
name|int
name|linux_ioctl
parameter_list|(
name|struct
name|thread
modifier|*
name|td
parameter_list|,
name|struct
name|linux_ioctl_args
modifier|*
name|args
parameter_list|)
block|{
name|cap_rights_t
name|rights
decl_stmt|;
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|struct
name|handler_element
modifier|*
name|he
decl_stmt|;
name|int
name|error
decl_stmt|,
name|cmd
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|ldebug
argument_list|(
name|ioctl
argument_list|)
condition|)
name|printf
argument_list|(
name|ARGS
argument_list|(
name|ioctl
argument_list|,
literal|"%d, %04lx, *"
argument_list|)
argument_list|,
name|args
operator|->
name|fd
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|args
operator|->
name|cmd
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|error
operator|=
name|fget
argument_list|(
name|td
argument_list|,
name|args
operator|->
name|fd
argument_list|,
name|cap_rights_init
argument_list|(
operator|&
name|rights
argument_list|,
name|CAP_IOCTL
argument_list|)
argument_list|,
operator|&
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
literal|0
condition|)
return|return
operator|(
name|error
operator|)
return|;
if|if
condition|(
operator|(
name|fp
operator|->
name|f_flag
operator|&
operator|(
name|FREAD
operator||
name|FWRITE
operator|)
operator|)
operator|==
literal|0
condition|)
block|{
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|EBADF
operator|)
return|;
block|}
comment|/* Iterate over the ioctl handlers */
name|cmd
operator|=
name|args
operator|->
name|cmd
operator|&
literal|0xffff
expr_stmt|;
name|sx_slock
argument_list|(
operator|&
name|linux_ioctl_sx
argument_list|)
expr_stmt|;
name|mtx_lock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|he
argument_list|,
argument|&handlers
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|cmd
operator|>=
name|he
operator|->
name|low
operator|&&
name|cmd
operator|<=
name|he
operator|->
name|high
condition|)
block|{
name|error
operator|=
call|(
modifier|*
name|he
operator|->
name|func
call|)
argument_list|(
name|td
argument_list|,
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|!=
name|ENOIOCTL
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
name|sx_sunlock
argument_list|(
operator|&
name|linux_ioctl_sx
argument_list|)
expr_stmt|;
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
block|}
block|}
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
name|sx_sunlock
argument_list|(
operator|&
name|linux_ioctl_sx
argument_list|)
expr_stmt|;
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
name|linux_msg
argument_list|(
name|td
argument_list|,
literal|"ioctl fd=%d, cmd=0x%x ('%c',%d) is not implemented"
argument_list|,
name|args
operator|->
name|fd
argument_list|,
call|(
name|int
call|)
argument_list|(
name|args
operator|->
name|cmd
operator|&
literal|0xffff
argument_list|)
argument_list|,
call|(
name|int
call|)
argument_list|(
name|args
operator|->
name|cmd
operator|&
literal|0xff00
argument_list|)
operator|>>
literal|8
argument_list|,
call|(
name|int
call|)
argument_list|(
name|args
operator|->
name|cmd
operator|&
literal|0xff
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

begin_function
name|int
name|linux_ioctl_register_handler
parameter_list|(
name|struct
name|linux_ioctl_handler
modifier|*
name|h
parameter_list|)
block|{
name|struct
name|handler_element
modifier|*
name|he
decl_stmt|,
modifier|*
name|cur
decl_stmt|;
if|if
condition|(
name|h
operator|==
name|NULL
operator|||
name|h
operator|->
name|func
operator|==
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
comment|/* 	 * Reuse the element if the handler is already on the list, otherwise 	 * create a new element. 	 */
name|sx_xlock
argument_list|(
operator|&
name|linux_ioctl_sx
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|he
argument_list|,
argument|&handlers
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|he
operator|->
name|func
operator|==
name|h
operator|->
name|func
condition|)
break|break;
block|}
if|if
condition|(
name|he
operator|==
name|NULL
condition|)
block|{
name|he
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|he
argument_list|)
argument_list|,
name|M_LINUX
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
name|he
operator|->
name|func
operator|=
name|h
operator|->
name|func
expr_stmt|;
block|}
else|else
name|TAILQ_REMOVE
argument_list|(
operator|&
name|handlers
argument_list|,
name|he
argument_list|,
name|list
argument_list|)
expr_stmt|;
comment|/* Initialize range information. */
name|he
operator|->
name|low
operator|=
name|h
operator|->
name|low
expr_stmt|;
name|he
operator|->
name|high
operator|=
name|h
operator|->
name|high
expr_stmt|;
name|he
operator|->
name|span
operator|=
name|h
operator|->
name|high
operator|-
name|h
operator|->
name|low
operator|+
literal|1
expr_stmt|;
comment|/* Add the element to the list, sorted on span. */
name|TAILQ_FOREACH
argument_list|(
argument|cur
argument_list|,
argument|&handlers
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|cur
operator|->
name|span
operator|>
name|he
operator|->
name|span
condition|)
block|{
name|TAILQ_INSERT_BEFORE
argument_list|(
name|cur
argument_list|,
name|he
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|sx_xunlock
argument_list|(
operator|&
name|linux_ioctl_sx
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
name|TAILQ_INSERT_TAIL
argument_list|(
operator|&
name|handlers
argument_list|,
name|he
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|sx_xunlock
argument_list|(
operator|&
name|linux_ioctl_sx
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|int
name|linux_ioctl_unregister_handler
parameter_list|(
name|struct
name|linux_ioctl_handler
modifier|*
name|h
parameter_list|)
block|{
name|struct
name|handler_element
modifier|*
name|he
decl_stmt|;
if|if
condition|(
name|h
operator|==
name|NULL
operator|||
name|h
operator|->
name|func
operator|==
name|NULL
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
name|sx_xlock
argument_list|(
operator|&
name|linux_ioctl_sx
argument_list|)
expr_stmt|;
name|TAILQ_FOREACH
argument_list|(
argument|he
argument_list|,
argument|&handlers
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|he
operator|->
name|func
operator|==
name|h
operator|->
name|func
condition|)
block|{
name|TAILQ_REMOVE
argument_list|(
operator|&
name|handlers
argument_list|,
name|he
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|sx_xunlock
argument_list|(
operator|&
name|linux_ioctl_sx
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|he
argument_list|,
name|M_LINUX
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
name|sx_xunlock
argument_list|(
operator|&
name|linux_ioctl_sx
argument_list|)
expr_stmt|;
return|return
operator|(
name|EINVAL
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1998 Mark Newton  * Copyright (c) 1994 Christos Zoulas  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  *   * $FreeBSD$  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/filedesc.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/signal.h>
end_include

begin_include
include|#
directive|include
file|<sys/signalvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysproto.h>
end_include

begin_include
include|#
directive|include
file|<machine/cpu.h>
end_include

begin_include
include|#
directive|include
file|<compat/svr4/svr4.h>
end_include

begin_include
include|#
directive|include
file|<compat/svr4/svr4_types.h>
end_include

begin_include
include|#
directive|include
file|<compat/svr4/svr4_signal.h>
end_include

begin_include
include|#
directive|include
file|<compat/svr4/svr4_proto.h>
end_include

begin_include
include|#
directive|include
file|<compat/svr4/svr4_util.h>
end_include

begin_include
include|#
directive|include
file|<compat/svr4/svr4_ucontext.h>
end_include

begin_define
define|#
directive|define
name|svr4_sigmask
parameter_list|(
name|n
parameter_list|)
value|(1<< (((n) - 1)& 31))
end_define

begin_define
define|#
directive|define
name|svr4_sigword
parameter_list|(
name|n
parameter_list|)
value|(((n) - 1)>> 5)
end_define

begin_define
define|#
directive|define
name|svr4_sigemptyset
parameter_list|(
name|s
parameter_list|)
value|memset((s), 0, sizeof(*(s)))
end_define

begin_define
define|#
directive|define
name|svr4_sigismember
parameter_list|(
name|s
parameter_list|,
name|n
parameter_list|)
value|((s)->bits[svr4_sigword(n)]& svr4_sigmask(n))
end_define

begin_define
define|#
directive|define
name|svr4_sigaddset
parameter_list|(
name|s
parameter_list|,
name|n
parameter_list|)
value|((s)->bits[svr4_sigword(n)] |= svr4_sigmask(n))
end_define

begin_function_decl
name|void
name|svr4_to_bsd_sigaction
parameter_list|(
specifier|const
name|struct
name|svr4_sigaction
modifier|*
parameter_list|,
name|struct
name|sigaction
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|bsd_to_svr4_sigaction
parameter_list|(
specifier|const
name|struct
name|sigaction
modifier|*
parameter_list|,
name|struct
name|svr4_sigaction
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|svr4_sigfillset
parameter_list|(
name|svr4_sigset_t
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|int
name|bsd_to_svr4_sig
index|[
name|SVR4_SIGTBLSZ
index|]
init|=
block|{
name|SVR4_SIGHUP
block|,
name|SVR4_SIGINT
block|,
name|SVR4_SIGQUIT
block|,
name|SVR4_SIGILL
block|,
name|SVR4_SIGTRAP
block|,
name|SVR4_SIGABRT
block|,
name|SVR4_SIGEMT
block|,
name|SVR4_SIGFPE
block|,
name|SVR4_SIGKILL
block|,
name|SVR4_SIGBUS
block|,
name|SVR4_SIGSEGV
block|,
name|SVR4_SIGSYS
block|,
name|SVR4_SIGPIPE
block|,
name|SVR4_SIGALRM
block|,
name|SVR4_SIGTERM
block|,
name|SVR4_SIGURG
block|,
name|SVR4_SIGSTOP
block|,
name|SVR4_SIGTSTP
block|,
name|SVR4_SIGCONT
block|,
name|SVR4_SIGCHLD
block|,
name|SVR4_SIGTTIN
block|,
name|SVR4_SIGTTOU
block|,
name|SVR4_SIGIO
block|,
name|SVR4_SIGXCPU
block|,
name|SVR4_SIGXFSZ
block|,
name|SVR4_SIGVTALRM
block|,
name|SVR4_SIGPROF
block|,
name|SVR4_SIGWINCH
block|,
literal|0
block|,
comment|/* SIGINFO */
name|SVR4_SIGUSR1
block|,
name|SVR4_SIGUSR2
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|svr4_to_bsd_sig
index|[
name|SVR4_SIGTBLSZ
index|]
init|=
block|{
name|SIGHUP
block|,
name|SIGINT
block|,
name|SIGQUIT
block|,
name|SIGILL
block|,
name|SIGTRAP
block|,
name|SIGABRT
block|,
name|SIGEMT
block|,
name|SIGFPE
block|,
name|SIGKILL
block|,
name|SIGBUS
block|,
name|SIGSEGV
block|,
name|SIGSYS
block|,
name|SIGPIPE
block|,
name|SIGALRM
block|,
name|SIGTERM
block|,
name|SIGUSR1
block|,
name|SIGUSR2
block|,
name|SIGCHLD
block|,
literal|0
block|,
comment|/* XXX NetBSD uses SIGPWR here, but we don't seem to have one */
name|SIGWINCH
block|,
name|SIGURG
block|,
name|SIGIO
block|,
name|SIGSTOP
block|,
name|SIGTSTP
block|,
name|SIGCONT
block|,
name|SIGTTIN
block|,
name|SIGTTOU
block|,
name|SIGVTALRM
block|,
name|SIGPROF
block|,
name|SIGXCPU
block|,
name|SIGXFSZ
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|svr4_sigfillset
parameter_list|(
name|s
parameter_list|)
name|svr4_sigset_t
modifier|*
name|s
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|svr4_sigemptyset
argument_list|(
name|s
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SVR4_NSIG
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|svr4_to_bsd_sig
index|[
name|i
index|]
operator|!=
literal|0
condition|)
name|svr4_sigaddset
argument_list|(
name|s
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|svr4_to_bsd_sigset
parameter_list|(
name|sss
parameter_list|,
name|bss
parameter_list|)
specifier|const
name|svr4_sigset_t
modifier|*
name|sss
decl_stmt|;
name|sigset_t
modifier|*
name|bss
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|newsig
decl_stmt|;
name|SIGEMPTYSET
argument_list|(
operator|*
name|bss
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|SVR4_NSIG
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|svr4_sigismember
argument_list|(
name|sss
argument_list|,
name|i
operator|+
literal|1
argument_list|)
condition|)
block|{
name|newsig
operator|=
name|svr4_to_bsd_sig
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|newsig
condition|)
name|SIGADDSET
argument_list|(
operator|*
name|bss
argument_list|,
name|newsig
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|bsd_to_svr4_sigset
parameter_list|(
name|bss
parameter_list|,
name|sss
parameter_list|)
specifier|const
name|sigset_t
modifier|*
name|bss
decl_stmt|;
name|svr4_sigset_t
modifier|*
name|sss
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|newsig
decl_stmt|;
name|svr4_sigemptyset
argument_list|(
name|sss
argument_list|)
expr_stmt|;
name|sss
operator|->
name|bits
index|[
literal|0
index|]
operator|=
name|bss
operator|->
name|__bits
index|[
literal|0
index|]
operator|&
operator|~
operator|(
operator|(
literal|1U
operator|<<
name|SVR4_SIGTBLSZ
operator|)
operator|-
literal|1
operator|)
expr_stmt|;
name|sss
operator|->
name|bits
index|[
literal|1
index|]
operator|=
name|bss
operator|->
name|__bits
index|[
literal|1
index|]
expr_stmt|;
name|sss
operator|->
name|bits
index|[
literal|2
index|]
operator|=
name|bss
operator|->
name|__bits
index|[
literal|2
index|]
expr_stmt|;
name|sss
operator|->
name|bits
index|[
literal|3
index|]
operator|=
name|bss
operator|->
name|__bits
index|[
literal|3
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|SVR4_SIGTBLSZ
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|SIGISMEMBER
argument_list|(
operator|*
name|bss
argument_list|,
name|i
argument_list|)
condition|)
block|{
name|newsig
operator|=
name|bsd_to_svr4_sig
index|[
name|_SIG_IDX
argument_list|(
name|i
argument_list|)
index|]
expr_stmt|;
if|if
condition|(
name|newsig
condition|)
name|svr4_sigaddset
argument_list|(
name|sss
argument_list|,
name|newsig
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/*  * XXX: Only a subset of the flags is currently implemented.  */
end_comment

begin_function
name|void
name|svr4_to_bsd_sigaction
parameter_list|(
name|ssa
parameter_list|,
name|bsa
parameter_list|)
specifier|const
name|struct
name|svr4_sigaction
modifier|*
name|ssa
decl_stmt|;
name|struct
name|sigaction
modifier|*
name|bsa
decl_stmt|;
block|{
name|bsa
operator|->
name|sa_handler
operator|=
operator|(
name|sig_t
operator|)
name|ssa
operator|->
name|ssa_handler
expr_stmt|;
name|svr4_to_bsd_sigset
argument_list|(
operator|&
name|ssa
operator|->
name|ssa_mask
argument_list|,
operator|&
name|bsa
operator|->
name|sa_mask
argument_list|)
expr_stmt|;
name|bsa
operator|->
name|sa_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|ssa
operator|->
name|ssa_flags
operator|&
name|SVR4_SA_ONSTACK
operator|)
operator|!=
literal|0
condition|)
name|bsa
operator|->
name|sa_flags
operator||=
name|SA_ONSTACK
expr_stmt|;
if|if
condition|(
operator|(
name|ssa
operator|->
name|ssa_flags
operator|&
name|SVR4_SA_RESETHAND
operator|)
operator|!=
literal|0
condition|)
name|bsa
operator|->
name|sa_flags
operator||=
name|SA_RESETHAND
expr_stmt|;
if|if
condition|(
operator|(
name|ssa
operator|->
name|ssa_flags
operator|&
name|SVR4_SA_RESTART
operator|)
operator|!=
literal|0
condition|)
name|bsa
operator|->
name|sa_flags
operator||=
name|SA_RESTART
expr_stmt|;
if|if
condition|(
operator|(
name|ssa
operator|->
name|ssa_flags
operator|&
name|SVR4_SA_SIGINFO
operator|)
operator|!=
literal|0
condition|)
name|DPRINTF
argument_list|(
operator|(
literal|"svr4_to_bsd_sigaction: SA_SIGINFO ignored\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ssa
operator|->
name|ssa_flags
operator|&
name|SVR4_SA_NOCLDSTOP
operator|)
operator|!=
literal|0
condition|)
name|bsa
operator|->
name|sa_flags
operator||=
name|SA_NOCLDSTOP
expr_stmt|;
if|if
condition|(
operator|(
name|ssa
operator|->
name|ssa_flags
operator|&
name|SVR4_SA_NODEFER
operator|)
operator|!=
literal|0
condition|)
name|bsa
operator|->
name|sa_flags
operator||=
name|SA_NODEFER
expr_stmt|;
if|if
condition|(
operator|(
name|ssa
operator|->
name|ssa_flags
operator|&
name|SVR4_SA_NOCLDWAIT
operator|)
operator|!=
literal|0
condition|)
name|bsa
operator|->
name|sa_flags
operator||=
name|SA_NOCLDWAIT
expr_stmt|;
if|if
condition|(
operator|(
name|ssa
operator|->
name|ssa_flags
operator|&
operator|~
name|SVR4_SA_ALLBITS
operator|)
operator|!=
literal|0
condition|)
name|DPRINTF
argument_list|(
operator|(
literal|"svr4_to_bsd_sigaction: extra bits ignored\n"
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|bsd_to_svr4_sigaction
parameter_list|(
name|bsa
parameter_list|,
name|ssa
parameter_list|)
specifier|const
name|struct
name|sigaction
modifier|*
name|bsa
decl_stmt|;
name|struct
name|svr4_sigaction
modifier|*
name|ssa
decl_stmt|;
block|{
name|ssa
operator|->
name|ssa_handler
operator|=
operator|(
name|svr4_sig_t
operator|)
name|bsa
operator|->
name|sa_handler
expr_stmt|;
name|bsd_to_svr4_sigset
argument_list|(
operator|&
name|bsa
operator|->
name|sa_mask
argument_list|,
operator|&
name|ssa
operator|->
name|ssa_mask
argument_list|)
expr_stmt|;
name|ssa
operator|->
name|ssa_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|bsa
operator|->
name|sa_flags
operator|&
name|SA_ONSTACK
operator|)
operator|!=
literal|0
condition|)
name|ssa
operator|->
name|ssa_flags
operator||=
name|SVR4_SA_ONSTACK
expr_stmt|;
if|if
condition|(
operator|(
name|bsa
operator|->
name|sa_flags
operator|&
name|SA_RESETHAND
operator|)
operator|!=
literal|0
condition|)
name|ssa
operator|->
name|ssa_flags
operator||=
name|SVR4_SA_RESETHAND
expr_stmt|;
if|if
condition|(
operator|(
name|bsa
operator|->
name|sa_flags
operator|&
name|SA_RESTART
operator|)
operator|!=
literal|0
condition|)
name|ssa
operator|->
name|ssa_flags
operator||=
name|SVR4_SA_RESTART
expr_stmt|;
if|if
condition|(
operator|(
name|bsa
operator|->
name|sa_flags
operator|&
name|SA_NODEFER
operator|)
operator|!=
literal|0
condition|)
name|ssa
operator|->
name|ssa_flags
operator||=
name|SVR4_SA_NODEFER
expr_stmt|;
if|if
condition|(
operator|(
name|bsa
operator|->
name|sa_flags
operator|&
name|SA_NOCLDSTOP
operator|)
operator|!=
literal|0
condition|)
name|ssa
operator|->
name|ssa_flags
operator||=
name|SVR4_SA_NOCLDSTOP
expr_stmt|;
block|}
end_function

begin_function
name|void
name|svr4_to_bsd_sigaltstack
parameter_list|(
name|sss
parameter_list|,
name|bss
parameter_list|)
specifier|const
name|struct
name|svr4_sigaltstack
modifier|*
name|sss
decl_stmt|;
name|struct
name|sigaltstack
modifier|*
name|bss
decl_stmt|;
block|{
name|bss
operator|->
name|ss_sp
operator|=
name|sss
operator|->
name|ss_sp
expr_stmt|;
name|bss
operator|->
name|ss_size
operator|=
name|sss
operator|->
name|ss_size
expr_stmt|;
name|bss
operator|->
name|ss_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|sss
operator|->
name|ss_flags
operator|&
name|SVR4_SS_DISABLE
operator|)
operator|!=
literal|0
condition|)
name|bss
operator|->
name|ss_flags
operator||=
name|SS_DISABLE
expr_stmt|;
if|if
condition|(
operator|(
name|sss
operator|->
name|ss_flags
operator|&
name|SVR4_SS_ONSTACK
operator|)
operator|!=
literal|0
condition|)
name|bss
operator|->
name|ss_flags
operator||=
name|SS_ONSTACK
expr_stmt|;
if|if
condition|(
operator|(
name|sss
operator|->
name|ss_flags
operator|&
operator|~
name|SVR4_SS_ALLBITS
operator|)
operator|!=
literal|0
condition|)
comment|/*XXX*/
name|uprintf
argument_list|(
literal|"svr4_to_bsd_sigaltstack: extra bits ignored\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|bsd_to_svr4_sigaltstack
parameter_list|(
name|bss
parameter_list|,
name|sss
parameter_list|)
specifier|const
name|struct
name|sigaltstack
modifier|*
name|bss
decl_stmt|;
name|struct
name|svr4_sigaltstack
modifier|*
name|sss
decl_stmt|;
block|{
name|sss
operator|->
name|ss_sp
operator|=
name|bss
operator|->
name|ss_sp
expr_stmt|;
name|sss
operator|->
name|ss_size
operator|=
name|bss
operator|->
name|ss_size
expr_stmt|;
name|sss
operator|->
name|ss_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|bss
operator|->
name|ss_flags
operator|&
name|SS_DISABLE
operator|)
operator|!=
literal|0
condition|)
name|sss
operator|->
name|ss_flags
operator||=
name|SVR4_SS_DISABLE
expr_stmt|;
if|if
condition|(
operator|(
name|bss
operator|->
name|ss_flags
operator|&
name|SS_ONSTACK
operator|)
operator|!=
literal|0
condition|)
name|sss
operator|->
name|ss_flags
operator||=
name|SVR4_SS_ONSTACK
expr_stmt|;
block|}
end_function

begin_function
name|int
name|svr4_sys_sigaction
parameter_list|(
name|td
parameter_list|,
name|uap
parameter_list|)
specifier|register
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|struct
name|svr4_sys_sigaction_args
modifier|*
name|uap
decl_stmt|;
block|{
name|struct
name|svr4_sigaction
modifier|*
name|nisa
decl_stmt|,
modifier|*
name|oisa
decl_stmt|,
name|tmpisa
decl_stmt|;
name|struct
name|sigaction
modifier|*
name|nbsa
decl_stmt|,
modifier|*
name|obsa
decl_stmt|,
name|tmpbsa
decl_stmt|;
name|struct
name|sigaction_args
name|sa
decl_stmt|;
name|caddr_t
name|sg
decl_stmt|;
name|int
name|error
decl_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"@@@ svr4_sys_sigaction(%d, %d, %d)\n"
operator|,
name|td
operator|->
name|td_proc
operator|->
name|p_pid
operator|,
name|SCARG
argument_list|(
name|uap
argument_list|,
name|signum
argument_list|)
operator|,
name|SVR4_SVR42BSD_SIG
argument_list|(
name|SCARG
argument_list|(
name|uap
argument_list|,
name|signum
argument_list|)
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|sg
operator|=
name|stackgap_init
argument_list|()
expr_stmt|;
name|nisa
operator|=
name|SCARG
argument_list|(
name|uap
argument_list|,
name|nsa
argument_list|)
expr_stmt|;
name|oisa
operator|=
name|SCARG
argument_list|(
name|uap
argument_list|,
name|osa
argument_list|)
expr_stmt|;
if|if
condition|(
name|oisa
operator|!=
name|NULL
condition|)
name|obsa
operator|=
name|stackgap_alloc
argument_list|(
operator|&
name|sg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sigaction
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|obsa
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|nisa
operator|!=
name|NULL
condition|)
block|{
name|nbsa
operator|=
name|stackgap_alloc
argument_list|(
operator|&
name|sg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sigaction
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|nisa
argument_list|,
operator|&
name|tmpisa
argument_list|,
sizeof|sizeof
argument_list|(
name|tmpisa
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
name|svr4_to_bsd_sigaction
argument_list|(
operator|&
name|tmpisa
argument_list|,
operator|&
name|tmpbsa
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|tmpbsa
argument_list|,
name|nbsa
argument_list|,
sizeof|sizeof
argument_list|(
name|tmpbsa
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
block|}
else|else
name|nbsa
operator|=
name|NULL
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|DEBUG_SVR4
argument_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|DPRINTF
argument_list|(
operator|(
literal|"\tssa_mask[%d] = %lx\n"
operator|,
name|i
operator|,
name|nisa
operator|->
name|ssa_mask
operator|.
name|bits
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"\tssa_handler = %p\n"
operator|,
name|nisa
operator|->
name|ssa_handler
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|SCARG
argument_list|(
operator|&
name|sa
argument_list|,
name|sig
argument_list|)
operator|=
name|SVR4_SVR42BSD_SIG
argument_list|(
name|SCARG
argument_list|(
name|uap
argument_list|,
name|signum
argument_list|)
argument_list|)
expr_stmt|;
name|SCARG
argument_list|(
operator|&
name|sa
argument_list|,
name|act
argument_list|)
operator|=
name|nbsa
expr_stmt|;
name|SCARG
argument_list|(
operator|&
name|sa
argument_list|,
name|oact
argument_list|)
operator|=
name|obsa
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|sigaction
argument_list|(
name|td
argument_list|,
operator|&
name|sa
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
if|if
condition|(
name|oisa
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|obsa
argument_list|,
operator|&
name|tmpbsa
argument_list|,
sizeof|sizeof
argument_list|(
name|tmpbsa
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
name|bsd_to_svr4_sigaction
argument_list|(
operator|&
name|tmpbsa
argument_list|,
operator|&
name|tmpisa
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|tmpisa
argument_list|,
name|oisa
argument_list|,
sizeof|sizeof
argument_list|(
name|tmpisa
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|svr4_sys_sigaltstack
parameter_list|(
name|td
parameter_list|,
name|uap
parameter_list|)
specifier|register
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|struct
name|svr4_sys_sigaltstack_args
modifier|*
name|uap
decl_stmt|;
block|{
name|struct
name|svr4_sigaltstack
modifier|*
name|nsss
decl_stmt|,
modifier|*
name|osss
decl_stmt|,
name|tmpsss
decl_stmt|;
name|struct
name|sigaltstack
modifier|*
name|nbss
decl_stmt|,
modifier|*
name|obss
decl_stmt|,
name|tmpbss
decl_stmt|;
name|struct
name|sigaltstack_args
name|sa
decl_stmt|;
name|caddr_t
name|sg
decl_stmt|;
name|int
name|error
decl_stmt|,
modifier|*
name|retval
decl_stmt|;
name|retval
operator|=
name|td
operator|->
name|td_retval
expr_stmt|;
name|sg
operator|=
name|stackgap_init
argument_list|()
expr_stmt|;
name|nsss
operator|=
name|SCARG
argument_list|(
name|uap
argument_list|,
name|nss
argument_list|)
expr_stmt|;
name|osss
operator|=
name|SCARG
argument_list|(
name|uap
argument_list|,
name|oss
argument_list|)
expr_stmt|;
if|if
condition|(
name|osss
operator|!=
name|NULL
condition|)
name|obss
operator|=
name|stackgap_alloc
argument_list|(
operator|&
name|sg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sigaltstack
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|obss
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|nsss
operator|!=
name|NULL
condition|)
block|{
name|nbss
operator|=
name|stackgap_alloc
argument_list|(
operator|&
name|sg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sigaltstack
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|nsss
argument_list|,
operator|&
name|tmpsss
argument_list|,
sizeof|sizeof
argument_list|(
name|tmpsss
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
name|svr4_to_bsd_sigaltstack
argument_list|(
operator|&
name|tmpsss
argument_list|,
operator|&
name|tmpbss
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|tmpbss
argument_list|,
name|nbss
argument_list|,
sizeof|sizeof
argument_list|(
name|tmpbss
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
block|}
else|else
name|nbss
operator|=
name|NULL
expr_stmt|;
name|SCARG
argument_list|(
operator|&
name|sa
argument_list|,
name|ss
argument_list|)
operator|=
name|nbss
expr_stmt|;
name|SCARG
argument_list|(
operator|&
name|sa
argument_list|,
name|oss
argument_list|)
operator|=
name|obss
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|sigaltstack
argument_list|(
name|td
argument_list|,
operator|&
name|sa
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
if|if
condition|(
name|obss
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|obss
argument_list|,
operator|&
name|tmpbss
argument_list|,
sizeof|sizeof
argument_list|(
name|tmpbss
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
name|bsd_to_svr4_sigaltstack
argument_list|(
operator|&
name|tmpbss
argument_list|,
operator|&
name|tmpsss
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|tmpsss
argument_list|,
name|osss
argument_list|,
sizeof|sizeof
argument_list|(
name|tmpsss
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  * Stolen from the ibcs2 one  */
end_comment

begin_function
name|int
name|svr4_sys_signal
parameter_list|(
name|td
parameter_list|,
name|uap
parameter_list|)
specifier|register
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|struct
name|svr4_sys_signal_args
modifier|*
name|uap
decl_stmt|;
block|{
name|int
name|signum
decl_stmt|;
name|int
name|error
decl_stmt|,
modifier|*
name|retval
init|=
name|td
operator|->
name|td_retval
decl_stmt|;
name|caddr_t
name|sg
init|=
name|stackgap_init
argument_list|()
decl_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"@@@ svr4_sys_signal(%d)\n"
operator|,
name|td
operator|->
name|td_proc
operator|->
name|p_pid
operator|)
argument_list|)
expr_stmt|;
name|signum
operator|=
name|SVR4_SVR42BSD_SIG
argument_list|(
name|SVR4_SIGNO
argument_list|(
name|SCARG
argument_list|(
name|uap
argument_list|,
name|signum
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|signum
operator|<=
literal|0
operator|||
name|signum
operator|>
name|SVR4_NSIG
condition|)
return|return
operator|(
name|EINVAL
operator|)
return|;
switch|switch
condition|(
name|SVR4_SIGCALL
argument_list|(
name|SCARG
argument_list|(
name|uap
argument_list|,
name|signum
argument_list|)
argument_list|)
condition|)
block|{
case|case
name|SVR4_SIGDEFER_MASK
case|:
if|if
condition|(
name|SCARG
argument_list|(
name|uap
argument_list|,
name|handler
argument_list|)
operator|==
name|SVR4_SIG_HOLD
condition|)
goto|goto
name|sighold
goto|;
comment|/* FALLTHROUGH */
case|case
name|SVR4_SIGNAL_MASK
case|:
block|{
name|struct
name|sigaction_args
name|sa_args
decl_stmt|;
name|struct
name|sigaction
modifier|*
name|nbsa
decl_stmt|,
modifier|*
name|obsa
decl_stmt|,
name|sa
decl_stmt|;
name|nbsa
operator|=
name|stackgap_alloc
argument_list|(
operator|&
name|sg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sigaction
argument_list|)
argument_list|)
expr_stmt|;
name|obsa
operator|=
name|stackgap_alloc
argument_list|(
operator|&
name|sg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sigaction
argument_list|)
argument_list|)
expr_stmt|;
name|SCARG
argument_list|(
operator|&
name|sa_args
argument_list|,
name|sig
argument_list|)
operator|=
name|signum
expr_stmt|;
name|SCARG
argument_list|(
operator|&
name|sa_args
argument_list|,
name|act
argument_list|)
operator|=
name|nbsa
expr_stmt|;
name|SCARG
argument_list|(
operator|&
name|sa_args
argument_list|,
name|oact
argument_list|)
operator|=
name|obsa
expr_stmt|;
name|sa
operator|.
name|sa_handler
operator|=
operator|(
name|sig_t
operator|)
name|SCARG
argument_list|(
name|uap
argument_list|,
name|handler
argument_list|)
expr_stmt|;
name|SIGEMPTYSET
argument_list|(
name|sa
operator|.
name|sa_mask
argument_list|)
expr_stmt|;
name|sa
operator|.
name|sa_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|signum
operator|!=
name|SIGALRM
condition|)
name|sa
operator|.
name|sa_flags
operator|=
name|SA_RESTART
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|sa
argument_list|,
name|nbsa
argument_list|,
sizeof|sizeof
argument_list|(
name|sa
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
if|if
condition|(
operator|(
name|error
operator|=
name|sigaction
argument_list|(
name|td
argument_list|,
operator|&
name|sa_args
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"signal: sigaction failed: %d\n"
operator|,
name|error
operator|)
argument_list|)
expr_stmt|;
operator|*
name|retval
operator|=
operator|(
name|int
operator|)
name|SVR4_SIG_ERR
expr_stmt|;
return|return
name|error
return|;
block|}
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|obsa
argument_list|,
operator|&
name|sa
argument_list|,
sizeof|sizeof
argument_list|(
name|sa
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
operator|*
name|retval
operator|=
operator|(
name|int
operator|)
name|sa
operator|.
name|sa_handler
expr_stmt|;
return|return
literal|0
return|;
block|}
case|case
name|SVR4_SIGHOLD_MASK
case|:
name|sighold
label|:
block|{
name|struct
name|sigprocmask_args
name|sa
decl_stmt|;
name|sigset_t
modifier|*
name|set
decl_stmt|;
name|set
operator|=
name|stackgap_alloc
argument_list|(
operator|&
name|sg
argument_list|,
sizeof|sizeof
argument_list|(
name|sigset_t
argument_list|)
argument_list|)
expr_stmt|;
name|SIGEMPTYSET
argument_list|(
operator|*
name|set
argument_list|)
expr_stmt|;
name|SIGADDSET
argument_list|(
operator|*
name|set
argument_list|,
name|signum
argument_list|)
expr_stmt|;
name|SCARG
argument_list|(
operator|&
name|sa
argument_list|,
name|how
argument_list|)
operator|=
name|SIG_BLOCK
expr_stmt|;
name|SCARG
argument_list|(
operator|&
name|sa
argument_list|,
name|set
argument_list|)
operator|=
name|set
expr_stmt|;
name|SCARG
argument_list|(
operator|&
name|sa
argument_list|,
name|oset
argument_list|)
operator|=
name|NULL
expr_stmt|;
return|return
name|sigprocmask
argument_list|(
name|td
argument_list|,
operator|&
name|sa
argument_list|)
return|;
block|}
case|case
name|SVR4_SIGRELSE_MASK
case|:
block|{
name|struct
name|sigprocmask_args
name|sa
decl_stmt|;
name|sigset_t
modifier|*
name|set
decl_stmt|;
name|set
operator|=
name|stackgap_alloc
argument_list|(
operator|&
name|sg
argument_list|,
sizeof|sizeof
argument_list|(
name|sigset_t
argument_list|)
argument_list|)
expr_stmt|;
name|SIGEMPTYSET
argument_list|(
operator|*
name|set
argument_list|)
expr_stmt|;
name|SIGADDSET
argument_list|(
operator|*
name|set
argument_list|,
name|signum
argument_list|)
expr_stmt|;
name|SCARG
argument_list|(
operator|&
name|sa
argument_list|,
name|how
argument_list|)
operator|=
name|SIG_UNBLOCK
expr_stmt|;
name|SCARG
argument_list|(
operator|&
name|sa
argument_list|,
name|set
argument_list|)
operator|=
name|set
expr_stmt|;
name|SCARG
argument_list|(
operator|&
name|sa
argument_list|,
name|oset
argument_list|)
operator|=
name|NULL
expr_stmt|;
return|return
name|sigprocmask
argument_list|(
name|td
argument_list|,
operator|&
name|sa
argument_list|)
return|;
block|}
case|case
name|SVR4_SIGIGNORE_MASK
case|:
block|{
name|struct
name|sigaction_args
name|sa_args
decl_stmt|;
name|struct
name|sigaction
modifier|*
name|bsa
decl_stmt|,
name|sa
decl_stmt|;
name|bsa
operator|=
name|stackgap_alloc
argument_list|(
operator|&
name|sg
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sigaction
argument_list|)
argument_list|)
expr_stmt|;
name|SCARG
argument_list|(
operator|&
name|sa_args
argument_list|,
name|sig
argument_list|)
operator|=
name|signum
expr_stmt|;
name|SCARG
argument_list|(
operator|&
name|sa_args
argument_list|,
name|act
argument_list|)
operator|=
name|bsa
expr_stmt|;
name|SCARG
argument_list|(
operator|&
name|sa_args
argument_list|,
name|oact
argument_list|)
operator|=
name|NULL
expr_stmt|;
name|sa
operator|.
name|sa_handler
operator|=
name|SIG_IGN
expr_stmt|;
name|SIGEMPTYSET
argument_list|(
name|sa
operator|.
name|sa_mask
argument_list|)
expr_stmt|;
name|sa
operator|.
name|sa_flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|sa
argument_list|,
name|bsa
argument_list|,
sizeof|sizeof
argument_list|(
name|sa
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
if|if
condition|(
operator|(
name|error
operator|=
name|sigaction
argument_list|(
name|td
argument_list|,
operator|&
name|sa_args
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"sigignore: sigaction failed\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
return|return
literal|0
return|;
block|}
case|case
name|SVR4_SIGPAUSE_MASK
case|:
block|{
name|struct
name|sigsuspend_args
name|sa
decl_stmt|;
name|sigset_t
modifier|*
name|set
decl_stmt|;
name|set
operator|=
name|stackgap_alloc
argument_list|(
operator|&
name|sg
argument_list|,
sizeof|sizeof
argument_list|(
name|sigset_t
argument_list|)
argument_list|)
expr_stmt|;
name|PROC_LOCK
argument_list|(
name|td
operator|->
name|td_proc
argument_list|)
expr_stmt|;
operator|*
name|set
operator|=
name|td
operator|->
name|td_proc
operator|->
name|p_sigmask
expr_stmt|;
name|PROC_UNLOCK
argument_list|(
name|td
operator|->
name|td_proc
argument_list|)
expr_stmt|;
name|SIGDELSET
argument_list|(
operator|*
name|set
argument_list|,
name|signum
argument_list|)
expr_stmt|;
name|SCARG
argument_list|(
operator|&
name|sa
argument_list|,
name|sigmask
argument_list|)
operator|=
name|set
expr_stmt|;
return|return
name|sigsuspend
argument_list|(
name|td
argument_list|,
operator|&
name|sa
argument_list|)
return|;
block|}
default|default:
return|return
operator|(
name|ENOSYS
operator|)
return|;
block|}
block|}
end_function

begin_function
name|int
name|svr4_sys_sigprocmask
parameter_list|(
name|td
parameter_list|,
name|uap
parameter_list|)
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|struct
name|svr4_sys_sigprocmask_args
modifier|*
name|uap
decl_stmt|;
block|{
name|svr4_sigset_t
name|sss
decl_stmt|;
name|sigset_t
name|bss
decl_stmt|;
name|int
name|error
init|=
literal|0
decl_stmt|,
modifier|*
name|retval
decl_stmt|;
name|retval
operator|=
name|td
operator|->
name|td_retval
expr_stmt|;
if|if
condition|(
name|SCARG
argument_list|(
name|uap
argument_list|,
name|oset
argument_list|)
operator|!=
name|NULL
condition|)
block|{
comment|/* Fix the return value first if needed */
name|PROC_LOCK
argument_list|(
name|td
operator|->
name|td_proc
argument_list|)
expr_stmt|;
name|bsd_to_svr4_sigset
argument_list|(
operator|&
name|td
operator|->
name|td_proc
operator|->
name|p_sigmask
argument_list|,
operator|&
name|sss
argument_list|)
expr_stmt|;
name|PROC_UNLOCK
argument_list|(
name|td
operator|->
name|td_proc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|sss
argument_list|,
name|SCARG
argument_list|(
name|uap
argument_list|,
name|oset
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|sss
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
block|}
if|if
condition|(
name|SCARG
argument_list|(
name|uap
argument_list|,
name|set
argument_list|)
operator|==
name|NULL
condition|)
comment|/* Just examine */
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|SCARG
argument_list|(
name|uap
argument_list|,
name|set
argument_list|)
argument_list|,
operator|&
name|sss
argument_list|,
sizeof|sizeof
argument_list|(
name|sss
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
name|svr4_to_bsd_sigset
argument_list|(
operator|&
name|sss
argument_list|,
operator|&
name|bss
argument_list|)
expr_stmt|;
name|PROC_LOCK
argument_list|(
name|td
operator|->
name|td_proc
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|SCARG
argument_list|(
name|uap
argument_list|,
name|how
argument_list|)
condition|)
block|{
case|case
name|SVR4_SIG_BLOCK
case|:
name|SIGSETOR
argument_list|(
name|td
operator|->
name|td_proc
operator|->
name|p_sigmask
argument_list|,
name|bss
argument_list|)
expr_stmt|;
name|SIG_CANTMASK
argument_list|(
name|td
operator|->
name|td_proc
operator|->
name|p_sigmask
argument_list|)
expr_stmt|;
break|break;
case|case
name|SVR4_SIG_UNBLOCK
case|:
name|SIGSETNAND
argument_list|(
name|td
operator|->
name|td_proc
operator|->
name|p_sigmask
argument_list|,
name|bss
argument_list|)
expr_stmt|;
break|break;
case|case
name|SVR4_SIG_SETMASK
case|:
name|td
operator|->
name|td_proc
operator|->
name|p_sigmask
operator|=
name|bss
expr_stmt|;
name|SIG_CANTMASK
argument_list|(
name|td
operator|->
name|td_proc
operator|->
name|p_sigmask
argument_list|)
expr_stmt|;
break|break;
default|default:
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
block|}
name|PROC_UNLOCK
argument_list|(
name|td
operator|->
name|td_proc
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
end_function

begin_function
name|int
name|svr4_sys_sigpending
parameter_list|(
name|td
parameter_list|,
name|uap
parameter_list|)
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|struct
name|svr4_sys_sigpending_args
modifier|*
name|uap
decl_stmt|;
block|{
name|sigset_t
name|bss
decl_stmt|;
name|int
modifier|*
name|retval
decl_stmt|;
name|svr4_sigset_t
name|sss
decl_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"@@@ svr4_sys_sigpending(%d)\n"
operator|,
name|td
operator|->
name|td_proc
operator|->
name|p_pid
operator|)
argument_list|)
expr_stmt|;
name|retval
operator|=
name|td
operator|->
name|td_retval
expr_stmt|;
switch|switch
condition|(
name|SCARG
argument_list|(
name|uap
argument_list|,
name|what
argument_list|)
condition|)
block|{
case|case
literal|1
case|:
comment|/* sigpending */
if|if
condition|(
name|SCARG
argument_list|(
name|uap
argument_list|,
name|mask
argument_list|)
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|PROC_LOCK
argument_list|(
name|td
operator|->
name|td_proc
argument_list|)
expr_stmt|;
name|bss
operator|=
name|td
operator|->
name|td_proc
operator|->
name|p_siglist
expr_stmt|;
name|SIGSETAND
argument_list|(
name|bss
argument_list|,
name|td
operator|->
name|td_proc
operator|->
name|p_sigmask
argument_list|)
expr_stmt|;
name|PROC_UNLOCK
argument_list|(
name|td
operator|->
name|td_proc
argument_list|)
expr_stmt|;
name|bsd_to_svr4_sigset
argument_list|(
operator|&
name|bss
argument_list|,
operator|&
name|sss
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
comment|/* sigfillset */
name|svr4_sigfillset
argument_list|(
operator|&
name|sss
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|DEBUG_SVR4
argument_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|DPRINTF
argument_list|(
operator|(
literal|"new sigset[%d] = %lx\n"
operator|,
name|i
operator|,
operator|(
name|long
operator|)
name|sss
operator|.
name|bits
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
break|break;
default|default:
return|return
name|EINVAL
return|;
block|}
return|return
name|copyout
argument_list|(
operator|&
name|sss
argument_list|,
name|SCARG
argument_list|(
name|uap
argument_list|,
name|mask
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|sss
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|svr4_sys_sigsuspend
parameter_list|(
name|td
parameter_list|,
name|uap
parameter_list|)
specifier|register
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|struct
name|svr4_sys_sigsuspend_args
modifier|*
name|uap
decl_stmt|;
block|{
name|svr4_sigset_t
name|sss
decl_stmt|;
name|sigset_t
modifier|*
name|bss
decl_stmt|;
name|struct
name|sigsuspend_args
name|sa
decl_stmt|;
name|int
name|error
decl_stmt|;
name|caddr_t
name|sg
init|=
name|stackgap_init
argument_list|()
decl_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|SCARG
argument_list|(
name|uap
argument_list|,
name|ss
argument_list|)
argument_list|,
operator|&
name|sss
argument_list|,
sizeof|sizeof
argument_list|(
name|sss
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
name|bss
operator|=
name|stackgap_alloc
argument_list|(
operator|&
name|sg
argument_list|,
sizeof|sizeof
argument_list|(
name|sigset_t
argument_list|)
argument_list|)
expr_stmt|;
name|svr4_to_bsd_sigset
argument_list|(
operator|&
name|sss
argument_list|,
name|bss
argument_list|)
expr_stmt|;
name|SCARG
argument_list|(
operator|&
name|sa
argument_list|,
name|sigmask
argument_list|)
operator|=
name|bss
expr_stmt|;
return|return
name|sigsuspend
argument_list|(
name|td
argument_list|,
operator|&
name|sa
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|svr4_sys_kill
parameter_list|(
name|td
parameter_list|,
name|uap
parameter_list|)
specifier|register
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|struct
name|svr4_sys_kill_args
modifier|*
name|uap
decl_stmt|;
block|{
name|struct
name|kill_args
name|ka
decl_stmt|;
name|SCARG
argument_list|(
operator|&
name|ka
argument_list|,
name|pid
argument_list|)
operator|=
name|SCARG
argument_list|(
name|uap
argument_list|,
name|pid
argument_list|)
expr_stmt|;
name|SCARG
argument_list|(
operator|&
name|ka
argument_list|,
name|signum
argument_list|)
operator|=
name|SVR4_SVR42BSD_SIG
argument_list|(
name|SCARG
argument_list|(
name|uap
argument_list|,
name|signum
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|kill
argument_list|(
name|td
argument_list|,
operator|&
name|ka
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|svr4_sys_context
parameter_list|(
name|td
parameter_list|,
name|uap
parameter_list|)
specifier|register
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|struct
name|svr4_sys_context_args
modifier|*
name|uap
decl_stmt|;
block|{
name|struct
name|svr4_ucontext
name|uc
decl_stmt|;
name|int
name|error
decl_stmt|;
switch|switch
condition|(
name|uap
operator|->
name|func
condition|)
block|{
case|case
literal|0
case|:
name|PROC_LOCK
argument_list|(
name|td
operator|->
name|td_proc
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"getcontext(%p)\n"
operator|,
name|uap
operator|->
name|uc
operator|)
argument_list|)
expr_stmt|;
name|svr4_getcontext
argument_list|(
name|td
argument_list|,
operator|&
name|uc
argument_list|,
operator|&
name|td
operator|->
name|td_proc
operator|->
name|p_sigmask
argument_list|,
name|sigonstack
argument_list|(
name|cpu_getstack
argument_list|(
name|td
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|PROC_UNLOCK
argument_list|(
name|td
operator|->
name|td_proc
argument_list|)
expr_stmt|;
return|return
name|copyout
argument_list|(
operator|&
name|uc
argument_list|,
name|uap
operator|->
name|uc
argument_list|,
sizeof|sizeof
argument_list|(
name|uc
argument_list|)
argument_list|)
return|;
case|case
literal|1
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"setcontext(%p)\n"
operator|,
name|uap
operator|->
name|uc
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|uap
operator|->
name|uc
argument_list|,
operator|&
name|uc
argument_list|,
sizeof|sizeof
argument_list|(
name|uc
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
name|DPRINTF
argument_list|(
operator|(
literal|"uc_flags = %lx\n"
operator|,
name|uc
operator|.
name|uc_flags
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|DEBUG_SVR4
argument_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
name|DPRINTF
argument_list|(
operator|(
literal|"uc_sigmask[%d] = %lx\n"
operator|,
name|i
operator|,
name|uc
operator|.
name|uc_sigmask
operator|.
name|bits
index|[
name|i
index|]
operator|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
return|return
name|svr4_setcontext
argument_list|(
name|td
argument_list|,
operator|&
name|uc
argument_list|)
return|;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"context(%d, %p)\n"
operator|,
name|uap
operator|->
name|func
operator|,
name|uap
operator|->
name|uc
operator|)
argument_list|)
expr_stmt|;
return|return
name|ENOSYS
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|svr4_sys_pause
parameter_list|(
name|td
parameter_list|,
name|uap
parameter_list|)
specifier|register
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|struct
name|svr4_sys_pause_args
modifier|*
name|uap
decl_stmt|;
block|{
name|struct
name|sigsuspend_args
name|bsa
decl_stmt|;
name|SCARG
argument_list|(
operator|&
name|bsa
argument_list|,
name|sigmask
argument_list|)
operator|=
operator|&
name|td
operator|->
name|td_proc
operator|->
name|p_sigmask
expr_stmt|;
return|return
name|sigsuspend
argument_list|(
name|td
argument_list|,
operator|&
name|bsa
argument_list|)
return|;
block|}
end_function

end_unit


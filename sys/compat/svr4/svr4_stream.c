begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*-  * Copyright (c) 1998 Mark Newton.  All rights reserved.  * Copyright (c) 1994, 1996 Christos Zoulas.  All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. All advertising materials mentioning features or use of this software  *    must display the following acknowledgement:  *	This product includes software developed by Christos Zoulas.  * 4. The name of the author may not be used to endorse or promote products  *    derived from this software without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR  * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES  * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,  * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT  * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,  * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY  * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT  * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF  * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * Pretend that we have streams...  * Yes, this is gross.  *  * ToDo: The state machine for getmsg needs re-thinking  */
end_comment

begin_include
include|#
directive|include
file|<sys/cdefs.h>
end_include

begin_expr_stmt
name|__FBSDID
argument_list|(
literal|"$FreeBSD$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_include
include|#
directive|include
file|"opt_compat.h"
end_include

begin_include
include|#
directive|include
file|"opt_ktrace.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/systm.h>
end_include

begin_include
include|#
directive|include
file|<sys/capability.h>
end_include

begin_include
include|#
directive|include
file|<sys/fcntl.h>
end_include

begin_include
include|#
directive|include
file|<sys/filedesc.h>
end_include

begin_include
include|#
directive|include
file|<sys/filio.h>
end_include

begin_include
include|#
directive|include
file|<sys/lock.h>
end_include

begin_include
include|#
directive|include
file|<sys/malloc.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_comment
comment|/* Must come after sys/malloc.h */
end_comment

begin_include
include|#
directive|include
file|<sys/mbuf.h>
end_include

begin_include
include|#
directive|include
file|<sys/mutex.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_include
include|#
directive|include
file|<sys/protosw.h>
end_include

begin_include
include|#
directive|include
file|<sys/signal.h>
end_include

begin_include
include|#
directive|include
file|<sys/signalvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<sys/socketvar.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<sys/syscallsubr.h>
end_include

begin_include
include|#
directive|include
file|<sys/sysproto.h>
end_include

begin_include
include|#
directive|include
file|<sys/uio.h>
end_include

begin_include
include|#
directive|include
file|<sys/ktrace.h>
end_include

begin_comment
comment|/* Must come after sys/uio.h */
end_comment

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<compat/svr4/svr4.h>
end_include

begin_include
include|#
directive|include
file|<compat/svr4/svr4_types.h>
end_include

begin_include
include|#
directive|include
file|<compat/svr4/svr4_util.h>
end_include

begin_include
include|#
directive|include
file|<compat/svr4/svr4_signal.h>
end_include

begin_include
include|#
directive|include
file|<compat/svr4/svr4_proto.h>
end_include

begin_include
include|#
directive|include
file|<compat/svr4/svr4_stropts.h>
end_include

begin_include
include|#
directive|include
file|<compat/svr4/svr4_timod.h>
end_include

begin_include
include|#
directive|include
file|<compat/svr4/svr4_sockmod.h>
end_include

begin_include
include|#
directive|include
file|<compat/svr4/svr4_ioctl.h>
end_include

begin_include
include|#
directive|include
file|<compat/svr4/svr4_socket.h>
end_include

begin_comment
comment|/* Utils */
end_comment

begin_function_decl
specifier|static
name|int
name|clean_pipe
parameter_list|(
name|struct
name|thread
modifier|*
parameter_list|,
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|getparm
parameter_list|(
name|struct
name|file
modifier|*
parameter_list|,
name|struct
name|svr4_si_sockparms
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|svr4_do_putmsg
parameter_list|(
name|struct
name|thread
modifier|*
parameter_list|,
name|struct
name|svr4_sys_putmsg_args
modifier|*
parameter_list|,
name|struct
name|file
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|svr4_do_getmsg
parameter_list|(
name|struct
name|thread
modifier|*
parameter_list|,
name|struct
name|svr4_sys_getmsg_args
modifier|*
parameter_list|,
name|struct
name|file
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Address Conversions */
end_comment

begin_function_decl
specifier|static
name|void
name|sockaddr_to_netaddr_in
parameter_list|(
name|struct
name|svr4_strmcmd
modifier|*
parameter_list|,
specifier|const
name|struct
name|sockaddr_in
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sockaddr_to_netaddr_un
parameter_list|(
name|struct
name|svr4_strmcmd
modifier|*
parameter_list|,
specifier|const
name|struct
name|sockaddr_un
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|netaddr_to_sockaddr_in
parameter_list|(
name|struct
name|sockaddr_in
modifier|*
parameter_list|,
specifier|const
name|struct
name|svr4_strmcmd
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|netaddr_to_sockaddr_un
parameter_list|(
name|struct
name|sockaddr_un
modifier|*
parameter_list|,
specifier|const
name|struct
name|svr4_strmcmd
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* stream ioctls */
end_comment

begin_function_decl
specifier|static
name|int
name|i_nread
parameter_list|(
name|struct
name|file
modifier|*
parameter_list|,
name|struct
name|thread
modifier|*
parameter_list|,
name|register_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|u_long
parameter_list|,
name|caddr_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|i_fdinsert
parameter_list|(
name|struct
name|file
modifier|*
parameter_list|,
name|struct
name|thread
modifier|*
parameter_list|,
name|register_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|u_long
parameter_list|,
name|caddr_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|i_str
parameter_list|(
name|struct
name|file
modifier|*
parameter_list|,
name|struct
name|thread
modifier|*
parameter_list|,
name|register_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|u_long
parameter_list|,
name|caddr_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|i_setsig
parameter_list|(
name|struct
name|file
modifier|*
parameter_list|,
name|struct
name|thread
modifier|*
parameter_list|,
name|register_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|u_long
parameter_list|,
name|caddr_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|i_getsig
parameter_list|(
name|struct
name|file
modifier|*
parameter_list|,
name|struct
name|thread
modifier|*
parameter_list|,
name|register_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|u_long
parameter_list|,
name|caddr_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|_i_bind_rsvd
parameter_list|(
name|struct
name|file
modifier|*
parameter_list|,
name|struct
name|thread
modifier|*
parameter_list|,
name|register_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|u_long
parameter_list|,
name|caddr_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|_i_rele_rsvd
parameter_list|(
name|struct
name|file
modifier|*
parameter_list|,
name|struct
name|thread
modifier|*
parameter_list|,
name|register_t
modifier|*
parameter_list|,
name|int
parameter_list|,
name|u_long
parameter_list|,
name|caddr_t
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* i_str sockmod calls */
end_comment

begin_function_decl
specifier|static
name|int
name|sockmod
parameter_list|(
name|struct
name|file
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|svr4_strioctl
modifier|*
parameter_list|,
name|struct
name|thread
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|si_listen
parameter_list|(
name|struct
name|file
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|svr4_strioctl
modifier|*
parameter_list|,
name|struct
name|thread
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|si_ogetudata
parameter_list|(
name|struct
name|file
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|svr4_strioctl
modifier|*
parameter_list|,
name|struct
name|thread
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|si_sockparams
parameter_list|(
name|struct
name|file
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|svr4_strioctl
modifier|*
parameter_list|,
name|struct
name|thread
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|si_shutdown
parameter_list|(
name|struct
name|file
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|svr4_strioctl
modifier|*
parameter_list|,
name|struct
name|thread
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|si_getudata
parameter_list|(
name|struct
name|file
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|svr4_strioctl
modifier|*
parameter_list|,
name|struct
name|thread
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* i_str timod calls */
end_comment

begin_function_decl
specifier|static
name|int
name|timod
parameter_list|(
name|struct
name|file
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|svr4_strioctl
modifier|*
parameter_list|,
name|struct
name|thread
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ti_getinfo
parameter_list|(
name|struct
name|file
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|svr4_strioctl
modifier|*
parameter_list|,
name|struct
name|thread
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|ti_bind
parameter_list|(
name|struct
name|file
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|svr4_strioctl
modifier|*
parameter_list|,
name|struct
name|thread
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG_SVR4
end_ifdef

begin_function_decl
specifier|static
name|void
name|bufprint
parameter_list|(
name|u_char
modifier|*
parameter_list|,
name|size_t
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|show_ioc
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
name|struct
name|svr4_strioctl
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|show_strbuf
parameter_list|(
name|struct
name|svr4_strbuf
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|show_msg
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|,
name|int
parameter_list|,
name|struct
name|svr4_strbuf
modifier|*
parameter_list|,
name|struct
name|svr4_strbuf
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|bufprint
parameter_list|(
name|buf
parameter_list|,
name|len
parameter_list|)
name|u_char
modifier|*
name|buf
decl_stmt|;
name|size_t
name|len
decl_stmt|;
block|{
name|size_t
name|i
decl_stmt|;
name|uprintf
argument_list|(
literal|"\n\t"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
name|uprintf
argument_list|(
literal|"%x "
argument_list|,
name|buf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|&&
operator|(
name|i
operator|%
literal|16
operator|)
operator|==
literal|0
condition|)
name|uprintf
argument_list|(
literal|"\n\t"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|show_ioc
parameter_list|(
name|str
parameter_list|,
name|ioc
parameter_list|)
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|struct
name|svr4_strioctl
modifier|*
name|ioc
decl_stmt|;
block|{
name|u_char
modifier|*
name|ptr
init|=
name|NULL
decl_stmt|;
name|int
name|len
decl_stmt|;
name|int
name|error
decl_stmt|;
name|len
operator|=
name|ioc
operator|->
name|len
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|1024
condition|)
name|len
operator|=
literal|1024
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|0
condition|)
block|{
name|ptr
operator|=
operator|(
name|u_char
operator|*
operator|)
name|malloc
argument_list|(
name|len
argument_list|,
name|M_TEMP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|ioc
operator|->
name|buf
argument_list|,
name|ptr
argument_list|,
name|len
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ptr
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
block|}
name|uprintf
argument_list|(
literal|"%s cmd = %ld, timeout = %d, len = %d, buf = %p { "
argument_list|,
name|str
argument_list|,
name|ioc
operator|->
name|cmd
argument_list|,
name|ioc
operator|->
name|timeout
argument_list|,
name|ioc
operator|->
name|len
argument_list|,
name|ioc
operator|->
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|!=
name|NULL
condition|)
name|bufprint
argument_list|(
name|ptr
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|uprintf
argument_list|(
literal|"}\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
operator|!=
name|NULL
condition|)
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ptr
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|show_strbuf
parameter_list|(
name|str
parameter_list|)
name|struct
name|svr4_strbuf
modifier|*
name|str
decl_stmt|;
block|{
name|int
name|error
decl_stmt|;
name|u_char
modifier|*
name|ptr
init|=
name|NULL
decl_stmt|;
name|int
name|maxlen
init|=
name|str
operator|->
name|maxlen
decl_stmt|;
name|int
name|len
init|=
name|str
operator|->
name|len
decl_stmt|;
if|if
condition|(
name|maxlen
operator|>
literal|8192
condition|)
name|maxlen
operator|=
literal|8192
expr_stmt|;
if|if
condition|(
name|maxlen
operator|<
literal|0
condition|)
name|maxlen
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|len
operator|>=
name|maxlen
condition|)
name|len
operator|=
name|maxlen
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|0
condition|)
block|{
name|ptr
operator|=
operator|(
name|u_char
operator|*
operator|)
name|malloc
argument_list|(
name|len
argument_list|,
name|M_TEMP
argument_list|,
name|M_WAITOK
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|str
operator|->
name|buf
argument_list|,
name|ptr
argument_list|,
name|len
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ptr
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
block|}
name|uprintf
argument_list|(
literal|", { %d, %d, %p=[ "
argument_list|,
name|str
operator|->
name|maxlen
argument_list|,
name|str
operator|->
name|len
argument_list|,
name|str
operator|->
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
condition|)
name|bufprint
argument_list|(
name|ptr
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|uprintf
argument_list|(
literal|"]}"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptr
condition|)
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ptr
argument_list|,
name|M_TEMP
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|show_msg
parameter_list|(
name|str
parameter_list|,
name|fd
parameter_list|,
name|ctl
parameter_list|,
name|dat
parameter_list|,
name|flags
parameter_list|)
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|struct
name|svr4_strbuf
modifier|*
name|ctl
decl_stmt|;
name|struct
name|svr4_strbuf
modifier|*
name|dat
decl_stmt|;
name|int
name|flags
decl_stmt|;
block|{
name|struct
name|svr4_strbuf
name|buf
decl_stmt|;
name|int
name|error
decl_stmt|;
name|uprintf
argument_list|(
literal|"%s(%d"
argument_list|,
name|str
argument_list|,
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctl
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|ctl
argument_list|,
operator|&
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return;
name|show_strbuf
argument_list|(
operator|&
name|buf
argument_list|)
expr_stmt|;
block|}
else|else
name|uprintf
argument_list|(
literal|", NULL"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dat
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|dat
argument_list|,
operator|&
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return;
name|show_strbuf
argument_list|(
operator|&
name|buf
argument_list|)
expr_stmt|;
block|}
else|else
name|uprintf
argument_list|(
literal|", NULL"
argument_list|)
expr_stmt|;
name|uprintf
argument_list|(
literal|", %x);\n"
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* DEBUG_SVR4 */
end_comment

begin_comment
comment|/*  * We are faced with an interesting situation. On svr4 unix sockets  * are really pipes. But we really have sockets, and we might as  * well use them. At the point where svr4 calls TI_BIND, it has  * already created a named pipe for the socket using mknod(2).  * We need to create a socket with the same name when we bind,  * so we need to remove the pipe before, otherwise we'll get address  * already in use. So we *carefully* remove the pipe, to avoid  * using this as a random file removal tool. We use system calls  * to avoid code duplication.  */
end_comment

begin_function
specifier|static
name|int
name|clean_pipe
parameter_list|(
name|td
parameter_list|,
name|path
parameter_list|)
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|char
modifier|*
name|path
decl_stmt|;
block|{
name|struct
name|stat
name|st
decl_stmt|;
name|int
name|error
decl_stmt|;
name|error
operator|=
name|kern_lstat
argument_list|(
name|td
argument_list|,
name|path
argument_list|,
name|UIO_SYSSPACE
argument_list|,
operator|&
name|st
argument_list|)
expr_stmt|;
comment|/* 	 * Make sure we are dealing with a mode 0 named pipe. 	 */
if|if
condition|(
operator|(
name|st
operator|.
name|st_mode
operator|&
name|S_IFMT
operator|)
operator|!=
name|S_IFIFO
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
operator|(
name|st
operator|.
name|st_mode
operator|&
name|ALLPERMS
operator|)
operator|!=
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|error
operator|=
name|kern_unlink
argument_list|(
name|td
argument_list|,
name|path
argument_list|,
name|UIO_SYSSPACE
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
name|DPRINTF
argument_list|(
operator|(
literal|"clean_pipe: unlink failed %d\n"
operator|,
name|error
operator|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sockaddr_to_netaddr_in
parameter_list|(
name|sc
parameter_list|,
name|sain
parameter_list|)
name|struct
name|svr4_strmcmd
modifier|*
name|sc
decl_stmt|;
specifier|const
name|struct
name|sockaddr_in
modifier|*
name|sain
decl_stmt|;
block|{
name|struct
name|svr4_netaddr_in
modifier|*
name|na
decl_stmt|;
name|na
operator|=
name|SVR4_ADDROF
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|na
operator|->
name|family
operator|=
name|sain
operator|->
name|sin_family
expr_stmt|;
name|na
operator|->
name|port
operator|=
name|sain
operator|->
name|sin_port
expr_stmt|;
name|na
operator|->
name|addr
operator|=
name|sain
operator|->
name|sin_addr
operator|.
name|s_addr
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"sockaddr_in -> netaddr %d %d %lx\n"
operator|,
name|na
operator|->
name|family
operator|,
name|na
operator|->
name|port
operator|,
name|na
operator|->
name|addr
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sockaddr_to_netaddr_un
parameter_list|(
name|sc
parameter_list|,
name|saun
parameter_list|)
name|struct
name|svr4_strmcmd
modifier|*
name|sc
decl_stmt|;
specifier|const
name|struct
name|sockaddr_un
modifier|*
name|saun
decl_stmt|;
block|{
name|struct
name|svr4_netaddr_un
modifier|*
name|na
decl_stmt|;
name|char
modifier|*
name|dst
decl_stmt|,
modifier|*
name|edst
init|=
operator|(
operator|(
name|char
operator|*
operator|)
name|sc
operator|)
operator|+
name|sc
operator|->
name|offs
operator|+
sizeof|sizeof
argument_list|(
name|na
operator|->
name|family
argument_list|)
operator|+
literal|1
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|sc
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|src
decl_stmt|;
name|na
operator|=
name|SVR4_ADDROF
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|na
operator|->
name|family
operator|=
name|saun
operator|->
name|sun_family
expr_stmt|;
for|for
control|(
name|src
operator|=
name|saun
operator|->
name|sun_path
operator|,
name|dst
operator|=
name|na
operator|->
name|path
init|;
operator|(
operator|*
name|dst
operator|++
operator|=
operator|*
name|src
operator|++
operator|)
operator|!=
literal|'\0'
condition|;
control|)
if|if
condition|(
name|dst
operator|==
name|edst
condition|)
break|break;
name|DPRINTF
argument_list|(
operator|(
literal|"sockaddr_un -> netaddr %d %s\n"
operator|,
name|na
operator|->
name|family
operator|,
name|na
operator|->
name|path
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|netaddr_to_sockaddr_in
parameter_list|(
name|sain
parameter_list|,
name|sc
parameter_list|)
name|struct
name|sockaddr_in
modifier|*
name|sain
decl_stmt|;
specifier|const
name|struct
name|svr4_strmcmd
modifier|*
name|sc
decl_stmt|;
block|{
specifier|const
name|struct
name|svr4_netaddr_in
modifier|*
name|na
decl_stmt|;
name|na
operator|=
name|SVR4_C_ADDROF
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|sain
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sain
argument_list|)
argument_list|)
expr_stmt|;
name|sain
operator|->
name|sin_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|sain
argument_list|)
expr_stmt|;
name|sain
operator|->
name|sin_family
operator|=
name|na
operator|->
name|family
expr_stmt|;
name|sain
operator|->
name|sin_port
operator|=
name|na
operator|->
name|port
expr_stmt|;
name|sain
operator|->
name|sin_addr
operator|.
name|s_addr
operator|=
name|na
operator|->
name|addr
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"netaddr -> sockaddr_in %d %d %x\n"
operator|,
name|sain
operator|->
name|sin_family
operator|,
name|sain
operator|->
name|sin_port
operator|,
name|sain
operator|->
name|sin_addr
operator|.
name|s_addr
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|netaddr_to_sockaddr_un
parameter_list|(
name|saun
parameter_list|,
name|sc
parameter_list|)
name|struct
name|sockaddr_un
modifier|*
name|saun
decl_stmt|;
specifier|const
name|struct
name|svr4_strmcmd
modifier|*
name|sc
decl_stmt|;
block|{
specifier|const
name|struct
name|svr4_netaddr_un
modifier|*
name|na
decl_stmt|;
name|char
modifier|*
name|dst
decl_stmt|,
modifier|*
name|edst
init|=
operator|&
name|saun
operator|->
name|sun_path
index|[
sizeof|sizeof
argument_list|(
name|saun
operator|->
name|sun_path
argument_list|)
operator|-
literal|1
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|src
decl_stmt|;
name|na
operator|=
name|SVR4_C_ADDROF
argument_list|(
name|sc
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|saun
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|saun
argument_list|)
argument_list|)
expr_stmt|;
name|saun
operator|->
name|sun_family
operator|=
name|na
operator|->
name|family
expr_stmt|;
for|for
control|(
name|src
operator|=
name|na
operator|->
name|path
operator|,
name|dst
operator|=
name|saun
operator|->
name|sun_path
init|;
operator|(
operator|*
name|dst
operator|++
operator|=
operator|*
name|src
operator|++
operator|)
operator|!=
literal|'\0'
condition|;
control|)
if|if
condition|(
name|dst
operator|==
name|edst
condition|)
break|break;
name|saun
operator|->
name|sun_len
operator|=
name|dst
operator|-
name|saun
operator|->
name|sun_path
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"netaddr -> sockaddr_un %d %s\n"
operator|,
name|saun
operator|->
name|sun_family
operator|,
name|saun
operator|->
name|sun_path
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|getparm
parameter_list|(
name|fp
parameter_list|,
name|pa
parameter_list|)
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|struct
name|svr4_si_sockparms
modifier|*
name|pa
decl_stmt|;
block|{
name|struct
name|svr4_strm
modifier|*
name|st
decl_stmt|;
name|struct
name|socket
modifier|*
name|so
decl_stmt|;
name|st
operator|=
name|svr4_stream_get
argument_list|(
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|st
operator|==
name|NULL
condition|)
return|return;
name|so
operator|=
name|fp
operator|->
name|f_data
expr_stmt|;
name|pa
operator|->
name|family
operator|=
name|st
operator|->
name|s_family
expr_stmt|;
switch|switch
condition|(
name|so
operator|->
name|so_type
condition|)
block|{
case|case
name|SOCK_DGRAM
case|:
name|pa
operator|->
name|type
operator|=
name|SVR4_T_CLTS
expr_stmt|;
name|pa
operator|->
name|protocol
operator|=
name|IPPROTO_UDP
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"getparm(dgram)\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
case|case
name|SOCK_STREAM
case|:
name|pa
operator|->
name|type
operator|=
name|SVR4_T_COTS
expr_stmt|;
comment|/* What about T_COTS_ORD? XXX */
name|pa
operator|->
name|protocol
operator|=
name|IPPROTO_IP
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"getparm(stream)\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
case|case
name|SOCK_RAW
case|:
name|pa
operator|->
name|type
operator|=
name|SVR4_T_CLTS
expr_stmt|;
name|pa
operator|->
name|protocol
operator|=
name|IPPROTO_RAW
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"getparm(raw)\n"
operator|)
argument_list|)
expr_stmt|;
return|return;
default|default:
name|pa
operator|->
name|type
operator|=
literal|0
expr_stmt|;
name|pa
operator|->
name|protocol
operator|=
literal|0
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"getparm(type %d?)\n"
operator|,
name|so
operator|->
name|so_type
operator|)
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|si_ogetudata
parameter_list|(
name|fp
parameter_list|,
name|fd
parameter_list|,
name|ioc
parameter_list|,
name|td
parameter_list|)
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|struct
name|svr4_strioctl
modifier|*
name|ioc
decl_stmt|;
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
block|{
name|int
name|error
decl_stmt|;
name|struct
name|svr4_si_oudata
name|ud
decl_stmt|;
name|struct
name|svr4_si_sockparms
name|pa
decl_stmt|;
if|if
condition|(
name|ioc
operator|->
name|len
operator|!=
sizeof|sizeof
argument_list|(
name|ud
argument_list|)
operator|&&
name|ioc
operator|->
name|len
operator|!=
sizeof|sizeof
argument_list|(
name|ud
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
name|int
argument_list|)
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"SI_OGETUDATA: Wrong size %d != %d\n"
operator|,
sizeof|sizeof
argument_list|(
name|ud
argument_list|)
operator|,
name|ioc
operator|->
name|len
operator|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|ioc
operator|->
name|buf
argument_list|,
operator|&
name|ud
argument_list|,
sizeof|sizeof
argument_list|(
name|ud
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
name|getparm
argument_list|(
name|fp
argument_list|,
operator|&
name|pa
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|pa
operator|.
name|family
condition|)
block|{
case|case
name|AF_INET
case|:
name|ud
operator|.
name|tidusize
operator|=
literal|16384
expr_stmt|;
name|ud
operator|.
name|addrsize
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|svr4_sockaddr_in
argument_list|)
expr_stmt|;
if|if
condition|(
name|pa
operator|.
name|type
operator|==
name|SVR4_SOCK_STREAM
condition|)
name|ud
operator|.
name|etsdusize
operator|=
literal|1
expr_stmt|;
else|else
name|ud
operator|.
name|etsdusize
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|AF_LOCAL
case|:
name|ud
operator|.
name|tidusize
operator|=
literal|65536
expr_stmt|;
name|ud
operator|.
name|addrsize
operator|=
literal|128
expr_stmt|;
name|ud
operator|.
name|etsdusize
operator|=
literal|128
expr_stmt|;
break|break;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"SI_OGETUDATA: Unsupported address family %d\n"
operator|,
name|pa
operator|.
name|family
operator|)
argument_list|)
expr_stmt|;
return|return
name|ENOSYS
return|;
block|}
comment|/* I have no idea what these should be! */
name|ud
operator|.
name|optsize
operator|=
literal|128
expr_stmt|;
name|ud
operator|.
name|tsdusize
operator|=
literal|128
expr_stmt|;
name|ud
operator|.
name|servtype
operator|=
name|pa
operator|.
name|type
expr_stmt|;
comment|/* XXX: Fixme */
name|ud
operator|.
name|so_state
operator|=
literal|0
expr_stmt|;
name|ud
operator|.
name|so_options
operator|=
literal|0
expr_stmt|;
return|return
name|copyout
argument_list|(
operator|&
name|ud
argument_list|,
name|ioc
operator|->
name|buf
argument_list|,
name|ioc
operator|->
name|len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|si_sockparams
parameter_list|(
name|fp
parameter_list|,
name|fd
parameter_list|,
name|ioc
parameter_list|,
name|td
parameter_list|)
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|struct
name|svr4_strioctl
modifier|*
name|ioc
decl_stmt|;
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
block|{
name|struct
name|svr4_si_sockparms
name|pa
decl_stmt|;
name|getparm
argument_list|(
name|fp
argument_list|,
operator|&
name|pa
argument_list|)
expr_stmt|;
return|return
name|copyout
argument_list|(
operator|&
name|pa
argument_list|,
name|ioc
operator|->
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|pa
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|si_listen
parameter_list|(
name|fp
parameter_list|,
name|fd
parameter_list|,
name|ioc
parameter_list|,
name|td
parameter_list|)
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|struct
name|svr4_strioctl
modifier|*
name|ioc
decl_stmt|;
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
block|{
name|int
name|error
decl_stmt|;
name|struct
name|svr4_strm
modifier|*
name|st
init|=
name|svr4_stream_get
argument_list|(
name|fp
argument_list|)
decl_stmt|;
name|struct
name|svr4_strmcmd
name|lst
decl_stmt|;
name|struct
name|listen_args
name|la
decl_stmt|;
if|if
condition|(
name|st
operator|==
name|NULL
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
name|ioc
operator|->
name|len
operator|<
literal|0
operator|||
name|ioc
operator|->
name|len
operator|>
sizeof|sizeof
argument_list|(
name|lst
argument_list|)
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|ioc
operator|->
name|buf
argument_list|,
operator|&
name|lst
argument_list|,
name|ioc
operator|->
name|len
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
if|if
condition|(
name|lst
operator|.
name|cmd
operator|!=
name|SVR4_TI_OLD_BIND_REQUEST
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"si_listen: bad request %ld\n"
operator|,
name|lst
operator|.
name|cmd
operator|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
comment|/* 	 * We are making assumptions again... 	 */
name|la
operator|.
name|s
operator|=
name|fd
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"SI_LISTEN: fileno %d backlog = %d\n"
operator|,
name|fd
operator|,
literal|5
operator|)
argument_list|)
expr_stmt|;
name|la
operator|.
name|backlog
operator|=
literal|5
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|sys_listen
argument_list|(
name|td
argument_list|,
operator|&
name|la
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"SI_LISTEN: listen failed %d\n"
operator|,
name|error
operator|)
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|st
operator|->
name|s_cmd
operator|=
name|SVR4_TI__ACCEPT_WAIT
expr_stmt|;
name|lst
operator|.
name|cmd
operator|=
name|SVR4_TI_BIND_REPLY
expr_stmt|;
switch|switch
condition|(
name|st
operator|->
name|s_family
condition|)
block|{
case|case
name|AF_INET
case|:
comment|/* XXX: Fill the length here */
break|break;
case|case
name|AF_LOCAL
case|:
name|lst
operator|.
name|len
operator|=
literal|140
expr_stmt|;
name|lst
operator|.
name|pad
index|[
literal|28
index|]
operator|=
literal|0x00000000
expr_stmt|;
comment|/* magic again */
name|lst
operator|.
name|pad
index|[
literal|29
index|]
operator|=
literal|0x00000800
expr_stmt|;
comment|/* magic again */
name|lst
operator|.
name|pad
index|[
literal|30
index|]
operator|=
literal|0x80001400
expr_stmt|;
comment|/* magic again */
break|break;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"SI_LISTEN: Unsupported address family %d\n"
operator|,
name|st
operator|->
name|s_family
operator|)
argument_list|)
expr_stmt|;
return|return
name|ENOSYS
return|;
block|}
if|if
condition|(
operator|(
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|lst
argument_list|,
name|ioc
operator|->
name|buf
argument_list|,
name|ioc
operator|->
name|len
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|si_getudata
parameter_list|(
name|fp
parameter_list|,
name|fd
parameter_list|,
name|ioc
parameter_list|,
name|td
parameter_list|)
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|struct
name|svr4_strioctl
modifier|*
name|ioc
decl_stmt|;
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
block|{
name|int
name|error
decl_stmt|;
name|struct
name|svr4_si_udata
name|ud
decl_stmt|;
if|if
condition|(
sizeof|sizeof
argument_list|(
name|ud
argument_list|)
operator|!=
name|ioc
operator|->
name|len
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"SI_GETUDATA: Wrong size %d != %d\n"
operator|,
sizeof|sizeof
argument_list|(
name|ud
argument_list|)
operator|,
name|ioc
operator|->
name|len
operator|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|ioc
operator|->
name|buf
argument_list|,
operator|&
name|ud
argument_list|,
sizeof|sizeof
argument_list|(
name|ud
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
name|getparm
argument_list|(
name|fp
argument_list|,
operator|&
name|ud
operator|.
name|sockparms
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ud
operator|.
name|sockparms
operator|.
name|family
condition|)
block|{
case|case
name|AF_INET
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"getudata_inet\n"
operator|)
argument_list|)
expr_stmt|;
name|ud
operator|.
name|tidusize
operator|=
literal|16384
expr_stmt|;
name|ud
operator|.
name|tsdusize
operator|=
literal|16384
expr_stmt|;
name|ud
operator|.
name|addrsize
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|svr4_sockaddr_in
argument_list|)
expr_stmt|;
if|if
condition|(
name|ud
operator|.
name|sockparms
operator|.
name|type
operator|==
name|SVR4_SOCK_STREAM
condition|)
name|ud
operator|.
name|etsdusize
operator|=
literal|1
expr_stmt|;
else|else
name|ud
operator|.
name|etsdusize
operator|=
literal|0
expr_stmt|;
name|ud
operator|.
name|optsize
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|AF_LOCAL
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"getudata_local\n"
operator|)
argument_list|)
expr_stmt|;
name|ud
operator|.
name|tidusize
operator|=
literal|65536
expr_stmt|;
name|ud
operator|.
name|tsdusize
operator|=
literal|128
expr_stmt|;
name|ud
operator|.
name|addrsize
operator|=
literal|128
expr_stmt|;
name|ud
operator|.
name|etsdusize
operator|=
literal|128
expr_stmt|;
name|ud
operator|.
name|optsize
operator|=
literal|128
expr_stmt|;
break|break;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"SI_GETUDATA: Unsupported address family %d\n"
operator|,
name|ud
operator|.
name|sockparms
operator|.
name|family
operator|)
argument_list|)
expr_stmt|;
return|return
name|ENOSYS
return|;
block|}
name|ud
operator|.
name|servtype
operator|=
name|ud
operator|.
name|sockparms
operator|.
name|type
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"ud.servtype = %d\n"
operator|,
name|ud
operator|.
name|servtype
operator|)
argument_list|)
expr_stmt|;
comment|/* XXX: Fixme */
name|ud
operator|.
name|so_state
operator|=
literal|0
expr_stmt|;
name|ud
operator|.
name|so_options
operator|=
literal|0
expr_stmt|;
return|return
name|copyout
argument_list|(
operator|&
name|ud
argument_list|,
name|ioc
operator|->
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|ud
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|si_shutdown
parameter_list|(
name|fp
parameter_list|,
name|fd
parameter_list|,
name|ioc
parameter_list|,
name|td
parameter_list|)
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|struct
name|svr4_strioctl
modifier|*
name|ioc
decl_stmt|;
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
block|{
name|int
name|error
decl_stmt|;
name|struct
name|shutdown_args
name|ap
decl_stmt|;
if|if
condition|(
name|ioc
operator|->
name|len
operator|!=
sizeof|sizeof
argument_list|(
name|ap
operator|.
name|how
argument_list|)
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"SI_SHUTDOWN: Wrong size %d != %d\n"
operator|,
sizeof|sizeof
argument_list|(
name|ap
operator|.
name|how
argument_list|)
operator|,
name|ioc
operator|->
name|len
operator|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|ioc
operator|->
name|buf
argument_list|,
operator|&
name|ap
operator|.
name|how
argument_list|,
name|ioc
operator|->
name|len
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
name|ap
operator|.
name|s
operator|=
name|fd
expr_stmt|;
return|return
name|sys_shutdown
argument_list|(
name|td
argument_list|,
operator|&
name|ap
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sockmod
parameter_list|(
name|fp
parameter_list|,
name|fd
parameter_list|,
name|ioc
parameter_list|,
name|td
parameter_list|)
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|struct
name|svr4_strioctl
modifier|*
name|ioc
decl_stmt|;
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
block|{
switch|switch
condition|(
name|ioc
operator|->
name|cmd
condition|)
block|{
case|case
name|SVR4_SI_OGETUDATA
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"SI_OGETUDATA\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|si_ogetudata
argument_list|(
name|fp
argument_list|,
name|fd
argument_list|,
name|ioc
argument_list|,
name|td
argument_list|)
return|;
case|case
name|SVR4_SI_SHUTDOWN
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"SI_SHUTDOWN\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|si_shutdown
argument_list|(
name|fp
argument_list|,
name|fd
argument_list|,
name|ioc
argument_list|,
name|td
argument_list|)
return|;
case|case
name|SVR4_SI_LISTEN
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"SI_LISTEN\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|si_listen
argument_list|(
name|fp
argument_list|,
name|fd
argument_list|,
name|ioc
argument_list|,
name|td
argument_list|)
return|;
case|case
name|SVR4_SI_SETMYNAME
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"SI_SETMYNAME\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_SI_SETPEERNAME
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"SI_SETPEERNAME\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_SI_GETINTRANSIT
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"SI_GETINTRANSIT\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_SI_TCL_LINK
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"SI_TCL_LINK\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_SI_TCL_UNLINK
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"SI_TCL_UNLINK\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_SI_SOCKPARAMS
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"SI_SOCKPARAMS\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|si_sockparams
argument_list|(
name|fp
argument_list|,
name|fd
argument_list|,
name|ioc
argument_list|,
name|td
argument_list|)
return|;
case|case
name|SVR4_SI_GETUDATA
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"SI_GETUDATA\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|si_getudata
argument_list|(
name|fp
argument_list|,
name|fd
argument_list|,
name|ioc
argument_list|,
name|td
argument_list|)
return|;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"Unknown sockmod ioctl %lx\n"
operator|,
name|ioc
operator|->
name|cmd
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ti_getinfo
parameter_list|(
name|fp
parameter_list|,
name|fd
parameter_list|,
name|ioc
parameter_list|,
name|td
parameter_list|)
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|struct
name|svr4_strioctl
modifier|*
name|ioc
decl_stmt|;
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
block|{
name|int
name|error
decl_stmt|;
name|struct
name|svr4_infocmd
name|info
decl_stmt|;
name|memset
argument_list|(
operator|&
name|info
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioc
operator|->
name|len
operator|<
literal|0
operator|||
name|ioc
operator|->
name|len
operator|>
sizeof|sizeof
argument_list|(
name|info
argument_list|)
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|ioc
operator|->
name|buf
argument_list|,
operator|&
name|info
argument_list|,
name|ioc
operator|->
name|len
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
if|if
condition|(
name|info
operator|.
name|cmd
operator|!=
name|SVR4_TI_INFO_REQUEST
condition|)
return|return
name|EINVAL
return|;
name|info
operator|.
name|cmd
operator|=
name|SVR4_TI_INFO_REPLY
expr_stmt|;
name|info
operator|.
name|tsdu
operator|=
literal|0
expr_stmt|;
name|info
operator|.
name|etsdu
operator|=
literal|1
expr_stmt|;
name|info
operator|.
name|cdata
operator|=
operator|-
literal|2
expr_stmt|;
name|info
operator|.
name|ddata
operator|=
operator|-
literal|2
expr_stmt|;
name|info
operator|.
name|addr
operator|=
literal|16
expr_stmt|;
name|info
operator|.
name|opt
operator|=
operator|-
literal|1
expr_stmt|;
name|info
operator|.
name|tidu
operator|=
literal|16384
expr_stmt|;
name|info
operator|.
name|serv
operator|=
literal|2
expr_stmt|;
name|info
operator|.
name|current
operator|=
literal|0
expr_stmt|;
name|info
operator|.
name|provider
operator|=
literal|2
expr_stmt|;
name|ioc
operator|->
name|len
operator|=
sizeof|sizeof
argument_list|(
name|info
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|info
argument_list|,
name|ioc
operator|->
name|buf
argument_list|,
name|ioc
operator|->
name|len
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ti_bind
parameter_list|(
name|fp
parameter_list|,
name|fd
parameter_list|,
name|ioc
parameter_list|,
name|td
parameter_list|)
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|struct
name|svr4_strioctl
modifier|*
name|ioc
decl_stmt|;
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
block|{
name|int
name|error
decl_stmt|;
name|struct
name|svr4_strm
modifier|*
name|st
init|=
name|svr4_stream_get
argument_list|(
name|fp
argument_list|)
decl_stmt|;
name|struct
name|sockaddr_in
name|sain
decl_stmt|;
name|struct
name|sockaddr_un
name|saun
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|skp
decl_stmt|;
name|int
name|sasize
decl_stmt|;
name|struct
name|svr4_strmcmd
name|bnd
decl_stmt|;
if|if
condition|(
name|st
operator|==
name|NULL
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"ti_bind: bad file descriptor\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
if|if
condition|(
name|ioc
operator|->
name|len
operator|<
literal|0
operator|||
name|ioc
operator|->
name|len
operator|>
sizeof|sizeof
argument_list|(
name|bnd
argument_list|)
condition|)
return|return
name|EINVAL
return|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|ioc
operator|->
name|buf
argument_list|,
operator|&
name|bnd
argument_list|,
name|ioc
operator|->
name|len
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
if|if
condition|(
name|bnd
operator|.
name|cmd
operator|!=
name|SVR4_TI_OLD_BIND_REQUEST
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"ti_bind: bad request %ld\n"
operator|,
name|bnd
operator|.
name|cmd
operator|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
switch|switch
condition|(
name|st
operator|->
name|s_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|skp
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sain
expr_stmt|;
name|sasize
operator|=
sizeof|sizeof
argument_list|(
name|sain
argument_list|)
expr_stmt|;
if|if
condition|(
name|bnd
operator|.
name|offs
operator|==
literal|0
condition|)
goto|goto
name|error
goto|;
name|netaddr_to_sockaddr_in
argument_list|(
operator|&
name|sain
argument_list|,
operator|&
name|bnd
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"TI_BIND: fam %d, port %d, addr %x\n"
operator|,
name|sain
operator|.
name|sin_family
operator|,
name|sain
operator|.
name|sin_port
operator|,
name|sain
operator|.
name|sin_addr
operator|.
name|s_addr
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_LOCAL
case|:
name|skp
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|saun
expr_stmt|;
name|sasize
operator|=
sizeof|sizeof
argument_list|(
name|saun
argument_list|)
expr_stmt|;
if|if
condition|(
name|bnd
operator|.
name|offs
operator|==
literal|0
condition|)
goto|goto
name|error
goto|;
name|netaddr_to_sockaddr_un
argument_list|(
operator|&
name|saun
argument_list|,
operator|&
name|bnd
argument_list|)
expr_stmt|;
if|if
condition|(
name|saun
operator|.
name|sun_path
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
goto|goto
name|error
goto|;
name|DPRINTF
argument_list|(
operator|(
literal|"TI_BIND: fam %d, path %s\n"
operator|,
name|saun
operator|.
name|sun_family
operator|,
name|saun
operator|.
name|sun_path
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|clean_pipe
argument_list|(
name|td
argument_list|,
name|saun
operator|.
name|sun_path
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
name|bnd
operator|.
name|pad
index|[
literal|28
index|]
operator|=
literal|0x00001000
expr_stmt|;
comment|/* magic again */
break|break;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"TI_BIND: Unsupported address family %d\n"
operator|,
name|st
operator|->
name|s_family
operator|)
argument_list|)
expr_stmt|;
return|return
name|ENOSYS
return|;
block|}
name|DPRINTF
argument_list|(
operator|(
literal|"TI_BIND: fileno %d\n"
operator|,
name|fd
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|kern_bind
argument_list|(
name|td
argument_list|,
name|fd
argument_list|,
name|skp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"TI_BIND: bind failed %d\n"
operator|,
name|error
operator|)
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
goto|goto
name|reply
goto|;
name|error
label|:
name|memset
argument_list|(
operator|&
name|bnd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|bnd
argument_list|)
argument_list|)
expr_stmt|;
name|bnd
operator|.
name|len
operator|=
name|sasize
operator|+
literal|4
expr_stmt|;
name|bnd
operator|.
name|offs
operator|=
literal|0x10
expr_stmt|;
comment|/* XXX */
name|reply
label|:
name|bnd
operator|.
name|cmd
operator|=
name|SVR4_TI_BIND_REPLY
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|bnd
argument_list|,
name|ioc
operator|->
name|buf
argument_list|,
name|ioc
operator|->
name|len
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|timod
parameter_list|(
name|fp
parameter_list|,
name|fd
parameter_list|,
name|ioc
parameter_list|,
name|td
parameter_list|)
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|struct
name|svr4_strioctl
modifier|*
name|ioc
decl_stmt|;
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
block|{
switch|switch
condition|(
name|ioc
operator|->
name|cmd
condition|)
block|{
case|case
name|SVR4_TI_GETINFO
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"TI_GETINFO\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|ti_getinfo
argument_list|(
name|fp
argument_list|,
name|fd
argument_list|,
name|ioc
argument_list|,
name|td
argument_list|)
return|;
case|case
name|SVR4_TI_OPTMGMT
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"TI_OPTMGMT\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_TI_BIND
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"TI_BIND\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|ti_bind
argument_list|(
name|fp
argument_list|,
name|fd
argument_list|,
name|ioc
argument_list|,
name|td
argument_list|)
return|;
case|case
name|SVR4_TI_UNBIND
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"TI_UNBIND\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"Unknown timod ioctl %lx\n"
operator|,
name|ioc
operator|->
name|cmd
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
name|int
name|svr4_stream_ti_ioctl
parameter_list|(
name|fp
parameter_list|,
name|td
parameter_list|,
name|retval
parameter_list|,
name|fd
parameter_list|,
name|cmd
parameter_list|,
name|dat
parameter_list|)
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|register_t
modifier|*
name|retval
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|u_long
name|cmd
decl_stmt|;
name|caddr_t
name|dat
decl_stmt|;
block|{
name|struct
name|svr4_strbuf
name|skb
decl_stmt|,
modifier|*
name|sub
init|=
operator|(
expr|struct
name|svr4_strbuf
operator|*
operator|)
name|dat
decl_stmt|;
name|struct
name|svr4_strm
modifier|*
name|st
init|=
name|svr4_stream_get
argument_list|(
name|fp
argument_list|)
decl_stmt|;
name|int
name|error
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
name|socklen_t
name|sasize
decl_stmt|,
name|oldsasize
decl_stmt|;
name|struct
name|svr4_strmcmd
name|sc
decl_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"svr4_stream_ti_ioctl\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|st
operator|==
name|NULL
condition|)
return|return
name|EINVAL
return|;
name|sc
operator|.
name|offs
operator|=
literal|0x10
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|sub
argument_list|,
operator|&
name|skb
argument_list|,
sizeof|sizeof
argument_list|(
name|skb
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"ti_ioctl: error copying in strbuf\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
switch|switch
condition|(
name|st
operator|->
name|s_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|sasize
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_in
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_LOCAL
case|:
name|sasize
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_un
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"ti_ioctl: Unsupported address family %d\n"
operator|,
name|st
operator|->
name|s_family
operator|)
argument_list|)
expr_stmt|;
return|return
name|ENOSYS
return|;
block|}
name|oldsasize
operator|=
name|sasize
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SVR4_TI_GETMYNAME
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"TI_GETMYNAME\n"
operator|)
argument_list|)
expr_stmt|;
block|{
name|error
operator|=
name|kern_getsockname
argument_list|(
name|td
argument_list|,
name|fd
argument_list|,
operator|&
name|sa
argument_list|,
operator|&
name|sasize
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"ti_ioctl: getsockname error\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
block|}
break|break;
case|case
name|SVR4_TI_GETPEERNAME
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"TI_GETPEERNAME\n"
operator|)
argument_list|)
expr_stmt|;
block|{
name|error
operator|=
name|kern_getpeername
argument_list|(
name|td
argument_list|,
name|fd
argument_list|,
operator|&
name|sa
argument_list|,
operator|&
name|sasize
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"ti_ioctl: getpeername error\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
block|}
break|break;
case|case
name|SVR4_TI_SETMYNAME
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"TI_SETMYNAME\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_TI_SETPEERNAME
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"TI_SETPEERNAME\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"ti_ioctl: Unknown ioctl %lx\n"
operator|,
name|cmd
operator|)
argument_list|)
expr_stmt|;
return|return
name|ENOSYS
return|;
block|}
if|if
condition|(
name|sasize
operator|<
literal|0
operator|||
name|sasize
operator|>
name|oldsasize
condition|)
block|{
name|free
argument_list|(
name|sa
argument_list|,
name|M_SONAME
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
switch|switch
condition|(
name|st
operator|->
name|s_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|sockaddr_to_netaddr_in
argument_list|(
operator|&
name|sc
argument_list|,
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|sa
argument_list|)
expr_stmt|;
name|skb
operator|.
name|len
operator|=
name|sasize
expr_stmt|;
break|break;
case|case
name|AF_LOCAL
case|:
name|sockaddr_to_netaddr_un
argument_list|(
operator|&
name|sc
argument_list|,
operator|(
expr|struct
name|sockaddr_un
operator|*
operator|)
name|sa
argument_list|)
expr_stmt|;
name|skb
operator|.
name|len
operator|=
name|sasize
operator|+
literal|4
expr_stmt|;
break|break;
default|default:
name|free
argument_list|(
name|sa
argument_list|,
name|M_SONAME
argument_list|)
expr_stmt|;
return|return
name|ENOSYS
return|;
block|}
name|free
argument_list|(
name|sa
argument_list|,
name|M_SONAME
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyout
argument_list|(
name|SVR4_ADDROF
argument_list|(
operator|&
name|sc
argument_list|)
argument_list|,
name|skb
operator|.
name|buf
argument_list|,
name|sasize
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"ti_ioctl: error copying out socket data\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
if|if
condition|(
operator|(
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|skb
argument_list|,
name|sub
argument_list|,
sizeof|sizeof
argument_list|(
name|skb
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"ti_ioctl: error copying out strbuf\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
return|return
name|error
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i_nread
parameter_list|(
name|fp
parameter_list|,
name|td
parameter_list|,
name|retval
parameter_list|,
name|fd
parameter_list|,
name|cmd
parameter_list|,
name|dat
parameter_list|)
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|register_t
modifier|*
name|retval
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|u_long
name|cmd
decl_stmt|;
name|caddr_t
name|dat
decl_stmt|;
block|{
name|int
name|error
decl_stmt|;
name|int
name|nread
init|=
literal|0
decl_stmt|;
comment|/* 	 * We are supposed to return the message length in nread, and the 	 * number of messages in retval. We don't have the notion of number 	 * of stream messages, so we just find out if we have any bytes waiting 	 * for us, and if we do, then we assume that we have at least one 	 * message waiting for us. 	 */
if|if
condition|(
operator|(
name|error
operator|=
name|fo_ioctl
argument_list|(
name|fp
argument_list|,
name|FIONREAD
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|nread
argument_list|,
name|td
operator|->
name|td_ucred
argument_list|,
name|td
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
if|if
condition|(
name|nread
operator|!=
literal|0
condition|)
operator|*
name|retval
operator|=
literal|1
expr_stmt|;
else|else
operator|*
name|retval
operator|=
literal|0
expr_stmt|;
return|return
name|copyout
argument_list|(
operator|&
name|nread
argument_list|,
name|dat
argument_list|,
sizeof|sizeof
argument_list|(
name|nread
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i_fdinsert
parameter_list|(
name|fp
parameter_list|,
name|td
parameter_list|,
name|retval
parameter_list|,
name|fd
parameter_list|,
name|cmd
parameter_list|,
name|dat
parameter_list|)
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|register_t
modifier|*
name|retval
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|u_long
name|cmd
decl_stmt|;
name|caddr_t
name|dat
decl_stmt|;
block|{
comment|/* 	 * Major hack again here. We assume that we are using this to 	 * implement accept(2). If that is the case, we have already 	 * called accept, and we have stored the file descriptor in 	 * afd. We find the file descriptor that the code wants to use 	 * in fd insert, and then we dup2() our accepted file descriptor 	 * to it. 	 */
name|int
name|error
decl_stmt|;
name|struct
name|svr4_strm
modifier|*
name|st
init|=
name|svr4_stream_get
argument_list|(
name|fp
argument_list|)
decl_stmt|;
name|struct
name|svr4_strfdinsert
name|fdi
decl_stmt|;
name|struct
name|dup2_args
name|d2p
decl_stmt|;
if|if
condition|(
name|st
operator|==
name|NULL
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"fdinsert: bad file type\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|mtx_lock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
if|if
condition|(
name|st
operator|->
name|s_afd
operator|==
operator|-
literal|1
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"fdinsert: accept fd not found\n"
operator|)
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
return|return
name|ENOENT
return|;
block|}
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|dat
argument_list|,
operator|&
name|fdi
argument_list|,
sizeof|sizeof
argument_list|(
name|fdi
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"fdinsert: copyin failed %d\n"
operator|,
name|error
operator|)
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|d2p
operator|.
name|from
operator|=
name|st
operator|->
name|s_afd
expr_stmt|;
name|d2p
operator|.
name|to
operator|=
name|fdi
operator|.
name|fd
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|sys_dup2
argument_list|(
name|td
argument_list|,
operator|&
name|d2p
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"fdinsert: dup2(%d, %d) failed %d\n"
operator|,
name|st
operator|->
name|s_afd
operator|,
name|fdi
operator|.
name|fd
operator|,
name|error
operator|)
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
if|if
condition|(
operator|(
name|error
operator|=
name|kern_close
argument_list|(
name|td
argument_list|,
name|st
operator|->
name|s_afd
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"fdinsert: close(%d) failed %d\n"
operator|,
name|st
operator|->
name|s_afd
operator|,
name|error
operator|)
argument_list|)
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|st
operator|->
name|s_afd
operator|=
operator|-
literal|1
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
operator|*
name|retval
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|_i_bind_rsvd
parameter_list|(
name|fp
parameter_list|,
name|td
parameter_list|,
name|retval
parameter_list|,
name|fd
parameter_list|,
name|cmd
parameter_list|,
name|dat
parameter_list|)
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|register_t
modifier|*
name|retval
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|u_long
name|cmd
decl_stmt|;
name|caddr_t
name|dat
decl_stmt|;
block|{
name|struct
name|mkfifo_args
name|ap
decl_stmt|;
comment|/* 	 * This is a supposed to be a kernel and library only ioctl. 	 * It gets called before ti_bind, when we have a unix  	 * socket, to physically create the socket transport and 	 * ``reserve'' it. I don't know how this get reserved inside 	 * the kernel, but we are going to create it nevertheless. 	 */
name|ap
operator|.
name|path
operator|=
name|dat
expr_stmt|;
name|ap
operator|.
name|mode
operator|=
name|S_IFIFO
expr_stmt|;
return|return
name|sys_mkfifo
argument_list|(
name|td
argument_list|,
operator|&
name|ap
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|_i_rele_rsvd
parameter_list|(
name|fp
parameter_list|,
name|td
parameter_list|,
name|retval
parameter_list|,
name|fd
parameter_list|,
name|cmd
parameter_list|,
name|dat
parameter_list|)
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|register_t
modifier|*
name|retval
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|u_long
name|cmd
decl_stmt|;
name|caddr_t
name|dat
decl_stmt|;
block|{
name|struct
name|unlink_args
name|ap
decl_stmt|;
comment|/* 	 * This is a supposed to be a kernel and library only ioctl. 	 * I guess it is supposed to release the socket. 	 */
name|ap
operator|.
name|path
operator|=
name|dat
expr_stmt|;
return|return
name|sys_unlink
argument_list|(
name|td
argument_list|,
operator|&
name|ap
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i_str
parameter_list|(
name|fp
parameter_list|,
name|td
parameter_list|,
name|retval
parameter_list|,
name|fd
parameter_list|,
name|cmd
parameter_list|,
name|dat
parameter_list|)
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|register_t
modifier|*
name|retval
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|u_long
name|cmd
decl_stmt|;
name|caddr_t
name|dat
decl_stmt|;
block|{
name|int
name|error
decl_stmt|;
name|struct
name|svr4_strioctl
name|ioc
decl_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|dat
argument_list|,
operator|&
name|ioc
argument_list|,
sizeof|sizeof
argument_list|(
name|ioc
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
ifdef|#
directive|ifdef
name|DEBUG_SVR4
if|if
condition|(
operator|(
name|error
operator|=
name|show_ioc
argument_list|(
literal|">"
argument_list|,
operator|&
name|ioc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
endif|#
directive|endif
comment|/* DEBUG_SVR4 */
switch|switch
condition|(
name|ioc
operator|.
name|cmd
operator|&
literal|0xff00
condition|)
block|{
case|case
name|SVR4_SIMOD
case|:
if|if
condition|(
operator|(
name|error
operator|=
name|sockmod
argument_list|(
name|fp
argument_list|,
name|fd
argument_list|,
operator|&
name|ioc
argument_list|,
name|td
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
break|break;
case|case
name|SVR4_TIMOD
case|:
if|if
condition|(
operator|(
name|error
operator|=
name|timod
argument_list|(
name|fp
argument_list|,
name|fd
argument_list|,
operator|&
name|ioc
argument_list|,
name|td
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
break|break;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"Unimplemented module %c %ld\n"
operator|,
call|(
name|char
call|)
argument_list|(
name|cmd
operator|>>
literal|8
argument_list|)
operator|,
name|cmd
operator|&
literal|0xff
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
ifdef|#
directive|ifdef
name|DEBUG_SVR4
if|if
condition|(
operator|(
name|error
operator|=
name|show_ioc
argument_list|(
literal|"<"
argument_list|,
operator|&
name|ioc
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
endif|#
directive|endif
comment|/* DEBUG_SVR4 */
return|return
name|copyout
argument_list|(
operator|&
name|ioc
argument_list|,
name|dat
argument_list|,
sizeof|sizeof
argument_list|(
name|ioc
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i_setsig
parameter_list|(
name|fp
parameter_list|,
name|td
parameter_list|,
name|retval
parameter_list|,
name|fd
parameter_list|,
name|cmd
parameter_list|,
name|dat
parameter_list|)
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|register_t
modifier|*
name|retval
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|u_long
name|cmd
decl_stmt|;
name|caddr_t
name|dat
decl_stmt|;
block|{
comment|/*  	 * This is the best we can do for now; we cannot generate 	 * signals only for specific events so the signal mask gets 	 * ignored; we save it just to pass it to a possible I_GETSIG... 	 * 	 * We alse have to fix the O_ASYNC fcntl bit, so the 	 * process will get SIGPOLLs. 	 */
name|int
name|error
decl_stmt|;
name|register_t
name|oflags
decl_stmt|,
name|flags
decl_stmt|;
name|struct
name|svr4_strm
modifier|*
name|st
init|=
name|svr4_stream_get
argument_list|(
name|fp
argument_list|)
decl_stmt|;
if|if
condition|(
name|st
operator|==
name|NULL
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"i_setsig: bad file descriptor\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
comment|/* get old status flags */
name|error
operator|=
name|kern_fcntl
argument_list|(
name|td
argument_list|,
name|fd
argument_list|,
name|F_GETFL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|oflags
operator|=
name|td
operator|->
name|td_retval
index|[
literal|0
index|]
expr_stmt|;
comment|/* update the flags */
name|mtx_lock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
if|if
condition|(
name|dat
operator|!=
name|NULL
condition|)
block|{
name|int
name|mask
decl_stmt|;
name|flags
operator|=
name|oflags
operator||
name|O_ASYNC
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|dat
argument_list|,
operator|&
name|mask
argument_list|,
sizeof|sizeof
argument_list|(
name|mask
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"i_setsig: bad eventmask pointer\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
if|if
condition|(
name|mask
operator|&
name|SVR4_S_ALLMASK
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"i_setsig: bad eventmask data %x\n"
operator|,
name|mask
operator|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|st
operator|->
name|s_eventmask
operator|=
name|mask
expr_stmt|;
block|}
else|else
block|{
name|flags
operator|=
name|oflags
operator|&
operator|~
name|O_ASYNC
expr_stmt|;
name|st
operator|->
name|s_eventmask
operator|=
literal|0
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
comment|/* set the new flags, if changed */
if|if
condition|(
name|flags
operator|!=
name|oflags
condition|)
block|{
name|error
operator|=
name|kern_fcntl
argument_list|(
name|td
argument_list|,
name|fd
argument_list|,
name|F_SETFL
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|(
name|error
operator|)
return|;
name|flags
operator|=
name|td
operator|->
name|td_retval
index|[
literal|0
index|]
expr_stmt|;
block|}
comment|/* set up SIGIO receiver if needed */
if|if
condition|(
name|dat
operator|!=
name|NULL
condition|)
return|return
operator|(
name|kern_fcntl
argument_list|(
name|td
argument_list|,
name|fd
argument_list|,
name|F_SETOWN
argument_list|,
name|td
operator|->
name|td_proc
operator|->
name|p_pid
argument_list|)
operator|)
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|i_getsig
parameter_list|(
name|fp
parameter_list|,
name|td
parameter_list|,
name|retval
parameter_list|,
name|fd
parameter_list|,
name|cmd
parameter_list|,
name|dat
parameter_list|)
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|register_t
modifier|*
name|retval
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|u_long
name|cmd
decl_stmt|;
name|caddr_t
name|dat
decl_stmt|;
block|{
name|int
name|error
decl_stmt|,
name|eventmask
decl_stmt|;
if|if
condition|(
name|dat
operator|!=
name|NULL
condition|)
block|{
name|struct
name|svr4_strm
modifier|*
name|st
init|=
name|svr4_stream_get
argument_list|(
name|fp
argument_list|)
decl_stmt|;
if|if
condition|(
name|st
operator|==
name|NULL
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"i_getsig: bad file descriptor\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|mtx_lock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
name|eventmask
operator|=
name|st
operator|->
name|s_eventmask
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|eventmask
argument_list|,
name|dat
argument_list|,
sizeof|sizeof
argument_list|(
name|eventmask
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"i_getsig: bad eventmask pointer\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|svr4_stream_ioctl
parameter_list|(
name|fp
parameter_list|,
name|td
parameter_list|,
name|retval
parameter_list|,
name|fd
parameter_list|,
name|cmd
parameter_list|,
name|dat
parameter_list|)
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|register_t
modifier|*
name|retval
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|u_long
name|cmd
decl_stmt|;
name|caddr_t
name|dat
decl_stmt|;
block|{
operator|*
name|retval
operator|=
literal|0
expr_stmt|;
comment|/* 	 * All the following stuff assumes "sockmod" is pushed... 	 */
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|SVR4_I_NREAD
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_NREAD\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|i_nread
argument_list|(
name|fp
argument_list|,
name|td
argument_list|,
name|retval
argument_list|,
name|fd
argument_list|,
name|cmd
argument_list|,
name|dat
argument_list|)
return|;
case|case
name|SVR4_I_PUSH
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_PUSH %p\n"
operator|,
name|dat
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|DEBUG_SVR4
argument_list|)
name|show_strbuf
argument_list|(
operator|(
expr|struct
name|svr4_strbuf
operator|*
operator|)
name|dat
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
literal|0
return|;
case|case
name|SVR4_I_POP
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_POP\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_LOOK
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_LOOK\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_FLUSH
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_FLUSH\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_SRDOPT
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_SRDOPT\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_GRDOPT
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_GRDOPT\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_STR
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_STR\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|i_str
argument_list|(
name|fp
argument_list|,
name|td
argument_list|,
name|retval
argument_list|,
name|fd
argument_list|,
name|cmd
argument_list|,
name|dat
argument_list|)
return|;
case|case
name|SVR4_I_SETSIG
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_SETSIG\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|i_setsig
argument_list|(
name|fp
argument_list|,
name|td
argument_list|,
name|retval
argument_list|,
name|fd
argument_list|,
name|cmd
argument_list|,
name|dat
argument_list|)
return|;
case|case
name|SVR4_I_GETSIG
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_GETSIG\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|i_getsig
argument_list|(
name|fp
argument_list|,
name|td
argument_list|,
name|retval
argument_list|,
name|fd
argument_list|,
name|cmd
argument_list|,
name|dat
argument_list|)
return|;
case|case
name|SVR4_I_FIND
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_FIND\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* 		 * Here we are not pushing modules really, we just 		 * pretend all are present 		 */
operator|*
name|retval
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_LINK
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_LINK\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_UNLINK
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_UNLINK\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_ERECVFD
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_ERECVFD\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_PEEK
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_PEEK\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_FDINSERT
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_FDINSERT\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|i_fdinsert
argument_list|(
name|fp
argument_list|,
name|td
argument_list|,
name|retval
argument_list|,
name|fd
argument_list|,
name|cmd
argument_list|,
name|dat
argument_list|)
return|;
case|case
name|SVR4_I_SENDFD
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_SENDFD\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_RECVFD
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_RECVFD\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_SWROPT
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_SWROPT\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_GWROPT
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_GWROPT\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_LIST
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_LIST\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_PLINK
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_PLINK\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_PUNLINK
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_PUNLINK\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_SETEV
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_SETEV\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_GETEV
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_GETEV\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_STREV
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_STREV\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_UNSTREV
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_UNSTREV\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_FLUSHBAND
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_FLUSHBAND\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_CKBAND
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_CKBAND\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_GETBAND
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_GETBANK\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_ATMARK
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_ATMARK\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_SETCLTIME
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_SETCLTIME\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_GETCLTIME
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_GETCLTIME\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4_I_CANPUT
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"I_CANPUT\n"
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
case|case
name|SVR4__I_BIND_RSVD
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"_I_BIND_RSVD\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|_i_bind_rsvd
argument_list|(
name|fp
argument_list|,
name|td
argument_list|,
name|retval
argument_list|,
name|fd
argument_list|,
name|cmd
argument_list|,
name|dat
argument_list|)
return|;
case|case
name|SVR4__I_RELE_RSVD
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"_I_RELE_RSVD\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|_i_rele_rsvd
argument_list|(
name|fp
argument_list|,
name|td
argument_list|,
name|retval
argument_list|,
name|fd
argument_list|,
name|cmd
argument_list|,
name|dat
argument_list|)
return|;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"unimpl cmd = %lx\n"
operator|,
name|cmd
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|svr4_sys_putmsg
parameter_list|(
name|td
parameter_list|,
name|uap
parameter_list|)
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|struct
name|svr4_sys_putmsg_args
modifier|*
name|uap
decl_stmt|;
block|{
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|fget
argument_list|(
name|td
argument_list|,
name|uap
operator|->
name|fd
argument_list|,
name|CAP_SEND
argument_list|,
operator|&
name|fp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG_SVR4
name|uprintf
argument_list|(
literal|"putmsg: bad fp\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|EBADF
return|;
block|}
name|error
operator|=
name|svr4_do_putmsg
argument_list|(
name|td
argument_list|,
name|uap
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|svr4_do_putmsg
parameter_list|(
name|td
parameter_list|,
name|uap
parameter_list|,
name|fp
parameter_list|)
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|struct
name|svr4_sys_putmsg_args
modifier|*
name|uap
decl_stmt|;
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
block|{
name|struct
name|svr4_strbuf
name|dat
decl_stmt|,
name|ctl
decl_stmt|;
name|struct
name|svr4_strmcmd
name|sc
decl_stmt|;
name|struct
name|sockaddr_in
name|sain
decl_stmt|;
name|struct
name|sockaddr_un
name|saun
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
name|int
name|sasize
decl_stmt|,
modifier|*
name|retval
decl_stmt|;
name|struct
name|svr4_strm
modifier|*
name|st
decl_stmt|;
name|int
name|error
decl_stmt|;
name|retval
operator|=
name|td
operator|->
name|td_retval
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG_SVR4
name|show_msg
argument_list|(
literal|">putmsg"
argument_list|,
name|uap
operator|->
name|fd
argument_list|,
name|uap
operator|->
name|ctl
argument_list|,
name|uap
operator|->
name|dat
argument_list|,
name|uap
operator|->
name|flags
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DEBUG_SVR4 */
if|if
condition|(
name|uap
operator|->
name|ctl
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|uap
operator|->
name|ctl
argument_list|,
operator|&
name|ctl
argument_list|,
sizeof|sizeof
argument_list|(
name|ctl
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG_SVR4
name|uprintf
argument_list|(
literal|"putmsg: copyin(): %d\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|error
return|;
block|}
block|}
else|else
name|ctl
operator|.
name|len
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|uap
operator|->
name|dat
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|uap
operator|->
name|dat
argument_list|,
operator|&
name|dat
argument_list|,
sizeof|sizeof
argument_list|(
name|dat
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG_SVR4
name|uprintf
argument_list|(
literal|"putmsg: copyin(): %d (2)\n"
argument_list|,
name|error
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|error
return|;
block|}
block|}
else|else
name|dat
operator|.
name|len
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* 	 * Only for sockets for now. 	 */
if|if
condition|(
operator|(
name|st
operator|=
name|svr4_stream_get
argument_list|(
name|fp
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"putmsg: bad file type\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
if|if
condition|(
name|ctl
operator|.
name|len
operator|<
literal|0
operator|||
name|ctl
operator|.
name|len
operator|>
sizeof|sizeof
argument_list|(
name|sc
argument_list|)
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"putmsg: Bad control size %d != %d\n"
operator|,
name|ctl
operator|.
name|len
operator|,
sizeof|sizeof
argument_list|(
expr|struct
name|svr4_strmcmd
argument_list|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|ctl
operator|.
name|buf
argument_list|,
operator|&
name|sc
argument_list|,
name|ctl
operator|.
name|len
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
switch|switch
condition|(
name|st
operator|->
name|s_family
condition|)
block|{
case|case
name|AF_INET
case|:
if|if
condition|(
name|sc
operator|.
name|len
operator|!=
sizeof|sizeof
argument_list|(
name|sain
argument_list|)
condition|)
block|{
if|if
condition|(
name|sc
operator|.
name|cmd
operator|==
name|SVR4_TI_DATA_REQUEST
condition|)
block|{
name|struct
name|write_args
name|wa
decl_stmt|;
comment|/* Solaris seems to use sc.cmd = 3 to 				 * send "expedited" data.  telnet uses 				 * this for options processing, sending EOF, 				 * etc.  I'm sure other things use it too. 				 * I don't have any documentation 				 * on it, so I'm making a guess that this 				 * is how it works. newton@atdot.dotat.org XXX 				 */
name|DPRINTF
argument_list|(
operator|(
literal|"sending expedited data ??\n"
operator|)
argument_list|)
expr_stmt|;
name|wa
operator|.
name|fd
operator|=
name|uap
operator|->
name|fd
expr_stmt|;
name|wa
operator|.
name|buf
operator|=
name|dat
operator|.
name|buf
expr_stmt|;
name|wa
operator|.
name|nbyte
operator|=
name|dat
operator|.
name|len
expr_stmt|;
return|return
name|sys_write
argument_list|(
name|td
argument_list|,
operator|&
name|wa
argument_list|)
return|;
block|}
name|DPRINTF
argument_list|(
operator|(
literal|"putmsg: Invalid inet length %ld\n"
operator|,
name|sc
operator|.
name|len
operator|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
name|netaddr_to_sockaddr_in
argument_list|(
operator|&
name|sain
argument_list|,
operator|&
name|sc
argument_list|)
expr_stmt|;
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sain
expr_stmt|;
name|sasize
operator|=
sizeof|sizeof
argument_list|(
name|sain
argument_list|)
expr_stmt|;
if|if
condition|(
name|sain
operator|.
name|sin_family
operator|!=
name|st
operator|->
name|s_family
condition|)
name|error
operator|=
name|EINVAL
expr_stmt|;
break|break;
case|case
name|AF_LOCAL
case|:
if|if
condition|(
name|ctl
operator|.
name|len
operator|==
literal|8
condition|)
block|{
comment|/* We are doing an accept; succeed */
name|DPRINTF
argument_list|(
operator|(
literal|"putmsg: Do nothing\n"
operator|)
argument_list|)
expr_stmt|;
operator|*
name|retval
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
block|{
comment|/* Maybe we've been given a device/inode pair */
name|dev_t
modifier|*
name|dev
init|=
name|SVR4_ADDROF
argument_list|(
operator|&
name|sc
argument_list|)
decl_stmt|;
name|ino_t
modifier|*
name|ino
init|=
operator|(
name|ino_t
operator|*
operator|)
operator|&
name|dev
index|[
literal|1
index|]
decl_stmt|;
if|if
condition|(
name|svr4_find_socket
argument_list|(
name|td
argument_list|,
name|fp
argument_list|,
operator|*
name|dev
argument_list|,
operator|*
name|ino
argument_list|,
operator|&
name|saun
argument_list|)
operator|!=
literal|0
condition|)
block|{
comment|/* I guess we have it by name */
name|netaddr_to_sockaddr_un
argument_list|(
operator|&
name|saun
argument_list|,
operator|&
name|sc
argument_list|)
expr_stmt|;
block|}
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|saun
expr_stmt|;
name|sasize
operator|=
sizeof|sizeof
argument_list|(
name|saun
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"putmsg: Unsupported address family %d\n"
operator|,
name|st
operator|->
name|s_family
operator|)
argument_list|)
expr_stmt|;
return|return
name|ENOSYS
return|;
block|}
name|mtx_lock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
name|st
operator|->
name|s_cmd
operator|=
name|sc
operator|.
name|cmd
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sc
operator|.
name|cmd
condition|)
block|{
case|case
name|SVR4_TI_CONNECT_REQUEST
case|:
comment|/* connect 	*/
block|{
return|return
operator|(
name|kern_connect
argument_list|(
name|td
argument_list|,
name|uap
operator|->
name|fd
argument_list|,
name|sa
argument_list|)
operator|)
return|;
block|}
case|case
name|SVR4_TI_SENDTO_REQUEST
case|:
comment|/* sendto 	*/
block|{
name|struct
name|msghdr
name|msg
decl_stmt|;
name|struct
name|iovec
name|aiov
decl_stmt|;
name|msg
operator|.
name|msg_name
operator|=
name|sa
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
name|sasize
expr_stmt|;
name|msg
operator|.
name|msg_iov
operator|=
operator|&
name|aiov
expr_stmt|;
name|msg
operator|.
name|msg_iovlen
operator|=
literal|1
expr_stmt|;
name|msg
operator|.
name|msg_control
operator|=
literal|0
expr_stmt|;
name|msg
operator|.
name|msg_flags
operator|=
literal|0
expr_stmt|;
name|aiov
operator|.
name|iov_base
operator|=
name|dat
operator|.
name|buf
expr_stmt|;
name|aiov
operator|.
name|iov_len
operator|=
name|dat
operator|.
name|len
expr_stmt|;
name|error
operator|=
name|kern_sendit
argument_list|(
name|td
argument_list|,
name|uap
operator|->
name|fd
argument_list|,
operator|&
name|msg
argument_list|,
name|uap
operator|->
name|flags
argument_list|,
name|NULL
argument_list|,
name|UIO_USERSPACE
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"sendto_request error: %d\n"
operator|,
name|error
operator|)
argument_list|)
expr_stmt|;
operator|*
name|retval
operator|=
literal|0
expr_stmt|;
return|return
name|error
return|;
block|}
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"putmsg: Unimplemented command %lx\n"
operator|,
name|sc
operator|.
name|cmd
operator|)
argument_list|)
expr_stmt|;
return|return
name|ENOSYS
return|;
block|}
block|}
end_function

begin_function
name|int
name|svr4_sys_getmsg
parameter_list|(
name|td
parameter_list|,
name|uap
parameter_list|)
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|struct
name|svr4_sys_getmsg_args
modifier|*
name|uap
decl_stmt|;
block|{
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
name|int
name|error
decl_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|fget
argument_list|(
name|td
argument_list|,
name|uap
operator|->
name|fd
argument_list|,
name|CAP_RECV
argument_list|,
operator|&
name|fp
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG_SVR4
name|uprintf
argument_list|(
literal|"getmsg: bad fp\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|EBADF
return|;
block|}
name|error
operator|=
name|svr4_do_getmsg
argument_list|(
name|td
argument_list|,
name|uap
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|fdrop
argument_list|(
name|fp
argument_list|,
name|td
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
end_function

begin_function
name|int
name|svr4_do_getmsg
parameter_list|(
name|td
parameter_list|,
name|uap
parameter_list|,
name|fp
parameter_list|)
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|struct
name|svr4_sys_getmsg_args
modifier|*
name|uap
decl_stmt|;
name|struct
name|file
modifier|*
name|fp
decl_stmt|;
block|{
name|struct
name|svr4_strbuf
name|dat
decl_stmt|,
name|ctl
decl_stmt|;
name|struct
name|svr4_strmcmd
name|sc
decl_stmt|;
name|int
name|error
decl_stmt|,
modifier|*
name|retval
decl_stmt|;
name|struct
name|msghdr
name|msg
decl_stmt|;
name|struct
name|iovec
name|aiov
decl_stmt|;
name|struct
name|sockaddr_in
name|sain
decl_stmt|;
name|struct
name|sockaddr_un
name|saun
decl_stmt|;
name|struct
name|sockaddr
modifier|*
name|sa
decl_stmt|;
name|socklen_t
name|sasize
decl_stmt|;
name|struct
name|svr4_strm
modifier|*
name|st
decl_stmt|;
name|struct
name|file
modifier|*
name|afp
decl_stmt|;
name|int
name|fl
decl_stmt|;
name|retval
operator|=
name|td
operator|->
name|td_retval
expr_stmt|;
name|error
operator|=
literal|0
expr_stmt|;
name|afp
operator|=
name|NULL
expr_stmt|;
name|memset
argument_list|(
operator|&
name|sc
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sc
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG_SVR4
name|show_msg
argument_list|(
literal|">getmsg"
argument_list|,
name|uap
operator|->
name|fd
argument_list|,
name|uap
operator|->
name|ctl
argument_list|,
name|uap
operator|->
name|dat
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DEBUG_SVR4 */
if|if
condition|(
name|uap
operator|->
name|ctl
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|uap
operator|->
name|ctl
argument_list|,
operator|&
name|ctl
argument_list|,
sizeof|sizeof
argument_list|(
name|ctl
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
if|if
condition|(
name|ctl
operator|.
name|len
operator|<
literal|0
condition|)
return|return
name|EINVAL
return|;
block|}
else|else
block|{
name|ctl
operator|.
name|len
operator|=
operator|-
literal|1
expr_stmt|;
name|ctl
operator|.
name|maxlen
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|uap
operator|->
name|dat
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|uap
operator|->
name|dat
argument_list|,
operator|&
name|dat
argument_list|,
sizeof|sizeof
argument_list|(
name|dat
argument_list|)
argument_list|)
operator|)
operator|!=
literal|0
condition|)
return|return
name|error
return|;
block|}
else|else
block|{
name|dat
operator|.
name|len
operator|=
operator|-
literal|1
expr_stmt|;
name|dat
operator|.
name|maxlen
operator|=
literal|0
expr_stmt|;
block|}
comment|/* 	 * Only for sockets for now. 	 */
if|if
condition|(
operator|(
name|st
operator|=
name|svr4_stream_get
argument_list|(
name|fp
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"getmsg: bad file type\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
if|if
condition|(
name|ctl
operator|.
name|maxlen
operator|==
operator|-
literal|1
operator|||
name|dat
operator|.
name|maxlen
operator|==
operator|-
literal|1
condition|)
block|{
name|DPRINTF
argument_list|(
operator|(
literal|"getmsg: Cannot handle -1 maxlen (yet)\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|ENOSYS
return|;
block|}
switch|switch
condition|(
name|st
operator|->
name|s_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|sasize
operator|=
sizeof|sizeof
argument_list|(
name|sain
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_LOCAL
case|:
name|sasize
operator|=
sizeof|sizeof
argument_list|(
name|saun
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DPRINTF
argument_list|(
operator|(
literal|"getmsg: Unsupported address family %d\n"
operator|,
name|st
operator|->
name|s_family
operator|)
argument_list|)
expr_stmt|;
return|return
name|ENOSYS
return|;
block|}
name|mtx_lock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|st
operator|->
name|s_cmd
condition|)
block|{
case|case
name|SVR4_TI_CONNECT_REQUEST
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"getmsg: TI_CONNECT_REQUEST\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* 		 * We do the connect in one step, so the putmsg should 		 * have gotten the error. 		 */
name|sc
operator|.
name|cmd
operator|=
name|SVR4_TI_OK_REPLY
expr_stmt|;
name|sc
operator|.
name|len
operator|=
literal|0
expr_stmt|;
name|ctl
operator|.
name|len
operator|=
literal|8
expr_stmt|;
name|dat
operator|.
name|len
operator|=
operator|-
literal|1
expr_stmt|;
name|fl
operator|=
literal|1
expr_stmt|;
name|st
operator|->
name|s_cmd
operator|=
name|sc
operator|.
name|cmd
expr_stmt|;
break|break;
case|case
name|SVR4_TI_OK_REPLY
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"getmsg: TI_OK_REPLY\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* 		 * We are immediately after a connect reply, so we send 		 * a connect verification. 		 */
name|error
operator|=
name|kern_getpeername
argument_list|(
name|td
argument_list|,
name|uap
operator|->
name|fd
argument_list|,
operator|&
name|sa
argument_list|,
operator|&
name|sasize
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"getmsg: getpeername failed %d\n"
operator|,
name|error
operator|)
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|sc
operator|.
name|cmd
operator|=
name|SVR4_TI_CONNECT_REPLY
expr_stmt|;
name|sc
operator|.
name|pad
index|[
literal|0
index|]
operator|=
literal|0x4
expr_stmt|;
name|sc
operator|.
name|offs
operator|=
literal|0x18
expr_stmt|;
name|sc
operator|.
name|pad
index|[
literal|1
index|]
operator|=
literal|0x14
expr_stmt|;
name|sc
operator|.
name|pad
index|[
literal|2
index|]
operator|=
literal|0x04000402
expr_stmt|;
switch|switch
condition|(
name|st
operator|->
name|s_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|sc
operator|.
name|len
operator|=
name|sasize
expr_stmt|;
name|sockaddr_to_netaddr_in
argument_list|(
operator|&
name|sc
argument_list|,
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|sa
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_LOCAL
case|:
name|sc
operator|.
name|len
operator|=
name|sasize
operator|+
literal|4
expr_stmt|;
name|sockaddr_to_netaddr_un
argument_list|(
operator|&
name|sc
argument_list|,
operator|(
expr|struct
name|sockaddr_un
operator|*
operator|)
name|sa
argument_list|)
expr_stmt|;
break|break;
default|default:
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sa
argument_list|,
name|M_SONAME
argument_list|)
expr_stmt|;
return|return
name|ENOSYS
return|;
block|}
name|free
argument_list|(
name|sa
argument_list|,
name|M_SONAME
argument_list|)
expr_stmt|;
name|ctl
operator|.
name|len
operator|=
literal|40
expr_stmt|;
name|dat
operator|.
name|len
operator|=
operator|-
literal|1
expr_stmt|;
name|fl
operator|=
literal|0
expr_stmt|;
name|st
operator|->
name|s_cmd
operator|=
name|sc
operator|.
name|cmd
expr_stmt|;
break|break;
case|case
name|SVR4_TI__ACCEPT_OK
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"getmsg: TI__ACCEPT_OK\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* 		 * We do the connect in one step, so the putmsg should 		 * have gotten the error. 		 */
name|sc
operator|.
name|cmd
operator|=
name|SVR4_TI_OK_REPLY
expr_stmt|;
name|sc
operator|.
name|len
operator|=
literal|1
expr_stmt|;
name|ctl
operator|.
name|len
operator|=
literal|8
expr_stmt|;
name|dat
operator|.
name|len
operator|=
operator|-
literal|1
expr_stmt|;
name|fl
operator|=
literal|1
expr_stmt|;
name|st
operator|->
name|s_cmd
operator|=
name|SVR4_TI__ACCEPT_WAIT
expr_stmt|;
break|break;
case|case
name|SVR4_TI__ACCEPT_WAIT
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"getmsg: TI__ACCEPT_WAIT\n"
operator|)
argument_list|)
expr_stmt|;
comment|/* 		 * We are after a listen, so we try to accept... 		 */
name|error
operator|=
name|kern_accept
argument_list|(
name|td
argument_list|,
name|uap
operator|->
name|fd
argument_list|,
operator|&
name|sa
argument_list|,
operator|&
name|sasize
argument_list|,
operator|&
name|afp
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"getmsg: accept failed %d\n"
operator|,
name|error
operator|)
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|st
operator|->
name|s_afd
operator|=
operator|*
name|retval
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"getmsg: Accept fd = %d\n"
operator|,
name|st
operator|->
name|s_afd
operator|)
argument_list|)
expr_stmt|;
name|sc
operator|.
name|cmd
operator|=
name|SVR4_TI_ACCEPT_REPLY
expr_stmt|;
name|sc
operator|.
name|offs
operator|=
literal|0x18
expr_stmt|;
name|sc
operator|.
name|pad
index|[
literal|0
index|]
operator|=
literal|0x0
expr_stmt|;
switch|switch
condition|(
name|st
operator|->
name|s_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|sc
operator|.
name|pad
index|[
literal|1
index|]
operator|=
literal|0x28
expr_stmt|;
name|sockaddr_to_netaddr_in
argument_list|(
operator|&
name|sc
argument_list|,
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
operator|&
name|sa
argument_list|)
expr_stmt|;
name|ctl
operator|.
name|len
operator|=
literal|40
expr_stmt|;
name|sc
operator|.
name|len
operator|=
name|sasize
expr_stmt|;
break|break;
case|case
name|AF_LOCAL
case|:
name|sc
operator|.
name|pad
index|[
literal|1
index|]
operator|=
literal|0x00010000
expr_stmt|;
name|sc
operator|.
name|pad
index|[
literal|2
index|]
operator|=
literal|0xf6bcdaa0
expr_stmt|;
comment|/* I don't know what that is */
name|sc
operator|.
name|pad
index|[
literal|3
index|]
operator|=
literal|0x00010000
expr_stmt|;
name|ctl
operator|.
name|len
operator|=
literal|134
expr_stmt|;
name|sc
operator|.
name|len
operator|=
name|sasize
operator|+
literal|4
expr_stmt|;
break|break;
default|default:
name|fdclose
argument_list|(
name|td
operator|->
name|td_proc
operator|->
name|p_fd
argument_list|,
name|afp
argument_list|,
name|st
operator|->
name|s_afd
argument_list|,
name|td
argument_list|)
expr_stmt|;
name|fdrop
argument_list|(
name|afp
argument_list|,
name|td
argument_list|)
expr_stmt|;
name|st
operator|->
name|s_afd
operator|=
operator|-
literal|1
expr_stmt|;
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|sa
argument_list|,
name|M_SONAME
argument_list|)
expr_stmt|;
return|return
name|ENOSYS
return|;
block|}
name|free
argument_list|(
name|sa
argument_list|,
name|M_SONAME
argument_list|)
expr_stmt|;
name|dat
operator|.
name|len
operator|=
operator|-
literal|1
expr_stmt|;
name|fl
operator|=
literal|0
expr_stmt|;
name|st
operator|->
name|s_cmd
operator|=
name|SVR4_TI__ACCEPT_OK
expr_stmt|;
break|break;
case|case
name|SVR4_TI_SENDTO_REQUEST
case|:
name|DPRINTF
argument_list|(
operator|(
literal|"getmsg: TI_SENDTO_REQUEST\n"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctl
operator|.
name|maxlen
operator|>
literal|36
operator|&&
name|ctl
operator|.
name|len
operator|<
literal|36
condition|)
name|ctl
operator|.
name|len
operator|=
literal|36
expr_stmt|;
if|if
condition|(
name|ctl
operator|.
name|len
operator|>
sizeof|sizeof
argument_list|(
name|sc
argument_list|)
condition|)
name|ctl
operator|.
name|len
operator|=
sizeof|sizeof
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|copyin
argument_list|(
name|ctl
operator|.
name|buf
argument_list|,
operator|&
name|sc
argument_list|,
name|ctl
operator|.
name|len
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
switch|switch
condition|(
name|st
operator|->
name|s_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sain
expr_stmt|;
name|sockaddr_to_netaddr_in
argument_list|(
operator|&
name|sc
argument_list|,
operator|&
name|sain
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_LOCAL
case|:
name|sa
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|saun
expr_stmt|;
name|sockaddr_to_netaddr_un
argument_list|(
operator|&
name|sc
argument_list|,
operator|&
name|saun
argument_list|)
expr_stmt|;
break|break;
default|default:
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
return|return
name|ENOSYS
return|;
block|}
name|msg
operator|.
name|msg_name
operator|=
name|sa
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
name|sasize
expr_stmt|;
name|msg
operator|.
name|msg_iov
operator|=
operator|&
name|aiov
expr_stmt|;
name|msg
operator|.
name|msg_iovlen
operator|=
literal|1
expr_stmt|;
name|msg
operator|.
name|msg_control
operator|=
literal|0
expr_stmt|;
name|aiov
operator|.
name|iov_base
operator|=
name|dat
operator|.
name|buf
expr_stmt|;
name|aiov
operator|.
name|iov_len
operator|=
name|dat
operator|.
name|maxlen
expr_stmt|;
name|msg
operator|.
name|msg_flags
operator|=
literal|0
expr_stmt|;
name|error
operator|=
name|kern_recvit
argument_list|(
name|td
argument_list|,
name|uap
operator|->
name|fd
argument_list|,
operator|&
name|msg
argument_list|,
name|UIO_SYSSPACE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"getmsg: recvit failed %d\n"
operator|,
name|error
operator|)
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|sc
operator|.
name|cmd
operator|=
name|SVR4_TI_RECVFROM_IND
expr_stmt|;
switch|switch
condition|(
name|st
operator|->
name|s_family
condition|)
block|{
case|case
name|AF_INET
case|:
name|sc
operator|.
name|len
operator|=
name|sasize
expr_stmt|;
name|sockaddr_to_netaddr_in
argument_list|(
operator|&
name|sc
argument_list|,
operator|&
name|sain
argument_list|)
expr_stmt|;
break|break;
case|case
name|AF_LOCAL
case|:
name|sc
operator|.
name|len
operator|=
name|sasize
operator|+
literal|4
expr_stmt|;
name|sockaddr_to_netaddr_un
argument_list|(
operator|&
name|sc
argument_list|,
operator|&
name|saun
argument_list|)
expr_stmt|;
break|break;
default|default:
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
return|return
name|ENOSYS
return|;
block|}
name|dat
operator|.
name|len
operator|=
operator|*
name|retval
expr_stmt|;
name|fl
operator|=
literal|0
expr_stmt|;
name|st
operator|->
name|s_cmd
operator|=
name|sc
operator|.
name|cmd
expr_stmt|;
break|break;
default|default:
name|st
operator|->
name|s_cmd
operator|=
name|sc
operator|.
name|cmd
expr_stmt|;
if|if
condition|(
name|st
operator|->
name|s_cmd
operator|==
name|SVR4_TI_CONNECT_REQUEST
condition|)
block|{
name|struct
name|read_args
name|ra
decl_stmt|;
comment|/* More weirdness:  Again, I can't find documentation 			 * to back this up, but when a process does a generic 			 * "getmsg()" call it seems that the command field is 			 * zero and the length of the data area is zero.  I 			 * think processes expect getmsg() to fill in dat.len 			 * after reading at most dat.maxlen octets from the 			 * stream.  Since we're using sockets I can let  			 * read() look after it and frob return values 			 * appropriately (or inappropriately :-) 			 *   -- newton@atdot.dotat.org        XXX 			 */
name|ra
operator|.
name|fd
operator|=
name|uap
operator|->
name|fd
expr_stmt|;
name|ra
operator|.
name|buf
operator|=
name|dat
operator|.
name|buf
expr_stmt|;
name|ra
operator|.
name|nbyte
operator|=
name|dat
operator|.
name|maxlen
expr_stmt|;
if|if
condition|(
operator|(
name|error
operator|=
name|sys_read
argument_list|(
name|td
argument_list|,
operator|&
name|ra
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
return|return
name|error
return|;
block|}
name|dat
operator|.
name|len
operator|=
operator|*
name|retval
expr_stmt|;
operator|*
name|retval
operator|=
literal|0
expr_stmt|;
name|st
operator|->
name|s_cmd
operator|=
name|SVR4_TI_SENDTO_REQUEST
expr_stmt|;
break|break;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"getmsg: Unknown state %x\n"
operator|,
name|st
operator|->
name|s_cmd
operator|)
argument_list|)
expr_stmt|;
return|return
name|EINVAL
return|;
block|}
if|if
condition|(
name|uap
operator|->
name|ctl
condition|)
block|{
if|if
condition|(
name|ctl
operator|.
name|len
operator|>
sizeof|sizeof
argument_list|(
name|sc
argument_list|)
condition|)
name|ctl
operator|.
name|len
operator|=
sizeof|sizeof
argument_list|(
name|sc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctl
operator|.
name|len
operator|!=
operator|-
literal|1
condition|)
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|sc
argument_list|,
name|ctl
operator|.
name|buf
argument_list|,
name|ctl
operator|.
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|ctl
argument_list|,
name|uap
operator|->
name|ctl
argument_list|,
sizeof|sizeof
argument_list|(
name|ctl
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|uap
operator|->
name|dat
condition|)
block|{
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|dat
argument_list|,
name|uap
operator|->
name|dat
argument_list|,
sizeof|sizeof
argument_list|(
name|dat
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|uap
operator|->
name|flags
condition|)
block|{
comment|/* XXX: Need translation */
if|if
condition|(
name|error
operator|==
literal|0
condition|)
name|error
operator|=
name|copyout
argument_list|(
operator|&
name|fl
argument_list|,
name|uap
operator|->
name|flags
argument_list|,
sizeof|sizeof
argument_list|(
name|fl
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|error
condition|)
block|{
if|if
condition|(
name|afp
condition|)
block|{
name|fdclose
argument_list|(
name|td
operator|->
name|td_proc
operator|->
name|p_fd
argument_list|,
name|afp
argument_list|,
name|st
operator|->
name|s_afd
argument_list|,
name|td
argument_list|)
expr_stmt|;
name|fdrop
argument_list|(
name|afp
argument_list|,
name|td
argument_list|)
expr_stmt|;
name|st
operator|->
name|s_afd
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
return|return
operator|(
name|error
operator|)
return|;
block|}
name|mtx_unlock
argument_list|(
operator|&
name|Giant
argument_list|)
expr_stmt|;
if|if
condition|(
name|afp
condition|)
name|fdrop
argument_list|(
name|afp
argument_list|,
name|td
argument_list|)
expr_stmt|;
operator|*
name|retval
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG_SVR4
name|show_msg
argument_list|(
literal|"<getmsg"
argument_list|,
name|uap
operator|->
name|fd
argument_list|,
name|uap
operator|->
name|ctl
argument_list|,
name|uap
operator|->
name|dat
argument_list|,
name|fl
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* DEBUG_SVR4 */
return|return
name|error
return|;
block|}
end_function

begin_function
name|int
name|svr4_sys_send
parameter_list|(
name|td
parameter_list|,
name|uap
parameter_list|)
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|struct
name|svr4_sys_send_args
modifier|*
name|uap
decl_stmt|;
block|{
name|struct
name|sendto_args
name|sta
decl_stmt|;
name|sta
operator|.
name|s
operator|=
name|uap
operator|->
name|s
expr_stmt|;
name|sta
operator|.
name|buf
operator|=
name|uap
operator|->
name|buf
expr_stmt|;
name|sta
operator|.
name|len
operator|=
name|uap
operator|->
name|len
expr_stmt|;
name|sta
operator|.
name|flags
operator|=
name|uap
operator|->
name|flags
expr_stmt|;
name|sta
operator|.
name|to
operator|=
name|NULL
expr_stmt|;
name|sta
operator|.
name|tolen
operator|=
literal|0
expr_stmt|;
return|return
operator|(
name|sys_sendto
argument_list|(
name|td
argument_list|,
operator|&
name|sta
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
name|int
name|svr4_sys_recv
parameter_list|(
name|td
parameter_list|,
name|uap
parameter_list|)
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|struct
name|svr4_sys_recv_args
modifier|*
name|uap
decl_stmt|;
block|{
name|struct
name|recvfrom_args
name|rfa
decl_stmt|;
name|rfa
operator|.
name|s
operator|=
name|uap
operator|->
name|s
expr_stmt|;
name|rfa
operator|.
name|buf
operator|=
name|uap
operator|->
name|buf
expr_stmt|;
name|rfa
operator|.
name|len
operator|=
name|uap
operator|->
name|len
expr_stmt|;
name|rfa
operator|.
name|flags
operator|=
name|uap
operator|->
name|flags
expr_stmt|;
name|rfa
operator|.
name|from
operator|=
name|NULL
expr_stmt|;
name|rfa
operator|.
name|fromlenaddr
operator|=
name|NULL
expr_stmt|;
return|return
operator|(
name|sys_recvfrom
argument_list|(
name|td
argument_list|,
operator|&
name|rfa
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/*   * XXX This isn't necessary, but it's handy for inserting debug code into  * sendto().  Let's leave it here for now...  */
end_comment

begin_function
name|int
name|svr4_sys_sendto
parameter_list|(
name|td
parameter_list|,
name|uap
parameter_list|)
name|struct
name|thread
modifier|*
name|td
decl_stmt|;
name|struct
name|svr4_sys_sendto_args
modifier|*
name|uap
decl_stmt|;
block|{
name|struct
name|sendto_args
name|sa
decl_stmt|;
name|sa
operator|.
name|s
operator|=
name|uap
operator|->
name|s
expr_stmt|;
name|sa
operator|.
name|buf
operator|=
name|uap
operator|->
name|buf
expr_stmt|;
name|sa
operator|.
name|len
operator|=
name|uap
operator|->
name|len
expr_stmt|;
name|sa
operator|.
name|flags
operator|=
name|uap
operator|->
name|flags
expr_stmt|;
name|sa
operator|.
name|to
operator|=
operator|(
name|caddr_t
operator|)
name|uap
operator|->
name|to
expr_stmt|;
name|sa
operator|.
name|tolen
operator|=
name|uap
operator|->
name|tolen
expr_stmt|;
name|DPRINTF
argument_list|(
operator|(
literal|"calling sendto()\n"
operator|)
argument_list|)
expr_stmt|;
return|return
name|sys_sendto
argument_list|(
name|td
argument_list|,
operator|&
name|sa
argument_list|)
return|;
block|}
end_function

end_unit


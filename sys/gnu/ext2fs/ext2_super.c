begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *  linux/fs/ext2/super.c  *  * Copyright (C) 1992, 1993, 1994, 1995  * Remy Card (card@masi.ibp.fr)  * Laboratoire MASI - Institut Blaise Pascal  * Universite Pierre et Marie Curie (Paris VI)  *  *  from  *  *  linux/fs/minix/inode.c  *  *  Copyright (C) 1991, 1992  Linus Torvalds  */
end_comment

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_include
include|#
directive|include
file|<asm/segment.h>
end_include

begin_include
include|#
directive|include
file|<asm/system.h>
end_include

begin_include
include|#
directive|include
file|<linux/errno.h>
end_include

begin_include
include|#
directive|include
file|<linux/fs.h>
end_include

begin_include
include|#
directive|include
file|<linux/ext2_fs.h>
end_include

begin_include
include|#
directive|include
file|<linux/malloc.h>
end_include

begin_include
include|#
directive|include
file|<linux/sched.h>
end_include

begin_include
include|#
directive|include
file|<linux/stat.h>
end_include

begin_include
include|#
directive|include
file|<linux/string.h>
end_include

begin_include
include|#
directive|include
file|<linux/locks.h>
end_include

begin_decl_stmt
specifier|static
name|char
name|error_buf
index|[
literal|1024
index|]
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|ext2_error
parameter_list|(
name|struct
name|super_block
modifier|*
name|sb
parameter_list|,
specifier|const
name|char
modifier|*
name|function
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|args
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|sb
operator|->
name|s_flags
operator|&
name|MS_RDONLY
operator|)
condition|)
block|{
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_mount_state
operator||=
name|EXT2_ERROR_FS
expr_stmt|;
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_es
operator|->
name|s_state
operator||=
name|EXT2_ERROR_FS
expr_stmt|;
name|mark_buffer_dirty
argument_list|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_sbh
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sb
operator|->
name|s_dirt
operator|=
literal|1
expr_stmt|;
block|}
name|va_start
argument_list|(
name|args
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vsprintf
argument_list|(
name|error_buf
argument_list|,
name|fmt
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|test_opt
argument_list|(
name|sb
argument_list|,
name|ERRORS_PANIC
argument_list|)
operator|||
operator|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_es
operator|->
name|s_errors
operator|==
name|EXT2_ERRORS_PANIC
operator|&&
operator|!
name|test_opt
argument_list|(
name|sb
argument_list|,
name|ERRORS_CONT
argument_list|)
operator|&&
operator|!
name|test_opt
argument_list|(
name|sb
argument_list|,
name|ERRORS_RO
argument_list|)
operator|)
condition|)
name|panic
argument_list|(
literal|"EXT2-fs panic (device %d/%d): %s: %s\n"
argument_list|,
name|MAJOR
argument_list|(
name|sb
operator|->
name|s_dev
argument_list|)
argument_list|,
name|MINOR
argument_list|(
name|sb
operator|->
name|s_dev
argument_list|)
argument_list|,
name|function
argument_list|,
name|error_buf
argument_list|)
expr_stmt|;
name|printk
argument_list|(
name|KERN_CRIT
literal|"EXT2-fs error (device %d/%d): %s: %s\n"
argument_list|,
name|MAJOR
argument_list|(
name|sb
operator|->
name|s_dev
argument_list|)
argument_list|,
name|MINOR
argument_list|(
name|sb
operator|->
name|s_dev
argument_list|)
argument_list|,
name|function
argument_list|,
name|error_buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|test_opt
argument_list|(
name|sb
argument_list|,
name|ERRORS_RO
argument_list|)
operator|||
operator|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_es
operator|->
name|s_errors
operator|==
name|EXT2_ERRORS_RO
operator|&&
operator|!
name|test_opt
argument_list|(
name|sb
argument_list|,
name|ERRORS_CONT
argument_list|)
operator|&&
operator|!
name|test_opt
argument_list|(
name|sb
argument_list|,
name|ERRORS_PANIC
argument_list|)
operator|)
condition|)
block|{
name|printk
argument_list|(
literal|"Remounting filesystem read-only\n"
argument_list|)
expr_stmt|;
name|sb
operator|->
name|s_flags
operator||=
name|MS_RDONLY
expr_stmt|;
block|}
block|}
end_function

begin_function
name|NORET_TYPE
name|void
name|ext2_panic
parameter_list|(
name|struct
name|super_block
modifier|*
name|sb
parameter_list|,
specifier|const
name|char
modifier|*
name|function
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|args
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|sb
operator|->
name|s_flags
operator|&
name|MS_RDONLY
operator|)
condition|)
block|{
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_mount_state
operator||=
name|EXT2_ERROR_FS
expr_stmt|;
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_es
operator|->
name|s_state
operator||=
name|EXT2_ERROR_FS
expr_stmt|;
name|mark_buffer_dirty
argument_list|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_sbh
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sb
operator|->
name|s_dirt
operator|=
literal|1
expr_stmt|;
block|}
name|va_start
argument_list|(
name|args
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vsprintf
argument_list|(
name|error_buf
argument_list|,
name|fmt
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|panic
argument_list|(
literal|"EXT2-fs panic (device %d/%d): %s: %s\n"
argument_list|,
name|MAJOR
argument_list|(
name|sb
operator|->
name|s_dev
argument_list|)
argument_list|,
name|MINOR
argument_list|(
name|sb
operator|->
name|s_dev
argument_list|)
argument_list|,
name|function
argument_list|,
name|error_buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ext2_warning
parameter_list|(
name|struct
name|super_block
modifier|*
name|sb
parameter_list|,
specifier|const
name|char
modifier|*
name|function
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|args
decl_stmt|;
name|va_start
argument_list|(
name|args
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vsprintf
argument_list|(
name|error_buf
argument_list|,
name|fmt
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|printk
argument_list|(
name|KERN_WARNING
literal|"EXT2-fs warning (device %d/%d): %s: %s\n"
argument_list|,
name|MAJOR
argument_list|(
name|sb
operator|->
name|s_dev
argument_list|)
argument_list|,
name|MINOR
argument_list|(
name|sb
operator|->
name|s_dev
argument_list|)
argument_list|,
name|function
argument_list|,
name|error_buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ext2_put_super
parameter_list|(
name|struct
name|super_block
modifier|*
name|sb
parameter_list|)
block|{
name|int
name|db_count
decl_stmt|;
name|int
name|i
decl_stmt|;
name|lock_super
argument_list|(
name|sb
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sb
operator|->
name|s_flags
operator|&
name|MS_RDONLY
operator|)
condition|)
block|{
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_es
operator|->
name|s_state
operator|=
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_mount_state
expr_stmt|;
name|mark_buffer_dirty
argument_list|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_sbh
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|sb
operator|->
name|s_dev
operator|=
literal|0
expr_stmt|;
name|db_count
operator|=
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_db_per_group
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|db_count
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_group_desc
index|[
name|i
index|]
condition|)
name|brelse
argument_list|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_group_desc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|kfree_s
argument_list|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_group_desc
argument_list|,
name|db_count
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|buffer_head
operator|*
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EXT2_MAX_GROUP_LOADED
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_inode_bitmap
index|[
name|i
index|]
condition|)
name|brelse
argument_list|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_inode_bitmap
index|[
name|i
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EXT2_MAX_GROUP_LOADED
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_block_bitmap
index|[
name|i
index|]
condition|)
name|brelse
argument_list|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_block_bitmap
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_sbh
argument_list|)
expr_stmt|;
name|unlock_super
argument_list|(
name|sb
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|super_operations
name|ext2_sops
init|=
block|{
name|ext2_read_inode
block|,
name|NULL
block|,
name|ext2_write_inode
block|,
name|ext2_put_inode
block|,
name|ext2_put_super
block|,
name|ext2_write_super
block|,
name|ext2_statfs
block|,
name|ext2_remount
block|}
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|EXT2FS_PRE_02B_COMPAT
end_ifdef

begin_function
specifier|static
name|int
name|convert_pre_02b_fs
parameter_list|(
name|struct
name|super_block
modifier|*
name|sb
parameter_list|,
name|struct
name|buffer_head
modifier|*
name|bh
parameter_list|)
block|{
name|struct
name|ext2_super_block
modifier|*
name|es
decl_stmt|;
name|struct
name|ext2_old_group_desc
name|old_group_desc
index|[
name|BLOCK_SIZE
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|ext2_old_group_desc
argument_list|)
index|]
decl_stmt|;
name|struct
name|ext2_group_desc
modifier|*
name|gdp
decl_stmt|;
name|struct
name|buffer_head
modifier|*
name|bh2
decl_stmt|;
name|int
name|groups_count
decl_stmt|;
name|int
name|i
decl_stmt|;
name|es
operator|=
operator|(
expr|struct
name|ext2_super_block
operator|*
operator|)
name|bh
operator|->
name|b_data
expr_stmt|;
name|bh2
operator|=
name|bread
argument_list|(
name|sb
operator|->
name|s_dev
argument_list|,
literal|2
argument_list|,
name|BLOCK_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bh2
condition|)
block|{
name|printk
argument_list|(
literal|"Cannot read descriptor blocks while converting !\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|memcpy
argument_list|(
name|old_group_desc
argument_list|,
name|bh2
operator|->
name|b_data
argument_list|,
name|BLOCK_SIZE
argument_list|)
expr_stmt|;
name|groups_count
operator|=
operator|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_blocks_count
operator|-
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_first_data_block
operator|+
operator|(
name|EXT2_BLOCK_SIZE
argument_list|(
name|sb
argument_list|)
operator|*
literal|8
operator|)
operator|-
literal|1
operator|)
operator|/
operator|(
name|EXT2_BLOCK_SIZE
argument_list|(
name|sb
argument_list|)
operator|*
literal|8
operator|)
expr_stmt|;
name|memset
argument_list|(
name|bh2
operator|->
name|b_data
argument_list|,
literal|0
argument_list|,
name|BLOCK_SIZE
argument_list|)
expr_stmt|;
name|gdp
operator|=
operator|(
expr|struct
name|ext2_group_desc
operator|*
operator|)
name|bh2
operator|->
name|b_data
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|groups_count
condition|;
name|i
operator|++
control|)
block|{
name|gdp
index|[
name|i
index|]
operator|.
name|bg_block_bitmap
operator|=
name|old_group_desc
index|[
name|i
index|]
operator|.
name|bg_block_bitmap
expr_stmt|;
name|gdp
index|[
name|i
index|]
operator|.
name|bg_inode_bitmap
operator|=
name|old_group_desc
index|[
name|i
index|]
operator|.
name|bg_inode_bitmap
expr_stmt|;
name|gdp
index|[
name|i
index|]
operator|.
name|bg_inode_table
operator|=
name|old_group_desc
index|[
name|i
index|]
operator|.
name|bg_inode_table
expr_stmt|;
name|gdp
index|[
name|i
index|]
operator|.
name|bg_free_blocks_count
operator|=
name|old_group_desc
index|[
name|i
index|]
operator|.
name|bg_free_blocks_count
expr_stmt|;
name|gdp
index|[
name|i
index|]
operator|.
name|bg_free_inodes_count
operator|=
name|old_group_desc
index|[
name|i
index|]
operator|.
name|bg_free_inodes_count
expr_stmt|;
block|}
name|mark_buffer_dirty
argument_list|(
name|bh2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bh2
argument_list|)
expr_stmt|;
name|es
operator|->
name|s_magic
operator|=
name|EXT2_SUPER_MAGIC
expr_stmt|;
name|mark_buffer_dirty
argument_list|(
name|bh
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sb
operator|->
name|s_magic
operator|=
name|EXT2_SUPER_MAGIC
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * This function has been shamelessly adapted from the msdos fs  */
end_comment

begin_function
specifier|static
name|int
name|parse_options
parameter_list|(
name|char
modifier|*
name|options
parameter_list|,
name|unsigned
name|long
modifier|*
name|sb_block
parameter_list|,
name|unsigned
name|short
modifier|*
name|resuid
parameter_list|,
name|unsigned
name|short
modifier|*
name|resgid
parameter_list|,
name|unsigned
name|long
modifier|*
name|mount_options
parameter_list|)
block|{
name|char
modifier|*
name|this_char
decl_stmt|;
name|char
modifier|*
name|value
decl_stmt|;
if|if
condition|(
operator|!
name|options
condition|)
return|return
literal|1
return|;
for|for
control|(
name|this_char
operator|=
name|strtok
argument_list|(
name|options
argument_list|,
literal|","
argument_list|)
init|;
name|this_char
operator|!=
name|NULL
condition|;
name|this_char
operator|=
name|strtok
argument_list|(
name|NULL
argument_list|,
literal|","
argument_list|)
control|)
block|{
if|if
condition|(
operator|(
name|value
operator|=
name|strchr
argument_list|(
name|this_char
argument_list|,
literal|'='
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
operator|*
name|value
operator|++
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|this_char
argument_list|,
literal|"bsddf"
argument_list|)
condition|)
name|clear_opt
argument_list|(
operator|*
name|mount_options
argument_list|,
name|MINIX_DF
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|this_char
argument_list|,
literal|"check"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|value
operator|||
operator|!
operator|*
name|value
condition|)
name|set_opt
argument_list|(
operator|*
name|mount_options
argument_list|,
name|CHECK_NORMAL
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|value
argument_list|,
literal|"none"
argument_list|)
condition|)
block|{
name|clear_opt
argument_list|(
operator|*
name|mount_options
argument_list|,
name|CHECK_NORMAL
argument_list|)
expr_stmt|;
name|clear_opt
argument_list|(
operator|*
name|mount_options
argument_list|,
name|CHECK_STRICT
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|value
argument_list|,
literal|"normal"
argument_list|)
condition|)
name|set_opt
argument_list|(
operator|*
name|mount_options
argument_list|,
name|CHECK_NORMAL
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|value
argument_list|,
literal|"strict"
argument_list|)
condition|)
block|{
name|set_opt
argument_list|(
operator|*
name|mount_options
argument_list|,
name|CHECK_NORMAL
argument_list|)
expr_stmt|;
name|set_opt
argument_list|(
operator|*
name|mount_options
argument_list|,
name|CHECK_STRICT
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printk
argument_list|(
literal|"EXT2-fs: Invalid check option: %s\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|this_char
argument_list|,
literal|"debug"
argument_list|)
condition|)
name|set_opt
argument_list|(
operator|*
name|mount_options
argument_list|,
name|DEBUG
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|this_char
argument_list|,
literal|"errors"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|value
operator|||
operator|!
operator|*
name|value
condition|)
block|{
name|printk
argument_list|(
literal|"EXT2-fs: the errors option requires "
literal|"an argument"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|value
argument_list|,
literal|"continue"
argument_list|)
condition|)
block|{
name|clear_opt
argument_list|(
operator|*
name|mount_options
argument_list|,
name|ERRORS_RO
argument_list|)
expr_stmt|;
name|clear_opt
argument_list|(
operator|*
name|mount_options
argument_list|,
name|ERRORS_PANIC
argument_list|)
expr_stmt|;
name|set_opt
argument_list|(
operator|*
name|mount_options
argument_list|,
name|ERRORS_CONT
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|value
argument_list|,
literal|"remount-ro"
argument_list|)
condition|)
block|{
name|clear_opt
argument_list|(
operator|*
name|mount_options
argument_list|,
name|ERRORS_CONT
argument_list|)
expr_stmt|;
name|clear_opt
argument_list|(
operator|*
name|mount_options
argument_list|,
name|ERRORS_PANIC
argument_list|)
expr_stmt|;
name|set_opt
argument_list|(
operator|*
name|mount_options
argument_list|,
name|ERRORS_RO
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|value
argument_list|,
literal|"panic"
argument_list|)
condition|)
block|{
name|clear_opt
argument_list|(
operator|*
name|mount_options
argument_list|,
name|ERRORS_CONT
argument_list|)
expr_stmt|;
name|clear_opt
argument_list|(
operator|*
name|mount_options
argument_list|,
name|ERRORS_RO
argument_list|)
expr_stmt|;
name|set_opt
argument_list|(
operator|*
name|mount_options
argument_list|,
name|ERRORS_PANIC
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printk
argument_list|(
literal|"EXT2-fs: Invalid errors option: %s\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|this_char
argument_list|,
literal|"grpid"
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
name|this_char
argument_list|,
literal|"bsdgroups"
argument_list|)
condition|)
name|set_opt
argument_list|(
operator|*
name|mount_options
argument_list|,
name|GRPID
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|this_char
argument_list|,
literal|"minixdf"
argument_list|)
condition|)
name|set_opt
argument_list|(
operator|*
name|mount_options
argument_list|,
name|MINIX_DF
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|this_char
argument_list|,
literal|"nocheck"
argument_list|)
condition|)
block|{
name|clear_opt
argument_list|(
operator|*
name|mount_options
argument_list|,
name|CHECK_NORMAL
argument_list|)
expr_stmt|;
name|clear_opt
argument_list|(
operator|*
name|mount_options
argument_list|,
name|CHECK_STRICT
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|this_char
argument_list|,
literal|"nogrpid"
argument_list|)
operator|||
operator|!
name|strcmp
argument_list|(
name|this_char
argument_list|,
literal|"sysvgroups"
argument_list|)
condition|)
name|clear_opt
argument_list|(
operator|*
name|mount_options
argument_list|,
name|GRPID
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|this_char
argument_list|,
literal|"resgid"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|value
operator|||
operator|!
operator|*
name|value
condition|)
block|{
name|printk
argument_list|(
literal|"EXT2-fs: the resgid option requires "
literal|"an argument"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
operator|*
name|resgid
operator|=
name|simple_strtoul
argument_list|(
name|value
argument_list|,
operator|&
name|value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|value
condition|)
block|{
name|printk
argument_list|(
literal|"EXT2-fs: Invalid resgid option: %s\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|this_char
argument_list|,
literal|"resuid"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|value
operator|||
operator|!
operator|*
name|value
condition|)
block|{
name|printk
argument_list|(
literal|"EXT2-fs: the resuid option requires "
literal|"an argument"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
operator|*
name|resuid
operator|=
name|simple_strtoul
argument_list|(
name|value
argument_list|,
operator|&
name|value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|value
condition|)
block|{
name|printk
argument_list|(
literal|"EXT2-fs: Invalid resuid option: %s\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|this_char
argument_list|,
literal|"sb"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|value
operator|||
operator|!
operator|*
name|value
condition|)
block|{
name|printk
argument_list|(
literal|"EXT2-fs: the sb option requires "
literal|"an argument"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
operator|*
name|sb_block
operator|=
name|simple_strtoul
argument_list|(
name|value
argument_list|,
operator|&
name|value
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|value
condition|)
block|{
name|printk
argument_list|(
literal|"EXT2-fs: Invalid sb option: %s\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
else|else
block|{
name|printk
argument_list|(
literal|"EXT2-fs: Unrecognized mount option %s\n"
argument_list|,
name|this_char
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ext2_setup_super
parameter_list|(
name|struct
name|super_block
modifier|*
name|sb
parameter_list|,
name|struct
name|ext2_super_block
modifier|*
name|es
parameter_list|)
block|{
if|if
condition|(
name|es
operator|->
name|s_rev_level
operator|>
name|EXT2_CURRENT_REV
condition|)
block|{
name|printk
argument_list|(
literal|"EXT2-fs warning: revision level too high, "
literal|"forcing read/only mode\n"
argument_list|)
expr_stmt|;
name|sb
operator|->
name|s_flags
operator||=
name|MS_RDONLY
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|sb
operator|->
name|s_flags
operator|&
name|MS_RDONLY
operator|)
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_mount_state
operator|&
name|EXT2_VALID_FS
operator|)
condition|)
name|printk
argument_list|(
literal|"EXT2-fs warning: mounting unchecked fs, "
literal|"running e2fsck is recommended\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_mount_state
operator|&
name|EXT2_ERROR_FS
operator|)
condition|)
name|printk
argument_list|(
literal|"EXT2-fs warning: mounting fs with errors, "
literal|"running e2fsck is recommended\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|es
operator|->
name|s_max_mnt_count
operator|>=
literal|0
operator|&&
name|es
operator|->
name|s_mnt_count
operator|>=
operator|(
name|unsigned
name|short
operator|)
name|es
operator|->
name|s_max_mnt_count
condition|)
name|printk
argument_list|(
literal|"EXT2-fs warning: maximal mount count reached, "
literal|"running e2fsck is recommended\n"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|es
operator|->
name|s_checkinterval
operator|&&
operator|(
name|es
operator|->
name|s_lastcheck
operator|+
name|es
operator|->
name|s_checkinterval
operator|<=
name|CURRENT_TIME
operator|)
condition|)
name|printk
argument_list|(
literal|"EXT2-fs warning: checktime reached, "
literal|"running e2fsck is recommended\n"
argument_list|)
expr_stmt|;
name|es
operator|->
name|s_state
operator|&=
operator|~
name|EXT2_VALID_FS
expr_stmt|;
if|if
condition|(
operator|!
name|es
operator|->
name|s_max_mnt_count
condition|)
name|es
operator|->
name|s_max_mnt_count
operator|=
name|EXT2_DFL_MAX_MNT_COUNT
expr_stmt|;
name|es
operator|->
name|s_mnt_count
operator|++
expr_stmt|;
name|es
operator|->
name|s_mtime
operator|=
name|CURRENT_TIME
expr_stmt|;
name|mark_buffer_dirty
argument_list|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_sbh
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sb
operator|->
name|s_dirt
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|test_opt
argument_list|(
name|sb
argument_list|,
name|DEBUG
argument_list|)
condition|)
name|printk
argument_list|(
literal|"[EXT II FS %s, %s, bs=%lu, fs=%lu, gc=%lu, "
literal|"bpg=%lu, ipg=%lu, mo=%04lx]\n"
argument_list|,
name|EXT2FS_VERSION
argument_list|,
name|EXT2FS_DATE
argument_list|,
name|sb
operator|->
name|s_blocksize
argument_list|,
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_frag_size
argument_list|,
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_groups_count
argument_list|,
name|EXT2_BLOCKS_PER_GROUP
argument_list|(
name|sb
argument_list|)
argument_list|,
name|EXT2_INODES_PER_GROUP
argument_list|(
name|sb
argument_list|)
argument_list|,
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_mount_opt
argument_list|)
expr_stmt|;
if|if
condition|(
name|test_opt
argument_list|(
name|sb
argument_list|,
name|CHECK
argument_list|)
condition|)
block|{
name|ext2_check_blocks_bitmap
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|ext2_check_inodes_bitmap
argument_list|(
name|sb
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ext2_check_descriptors
parameter_list|(
name|struct
name|super_block
modifier|*
name|sb
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|desc_block
init|=
literal|0
decl_stmt|;
name|unsigned
name|long
name|block
init|=
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_es
operator|->
name|s_first_data_block
decl_stmt|;
name|struct
name|ext2_group_desc
modifier|*
name|gdp
init|=
name|NULL
decl_stmt|;
name|ext2_debug
argument_list|(
literal|"Checking group descriptors"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_groups_count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|i
operator|%
name|EXT2_DESC_PER_BLOCK
argument_list|(
name|sb
argument_list|)
operator|)
operator|==
literal|0
condition|)
name|gdp
operator|=
operator|(
expr|struct
name|ext2_group_desc
operator|*
operator|)
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_group_desc
index|[
name|desc_block
operator|++
index|]
operator|->
name|b_data
expr_stmt|;
if|if
condition|(
name|gdp
operator|->
name|bg_block_bitmap
operator|<
name|block
operator|||
name|gdp
operator|->
name|bg_block_bitmap
operator|>=
name|block
operator|+
name|EXT2_BLOCKS_PER_GROUP
argument_list|(
name|sb
argument_list|)
condition|)
block|{
name|ext2_error
argument_list|(
name|sb
argument_list|,
literal|"ext2_check_descriptors"
argument_list|,
literal|"Block bitmap for group %d"
literal|" not in group (block %lu)!"
argument_list|,
name|i
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|gdp
operator|->
name|bg_block_bitmap
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|gdp
operator|->
name|bg_inode_bitmap
operator|<
name|block
operator|||
name|gdp
operator|->
name|bg_inode_bitmap
operator|>=
name|block
operator|+
name|EXT2_BLOCKS_PER_GROUP
argument_list|(
name|sb
argument_list|)
condition|)
block|{
name|ext2_error
argument_list|(
name|sb
argument_list|,
literal|"ext2_check_descriptors"
argument_list|,
literal|"Inode bitmap for group %d"
literal|" not in group (block %lu)!"
argument_list|,
name|i
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|gdp
operator|->
name|bg_inode_bitmap
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|gdp
operator|->
name|bg_inode_table
operator|<
name|block
operator|||
name|gdp
operator|->
name|bg_inode_table
operator|+
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_itb_per_group
operator|>=
name|block
operator|+
name|EXT2_BLOCKS_PER_GROUP
argument_list|(
name|sb
argument_list|)
condition|)
block|{
name|ext2_error
argument_list|(
name|sb
argument_list|,
literal|"ext2_check_descriptors"
argument_list|,
literal|"Inode table for group %d"
literal|" not in group (block %lu)!"
argument_list|,
name|i
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|gdp
operator|->
name|bg_inode_table
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|block
operator|+=
name|EXT2_BLOCKS_PER_GROUP
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|gdp
operator|++
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
name|struct
name|super_block
modifier|*
name|ext2_read_super
parameter_list|(
name|struct
name|super_block
modifier|*
name|sb
parameter_list|,
name|void
modifier|*
name|data
parameter_list|,
name|int
name|silent
parameter_list|)
block|{
name|struct
name|buffer_head
modifier|*
name|bh
decl_stmt|;
name|struct
name|ext2_super_block
modifier|*
name|es
decl_stmt|;
name|unsigned
name|long
name|sb_block
init|=
literal|1
decl_stmt|;
name|unsigned
name|short
name|resuid
init|=
name|EXT2_DEF_RESUID
decl_stmt|;
name|unsigned
name|short
name|resgid
init|=
name|EXT2_DEF_RESGID
decl_stmt|;
name|unsigned
name|long
name|logic_sb_block
init|=
literal|1
decl_stmt|;
name|int
name|dev
init|=
name|sb
operator|->
name|s_dev
decl_stmt|;
name|int
name|db_count
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
ifdef|#
directive|ifdef
name|EXT2FS_PRE_02B_COMPAT
name|int
name|fs_converted
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
name|set_opt
argument_list|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_mount_opt
argument_list|,
name|CHECK_NORMAL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|parse_options
argument_list|(
operator|(
name|char
operator|*
operator|)
name|data
argument_list|,
operator|&
name|sb_block
argument_list|,
operator|&
name|resuid
argument_list|,
operator|&
name|resgid
argument_list|,
operator|&
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_mount_opt
argument_list|)
condition|)
block|{
name|sb
operator|->
name|s_dev
operator|=
literal|0
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|lock_super
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|set_blocksize
argument_list|(
name|dev
argument_list|,
name|BLOCK_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|bh
operator|=
name|bread
argument_list|(
name|dev
argument_list|,
name|sb_block
argument_list|,
name|BLOCK_SIZE
argument_list|)
operator|)
condition|)
block|{
name|sb
operator|->
name|s_dev
operator|=
literal|0
expr_stmt|;
name|unlock_super
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"EXT2-fs: unable to read superblock\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* 	 * Note: s_es must be initialized s_es as soon as possible because 	 * some ext2 macro-instructions depend on its value 	 */
name|es
operator|=
operator|(
expr|struct
name|ext2_super_block
operator|*
operator|)
name|bh
operator|->
name|b_data
expr_stmt|;
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_es
operator|=
name|es
expr_stmt|;
name|sb
operator|->
name|s_magic
operator|=
name|es
operator|->
name|s_magic
expr_stmt|;
if|if
condition|(
name|sb
operator|->
name|s_magic
operator|!=
name|EXT2_SUPER_MAGIC
ifdef|#
directive|ifdef
name|EXT2FS_PRE_02B_COMPAT
operator|&&
name|sb
operator|->
name|s_magic
operator|!=
name|EXT2_PRE_02B_MAGIC
endif|#
directive|endif
condition|)
block|{
name|sb
operator|->
name|s_dev
operator|=
literal|0
expr_stmt|;
name|unlock_super
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bh
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|silent
condition|)
name|printk
argument_list|(
literal|"VFS: Can't find an ext2 filesystem on dev %d/%d.\n"
argument_list|,
name|MAJOR
argument_list|(
name|dev
argument_list|)
argument_list|,
name|MINOR
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|sb
operator|->
name|s_blocksize
operator|=
name|EXT2_MIN_BLOCK_SIZE
operator|<<
name|es
operator|->
name|s_log_block_size
expr_stmt|;
name|sb
operator|->
name|s_blocksize_bits
operator|=
name|EXT2_BLOCK_SIZE_BITS
argument_list|(
name|sb
argument_list|)
expr_stmt|;
if|if
condition|(
name|sb
operator|->
name|s_blocksize
operator|!=
name|BLOCK_SIZE
operator|&&
operator|(
name|sb
operator|->
name|s_blocksize
operator|==
literal|1024
operator|||
name|sb
operator|->
name|s_blocksize
operator|==
literal|2048
operator|||
name|sb
operator|->
name|s_blocksize
operator|==
literal|4096
operator|)
condition|)
block|{
name|unsigned
name|long
name|offset
decl_stmt|;
name|brelse
argument_list|(
name|bh
argument_list|)
expr_stmt|;
name|set_blocksize
argument_list|(
name|dev
argument_list|,
name|sb
operator|->
name|s_blocksize
argument_list|)
expr_stmt|;
name|logic_sb_block
operator|=
operator|(
name|sb_block
operator|*
name|BLOCK_SIZE
operator|)
operator|/
name|sb
operator|->
name|s_blocksize
expr_stmt|;
name|offset
operator|=
operator|(
name|sb_block
operator|*
name|BLOCK_SIZE
operator|)
operator|%
name|sb
operator|->
name|s_blocksize
expr_stmt|;
name|bh
operator|=
name|bread
argument_list|(
name|dev
argument_list|,
name|logic_sb_block
argument_list|,
name|sb
operator|->
name|s_blocksize
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bh
condition|)
return|return
name|NULL
return|;
name|es
operator|=
operator|(
expr|struct
name|ext2_super_block
operator|*
operator|)
operator|(
operator|(
operator|(
name|char
operator|*
operator|)
name|bh
operator|->
name|b_data
operator|)
operator|+
name|offset
operator|)
expr_stmt|;
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_es
operator|=
name|es
expr_stmt|;
if|if
condition|(
name|es
operator|->
name|s_magic
operator|!=
name|EXT2_SUPER_MAGIC
condition|)
block|{
name|sb
operator|->
name|s_dev
operator|=
literal|0
expr_stmt|;
name|unlock_super
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bh
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"EXT2-fs: Magic mismatch, very weird !\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_frag_size
operator|=
name|EXT2_MIN_FRAG_SIZE
operator|<<
name|es
operator|->
name|s_log_frag_size
expr_stmt|;
if|if
condition|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_frag_size
condition|)
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_frags_per_block
operator|=
name|sb
operator|->
name|s_blocksize
operator|/
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_frag_size
expr_stmt|;
else|else
name|sb
operator|->
name|s_magic
operator|=
literal|0
expr_stmt|;
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_blocks_per_group
operator|=
name|es
operator|->
name|s_blocks_per_group
expr_stmt|;
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_frags_per_group
operator|=
name|es
operator|->
name|s_frags_per_group
expr_stmt|;
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_inodes_per_group
operator|=
name|es
operator|->
name|s_inodes_per_group
expr_stmt|;
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_inodes_per_block
operator|=
name|sb
operator|->
name|s_blocksize
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|ext2_inode
argument_list|)
expr_stmt|;
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_itb_per_group
operator|=
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_inodes_per_group
operator|/
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_inodes_per_block
expr_stmt|;
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_desc_per_block
operator|=
name|sb
operator|->
name|s_blocksize
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|ext2_group_desc
argument_list|)
expr_stmt|;
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_sbh
operator|=
name|bh
expr_stmt|;
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_es
operator|=
name|es
expr_stmt|;
if|if
condition|(
name|resuid
operator|!=
name|EXT2_DEF_RESUID
condition|)
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_resuid
operator|=
name|resuid
expr_stmt|;
else|else
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_resuid
operator|=
name|es
operator|->
name|s_def_resuid
expr_stmt|;
if|if
condition|(
name|resgid
operator|!=
name|EXT2_DEF_RESGID
condition|)
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_resgid
operator|=
name|resgid
expr_stmt|;
else|else
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_resgid
operator|=
name|es
operator|->
name|s_def_resgid
expr_stmt|;
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_mount_state
operator|=
name|es
operator|->
name|s_state
expr_stmt|;
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_rename_lock
operator|=
literal|0
expr_stmt|;
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_rename_wait
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|EXT2FS_PRE_02B_COMPAT
if|if
condition|(
name|sb
operator|->
name|s_magic
operator|==
name|EXT2_PRE_02B_MAGIC
condition|)
block|{
if|if
condition|(
name|es
operator|->
name|s_blocks_count
operator|>
literal|262144
condition|)
block|{
comment|/* 			 * fs> 256 MB can't be converted 			 */
name|sb
operator|->
name|s_dev
operator|=
literal|0
expr_stmt|;
name|unlock_super
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bh
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"EXT2-fs: trying to mount a pre-0.2b file"
literal|"system which cannot be converted\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|printk
argument_list|(
literal|"EXT2-fs: mounting a pre 0.2b file system, "
literal|"will try to convert the structure\n"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sb
operator|->
name|s_flags
operator|&
name|MS_RDONLY
operator|)
condition|)
block|{
name|sb
operator|->
name|s_dev
operator|=
literal|0
expr_stmt|;
name|unlock_super
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bh
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"EXT2-fs: cannot convert a read-only fs\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|convert_pre_02b_fs
argument_list|(
name|sb
argument_list|,
name|bh
argument_list|)
condition|)
block|{
name|sb
operator|->
name|s_dev
operator|=
literal|0
expr_stmt|;
name|unlock_super
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bh
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"EXT2-fs: conversion failed !!!\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|printk
argument_list|(
literal|"EXT2-fs: conversion succeeded !!!\n"
argument_list|)
expr_stmt|;
name|fs_converted
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|sb
operator|->
name|s_magic
operator|!=
name|EXT2_SUPER_MAGIC
condition|)
block|{
name|sb
operator|->
name|s_dev
operator|=
literal|0
expr_stmt|;
name|unlock_super
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bh
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|silent
condition|)
name|printk
argument_list|(
literal|"VFS: Can't find an ext2 filesystem on dev %d/%d.\n"
argument_list|,
name|MAJOR
argument_list|(
name|dev
argument_list|)
argument_list|,
name|MINOR
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|sb
operator|->
name|s_blocksize
operator|!=
name|bh
operator|->
name|b_size
condition|)
block|{
name|sb
operator|->
name|s_dev
operator|=
literal|0
expr_stmt|;
name|unlock_super
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bh
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|silent
condition|)
name|printk
argument_list|(
literal|"VFS: Unsupported blocksize on dev 0x%04x.\n"
argument_list|,
name|dev
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|sb
operator|->
name|s_blocksize
operator|!=
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_frag_size
condition|)
block|{
name|sb
operator|->
name|s_dev
operator|=
literal|0
expr_stmt|;
name|unlock_super
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bh
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"EXT2-fs: fragsize %lu != blocksize %lu (not supported yet)\n"
argument_list|,
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_frag_size
argument_list|,
name|sb
operator|->
name|s_blocksize
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_blocks_per_group
operator|>
name|sb
operator|->
name|s_blocksize
operator|*
literal|8
condition|)
block|{
name|sb
operator|->
name|s_dev
operator|=
literal|0
expr_stmt|;
name|unlock_super
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bh
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"EXT2-fs: #blocks per group too big: %lu\n"
argument_list|,
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_blocks_per_group
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_frags_per_group
operator|>
name|sb
operator|->
name|s_blocksize
operator|*
literal|8
condition|)
block|{
name|sb
operator|->
name|s_dev
operator|=
literal|0
expr_stmt|;
name|unlock_super
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bh
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"EXT2-fs: #fragments per group too big: %lu\n"
argument_list|,
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_frags_per_group
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_inodes_per_group
operator|>
name|sb
operator|->
name|s_blocksize
operator|*
literal|8
condition|)
block|{
name|sb
operator|->
name|s_dev
operator|=
literal|0
expr_stmt|;
name|unlock_super
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bh
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"EXT2-fs: #inodes per group too big: %lu\n"
argument_list|,
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_inodes_per_group
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_groups_count
operator|=
operator|(
name|es
operator|->
name|s_blocks_count
operator|-
name|es
operator|->
name|s_first_data_block
operator|+
name|EXT2_BLOCKS_PER_GROUP
argument_list|(
name|sb
argument_list|)
operator|-
literal|1
operator|)
operator|/
name|EXT2_BLOCKS_PER_GROUP
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|db_count
operator|=
operator|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_groups_count
operator|+
name|EXT2_DESC_PER_BLOCK
argument_list|(
name|sb
argument_list|)
operator|-
literal|1
operator|)
operator|/
name|EXT2_DESC_PER_BLOCK
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_group_desc
operator|=
name|kmalloc
argument_list|(
name|db_count
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|buffer_head
operator|*
argument_list|)
argument_list|,
name|GFP_KERNEL
argument_list|)
expr_stmt|;
if|if
condition|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_group_desc
operator|==
name|NULL
condition|)
block|{
name|sb
operator|->
name|s_dev
operator|=
literal|0
expr_stmt|;
name|unlock_super
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bh
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"EXT2-fs: not enough memory\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|db_count
condition|;
name|i
operator|++
control|)
block|{
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_group_desc
index|[
name|i
index|]
operator|=
name|bread
argument_list|(
name|dev
argument_list|,
name|logic_sb_block
operator|+
name|i
operator|+
literal|1
argument_list|,
name|sb
operator|->
name|s_blocksize
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_group_desc
index|[
name|i
index|]
condition|)
block|{
name|sb
operator|->
name|s_dev
operator|=
literal|0
expr_stmt|;
name|unlock_super
argument_list|(
name|sb
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|i
condition|;
name|j
operator|++
control|)
name|brelse
argument_list|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_group_desc
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|kfree_s
argument_list|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_group_desc
argument_list|,
name|db_count
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|buffer_head
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bh
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"EXT2-fs: unable to read group descriptors\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
if|if
condition|(
operator|!
name|ext2_check_descriptors
argument_list|(
name|sb
argument_list|)
condition|)
block|{
name|sb
operator|->
name|s_dev
operator|=
literal|0
expr_stmt|;
name|unlock_super
argument_list|(
name|sb
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|db_count
condition|;
name|j
operator|++
control|)
name|brelse
argument_list|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_group_desc
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|kfree_s
argument_list|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_group_desc
argument_list|,
name|db_count
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|buffer_head
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bh
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"EXT2-fs: group descriptors corrupted !\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|EXT2_MAX_GROUP_LOADED
condition|;
name|i
operator|++
control|)
block|{
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_inode_bitmap_number
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_inode_bitmap
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_block_bitmap_number
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_block_bitmap
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_loaded_inode_bitmaps
operator|=
literal|0
expr_stmt|;
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_loaded_block_bitmaps
operator|=
literal|0
expr_stmt|;
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_db_per_group
operator|=
name|db_count
expr_stmt|;
name|unlock_super
argument_list|(
name|sb
argument_list|)
expr_stmt|;
comment|/* 	 * set up enough so that it can read an inode 	 */
name|sb
operator|->
name|s_dev
operator|=
name|dev
expr_stmt|;
name|sb
operator|->
name|s_op
operator|=
operator|&
name|ext2_sops
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sb
operator|->
name|s_mounted
operator|=
name|iget
argument_list|(
name|sb
argument_list|,
name|EXT2_ROOT_INO
argument_list|)
operator|)
condition|)
block|{
name|sb
operator|->
name|s_dev
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|db_count
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_group_desc
index|[
name|i
index|]
condition|)
name|brelse
argument_list|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_group_desc
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|kfree_s
argument_list|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_group_desc
argument_list|,
name|db_count
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|buffer_head
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|brelse
argument_list|(
name|bh
argument_list|)
expr_stmt|;
name|printk
argument_list|(
literal|"EXT2-fs: get root inode failed\n"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
ifdef|#
directive|ifdef
name|EXT2FS_PRE_02B_COMPAT
if|if
condition|(
name|fs_converted
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|db_count
condition|;
name|i
operator|++
control|)
name|mark_buffer_dirty
argument_list|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_group_desc
index|[
name|i
index|]
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sb
operator|->
name|s_dirt
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
name|ext2_setup_super
argument_list|(
name|sb
argument_list|,
name|es
argument_list|)
expr_stmt|;
return|return
name|sb
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ext2_commit_super
parameter_list|(
name|struct
name|super_block
modifier|*
name|sb
parameter_list|,
name|struct
name|ext2_super_block
modifier|*
name|es
parameter_list|)
block|{
name|es
operator|->
name|s_wtime
operator|=
name|CURRENT_TIME
expr_stmt|;
name|mark_buffer_dirty
argument_list|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_sbh
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sb
operator|->
name|s_dirt
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * In the second extended file system, it is not necessary to  * write the super block since we use a mapping of the  * disk super block in a buffer.  *  * However, this function is still used to set the fs valid  * flags to 0.  We need to set this flag to 0 since the fs  * may have been checked while mounted and e2fsck may have  * set s_state to EXT2_VALID_FS after some corrections.  */
end_comment

begin_function
name|void
name|ext2_write_super
parameter_list|(
name|struct
name|super_block
modifier|*
name|sb
parameter_list|)
block|{
name|struct
name|ext2_super_block
modifier|*
name|es
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|sb
operator|->
name|s_flags
operator|&
name|MS_RDONLY
operator|)
condition|)
block|{
name|es
operator|=
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_es
expr_stmt|;
name|ext2_debug
argument_list|(
literal|"setting valid to 0\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|es
operator|->
name|s_state
operator|&
name|EXT2_VALID_FS
condition|)
block|{
name|es
operator|->
name|s_state
operator|&=
operator|~
name|EXT2_VALID_FS
expr_stmt|;
name|es
operator|->
name|s_mtime
operator|=
name|CURRENT_TIME
expr_stmt|;
block|}
name|ext2_commit_super
argument_list|(
name|sb
argument_list|,
name|es
argument_list|)
expr_stmt|;
block|}
name|sb
operator|->
name|s_dirt
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|int
name|ext2_remount
parameter_list|(
name|struct
name|super_block
modifier|*
name|sb
parameter_list|,
name|int
modifier|*
name|flags
parameter_list|,
name|char
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|ext2_super_block
modifier|*
name|es
decl_stmt|;
name|unsigned
name|short
name|resuid
init|=
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_resuid
decl_stmt|;
name|unsigned
name|short
name|resgid
init|=
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_resgid
decl_stmt|;
name|unsigned
name|long
name|new_mount_opt
decl_stmt|;
name|unsigned
name|long
name|tmp
decl_stmt|;
comment|/* 	 * Allow the "check" option to be passed as a remount option. 	 */
name|set_opt
argument_list|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_mount_opt
argument_list|,
name|CHECK_NORMAL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|parse_options
argument_list|(
name|data
argument_list|,
operator|&
name|tmp
argument_list|,
operator|&
name|resuid
argument_list|,
operator|&
name|resgid
argument_list|,
operator|&
name|new_mount_opt
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_mount_opt
operator|=
name|new_mount_opt
expr_stmt|;
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_resuid
operator|=
name|resuid
expr_stmt|;
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_resgid
operator|=
name|resgid
expr_stmt|;
name|es
operator|=
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_es
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|flags
operator|&
name|MS_RDONLY
operator|)
operator|==
operator|(
name|sb
operator|->
name|s_flags
operator|&
name|MS_RDONLY
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|*
name|flags
operator|&
name|MS_RDONLY
condition|)
block|{
if|if
condition|(
name|es
operator|->
name|s_state
operator|&
name|EXT2_VALID_FS
operator|||
operator|!
operator|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_mount_state
operator|&
name|EXT2_VALID_FS
operator|)
condition|)
return|return
literal|0
return|;
comment|/* 		 * OK, we are remounting a valid rw partition rdonly, so set 		 * the rdonly flag and then mark the partition as valid again. 		 */
name|es
operator|->
name|s_state
operator|=
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_mount_state
expr_stmt|;
name|es
operator|->
name|s_mtime
operator|=
name|CURRENT_TIME
expr_stmt|;
name|mark_buffer_dirty
argument_list|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_sbh
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sb
operator|->
name|s_dirt
operator|=
literal|1
expr_stmt|;
name|ext2_commit_super
argument_list|(
name|sb
argument_list|,
name|es
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * Mounting a RDONLY partition read-write, so reread and 		 * store the current valid flag.  (It may have been changed  		 * by e2fsck since we originally mounted the partition.) 		 */
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_mount_state
operator|=
name|es
operator|->
name|s_state
expr_stmt|;
name|sb
operator|->
name|s_flags
operator|&=
operator|~
name|MS_RDONLY
expr_stmt|;
name|ext2_setup_super
argument_list|(
name|sb
argument_list|,
name|es
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|ext2_statfs
parameter_list|(
name|struct
name|super_block
modifier|*
name|sb
parameter_list|,
name|struct
name|statfs
modifier|*
name|buf
parameter_list|)
block|{
name|long
name|tmp
decl_stmt|;
name|unsigned
name|long
name|overhead
decl_stmt|;
name|unsigned
name|long
name|overhead_per_group
decl_stmt|;
if|if
condition|(
name|test_opt
argument_list|(
name|sb
argument_list|,
name|MINIX_DF
argument_list|)
condition|)
name|overhead
operator|=
literal|0
expr_stmt|;
else|else
block|{
comment|/* 		 * Compute the overhead (FS structures) 		 */
name|overhead_per_group
operator|=
literal|1
comment|/* super block */
operator|+
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_db_per_group
comment|/* descriptors */
operator|+
literal|1
comment|/* block bitmap */
operator|+
literal|1
comment|/* inode bitmap */
operator|+
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_itb_per_group
comment|/* inode table */
expr_stmt|;
name|overhead
operator|=
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_es
operator|->
name|s_first_data_block
operator|+
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_groups_count
operator|*
name|overhead_per_group
expr_stmt|;
block|}
name|put_fs_long
argument_list|(
name|EXT2_SUPER_MAGIC
argument_list|,
operator|&
name|buf
operator|->
name|f_type
argument_list|)
expr_stmt|;
name|put_fs_long
argument_list|(
name|sb
operator|->
name|s_blocksize
argument_list|,
operator|&
name|buf
operator|->
name|f_bsize
argument_list|)
expr_stmt|;
name|put_fs_long
argument_list|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_es
operator|->
name|s_blocks_count
operator|-
name|overhead
argument_list|,
operator|&
name|buf
operator|->
name|f_blocks
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|ext2_count_free_blocks
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|put_fs_long
argument_list|(
name|tmp
argument_list|,
operator|&
name|buf
operator|->
name|f_bfree
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|>=
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_es
operator|->
name|s_r_blocks_count
condition|)
name|put_fs_long
argument_list|(
name|tmp
operator|-
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_es
operator|->
name|s_r_blocks_count
argument_list|,
operator|&
name|buf
operator|->
name|f_bavail
argument_list|)
expr_stmt|;
else|else
name|put_fs_long
argument_list|(
literal|0
argument_list|,
operator|&
name|buf
operator|->
name|f_bavail
argument_list|)
expr_stmt|;
name|put_fs_long
argument_list|(
name|sb
operator|->
name|u
operator|.
name|ext2_sb
operator|.
name|s_es
operator|->
name|s_inodes_count
argument_list|,
operator|&
name|buf
operator|->
name|f_files
argument_list|)
expr_stmt|;
name|put_fs_long
argument_list|(
name|ext2_count_free_inodes
argument_list|(
name|sb
argument_list|)
argument_list|,
operator|&
name|buf
operator|->
name|f_ffree
argument_list|)
expr_stmt|;
name|put_fs_long
argument_list|(
name|EXT2_NAME_LEN
argument_list|,
operator|&
name|buf
operator|->
name|f_namelen
argument_list|)
expr_stmt|;
comment|/* Don't know what value to put in buf->f_fsid */
block|}
end_function

end_unit

